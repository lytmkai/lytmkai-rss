<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[场景化落地指南——金仓时序数据库在关键行业的应用实践]]></title>    <link>https://juejin.cn/post/7594662879202230298</link>    <guid>https://juejin.cn/post/7594662879202230298</guid>    <pubDate>2026-01-13T13:08:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662879202230298" data-draft-id="7594662879202197530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="场景化落地指南——金仓时序数据库在关键行业的应用实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-01-13T13:08:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            场景化落地指南——金仓时序数据库在关键行业的应用实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T13:08:36.000Z" title="Tue Jan 13 2026 13:08:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>时序数据怎么“落到系统里”，往往比“概念讲清楚”更难。本文就以金仓时序数据库的工程落地为主线，把采集、存储、分析、看板到运维闭环串起来：能力怎么拆、模型怎么建、SQL怎么写、行业怎么用，尽量讲得清楚、也讲得能直接照着做。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63784542e8b64026a1ff61fd8c087af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768914516&amp;x-signature=Lo09fjw5NTdRp58vwTDMZ7e7t7k%3D" alt="a6bb70bf487627cb7b4e42054570950f.jpg" loading="lazy"/></p>
<p>@[toc]</p>
<hr/>
<h2 data-id="heading-0">1. 为什么 2025 年时序数据库“必须场景化”</h2>
<p>时序数据库早就不只是“写得快、存得下”这么简单了。到了 2025 年，大家更看重的是<strong>能不能围绕场景把链路交付出来</strong>——接入稳不稳、存储贵不贵、查询快不快、系统抗不抗压、治理合不合规、国产化环境能不能长期跑住。</p>
<h3 data-id="heading-1">1.1 2025 年时序数据的四个典型变化</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/815bd264292a460c8e7683e6db5b4432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768914516&amp;x-signature=SURvd2wf9%2BUpCsPAWeiAa6pNvDc%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>
<p><strong>数据源更碎更近</strong><br/>
边缘侧设备、网关、工业控制与车联网等产生大量“短周期、高噪声、易丢包”的数据，接入链路需要更强的吞吐与容错。</p>
</li>
<li>
<p><strong>“写入高峰 + 查询突发”成为常态</strong><br/>
白天业务写入、夜间批处理、故障排查突发查询叠加，要求数据库同时兼顾写入、压缩、聚合与并发读。</p>
</li>
<li>
<p><strong>从“保存原始数据”走向“可运营的数据资产”</strong><br/>
不只是存：还要分层（热/温/冷）、保留策略、降采样、数据质量与审计，让数据能被长期复用。</p>
</li>
<li>
<p><strong>“可控可用”比“参数最优”更重要</strong><br/>
关键行业更看重可交付性：可运维、可审计、可扩展、可兼容生态、可在国产化环境稳定运行。</p>
</li>
</ol>
<h3 data-id="heading-2">1.2 趋势、格局与金仓的机会点：把“能力”写进“交付件”</h3>
<p>如果把行业格局拆开看，时序产品大体会落在三条路线上：偏工业/能源的生产系统路线、偏 IT 可观测性的运维路线、以及偏物联网与平台化的数据平台路线。走到 2025 年，真正能拉开差距的往往不是某一项“极限指标”，而是能不能把能力沉淀成一套可复用、可验收的交付件：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fab5ae891cf4b4fb22f6930436b27ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768914516&amp;x-signature=noB%2BXeVpr91ObNiCtX%2FWhryNXrs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>数据接入标准化</strong>：批量写入、重试幂等、乱序补写、质量标记这些能力，最后要落成接入规范与模板，谁接谁用。</li>
<li><strong>分区生命周期工程化</strong>：分区自动创建与清理、冷热分层、归档策略要固化成运维脚本与验收口径，跑起来心里有底。</li>
<li><strong>看板查询产品化</strong>：分钟/小时聚合层配上回补窗口，把看板从“偶尔很快”变成“长期稳定快”。</li>
<li><strong>治理与审计体系化</strong>：权限隔离、审计留痕、保留策略可审计，减少上线审批与合规沟通成本。</li>
<li><strong>国产化落地可持续</strong>：压测基线、容量模型、演练流程与监控指标补齐，尽量把问题挡在上线前。</li>
</ul>
<hr/>
<h2 data-id="heading-3">2. 金仓时序数据库的能力拆解：用工程语言对齐“能解决什么问题”</h2>
<p>把能力按“落地会用到的层次”拆开看，规划、验收、扩容评估都会清晰不少。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
  A[数据接入&lt;br/&gt;采集/网关/消息队列] --&gt; B[写入与缓冲&lt;br/&gt;批量/乱序/幂等]
  B --&gt; C[存储组织&lt;br/&gt;分区/索引/压缩]
  C --&gt; D[查询分析&lt;br/&gt;窗口聚合/关联/预聚合]
  D --&gt; E[数据治理&lt;br/&gt;生命周期/权限/审计]
  E --&gt; F[高可用与运维&lt;br/&gt;备份恢复/监控/扩缩容]
</code></pre>
<h3 data-id="heading-4">2.0 把“金仓”放进架构图：不是单点能力，而是一套交付体系</h3>
<p>关键行业里，金仓的时序能力更多是作为金仓数据库的企业级数据底座能力来用：它能承载“海量时序数据采集检索类应用”等场景，并且支持和关系、文档、GIS 等模型统一存储、混合访问。换句话说，很多时候你不必为了时序单独再拼一套系统，运维与治理的压力也会小一截。</p>
<p>做国产化替代，难点往往不在“能不能迁”，而在“迁完能不能长期稳”。所以工程交付必须把“评估—迁移—开发—运维”这一串打通。金仓官网公开信息里也明确提到其配套的工具组件体系覆盖迁移评估、数据迁移、开发管理与集中运维等环节，目的就是把“能跑起来”进一步变成“能持续跑下去”。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40af9ece24a14edd8369b6ba1c0e24a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768914516&amp;x-signature=5DI3EwWn6uNondtYfhWCEX3rijU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 写入：吞吐、乱序与“业务可恢复”</h3>
<p>很多项目里，写入的真实痛点并不是“单条写得慢”，而是下面这些更折磨人的问题：</p>
<ul>
<li>峰值写入时如何保持稳定、不卡死查询；</li>
<li>乱序/迟到数据如何补写并保持一致；</li>
<li>断网/重试时如何做到幂等与可追溯。</li>
</ul>
<p>落到工程上，可以按这个思路做：</p>
<ul>
<li>入口层先把<strong>批量写入</strong>和<strong>重试去重</strong>做扎实（设备侧或网关侧带唯一序号/时间戳+设备ID），写入高峰时更稳。</li>
<li>数据库侧用<strong>按时间范围分区</strong>来兜底，避免一张表无限变大后维护成本飙升。</li>
<li>如果业务维度很稳定、过滤也很高频，就把“时间 + 业务维度”当成联合切分的抓手，既降低热点，也减少扫描范围。[^kb-logs][^kb-safety]</li>
</ul>
<h3 data-id="heading-6">2.2 存储：分区、压缩与冷热分层（降低总成本）</h3>
<p>时序数据按时间范围切分（天/小时/周等）几乎是“默认正确”的选择，收益也很直接：</p>
<ul>
<li>查询裁剪：只扫描命中的时间分区；</li>
<li>运维简化：过期数据直接按分区清理；</li>
<li>性能稳定：避免“越存越慢”的长尾问题。</li>
</ul>
<p>从产品形态上看，金仓把时序能力放进融合数据库体系里，强调多种模型统一存储、混合访问。这样一来，“时序明细 + 业务维表 +（可选的）空间信息”就能在同一底座内闭环完成，跨系统同步与一致性治理的麻烦事会少很多。[^kb-kes]</p>
<h3 data-id="heading-7">2.3 查询：窗口聚合、预聚合与“秒级看板”</h3>
<p>看板/告警最常见的坑就是：原始点位太多，一上来就扫明细，延迟上去了，资源也被吃光。更稳妥的做法通常是：</p>
<ul>
<li>明细层保留原始数据；</li>
<li>聚合层按分钟/小时做预聚合（可物化/可增量）；</li>
<li>业务侧读聚合层满足大多数实时看板。</li>
</ul>
<p>在金仓公开的时序分析实践里，“区间筛选 + 时间窗口聚合”的函数化思路经常被用来把复杂查询收敛成稳定、可复用的时间窗操作，这样压测、缓存和看板复用都会更顺手。[^kb-safety]</p>
<h3 data-id="heading-8">2.4 治理与安全：权限、审计与合规</h3>
<p>关键行业往往要求：</p>
<ul>
<li>
<p>租户/部门隔离（多业务域并行）；</p>
</li>
<li>
<p>行级/库级/表级权限；</p>
</li>
<li>
<p>操作审计、追溯与留痕；</p>
</li>
<li>
<p>数据保留策略可控、可审计。</p>
</li>
</ul>
<h2 data-id="heading-9">时序项目能不能顺利上线、上线后敢不敢放量，很多时候就卡在治理这一关。</h2>
<h2 data-id="heading-10">3. 一个可复用的数据模型：设备测点表（含分区与索引）</h2>
<p>先用通用 SQL 来阐述建模思路，把“设备测点”当作事实表，并按照时间范围实施分区，然后针对最常见的过滤条件创建合成索引，这样大概就可以涵盖多数生产场景。</p>
<p>不同系统对于分区语法的细节可能存在差别，不过建模思路以及字段设计可以照搬，等到实际执行的时候，再依照金仓时序数据库的功能以及运维规范去调整分区粒度和索引策略即可。</p>
<h3 data-id="heading-11">3.1 表结构建议</h3>
<ul>
<li><code>ts</code>：采集时间（统一使用同一时区/统一入库口径）</li>
<li><code>device_id</code>：设备/点位唯一标识</li>
<li><code>metric</code>：指标名（温度、压力、电流等）</li>
<li><code>value</code>：数值</li>
<li><code>quality</code>：质量位（可选，标记是否有效/是否补传）</li>
<li><code>tags</code>：扩展维度（可选，JSON 或规范化维表）</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_points (
  ts         <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  device_id  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  metric     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">value</span>      <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  quality    <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (ts, device_id, metric)
);
</code></pre>
<h3 data-id="heading-12">3.2 按时间范围分区（示例：按天）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_points_2025_01_01 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> telemetry_points
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2025-01-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2025-01-02'</span>);
</code></pre>
<h3 data-id="heading-13">3.3 常用索引</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_tp_device_metric_ts <span class="hljs-keyword">ON</span> telemetry_points (device_id, metric, ts);
<span class="hljs-keyword">CREATE</span> INDEX idx_tp_ts <span class="hljs-keyword">ON</span> telemetry_points (ts);
</code></pre>
<h3 data-id="heading-14">3.4 多业务域/多租户的两种常见隔离方式</h3>
<p>时序平台一旦做成“平台”，就会遇到多业务域/多租户的问题。工程上最常见的隔离方式基本就这两类：</p>
<ul>
<li><strong>库/模式隔离</strong>：不同租户/业务域使用不同库或不同模式，隔离清晰、权限简单，适合强隔离场景。</li>
<li><strong>表内隔离</strong>：同一张事实表增加 <code>tenant_id</code> 字段，适合租户多且小、共享资源的场景，但需要更严格的权限与审计策略。</li>
</ul>
<hr/>
<h2 data-id="heading-15">4. 典型查询与聚合：从“明细点”到“可用指标”</h2>
<p>许多团队执行时序分析的时候，最常犯的错误就是“每个人都有一套自己的时间窗逻辑”，这样就造成口径不统一，性能也无法控制，金仓在开展时序分析的时候，更侧重于把“时间范围过滤，区间筛选，时间窗口聚合”这些功能做成函数化，模板化的模式，从而减轻重复劳动的负担，也便于创建性能基线并实施回归检测，这里有一组通用的 SQL 思路；到了实际操作金仓时，可以优先采用金仓自身具备的等效内置函数及其相关能力，把逻辑编写得更为精炼，稳定。</p>
<h3 data-id="heading-16">4.1 区间查询：设备在某时间段的曲线</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> ts, <span class="hljs-keyword">value</span>
<span class="hljs-keyword">FROM</span> telemetry_points
<span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
  <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-02 00:00:00'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ts;
</code></pre>
<h3 data-id="heading-17">4.2 窗口聚合：按 5 分钟做均值、最大、最小</h3>
<p>没有内置时间桶函数时，也可以用“时间截断/取整”的方式表达时间桶。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span>
  (DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts) <span class="hljs-operator">-</span> (<span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">minute</span> <span class="hljs-keyword">FROM</span> ts)::<span class="hljs-type">int</span> <span class="hljs-operator">%</span> <span class="hljs-number">5</span>) <span class="hljs-operator">*</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'1 minute'</span>) <span class="hljs-keyword">AS</span> bucket_start,
  <span class="hljs-built_in">AVG</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> avg_value,
  <span class="hljs-built_in">MIN</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> min_value,
  <span class="hljs-built_in">MAX</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> max_value
<span class="hljs-keyword">FROM</span> telemetry_points
<span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
  <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
  <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-01 06:00:00'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> bucket_start
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> bucket_start;
</code></pre>
<h3 data-id="heading-18">4.3 预聚合：面向看板的“分钟级物化视图”（示例思路）</h3>
<p>当看板查询频繁、且大部分只需要分钟级指标时，建议做“明细层 + 聚合层”两层结构。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_1m (
  bucket_start <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  device_id    <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  metric       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  avg_value    <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  min_value    <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  max_value    <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  cnt          <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (bucket_start, device_id, metric)
);
</code></pre>
<p>聚合刷新策略建议：</p>
<ul>
<li>实时性要求高：按分钟增量刷新；</li>
<li>允许延迟：按 5 分钟/15 分钟批量刷新；</li>
<li>支持迟到数据：设置“回补窗口”（例如回补最近 2 小时）。</li>
</ul>
<h3 data-id="heading-19">4.4 乱序、重复与补传：用“质量位 + 业务幂等键”降低风险</h3>
<p>现场采集常常会遇到这样一些麻烦事，第一种是设备补传引发的重复情况，第二种是因为网络抖动而出现的乱序现象，第三种则是由于设备离线造成的缺段问题，想要减小返工量，最好是就在模型层预先留出控制面。</p>
<ul>
<li><code>quality</code> 标记来源（正常/补传/估算/无效等），便于告警与统计口径一致</li>
<li>入口层生成 <code>event_id</code>（设备序号或哈希），用于幂等写入与去重</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> telemetry_points2 (
  ts         <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  device_id  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  metric     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">value</span>      <span class="hljs-type">DOUBLE PRECISION</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  quality    <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  event_id   <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (event_id)
);
</code></pre>
<h3 data-id="heading-20">4.5 缺失补齐：把“时间对齐”做成可复用查询模板</h3>
<p>看板经常要一根“等间隔时间轴”（比如每分钟一个点）。遇到缺失时，先用 <code>NULL</code> 占位更干净，后面在展示层再做插值或前向填充就好。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> time_grid <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> generate_series(
    <span class="hljs-type">TIMESTAMP</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>,
    <span class="hljs-type">TIMESTAMP</span> <span class="hljs-string">'2025-01-01 01:00:00'</span>,
    <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'1 minute'</span>
  ) <span class="hljs-keyword">AS</span> ts
),
raw <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts) <span class="hljs-keyword">AS</span> ts, <span class="hljs-built_in">AVG</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> v
  <span class="hljs-keyword">FROM</span> telemetry_points
  <span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
    <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-01 01:00:00'</span>
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts)
)
<span class="hljs-keyword">SELECT</span> g.ts, r.v
<span class="hljs-keyword">FROM</span> time_grid g
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> raw r <span class="hljs-keyword">ON</span> r.ts <span class="hljs-operator">=</span> g.ts
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> g.ts;
</code></pre>
<h3 data-id="heading-21">4.6 告警计算：阈值 + 持续时间（避免“抖动误报”）</h3>
<p>不少告警规则并不是“超过阈值就立刻报”，而是“连续超过阈值 N 分钟才算”。这类需求更适合先在分钟聚合层算，再去识别连续段。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> m1 <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts) <span class="hljs-keyword">AS</span> minute_ts,
    <span class="hljs-built_in">AVG</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> avg_value
  <span class="hljs-keyword">FROM</span> telemetry_points
  <span class="hljs-keyword">WHERE</span> device_id <span class="hljs-operator">=</span> <span class="hljs-string">'D-10086'</span>
    <span class="hljs-keyword">AND</span> metric <span class="hljs-operator">=</span> <span class="hljs-string">'temperature'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>
    <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span>  <span class="hljs-string">'2025-01-01 06:00:00'</span>
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> DATE_TRUNC(<span class="hljs-string">'minute'</span>, ts)
),
flag <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    minute_ts,
    avg_value,
    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> avg_value <span class="hljs-operator">&gt;=</span> <span class="hljs-number">80</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> over_th
  <span class="hljs-keyword">FROM</span> m1
),
grp <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-operator">*</span>,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> over_th <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> minute_ts) <span class="hljs-keyword">AS</span> grp_id
  <span class="hljs-keyword">FROM</span> flag
)
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">MIN</span>(minute_ts) <span class="hljs-keyword">AS</span> start_ts,
  <span class="hljs-built_in">MAX</span>(minute_ts) <span class="hljs-keyword">AS</span> end_ts,
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> minutes
<span class="hljs-keyword">FROM</span> grp
<span class="hljs-keyword">WHERE</span> over_th <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> grp_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">&gt;=</span> <span class="hljs-number">5</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> start_ts;
</code></pre>
<hr/>
<h2 data-id="heading-22">5. 生命周期管理：热/温/冷分层与保留策略（落地可验收）</h2>
<p>时序项目最容易越跑越贵，原因往往很朴素：原始数据一直涨、聚合层没规划、过期数据清不掉（或者不敢清）。</p>
<p>一个实用的做法，是按业务价值把数据分三层：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/806b424cd4f0448bb910804eed02609a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768914516&amp;x-signature=C4sN5cetaWXBHx4guD2kOC%2B0bWQ%3D" alt="image.png" loading="lazy"/></p>
<p>这块怎么验收也不难，口径可以很清楚：</p>
<ul>
<li>分区切换与清理是否自动化；</li>
<li>聚合层是否按周期生成并可回补；</li>
<li>单次看板查询能否稳定在目标延迟（例如 1–3 秒级）。</li>
</ul>
<h3 data-id="heading-23">5.1 分区清理的最小可行策略：按“分区删除”而非“全表删除”</h3>
<p>过期数据的处理上，优先选“按分区删除/归档”，别用“全表扫一遍再删”的方式去赌运气，这样能绕开长事务和大量碎片带来的抖动风险。验收时就看两件事：清理窗口里系统稳不稳、清理耗时能不能预测。</p>
<h3 data-id="heading-24">5.2 用一张图理解“明细到指标”的数据金字塔</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
  A[原始明细点位&lt;br/&gt;秒级/更细] --&gt; B[分钟聚合&lt;br/&gt;看板主力]
  B --&gt; C[小时/天聚合&lt;br/&gt;报表与趋势]
  A --&gt; D[事件/告警表&lt;br/&gt;定位入口]
  D --&gt; A
</code></pre>
<hr/>
<h2 data-id="heading-25">6. 关键行业应用实践：三类场景、三种交付方式</h2>
<p>下面我就按“业务诉求—数据特征—落地打法”来写，你写征文或方案时也方便直接拿去用。</p>
<h3 data-id="heading-26">6.0 一张表把“场景诉求”映射到“金仓落地动作”</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0448fb2ed8d4a1399d19bd25c9adc3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768914516&amp;x-signature=eNh5SsS84jGryjn1mZZHd6QryBM%3D" alt="image.png" loading="lazy"/></p>
<p>顺带一提，“时间 + 业务维度”的联合分区/分片，以及把查询收敛到区间筛选与时间窗口这套写法，在金仓官网的时序分析文章里被反复强调，用它来当方案的设计抓手会更落地。[^kb-logs][^kb-safety]</p>
<h3 data-id="heading-27">6.1 电力与能源：设备状态监测 + 故障追溯</h3>
<p><strong>业务诉求</strong><br/>
设备状态量（电压、电流、温度、振动等）连续采集；异常发生后要能快速定位时间窗、关联工况与告警记录。</p>
<p><strong>数据特征</strong><br/>
点位多、采样周期短；峰值写入高；查询以“设备+时间段”为主，伴随聚合与对比。</p>
<p><strong>落地打法</strong></p>
<ul>
<li>用金仓时序数据库承载海量采集与检索，先把写入与查询基线压测跑出来，心里有数；[^kb-kes]</li>
<li>明细表按天分区；常用设备/指标建组合索引；</li>
<li>建分钟级聚合层供看板读；</li>
<li>故障追溯走“事件表 + 明细回放”链路。</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
  participant Dev as 设备/采集端
  participant Gw as 网关/消息队列
  participant TS as 金仓时序数据库
  participant BI as 看板/告警
  Dev-&gt;&gt;Gw: 批量上报(含序号/时间戳)
  Gw-&gt;&gt;TS: 批量写入/重试
  TS--&gt;&gt;BI: 分钟聚合指标
  BI--&gt;&gt;TS: 异常回放查询(设备+时间窗)
</code></pre>
<h3 data-id="heading-28">6.2 制造与工业互联网：OEE/能耗与质量波动分析</h3>
<p><strong>业务诉求</strong><br/>
把机台数据变成可运营指标（稼动率、能耗、节拍波动、良率关联），并能按产线/班组/工单维度分析。</p>
<p><strong>数据特征</strong><br/>
除时序明细外，必须强依赖维度（产线、工单、物料批次、工艺段）。</p>
<p><strong>落地打法</strong></p>
<ul>
<li>把时序事实表和业务维表放在金仓统一底座内，尽量少做跨库同步，把一致性治理的复杂度压下去；[^kb-kes]</li>
<li>“时序事实表 + 维表”建模：维表相对稳定，事实表高频写；</li>
<li>查询侧做“窗口聚合 + 维表关联”，把指标沉淀到报表层；</li>
<li>对关键指标做预聚合，减少峰值压力。</li>
</ul>
<h3 data-id="heading-29">6.3 交通与城市运行：多源融合监测与态势感知</h3>
<p><strong>业务诉求</strong><br/>
融合多源数据（设备、环境、视频结构化指标、路网状态），要求稳定接入、实时聚合与趋势判断。</p>
<p><strong>数据特征</strong><br/>
来源多、格式不一、质量参差；需要统一时间对齐与数据质量管理。</p>
<p><strong>落地打法</strong></p>
<ul>
<li>接入层规范化：统一时间口径、统一设备ID映射；</li>
<li>入库前做基础质量校验（缺测、重复、异常值标记）；</li>
<li>用聚合层支撑全市/全网态势看板，用明细层支撑局部排障回放。</li>
<li>需要空间维度（区域、路段、围栏）时，可结合时序与空间数据做联合筛选，把“时间窗 + 空间范围”的查询收敛成可复用模板。[^kb-kes][^kb-safety]</li>
</ul>
<hr/>
<h2 data-id="heading-30">7. 国产化替代背景下：怎么把“可用”做成“好用、稳用、可持续用”</h2>
<p>国产化替代项目真正的关键，通常不是“能不能替”，而是把风险尽量从“上线后暴露”前移到“上线前可控”。比较稳的推进方式，可以沿着“三条主线”走：</p>
<h3 data-id="heading-31">7.1 主线一：选型与验证（可量化、可复测）</h3>
<p>验证集建议至少覆盖这些维度：</p>
<ul>
<li>
<p>写入：峰值吞吐、乱序补写、重试幂等；</p>
</li>
<li>
<p>查询：典型看板/报表/回放 SQL 的稳定延迟；</p>
</li>
<li>
<p>运维：备份恢复、扩容、分区维护、生命周期清理；</p>
</li>
<li>
<p>安全：权限隔离、审计留痕、账号策略与合规要求。</p>
</li>
</ul>
<p>更为关键的是要将验证动作和工具链关联起来，迁移评定，数据迁移，开发守护以及集中运维这些环节都应该凝结成可回溯的交付物，不可让替代项目仅依靠记忆或者经验存在。</p>
<h3 data-id="heading-32">7.2 主线二：数据分层与指标体系（让成本与性能可控）</h3>
<p>比较实用的做法，是先把指标分成三类：</p>
<ul>
<li>需要秒级：走分钟聚合层或更细粒度的预聚合；</li>
<li>需要分钟级：直接查聚合层；</li>
<li>需要追溯：从事件定位，再回放明细层。</li>
</ul>
<p>这样资源消耗就能从“每次都扫明细”变成“多数读聚合，少数回放明细”，性能和成本都会稳很多。</p>
<h3 data-id="heading-33">7.3 主线三：运维闭环（让系统在生产中持续稳定）</h3>
<p>建议把下面这些事做成日常动作，别等出问题才想起来：</p>
<ul>
<li>
<p>分区自动创建与过期清理；</p>
</li>
<li>
<p>聚合层按计划刷新并具备回补窗口；</p>
</li>
<li>
<p>指标监控：写入延迟、查询 P95、磁盘增长、分区数量、慢查询；</p>
</li>
<li>
<p>灾备演练：按季度做恢复演练与容量回归。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-34">结语：用“可交付的时序工程”把机会点落到现实</h2>
<p>2025年的时序数据库竞争渐渐变成了一场工程交付能力的较量，谁能将写入，存储，查询，治理，运维形成起一套可复用的体系，谁就更有可能在关键行业中做到规模扩张。</p>
<p>如果你正在推动关键行业时序数据平台的创建或者进行国产化替代，建议先把“数据分层，分区生命周期，预聚合”这三件事做好，然后逐步深入地完善指标体系和运维闭环。想了解更多产品与方案，可以到金仓数据库官网看看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kingbase.com.cn%2F" target="_blank" title="https://www.kingbase.com.cn/" ref="nofollow noopener noreferrer">www.kingbase.com.cn/</a></p>
<p>👉 <strong>金仓数据库官方博客站</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkingbase.com.cn%2Fexplore" target="_blank" title="https://kingbase.com.cn/explore" ref="nofollow noopener noreferrer">kingbase.com.cn/explore</a><br/>
想继续深挖的话，这里有不少专家文章、原理解析和最佳实践，可以按场景直接挑着看。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cf7d5cfc79b4976a490e417e149856e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768914516&amp;x-signature=Pbfxsyo1oP5y5TRtfk1tq8YcW2U%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我开发了一款工具箱类型APP：CreativeUtil]]></title>    <link>https://juejin.cn/post/7594682922683596809</link>    <guid>https://juejin.cn/post/7594682922683596809</guid>    <pubDate>2026-01-13T13:32:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594682922683596809" data-draft-id="7594657393830510630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我开发了一款工具箱类型APP：CreativeUtil"/> <meta itemprop="keywords" content="iOS,Mac,APP"/> <meta itemprop="datePublished" content="2026-01-13T13:32:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶子的技术碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2831954919569245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我开发了一款工具箱类型APP：CreativeUtil
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831954919569245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶子的技术碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T13:32:28.000Z" title="Tue Jan 13 2026 13:32:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近又开发了一款新的app：Creative Util，这次是只针对 Mac 平台开发的，因为平时不管是工作还是生活中，会需要用到很多小工具，包括什么markdown转公众号、OSS截图上传、取色、文档处理等等，一般来说要么使用utools这类工具，要么直接网上整一个在线网站临时处理一下，但还是希望能有一个本地的更完整的工具箱能完成自己的所有需求。纠结了一番，最终开发了这款app。包含了设计创作、开发辅助、文档处理三类工具集，目前已经囊括了常用的接近20种工具，后续也会陆陆续续继续增加更多的工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41fc9b2e04394ecbb77b956939b9e8ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768915948&amp;x-signature=ro4zEpN8fCbkcP%2BZtRpkeS3XeL4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd41b4fb03f24e2aa8993b61ea3257db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768915948&amp;x-signature=DBJkEo29Ex7Fx8O5JSmYYSjwcCU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ce0b5da9e34ea7898b8a88b2a7fffc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768915948&amp;x-signature=yQ%2BLdS9cuXLTol8HScdkButGk%2Fk%3D" alt="" loading="lazy"/></p>
<p>总的来说，CreativeUtil 是面向内容创作者、视觉设计师、开发者/运营的 All-in-One 办公效率 App，帮你把常用但零散的工具整合成一个工具集——少切几次应用，多一点专注与灵感。有什么缺的工具可以评论或私信告诉我，我会收集起来把工具集做的更多更完善的，后续工具多起来之后也会支持自选工具排版，省的有的工具对有些朋友可能没什么用还得多滚轮一下才能选择自己想要用的工具。</p>
<p>App Store地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2Fapp%2Fcreativeutil%2Fid6756833314%3Fmt%3D12" target="_blank" title="https://apps.apple.com/cn/app/creativeutil/id6756833314?mt=12" ref="nofollow noopener noreferrer">CreativeUtil</a></p>
<p>PS：我的另一个ios端的app：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2Fapp%2F%25E5%25AE%2589%25E5%25BA%25B7%25E8%25AE%25B0%2Fid6754668335" target="_blank" title="https://apps.apple.com/cn/app/%E5%AE%89%E5%BA%B7%E8%AE%B0/id6754668335" ref="nofollow noopener noreferrer">安康记</a>也在不断更新迭代中，感兴趣的朋友也可以关注一下多多支持，谢谢ღ( ´･ᴗ･` )比心。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[又来学习提示词啦～13.9k star 的系统提示词集合]]></title>    <link>https://juejin.cn/post/7594667893016395791</link>    <guid>https://juejin.cn/post/7594667893016395791</guid>    <pubDate>2026-01-13T13:38:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594667893016395791" data-draft-id="7594667893016379407" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="又来学习提示词啦～13.9k star 的系统提示词集合"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-13T13:38:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            又来学习提示词啦～13.9k star 的系统提示词集合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T13:38:31.000Z" title="Tue Jan 13 2026 13:38:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 能否按照你预期那样 “聪明” 地进行工作，除了模型本身的能力之外，最重要的就是提示词！</p>
<p>对于 AI 而言，它虽然有强大的推理能力、无人能及的训练数据以及巨量的信息储备，但是如果没有给它指定目标和引导，它充其量就是一个能快速给出回答的搜索引擎而已。</p>
<p>ChatGPT 3.5 刚出道的时候，这种感觉尤为明显。哪怕是现在，大多数人依旧是将 AI 当搜索引擎用。所以这在一定程度上会造成一种误解：AI 智能好像也没多智能。</p>
<p>但是在加入提示词之后，尤其是系统提示词，它带来的效果是非常显著的。</p>
<p>首先，对于系统提示词来说，它带给 AI 的，是一种身份赋予。这会注入职业、性格、喜好甚至情感给 AI，让它知道它后续需要以什么身份来和用户进行沟通。<strong>从哲学角度来看，解决了 “我是谁” 的问题</strong>；</p>
<p>其次，在用户提示词上，它会<strong>告诉 AI 用户的目标是什么。解决了 “做什么” 的问题</strong>。</p>
<p>二者结合之下，AI 的能力被释放，市面上逐渐出现了一些很牛的 AI 产品出来。比如 perplexity.ai、Brave Leo AI 等等。</p>
<p>而这些产品的系统提示词，目前均被收集到一款开源项目 <strong>Leaked-system-prompts</strong> 中，项目 star 已经到了 13.9k～</p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjujumilk3%2Fleaked-system-prompts" target="_blank" title="https://github.com/jujumilk3/leaked-system-prompts" ref="nofollow noopener noreferrer">github.com/jujumilk3/l…</a></p>
<p>可以看到在上个月狠狠更新了一波 A 社 Claude 模型的系统提示词：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96681a1e1c204b1b9300f216d86670da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768916310&amp;x-signature=vTPqala%2BSqt%2BgnhBlv%2FLXyyO2oU%3D" alt="i_kicY5mnwzMQbyL1UZpL3tXcAab3XLmYZtZO_qWyEU=.webp" loading="lazy"/></p>
<p>最近一次更新是三天前，更新了 DeepSeek R1 和 duckAI 的提示词：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7747a6554a14e3abe241646603dbabc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768916310&amp;x-signature=pk0Cxuafya1EPb7PpAcFcEnfYYo%3D" alt="DhT_lvZU0a96cCZIF0k3uKPnojBcbrIhY8lS_TmhCK4=.webp" loading="lazy"/></p>
<p>虽然这些提示词对于我们而言无法直接使用（也说不好，一些第三方的中转站说不准能用），但是我们也可以从中取长补短，借鉴和学习他们的提示词是咋写的。</p>
<p>我们以 <code>anthropic-claude-opus-4.5_20251124</code> 的提示词为例来学习一下 A 社是如何写提示词的。</p>
<blockquote>
<p>原提示词太长，大家感兴趣可以直接访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjujumilk3%2Fleaked-system-prompts%2Fblob%2Fmain%2Fanthropic-claude-opus-4.5_20251124.md" target="_blank" title="https://github.com/jujumilk3/leaked-system-prompts/blob/main/anthropic-claude-opus-4.5_20251124.md" ref="nofollow noopener noreferrer">github.com/jujumilk3/l…</a></p>
</blockquote>
<p>从这份提示词来看，我们写提示词的核心要覆盖 8 个方面：</p>
<ul>
<li><strong>角色与身份</strong>：明确模型**“是谁”“以什么身份工作”**。
<ul>
<li>让模型进入稳定心智模型；</li>
<li>决定回答深度、视角、专业度；</li>
<li>示例要素：“你是一名……”、“你以……身份思考和回答”。</li>
</ul>
</li>
<li><strong>能力边界与知识范围</strong>：<strong>明确模型能做什么、不能做什么</strong>。
<ul>
<li>减少幻觉；</li>
<li>提升可信度；</li>
<li>控制回答风险。</li>
</ul>
</li>
<li><strong>任务目标</strong>：这是最重要的一点。<strong>你希望模型最终“帮你达成什么结果”</strong> 。
<ul>
<li>决定内容取舍；</li>
<li>决定是否偏结论、过程、还是启发。</li>
</ul>
</li>
<li><strong>行为与价值约束</strong>：不是安全合规那么重，但是要有<strong>行为边界</strong>。
<ul>
<li>避免你不想要的输出；</li>
<li>提高一致性；</li>
<li>示例要素：不做什么，遇到灰区要如何处理。</li>
</ul>
</li>
<li><strong>推理方式</strong>：即是否要求<strong>分步骤、显式思考、给出权衡点和对立观点</strong>。
<ul>
<li>这是决定 <strong>聪不聪明</strong> 的观感。</li>
</ul>
</li>
<li><strong>语气与态度</strong>：这会影响 <strong>AI 输出的可读性以及是否“像人”</strong> 。</li>
<li><strong>输出格式</strong>：最立竿见影的一点。
<ul>
<li>可以节省二次整理的成本；</li>
<li>提升 AI 输出的稳定性；</li>
<li>示例：是否使用列表、表格、是否限定长度、指定标签、Markdown 和 JSON 格式等。</li>
</ul>
</li>
<li><strong>交互策略</strong>：可以决定模型是否主动补充、先给结论还是先澄清、是否提出改进建议。</li>
</ul>
<p>总结起来就是：<strong>好提示词 = 明确身份 + 明确目标 + 明确边界 + 明确表达方式。</strong></p>
<p>但是也要注意<strong>好提示词 ≠ 长提示词。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AQS 工具之 CountDownLatch 与 CyclicBarry 学习笔记]]></title>    <link>https://juejin.cn/post/7594657393830625318</link>    <guid>https://juejin.cn/post/7594657393830625318</guid>    <pubDate>2026-01-13T13:53:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594657393830625318" data-draft-id="7594657393830608934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AQS 工具之 CountDownLatch 与 CyclicBarry 学习笔记"/> <meta itemprop="keywords" content="Java,后端,源码阅读"/> <meta itemprop="datePublished" content="2026-01-13T13:53:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gelald"/> <meta itemprop="url" content="https://juejin.cn/user/923245499657822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AQS 工具之 CountDownLatch 与 CyclicBarry 学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/923245499657822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gelald
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T13:53:21.000Z" title="Tue Jan 13 2026 13:53:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>CountDownLatch 是 AQS 常见共享模式的实现类，它可以实现线程等待，也可以实现线程通知。CyclicBarrier 和它的功能相似，但是它允许线程复用，在这里对比着学习</p>
</blockquote>
<h2 data-id="heading-0">源码看本质</h2>
<h3 data-id="heading-1">CountDownLatch</h3>
<p><code>CountDownLatch</code> 是 AQS 共享模式的实现，核心要点：</p>
<ul>
<li>线程通过 <code>countDown()</code> 方法对资源进行递减</li>
<li>等待资源 <code>state</code> 减到 0，然后传播式唤醒所有等待线程 (调用了 <code>await()</code> 方法的线程)</li>
<li><strong>不可重用，一旦 <code>state</code> 减到 0，后续调用 <code>await()</code> 方法都不再阻塞，直接通过</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatch</span> {
    <span class="hljs-comment">// 构造方法定义 state 有多少份资源</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CountDownLatch</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"count &lt; 0"</span>);
        <span class="hljs-built_in">this</span>.sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>(count);
    }
    
    <span class="hljs-comment">// 核心：state 从 N → 0</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countDown</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 调用 AQS 共享释放</span>
        sync.releaseShared(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-comment">// 调用 AQS 共享获取</span>
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 已归零</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c - <span class="hljs-number">1</span>;
                <span class="hljs-keyword">if</span> (compareAndSetState(c, nextc))
                    <span class="hljs-keyword">return</span> nextc == <span class="hljs-number">0</span>; <span class="hljs-comment">// 归零时唤醒所有</span>
            }
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-comment">// state=0 时返回正数（成功）</span>
            <span class="hljs-keyword">return</span> (getState() == <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-2">CyclicBarrier</h3>
<p><code>CyclicBarrier</code> 是利用 <code>CountDownLatch</code> 和 <code>Condition</code> 实现的阻塞唤醒，核心要点：</p>
<ul>
<li>线程通过 <code>await()</code> 方法对资源进行递减，通过 <code>Condition</code> 暂时释放锁并进入等待状态</li>
<li>当资源 <code>count</code> 减到 0 时，会执行定义好的到达屏障的回调逻辑，并使用 <code>signalAll()</code> 方法唤醒所有等待线程</li>
<li><strong>唤醒所有等待线程后，重新创建新屏障，通过 <code>Generation</code> 标识屏障代数，实现复用</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CyclicBarrier</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">trip</span> <span class="hljs-operator">=</span> lock.newCondition();

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Generation</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">broken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 标记屏障是否被破坏</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dowait</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, BrokenBarrierException {
        <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Generation</span> <span class="hljs-variable">g</span> <span class="hljs-operator">=</span> generation;
            <span class="hljs-keyword">if</span> (g.broken) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();
            
            <span class="hljs-keyword">if</span> (--count == <span class="hljs-number">0</span>) { <span class="hljs-comment">// 最后一个线程到达</span>
                nextGeneration(); <span class="hljs-comment">// 创建新屏障</span>
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            
            <span class="hljs-comment">// 等待</span>
            <span class="hljs-keyword">for</span> (;;) {
                trip.await(); <span class="hljs-comment">// Condition 等待</span>
                <span class="hljs-keyword">if</span> (g.broken) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();
                <span class="hljs-keyword">if</span> (g != generation) <span class="hljs-keyword">return</span> index; <span class="hljs-comment">// 屏障已更新</span>
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nextGeneration</span><span class="hljs-params">()</span> {
        trip.signalAll(); <span class="hljs-comment">// 唤醒所有等待线程</span>
        count = parties; <span class="hljs-comment">// 重置计数</span>
        generation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>(); <span class="hljs-comment">// 创建新屏障</span>
    }
}
</code></pre>
<h2 data-id="heading-3">屏障效果测试对比</h2>
<blockquote>
<p>分别使用 <code>CountDownLatch</code> 和 <code>CyclicBarrier</code> 实现屏障效果，对比测试</p>
</blockquote>
<h3 data-id="heading-4">CountDownLatch</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatchTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">int</span> <span class="hljs-variable">workerCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(workerCount);

        System.out.println(<span class="hljs-string">"===== CountDownLatch 测试 ====="</span>);
        System.out.println(<span class="hljs-string">"主线程: 启动 "</span> + workerCount + <span class="hljs-string">" 个 worker"</span>);

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= workerCount; i++) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 开始工作"</span>);
                    Thread.sleep(<span class="hljs-number">1000</span>);
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 工作完成，调用 countDown()"</span>);
                    latch.countDown(); <span class="hljs-comment">// 通知完成</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }, <span class="hljs-string">"Worker-"</span> + i).start();
        }

        System.out.println(<span class="hljs-string">"主线程调用 await() 等待所有 worker 完成"</span>);
        latch.await(); <span class="hljs-comment">// 主线程等待</span>
        System.out.println(<span class="hljs-string">"主线程: 所有 worker 完成，继续执行"</span>);

        <span class="hljs-comment">// 尝试重用（会失败！）</span>
        System.out.println(<span class="hljs-string">"\n⚠️ 尝试重用 CountDownLatch..."</span>);
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 再次开始工作"</span>);
                Thread.sleep(<span class="hljs-number">1000</span>);
                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 工作再次完成，再次调用 countDown()"</span>);
                latch.countDown(); <span class="hljs-comment">// 无效果</span>
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }, <span class="hljs-string">"Worker-1"</span>).start();

        System.out.println(<span class="hljs-string">"主线程尝试再次调用 await() 来等待第二次 worker 完成"</span>);
        latch.await(); <span class="hljs-comment">// 立即通过（因为 state 已归0）</span>
        System.out.println(<span class="hljs-string">"主线程: 再次 await() 直接通过！证明不可重用"</span>);
    }
}
</code></pre>
<p>结果：</p>
<pre><code class="hljs language-makefile" lang="makefile">===== CountDownLatch 测试 =====
<span class="hljs-section">主线程: 启动 3 个 worker</span>
主线程调用 await() 等待所有 worker 完成
<span class="hljs-section">Worker-1: 开始工作</span>
<span class="hljs-section">Worker-2: 开始工作</span>
<span class="hljs-section">Worker-3: 开始工作</span>
<span class="hljs-section">Worker-1: 工作完成，调用 countDown()</span>
<span class="hljs-section">Worker-2: 工作完成，调用 countDown()</span>
<span class="hljs-section">Worker-3: 工作完成，调用 countDown()</span>
<span class="hljs-section">主线程: 所有 worker 完成，继续执行</span>

⚠️ 尝试重用 CountDownLatch...
主线程尝试再次调用 await() 来等待第二次 worker 完成
<span class="hljs-section">主线程: 再次 await() 直接通过！证明不可重用</span>
<span class="hljs-section">Worker-1: 再次开始工作</span>
<span class="hljs-section">Worker-1: 工作再次完成，再次调用 countDown()</span>
</code></pre>
<p><code>CountDownLatch</code> 的测试中，主线程等待每个 worker，第一次使用时，可以正常实现“屏障”的同步功能，但是第二次使用时却不能达到相同的效果</p>
<p>原因是 <code>CountDownLatch</code> 不可重用，<code>countDown()</code> 方法会对 <code>state</code> 递减，但是没有让 <code>state</code> 递增的方法，只能减，不能加，当 <code>state</code> 减到 0，尝试第二次使用 <code>CountDownLatch</code> 时，<code>await()</code> 方法会直接通过，不再阻塞</p>
<h3 data-id="heading-5">CyclicBarrier</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CyclicBarrierTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">int</span> <span class="hljs-variable">parties</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">CyclicBarrier</span> <span class="hljs-variable">barrier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CyclicBarrier</span>(parties, () -&gt; {
            System.out.println(<span class="hljs-string">"→→→ 阶段完成回调: 所有线程到达屏障 ←←←"</span>);
        });

        System.out.println(<span class="hljs-string">"\n===== CyclicBarrier 测试 ====="</span>);

        <span class="hljs-comment">// 第一阶段</span>
        System.out.println(<span class="hljs-string">"第一阶段: "</span> + parties + <span class="hljs-string">" 个线程互相等待"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= parties; i++) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 到达第一阶段屏障, 调用 await()"</span>);
                    barrier.await(); <span class="hljs-comment">// 等待其他线程</span>
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 通过第一阶段屏障, 唤醒"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    e.printStackTrace();
                }
            }, <span class="hljs-string">"Thread-"</span> + i).start();
        }
        Thread.sleep(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 等待第一阶段完成</span>

        <span class="hljs-comment">// 第二阶段（重用）</span>
        System.out.println(<span class="hljs-string">"\n✅ 重用 CyclicBarrier 进行第二阶段"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= parties; i++) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 到达第二阶段屏障, 调用 await()"</span>);
                    barrier.await();
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">": 通过第二阶段屏障, 唤醒"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    e.printStackTrace();
                }
            }, <span class="hljs-string">"Thread-"</span> + i).start();
        }
    }
}
</code></pre>
<p>结果：</p>
<pre><code class="hljs language-makefile" lang="makefile">===== CyclicBarrier 测试 =====
<span class="hljs-section">第一阶段: 3 个线程互相等待</span>
<span class="hljs-section">Thread-1: 到达第一阶段屏障, 调用 await()</span>
<span class="hljs-section">Thread-2: 到达第一阶段屏障, 调用 await()</span>
<span class="hljs-section">Thread-3: 到达第一阶段屏障, 调用 await()</span>
→→→ 阶段完成回调: 所有线程到达屏障 ←←←
<span class="hljs-section">Worker-1: 工作再次完成，再次调用 countDown()</span>
<span class="hljs-section">Thread-3: 通过第一阶段屏障, 唤醒</span>
<span class="hljs-section">Thread-1: 通过第一阶段屏障, 唤醒</span>
<span class="hljs-section">Thread-2: 通过第一阶段屏障, 唤醒</span>

✅ 重用 CyclicBarrier 进行第二阶段
<span class="hljs-section">Thread-1: 到达第二阶段屏障, 调用 await()</span>
<span class="hljs-section">Thread-2: 到达第二阶段屏障, 调用 await()</span>
<span class="hljs-section">Thread-3: 到达第二阶段屏障, 调用 await()</span>
→→→ 阶段完成回调: 所有线程到达屏障 ←←←
<span class="hljs-section">Thread-3: 通过第二阶段屏障, 唤醒</span>
<span class="hljs-section">Thread-1: 通过第二阶段屏障, 唤醒</span>
<span class="hljs-section">Thread-2: 通过第二阶段屏障, 唤醒</span>
</code></pre>
<p><code>CyclicBarrier</code> 的测试中，多个 worker 相互协作，到达临界点触发屏障回调，第一次使用时，可以正常实现“屏障”的同步功能；第二次使用时，依然可以实现“屏障”的同步功能</p>
<p>原因是 <code>CyclicBarrier</code> 的屏障是可重用，当不断调用 <code>await()</code> 方法对 <code>count</code> 递减到 0 时，唤醒所有等待的线程，并重置了 <code>count</code>，等待下一轮的屏障到达</p>
<h2 data-id="heading-6">总结使用场景</h2>
<ul>
<li>
<p><code>CountDownLatch</code>：</p>
<ul>
<li>等待主体是主线程，主线程等待多个任务完成</li>
<li>等待主体是子线程，子线程等待主线程的统一发令后开始执行</li>
<li>关键在于必须正确调用 <code>countDown()</code> 方法，否则容易导致永久阻塞，除非使用 <code>await(timeout)</code> 方法</li>
</ul>
</li>
<li>
<p><code>CyclicBarrier</code>：适用所有复用屏障的场景</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（40）Hibernate的命名策略是什么？]]></title>    <link>https://juejin.cn/post/7594627998851907590</link>    <guid>https://juejin.cn/post/7594627998851907590</guid>    <pubDate>2026-01-13T12:04:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594627998851907590" data-draft-id="7594533204004077631" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（40）Hibernate的命名策略是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T12:04:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（40）Hibernate的命名策略是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:04:34.000Z" title="Tue Jan 13 2026 12:04:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的命名策略</h3>
<p>Hibernate的命名策略（Naming Strategy）用于定义数据库表和列的命名规则。默认情况下，Hibernate会根据实体类和属性名自动生成表名和列名，但有时候我们需要自定义这些命名规则以符合特定的命名约定或数据库要求。</p>
<h3 data-id="heading-1">默认命名策略</h3>
<p>Hibernate 5.x及更高版本提供了一些内置的命名策略，如<code>ImplicitNamingStrategy</code>和<code>PhysicalNamingStrategy</code>，用于分别处理隐式和物理命名。</p>
<ul>
<li><strong>ImplicitNamingStrategy</strong>：用于决定在没有明确指定表名或列名的情况下，如何从实体类名和属性名生成默认的表名和列名。</li>
<li><strong>PhysicalNamingStrategy</strong>：用于决定最终采用的物理表名和列名，可以用于将隐式命名策略生成的名进行进一步的转换（如大小写转换、添加前缀或后缀等）。</li>
</ul>
<h3 data-id="heading-2">自定义命名策略示例</h3>
<h4 data-id="heading-3">步骤一：创建自定义命名策略</h4>
<p>我们可以通过实现<code>PhysicalNamingStrategy</code>接口来创建自定义的物理命名策略。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.naming;

<span class="hljs-keyword">import</span> org.hibernate.boot.model.naming.Identifier;
<span class="hljs-keyword">import</span> org.hibernate.boot.model.naming.PhysicalNamingStrategy;
<span class="hljs-keyword">import</span> org.hibernate.engine.jdbc.env.spi.JdbcEnvironment;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomPhysicalNamingStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PhysicalNamingStrategy</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Identifier <span class="hljs-title function_">toPhysicalCatalogName</span><span class="hljs-params">(Identifier name, JdbcEnvironment context)</span> {
        <span class="hljs-keyword">return</span> applyNamingStrategy(name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Identifier <span class="hljs-title function_">toPhysicalSchemaName</span><span class="hljs-params">(Identifier name, JdbcEnvironment context)</span> {
        <span class="hljs-keyword">return</span> applyNamingStrategy(name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Identifier <span class="hljs-title function_">toPhysicalTableName</span><span class="hljs-params">(Identifier name, JdbcEnvironment context)</span> {
        <span class="hljs-keyword">return</span> applyNamingStrategy(name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Identifier <span class="hljs-title function_">toPhysicalSequenceName</span><span class="hljs-params">(Identifier name, JdbcEnvironment context)</span> {
        <span class="hljs-keyword">return</span> applyNamingStrategy(name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Identifier <span class="hljs-title function_">toPhysicalColumnName</span><span class="hljs-params">(Identifier name, JdbcEnvironment context)</span> {
        <span class="hljs-keyword">return</span> applyNamingStrategy(name);
    }

    <span class="hljs-keyword">private</span> Identifier <span class="hljs-title function_">applyNamingStrategy</span><span class="hljs-params">(Identifier name)</span> {
        <span class="hljs-keyword">if</span> (name == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 自定义命名规则：将所有命名转换为大写，并加上前缀 "TBL_"</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">newName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TBL_"</span> + name.getText().toUpperCase();
        <span class="hljs-keyword">return</span> Identifier.toIdentifier(newName);
    }
}
</code></pre>
<h4 data-id="heading-4">步骤二：配置Hibernate以使用自定义命名策略</h4>
<p>在Hibernate配置文件<code>hibernate.cfg.xml</code>中，我们需要配置使用自定义的物理命名策略。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 配置自定义物理命名策略 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.physical_naming_strategy"</span>&gt;</span>com.example.naming.CustomPhysicalNamingStrategy<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">步骤三：定义实体类</h4>
<p>定义一个简单的实体类<code>Product</code>，并观察其在数据库中的表名和列名是如何根据自定义命名策略生成的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Product</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Product</span><span class="hljs-params">(String name, Double price)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.price = price;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(Double price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }
}
</code></pre>
<h4 data-id="heading-6">步骤四：测试命名策略</h4>
<p>通过一个简单的操作来测试我们的自定义命名策略。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> com.example.domain.Product;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateNamingStrategyExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">1000.0</span>);
            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"Smartphone"</span>, <span class="hljs-number">500.0</span>);
            session.save(product1);
            session.save(product2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-7">详细解释</h3>
<ol>
<li>
<p><strong>自定义命名策略</strong>：</p>
<ul>
<li>创建一个名为<code>CustomPhysicalNamingStrategy</code>的类，实现<code>PhysicalNamingStrategy</code>接口，覆盖所需的方法。</li>
<li>在覆盖的方法中，定义一个命名转换的逻辑，例如将所有名字转换为大写并添加前缀<code>"TBL_"</code>。</li>
</ul>
</li>
<li>
<p><strong>配置文件</strong>：</p>
<ul>
<li>在<code>hibernate.cfg.xml</code>配置文件中，添加<code>&lt;property name="hibernate.physical_naming_strategy"&gt;com.example.naming.CustomPhysicalNamingStrategy&lt;/property&gt;</code>来指定自定义命名策略类。</li>
</ul>
</li>
<li>
<p><strong>实体类</strong>：</p>
<ul>
<li>定义一个简单的实体类<code>Product</code>，并观察其在数据库中生成的表名和列名。</li>
</ul>
</li>
<li>
<p><strong>测试命名策略</strong>：</p>
<ul>
<li>通过一个示例操作（如插入数据）测试自定义命名策略的效果，观察生成的数据库表名和列名是否符合预期。</li>
</ul>
</li>
</ol>
<p>通过这种方式，我们可以灵活地定义和使用自定义的命名策略，以满足特定的数据库命名规范或个人偏好。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue插槽]]></title>    <link>https://juejin.cn/post/7594818713631588394</link>    <guid>https://juejin.cn/post/7594818713631588394</guid>    <pubDate>2026-01-13T12:15:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594818713631588394" data-draft-id="7594103243686461483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue插槽"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-13T12:15:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yyt_"/> <meta itemprop="url" content="https://juejin.cn/user/1162607282632969"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue插槽
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1162607282632969/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yyt_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:15:30.000Z" title="Tue Jan 13 2026 12:15:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、先明确核心概念</h2>
<ol>
<li><strong>具名插槽</strong>：给 <code>&lt;slot&gt;</code> 标签添加 <code>name</code> 属性，用于区分不同位置的插槽，让父组件可以精准地将内容插入到子组件的指定位置，解决「默认插槽只能插入一处内容」的问题。</li>
<li><strong>默认插槽</strong>：没有 <code>name</code> 属性的 <code>&lt;slot&gt;</code>，是具名插槽的特殊形式（默认名称为 <code>default</code>），父组件中未指定插槽名称的内容，会默认插入到这里。</li>
<li><strong>插槽默认内容</strong>：在子组件的 <code>&lt;slot&gt;</code> 标签内部写入内容，当父组件未给该插槽传递任何内容时，会显示这份默认内容；若父组件传递了内容，会覆盖默认内容，提升组件的复用性和容错性。</li>
<li><strong>作用域插槽</strong>：子组件通过「属性绑定」的方式给 <code>&lt;slot&gt;</code> 传递内部私有数据，父组件在使用插槽时可以接收这些数据并自定义渲染，解决「父组件无法访问子组件内部数据」的问题，实现「子组件供数、父组件定制渲染」。</li>
</ol>
<h2 data-id="heading-1">二、分步实例演示</h2>
<h3 data-id="heading-2">第一步：实现最基础的「具名插槽 + 默认插槽」</h3>
<p>核心需求：创建一个通用的「页面容器组件」，包含「页头」「页面内容」「页脚」三个部分，其中「页面内容」用默认插槽，「页头」「页脚」用具名插槽。</p>
<h4 data-id="heading-3">1. 子组件：定义插槽（文件名：<code>PageContainer.vue</code>）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 通用页面容器样式（简单美化，方便查看效果） --&gt;
  &lt;div class="page-container" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 20px 0;"&gt;
    &lt;!-- 具名插槽：页头（name="header"） --&gt;
    &lt;div class="page-header" style="border-bottom: 1px dashed #e0e0e0; padding-bottom: 10px; margin-bottom: 10px;"&gt;
      &lt;slot name="header" /&gt;
    &lt;/div&gt;

    &lt;!-- 默认插槽：页面核心内容（无name属性，对应default） --&gt;
    &lt;div class="page-content" style="margin: 20px 0; min-height: 100px;"&gt;
      &lt;slot /&gt;
    &lt;/div&gt;

    &lt;!-- 具名插槽：页脚（name="footer"） --&gt;
    &lt;div class="page-footer" style="border-top: 1px dashed #e0e0e0; padding-top: 10px; margin-top: 10px; text-align: right;"&gt;
      &lt;slot name="footer" /&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 子组件无需额外逻辑，仅定义插槽结构即可
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-4">2. 父组件：使用插槽（传递内容，文件名：<code>App.vue</code>）</h4>
<p>父组件通过 <code>v-slot:插槽名</code>（简写：<code>#插槽名</code>）指定内容要插入的具名插槽，未指定的内容默认插入到默认插槽。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;h2&gt;基础具名插槽 + 默认插槽演示&lt;/h2&gt;

  &lt;!-- 使用子组件 PageContainer --&gt;
  &lt;PageContainer&gt;
    &lt;!-- 给具名插槽 header 传递内容（简写 #header，完整写法 v-slot:header） --&gt;
    &lt;template #header&gt;
      &lt;h3&gt;这是文章详情页的页头&lt;/h3&gt;
      &lt;nav&gt;首页 &gt; 文章 &gt; Vue 插槽教程&lt;/nav&gt;
    &lt;/template&gt;

    &lt;!-- 未指定插槽名，默认插入到子组件的默认插槽 --&gt;
    &lt;div&gt;
      &lt;p&gt;1. 具名插槽可以让父组件精准控制内容插入位置。&lt;/p&gt;
      &lt;p&gt;2. 默认插槽用于承载组件的核心内容，使用更简洁。&lt;/p&gt;
      &lt;p&gt;3. 这部分内容会显示在页头和页脚之间。&lt;/p&gt;
    &lt;/div&gt;

    &lt;!-- 给具名插槽 footer 传递内容（简写 #footer） --&gt;
    &lt;template #footer&gt;
      &lt;span&gt;发布时间：2026-01-13&lt;/span&gt;
      &lt;button style="margin-left: 20px; padding: 4px 12px;"&gt;收藏文章&lt;/button&gt;
    &lt;/template&gt;
  &lt;/PageContainer&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 导入子组件
import PageContainer from './PageContainer.vue';
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-5">3. 运行效果与说明</h4>
<ul>
<li>页头区域显示「文章详情页标题 + 面包屑导航」（对应 <code>#header</code> 插槽内容）。</li>
<li>中间区域显示核心正文（对应默认插槽内容）。</li>
<li>页脚区域显示「发布时间 + 收藏按钮」（对应 <code>#footer</code> 插槽内容）。</li>
<li>关键：父组件的 <code>&lt;template&gt;</code> 标签包裹插槽内容，通过 <code>#插槽名</code> 绑定子组件的具名插槽，结构清晰，互不干扰。</li>
</ul>
<h3 data-id="heading-6">第二步：实现「带默认内容的插槽」</h3>
<p>核心需求：优化上面的 <code>PageContainer.vue</code>，给「页脚插槽」添加默认内容（默认显示「返回顶部」按钮），当父组件未给 <code>footer</code> 插槽传递内容时，显示默认按钮；若传递了内容，覆盖默认内容。</p>
<h4 data-id="heading-7">1. 修改子组件：给插槽添加默认内容（<code>PageContainer.vue</code>）</h4>
<p>仅修改 <code>footer</code> 插槽部分，在 <code>&lt;slot name="footer"&gt;</code> 内部写入默认内容：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="page-container" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 20px 0;"&gt;
    &lt;!-- 具名插槽：页头 --&gt;
    &lt;div class="page-header" style="border-bottom: 1px dashed #e0e0e0; padding-bottom: 10px; margin-bottom: 10px;"&gt;
      &lt;slot name="header" /&gt;
    &lt;/div&gt;

    &lt;!-- 默认插槽：页面核心内容 --&gt;
    &lt;div class="page-content" style="margin: 20px 0; min-height: 100px;"&gt;
      &lt;slot /&gt;
    &lt;/div&gt;

    &lt;!-- 具名插槽：页脚（带默认内容） --&gt;
    &lt;div class="page-footer" style="border-top: 1px dashed #e0e0e0; padding-top: 10px; margin-top: 10px; text-align: right;"&gt;
      &lt;slot name="footer"&gt;
        &lt;!-- 插槽默认内容：父组件未传递footer内容时，显示该按钮 --&gt;
        &lt;button style="padding: 4px 12px;" @click="backToTop"&gt;返回顶部&lt;/button&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 定义默认内容的点击事件（返回顶部）
const backToTop = () =&gt; {
  window.scrollTo({
    top: 0,
    behavior: 'smooth' // 平滑滚动
  });
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-8">2. 父组件演示两种场景（<code>App.vue</code>）</h4>
<p>分别演示「不传递 footer 内容」和「传递 footer 内容」的效果：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;h2&gt;带默认内容的插槽演示&lt;/h2&gt;

  &lt;!-- 场景1：父组件不传递 footer 插槽内容，显示子组件的默认「返回顶部」按钮 --&gt;
  &lt;h4&gt;场景1：未传递页脚内容（显示默认按钮）&lt;/h4&gt;
  &lt;PageContainer&gt;
    &lt;template #header&gt;
      &lt;h3&gt;这是未传递页脚的页面&lt;/h3&gt;
    &lt;/template&gt;
    &lt;p&gt;该页面父组件没有给 footer 插槽传递内容，所以页脚会显示子组件默认的「返回顶部」按钮。&lt;/p&gt;
  &lt;/PageContainer&gt;

  &lt;!-- 场景2：父组件传递 footer 插槽内容，覆盖默认按钮 --&gt;
  &lt;h4 style="margin-top: 40px;"&gt;场景2：传递页脚内容（覆盖默认按钮）&lt;/h4&gt;
  &lt;PageContainer&gt;
    &lt;template #header&gt;
      &lt;h3&gt;这是传递了页脚的页面&lt;/h3&gt;
    &lt;/template&gt;
    &lt;p&gt;该页面父组件给 footer 插槽传递了自定义内容，会覆盖子组件的默认「返回顶部」按钮。&lt;/p&gt;
    &lt;template #footer&gt;
      &lt;span&gt;作者：Vue 小白教程&lt;/span&gt;
      &lt;button style="margin-left: 20px; padding: 4px 12px;"&gt;点赞&lt;/button&gt;
      &lt;button style="margin-left: 10px; padding: 4px 12px;"&gt;评论&lt;/button&gt;
    &lt;/template&gt;
  &lt;/PageContainer&gt;
&lt;/template&gt;

&lt;script setup&gt;
import PageContainer from './PageContainer.vue';
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-9">3. 运行效果与说明</h4>
<ul>
<li>场景1：页脚显示「返回顶部」按钮，点击可实现平滑滚动到页面顶部（默认内容生效）。</li>
<li>场景2：页脚显示「作者 + 点赞 + 评论」，默认的「返回顶部」按钮被覆盖（自定义内容生效）。</li>
<li>核心价值：插槽默认内容让组件更「健壮」，无需父组件每次都传递所有插槽内容，减少冗余代码，提升组件复用性。</li>
</ul>
<h3 data-id="heading-10">第三步：实际业务场景综合应用（卡片组件）</h3>
<p>核心需求：创建一个通用的「商品卡片组件」，使用具名插槽实现「商品图片」「商品标题」「商品价格」「操作按钮」的自定义配置，其中「操作按钮」插槽带默认内容（默认「加入购物车」按钮）。</p>
<h4 data-id="heading-11">1. 子组件：商品卡片（<code>GoodsCard.vue</code>）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="goods-card" style="width: 280px; border: 1px solid #f0f0f0; border-radius: 12px; padding: 16px; margin: 16px; float: left; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"&gt;
    &lt;!-- 具名插槽：商品图片 --&gt;
    &lt;div class="goods-img" style="width: 100%; height: 180px; margin-bottom: 12px; text-align: center;"&gt;
      &lt;slot name="image" /&gt;
    &lt;/div&gt;

    &lt;!-- 具名插槽：商品标题 --&gt;
    &lt;div class="goods-title" style="font-size: 16px; font-weight: 500; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"&gt;
      &lt;slot name="title" /&gt;
    &lt;/div&gt;

    &lt;!-- 具名插槽：商品价格 --&gt;
    &lt;div class="goods-price" style="font-size: 18px; color: #ff4400; margin-bottom: 16px;"&gt;
      &lt;slot name="price" /&gt;
    &lt;/div&gt;

    &lt;!-- 具名插槽：操作按钮（带默认内容） --&gt;
    &lt;div class="goods-actions" style="text-align: center;"&gt;
      &lt;slot name="action"&gt;
        &lt;!-- 默认内容：加入购物车按钮 --&gt;
        &lt;button style="width: 100%; padding: 8px 0; background: #ff4400; color: #fff; border: none; border-radius: 8px; cursor: pointer;"&gt;
          加入购物车
        &lt;/button&gt;
      &lt;/slot&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 无需额外逻辑，仅提供插槽结构和默认内容
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-12">2. 父组件：使用商品卡片组件（<code>App.vue</code>）</h4>
<p>自定义不同商品的内容，演示插槽的灵活性：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;h2&gt;实际业务场景：商品卡片组件&lt;/h2&gt;
  &lt;div style="overflow: hidden; clear: both;"&gt;
    &lt;!-- 商品1：使用默认操作按钮（加入购物车） --&gt;
    &lt;GoodsCard&gt;
      &lt;template #image&gt;
        &lt;img src="https://picsum.photos/240/180?random=1" alt="商品图片" style="width: 240px; height: 180px; object-fit: cover; border-radius: 8px;"&gt;
      &lt;/template&gt;
      &lt;template #title&gt;
        小米手机 14 旗舰智能手机
      &lt;/template&gt;
      &lt;template #price&gt;
        ¥ 4999
      &lt;/template&gt;
      &lt;!-- 未传递 #action 插槽，显示默认「加入购物车」按钮 --&gt;
    &lt;/GoodsCard&gt;

    &lt;!-- 商品2：自定义操作按钮（立即购买 + 收藏） --&gt;
    &lt;GoodsCard&gt;
      &lt;template #image&gt;
        &lt;img src="https://picsum.photos/240/180?random=2" alt="商品图片" style="width: 240px; height: 180px; object-fit: cover; border-radius: 8px;"&gt;
      &lt;/template&gt;
      &lt;template #title&gt;
        苹果 iPad Pro 平板电脑
      &lt;/template&gt;
      &lt;template #price&gt;
        ¥ 7999
      &lt;/template&gt;
      &lt;!-- 自定义 #action 插槽内容，覆盖默认按钮 --&gt;
      &lt;template #action&gt;
        &lt;button style="width: 48%; padding: 8px 0; background: #0071e3; color: #fff; border: none; border-radius: 8px; cursor: pointer; margin-right: 4%;"&gt;
          立即购买
        &lt;/button&gt;
        &lt;button style="width: 48%; padding: 8px 0; background: #f0f0f0; color: #333; border: none; border-radius: 8px; cursor: pointer;"&gt;
          收藏
        &lt;/button&gt;
      &lt;/template&gt;
    &lt;/GoodsCard&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import GoodsCard from './GoodsCard.vue';
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-13">3. 运行效果与说明</h4>
<ul>
<li>商品1：操作按钮显示默认的「加入购物车」，快速实现基础功能。</li>
<li>商品2：操作按钮显示「立即购买 + 收藏」，满足自定义需求。</li>
<li>业务价值：通过具名插槽，打造了「通用可复用」的商品卡片组件，父组件可以根据不同商品场景，灵活配置各个区域的内容，既减少了重复代码，又保证了灵活性。</li>
</ul>
<h3 data-id="heading-14">第四步：实现「作用域插槽」</h3>
<p>核心需求：基于现有商品卡片组件优化，让子组件持有私有商品数据，通过作用域插槽传递给父组件，父组件自定义渲染格式（如给高价商品加「高端」标识、显示商品优惠信息）。</p>
<h4 data-id="heading-15">1. 修改子组件：定义作用域插槽，传递内部数据（<code>GoodsCard.vue</code>）</h4>
<p>子组件新增内部私有数据，通过「属性绑定」给插槽传递数据（<code>:数据名="子组件内部数据"</code>）：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"goods-card"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 280px; border: 1px solid #f0f0f0; border-radius: 12px; padding: 16px; margin: 16px; float: left; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 作用域插槽：商品图片（暴露商品id和图片地址） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"goods-img"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%; height: 180px; margin-bottom: 12px; text-align: center;"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"image"</span> <span class="hljs-attr">:goodsId</span>=<span class="hljs-string">"goods.id"</span> <span class="hljs-attr">:imgUrl</span>=<span class="hljs-string">"goods.imgUrl"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 作用域插槽：商品标题（暴露商品名称和价格） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"goods-title"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 16px; font-weight: 500; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">:goodsName</span>=<span class="hljs-string">"goods.name"</span> <span class="hljs-attr">:goodsPrice</span>=<span class="hljs-string">"goods.price"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 作用域插槽：商品价格（暴露价格和优惠信息） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"goods-price"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 18px; color: #ff4400; margin-bottom: 16px;"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"price"</span> <span class="hljs-attr">:price</span>=<span class="hljs-string">"goods.price"</span> <span class="hljs-attr">:discount</span>=<span class="hljs-string">"goods.discount"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 具名插槽：操作按钮（带默认内容） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"goods-actions"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"text-align: center;"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"action"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 默认内容：加入购物车按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%; padding: 8px 0; background: #ff4400; color: #fff; border: none; border-radius: 8px; cursor: pointer;"</span>&gt;</span>
          加入购物车
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 子组件内部私有数据（模拟接口返回，父组件无法直接访问）</span>
<span class="hljs-keyword">const</span> goods = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1001</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">"小米手机 14 旗舰智能手机"</span>,
  <span class="hljs-attr">price</span>: <span class="hljs-number">4999</span>,
  <span class="hljs-attr">imgUrl</span>: <span class="hljs-string">"https://picsum.photos/240/180?random=1"</span>,
  <span class="hljs-attr">discount</span>: <span class="hljs-string">"立减200元，支持分期免息"</span>
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">2. 父组件：接收并使用作用域插槽数据（<code>App.vue</code>）</h4>
<p>父组件通过 <code>template #插槽名="插槽数据对象"</code> 接收子组件暴露的数据，支持解构赋值简化代码，自定义渲染逻辑：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>进阶：作用域插槽演示（子组件供数，父组件定制渲染）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"overflow: hidden; clear: both; margin-top: 40px;"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">GoodsCard</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 接收图片插槽的作用域数据：slotProps（自定义名称，包含goodsId、imgUrl） --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">image</span>=<span class="hljs-string">"slotProps"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"slotProps.imgUrl"</span> <span class="hljs-attr">:alt</span>=<span class="hljs-string">"'商品' + slotProps.goodsId"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 240px; height: 180px; object-fit: cover; border-radius: 8px;"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 利用子组件传递的goodsId，添加自定义标识 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: absolute; top: 8px; left: 8px; background: red; color: #fff; padding: 2px 8px; border-radius: 4px; z-index: 10;"</span>&gt;</span>
          编号：{{ slotProps.goodsId }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 接收标题插槽的作用域数据：解构赋值（更简洁，推荐） --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">title</span>=<span class="hljs-string">"{ goodsName, goodsPrice }"</span>&gt;</span>
        {{ goodsName }}
        <span class="hljs-comment">&lt;!-- 父组件自定义逻辑：价格高于4000加「高端」标识 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"goodsPrice &gt; 4000"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: #ff4400; font-size: 12px; margin-left: 8px;"</span>&gt;</span>
          高端
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 接收价格插槽的作用域数据：结合优惠信息渲染 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">price</span>=<span class="hljs-string">"{ price, discount }"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>¥ {{ price }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 渲染子组件传递的优惠信息，自定义样式 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 12px; color: #999; margin-top: 4px; text-align: left;"</span>&gt;</span>
          {{ discount }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">GoodsCard</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GoodsCard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/GoodsCard.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">3. 运行效果与说明</h4>
<ul>
<li>父组件成功获取子组件私有数据（<code>goodsId</code>、<code>discount</code> 等），并实现自定义渲染（商品编号、高端标识、优惠信息）；</li>
<li>核心语法：子组件「属性绑定传数据」，父组件「插槽数据对象接收」，支持解构赋值简化代码；</li>
<li>核心价值：通用组件（列表、卡片、表格）既保留内部数据逻辑，又开放渲染格式定制权，极大提升组件灵活性和复用性；</li>
<li>注意：作用域插槽本质仍是具名 / 默认插槽，只是增加了「子向父」的数据传递能力。</li>
</ul>
<h2 data-id="heading-18">三、总结（核心知识点回顾，加深记忆）</h2>
<ol>
<li><strong>使用步骤</strong>：</li>
</ol>
<ul>
<li>子组件：用 <code>&lt;slot name="xxx"&gt;</code> 定义具名插槽（内部可写默认内容），用 <code>:数据名="内部数据"</code> 给插槽传递数据（作用域插槽）；</li>
<li>父组件：用 <code>&lt;template #xxx&gt;</code> 给指定具名插槽传内容，用 <code>&lt;template #xxx="slotProps"&gt;</code> 接收作用域插槽数据，未指定插槽名的内容默认插入到 <code>&lt;slot&gt;</code>（默认插槽）。</li>
</ul>
<ol start="2">
<li><strong>核心语法</strong>：</li>
</ol>
<ul>
<li><code>v-slot:插槽名</code> 可简写为 <code>#插槽名</code>，仅能用于 <code>&lt;template&gt;</code> 标签或组件标签上；</li>
<li>作用域插槽数据支持解构赋值，可设置默认值（如 <code>#title="{ goodsName = '默认商品', goodsPrice = 0 }"</code>）避免报错。</li>
</ul>
<ol start="3">
<li><strong>插槽体系</strong>：</li>
</ol>
<ul>
<li>基础层：默认插槽（单一区域）、具名插槽（多区域精准定制）；</li>
<li>增强层：插槽默认内容（提升健壮性）、作用域插槽（子供数 + 父定制，进阶核心）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 官宣停止维护 3.2.x~3.4.x！]]></title>    <link>https://juejin.cn/post/7594627998852005894</link>    <guid>https://juejin.cn/post/7594627998852005894</guid>    <pubDate>2026-01-13T12:37:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594627998852005894" data-draft-id="7594822454419423295" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 官宣停止维护 3.2.x~3.4.x！"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-13T12:37:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 官宣停止维护 3.2.x~3.4.x！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:37:33.000Z" title="Tue Jan 13 2026 12:37:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Guide！技术的迭代速度有时候真的快到让人窒息。</p>
<p>就在前阵子，<strong>Spring Boot 4.0</strong> 正式发布，3.2.x、3.3.x 和 3.4.x 这些 2024 年发布的版本官方已经不在维护了，也就是不再提供免费的安全更新和错误修复。</p>
<p>下图来源于 SpringBoot 官方文档：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fspring.io%2Fprojects%2Fspring-boot%23support" target="_blank" title="https://spring.io/projects/spring-boot#support" ref="nofollow noopener noreferrer">spring.io/projects/sp…</a></strong> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/569dbbf560694b1da35d1bca798395c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768912653&amp;x-signature=Il38N3EzvryFayEs1P%2BjrycKgxo%3D" alt="" loading="lazy"/></p>
<p>其实影响也不大，很多老项目目前还是 2.x 版本，甚至还有停留在 1.x 版本的。</p>
<p>对于公司项目，如果能稳定运行，就不必要强行去升级新版本。你升级了，老板看不到效果，还容易出现问题，一出现问题说不定就是你背锅。</p>
<p>不过，对于新项目和个人项目来说，还是应该尽量使用相对较新且稳定的版本。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">InterviewGuide</a> （基于 Spring Boot 4.0 + Java 21 + Spring AI 开发的 AI 简历分析和模拟面试系统）这个项目我当时图省事复制了上一个项目的部分依赖文件，导致 SpringBoot 版本是 3.3，给自己找了一个麻烦！</p>
<p>有不少朋友反馈建议将其升级为 4.0 版本，于是我昨天就把这件事做了！</p>
<p>这一路踩了不少坑，尤其是 Jackson 3 的包名大改，简直是“史诗级”的 Breaking Change。今天就把这份<strong>穿透式升级指南</strong>分享给大家，建议收藏备用！</p>
<p>具体的更新内容可以查看这个 Commit：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnailclimb%2Finterview-guide%2Fcommit%2Ff7bb05980b725c8658f93a4c511bf4b2ec616b82" target="_blank" title="https://github.com/Snailclimb/interview-guide/commit/f7bb05980b725c8658f93a4c511bf4b2ec616b82" ref="nofollow noopener noreferrer">github.com/Snailclimb/…</a></strong> 。</p>
<h2 data-id="heading-0">为什么要升级？</h2>
<p>Spring Boot 4.0.0 基于 Spring Framework 7.0，全面支持 Java 25（含虚拟线程优化）。核心新特性包括：HTTP Service Clients 简化远程调用；原生 API 版本管理；全面采用 JSpecify 空安全体系（默认非空，编译期防 NPE）；关键依赖升级至 Jackson 3.0、Tomcat 11、Hibernate 7.1 等；模块化设计改进；化支持 Gradle 9；Redis 静态主从配置；移除 Undertow。</p>
<p>我专门分享过一篇文章介绍这些新特性：<a href="https://juejin.cn/post/7574749664492781602" target="_blank" title="https://juejin.cn/post/7574749664492781602">Spring Boot 4.0 正式发布，人已麻。。。</a>（确实已经麻了）。</p>
<h2 data-id="heading-1">版本变更总览</h2>
<p>在这里提个醒，升级千万别“跳级”。官方建议的升级路径：<strong>3.3/3.4 → 3.5 → 4.0</strong>，这条路径能避免 90% 的坑。</p>




























































<table><thead><tr><th>组件</th><th>升级前</th><th>升级后</th></tr></thead><tbody><tr><td>Spring Boot</td><td>3.3.6</td><td>4.0.1</td></tr><tr><td>Spring Framework</td><td>6.x</td><td>7.x</td></tr><tr><td>Spring AI</td><td>1.1.2</td><td>2.0.0-M1</td></tr><tr><td>Redisson</td><td>3.24.3</td><td>4.0.0</td></tr><tr><td>Gradle</td><td>8.8</td><td>8.14</td></tr><tr><td>Hibernate</td><td>6.x</td><td>7.2.0.Final</td></tr><tr><td>Tomcat</td><td>10.x</td><td>11.0.15</td></tr><tr><td>Jackson</td><td>2.x</td><td>3.x</td></tr><tr><td>iText</td><td>7.2.5</td><td>8.0.5</td></tr><tr><td>MapStruct</td><td>1.5.5.Final</td><td>1.6.3</td></tr></tbody></table>
<h2 data-id="heading-2">升级步骤详解</h2>
<h3 data-id="heading-3">Step 1: 升级 Gradle</h3>
<p>Spring Boot 4.0 要求 Gradle 8.14 或更高版本。首先需要升级 Gradle Wrapper：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时使用旧版本 Spring Boot 执行 wrapper 升级命令</span>
./gradlew wrapper --gradle-version=8.14
</code></pre>
<p>修改 <code>gradle/wrapper/gradle-wrapper.properties</code>：</p>
<pre><code class="hljs language-properties" lang="properties">distributionUrl=https\://services.gradle.org/distributions/gradle-8.14-bin.zip
</code></pre>
<h3 data-id="heading-4">Step 2: 更新依赖版本</h3>
<p>修改 <code>gradle/libs.versions.toml</code>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[versions]</span>
<span class="hljs-attr">spring-boot</span> = <span class="hljs-string">"4.0.1"</span>
<span class="hljs-attr">spring-ai</span> = <span class="hljs-string">"2.0.0-M1"</span>
<span class="hljs-attr">redisson</span> = <span class="hljs-string">"4.0.0"</span>
<span class="hljs-attr">mapstruct</span> = <span class="hljs-string">"1.6.3"</span>
<span class="hljs-attr">aws-sdk</span> = <span class="hljs-string">"2.29.51"</span>
<span class="hljs-attr">itext</span> = <span class="hljs-string">"8.0.5"</span>
<span class="hljs-attr">lombok</span> = <span class="hljs-string">"1.18.36"</span>
<span class="hljs-attr">junit-jupiter</span> = <span class="hljs-string">"5.12.0"</span>

<span class="hljs-section">[plugins]</span>
<span class="hljs-attr">spring-boot</span> = { id = <span class="hljs-string">"org.springframework.boot"</span>, version.ref = <span class="hljs-string">"spring-boot"</span> }
<span class="hljs-attr">spring-dependency-management</span> = { id = <span class="hljs-string">"io.spring.dependency-management"</span>, version = <span class="hljs-string">"1.1.7"</span> }
</code></pre>
<p><code>libs.versions.toml</code>是 Gradle 7.0 引入并从 7.4 版本开始正式推荐的 <strong>“版本目录”（Version Catalog）</strong> 文件。它的核心作用是<strong>集中管理项目中所有的依赖库及其版本号</strong>。</p>
<h3 data-id="heading-5">Step 3: 模块化重构 (Starter 变更)</h3>
<p>Spring Boot 4.0 采用了更细粒度的模块化设计，需要更新 starter 依赖：</p>
<pre><code class="hljs language-groovy" lang="groovy">// 升级前
implementation 'org.springframework.boot:spring-boot-starter-web'

// 升级后
implementation 'org.springframework.boot:spring-boot-starter-webmvc'
</code></pre>
<p>完整的 <code>build.gradle</code> 依赖变更：</p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    // Spring Boot Starters (Boot 4.0 modular design)
    implementation 'org.springframework.boot:spring-boot-starter-webmvc'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'

    // Spring AI 2.0
    implementation "org.springframework.ai:spring-ai-starter-model-openai:${libs.versions.spring.ai.get()}"
    implementation "org.springframework.ai:spring-ai-starter-vector-store-pgvector:${libs.versions.spring.ai.get()}"

    // Redisson 4.0
    implementation "org.redisson:redisson-spring-boot-starter:${libs.versions.redisson.get()}"

    // iText 8
    implementation "com.itextpdf:itext-core:${libs.versions.itext.get()}"
    implementation "com.itextpdf:font-asian:${libs.versions.itext.get()}"
}
</code></pre>
<h3 data-id="heading-6">Step 4: 史上最坑的 Jackson 3 迁移</h3>
<p>这是本次升级最痛苦的部分。Jackson 3 将包名从 <code>com.fasterxml.jackson</code> 全面改为了 <code>tools.jackson</code>。这意味着你项目中所有的 <code>ObjectMapper</code>、<code>JsonNode</code> 导入都失效了。</p>
<p><strong>需要修改的导入语句：</strong></p>





















<table><thead><tr><th>升级前</th><th>升级后</th></tr></thead><tbody><tr><td><code>com.fasterxml.jackson.databind.ObjectMapper</code></td><td><code>tools.jackson.databind.ObjectMapper</code></td></tr><tr><td><code>com.fasterxml.jackson.core.type.TypeReference</code></td><td><code>tools.jackson.core.type.TypeReference</code></td></tr><tr><td><code>com.fasterxml.jackson.core.JsonProcessingException</code></td><td><code>tools.jackson.core.JacksonException</code></td></tr></tbody></table>
<p><strong>示例代码修改：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前</span>
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;

<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(data);
} <span class="hljs-keyword">catch</span> (JsonProcessingException e) {
    <span class="hljs-comment">// 处理异常</span>
}

<span class="hljs-comment">// 升级后</span>
<span class="hljs-keyword">import</span> tools.jackson.core.JacksonException;
<span class="hljs-keyword">import</span> tools.jackson.core.type.TypeReference;
<span class="hljs-keyword">import</span> tools.jackson.databind.ObjectMapper;

<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(data);
} <span class="hljs-keyword">catch</span> (JacksonException e) {
    <span class="hljs-comment">// 处理异常</span>
}
</code></pre>
<p>我们需要在 <code>PdfExportService</code>、<code>RedisService</code> 等 7 个核心业务类中，利用 IDE 的全局替换功能，将 <code>com.fasterxml.jackson</code> 统一修正为 <code>tools.jackson</code>。</p>
<h3 data-id="heading-7">Step 5: Redisson 4.0 API 迁移</h3>
<p>Redisson 4.0 对部分类进行了包重组，<code>StreamMessageId</code> 等 Stream 相关类移至新包：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前</span>
<span class="hljs-keyword">import</span> org.redisson.api.StreamMessageId;

<span class="hljs-comment">// 升级后</span>
<span class="hljs-keyword">import</span> org.redisson.api.stream.StreamMessageId;
</code></pre>
<p>这个还好点，只涉及到 3 个类：</p>
<ul>
<li><code>infrastructure/redis/RedisService.java</code></li>
<li><code>modules/resume/listener/AnalyzeStreamConsumer.java</code></li>
<li><code>modules/knowledgebase/listener/VectorizeStreamConsumer.java</code></li>
</ul>
<h2 data-id="heading-8">验证升级结果</h2>
<p>升级完成后，运行以下命令验证：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译项目</span>
./gradlew :app:compileJava

<span class="hljs-comment"># 运行测试</span>
./gradlew :app:build

<span class="hljs-comment"># 启动应用</span>
./gradlew :app:bootRun
</code></pre>
<p>成功启动后，日志应显示：</p>
<pre><code class="hljs language-markdown" lang="markdown">  .   <span class="hljs-strong">____</span>          _            __ _ _
 /\\ / <span class="hljs-strong">__<span class="hljs-emphasis">_'_</span> __</span> _ <span class="hljs-emphasis">_(_</span>)_ __  __ _ \ \ \ \
( ( )\<span class="hljs-strong">___ | '_ | '<span class="hljs-emphasis">_| | '_</span> \/ <span class="hljs-emphasis">_` | \ \ \ \
 \\/  _</span>__</span>)| |<span class="hljs-emphasis">_)| | | | | || (_</span>| |  ) ) ) )
  '  |<span class="hljs-strong">____</span>| .<span class="hljs-strong">__|<span class="hljs-emphasis">_| |_</span>|<span class="hljs-emphasis">_| |_</span>\__</span>, | / / / /
 =========|<span class="hljs-emphasis">_|==============|<span class="hljs-strong">___/=/_/_/_/

 :: Spring Boot ::                (v4.0.1)

... Tomcat initialized with port 8080 (http)
... Starting Servlet engine: [Apache Tomcat/11.0.15]
... Redisson 4.0.0
... HHH000001: Hibernate ORM core version 7.2.0.Final
</span></span></code></pre>
<h2 data-id="heading-9">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspring.io%2Fblog%2F2025%2F11%2F20%2Fspring-boot-4-0-0-available-now%2F" target="_blank" title="https://spring.io/blog/2025/11/20/spring-boot-4-0-0-available-now/" ref="nofollow noopener noreferrer">Spring Boot 4.0 发布公告</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-boot%2Fwiki%2FSpring-Boot-4.0-Migration-Guide" target="_blank" title="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-4.0-Migration-Guide" ref="nofollow noopener noreferrer">Spring Boot 4.0 Migration Guide</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspring.io%2Fblog%2F2025%2F12%2F11%2Fspring-ai-2-0-0-M1-available-now%2F" target="_blank" title="https://spring.io/blog/2025/12/11/spring-ai-2-0-0-M1-available-now/" ref="nofollow noopener noreferrer">Spring AI 2.0.0-M1 发布公告</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fredisson%2Fredisson%2Fblob%2Fmaster%2FCHANGELOG.md" target="_blank" title="https://github.com/redisson/redisson/blob/master/CHANGELOG.md" ref="nofollow noopener noreferrer">Redisson Changelog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFasterXML%2Fjackson%2Fwiki%2FJackson-Release-3.0" target="_blank" title="https://github.com/FasterXML/jackson/wiki/Jackson-Release-3.0" ref="nofollow noopener noreferrer">Jackson 3 Release Notes</a></li>
</ul>
<h2 data-id="heading-10">总结</h2>
<p>本次 Spring Boot 4.0 的升级主要涉及以下几个方面：</p>
<ol>
<li><strong>构建工具升级</strong>：Gradle 8.14+</li>
<li><strong>模块化变更</strong>：<code>starter-web</code> → <code>starter-webmvc</code></li>
<li><strong>Jackson 3 迁移</strong>：包名从 <code>com.fasterxml.jackson</code> 改为 <code>tools.jackson</code></li>
<li><strong>第三方库兼容</strong>：Redisson、Spring AI 等需要升级到对应的兼容版本</li>
</ol>
<p>遵循官方推荐的 3.3 → 3.5 → 4.0 升级路径，可以更平滑地完成迁移。升级过程中遇到的大多数问题都与包名变更有关，通过全局搜索替换即可解决。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">InterviewGuide</a> 传送门：</p>
<ul>
<li>Github 地址：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnailclimb%2Finterview-guide" target="_blank" title="https://github.com/Snailclimb/interview-guide" ref="nofollow noopener noreferrer">github.com/Snailclimb/…</a></strong></li>
<li>Gitee 地址：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FSnailClimb%2Finterview-guide" target="_blank" title="https://gitee.com/SnailClimb/interview-guide" ref="nofollow noopener noreferrer">gitee.com/SnailClimb/…</a></strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS 多模块项目中的公共库治理与最佳实践]]></title>    <link>https://juejin.cn/post/7594655863548280884</link>    <guid>https://juejin.cn/post/7594655863548280884</guid>    <pubDate>2026-01-13T12:43:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594655863548280884" data-draft-id="7594616268781961243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS 多模块项目中的公共库治理与最佳实践"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-13T12:43:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS 多模块项目中的公共库治理与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:43:30.000Z" title="Tue Jan 13 2026 12:43:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <strong>鸿蒙（HarmonyOS）多模块项目</strong> 中，如果你希望 <strong>避免在每个模块（Module）中重复集成同一个三方库或公共库</strong>，可以将该库 <strong>提升到项目级别（Project-level）进行统一管理</strong>。以下是标准做法，适用于 <strong>Stage 模型 + ArkTS + DevEco Studio</strong> 的工程结构。</p>
<hr/>
<h2 data-id="heading-0">✅ 目标</h2>
<blockquote>
<p>将公共库（如 <code>@ohos/utils</code>、自研工具库、第三方 npm 包等）<strong>只声明一次</strong>，供多个模块（entry、feature、service 等）<strong>共享使用</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">📁 鸿蒙项目结构回顾</h2>
<pre><code class="hljs language-bash" lang="bash">MyHarmonyProject/
├── build-profile.json5        ← 项目级构建配置
├── oh-package.json5           ← 项目级依赖（关键！）
├── modules/
│   ├── entry/                 ← 主模块
│   ├── feature_news/          ← 功能模块1
│   └── feature_ebook/         ← 功能模块2
└── libs/                      ← （可选）本地 aar/har 公共库
</code></pre>
<hr/>
<h2 data-id="heading-2">✅ 正确做法：在 <strong>项目根目录的 <code>oh-package.json5</code></strong> 中声明依赖</h2>
<h3 data-id="heading-3">步骤 1：在项目根目录的 <code>oh-package.json5</code> 中添加依赖</h3>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-regexp">//</span> 开发依赖（如 types）
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-regexp">//</span> 👇 把公共库放在这里（项目级）
    <span class="hljs-string">"@ohos/utils"</span>: <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-string">"some-third-party-lib"</span>: <span class="hljs-string">"^2.3.0"</span>
  }
}
</code></pre>
<blockquote>
<p>✅ 这样，<strong>所有子模块都可以继承使用这些依赖</strong>，无需在每个 <code>module/xxx/oh-package.json5</code> 中重复声明。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">步骤 2：<strong>删除各子模块中的重复依赖</strong></h3>
<p>确保 <code>modules/entry/oh-package.json5</code>、<code>modules/feature_news/oh-package.json5</code> 等 <strong>不再包含</strong> 已提升到项目级的依赖。</p>
<p>例如，<strong>不要</strong>在 <code>entry/oh-package.json5</code> 中再写：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@ohos/utils"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span>  <span class="hljs-comment">// ❌ 删除这行！</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">步骤 3：在子模块代码中正常 import 使用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在 entry 或 feature_news 模块中</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ZGJYBAppearanceColorUtil</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/utils'</span>;

<span class="hljs-comment">// ✅ 可以正常使用，因为依赖已由项目级提供</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">⚠️ 注意事项</h2>
<h3 data-id="heading-7">1. <strong>仅适用于 <code>npm</code> 类型的包（通过 <code>ohpm</code> 安装）</strong></h3>
<ul>
<li>如果你是通过 <code>ohpm install @ohos/utils</code> 安装的库，它会被记录在 <code>oh-package.json5</code>。</li>
<li>这种方式支持 <strong>依赖提升（hoisting）</strong> ，类似 npm/yarn 的 workspace。</li>
</ul>
<h3 data-id="heading-8">2. <strong>本地 <code>.har</code> 或 <code>.hap</code> 库不能这样共享</strong></h3>
<ul>
<li>
<p>如果你的“库”是一个 <strong>本地开发的 <code>.har</code>（HarmonyOS Archive）模块</strong>，则需要：</p>
<ul>
<li>将其放在 <code>libs/</code> 目录下；</li>
<li>在 <strong>每个需要使用的模块</strong> 的 <code>module.json5</code> 中声明 <code>deps</code> 引用；</li>
<li>或者将其发布为私有 <code>ohpm</code> 包，再通过 <code>oh-package.json5</code> 引入。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">示例：引用本地 har（仍需逐模块配置）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// modules/entry/module.json5</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"deps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"../libs/my-common-utils.har"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>❌ 这种情况<strong>无法完全避免重复声明</strong>，但你可以通过脚本或模板减少工作量。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">3. <strong>确保 DevEco Studio 同步了依赖</strong></h3>
<ul>
<li>
<p>修改 <code>oh-package.json5</code> 后，点击 <strong>“Sync Now”</strong> 或运行：</p>
<pre><code class="hljs">ohpm install
</code></pre>
<p>在项目根目录执行，会安装所有模块共享的依赖。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-11">✅ 最佳实践总结</h2>

























<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>公共 npm/ohpm 库</strong>（如 <code>@ohos/utils</code>）</td><td>✅ 在 <strong>项目根目录 <code>oh-package.json5</code></strong> 中声明一次</td></tr><tr><td><strong>自研公共逻辑</strong>（TS 工具函数）</td><td>✅ 创建一个 <code>shared</code> 模块，发布为 <code>ohpm</code> 私有包，再在项目级引入</td></tr><tr><td><strong>本地 <code>.har</code> 库</strong></td><td>⚠️ 需在每个模块的 <code>module.json5</code> 中引用，但可统一放在 <code>libs/</code> 目录管理</td></tr><tr><td><strong>避免重复代码</strong></td><td>✅ 抽象公共组件/工具到独立模块，通过依赖注入使用</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">🔧 附加建议：创建 <code>shared</code> 模块（高级）</h2>
<ol>
<li>
<p>新建模块：<code>File &gt; New &gt; Module &gt; Static Library (HAR)</code></p>
<ul>
<li>命名为 <code>shared</code></li>
</ul>
</li>
<li>
<p>在其中放置公共工具类、常量、网络封装等</p>
</li>
<li>
<p>在 <code>shared/oh-package.json5</code> 中定义包名：</p>
<pre><code class="hljs language-perl" lang="perl">{ <span class="hljs-string">"name"</span>: <span class="hljs-string">"@myorg/shared"</span>, <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span> }
</code></pre>
</li>
<li>
<p>在项目根目录运行：</p>
<pre><code class="hljs language-bash" lang="bash">ohpm install ./modules/shared --save
</code></pre>
</li>
<li>
<p>然后在 <code>oh-package.json5</code> 中就会出现：</p>
<pre><code class="hljs language-less" lang="less">"<span class="hljs-selector-tag">dependencies</span>": {
  "<span class="hljs-variable">@myorg</span>/shared<span class="hljs-string">": "</span><span class="hljs-attribute">file</span>:./modules/shared"
}
</code></pre>
</li>
<li>
<p>所有模块即可通过 <code>import { xxx } from '@myorg/shared'</code> 使用。</p>
</li>
</ol>
<blockquote>
<p>✅ 这是最接近“项目级公共库”的鸿蒙官方推荐方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">✅ 结论</h2>
<blockquote>
<p><strong>把公共库写在项目根目录的 <code>oh-package.json5</code> 的 <code>dependencies</code> 中，即可实现“一次集成，多模块共享”</strong> 。</p>
</blockquote>
<p>只要你的库是通过 <code>ohpm</code> 管理的（包括本地 file: 引用），就支持这种共享机制。这是 HarmonyOS 多模块项目的标准依赖管理方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[驾驭 CPU 与编译器：Apache Doris 实现极致性能的底层逻辑]]></title>    <link>https://juejin.cn/post/7594655863548264500</link>    <guid>https://juejin.cn/post/7594655863548264500</guid>    <pubDate>2026-01-13T12:43:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594655863548264500" data-draft-id="7594661351513276451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="驾驭 CPU 与编译器：Apache Doris 实现极致性能的底层逻辑"/> <meta itemprop="keywords" content="运维,Apache,数据库"/> <meta itemprop="datePublished" content="2026-01-13T12:43:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            驾驭 CPU 与编译器：Apache Doris 实现极致性能的底层逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:43:24.000Z" title="Tue Jan 13 2026 12:43:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>过去 10 年，数据分析基准的成绩已经提升了数十倍。这种性能的提升造就了商业世界中更大的可能——从特定维度的 MOLAP 分析和周期报表，到随时随地从任意维度分析中发掘新范式的 Ad-hoc 查询，直到现在基于 Agent 派生出的复杂查询、高并发 + 高性能需求。基于日益实时、智能的 OLAP 引擎，企业的数据资产正在产生更大的价值。</p>
<p>从简单、固定、分钟到小时级别的查询，到亚秒级、PB 级数据、大宽表、高并发、复杂 JOIN 和聚合，我们为何在今天能够实现当初不敢想象的分析需求？</p>
<p>Apache Doris 的演进给我们提供了一个生动的答案——它不仅跟随硬件与编译器的发展而演进，更主动地通过向量化、模板化、指令级并行与精细的用户态调度模式，将每一代 CPU 的潜力推向理论极限。</p>
<h2 data-id="heading-0">1. Background：硬件与编译器的变迁</h2>
<p>这十年硬件与编译器的发展轨迹，彻底改变了高性能数据库的设计哲学：</p>
<ol>
<li><strong>CPU：从“更快”到“更宽、更多”</strong>
<ol>
<li><strong>主频停滞，核心爆发</strong>：单个核心的主频已在 3-5GHz 徘徊多年，性能提升转而依赖<strong>核心数量</strong>（从个位数到百核级）和单核心的并行宽度（<strong>SIMD</strong>）。</li>
<li><strong>内存墙加剧</strong>：CPU 与主存的速度差距已超 300 倍。<strong>缓存命中率</strong>成为性能的生命线，一次缓存未命中（Cache Miss）的代价足以执行数百条指令。</li>
<li><strong>SIMD 成为标配</strong>：AVX2（256 位）、AVX-512（512 位）及 ARM SVE 等指令集，允许单条指令处理 4 至 16 个数据单元。不用 <strong>SIMD</strong>，就等于主动浪费超过 80%的浮点算力。</li>
</ol>
</li>
<li><strong>编译器</strong>：从“翻译者”到“优化合作伙伴”
<ol>
<li><strong>激进的内联与向量化</strong>：现代编译器（如 Clang/GCC）能在编译期进行<strong>循环展开、分支消除、自动向量化</strong>，但其优化能力极度依赖代码模式。<strong>虚函数、指针别名、分支预测失败</strong>会瞬间阻断其优化通路。</li>
<li><strong>跨平台抽象</strong>：通过优良的代码模式，编译器能够自动为循环生成 SIMD 代码，无缝迁移不同平台。但对于复杂的数据处理逻辑，仍然需要手动生成 SIMD 代码。</li>
</ol>
</li>
<li><strong>新硬件下的 OLAP 性能陷阱</strong>
<ol>
<li>
<p>基础设施的升级迭代，意味着传统数据库引擎的微观开销被急剧放大：</p>
</li>
<li>
<p><strong>火山模型</strong>：每行的虚函数调用，导致<strong>指令缓存（I-Cache）</strong> 被频繁冲刷，核心处于“饥渴”状态。</p>
</li>
<li>
<p><strong>动态分支</strong>：在数据密集的循环中，一次预测失败可能清空长达 15-20 级的指令流水线。</p>
</li>
<li>
<p><strong>随机内存访问</strong>：不连续的内存访问模式，让 CPU 的<strong>预取器</strong>（Prefetcher）失效，大部分时间在等待数据从内存加载。</p>
</li>
</ol>
</li>
</ol>
<p>因此，性能优化必须从“算法优化”下沉为“与硬件和编译器的对话”。Apache Doris（及其商业化版本）不断在各类主流 benchmark 上取得令人惊叹的领先（例如，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40selectdb.marketing%2Fselectdb-topped-clickbench-to-be-no-1-in-the-world-892709544245" target="_blank" title="https://medium.com/@selectdb.marketing/selectdb-topped-clickbench-to-be-no-1-in-the-world-892709544245" ref="nofollow noopener noreferrer">ClickBench#1</a>，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.velodb.io%2Fblog%2Fapache-doris-tops-json-bench-cold-queries" target="_blank" title="https://www.velodb.io/blog/apache-doris-tops-json-bench-cold-queries" ref="nofollow noopener noreferrer">JsonBench#1</a>，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.velodb.io%2Fblog%2Fapache-doris-tops-rta-bench" target="_blank" title="https://www.velodb.io/blog/apache-doris-tops-rta-bench" ref="nofollow noopener noreferrer">RtaBench#1</a>），背后正是这些与现代硬件体系协同进步的决心。</p>
<h2 data-id="heading-1">2. 向量化执行：从“行”到“列”的降维打击</h2>
<p>现代的 CPU 架构中，存在着大量激进如“黑科技”般的优化手段，例如指令乱序发射（OOE）、多级流水线、向量指令集（AVX、Neon、SVE）。它们能够使你的代码在同等的算力下性能倍增——前提是，你没有反模式。</p>
<ul>
<li><strong>指令乱序发射与流水线</strong>：现代 CPU 的流水线深度可达 15-20 级，并通过乱序执行引擎动态调度指令。互相没有依赖的指令虽然在汇编与机器码中有先后顺序，但实际可以完全并行。其性能发挥的关键在于指令流的连续性和可预测性。一次错误的分支预测会导致整个流水线被重置，带来约 15 个时钟周期的惩罚；而一次缓存未命中（Cache Miss） 导致的数百周期等待，更会让所有精巧设计瞬间归零。[1]</li>
<li><strong>微指令缓存（μop Cache）</strong>：μop Cache 是处理器前端的一种硬件缓存结构，能够缓存热指令，跳过解码阶段，提升每周期指令数（IPC）。根据常规统计，μop Cache 能够产生稳定、可观（2% ～ 10%）的 IPC 增加。但在目前常见的数据应用中，实际命中率从 30% 到 70% 差距很大[2]，是明显的性能提升点。</li>
<li><strong>向量指令集（SIMD）</strong>：这是性能提升一个数量级的核心武器。从 SSE 的 128 位到 AVX2 的 256 位，再到 AVX-512 的 512 位，意味着单条指令可同时处理的数据量从 4 个 32 位整数跃升至 16 个。理论峰值算力因此呈倍数增长。例如，在理想的数据密集循环中，使用 AVX-512 相比标量代码可带来 <strong>10 倍以上的吞吐量</strong>提升。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dfd3b61bcc14aa9aaecc8cbd83e7477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=Y34hyAPifLp7kdLEVyIJMTKC92g%3D" alt="2. 向量化执行：从“行”到“列”的降维打击.PNG" loading="lazy"/></p>
<p>早期的数据库执行引擎多基于火山模型（Volcano Model），以 <code>Tuple</code>（行）为单位进行处理。在 CPU 主频停滞、核心数增加的今天，这种方式导致了大量的<strong>虚函数调用</strong>和糟糕的<strong>指令缓存</strong>命中率。这是因为在逐行处理的情况下，我们需要频繁地切换处理对象（列）的类型，执行不同的操作。这导致指令缓存命中率极低，且无法利用向量化指令进行批量处理，逐行的虚函数开销最高可达常规执行的数十倍[3][5]。</p>
<p>Doris 的全面向量化重构，核心在于引入了<code>Block</code>和<code>Column</code>的概念。这是内存布局的重大变革：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad1ad6a1feb54bd6ac45241e0cbc6635~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=Nmc4cEsoIFJzMpTj%2F5nBJW32Zm8%3D" alt="2. 向量化执行：从“行”到“列”的降维打击-1.PNG" loading="lazy"/></p>
<h3 data-id="heading-2">2.1 内存布局与 Cache Locality</h3>
<p>在 Doris 的向量化引擎中，一列数据在内存中是连续存储的。例如一个<code>INT</code>类型的列，直接使用 Doris 中的<code>PODArray</code>（Plain Old Data Array）来存储数据。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">// 核心逻辑示意</span>
<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ColumnVector</span> <span class="hljs-keyword">final</span> : <span class="hljs-keyword">public</span> IColumn {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// PaddedPODArray 保证了内存对齐，通常按 64 字节对齐以适配 Cache Line</span>
    PaddedPODArray&lt;T&gt; data; 
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 向量化计算入口，不再处理单行，而是处理整个 data 数组</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">filter</span><span class="hljs-params">(<span class="hljs-type">const</span> Filter&amp; filt)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>这种布局保证了同一列的数据在物理上连续。当 CPU 从内存加载数据到 Cache 时，能够一次性加载多个数据项，极大提升了<strong>指令/数据缓存的局部性（Cache Locality）</strong>。由于近些年 CPU 数据 Cache 容量大幅提升，常规运算的完成较大程度依赖在 L2 cache 中完全装载数据。如果因为数据不连续频繁刷新缓存，可能带来 3～5 倍的局部性能损失[3][6]。</p>
<p>在传统批处理模型下，<code>Next()</code>接口一次返回的<code>Block</code> 通常包含 4096 行，那么就会发生 4096 次的虚函数调用。而在向量化代码中，整个 Column 每次一起处理，<strong>虚函数调用仅发生一次</strong>。在复杂算子（如 Hash Join、Aggregation）中，这种调用开销的降低是数量级的区别。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41371b5938a14b249abf66352798fd03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=PJ4076Mtr9uIPpd8TRqJxHfvfYw%3D" alt="2. 向量化执行：从“行”到“列”的降维打击-2.png" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 自动与手动向量化的结合</h3>
<p>随着编译器进化至今，编译优化的技术同数据库一样有了飞跃式的进步。在更多的场景下，编译器已能实现以前无法自动进行的优化。<strong>自动向量化</strong>（Auto Vectorization）就是其中的重要方面。</p>
<p>在绝大多数情况下，利用编译器自动生成向量化的代码是最佳的方案——它天然带来了跨平台迁移的友好，代码也一目了然。而这并不意味着相关代码的工程难度降低，许多时候反而更加复杂——因为最终执行的代码向量化程度不再是编码时的“所见即所得”，其中涉及到了复杂的编译器行为。要保证最高的代码生成质量，开发者编码时必须尽可能遵守良好的开发范式。</p>
<p>当然，在一些更为复杂的场景下，手动调用的向量化代码仍是不可避免的。因此 Doris 采用了“自动+手动”的双重策略：</p>
<ul>
<li><strong>自动向量化</strong>：对于绝大多数情况下，这是现代编译器提供给我们的最佳选择。核心在于，简化循环体，抽离控制流分支（Branch），让编译器识别出 Auto Vectorization 的机会。</li>
<li><strong>手动向量化</strong>：对于实际汇编识别出未能正常 Auto Vectorization 的算子，或是那些热点路径上的向量化需求，Doris 工程师并不避讳直接手写 Intrinsic 代码。相比于自动生成的代码，此种方式往往拥有更加极致的性能，几乎没有指令浪费。</li>
</ul>
<p>例如以下场景：</p>
<p><strong>A. 谓词过滤（Filter）</strong></p>
<p>在<code>WHERE</code>子句处理中，过滤结果通常是一个<code>uint8_t</code>的数组（0 或 1）。将过滤后的数据拷贝到新 Block 是高频操作。 Doris 利用 AVX2 的 <code>_mm256_movemask_epi8</code> 指令，快速生成选择掩码，并配合 <code>_mm256_permutevar8x32_epi32</code> 等指令进行数据重排（Shuffle），避免了传统分支判断带来的流水线冲刷。在相同的指令周期内，实现更大的数据吞吐量。</p>
<p><strong>B. 字符串与</strong> <strong>JSON</strong> <strong>处理</strong></p>
<p>字符串匹配（Like）、JSON 解析是 CPU 密集型操作。Doris 引入了特定的 SIMD 算法或者库：</p>
<ul>
<li><strong>Volnitsky 算法</strong>：在子串查找中，利用 SIMD 并行比较多个字符，快速跳过不匹配区域。</li>
<li><strong>SimdJson</strong>：在解析 JSON Path 时，利用 SIMD 指令快速定位结构符（如 <code>{</code>, <code>}</code>, <code>:</code>），大幅缩短解析路径。</li>
</ul>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">// SIMD 子串匹配</span>
<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* _search(<span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* haystack, <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>* haystack_end) <span class="hljs-type">const</span> {
    ......
    <span class="hljs-keyword">while</span> (haystack &lt; haystack_end &amp;&amp; haystack_end - haystack &gt;= needle_size) {
<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__SSE4_1__) || defined(__aarch64__)</span>
        <span class="hljs-keyword">if</span> ((haystack + <span class="hljs-number">1</span> + n) &lt;= haystack_end &amp;&amp; <span class="hljs-built_in">page_safe</span>(haystack)) {
            <span class="hljs-comment">/// find first and second characters</span>
            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> v_haystack_block_first =
                    _mm_loadu_si128(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> __m128i*&gt;(haystack));
            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> v_haystack_block_second =
                    _mm_loadu_si128(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> __m128i*&gt;(haystack + <span class="hljs-number">1</span>));

            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> v_against_pattern_first =
                    _mm_cmpeq_epi8(v_haystack_block_first, first_pattern);
            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> v_against_pattern_second =
                    _mm_cmpeq_epi8(v_haystack_block_second, second_pattern);

            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> mask = _mm_movemask_epi8(
                    _mm_and_si128(v_against_pattern_first, v_against_pattern_second));
            <span class="hljs-comment">/// first and second characters not present in 16 octets starting at `haystack`</span>
            <span class="hljs-keyword">if</span> (mask == <span class="hljs-number">0</span>) {
                haystack += n;
                <span class="hljs-keyword">continue</span>;
            }
    ......
}
</code></pre>
<h2 data-id="heading-4">3. 模板编译：消除运行时开销</h2>
<p>前面我们讨论了分支预测、数据和指令缓存、指令流水线这些“看得见摸不着”的性能关键点。那么，一次虚函数调用究竟会产生多大的开销？可以用一个小例子来说明：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualBase</span> {
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>;
};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualDerived</span> : <span class="hljs-keyword">public</span> VirtualBase {
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> <span class="hljs-keyword">override</span></span>;
};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NonVirtual</span> {
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">bar</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>;
};

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">BM_VirtualCall</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
    VirtualBase* obj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">VirtualDerived</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {
        result = obj-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">42</span>);
    }
}
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">BM_NonVirtualCall</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
    NonVirtualBase obj;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {
        result = obj.<span class="hljs-built_in">bar</span>(<span class="hljs-number">42</span>);
    }
}
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">BM_DirectCall</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
    VirtualDerived obj;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {
        result = obj.<span class="hljs-built_in">foo</span>(<span class="hljs-number">42</span>);
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c63a2af2c63548079414781cb2fb277a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=9D2rw4pLT5YbM3O3kigKu0f%2FKL4%3D" alt="3. 模板编译：消除运行时开销.png" loading="lazy"/></p>
<p>以上结果产生自 <code>Clang++ 17.0 -O3 -std=c++20</code> 条件下的测试，可以看到，虚函数调用导致了普通函数 <strong>5 倍的性能开销</strong>。</p>
<p>因此，如何尽可能消除虚函数是 OLAP 领域中的重要课题。过去的研究展现了两种常见的大方向：编译执行和向量化执行。<strong>Doris 选择的是向量化执行的方案</strong>，它通过一次处理一个 Block 的数据，将这些虚函数和分支的 overhead 均摊到数千行上。<em><strong>那么，有没有一种方式，能够在向量化执行的基础上，像编译执行一样彻底消除掉所有的分支 overhead 呢？答案是：有的。</strong></em></p>
<h3 data-id="heading-5">3.1 模板的艺术</h3>
<p>编译执行的本质是对于不同的类型、分支等代码路径，生成在当前条件下完全确定的代码，从而消去不同类型所需的判断和虚表访问。</p>
<p>例如对于一个<code>a + b</code>的操作，编译执行并没有一个通用的<code>add(Value a, Value b)</code>函数，而是为<code>int + int</code>、<code>double + double</code>生成了完全独立的机器码。CPU 在执行时，不仅没有虚函数指针跳转，甚至可以将简单的加法指令直接内联（Inline），从而充分利用指令流水线。</p>
<p>在“编译执行”框架下，这往往通过 LLVM JIT 等代码生成框架完成，针对用户的表达式现场生成一套完全固定的汇编并执行。但在“向量化执行”框架下，这同样可以通过 C++ 的<strong>模板编程</strong>实现。例如对于 days_add 函数：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">template</span> &lt;PrimitiveType PType&gt;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AddDaysImpl</span> {
    ......
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> ReturnNativeType <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">const</span> InputNativeType&amp; t, IntervalNativeType delta)</span> </span>{
        <span class="hljs-comment">// PType 已经固定，不需要运行期判断</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">date_time_add</span>&lt;TimeUnit::DAY, PType, IntervalNativeType&gt;(t, delta);
        <span class="hljs-comment">// compare to </span>
        <span class="hljs-comment">// if (t.is_date) {</span>
        <span class="hljs-comment">//     return date_time_add&lt;TimeUnit::DAY, DATEV2, IntervalNativeType&gt;(t, delta);</span>
        <span class="hljs-comment">// } else {</span>
        <span class="hljs-comment">//     return date_time_add&lt;TimeUnit::DAY, DATETIMEV2, IntervalNativeType&gt;(t, delta);</span>
        <span class="hljs-comment">// }</span>
    }
    <span class="hljs-comment">// 不同模板实例参数不同，函数匹配时直接命中对应实例</span>
    <span class="hljs-function"><span class="hljs-type">static</span> DataTypes <span class="hljs-title">get_variadic_argument_types</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> {std ::make_shared&lt;<span class="hljs-keyword">typename</span> PrimitiveTypeTraits&lt;PType&gt;::DataType&gt;(),
                std ::make_shared&lt;<span class="hljs-keyword">typename</span> PrimitiveTypeTraits&lt;IntervalPType&gt;::DataType&gt;()};
    }
}

<span class="hljs-keyword">using</span> FunctionAddDays = FunctionDateOrDateTimeComputation&lt;AddDaysImpl&lt;TYPE_DATEV2&gt;&gt;;
<span class="hljs-keyword">using</span> FunctionDatetimeAddDays = FunctionDateOrDateTimeComputation&lt;AddDaysImpl&lt;TYPE_DATETIMEV2&gt;&gt;;

factory.<span class="hljs-built_in">register_function</span>&lt;FunctionDatetimeAddDays&gt;();
factory.<span class="hljs-built_in">register_function</span>&lt;FunctionAddDays&gt;();
</code></pre>
<p>可以看到，对于不同的入参类型（DATE 和 DATETIME），函数在参数匹配时已经命中了不同的实例，这些实例各自包含确定的类型信息，规避了运行期的<strong>虚表访问</strong>，使原本无法<strong>内联</strong>的函数变为可能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6ba8719e5694fc78d99b70ccad65a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=HbacUj8Twm0m%2Bqoe4nMMDbVLr68%3D" alt="3. 模板编译：消除运行时开销-1.png" loading="lazy"/></p>
<h2 data-id="heading-6">4. 多线程内存分配：Jemalloc 与 Arena 的协同</h2>
<p>这些年 CPU 发展的新趋势是——主频、单核心性能增长相对缓慢，CPU 核心数却在不断增长[4]。尤其是在逐渐占领市场的 ARM 架构下，核心数量更是呈指数级倍增，从 2018 年之前的 16 核以内，一路达到了现在 192 核的高峰[7]。<strong>这意味着我们必须把更多的目光投向高并发（High Concurrency）场景。</strong></p>
<p>这种场景中，系统的瓶颈往往不在计算，而在 <code>malloc/free</code> <strong>锁竞争</strong>（Lock Contention）以及 <strong>TLB</strong>（Translation Lookaside Buffer）的刷新开销。典型 OLAP 查询会创建大量短生命周期对象（Hash Key、聚合状态、临时字符串）。如果这些都通过 glibc <code>malloc/free</code> 申请：</p>
<ul>
<li>每次都走系统分配器，锁竞争严重；</li>
<li>碎片多，RSS（常驻内存集，Resident Set Size）难以控制。</li>
</ul>
<p>由于锁护送（Lock Convoy）等效应的存在，随着 CPU 核心数增加，多线程竞争甚至可能导致多核吞吐不升反降[8]。一旦 L1、L2 缓存被驱逐，就又是 3-5 倍的数据访问开销。<strong>在内存分配上，这种性能瓶颈尤为突出。为避免全局竞争、有锁分配是 Doris 必须解决的技术问题。</strong></p>
<h3 data-id="heading-7">4.1 接管全局分配器</h3>
<p>因此，Doris 后端进程（BE）选择了链接 <code>Jemalloc</code> 进行内存分配。其核心优势在于 <strong>Thread Local Cache (Tcache)</strong>。每个执行线程拥有独立的内存分配缓存，绝大多数小对象的申请无需加锁，消除了全局锁竞争。许多小对象申请直接通过 Jemalloc 缓存解决，不进行系统调用。</p>
<h3 data-id="heading-8">4.2 Arena 内存池</h3>
<p>但在查询执行内部，Doris 并没有止步于此。在执行算子（如 Hash Join、Aggregation）时，Doris 使用 <code>Arena</code>（区域内存池）模式，这是因为很多对象的生命周期和“查询”绑定，完全可以在查询结束时统一回收。这直接带来了若干收益：</p>
<ul>
<li><strong>无锁分配</strong>：算子内部申请内存通常只是当前线程缓存内的指针简单移动（Bump Pointer），完全无锁。</li>
<li><strong>批量释放</strong>：查询结束后，整块 Arena 统一释放，避免了数百万次小对象的析构开销。</li>
<li><strong>Cache 友好</strong>：同一算子使用的对象在内存中紧凑排列，极大提升了 CPU 缓存命中率。</li>
</ul>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Arena</span> : <span class="hljs-keyword">private</span> boost::noncopyable {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Chunk</span> : <span class="hljs-keyword">private</span> Allocator&lt;<span class="hljs-literal">false</span>&gt; {
        ......
    }
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">alloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>{
        _init_head_if_needed();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">UNLIKELY</span>(head-&gt;pos + size &gt; head-&gt;end)) {
            _add_chunk(size);
        }
        <span class="hljs-comment">// 直接 bump pointer，开销无限小</span>
        <span class="hljs-type">char</span>* res = head-&gt;pos;
        head-&gt;pos += size;
        <span class="hljs-keyword">return</span> res;
    }
    <span class="hljs-comment">// 一次性统一回收</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">(<span class="hljs-type">bool</span> delete_head = <span class="hljs-literal">false</span>)</span> </span>{
        ......
    }
};
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c392f4ea465a4d7ab0a0d12e7369788b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=GpcYR7eecuK1lu7L4H0%2BO5nY594%3D" alt="4.2 Arena 内存池.png" loading="lazy"/></p>
<h2 data-id="heading-9">5. Pipeline 执行引擎：解决多核时代的调度瓶颈</h2>
<p>传统的火山模型对于每个 Instance 使用独立的线程进行处理，每个线程需要处理一个完整 Fragment（查询计划片段）的部分数据。显然，这时的任务调度完全依赖操作系统的线程调度，而这在 OLAP 场景下存在很多根本性问题：</p>
<ol>
<li>如果一个线程因为网络或磁盘 IO 阻塞，操作系统就会进行线程的<strong>上下文切换</strong>（Context Switch），开销在微秒级别。随着查询数量和规模增长，系统线程数暴涨，导致上下文切换频繁，overhead 明显增加；</li>
<li>无法细粒度实现 query 之间的公平调度。大小查询混合场景下，<strong>小查询</strong>被调度到的机会明显下降，延迟大幅增高；</li>
<li>线程频繁迁移，丧失 <strong>NUMA 和 Cache 亲和性</strong>，影响查询性能；</li>
<li>依赖底层数据分布，无法交换数据，<strong>数据倾斜</strong>对性能影响巨大</li>
</ol>
<p>……</p>
<p>核心问题是，依附于线程模型的 Instance 执行，其调度完全依赖操作系统，无法进行更细粒度的调整。由阻塞、亲和性、优先级带来的影响随着现代 CPU 核数不断增加、系统负载不断增高，严重性也逐步提升。在现代 CPU 上，单次 Context Switch 往往带来上千个指令周期的时间成本，近似于<strong>上千次浮点运算</strong>[3]。而这还不是最糟糕的——如果发生了跨核心迁移，更是会花费<strong>数微秒</strong>的代价用于缓存重建和 CPU Core 之间同步。高竞争环境下，CPU 可能有<strong>数个百分点</strong>的时间都花在这些非运算代价中。[9]</p>
<p>Doris 通过全新设计的 Pipeline 引擎，在用户态实现精细化的调度控制，终于解决了以上全部问题。本质上讲，它实现了一套完整的<strong>协程</strong>（Coroutine）语义，也就是用户态调度。极其符合 OLAP 负载的实际。</p>
<h3 data-id="heading-10">5.1 阻塞等待？Pipeline Task 拆分</h3>
<p>查询计划根据阻塞算子拆解为多个 <code>Pipeline</code>，每个 Pipeline 包含一组算子（Operator）。所有阻塞算子的多个上游均被拆分至不同的 Pipeline，所以 Pipeline <strong>内部完全不发生阻塞</strong>。每个逻辑 Pipeline 被实例化为多个物理 <code>PipelineTask</code>，可被多核同时调度以充分利用 CPU 资源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d086be76f70845f7ae22dc8adee17493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=yV134vXY2Ol6EIJJ7rHPWKzcOek%3D" alt="5.1 阻塞等待？Pipeline Task 拆分.png" loading="lazy"/></p>
<p>这保证了所有阻塞的操作不会占用执行线程，而是标记自身阻塞状态后，将当前<strong>线程交回给 Pipeline 调度器</strong>重新调度。因此，我们不再需要随着查询数量增多的线程了。</p>
<h3 data-id="heading-11">5.2 上下文切换？线程迁移？用户态调度器</h3>
<p>Doris 实现了一个类似于 Go Runtime（协程）的用户态调度器（Task Scheduler），它包含：</p>
<ul>
<li><strong>就绪队列（Runnable Queue）</strong>：一旦数据就绪，依赖被满足，Task 转移至就绪队列。可以随时被调度执行。</li>
<li><strong>阻塞队列（Blocked Queue）</strong>：当 Task 需要等待 IO 或 RPC 数据时，它被放入阻塞队列，<strong>不占用操作系统线程</strong>。</li>
<li><strong>执行线程池</strong>：一组固定数量的线程不断从就绪队列取出 Task 执行。<strong>执行线程绑核</strong>以保证 Cache 命中率。</li>
</ul>
<p>在此基础上，我们更进一步地迭代了新的 PipelineX 执行引擎，也就是 Doris 当前所使用的执行引擎。通过设置上下游 PipelineTask 之间依赖的方式进一步规避了对阻塞任务的轮询，实现了自动唤醒下游可执行任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/044bb3eceb3742b8923f2ba2e1094a31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=wByGn0yjpvITu8BFSQDKjG48FHc%3D" alt="5.2 上下文切换？线程迁移？用户态调度器.png" loading="lazy"/></p>
<h3 data-id="heading-12">5.3 数据倾斜？细粒度数据均衡</h3>
<p>我们前面说到，近年来 CPU 发展的特点是什么？更多的核心、更多的系统线程数。这意味着我们的同一个查询，可以同时拆分成更多份进行并行。这是个好事儿……吧？</p>
<p>一般来说是的。更多的线程意味着单位时间更大的吞吐。但这明显受到“短板效应”的制约——如果扫描的每个存储分桶（Bucket/Tablet）数据量不一致，上层每个 PipelineTask 的<strong>执行时间也必然不一致</strong>。在不同的查询负载下，仅通过调整分桶策略几乎无法找到最优解。</p>
<p>在 Doris 的新 Pipeline 引擎中，解决这一问题却很简单：通过添加 Local Shuffle 算子，对 PipelineTask 之间的数据进行重新分布，“数据倾斜”问题被全自动化地消解了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b52fd07f554b42b7fadba4cff97ef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=DR%2B72gJuLovbIX4BIMdmHztsSHA%3D" alt="5.3 数据倾斜？细粒度数据均衡.png" loading="lazy"/></p>
<h3 data-id="heading-13">5.4 小查询饿死？分时复用与抢占</h3>
<p>为了防止大查询饿死小查询，Pipeline 引擎引入了基于<strong>多级反馈队列</strong>的<strong>时间片轮转</strong>机制。一个 Task 每次在 CPU 上执行的时间有限（例如 100ms），如果当前时间片运行完，必须出让 CPU 给其他任务。同时，根据执行时间的累计，大的 Task 会被逐渐降级调度，保证小查询比大查询有更高的优先级，防止延迟被影响。</p>
<p>这种机制使得 Doris 在高并发<strong>混合负载</strong>下，CPU 利用率能够稳定维持在 95% 以上，且完全避免了线程爆炸（Thread Explosion）导致的系统抖动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/672831ab1067455fb414094f12c5e9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=EhqLfz1xYS0wcjSNtBrUBmoaHVg%3D" alt="5.4 小查询饿死？分时复用与抢占.png" loading="lazy"/></p>
<h2 data-id="heading-14">6. 落地：可验证的性能提升结果</h2>
<p>所以，我们罗列的这些技术，到底有用没有？是高大上的花活，还是真正能够落地到成熟系统中的关键优化呢？</p>
<p>来吧，让我们看一下 Apache Doris（及 VeloDB 等商业发行版）在各个<strong>优化前后的直接性能对比结果</strong>。经过长久的迭代，它们现在均已成为 Doris 坚实的架构基础。</p>
<h3 data-id="heading-15">6.1 向量化执行</h3>
<p>首先是向量化部分。在 1.2 版本，Doris 的向量化彻底成熟。相比于过去的火山模型，这是一次里程碑式的性能跃升——根据实验，开启向量化之后的 Doris 1.2 相比早期的 Doris 0.15，<strong>在 SSB-Flat 上性能提升了近 10 倍[10]，在 TPC-H 上提升了超过 11 倍，最显著的单个 SQL 提速更是达到了近 70 倍</strong>[11]。</p>
<h3 data-id="heading-16">6.2 Pipeline 执行引擎</h3>
<p>在 Doris 2.0 版本上，我们实现了 Pipeline 执行引擎，并在 2.1 版本进行了大的重构，使全部实现达到理想状态。在 Apache Doris 2.0 上的测试结果表明，Pipeline 引擎配合合理的 SQL 优化，<strong>达到了相比火山模型 100% 的 TPC-H 性能提升，相比于 Trino/Presto 更是有 3-5 倍的性能领先</strong>[12]。基于 Pipeline 引擎，Doris 更是引入了 Workload Group 进行资源划分和负载控制，有效解决了大型公司中面对大量用户复杂场景的稳定性问题。</p>
<p>在 Doris 2.1 中，我们的 Pipeline 引擎达到了最终形态，它具备了自适应解决数据倾斜的能力。相比于已经达到业内领先水平的 Doris 2.0，它在 TPC-DS 上进一步<strong>实现了 100% 的性能提升。在数据不均衡、分桶数极不合理的极端情况下重新测试 ClickBench 和 TPC-H，也几乎不产生性能损失</strong>[13]。</p>
<h3 data-id="heading-17">6.3 ARM 架构优化</h3>
<p>得益于 Doris 精细的向量化实现，ARM 架构下 Doris 的性能相比于其他产品，产生了比 X86 平台更大的领先优势。Doris 2.1 是第一个针对 ARM 架构深度优化的版本。相比于前一个版本，<strong>ARM 下的 Doris 2.1 在 ClickBench 上的成绩提升了 230%，TPC-H 上也达到了接近 1 倍的性能提升</strong>。[14]</p>
<p>尤其是在 AWS Graviton4 架构下，Doris 凭借卓越的优化，<strong>相比于 X86 在 ClickBench、SSB、SSB-Flat、TPC-H、TPC-DS 上分别取得了 65%、54%、53%、54%、60% 的性价比提升[14]</strong>。昭示着 ARM 俨然成为了数据分析领域高性价比的选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47ba0c5f2ab64809afb7f4b716c2ba05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913003&amp;x-signature=j6vBJyvd9I4pD%2FA02XcoxlGwPHU%3D" alt="6.3 ARM 架构优化.png" loading="lazy"/></p>
<h3 data-id="heading-18">6.4 整体性能领先</h3>
<p>相比于 Clickhouse、Trino 等其他 OLAP 分析引擎，Doris 的横向对比成绩究竟如何？经历了这么多优化之后，是否真正取得了领先？以下是一些事实结果：</p>
<ul>
<li>相比于 Clickhouse，Doris 在其自家维护的 ClickBench 上曾多次取得领先，上一次提交的成绩位列<strong>第 2 名</strong>，领先于 Clickhouse 的第三名 2% 的总分。在 SSB、TPC-H 上，更是分别有 <strong>3 倍和 60 倍的性能领先</strong>。在 TPC-DS 上，Clickhouse 在同等资源下只能执行约 50% 的查询，<strong>这部分成绩比 Doris 的总成绩还落后 1 倍</strong>[15]。
<ul>
<li>而在实时更新场景中，二者差距更大。根据发行商 VeloDB 的测试结果，在比 Clickhouse 更差的硬件条件下，<strong>25% 更新率场景下 Doris 比 Clickhouse 快 14 倍；100% 更新率时领先更是达到了 18 倍</strong>[16]。</li>
</ul>
</li>
<li>相比于 Trino/Presto，Doris 在 TPC-DS 1TB 测试中使用同等条件进行数据湖查询，<strong>达到了 3 倍的性能领先</strong>；使用 Doris <strong>内表性能领先更是达到 10 倍之多</strong>。在实际用户场景中，<strong>查询延时更是降低了最多 20 倍</strong>[17]。</li>
<li>与 Spark 对比，Doris 在其擅长的<strong>复杂查询下性能领先 4-6 倍</strong>，实时场景下更是实现了代际级别的延迟优势[13]。</li>
<li>对比擅长半结构化数据存储的 ElasticSearch，Doris <strong>在半结构化测试集 JsonBench 上达到了 2 倍性能领先，同时超越了 Clickhouse。相比于 Postgresql 领先幅度更是达到 80 倍之多</strong>[18]。</li>
</ul>
<h2 data-id="heading-19">总结</h2>
<p>过去十年，OLAP 性能需求的演进，本质上是向底层要算力的一场硬仗。当查询变得复杂、数据量暴涨、并发攀升时，传统执行引擎在硬件层面的低效被无限放大。Apache Doris 团队面对的，正是如何驾驭现代多核 CPU 与智能编译器，将每一份硬件潜能转化为稳定的性能提升。</p>
<p>挑战是明确的：如何消除虚函数和分支预测带来的开销？如何让内存访问模式更适配 CPU 缓存？如何在高并发下避免锁与调度成为瓶颈？Doris 的应对策略清晰而系统：</p>
<ul>
<li>针对计算效率，我们通过全面的向量化重构和模板化编程，将处理单元从“行”升级为“列”，并在编译期固化类型与分支，让生成的代码近乎直接匹配 CPU 的高效流水线。</li>
<li>针对内存效率，我们引入专用的内存分配器与池化技术，大幅削减高并发下的锁竞争与碎片，确保数据在缓存中紧凑排列。</li>
<li>针对多核调度，我们自研 Pipeline 执行引擎，在用户态实现精细的任务调度与数据均衡，彻底解决操作系统线程模型在 OLAP 场景下的固有缺陷。</li>
</ul>
<p>这些优化不是孤立的技术堆砌，而是一套贯穿数据从加载到计算全链路的系统性工程。其核心在于，团队始终保持着对硬件行为与编译器逻辑的深刻理解，并以此驱动架构演进——让代码的写法顺应硬件的“脾气”，让执行路径契合编译器的“优化逻辑”。</p>
<p>最终，这使 Doris 能够持续地将每一代 CPU 的理论算力，稳定地转化为用户场景下的实际吞吐与低延迟。性能的极致，来自于对底层细节的持续深耕与系统化掌控。</p>
<h2 data-id="heading-20">参考文献</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.abhik.xyz%2Fconcepts%2Fperformance%2Fcpu-pipelines" target="_blank" title="https://www.abhik.xyz/concepts/performance/cpu-pipelines" ref="nofollow noopener noreferrer">www.abhik.xyz/concepts/pe…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebs.um.es%2Faros%2Fpapers%2Fpdfs%2Fssingh-isca24.pdf" target="_blank" title="https://webs.um.es/aros/papers/pdfs/ssingh-isca24.pdf" ref="nofollow noopener noreferrer">webs.um.es/aros/papers…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.codingconfessions.com%2Fp%2Fcontext-switching-and-performance" target="_blank" title="https://blog.codingconfessions.com/p/context-switching-and-performance" ref="nofollow noopener noreferrer">blog.codingconfessions.com/p/context-s…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servethehome.com%2Fupdated-amd-epyc-and-intel-xeon-core-counts-over-time" target="_blank" title="https://www.servethehome.com/updated-amd-epyc-and-intel-xeon-core-counts-over-time" ref="nofollow noopener noreferrer">www.servethehome.com/updated-amd…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffaculty.cs.niu.edu%2F~winans%2Fnotes%2Fpatmc.pdf" target="_blank" title="https://faculty.cs.niu.edu/~winans/notes/patmc.pdf" ref="nofollow noopener noreferrer">faculty.cs.niu.edu/~winans/not…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpikuma.com%2Fblog%2Funderstanding-computer-cache" target="_blank" title="https://pikuma.com/blog/understanding-computer-cache" ref="nofollow noopener noreferrer">pikuma.com/blog/unders…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.phoronix.com%2Freview%2Fampereone-aws-graviton4" target="_blank" title="https://www.phoronix.com/review/ampereone-aws-graviton4" ref="nofollow noopener noreferrer">www.phoronix.com/review/ampe…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgrokipedia.com%2Fpage%2FNon-blocking_algorithm" target="_blank" title="https://grokipedia.com/page/Non-blocking_algorithm" ref="nofollow noopener noreferrer">grokipedia.com/page/Non-bl…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.systemoverflow.com%2Flearn%2Fos-systems-fundamentals%2Fcpu-scheduling%2Fwhat-is-cpu-scheduling-and-context-switching" target="_blank" title="https://www.systemoverflow.com/learn/os-systems-fundamentals/cpu-scheduling/what-is-cpu-scheduling-and-context-switching" ref="nofollow noopener noreferrer">www.systemoverflow.com/learn/os-sy…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fblog%2Fssb" target="_blank" title="https://doris.apache.org/blog/ssb" ref="nofollow noopener noreferrer">doris.apache.org/blog/ssb</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fblog%2Ftpch" target="_blank" title="https://doris.apache.org/blog/tpch" ref="nofollow noopener noreferrer">doris.apache.org/blog/tpch</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.velodb.io%2Fblog%2Fmilestone-apache-doris-2-0" target="_blank" title="https://www.velodb.io/blog/milestone-apache-doris-2-0" ref="nofollow noopener noreferrer">www.velodb.io/blog/milest…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.velodb.io%2Fblog%2Fapache-doris-2-1-0-released" target="_blank" title="https://www.velodb.io/blog/apache-doris-2-1-0-released" ref="nofollow noopener noreferrer">www.velodb.io/blog/apache…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.velodb.io%2Fblog%2Fapache-doris-achieves-70-better-price-performance" target="_blank" title="https://www.velodb.io/blog/apache-doris-achieves-70-better-price-performance" ref="nofollow noopener noreferrer">www.velodb.io/blog/apache…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdocs%2F3.x%2FgettingStarted%2Falternatives%2Falternative-to-clickhouse" target="_blank" title="https://doris.apache.org/docs/3.x/gettingStarted/alternatives/alternative-to-clickhouse" ref="nofollow noopener noreferrer">doris.apache.org/docs/3.x/ge…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.velodb.io%2Fblog%2Fapache-doris-34x-faster-clickhouse-realtime-updates" target="_blank" title="https://www.velodb.io/blog/apache-doris-34x-faster-clickhouse-realtime-updates" ref="nofollow noopener noreferrer">www.velodb.io/blog/apache…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdocs%2F3.x%2FgettingStarted%2Falternatives%2Falternative-to-trino" target="_blank" title="https://doris.apache.org/docs/3.x/gettingStarted/alternatives/alternative-to-trino" ref="nofollow noopener noreferrer">doris.apache.org/docs/3.x/ge…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40VeloDB_poweredby_ApacheDoris%2F1-billion-json-records-1-second-query-response-apache-doris-vs-7bbe9d9e3a12" target="_blank" title="https://medium.com/@VeloDB_poweredby_ApacheDoris/1-billion-json-records-1-second-query-response-apache-doris-vs-7bbe9d9e3a12" ref="nofollow noopener noreferrer">medium.com/@VeloDB_pow…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“死了么”到“活着记”：用Gmeek在数字世界留下思想印记]]></title>    <link>https://juejin.cn/post/7594662258354782243</link>    <guid>https://juejin.cn/post/7594662258354782243</guid>    <pubDate>2026-01-13T12:47:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662258354782243" data-draft-id="7594678044263956480" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“死了么”到“活着记”：用Gmeek在数字世界留下思想印记"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-13T12:47:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“死了么”到“活着记”：用Gmeek在数字世界留下思想印记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:47:52.000Z" title="Tue Jan 13 2026 12:47:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文从近期热议的“死了么”App入手，探讨现代人对数字安全与思想存续的双重需求，详细介绍基于GitHub的极简博客框架Gmeek，阐述在数字时代通过博客记录思想、对抗遗忘的重要意义，鼓励读者建立个人数字思想家园。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d13b78ed59944ff967131bf5476e7eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=4pAt3BWHLoRUyv7ru9jEjMVfIg8%3D" alt="github_gmeek.png" loading="lazy"/></p>
<p>github_gmeek.png</p>
<h2 data-id="heading-0">引言</h2>
<p>一款名为“死了么”的App近期引发广泛讨论。它以直白甚至略显生硬的名字，精准地切中了当代社会一个真实且规模庞大的群体需求。</p>
<p>可以说，“死了么”的火爆，是产品创意、社会情绪与网络传播共同作用的结果。它如同一面棱镜，折射出当代独居生活的潜在隐忧。</p>
<p>如今，独居者人数众多。他们往往独自奋斗，习惯“一个人扛下所有”，最担心的莫过于在突发疾病或意外时无人知晓。这款App之所以能够走红，恰恰在于它敏锐地捕捉到了现代人一种微妙而普遍的心理——“不愿日常打扰他人，却渴望在异常状况下被关注”。用户无需复杂的社交，仅通过简单的每日打卡，就能为自己构筑一道最低成本的“安全防线”。其付费下载量的快速增长，也印证了这一需求真实而强烈。</p>
<p>然而，人终有一死。那么，我们该如何留下生活过的痕迹？如何在日常中安顿内心、与自己对话？活着，不仅仅意味着没有死去，而是要有思想、有记录、有回响地活着。博客，作为一种数字化的表达方式，正成为越来越多人记录自我、分享见解、沉淀思想的平台。</p>
<p>最近读到一篇文章，颇受启发。<a href="https://link.juejin.cn?target=https%3A%2F%2Flaike9m.com%2Fblog%2Fpeople-die-but-long-live-github%2C122%2F" target="_blank" title="https://laike9m.com/blog/people-die-but-long-live-github,122/" ref="nofollow noopener noreferrer">People Die, but Long Live GitHub</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/090edfec5b564f14b09057f894fac4dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=gD3zKk71lhbC%2FE1wJ1qcAQldC4M%3D" alt="people-die-but-long-live-github.png" loading="lazy"/></p>
<p>people-die-but-long-live-github.png</p>
<p>最近，我还在 GitHub 上发现了一个开源项目——Gmeek。它是一个超轻量级的个人博客框架，完全基于 GitHub Pages、GitHub Issues 与 GitHub Actions 构建，可谓“All in GitHub”。无需本地部署，从搭建到写作，整个过程只需三步：前两步用 18 秒完成博客搭建，第三步即可开始书写。今天我们就来介绍下如何使用这款开源项目构建个人github博客。</p>
<h2 data-id="heading-1">Gmeek：三步构建你的数字思想家园</h2>
<p>一个博客框架，超轻量级个人博客模板。完全基于<code>Github Pages</code> 、 <code>Github Issues</code> 和 <code>Github Actions</code>。不需要本地部署，从搭建到写作，只需要18秒，2步搭建好博客，第3步就是写作。</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMeekdai%2FGmeek" target="_blank" title="https://github.com/Meekdai/Gmeek" ref="nofollow noopener noreferrer">github.com/Meekdai/Gme…</a></p>
<p>文档博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.meekdai.com%2Ftag.html%23Gmeek" target="_blank" title="https://blog.meekdai.com/tag.html#Gmeek" ref="nofollow noopener noreferrer">blog.meekdai.com/tag.html#Gm…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/526c834848bc481a8bcba9af189d629e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=gZYVqS2ytFjhvRRGZMoHuj3mLnY%3D" alt="gmeek_star.png" loading="lazy"/></p>
<p>gmeek_star.png</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2394926afc2b4c68b38f42f600e39110~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=t2jrslZbukUO9PDfibiz%2BE8FcPo%3D" alt="gmeek_doc_blog.png" loading="lazy"/></p>
<p>gmeek_doc_blog.png</p>
<h2 data-id="heading-2">快速开始</h2>
<ol>
<li>【创建仓库】点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnew%3Ftemplate_name%3DGmeek-template%26template_owner%3DMeekdai" target="_blank" title="https://github.com/new?template_name=Gmeek-template&amp;template_owner=Meekdai" ref="nofollow noopener noreferrer">通过模板创建仓库</a>，建议仓库名称为<code>XXX.github.io</code>，其中<code>XXX</code>为你的github用户名。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e5fd868ad6e4df696d814396da7ce03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=V2QNAey4ZUD6Cs%2Biug7Ta0mLUVI%3D" alt="xiuji_github_blog.png" loading="lazy"/></p>
<p>xiuji_github_blog.png</p>
<ol start="2">
<li>【启用Pages】在仓库的<code>Settings</code>中<code>Pages-&gt;Build and deployment-&gt;Source</code>下面选择<code>Github Actions</code>。</li>
<li>【开始写作】打开一篇issue，开始写作，并且<strong>必须</strong>添加一个<code>标签Label</code>（至少添加一个），再保存issue后会自动创建博客内容，片刻后可通过<a href="https://link.juejin.cn?target=https%3A%2F%2FXXX.github.io" target="_blank" title="https://XXX.github.io" ref="nofollow noopener noreferrer">XXX.github.io</a> 访问（可进入Actions页面查看构建进度）。</li>
<li>【手动全局生成】这个步骤只有在修改<code>config.json</code>文件或者出现奇怪问题的时候，需要执行。</li>
</ol>

<pre><code class="hljs language-rust" lang="rust">通过Actions<span class="hljs-punctuation">-&gt;</span>build Gmeek<span class="hljs-punctuation">-&gt;</span>Run workflow<span class="hljs-punctuation">-&gt;</span>里面的按钮全局重新生成一次
</code></pre>
<blockquote>
<p>[!NOTE] issue必须添加一个标签Label（至少添加一个）</p>
</blockquote>
<p>到此，提交完issue之后Actions页面构建完成之后就可以看到我们的博客了。</p>
<p>博主的github博客地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiuji008.github.io%2F" target="_blank" title="https://xiuji008.github.io/" ref="nofollow noopener noreferrer">xiuji008.github.io/</a></p>
<h2 data-id="heading-3">配置及使用</h2>
<p>config.json 文件就是配置文件，在创建的仓库内可以找到，对应修改为自己的即可。</p>
<p>配置可参考Gmeek作者博文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.meekdai.com%2Fpost%2FGmeek-kuai-su-shang-shou.html" target="_blank" title="https://blog.meekdai.com/post/Gmeek-kuai-su-shang-shou.html" ref="nofollow noopener noreferrer">blog.meekdai.com/post/Gmeek-…</a></p>
<h3 data-id="heading-4">static文件夹使用</h3>
<ol>
<li>在自己的仓库根目录下新建一个文件夹，名称必须是static。</li>
<li>然后在static文件内上传一些自己的文件，比如博客图片、插件js等。</li>
<li>通过手动全局生成一次成功后，你就可以通过 xxx.github.io/your.png 访问了</li>
</ol>
<h3 data-id="heading-5">插件功能的使用</h3>
<p>为了使得Gmeek的功能更加的丰富，Gmeek作者添加了插件的功能，目前已经有几个插件可以使用。大家可以直接复制文章中的配置代码使用，也可以把对应的插件文件拷贝到自己的static文件夹下使用。</p>
<h4 data-id="heading-6">计数工具 Vercount</h4>
<ol>
<li>全站添加计数工具Vercount，只需要在config.json文件内添加配置</li>
</ol>

<pre><code class="hljs language-xml" lang="xml">"allHead":"<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://blog.meekdai.com/Gmeek/plugins/GmeekVercount.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>",
</code></pre>
<p>2.  单个文章页添加Vercount，只需要在文章最后一行添加如下</p>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ##{"script":"&lt;script src='https://blog.meekdai.com/Gmeek/plugins/GmeekVercount.js'&gt;&lt;/script&gt;"}## --&gt;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65b854151b7f4a8b8ee326a1abc691d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=ZZildM3CBvDjjfhYNUGNchgPH5Y%3D" alt="gmeek_plugin_vercount.png" loading="lazy"/></p>
<p>gmeek_plugin_vercount.png</p>
<h4 data-id="heading-7">TOC目录</h4>
<ol>
<li>所有文章页添加TOC目录，只需要在config.json文件内添加配置</li>
</ol>

<pre><code class="hljs language-xml" lang="xml">"script":"<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>",
</code></pre>
<p>2.  单个文章页添加TOC目录，只需要在文章最后一行添加如下</p>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ##{"script":"&lt;script src='https://blog.meekdai.com/Gmeek/plugins/GmeekTOC.js'&gt;&lt;/script&gt;"}## --&gt;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60c9965c3dde4456bfada17b564355ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=UN9nt%2F4NpDXRtw93ud6KRjw%2BRS8%3D" alt="gmeek_plugins_toc.png" loading="lazy"/></p>
<p>gmeek_plugins_toc.png</p>
<h4 data-id="heading-8">灯箱插件</h4>
<blockquote>
<p>[!TIP] 此插件由Tiengming编写，可以放大浏览文章中的图片，适合一些图片较多的文章。</p>
</blockquote>
<ol>
<li>所有文章页添加lightbox，只需要在config.json文件内添加配置</li>
</ol>

<pre><code class="hljs language-xml" lang="xml">"script":"<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://blog.meekdai.com/Gmeek/plugins/lightbox.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>",
</code></pre>
<p>2.  单个文章页添加lightbox，只需要在文章最后一行添加如下</p>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ##{"script":"&lt;script src='https://blog.meekdai.com/Gmeek/plugins/lightbox.js'&gt;&lt;/script&gt;"}## --&gt;</span>
</code></pre>
<h4 data-id="heading-9">看板娘（花里胡哨）</h4>
<blockquote>
<p>[!TIP] 此插件从github开源项目live2d-widget引入，纯属页面展示</p>
</blockquote>
<ol>
<li>所有文章页添加lightbox，只需要在config.json文件内添加配置</li>
</ol>

<pre><code class="hljs language-xml" lang="xml">"script":"<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/autoload.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>",
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74ec77dc4d8c4f6d8a255aa026799bbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=mPGP0DB2LJIKYG0mR4m6dK3pl94%3D" alt="gmeek_plugins_live2d-widget.png" loading="lazy"/></p>
<p>gmeek_plugins_live2d-widget.png</p>
<p>对看板娘项目感兴趣的伙伴也可以研究下</p>
<p>看板娘项目github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstevenjoezhang%2Flive2d-widget" target="_blank" title="https://github.com/stevenjoezhang/live2d-widget" ref="nofollow noopener noreferrer">github.com/stevenjoezh…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2bacf69cfad4aa2b9b8bc2162417653~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=hiuDjQGEQctXi76MUAN7UGoaTPE%3D" alt="github_live2d_widget.png" loading="lazy"/></p>
<p>github_live2d_widget.png</p>
<h4 data-id="heading-10">多插件使用</h4>
<p>同时在所有文章页使用TOC目录、灯箱插件及其它插件，需要这样添加配置文件：</p>
<pre><code class="hljs language-xml" lang="xml">    "allHead":"<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://xiuji008.github.io/plugins/gmeekVercount.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://xiuji008.github.io/plugins/lightbox.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://xiuji008.github.io/plugins/gmeekTOC.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/autoload.js'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>",
</code></pre>
<h3 data-id="heading-11">其它使用说明</h3>
<h4 data-id="heading-12">issue添加中文标签</h4>
<ol>
<li>点击 <code>issue</code>页签, 点击右侧 <code>Labels</code> 后边的设置按钮，点击<code>Edit labels</code></li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b79ffad7f1bb422fbad33317c427bc3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=GzrskHMxK1quPIgQnXiVjX69w00%3D" alt="issues_labels_setting.png" loading="lazy"/></p>
<p>issues_labels_setting.png</p>
<ol start="2">
<li>在<code>Labels</code> 页面则可以新增或修改标签</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb8d710e32ab478d9e98e92ae75a3fe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=R4Z2zSO%2BI0k0lwfVuYRaOuneU%2BI%3D" alt="issues_labels_edit.png" loading="lazy"/></p>
<p>issues_labels_edit.png</p>
<h4 data-id="heading-13">置顶博客文章</h4>
<p>只需要<code>Pin issue</code>后，手动全局生成一次即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da2ee6bab79041df8a575ae7e48a3562~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913271&amp;x-signature=TzRr8%2BT0leJlTDNafK%2BYryG14CE%3D" alt="issues_pin.png" loading="lazy"/></p>
<p>issues_pin.png</p>
<h4 data-id="heading-14">评论 utteranc报错</h4>
<p>如果在评论里面登录后评论报错，可直接按照提示安装<code>utteranc app</code>即可</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Error: utterances <span class="hljs-keyword">is</span> not installed on xxx/xxx.github.io. If you own <span class="hljs-keyword">this</span> repo, install the app. Read more about <span class="hljs-keyword">this</span> change <span class="hljs-keyword">in</span> the PR.
</code></pre>
<h4 data-id="heading-15">删除文章</h4>
<p>只需要<code>Close issue</code>或者<code>Delete issue</code>后，再手动全局生成一次即可。</p>
<h2 data-id="heading-16">结语：在数字时代留下有温度的痕迹</h2>
<p>“死了么”关注的是物理存在的安全，而Gmeek这样的工具关注的是思想存在的延续。两者看似无关，实则都回应了现代人对存在感的深层渴望。</p>
<p>在这个算法主导、注意力碎片化的时代，拥有一个属于自己的数字角落，定期记录、整理、输出，不仅是对抗遗忘的方式，更是一种积极的生活态度——主动塑造自己的数字身份，而非被动地被平台定义。</p>
<p>从担心“无人知晓的离去”到主动“留下有思想的痕迹”，或许正是数字时代给予我们的一种平衡：既通过工具获得安全感，也通过表达实现自我确认。</p>
<p>你的思想值得被记录，你的声音值得被听见。现在，只需18秒，就可以开始在GitHub上建造你的数字思想家园。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Shapefile到GeoJSON：用GDAL实现GIS矢量数据读写与空间分析]]></title>    <link>https://juejin.cn/post/7594662258354798627</link>    <guid>https://juejin.cn/post/7594662258354798627</guid>    <pubDate>2026-01-13T12:55:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662258354798627" data-draft-id="7594661351513423907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Shapefile到GeoJSON：用GDAL实现GIS矢量数据读写与空间分析"/> <meta itemprop="keywords" content="GIS"/> <meta itemprop="datePublished" content="2026-01-13T12:55:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Shapefile到GeoJSON：用GDAL实现GIS矢量数据读写与空间分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:55:50.000Z" title="Tue Jan 13 2026 12:55:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文节选自作者新书<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">《GIS基础原理与技术实践》</a>第4章，系统讲解矢量数据开发基础，涵盖 OGR/GDAL 使用、坐标转换、拓扑判断等实战内容。</p>
</blockquote>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/e43cc66da13b4e589a26aeb1c0e38981~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768395215&amp;x-orig-sign=8S%2FRPaItEEf9cpF3n7hXpPRqkXQ%3D" alt="GIS基础原理与技术实践" loading="lazy"/></p>
<h2 data-id="heading-0">4.4 矢量数据开发基础</h2>
<p>通过之前的介绍，相信读者已经对于GIS的矢量数据有了一个全面的认识，尽管可能不是那么深入。但是没有关系，我们可以在实际的开发过程中加深对其的认识。</p>
<h3 data-id="heading-1">4.4.1 第三方开源库OGR/GDAL</h3>
<p>在第3章的时候，我们小试牛刀，通过第三方开源库PROJ/GDAL很简单的就实现了地理空间参考系统的相互转换。在这里同样如此，我们可以通过GDAL的OGR组件，轻松实现GIS矢量数据的基础开发。</p>
<p>OGR曾经是一个独立的矢量IO库，表示OpenGIS Simple Features Reference Implementation的意思，但其实OGR不完全符合OGC的Simple Feature标准规范，因此未被批准作为该规范的参考实现（当然也非常接近规范了）。从GDAL2.0开始，GDAL和OGR组件被集成在一起。</p>
<p>OGR/GDAL提供了非常强大的矢量读写能力，支持市面上绝大多数矢量数据格式。在第3章我们介绍GDAL的时候就提到过，GDAL是一个GIS数据抽象库。所谓数据抽象，是指无论是哪一种具体的矢量数据格式，GDAL都会将其抽象成数据集对象（Dataset），从而可以支持读取、写出和处理操作。常用的矢量数据格式如下：</p>
<ul>
<li>DXF/DWG：应用最广泛的几何图形数据格式，在CAD领域内用的非常多，但是缺点是缺少地理信息。</li>
<li>ESRI Shapefile：GIS中最常见的矢量数据格式，几乎所有的商业和开源GIS软件都支持。除了几何信息之外，还包含空间信息和属性信息。</li>
<li>GeoJSON：一种通过JSON来表述要素的矢量数据格式，因而很容易被JavaScript解析和处理，适用于Web端的轻量化应用。</li>
<li>KML：Google提出的一种基于XML标准来描述地理空间信息的数据格式（包括点、线、面、多边形和模型等），并且已经被OGC认定为开放地理信息编码标准。</li>
</ul>
<p>在GDAL中，对数据格式的支持被封装成驱动（dirver），包括上述格式在内的数据驱动要么内嵌在GDAL中，要么通过另外的第三方库来支持。当然这些我们可以暂时不用关心，直接使用本书Github主页代码仓库中的GDAL即可。</p>
<h3 data-id="heading-2">4.4.2 矢量数据的读取、处理和写入</h3>
<p>了解了第三方库OGR/GDAL，接下来我们就通过其实现关于GIS矢量数据的基础开发。一个很容易理解的常识是，包含GIS矢量数据在内的任何数据的操作都离不开三个过程：读取、处理和写入。因此，这里我们结合前面空间坐标参考转换的实践，实现一个简单的实例：读取一个面的矢量，然后对其进行空间参考的转换，最后重新写出一个矢量。具体的实现代码如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ogrsf_frmts.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Eigen/Eigen&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> Eigen;

<span class="hljs-keyword">using</span> Point = Vector3d;
<span class="hljs-keyword">using</span> Line = vector&lt;Point&gt;;
<span class="hljs-keyword">using</span> Polygon = vector&lt;Line&gt;;

vector&lt;Polygon&gt; polygonData;

OGRSpatialReference srcFileSpatialReference;
OGRSpatialReference dstFileSpatialReference;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OgrRing2Line</span><span class="hljs-params">(OGRLinearRing *ogrLinearRing, Line &amp;line)</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ogrLinearRing-&gt;<span class="hljs-built_in">getNumPoints</span>(); i++) {
    line.<span class="hljs-built_in">emplace_back</span>(ogrLinearRing-&gt;<span class="hljs-built_in">getX</span>(i), ogrLinearRing-&gt;<span class="hljs-built_in">getY</span>(i),
                      ogrLinearRing-&gt;<span class="hljs-built_in">getZ</span>(i));
  }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OgrPolygon2Polygon</span><span class="hljs-params">(OGRPolygon *ogrPolygon, Polygon &amp;polygon)</span> </span>{
  <span class="hljs-comment">//外环</span>
  Line line;
  <span class="hljs-built_in">OgrRing2Line</span>(ogrPolygon-&gt;<span class="hljs-built_in">getExteriorRing</span>(), line);
  polygon.<span class="hljs-built_in">push_back</span>(line);

  <span class="hljs-comment">//内环</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> ri = <span class="hljs-number">0</span>; ri &lt; ogrPolygon-&gt;<span class="hljs-built_in">getNumInteriorRings</span>(); ri++) {
    Line line;
    <span class="hljs-built_in">OgrRing2Line</span>(ogrPolygon-&gt;<span class="hljs-built_in">getInteriorRing</span>(ri), line);
    polygon.<span class="hljs-built_in">push_back</span>(line);
  }
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ReadShp</span><span class="hljs-params">()</span> </span>{
  string srcFile = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  srcFile = srcFile + <span class="hljs-string">"/../Data/Vector/multipolygons.shp"</span>;

  GDALDataset *poDS = (GDALDataset *)<span class="hljs-built_in">GDALOpenEx</span>(srcFile.<span class="hljs-built_in">c_str</span>(), GDAL_OF_VECTOR,
                                                <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
  <span class="hljs-keyword">if</span> (!poDS) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"无法读取该文件，请检查数据是否存在问题！"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (poDS-&gt;<span class="hljs-built_in">GetLayerCount</span>() &lt; <span class="hljs-number">1</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"该文件的层数小于1，请检查数据是否存在问题！"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">//原始数据空间参考</span>
  <span class="hljs-type">char</span> *pszWKT = <span class="hljs-literal">nullptr</span>;
  poDS-&gt;<span class="hljs-built_in">GetLayer</span>(<span class="hljs-number">0</span>)-&gt;<span class="hljs-built_in">GetSpatialRef</span>()-&gt;<span class="hljs-built_in">exportToWkt</span>(&amp;pszWKT);
  srcFileSpatialReference.<span class="hljs-built_in">importFromWkt</span>(pszWKT);
  <span class="hljs-built_in">CPLFree</span>(pszWKT);
  pszWKT = <span class="hljs-literal">nullptr</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> li = <span class="hljs-number">0</span>; li &lt; poDS-&gt;<span class="hljs-built_in">GetLayerCount</span>(); li++) {
    OGRLayer *poLayer = poDS-&gt;<span class="hljs-built_in">GetLayer</span>(li);  <span class="hljs-comment">//读取层</span>
    poLayer-&gt;<span class="hljs-built_in">ResetReading</span>();

    <span class="hljs-comment">//输出字段名</span>
    OGRFeatureDefn *poFDefn = poLayer-&gt;<span class="hljs-built_in">GetLayerDefn</span>();
    <span class="hljs-type">int</span> n = poFDefn-&gt;<span class="hljs-built_in">GetFieldCount</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> iField = <span class="hljs-number">0</span>; iField &lt; n; iField++) {
      OGRFieldDefn *OGRFieldDefn = poFDefn-&gt;<span class="hljs-built_in">GetFieldDefn</span>(iField);
      cout &lt;&lt; OGRFieldDefn-&gt;<span class="hljs-built_in">GetNameRef</span>() &lt;&lt; endl;
    }

    <span class="hljs-comment">//遍历特征</span>
    OGRFeature *poFeature = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-keyword">while</span> ((poFeature = poLayer-&gt;<span class="hljs-built_in">GetNextFeature</span>()) != <span class="hljs-literal">nullptr</span>) {
      OGRGeometry *geometry = poFeature-&gt;<span class="hljs-built_in">GetGeometryRef</span>();
      OGRwkbGeometryType geometryType = geometry-&gt;<span class="hljs-built_in">getGeometryType</span>();

      <span class="hljs-keyword">switch</span> (geometryType) {
        <span class="hljs-keyword">case</span> wkbPolygon:
        <span class="hljs-keyword">case</span> wkbPolygonM:
        <span class="hljs-keyword">case</span> wkbPolygonZM: {
          OGRPolygon *ogrPolygon = <span class="hljs-built_in">dynamic_cast</span>&lt;OGRPolygon *&gt;(geometry);
          <span class="hljs-keyword">if</span> (!ogrPolygon) {
            <span class="hljs-keyword">continue</span>;
          }

          Polygon polygon;
          <span class="hljs-built_in">OgrPolygon2Polygon</span>(ogrPolygon, polygon);
          polygonData.<span class="hljs-built_in">push_back</span>(polygon);

          <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">case</span> wkbMultiPolygon:
        <span class="hljs-keyword">case</span> wkbMultiPolygonM:
        <span class="hljs-keyword">case</span> wkbMultiPolygonZM: {
          OGRMultiPolygon *ogrMultiPolygon =
              <span class="hljs-built_in">dynamic_cast</span>&lt;OGRMultiPolygon *&gt;(geometry);
          <span class="hljs-keyword">if</span> (!ogrMultiPolygon) {
            <span class="hljs-keyword">continue</span>;
          }

          <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> gi = <span class="hljs-number">0</span>; gi &lt; ogrMultiPolygon-&gt;<span class="hljs-built_in">getNumGeometries</span>(); gi++) {
            OGRPolygon *ogrPolygon =
                <span class="hljs-built_in">dynamic_cast</span>&lt;OGRPolygon *&gt;(ogrMultiPolygon-&gt;<span class="hljs-built_in">getGeometryRef</span>(gi));
            <span class="hljs-keyword">if</span> (!ogrPolygon) {
              <span class="hljs-keyword">continue</span>;
            }

            Polygon polygon;
            <span class="hljs-built_in">OgrPolygon2Polygon</span>(ogrPolygon, polygon);
            polygonData.<span class="hljs-built_in">push_back</span>(polygon);
          }

          <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">default</span>: {
          <span class="hljs-built_in">printf</span>(<span class="hljs-string">"未处理的特征类型\n"</span>);
          <span class="hljs-keyword">break</span>;
        }
      }

      <span class="hljs-comment">//输出每个字段的值</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> iField = <span class="hljs-number">0</span>; iField &lt; n; iField++) {
        cout &lt;&lt; poFeature-&gt;<span class="hljs-built_in">GetFieldAsString</span>(iField) &lt;&lt; <span class="hljs-string">"    "</span>;
      }
      cout &lt;&lt; endl;

      OGRFeature::<span class="hljs-built_in">DestroyFeature</span>(poFeature);
    }
  }

  <span class="hljs-built_in">GDALClose</span>(poDS);
  poDS = <span class="hljs-literal">nullptr</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Convert</span><span class="hljs-params">()</span> </span>{
  dstFileSpatialReference.<span class="hljs-built_in">importFromEPSG</span>(<span class="hljs-number">3857</span>);
  dstFileSpatialReference.<span class="hljs-built_in">SetAxisMappingStrategy</span>(OAMS_TRADITIONAL_GIS_ORDER);
  srcFileSpatialReference.<span class="hljs-built_in">SetAxisMappingStrategy</span>(OAMS_TRADITIONAL_GIS_ORDER);

  OGRCoordinateTransformation *src2DstTransformation =
      <span class="hljs-built_in">OGRCreateCoordinateTransformation</span>(&amp;srcFileSpatialReference,
                                        &amp;dstFileSpatialReference);

  <span class="hljs-keyword">if</span> (!src2DstTransformation) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;polygon : polygonData) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;line : polygon) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;point : line) {
        src2DstTransformation-&gt;<span class="hljs-built_in">Transform</span>(<span class="hljs-number">1</span>, point.<span class="hljs-built_in">data</span>(), point.<span class="hljs-built_in">data</span>() + <span class="hljs-number">1</span>,
                                         point.<span class="hljs-built_in">data</span>() + <span class="hljs-number">2</span>);
      }
    }
  }
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">CreateField</span><span class="hljs-params">(OGRLayer *poLayer)</span> </span>{
  <span class="hljs-comment">// 字符串</span>
  <span class="hljs-function">OGRFieldDefn <span class="hljs-title">oField1</span><span class="hljs-params">(<span class="hljs-string">"Type"</span>, OFTString)</span></span>;
  oField1.<span class="hljs-built_in">SetWidth</span>(<span class="hljs-number">8</span>);
  <span class="hljs-keyword">if</span> (poLayer-&gt;<span class="hljs-built_in">CreateField</span>(&amp;oField1) != OGRERR_NONE) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Creating Name field failed.\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// 浮点数</span>
  <span class="hljs-function">OGRFieldDefn <span class="hljs-title">oField2</span><span class="hljs-params">(<span class="hljs-string">"Area"</span>, OFTReal)</span></span>;
  oField2.<span class="hljs-built_in">SetPrecision</span>(<span class="hljs-number">3</span>);
  <span class="hljs-keyword">if</span> (poLayer-&gt;<span class="hljs-built_in">CreateField</span>(&amp;oField2) != OGRERR_NONE) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Creating Name field failed.\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// 整型</span>
  <span class="hljs-function">OGRFieldDefn <span class="hljs-title">oField3</span><span class="hljs-params">(<span class="hljs-string">"VertexCount"</span>, OFTInteger)</span></span>;
  <span class="hljs-keyword">if</span> (poLayer-&gt;<span class="hljs-built_in">CreateField</span>(&amp;oField3) != OGRERR_NONE) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Creating Name field failed.\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">WriteGeoJson</span><span class="hljs-params">()</span> </span>{
  string dstFile = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  dstFile = dstFile + <span class="hljs-string">"/../Data/Out.geoJson"</span>;

  <span class="hljs-comment">//创建</span>
  GDALDriver *driver = <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"GeoJSON"</span>);
  <span class="hljs-keyword">if</span> (!driver) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Get Driver GeoJSON Error！\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  GDALDataset *dataset =
      driver-&gt;<span class="hljs-built_in">Create</span>(dstFile.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, GDT_Unknown, <span class="hljs-literal">NULL</span>);
  OGRLayer *poLayer = dataset-&gt;<span class="hljs-built_in">CreateLayer</span>(
      <span class="hljs-string">"FirstLayer"</span>, &amp;dstFileSpatialReference, wkbPolygon, <span class="hljs-literal">NULL</span>);

  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CreateField</span>(poLayer)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">//创建特征</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;polygon : polygonData) {
    <span class="hljs-function">OGRFeature <span class="hljs-title">ogrFeature</span><span class="hljs-params">(poLayer-&gt;GetLayerDefn())</span></span>;

    OGRPolygon ogrPolygon;

    <span class="hljs-type">int</span> vertexNum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;line : polygon) {
      OGRLinearRing ogrRing;
      <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;point : line) {
        ogrRing.<span class="hljs-built_in">addPoint</span>(point.<span class="hljs-built_in">x</span>(), point.<span class="hljs-built_in">y</span>(), point.<span class="hljs-built_in">z</span>());
        vertexNum++;
      }
      ogrPolygon.<span class="hljs-built_in">addRing</span>(&amp;ogrRing);
    }
    ogrFeature.<span class="hljs-built_in">SetGeometry</span>(&amp;ogrPolygon);

    ogrFeature.<span class="hljs-built_in">SetField</span>(<span class="hljs-string">"Type"</span>, <span class="hljs-string">"Polygon"</span>);
    ogrFeature.<span class="hljs-built_in">SetField</span>(<span class="hljs-string">"Area"</span>, ogrPolygon.<span class="hljs-built_in">get_Area</span>());
    ogrFeature.<span class="hljs-built_in">SetField</span>(<span class="hljs-string">"VertexCount"</span>, vertexNum);

    <span class="hljs-keyword">if</span> (poLayer-&gt;<span class="hljs-built_in">CreateFeature</span>(&amp;ogrFeature) != OGRERR_NONE) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to create feature.\n"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">//释放</span>
  <span class="hljs-built_in">GDALClose</span>(dataset);
  dataset = <span class="hljs-literal">nullptr</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();
  <span class="hljs-built_in">CPLSetConfigOption</span>(<span class="hljs-string">"GDAL_FILENAME_IS_UTF8"</span>, <span class="hljs-string">"NO"</span>);  <span class="hljs-comment">//支持中文路径</span>
  <span class="hljs-built_in">CPLSetConfigOption</span>(<span class="hljs-string">"SHAPE_ENCODING"</span>, <span class="hljs-string">""</span>);           <span class="hljs-comment">//解决中文乱码问题</span>

  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadShp</span>()) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  <span class="hljs-built_in">Convert</span>();

  <span class="hljs-built_in">WriteGeoJson</span>();
}
</code></pre>
<p>在这里，读取的矢量是一个Shapefile文件，包含的都是多边形的要素，空间参考为WGS84地理坐标系（EPSG：4326），显示如下图4.14所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/b466a0c5023f46aa914630bb3b73c314~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768395215&amp;x-orig-sign=N6NGMOI6vPhpdOFpBoPYl4km8Fg%3D" alt="图4.14 处理前多边形矢量要素" loading="lazy"/></p>
<p>经过空间参考转换后，空间参考为Web墨卡托投影坐标系（EPSG：3857），且生成的是一个GeoJson文件。如下图4.15所示，可以看到在空间坐标参考转换之后形状似乎“变窄”了一点，这是地图投影变换的特性决定的（参考第2章介绍的知识）。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/4a9f9a76ce4e4044928a7863c7f56a0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768395216&amp;x-orig-sign=TREVPk47WE74OR7yh6Jv6M1HilU%3D" alt="图4.15 处理后多边形矢量要素" loading="lazy"/></p>
<p>这段代码的关键在于如下几点：</p>
<ul>
<li>
<p>读取矢量时，矢量数据被读取成数据集对象GDALDataset，GDALDataset管理图层对象OGRLayer，OGRLayer管理特征类对象OGRFeature，OGRFeature则包含几何对象类OGRGeometry。OGRGeometry是一个抽象父类，有意义的是其表达具体的几何对象的子类，比如OGRPolygon代表多边形几何对象。OGRPolygon又是由1个外环和多个内环（环线：OGRLinearRing）组成。矢量就是这样一层层抽象组合表达出来的。</p>
</li>
<li>
<p>在进行数据处理也就是空间参考转换之前，我们把读取的数据放到我们自己的数据容器中：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">using</span> Point = Vector3d;
<span class="hljs-keyword">using</span> Line = vector&lt;Point&gt;;
<span class="hljs-keyword">using</span> Polygon = vector&lt;Line&gt;;

vector&lt;Polygon&gt; polygonData;
</code></pre>
<p>真实的GIS数据处理开发要求是千变万化的，操作的往往不是读取组件（这里指OGR）定义的数据结构对象。我们可以将其读取在成自定义的数据结构中，以方便我们进行更加通用的操作，或者进行并行优化。在这里我们遍历了自定义的数据结构对象中的顶点，逐点进行空间坐标参考的转换。进行其他的数据处理也是如此，根据自己的需要操作自己的数据结构容器。</p>
</li>
<li>
<p>写出矢量时，将处理结束的自定义数据结构对象恢复成数据集对象GDALDataset（读取矢量的逆操作）。另外，需要关注的是GDAL的数据驱动GDALDriver，其是通过名称来创建对应格式的矢量文件，例如这里传入到名称是GeoJson:</p>
<pre><code class="hljs language-cpp" lang="cpp">GDALDriver *driver = <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"GeoJSON"</span>);
<span class="hljs-keyword">if</span> (!driver) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Get Driver GeoJSON Error！\n"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
</li>
<li>
<p>矢量数据的属性表数据与数据库中的表结构比较类似，每个字段具有自己的定义属性，例如数据类型、长度、精度等。并且，每一个特征都对应了一行记录。因而属性表的操作还是挺复杂的，往往与业务操作相关联。这里仅仅只是输出显示了读取的属性表信息，写入了自己创建的字段与值。读取和写入的属性表数据如下图4.16、图4.17所示：</p>
</li>
</ul>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/6c09b2ead64f422e90cf80b0d2a5ceb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768395215&amp;x-orig-sign=2teQ4WIO4aIO%2FM3lEsjhoZQQ5c8%3D" alt="图4.16 读取的属性表信息" loading="lazy"/>
<img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/8b72e8e3819644b9aa45d81d485eada0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768395215&amp;x-orig-sign=DbRNzUdoGH%2FX8Kl11LzrJ3PzyDk%3D" alt="图4.17 写入的属性表信息" loading="lazy"/></p>
<h3 data-id="heading-3">4.4.3 空间拓扑关系的判断</h3>
<p>对矢量要素进行空间拓扑关系的判断也是GIS开发中常用的功能。在4.3.3节中介绍了OGC的Simple Feature标准规范中拓扑关系，OGR/GDAL对其做了具体的实现。任何继承了OGRGeometry的几何对象类（如OGRPoint、OGRPolygon）都可以调用标准中定义的接口（二元谓词），判断该几何对象与另外一个几何对象的拓扑关系。在如下实例中，判断了空间中某点与某多边形是否存在包含（Contains）关系：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ogrsf_frmts.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  OGRLinearRing linearRing;
  linearRing.<span class="hljs-built_in">addPoint</span>(<span class="hljs-number">268.28</span>, <span class="hljs-number">784.75</span>);
  linearRing.<span class="hljs-built_in">addPoint</span>(<span class="hljs-number">153.98</span>, <span class="hljs-number">600.60</span>);
  linearRing.<span class="hljs-built_in">addPoint</span>(<span class="hljs-number">274.63</span>, <span class="hljs-number">336.02</span>);
  linearRing.<span class="hljs-built_in">addPoint</span>(<span class="hljs-number">623.88</span>, <span class="hljs-number">401.64</span>);
  linearRing.<span class="hljs-built_in">addPoint</span>(<span class="hljs-number">676.80</span>, <span class="hljs-number">634.47</span>);
  linearRing.<span class="hljs-built_in">addPoint</span>(<span class="hljs-number">530.75</span>, <span class="hljs-number">822.85</span>);
  linearRing.<span class="hljs-built_in">closeRings</span>();

  OGRPolygon polygon;
  polygon.<span class="hljs-built_in">addRing</span>(&amp;linearRing);

  cout &lt;&lt; <span class="hljs-string">"点A是否在多边形内："</span>;
  <span class="hljs-function">OGRPoint <span class="hljs-title">pointA</span><span class="hljs-params">(<span class="hljs-number">407.98</span>, <span class="hljs-number">579.43</span>)</span></span>;  
  cout &lt;&lt; polygon.<span class="hljs-built_in">Contains</span>(&amp;pointA) &lt;&lt; endl;

  cout &lt;&lt; <span class="hljs-string">"点B是否在多边形内："</span>;
  <span class="hljs-function">OGRPoint <span class="hljs-title">pointB</span><span class="hljs-params">(<span class="hljs-number">678.92</span>, <span class="hljs-number">482.07</span>)</span></span>;  
  cout &lt;&lt; polygon.<span class="hljs-built_in">Contains</span>(&amp;pointB) &lt;&lt; endl;
}
</code></pre>
<p>运行的结果如下所示：</p>
<pre><code class="hljs language-text" lang="text">点A是否在多边形内：1
点B是否在多边形内：0
</code></pre>
<p>在4.3.3节中介绍过，包含(Contains)与内含(Within)是一对相反的关系。在这里我们当然也可以调用OGRPoint的内含(Within)接口，会返回与上述同样的结果。不止如此，其他空间拓扑关系的接口也是这样调用，读者可以根据自己的需求尝试一二，这里只是抛砖引玉。</p>
<hr/>
<p>本文节选自作者新书《GIS基础原理与技术实践》第4章。书中系统讲解 GIS 核心理论与多语言实战，适合开发者与高校师生。</p>
<p>📚 <strong>配套资源开源</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffafa1899%2FGISBasic" target="_blank" title="https://github.com/fafa1899/GISBasic" ref="nofollow noopener noreferrer">GitHub</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fcharlee44%2FGISBasic" target="_blank" title="https://gitcode.com/charlee44/GISBasic" ref="nofollow noopener noreferrer">GitCode</a></p>
<p>🛒 <strong>支持正版</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">京东</a>｜<a href="https://link.juejin.cn?target=https%3A%2F%2Fproduct.dangdang.com%2F29988568.html" target="_blank" title="https://product.dangdang.com/29988568.html" ref="nofollow noopener noreferrer">当当</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型训练全流程实战指南（一）——为什么要学习大模型训练？]]></title>    <link>https://juejin.cn/post/7594655863548297268</link>    <guid>https://juejin.cn/post/7594655863548297268</guid>    <pubDate>2026-01-13T12:48:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594655863548297268" data-draft-id="7592094314471866403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型训练全流程实战指南（一）——为什么要学习大模型训练？"/> <meta itemprop="keywords" content="人工智能,DeepSeek,深度学习"/> <meta itemprop="datePublished" content="2026-01-13T12:48:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型训练全流程实战指南（一）——为什么要学习大模型训练？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:48:09.000Z" title="Tue Jan 13 2026 12:48:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2025年，大模型技术迈入了飞速发展的新阶段。自从DeepSeek-R1引入强化学习方法以来，模型的能力得到了系统性提升，整个领域的发展宛如“打通任督二脉”，进入了前所未有的快车道。无论是国外闭源模型——如OpenAI的<a href="https://juejin.cn/post/7572010680897257512" target="_blank" title="https://juejin.cn/post/7572010680897257512">GPT系列</a>、Anthropic的<a href="https://juejin.cn/post/7507554645227536411" target="_blank" title="https://juejin.cn/post/7507554645227536411">Claude系列</a>、谷歌的<a href="https://juejin.cn/post/7574615024293429274" target="_blank" title="https://juejin.cn/post/7574615024293429274">Gemini系列</a>，还是国内开源阵营的<a href="https://juejin.cn/post/7579849892613373988" target="_blank" title="https://juejin.cn/post/7579849892613373988">DeepSeek</a>、<a href="https://juejin.cn/post/7530202220802359331" target="_blank" title="https://juejin.cn/post/7530202220802359331">Qwen</a>等系列，都在今年实现了密集的版本迭代与能力突破。</p>
<p>很难想象现在遇到问题时，大家不是打开豆包或者DeepSeek来问上一问？大模型正以前所未有的深度融入我们的工作与生活。然而身为技术人，大家是否想过：这些模型究竟是如何被训练出来的？如果有一天，我们也能从头开始训练一个属于自己的大模型，又会是怎样一种体验？</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ac84cce0a0b4146bbbfc72abca314b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913792&amp;x-signature=VULkwsKLt3kUP3eaIuTccXCjb9A%3D" alt="1.png" width="70%" loading="lazy"/></p>
<p>除大模型训练外，笔者也在同步更新<a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>免费专栏，要说明该专栏适合所有对 LangChain 感兴趣的学习者，无论之前是否接触过 LangChain。该专栏基于笔者在实际项目中的深度使用经验，系统讲解了使用LangChain/LangGraph如何开发智能体，目前已更新 36 讲，并持续补充实战与拓展内容。欢迎感兴趣的同学关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号<strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-1">一、为什么要学习大模型训练？</h2>
<p>面对功能强大的现成模型，或许大家会疑惑：直接调用API就能解决问题，为何还要深入了解其训练过程？笔者一直认为，理解“如何制造”比单纯“如何使用”更能让你在AI浪潮中把握主动。当前，大模型技术主要沿着<strong>模型应用</strong>与<strong>模型训练</strong>两大路径发展。模型应用的核心在于智能体（Agent）开发，通过赋予大模型工具调用、记忆、规划等能力，使其能自主完成复杂任务——这正是2025年“智能体元年”的焦点。然而，这一切应用生态的根基，皆源于<strong>模型训练</strong>。掌握大模型训练的知识，不仅是理解技术本质的钥匙，更是构建差异优势的起点。具体而言，笔者认为学习大模型训练的必要性主要体现在以下三个方面：</p>
<h3 data-id="heading-2">1.1 专业大模型缺口巨大，垂类应用需求爆发</h3>
<p>从头预训练一个通用大模型，需要数千亿词汇、上百TB的高质量多领域数据，其成本与门槛对我们个人甚至很多中小企业来说都遥不可及。然而，通用大模型虽是“博学家”，却不是一个领域专家，难以深入特定垂直领域。这就催生了大量对<strong>专业化、领域化模型</strong>的迫切需求。</p>
<p>例如，哈尔滨工业大学的“华佗”大模型专注于医疗诊断，东南大学的“法衡”大模型深耕法律条文与案例分析，中国农业大学的“神农”大模型则能进行农业知识问答与生产决策推理，并已服务超十万用户，被戏称为“养猪大模型”。此外，当前各类数据处理、代码生成等智能体，其核心也都是通过对通用基座模型进行针对性训练与微调而来，以提升其在特定任务上的准确性与可靠性。</p>
<p>因此，学会大模型训练技术，意味着大家能够将通用能力转化为解决行业实际问题的专属智能，这正是技术落地的最前沿。</p>
<h3 data-id="heading-3">1.2 学生与研究者的必备技能与学术前沿</h3>
<p>笔者几乎不只一次被以前实验室的小伙伴们问道：“到底该如何学习大模型训练呢？”，在人工智能领域，大模型不仅是应用热点，更是理论研究的基础。对于研究生和科研人员而言，掌握大模型训练已成为一项不可或缺的核心技能。</p>
<p>大模型训练技术的学习价值不仅在于训练出可应用的模型，更在于大模型内部机理尚存大量“炼金术”般的开放问题，为探索智能本质，发表论文创新点提供了绝佳试验场。基于强大的开源基座，研究者可聚焦于高效微调、对齐技术、安全伦理等创新点，以有限算力产出具有影响力的学术成果。这一过程培养的是一种“从零构建到精准驯服”的全新科研范式，相关研究经历与论文更是通往顶尖学术机构或工业界研发团队的“硬通货”。</p>
<h3 data-id="heading-4">1.3 企业转型与个人职业跃迁的硬核资本</h3>
<p>并非所有企业都需要或能够训练通用大模型，但每家企业都拥有其最具价值的<strong>私有数据与业务知识</strong>。能否利用这些资产打造安全、专属、高效的内部智能系统，在人工智能时代已成为企业的关键能力。</p>
<p>掌握大模型预训练、微调及强化学习对齐（如RLHF）等全流程技能，大家就能够直接回应这一核心需求，从简单的API调用者，转变为能为企业创造核心价值的“AI架构师”。这不仅意味着职位与薪水的跃升，更意味着大家构建了一条基于深度技术理解、足以应对快速技术迭代的<strong>长期职业护城河</strong>。</p>
<h2 data-id="heading-5">二、认识大模型训练</h2>
<p>在了解学习大模型训练的必要性后，大家一定对大模型训练产生了浓厚兴趣。笔者这里先进一步剖析其核心过程。为了让抽象的概念更易于理解，笔者首先将通过一个整体性比喻向大家描绘大模型训练的全景图，并点明其中的关键环节。</p>
<h3 data-id="heading-6">2.1 大模型训练的基本流程：从“学生”到“专家”</h3>
<p>大模型的训练可形象地理解为一个学生的完整培养过程，主要包含以下关键阶段：</p>
<ol>
<li><strong>数据处理（准备教材）</strong> ：这是所有步骤的根基。大家需要将互联网网页、书籍、文档等海量原始文本，清洗、过滤并转化为模型可高效学习的格式。<strong>数据的质量直接决定了模型能力的上限</strong>，如同教材的优劣会深刻影响学生的知识基础（这里要痛批“毒教材”事件）。</li>
<li><strong>预训练（学习知识）</strong> ：此阶段是让模型“博览群书”，通过在海量数据上进行自监督学习，掌握语言规律、事实知识和世界逻辑。对于多数从业者，更常见的是在已有大模型（基座模型）上进行<strong>增量预训练</strong>，向其注入新的、特定领域的知识。</li>
<li><strong>指令精调（学会表达）</strong> ：一个仅经过预训练的模型，虽知识渊博，却可能不擅于以人类期望的方式回答问题。例如，当被问及“长江”，它可能机械地关联出“黄河”，却无法组织成一句通顺的介绍。指令精调（SFT）使用高质量对话数据，教会模型如何理解指令，并将其掌握的知识清晰、有条理地表达出来。</li>
<li><strong>对齐优化（精炼表达，接近人类）</strong> ：经过精调的模型回答可能仍显生硬或机械。此时，需通过<strong>强化学习（如RLHF）</strong> 等技术，根据人类偏好对模型的回答进行“奖励”或“纠正”，使其输出更流畅、自然、有用且安全，最终贴近人类的表达习惯与价值观。</li>
</ol>
<p>整个流程并非单向直线，而是一个<strong>评估、反馈与迭代</strong>的循环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca09dbad2e4e43ba8ba6632188240e0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913792&amp;x-signature=gqwcB%2BPXJHsvthmeR4AmIhYjpc8%3D" alt="2.png" loading="lazy"/></p>
<p>随着DeepSeek-R1等模型的发布，强化学习不仅成为提升效果的关键手段，更是赋予模型深度<strong>思维与推理能力</strong>的核心路径。同时，为了适应智能体开发或垂直领域任务，往往还需在上述流程基础上，进行更深度的“后训练”，使模型能调用工具或掌握更专精的技能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62aae2c63718489ba5dbfcfa1caea92b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913792&amp;x-signature=V%2BCAU3ccnZsqWfWzLNWmuewdWKY%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-7">2.2 大模型训练与RAG的核心区别：内生能力 vs. 外部扩展</h3>
<p>大家可能会联想到当前流行的RAG（RAG是检索增强生成，先对用户的问题进行知识检索，检索后的知识传递给大模型进行总结回答，回答更准确。更具体的原理可以参考笔者的文章：<a href="https://juejin.cn/post/7494201369303253002" target="_blank" title="https://juejin.cn/post/7494201369303253002">一文带你了解RAG核心原理！不再只是文档的搬运工</a>）技术，它同样能扩展模型的知识边界。那么，直接将专有知识放入RAG知识库是否更简便？为何还要投入精力学习模型训练？</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/982d060dd063461183e2f3aa0c06417b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768913792&amp;x-signature=eFyAW5a%2Bz6affMyWs%2FEeTwwyfAA%3D" alt="5.png" width="70%" loading="lazy"/></p>
<p><strong>根本区别在于：大模型训练是让知识“内化”于模型本身，而RAG是在推理时“外挂”一个知识库。</strong>  训练能够从根本上定制模型的行为逻辑、深化其领域专业知识、优化其任务性能。一个经过良好训练的模型，可以覆盖RAG的大部分应用场景，反之则不然。具体而言，训练后模型的优势体现在：</p>
<h4 data-id="heading-8">2.2.1 任务精通度：从“调用者”变为“专家”</h4>
<p>训练将知识直接编码进模型的参数中。这使得模型在处理领域内结构化、复杂或隐含逻辑的查询时，表现更为精准可靠，成为该任务的“专家”。而仅依赖RAG的模型，其回答深度和连贯性受限于检索片段的质量。</p>
<h4 data-id="heading-9">2.2.2 响应速度：无需检索，即时生成</h4>
<p>训练好的模型在推理时无需访问外部数据库，跳过了检索耗时，因此响应速度更快，尤其适用于对实时性要求高的应用场景。</p>
<h4 data-id="heading-10">2.2.3 系统可靠性：提供稳定性能底座</h4>
<p>在“训练+RAG”的混合架构中，训练后的模型本身就是一个可靠的后备。当检索系统未能找到相关信息或返回错误内容时，模型内置的知识依然能够保证生成一个基本可用、符合领域常识的答案，极大地增强了整体系统的鲁棒性。</p>
<p>当然，这并非否定RAG的价值。<strong>RAG在集成实时、动态变化的外部信息（如最新新闻、股价）方面具有不可替代的优势</strong>，而通过重新训练来更新此类知识则成本高昂。因此，最佳的工程实践往往是<strong>将大模型的“内化知识”与RAG的“外部扩展”能力相结合</strong>，以构建既专业又鲜活的智能系统。</p>
<h2 data-id="heading-11">三、本合集学习框架与路线图</h2>
<p>本系列教程源于笔者去年亲身经历从数据准备到模型部署的全流程、并踩过无数“坑”之后，笔者深知一个完整、透彻且紧跟前沿的学习框架对大家的价值。笔者在开始学习大模型时也找过很多的教程，然而目前许多现有教程多聚焦于使用特定工具进行微调，往往缺少对<strong>数据工程、评估迭代及全流程闭环</strong>的深入剖析。然而，大模型训练的精髓，恰恰在于这些决定成败的细节。更为重要的是，训练的目标已不仅是嵌入知识，更在于通过强化学习赋予模型<strong>思维与推理能力</strong>，以及通过Agent微调使其精准掌握工具调用和指令跟随。为此，本合集笔者将不仅详解工具使用与数据集构建，更会在合集最后<strong>从零开始用PyTorch实现一个大模型</strong>，带大家彻底理解其运行与训练机理。</p>
<h3 data-id="heading-12">3.1 核心基础篇：构建系统化知识体系</h3>
<p>笔者将从基础到实战，搭建三层递进的知识结构：</p>
<p><strong>1. 知识篇（理解模型）</strong></p>
<ul>
<li>大模型核心架构解析：理解模型组成、文件格式与作用。</li>
<li>本地化部署实践：学习如何在本地环境成功部署大模型。</li>
<li>基础调用与交互：掌握与本地部署大模型进行基础API及对话交互的方法。</li>
<li>原理解析：深入浅出理解Transformer、注意力机制等核心工作原理。</li>
</ul>
<p><strong>2. 工具篇（掌握武器）</strong></p>
<ul>
<li>训练工具全景图：梳理并对比市面主流大模型训练框架。</li>
<li>数据处理方法论：学习数据清洗、格式化、质量评估的通用流程与最佳实践。</li>
<li>工具链实战：亲手使用主流工具完成一次完整的微调训练任务。</li>
</ul>
<p><strong>3. 实战篇（闭环训练）</strong></p>
<ul>
<li><strong>数据工程实战</strong>：从特定领域需求出发，完成从原始数据收集、清洗到构建高质量预训练数据集，微调问答数据集，强化学习数据集的完整过程。</li>
<li><strong>预训练实战</strong>：学习如何利用领域数据对基座模型进行高效的增量预训练。</li>
<li><strong>监督微调实战</strong>：利用高质量指令集对模型进行指令跟随能力调优。</li>
<li><strong>对齐优化实战</strong>：实践基于人类反馈的强化学习等技术，让模型输出更安全、有用、符合人类偏好。</li>
</ul>
<h3 data-id="heading-13">3.2 高级拓展篇：深入前沿与本质</h3>
<p>在夯实基础后笔者还将进一步深入两大前沿方向与底层原理：</p>
<p><strong>1. 强化学习专题</strong></p>
<ul>
<li>前沿算法剖析：深入解读GRPO等无需奖励模型的强化学习算法原理。</li>
<li>思维能力实战：通过GRPO实战，让模型真正掌握分步推理与复杂问题解决能力。</li>
</ul>
<p><strong>2. 智能体专题</strong></p>
<ul>
<li>函数调用详解：深入剖析大模型的Function Calling能力实现原理。</li>
<li>Agent性能微调：学习如何通过数据训练与强化，让模型成为高效、可靠的任务规划与执行智能体的基座。</li>
</ul>
<p><strong>3. 原理实现专题</strong></p>
<ul>
<li><strong>从零手写大模型</strong>：使用PyTorch，从注意力机制开始，逐步实现一个完整的小规模大模型，并完成预训练全流程，彻底打通理论到实现的壁垒。</li>
</ul>
<p>本系列预计将通过超过50篇的详细文章，系统化覆盖以上所有知识点。教程完结后，笔者将持续分享训练中的<strong>新技术实践、疑难问题解决方案与前沿动态</strong>，因此该合集不仅是实战教程，更是持续更新的学习指南。</p>
<h2 data-id="heading-14">四、总结</h2>
<p>大模型训练是深入AI核心、从技术使用者迈向创造者的关键一步。它不仅赋能垂直领域创新，更是构建个人长期竞争力的硬核技能。</p>
<p>无论是企业智能赋能还是研究生学术界的创新点构思，大模型训练都是大家追逐AI浪潮的必备技能，本合集将系统拆解从数据处理、模型训练到强化学习与智能体开发的全流程，并带你从零实现模型，大家掌握大模型训练的全技能，真正掌握塑造智能的能力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Generator 函数]]></title>    <link>https://juejin.cn/post/7594657393830068262</link>    <guid>https://juejin.cn/post/7594657393830068262</guid>    <pubDate>2026-01-13T10:19:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594657393830068262" data-draft-id="7594270467030777883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Generator 函数"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-13T10:19:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秋子aria"/> <meta itemprop="url" content="https://juejin.cn/user/2892132889661339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Generator 函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2892132889661339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秋子aria
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:19:45.000Z" title="Tue Jan 13 2026 10:19:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 1.核心知识点 总结</h2>
<ol>
<li>Generator 是「分段执行的函数」，<code>function*</code> 声明，<code>yield</code> 暂停，<code>next()</code> 恢复执行</li>
<li><code>yield</code> 是暂停标记 + 返回值，<code>yield*</code> 是遍历器委托，用于调用其他生成器 / 可遍历结构</li>
<li><code>next(参数)</code> 可以给「上一个 yield」传值，首次传参无效</li>
<li>Generator 返回遍历器，可被 <code>for...of</code> 遍历，<code>return()</code> 强制终止遍历</li>
<li>核心优势：无全局变量污染、保存执行状态、外部灵活控制内部逻辑，是 ES6 异步编程的重要方案</li>
</ol>
<h2 data-id="heading-1">2.什么是 Generator 函数</h2>
<p>在Javascript中，一个函数一旦开始执行，就会运行到最后或遇到return时结束，运行期间不会有其它代码能够打断它，也不能从外部再传入值到函数体内</p>
<p>而<strong>Generator函数（生成器）的出现使得打破函数的完整运行成为了可能</strong>，其语法行为与传统函数完全不同</p>
<p><strong>Generator函数是ES6提供的一种异步编程解决方案</strong>，形式上也是一个普通函数，但有几个显著的特征：</p>
<p>-- function关键字与函数名之间有一个星号 "*" （推荐紧挨着function关键字）<br/>
-- 函数体内使用 yield 表达式，定义不同的内部状态 （可以有多个yield）<br/>
-- <strong>直接调用 Generator函数并不会执行，也不会返回运行结果，而是返回一个遍历器对象（Iterator Object）</strong><br/>
-- 依次调用遍历器对象的next方法，遍历 Generator函数内部的每一个状态</p>
<h3 data-id="heading-2">2.1 传统函数和Generator函数区别</h3>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-comment">// 传统函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'hello world'</span>
  }

  <span class="hljs-title function_">foo</span>()   <span class="hljs-comment">// 'hello world'，一旦调用立即执行</span>


  <span class="hljs-comment">// Generator函数</span>
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">generator</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'status one'</span>         <span class="hljs-comment">// yield 表达式是暂停执行的标记  </span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'hello world'</span>
  }

  <span class="hljs-keyword">let</span> iterator = <span class="hljs-title function_">generator</span>()   
  <span class="hljs-comment">// 调用 Generator函数，函数并没有执行，返回的是一个Iterator对象</span>
  iterator.<span class="hljs-title function_">next</span>()              
  <span class="hljs-comment">// {value: "status one", done: false}，value 表示返回值，done 表示遍历还没有结束</span>
  iterator.<span class="hljs-title function_">next</span>()              
  <span class="hljs-comment">// {value: "hello world", done: true}，value 表示返回值，done 表示遍历结束</span>
}
</code></pre>
<h3 data-id="heading-3">2.2 Generator函数详解</h3>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//定义了一个 Generator函数，其中包含两个 yield 表达式和一个 return 语句（即产生了三个状态）</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'hello'</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'world'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'ending'</span>
  }

  <span class="hljs-keyword">let</span> it = <span class="hljs-title function_">gen</span>()

  it.<span class="hljs-title function_">next</span>()   <span class="hljs-comment">// {value: "hello", done: false}</span>
  it.<span class="hljs-title function_">next</span>()   <span class="hljs-comment">// {value: "world", done: false}</span>
  it.<span class="hljs-title function_">next</span>()   <span class="hljs-comment">// {value: "ending", done: true}</span>
  it.<span class="hljs-title function_">next</span>()   <span class="hljs-comment">// {value: undefined, done: true}</span>
}
</code></pre>
<p>每次调用Iterator对象的next方法时，内部的指针就会从函数的头部或上一次停下来的地方开始执行，直到遇到下一个 yield 表达式或return语句暂停。换句话说，<strong>Generator 函数是分段执行的，yield表达式是暂停执行的标记，而 next方法可以恢复执行</strong></p>
<p>执行过程如下：</p>
<p>第一次调用next方法时，内部指针从函数头部开始执行，遇到第一个 yield 表达式暂停，并返回当前状态的值 'hello'</p>
<p>第二次调用next方法时，内部指针从上一个（即第一个） yield 表达式开始，遇到第二个 yield 表达式暂停，返回当前状态的值 'world'</p>
<p>第三次调用next方法时，内部指针从第二个 yield 表达式开始，遇到return语句暂停，返回当前状态的值 'ending'，同时所有状态遍历完毕，done 属性的值变为true</p>
<p>第四次调用next方法时，<strong>由于函数已经遍历运行完毕，不再有其它状态，因此返回 {value: undefined, done: true}。如果继续调用next方法，返回的也都是这个值</strong></p>
<h2 data-id="heading-4">3.yield 表达式</h2>
<p><strong>（1）、yield 表达式只能用在 Generator 函数里面，用在其它地方都会报错</strong></p>
<pre><code class="hljs language-js" lang="js">{
  (<span class="hljs-keyword">function</span> (<span class="hljs-params"/>){
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
  })()

  <span class="hljs-comment">// SyntaxError: Unexpected number</span>
  <span class="hljs-comment">// 在一个普通函数中使用yield表达式，结果产生一个句法错误</span>
}
</code></pre>
<p><strong>（2）、yield 表达式如果用在另一个表达式中，必须放在圆括号里面</strong></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello'</span> + <span class="hljs-keyword">yield</span>); <span class="hljs-comment">// SyntaxError</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello'</span> + <span class="hljs-keyword">yield</span> <span class="hljs-number">123</span>); <span class="hljs-comment">// SyntaxError</span>

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello'</span> + (<span class="hljs-keyword">yield</span>)); <span class="hljs-comment">// OK</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello'</span> + (<span class="hljs-keyword">yield</span> <span class="hljs-number">123</span>)); <span class="hljs-comment">// OK</span>
  }
}
</code></pre>
<p><strong>（3）、yield 表达式用作参数或放在赋值表达式的右边，可以不加括号</strong></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">foo</span>(<span class="hljs-keyword">yield</span> <span class="hljs-string">'a'</span>, <span class="hljs-keyword">yield</span> <span class="hljs-string">'b'</span>); <span class="hljs-comment">// OK</span>
    <span class="hljs-keyword">let</span> input = <span class="hljs-keyword">yield</span>; <span class="hljs-comment">// OK</span>
  }
}
</code></pre>
<p><strong>（4）、yield 表达式和return语句的区别</strong></p>
<p>相似：都能返回紧跟在语句后面的那个表达式的值</p>
<p>区别：<br/>
-- 每次遇到 yield，函数就暂停执行，下一次再从该位置继续向后执行；而 return 语句不具备记忆位置的功能<br/>
-- 一个函数只能执行一次 return 语句，而在 Generator 函数中可以有任意多个 yield</p>
<h2 data-id="heading-5">4. <code>return()</code> 与 <code>throw()</code> 方法</h2>
<p>Generator 对象除了 <code>next()</code>，还有两个方法用于主动控制执行：</p>
<h3 data-id="heading-6"><code>return(value)</code></h3>
<ul>
<li>作用：立即终止 Generator 函数，返回 <code>{ value: 传入值, done: true }</code>；</li>
<li>后续再调用 <code>next()</code>，仅返回 <code>{ value: undefined, done: true }</code>。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
}
<span class="hljs-keyword">const</span> g = <span class="hljs-title function_">gen</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(g.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value:1, done:false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(g.<span class="hljs-keyword">return</span>(<span class="hljs-string">'终止'</span>)); <span class="hljs-comment">// { value:'终止', done:true }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(g.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value:undefined, done:true }</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-7"><code>throw(error)</code></h3>
<ul>
<li>作用：在当前暂停点抛出一个错误，若函数内未捕获，错误会向外传播；</li>
<li>若函数内用 <code>try/catch</code> 捕获错误，函数会继续执行，直到下一个 <code>yield</code>。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获错误：'</span>, e); <span class="hljs-comment">// 捕获 throw() 抛出的错误</span>
  }
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
}
<span class="hljs-keyword">const</span> g = <span class="hljs-title function_">gen</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(g.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value:1, done:false }</span>
g.<span class="hljs-keyword">throw</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'手动抛错'</span>)); <span class="hljs-comment">// 输出：捕获错误：Error: 手动抛错</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(g.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value:2, done:false }</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-8">5.yield* 表达式</h2>
<p><strong>如果在 Generator 函数里面调用另一个 Generator 函数，默认情况下是没有效果的</strong></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'aaa'</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'bbb'</span>
  }

  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">foo</span>()
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'ccc'</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'ddd'</span>
  }

  <span class="hljs-keyword">let</span> iterator = <span class="hljs-title function_">bar</span>()

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> value <span class="hljs-keyword">of</span> iterator) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)
  }

  <span class="hljs-comment">// ccc</span>
  <span class="hljs-comment">// ddd</span>

}
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>上例中，使用 for...of 来遍历函数bar的生成的遍历器对象时，只返回了bar自身的两个状态值。此时，如果想要正确的在bar 里调用foo，就需要用到 yield* 表达式</p>
<p><em><em>yield</em> 表达式用来在一个 Generator 函数里面 执行 另一个 Generator 函数</em>*</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'aaa'</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'bbb'</span>
  }

  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span>* <span class="hljs-title function_">foo</span>()      <span class="hljs-comment">// 在bar函数中 **执行** foo函数</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'ccc'</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">'ddd'</span>
  }

  <span class="hljs-keyword">let</span> iterator = <span class="hljs-title function_">bar</span>()

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> value <span class="hljs-keyword">of</span> iterator) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)
  }

  <span class="hljs-comment">// aaa</span>
  <span class="hljs-comment">// bbb</span>
  <span class="hljs-comment">// ccc</span>
  <span class="hljs-comment">// ddd</span>
}
</code></pre>
<h2 data-id="heading-9">6.next() 方法的参数</h2>
<p><strong>yield表达式本身没有返回值，或者说总是返回undefined。next方法可以带一个参数，该参数就会被当作上一个yield表达式的返回值</strong></p>
<pre><code class="hljs language-js" lang="js"> [rv] = <span class="hljs-keyword">yield</span> [expression]
</code></pre>
<p>expression：定义通过遍历器从生成器函数返回的值，如果省略，则返回 undefined<br/>
rv：接收从下一个 next() 方法传递来的参数</p>
<p>例子，并尝试解析遍历生成器函数的执行过程</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span> + <span class="hljs-number">5</span> + <span class="hljs-number">6</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)
    <span class="hljs-keyword">yield</span> result
  }

  <span class="hljs-keyword">let</span> it = <span class="hljs-title function_">gen</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())      <span class="hljs-comment">// {value: 14, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())      <span class="hljs-comment">// undefined    {value: undefined, done: false}</span>
}
</code></pre>
<p>第一次调用遍历器对象的next方法，函数从头部开始执行，遇到第一个 yield 暂停，在这个过程中其实是分了三步：</p>
<p>（1）、声明了一个变量result，并将声明提前，默认值为 undefined<br/>
（2）、由于 Generator函数是 “惰性求值”，执行到第一个 yield 时才会计算求和，并加计算结果返回给遍历器对象 {value: 14, done: false}，函数暂停运行<br/>
（3）、<strong>理论上应该要把等号右边的 [yield 3 + 5 + 6] 赋值给变量result，但是，</strong> <strong>由于函数执行到 yield 时暂定了，这一步就被挂起了</strong></p>
<p><strong>第二次调用next方法，函数从上一次 yield 停下的地方开始执行，也就是给result赋值的地方开始，由于next()并没有传参，就相当于传参为undefined</strong></p>
<p>基于以上分析，就不难理解为什么说 yield表达式本身的返回值（特指 [rv]）总是undefined了。现在把上面的代码稍作修改，第二次调用 next() 方法传一个参数3，按照上图分析可以很快得出输出结果</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span> + <span class="hljs-number">5</span> + <span class="hljs-number">6</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)
    <span class="hljs-keyword">yield</span> result
  }

  <span class="hljs-keyword">let</span> it = <span class="hljs-title function_">gen</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())      <span class="hljs-comment">// {value: 14, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>(<span class="hljs-number">3</span>))      <span class="hljs-comment">// 3    {value: 3, done: false}</span>
}
</code></pre>
<p><strong>如果第一次调用next()的时候也传了一个参数呢？这个当然是无效的，next方法的参数表示上一个yield表达式的返回值，所以在第一次使用next方法时，传递参数是无效的。</strong></p>
<p>从语义上讲，第一个next方法用来启动遍历器对象，所以不用带有参数。</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span> + <span class="hljs-number">5</span> + <span class="hljs-number">6</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)
    <span class="hljs-keyword">yield</span> result
  }

  <span class="hljs-keyword">let</span> it = <span class="hljs-title function_">gen</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>(<span class="hljs-number">10</span>))      <span class="hljs-comment">// {value: 14, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>(<span class="hljs-number">3</span>))      <span class="hljs-comment">// 3    {value: 3, done: false}</span>
}
</code></pre>
<p><strong>Generator 函数从暂停状态到恢复运行，它的上下文状态（context）是不变的。通过next方法的参数，就有办法在 Generator 函数开始运行之后，继续向函数体内部注入值。</strong> 也就是说，可以在 Generator 函数运行的不同阶段，从外部向内部注入不同的值，从而调整函数行为。</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params">x</span>) {
    <span class="hljs-keyword">let</span> y = <span class="hljs-number">2</span> * (<span class="hljs-keyword">yield</span> (x + <span class="hljs-number">1</span>))   
    <span class="hljs-comment">// 注意：yield 表达式如果用在另一个表达式中，必须放在圆括号里面</span>
    <span class="hljs-keyword">let</span> z = <span class="hljs-keyword">yield</span> (y / <span class="hljs-number">3</span>)
    <span class="hljs-keyword">return</span> x + y + z
  }

  <span class="hljs-keyword">let</span> it = <span class="hljs-title function_">gen</span>(<span class="hljs-number">5</span>)
  <span class="hljs-comment">/* 通过前面的介绍就知道这部分输出结果是错误的啦
    
    console.log(it.next())  // {value: 6, done: false}
    console.log(it.next())  // {value: 2, done: false}
    console.log(it.next())  // {value: 13, done: false}
  */</span>

  <span class="hljs-comment">/*** 正确的结果在这里 ***/</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())  
  <span class="hljs-comment">// 首次调用next，函数只会执行到 “yield(5+1)” 暂停，并返回 {value: 6, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())  
  <span class="hljs-comment">// 第二次调用next，没有传递参数，</span>
  <span class="hljs-comment">//所以 y的值是undefined，那么 y/3 当然是一个NaN，所以应该返回 {value: NaN, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())  
  <span class="hljs-comment">// 同样的道理，z也是undefined，6 + undefined + undefined = NaN，</span>
  <span class="hljs-comment">//返回 {value: NaN, done: true}</span>
}
</code></pre>
<p>如果向next方法提供参数，返回结果就完全不一样了</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params">x</span>) {
    <span class="hljs-keyword">let</span> y = <span class="hljs-number">2</span> * (<span class="hljs-keyword">yield</span> (x + <span class="hljs-number">1</span>))   
    <span class="hljs-comment">// 注意：yield 表达式如果用在另一个表达式中，必须放在圆括号里面</span>
    <span class="hljs-keyword">let</span> z = <span class="hljs-keyword">yield</span> (y / <span class="hljs-number">3</span>)
    <span class="hljs-keyword">return</span> x + y + z
  }

  <span class="hljs-keyword">let</span> it = <span class="hljs-title function_">gen</span>(<span class="hljs-number">5</span>)

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())  
  <span class="hljs-comment">// 正常的运算应该是先执行圆括号内的计算，再去乘以2，</span>
  <span class="hljs-comment">//由于圆括号内被 yield 返回 5 + 1 的结果并暂停，所以返回{value: 6, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>(<span class="hljs-number">9</span>))  
  <span class="hljs-comment">// 上次是在圆括号内部暂停的，所以第二次调用 next方法应该从圆括号里面开始，</span>
  <span class="hljs-comment">//就变成了 let y = 2 * (9)，y被赋值为18，</span>
  <span class="hljs-comment">//所以第二次返回的应该是 18/3的结果 {value: 6, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>(<span class="hljs-number">2</span>))  
  <span class="hljs-comment">// 参数2被赋值给了 z，最终 x + y + z = 5 + 18 + 2 = 25，返回 {value: 25, done: true}</span>
}



{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params">x</span>) {
    <span class="hljs-keyword">let</span> y = <span class="hljs-number">2</span> * (<span class="hljs-keyword">yield</span> (x + <span class="hljs-number">1</span>))   
    <span class="hljs-keyword">let</span> z = <span class="hljs-keyword">yield</span> (y / <span class="hljs-number">3</span>)
    z = <span class="hljs-number">88</span>    <span class="hljs-comment">// 注意看这里</span>
    <span class="hljs-keyword">return</span> x + y + z
  }

  <span class="hljs-keyword">let</span> it = <span class="hljs-title function_">gen</span>(<span class="hljs-number">5</span>)

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>())   <span class="hljs-comment">// {value: 6, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>(<span class="hljs-number">9</span>))  <span class="hljs-comment">// {value: 6, done: false}</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-title function_">next</span>(<span class="hljs-number">2</span>))  <span class="hljs-comment">// 这里其实也很容易理解，参数2被赋值给了 z，但是函数体内又给 z 重新赋值为88， 最终 x + y + z = 5 + 18 + 88 = 111，返回 {value: 111, done: true}</span>
}
</code></pre>
<h2 data-id="heading-10">7.<strong>Generator函数</strong>与 Iterator 接口的关系</h2>
<h3 data-id="heading-11">7.1Generator 函数的核心用途之一是简化迭代器的创建</h3>
<ul>
<li>Generator 对象本身就是一个迭代器（实现了 <code>Symbol.iterator</code> 方法，且返回自身）；</li>
<li>普通迭代器需要手动实现 <code>next()</code> 方法和状态管理，而 Generator 用 <code>yield</code> 即可自动实现迭代逻辑。</li>
</ul>
<h4 data-id="heading-12">(1). 手动实现迭代器（繁琐）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 手动创建一个迭代器，生成 1~3 的数字</span>
<span class="hljs-keyword">const</span> iterator = {
  <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>,
  <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> &lt;= <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
    }
  },
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; } <span class="hljs-comment">// 实现可迭代协议</span>
};

<span class="hljs-comment">// 迭代</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> val <span class="hljs-keyword">of</span> iterator) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h4 data-id="heading-13">(2). Generator 实现迭代器（简洁）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Generator 自动生成迭代器</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">numberGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
}

<span class="hljs-comment">// 迭代（支持 for...of，因为 Generator 对象是可迭代的）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> val <span class="hljs-keyword">of</span> <span class="hljs-title function_">numberGenerator</span>()) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h3 data-id="heading-14">7.2 Iterator（迭代器）</h3>
<p><strong>JavaScript原有的表示集合的数据结构有数组(Array)和对象(Object),ES6又添加了Map和Set。这样就有了4种数据集合，此时便需要****一种统一的接口机制来处理不同的数据结构</strong> <strong>。</strong></p>
<p>ES6 规定，默认的 Iterator 接口部署在数据结构的Symbol.iterator属性，或者说，<strong>一个数据结构只要具有Symbol.iterator属性，就可以认为是“可遍历的”（iterable）。</strong></p>
<p><strong>Symbol.iterator属性本身是一个函数，就是当前数据结构默认的遍历器生成函数。执行这个函数，就会返回一个遍历器。</strong></p>
<p><strong>传统对象没有原生部署 Iterator接口，不能使用 for...of 和 扩展运算符，现在通过给对象添加 Symbol.iterator 属性和对应的遍历器生成函数，就可以使用了</strong></p>
<h4 data-id="heading-15">Iterator对象</h4>
<ol>
<li>Iterator就是这样一个统一的接口。<strong>任何数据结构，主要部署Iterator接口，就可以完成遍历</strong>。</li>
<li><strong>Iterator接口主要供for...of使用</strong>(ES6创造的新的遍历命令),当使用for...of循环时，该循环会自动寻找Iterator接口</li>
<li>Iterator对象本质上是一个指针对象。(创建时指向数据结构头部，依次调用next()方法后指针会移动，依次指向第1，2，3...个成员，最后指向结束位置)</li>
</ol>
<h4 data-id="heading-16">默认迭代器</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {<span class="hljs-comment">//obj具有Symbol.iterator(它是一个方法)，因此是可遍历的</span>
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]:<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">next</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">value</span>:<span class="hljs-number">1</span>,
          <span class="hljs-attr">done</span>:<span class="hljs-literal">true</span>
        }
      }
    }
  }
}
</code></pre>
<p>ES6的<strong>有些数据结构(数组)原生部署了Symbol.iterator属性(称为部署了</strong> <strong>遍历器接口</strong> <strong>)，即不用任何处理就可以被for...of循环。另外一些数据结构(对象)没有。</strong><br/>
以下数据结构原生部署Iterator接口：也就是说这些都可以使用for...of。除了这些，其他数据结构(如对象)的Iterator接口需要自己在Symbol.iterator属性上面部署，才会被for...of遍历。</p>
<ul>
<li>Map</li>
<li>Set</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//NodeList对象//数组的默认迭代器：</span>
<span class="hljs-keyword">let</span> color = [<span class="hljs-string">'red'</span>,<span class="hljs-string">'yellow'</span>,<span class="hljs-string">'blue'</span>]
<span class="hljs-keyword">let</span> arrIt = colorSymbol.<span class="hljs-property">iterator</span>;<span class="hljs-comment">//返回一个迭代器</span>
arrIt.<span class="hljs-title function_">next</span>()<span class="hljs-comment">//{value:'red',done:false}</span>
<span class="hljs-comment">//类数组arguments的默认迭代器：</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>){
<span class="hljs-keyword">let</span> argsIt = argumentsSymbol.<span class="hljs-property">iterator</span>;
argsIt.<span class="hljs-title function_">next</span>()
}
<span class="hljs-comment">//类数组dom节点的默认迭代器：</span>
<span class="hljs-keyword">let</span> myP = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">'li'</span>);
<span class="hljs-keyword">let</span> pIt = myPSymbol.<span class="hljs-property">iterator</span>;
pIt.<span class="hljs-title function_">next</span>();
<span class="hljs-comment">//字符串的默认迭代器：</span>
<span class="hljs-keyword">let</span>　str = <span class="hljs-string">'dhakjda'</span>;
<span class="hljs-keyword">let</span> strIt = strSymbol.<span class="hljs-property">iterator</span>;
strIt.<span class="hljs-title function_">next</span>();
<span class="hljs-comment">//对象没有默认(即内置)迭代器：obj[Symbol.iterator] is not a function</span>
</code></pre>
<h2 data-id="heading-17">8.for...of 循环</h2>
<p>由于 Generator 函数运行时生成的是一个 Iterator 对象，因此，可以直接使用 for...of 循环遍历，且此时无需再调用 next() 方法</p>
<p>这里需要注意，一旦 next() 方法的返回对象的 done 属性为 true，for...of 循环就会终止，且不包含该返回对象</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-number">4</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>
  }

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> <span class="hljs-title function_">gen</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item)
  }

  <span class="hljs-comment">// 1 2 3 4</span>
}
</code></pre>
<h2 data-id="heading-18">9.Generator 的典型应用场景</h2>
<h3 data-id="heading-19">9.1 异步编程（ES6 时代的方案）</h3>
<p><strong>Generator 是</strong> <code>async/await</code> <strong>的 “前身”</strong> ，通过 <code>yield</code> 暂停异步操作，<code>next()</code> 恢复执行，解决了回调地狱问题。需配合自动执行器（如 <code>co</code> 库）使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 模拟异步请求</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`数据：<span class="hljs-subst">${url}</span>`</span>), <span class="hljs-number">1000</span>);
  });
}

<span class="hljs-comment">// Generator 函数封装异步逻辑</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">asyncGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'url1'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data1); <span class="hljs-comment">// 1秒后输出：数据：url1</span>
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'url2'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data2); <span class="hljs-comment">// 再1秒后输出：数据：url2</span>
}

<span class="hljs-comment">// 手动执行（实际用 co 库自动执行）</span>
<span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">asyncGenerator</span>();
gen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data1</span> =&gt;</span> {
  gen.<span class="hljs-title function_">next</span>(data1).<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data2</span> =&gt;</span> {
    gen.<span class="hljs-title function_">next</span>(data2);
  });
});
<span class="hljs-comment">//.then(data1 =&gt; {}) → 是 Promise 的异步回调，等 1 秒后，异步请求完成，</span>
<span class="hljs-comment">//Promise 的 resolve 值是 数据：url1，这个值会被自动传给回调函数的形参 data1；</span>
</code></pre>
<p>注：ES7 引入的 <code>async/await</code> 是 Generator + Promise 的语法糖，更简洁易用，现在已替代 Generator 成为主流异步方案</p>
<h3 data-id="heading-20">9.2 生成无限序列（惰性求值）</h3>
<p><strong>Generator 支持 “按需生成” 数据，不会一次性创建所有数据，适合处理无限序列</strong>（如斐波那契数列）或大数据集：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 生成无限斐波那契数列</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">yield</span> a;
    [a, b] = [b, a + b];
  }
}

<span class="hljs-keyword">const</span> fib = <span class="hljs-title function_">fibonacci</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fib.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 0</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fib.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fib.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fib.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fib.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 按需获取，不会占用大量内存</span>
</code></pre>
<h3 data-id="heading-21">9.3 控制流管理</h3>
<p><strong>通过 <code>yield</code> 可以灵活控制函数执行顺序，适合复杂的流程控制</strong>（如分步执行、条件分支）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">taskFlow</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务1'</span>);
  <span class="hljs-keyword">yield</span>; <span class="hljs-comment">// 暂停，等待外部触发下一步</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务2'</span>);
  <span class="hljs-keyword">const</span> flag = <span class="hljs-keyword">yield</span> <span class="hljs-string">'是否执行任务3？'</span>; <span class="hljs-comment">// 产出询问，接收外部决策</span>
  <span class="hljs-keyword">if</span> (flag) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务3执行'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务3跳过'</span>);
  }
}

<span class="hljs-keyword">const</span> flow = <span class="hljs-title function_">taskFlow</span>();
flow.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 任务1 → { value: undefined, done: false }</span>
<span class="hljs-keyword">const</span> res = flow.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 任务2 → { value: '是否执行任务3？', done: false }</span>
flow.<span class="hljs-title function_">next</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 任务3执行 → { value: undefined, done: true }</span>
</code></pre>
<h3 data-id="heading-22">最后</h3>
<p>这是《<a href="https://juejin.cn/column/7355759709166845963" target="_blank" title="https://juejin.cn/column/7355759709166845963">JavaScript系列</a>》第8篇，将持续更新。</p>
<p>小伙伴如果喜欢我的分享，可以动动您发财的手关注下我，我会持续更新的！！！<br/>
您对我的关注、点赞和收藏，是对我最大的支持！欢迎关注、评论、讨论和指正！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每组件（Per-Component）与集中式（Centralized）i18n]]></title>    <link>https://juejin.cn/post/7594616268782665755</link>    <guid>https://juejin.cn/post/7594616268782665755</guid>    <pubDate>2026-01-13T10:20:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782665755" data-draft-id="7594616268782616603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每组件（Per-Component）与集中式（Centralized）i18n"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-13T10:20:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户638799477305"/> <meta itemprop="url" content="https://juejin.cn/user/2763505844628169"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每组件（Per-Component）与集中式（Centralized）i18n
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763505844628169/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户638799477305
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:20:23.000Z" title="Tue Jan 13 2026 10:20:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>每组件（per-component）方法并非新概念。例如，在 Vue 生态系统中，<code>vue-i18n</code> 支持 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvue-i18n.intlify.dev%2Fguide%2Fadvanced%2Fsfc.html" target="_blank" title="https://vue-i18n.intlify.dev/guide/advanced/sfc.html" ref="nofollow noopener noreferrer">SFC i18n（单文件组件）</a>。Nuxt 也提供 <a href="https://link.juejin.cn?target=https%3A%2F%2Fi18n.nuxtjs.org%2Fdocs%2Fguide%2Fper-component-translations" target="_blank" title="https://i18n.nuxtjs.org/docs/guide/per-component-translations" ref="nofollow noopener noreferrer">按组件翻译</a>，Angular 通过其 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv17.angular.io%2Fguide%2Ffeature-modules" target="_blank" title="https://v17.angular.io/guide/feature-modules" ref="nofollow noopener noreferrer">Feature Modules</a> 采用类似的模式。</p>
<p>即使在 Flutter 应用中，我们也常能发现这样的模式：</p>
<pre><code class="hljs language-bash" lang="bash">lib/
└── features/
    └── login/
        ├── login_screen.dart
        └── login_screen.i18n.dart  <span class="hljs-comment"># &lt;- 翻译存放在这里</span>
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:i18n_extension/i18n_extension.dart'</span>;

<span class="hljs-keyword">extension</span> Localization <span class="hljs-keyword">on</span> <span class="hljs-built_in">String</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> _t = Translations.byText(<span class="hljs-string">"en"</span>) +
      {
        <span class="hljs-string">"Hello"</span>: {
          <span class="hljs-string">"en"</span>: <span class="hljs-string">"Hello"</span>,
          <span class="hljs-string">"fr"</span>: <span class="hljs-string">"Bonjour"</span>,
        },
      };

  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> i18n =&gt; localize(<span class="hljs-keyword">this</span>, _t);
}
</code></pre>
<p>然而在 React 领域，我们主要看到不同的做法，我会将它们分为三类：</p>

  
<p><strong>集中式方法</strong>（i18next、next-intl、react-intl、lingui）</p>
<ul>
<li>（无命名空间）将内容视为单一来源进行检索。默认情况下，当应用加载时，会从所有页面加载内容。</li>
</ul>
<p><strong>细粒度方法</strong> (intlayer, inlang)</p>
<ul>
<li>按键或按组件对内容检索进行细化。</li>
</ul>
<blockquote>
<p>在本博文中，我不会专注于基于编译器的解决方案，我已经在这里覆盖过：<a href="https://link.juejin.cn?target=https%3A%2F%2Fintlayer.org%2Fzh%2Fblog%2Fper-component-vs-centralized-i18n" target="_blank" title="https://intlayer.org/zh/blog/per-component-vs-centralized-i18n" ref="nofollow noopener noreferrer">Compiler vs Declarative i18n</a>.
注意，基于编译器的 i18n（例如 Lingui）只是自动化了内容的提取和加载。在底层，它们通常与其他方法共享相同的限制。</p>
</blockquote>
<blockquote>
<p>注意，你越细化内容的检索方式，就越有可能将额外的 state 和逻辑插入到组件中。</p>
</blockquote>
<p>细粒度方法比集中式方法更灵活，但这通常是一种权衡。即使这些 libraries 宣称支持 "tree shaking"，在实际中，你通常仍会以每种语言加载整个页面。</p>
<p>所以，概括来说，决策大致可以分为：</p>
<ul>
<li>如果你的应用页面数量多于语言数量，应优先采用细粒度方法。</li>
<li>如果语言数量多于页面数量，则应倾向于集中式方法。</li>
</ul>
<p>当然，library 的作者们也意识到这些限制并提供了解决方案。
其中包括：将内容拆分为命名空间、动态加载 JSON 文件（<code>await import()</code>），或在构建时剔除内容。</p>
<p>与此同时，你应该知道，当你动态加载内容时，会向服务器引入额外的请求。每多一个 <code>useState</code> 或 hook，就意味着一次额外的服务器请求。</p>
<blockquote>
<p>为了解决这一点，Intlayer 建议将多个内容定义分组到同一个键下，Intlayer 会合并这些内容。</p>
</blockquote>
<p>但综观这些解决方案，最流行的方法显然是集中式的。</p>
<h3 data-id="heading-0">那么为什么集中式方法如此受欢迎？</h3>
<ul>
<li>首先，i18next 是第一个被广泛采用的解决方案，其理念受 PHP 和 Java 架构（MVC）的启发，依赖于严格的关注点分离（将内容与代码分离）。它于 2011 年出现，在向基于组件的架构（如 React）大规模转变之前就确立了其标准。</li>
<li>此外，一旦某个库被广泛采用，就很难将生态系统转向其他模式。</li>
<li>在 Crowdin、Phrase 或 Localized 等翻译管理系统中，使用集中式方法也更为方便。</li>
<li>按组件（per-component）方法背后的逻辑比集中式更复杂，开发需要更多时间，尤其是在需要解决诸如识别内容位置等问题时。</li>
</ul>
<h3 data-id="heading-1">好的，但为什么不直接坚持集中式方法？</h3>
<p>让我告诉你这对你的应用可能会带来哪些问题：</p>
<ul>
<li><strong>未使用的数据：</strong>
当一个页面加载时，你通常会加载来自所有其他页面的内容。（在一个 10 页的应用中，那就是 90% 未使用的内容被加载）。你懒加载一个 modal？i18n 库并不在意，它反正会先加载这些字符串。</li>
<li><strong>性能：</strong>
每次重新渲染时，你的每个组件都会被一个巨大的 JSON payload 进行 hydrate，这会随着应用增长影响其响应性。</li>
<li><strong>维护：</strong>
维护大型 JSON 文件很痛苦。你必须在文件之间来回跳转以插入翻译，确保没有翻译缺失且没有孤立的 key 留下。</li>
<li><strong>设计系统：</strong>
这会导致与设计系统不兼容（例如，<code>LoginForm</code> 组件），并限制在不同应用之间复制组件的能力。</li>
</ul>
<p><strong>“但我们发明了 Namespaces！”</strong></p>
<p>当然，这确实是一个巨大的进步。下面对比一下在 Vite + React + React Router v7 + Intlayer 配置下主 bundle 大小的差异。我们模拟了一个 20 页的应用。</p>
<p>第一个示例没有为每个 locale 进行懒加载翻译，也没有进行命名空间拆分。第二个示例则包含内容清理（purging）和翻译的动态加载。</p>













<table><thead><tr><th>已优化的 bundle</th><th>未优化的 bundle</th></tr></thead><tbody><tr><td><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ea7fbb13e324b0abf7cb4d3ccb680d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjM4Nzk5NDc3MzA1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768905342&amp;x-signature=y9RjMEVLreUtFhm4uFPb6BbD%2B08%3D" alt="bundle_no_optimization.png" loading="lazy"/></td><td/></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03d44c4391354f37aaec52ed88f121e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjM4Nzk5NDc3MzA1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768905342&amp;x-signature=aC4c83OlWnIgNP%2FP9u9si9aAgQg%3D" alt="bundle.png" loading="lazy"/></p>
<p>因此，多亏了 namespaces，我们将结构从以下形式迁移：</p>
<pre><code class="hljs language-bash" lang="bash">locale/
├── en.json
├── fr.json
└── es.json
</code></pre>
<p>到这个结构：</p>
<pre><code class="hljs language-bash" lang="bash">locale/
├── en/
│   ├── common.json
│   ├── navbar.json
│   ├── footer.json
│   ├── home.json
│   └── about.json
├── fr/
│   └── ...
└── es/
    └── ...

</code></pre>
<p>现在你必须精细地管理应用的哪些内容应该被加载，以及在何处加载它们。总之，由于复杂性，绝大多数项目都会跳过这一步（例如参见 [<a href="https://link.juejin.cn?target=url" target="_blank" title="url" ref="nofollow noopener noreferrer">next-i18next</a> 指南](<a href="https://link.juejin.cn?target=https%3A%2F%2Fintlayer.org%2Fzh%2Fblog%2Fnextjs-internationalization-using-next-i18next" target="_blank" title="https://intlayer.org/zh/blog/nextjs-internationalization-using-next-i18next" ref="nofollow noopener noreferrer">intlayer.org/zh/blog/nex…</a>) 来了解仅仅遵循良好实践也会带来哪些挑战）。因此，这些项目最终会遇到前面解释的庞大 JSON 加载问题。</p>
<blockquote>
<p>注意，这个问题并非 i18next 所特有，而是上述所有集中式方法共有的问题。</p>
</blockquote>
<p>然而，我想提醒你，并非所有细粒度方法都能解决这个问题。例如，<code>vue-i18n SFC</code> 或 <code>inlang</code> 的做法并不会本质上为每个语言环境按需懒加载翻译，因此你只是将捆绑包大小的问题换成了另一个问题。</p>
<p>此外，如果没有适当的关注点分离，就更难将翻译内容提取并提供给译者进行审核。</p>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fintlayer.org%2Fzh" target="_blank" title="https://intlayer.org/zh" ref="nofollow noopener noreferrer">Intlayer</a> 的按组件方法如何解决这个问题</h3>
<p>Intlayer 通过以下几个步骤来处理：</p>
<ol>
<li><strong>声明：</strong> 在代码库的任何位置使用 <code>*.content.{ts|jsx|cjs|json|json5|...}</code> 文件声明你的内容。这既确保了关注点分离，又保持内容与组件同处一处。内容文件可以是针对单一语言的，也可以是多语言的。</li>
<li><strong>Processing:</strong> Intlayer 在构建步骤中运行，用于处理 JS 逻辑、处理缺失的翻译回退、生成 TypeScript 类型、管理重复内容、从你的 CMS 获取内容，等等。</li>
<li><strong>Purging:</strong> 当你的应用构建时，Intlayer 会清除未使用的内容（有点像 Tailwind 管理你的类的方式），通过如下方式替换内容：</li>
</ol>
<p><strong>Declaration:</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// src/MyComponent.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> content = <span class="hljs-title function_">useIntlayer</span>(<span class="hljs-string">"my-key"</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{content.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
};
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// src/myComponent.content.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> {
  <span class="hljs-attr">key</span>: <span class="hljs-string">"my-key"</span>,
  <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>({
    <span class="hljs-attr">zh</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">"我的标题"</span> },
    <span class="hljs-attr">en</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">"My title"</span> },
    <span class="hljs-attr">fr</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">"Mon titre"</span> }
  })
}

</code></pre>
<p><strong>Processing:</strong> Intlayer builds the dictionary based on the <code>.content</code> file and generates:</p>
<pre><code class="hljs language-json5" lang="json5">// .intlayer/dynamic_dictionary/zh/my-key.json（翻译后的 JSON 文件示例）
{
  "key": "my-key",
  "content": { "title": "我的标题" },
}
</code></pre>
<p><strong>替换：</strong> Intlayer 在应用构建期间转换你的组件。</p>
<p><strong>- 静态导入模式：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 在类 JSX 语法中的组件表示</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> content = <span class="hljs-title function_">useDictionary</span>({
    <span class="hljs-attr">key</span>: <span class="hljs-string">"my-key"</span>,
    <span class="hljs-attr">content</span>: {
      <span class="hljs-attr">nodeType</span>: <span class="hljs-string">"translation"</span>,
      <span class="hljs-attr">translation</span>: {
        <span class="hljs-attr">zh</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">"我的标题"</span> },
        <span class="hljs-attr">en</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">"My title"</span> },
        <span class="hljs-attr">fr</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">"Mon titre"</span> },
      },
    },
  });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{content.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
};
</code></pre>
<p><strong>- 动态导入模式：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 在类 JSX 语法中的组件表示</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> content = <span class="hljs-title function_">useDictionaryAsync</span>({
    <span class="hljs-attr">en</span>: <span class="hljs-function">() =&gt;</span>
      <span class="hljs-keyword">import</span>(<span class="hljs-string">".intlayer/dynamic_dictionary/en/my-key.json"</span>, {
        <span class="hljs-attr">with</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"json"</span> },
      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">mod</span>) =&gt;</span> mod.<span class="hljs-property">default</span>),
    <span class="hljs-comment">// Same for other languages</span>
  });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{content.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
};
</code></pre>
<blockquote>
<p><code>useDictionaryAsync</code> 使用类似 Suspense 的机制，仅在需要时加载本地化的 JSON。</p>
</blockquote>
<p><strong>此按组件方法的主要优点：</strong></p>
<ul>
<li>
<p>将内容声明与组件放在一起可以提高可维护性（例如：将组件移动到另一个应用或 design system。删除组件文件夹时也会同时移除相关内容，就像你通常对 <code>.test</code>、<code>.stories</code> 所做的那样）</p>
</li>
<li>
<p>以组件为单位的方法可以防止 AI 代理需要在你所有不同的文件之间来回跳转。它将所有翻译集中在一个地方，限制了任务的复杂性以及使用的 tokens 数量。</p>
</li>
</ul>
<h3 data-id="heading-3">限制</h3>
<p>当然，这种方法有其权衡：</p>
<ul>
<li>更难与其他 l10n 系统和额外的工具链对接。</li>
<li>会产生锁定（lock-in）问题（这在任何 i18n 解决方案中基本都存在，因为它们有特定的语法）。</li>
</ul>
<p>这就是 Intlayer 试图为 i18n 提供完整工具集（100% 免费且 OSS）的原因，包括使用你自己的 AI Provider 和 API 密钥进行 AI 翻译的功能。Intlayer 还提供用于同步你的 JSON 的工具，类似于 ICU / vue-i18n / i18next 的消息格式化器，用以将内容映射到它们的特定格式。</p>
<p>我很乐意听到你对它的真实反馈。你的反对意见真的有助于打造一个更好的产品。这是不是有点过度设计了？还是它会成为下一个 Tailwind？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[useEffect 空依赖 + 定时器 = 闭包陷阱？count 永远停在 1 的坑我踩透了]]></title>    <link>https://juejin.cn/post/7594578555352956979</link>    <guid>https://juejin.cn/post/7594578555352956979</guid>    <pubDate>2026-01-13T10:55:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555352956979" data-draft-id="7594681318827835442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="useEffect 空依赖 + 定时器 = 闭包陷阱？count 永远停在 1 的坑我踩透了"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T10:55:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="全栈打怪日记"/> <meta itemprop="url" content="https://juejin.cn/user/2269028453720813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            useEffect 空依赖 + 定时器 = 闭包陷阱？count 永远停在 1 的坑我踩透了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2269028453720813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    全栈打怪日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:55:15.000Z" title="Tue Jan 13 2026 10:55:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写 React 时，你有没有遇到过「定时器里的 state 永远不更新」的诡异情况？比如明明写了<code>setCount(count + 1)</code>，页面上的<code>count</code>却永远停在 1—— 这其实是 ** 闭包陷阱（Stale Closure）** 在搞鬼。</p>
<p>今天用一个极简示例，拆解这个坑的本质，再给你 2 个一劳永逸的解决方案。</p>
<h4 data-id="heading-0">一、先看复现：count 为什么永远停在 1？</h4>
<p>先看这段 “看似没问题” 的代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98744674cf6a445f8a2a54b8d7f8199d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI5omT5oCq5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768906515&amp;x-signature=IYM9DWxbFjJx098vRNn%2FLFhUXSc%3D" alt="carbon.png" loading="lazy"/></p>
<p><strong>运行结果</strong>：页面上的<code>count</code>从 0 变成 1 后，就再也不涨了。</p>
<h4 data-id="heading-1">二、核心原因：闭包 “定格” 了初始 state</h4>
<p>问题出在 2 个关键点的叠加：</p>
<ol>
<li><strong>useEffect 的空依赖<code>[]</code></strong> ：空依赖意味着<code>useEffect</code><strong>只在组件挂载时执行 1 次</strong>，后续组件更新不会重新运行这个 effect。</li>
<li><strong>闭包捕获了 “快照” 值</strong>：<code>useEffect</code>执行时，内部的<code>setInterval</code>函数形成了闭包 —— 它 “抓住” 了当时的<code>count</code>（值为 0）。后续<code>count</code>虽然被更新，但因为<code>useEffect</code>没重新执行，这个闭包<strong>永远拿着初始值 0</strong>，所以<code>setCount(count + 1)</code>永远是<code>0 + 1 = 1</code>。</li>
</ol>
<h4 data-id="heading-2">三、2 个解决方案：从根源避开闭包陷阱</h4>
<p>针对这个场景，推荐 2 种既简单又安全的写法：</p>
<h5 data-id="heading-3">方案 1：函数式更新（推荐）</h5>
<p>用<code>setState</code>的<strong>函数式写法</strong>，直接获取最新的 state 值，绕开闭包的旧值：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12972fbf56524ee48b65fc9b83573177~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI5omT5oCq5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768906515&amp;x-signature=Uja37rEaa5p6xrmVnMkn0dki9oc%3D" alt="carbon (1).png" loading="lazy"/></p>
<p><strong>原理</strong>：<code>setCount(c =&gt; c + 1)</code>会从 React 内部获取当前最新的<code>count</code>值，不管闭包抓的是旧值，都能拿到最新数据。</p>
<h5 data-id="heading-4">方案 2：补全依赖数组</h5>
<p>把<code>count</code>加入<code>useEffect</code>的依赖数组，让<code>useEffect</code>在<code>count</code>变化时重新执行，生成新的闭包：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75079adc34cb4788bb89305f7e6d5904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI5omT5oCq5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768906515&amp;x-signature=61zNFuxdPv%2FFHxqIdd5T7VmzqEI%3D" alt="carbon (2).png" loading="lazy"/></p>
<p><strong>注意</strong>：这个方案会<strong>频繁创建 / 清理定时器</strong>（每次<code>count</code>变化都重新执行 effect），性能不如方案 1，仅推荐在 “必须依赖外部变量” 的场景使用。</p>
<h4 data-id="heading-5">四、避坑总结：useEffect + 定时器的正确姿势</h4>
<ol>
<li><strong>优先用函数式更新</strong>：<code>setState(prev =&gt; prev + 1)</code>是避开闭包陷阱的 “万能钥匙”；</li>
<li><strong>空依赖要谨慎</strong>：空依赖的<code>useEffect</code>里，尽量避免直接引用 state/props，改用函数式更新；</li>
<li><strong>依赖数组要写全</strong>：如果必须依赖外部变量，一定要把变量加入依赖数组（配合 ESLint 的<code>react-hooks/exhaustive-deps</code>规则）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android WebView 混合开发完整指南]]></title>    <link>https://juejin.cn/post/7594468778110664738</link>    <guid>https://juejin.cn/post/7594468778110664738</guid>    <pubDate>2026-01-13T07:13:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594468778110664738" data-draft-id="7594468778110484514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android WebView 混合开发完整指南"/> <meta itemprop="keywords" content="前端,面试,Android"/> <meta itemprop="datePublished" content="2026-01-13T07:13:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青莲843"/> <meta itemprop="url" content="https://juejin.cn/user/541408646929991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android WebView 混合开发完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/541408646929991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青莲843
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:13:00.000Z" title="Tue Jan 13 2026 07:13:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、JavaScript 调用 Android 的所有方式</h2>
<h3 data-id="heading-1">1.1 addJavascriptInterface 方法（最常用）</h3>
<p><strong>原理</strong>：将 Java 对象暴露给 WebView 中的 JavaScript，JavaScript 可以直接调用该对象的方法。</p>
<p><strong>版本要求</strong>：</p>
<ul>
<li>Android 4.2+ 必须使用 <code>@JavascriptInterface</code> 注解</li>
<li>Android 4.2 之前存在安全漏洞</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 最简单直接的方式</li>
<li>✅ 支持双向通信</li>
<li>✅ 可以传递复杂参数</li>
<li>⚠️ Android 4.2 之前有安全风险</li>
<li>⚠️ 需要确保方法有 <code>@JavascriptInterface</code> 注解</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建接口类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JSInterface</span> {
    <span class="hljs-keyword">private</span> Context context;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JSInterface</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">this</span>.context = context;
    }
    
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showToast</span><span class="hljs-params">(String message)</span> {
        Toast.makeText(context, message, Toast.LENGTH_SHORT).show();
    }
    
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDeviceInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Build.MODEL;
    }
}

<span class="hljs-comment">// 绑定到 WebView</span>
<span class="hljs-type">WebView</span> <span class="hljs-variable">webView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);
webView.getSettings().setJavaScriptEnabled(<span class="hljs-literal">true</span>);
webView.addJavascriptInterface(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JSInterface</span>(<span class="hljs-built_in">this</span>), <span class="hljs-string">"Android"</span>);
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 调用方法</span>
<span class="hljs-title class_">Android</span>.<span class="hljs-title function_">showToast</span>(<span class="hljs-string">'Hello from JavaScript'</span>);
<span class="hljs-keyword">var</span> deviceInfo = <span class="hljs-title class_">Android</span>.<span class="hljs-title function_">getDeviceInfo</span>();
</code></pre>
<hr/>
<h3 data-id="heading-2">1.2 shouldOverrideUrlLoading 拦截（URL Scheme）</h3>
<p><strong>原理</strong>：拦截 WebView 中的 URL 请求，通过自定义协议（如 <code>myapp://</code>）实现通信。</p>
<p><strong>版本要求</strong>：所有 Android 版本</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 安全性较高</li>
<li>✅ 兼容性好</li>
<li>❌ 只能单向通信（JS → Android）</li>
<li>❌ 无法直接获取返回值（需要通过回调）</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">webView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {
        <span class="hljs-keyword">if</span> (url.startsWith(<span class="hljs-string">"myapp://"</span>)) {
            <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(url);
            <span class="hljs-type">String</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> uri.getHost();
            <span class="hljs-type">String</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> uri.getQueryParameter(<span class="hljs-string">"param"</span>);
            
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"showToast"</span>.equals(action)) {
                Toast.makeText(context, param, Toast.LENGTH_SHORT).show();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, WebResourceRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getUrl().toString();
        <span class="hljs-keyword">if</span> (url.startsWith(<span class="hljs-string">"myapp://"</span>)) {
            <span class="hljs-comment">// 处理逻辑同上</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
});
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 iframe（推荐，不会触发页面跳转）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">callAndroid</span>(<span class="hljs-params">action, param</span>) {
    <span class="hljs-keyword">var</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'iframe'</span>);
    iframe.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    iframe.<span class="hljs-property">src</span> = <span class="hljs-string">"myapp://"</span> + action + <span class="hljs-string">"?param="</span> + <span class="hljs-built_in">encodeURIComponent</span>(param);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(iframe);
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(iframe), <span class="hljs-number">100</span>);
}

<span class="hljs-title function_">callAndroid</span>(<span class="hljs-string">"showToast"</span>, <span class="hljs-string">"Hello"</span>);
</code></pre>
<hr/>
<h3 data-id="heading-3">1.3 onJsPrompt 方法（推荐，可返回值）</h3>
<p><strong>原理</strong>：拦截 JavaScript 的 <code>prompt()</code> 调用，可以实现双向通信并获取返回值。</p>
<p><strong>版本要求</strong>：所有 Android 版本</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 可以获取返回值</li>
<li>✅ 安全性较高</li>
<li>✅ 兼容性好</li>
<li>⚠️ 需要约定通信协议格式</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">webView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsPrompt</span><span class="hljs-params">(WebView view, String url, String message, 
                              String defaultValue, JsPromptResult result)</span> {
        <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span> &amp;&amp; message.startsWith(<span class="hljs-string">"jsbridge://"</span>)) {
            <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(message);
            <span class="hljs-type">String</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> uri.getHost();
            
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"getDeviceInfo"</span>.equals(action)) {
                result.confirm(Build.MODEL);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"getVersion"</span>.equals(action)) {
                result.confirm(Build.VERSION.RELEASE);
            } <span class="hljs-keyword">else</span> {
                result.confirm(<span class="hljs-string">"unknown"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
});
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params">action, params</span>) {
    <span class="hljs-keyword">var</span> url = <span class="hljs-string">"jsbridge://"</span> + action;
    <span class="hljs-keyword">if</span> (params) {
        url += <span class="hljs-string">"?"</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(params).<span class="hljs-title function_">toString</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">prompt</span>(url);
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">var</span> device = <span class="hljs-title function_">callNative</span>(<span class="hljs-string">"getDeviceInfo"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Device: "</span> + device);
</code></pre>
<hr/>
<h3 data-id="heading-4">1.4 onJsAlert 方法</h3>
<p><strong>原理</strong>：拦截 JavaScript 的 <code>alert()</code> 调用。</p>
<p><strong>版本要求</strong>：所有 Android 版本</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 简单易用</li>
<li>❌ 只能单向通信（JS → Android）</li>
<li>❌ 无返回值</li>
<li>⚠️ 会显示弹窗，用户体验可能不佳</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">webView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsAlert</span><span class="hljs-params">(WebView view, String url, String message, JsResult result)</span> {
        <span class="hljs-keyword">if</span> (message.startsWith(<span class="hljs-string">"jsbridge://"</span>)) {
            handleBridgeMessage(message);
            result.confirm();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(view.getContext())
            .setMessage(message)
            .setPositiveButton(<span class="hljs-string">"确定"</span>, (d, w) -&gt; result.confirm())
            .show();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
});
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params">action, params</span>) {
    <span class="hljs-keyword">var</span> msg = <span class="hljs-string">"jsbridge://"</span> + action + (params ? <span class="hljs-string">"?"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params) : <span class="hljs-string">""</span>);
    <span class="hljs-title function_">alert</span>(msg);
}
</code></pre>
<hr/>
<h3 data-id="heading-5">1.5 onJsConfirm 方法</h3>
<p><strong>原理</strong>：拦截 JavaScript 的 <code>confirm()</code> 调用，可以获取用户的选择结果。</p>
<p><strong>版本要求</strong>：所有 Android 版本</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 可以获取用户选择</li>
<li>❌ 只能单向通信（JS → Android）</li>
<li>⚠️ 会显示确认对话框</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">webView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsConfirm</span><span class="hljs-params">(WebView view, String url, String message, JsResult result)</span> {
        <span class="hljs-keyword">if</span> (message.startsWith(<span class="hljs-string">"jsbridge://"</span>)) {
            handleBridgeMessage(message);
            result.confirm();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(view.getContext())
            .setMessage(message)
            .setPositiveButton(<span class="hljs-string">"确定"</span>, (d, w) -&gt; result.confirm())
            .setNegativeButton(<span class="hljs-string">"取消"</span>, (d, w) -&gt; result.cancel())
            .show();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
});
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params">action, params</span>) {
    <span class="hljs-keyword">var</span> msg = <span class="hljs-string">"jsbridge://"</span> + action + (params ? <span class="hljs-string">"?"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params) : <span class="hljs-string">""</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">confirm</span>(msg);
}
</code></pre>
<hr/>
<h3 data-id="heading-6">1.6 onConsoleMessage 方法</h3>
<p><strong>原理</strong>：捕获 JavaScript 控制台日志，可以用于传递数据。</p>
<p><strong>版本要求</strong>：所有 Android 版本</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 主要用于调试</li>
<li>✅ 可以传递数据</li>
<li>❌ 不适合生产环境使用</li>
<li>⚠️ 主要用于日志收集</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">webView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onConsoleMessage</span><span class="hljs-params">(ConsoleMessage consoleMessage)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> consoleMessage.message();
        <span class="hljs-keyword">if</span> (msg.startsWith(<span class="hljs-string">"jsbridge://"</span>)) {
            handleBridgeMessage(msg);
        } <span class="hljs-keyword">else</span> {
            Log.d(<span class="hljs-string">"WebView"</span>, msg);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
});
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params">action, params</span>) {
    <span class="hljs-keyword">var</span> msg = <span class="hljs-string">"jsbridge://"</span> + action + (params ? <span class="hljs-string">"?"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params) : <span class="hljs-string">""</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
}
</code></pre>
<hr/>
<h3 data-id="heading-7">1.7 postMessage 方法（Android 6.0+）</h3>
<p><strong>原理</strong>：使用 <code>WebMessagePort</code> 进行消息传递，这是官方推荐的安全通信方式。</p>
<p><strong>版本要求</strong>：Android 6.0 (API 23)+</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 官方推荐的安全方式</li>
<li>✅ 支持双向通信</li>
<li>✅ 安全性高</li>
<li>❌ 需要 Android 6.0+</li>
<li>⚠️ 实现相对复杂</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
    <span class="hljs-keyword">if</span> (WebViewFeature.isFeatureSupported(WebViewFeature.WEB_MESSAGE_PORT_POST_MESSAGE)) {
        WebMessagePort[] ports = webView.createWebMessageChannel();
        <span class="hljs-type">WebMessagePort</span> <span class="hljs-variable">port1</span> <span class="hljs-operator">=</span> ports[<span class="hljs-number">0</span>];
        <span class="hljs-type">WebMessagePort</span> <span class="hljs-variable">port2</span> <span class="hljs-operator">=</span> ports[<span class="hljs-number">1</span>];
        
        <span class="hljs-comment">// 将 port2 传递给 JavaScript</span>
        webView.postWebMessage(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebMessage</span>(<span class="hljs-string">"init"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebMessagePort</span>[]{port2}),
            Uri.parse(<span class="hljs-string">"https://example.com"</span>)
        );
        
        <span class="hljs-comment">// 监听来自 JavaScript 的消息</span>
        port1.setWebMessageCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebMessagePort</span>.WebMessageCallback() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(WebMessagePort port, WebMessage message)</span> {
                Log.d(<span class="hljs-string">"WebView"</span>, <span class="hljs-string">"Received: "</span> + message.getData());
                port.postMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebMessage</span>(<span class="hljs-string">"Response from Android"</span>));
            }
        });
    }
}
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"message"</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span> === <span class="hljs-string">"init"</span> &amp;&amp; event.<span class="hljs-property">ports</span> &amp;&amp; event.<span class="hljs-property">ports</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> port = event.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
        port.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received: "</span> + e.<span class="hljs-property">data</span>);
        };
        port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">"Hello from JavaScript"</span>);
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">androidPort</span> = port;
    }
});

<span class="hljs-comment">// 后续使用</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">androidPort</span>?.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">"Another message"</span>);
</code></pre>
<hr/>
<h3 data-id="heading-8">1.8 通过 JSBridge 库调用</h3>
<p>详见 <a href="#%E4%B8%89jsbridge-%E5%BC%80%E6%BA%90%E5%BA%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F" title="#%E4%B8%89jsbridge-%E5%BC%80%E6%BA%90%E5%BA%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F">三、JSBridge 开源库实现方式</a></p>
<hr/>
<h2 data-id="heading-9">二、Android 调用 JavaScript 的所有方式</h2>
<h3 data-id="heading-10">2.1 evaluateJavascript 方法（推荐，Android 4.4+）</h3>
<p><strong>原理</strong>：在 WebView 中执行 JavaScript 代码并获取返回值。</p>
<p><strong>版本要求</strong>：Android 4.4 (API 19)+</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 支持异步回调</li>
<li>✅ 可以获取返回值</li>
<li>✅ 性能较好</li>
<li>✅ 官方推荐方式</li>
<li>❌ 需要 Android 4.4+</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 调用无返回值方法</span>
webView.evaluateJavascript(<span class="hljs-string">"javascript:showMessage('Hello')"</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 调用有返回值方法</span>
webView.evaluateJavascript(<span class="hljs-string">"javascript:getData()"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueCallback</span>&lt;String&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceiveValue</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; !value.equals(<span class="hljs-string">"null"</span>)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">JSONObject</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(value);
                Log.d(<span class="hljs-string">"WebView"</span>, <span class="hljs-string">"Result: "</span> + json.toString());
            } <span class="hljs-keyword">catch</span> (JSONException e) {
                Log.d(<span class="hljs-string">"WebView"</span>, <span class="hljs-string">"Result: "</span> + value);
            }
        }
    }
});

<span class="hljs-comment">// 传递参数</span>
<span class="hljs-type">String</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>().put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"John"</span>).put(<span class="hljs-string">"age"</span>, <span class="hljs-number">30</span>).toString();
webView.evaluateJavascript(<span class="hljs-string">"javascript:handleData("</span> + params + <span class="hljs-string">")"</span>, <span class="hljs-literal">null</span>);
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">showMessage</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-title function_">alert</span>(message);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span>, <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> } };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">params</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received:'</span>, params);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
}
</code></pre>
<p><strong>返回值处理</strong>：</p>
<pre><code class="hljs language-java" lang="java">webView.evaluateJavascript(<span class="hljs-string">"javascript:getData()"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueCallback</span>&lt;String&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceiveValue</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span> || value.equals(<span class="hljs-string">"null"</span>)) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-comment">// 去除首尾引号和转义字符</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> value;
        <span class="hljs-keyword">if</span> (result.startsWith(<span class="hljs-string">"\""</span>) &amp;&amp; result.endsWith(<span class="hljs-string">"\""</span>)) {
            result = result.substring(<span class="hljs-number">1</span>, result.length() - <span class="hljs-number">1</span>);
        }
        result = result.replace(<span class="hljs-string">"\\\""</span>, <span class="hljs-string">"\""</span>).replace(<span class="hljs-string">"\\\\"</span>, <span class="hljs-string">"\\"</span>);
        
        <span class="hljs-comment">// 解析 JSON</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(result);
            Log.d(<span class="hljs-string">"WebView"</span>, <span class="hljs-string">"Result: "</span> + json.toString());
        } <span class="hljs-keyword">catch</span> (JSONException e) {
            Log.d(<span class="hljs-string">"WebView"</span>, <span class="hljs-string">"Result: "</span> + result);
        }
    }
});
</code></pre>
<hr/>
<h3 data-id="heading-11">2.2 loadUrl 方法（兼容低版本）</h3>
<p><strong>原理</strong>：通过加载 <code>javascript:</code> 协议的 URL 来执行 JavaScript 代码。</p>
<p><strong>版本要求</strong>：所有 Android 版本</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 兼容所有 Android 版本</li>
<li>✅ 简单易用</li>
<li>❌ 无法获取返回值</li>
<li>❌ 性能较低</li>
<li>⚠️ 主要用于兼容 Android 4.4 以下版本</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 调用 JavaScript 方法</span>
webView.loadUrl(<span class="hljs-string">"javascript:showMessage('Hello')"</span>);

<span class="hljs-comment">// 传递参数</span>
<span class="hljs-type">String</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>().put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"John"</span>).put(<span class="hljs-string">"age"</span>, <span class="hljs-number">30</span>).toString();
webView.loadUrl(<span class="hljs-string">"javascript:handleData("</span> + params + <span class="hljs-string">")"</span>);
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">showMessage</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-title function_">alert</span>(message);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">params</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received:'</span>, params);
}
</code></pre>
<p><strong>注意事项</strong>：</p>
<ul>
<li>无法获取 JavaScript 的返回值</li>
<li>参数中的特殊字符需要转义</li>
<li>性能比 <code>evaluateJavascript</code> 低</li>
<li>建议在 Android 4.4+ 使用 <code>evaluateJavascript</code></li>
</ul>
<hr/>
<h3 data-id="heading-12">2.3 通过 JavaScript 回调机制</h3>
<p><strong>原理</strong>：Android 调用 JavaScript 时传入回调函数名，JavaScript 执行完成后通过回调通知 Android。</p>
<p><strong>版本要求</strong>：所有 Android 版本（配合 <code>evaluateJavascript</code> 或 <code>loadUrl</code>）</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 可以实现异步通信</li>
<li>✅ 可以获取返回值</li>
<li>✅ 兼容性好</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewCallback</span> {
    <span class="hljs-keyword">private</span> WebView webView;
    <span class="hljs-keyword">private</span> Map&lt;String, ValueCallback&lt;String&gt;&gt; callbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">callbackId</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WebViewCallback</span><span class="hljs-params">(WebView webView)</span> {
        <span class="hljs-built_in">this</span>.webView = webView;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callJS</span><span class="hljs-params">(String method, String params, ValueCallback&lt;String&gt; callback)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">callbackName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"callback_"</span> + (callbackId++);
        callbacks.put(callbackName, callback);
        
        <span class="hljs-type">String</span> <span class="hljs-variable">jsCode</span> <span class="hljs-operator">=</span> String.format(
            <span class="hljs-string">"javascript:%s(%s, function(result) { Android.onJSCallback('%s', result); });"</span>,
            method, params, callbackName
        );
        webView.evaluateJavascript(jsCode, <span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onJSCallback</span><span class="hljs-params">(String callbackName, String result)</span> {
        ValueCallback&lt;String&gt; callback = callbacks.remove(callbackName);
        <span class="hljs-keyword">if</span> (callback != <span class="hljs-literal">null</span>) {
            callback.onReceiveValue(result);
        }
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-type">WebViewCallback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewCallback</span>(webView);
webView.addJavascriptInterface(callback, <span class="hljs-string">"Android"</span>);
callback.callJS(<span class="hljs-string">"getData"</span>, <span class="hljs-string">"null"</span>, result -&gt; Log.d(<span class="hljs-string">"WebView"</span>, <span class="hljs-string">"Result: "</span> + result));
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params">param, callback</span>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">callback</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">result</span>: <span class="hljs-string">'success'</span>, <span class="hljs-attr">data</span>: param }));
    }, <span class="hljs-number">1000</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-13">2.4 通过 JSBridge 库调用</h3>
<p>详见 <a href="#%E4%B8%89jsbridge-%E5%BC%80%E6%BA%90%E5%BA%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F" title="#%E4%B8%89jsbridge-%E5%BC%80%E6%BA%90%E5%BA%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F">三、JSBridge 开源库实现方式</a></p>
<hr/>
<h3 data-id="heading-14">2.5 通过注入 JavaScript 代码</h3>
<p><strong>原理</strong>：在页面加载时注入 JavaScript 代码，建立通信桥梁。</p>
<p><strong>版本要求</strong>：所有 Android 版本</p>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 可以在页面加载前建立通信</li>
<li>✅ 灵活性高</li>
<li>⚠️ 需要处理时机问题</li>
</ul>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">webView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPageFinished</span><span class="hljs-params">(WebView view, String url)</span> {
        <span class="hljs-built_in">super</span>.onPageFinished(view, url);
        <span class="hljs-type">String</span> <span class="hljs-variable">jsCode</span> <span class="hljs-operator">=</span> <span class="hljs-string">"javascript:(function() {"</span> +
            <span class="hljs-string">"window.AndroidBridge = {"</span> +
            <span class="hljs-string">"  onNativeCall: function(callback) { window._nativeCallback = callback; }"</span> +
            <span class="hljs-string">"};"</span> +
            <span class="hljs-string">"})();"</span>;
        view.evaluateJavascript(jsCode, <span class="hljs-literal">null</span>);
    }
});

<span class="hljs-comment">// 调用注入的方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callJSMethod</span><span class="hljs-params">()</span> {
    webView.evaluateJavascript(<span class="hljs-string">"javascript:window._nativeCallback &amp;&amp; window._nativeCallback('Hello')"</span>, <span class="hljs-literal">null</span>);
}
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">AndroidBridge</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">AndroidBridge</span>.<span class="hljs-title function_">onNativeCall</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received: '</span> + message);
        });
    }
});
</code></pre>
<hr/>
<h2 data-id="heading-15">三、JSBridge 开源库实现方式</h2>
<h3 data-id="heading-16">3.1 JsBridge（lzyzsd）</h3>
<p><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flzyzsd%2FJsBridge" target="_blank" title="https://github.com/lzyzsd/JsBridge" ref="nofollow noopener noreferrer">github.com/lzyzsd/JsBr…</a></p>
<p><strong>特点</strong>：</p>
<ul>
<li>受微信 WebView JsBridge 启发</li>
<li>支持双向通信</li>
<li>支持持久回调</li>
<li>提供默认处理器</li>
</ul>
<p><strong>依赖</strong>：</p>
<pre><code class="hljs language-gradle" lang="gradle">implementation 'com.github.lzyzsd:jsbridge:1.0.4'
</code></pre>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BridgeWebView</span> <span class="hljs-variable">webView</span> <span class="hljs-operator">=</span> (BridgeWebView) findViewById(R.id.webview);

<span class="hljs-comment">// 注册处理器（供 JS 调用）</span>
webView.registerHandler(<span class="hljs-string">"submitFromWeb"</span>, (data, function) -&gt; 
    function.onCallBack(<span class="hljs-string">"Response from Android"</span>)
);

<span class="hljs-comment">// 调用 JavaScript 方法</span>
webView.callHandler(<span class="hljs-string">"functionInJs"</span>, <span class="hljs-string">"data"</span>, result -&gt; 
    Log.d(<span class="hljs-string">"Bridge"</span>, <span class="hljs-string">"Result: "</span> + result)
);
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 连接 Bridge</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">connectBridge</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">WebViewJavascriptBridge</span>) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-title class_">WebViewJavascriptBridge</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'WebViewJavascriptBridgeReady'</span>, <span class="hljs-function">() =&gt;</span> 
            <span class="hljs-title function_">callback</span>(<span class="hljs-title class_">WebViewJavascriptBridge</span>)
        );
    }
}

<span class="hljs-title function_">connectBridge</span>(<span class="hljs-function"><span class="hljs-params">bridge</span> =&gt;</span> {
    <span class="hljs-comment">// 注册处理器（供 Android 调用）</span>
    bridge.<span class="hljs-title function_">registerHandler</span>(<span class="hljs-string">"functionInJs"</span>, <span class="hljs-function">(<span class="hljs-params">data, callback</span>) =&gt;</span> 
        <span class="hljs-title function_">callback</span>(<span class="hljs-string">"Response from JS"</span>)
    );
    
    <span class="hljs-comment">// 调用 Android 方法</span>
    bridge.<span class="hljs-title function_">callHandler</span>(<span class="hljs-string">'submitFromWeb'</span>, {<span class="hljs-attr">param</span>: <span class="hljs-string">'value'</span>}, <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> 
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Response: '</span> + response)
    );
});
</code></pre>
<hr/>
<h3 data-id="heading-17">3.2 DSBridge</h3>
<p><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwendux%2FDSBridge-Android" target="_blank" title="https://github.com/wendux/DSBridge-Android" ref="nofollow noopener noreferrer">github.com/wendux/DSBr…</a></p>
<p><strong>特点</strong>：</p>
<ul>
<li>跨平台支持（iOS + Android）</li>
<li>支持同步和异步调用</li>
<li>支持进度回调（一次调用，多次返回）</li>
<li>支持腾讯 X5 内核</li>
<li>支持 API 命名空间</li>
<li>支持调试模式</li>
</ul>
<p><strong>依赖</strong>：</p>
<pre><code class="hljs language-gradle" lang="gradle">implementation 'com.github.wendux:DSBridge-Android:3.0.0'
</code></pre>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义 API 类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsApi</span> {
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testSyn</span><span class="hljs-params">(Object msg)</span> {
        <span class="hljs-keyword">return</span> msg + <span class="hljs-string">" [syn]"</span>;
    }
    
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAsyn</span><span class="hljs-params">(Object msg, CompletionHandler&lt;String&gt; handler)</span> {
        handler.complete(msg + <span class="hljs-string">" [asyn]"</span>);
    }
}

<span class="hljs-comment">// 添加到 WebView</span>
<span class="hljs-type">DWebView</span> <span class="hljs-variable">dWebView</span> <span class="hljs-operator">=</span> (DWebView) webView;
dWebView.addJavascriptObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsApi</span>(), <span class="hljs-string">"nativeApi"</span>);

<span class="hljs-comment">// 调用 JavaScript 方法</span>
dWebView.callHandler(<span class="hljs-string">"test.method"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-string">"hello"</span>}, retValue -&gt; 
    Log.d(<span class="hljs-string">"DSBridge"</span>, <span class="hljs-string">"Result: "</span> + retValue)
);
</code></pre>
<p><strong>JavaScript 端代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同步调用</span>
<span class="hljs-keyword">var</span> result = dsBridge.<span class="hljs-title function_">call</span>(<span class="hljs-string">"nativeApi.testSyn"</span>, <span class="hljs-string">"test"</span>);

<span class="hljs-comment">// 异步调用</span>
dsBridge.<span class="hljs-title function_">call</span>(<span class="hljs-string">"nativeApi.testAsyn"</span>, <span class="hljs-string">"test"</span>, <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val));

<span class="hljs-comment">// 注册方法供 Android 调用</span>
dsBridge.<span class="hljs-title function_">register</span>(<span class="hljs-string">"test.method"</span>, <span class="hljs-function">(<span class="hljs-params">arg, callback</span>) =&gt;</span> <span class="hljs-title function_">callback</span>(<span class="hljs-string">"result from js"</span>));
</code></pre>
<hr/>
<h3 data-id="heading-18">3.3 SafeWebViewBridge</h3>
<p><strong>特点</strong>：专注于安全性的 WebView Bridge</p>
<p><strong>使用场景</strong>：对安全性要求较高的应用</p>
<hr/>
<h3 data-id="heading-19">3.4 WebViewJavascriptBridge（iOS 风格）</h3>
<p><strong>特点</strong>：模仿 iOS 的 WebViewJavascriptBridge 实现</p>
<p><strong>使用场景</strong>：需要 iOS/Android 统一接口的项目</p>
<hr/>
<h3 data-id="heading-20">3.5 X5 WebView Bridge</h3>
<p><strong>特点</strong>：基于腾讯 X5 内核的 Bridge 实现</p>
<p><strong>使用场景</strong>：使用腾讯 X5 内核的项目</p>
<p><strong>Android 端代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">com.tencent.smtt.sdk.<span class="hljs-type">WebView</span> <span class="hljs-variable">x5WebView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.tencent.smtt.sdk.WebView(context);
x5WebView.addJavascriptInterface(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JSInterface</span>(), <span class="hljs-string">"Android"</span>);
</code></pre>
<hr/>
<h2 data-id="heading-21">四、安全性与最佳实践</h2>
<h3 data-id="heading-22">4.1 安全风险</h3>
<h4 data-id="heading-23">4.1.1 addJavascriptInterface 安全风险</h4>
<ul>
<li><strong>问题</strong>：Android 4.2 之前存在漏洞，恶意 JavaScript 可能执行任意代码</li>
<li><strong>解决方案</strong>：
<ul>
<li>使用 <code>@JavascriptInterface</code> 注解（Android 4.2+）</li>
<li>验证所有来自 JavaScript 的参数</li>
<li>限制暴露的方法和权限</li>
</ul>
</li>
</ul>
<h4 data-id="heading-24">4.1.2 URL Scheme 安全风险</h4>
<ul>
<li><strong>问题</strong>：可能被恶意应用拦截</li>
<li><strong>解决方案</strong>：
<ul>
<li>验证 URL 来源</li>
<li>使用 HTTPS</li>
<li>添加签名验证</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">4.1.3 XSS 攻击风险</h4>
<ul>
<li><strong>问题</strong>：注入恶意 JavaScript</li>
<li><strong>解决方案</strong>：
<ul>
<li>内容安全策略（CSP）</li>
<li>输入验证和转义</li>
<li>白名单机制</li>
</ul>
</li>
</ul>
<h3 data-id="heading-26">4.2 最佳实践</h3>
<h4 data-id="heading-27">4.2.1 WebView 安全配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">WebSettings</span> <span class="hljs-variable">settings</span> <span class="hljs-operator">=</span> webView.getSettings();
settings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

<span class="hljs-comment">// 安全配置</span>
settings.setAllowFileAccess(<span class="hljs-literal">false</span>);                    <span class="hljs-comment">// 禁止文件访问</span>
settings.setAllowContentAccess(<span class="hljs-literal">false</span>);                 <span class="hljs-comment">// 禁止内容访问</span>
settings.setAllowFileAccessFromFileURLs(<span class="hljs-literal">false</span>);        <span class="hljs-comment">// 禁止从文件 URL 访问</span>
settings.setAllowUniversalAccessFromFileURLs(<span class="hljs-literal">false</span>);   <span class="hljs-comment">// 禁止通用文件访问</span>
settings.setMixedContentMode(WebSettings.MIXED_CONTENT_NEVER_ALWAYS); <span class="hljs-comment">// 禁止混合内容</span>

<span class="hljs-comment">// 使用 HTTPS</span>
webView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceivedSslError</span><span class="hljs-params">(WebView view, SslErrorHandler handler, SslError error)</span> {
        <span class="hljs-comment">// 生产环境应该验证证书</span>
        handler.proceed(); <span class="hljs-comment">// 仅用于开发环境</span>
    }
});
</code></pre>
<h4 data-id="heading-28">4.2.2 参数验证</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@JavascriptInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showToast</span><span class="hljs-params">(String message)</span> {
    <span class="hljs-comment">// 验证参数</span>
    <span class="hljs-keyword">if</span> (message == <span class="hljs-literal">null</span> || message.length() &gt; <span class="hljs-number">100</span>) {
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 防止 XSS</span>
    message = message.replace(<span class="hljs-string">"&lt;"</span>, <span class="hljs-string">"&amp;lt;"</span>)
                     .replace(<span class="hljs-string">"&gt;"</span>, <span class="hljs-string">"&amp;gt;"</span>)
                     .replace(<span class="hljs-string">"\""</span>, <span class="hljs-string">"&amp;quot;"</span>)
                     .replace(<span class="hljs-string">"'"</span>, <span class="hljs-string">"&amp;#x27;"</span>);
    
    Toast.makeText(context, message, Toast.LENGTH_SHORT).show();
}
</code></pre>
<h4 data-id="heading-29">4.2.3 权限控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JSInterface</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; ALLOWED_METHODS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;() {{
        add(<span class="hljs-string">"showToast"</span>);
        add(<span class="hljs-string">"getDeviceInfo"</span>);
    }};
    
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showToast</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-comment">// 检查权限</span>
        <span class="hljs-keyword">if</span> (!hasPermission(<span class="hljs-string">"showToast"</span>)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 执行操作</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(String method)</span> {
        <span class="hljs-keyword">return</span> ALLOWED_METHODS.contains(method);
    }
}
</code></pre>
<h4 data-id="heading-30">4.2.4 使用成熟的 Bridge 库</h4>
<ul>
<li>避免自己实现，使用经过验证的库</li>
<li>定期更新依赖</li>
<li>关注安全公告</li>
</ul>
<h4 data-id="heading-31">4.2.5 版本兼容性处理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查 Android 版本</span>
<span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) {
    <span class="hljs-comment">// 使用 evaluateJavascript</span>
    webView.evaluateJavascript(jsCode, callback);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 使用 loadUrl</span>
    webView.loadUrl(jsCode);
}

<span class="hljs-comment">// 检查 @JavascriptInterface 支持</span>
<span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) {
    <span class="hljs-comment">// 使用 @JavascriptInterface</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 使用其他方式</span>
}
</code></pre>
<h4 data-id="heading-32">4.2.6 错误处理</h4>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@JavascriptInterface</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleRequest</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> json = JSONObject(<span class="hljs-keyword">data</span>)
        <span class="hljs-comment">// 处理请求</span>
    } <span class="hljs-keyword">catch</span> (e: JSONException) {
        Log.e(TAG, <span class="hljs-string">"Invalid JSON"</span>, e)
        <span class="hljs-comment">// 返回错误信息</span>
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Log.e(TAG, <span class="hljs-string">"Error handling request"</span>, e)
        <span class="hljs-comment">// 错误处理</span>
    }
}
</code></pre>
<h4 data-id="heading-33">4.2.7 统一错误处理框架</h4>
<p><strong>原理</strong>：统一的错误处理可以提升代码可维护性，便于错误追踪和上报。</p>
<p><strong>依赖说明</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.util.Log
<span class="hljs-keyword">import</span> org.json.JSONObject
</code></pre>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 统一错误处理框架
 */</span>
<span class="hljs-keyword">object</span> ErrorHandler {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> errorReporter: ((ErrorInfo) -&gt; <span class="hljs-built_in">Unit</span>)? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorInfo</span>(
        <span class="hljs-keyword">val</span> type: ErrorType,
        <span class="hljs-keyword">val</span> message: String,
        <span class="hljs-keyword">val</span> stackTrace: String? = <span class="hljs-literal">null</span>,
        <span class="hljs-keyword">val</span> context: Map&lt;String, Any&gt;? = <span class="hljs-literal">null</span>
    )
    
    <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorType</span> {
        JS_ERROR,      <span class="hljs-comment">// JavaScript 错误</span>
        BRIDGE_ERROR,  <span class="hljs-comment">// Bridge 调用错误</span>
        NETWORK_ERROR, <span class="hljs-comment">// 网络错误</span>
        CACHE_ERROR,   <span class="hljs-comment">// 缓存错误</span>
        UNKNOWN_ERROR  <span class="hljs-comment">// 未知错误</span>
    }
    
    <span class="hljs-comment">/**
     * 设置错误上报器
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setErrorReporter</span><span class="hljs-params">(reporter: (<span class="hljs-type">ErrorInfo</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        errorReporter = reporter
    }
    
    <span class="hljs-comment">/**
     * 处理错误
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleError</span><span class="hljs-params">(
        type: <span class="hljs-type">ErrorType</span>,
        message: <span class="hljs-type">String</span>,
        throwable: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>,
        context: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, Any&gt;? = <span class="hljs-literal">null</span>
    )</span></span> {
        <span class="hljs-keyword">val</span> errorInfo = ErrorInfo(
            type = type,
            message = message,
            stackTrace = throwable?.stackTraceToString(),
            context = context
        )
        
        <span class="hljs-comment">// 记录日志</span>
        Log.e(<span class="hljs-string">"ErrorHandler"</span>, <span class="hljs-string">"[<span class="hljs-subst">${type.name}</span>] <span class="hljs-variable">$message</span>"</span>, throwable)
        
        <span class="hljs-comment">// 上报错误</span>
        errorReporter?.invoke(errorInfo)
    }
    
    <span class="hljs-comment">/**
     * 处理 JavaScript 错误
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleJSError</span><span class="hljs-params">(message: <span class="hljs-type">String</span>, stackTrace: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>)</span></span> {
        handleError(
            ErrorType.JS_ERROR,
            message,
            context = mapOf(<span class="hljs-string">"stackTrace"</span> to (stackTrace ?: <span class="hljs-string">""</span>))
        )
    }
    
    <span class="hljs-comment">/**
     * 处理 Bridge 调用错误
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleBridgeError</span><span class="hljs-params">(method: <span class="hljs-type">String</span>, error: <span class="hljs-type">Throwable</span>)</span></span> {
        handleError(
            ErrorType.BRIDGE_ERROR,
            <span class="hljs-string">"Bridge call failed: <span class="hljs-variable">$method</span>"</span>,
            error,
            mapOf(<span class="hljs-string">"method"</span> to method)
        )
    }
}

<span class="hljs-comment">// 在 JSInterface 中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JSInterface</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onJSError</span><span class="hljs-params">(errorInfo: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> json = JSONObject(errorInfo)
            ErrorHandler.handleJSError(
                json.optString(<span class="hljs-string">"message"</span>, <span class="hljs-string">""</span>),
                json.optString(<span class="hljs-string">"stack"</span>, <span class="hljs-literal">null</span>)
            )
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            ErrorHandler.handleError(ErrorType.JS_ERROR, <span class="hljs-string">"Failed to parse JS error"</span>, e)
        }
    }
    
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">callNative</span><span class="hljs-params">(method: <span class="hljs-type">String</span>, params: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 处理调用</span>
            handleNativeCall(method, params)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            ErrorHandler.handleBridgeError(method, e)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleNativeCall</span><span class="hljs-params">(method: <span class="hljs-type">String</span>, params: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// 实现调用逻辑</span>
    }
}

<span class="hljs-comment">// 配置错误上报</span>
ErrorHandler.setErrorReporter { errorInfo -&gt;
    <span class="hljs-comment">// 上报到服务器</span>
    <span class="hljs-comment">// uploadErrorToServer(errorInfo)</span>
}
</code></pre>
<h4 data-id="heading-34">4.2.8 性能优化</h4>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. WebView 复用</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webViewPool = WebViewPool(context)

<span class="hljs-comment">// 2. 硬件加速</span>
webView.setLayerType(View.LAYER_TYPE_HARDWARE, <span class="hljs-literal">null</span>)

<span class="hljs-comment">// 3. 减少通信频率（批量处理）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> batchExecutor = BatchJSExecutor(webView)

<span class="hljs-comment">// 使用批量执行器</span>
batchExecutor.addCall(<span class="hljs-string">"console.log('1')"</span>)
batchExecutor.addCall(<span class="hljs-string">"console.log('2')"</span>)
<span class="hljs-comment">// 100ms 后自动批量执行</span>
</code></pre>
<hr/>
<h2 data-id="heading-35">五、常见问题与解决方案</h2>
<h3 data-id="heading-36">5.1 WebView 内存泄漏问题</h3>
<p><strong>问题</strong>：WebView 可能导致 Activity 内存泄漏。</p>
<p><strong>原因</strong>：</p>
<ul>
<li>WebView 持有 Activity 的 Context 引用</li>
<li>WebView 在后台线程中执行，生命周期与 Activity 不一致</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webView: WebView? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// 使用 ApplicationContext 创建 WebView（如果可能）</span>
        webView = WebView(applicationContext)
        setContentView(webView)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 重要：在 onDestroy 中清理 WebView</span>
        webView?.let {
            <span class="hljs-keyword">try</span> {
                it.loadDataWithBaseURL(<span class="hljs-literal">null</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, <span class="hljs-literal">null</span>)
                it.clearHistory()
                it.clearCache(<span class="hljs-literal">true</span>)
                it.onPause()
                it.removeAllViews()
                it.destroy()
                webView = <span class="hljs-literal">null</span>
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
                ErrorHandler.handleError(
                    ErrorHandler.ErrorType.UNKNOWN_ERROR,
                    <span class="hljs-string">"Failed to destroy WebView"</span>,
                    e
                )
            }
        }
        <span class="hljs-keyword">super</span>.onDestroy()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPause</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onPause()
        webView?.onPause()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResume</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onResume()
        webView?.onResume()
    }
}
</code></pre>
<h3 data-id="heading-37">5.2 WebView 未加载完成就调用 JavaScript</h3>
<p><strong>问题</strong>：在页面加载完成前调用 JavaScript 会失败。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> isPageFinished = <span class="hljs-literal">false</span>

webView.webViewClient = <span class="hljs-keyword">object</span> : WebViewClient() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageFinished</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onPageFinished(view, url)
        isPageFinished = <span class="hljs-literal">true</span>
        <span class="hljs-comment">// 页面加载完成后可以安全调用 JavaScript</span>
        callJavaScriptSafely()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageStarted</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?, favicon: <span class="hljs-type">Bitmap</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onPageStarted(view, url, favicon)
        isPageFinished = <span class="hljs-literal">false</span>
    }
}

<span class="hljs-comment">// 安全调用 JavaScript 的方法</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">callJavaScriptSafely</span><span class="hljs-params">()</span></span> {
    webView?.let {
        <span class="hljs-comment">// 方式1：延迟调用，确保页面完全加载</span>
        it.postDelayed({
            <span class="hljs-comment">// 使用统一的扩展函数</span>
            it.evaluateJavaScriptSafe(<span class="hljs-string">"javascript:init()"</span>)
        }, <span class="hljs-number">500</span>)
        
        <span class="hljs-comment">// 方式2：在 onPageFinished 中直接调用</span>
    }
}
</code></pre>
<h3 data-id="heading-38">5.3 evaluateJavascript 返回值格式问题</h3>
<p><strong>问题</strong>：返回值包含引号和转义字符，解析困难。</p>
<p><strong>解决方案</strong>：使用 <code>JSResultParser</code> 工具类解析返回值</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用统一的工具类解析返回值</span>
webView.evaluateJavaScriptSafe(<span class="hljs-string">"javascript:getData()"</span>) { value -&gt;
    <span class="hljs-comment">// 使用 JSResultParser 解析</span>
    <span class="hljs-keyword">val</span> cleaned = JSResultParser.parseResult(value)
    <span class="hljs-keyword">val</span> json = JSResultParser.parseAsJson(value)
    <span class="hljs-comment">// 使用解析后的数据</span>
}
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li>推荐使用 <code>evaluateJavaScriptSafe()</code> 扩展函数替代直接调用 <code>evaluateJavascript()</code></li>
<li>返回值解析统一使用 <code>JSResultParser</code>，避免重复实现解析逻辑</li>
</ul>
<h3 data-id="heading-39">5.4 特殊字符转义问题</h3>
<p><strong>问题</strong>：传递包含特殊字符的参数时，JavaScript 执行失败。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> JSEscapeUtils {
    <span class="hljs-comment">/**
     * 转义 JavaScript 字符串中的特殊字符
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">escapeJS</span><span class="hljs-params">(input: <span class="hljs-type">String</span>?)</span></span>: String {
        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"null"</span>
        
        <span class="hljs-keyword">return</span> input.replace(<span class="hljs-string">"\\"</span>, <span class="hljs-string">"\\\\"</span>)
                   .replace(<span class="hljs-string">"'"</span>, <span class="hljs-string">"\\'"</span>)
                   .replace(<span class="hljs-string">"\""</span>, <span class="hljs-string">"\\\""</span>)
                   .replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">"\\n"</span>)
                   .replace(<span class="hljs-string">"\r"</span>, <span class="hljs-string">"\\r"</span>)
                   .replace(<span class="hljs-string">"\t"</span>, <span class="hljs-string">"\\t"</span>)
                   .replace(<span class="hljs-string">"/"</span>, <span class="hljs-string">"\\/"</span>)
    }
    
    <span class="hljs-comment">/**
     * 安全地调用 JavaScript（推荐使用 JSON 传递参数）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">callJSSafely</span><span class="hljs-params">(webView: <span class="hljs-type">WebView</span>, functionName: <span class="hljs-type">String</span>, params: <span class="hljs-type">Any</span>? = <span class="hljs-literal">null</span>)</span></span> {
        <span class="hljs-keyword">val</span> jsCode = <span class="hljs-keyword">if</span> (params == <span class="hljs-literal">null</span>) {
            <span class="hljs-string">"javascript:<span class="hljs-variable">$functionName</span>()"</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 使用 JSON 传递参数，避免转义问题</span>
            <span class="hljs-keyword">val</span> jsonParams = JSONObject().put(<span class="hljs-string">"data"</span>, params).toString()
            <span class="hljs-string">"javascript:<span class="hljs-variable">$functionName</span>(<span class="hljs-variable">$jsonParams</span>)"</span>
        }
        
        <span class="hljs-comment">// 使用统一的扩展函数</span>
        webView.evaluateJavaScriptSafe(jsCode)
        <span class="hljs-comment">// 注意：低版本无法获取返回值，如需返回值请使用 WebViewBridgeKt</span>
    }
}
</code></pre>
<h3 data-id="heading-40">5.5 线程安全问题</h3>
<p><strong>问题</strong>：在非主线程中调用 WebView 方法会导致崩溃。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> WebViewUtils {
    <span class="hljs-comment">/**
     * 在主线程中安全调用 WebView 方法
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">callOnMainThread</span><span class="hljs-params">(webView: <span class="hljs-type">WebView</span>, runnable: <span class="hljs-type">Runnable</span>)</span></span> {
        <span class="hljs-keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) {
            <span class="hljs-comment">// 已经在主线程</span>
            runnable.run()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 切换到主线程</span>
            Handler(Looper.getMainLooper()).post(runnable)
        }
    }
    
    <span class="hljs-comment">/**
     * 安全调用 JavaScript
     * 注意：推荐使用扩展函数 evaluateJavaScriptSafe()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">evaluateJavaScript</span><span class="hljs-params">(
        webView: <span class="hljs-type">WebView</span>, 
        jsCode: <span class="hljs-type">String</span>, 
        callback: ((<span class="hljs-type">String</span>?) -&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>
    )</span></span> {
        callOnMainThread(webView, Runnable {
            <span class="hljs-comment">// 使用统一的扩展函数</span>
            webView.evaluateJavaScriptSafe(jsCode, callback)
        })
    }
}
</code></pre>
<h3 data-id="heading-41">5.6 WebView 缓存问题</h3>
<p><strong>问题</strong>：WebView 缓存导致页面不更新。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用统一的配置扩展函数</span>
<span class="hljs-comment">// 开发环境：不使用缓存</span>
<span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
    webView.setupDefaultSettings(enableCache = <span class="hljs-literal">false</span>)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 生产环境：使用缓存</span>
    webView.setupDefaultSettings(enableCache = <span class="hljs-literal">true</span>)
}

<span class="hljs-comment">// 清除缓存（需要时调用）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearWebViewCache</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">try</span> {
        webView.clearCache(<span class="hljs-literal">true</span>)
        webView.clearHistory()
        CookieManager.getInstance().apply {
            removeAllCookies(<span class="hljs-literal">null</span>)
            flush()
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
        ErrorHandler.handleError(
            ErrorHandler.ErrorType.CACHE_ERROR,
            <span class="hljs-string">"Failed to clear WebView cache"</span>,
            e
        )
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-42">六、实际开发中的坑</h2>
<h3 data-id="heading-43">6.1 addJavascriptInterface 方法名冲突</h3>
<p><strong>坑</strong>：如果 JavaScript 中已有同名对象，会导致冲突。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用唯一的前缀</span>
webView.addJavascriptInterface(JSInterface(), <span class="hljs-string">"MyAppAndroid"</span>)

<span class="hljs-comment">// 或者检查 JavaScript 中是否已存在</span>
<span class="hljs-keyword">val</span> checkCode = <span class="hljs-string">"""
    if (typeof Android !== 'undefined') {
        window.MyAppAndroid = Android;
    }
"""</span>.trimIndent()
<span class="hljs-comment">// 使用统一的扩展函数</span>
webView.evaluateJavaScriptSafe(checkCode)
</code></pre>
<h3 data-id="heading-44">6.2 异步回调时序问题</h3>
<p><strong>坑</strong>：JavaScript 异步操作完成时，Android 端可能已经销毁。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JSInterface</span>(context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> contextRef = WeakReference(context)
    
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleAsyncResult</span><span class="hljs-params">(result: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> context = contextRef.<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// Context 已被回收，忽略回调</span>
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 使用弱引用避免内存泄漏</span>
        <span class="hljs-comment">// 处理结果</span>
    }
}
</code></pre>
<h3 data-id="heading-45">6.3 URL Scheme 被其他应用拦截</h3>
<p><strong>坑</strong>：自定义 URL Scheme 可能被其他应用拦截。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldOverrideUrlLoading</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">if</span> (url?.startsWith(<span class="hljs-string">"myapp://"</span>) == <span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 验证 URL 来源</span>
        <span class="hljs-keyword">if</span> (isValidUrl(url)) {
            handleCustomUrl(url)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isValidUrl</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-comment">// 添加签名验证</span>
    <span class="hljs-keyword">val</span> uri = Uri.parse(url)
    <span class="hljs-keyword">val</span> signature = uri.getQueryParameter(<span class="hljs-string">"sig"</span>)
    <span class="hljs-comment">// 验证签名</span>
    <span class="hljs-keyword">return</span> verifySignature(url, signature)
}
</code></pre>
<h3 data-id="heading-46">6.4 evaluateJavascript 在低版本返回 null</h3>
<p><strong>坑</strong>：Android 4.4 以下版本不支持 evaluateJavascript，需要使用 loadUrl。</p>
<p><strong>解决方案</strong>：使用统一的扩展函数 <code>evaluateJavaScriptSafe()</code>，自动处理版本兼容性。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用统一的扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">callJS</span><span class="hljs-params">(webView: <span class="hljs-type">WebView</span>, jsCode: <span class="hljs-type">String</span>, callback: ((<span class="hljs-type">String</span>?) -&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>)</span></span> {
    webView.evaluateJavaScriptSafe(jsCode, callback)
    <span class="hljs-comment">// 注意：低版本无法获取返回值，callback 不会执行</span>
    <span class="hljs-comment">// 如需返回值，请使用 WebViewBridgeKt</span>
}
</code></pre>
<h3 data-id="heading-47">6.5 WebView 在 Fragment 中的生命周期问题</h3>
<p><strong>坑</strong>：Fragment 生命周期与 WebView 不一致，可能导致崩溃。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewFragment</span> : <span class="hljs-type">Fragment</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webView: WebView? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isWebViewAvailable = <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>, 
        container: <span class="hljs-type">ViewGroup</span>?, 
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View? {
        webView = WebView(requireContext())
        isWebViewAvailable = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">return</span> webView
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        isWebViewAvailable = <span class="hljs-literal">false</span>
        webView?.destroy()
        webView = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">super</span>.onDestroyView()
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">callJavaScript</span><span class="hljs-params">(code: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">if</span> (isWebViewAvailable &amp;&amp; webView != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 使用统一的扩展函数</span>
            webView?.evaluateJavaScriptSafe(code)
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-48">七、版本兼容性对照表</h2>





















































<table><thead><tr><th>Android 版本</th><th>API Level</th><th>关键特性</th><th>注意事项</th></tr></thead><tbody><tr><td>Android 4.1</td><td>16</td><td><code>addJavascriptInterface</code> 存在安全漏洞</td><td>必须使用 URL Scheme 或其他方式</td></tr><tr><td>Android 4.2</td><td>17</td><td><code>@JavascriptInterface</code> 注解必需</td><td>必须添加注解才能使用</td></tr><tr><td>Android 4.4</td><td>19</td><td><code>evaluateJavascript</code> 可用</td><td>推荐使用，支持返回值</td></tr><tr><td>Android 5.0</td><td>21</td><td><code>shouldOverrideUrlLoading</code> 方法变更</td><td>需要重写新方法</td></tr><tr><td>Android 6.0</td><td>23</td><td><code>postMessage</code> 支持</td><td>官方推荐的安全通信方式</td></tr><tr><td>Android 7.0</td><td>24</td><td>文件访问限制更严格</td><td>注意文件访问权限</td></tr><tr><td>Android 8.0</td><td>26</td><td>WebView 多进程支持</td><td>注意进程间通信</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-49">八、性能优化建议</h2>
<h3 data-id="heading-50">8.1 资源预加载策略</h3>
<p><strong>WebView 池（预加载优化基础）</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewPool</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> pool = mutableListOf&lt;WebView&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxSize = <span class="hljs-number">3</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">obtain</span><span class="hljs-params">()</span></span>: WebView {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (pool.isNotEmpty()) {
            pool.removeAt(<span class="hljs-number">0</span>)
        } <span class="hljs-keyword">else</span> {
            WebView(context.applicationContext).apply {
                setupDefaultSettings()
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recycle</span><span class="hljs-params">(webView: <span class="hljs-type">WebView</span>)</span></span> {
        <span class="hljs-keyword">if</span> (pool.size &lt; maxSize) {
            webView.loadDataWithBaseURL(<span class="hljs-literal">null</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, <span class="hljs-literal">null</span>)
            pool.add(webView)
        } <span class="hljs-keyword">else</span> {
            webView.destroy()
        }
    }
}
</code></pre>
<h4 data-id="heading-51">8.1.1 页面预加载</h4>
<p><strong>原理</strong>：在用户访问前提前加载常用页面，提升用户体验。使用 WebView 池中的实例进行预加载，避免重复创建。</p>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewPreloader</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webViewPool: WebViewPool
) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> preloadWebView: WebView <span class="hljs-keyword">by</span> lazy { webViewPool.obtain() }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preloadPage</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> = preloadWebView.loadUrl(url)
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preloadPages</span><span class="hljs-params">(urls: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> = urls.forEach { preloadPage(it) }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cleanup</span><span class="hljs-params">()</span></span> = webViewPool.recycle(preloadWebView)
}
</code></pre>
<h4 data-id="heading-52">8.1.2 静态资源预加载</h4>
<p><strong>原理</strong>：提前加载 CSS、JavaScript、图片等静态资源。使用 WebView 池中的实例，避免为预加载创建额外的 WebView。</p>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourcePreloader</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webViewPool: WebViewPool
) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> preloadWebView: WebView <span class="hljs-keyword">by</span> lazy { webViewPool.obtain() }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preloadResource</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> html = <span class="hljs-keyword">when</span> {
            url.endsWith(<span class="hljs-string">".js"</span>) -&gt; <span class="hljs-string">"&lt;html&gt;&lt;head&gt;&lt;script src=\"<span class="hljs-variable">$url</span>\"&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;"</span>
            url.endsWith(<span class="hljs-string">".css"</span>) -&gt; <span class="hljs-string">"&lt;html&gt;&lt;head&gt;&lt;link rel=\"stylesheet\" href=\"<span class="hljs-variable">$url</span>\"&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;"</span>
            url.matches(Regex(<span class="hljs-string">".*\\.(jpg|jpeg|png|gif|webp)$"</span>, RegexOption.IGNORE_CASE)) -&gt; 
                <span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;img src=\"<span class="hljs-variable">$url</span>\" style=\"display:none;\"&gt;&lt;/body&gt;&lt;/html&gt;"</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">return</span>
        }
        preloadWebView.loadDataWithBaseURL(<span class="hljs-literal">null</span>, html, <span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, <span class="hljs-literal">null</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cleanup</span><span class="hljs-params">()</span></span> = webViewPool.recycle(preloadWebView)
}
</code></pre>
<h4 data-id="heading-53">8.1.3 预加载时机控制</h4>
<p><strong>原理</strong>：选择合适的时机进行预加载，避免影响应用启动速度和用户体验。</p>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PreloadManager</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webViewPool = WebViewPool(context)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> preloader = WebViewPreloader(webViewPool)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handler = Handler(Looper.getMainLooper())
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preloadOnAppStart</span><span class="hljs-params">()</span></span> {
        handler.postDelayed({
            preloader.preloadPages(listOf(<span class="hljs-string">"https://example.com/home"</span>, <span class="hljs-string">"https://example.com/about"</span>))
        }, <span class="hljs-number">3000</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preloadAfterPageLoad</span><span class="hljs-params">(currentUrl: <span class="hljs-type">String</span>)</span></span> {
        handler.postDelayed({
            <span class="hljs-keyword">val</span> nextUrls = <span class="hljs-keyword">when</span> {
                currentUrl.contains(<span class="hljs-string">"/home"</span>) -&gt; listOf(<span class="hljs-string">"https://example.com/products"</span>)
                currentUrl.contains(<span class="hljs-string">"/products"</span>) -&gt; listOf(<span class="hljs-string">"https://example.com/product/detail"</span>)
                <span class="hljs-keyword">else</span> -&gt; emptyList()
            }
            preloader.preloadPages(nextUrls)
        }, <span class="hljs-number">1000</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cleanup</span><span class="hljs-params">()</span></span> = preloader.cleanup()
}
</code></pre>
<h3 data-id="heading-54">8.2 离线缓存策略</h3>
<h4 data-id="heading-55">8.2.1 WebView 缓存工作原理</h4>
<p><strong>一、WebView 缓存的核心机制</strong></p>
<p>WebView 的缓存基于 <strong>HTTP 缓存协议</strong>，这是 Web 标准缓存机制，由 WebView 内核自动管理。</p>
<p><strong>缓存存储位置</strong>：</p>
<ul>
<li>Android 路径：<code>/data/data/包名/cache/webviewCache/</code></li>
<li>存储内容：HTML、CSS、JavaScript、图片等所有网络资源</li>
<li>存储方式：文件系统，按 URL 和缓存策略组织</li>
</ul>
<p><strong>二、HTTP 缓存的工作原理</strong></p>
<p><strong>1. 缓存判断流程</strong></p>
<pre><code class="hljs language-sql" lang="sql">用户请求资源（如 https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>example.com<span class="hljs-operator">/</span>page.html）
    ↓
WebView 检查本地缓存目录
    ↓
缓存是否存在？
    ├─ 不存在 → 直接请求网络 → 保存响应到缓存 → 返回给 WebView
    └─ 存在 → 检查缓存是否过期
         ├─ 未过期 → 直接返回缓存（不请求网络，<span class="hljs-number">200</span> <span class="hljs-keyword">from</span> cache）
         └─ 已过期 → 发送条件请求（If<span class="hljs-operator">-</span><span class="hljs-keyword">None</span><span class="hljs-operator">-</span><span class="hljs-keyword">Match</span> <span class="hljs-operator">/</span> If<span class="hljs-operator">-</span>Modified<span class="hljs-operator">-</span>Since）
              ├─ 服务器返回 <span class="hljs-number">304</span> → 使用缓存（更新过期时间）
              └─ 服务器返回 <span class="hljs-number">200</span> → 更新缓存（新内容）
</code></pre>
<p><strong>2. 缓存过期判断</strong></p>
<p>WebView 根据 HTTP 响应头判断缓存是否过期：</p>
<ul>
<li>
<p><strong>Cache-Control: max-age=3600</strong></p>
<ul>
<li>缓存有效期 3600 秒（1小时）</li>
<li>计算：<code>当前时间 - 缓存时间 &lt; max-age</code> → 未过期</li>
</ul>
</li>
<li>
<p><strong>Expires: Wed, 21 Oct 2024 08:00:00 GMT</strong></p>
<ul>
<li>绝对过期时间</li>
<li>计算：<code>当前时间 &lt; Expires 时间</code> → 未过期</li>
</ul>
</li>
</ul>
<p><strong>3. 条件请求机制（验证缓存有效性）</strong></p>
<p>当缓存过期时，WebView 不会直接使用，而是发送条件请求验证：</p>
<pre><code class="hljs language-less" lang="less">缓存已过期
    ↓
发送请求，携带条件头：
  If-<span class="hljs-attribute">None-Match</span>: <span class="hljs-string">"abc123"</span>        <span class="hljs-comment">// ETag 值</span>
  <span class="hljs-attribute">If-Modified-Since</span>: Wed, <span class="hljs-number">21</span> Oct <span class="hljs-number">2024</span> <span class="hljs-number">07</span>:<span class="hljs-number">28</span>:<span class="hljs-number">00</span> GMT
    ↓
服务器检查资源是否变化
    ├─ 未变化 → 返回 <span class="hljs-number">304</span> <span class="hljs-keyword">Not</span> Modified → WebView 使用缓存（更新过期时间）
    └─ 已变化 → 返回 <span class="hljs-number">200</span> + 新内容 → WebView 更新缓存
</code></pre>
<p><strong>优点</strong>：节省带宽，即使缓存过期，如果内容未变，仍可使用缓存。</p>
<p><strong>三、WebView 缓存模式详解</strong></p>
<p>WebView 提供 4 种缓存模式（通过 <code>webView.settings.cacheMode</code> 设置）：</p>
<p><strong>1. LOAD_DEFAULT（默认模式，推荐）</strong></p>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请求资源
<span class="hljs-code">    ↓
检查 HTTP 缓存头（Cache-Control、Expires）
    ↓
有缓存头且有效？ → 是 → 使用缓存（不请求网络）
    ↓ 否
请求网络 → 保存到缓存 → 返回给 WebView
</span></code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>大多数 Web 应用</li>
<li>服务器正确设置了缓存头的情况</li>
<li>需要平衡性能和实时性的场景</li>
</ul>
<p><strong>2. LOAD_CACHE_ELSE_NETWORK（缓存优先）</strong></p>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请求资源
<span class="hljs-code">    ↓
检查本地缓存
    ↓
有缓存？ → 是 → 直接使用缓存（即使过期也不请求网络）
    ↓ 否
请求网络 → 保存到缓存 → 返回给 WebView
</span></code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>离线优先的应用（新闻阅读、文档查看）</li>
<li>网络不稳定时仍可查看历史内容</li>
<li>内容更新不频繁的场景</li>
</ul>
<p><strong>注意</strong>：即使缓存过期也会使用，可能导致显示旧内容。</p>
<p><strong>3. LOAD_NO_CACHE（不使用缓存）</strong></p>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请求资源
<span class="hljs-code">    ↓
忽略所有缓存
    ↓
直接请求网络 → 不保存到缓存 → 返回给 WebView
</span></code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要实时数据的页面（股票行情、实时聊天）</li>
<li>每次都需要最新内容的场景</li>
<li>调试阶段，确保获取最新内容</li>
</ul>
<p><strong>4. LOAD_CACHE_ONLY（仅使用缓存）</strong></p>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请求资源
<span class="hljs-code">    ↓
检查本地缓存
    ↓
有缓存？ → 是 → 使用缓存
    ↓ 否
返回空白页面（不请求网络）
</span></code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>完全离线模式</li>
<li>已预加载所有内容的场景</li>
<li>不依赖网络的离线应用</li>
</ul>
<p><strong>四、HTTP 缓存头详解</strong></p>
<p><strong>1. Cache-Control（优先级最高）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">Cache-Control: max-age=<span class="hljs-number">3600</span>          <span class="hljs-comment">// 缓存有效期 3600 秒</span>
Cache-Control: no-cache              <span class="hljs-comment">// 每次都要验证缓存（发送条件请求）</span>
Cache-Control: no-store              <span class="hljs-comment">// 不存储缓存</span>
Cache-Control: must-revalidate       <span class="hljs-comment">// 缓存过期后必须验证</span>
Cache-Control: <span class="hljs-keyword">public</span>                <span class="hljs-comment">// 可以被任何缓存存储</span>
Cache-Control: <span class="hljs-keyword">private</span>               <span class="hljs-comment">// 只能被浏览器缓存，不能被 CDN 缓存</span>
</code></pre>
<p><strong>2. ETag / If-None-Match（内容指纹验证）</strong></p>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">第一次请求：
  服务器返回：ETag: "abc123"（资源的唯一标识，通常是内容哈希）
  WebView 保存 ETag 和内容

第二次请求（缓存过期）：
  WebView 发送：If<span class="hljs-operator">-</span><span class="hljs-keyword">None</span><span class="hljs-operator">-</span><span class="hljs-keyword">Match</span>: "abc123"
  服务器比较：
    <span class="hljs-operator">-</span> 资源未变 → 返回 <span class="hljs-number">304</span> <span class="hljs-keyword">Not</span> Modified（不返回内容，节省带宽）
    <span class="hljs-operator">-</span> 资源已变 → 返回 <span class="hljs-number">200</span> <span class="hljs-operator">+</span> 新内容 <span class="hljs-operator">+</span> 新 ETag
</code></pre>
<p><strong>优点</strong>：即使缓存过期，如果内容未变，仍可使用缓存，节省带宽。</p>
<p><strong>3. Last-Modified / If-Modified-Since（时间戳验证）</strong></p>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">第一次请求：
  服务器返回：Last-Modified: Wed, 21 Oct 2024 07:28:00 GMT
  WebView 保存时间戳和内容

第二次请求（缓存过期）：
  WebView 发送：If-Modified-Since: Wed, 21 Oct 2024 07:28:00 GMT
  服务器比较：
<span class="hljs-bullet">    -</span> 资源未变 → 返回 304 Not Modified
<span class="hljs-bullet">    -</span> 资源已变 → 返回 200 + 新内容 + 新 Last-Modified
</code></pre>
<p><strong>注意</strong>：Last-Modified 精度是秒级，如果资源在 1 秒内多次修改，可能无法检测到变化。</p>
<p><strong>五、缓存的生命周期完整流程</strong></p>
<pre><code class="hljs language-python" lang="python">┌─────────────────────────────────────────────────────────┐
│ <span class="hljs-number">1.</span> 首次请求                                              │
└─────────────────────────────────────────────────────────┘
用户请求 URL
    ↓
WebView 检查缓存目录 → 不存在
    ↓
请求网络
    ↓
服务器返回：
  - 响应内容（HTML/CSS/JS/图片等）
  - 缓存头（Cache-Control、ETag、Last-Modified）
    ↓
WebView 保存到缓存目录：
  - 文件内容
  - 元数据（URL、时间戳、ETag、过期时间等）
    ↓
返回给 WebView 渲染

┌─────────────────────────────────────────────────────────┐
│ <span class="hljs-number">2.</span> 再次请求（缓存未过期）                                │
└─────────────────────────────────────────────────────────┘
用户请求相同 URL
    ↓
WebView 检查缓存目录 → 存在
    ↓
检查过期时间：
  当前时间 - 缓存时间 &lt; <span class="hljs-built_in">max</span>-age → 未过期
    ↓
直接返回缓存（<span class="hljs-number">200</span> <span class="hljs-keyword">from</span> cache）
    ↓
不请求网络，立即显示

┌─────────────────────────────────────────────────────────┐
│ <span class="hljs-number">3.</span> 再次请求（缓存已过期）                                │
└─────────────────────────────────────────────────────────┘
用户请求相同 URL
    ↓
WebView 检查缓存目录 → 存在
    ↓
检查过期时间：
  当前时间 - 缓存时间 &gt;= <span class="hljs-built_in">max</span>-age → 已过期
    ↓
发送条件请求（携带 If-<span class="hljs-literal">None</span>-Match / If-Modified-Since）
    ↓
服务器验证：
  ├─ 资源未变 → 返回 <span class="hljs-number">304</span> Not Modified
  │     ↓
  │  WebView 使用缓存（更新过期时间）
  │     ↓
  │  返回给 WebView 渲染
  │
  └─ 资源已变 → 返回 <span class="hljs-number">200</span> + 新内容
        ↓
    WebView 更新缓存（覆盖旧内容）
        ↓
    返回给 WebView 渲染
</code></pre>
<p><strong>六、缓存存储的物理结构</strong></p>
<pre><code class="hljs language-bash" lang="bash">/data/data/包名/cache/webviewCache/
  ├── Cache/
  │   ├── f_000001          <span class="hljs-comment"># 缓存的资源文件（二进制）</span>
  │   ├── f_000002
  │   └── ...
  ├── Code Cache/           <span class="hljs-comment"># JavaScript 代码缓存（V8 引擎优化）</span>
  │   └── ...
  └── GPUCache/             <span class="hljs-comment"># GPU 相关缓存</span>
      └── ...
</code></pre>
<p><strong>缓存文件命名</strong>：</p>
<ul>
<li>WebView 使用内部算法生成文件名（通常是 URL 的哈希值）</li>
<li>无法直接通过文件名识别对应的 URL</li>
<li>元数据存储在 WebView 内部数据库中</li>
</ul>
<p><strong>七、DOM 存储（LocalStorage / SessionStorage）</strong></p>
<p><strong>LocalStorage</strong>：</p>
<ul>
<li><strong>存储位置</strong>：<code>/data/data/包名/app_webview/Default/Local Storage/</code></li>
<li><strong>存储方式</strong>：键值对，持久化存储</li>
<li><strong>生命周期</strong>：除非手动清除，否则永久保存</li>
<li><strong>作用域</strong>：同源策略（相同协议、域名、端口）</li>
</ul>
<p><strong>SessionStorage</strong>：</p>
<ul>
<li><strong>存储位置</strong>：内存中</li>
<li><strong>生命周期</strong>：会话结束（关闭 WebView）后清除</li>
<li><strong>作用域</strong>：同源策略</li>
</ul>
<p><strong>IndexedDB</strong>：</p>
<ul>
<li><strong>存储位置</strong>：<code>/data/data/包名/app_webview/Default/IndexedDB/</code></li>
<li><strong>存储方式</strong>：NoSQL 数据库，支持复杂数据结构</li>
<li><strong>适用场景</strong>：存储大量结构化数据</li>
</ul>
<p><strong>注意</strong>：这些存储机制与 HTTP 缓存不同，主要用于存储应用数据，而非网络资源。</p>
<h4 data-id="heading-56">8.2.2 WebView 缓存配置实现</h4>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewCacheManager</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">/**
         * 配置 WebView 缓存
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupCache</span><span class="hljs-params">(webView: <span class="hljs-type">WebView</span>, enableCache: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>)</span></span> {
            <span class="hljs-comment">// 使用统一的配置扩展函数</span>
            webView.setupDefaultSettings(enableCache)
            
            <span class="hljs-comment">// 如果需要自定义缓存策略，可以单独设置</span>
            <span class="hljs-keyword">if</span> (enableCache) {
                webView.settings.cacheMode = WebSettings.LOAD_CACHE_ELSE_NETWORK
            }
            
            <span class="hljs-comment">// 注意：setAppCacheEnabled 在 Android 5.0+ 已废弃，不应使用</span>
            <span class="hljs-comment">// 如需更灵活的缓存控制，推荐使用自定义缓存（见 8.2.3）</span>
        }
        
        <span class="hljs-comment">/**
         * 清除 WebView 缓存
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 清除缓存</span>
                WebView(context).clearCache(<span class="hljs-literal">true</span>)
                
                <span class="hljs-comment">// 清除历史记录</span>
                WebView(context).clearHistory()
                
                <span class="hljs-comment">// 清除 Cookie</span>
                CookieManager.getInstance().apply {
                    removeAllCookies(<span class="hljs-literal">null</span>)
                    flush()
                }
                
                <span class="hljs-comment">// 注意：AppCache 已在 Android 5.0+ 废弃，无需清除</span>
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
                ErrorHandler.handleError(
                    ErrorHandler.ErrorType.CACHE_ERROR,
                    <span class="hljs-string">"Failed to clear WebView cache"</span>,
                    e
                )
            }
        }
        
        <span class="hljs-comment">/**
         * 获取缓存大小
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCacheSize</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: <span class="hljs-built_in">Long</span> {
            <span class="hljs-keyword">val</span> cacheDir = File(context.cacheDir, <span class="hljs-string">"webview"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (cacheDir.exists()) {
                cacheDir.walkTopDown().sumOf { it.length() }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-number">0L</span>
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-57">8.2.3 自定义离线缓存管理器原理</h4>
<p><strong>一、为什么需要自定义缓存？</strong></p>
<p>WebView 内置的 HTTP 缓存有以下限制：</p>
<ol>
<li><strong>依赖服务器响应头</strong>：如果服务器没有设置缓存头，无法缓存</li>
<li><strong>无法跨域缓存</strong>：某些跨域资源无法缓存</li>
<li><strong>缓存策略固定</strong>：无法灵活控制缓存逻辑</li>
<li><strong>无法加密存储</strong>：缓存数据以明文存储</li>
<li><strong>无法自定义过期时间</strong>：只能依赖服务器的 Cache-Control</li>
</ol>
<p><strong>自定义缓存可以解决这些问题</strong>，实现完全可控的缓存策略。</p>
<p><strong>二、自定义缓存的核心原理</strong></p>
<p>自定义缓存通过 <code>shouldInterceptRequest</code> 方法拦截 WebView 的所有网络请求：</p>
<pre><code class="hljs language-csharp" lang="csharp">WebView 请求资源
    ↓
shouldInterceptRequest 拦截（Android 端）
    ↓
检查自定义缓存（文件系统/数据库）
    ↓
有缓存且有效？ → 是 → 构造 WebResourceResponse 返回缓存
    ↓ 否
返回 <span class="hljs-literal">null</span> → WebView 继续默认流程（HTTP 缓存 → 网络请求）
    ↓
onPageFinished（页面加载完成）
    ↓
获取页面 HTML 内容
    ↓
保存到自定义缓存（文件系统/数据库）
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>shouldInterceptRequest</code> 在请求发起前拦截，可以返回缓存的响应</li>
<li>如果返回 <code>null</code>，WebView 会继续使用默认的 HTTP 缓存机制</li>
<li>在 <code>onPageFinished</code> 中保存页面内容，实现缓存更新</li>
</ul>
<p><strong>三、缓存存储架构</strong></p>
<p><strong>1. 文件系统存储（推荐）</strong></p>
<pre><code class="hljs language-bash" lang="bash">cacheDir/
  └── offline_cache/
       ├── index.json          <span class="hljs-comment"># 缓存索引（URL -&gt; 文件路径映射）</span>
       ├── 12345.html          <span class="hljs-comment"># 缓存的 HTML 文件（URL 哈希值作为文件名）</span>
       ├── 67890.html
       └── ...
</code></pre>
<p><strong>索引文件结构</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"https://example.com/page1"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12345"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1698123456789</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ttl"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">604800000</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"https://example.com/page2"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"hash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"67890"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1698123456790</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ttl"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">604800000</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>实现简单，直接使用文件系统</li>
<li>存储效率高，适合大文件</li>
<li>易于调试，可以直接查看文件</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>需要手动管理文件</li>
<li>查询效率相对较低（需要遍历索引）</li>
</ul>
<p><strong>2. 数据库存储</strong></p>
<pre><code class="hljs language-scss" lang="scss">SQLite 数据库
  └── cache_table
       ├── url (TEXT PRIMARY KEY)
       ├── <span class="hljs-attribute">content</span> (BLOB)        # 缓存的 <span class="hljs-selector-tag">HTML</span> 内容
       ├── timestamp (INTEGER)   # 缓存时间戳
       └── ttl (INTEGER)         # 过期时间
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>查询效率高，支持索引</li>
<li>支持复杂查询（如按时间、大小排序）</li>
<li>事务支持，数据一致性好</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>大文件存储效率低（BLOB 字段）</li>
<li>实现相对复杂</li>
</ul>
<p><strong>3. 混合存储（最佳实践）</strong></p>
<pre><code class="hljs language-bash" lang="bash">数据库（元数据）
  └── cache_metadata
       ├── url
       ├── file_path          <span class="hljs-comment"># 文件路径</span>
       ├── timestamp
       └── ttl

文件系统（内容）
  └── cache_files/
       ├── 12345.html
       └── 67890.html
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>兼顾查询效率和存储效率</li>
<li>元数据查询快，大文件存储效率高</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>实现复杂，需要维护两套存储</li>
</ul>
<p><strong>四、缓存失效策略详解</strong></p>
<p><strong>1. TTL（Time To Live）时间过期</strong></p>
<p><strong>原理</strong>：每个缓存条目设置一个过期时间，超过时间后自动失效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 保存时设置过期时间</span>
<span class="hljs-keyword">val</span> ttl = <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>  <span class="hljs-comment">// 7 天</span>
<span class="hljs-keyword">val</span> timestamp = System.currentTimeMillis()

<span class="hljs-comment">// 检查时判断是否过期</span>
<span class="hljs-keyword">val</span> age = System.currentTimeMillis() - timestamp
<span class="hljs-keyword">if</span> (age &gt; ttl) {
    <span class="hljs-comment">// 缓存已过期，删除</span>
    clearCache(url)
}
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>新闻、文章等有时效性的内容</li>
<li>需要定期更新的数据</li>
</ul>
<p><strong>2. LRU（Least Recently Used）最近最少使用</strong></p>
<p><strong>原理</strong>：维护每个缓存条目的访问时间，当缓存空间不足时，删除最久未访问的缓存。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 访问时更新访问时间</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadPage</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: String? {
    <span class="hljs-keyword">val</span> entry = getCacheEntry(url) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    updateAccessTime(url)  <span class="hljs-comment">// 更新访问时间</span>
    <span class="hljs-keyword">return</span> readFile(entry.filePath)
}

<span class="hljs-comment">// 清理时按访问时间排序</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">evictCache</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> entries = getAllCacheEntries()
        .sortedBy { it.accessTime }  <span class="hljs-comment">// 按访问时间升序排序</span>
    
    <span class="hljs-comment">// 删除最久未访问的</span>
    entries.take(entries.size - maxSize).forEach {
        clearCache(it.url)
    }
}
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>缓存空间有限，需要自动清理</li>
<li>希望保留最常用的缓存</li>
</ul>
<p><strong>3. 版本控制</strong></p>
<p><strong>原理</strong>：通过版本号管理缓存，版本更新时清除旧缓存。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 保存时记录版本</span>
<span class="hljs-keyword">val</span> cacheVersion = <span class="hljs-string">"v1.0"</span>
savePage(url, html, version = cacheVersion)

<span class="hljs-comment">// 检查时比较版本</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isCacheValid</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> entry = getCacheEntry(url) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> entry.version == currentVersion
}
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>应用版本更新，需要清除旧缓存</li>
<li>数据结构变更，需要重新缓存</li>
</ul>
<p><strong>4. 大小限制</strong></p>
<p><strong>原理</strong>：限制缓存总大小，超过限制时删除最旧的缓存。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkCacheSize</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> totalSize = getTotalCacheSize()
    <span class="hljs-keyword">if</span> (totalSize &gt; maxCacheSize) {
        <span class="hljs-comment">// 按时间排序，删除最旧的</span>
        <span class="hljs-keyword">val</span> entries = getAllCacheEntries()
            .sortedBy { it.timestamp }
        
        <span class="hljs-keyword">for</span> (entry <span class="hljs-keyword">in</span> entries) {
            <span class="hljs-keyword">if</span> (totalSize &lt;= maxCacheSize) <span class="hljs-keyword">break</span>
            totalSize -= entry.size
            clearCache(entry.url)
        }
    }
}
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要控制缓存占用的存储空间</li>
<li>防止缓存无限增长</li>
</ul>
<p><strong>五、缓存更新策略</strong></p>
<p><strong>1. 后台更新（推荐）</strong></p>
<p><strong>原理</strong>：立即返回缓存给用户，同时在后台更新缓存。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInterceptRequest</span><span class="hljs-params">(
    view: <span class="hljs-type">WebView</span>?,
    request: <span class="hljs-type">WebResourceRequest</span>?
)</span></span>: WebResourceResponse? {
    <span class="hljs-keyword">val</span> url = request?.url?.toString() ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 立即返回缓存</span>
    <span class="hljs-keyword">val</span> cached = cacheManager.loadPage(url)
    <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 后台更新（异步）</span>
        backgroundUpdate(url)
        <span class="hljs-keyword">return</span> WebResourceResponse(<span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, cached.byteInputStream())
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">backgroundUpdate</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 在后台线程更新缓存</span>
    thread {
        <span class="hljs-comment">// 请求最新内容</span>
        <span class="hljs-keyword">val</span> newContent = fetchFromNetwork(url)
        cacheManager.savePage(url, newContent)
    }
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>用户体验好，立即响应</li>
<li>后台自动更新，保持数据新鲜</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>首次可能返回旧数据</li>
<li>需要额外的网络请求</li>
</ul>
<p><strong>2. 网络优先</strong></p>
<p><strong>原理</strong>：优先请求网络，失败时才使用缓存。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInterceptRequest</span><span class="hljs-params">(
    view: <span class="hljs-type">WebView</span>?,
    request: <span class="hljs-type">WebResourceRequest</span>?
)</span></span>: WebResourceResponse? {
    <span class="hljs-keyword">val</span> url = request?.url?.toString() ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 先尝试网络请求</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> networkResponse = fetchFromNetwork(url)
        <span class="hljs-comment">// 成功则更新缓存</span>
        cacheManager.savePage(url, networkResponse)
        <span class="hljs-keyword">return</span> WebResourceResponse(<span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, networkResponse.byteInputStream())
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// 失败则使用缓存</span>
        <span class="hljs-keyword">val</span> cached = cacheManager.loadPage(url)
        <span class="hljs-keyword">return</span> cached?.let {
            WebResourceResponse(<span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, it.byteInputStream())
        }
    }
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>数据最新</li>
<li>离线时仍可使用缓存</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>每次都需要网络请求，速度较慢</li>
</ul>
<p><strong>3. 缓存优先</strong></p>
<p><strong>原理</strong>：优先使用缓存，缓存不存在时才请求网络。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInterceptRequest</span><span class="hljs-params">(
    view: <span class="hljs-type">WebView</span>?,
    request: <span class="hljs-type">WebResourceRequest</span>?
)</span></span>: WebResourceResponse? {
    <span class="hljs-keyword">val</span> url = request?.url?.toString() ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 先检查缓存</span>
    <span class="hljs-keyword">val</span> cached = cacheManager.loadPage(url)
    <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> WebResourceResponse(<span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, cached.byteInputStream())
    }
    
    <span class="hljs-comment">// 缓存不存在，返回 null 让 WebView 请求网络</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>离线可用</li>
<li>加载速度快</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>可能返回过期数据</li>
<li>需要手动触发更新</li>
</ul>
<h4 data-id="heading-58">8.2.4 自定义离线缓存实现（简化版）</h4>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 简化的离线缓存管理器
 * 核心功能：保存、加载、检查、清除缓存
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OfflineCacheManager</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cacheDir = File(context.cacheDir, <span class="hljs-string">"offline_cache"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> indexFile = File(cacheDir, <span class="hljs-string">"index.json"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxCacheSize = <span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024L</span> <span class="hljs-comment">// 50MB</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> defaultTTL = <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span> <span class="hljs-comment">// 默认 7 天过期</span>
    
    <span class="hljs-comment">// 缓存索引：URL -&gt; CacheEntry</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>(
        <span class="hljs-keyword">val</span> hash: String,           <span class="hljs-comment">// 文件哈希（用于文件名）</span>
        <span class="hljs-keyword">val</span> timestamp: <span class="hljs-built_in">Long</span>,        <span class="hljs-comment">// 缓存时间戳</span>
        <span class="hljs-keyword">val</span> size: <span class="hljs-built_in">Long</span>,            <span class="hljs-comment">// 缓存大小</span>
        <span class="hljs-keyword">val</span> ttl: <span class="hljs-built_in">Long</span> = defaultTTL <span class="hljs-comment">// 生存时间</span>
    )
    
    <span class="hljs-keyword">init</span> {
        <span class="hljs-keyword">if</span> (!cacheDir.exists()) {
            cacheDir.mkdirs()
        }
        <span class="hljs-keyword">if</span> (!indexFile.exists()) {
            indexFile.writeText(<span class="hljs-string">"{}"</span>)
        }
    }
    
    <span class="hljs-comment">/**
     * 保存页面到缓存
     * 
     * 原理：
     * 1. 将 URL 转换为哈希值作为文件名（避免特殊字符问题）
     * 2. 保存 HTML 内容到文件
     * 3. 保存关联资源（CSS、JS、图片等）到子目录
     * 4. 更新索引文件，记录 URL、时间戳、大小等信息
     * 5. 检查缓存大小，如果超限则删除最旧的缓存（LRU）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">savePage</span><span class="hljs-params">(
        url: <span class="hljs-type">String</span>, 
        html: <span class="hljs-type">String</span>, 
        resources: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, ByteArray&gt; = emptyMap()</span></span>,
        ttl: <span class="hljs-built_in">Long</span> = defaultTTL
    ) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 生成 URL 哈希（使用 MD5 或简单哈希）</span>
            <span class="hljs-keyword">val</span> urlHash = url.hashCode().toString()
            <span class="hljs-keyword">val</span> pageFile = File(cacheDir, <span class="hljs-string">"<span class="hljs-variable">$urlHash</span>.html"</span>)
            <span class="hljs-keyword">val</span> resourcesDir = File(cacheDir, <span class="hljs-string">"<span class="hljs-subst">${urlHash}</span>_resources"</span>)
            
            <span class="hljs-comment">// 2. 保存 HTML 内容</span>
            pageFile.writeText(html, Charsets.UTF_8)
            
            <span class="hljs-comment">// 3. 保存关联资源（CSS、JS、图片等）</span>
            <span class="hljs-keyword">if</span> (resources.isNotEmpty()) {
                <span class="hljs-keyword">if</span> (!resourcesDir.exists()) {
                    resourcesDir.mkdirs()
                }
                resources.forEach { (name, <span class="hljs-keyword">data</span>) -&gt;
                    <span class="hljs-comment">// 清理文件名，避免路径遍历攻击</span>
                    <span class="hljs-keyword">val</span> safeName = name.replace(Regex(<span class="hljs-string">"[^a-zA-Z0-9._-]"</span>), <span class="hljs-string">"_"</span>)
                    File(resourcesDir, safeName).writeBytes(<span class="hljs-keyword">data</span>)
                }
            }
            
            <span class="hljs-comment">// 4. 计算缓存大小</span>
            <span class="hljs-keyword">val</span> cacheSize = pageFile.length() + 
                           resourcesDir.walkTopDown().sumOf { it.length() }
            
            <span class="hljs-comment">// 5. 更新缓存索引</span>
            updateCacheIndex(url, CacheEntry(
                hash = urlHash,
                timestamp = System.currentTimeMillis(),
                size = cacheSize,
                ttl = ttl
            ))
            
            <span class="hljs-comment">// 6. 检查并清理过期缓存</span>
            cleanupExpiredCache()
            
            <span class="hljs-comment">// 7. 检查缓存大小，如果超限则删除最旧的（LRU）</span>
            checkAndEvictCache()
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to save page to cache: <span class="hljs-variable">$url</span>"</span>,
                e
            )
        }
    }
    
    <span class="hljs-comment">/**
     * 从缓存加载页面
     * 
     * 原理：
     * 1. 从索引文件查找 URL 对应的哈希值
     * 2. 检查缓存是否过期（TTL）
     * 3. 如果有效，读取 HTML 文件内容
     * 4. 更新访问时间（用于 LRU）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadPage</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: String? {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> entry = getCacheEntry(url) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
            
            <span class="hljs-comment">// 检查是否过期</span>
            <span class="hljs-keyword">if</span> (isExpired(entry)) {
                clearCache(url)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
            }
            
            <span class="hljs-keyword">val</span> pageFile = File(cacheDir, <span class="hljs-string">"<span class="hljs-subst">${entry.hash}</span>.html"</span>)
            <span class="hljs-keyword">if</span> (pageFile.exists()) {
                <span class="hljs-comment">// 更新访问时间（用于 LRU）</span>
                updateAccessTime(url)
                pageFile.readText(Charsets.UTF_8)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-literal">null</span>
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to load page from cache: <span class="hljs-variable">$url</span>"</span>,
                e
            )
            <span class="hljs-literal">null</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 检查页面是否已缓存且有效
     * 
     * 原理：
     * 1. 检查索引中是否存在该 URL
     * 2. 检查缓存是否过期
     * 3. 检查文件是否存在
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isCached</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> entry = getCacheEntry(url) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> (isExpired(entry)) {
            clearCache(url)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
        <span class="hljs-keyword">val</span> pageFile = File(cacheDir, <span class="hljs-string">"<span class="hljs-subst">${entry.hash}</span>.html"</span>)
        <span class="hljs-keyword">return</span> pageFile.exists()
    }
    
    <span class="hljs-comment">/**
     * 检查缓存是否过期
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isExpired</span><span class="hljs-params">(entry: <span class="hljs-type">CacheEntry</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> age = System.currentTimeMillis() - entry.timestamp
        <span class="hljs-keyword">return</span> age &gt; entry.ttl
    }
    
    <span class="hljs-comment">/**
     * 清除指定 URL 的缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> urlHash = getUrlHash(url) ?: <span class="hljs-keyword">return</span>
            File(cacheDir, <span class="hljs-string">"<span class="hljs-variable">$urlHash</span>.html"</span>).delete()
            File(cacheDir, <span class="hljs-string">"<span class="hljs-subst">${urlHash}</span>_resources"</span>).deleteRecursively()
            removeFromCacheIndex(url)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to clear cache: <span class="hljs-variable">$url</span>"</span>,
                e
            )
        }
    }
    
    <span class="hljs-comment">/**
     * 清除所有缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearAllCache</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">try</span> {
            cacheDir.deleteRecursively()
            cacheDir.mkdirs()
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to clear all cache"</span>,
                e
            )
        }
    }
    
    <span class="hljs-comment">/**
     * 获取缓存大小
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCacheSize</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Long</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (cacheDir.exists()) {
            cacheDir.walkTopDown().sumOf { it.length() }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-number">0L</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 更新缓存索引
     * 
     * 原理：
     * 索引文件结构：
     * {
     *   "url1": {"hash": "123", "timestamp": 1234567890, "size": 1024, "ttl": 604800000},
     *   "url2": {"hash": "456", "timestamp": 1234567891, "size": 2048, "ttl": 604800000}
     * }
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateCacheIndex</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, entry: <span class="hljs-type">CacheEntry</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> index = loadIndex()
            <span class="hljs-keyword">val</span> entryJson = JSONObject().apply {
                put(<span class="hljs-string">"hash"</span>, entry.hash)
                put(<span class="hljs-string">"timestamp"</span>, entry.timestamp)
                put(<span class="hljs-string">"size"</span>, entry.size)
                put(<span class="hljs-string">"ttl"</span>, entry.ttl)
                put(<span class="hljs-string">"accessTime"</span>, System.currentTimeMillis()) <span class="hljs-comment">// 用于 LRU</span>
            }
            index.put(url, entryJson)
            saveIndex(index)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to update cache index: <span class="hljs-variable">$url</span>"</span>,
                e
            )
        }
    }
    
    <span class="hljs-comment">/**
     * 更新访问时间（用于 LRU 算法）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateAccessTime</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> index = loadIndex()
            <span class="hljs-keyword">val</span> entryJson = index.optJSONObject(url) ?: <span class="hljs-keyword">return</span>
            entryJson.put(<span class="hljs-string">"accessTime"</span>, System.currentTimeMillis())
            index.put(url, entryJson)
            saveIndex(index)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to update access time: <span class="hljs-variable">$url</span>"</span>,
                e
            )
        }
    }
    
    <span class="hljs-comment">/**
     * 获取缓存条目
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCacheEntry</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>: CacheEntry? {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> index = loadIndex()
            <span class="hljs-keyword">val</span> entryJson = index.optJSONObject(url) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
            CacheEntry(
                hash = entryJson.getString(<span class="hljs-string">"hash"</span>),
                timestamp = entryJson.getLong(<span class="hljs-string">"timestamp"</span>),
                size = entryJson.getLong(<span class="hljs-string">"size"</span>),
                ttl = entryJson.optLong(<span class="hljs-string">"ttl"</span>, defaultTTL)
            )
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-literal">null</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 加载索引文件
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadIndex</span><span class="hljs-params">()</span></span>: JSONObject {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (indexFile.exists()) {
            <span class="hljs-keyword">try</span> {
                JSONObject(indexFile.readText())
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                JSONObject()
            }
        } <span class="hljs-keyword">else</span> {
            JSONObject()
        }
    }
    
    <span class="hljs-comment">/**
     * 保存索引文件
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveIndex</span><span class="hljs-params">(index: <span class="hljs-type">JSONObject</span>)</span></span> {
        indexFile.writeText(index.toString())
    }
    
    <span class="hljs-comment">/**
     * 清理过期缓存
     * 
     * 原理：遍历所有缓存条目，删除已过期的
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cleanupExpiredCache</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> index = loadIndex()
            <span class="hljs-keyword">val</span> keys = index.keys()
            <span class="hljs-keyword">val</span> expiredUrls = mutableListOf&lt;String&gt;()
            
            <span class="hljs-keyword">while</span> (keys.hasNext()) {
                <span class="hljs-keyword">val</span> url = keys.next()
                <span class="hljs-keyword">val</span> entry = getCacheEntry(url) ?: <span class="hljs-keyword">continue</span>
                <span class="hljs-keyword">if</span> (isExpired(entry)) {
                    expiredUrls.add(url)
                }
            }
            
            expiredUrls.forEach { url -&gt;
                clearCache(url)
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to cleanup expired cache"</span>,
                e
            )
        }
    }
    
    <span class="hljs-comment">/**
     * 检查并清理缓存（LRU 策略）
     * 
     * 原理：
     * 1. 计算当前缓存总大小
     * 2. 如果超过限制，按访问时间排序（LRU）
     * 3. 删除最久未访问的缓存，直到满足大小限制
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkAndEvictCache</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> currentSize = getCacheSize()
            <span class="hljs-keyword">if</span> (currentSize &lt;= maxCacheSize) {
                <span class="hljs-keyword">return</span>
            }
            
            <span class="hljs-comment">// 按访问时间排序（LRU：最久未访问的优先删除）</span>
            <span class="hljs-keyword">val</span> index = loadIndex()
            <span class="hljs-keyword">val</span> entries = mutableListOf&lt;Pair&lt;String, <span class="hljs-built_in">Long</span>&gt;&gt;()
            
            index.keys().forEach { url -&gt;
                <span class="hljs-keyword">val</span> entryJson = index.optJSONObject(url) ?: <span class="hljs-keyword">return</span><span class="hljs-symbol">@forEach</span>
                <span class="hljs-keyword">val</span> accessTime = entryJson.optLong(<span class="hljs-string">"accessTime"</span>, entryJson.getLong(<span class="hljs-string">"timestamp"</span>))
                entries.add(Pair(url, accessTime))
            }
            
            <span class="hljs-comment">// 按访问时间升序排序（最旧的在前）</span>
            entries.sortBy { it.second }
            
            <span class="hljs-comment">// 删除最旧的缓存，直到满足大小限制</span>
            <span class="hljs-keyword">for</span> ((url, _) <span class="hljs-keyword">in</span> entries) {
                <span class="hljs-keyword">if</span> (currentSize &lt;= maxCacheSize) {
                    <span class="hljs-keyword">break</span>
                }
                <span class="hljs-keyword">val</span> entry = getCacheEntry(url) ?: <span class="hljs-keyword">continue</span>
                currentSize -= entry.size
                clearCache(url)
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 使用统一的错误处理框架（见 4.2.7）</span>
            ErrorHandler.handleError(
                ErrorHandler.ErrorType.CACHE_ERROR,
                <span class="hljs-string">"Failed to evict cache"</span>,
                e
            )
        }
    }
}
</code></pre>
<h4 data-id="heading-59">8.2.5 离线缓存完整使用示例</h4>
<p><strong>一、缓存策略选择指南</strong></p>



































<table><thead><tr><th>场景</th><th>推荐策略</th><th>原因</th></tr></thead><tbody><tr><td>新闻阅读</td><td>LOAD_CACHE_ELSE_NETWORK + 自定义缓存（后台更新）</td><td>离线可读，后台更新</td></tr><tr><td>实时数据</td><td>LOAD_NO_CACHE</td><td>需要最新数据</td></tr><tr><td>静态文档</td><td>LOAD_CACHE_ELSE_NETWORK</td><td>内容变化少</td></tr><tr><td>完全离线</td><td>LOAD_CACHE_ONLY + 自定义缓存</td><td>不依赖网络</td></tr><tr><td>混合应用</td><td>LOAD_DEFAULT + 自定义缓存（网络优先）</td><td>平衡性能和实时性</td></tr></tbody></table>
<p><strong>二、完整实现示例</strong></p>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 支持离线缓存的 WebViewClient（简化版）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedWebViewClient</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cacheManager: OfflineCacheManager
) : WebViewClient() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInterceptRequest</span><span class="hljs-params">(
        view: <span class="hljs-type">WebView</span>?,
        request: <span class="hljs-type">WebResourceRequest</span>?
    )</span></span>: WebResourceResponse? {
        <span class="hljs-keyword">val</span> url = request?.url?.toString() ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">val</span> cachedHtml = cacheManager.loadPage(url)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (cachedHtml != <span class="hljs-literal">null</span>) {
            WebResourceResponse(<span class="hljs-string">"text/html"</span>, <span class="hljs-string">"utf-8"</span>, cachedHtml.byteInputStream())
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">super</span>.shouldInterceptRequest(view, request)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageFinished</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onPageFinished(view, url)
        url?.let {
            view?.evaluateJavaScriptSafe(<span class="hljs-string">"document.documentElement.outerHTML"</span>) { html -&gt;
                JSResultParser.parseResult(html)?.let { cleaned -&gt;
                    cacheManager.savePage(url, cleaned)
                }
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> webView: WebView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> cacheManager: OfflineCacheManager
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        cacheManager = OfflineCacheManager(<span class="hljs-keyword">this</span>)
        webView = findViewById(R.id.webview)
        webView.setupDefaultSettings(enableCache = <span class="hljs-literal">true</span>)
        webView.webViewClient = CachedWebViewClient(cacheManager)
        webView.loadUrl(<span class="hljs-string">"https://example.com"</span>)
    }
}
</code></pre>
<h3 data-id="heading-60">8.3 批量通信优化</h3>
<p><strong>原理</strong>：频繁调用 JavaScript 会导致性能问题，通过批量合并调用可以减少通信次数，提升性能。</p>
<p><strong>依赖说明</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.webkit.WebView
<span class="hljs-keyword">import</span> android.webkit.ValueCallback
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> android.os.Handler
<span class="hljs-keyword">import</span> android.os.Looper
</code></pre>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 批量 JavaScript 执行器
 * 
 * 工作原理：
 * 1. 收集待执行的 JavaScript 代码
 * 2. 延迟执行（100ms 内合并）
 * 3. 批量执行，减少通信次数
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchJSExecutor</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webView: WebView) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> pendingCalls = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handler = Handler(Looper.getMainLooper())
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> batchRunnable: Runnable? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> batchDelay = <span class="hljs-number">100L</span> <span class="hljs-comment">// 100ms 内合并</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addCall</span><span class="hljs-params">(jsCode: <span class="hljs-type">String</span>)</span></span> {
        synchronized(pendingCalls) { pendingCalls.add(jsCode) }
        scheduleBatch()
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">flush</span><span class="hljs-params">()</span></span> {
        handler.removeCallbacks(batchRunnable ?: <span class="hljs-keyword">return</span>)
        batchRunnable?.run()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">scheduleBatch</span><span class="hljs-params">()</span></span> {
        batchRunnable?.let { handler.removeCallbacks(it) }
        batchRunnable = Runnable {
            synchronized(pendingCalls) {
                <span class="hljs-keyword">if</span> (pendingCalls.isNotEmpty()) {
                    webView.evaluateJavaScriptSafe(pendingCalls.joinToString(<span class="hljs-string">";"</span>))
                    pendingCalls.clear()
                }
            }
        }
        handler.postDelayed(batchRunnable!!, batchDelay)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cleanup</span><span class="hljs-params">()</span></span> {
        handler.removeCallbacks(batchRunnable ?: <span class="hljs-keyword">return</span>)
        synchronized(pendingCalls) { pendingCalls.clear() }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">val</span> batchExecutor = BatchJSExecutor(webView)

<span class="hljs-comment">// 添加多个调用</span>
batchExecutor.addCall(<span class="hljs-string">"console.log('1')"</span>)
batchExecutor.addCall(<span class="hljs-string">"console.log('2')"</span>)
batchExecutor.addCall(<span class="hljs-string">"console.log('3')"</span>)
<span class="hljs-comment">// 100ms 后会自动批量执行</span>

<span class="hljs-comment">// 立即执行</span>
batchExecutor.flush()
</code></pre>
<hr/>
<h2 data-id="heading-61">九、架构设计建议</h2>
<h3 data-id="heading-62">9.1 WebView 架构设计</h3>
<p><strong>一、单一 WebView 架构</strong></p>
<p>适用于：简单的 H5 页面展示</p>
<pre><code class="hljs language-scss" lang="scss">Activity
  └── WebView
       └── WebViewClient (处理页面加载)
       └── WebChromeClient (处理 JS 交互)
       └── JSInterface (Bridge 接口)
</code></pre>
<p><strong>依赖说明</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.webkit.WebView
<span class="hljs-keyword">import</span> android.webkit.WebViewClient
<span class="hljs-keyword">import</span> android.webkit.WebChromeClient
<span class="hljs-keyword">import</span> android.webkit.JavascriptInterface
<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity
</code></pre>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleWebViewActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> webView: WebView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> bridge: WebViewBridgeKt
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        webView = WebView(<span class="hljs-keyword">this</span>)
        <span class="hljs-comment">// WebViewBridgeKt 会自动配置 WebView</span>
        bridge = WebViewBridgeKt(webView)
        
        <span class="hljs-comment">// 注册处理器</span>
        bridge.registerHandler(<span class="hljs-string">"showToast"</span>) { <span class="hljs-keyword">data</span>, callback -&gt;
            Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">data</span>, Toast.LENGTH_SHORT).show()
            callback?.invoke(<span class="hljs-string">"success"</span>)
        }
        
        setContentView(webView)
        webView.loadUrl(<span class="hljs-string">"https://example.com"</span>)
    }
}
</code></pre>
<p><strong>二、多 WebView 管理架构</strong></p>
<p>适用于：需要管理多个 WebView 的场景（如多标签页、多页面栈）</p>
<pre><code class="hljs language-scss" lang="scss">WebViewManager (单例)
  ├── WebViewPool (WebView 池)
  ├── WebViewRegistry (WebView 注册表)
  └── LifecycleManager (生命周期管理)
       ├── WebView <span class="hljs-number">1</span>
       ├── WebView <span class="hljs-number">2</span>
       └── WebView <span class="hljs-number">3</span>
</code></pre>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * WebView 管理器（简化版）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewManager</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webViewPool = WebViewPool(context)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> activeWebViews = mutableMapOf&lt;String, WebView&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getWebView</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: WebView {
        <span class="hljs-keyword">return</span> activeWebViews.getOrPut(id) { webViewPool.obtain() }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">destroyWebView</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span> {
        activeWebViews.remove(id)?.let { webViewPool.recycle(it) }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearAll</span><span class="hljs-params">()</span></span> {
        activeWebViews.values.forEach { webViewPool.recycle(it) }
        activeWebViews.clear()
    }
}
</code></pre>
<p><strong>三、模块化架构</strong></p>
<p>适用于：大型项目，需要模块化管理</p>
<pre><code class="hljs language-scss" lang="scss">App
  └── WebViewModule
       ├── WebViewManager (WebView 管理)
       ├── BridgeManager (Bridge 管理)
       ├── CacheManager (缓存管理)
       ├── PreloadManager (预加载管理)
       └── ErrorHandler (错误处理)
</code></pre>
<h3 data-id="heading-63">9.2 多 WebView 场景管理</h3>
<p><strong>场景</strong>：多标签页浏览器、多页面栈、Fragment 中的 WebView</p>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 多 WebView 场景管理器（简化版）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiWebViewManager</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webViews = mutableMapOf&lt;String, WebView&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createWebView</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: WebView {
        <span class="hljs-keyword">return</span> WebView(context.applicationContext).apply {
            setupDefaultSettings()
            webViews[id] = <span class="hljs-keyword">this</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getWebView</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: WebView? = webViews[id]
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchWebView</span><span class="hljs-params">(fromId: <span class="hljs-type">String</span>, toId: <span class="hljs-type">String</span>)</span></span> {
        webViews[fromId]?.onPause()
        webViews[toId]?.onResume()
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">destroyWebView</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span> {
        webViews.remove(id)?.destroy()
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearAll</span><span class="hljs-params">()</span></span> {
        webViews.values.forEach { it.destroy() }
        webViews.clear()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-64">十、性能监控</h2>
<h3 data-id="heading-65">10.1 性能指标收集</h3>
<p><strong>原理</strong>：收集 WebView 性能指标，帮助优化应用性能。</p>
<p><strong>依赖说明</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.webkit.WebView
<span class="hljs-keyword">import</span> android.webkit.WebResourceRequest
<span class="hljs-keyword">import</span> android.webkit.WebResourceError
<span class="hljs-keyword">import</span> android.webkit.WebResourceResponse
<span class="hljs-keyword">import</span> android.graphics.Bitmap
<span class="hljs-keyword">import</span> android.util.Log
</code></pre>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * WebView 性能监控器
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewPerformanceMonitor</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> webView: WebView) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> metrics = mutableListOf&lt;PerformanceMetric&gt;()
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMetric</span>(
        <span class="hljs-keyword">val</span> type: MetricType,
        <span class="hljs-keyword">val</span> value: <span class="hljs-built_in">Long</span>,
        <span class="hljs-keyword">val</span> timestamp: <span class="hljs-built_in">Long</span> = System.currentTimeMillis(),
        <span class="hljs-keyword">val</span> context: Map&lt;String, Any&gt;? = <span class="hljs-literal">null</span>
    )
    
    <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricType</span> {
        PAGE_LOAD_TIME,      <span class="hljs-comment">// 页面加载时间</span>
        JS_EXECUTION_TIME,   <span class="hljs-comment">// JS 执行时间</span>
        BRIDGE_CALL_TIME,    <span class="hljs-comment">// Bridge 调用时间</span>
        MEMORY_USAGE,        <span class="hljs-comment">// 内存使用</span>
        NETWORK_REQUEST_TIME <span class="hljs-comment">// 网络请求时间</span>
    }
    
    <span class="hljs-comment">/**
     * 监控页面加载时间
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">monitorPageLoad</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">var</span> startTime = <span class="hljs-number">0L</span>
        
        webView.webViewClient = <span class="hljs-keyword">object</span> : WebViewClient() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageStarted</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?, favicon: <span class="hljs-type">Bitmap</span>?)</span></span> {
                <span class="hljs-keyword">super</span>.onPageStarted(view, url, favicon)
                startTime = System.currentTimeMillis()
            }
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageFinished</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?)</span></span> {
                <span class="hljs-keyword">super</span>.onPageFinished(view, url)
                <span class="hljs-keyword">val</span> loadTime = System.currentTimeMillis() - startTime
                recordMetric(MetricType.PAGE_LOAD_TIME, loadTime, mapOf(<span class="hljs-string">"url"</span> to (url ?: <span class="hljs-string">""</span>)))
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 监控 Bridge 调用时间
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">monitorBridgeCall</span><span class="hljs-params">(handlerName: <span class="hljs-type">String</span>, block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
        <span class="hljs-keyword">try</span> {
            block()
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">val</span> duration = System.currentTimeMillis() - startTime
            recordMetric(MetricType.BRIDGE_CALL_TIME, duration, mapOf(<span class="hljs-string">"handler"</span> to handlerName))
        }
    }
    
    <span class="hljs-comment">/**
     * 记录指标
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordMetric</span><span class="hljs-params">(type: <span class="hljs-type">MetricType</span>, value: <span class="hljs-type">Long</span>, context: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, Any&gt;? = <span class="hljs-literal">null</span>)</span></span> {
        metrics.add(PerformanceMetric(type, value, context = context))
        
        <span class="hljs-comment">// 如果指标过多，只保留最近 1000 条</span>
        <span class="hljs-keyword">if</span> (metrics.size &gt; <span class="hljs-number">1000</span>) {
            metrics.removeAt(<span class="hljs-number">0</span>)
        }
    }
    
    <span class="hljs-comment">/**
     * 获取性能报告
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPerformanceReport</span><span class="hljs-params">()</span></span>: PerformanceReport {
        <span class="hljs-keyword">val</span> pageLoadTimes = metrics.filter { it.type == MetricType.PAGE_LOAD_TIME }
        <span class="hljs-keyword">val</span> bridgeCallTimes = metrics.filter { it.type == MetricType.BRIDGE_CALL_TIME }
        
        <span class="hljs-keyword">return</span> PerformanceReport(
            avgPageLoadTime = pageLoadTimes.map { it.value }.average().toLong(),
            avgBridgeCallTime = bridgeCallTimes.map { it.value }.average().toLong(),
            totalMetrics = metrics.size
        )
    }
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceReport</span>(
        <span class="hljs-keyword">val</span> avgPageLoadTime: <span class="hljs-built_in">Long</span>,
        <span class="hljs-keyword">val</span> avgBridgeCallTime: <span class="hljs-built_in">Long</span>,
        <span class="hljs-keyword">val</span> totalMetrics: <span class="hljs-built_in">Int</span>
    )
}

<span class="hljs-comment">// ========== 使用示例 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> webView: WebView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> performanceMonitor: WebViewPerformanceMonitor
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        webView = findViewById(R.id.webview)
        
        <span class="hljs-comment">// 初始化性能监控</span>
        performanceMonitor = WebViewPerformanceMonitor(webView)
        performanceMonitor.monitorPageLoad()
        
        <span class="hljs-comment">// 监控 Bridge 调用</span>
        <span class="hljs-keyword">val</span> bridge = WebViewBridgeKt(webView)
        bridge.registerHandler(<span class="hljs-string">"test"</span>) { <span class="hljs-keyword">data</span>, callback -&gt;
            performanceMonitor.monitorBridgeCall(<span class="hljs-string">"test"</span>) {
                <span class="hljs-comment">// 处理逻辑</span>
                callback?.invoke(<span class="hljs-string">"success"</span>)
            }
        }
        
        webView.loadUrl(<span class="hljs-string">"https://example.com"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroy()
        <span class="hljs-comment">// 获取性能报告</span>
        <span class="hljs-keyword">val</span> report = performanceMonitor.getPerformanceReport()
        <span class="hljs-comment">// 性能日志，生产环境建议上报到服务器</span>
        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            Log.d(<span class="hljs-string">"Performance"</span>, <span class="hljs-string">"平均页面加载时间: <span class="hljs-subst">${report.avgPageLoadTime}</span>ms"</span>)
            Log.d(<span class="hljs-string">"Performance"</span>, <span class="hljs-string">"平均 Bridge 调用时间: <span class="hljs-subst">${report.avgBridgeCallTime}</span>ms"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-66">10.2 内存监控</h3>
<p><strong>Kotlin 实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * WebView 内存监控（简化版）
 */</span>
<span class="hljs-keyword">object</span> WebViewMemoryMonitor {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMemoryInfo</span><span class="hljs-params">()</span></span>: MemoryInfo {
        <span class="hljs-keyword">val</span> runtime = Runtime.getRuntime()
        <span class="hljs-keyword">val</span> usedMemory = runtime.totalMemory() - runtime.freeMemory()
        <span class="hljs-keyword">return</span> MemoryInfo(
            usedMemoryMB = usedMemory / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024.0</span>,
            maxMemoryMB = runtime.maxMemory() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024.0</span>
        )
    }
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryInfo</span>(
        <span class="hljs-keyword">val</span> usedMemoryMB: <span class="hljs-built_in">Double</span>,
        <span class="hljs-keyword">val</span> maxMemoryMB: <span class="hljs-built_in">Double</span>
    )
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isMemorySufficient</span><span class="hljs-params">(requiredMB: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> info = getMemoryInfo()
        <span class="hljs-keyword">return</span> (info.maxMemoryMB - info.usedMemoryMB) &gt;= requiredMB
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-67">十一、快速参考</h2>
<h3 data-id="heading-68">11.1 API 速查表</h3>
<h4 data-id="heading-69">JavaScript 调用 Android</h4>















































<table><thead><tr><th>方法</th><th>版本要求</th><th>特点</th><th>推荐度</th></tr></thead><tbody><tr><td><code>addJavascriptInterface</code></td><td>Android 4.2+</td><td>最简单直接</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><code>shouldOverrideUrlLoading</code></td><td>所有版本</td><td>安全性高</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>onJsPrompt</code></td><td>所有版本</td><td>可返回值</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><code>onJsAlert</code></td><td>所有版本</td><td>简单但功能有限</td><td>⭐⭐</td></tr><tr><td><code>onJsConfirm</code></td><td>所有版本</td><td>需要用户确认</td><td>⭐⭐</td></tr><tr><td><code>postMessage</code></td><td>Android 6.0+</td><td>官方推荐</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<h4 data-id="heading-70">Android 调用 JavaScript</h4>























<table><thead><tr><th>方法</th><th>版本要求</th><th>特点</th><th>推荐度</th></tr></thead><tbody><tr><td><code>evaluateJavascript</code></td><td>Android 4.4+</td><td>支持返回值</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><code>loadUrl</code></td><td>所有版本</td><td>兼容性好</td><td>⭐⭐⭐</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零实现 React Native（2）: 跨平台支持]]></title>    <link>https://juejin.cn/post/7594578555352989747</link>    <guid>https://juejin.cn/post/7594578555352989747</guid>    <pubDate>2026-01-13T11:21:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555352989747" data-draft-id="7594578555352973363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零实现 React Native（2）: 跨平台支持"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2026-01-13T11:21:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zerosrat"/> <meta itemprop="url" content="https://juejin.cn/user/1538972006230942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零实现 React Native（2）: 跨平台支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1538972006230942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zerosrat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T11:21:38.000Z" title="Tue Jan 13 2026 11:21:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>上一回：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzerosrat.dev%2Fn%2F2025%2Fmini-rn-1" target="_blank" title="https://zerosrat.dev/n/2025/mini-rn-1" ref="nofollow noopener noreferrer">从零实现 React Native（1）: 桥通信的原理与实现</a></p>
</blockquote>
<h2 data-id="heading-0">平台支持的取舍</h2>
<p>在上一篇《从零实现 React Native（1）: 桥通信的原理与实现》中，基于 <strong>macos</strong> 平台实现了 JS 与 Native 的双向桥通信，在本篇中将对其他平台进行支持，实现「write once，run anywhere」这个理念。</p>
<p>接下来便来进行 iOS 和 Android 平台的支持工作。</p>
<h3 data-id="heading-1">iOS 进展顺利</h3>
<p>在支持了 macos 端后，<strong>支持 iOS</strong> 是很容易的，可以马上着手来搞这个事情。得益于 Apple 生态带来的：macOS 和 iOS 都内置了 JavaScriptCore.framework，这意味着无需额外的引擎移植工作；且编程 API 很相似，这意味着差异化实现较少，大多可复用或类比实现。</p>
<p>事实上，我只花了<strong>半天时间</strong>就完成了 iOS 端的支持工作，其中主要的时间花在了构建配置的修改、测试示例的新增和调整，少部分时间花在了差异化的 <code>DeviceInfo</code> 模块实现。</p>
<p>得益于 Apple 生态，iOS 的支持工作中大部分代码都是复用的，<strong>复用率 90%</strong>。因为 macos 和 iOS 的 JSC API 一致，以及 C++ 语言的优势，可以用于跨端复用。复用的内容包含：</p>
<ul>
<li>JSCExector</li>
<li>Bridge 通信逻辑</li>
<li>模块注册逻辑</li>
</ul>
<h3 data-id="heading-2">Android 滑铁卢</h3>
<p>在顺利支持了 iOS 后，预想是 Android 的支持也不会太难，但实际做起来发现没这么简单。</p>
<p>记得是周末的午后的轻松下午，我先把 Android 的相关环境搭建好（包括 Android Studio、Java SDK 及其环境变量、NDK 等），然后进入 JSC 的移植工作。Why JSC 移植？因为不同于 Apple 生态，Android 系统是没有内置 JSC 引擎的。而正是这一步让我陷入泥潭。</p>
<p>我首先尝试了三方编译的版本，但是要么遇到了 libjsc.so（JSC 编译后的二进制文件，可供 Android 平台运行，可类比理解为前端的 wasm） 不支持 arm64（由于是 MBP 机器，安卓模拟器必须用 arm64 而非 x86 架构的），要么是遇到了 libjsc.so 和 NDK 版本不兼容。然后尝试了从社区提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freact-native-community%2Fjsc-android-buildscripts" target="_blank" title="https://github.com/react-native-community/jsc-android-buildscripts" ref="nofollow noopener noreferrer">jsc-android-buildscripts</a> 自行编译，也遇到了各种问题编译失败，考虑到每次编译时间：2-3 小时，这也是一个艰难的旅程。</p>
<p>就算解决了 JavaScriptCore，还有 JNI 在等着我。Java 和 C++ 之间的桥梁不是简单的函数调用。我要处理诸如：类型转换、线程同步等问题。前方有很多新的坑在等着我。</p>
<h3 data-id="heading-3">舍与得</h3>
<p>Maybe it's not the right time. 先理解核心，再扩展边界。先放下 Android 的支持，或许未来的某一天再回头来看这件事。</p>
<p>这个决定让我想起了 MVP（最小可行产品）的原则：先让核心功能跑通，再逐步完善。在学习项目中，这个原则同样适用——先掌握本质，再扩展边界。</p>
<p>既然决定专注于 iOS 和 macOS 双平台，那么接下来就需要一套优雅的构建系统来支撑跨平台开发。一个好的构建系统不仅能让开发者轻松切换平台，更重要的是，它能为后续的代码复用奠定基础。</p>
<h2 data-id="heading-4">构建系统的演进</h2>
<p>在上一篇博客中，受制于篇幅的限制，跳过了对构建系统的讲解。而在跨平台支持中，天然需要迭代构建系统，也正是对其展开讲讲的一个好时机。</p>
<h3 data-id="heading-5">Make 是什么</h3>
<p>Make 是一个诞生于 1976 年的构建工具，它的工作原理很简单：描述文件之间的依赖关系，然后只重新编译"变化过的"文件。</p>
<p>Make 适合于 <strong>需要多步骤构建流程</strong> 的项目，本项目的构建流程较为复杂：JS 产物打包 -&gt; CMake 配置 -&gt; C++ 产物编译 -&gt; 运行 test 代码，很适合引入 Make 进行任务流程的编排。</p>
<p>Make 工具的配套 <code>Makefile</code> 文件是一个<strong>文本配置文件</strong>，它定义了构建规则、依赖关系和执行命令，可以将其理解为 npm 和 package.json 的关系。</p>
<p>以下是基于 macos 编译和测试的 Makefile 文件摘要代码，核心步骤包含了 <code>js-build</code>, <code>configure</code>, <code>test</code>。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 变量定义 (Makefile 第 10-13 行)</span>
<span class="hljs-comment"># ============================================</span>
BUILD_DIR = build
CMAKE_BUILD_TYPE ?= Debug
CORES = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> sysctl -n hw.ncpu)</span>  <span class="hljs-comment"># 动态检测 CPU 核心数</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 主要构建目标 - 依赖链设计</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># 默认目标：make 等价于 make build</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all</span>
<span class="hljs-section">all: build</span>

<span class="hljs-comment"># 核心构建流程：js-build → configure → 实际编译</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: build</span>
<span class="hljs-section">build: js-build configure</span>
    @echo <span class="hljs-string">"🔨 Building Mini React Native..."</span>
    @cd <span class="hljs-variable">$(BUILD_DIR)</span> &amp;&amp; make -j<span class="hljs-variable">$(CORES)</span>
    @echo <span class="hljs-string">"✅ Build complete"</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 步骤 1：JavaScript 构建 (第 29-33 行)</span>
<span class="hljs-comment"># ============================================</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: js-build</span>
<span class="hljs-section">js-build:</span>
    @echo <span class="hljs-string">"📦 Building JavaScript bundle..."</span>
    @npm run build    <span class="hljs-comment"># 执行 rollup -c，生成 dist/bundle.js</span>
    @echo <span class="hljs-string">"✅ JavaScript bundle built"</span>

<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 步骤 2：CMake 配置 (第 22-26 行)</span>
<span class="hljs-comment"># ============================================</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: configure</span>
<span class="hljs-section">configure:</span>
    @echo <span class="hljs-string">"🔧 Configuring build system..."</span>
    @mkdir -p <span class="hljs-variable">$(BUILD_DIR)</span>
    @cd <span class="hljs-variable">$(BUILD_DIR)</span> &amp;&amp; cmake -DCMAKE_BUILD_TYPE=<span class="hljs-variable">$(CMAKE_BUILD_TYPE)</span> -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..
    @echo <span class="hljs-string">"✅ Configuration complete"</span>


<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 步骤 4：分层测试流程 (第 91-130 行)</span>
<span class="hljs-comment"># ============================================</span>

<span class="hljs-comment"># 完整测试：build → 4 个测试依次执行</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: test</span>
<span class="hljs-section">test: build</span>
    @echo <span class="hljs-string">"🧪 Running all tests..."</span>
    @echo <span class="hljs-string">"\n📝 Test 1: Basic functionality test"</span>
    @./<span class="hljs-variable">$(BUILD_DIR)</span>/mini_rn_test
    @echo <span class="hljs-string">"\n📝 Test 2: Module framework test"</span>
    @./<span class="hljs-variable">$(BUILD_DIR)</span>/test_module_framework
    @echo <span class="hljs-string">"\n📝 Test 3: Integration test"</span>
    @./<span class="hljs-variable">$(BUILD_DIR)</span>/test_integration
    @echo <span class="hljs-string">"\n📝 Test 4: Performance test"</span>
    @./<span class="hljs-variable">$(BUILD_DIR)</span>/test_performance
    @echo <span class="hljs-string">"\n✅ All tests complete"</span>

<span class="hljs-comment"># 单独的测试目标 - 允许细粒度测试</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: test-basic</span>
<span class="hljs-section">test-basic: build</span>
    @echo <span class="hljs-string">"🧪 Running basic functionality test..."</span>
    @./<span class="hljs-variable">$(BUILD_DIR)</span>/mini_rn_test

<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: test-performance</span>
<span class="hljs-section">test-performance: build</span>
    @echo <span class="hljs-string">"🧪 Running performance test..."</span>
    @./<span class="hljs-variable">$(BUILD_DIR)</span>/test_performance
</code></pre>
<p>在引入了 make 后，可以很方便的进行复杂流程的编排，例如我们想要运行测试代码时，实际的发生的事情如下所示。</p>
<pre><code class="hljs language-text" lang="text">用户命令: make test
    ↓
test: build
    ↓
build: js-build configure
        ↓             ↓
    js-build          configure
        ↓                   ↓
    npm run build       cmake ..
        ↓                   ↓
    dist/bundle.js      build/Makefile
                            ↓
                        make -j8 (CMake 管理的依赖)
                            ↓
                        libmini_react_native.a
                            ↓
                        mini_rn_test (等 4 个可执行文件)
</code></pre>
<p><strong>Before 引入 Make</strong>：想象一下，如果没有 Make，每次修改代码后你需要手动执行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 步骤1：构建 JavaScript</span>
npm run build

<span class="hljs-comment"># 步骤2：配置 CMake</span>
<span class="hljs-built_in">mkdir</span> -p build
<span class="hljs-built_in">cd</span> build &amp;&amp; cmake ..

<span class="hljs-comment"># 步骤3：编译 C++</span>
<span class="hljs-built_in">cd</span> build &amp;&amp; make -j8

<span class="hljs-comment"># 步骤4：运行测试</span>
./build/mini_rn_test
./build/test_module_framework
./build/test_integration
./build/test_performance
</code></pre>
<p>每次都要记住这么多命令，还要确保执行顺序正确。更糟糕的是，如果某个步骤失败了，你需要手动判断从哪里重新开始。</p>
<p><strong>After 引入 Make</strong>：<code>make test</code> 一条命令搞定所有事情</p>
<h3 data-id="heading-6">CMake 是什么</h3>
<p>在把 C++ 代码编译成二进制文件这一步之前，其实构建系统提前引入了 CMake 进行管理。CMake 不是“构建工具”，而是“构建系统的构建系统”，在这个场景中 CMake 实际上生成了编译代码的工具 Makefile 文件。CMake 会读取 <code>CMakeLists.txt</code>，然后生成原生的构建文件。</p>
<p>Why CMake？因为 mini-rn 项目开始之初就是要考虑多平台支持的，为了实现这个 feature，便会遇到 <strong>多平台构建的复杂性</strong> 这个问题。</p>
<p><strong>问题 1：平台特定源文件管理</strong></p>
<p>不同平台需要不同的实现：</p>
<ul>
<li>macOS：使用 <code>IOKit</code> 获取硬件信息</li>
<li>iOS：使用 <code>UIDevice</code> 获取设备信息</li>
</ul>
<p>没有 CMake 需要维护两套构建脚本，引入 CMake 后可通过条件编译一套配置搞定。</p>
<p><strong>问题 2：系统框架动态链接</strong></p>
<p>不同平台需要链接不同框架：macOS 需要 <code>IOKit</code>，iOS 需要 <code>UIKit</code>。</p>
<p>引入 CMake 后可自动检测并链接正确的框架。</p>
<p><strong>解决效果</strong></p>
<p><strong>引入 CMake 前</strong>：需要维护多套构建脚本，手动管理复杂配置，容易出错。</p>
<p><strong>引入 CMake 后</strong>：一套 <code>CMakeLists.txt</code> 支持所有平台，自动处理平台差异，大幅降低维护成本。</p>
<p><strong>CMake 关键语法解释</strong>：</p>
<ul>
<li><code>CMAKE_SYSTEM_NAME</code>：CMake 内置变量，表示目标系统名称（iOS、Darwin等）</li>
<li><code>find_library()</code>：在系统中查找指定的库文件</li>
<li><code>target_link_libraries()</code>：将库文件链接到目标可执行文件</li>
<li><code>set()</code>：设置变量的值</li>
<li><code>if(MATCHES)</code>：条件判断，支持正则表达式匹配</li>
</ul>
<h3 data-id="heading-7">改动一：Makefile 新增 iOS 构建目标</h3>
<p>在 macOS 的可扩展构建系统配置就绪后，接下来看看如何改动以支持 iOS。</p>
<p><strong>改动一实现了什么？</strong></p>
<p><strong>核心目标</strong>：在现有 Makefile 基础上，新增 iOS 平台的完整构建流程，实现"一套 Makefile，双平台支持"。</p>
<p><strong>具体实现</strong>：</p>
<ol>
<li><strong>新增 4 个 iOS 专用目标</strong>：<code>ios-configure</code>、<code>ios-build</code>、<code>ios-test</code>、<code>ios-test-deviceinfo</code></li>
<li><strong>建立 iOS 构建流程</strong>：js-build → ios-configure → ios-build → ios-test</li>
<li><strong>实现平台隔离</strong>：iOS 使用独立的 <code>build_ios/</code> 目录，与 macOS 的 <code>build/</code> 目录完全分离</li>
<li><strong>自动化 Xcode 环境配置</strong>：自动检测 SDK 路径、设置开发者目录、配置模拟器架构</li>
</ol>
<h4 data-id="heading-8">新增的 4 个 iOS 目标</h4>
<p>原本基于 macOS 的构建路径是：js-build → configure → build → test，现在为 iOS 新增了对应的平行路径：js-build → ios-configure → ios-build → ios-test。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># iOS 构建配置（模拟器）</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: ios-configure</span>
<span class="hljs-section">ios-configure:</span>
    @mkdir -p <span class="hljs-variable">$(BUILD_DIR)</span>_ios
    @cd <span class="hljs-variable">$(BUILD_DIR)</span>_ios &amp;&amp; DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer cmake \
        -DCMAKE_SYSTEM_NAME=iOS \
        -DCMAKE_OSX_ARCHITECTURES=$<span class="hljs-variable">$(uname -m)</span> \
        -DCMAKE_OSX_SYSROOT=$$(DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer xcrun --sdk iphonesimulator --show-sdk-path) \
        -DCMAKE_BUILD_TYPE=<span class="hljs-variable">$(CMAKE_BUILD_TYPE)</span> \
        -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
        ..

<span class="hljs-comment"># 构建 iOS 版本（模拟器）</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: ios-build</span>
<span class="hljs-section">ios-build: js-build ios-configure</span>
    @cd <span class="hljs-variable">$(BUILD_DIR)</span>_ios &amp;&amp; make -j<span class="hljs-variable">$(CORES)</span>

<span class="hljs-comment"># iOS 测试目标</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: ios-test</span>
<span class="hljs-section">ios-test: ios-build</span>
    @./test_ios.sh all

<span class="hljs-comment"># iOS DeviceInfo 测试</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: ios-test-deviceinfo</span>
<span class="hljs-section">ios-test-deviceinfo: ios-build</span>
    @./test_ios.sh deviceinfo
</code></pre>
<h4 data-id="heading-9">关键设计决策</h4>
<p><strong>1. 独立构建目录</strong></p>
<p>macOS 用 <code>build/</code>，iOS 用 <code>build_ios/</code>，互不干扰：</p>
<pre><code class="hljs language-makefile" lang="makefile">@mkdir -p <span class="hljs-variable">$(BUILD_DIR)</span>_ios   <span class="hljs-comment"># iOS 构建目录</span>
</code></pre>
<p><strong>2. 仅支持 iOS 模拟器</strong></p>
<p>为什么不支持真机？因为：</p>
<ul>
<li>真机需要开发者证书和配置文件</li>
<li>模拟器足够验证 Bridge 通信机制</li>
<li>降低环境配置复杂度</li>
</ul>
<pre><code class="hljs language-makefile" lang="makefile">-DCMAKE_OSX_SYSROOT=$<span class="hljs-variable">$(xcrun --sdk iphonesimulator --show-sdk-path)</span>
</code></pre>
<p><strong>3. 语义化命令</strong></p>
<p><code>make ios-configure</code> 比写一长串 CMake 命令简洁太多。这就是 Makefile 作为用户接口的价值。</p>
<h3 data-id="heading-10">改动二：CMake 平台条件编译</h3>
<p><strong>改动二实现了什么？</strong></p>
<p><strong>核心目标</strong>：让 CMake 能够智能识别目标平台，并自动选择正确的源文件和系统框架，实现"一套 CMakeLists.txt，智能适配双平台"。</p>
<p><strong>具体实现</strong>：</p>
<ol>
<li><strong>平台检测机制</strong>：通过 <code>CMAKE_SYSTEM_NAME</code> 变量自动识别是 macOS 还是 iOS</li>
<li><strong>源文件智能选择</strong>：根据平台自动选择对应的 <code>.mm</code> 实现文件</li>
<li><strong>框架动态链接</strong>：iOS 链接 UIKit，macOS 链接 IOKit，共享 JavaScriptCore 和 Foundation</li>
<li><strong>编译标志自动设置</strong>：为 Objective-C++ 文件自动设置 ARC 标志</li>
<li><strong>部署目标配置</strong>：iOS 设为 12.0+，macOS 设为 10.15+</li>
</ol>
<p><strong>设计精髓</strong>：编译时确定，运行时无开销。最终的 iOS 二进制文件中完全没有 macOS 代码，反之亦然。</p>
<h4 data-id="heading-11">原来的代码（仅 macOS）</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 原始版本 - 仅支持 macOS
if(APPLE)
    set(PLATFORM_SOURCES
        src/macos/modules/deviceinfo/DeviceInfoModule.mm
    )
    find_library(IOKIT_FRAMEWORK IOKit)
endif()

target_link_libraries(mini_react_native
    ${JAVASCRIPTCORE_FRAMEWORK}
    ${IOKIT_FRAMEWORK}
)
</code></pre>
<h4 data-id="heading-12">演进后的代码（macOS + iOS）</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 演进版本 - 支持 macOS + iOS
if(APPLE)
    # 根据具体平台选择源文件
    if(${CMAKE_SYSTEM_NAME} MATCHES "iOS")
        set(PLATFORM_SOURCES
            src/ios/modules/deviceinfo/DeviceInfoModule.mm
        )
    else()
        # macOS
        set(PLATFORM_SOURCES
            src/macos/modules/deviceinfo/DeviceInfoModule.mm
        )
    endif()

    # 平台特定框架
    if(${CMAKE_SYSTEM_NAME} MATCHES "iOS")
        find_library(UIKIT_FRAMEWORK UIKit)
        set(PLATFORM_FRAMEWORKS ${UIKIT_FRAMEWORK})
    else()
        find_library(IOKIT_FRAMEWORK IOKit)
        set(PLATFORM_FRAMEWORKS ${IOKIT_FRAMEWORK})
    endif()

    # 统一链接
    target_link_libraries(mini_react_native
        ${JAVASCRIPTCORE_FRAMEWORK}
        ${FOUNDATION_FRAMEWORK}
        ${PLATFORM_FRAMEWORKS}
    )
endif()
</code></pre>
<h4 data-id="heading-13">三个关键变化</h4>
<p><strong>1. 源文件分离</strong></p>
<pre><code class="hljs language-text" lang="text">src/
├── macos/modules/deviceinfo/DeviceInfoModule.mm
└── ios/modules/deviceinfo/DeviceInfoModule.mm
</code></pre>
<p>两个文件虽然文件名相同，但实现不同：</p>
<ul>
<li><strong>macOS 版本</strong>：用 IOKit 获取硬件信息</li>
<li><strong>iOS 版本</strong>：用 UIDevice 获取设备信息</li>
</ul>
<p><strong>2. 框架动态链接</strong></p>




















<table><thead><tr><th>平台</th><th>共享框架</th><th>平台特定框架</th></tr></thead><tbody><tr><td>macOS</td><td>JavaScriptCore, Foundation</td><td>IOKit</td></tr><tr><td>iOS</td><td>JavaScriptCore, Foundation</td><td>UIKit</td></tr></tbody></table>
<p><strong>3. 部署目标设置</strong></p>
<pre><code class="hljs language-cmake" lang="cmake">if(${CMAKE_SYSTEM_NAME} MATCHES "iOS")
    set(CMAKE_OSX_DEPLOYMENT_TARGET "12.0")
elseif(${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
    set(CMAKE_OSX_DEPLOYMENT_TARGET "10.15")
endif()
</code></pre>
<h3 data-id="heading-14">两个改动的协同作用</h3>
<p><strong>改动一 + 改动二 = 完美的跨平台构建系统</strong></p>
<p>这两个改动巧妙地分工合作：</p>
<ul>
<li><strong>Makefile（改动一）</strong>：作为用户接口层，提供简单统一的命令，隐藏平台配置的复杂性</li>
<li><strong>CMake（改动二）</strong>：作为构建逻辑层，智能处理平台差异，自动选择正确的源文件和框架</li>
</ul>
<p><strong>协同效果</strong>：</p>
<ol>
<li><strong>开发者体验</strong>：<code>make build</code> vs <code>make ios-build</code>，命令接口一致</li>
<li><strong>构建隔离</strong>：两个平台使用独立目录，可以并行构建，切换无需清理</li>
<li><strong>智能适配</strong>：CMake 根据 Makefile 传入的平台信息，自动配置所有细节</li>
<li><strong>零运行时开销</strong>：编译时就确定了平台，最终二进制文件纯净无冗余</li>
</ol>
<p>这种设计让跨平台支持变得既强大又优雅：开发者只需要记住两个命令，背后的所有复杂性都被自动化处理了。</p>
<h2 data-id="heading-15">DeviceInfo - 变与不变</h2>
<p>在构建系统演进完成后，我们来深入分析 DeviceInfo 模块的双平台实现。这个模块展示了跨平台架构设计的智慧：如何在保持接口统一的同时，让每个平台发挥自身优势。</p>
<h3 data-id="heading-16">90% 复用率是怎么做到的？</h3>
<p><strong>关键洞察：大部分逻辑其实是平台无关的</strong></p>
<p>仔细分析 DeviceInfo 模块，你会发现一个惊人的事实：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 这些逻辑在任何平台都一样</span>
<span class="hljs-function">std::string <span class="hljs-title">DeviceInfoModule::getName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">"DeviceInfo"</span>;
}

<span class="hljs-function">std::vector&lt;std::string&gt; <span class="hljs-title">DeviceInfoModule::getMethods</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"getUniqueId"</span>,       <span class="hljs-comment">// methodId = 0</span>
        <span class="hljs-string">"getSystemVersion"</span>,  <span class="hljs-comment">// methodId = 1</span>
        <span class="hljs-string">"getDeviceId"</span>        <span class="hljs-comment">// methodId = 2</span>
    };
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DeviceInfoModule::invoke</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; methodName,
                             <span class="hljs-type">const</span> std::string&amp; args, <span class="hljs-type">int</span> callId)</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (methodName == <span class="hljs-string">"getUniqueId"</span>) {
            std::string uniqueId = <span class="hljs-built_in">getUniqueIdImpl</span>();  <span class="hljs-comment">// 只是调用，不关心具体实现</span>
            <span class="hljs-built_in">sendSuccessCallback</span>(callId, uniqueId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">sendErrorCallback</span>(callId, <span class="hljs-string">"Unknown method: "</span> + methodName);
        }
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        <span class="hljs-built_in">sendErrorCallback</span>(callId, <span class="hljs-string">"Method invocation failed: "</span> + std::<span class="hljs-built_in">string</span>(e.<span class="hljs-built_in">what</span>()));
    }
}
</code></pre>
<p>**Bridge 通信协议、方法注册机制、消息分发逻辑，完全都是可以复用的！**真正不同的，只是那几个 <code>xxxImpl()</code> 方法的底层实现。</p>
<h3 data-id="heading-17">复用的边界</h3>
<p>但这里有个更深层的问题：<strong>为什么有些代码能 100% 复用，有些却完全不能？</strong></p>
<p>让我们看看实际的复用率统计：</p>








































<table><thead><tr><th>代码类型</th><th>复用率</th><th>为什么？</th></tr></thead><tbody><tr><td>Bridge 通信逻辑</td><td>100%</td><td>协议标准化</td></tr><tr><td>模块注册机制</td><td>100%</td><td>框架层抽象</td></tr><tr><td>错误处理机制</td><td>100%</td><td>异常处理逻辑相同</td></tr><tr><td>设备唯一标识</td><td>0%</td><td>平台理念完全不同</td></tr><tr><td>系统版本获取</td><td>95%</td><td>只有注释不同</td></tr><tr><td>设备型号获取</td><td>85%</td><td>都用 sysctlbyname，iOS多了模拟器判断</td></tr></tbody></table>
<h4 data-id="heading-18">100% 复用：协议的力量</h4>
<p><strong>为什么 Bridge 通信能 100% 复用？</strong></p>
<p>因为这是协议层，不管底层平台怎么变，JavaScript 和 Native 之间的通信协议是固定的。方法名、参数、回调 ID、错误处理这些都是标准化的。就像 HTTP 协议，不管服务器是 Linux 还是 Windows，浏览器都用同样的方式发请求。</p>
<h4 data-id="heading-19">0% 复用：平台的鸿沟</h4>
<p><strong>为什么设备唯一标识完全不能复用？</strong></p>
<p>macOS 追求真正的硬件级别唯一性，有复杂的降级机制；iOS 在 MVP 阶段采用了简化策略，每次启动生成新ID。这不是技术问题，而是：</p>
<ol>
<li><strong>平台哲学</strong>的差异：桌面 vs 移动的隐私理念</li>
<li><strong>开发策略</strong>的差异：完整实现 vs MVP验证</li>
</ol>
<h4 data-id="heading-20">复用边界的哲学</h4>
<p>通过 DeviceInfo 模块，我们发现了跨平台复用的三个层次：</p>
<ol>
<li><strong>协议层</strong>：100% 复用，因为标准统一</li>
<li><strong>API 层</strong>：看运气，苹果生态有优势</li>
<li><strong>实现层</strong>：看平台差异，移动端更复杂</li>
</ol>
<p>这揭示了一个残酷的真相：<strong>跨平台的成本永远存在，只是被转移了。</strong></p>
<p>可以用抽象基类隐藏差异，但差异本身不会消失。关键是找到合适的边界，让复用最大化，让差异最小化。</p>
<h3 data-id="heading-21">头文件的魔法</h3>
<p>解决方案其实就是基于 <strong>面向对象</strong> 的：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// common/modules/DeviceInfoModule.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DeviceInfoModule</span> : <span class="hljs-keyword">public</span> NativeModule {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">DeviceInfoModule</span>();
    ~<span class="hljs-built_in">DeviceInfoModule</span>() <span class="hljs-keyword">override</span> = <span class="hljs-keyword">default</span>;

    <span class="hljs-comment">// NativeModule 接口实现 - 所有平台共享</span>
    <span class="hljs-function">std::string <span class="hljs-title">getName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;
    <span class="hljs-function">std::vector&lt;std::string&gt; <span class="hljs-title">getMethods</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; methodName, <span class="hljs-type">const</span> std::string&amp; args,
                <span class="hljs-type">int</span> callId)</span> <span class="hljs-keyword">override</span></span>;

    <span class="hljs-comment">// 平台特定的实现接口 - 让各平台去填这些"洞"</span>
    <span class="hljs-function">std::string <span class="hljs-title">getUniqueIdImpl</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function">std::string <span class="hljs-title">getSystemVersionImpl</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function">std::string <span class="hljs-title">getDeviceIdImpl</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;

<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 工具方法</span>
    <span class="hljs-function">std::string <span class="hljs-title">createSuccessResponse</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; data)</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function">std::string <span class="hljs-title">createErrorResponse</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; error)</span> <span class="hljs-type">const</span></span>;
};
</code></pre>
<p>注意这里没有用虚函数，因为已经引入了 CMake 在编译时确定了对应平台的文件，不需要运行时多态，结果是 <strong>同一个头文件，不同的实现文件</strong>。每个平台都有自己的 <code>.mm</code> 文件来实现这些方法，编译时自动选择对应的实现。</p>
<p>基类定义了 what（做什么），各平台实现 how （怎么做）。Bridge 通信、方法注册、消息分发等这些复杂的逻辑只写一遍，所有平台自动继承。</p>
<h3 data-id="heading-22">分平台实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// macOS 实现 - src/macos/modules/deviceinfo/DeviceInfoModule.mm</span>
<span class="hljs-function">std::string <span class="hljs-title">DeviceInfoModule::getUniqueIdImpl</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
    @autoreleasepool {
        <span class="hljs-comment">// 尝试获取硬件 UUID</span>
        <span class="hljs-type">io_registry_entry_t</span> ioRegistryRoot =
            <span class="hljs-built_in">IORegistryEntryFromPath</span>(kIOMasterPortDefault, <span class="hljs-string">"IOService:/"</span>);
        CFStringRef uuidCf = (CFStringRef)<span class="hljs-built_in">IORegistryEntryCreateCFProperty</span>(
            ioRegistryRoot, <span class="hljs-built_in">CFSTR</span>(kIOPlatformUUIDKey), kCFAllocatorDefault, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">if</span> (uuidCf) {
            NSString* uuid = (__bridge NSString*)uuidCf;
            std::string result = [uuid UTF8String];
            <span class="hljs-built_in">CFRelease</span>(uuidCf);
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-comment">// 多层降级机制...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"macOS-"</span> + <span class="hljs-built_in">getDeviceIdImpl</span>() + <span class="hljs-string">"-"</span> + <span class="hljs-built_in">getSystemVersionImpl</span>();
    }
}

<span class="hljs-comment">// iOS 实现 - src/ios/modules/deviceinfo/DeviceInfoModule.mm</span>
<span class="hljs-function">std::string <span class="hljs-title">DeviceInfoModule::getUniqueIdImpl</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
    @autoreleasepool {
        <span class="hljs-comment">// iOS 简化实现：使用 NSUUID 生成唯一标识</span>
        <span class="hljs-comment">// 注意：这个实现每次启动都会生成新的ID，适用于MVP测试</span>
        NSUUID* uuid = [NSUUID UUID];
        NSString* uuidString = [uuid UUIDString];
        <span class="hljs-keyword">return</span> [uuidString UTF8String];
    }
}
</code></pre>
<p><strong>Objective-C++ 关键字解释</strong>：</p>
<ul>
<li><code>@autoreleasepool</code>：自动释放池，管理 Objective-C 对象的内存，确保及时释放</li>
<li><code>__bridge</code>：ARC（自动引用计数）中的桥接转换，在 C/C++ 指针和 Objective-C 对象间转换</li>
<li><code>[object method]</code>：Objective-C 的方法调用语法</li>
<li><code>.mm</code> 文件扩展名：表示 Objective-C++ 文件，可以混合使用 C++、C 和 Objective-C 代码</li>
</ul>
<p>两个平台的实现文件自动拥有了完整的 Bridge 通信能力，现在只需要实现平台差异部分即可~</p>
<h3 data-id="heading-23">应自动化尽自动化</h3>
<p>DeviceInfo 模块的自动化实现揭示了一个重要原则：</p>
<p><strong>好的跨平台架构不是让代码在所有平台都能跑，而是让正确的代码在正确的平台上跑。</strong></p>
<p>通过这个项目的三层自动化体系：</p>
<ol>
<li><strong>Makefile 自动化</strong>：统一的命令接口，隐藏平台配置复杂性</li>
<li><strong>CMake 自动化</strong>：智能的源文件选择和框架链接</li>
<li><strong>编译器自动化</strong>：平台特定的二进制生成</li>
</ol>
<p>这样的架构让开发者专注于业务逻辑，而把平台适配的复杂性交给了工具链。</p>
<p>真正的自动化不是写一份代码到处跑，而是：</p>
<ul>
<li><strong>开发体验统一</strong>：<code>make build</code> vs <code>make ios-build</code>，命令接口一致</li>
<li><strong>实现策略分离</strong>：每个平台有最适合的实现方式</li>
<li><strong>构建过程透明</strong>：开发者不需要关心 Xcode SDK 路径、编译标志等细节</li>
</ul>
<p>这种设计在面对更复杂的系统时依然有效：只要保持接口统一、实现分离、构建自动化，就能优雅地扩展到视图渲染、事件处理等更复杂的场景。</p>
<h2 data-id="heading-24">彩蛋</h2>
<p><strong>项目地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzerosrat%2Fmini-react-native" target="_blank" title="https://github.com/zerosrat/mini-react-native" ref="nofollow noopener noreferrer">github.com/zerosrat/mi…</a></p>
<p>当前项目中包含了本篇文章中的全部内容:</p>
<ul>
<li>✅ iOS 构建系统适配</li>
<li>✅ iOS 跨平台的差异化实现（DeviceInfo）</li>
</ul>
<p>完成本阶段后，项目已经具备了进入第三阶段的基础：<strong>视图渲染系统</strong>。</p>
<hr/>
<p>📝 本文首发于个人博客: <a href="https://link.juejin.cn?target=https%3A%2F%2Fzerosrat.dev%2Fn%2F2025%2Fmini-rn-2" target="_blank" title="https://zerosrat.dev/n/2025/mini-rn-2" ref="nofollow noopener noreferrer">zerosrat.dev/n/2025/mini…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AOSP 设置-提示音和振动 添加一个带有开关（Switch）的设置项]]></title>    <link>https://juejin.cn/post/7594351060615839763</link>    <guid>https://juejin.cn/post/7594351060615839763</guid>    <pubDate>2026-01-13T07:56:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594351060615839763" data-draft-id="7594627998839717930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AOSP 设置-提示音和振动 添加一个带有开关（Switch）的设置项"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-13T07:56:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="robotx"/> <meta itemprop="url" content="https://juejin.cn/user/3817944287025453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AOSP 设置-提示音和振动 添加一个带有开关（Switch）的设置项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817944287025453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    robotx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:56:12.000Z" title="Tue Jan 13 2026 07:56:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">要求</h2>
<p>如题，在设置-提示音和振动中添加一个带有开关（Switch）的设置项。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b560bc96a43408d951831ab92cdf13c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcm9ib3R4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768895772&amp;x-signature=fEvSuml0R8i%2F6mlFlSSFvR%2BBhsc%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs">要实现的效果：
1、能正常显示带有开关（Switch）的设置项
2、给这个开关设置默认属性
3、开关能正常使用（具体逻辑需要自己加）
</code></pre>
<h2 data-id="heading-1">步骤</h2>
<h3 data-id="heading-2">1、UI显示</h3>
<p>可以根据上方的“振动模式下一律显示振动图标”来定位要在哪里添加。</p>
<pre><code class="hljs language-xml" lang="xml">packages/apps/Settings/res/xml/sound_settings.xml

<span class="hljs-tag">&lt;<span class="hljs-name">SwitchPreferenceCompat</span>
        <span class="hljs-attr">android:key</span>=<span class="hljs-string">"top_paddle_control_volume"</span>
        <span class="hljs-attr">android:title</span>=<span class="hljs-string">"@string/top_paddle_control_volume_title"</span>
        <span class="hljs-attr">android:order</span>=<span class="hljs-string">"-25"</span>
        <span class="hljs-attr">settings:controller</span>=<span class="hljs-string">"com.android.settings.notification.TopPaddleVolumePreferenceController"</span>/&gt;</span>
</code></pre>
<p>只要加上上面这段xml代码就能在设置中显示了，一开始可以不加<code>settings:controller</code>这个配置，也会正常显示的，只是没有功能，纯UI。后续TopPaddleVolumePreferenceController是需要自己加的。</p>
<h3 data-id="heading-3">2、定义对应的controller</h3>
<p>要给这个switch开关定义一个controller来控制开关</p>
<pre><code class="hljs language-java" lang="java">packages/apps/Settings/src/com/android/settings/notification/TopPaddleVolumePreferenceController.java

<span class="hljs-keyword">package</span> com.android.settings.notification;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.android.settings.notification.SettingPref.TYPE_SECURE;

<span class="hljs-keyword">import</span> android.content.Context;
<span class="hljs-keyword">import</span> android.provider.Settings.Secure;

<span class="hljs-keyword">import</span> com.android.settings.SettingsPreferenceFragment;
<span class="hljs-keyword">import</span> com.android.settings.core.TogglePreferenceController;
<span class="hljs-keyword">import</span> com.android.settings.R;
<span class="hljs-keyword">import</span> com.android.settingslib.core.lifecycle.Lifecycle;

<span class="hljs-keyword">import</span> android.provider.Settings;
<span class="hljs-keyword">import</span> android.util.Log;

<span class="hljs-comment">// public class TopPaddleVolumePreferenceController  extends SettingPrefController {</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopPaddleVolumePreferenceController</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TogglePreferenceController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TopPaddleVolumePreferenceController"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOP_PADDLE_CONTROL_VOLUME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"top_paddle_control_volume"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TopPaddleVolumePreferenceController</span><span class="hljs-params">(Context context, String preferenceKey)</span> {
        <span class="hljs-built_in">super</span>(context, preferenceKey);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isChecked</span><span class="hljs-params">()</span> {
        Log.d(TAG, <span class="hljs-string">"ENTER isChecked()"</span>);
        <span class="hljs-comment">// Read database status, default 0 (off)</span>
        <span class="hljs-keyword">return</span> Settings.System.getInt(mContext.getContentResolver(),
            TOP_PADDLE_CONTROL_VOLUME, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 经过测试，这里的TOP_PADDLE_CONTROL_VOLUME也可以替换成Settings.System.TOP_PADDLE_CONTROL_VOLUME</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setChecked</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isChecked)</span> {
        Log.d(TAG, <span class="hljs-string">"isChecked = "</span>+isChecked);
        <span class="hljs-comment">// Write database status</span>
        <span class="hljs-keyword">return</span> Settings.System.putInt(mContext.getContentResolver(),
            TOP_PADDLE_CONTROL_VOLUME, isChecked ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);
        <span class="hljs-comment">// 经过测试，这里的TOP_PADDLE_CONTROL_VOLUME也可以替换成Settings.System.TOP_PADDLE_CONTROL_VOLUME</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAvailabilityStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> AVAILABLE;
    }

    <span class="hljs-comment">/**
     * 修复错误：覆盖 TogglePreferenceController 中的抽象方法
     * 该方法用于在搜索结果中高亮显示菜单路径
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSliceHighlightMenuRes</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 因为你在 sound_settings.xml 中添加，所以指向声音菜单</span>
        <span class="hljs-keyword">return</span> R.string.menu_key_sound; 
    }
}

</code></pre>
<h3 data-id="heading-4">3、数据初始化</h3>
<p>需要给这个设置项定义一个变量A，对吧，点击开关时实际就是修改这个变量A的值。而且还需要给这个变量A初始化一个值，0或者1，规定这个开关是默认开还是默认关</p>
<h4 data-id="heading-5">3.1 定义switch开关的初始值</h4>
<pre><code class="hljs language-java" lang="java">frameworks\base\core\java\android\provider\Settings.java

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">System</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NameValueTable</span> {
    <span class="hljs-comment">/**
     * Whether keyboard vibration feedback is enabled. The value is boolean (1 or 0).
     *
     * <span class="hljs-doctag">@hide</span>
     */</span>
    <span class="hljs-meta">@hide</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEYBOARD_VIBRATION_ENABLED</span> <span class="hljs-operator">=</span> <span class="hljs-string">"keyboard_vibration_enabled"</span>;
    
这样就是定义了一个变量了，相当于数据库的key，后面切换开关时修改的就是这个key。
其中<span class="hljs-meta">@hide</span>和<span class="hljs-meta">@hide</span>我看其它的变量也有，我也对应着加上了，反正如果你没有<span class="hljs-meta">@hide</span>编译会报错。
</code></pre>
<h3 data-id="heading-6"><code>注意：你定义的这个KEYBOARD_VIBRATION_ENABLED是放在class System还是class Secure中很重要的。我一开始是没注意，定义在了class Secure，但是绑定初始值时用的Settings.System.TOP_PADDLE_CONTROL_VOLUME，结果就报错了，这里注意。</code></h3>
<h4 data-id="heading-7">3.2 定义switch开关的默认值</h4>
<p>这个默认值其实不用定义，在初始值赋值的时候可以直接给个0或者1，但是这里为了代码的规范化，咱们还是定义一下。</p>
<pre><code class="hljs language-xml" lang="xml">frameworks\base\packages\SettingsProvider\res\values\defaults.xml

<span class="hljs-comment">&lt;!--cmy add, Top paddle control volume, default: false --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bool</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"def_top_paddle_control_volume"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">bool</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">3.3 绑定初始值</h4>
<pre><code class="hljs language-java" lang="java">frameworks\base\packages\SettingsProvider\src\com\android\providers\settings\DatabaseHelper.java

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadSystemSettings</span><span class="hljs-params">(SQLiteDatabase db)</span> {
    <span class="hljs-comment">// cmy add</span>
    loadBooleanSetting(stmt, Settings.System.TOP_PADDLE_CONTROL_VOLUME,
        R.bool.def_top_paddle_control_volume);
</code></pre>
<hr/>
<p>这样修改完，然后编译刷机，就能看到switch开关被打开了，因为绑定的默认值def_top_paddle_control_volume是true。</p>
<h2 data-id="heading-9">查看变量值的adb命令</h2>
<pre><code class="hljs language-shell" lang="shell">adb shell settings get system top_paddle_control_volume

这里是get system，这个system可能跟你定义变量的位置有关，前面说的，看你的变量是定义在class System还是class Secure
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RecyclerView 完全指南]]></title>    <link>https://juejin.cn/post/7594396368174874659</link>    <guid>https://juejin.cn/post/7594396368174874659</guid>    <pubDate>2026-01-13T06:49:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594396368174874659" data-draft-id="7594402344617148431" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RecyclerView 完全指南"/> <meta itemprop="keywords" content="前端,面试,Android"/> <meta itemprop="datePublished" content="2026-01-13T06:49:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青莲843"/> <meta itemprop="url" content="https://juejin.cn/user/541408646929991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RecyclerView 完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/541408646929991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青莲843
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T06:49:31.000Z" title="Tue Jan 13 2026 06:49:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基础概念</h2>
<h3 data-id="heading-1">1.1 什么是 RecyclerView？</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 是 Android 提供的一个用于高效显示大量数据集合的视图组件。它是 ListView 的升级版本，提供了更灵活、更强大的功能。</p>
<p><strong>主要作用：</strong></p>
<ol>
<li><strong>显示列表数据</strong>：以列表、网格或瀑布流的形式展示数据</li>
<li><strong>视图复用</strong>：通过 ViewHolder 模式复用视图，提高性能</li>
<li><strong>灵活布局</strong>：支持多种布局方式（线性、网格、瀑布流等）</li>
<li><strong>动画支持</strong>：内置动画支持，可以轻松实现增删改动画</li>
</ol>
<p><strong>基本使用示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 布局文件</span>
&lt;androidx.recyclerview.widget.RecyclerView
    android:id=<span class="hljs-string">"@+id/recyclerView"</span>
    android:layout_width=<span class="hljs-string">"match_parent"</span>
    android:layout_height=<span class="hljs-string">"match_parent"</span> /&gt;

<span class="hljs-comment">// Activity 中</span>
<span class="hljs-keyword">val</span> recyclerView = findViewById&lt;RecyclerView&gt;(R.id.recyclerView)
recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
recyclerView.adapter = MyAdapter(dataList)
</code></pre>
<hr/>
<h3 data-id="heading-2">1.2 RecyclerView 与 ListView 的区别</h3>
<p><strong>答案：</strong></p>
<p>这是面试中的高频题目，需要从多个维度进行对比：</p>













































<table><thead><tr><th>对比项</th><th>RecyclerView</th><th>ListView</th></tr></thead><tbody><tr><td><strong>布局管理</strong></td><td>通过 LayoutManager 支持多种布局（线性、网格、瀑布流）</td><td>仅支持垂直列表布局</td></tr><tr><td><strong>ViewHolder</strong></td><td>强制使用 ViewHolder 模式</td><td>支持但不强制</td></tr><tr><td><strong>动画支持</strong></td><td>内置 ItemAnimator，支持增删改动画</td><td>需要手动实现动画</td></tr><tr><td><strong>分割线</strong></td><td>通过 ItemDecoration 灵活添加</td><td>通过 divider 属性简单设置</td></tr><tr><td><strong>性能</strong></td><td>多级缓存机制，性能更优</td><td>缓存机制相对简单</td></tr><tr><td><strong>灵活性</strong></td><td>高度可定制，支持自定义 LayoutManager</td><td>定制性较差</td></tr><tr><td><strong>点击事件</strong></td><td>需要手动实现</td><td>内置 onItemClickListener</td></tr></tbody></table>
<p><strong>代码对比示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ListView：内置点击事件</span>
listView.setOnItemClickListener { ... }

<span class="hljs-comment">// RecyclerView：需要手动实现点击事件</span>
recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
recyclerView.adapter = MyAdapter(<span class="hljs-keyword">data</span>)
</code></pre>
<p><strong>为什么 RecyclerView 更好？</strong></p>
<ol>
<li><strong>性能更优</strong>：多级缓存机制，滑动更流畅</li>
<li><strong>更灵活</strong>：可以轻松切换不同的布局方式</li>
<li><strong>更现代</strong>：Google 推荐使用，ListView 已不再更新</li>
</ol>
<hr/>
<h3 data-id="heading-3">1.3 RecyclerView 的四大核心组件</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 的四大核心组件是：</p>
<ol>
<li><strong>RecyclerView</strong>：容器本身，负责显示和管理子视图</li>
<li><strong>Adapter</strong>：数据适配器，负责将数据绑定到视图</li>
<li><strong>LayoutManager</strong>：布局管理器，负责子视图的排列方式</li>
<li><strong>ViewHolder</strong>：视图持有者，缓存视图引用，提高性能</li>
</ol>
<p><strong>组件关系图：</strong></p>
<pre><code class="hljs language-scss" lang="scss">RecyclerView (容器)
    ├── LayoutManager (决定如何排列)
    ├── Adapter (决定显示什么数据)
    │   └── ViewHolder (缓存视图引用)
    └── ItemAnimator (动画效果，可选)
</code></pre>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> recyclerView = findViewById&lt;RecyclerView&gt;(R.id.recyclerView)
recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)  <span class="hljs-comment">// LayoutManager</span>
recyclerView.adapter = MyAdapter(dataList)               <span class="hljs-comment">// Adapter</span>
recyclerView.itemAnimator = DefaultItemAnimator()       <span class="hljs-comment">// ItemAnimator（可选）</span>
<span class="hljs-comment">// ViewHolder 在 Adapter 中创建</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">二、ViewHolder 机制</h2>
<h3 data-id="heading-5">2.1 什么是 ViewHolder？</h3>
<p><strong>答案：</strong></p>
<p>ViewHolder 模式是一种设计模式，用于缓存视图组件的引用，避免重复调用 <code>findViewById()</code>，从而提高列表滚动的性能。</p>
<p><strong>核心思想：</strong></p>
<ul>
<li>将视图引用存储在 ViewHolder 中</li>
<li>视图创建时查找一次，后续直接复用</li>
<li>减少 findViewById 的调用次数</li>
</ul>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：每次都调用 findViewById</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">val</span> textView = holder.itemView.findViewById&lt;TextView&gt;(R.id.textView)
    textView.text = items[position]  <span class="hljs-comment">// 性能差</span>
}

<span class="hljs-comment">// ✅ 正确：在 ViewHolder 中缓存引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)  <span class="hljs-comment">// 只查找一次</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    holder.textView.text = items[position]  <span class="hljs-comment">// 直接使用，性能好</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-6">2.2 ViewHolder 的优势</h3>
<p><strong>答案：</strong></p>
<p>ViewHolder 机制的优势主要体现在性能提升上：</p>
<p><strong>1. 减少 findViewById 调用</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不使用 ViewHolder：每次绑定都调用 findViewById</span>
<span class="hljs-comment">// 假设有 1000 个 item，每个 item 有 5 个 View</span>
<span class="hljs-comment">// 需要调用 findViewById 5000 次！</span>

<span class="hljs-comment">// 使用 ViewHolder：只在创建时调用一次</span>
<span class="hljs-comment">// 1000 个 item，每个 item 有 5 个 View</span>
<span class="hljs-comment">// 只需要调用 findViewById 5000 次（创建时），但可以复用！</span>
</code></pre>
<p><strong>2. 减少内存分配</strong></p>
<ul>
<li>视图引用被缓存，不需要重复创建</li>
<li>减少 GC（垃圾回收）压力</li>
</ul>
<p><strong>3. 提高滑动流畅度</strong></p>
<ul>
<li>findViewById 是耗时操作</li>
<li>减少调用次数，滑动更流畅</li>
<li>避免在滑动时频繁查找视图</li>
</ul>
<p><strong>性能对比示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 性能测试代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceTest</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testWithoutViewHolder</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.1000</span>) {
            <span class="hljs-keyword">val</span> textView = view.findViewById&lt;TextView&gt;(R.id.textView) <span class="hljs-comment">// 耗时</span>
        }
        <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
        println(<span class="hljs-string">"不使用 ViewHolder: <span class="hljs-subst">${endTime - startTime}</span>ms"</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testWithViewHolder</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> holder = ViewHolder(view)
        <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span><span class="hljs-number">.1000</span>) {
            holder.textView.text = <span class="hljs-string">"text"</span> <span class="hljs-comment">// 直接使用，快速</span>
        }
        <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
        println(<span class="hljs-string">"使用 ViewHolder: <span class="hljs-subst">${endTime - startTime}</span>ms"</span>)
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">2.3 如何创建自定义 ViewHolder</h3>
<p><strong>答案：</strong></p>
<p>创建自定义 ViewHolder 的步骤：</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ViewHolder：缓存视图引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">MyData</span>)</span></span> {
        textView.text = <span class="hljs-keyword">data</span>.text
    }
}

<span class="hljs-comment">// Adapter：使用 ViewHolder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;MyData&gt;) : 
    RecyclerView.Adapter&lt;MyViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: MyViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> MyViewHolder(view)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">MyViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.bind(items[position])
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span> = items.size
}
</code></pre>
<hr/>
<h2 data-id="heading-8">三、Adapter</h2>
<h3 data-id="heading-9">3.1 Adapter 必须实现哪些方法</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView.Adapter 必须实现三个核心方法：</p>
<p><strong>1. onCreateViewHolder()</strong> - 创建 ViewHolder</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
    <span class="hljs-comment">// 创建并返回 ViewHolder</span>
}
</code></pre>
<p><strong>2. onBindViewHolder()</strong> - 绑定数据到 ViewHolder</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// 将数据绑定到 ViewHolder 的视图上</span>
}
</code></pre>
<p><strong>3. getItemCount()</strong> - 返回数据总数</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-comment">// 返回数据列表的大小</span>
}
</code></pre>
<p><strong>完整示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;String&gt;) : 
    RecyclerView.Adapter&lt;SimpleAdapter.ViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_simple, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> ViewHolder(view)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.textView.text = items[position]
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span> = items.size
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)
    }
}
</code></pre>
<p><strong>方法调用时机：</strong></p>
<ul>
<li><code>onCreateViewHolder()</code>：当需要创建新的 ViewHolder 时调用（视图复用池中没有可用的）</li>
<li><code>onBindViewHolder()</code>：当需要将数据绑定到 ViewHolder 时调用（每次显示 item 时）</li>
<li><code>getItemCount()</code>：RecyclerView 需要知道有多少个 item 时调用</li>
</ul>
<hr/>
<h3 data-id="heading-10">3.2 onCreateViewHolder 和 onBindViewHolder 的区别</h3>
<p><strong>答案：</strong></p>
<p>这两个方法在 RecyclerView 中扮演不同的角色：</p>






























<table><thead><tr><th>对比项</th><th>onCreateViewHolder</th><th>onBindViewHolder</th></tr></thead><tbody><tr><td><strong>调用时机</strong></td><td>创建新的 ViewHolder 时</td><td>绑定数据到 ViewHolder 时</td></tr><tr><td><strong>调用频率</strong></td><td>较少（只在需要新 ViewHolder 时）</td><td>频繁（每次显示 item 时）</td></tr><tr><td><strong>主要作用</strong></td><td>创建视图和 ViewHolder</td><td>更新视图内容</td></tr><tr><td><strong>性能影响</strong></td><td>影响创建性能</td><td>影响滚动性能</td></tr></tbody></table>
<p><strong>详细说明：</strong></p>
<p><strong>onCreateViewHolder()</strong> - 创建阶段</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
    <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
        .inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
    <span class="hljs-keyword">return</span> ViewHolder(view)  <span class="hljs-comment">// 只在需要新 ViewHolder 时调用</span>
}
</code></pre>
<p><strong>onBindViewHolder()</strong> - 绑定阶段</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    holder.textView.text = items[position]  <span class="hljs-comment">// 每次显示 item 时调用</span>
}
</code></pre>
<p><strong>性能优化建议：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ onCreateViewHolder：做一次性初始化</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(...)</span></span>: ViewHolder {
    <span class="hljs-keyword">return</span> ViewHolder(...)
}

<span class="hljs-comment">// ✅ onBindViewHolder：只更新数据，不做耗时操作</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    holder.textView.text = items[position]
    <span class="hljs-comment">// ❌ 不要做复杂计算或网络请求</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-11">3.3 如何实现点击事件</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 不像 ListView 那样有内置的点击监听器，需要手动实现。有几种方式：</p>
<p><strong>方式 1：使用 Lambda（推荐）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;String&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onItemClick: (String) -&gt; <span class="hljs-built_in">Unit</span>
) : RecyclerView.Adapter&lt;MyAdapter.ViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.textView.text = items[position]
        holder.itemView.setOnClickListener {
            onItemClick(items[position])
        }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> adapter = MyAdapter(dataList) { item -&gt;
    Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"点击: <span class="hljs-variable">$item</span>"</span>, Toast.LENGTH_SHORT).show()
}
</code></pre>
<p><strong>方式 3：长按事件</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;String&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onItemClick: (<span class="hljs-built_in">Int</span>, String) -&gt; <span class="hljs-built_in">Unit</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onItemLongClick: (<span class="hljs-built_in">Int</span>, String) -&gt; <span class="hljs-built_in">Boolean</span> = { _, _ -&gt; <span class="hljs-literal">false</span> }
) : RecyclerView.Adapter&lt;MyAdapter.ViewHolder&gt;() {
    
    <span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">String</span>, position: <span class="hljs-type">Int</span>)</span></span> {
            itemView.setOnClickListener {
                onItemClick(position, item)
            }
            itemView.setOnLongClickListener {
                onItemLongClick(position, item)
            }
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-12">3.4 如何实现多类型视图</h3>
<p><strong>答案：</strong></p>
<p>多类型视图是指在一个 RecyclerView 中显示不同类型的 item 布局。</p>
<p><strong>实现步骤：</strong></p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 定义视图类型</span>
<span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_HEADER = <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_ITEM = <span class="hljs-number">1</span>
}

<span class="hljs-comment">// 2. 返回视图类型</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemViewType</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (position == <span class="hljs-number">0</span>) TYPE_HEADER <span class="hljs-keyword">else</span> TYPE_ITEM
}

<span class="hljs-comment">// 3. 根据类型创建 ViewHolder</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (viewType) {
        TYPE_HEADER -&gt; HeaderViewHolder(...)
        TYPE_ITEM -&gt; ItemViewHolder(...)
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException()
    }
}

<span class="hljs-comment">// 4. 绑定数据</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">when</span> (holder) {
        <span class="hljs-keyword">is</span> HeaderViewHolder -&gt; holder.bind(...)
        <span class="hljs-keyword">is</span> ItemViewHolder -&gt; holder.bind(...)
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-13">3.5 notifyDataSetChanged() 的优缺点</h3>
<p><strong>答案：</strong></p>
<p><code>notifyDataSetChanged()</code> 是最简单的数据更新方法，但存在明显的性能问题。</p>
<p><strong>优点：</strong></p>
<ol>
<li><strong>使用简单</strong>：一行代码即可刷新整个列表</li>
<li><strong>无需计算</strong>：不需要知道具体哪些数据变化了</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li><strong>性能差</strong>：会刷新所有可见的 item，即使数据没有变化</li>
<li><strong>丢失动画</strong>：无法显示增删改的动画效果</li>
<li><strong>用户体验差</strong>：可能导致闪烁、滚动位置丢失等问题</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不推荐：刷新所有 item</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateData</span><span class="hljs-params">(newItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    items.clear()
    items.addAll(newItems)
    notifyDataSetChanged()  <span class="hljs-comment">// 性能差，刷新所有</span>
}

<span class="hljs-comment">// ✅ 推荐：局部更新</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(item: <span class="hljs-type">String</span>)</span></span> {
    items.add(item)
    notifyItemInserted(items.size - <span class="hljs-number">1</span>)  <span class="hljs-comment">// 只刷新新增的</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span> {
    items.removeAt(position)
    notifyItemRemoved(position)  <span class="hljs-comment">// 只刷新删除的</span>
}
</code></pre>
<p><strong>性能对比：</strong></p>
<ul>
<li><code>notifyDataSetChanged()</code>：刷新所有 item，耗时约 100ms（1000 个 item）</li>
<li><code>notifyItemChanged(5)</code>：只刷新第 5 个 item，耗时约 1ms</li>
</ul>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 使用 DiffUtil（推荐）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">MyAdapter.ViewHolder</span>&gt;() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items = mutableListOf&lt;String&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateData</span><span class="hljs-params">(newItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        <span class="hljs-keyword">val</span> diffResult = DiffUtil.calculateDiff(
            MyDiffCallback(items, newItems)
        )
        items = newItems.toMutableList()
        diffResult.dispatchUpdatesTo(<span class="hljs-keyword">this</span>) <span class="hljs-comment">// 智能更新，性能最优</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-14">四、LayoutManager</h2>
<h3 data-id="heading-15">4.1 LayoutManager 的作用</h3>
<p><strong>答案：</strong></p>
<p>LayoutManager 负责决定 RecyclerView 中的 item 如何排列和显示。</p>
<p><strong>主要职责：</strong></p>
<ol>
<li><strong>测量子视图</strong>：计算每个 item 的大小</li>
<li><strong>布局子视图</strong>：决定每个 item 的位置</li>
<li><strong>回收视图</strong>：管理视图的回收和复用</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> recyclerView = findViewById&lt;RecyclerView&gt;(R.id.recyclerView)

<span class="hljs-comment">// LinearLayoutManager - 线性布局（垂直或水平）</span>
recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>) <span class="hljs-comment">// 默认垂直</span>
recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>, LinearLayoutManager.HORIZONTAL, <span class="hljs-literal">false</span>) <span class="hljs-comment">// 水平</span>

<span class="hljs-comment">// GridLayoutManager - 网格布局</span>
recyclerView.layoutManager = GridLayoutManager(<span class="hljs-keyword">this</span>, <span class="hljs-number">3</span>) <span class="hljs-comment">// 3 列</span>

<span class="hljs-comment">// StaggeredGridLayoutManager - 瀑布流布局</span>
recyclerView.layoutManager = StaggeredGridLayoutManager(<span class="hljs-number">2</span>, StaggeredGridLayoutManager.VERTICAL) <span class="hljs-comment">// 2 列垂直</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">4.2 支持哪些 LayoutManager</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 内置了三种常用的 LayoutManager：</p>
<p><strong>1. LinearLayoutManager - 线性布局</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 垂直列表（默认）</span>
<span class="hljs-keyword">val</span> linearLayoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
recyclerView.layoutManager = linearLayoutManager

<span class="hljs-comment">// 水平列表</span>
<span class="hljs-keyword">val</span> horizontalLayoutManager = LinearLayoutManager(
    <span class="hljs-keyword">this</span>, 
    LinearLayoutManager.HORIZONTAL, 
    <span class="hljs-literal">false</span>
)
recyclerView.layoutManager = horizontalLayoutManager

<span class="hljs-comment">// 反向列表</span>
<span class="hljs-keyword">val</span> reverseLayoutManager = LinearLayoutManager(
    <span class="hljs-keyword">this</span>, 
    LinearLayoutManager.VERTICAL, 
    <span class="hljs-literal">true</span> <span class="hljs-comment">// 反向</span>
)
recyclerView.layoutManager = reverseLayoutManager
</code></pre>
<p><strong>2. GridLayoutManager - 网格布局</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 2 列网格</span>
<span class="hljs-keyword">val</span> gridLayoutManager = GridLayoutManager(<span class="hljs-keyword">this</span>, <span class="hljs-number">2</span>)
recyclerView.layoutManager = gridLayoutManager

<span class="hljs-comment">// 3 列网格，支持不同 item 占不同列数</span>
<span class="hljs-keyword">val</span> spanSizeLookup = <span class="hljs-keyword">object</span> : GridLayoutManager.SpanSizeLookup() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSpanSize</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (position) {
            <span class="hljs-number">0</span> -&gt; <span class="hljs-number">3</span> <span class="hljs-comment">// 第一个 item 占 3 列（全宽）</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-number">1</span> <span class="hljs-comment">// 其他 item 占 1 列</span>
        }
    }
}
gridLayoutManager.spanSizeLookup = spanSizeLookup
</code></pre>
<p><strong>3. StaggeredGridLayoutManager - 瀑布流布局</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 2 列垂直瀑布流</span>
<span class="hljs-keyword">val</span> staggeredLayoutManager = StaggeredGridLayoutManager(
    <span class="hljs-number">2</span>, <span class="hljs-comment">// 列数</span>
    StaggeredGridLayoutManager.VERTICAL <span class="hljs-comment">// 方向</span>
)
recyclerView.layoutManager = staggeredLayoutManager

<span class="hljs-comment">// 3 行水平瀑布流</span>
<span class="hljs-keyword">val</span> horizontalStaggered = StaggeredGridLayoutManager(
    <span class="hljs-number">3</span>, <span class="hljs-comment">// 行数</span>
    StaggeredGridLayoutManager.HORIZONTAL <span class="hljs-comment">// 方向</span>
)
recyclerView.layoutManager = horizontalStaggered
</code></pre>
<p><strong>布局效果对比：</strong></p>
<pre><code class="hljs language-scss" lang="scss">LinearLayoutManager (垂直):
┌─────┐
│  <span class="hljs-number">1</span>  │
├─────┤
│  <span class="hljs-number">2</span>  │
├─────┤
│  <span class="hljs-number">3</span>  │
└─────┘

GridLayoutManager (<span class="hljs-number">2</span>列):
┌─────┬─────┐
│  <span class="hljs-number">1</span>  │  <span class="hljs-number">2</span>  │
├─────┼─────┤
│  <span class="hljs-number">3</span>  │  <span class="hljs-number">4</span>  │
└─────┴─────┘

StaggeredGridLayoutManager (<span class="hljs-number">2</span>列):
┌─────┬─────┐
│  <span class="hljs-number">1</span>  │  <span class="hljs-number">2</span>  │
│     ├─────┤
│     │  <span class="hljs-number">3</span>  │
├─────┤     │
│  <span class="hljs-number">4</span>  │     │
└─────┴─────┘
</code></pre>
<hr/>
<h2 data-id="heading-17">五、缓存机制</h2>
<h3 data-id="heading-18">5.1 RecyclerView 的缓存机制</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 采用四级缓存机制，这是其高性能的核心。</p>
<p><strong>四级缓存结构：</strong></p>
<pre><code class="hljs">RecyclerView 缓存机制
├── 一级缓存：mAttachedScrap（屏幕内缓存）
├── 二级缓存：mCachedViews（屏幕外缓存）
├── 三级缓存：ViewCacheExtension（自定义缓存，可选）
└── 四级缓存：RecycledViewPool（回收池）
</code></pre>
<p><strong>详细说明：</strong></p>
<p><strong>1. 一级缓存（mAttachedScrap）</strong></p>
<ul>
<li><strong>作用</strong>：存储当前屏幕内可见的 ViewHolder</li>
<li><strong>特点</strong>：数据未变化时直接复用，无需重新绑定</li>
<li><strong>场景</strong>：数据局部更新时使用</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 当调用 notifyItemChanged(5) 时</span>
<span class="hljs-comment">// 第 5 个 item 会先放入 mAttachedScrap</span>
<span class="hljs-comment">// 然后重新绑定数据，放回原位置</span>
</code></pre>
<p><strong>2. 二级缓存（mCachedViews）</strong></p>
<ul>
<li><strong>作用</strong>：存储刚滑出屏幕的 ViewHolder</li>
<li><strong>特点</strong>：默认最多缓存 2 个，数据未变化</li>
<li><strong>场景</strong>：快速来回滑动时复用</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 用户向下滑动，item 1 滑出屏幕</span>
<span class="hljs-comment">// item 1 的 ViewHolder 放入 mCachedViews</span>
<span class="hljs-comment">// 如果用户立即向上滑动，可以直接复用</span>
</code></pre>
<p><strong>3. 三级缓存（ViewCacheExtension）</strong></p>
<ul>
<li><strong>作用</strong>：开发者自定义的缓存层</li>
<li><strong>特点</strong>：可选，大多数情况下不需要</li>
<li><strong>场景</strong>：特殊缓存需求</li>
</ul>
<p><strong>4. 四级缓存（RecycledViewPool）</strong></p>
<ul>
<li><strong>作用</strong>：存储所有类型的 ViewHolder</li>
<li><strong>特点</strong>：数据已清空，需要重新绑定</li>
<li><strong>场景</strong>：跨 RecyclerView 共享，或作为最后备选</li>
</ul>
<p><strong>缓存查找顺序：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecyclerView 需要 ViewHolder 时的查找顺序：</span>
<span class="hljs-number">1.</span> 查找 mAttachedScrap（一级缓存）
   ↓ 未找到
<span class="hljs-number">2.</span> 查找 mCachedViews（二级缓存）
   ↓ 未找到
<span class="hljs-number">3.</span> 查找 ViewCacheExtension（三级缓存，如果有）
   ↓ 未找到
<span class="hljs-number">4.</span> 查找 RecycledViewPool（四级缓存）
   ↓ 未找到
<span class="hljs-number">5.</span> 创建新的 ViewHolder（调用 onCreateViewHolder）
</code></pre>
<p><strong>缓存流程示例：</strong></p>
<pre><code class="hljs">首次显示：创建 10 个 ViewHolder
向下滑动：item 0 滑出 → 放入 mCachedViews
向上滑动：item 0 从 mCachedViews 直接复用（无需重新绑定）
继续滑动：mCachedViews 满 → 移入 RecycledViewPool
</code></pre>
<hr/>
<h3 data-id="heading-19">5.2 一级缓存（mAttachedScrap）的作用</h3>
<p><strong>答案：</strong></p>
<p>mAttachedScrap 是 RecyclerView 的第一级缓存，用于存储当前屏幕内可见的 ViewHolder。</p>
<p><strong>主要作用：</strong></p>
<ol>
<li><strong>局部更新优化</strong>：当调用 <code>notifyItemChanged()</code> 时，避免重新创建 ViewHolder</li>
<li><strong>快速复用</strong>：数据未变化时直接复用，无需重新绑定</li>
<li><strong>保持状态</strong>：保持 ViewHolder 的选中状态、动画状态等</li>
</ol>
<p><strong>工作原理：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">更新 item 5：
<span class="hljs-bullet">1.</span> ViewHolder 放入 mAttachedScrap
<span class="hljs-bullet">2.</span> 调用 onBindViewHolder 重新绑定
<span class="hljs-bullet">3.</span> ViewHolder 取出复用
结果：ViewHolder 复用，只更新数据
</code></pre>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, newText: <span class="hljs-type">String</span>)</span></span> {
    items[position] = newText
    notifyItemChanged(position)  <span class="hljs-comment">// ViewHolder 复用，只更新数据</span>
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>性能好</strong>：不需要重新创建 View</li>
<li><strong>保持状态</strong>：保持用户交互状态（如选中、展开等）</li>
<li><strong>流畅</strong>：更新过程更平滑</li>
</ul>
<hr/>
<h3 data-id="heading-20">5.3 二级缓存（mCachedViews）的作用</h3>
<p><strong>答案：</strong></p>
<p>mCachedViews 存储刚滑出屏幕的 ViewHolder，用于快速来回滑动时的复用。</p>
<p><strong>主要特点：</strong></p>
<ol>
<li><strong>默认容量</strong>：最多缓存 2 个 ViewHolder</li>
<li><strong>数据完整</strong>：ViewHolder 中的数据未清空</li>
<li><strong>快速复用</strong>：可以直接使用，无需重新绑定</li>
</ol>
<p><strong>工作原理：</strong></p>
<pre><code class="hljs">向下滑动：item 0 滑出 → 放入 mCachedViews（数据保留）
向上滑动：item 0 从 mCachedViews 直接复用（无需重新绑定）
继续滑动：mCachedViews 满（2个）→ 移入 RecycledViewPool
</code></pre>
<p><strong>为什么只缓存 2 个？</strong></p>
<ul>
<li>平衡内存和性能</li>
<li>大多数情况下，用户来回滑动不会超过 2 个 item</li>
<li>如果缓存太多，会占用过多内存</li>
</ul>
<hr/>
<h3 data-id="heading-21">5.4 三级缓存（ViewCacheExtension）的作用</h3>
<p><strong>答案：</strong></p>
<p>ViewCacheExtension 是 RecyclerView 的第三级缓存，是开发者可以自定义的缓存层。</p>
<p><strong>主要特点：</strong></p>
<ol>
<li><strong>可选缓存</strong>：大多数情况下不需要使用</li>
<li><strong>自定义实现</strong>：开发者可以自定义缓存逻辑</li>
<li><strong>特殊场景</strong>：适用于有特殊缓存需求的场景</li>
</ol>
<p><strong>使用场景：</strong></p>
<ul>
<li>需要特殊的缓存策略</li>
<li>需要跨 RecyclerView 共享特定类型的 ViewHolder</li>
<li>需要自定义缓存的生命周期</li>
</ul>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewCacheExtension</span> : <span class="hljs-type">RecyclerView.ViewCacheExtension</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cache = mutableMapOf&lt;<span class="hljs-built_in">Int</span>, RecyclerView.ViewHolder&gt;()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewForPositionAndType</span><span class="hljs-params">(
        recycler: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">Recycler</span>,
        position: <span class="hljs-type">Int</span>,
        viewType: <span class="hljs-type">Int</span>
    )</span></span>: View? {
        <span class="hljs-comment">// 自定义缓存逻辑</span>
        <span class="hljs-keyword">return</span> cache[viewType]?.itemView
    }
}

<span class="hljs-comment">// 使用</span>
recyclerView.setViewCacheExtension(CustomViewCacheExtension())
</code></pre>
<p><strong>注意：</strong> 大多数情况下不需要使用，默认的缓存机制已经足够。</p>
<hr/>
<h3 data-id="heading-22">5.5 四级缓存（RecycledViewPool）的作用</h3>
<p><strong>答案：</strong></p>
<p>RecycledViewPool 是 RecyclerView 的最后一级缓存，存储所有被回收的 ViewHolder。</p>
<p><strong>主要特点：</strong></p>
<ol>
<li><strong>数据已清空</strong>：ViewHolder 中的数据已被清空</li>
<li><strong>需要重新绑定</strong>：使用时需要调用 <code>onBindViewHolder</code></li>
<li><strong>可共享</strong>：多个 RecyclerView 可以共享同一个 Pool</li>
<li><strong>按类型存储</strong>：不同类型的 ViewHolder 分开存储</li>
</ol>
<p><strong>工作原理：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ViewHolder 进入 RecycledViewPool 的流程：</span>

<span class="hljs-comment">// 1. ViewHolder 从 mCachedViews 移出</span>
<span class="hljs-comment">// 2. 清空 ViewHolder 中的数据（调用 onViewRecycled）</span>
<span class="hljs-comment">// 3. 放入 RecycledViewPool</span>

<span class="hljs-comment">// 使用时：</span>
<span class="hljs-comment">// 1. 从 RecycledViewPool 获取 ViewHolder</span>
<span class="hljs-comment">// 2. 调用 onBindViewHolder 重新绑定数据</span>
<span class="hljs-comment">// 3. 显示在屏幕上</span>
</code></pre>
<p><strong>代码示例：共享 RecycledViewPool</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> sharedPool = RecyclerView.RecycledViewPool()
sharedPool.setMaxRecycledViews(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>)

recyclerView1.setRecycledViewPool(sharedPool)
recyclerView2.setRecycledViewPool(sharedPool)  <span class="hljs-comment">// 共享缓存</span>
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>内存优化</strong>：多个 RecyclerView 共享缓存，减少内存占用</li>
<li><strong>性能提升</strong>：避免重复创建 ViewHolder</li>
<li><strong>灵活性</strong>：可以自定义缓存数量</li>
</ul>
<hr/>
<h2 data-id="heading-23">六、性能优化</h2>
<h3 data-id="heading-24">6.1 如何优化性能</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 性能优化是一个综合性的工作，需要从多个方面入手。</p>
<p><strong>优化策略：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 使用 ViewHolder 缓存视图引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)
}

<span class="hljs-comment">// 2. 设置固定大小</span>
recyclerView.setHasFixedSize(<span class="hljs-literal">true</span>)

<span class="hljs-comment">// 3. 使用 DiffUtil 增量更新</span>
<span class="hljs-keyword">val</span> diffResult = DiffUtil.calculateDiff(MyDiffCallback(oldItems, newItems))
diffResult.dispatchUpdatesTo(adapter)

<span class="hljs-comment">// 4. 避免在 onBindViewHolder 中做耗时操作</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    holder.textView.text = items[position].text  <span class="hljs-comment">// ✅ 只更新视图</span>
    <span class="hljs-comment">// ❌ 不要做复杂计算或网络请求</span>
}

<span class="hljs-comment">// 5. 使用 ConstraintLayout 减少布局嵌套</span>
<span class="hljs-comment">// ❌ LinearLayout 嵌套 → ✅ ConstraintLayout</span>

<span class="hljs-comment">// 6. 图片加载使用异步库</span>
Glide.with(context).load(url).into(imageView)

<span class="hljs-comment">// 7. 设置预加载</span>
layoutManager.initialPrefetchItemCount = <span class="hljs-number">4</span>
</code></pre>
<hr/>
<h3 data-id="heading-25">6.2 setHasFixedSize(true) 的作用</h3>
<p><strong>答案：</strong></p>
<p><code>setHasFixedSize(true)</code> 告诉 RecyclerView，它的尺寸是固定的，不会因为内容变化而改变大小。</p>
<p><strong>作用：</strong></p>
<ol>
<li><strong>优化布局计算</strong>：RecyclerView 知道大小不变，可以跳过一些布局测量</li>
<li><strong>提高性能</strong>：减少不必要的布局重新计算</li>
</ol>
<p><strong>使用场景：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 适合使用：RecyclerView 的大小固定</span>
&lt;androidx.constraintlayout.widget.ConstraintLayout&gt;
    &lt;androidx.recyclerview.widget.RecyclerView
        android:layout_width=<span class="hljs-string">"match_parent"</span>
        android:layout_height=<span class="hljs-string">"match_parent"</span> /&gt;
&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;

recyclerView.setHasFixedSize(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 大小不会改变</span>

<span class="hljs-comment">// ❌ 不适合使用：RecyclerView 的大小可能改变</span>
&lt;LinearLayout&gt;
    &lt;androidx.recyclerview.widget.RecyclerView
        android:layout_width=<span class="hljs-string">"wrap_content"</span>
        android:layout_height=<span class="hljs-string">"wrap_content"</span> /&gt;
&lt;/LinearLayout&gt;

recyclerView.setHasFixedSize(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 大小可能改变</span>
</code></pre>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        <span class="hljs-keyword">val</span> recyclerView = findViewById&lt;RecyclerView&gt;(R.id.recyclerView)
        
        <span class="hljs-comment">// 如果 RecyclerView 的宽高是 match_parent 或固定值</span>
        <span class="hljs-comment">// 设置此属性可以优化性能</span>
        recyclerView.setHasFixedSize(<span class="hljs-literal">true</span>)
        
        recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
        recyclerView.adapter = MyAdapter(dataList)
    }
}
</code></pre>
<p><strong>性能影响：</strong></p>
<ul>
<li>设置 <code>true</code> 后，当数据变化时，RecyclerView 不会重新测量自己的大小</li>
<li>可以节省布局计算时间，特别是在数据频繁更新时</li>
</ul>
<hr/>
<h3 data-id="heading-26">6.3 什么是 DiffUtil？如何使用</h3>
<p><strong>答案：</strong></p>
<p>DiffUtil 是 Android 提供的一个工具类，用于计算两个列表之间的差异，并生成更新操作。</p>
<p><strong>主要优势：</strong></p>
<ol>
<li><strong>增量更新</strong>：只更新变化的部分，而不是整个列表</li>
<li><strong>自动动画</strong>：配合 RecyclerView 可以自动显示增删改动画</li>
<li><strong>性能优化</strong>：避免不必要的视图刷新</li>
</ol>
<p><strong>使用方法：</strong></p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 创建 DiffUtil.Callback</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDiffCallback</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> oldList: List&lt;Item&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> newList: List&lt;Item&gt;
) : DiffUtil.Callback() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOldListSize</span><span class="hljs-params">()</span></span> = oldList.size
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNewListSize</span><span class="hljs-params">()</span></span> = newList.size
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">areItemsTheSame</span><span class="hljs-params">(oldPos: <span class="hljs-type">Int</span>, newPos: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> oldList[oldPos].id == newList[newPos].id  <span class="hljs-comment">// 判断是否是同一个 item</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">areContentsTheSame</span><span class="hljs-params">(oldPos: <span class="hljs-type">Int</span>, newPos: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> oldList[oldPos] == newList[newPos]  <span class="hljs-comment">// 判断内容是否相同</span>
    }
}

<span class="hljs-comment">// 2. 在 Adapter 中使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateData</span><span class="hljs-params">(newItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Item</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> diffResult = DiffUtil.calculateDiff(MyDiffCallback(items, newItems))
    items = newItems.toMutableList()
    diffResult.dispatchUpdatesTo(<span class="hljs-keyword">this</span>)  <span class="hljs-comment">// 只更新变化的部分</span>
}
</code></pre>
<p><strong>性能对比：</strong></p>
<ul>
<li><code>notifyDataSetChanged()</code>：刷新所有 item，耗时约 100ms（1000 个 item）</li>
<li><code>DiffUtil</code>：只刷新变化的 item，耗时约 1ms</li>
</ul>
<hr/>
<h2 data-id="heading-27">七、ItemDecoration</h2>
<h3 data-id="heading-28">7.1 ItemDecoration 的作用</h3>
<p><strong>答案：</strong></p>
<p>ItemDecoration 用于在 RecyclerView 的 item 之间添加装饰效果，如分割线、间距、背景等。</p>
<p><strong>主要作用：</strong></p>
<ol>
<li><strong>添加分割线</strong>：在 item 之间绘制分割线</li>
<li><strong>设置间距</strong>：为 item 添加内边距或外边距</li>
<li><strong>绘制背景</strong>：为 item 添加背景装饰</li>
<li><strong>自定义装饰</strong>：实现复杂的装饰效果</li>
</ol>
<p><strong>基本使用：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 添加分割线</span>
<span class="hljs-keyword">val</span> dividerItemDecoration = DividerItemDecoration(context, LinearLayoutManager.VERTICAL)
recyclerView.addItemDecoration(dividerItemDecoration)
</code></pre>
<hr/>
<h3 data-id="heading-29">7.2 如何自定义 ItemDecoration</h3>
<p><strong>答案：</strong></p>
<p>自定义 ItemDecoration 需要继承 <code>RecyclerView.ItemDecoration</code> 并重写相应方法。</p>
<p><strong>核心方法：</strong></p>
<ol>
<li><strong>getItemOffsets()</strong> - 设置 item 的偏移量（为装饰留出空间）</li>
<li><strong>onDraw()</strong> - 在 item 下方绘制装饰</li>
<li><strong>onDrawOver()</strong> - 在 item 上方绘制装饰（详见 7.3）</li>
</ol>
<p><strong>代码示例：自定义分割线</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomDividerDecoration</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> height: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: <span class="hljs-built_in">Int</span>
) : RecyclerView.ItemDecoration() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemOffsets</span><span class="hljs-params">(outRect: <span class="hljs-type">Rect</span>, view: <span class="hljs-type">View</span>, parent: <span class="hljs-type">RecyclerView</span>, state: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">State</span>)</span></span> {
        <span class="hljs-comment">// 为分割线留出空间（最后一个 item 不需要）</span>
        <span class="hljs-keyword">if</span> (parent.getChildAdapterPosition(view) != parent.adapter!!.itemCount - <span class="hljs-number">1</span>) {
            outRect.bottom = height
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(c: <span class="hljs-type">Canvas</span>, parent: <span class="hljs-type">RecyclerView</span>, state: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">State</span>)</span></span> {
        <span class="hljs-keyword">val</span> paint = Paint().apply { <span class="hljs-keyword">this</span>.color = color }
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until parent.childCount) {
            <span class="hljs-keyword">val</span> child = parent.getChildAt(i)
            <span class="hljs-keyword">if</span> (parent.getChildAdapterPosition(child) != parent.adapter!!.itemCount - <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">val</span> top = child.bottom.toFloat()
                c.drawRect(<span class="hljs-number">0f</span>, top, parent.width.toFloat(), top + height, paint)
            }
        }
    }
}

<span class="hljs-comment">// 使用方式</span>
recyclerView.addItemDecoration(CustomDividerDecoration(<span class="hljs-number">2.</span>dp, Color.GRAY))
</code></pre>
<p><strong>其他常见用法：</strong></p>
<ul>
<li><strong>设置间距</strong>：在 <code>getItemOffsets()</code> 中设置 <code>outRect.set(spacing, spacing, spacing, spacing)</code></li>
<li><strong>复杂装饰</strong>：结合 <code>onDraw()</code> 和 <code>onDrawOver()</code> 实现悬浮效果等</li>
</ul>
<hr/>
<h3 data-id="heading-30">7.3 onDraw() 和 onDrawOver() 的区别</h3>
<p><strong>答案：</strong></p>
<p>这两个方法用于在不同层级绘制装饰。</p>
<p><strong>区别说明：</strong></p>

























<table><thead><tr><th>对比项</th><th>onDraw()</th><th>onDrawOver()</th></tr></thead><tbody><tr><td><strong>绘制位置</strong></td><td>在 item 下方绘制</td><td>在 item 上方绘制</td></tr><tr><td><strong>绘制顺序</strong></td><td>先绘制</td><td>后绘制</td></tr><tr><td><strong>使用场景</strong></td><td>分割线、背景</td><td>悬浮效果、遮罩</td></tr></tbody></table>
<p><strong>绘制顺序：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">绘制顺序（从下到上）：
<span class="hljs-bullet">1.</span> RecyclerView 背景
<span class="hljs-bullet">2.</span> onDraw() 绘制的内容（分割线等）
<span class="hljs-bullet">3.</span> Item 视图
<span class="hljs-bullet">4.</span> onDrawOver() 绘制的内容（悬浮效果等）
</code></pre>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiLayerDecoration</span> : <span class="hljs-type">RecyclerView.ItemDecoration</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(c: <span class="hljs-type">Canvas</span>, parent: <span class="hljs-type">RecyclerView</span>, state: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">State</span>)</span></span> {
        <span class="hljs-comment">// 在 item 下方绘制分割线</span>
        <span class="hljs-keyword">val</span> paint = Paint().apply {
            color = Color.GRAY
            strokeWidth = <span class="hljs-number">1f</span>
        }
        
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until parent.childCount) {
            <span class="hljs-keyword">val</span> child = parent.getChildAt(i)
            <span class="hljs-keyword">val</span> bottom = child.bottom.toFloat()
            c.drawLine(
                child.left.toFloat(),
                bottom,
                child.right.toFloat(),
                bottom,
                paint
            )
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawOver</span><span class="hljs-params">(c: <span class="hljs-type">Canvas</span>, parent: <span class="hljs-type">RecyclerView</span>, state: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">State</span>)</span></span> {
        <span class="hljs-comment">// 在 item 上方绘制悬浮效果（例如：选中高亮）</span>
        <span class="hljs-keyword">val</span> paint = Paint().apply {
            color = Color.parseColor(<span class="hljs-string">"#33000000"</span>) <span class="hljs-comment">// 半透明黑色</span>
        }
        
        <span class="hljs-comment">// 绘制选中项的高亮效果</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until parent.childCount) {
            <span class="hljs-keyword">val</span> child = parent.getChildAt(i)
            <span class="hljs-keyword">if</span> (isSelected(child)) {
                c.drawRect(
                    child.left.toFloat(),
                    child.top.toFloat(),
                    child.right.toFloat(),
                    child.bottom.toFloat(),
                    paint
                )
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isSelected</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 判断是否选中</span>
        <span class="hljs-keyword">return</span> view.isSelected
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-31">八、ItemAnimator</h2>
<h3 data-id="heading-32">8.1 ItemAnimator 的作用</h3>
<p><strong>答案：</strong></p>
<p>ItemAnimator 负责处理 RecyclerView 中 item 的增删改动画效果。</p>
<p><strong>主要作用：</strong></p>
<ol>
<li><strong>添加动画</strong>：item 添加时的动画</li>
<li><strong>删除动画</strong>：item 删除时的动画</li>
<li><strong>移动动画</strong>：item 位置变化时的动画</li>
<li><strong>更改动画</strong>：item 内容变化时的动画</li>
</ol>
<p><strong>默认动画：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecyclerView 使用 DefaultItemAnimator 作为默认动画</span>
recyclerView.itemAnimator = DefaultItemAnimator()
</code></pre>
<hr/>
<h3 data-id="heading-33">8.2 如何自定义 ItemAnimator</h3>
<p><strong>答案：</strong></p>
<p>自定义 ItemAnimator 需要继承 <code>RecyclerView.ItemAnimator</code> 并实现相应方法。</p>
<p><strong>核心方法：</strong></p>
<ol>
<li><strong>animateAdd()</strong> - 处理添加动画</li>
<li><strong>animateRemove()</strong> - 处理删除动画</li>
<li><strong>animateMove()</strong> - 处理移动动画</li>
<li><strong>animateChange()</strong> - 处理更改动画</li>
</ol>
<p><strong>代码示例：简单的淡入淡出动画</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FadeItemAnimator</span> : <span class="hljs-type">RecyclerView.ItemAnimator</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">animateAdd</span><span class="hljs-params">(holder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        holder.itemView.alpha = <span class="hljs-number">0f</span>
        holder.itemView.animate()
            .alpha(<span class="hljs-number">1f</span>)
            .setDuration(<span class="hljs-number">300</span>)
            .setListener(<span class="hljs-keyword">object</span> : AnimatorListenerAdapter() {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAnimationEnd</span><span class="hljs-params">(animation: <span class="hljs-type">Animator</span>)</span></span> {
                    dispatchAddFinished(holder)
                }
            })
            .start()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">animateRemove</span><span class="hljs-params">(holder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        holder.itemView.animate()
            .alpha(<span class="hljs-number">0f</span>)
            .setDuration(<span class="hljs-number">300</span>)
            .setListener(<span class="hljs-keyword">object</span> : AnimatorListenerAdapter() {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAnimationEnd</span><span class="hljs-params">(animation: <span class="hljs-type">Animator</span>)</span></span> {
                    dispatchRemoveFinished(holder)
                }
            })
            .start()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">animateMove</span><span class="hljs-params">(
        holder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>,
        fromX: <span class="hljs-type">Int</span>, fromY: <span class="hljs-type">Int</span>, toX: <span class="hljs-type">Int</span>, toY: <span class="hljs-type">Int</span>
    )</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> deltaX = toX - fromX
        <span class="hljs-keyword">val</span> deltaY = toY - fromY
        holder.itemView.translationX = -deltaX.toFloat()
        holder.itemView.translationY = -deltaY.toFloat()
        holder.itemView.animate()
            .translationX(<span class="hljs-number">0f</span>)
            .translationY(<span class="hljs-number">0f</span>)
            .setDuration(<span class="hljs-number">300</span>)
            .setListener(<span class="hljs-keyword">object</span> : AnimatorListenerAdapter() {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAnimationEnd</span><span class="hljs-params">(animation: <span class="hljs-type">Animator</span>)</span></span> {
                    dispatchMoveFinished(holder)
                }
            })
            .start()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">animateChange</span><span class="hljs-params">(
        oldHolder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>,
        newHolder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>,
        fromLeft: <span class="hljs-type">Int</span>, fromTop: <span class="hljs-type">Int</span>, toLeft: <span class="hljs-type">Int</span>, toTop: <span class="hljs-type">Int</span>
    )</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// 使用默认动画</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runPendingAnimations</span><span class="hljs-params">()</span></span> {}
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endAnimation</span><span class="hljs-params">(item: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>)</span></span> {
        item.itemView.clearAnimation()
    }
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endAnimations</span><span class="hljs-params">()</span></span> {}
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isRunning</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
}

<span class="hljs-comment">// 使用方式</span>
recyclerView.itemAnimator = FadeItemAnimator()
</code></pre>
<p><strong>注意事项：</strong></p>
<ul>
<li>动画结束后必须调用 <code>dispatchAddFinished()</code>、<code>dispatchRemoveFinished()</code> 等方法</li>
<li>可以返回 <code>false</code> 表示使用默认动画</li>
<li>大多数情况下使用 <code>DefaultItemAnimator</code> 即可满足需求</li>
</ul>
<hr/>
<h2 data-id="heading-34">九、高级特性</h2>
<h3 data-id="heading-35">9.1 如何处理动态高度的 Item</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 默认支持动态高度的 item，但需要注意一些优化点。</p>
<p><strong>基本使用：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果 item 高度是动态的，不需要特殊设置</span>
<span class="hljs-comment">// RecyclerView 会自动测量每个 item 的高度</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicHeightAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;Item&gt;) : 
    RecyclerView.Adapter&lt;DynamicHeightAdapter.ViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_dynamic, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> ViewHolder(view)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> item = items[position]
        
        <span class="hljs-comment">// 设置内容，高度会自动调整</span>
        holder.titleTextView.text = item.title
        holder.contentTextView.text = item.content <span class="hljs-comment">// 内容长度不同，高度不同</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span> = items.size
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">val</span> titleTextView: TextView = itemView.findViewById(R.id.titleTextView)
        <span class="hljs-keyword">val</span> contentTextView: TextView = itemView.findViewById(R.id.contentTextView)
    }
}
</code></pre>
<p><strong>性能优化：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果所有 item 高度相同，设置固定高度可以优化性能</span>
recyclerView.setHasFixedSize(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 动态高度必须为 false</span>

<span class="hljs-comment">// 使用 ConstraintLayout 可以更好地处理动态高度</span>
<span class="hljs-comment">// item_dynamic.xml</span>
&lt;androidx.constraintlayout.widget.ConstraintLayout&gt;
    &lt;TextView
        android:id=<span class="hljs-string">"@+id/titleTextView"</span>
        app:layout_constraintTop_toTopOf=<span class="hljs-string">"parent"</span> /&gt;
    
    &lt;TextView
        android:id=<span class="hljs-string">"@+id/contentTextView"</span>
        app:layout_constraintTop_toBottomOf=<span class="hljs-string">"@id/titleTextView"</span>
        android:layout_height=<span class="hljs-string">"wrap_content"</span> /&gt;
&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;
</code></pre>
<hr/>
<h3 data-id="heading-36">9.2 如何实现数据预加载</h3>
<p><strong>答案：</strong></p>
<p>数据预加载是指监听滚动事件，在用户滑动到列表底部之前就开始加载更多数据，从而提升用户体验，避免用户等待数据加载。</p>
<p><strong>实现方式：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        <span class="hljs-keyword">val</span> recyclerView = findViewById&lt;RecyclerView&gt;(R.id.recyclerView)
        recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
        recyclerView.adapter = MyAdapter(dataList)
        
        <span class="hljs-comment">// 监听滚动，提前加载数据</span>
        recyclerView.addOnScrollListener(<span class="hljs-keyword">object</span> : RecyclerView.OnScrollListener() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onScrolled</span><span class="hljs-params">(recyclerView: <span class="hljs-type">RecyclerView</span>, dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>)</span></span> {
                <span class="hljs-keyword">super</span>.onScrolled(recyclerView, dx, dy)
                
                <span class="hljs-keyword">val</span> layoutManager = recyclerView.layoutManager <span class="hljs-keyword">as</span> LinearLayoutManager
                <span class="hljs-keyword">val</span> lastVisiblePosition = layoutManager.findLastVisibleItemPosition()
                <span class="hljs-keyword">val</span> totalItemCount = layoutManager.itemCount
                
                <span class="hljs-comment">// 距离底部还有 5 个 item 时开始预加载</span>
                <span class="hljs-keyword">if</span> (lastVisiblePosition &gt;= totalItemCount - <span class="hljs-number">5</span>) {
                    loadNextPage()
                }
            }
        })
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadNextPage</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 加载下一页数据</span>
        <span class="hljs-comment">// 注意：需要防止重复加载</span>
    }
}
</code></pre>
<p><strong>注意事项：</strong></p>
<ul>
<li>需要防止重复加载（使用标志位或锁）</li>
<li>预加载阈值建议设置为 3-5 个 item</li>
<li>对于网络请求，需要考虑取消机制</li>
<li>ViewHolder 预加载见 14.11 initialPrefetchItemCount</li>
</ul>
<hr/>
<h2 data-id="heading-37">十、常见问题</h2>
<h3 data-id="heading-38">10.1 RecyclerView 显示空白的原因</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 显示空白通常由以下原因导致：</p>
<p><strong>常见原因及解决方案：</strong></p>
<p><strong>1. 没有设置 LayoutManager</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：没有设置 LayoutManager</span>
recyclerView.adapter = adapter

<span class="hljs-comment">// ✅ 正确：必须设置 LayoutManager</span>
recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
recyclerView.adapter = adapter
</code></pre>
<p><strong>2. 数据为空</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 检查数据是否为空</span>
<span class="hljs-keyword">if</span> (dataList.isEmpty()) {
    <span class="hljs-comment">// 显示空状态视图</span>
    showEmptyView()
} <span class="hljs-keyword">else</span> {
    recyclerView.adapter = MyAdapter(dataList)
}
</code></pre>
<p><strong>3. Item 布局高度为 0</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ❌ 错误：高度为 0 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"0dp"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- ✅ 正确：设置合适的高度 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;</span>
</code></pre>
<p><strong>4. RecyclerView 高度问题</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ❌ 错误：高度为 wrap_content 且没有内容 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RecyclerView</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- ✅ 正确：使用 match_parent 或固定高度 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RecyclerView</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span> /&gt;</span>
</code></pre>
<p><strong>5. Adapter 的 getItemCount() 返回 0</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 检查 getItemCount() 是否正确</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> items.size <span class="hljs-comment">// 确保返回正确的数量</span>
}
</code></pre>
<p><strong>调试方法：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 添加日志调试</span>
Log.d(<span class="hljs-string">"RecyclerView"</span>, <span class="hljs-string">"ItemCount: <span class="hljs-subst">${adapter.itemCount}</span>"</span>)
Log.d(<span class="hljs-string">"RecyclerView"</span>, <span class="hljs-string">"DataSize: <span class="hljs-subst">${dataList.size}</span>"</span>)
Log.d(<span class="hljs-string">"RecyclerView"</span>, <span class="hljs-string">"LayoutManager: <span class="hljs-subst">${recyclerView.layoutManager}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-39">10.2 如何避免数据更新异常</h3>
<p><strong>答案：</strong></p>
<p>数据更新时的异常通常是由于在错误的时机更新数据导致的。</p>
<p><strong>常见异常及解决方案：</strong></p>
<p><strong>1. IndexOutOfBoundsException</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：在后台线程更新数据后直接通知</span>
Thread {
    items.add(<span class="hljs-string">"new item"</span>)
    notifyItemInserted(items.size - <span class="hljs-number">1</span>) <span class="hljs-comment">// 可能崩溃</span>
}.start()

<span class="hljs-comment">// ✅ 正确：在主线程更新</span>
Thread {
    items.add(<span class="hljs-string">"new item"</span>)
    runOnUiThread {
        notifyItemInserted(items.size - <span class="hljs-number">1</span>)
    }
}.start()

<span class="hljs-comment">// ✅ 或者使用 Handler</span>
handler.post {
    notifyItemInserted(items.size - <span class="hljs-number">1</span>)
}
</code></pre>
<p><strong>2. 并发修改异常</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：在遍历时修改列表</span>
<span class="hljs-keyword">for</span> (item <span class="hljs-keyword">in</span> items) {
    <span class="hljs-keyword">if</span> (shouldRemove(item)) {
        items.remove(item) <span class="hljs-comment">// ConcurrentModificationException</span>
    }
}

<span class="hljs-comment">// ✅ 正确：先收集要删除的项，再删除</span>
<span class="hljs-keyword">val</span> toRemove = items.filter { shouldRemove(it) }
items.removeAll(toRemove)
notifyItemRangeRemoved(<span class="hljs-number">0</span>, toRemove.size)
</code></pre>
<p><strong>3. 位置不匹配异常</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：使用 adapterPosition 而不是 position 参数</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    holder.itemView.setOnClickListener {
        <span class="hljs-keyword">val</span> adapterPosition = holder.adapterPosition
        <span class="hljs-keyword">if</span> (adapterPosition != RecyclerView.NO_POSITION) {
            <span class="hljs-keyword">val</span> item = items[adapterPosition] <span class="hljs-comment">// 安全访问</span>
        }
    }
}
</code></pre>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: MutableList&lt;String&gt;) : 
    RecyclerView.Adapter&lt;SafeAdapter.ViewHolder&gt;() {
    
    <span class="hljs-comment">// 线程安全的数据更新</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lock = Any()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(item: <span class="hljs-type">String</span>)</span></span> {
        synchronized(lock) {
            <span class="hljs-keyword">val</span> position = items.size
            items.add(item)
            notifyItemInserted(position)
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span> {
        synchronized(lock) {
            <span class="hljs-keyword">if</span> (position <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until items.size) {
                items.removeAt(position)
                notifyItemRemoved(position)
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, newItem: <span class="hljs-type">String</span>)</span></span> {
        synchronized(lock) {
            <span class="hljs-keyword">if</span> (position <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until items.size) {
                items[position] = newItem
                notifyItemChanged(position)
            }
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-40">10.3 如何避免 ViewHolder 内存泄漏</h3>
<p><strong>答案：</strong></p>
<p>ViewHolder 中可能持有 Context、监听器等引用，需要避免内存泄漏。</p>
<p><strong>常见泄漏场景及解决方案：</strong></p>
<p><strong>1. 持有 Activity Context</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：ViewHolder 持有 Activity 引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context = itemView.context <span class="hljs-comment">// 如果是 Activity Context，可能泄漏</span>
}

<span class="hljs-comment">// ✅ 正确：使用 Application Context 或 itemView.context</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context = itemView.context.applicationContext
}
</code></pre>
<p><strong>2. 未取消异步任务</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：异步任务未取消</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadImage</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// 如果 ViewHolder 被回收，但任务还在执行，可能泄漏</span>
        loadImageAsync(url) { bitmap -&gt;
            imageView.setImageBitmap(bitmap)
        }
    }
}

<span class="hljs-comment">// ✅ 正确：在 onViewRecycled 中取消任务</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> imageLoadJob: Job? = <span class="hljs-literal">null</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadImage</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        imageLoadJob = lifecycleScope.launch {
            <span class="hljs-keyword">val</span> bitmap = loadImageAsync(url)
            imageView.setImageBitmap(bitmap)
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cancelLoad</span><span class="hljs-params">()</span></span> {
        imageLoadJob?.cancel()
    }
}

<span class="hljs-comment">// 在 Adapter 中</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewRecycled</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>)</span></span> {
    <span class="hljs-keyword">super</span>.onViewRecycled(holder)
    holder.cancelLoad() <span class="hljs-comment">// 取消任务</span>
}
</code></pre>
<p><strong>3. 未移除监听器</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：在 onViewRecycled 中移除监听器</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewRecycled</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>)</span></span> {
    <span class="hljs-keyword">super</span>.onViewRecycled(holder)
    holder.removeListeners()
}
</code></pre>
<hr/>
<h2 data-id="heading-41">十一、源码分析</h2>
<h3 data-id="heading-42">11.1 RecyclerView 的绘制流程</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 的绘制流程遵循 Android 的标准绘制流程，但加入了视图复用机制。</p>
<p><strong>绘制流程：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. <span class="hljs-built_in">onMeasure</span>() - 测量阶段
   ├── 测量 RecyclerView 自身大小
   ├── 测量可见的 item
   └── 计算总高度/宽度

<span class="hljs-number">2</span>. <span class="hljs-built_in">onLayout</span>() - 布局阶段
   ├── 调用 LayoutManager<span class="hljs-selector-class">.onLayoutChildren</span>()
   ├── 回收不可见的 ViewHolder
   ├── 复用或创建新的 ViewHolder
   └── 布局可见的 item

<span class="hljs-number">3</span>. <span class="hljs-built_in">onDraw</span>() - 绘制阶段
   ├── 绘制 RecyclerView 背景
   ├── 绘制 ItemDecoration (onDraw)
   ├── 绘制 item 视图
   └── 绘制 ItemDecoration (onDrawOver)
</code></pre>
<p><strong>关键源码分析：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecyclerView.onMeasure()</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(widthSpec: <span class="hljs-type">Int</span>, heightSpec: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// 1. 调用 LayoutManager 测量</span>
    layoutManager?.let {
        it.onMeasure(recycler, state, widthSpec, heightSpec)
    } ?: <span class="hljs-keyword">super</span>.onMeasure(widthSpec, heightSpec)
}

<span class="hljs-comment">// RecyclerView.onLayout()</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLayout</span><span class="hljs-params">(changed: <span class="hljs-type">Boolean</span>, l: <span class="hljs-type">Int</span>, t: <span class="hljs-type">Int</span>, r: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// 1. 分发布局</span>
    dispatchLayout()
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatchLayout</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 2. 调用 LayoutManager 布局</span>
    layoutManager?.onLayoutChildren(recycler, state)
}

<span class="hljs-comment">// LayoutManager.onLayoutChildren()</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLayoutChildren</span><span class="hljs-params">(recycler: <span class="hljs-type">Recycler</span>, state: <span class="hljs-type">State</span>)</span></span> {
    <span class="hljs-comment">// 1. 回收所有视图</span>
    detachAndScrapAttachedViews(recycler)
    
    <span class="hljs-comment">// 2. 填充可见区域</span>
    fill(recycler, layoutState, state, <span class="hljs-literal">false</span>)
}
</code></pre>
<p><strong>视图复用流程：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 需要 ViewHolder 时，先从缓存获取</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewForPosition</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: View {
    <span class="hljs-comment">// 查找顺序：</span>
    <span class="hljs-comment">// 1. mAttachedScrap (一级缓存)</span>
    <span class="hljs-comment">// 2. mCachedViews (二级缓存)</span>
    <span class="hljs-comment">// 3. ViewCacheExtension (三级缓存)</span>
    <span class="hljs-comment">// 4. RecycledViewPool (四级缓存)</span>
    <span class="hljs-comment">// 5. 创建新的 ViewHolder</span>
}

<span class="hljs-comment">// 2. 视图滑出屏幕时，放入缓存</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recycleView</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span> {
    <span class="hljs-keyword">val</span> holder = getChildViewHolder(view)
    <span class="hljs-comment">// 根据情况放入不同级别的缓存</span>
    recycler.recycleView(holder)
}
</code></pre>
<hr/>
<h3 data-id="heading-43">11.2 如何实现视图复用</h3>
<p><strong>答案：</strong></p>
<p>视图复用是 RecyclerView 高性能的核心机制。</p>
<p><strong>复用机制原理：</strong></p>
<p><strong>1. 视图回收（Recycle）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 当 item 滑出屏幕时</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recycleView</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span> {
    <span class="hljs-keyword">val</span> holder = getChildViewHolder(view)
    
    <span class="hljs-comment">// 1. 清除数据绑定</span>
    holder.unbind()
    
    <span class="hljs-comment">// 2. 根据情况放入缓存</span>
    <span class="hljs-keyword">if</span> (holder.isRecyclable) {
        <span class="hljs-comment">// 放入 RecycledViewPool</span>
        recycledViewPool.putRecycledView(holder)
    }
}
</code></pre>
<p><strong>2. 视图获取（Get）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 需要 ViewHolder 时</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewForPosition</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
    <span class="hljs-comment">// 1. 从缓存池获取</span>
    <span class="hljs-keyword">val</span> holder = recycledViewPool.getRecycledView(viewType)
    
    <span class="hljs-keyword">if</span> (holder != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 2. 重新绑定数据</span>
        adapter.onBindViewHolder(holder, position)
        <span class="hljs-keyword">return</span> holder
    }
    
    <span class="hljs-comment">// 3. 缓存中没有，创建新的</span>
    <span class="hljs-keyword">return</span> adapter.onCreateViewHolder(parent, viewType)
}
</code></pre>
<p><strong>3. 缓存策略</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecycledViewPool 的实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RecycledViewPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scrapHeaps = SparseArray&lt;ScrapData&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">putRecycledView</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>)</span></span> {
        <span class="hljs-keyword">val</span> viewType = holder.itemViewType
        <span class="hljs-keyword">val</span> scrapHeap = getScrapHeapForType(viewType)
        scrapHeap.add(holder)
        
        <span class="hljs-comment">// 限制每个类型的缓存数量</span>
        <span class="hljs-keyword">if</span> (scrapHeap.size &gt; maxRecycledViews) {
            scrapHeap.remove(<span class="hljs-number">0</span>) <span class="hljs-comment">// 移除最旧的</span>
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getRecycledView</span><span class="hljs-params">(viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder? {
        <span class="hljs-keyword">val</span> scrapHeap = getScrapHeapForType(viewType)
        <span class="hljs-keyword">return</span> scrapHeap.removeLastOrNull()
    }
}
</code></pre>
<p><strong>复用流程图：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">用户滑动列表
<span class="hljs-code">    ↓
Item 滑出屏幕
    ↓
ViewHolder 被回收
    ↓
放入 RecycledViewPool
    ↓
新的 Item 需要显示
    ↓
从 RecycledViewPool 获取 ViewHolder
    ↓
重新绑定数据 (onBindViewHolder)
    ↓
显示在屏幕上
</span></code></pre>
<hr/>
<h3 data-id="heading-44">11.3 LayoutManager 的测量和布局流程</h3>
<p><strong>答案：</strong></p>
<p>LayoutManager 负责测量和布局 RecyclerView 中的 item。</p>
<p><strong>测量流程（Measure）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LinearLayoutManager.onMeasure()</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(
    recycler: <span class="hljs-type">Recycler</span>,
    state: <span class="hljs-type">State</span>,
    widthSpec: <span class="hljs-type">Int</span>,
    heightSpec: <span class="hljs-type">Int</span>
)</span></span>: IntArray {
    <span class="hljs-comment">// 1. 获取测量模式</span>
    <span class="hljs-keyword">val</span> widthMode = View.MeasureSpec.getMode(widthSpec)
    <span class="hljs-keyword">val</span> heightMode = View.MeasureSpec.getMode(heightSpec)
    
    <span class="hljs-comment">// 2. 测量可见的 item</span>
    <span class="hljs-keyword">var</span> width = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> height = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until childCount) {
        <span class="hljs-keyword">val</span> child = getChildAt(i)
        measureChild(child, widthSpec, heightSpec)
        
        width = max(width, child.measuredWidth)
        height += child.measuredHeight
    }
    
    <span class="hljs-keyword">return</span> intArrayOf(width, height)
}
</code></pre>
<p><strong>布局流程（Layout）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LinearLayoutManager.onLayoutChildren()</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLayoutChildren</span><span class="hljs-params">(recycler: <span class="hljs-type">Recycler</span>, state: <span class="hljs-type">State</span>)</span></span> {
    <span class="hljs-comment">// 1. 回收所有已附加的视图</span>
    detachAndScrapAttachedViews(recycler)
    
    <span class="hljs-comment">// 2. 计算布局方向</span>
    <span class="hljs-keyword">val</span> layoutDirection = <span class="hljs-keyword">if</span> (reverseLayout) -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    
    <span class="hljs-comment">// 3. 填充可见区域</span>
    <span class="hljs-keyword">var</span> currentPosition = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> currentTop = paddingTop
    
    <span class="hljs-keyword">while</span> (currentTop &lt; height - paddingBottom) {
        <span class="hljs-comment">// 3.1 获取或创建 ViewHolder</span>
        <span class="hljs-keyword">val</span> holder = recycler.getViewForPosition(currentPosition)
        
        <span class="hljs-comment">// 3.2 添加视图</span>
        addView(holder.itemView)
        
        <span class="hljs-comment">// 3.3 测量视图</span>
        measureChildWithMargins(holder.itemView, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        
        <span class="hljs-comment">// 3.4 布局视图</span>
        <span class="hljs-keyword">val</span> left = paddingLeft
        <span class="hljs-keyword">val</span> top = currentTop
        <span class="hljs-keyword">val</span> right = left + holder.itemView.measuredWidth
        <span class="hljs-keyword">val</span> bottom = top + holder.itemView.measuredHeight
        
        layoutDecorated(holder.itemView, left, top, right, bottom)
        
        <span class="hljs-comment">// 3.5 更新位置</span>
        currentTop = bottom
        currentPosition += layoutDirection
    }
    
    <span class="hljs-comment">// 4. 回收不可见的视图</span>
    recycleViewsOutOfBounds(recycler)
}
</code></pre>
<p><strong>关键方法说明：</strong></p>
<ul>
<li><code>detachAndScrapAttachedViews()</code>: 回收所有已附加的视图</li>
<li><code>getViewForPosition()</code>: 获取指定位置的 ViewHolder（可能从缓存获取）</li>
<li><code>addView()</code>: 将视图添加到 RecyclerView</li>
<li><code>measureChildWithMargins()</code>: 测量子视图（包含 margin）</li>
<li><code>layoutDecorated()</code>: 布局子视图（包含 decoration 的偏移）</li>
<li><code>recycleViewsOutOfBounds()</code>: 回收超出边界的视图</li>
</ul>
<hr/>
<h2 data-id="heading-45">十二、第三方库与工具</h2>
<h3 data-id="heading-46">12.1 Epoxy 库的作用和使用场景</h3>
<p><strong>答案：</strong></p>
<p>Epoxy 是 Airbnb 开发的一个库，用于简化 RecyclerView 的 Adapter 开发。</p>
<p><strong>主要优势：</strong></p>
<ol>
<li><strong>简化代码</strong>：减少样板代码</li>
<li><strong>类型安全</strong>：编译时检查</li>
<li><strong>自动 Diff</strong>：自动计算差异并更新</li>
<li><strong>易于测试</strong>：代码结构清晰</li>
</ol>
<p><strong>基本使用：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 添加依赖</span>
<span class="hljs-comment">// implementation 'com.airbnb.android:epoxy:4.6.3'</span>
<span class="hljs-comment">// kapt 'com.airbnb.android:epoxy-processor:4.6.3'</span>

<span class="hljs-comment">// 2. 定义 Model</span>
<span class="hljs-meta">@EpoxyModelClass(layout = R.layout.item_user)</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModel</span> : <span class="hljs-type">EpoxyModelWithHolder</span>&lt;<span class="hljs-type">UserHolder</span>&gt;() {
    <span class="hljs-meta">@EpoxyAttribute</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> name: String
    
    <span class="hljs-meta">@EpoxyAttribute</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(holder: <span class="hljs-type">UserHolder</span>)</span></span> {
        holder.nameTextView.text = name
        holder.ageTextView.text = <span class="hljs-string">"<span class="hljs-variable">$age</span> 岁"</span>
    }
}

<span class="hljs-comment">// 3. 创建 Holder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserHolder</span> : <span class="hljs-type">EpoxyHolder</span>() {
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> nameTextView: TextView
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> ageTextView: TextView
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindView</span><span class="hljs-params">(itemView: <span class="hljs-type">View</span>)</span></span> {
        nameTextView = itemView.findViewById(R.id.nameTextView)
        ageTextView = itemView.findViewById(R.id.ageTextView)
    }
}

<span class="hljs-comment">// 4. 在 Activity 中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        <span class="hljs-keyword">val</span> recyclerView = findViewById&lt;EpoxyRecyclerView&gt;(R.id.recyclerView)
        
        recyclerView.withModels {
            users.forEach { user -&gt;
                userModel {
                    id(user.id)
                    name(user.name)
                    age(user.age)
                }
            }
        }
    }
}
</code></pre>
<p><strong>使用场景：</strong></p>
<ul>
<li>复杂的多类型列表</li>
<li>需要频繁更新的列表</li>
<li>需要类型安全的列表开发</li>
</ul>
<hr/>
<h3 data-id="heading-47">12.2 如何使用 Systrace 分析性能</h3>
<p><strong>答案：</strong></p>
<p>Systrace 是 Android 提供的性能分析工具，可以分析 RecyclerView 的性能问题。</p>
<p><strong>使用步骤：</strong></p>
<p><strong>步骤 1：在代码中添加 Trace</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">MyAdapter.ViewHolder</span>&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 添加 Trace</span>
        Trace.beginSection(<span class="hljs-string">"onBindViewHolder"</span>)
        <span class="hljs-keyword">try</span> {
            holder.bind(items[position])
        } <span class="hljs-keyword">finally</span> {
            Trace.endSection()
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
        Trace.beginSection(<span class="hljs-string">"onCreateViewHolder"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
                .inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
            ViewHolder(view)
        } <span class="hljs-keyword">finally</span> {
            Trace.endSection()
        }
    }
}
</code></pre>
<p><strong>步骤 2：使用 Systrace 工具</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 连接设备</span>
adb devices

<span class="hljs-comment"># 2. 开始录制</span>
python systrace.py -t 10 -o trace.html <span class="hljs-built_in">sched</span> freq idle am wm gfx view binder_driver hal dalvik camera input res

<span class="hljs-comment"># 3. 在设备上操作 RecyclerView（滑动等）</span>

<span class="hljs-comment"># 4. 查看生成的 trace.html 文件</span>
</code></pre>
<p><strong>步骤 3：分析结果</strong></p>
<p>在生成的 HTML 文件中，可以查看：</p>
<ul>
<li><code>onBindViewHolder</code> 的执行时间</li>
<li><code>onCreateViewHolder</code> 的执行时间</li>
<li>主线程的阻塞情况</li>
<li>帧率情况</li>
</ul>
<p><strong>性能优化建议：</strong></p>
<ul>
<li>如果 <code>onBindViewHolder</code> 耗时过长，优化数据绑定逻辑</li>
<li>如果 <code>onCreateViewHolder</code> 耗时过长，优化布局文件</li>
<li>如果主线程阻塞，将耗时操作移到后台线程</li>
</ul>
<hr/>
<h3 data-id="heading-48">12.3 如何使用 Layout Inspector 调试</h3>
<p><strong>答案：</strong></p>
<p>Layout Inspector 是 Android Studio 提供的工具，可以查看 RecyclerView 的布局层次。</p>
<p><strong>使用步骤：</strong></p>
<ol>
<li>
<p><strong>打开 Layout Inspector</strong></p>
<ul>
<li>Android Studio → Tools → Layout Inspector</li>
<li>或点击工具栏的 Layout Inspector 图标</li>
</ul>
</li>
<li>
<p><strong>选择设备和进程</strong></p>
<ul>
<li>选择连接的设备</li>
<li>选择要调试的应用进程</li>
</ul>
</li>
<li>
<p><strong>查看布局层次</strong></p>
<ul>
<li>左侧显示布局树</li>
<li>中间显示布局预览</li>
<li>右侧显示属性面板</li>
</ul>
</li>
<li>
<p><strong>调试 RecyclerView</strong></p>
<ul>
<li>查看 RecyclerView 的子视图</li>
<li>检查 item 的布局</li>
<li>查看 ViewHolder 的复用情况</li>
</ul>
</li>
</ol>
<p><strong>调试技巧：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在代码中添加调试信息</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">MyAdapter.ViewHolder</span>&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 添加标签，方便在 Layout Inspector 中识别</span>
        holder.itemView.tag = <span class="hljs-string">"Item_<span class="hljs-variable">$position</span>"</span>
        holder.bind(items[position])
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-49">十三、设计模式与最佳实践</h2>
<h3 data-id="heading-50">13.1 RecyclerView 中使用的设计模式</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 使用了多种设计模式，这是其灵活性和可扩展性的基础。</p>
<p><strong>1. 适配器模式（Adapter Pattern）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecyclerView.Adapter 是适配器模式的典型应用</span>
<span class="hljs-comment">// 将数据适配到视图</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Adapter</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">()</span></span>: ViewHolder
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, <span class="hljs-keyword">data</span>: <span class="hljs-type">Any</span>)</span></span>
}
</code></pre>
<p><strong>2. 观察者模式（Observer Pattern）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Adapter 数据变化时，通知 RecyclerView 更新</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">notifyDataSetChanged</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 通知所有观察者（RecyclerView）</span>
        observers.forEach { it.onChanged() }
    }
}
</code></pre>
<p><strong>3. 策略模式（Strategy Pattern）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LayoutManager 是策略模式的体现</span>
<span class="hljs-comment">// 不同的布局策略可以互换</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">LayoutStrategy</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">layoutItems</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LinearLayoutStrategy</span> : <span class="hljs-type">LayoutStrategy</span> { ... }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GridLayoutStrategy</span> : <span class="hljs-type">LayoutStrategy</span> { ... }
</code></pre>
<p><strong>4. 模板方法模式（Template Method Pattern）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecyclerView 的绘制流程是模板方法</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecyclerView</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">()</span></span> {
        drawBackground()      <span class="hljs-comment">// 固定步骤</span>
        drawDecoration()       <span class="hljs-comment">// 固定步骤</span>
        drawItems()            <span class="hljs-comment">// 可自定义</span>
        drawDecorationOver()   <span class="hljs-comment">// 固定步骤</span>
    }
}
</code></pre>
<p><strong>5. 工厂模式（Factory Pattern）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ViewHolder 的创建使用工厂模式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createViewHolder</span><span class="hljs-params">(type: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (type) {
            TYPE_A -&gt; ViewHolderA()
            TYPE_B -&gt; ViewHolderB()
            <span class="hljs-keyword">else</span> -&gt; DefaultViewHolder()
        }
    }
}
</code></pre>
<p><strong>6. 对象池模式（Object Pool Pattern）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecycledViewPool 是对象池模式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RecycledViewPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> pool = mutableListOf&lt;ViewHolder&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>: ViewHolder? = pool.removeLastOrNull()
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">put</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>)</span></span> = pool.add(holder)
}
</code></pre>
<hr/>
<h3 data-id="heading-51">13.2 如何保持 Adapter 的单一职责</h3>
<p><strong>答案：</strong></p>
<p>单一职责原则要求一个类只负责一个功能。在 Adapter 中，应该将数据绑定和业务逻辑分离。</p>
<p><strong>错误示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：Adapter 承担了太多职责</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BadAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;Item&gt;) : 
    RecyclerView.Adapter&lt;BadAdapter.ViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> item = items[position]
        
        <span class="hljs-comment">// 职责 1：数据绑定</span>
        holder.textView.text = item.text
        
        <span class="hljs-comment">// 职责 2：网络请求（不应该在这里）</span>
        loadImage(item.imageUrl) { bitmap -&gt;
            holder.imageView.setImageBitmap(bitmap)
        }
        
        <span class="hljs-comment">// 职责 3：业务逻辑（不应该在这里）</span>
        <span class="hljs-keyword">if</span> (item.isVIP) {
            holder.vipBadge.visibility = View.VISIBLE
            holder.textView.setTextColor(Color.GOLD)
        }
        
        <span class="hljs-comment">// 职责 4：点击事件处理（可以，但最好分离）</span>
        holder.itemView.setOnClickListener {
            <span class="hljs-comment">// 复杂的业务逻辑</span>
            <span class="hljs-keyword">if</span> (user.isLoggedIn) {
                navigateToDetail(item)
            } <span class="hljs-keyword">else</span> {
                showLoginDialog()
            }
        }
    }
}
</code></pre>
<p><strong>正确示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：职责分离</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;Item&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> imageLoader: ImageLoader,      <span class="hljs-comment">// 图片加载职责分离</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> itemBinder: ItemBinder,       <span class="hljs-comment">// 数据绑定职责分离</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> clickHandler: ClickHandler    <span class="hljs-comment">// 点击处理职责分离</span>
) : RecyclerView.Adapter&lt;GoodAdapter.ViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> item = items[position]
        
        <span class="hljs-comment">// 只负责协调，不处理具体逻辑</span>
        itemBinder.bind(holder, item)
        imageLoader.load(item.imageUrl, holder.imageView)
        holder.itemView.setOnClickListener { clickHandler.onItemClick(item) }
    }
}

<span class="hljs-comment">// 图片加载器（单一职责）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageLoader</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>)</span></span> {
        Glide.with(imageView.context)
            .load(url)
            .into(imageView)
    }
}

<span class="hljs-comment">// 数据绑定器（单一职责）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemBinder</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, item: <span class="hljs-type">Item</span>)</span></span> {
        holder.textView.text = item.text
        <span class="hljs-comment">// 业务逻辑处理</span>
        <span class="hljs-keyword">if</span> (item.isVIP) {
            holder.vipBadge.visibility = View.VISIBLE
            holder.textView.setTextColor(Color.GOLD)
        }
    }
}

<span class="hljs-comment">// 点击处理器（单一职责）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickHandler</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> navigator: Navigator,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> authManager: AuthManager
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onItemClick</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> {
        <span class="hljs-keyword">if</span> (authManager.isLoggedIn()) {
            navigator.navigateToDetail(item)
        } <span class="hljs-keyword">else</span> {
            navigator.showLoginDialog()
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-52">十四、补充知识点</h2>
<h3 data-id="heading-53">14.1 RecyclerView 与 Jetpack Compose LazyColumn 的区别</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 和 Compose LazyColumn 都是用于显示列表的组件，但属于不同的技术栈。</p>








































<table><thead><tr><th>对比项</th><th>RecyclerView</th><th>Compose LazyColumn</th></tr></thead><tbody><tr><td><strong>技术栈</strong></td><td>传统 View 系统</td><td>Jetpack Compose</td></tr><tr><td><strong>声明式</strong></td><td>命令式（需要 Adapter）</td><td>声明式（直接描述 UI）</td></tr><tr><td><strong>代码量</strong></td><td>需要 Adapter、ViewHolder</td><td>代码更简洁</td></tr><tr><td><strong>性能</strong></td><td>成熟，性能优秀</td><td>性能优秀，但较新</td></tr><tr><td><strong>学习曲线</strong></td><td>相对平缓</td><td>需要学习 Compose</td></tr><tr><td><strong>兼容性</strong></td><td>支持所有 Android 版本</td><td>需要 API 21+</td></tr></tbody></table>
<p><strong>代码对比：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// RecyclerView 方式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        <span class="hljs-keyword">val</span> recyclerView = findViewById&lt;RecyclerView&gt;(R.id.recyclerView)
        recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
        recyclerView.adapter = MyAdapter(dataList)
    }
}

<span class="hljs-comment">// Compose LazyColumn 方式</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyList</span><span class="hljs-params">(items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Item</span>&gt;)</span></span> {
    LazyColumn {
        items(items) { item -&gt;
            ItemView(item = item)
        }
    }
}
</code></pre>
<p><strong>选择建议：</strong></p>
<ul>
<li><strong>使用 RecyclerView</strong>：现有项目、需要兼容低版本、团队熟悉 View 系统</li>
<li><strong>使用 Compose LazyColumn</strong>：新项目、追求现代化、愿意学习 Compose</li>
</ul>
<hr/>
<h3 data-id="heading-54">14.2 RecyclerView 的主要优势</h3>
<p><strong>答案：</strong></p>
<p>RecyclerView 相比 ListView 和其他列表组件，具有以下核心优势（与 ListView 的详细对比见 <strong>1.2</strong>）：</p>
<p><strong>1. 灵活的布局管理</strong></p>
<p>通过 LayoutManager 可以轻松切换不同的布局方式，无需修改 Adapter 代码。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 可以轻松切换不同的布局</span>
recyclerView.layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>) <span class="hljs-comment">// 线性</span>
recyclerView.layoutManager = GridLayoutManager(<span class="hljs-keyword">this</span>, <span class="hljs-number">3</span>) <span class="hljs-comment">// 网格</span>
recyclerView.layoutManager = StaggeredGridLayoutManager(<span class="hljs-number">2</span>, VERTICAL) <span class="hljs-comment">// 瀑布流</span>
</code></pre>
<p><strong>2. 强制 ViewHolder 模式</strong></p>
<p>RecyclerView 强制使用 ViewHolder，确保性能优化（详见 <strong>2.1、2.2</strong>）。</p>
<p><strong>3. 内置动画支持</strong></p>
<p>默认支持增删改动画，无需手动实现（详见 <strong>8.1、8.2</strong>）。</p>
<p><strong>4. 多级缓存机制</strong></p>
<p>四级缓存机制提供更好的性能（详见 <strong>5.1-5.5</strong>）。</p>
<p><strong>5. 高度可定制</strong></p>
<p>可以自定义 LayoutManager、ItemDecoration、ItemAnimator，实现复杂的布局和效果。</p>
<p><strong>6. 更好的性能</strong></p>
<ul>
<li>视图复用机制更完善（详见 <strong>11.2</strong>）</li>
<li>支持预加载（详见 <strong>9.2、14.10</strong>）</li>
<li>支持固定大小优化（详见 <strong>6.2</strong>）</li>
</ul>
<p><strong>总结：</strong></p>
<p>RecyclerView 相比 ListView 的主要优势在于更灵活的布局管理、更好的性能、更强的可定制性。详细对比见 <strong>1.2 RecyclerView 与 ListView 的区别是什么？</strong></p>
<hr/>
<h3 data-id="heading-55">14.3 ViewHolder 的生命周期</h3>
<p><strong>答案：</strong></p>
<p>ViewHolder 的生命周期与 RecyclerView 的视图复用机制密切相关。</p>
<p><strong>生命周期阶段：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 创建 (onCreateViewHolder)
   ↓
<span class="hljs-bullet">2.</span> 绑定 (onBindViewHolder)
   ↓
<span class="hljs-bullet">3.</span> 显示 (onScreen)
   ↓
<span class="hljs-bullet">4.</span> 回收 (onViewRecycled)
   ↓
<span class="hljs-bullet">5.</span> 复用 (onBindViewHolder) - 循环
   ↓
<span class="hljs-bullet">6.</span> 销毁 (最终)
</code></pre>
<p><strong>详细说明：</strong></p>
<p><strong>1. 创建阶段</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
    <span class="hljs-comment">// ViewHolder 被创建，但还未绑定数据</span>
    <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
        .inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
    <span class="hljs-keyword">return</span> ViewHolder(view)
}
</code></pre>
<p><strong>2. 绑定阶段</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// ViewHolder 绑定数据，准备显示</span>
    holder.bind(items[position])
}
</code></pre>
<p><strong>3. 显示阶段</strong></p>
<ul>
<li>ViewHolder 的 itemView 显示在屏幕上</li>
<li>用户可以与之交互</li>
</ul>
<p><strong>4. 回收阶段</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewRecycled</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>)</span></span> {
    <span class="hljs-keyword">super</span>.onViewRecycled(holder)
    <span class="hljs-comment">// ViewHolder 被回收，可以在这里清理资源</span>
    holder.clear()
}
</code></pre>
<p><strong>5. 复用阶段</strong></p>
<ul>
<li>ViewHolder 从缓存中取出</li>
<li>重新调用 <code>onBindViewHolder</code> 绑定新数据</li>
</ul>
<p><strong>完整示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">MyAdapter.ViewHolder</span>&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
        Log.d(<span class="hljs-string">"ViewHolder"</span>, <span class="hljs-string">"创建 ViewHolder"</span>)
        <span class="hljs-keyword">return</span> ViewHolder(LayoutInflater.from(parent.context)
            .inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>))
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        Log.d(<span class="hljs-string">"ViewHolder"</span>, <span class="hljs-string">"绑定 ViewHolder, position: <span class="hljs-variable">$position</span>"</span>)
        holder.bind(items[position])
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewRecycled</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onViewRecycled(holder)
        Log.d(<span class="hljs-string">"ViewHolder"</span>, <span class="hljs-string">"回收 ViewHolder"</span>)
        holder.clear()
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> {
            <span class="hljs-comment">// 绑定数据</span>
        }
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
            <span class="hljs-comment">// 清理资源，如取消图片加载</span>
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-56">14.4 notifyItemInserted() 和 notifyItemRemoved() 的区别</h3>
<p><strong>答案：</strong></p>
<p>这两个方法用于通知 RecyclerView 数据的变化，触发相应的动画。</p>
<p><strong>notifyItemInserted() - 插入通知</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在指定位置插入一个 item</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">String</span>)</span></span> {
    items.add(position, item)
    notifyItemInserted(position) <span class="hljs-comment">// 通知插入，显示插入动画</span>
}
</code></pre>
<p><strong>notifyItemRemoved() - 删除通知</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 删除指定位置的 item</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span> {
    items.removeAt(position)
    notifyItemRemoved(position) <span class="hljs-comment">// 通知删除，显示删除动画</span>
}
</code></pre>
<p><strong>区别对比：</strong></p>






























<table><thead><tr><th>对比项</th><th>notifyItemInserted</th><th>notifyItemRemoved</th></tr></thead><tbody><tr><td><strong>作用</strong></td><td>通知插入新 item</td><td>通知删除 item</td></tr><tr><td><strong>动画</strong></td><td>显示插入动画</td><td>显示删除动画</td></tr><tr><td><strong>参数</strong></td><td>插入的位置</td><td>删除的位置</td></tr><tr><td><strong>使用场景</strong></td><td>添加数据</td><td>删除数据</td></tr></tbody></table>
<p><strong>完整示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: MutableList&lt;String&gt;) : 
    RecyclerView.Adapter&lt;MyAdapter.ViewHolder&gt;() {
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, item: <span class="hljs-type">String</span>)</span></span> {
        items.add(position, item)
        notifyItemInserted(position)
        <span class="hljs-comment">// 如果插入的不是最后一个，还需要通知后面的 item 位置变化</span>
        notifyItemRangeChanged(position + <span class="hljs-number">1</span>, items.size - position - <span class="hljs-number">1</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span> {
        items.removeAt(position)
        notifyItemRemoved(position)
        <span class="hljs-comment">// 通知后面的 item 位置变化</span>
        notifyItemRangeChanged(position, items.size - position)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">moveItem</span><span class="hljs-params">(fromPosition: <span class="hljs-type">Int</span>, toPosition: <span class="hljs-type">Int</span>)</span></span> {
        Collections.swap(items, fromPosition, toPosition)
        notifyItemMoved(fromPosition, toPosition)
    }
}
</code></pre>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：使用局部更新方法</span>
adapter.addItem(<span class="hljs-number">0</span>, <span class="hljs-string">"new item"</span>) <span class="hljs-comment">// 只更新插入的 item</span>
adapter.removeItem(<span class="hljs-number">5</span>) <span class="hljs-comment">// 只更新删除的 item</span>

<span class="hljs-comment">// ❌ 错误：使用全局更新</span>
adapter.addItem(<span class="hljs-number">0</span>, <span class="hljs-string">"new item"</span>)
adapter.notifyDataSetChanged() <span class="hljs-comment">// 会刷新所有 item，性能差</span>
</code></pre>
<hr/>
<h3 data-id="heading-57">14.5 如何实现局部刷新</h3>
<p><strong>答案：</strong></p>
<p>局部刷新是指只更新变化的部分，而不是刷新整个列表。有多种实现方式，可以根据场景选择。</p>
<p><strong>方式 1：使用 notifyItemChanged() - 单个 item 更新</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: MutableList&lt;Item&gt;) : 
    RecyclerView.Adapter&lt;MyAdapter.ViewHolder&gt;() {
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, newItem: <span class="hljs-type">Item</span>)</span></span> {
        items[position] = newItem
        notifyItemChanged(position) <span class="hljs-comment">// 只刷新这个位置的 item</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItems</span><span class="hljs-params">(positions: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Int</span>&gt;, newItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Item</span>&gt;)</span></span> {
        positions.forEachIndexed { index, position -&gt;
            items[position] = newItems[index]
        }
        <span class="hljs-comment">// 批量更新</span>
        positions.forEach { notifyItemChanged(it) }
    }
}
</code></pre>
<p><strong>方式 2：使用 DiffUtil（推荐，详见 6.3）</strong></p>
<p>DiffUtil 是最智能的局部刷新方式，可以自动计算差异并更新。详细使用方法见 <strong>6.3 什么是 DiffUtil？如何使用？</strong></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>需要更新整个列表时</li>
<li>数据变化复杂，难以手动计算变化时</li>
<li>需要自动显示增删改动画时</li>
</ul>
<p><strong>方式 3：使用 Payload 进行部分更新</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">MyAdapter.ViewHolder</span>&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.bind(items[position])
    }
    
    <span class="hljs-comment">// 带 Payload 的绑定方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(
        holder: <span class="hljs-type">ViewHolder</span>,
        position: <span class="hljs-type">Int</span>,
        payloads: <span class="hljs-type">MutableList</span>&lt;<span class="hljs-type">Any</span>&gt;
    )</span></span> {
        <span class="hljs-keyword">if</span> (payloads.isEmpty()) {
            <span class="hljs-comment">// 没有 Payload，正常绑定</span>
            <span class="hljs-keyword">super</span>.onBindViewHolder(holder, position, payloads)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 有 Payload，只更新变化的部分</span>
            <span class="hljs-keyword">when</span> (payloads[<span class="hljs-number">0</span>]) {
                <span class="hljs-string">"name"</span> -&gt; holder.updateName(items[position].name)
                <span class="hljs-string">"avatar"</span> -&gt; holder.updateAvatar(items[position].avatar)
                <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">super</span>.onBindViewHolder(holder, position, payloads)
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItemName</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, newName: <span class="hljs-type">String</span>)</span></span> {
        items[position].name = newName
        notifyItemChanged(position, <span class="hljs-string">"name"</span>) <span class="hljs-comment">// 传递 Payload</span>
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateName</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span> {
            <span class="hljs-comment">// 只更新名字，不重新绑定整个 item</span>
            nameTextView.text = name
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-58">14.6 如何实现子 View 的点击事件</h3>
<p><strong>答案：</strong></p>
<p>在 RecyclerView 中，除了整个 item 的点击事件，还可以为 item 内的子 View 设置独立的点击事件。</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;Item&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onItemClick: (Item) -&gt; <span class="hljs-built_in">Unit</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onButtonClick: (Item) -&gt; <span class="hljs-built_in">Unit</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onImageClick: (Item) -&gt; <span class="hljs-built_in">Unit</span>
) : RecyclerView.Adapter&lt;MyAdapter.ViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> ViewHolder(view)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> item = items[position]
        holder.bind(item)
        
        <span class="hljs-comment">// Item 整体点击</span>
        holder.itemView.setOnClickListener {
            onItemClick(item)
        }
        
        <span class="hljs-comment">// 按钮点击（子 View）</span>
        holder.button.setOnClickListener {
            onButtonClick(item)
        }
        
        <span class="hljs-comment">// 图片点击（子 View）</span>
        holder.imageView.setOnClickListener {
            onImageClick(item)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span> = items.size
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">val</span> button: Button = itemView.findViewById(R.id.button)
        <span class="hljs-keyword">val</span> imageView: ImageView = itemView.findViewById(R.id.imageView)
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> {
            <span class="hljs-comment">// 绑定数据</span>
        }
    }
}
</code></pre>
<p><strong>注意事项：</strong></p>
<ul>
<li>子 View 的点击事件会优先于 item 的点击事件</li>
<li>如果子 View 消费了点击事件，item 的点击事件不会触发</li>
<li>可以使用 <code>setOnClickListener</code> 和 <code>setOnLongClickListener</code> 为不同子 View 设置不同的事件</li>
</ul>
<hr/>
<h3 data-id="heading-59">14.7 如何避免图片加载导致的滑动卡顿</h3>
<p><strong>答案：</strong></p>
<p>图片加载是导致 RecyclerView 滑动卡顿的常见原因，需要优化加载策略。</p>
<p><strong>优化方法：</strong></p>
<p><strong>1. 使用图片加载库（推荐）</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 Glide，自动处理缓存和异步加载</span>
Glide.with(context)
    .load(imageUrl)
    .placeholder(R.drawable.placeholder) <span class="hljs-comment">// 占位图</span>
    .error(R.drawable.error) <span class="hljs-comment">// 错误图</span>
    .into(imageView)
</code></pre>
<p><strong>2. 在滑动时暂停加载</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">MyAdapter.ViewHolder</span>&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> item = items[position]
        
        <span class="hljs-comment">// 只在静止时加载高清图</span>
        <span class="hljs-keyword">if</span> (recyclerView.scrollState == RecyclerView.SCROLL_STATE_IDLE) {
            Glide.with(context)
                .load(item.highResUrl)
                .into(holder.imageView)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 滑动时加载缩略图</span>
            Glide.with(context)
                .load(item.thumbUrl)
                .into(holder.imageView)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewRecycled</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onViewRecycled(holder)
        <span class="hljs-comment">// 回收时取消图片加载</span>
        Glide.with(context).clear(holder.imageView)
    }
}
</code></pre>
<p><strong>3. 使用 RecyclerView 的滑动监听</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">recyclerView.addOnScrollListener(<span class="hljs-keyword">object</span> : RecyclerView.OnScrollListener() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onScrollStateChanged</span><span class="hljs-params">(recyclerView: <span class="hljs-type">RecyclerView</span>, newState: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onScrollStateChanged(recyclerView, newState)
        
        <span class="hljs-keyword">when</span> (newState) {
            RecyclerView.SCROLL_STATE_IDLE -&gt; {
                <span class="hljs-comment">// 静止时恢复图片加载</span>
                Glide.with(context).resumeRequests()
            }
            RecyclerView.SCROLL_STATE_DRAGGING,
            RecyclerView.SCROLL_STATE_SETTLING -&gt; {
                <span class="hljs-comment">// 滑动时暂停图片加载</span>
                Glide.with(context).pauseRequests()
            }
        }
    }
})
</code></pre>
<p><strong>4. 优化图片尺寸</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 加载合适尺寸的图片，不要加载过大的图片</span>
Glide.with(context)
    .load(imageUrl)
    .<span class="hljs-keyword">override</span>(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>) <span class="hljs-comment">// 限制图片尺寸</span>
    .into(imageView)
</code></pre>
<hr/>
<h3 data-id="heading-60">14.8 initialPrefetchItemCount 的作用</h3>
<p><strong>答案：</strong></p>
<p><code>initialPrefetchItemCount</code> 是 LayoutManager 的一个属性，用于设置 ViewHolder 的预加载数量。它可以在用户滑动之前提前创建 ViewHolder，从而提升滑动流畅度。</p>
<p><strong>作用：</strong></p>
<ul>
<li><strong>提升流畅度</strong>：提前创建 ViewHolder，减少滑动时的创建时间</li>
<li><strong>优化体验</strong>：用户滑动时更流畅，减少卡顿</li>
<li><strong>减少延迟</strong>：避免在滑动过程中等待 ViewHolder 创建</li>
</ul>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> layoutManager = LinearLayoutManager(<span class="hljs-keyword">this</span>)
layoutManager.initialPrefetchItemCount = <span class="hljs-number">4</span> <span class="hljs-comment">// 预加载 4 个 item</span>

recyclerView.layoutManager = layoutManager
recyclerView.adapter = adapter
</code></pre>
<p><strong>工作原理：</strong></p>
<pre><code class="hljs">当前屏幕显示 item 0-9
预加载 item 10-13（提前创建 ViewHolder）
用户向下滑动时，item 10-13 已经准备好，直接显示
</code></pre>
<p><strong>与数据预加载的区别：</strong></p>
<ul>
<li><strong>initialPrefetchItemCount</strong>：预加载 ViewHolder（视图层），在 RecyclerView 内部自动完成</li>
<li><strong>数据预加载</strong>：预加载数据（数据层），需要手动监听滚动并加载更多数据（见 9.2）</li>
</ul>
<p><strong>注意事项：</strong></p>
<ul>
<li>预加载数量不宜过大，会占用内存</li>
<li>建议设置为 2-5 个</li>
<li>对于复杂布局，可以适当增加</li>
<li>对于简单布局，可以设置为 0 以节省内存</li>
</ul>
<hr/>
<h3 data-id="heading-61">14.9 RecyclerView 滑动卡顿的原因和解决方案</h3>
<p><strong>答案：</strong></p>
<p>滑动卡顿是 RecyclerView 性能问题的常见表现。</p>
<p><strong>常见原因：</strong></p>
<p><strong>1. 布局嵌套过深</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：嵌套过深</span>
&lt;LinearLayout&gt;
    &lt;LinearLayout&gt;
        &lt;LinearLayout&gt;
            &lt;TextView /&gt;
        &lt;/LinearLayout&gt;
    &lt;/LinearLayout&gt;
&lt;/LinearLayout&gt;

<span class="hljs-comment">// ✅ 正确：使用 ConstraintLayout 减少嵌套</span>
&lt;androidx.constraintlayout.widget.ConstraintLayout&gt;
    &lt;TextView /&gt;
&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;
</code></pre>
<p><strong>2. 在 onBindViewHolder 中执行耗时操作</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：在绑定中做耗时操作</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">val</span> result = complexCalculation() <span class="hljs-comment">// 耗时操作</span>
    holder.textView.text = result
}

<span class="hljs-comment">// ✅ 正确：提前计算好数据</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    holder.textView.text = items[position].preCalculatedResult
}
</code></pre>
<p><strong>3. 图片加载未优化</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 使用图片加载库，自动优化</span>
Glide.with(context)
    .load(imageUrl)
    .into(imageView)
</code></pre>
<p><strong>4. 未使用 ViewHolder 缓存</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：在 ViewHolder 中缓存视图引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)
}
</code></pre>
<p><strong>排查方法：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 使用 Systrace 分析</span>
Trace.beginSection(<span class="hljs-string">"onBindViewHolder"</span>)
<span class="hljs-comment">// ... 代码</span>
Trace.endSection()

<span class="hljs-comment">// 2. 使用 Profiler 查看性能</span>
<span class="hljs-comment">// Android Studio → View → Tool Windows → Profiler</span>

<span class="hljs-comment">// 3. 添加日志查看耗时</span>
<span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
<span class="hljs-comment">// ... 代码</span>
Log.d(<span class="hljs-string">"Performance"</span>, <span class="hljs-string">"耗时: <span class="hljs-subst">${System.currentTimeMillis() - startTime}</span>ms"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-62">14.10 如何排查性能问题</h3>
<p><strong>答案：</strong></p>
<p>排查性能问题需要系统的方法和工具。</p>
<p><strong>排查步骤：</strong></p>
<p><strong>1. 使用 Android Profiler</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android Studio → View → Tool Windows → Profiler</span>
<span class="hljs-comment">// 可以查看 CPU、内存、网络使用情况</span>
</code></pre>
<p><strong>2. 使用 Systrace</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 录制性能数据</span>
python systrace.py -t 10 -o trace.html <span class="hljs-built_in">sched</span> freq idle am wm gfx view

<span class="hljs-comment"># 在设备上操作 RecyclerView</span>

<span class="hljs-comment"># 查看 trace.html 文件</span>
</code></pre>
<p><strong>3. 添加性能日志</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">MyAdapter.ViewHolder</span>&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: ViewHolder {
        <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
        <span class="hljs-keyword">val</span> holder = ViewHolder(...)
        Log.d(<span class="hljs-string">"Performance"</span>, <span class="hljs-string">"onCreateViewHolder 耗时: <span class="hljs-subst">${System.currentTimeMillis() - startTime}</span>ms"</span>)
        <span class="hljs-keyword">return</span> holder
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
        holder.bind(items[position])
        Log.d(<span class="hljs-string">"Performance"</span>, <span class="hljs-string">"onBindViewHolder 耗时: <span class="hljs-subst">${System.currentTimeMillis() - startTime}</span>ms"</span>)
    }
}
</code></pre>
<p><strong>4. 检查布局层次</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 Layout Inspector 查看布局层次</span>
<span class="hljs-comment">// Android Studio → Tools → Layout Inspector</span>
</code></pre>
<p><strong>5. 检查内存使用</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 检查是否有内存泄漏</span>
<span class="hljs-comment">// 使用 LeakCanary</span>
dependencies {
    debugImplementation <span class="hljs-string">'com.squareup.leakcanary:leakcanary-android:2.12'</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-63">14.11 NO_POSITION 的含义</h3>
<p><strong>答案：</strong></p>
<p><code>NO_POSITION</code> 是 RecyclerView 中的一个常量，值为 -1，表示 ViewHolder 当前没有有效的位置。</p>
<p><strong>使用场景：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 当 ViewHolder 已经与 Adapter 分离时，adapterPosition 返回 NO_POSITION</span>
<span class="hljs-keyword">val</span> position = holder.adapterPosition
<span class="hljs-keyword">if</span> (position != RecyclerView.NO_POSITION) {
    <span class="hljs-comment">// 安全访问数据</span>
    <span class="hljs-keyword">val</span> item = items[position]
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// ViewHolder 已经分离，不能访问数据</span>
}
</code></pre>
<p><strong>常见情况：</strong></p>
<ol>
<li><strong>ViewHolder 被回收</strong>：ViewHolder 被放入缓存池时</li>
<li><strong>数据更新中</strong>：在数据更新过程中，ViewHolder 可能暂时没有位置</li>
<li><strong>动画进行中</strong>：在动画过程中，位置可能暂时无效</li>
</ol>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：总是检查 NO_POSITION</span>
holder.itemView.setOnClickListener {
    <span class="hljs-keyword">val</span> position = holder.adapterPosition
    <span class="hljs-keyword">if</span> (position != RecyclerView.NO_POSITION) {
        <span class="hljs-keyword">val</span> item = items[position]
        onItemClick(item)
    }
}

<span class="hljs-comment">// ❌ 错误：直接使用 position 参数</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
    holder.itemView.setOnClickListener {
        <span class="hljs-keyword">val</span> item = items[position] <span class="hljs-comment">// position 参数可能已经过时</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-64">14.12 如何实现数据源的线程安全</h3>
<p><strong>答案：</strong></p>
<p>在多线程环境下，需要确保数据源的线程安全。</p>
<p><strong>方式 1：使用同步锁</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">ViewHolder</span>&gt;() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lock = Any()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(item: <span class="hljs-type">String</span>)</span></span> {
        synchronized(lock) {
            items.add(item)
            notifyItemInserted(items.size - <span class="hljs-number">1</span>)
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeItem</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span> {
        synchronized(lock) {
            <span class="hljs-keyword">if</span> (position <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until items.size) {
                items.removeAt(position)
                notifyItemRemoved(position)
            }
        }
    }
}
</code></pre>
<p><strong>方式 2：使用主线程更新</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">ViewHolder</span>&gt;() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items = mutableListOf&lt;String&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateFromBackground</span><span class="hljs-params">(newItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        <span class="hljs-comment">// 在后台线程准备数据</span>
        Thread {
            <span class="hljs-keyword">val</span> processedItems = processItems(newItems)
            
            <span class="hljs-comment">// 在主线程更新 UI</span>
            Handler(Looper.getMainLooper()).post {
                items.clear()
                items.addAll(processedItems)
                notifyDataSetChanged()
            }
        }.start()
    }
}
</code></pre>
<p><strong>方式 3：使用协程</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">RecyclerView.Adapter</span>&lt;<span class="hljs-type">ViewHolder</span>&gt;() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items = mutableListOf&lt;String&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateItems</span><span class="hljs-params">(newItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        viewModelScope.launch(Dispatchers.Default) {
            <span class="hljs-comment">// 在后台线程处理数据</span>
            <span class="hljs-keyword">val</span> processedItems = processItems(newItems)
            
            <span class="hljs-comment">// 切换到主线程更新 UI</span>
            withContext(Dispatchers.Main) {
                items.clear()
                items.addAll(processedItems)
                notifyDataSetChanged()
            }
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[leetcode_day4_筑基期_《绝境求生》]]></title>    <link>https://juejin.cn/post/7594405684592295988</link>    <guid>https://juejin.cn/post/7594405684592295988</guid>    <pubDate>2026-01-13T07:39:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594405684592295988" data-draft-id="7594468778110976034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="leetcode_day4_筑基期_《绝境求生》"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-13T07:39:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="清木铎"/> <meta itemprop="url" content="https://juejin.cn/user/362175455046432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            leetcode_day4_筑基期_《绝境求生》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362175455046432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    清木铎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:39:13.000Z" title="Tue Jan 13 2026 07:39:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0"><strong>目录</strong></h2>
<hr/>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>前言</h2>
<p><code>提示：我就是一个运气很好的人，运气爆表</code></p>
<p>本系列《绝境求生》记录转码算法筑基过程，以代码随想录为纲学习，leetcode_hot_100练手，在此记录思考过程，方便过后复现。内容比较粗糙仅便于笔者厘清思路，复盘总结。</p>
<p>添加了代码逻辑这一部分内容</p>
<hr/>
<p><code>提示：以下是本篇文章正文内容</code></p>
<h2 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>动态规划</h2>
<p>特点：运筹学上最优化算法，题型是求最值，重叠子问题，最优子结构，！！状态转移方程</p>
<p>把复杂问题拆解成小问题，再由小问题的答案推导出大问题的答案（即记住之前做过的事情，避免重复计算，提高效率）</p>
<p>状态定义：用某个变量或数组代表某个小问题的答案</p>
<p>状态转移方程：大问题的答案=小问题答案的组合的数学表达式</p>
<p>初始化条件：最小的问题，不用推导就知道答案</p>
<h2 data-id="heading-3">一、70 爬楼梯</h2>
<h4 data-id="heading-4">题目描述</h4>
<blockquote>
<p><strong>示例 1：</strong></p>
<pre><code class="hljs language-ini" lang="ini">输入： <span class="hljs-attr">n</span> = <span class="hljs-number">2</span>
输出： 2
解释： 有两种方法可以爬到楼顶。
1. 1 阶 + 1 阶
2. 2 阶
</code></pre>
<p><strong>示例 2：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">输入： n = 3
输出： 3
解释： 有三种方法可以爬到楼顶。
<span class="hljs-bullet">1.</span> 1 阶 + 1 阶 + 1 阶
<span class="hljs-bullet">2.</span> 1 阶 + 2 阶
<span class="hljs-bullet">3.</span> 2 阶 + 1 阶
</code></pre>
</blockquote>
<h3 data-id="heading-5">1.模型</h3>
<h4 data-id="heading-6">简单理解？</h4>
<p>一次只能爬1,2个台阶，那爬n阶有几种方法</p>
<p>主要还是代几个子数据去推状态转移方程</p>
<h4 data-id="heading-7">能不能用图示意？</h4>
<p>None</p>
<h4 data-id="heading-8">初始化条件？</h4>
<p>定义i 为 第i 阶楼梯</p>
<p>dp[i] 就是爬第i阶楼梯所有方法的数组</p>
<p>d[1]=1 ，d[2]=2 (0-1-2,0- 2)</p>
<h4 data-id="heading-9">边界条件？</h4>
<p>可以剪枝一下。 比如当i=1或i=2时候直接返回1,2 因为创建数组也没有意义</p>
<h4 data-id="heading-10">代码逻辑？</h4>
<p>None</p>
<h4 data-id="heading-11">用什么方法：暴力法/ 其它巧妙的方法。         巧妙方法的子思路是?         。。。。。？？</h4>
<h5 data-id="heading-12">暴力法</h5>
<pre><code class="hljs language-ini" lang="ini">def solution(i):
    if <span class="hljs-attr">i</span> ==<span class="hljs-number">1</span>:
        return 1
    if <span class="hljs-attr">i</span> ==<span class="hljs-number">1</span>:
        return 2
    <span class="hljs-comment">#初始化dp数组用dp[0]占位</span>
    <span class="hljs-attr">dp</span>=[<span class="hljs-number">0</span>]*(i+<span class="hljs-number">1</span>) <span class="hljs-comment">#因为索引是0-n，所以</span>
    d<span class="hljs-section">[1]</span>=1
    d<span class="hljs-section">[2]</span>=2
    for _ in range(3,i+1):
        dp<span class="hljs-section">[i]</span>=dp<span class="hljs-section">[i-1]</span>+dp<span class="hljs-section">[i-2]</span>
    return dp<span class="hljs-section">[i]</span>  <span class="hljs-comment">#返回爬到n阶的方法</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-13">优化法</h5>
<p>用双指针法</p>
<p>用变量替代数组</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#爬楼梯的优化法</span>
def solution(i):
    if <span class="hljs-attr">i</span> ==<span class="hljs-number">1</span>:
        return 1
    if <span class="hljs-attr">i</span> ==<span class="hljs-number">1</span>:
        return 2
    <span class="hljs-attr">pre_pre</span>=<span class="hljs-number">1</span>
    <span class="hljs-attr">pre</span>=<span class="hljs-number">2</span>
    for _ in range(3,i+1):
        <span class="hljs-attr">cur</span> = pre + pre_pre  <span class="hljs-comment"># 当前i阶的方法数 = 前两阶方法数之和</span>
        <span class="hljs-comment"># 指针前进：为下一次迭代做准备</span>
        <span class="hljs-attr">pre_pre</span> = pre <span class="hljs-comment"># 原来的prev（i-1）变成新的prev_prev（i-2）</span>
        <span class="hljs-attr">pre</span> = cur    <span class="hljs-comment"># 原来的current（i）变成新的prev（i-1）</span>

<span class="hljs-comment"># 最终prev就是n阶的方法数（循环结束后，prev对应dp[n]）</span>
    return pre
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-14">细节？</h4>
<p>None</p>
<h4 data-id="heading-15">之前见过但没注意到的？</h4>
<p>创建一个全0数组 dp=[0]*n</p>
<h4 data-id="heading-16">疑惑点/新知识 ？</h4>
<p>搞清楚索引和数组长度分别定义什么？</p>
<p>自底向上的思路i-2,i-1再到i，不要反过来了</p>
<h2 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、118杨辉三角</h2>
<h4 data-id="heading-18">题目描述</h4>
<p>给定一个非负整数 <em><code>numRows</code>，</em> 生成「杨辉三角」的前 <em><code>numRows</code></em> 行。</p>
<blockquote>
<p>在**「杨辉三角」**中，每个数是它左上方和右上方的数的和。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5af536a097c485b91fa5716a2f382f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5pyo6ZOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768894753&amp;x-signature=%2BWB2%2F62BWjG1pOinNjQFeoXcz4s%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>编辑</p>
<p><strong>示例 1:</strong></p>
<pre><code class="hljs language-ini" lang="ini">输入: <span class="hljs-attr">numRows</span> = <span class="hljs-number">5</span>
输出: <span class="hljs-section">[[1]</span>,<span class="hljs-section">[1,1]</span>,<span class="hljs-section">[1,2,1]</span>,<span class="hljs-section">[1,3,3,1]</span>,<span class="hljs-section">[1,4,6,4,1]]</span>
</code></pre>
<p><strong>示例 2:</strong></p>
<pre><code class="hljs language-lua" lang="lua">输入: numRows = <span class="hljs-number">1</span>
输出: <span class="hljs-string">[[1]]</span>
</code></pre>
</blockquote>
<h3 data-id="heading-19">1.模型</h3>
<h4 data-id="heading-20">简单理解？</h4>
<p>每个数是左上方和右上方数之和</p>
<h4 data-id="heading-21">能不能用图示意？</h4>
<pre><code class="hljs language-csharp" lang="csharp">[
 [<span class="hljs-meta">1</span>],
 [<span class="hljs-meta">1,1</span>],
 [<span class="hljs-meta">1,2,1</span>],
 [<span class="hljs-meta">1,3,3,1</span>],
 [<span class="hljs-meta">1,4,6,4,1</span>]
]
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>数组张这样，特点：每一行的首尾元素都是1</p>
<h4 data-id="heading-22">初始化条件？</h4>
<p>dp=[[1]]   第零行为1</p>
<h4 data-id="heading-23">边界条件？</h4>
<p>剪枝 numRows=0 输出空列表，为n时要输出n行</p>
<h4 data-id="heading-24">代码逻辑？</h4>
<p>先初始化首尾，再填中间或者先全初始化 1，再覆盖中间</p>
<p>定义上一行还有当前行，首尾数与边界条件灵活搭配</p>
<p>矩阵构造上是先构造行，再添加每一行到二维数组中，而不是按元素s型构造数组</p>
<h4 data-id="heading-25">用什么方法：暴力法/ 其它巧妙的方法。         巧妙方法的子思路是?         。。。。。？？</h4>
<h5 data-id="heading-26">暴力法</h5>
<pre><code class="hljs language-ini" lang="ini">def solution(numrows):
    if <span class="hljs-attr">numrows</span>==<span class="hljs-number">0</span>:
        return <span class="hljs-section">[]</span>
    <span class="hljs-attr">dp</span>=[[<span class="hljs-number">1</span>]]       <span class="hljs-comment">#定义第0行</span>
    for i in range(1,numrows):  <span class="hljs-comment">#从第1行开始操作</span>
        <span class="hljs-attr">cur_row</span>=[<span class="hljs-number">1</span>]  <span class="hljs-comment">#行首为1   直接是一个列表了 [1,]</span>
        <span class="hljs-attr">pre_row</span>=dp[i-<span class="hljs-number">1</span>]  <span class="hljs-comment">#定义上一行</span>
    <span class="hljs-comment">#定义中间数</span>
        for j in range(1,i):
            <span class="hljs-attr">cur_val</span>=pre_row[j-<span class="hljs-number">1</span>]+pre_row[j]
            cur_row.append(cur_val)
        cur_row.append(1)
        dp.append(cur_row)
    return dp
<span class="hljs-comment"># print(solution(5))</span>
<span class="hljs-attr">dp</span>=solution(<span class="hljs-number">5</span>)
for _ in dp:
    print(_,<span class="hljs-attr">end</span>=<span class="hljs-string">'\n'</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-27">优化法</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">C</span>(i,j) = <span class="hljs-selector-tag">i</span>!/(j!*(i-j)!) 
<span class="hljs-built_in">C</span>(i,j-<span class="hljs-number">1</span>) = <span class="hljs-selector-tag">i</span>!/((j-<span class="hljs-number">1</span>)!*(i-j+<span class="hljs-number">1</span>)!) 

把 <span class="hljs-built_in">C</span>(i,j) 用 <span class="hljs-built_in">C</span>(i,j-<span class="hljs-number">1</span>) 表示：
<span class="hljs-built_in">C</span>(i,j) = <span class="hljs-built_in">C</span>(i,j-<span class="hljs-number">1</span>) * (i-j+<span class="hljs-number">1</span>) / j 
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 用公式法优化</span>
def solution(numrows):
    if <span class="hljs-attr">numrows</span>==<span class="hljs-number">0</span>:
        return <span class="hljs-section">[]</span>
    <span class="hljs-attr">result</span>=[]
    for i in range(numrows):
        <span class="hljs-attr">row</span>=[<span class="hljs-number">1</span>]*(i+<span class="hljs-number">1</span>)    <span class="hljs-comment">#初始化当前行，长度为i+1（第i行有i+1个元素），所有元素先设为1  C(i,0),C(i,j)=1</span>
        for j in range(1,i):
            row<span class="hljs-section">[j]</span>=row<span class="hljs-section">[j-1]</span>*(i-j+1)//j  <span class="hljs-comment">#数学公式法通过递推法 构建的 C(i,j) = i!/(j!*(i-j)!)</span>
        result.append(row)
    return result
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-28">细节？</h4>
<p>None</p>
<h4 data-id="heading-29">之前见过但没注意到的？</h4>
<p>创建二维数组</p>
<p>append() 可以添加数值也可以添加子向量</p>
<p>我以为 t=[1,]才能是列表</p>
<h4 data-id="heading-30"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a71801486ec4cfcb03d0cd99117ee50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5pyo6ZOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768894753&amp;x-signature=SnAnnU7d%2BouQaEuWH0cLBQJM60A%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h4>
<h4 data-id="heading-31">疑惑点/新知识 ？</h4>
<p>杨辉三角的数学公式怎么和递推结合</p>
<hr/>
<h2 data-id="heading-32"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></h2>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[leetcode_day10_筑基期_《绝境求生》]]></title>    <link>https://juejin.cn/post/7594405684592394292</link>    <guid>https://juejin.cn/post/7594405684592394292</guid>    <pubDate>2026-01-13T07:49:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594405684592394292" data-draft-id="7594655863547084852" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="leetcode_day10_筑基期_《绝境求生》"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-13T07:49:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="清木铎"/> <meta itemprop="url" content="https://juejin.cn/user/362175455046432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            leetcode_day10_筑基期_《绝境求生》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362175455046432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    清木铎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:49:42.000Z" title="Tue Jan 13 2026 07:49:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>​</p>
<h2 data-id="heading-0"><strong>目录</strong></h2>
<hr/>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>前言</h2>
<p><code>碎碎念：任何一句话，你只要不说出来，那你一直是它的主人，如果你把它说出来了，那未来可能成为它的奴隶。谨言慎行。</code></p>
<p>本系列《绝境求生》记录转码算法筑基过程，以代码随想录为纲学习，leetcode_hot_100练手，在此记录思考过程，方便过后复现。内容比较粗糙仅便于笔者厘清思路，复盘总结。</p>
<p>今天除了刷题， 过了一遍day 1,2,3 (哈希表，数组，链表)</p>
<hr/>
<p><code>提示：以下是本篇文章正文内容</code></p>
<h2 data-id="heading-2">一、128. 最长连续序列</h2>
<h3 data-id="heading-3">1、题目描述</h3>
<blockquote>
<p>给定一个<strong>未排序</strong>的整数数组 <code>nums</code>，找出数字连续的最长序列（不要求序列元素在原数组中连续）的长度。<strong>核心要求</strong>：算法的时间复杂度需优化到 <code>O(n)</code>（暴力法不满足，但用于理解逻辑）。</p>
<h4 data-id="heading-4">示例</h4>
<ul>
<li>
<p>示例 1：输入 <code>nums = [100,4,200,1,3,2]</code> → 输出 <code>4</code></p>
<ul>
<li>解释：最长连续序列是 <code>[1,2,3,4]</code>，长度为 4。</li>
</ul>
</li>
<li>
<p>示例 2：输入 <code>nums = [0,3,7,2,5,8,4,6,0,1]</code> → 输出 <code>9</code></p>
<ul>
<li>解释：最长连续序列是 <code>[0,1,2,3,4,5,6,7,8]</code>，长度为 9。</li>
</ul>
</li>
<li>
<p>示例 3：输入 <code>nums = []</code> → 输出 <code>0</code>；输入 <code>nums = [7]</code> → 输出 <code>1</code>。</p>
</li>
</ul>
<h4 data-id="heading-5">提示</h4>
<ul>
<li><code>0 &lt;= nums.length &lt;= 10^5</code></li>
<li><code>-10^9 &lt;= nums[i] &lt;= 10^9</code></li>
</ul>
</blockquote>
<h3 data-id="heading-6">2、简单理解？</h3>
<p>还不是单纯前一个数大于后一个数就行，必须步幅为1。 1,2,3才行。1,44,99不行</p>
<p>在数组中可以不连续，存在就行  比如【1100,4,200,1,3,2】输出是4</p>
<h3 data-id="heading-7">3、暴力法</h3>
<p>以num为起点，不断地找num+1</p>
<h4 data-id="heading-8">3.1、能不能用图示意？</h4>
<blockquote>
<pre><code class="hljs language-ini" lang="ini">遍历每个num：
<span class="hljs-attr">num</span>=<span class="hljs-number">100</span> → 找<span class="hljs-number">101</span>（不在）→ 长度<span class="hljs-number">1</span>
<span class="hljs-attr">num</span>=<span class="hljs-number">4</span> → 找<span class="hljs-number">5</span>（不在）→ 长度<span class="hljs-number">1</span>（重复计算，后续遍历<span class="hljs-number">1</span>时会重新统计<span class="hljs-number">1</span>-<span class="hljs-number">4</span>）
<span class="hljs-attr">num</span>=<span class="hljs-number">200</span> → 找<span class="hljs-number">201</span>（不在）→ 长度<span class="hljs-number">1</span>
<span class="hljs-attr">num</span>=<span class="hljs-number">1</span> → 找<span class="hljs-number">2</span>（在）→ 找<span class="hljs-number">3</span>（在）→ 找<span class="hljs-number">4</span>（在）→ 找<span class="hljs-number">5</span>（不在）→ 长度<span class="hljs-number">4</span>
<span class="hljs-attr">num</span>=<span class="hljs-number">3</span> → 找<span class="hljs-number">4</span>（在）→ 找<span class="hljs-number">5</span>（不在）→ 长度<span class="hljs-number">2</span>（重复计算）
<span class="hljs-attr">num</span>=<span class="hljs-number">2</span> → 找<span class="hljs-number">3</span>（在）→ 找<span class="hljs-number">4</span>（在）→ 找<span class="hljs-number">5</span>（不在）→ 长度<span class="hljs-number">3</span>（重复计算）
全局最大值：4
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-9">3.2、初始化条件？</h4>
<h4 data-id="heading-10">3.3、边界条件？</h4>
<p>空集或者只有一个元素</p>
<h4 data-id="heading-11">3.4、代码逻辑？</h4>
<p>剪枝，初始化最大长度 和 当前的长度为1，后面出现更大的再更新</p>
<h4 data-id="heading-12">3.5、之前见过但没注意到的？</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">max_len</span>=max(max_len,current_len)    没有最大，自己即为最大，出现更大，最大让位
</code></pre>
<h4 data-id="heading-13">3.6、疑惑点/新知识 ？</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">while</span> <span class="hljs-built_in">num</span>+current_len <span class="hljs-keyword">in</span> nums:     连着遍历<span class="hljs-built_in">num</span>+<span class="hljs-number">1</span>元素是否在数组中
</code></pre>
<h4 data-id="heading-14">3.7、python 代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">longestConsecutive</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-comment"># 边界条件1：数组为空，返回0</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nums:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
        
        <span class="hljs-comment"># 初始化最大长度为1（至少有一个元素时，最小长度是1）</span>
        max_len = <span class="hljs-number">1</span>
        
        <span class="hljs-comment"># 外层循环：遍历每个数字作为起始点</span>
        <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> nums:
            <span class="hljs-comment"># 初始化当前连续长度为1（当前数字自身）</span>
            current_len = <span class="hljs-number">1</span>
            <span class="hljs-comment"># 内层循环：查找num+1、num+2...是否在数组中</span>
            <span class="hljs-keyword">while</span> num + current_len <span class="hljs-keyword">in</span> nums:
                <span class="hljs-comment"># 找到连续数，长度+1</span>
                current_len += <span class="hljs-number">1</span>
            <span class="hljs-comment"># 更新全局最大长度</span>
            max_len = <span class="hljs-built_in">max</span>(max_len, current_len)
        
        <span class="hljs-keyword">return</span> max_len
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-15">4、优化法</h3>
<p>通过哈希表解题</p>
<h4 data-id="heading-16"> 4.1、能不能用图示意？</h4>
<blockquote>
<pre><code class="hljs language-ini" lang="ini">以 <span class="hljs-attr">nums</span> = [<span class="hljs-number">100</span>,<span class="hljs-number">4</span>,<span class="hljs-number">200</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>] 为例
步骤1：转集合 → <span class="hljs-attr">s</span> = {<span class="hljs-number">100</span>,<span class="hljs-number">4</span>,<span class="hljs-number">200</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>}
步骤2：遍历集合中的每个num：
<span class="hljs-attr">num</span>=<span class="hljs-number">100</span> → 检查<span class="hljs-number">100</span>-<span class="hljs-number">1</span>=<span class="hljs-number">99</span>是否在s？不在（是起点）→ 找<span class="hljs-number">101</span>（不在）→ 长度<span class="hljs-number">1</span>
<span class="hljs-attr">num</span>=<span class="hljs-number">4</span> → 检查<span class="hljs-number">4</span>-<span class="hljs-number">1</span>=<span class="hljs-number">3</span>是否在s？在（不是起点）→ 跳过
<span class="hljs-attr">num</span>=<span class="hljs-number">200</span> → 检查<span class="hljs-number">200</span>-<span class="hljs-number">1</span>=<span class="hljs-number">199</span>是否在s？不在（是起点）→ 找<span class="hljs-number">201</span>（不在）→ 长度<span class="hljs-number">1</span>
<span class="hljs-attr">num</span>=<span class="hljs-number">1</span> → 检查<span class="hljs-number">1</span>-<span class="hljs-number">1</span>=<span class="hljs-number">0</span>是否在s？不在（是起点）→ 找<span class="hljs-number">2</span>（在）→ 找<span class="hljs-number">3</span>（在）→ 找<span class="hljs-number">4</span>（在）→ 找<span class="hljs-number">5</span>（不在）→ 长度<span class="hljs-number">4</span>
<span class="hljs-attr">num</span>=<span class="hljs-number">3</span> → 检查<span class="hljs-number">3</span>-<span class="hljs-number">1</span>=<span class="hljs-number">2</span>是否在s？在（不是起点）→ 跳过
<span class="hljs-attr">num</span>=<span class="hljs-number">2</span> → 检查<span class="hljs-number">2</span>-<span class="hljs-number">1</span>=<span class="hljs-number">1</span>是否在s？在（不是起点）→ 跳过
步骤3：全局最大值=4
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-17">4.2、初始化条件？</h4>
<p>初始化current_len-0 因为 后面判断while current in nums: 会判断一次当前的current_len , 在就+1，与暴力法的current=1不同它判断的是while num+current_len是否在num中。</p>
<h4 data-id="heading-18">4.3、边界条件？</h4>
<p>none</p>
<h4 data-id="heading-19">4.4、代码逻辑？</h4>
<p>遍历nums中的每一个num，如果num-1存在于nums中，说明num不是最小，他就不能作为最长子序列的head，pass。 如果不在num中就+1看存不存在，长度递增返回长度</p>
<h4 data-id="heading-20">4.5、之前见过但没注意到的？</h4>
<h4 data-id="heading-21">4.6、疑惑点/新知识 ？</h4>
<p>找起点  num-1是否在nums中的思路 是减少查找的关键</p>
<h4 data-id="heading-22">4.7、python 代码</h4>
<pre><code class="hljs language-ini" lang="ini">from typing import List

class Solution:
    def longestConsecutive(self, nums: List<span class="hljs-section">[int]</span>) -&gt; int:
        <span class="hljs-comment"># 步骤1：将数组转为集合，O(1)查找+自动去重</span>
        <span class="hljs-attr">num_set</span> = set(nums)
        <span class="hljs-comment"># 初始化最大长度为0（兼容空数组）</span>
        <span class="hljs-attr">max_len</span> = <span class="hljs-number">0</span>
        
        <span class="hljs-comment"># 步骤2：遍历集合中的每个数字</span>
        for num in num_set:
            <span class="hljs-comment"># 核心判断：仅当num-1不在集合中，才是序列起点（避免重复计算）</span>
            if num - 1 not in num_set:
                <span class="hljs-comment"># 初始化当前数字为序列起点，当前长度为0</span>
                <span class="hljs-attr">current_num</span> = num
                <span class="hljs-attr">current_len</span> = <span class="hljs-number">0</span>
                
                <span class="hljs-comment"># 步骤3：查找连续数，直到找不到为止</span>
                while current_num in num_set:
                    <span class="hljs-comment"># 找到连续数，长度+1，当前数字+1</span>
                    current_len += 1
                    current_num += 1
                
                <span class="hljs-comment"># 步骤4：更新全局最大长度</span>
                <span class="hljs-attr">max_len</span> = max(max_len, current_len)
        
        <span class="hljs-comment"># 步骤5：返回结果（空数组时max_len仍为0）</span>
        return max_len
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-23"/>
<h2 data-id="heading-24"> 二、283 移动零</h2>
<h3 data-id="heading-25">1、题目描述</h3>
<blockquote>
<p>给定一个整数数组 <code>nums</code>，编写一个函数将所有 <code>0</code> 移动到数组的末尾，同时<strong>保持非零元素的相对顺序</strong>。<strong>核心约束</strong>：</p>
<ol>
<li>必须在<strong>原数组上操作</strong>（不能拷贝额外的数组）；</li>
<li>尽量减少操作次数（时间 / 空间复杂度最优）；</li>
<li>非零元素的相对顺序不能改变（比如 <code>[0,1,0,3,12]</code> 移动后必须是 <code>[1,3,12,0,0]</code>，而非 <code>[3,1,12,0,0]</code>）。</li>
</ol>
<h4 data-id="heading-26">示例</h4>
<ul>
<li>示例 1：输入 <code>nums = [0,1,0,3,12]</code> → 输出 <code>[1,3,12,0,0]</code>；</li>
<li>示例 2：输入 <code>nums = [0]</code> → 输出 <code>[0]</code>；</li>
<li>示例 3：输入 <code>nums = [1,2,3]</code> → 输出 <code>[1,2,3]</code>；</li>
<li>示例 4：输入 <code>nums = [0,0,1]</code> → 输出 <code>[1,0,0]</code>。</li>
</ul>
<h4 data-id="heading-27">提示</h4>
<ul>
<li><code>1 &lt;= nums.length &lt;= 10^4</code></li>
<li><code>-2^31 &lt;= nums[i] &lt;= 2^31 - 1</code></li>
</ul>
</blockquote>
<h3 data-id="heading-28">3、暴力法</h3>
<p>这题比较easy，快慢指针对换就可以解决。 其实也可以用暴力法while 连续覆盖</p>
<h4 data-id="heading-29">3.7、python 代码</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">nums</span>=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">55</span>,<span class="hljs-number">0</span>,<span class="hljs-number">43</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>]
def solution(nums):
    <span class="hljs-attr">n</span>=len(nums)
    slow,<span class="hljs-attr">fast</span>=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>
    while fast&lt;n:
        if nums<span class="hljs-section">[fast]</span>!=0:
            nums<span class="hljs-section">[slow]</span>,nums<span class="hljs-section">[fast]</span>=nums<span class="hljs-section">[fast]</span>,nums<span class="hljs-section">[slow]</span>
            slow+=1
        fast+=1
    return nums
solution(nums)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-30"> 三、11存最多水的容器</h2>
<h3 data-id="heading-31">1、题目描述</h3>
<blockquote>
<p>给定一个<strong>未排序</strong>的整数数组 <code>nums</code>，找出数字连续的最长序列（不要求序列元素在原数组中连续）的长度。<strong>核心要求</strong>：算法的时间复杂度需优化到 <code>O(n)</code>（暴力法不满足，但用于理解逻辑）。</p>
<h4 data-id="heading-32">示例</h4>
<ul>
<li>
<p>示例 1：输入 <code>nums = [100,4,200,1,3,2]</code> → 输出 <code>4</code></p>
<ul>
<li>解释：最长连续序列是 <code>[1,2,3,4]</code>，长度为 4。</li>
</ul>
</li>
<li>
<p>示例 2：输入 <code>nums = [0,3,7,2,5,8,4,6,0,1]</code> → 输出 <code>9</code></p>
<ul>
<li>解释：最长连续序列是 <code>[0,1,2,3,4,5,6,7,8]</code>，长度为 9。</li>
</ul>
</li>
<li>
<p>示例 3：输入 <code>nums = []</code> → 输出 <code>0</code>；输入 <code>nums = [7]</code> → 输出 <code>1</code>。</p>
</li>
</ul>
<h4 data-id="heading-33">提示</h4>
<ul>
<li><code>0 &lt;= nums.length &lt;= 10^5</code></li>
<li><code>-10^9 &lt;= nums[i] &lt;= 10^9</code></li>
</ul>
</blockquote>
<h3 data-id="heading-34">2、简单理解？</h3>
<p>area=两条线索引的距离*较短一线的高度</p>
<h3 data-id="heading-35">3、暴力法</h3>
<p>暴力枚举所有可能性就好了  作为一道中等题 感觉难度一般。但是暴力法超时了</p>
<h4 data-id="heading-36">3.7、python 代码</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 输入：[1,8,6,2,5,4,8,3,7]</span>
<span class="hljs-comment"># 输出：49</span>
<span class="hljs-attr">height</span>=[<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>]
def solution(height):
    <span class="hljs-attr">n</span>=len(height)
    <span class="hljs-attr">max_area</span>=<span class="hljs-number">0</span>
    for i in range(n):
        for j in range(i+1,n):
            <span class="hljs-attr">long</span>=j-i
            <span class="hljs-attr">width</span>=min(height[i],height[j])
            <span class="hljs-attr">current_area</span>=long*width
            <span class="hljs-attr">max_area</span>=max(max_area,current_area)
    return max_area
solution(height)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-37"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a42890233c2494bbad0b41a2b66c692~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5pyo6ZOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768895381&amp;x-signature=nDVAPxX4IKyxz%2FOQgGHrK%2FtFDQU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h3>
<h3 data-id="heading-38">4、优化法</h3>
<p>双指针法。 左短移左，右短移动右。其实优化法知道思路后也是很简单。</p>
<h4 data-id="heading-39"> 4.1、能不能用图示意？</h4>
<blockquote>
<pre><code class="hljs language-css" lang="css">以 <span class="hljs-attribute">height</span> = <span class="hljs-selector-attr">[1,8,6,2,5,4,8,3,7]</span> 为例
初始化：<span class="hljs-attribute">left</span>=<span class="hljs-number">0</span>（h=<span class="hljs-number">1</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">8</span>（h=<span class="hljs-number">7</span>），max_area=<span class="hljs-number">0</span>
步骤<span class="hljs-number">1</span>：宽度=<span class="hljs-number">8</span>，有效高度=<span class="hljs-number">1</span> → 面积=<span class="hljs-number">8</span> → max_area=<span class="hljs-number">8</span> → 左更短，<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>
步骤<span class="hljs-number">2</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>（h=<span class="hljs-number">8</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">8</span>（h=<span class="hljs-number">7</span>）→ 宽度=<span class="hljs-number">7</span>，有效高度=<span class="hljs-number">7</span> → 面积=<span class="hljs-number">49</span> → max_area=<span class="hljs-number">49</span> → 右更短，<span class="hljs-attribute">right</span>=<span class="hljs-number">7</span>
步骤<span class="hljs-number">3</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>（h=<span class="hljs-number">8</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">7</span>（h=<span class="hljs-number">3</span>）→ 宽度=<span class="hljs-number">6</span>，有效高度=<span class="hljs-number">3</span> → 面积=<span class="hljs-number">18</span> → max_area=<span class="hljs-number">49</span> → 右更短，<span class="hljs-attribute">right</span>=<span class="hljs-number">6</span>
步骤<span class="hljs-number">4</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>（h=<span class="hljs-number">8</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">6</span>（h=<span class="hljs-number">8</span>）→ 宽度=<span class="hljs-number">5</span>，有效高度=<span class="hljs-number">8</span> → 面积=<span class="hljs-number">40</span> → max_area=<span class="hljs-number">49</span> → 相等，<span class="hljs-attribute">right</span>=<span class="hljs-number">5</span>
步骤<span class="hljs-number">5</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>（h=<span class="hljs-number">8</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">5</span>（h=<span class="hljs-number">4</span>）→ 宽度=<span class="hljs-number">4</span>，有效高度=<span class="hljs-number">4</span> → 面积=<span class="hljs-number">16</span> → max_area=<span class="hljs-number">49</span> → 右更短，<span class="hljs-attribute">right</span>=<span class="hljs-number">4</span>
步骤<span class="hljs-number">6</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>（h=<span class="hljs-number">8</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">4</span>（h=<span class="hljs-number">5</span>）→ 宽度=<span class="hljs-number">3</span>，有效高度=<span class="hljs-number">5</span> → 面积=<span class="hljs-number">15</span> → max_area=<span class="hljs-number">49</span> → 右更短，<span class="hljs-attribute">right</span>=<span class="hljs-number">3</span>
步骤<span class="hljs-number">7</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>（h=<span class="hljs-number">8</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">3</span>（h=<span class="hljs-number">2</span>）→ 宽度=<span class="hljs-number">2</span>，有效高度=<span class="hljs-number">2</span> → 面积=<span class="hljs-number">4</span> → max_area=<span class="hljs-number">49</span> → 右更短，<span class="hljs-attribute">right</span>=<span class="hljs-number">2</span>
步骤<span class="hljs-number">8</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span>（h=<span class="hljs-number">8</span>），<span class="hljs-attribute">right</span>=<span class="hljs-number">2</span>（h=<span class="hljs-number">6</span>）→ 宽度=<span class="hljs-number">1</span>，有效高度=<span class="hljs-number">6</span> → 面积=<span class="hljs-number">6</span> → max_area=<span class="hljs-number">49</span> → 右更短，<span class="hljs-attribute">right</span>=<span class="hljs-number">1</span>
步骤<span class="hljs-number">9</span>：<span class="hljs-attribute">left</span>=<span class="hljs-number">1</span> &gt;= <span class="hljs-attribute">right</span>=<span class="hljs-number">1</span> → 遍历结束，返回<span class="hljs-number">49</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-40">4.7、python 代码</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 输入：[1,8,6,2,5,4,8,3,7]</span>
<span class="hljs-comment"># 输出：49</span>
<span class="hljs-attr">height</span>=[<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,<span class="hljs-number">6</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>]
def solution(height):
    <span class="hljs-attr">n</span>=len(height)
    <span class="hljs-attr">left</span>=<span class="hljs-number">0</span>
    <span class="hljs-attr">right</span>=n-<span class="hljs-number">1</span>
    <span class="hljs-attr">max_area</span>=<span class="hljs-number">0</span>
    while left&lt;right:
        <span class="hljs-attr">area</span>=(right-left)*min(height[left],height[right])
        <span class="hljs-attr">max_area</span>=max(area,max_area)
        if height<span class="hljs-section">[left]</span>&lt;height<span class="hljs-section">[right]</span>:
            left+=1
        else:
            <span class="hljs-attr">right-</span>=<span class="hljs-number">1</span>
    return max_area
solution(height)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-41"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></h2>
<p><strong>从利益出发它值不值得做不做，从风险出发它值不值得搏，从能力出发我能不能干，从结果出发它划不划算</strong></p>
<p><strong>飞扬跋扈得不到亲近</strong></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别RPA和脚本！视觉推理Agent，下一代自动化的暴力解法]]></title>    <link>https://juejin.cn/post/7594642978695446591</link>    <guid>https://juejin.cn/post/7594642978695446591</guid>    <pubDate>2026-01-13T08:50:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594642978695446591" data-draft-id="7592133956733190185" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别RPA和脚本！视觉推理Agent，下一代自动化的暴力解法"/> <meta itemprop="keywords" content="人工智能,Agent"/> <meta itemprop="datePublished" content="2026-01-13T08:50:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="贾维思基"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569632477"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别RPA和脚本！视觉推理Agent，下一代自动化的暴力解法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569632477/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    贾维思基
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:50:59.000Z" title="Tue Jan 13 2026 08:50:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>失踪两个半月，我又回来了。</p>
<p>两年前，公司因为一些自动化需求，我们采购了市面上比较主流的一款RPA产品。</p>
<p>但这两年用下来的感觉是，RPA确实能解决绝大多数的自动化问题，但维护成本实在太高。</p>
<p>这不，刚好一个月前智谱AI开源了一套叫作<strong>AutoGLM</strong>的GUI Agent框架，宣称是能让AI像人类一样看到手机屏幕内容并且执行自动化操作。</p>
<p>我寻思着有点意思，就去做了一把技术调研。</p>
<h2 data-id="heading-0">AutoGLM是什么</h2>
<p>AutoGLM是一个开源的<strong>多模态</strong>智能体（Agent）框架，专门用于构建能够理解和操作手机图形界面（Phone GUI Agent）的AI助手。它结合了大语言模型（LLM）和计算机视觉技术，让AI能够像人类一样“看到”屏幕内容并执行操作。</p>
<p>简单来说，它是一个基于<strong>LLM</strong>和<strong>计算机视觉技术</strong>构建的<strong>自动化Agent框架</strong>，用来帮你解放双手，轻松操控手机。</p>
<h2 data-id="heading-1">AutoGLM能做什么</h2>
<p>大家一定用过iphone的Siri语音智能助手吧，当你对它下达一个指令，它就能够帮你完成手机上的操作，AutoGLM其实干的就是这个，只不过更通用，更聪明，能支持更复杂的自动化操作！</p>
<p>举个例子，我让Safari帮我在淘宝上找出价格最低的AirPods Pro，并且支付下单，Safari做不到，但AutoGLM可以。</p>
<p>当然了，这两者的原理不同，Siri基于ios系统的内部API实现，因此有权限上的局限性，只能支持有系统操作权限的指令（能打开淘宝，但无法进行淘宝内的自动化操作），AutoGLM则是模拟人类进行自动化操作。</p>
<p>前阵子炒的火热的豆包手机也能做到和AutoGLM一样的事情，但AutoGLM具备跨设备的能力，它是技术框架而不是产品。</p>
<p>更重要的是，它开源啊！开源意味着什么，大家都是搞IT的，懂自懂。（再也不用担心钉钉没打上卡了）</p>
<h2 data-id="heading-2">AutoGLM的实现原理</h2>
<p>AutoGLM 的底层逻辑是一个<strong>基于实时状态感知的动态决策闭环</strong>。</p>
<p>当用户下达了一条自然语言指令，如“打开企业微信”，整个执行过程会被划分为3个阶段。</p>
<p><strong>阶段一：指令解析</strong></p>
<p>首先，Agent系统会通过自然语言理解引擎进行意图识别，大模型提取到关键动词“打开”和目标对象“企业微信”，将自然语言转化为结构化指令，识别出任务类型为"应用启动"，并确认目标应用为企业微信。</p>
<p><strong>阶段二：任务规划和分解</strong>
大模型收到“启动企业微信应用”这条高级指令后，会将其拆解为一系列原子化的可执行步骤，在AutoGLM的框架设计中，这一步是关键的分水岭，它不仅会思考“做什么”，还会通过内置的领域知识库（手机的操作逻辑）推理出“如何做”。</p>
<p>例如，对于“打开企业微信”这个任务，AutoGLM 内部的规划模块可能会生成如下步骤序列：</p>
<ol>
<li>唤醒手机屏幕（如果处于休眠状态的话）</li>
<li>返回主屏幕</li>
<li>判断当前页面是否有企业微信应用图标</li>
<li>点击企业微信应用图标打开应用</li>
</ol>
<p>这种规划过程，不仅依赖于大模型对通用任务步骤的推理能力，还紧密结合了 AutoGLM框架预先封装好的、针对手机操作系统的标准化单元。</p>
<p><strong>阶段三：感知与执行</strong></p>
<p>在这个阶段中，AutoGLM首先会利用ADB工具（Android Debug Bridge）对当前执行步骤下的手机屏幕进行实时截图，并将图像信息与当前的任务上下文一并发送给视觉理解模型。</p>
<p>视觉模型的核心工作，是进行<strong>像素到语义的翻译</strong>：</p>
<ul>
<li><strong>元素检测与解析</strong>：识别屏幕上的所有交互元素，如按钮、输入框、列表、图标，并标注其类型、位置和文本内容。</li>
<li><strong>布局与结构理解</strong>：分析元素的层级和空间关系，理解当前屏幕的逻辑结构（比如这是一个登录页、设置列表还是一个对话窗口）。</li>
<li><strong>状态与意图推断</strong>：结合任务上下文，判断当前界面状态。例如，在“发送微信消息”任务中，视觉模型能分辨出当前是停留在对话列表（需先点击联系人），还是已在聊天输入框界面（可直接输入文本）。</li>
</ul>
<p>基于视觉模型的解析结果，AutoGLM会将其转化为精确的、可执行的<strong>动作指令序列</strong>，并再次通过ADB执行。</p>
<p>假如当前处于步骤2，返回主屏幕后视觉理解模型从屏幕截图中识别到企业微信应用图标，那么将位置信息告诉大语言模型后可以得到“找到目标应用，调用ADB点击对应屏幕位置”的决策。</p>
<p>如果从屏幕截图中未识别到企业微信应用图标，那么由大语言模型推理下一步行动的规划，也就是“左右翻页”查找企业微信应用。</p>
<p><strong>重点总结</strong></p>
<p>在AutoGLM的设计架构中，存在两种模型，分别是<strong>视觉理解模型</strong>和<strong>大语言模型</strong>，各自承担不同的职责。</p>
<p><strong>视觉理解模型</strong>只负责<strong>解析屏幕截图</strong>并将结构化的解析结果转换成自然语言并告知大语言模型，<strong>大语言模型</strong>通过结合分解用户指令得到的逻辑步骤和视觉理解模型的实时描述结果进行<strong>决策</strong>，并<strong>推理出下一步行动</strong>，如此循环直到目标实现。</p>
<h2 data-id="heading-3">AutoGLM实战教学</h2>
<p>这里仅以安卓手机为例，如果你是鸿蒙手机或苹果手机，请移步至官方文档。</p>
<p>官方文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM" target="_blank" title="https://github.com/zai-org/Open-AutoGLM" ref="nofollow noopener noreferrer">github.com/zai-org/Ope…</a></p>
<h3 data-id="heading-4">前置准备</h3>
<ul>
<li>一根支持数据传输的数据线</li>
<li>一台笔记本或台式机（有无线网卡更佳）</li>
<li>一部安卓系统手机</li>
</ul>
<p>满足这些硬性条件后我们就可以开始了。</p>
<h3 data-id="heading-5">开发环境搭建</h3>
<h4 data-id="heading-6">1. 安装Python环境</h4>
<p>建议版本：</p>
<blockquote>
<p>Python &gt;= 3.10</p>
<p>pip &gt;= 22.x</p>
</blockquote>
<p>Python的安装过程这里不多做介绍，请自行百度~</p>
<h4 data-id="heading-7">2. 安装ADB工具</h4>
<p>下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftools%2Freleases%2Fplatform-tools%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/tools/releases/platform-tools?hl=zh-cn" ref="nofollow noopener noreferrer">developer.android.com/tools/relea…</a></p>
<p>下载完成后需要手动配置环境变量，否则运行AutoGLM项目时会出现识别不到ADB的情况。</p>
<h4 data-id="heading-8">3. 注册API Key</h4>
<p>平台地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbigmodel.cn%2Fusercenter%2Fproj-mgmt%2Fapikeys" target="_blank" title="https://bigmodel.cn/usercenter/proj-mgmt/apikeys" ref="nofollow noopener noreferrer">bigmodel.cn/usercenter/…</a></p>
<p>注册好帐号后，按照以下步骤操作即可</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b3e17ce29e4cbeae26b126bfcfba2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LS-57u05oCd5Z-6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899059&amp;x-signature=dIJspm%2BnyzALRv9fGwC5Sqqac5A%3D" alt="image.png" width="100%" loading="lazy"/>
<p>不得不说智谱还是很慷慨的，新用户注册送2000万Token，对于非重度用户来说绝对是够用的。</p>
<h4 data-id="heading-9">3. 获取源码</h4>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM" target="_blank" title="https://github.com/zai-org/Open-AutoGLM" ref="nofollow noopener noreferrer">github.com/zai-org/Ope…</a></p>
<pre><code class="hljs language-shell" lang="shell">git clone https://github.com/zai-org/Open-AutoGLM.git
</code></pre>
<h4 data-id="heading-10">4. 配置API Key</h4>
<p>进入项目根目录并创建.env文件</p>
<pre><code class="hljs language-txt" lang="txt"># .env 文件内容，这里把${API_KEY}替换成刚刚复制的API Key  
GLM_API_KEY=${API_KEY}
</code></pre>
<h4 data-id="heading-11">5. 安装项目依赖</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1. 安装基础依赖</span>
pip install -r requirements.txt 
<span class="hljs-meta prompt_">
# </span><span class="bash">2. 以编辑模式安装项目本身 (关键步骤)</span>
pip install -e .
</code></pre>
<p>到这里，PC端的项目环境配置我们就完成了，接下来开始进行手机端项目环境配置。</p>
<h4 data-id="heading-12">6. 启用开发者模式</h4>
<p>在手机上，进入"设置" → "关于手机"，找到"版本号"，连续点击 7 次（直到出现提示），你会看到"您已处于开发者模式"的提示。</p>
<p>返回设置主界面，进入"开发者选项"，找到"USB调试"和"无线调试"两个选项并开启。</p>
<p>这一步每台手机有些许差异，大家根据实际情况操作就行。</p>
<h4 data-id="heading-13">7. 安装ADB Keyboard</h4>
<p>下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsenzhk%2FADBKeyBoard%2Fraw%2Fmaster%2FADBKeyboard.apk" target="_blank" title="https://github.com/senzhk/ADBKeyBoard/raw/master/ADBKeyboard.apk" ref="nofollow noopener noreferrer">github.com/senzhk/ADBK…</a></p>
<p>下载完成后在手机上进行应用安装。</p>
<p>安装完成后需要在手机【设置-键盘-输入法】中手动切换为ADB Keyboard。</p>
<p>输入时屏幕底部会出现ADB Keyboard的字样（每台手机可能有差异）。</p>
<h4 data-id="heading-14">8. 项目依赖安装</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1. 进入项目</span>
cd Open-AutoGLM
<span class="hljs-meta prompt_">
# </span><span class="bash">2. 安装基础依赖</span>  
pip install -r requirements.txt  
<span class="hljs-meta prompt_">
# </span><span class="bash">3. 以编辑模式安装项目本身 (关键步骤)</span>  
pip install -e .
<span class="hljs-meta prompt_">
# </span><span class="bash">4.</span> 
</code></pre>
<h4 data-id="heading-15">9. 验证设备通信</h4>
<p>在项目运行之前，用准备好的数据线连接电脑和手机，确保能正常通信（连接成功手机上会出现是否信任设备的弹窗，确认即可）。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">在控制台输入adb devices命令，验证设备是否连接成功（如果找不到adb命令，请检查步骤2）</span>
adb devices
</code></pre>
<p>当连接成功，控制台会输出设备信息</p>
<pre><code class="hljs language-shell" lang="shell">List of devices attached  
xxxxx    device
</code></pre>
<p>到这里，我们就完成了整个开发环境的搭建。</p>
<h3 data-id="heading-16">项目运行</h3>
<h4 data-id="heading-17">方式一</h4>
<p>我们先采用最简单的方式，也就是通过<strong>主文件入口</strong>运行AutoGLM。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1. 进入项目</span>
cd Open-AutoGLM
<span class="hljs-meta prompt_">
# </span><span class="bash">2. 运行AutoGLM</span>
python main.py --base-url https://open.bigmodel.cn/api/paas/v4 --model "autoglm-phone" --apikey "这里填之前注册的API Key" "这里填要执行的操作，比如打开企业微信"
</code></pre>
<p>如果运行成功，会出现如下输出，并且在手机会开始执行进行自动化操作，否则请根据日志输出排查相应步骤。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edc69591e8f457e8b833b9571370b09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LS-57u05oCd5Z-6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899059&amp;x-signature=u9%2B%2FNnuBzLkeco70OCKRj8jPago%3D" alt="run_agent.png" width="100%" loading="lazy"/>
<p>除了数据线传输，AutoGLM也支持局域网传输，手机和电脑需要连接同一局域网，然后在命令行参数中携带--connect参数并填写ip和端口信息。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">127.0.0.1需要替换成实际的局域网ip，通信的默认端口为5555，不需要做更改</span>
python main.py --connect 127.0.0.1:5555 --base-url https://open.bigmodel.cn/api/paas/v4 --model "autoglm-phone" --apikey "这里填之前注册的API Key" "这里填要执行的操作，比如打开企业微信"
</code></pre>
<h4 data-id="heading-18">方式二</h4>
<p>AutoGLM项目本身已经集成了接口服务，如果我们想作为服务暴露给外部进行调用，可以采用这种方式运行。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">启动服务</span>
<span class="hljs-meta prompt_"># </span><span class="bash">uvicorn server:app --host 0.0.0.0 --port 8001</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 健康检查（GET请求）</span>
http://{ip}:8001/health

<span class="hljs-comment"># 列出当前已连接设备（GET请求）</span>
http://{ip}:8001/devices

<span class="hljs-comment"># 运行AutoGLM（POST请求）</span>
http://{ip}:8001/run
{
   <span class="hljs-string">"task"</span>: <span class="hljs-string">"打开企业微信"</span>,
   <span class="hljs-string">"base_url"</span>: <span class="hljs-string">"https://open.bigmodel.cn/api/paas/v4"</span>,    <span class="hljs-comment"># 可选，默认读取环境变量</span>
   <span class="hljs-string">"model"</span>: <span class="hljs-string">"autoglm-phone"</span>,                               <span class="hljs-comment"># 可选</span>
   <span class="hljs-string">"api_key"</span>: <span class="hljs-string">"这里填写API_Key"</span>,                     <span class="hljs-comment"># 可选</span>
   <span class="hljs-string">"device_type"</span>: <span class="hljs-string">"adb"</span> | <span class="hljs-string">"hdc"</span> | <span class="hljs-string">"ios"</span>,                 <span class="hljs-comment"># 可选，默认 adb</span>
   <span class="hljs-string">"device_id"</span>: <span class="hljs-string">"emulator-5554"</span>,                           <span class="hljs-comment"># 可选</span>
   <span class="hljs-string">"max_steps"</span>: 100,                                         <span class="hljs-comment"># 可选</span>
   <span class="hljs-string">"lang"</span>: <span class="hljs-string">"cn"</span> | <span class="hljs-string">"en"</span>,                                   <span class="hljs-comment"># 可选</span>
   <span class="hljs-string">"wda_url"</span>: <span class="hljs-string">"http://localhost:8100"</span>                      <span class="hljs-comment"># iOS可选</span>
}
</code></pre>
<h2 data-id="heading-19">第三方工具拓展</h2>
<p>如果大家仅仅想尝个鲜，或是想要开箱即用，那么推荐使用社区的可视化工具【AutoGLM GUI】，应用内置了AutoGLM的全部运行环境，只需要在手机上安装好ADB Keyboard，开启调试模式，就能够以最直观的方式运行AutoGLM。</p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsuyiiyii%2FAutoGLM-GUI" target="_blank" title="https://github.com/suyiiyii/AutoGLM-GUI" ref="nofollow noopener noreferrer">github.com/suyiiyii/Au…</a></p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/570da1a32b9549698df359847b9048f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LS-57u05oCd5Z-6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899059&amp;x-signature=sIg16W27%2BY63JjW1o3Nb%2BMyRmFo%3D" alt="AutoGLM_GUI.png" width="100%" loading="lazy"/>
<p>整个界面的布局非常简洁清晰，左侧是连接的设备信息，中间是AutoGLM的思考过程，右侧是手机的实时画面。</p>
<h2 data-id="heading-20">结语</h2>
<p>AutoGLM有意思在哪儿？我认为是它的设计理念，它抛弃了传统自动化那套预设流程，通过实时的图像解析和规划推理来完成自动化。</p>
<p>按钮没出来就等等，布局变了就找找，应用崩溃了就重启，实在不行还知道换条路试试。</p>
<p>不得不说，这是一个很大胆的下注，压的是LLM这个方向的未来，毕竟AI幻觉、推理效率低下、Token费用高这些被诟病的问题未来究竟会不会被解决，我们谁也说不准。</p>
<p>但文明与科技的进步始于期待和想象，任何一个先驱者都值得被尊敬。</p>
<p>现在的GUI Agent虽然还不太完美，但这条路，已经挺让人期待了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Prompt Engineering基础实践：角色设定/约束条件等技巧]]></title>    <link>https://juejin.cn/post/7594576956421210138</link>    <guid>https://juejin.cn/post/7594576956421210138</guid>    <pubDate>2026-01-13T09:05:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956421210138" data-draft-id="7594523145211150390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Prompt Engineering基础实践：角色设定/约束条件等技巧"/> <meta itemprop="keywords" content="OpenAI,Agent"/> <meta itemprop="datePublished" content="2026-01-13T09:05:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草帽lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Prompt Engineering基础实践：角色设定/约束条件等技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草帽lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:05:09.000Z" title="Tue Jan 13 2026 09:05:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>之前学习了一些模型API调用，以及一些文本分类和内容生成的一些基础技巧和案例，接下来实操一下 Prompt Engineering 相关技巧</p>
<h2 data-id="heading-1">Prompt Engineering</h2>
<p>Prompt Engineering（提示词工程）是设计和优化用于与AI语言模型交互的输入提示的过程，目的是引导模型产生更准确、相关和有用的输出</p>
<p>这个常用AI工具都知道，平时和AI对话的内容就是提示词，根据不同场景使用不同的对话方式和提问技巧，AI模型才会根据不同提示词回答不同的结果</p>
<h2 data-id="heading-2">基本原则</h2>
<ol>
<li><strong>明确性</strong>：清晰表达需求</li>
<li><strong>具体性</strong>：提供详细信息</li>
<li><strong>上下文</strong>：给出必要背景</li>
<li><strong>示例</strong>：提供参考样例</li>
<li><strong>约束</strong>：设定输出限制</li>
</ol>
<p>这方面就不多说了，瞎给AI说，让AI去猜的话，Ta的回答也是瞎掰，这些都是基本使用技巧，我们主要还是看代码中是如何使用的</p>
<h2 data-id="heading-3">基础实践</h2>
<h3 data-id="heading-4">零样本提示</h3>
<p>零样本提示（Zero-shot Prompting）是指在没有任何示例的情况下，直接给模型一个任务描述，让模型根据描述完成任务</p>
<p>例如直接问豆包，"判断以下文本的情感：今天的天气真糟糕，一切都不顺利！"，模型会根据描述直接回答</p>
<p>如果是问豆包"今天北京的天气怎么样？"，这个回答是查了相关天气API然后回答的</p>
<p>下面看代码的情况</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os 
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv 
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI 

<span class="hljs-comment"># 加载环境变量 </span>
load_dotenv() 

<span class="hljs-comment"># 初始化客户端 </span>
client = OpenAI(api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>)) 

<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
client = OpenAI()

response = client.chat.completions.create(
    model=<span class="hljs-string">"gpt-5-nano"</span>,
    messages=[
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"判断以下文本的情感：今天的天气真糟糕，一切都不顺利！"</span>}
    ]
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"情感判断结果: <span class="hljs-subst">{response.choices[<span class="hljs-number">0</span>].message.content}</span>"</span>)
</code></pre>
<p>输出情感结果：负面，并说明了理由</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/418e60f8a14a49bcaa1e4dc4a617f5f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899908&amp;x-signature=RiQ4O5SquV6MIY4j47wq08lWfuw%3D" alt="" loading="lazy"/></p>
<p>和文本分类，文本生成代码用法一样，只是 <code>content</code> 参数中的内容变了</p>
<h3 data-id="heading-5">少样本提示</h3>
<p>少样本提示（Few-shot Prompting），就是提供少量示例引导模型的回答</p>
<p>看下面这个例子</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
    model=<span class="hljs-string">"gpt-5-nano"</span>,
    messages=[
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"将以下文本分类为积极、消极或中性：\n1. 这部电影太棒了！→ 积极\n2. 今天下雨了。→ 中性\n3. 我讨厌排队。→ 消极\n4. 这家餐厅的食物很美味。→"</span>}
    ]
)

<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<p>提供了三种类型的分类示例，让模型分析提供的句子属于哪种分类结果</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3fc29a385f84a1f8f0195bafcc9021c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899908&amp;x-signature=Gp3VNMnghH%2FwwfEsy7z4Kk3sWiA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">思维链提示</h3>
<p>思维链提示（Chain-of-Thought Prompting），就是在提示中包含一系列中间步骤，引导模型逐步思考和解决问题</p>
<p>在一些需要多步骤操作推理的场景中，例如在编码中也常见，例如要实现一个复杂的函数功能，提示中可以包含函数的实现步骤，引导模型逐步编写代码</p>
<p>不过现在的AI模型似乎已经能够把很多需求自己分析理解直接干活了，很多时候直接在 Antigravity，Trae CN，等AI编辑器中直接描述需要的结果的就行（工程师彻底化身需求描述师）</p>
<p>好了，看个日常行程规划的例子，里面涉及到因果推理</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
    model=<span class="hljs-string">"gpt-5-nano"</span>,
    messages=[
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"问题：小红要在周日完成以下事情：①洗衣服（30 分钟）、②做饭（40 分钟）、③打扫房间（25 分钟）、④看电影（1 小时）。请帮她规划最省时的顺序，并说明原因。请分步分析哪些事情可以同时做，再计算总耗时"</span>}
    ]
)

<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<p>模型分析的很好，给出回答的同时，还考虑了实际场景中的时间冲突问题，例如在做饭时要高度专注等，会降低并行程度</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b07f0707a0294a6395905ab00e007ec1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899908&amp;x-signature=3yV9zxD0ly2Tgt2nRc3vqJgzIu8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">角色设定</h3>
<p>角色设定（Role-playing Prompting），就是在提示中指定模型的角色和行为</p>
<p>例如，让它扮演专业客服，回答用户问题时要专业、友好；扮演一名专业老师，根据用户问题，用专业的语言回答</p>
<p>日常我们在AI编辑器中用的最多的就是角色设定，前提都是让模型扮演专业的资深工程师，然后根据问题回答对应的编码问题</p>
<p>下面看一个简单的代码例子</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
    model=<span class="hljs-string">"gpt-5-nano"</span>,
    messages=[
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一位专业的英语教师，请用简单易懂的方式解释语法。"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请解释现在完成时的用法。"</span>}
    ]
)

<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<p><strong>注意！</strong> 上面的代码明显参数多了内容，``message` 中包含了系统角色和用户角色的内容</p>
<p>虽然问题简单，模型的回答很丰富，还会进行下一步引导提示，完整输出如下</p>
<pre><code class="hljs language-shell" lang="shell">(venv) w@GYW:~/AIProjects/ai-agent-project$ python test_openai.py 
下面用简单的方式解释现在完成时（present perfect）。

1) 结构
- 肯定句：主语 + have/has + 过去分词（V3）
  - I have finished. / She has eaten. / They have gone.
- 否定句：主语 + have/has not + 过去分词
  - I have not seen it. / He hasn’t finished yet.
- 疑问句：Have/Has + 主语 + 过去分词？
  - Have you visited Paris? / Has she eaten?

小提醒：动词的过去分词要记，规则动词用-ed，不规则动词要记形。

2) 现在完成时的常见用法（要点）
- 用法A：到现在为止的“经历”。不指明具体时间，强调已经做过某事的经验或经历。
  - 例：I have been to Japan. / Have you ever tasted sashimi?
- 用法B：从过去一直持续到现在，可能还在继续。常用 since/for 表示起点或持续时间。
  - 例：She has lived here for five years. / He has worked at the company since 2010.
- 用法C：最近发生，对现在有影响/结果。
  - 例：I have just finished my homework. / They have already left.
  - 常用词：just（刚刚）、recently/recent（最近）、already（已经）
- 用法D：在还没结束的时间段内发生过多次（或仍在发生）。
  - 例：This week I have seen three movies. / I have visited three museums today.（时间段还没结束）
- 用法E：与时间信号词搭配时的用法
  - 信号词：ever, never, just, already, recently, lately, so far, up to now, for, since, this week, today
  - 注意：带具体过去时间的词（yesterday、last year 等）通常用一般过去时，而不是现在完成时。

3) 与一般过去时的区别（要点对比）
- 现在完成时关注“直到现在的影响、经验或结果”，不特别说具体哪一天发生了什么。
- 一般过去时讲的是“在过去某一具体时间发生并结束的事”。
  - 例：I lived in Paris for two years.（过去的经历，但已经结束） vs I have lived in Paris for two years.（到现在还可能还住在巴黎，强调持续到现在）
  
4) 常见错误及要点
- 错写过去分词：I have went（错，正确：gone）/ I have eaten（对）
- 不该和具体时间一起用现在完成时：有具体时间点的事用一般过去时，如 Yesterday I came home早；不过如果强调“从那时到现在的影响”，也可用现在完成时但较少见。
- “have/has + been” 的用法：与地点、状态相关时常用 be 的过去分词（been）来表示去过某地或经历过某事。
  - I have been to China.（去过，回来） vs I have gone to China.（去中国了，可能还没回）

5) 快速练习（请用现在完成时写出英文句子）
- 你到过日本吗？ → Have you ever been to Japan?
- 他从两年前一直住在这里。 → He has lived here for two years.（如果现在不再住这里，用过去时：lived here for two years and moved away）
- 我刚吃完晚饭。 → I have just eaten dinner.
- 我们这一周看过三部电影。 → We have seen three movies this week.

如果你愿意，我可以给你一组练习题和答案，或者根据你的水平给出更多例句练习。需要的话告诉我你的母语、希望重点练习的场景（如旅行、工作、考试等）。
</code></pre>
<p>偏专业化的问答时，非常适合这种角色设定模式</p>
<h3 data-id="heading-8">约束条件</h3>
<p>这个可太常见了，例如让代码生成一段 <code>草帽lufei</code> 的自我介绍，让它限制字数，例如100字以内</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
    model=<span class="hljs-string">"gpt-5-nano"</span>,
    messages=[
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请给'草帽lufei'这个公众号博主写一段100字的介绍，他近期专注研究AI Agent相关应用和开发内容。"</span>},
    ]
)

<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1707809417a4c4186ad062ce101e07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899908&amp;x-signature=kJOmImmFpUh8otKQ4qmDCeLiy4I%3D" alt="" loading="lazy"/></p>
<p>日常生活中，提供资料让AI写总结，输出格式为Word，或者代码输出为JSON，或者使用其他语言实现等都是约束条件</p>
<h2 data-id="heading-9">小结</h2>
<p>提示词工程师充分发挥AI大模型能力的关键，通过精心设计的提示词可以让模型更好的理解我们的需求，并生成符合需求的内容</p>
<p>像一些图片，视频的生成就需要更专业的提示词去调教，才能出一些更符合需求的作品，因为强专业性的门槛，也出现了专门卖提示词的一些平台</p>
<p>总之，提示词工程既然是一个工程，就是一个长期学习测试总结的一个过程，只有不断尝试，才能很好的掌握相关的技巧</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/598048f17df840d2b5136fbef6e0c583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899908&amp;x-signature=DdSInJja5RyOauys23%2F%2Fyf95IBI%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>欢迎留言交流，如果觉得有帮助，可以<code>点个赞</code>支持一下</p>
<p>公众号：草帽lufei</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[agent-browser：让 AI Agent 像人一样浏览网页（节省93% Token）]]></title>    <link>https://juejin.cn/post/7594662879201460250</link>    <guid>https://juejin.cn/post/7594662879201460250</guid>    <pubDate>2026-01-13T09:45:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662879201460250" data-draft-id="7594662879201427482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="agent-browser：让 AI Agent 像人一样浏览网页（节省93% Token）"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-13T09:45:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI首席情报员_阿布"/> <meta itemprop="url" content="https://juejin.cn/user/4114839354741274"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            agent-browser：让 AI Agent 像人一样浏览网页（节省93% Token）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4114839354741274/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI首席情报员_阿布
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:45:33.000Z" title="Tue Jan 13 2026 09:45:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">agent-browser：让 AI Agent 像人一样浏览网页（节省93% Token）</h2>
<h3 data-id="heading-1">为什么是 agent-browser</h3>
<p>如果你正在开发 AI Agent，或者尝试用 LLM 来控制浏览器进行自动化操作，那么你大概率遇到过这两个"拦路虎"：</p>
<ol>
<li><strong>Token 贵且慢（Context Rot）</strong> ：一个普通的网页 HTML 动辄几百 KB，直接喂给 LLM，不仅 Token 消耗惊人，而且充满噪音（CSS、Script 标签）。LLM 在处理这种长文本时，极易产生幻觉（Hallucination），我们称之为"上下文腐烂"（Context Rot）。</li>
<li><strong>选择器脆弱（Flaky Selectors）</strong> ：传统的 <code>div &gt; div.content &gt; span</code> 选择器脆弱不堪。网页稍微改版，class 名变一下，你的 Agent 就从"自动化"变成了"人工报错机"。</li>
</ol>
<p>针对这两个核心痛点，Vercel Labs 开源了 <strong>agent-browser</strong>。</p>
<p>它不是简单的 Playwright 封装，而是专为 LLM 设计的浏览器接口。</p>
<p><strong>核心价值</strong>：</p>
<ul>
<li><strong>节省高达 93% 的 Token</strong>：它不给 LLM 看原始 HTML，而是经过语义清洗后的精简结构。</li>
<li><strong>告别脆弱选择器</strong>：支持自然语言交互，Agent 不再依赖死板的 CSS 选择器。</li>
<li><strong>开箱即用</strong>：零配置，无需繁琐的 MCP 安装，一条命令即可启动。</li>
</ul>
<hr/>
<h3 data-id="heading-2">核心原理：它是如何"像人一样"浏览的？</h3>
<p>传统的自动化是为了"测试"，所以追求精确的 DOM 匹配。而 <code>agent-browser</code> 是为了"理解"，所以它追求语义的提取。</p>
<h4 data-id="heading-3">◈1. 拒绝"上下文腐烂"</h4>
<p>我们来看一组真实对比。假设我们要访问 Hacker News 首页并提取头条新闻。</p>
<p><strong>传统方式（Playwright <code>page.content()</code>）</strong> ： 你需要将包含大量 <code>&lt;script&gt;</code>, <code>&lt;style&gt;</code>, <code>&lt;div&gt;</code> 嵌套的原始 HTML 传给 LLM。</p>
<ul>
<li><strong>Token 消耗</strong>：~15k Tokens</li>
<li><strong>噪点</strong>：极高（90% 是无用代码）</li>
</ul>
<p><strong>Agent Browser 方式</strong>： 它会利用无障碍树（Accessibility Tree）和语义分析，将页面转化为 LLM "喜欢" 的格式。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"link"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Show HN: My new project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://..."</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>Token 消耗</strong>：~800 Tokens</li>
<li><strong>节省比例</strong>：<strong>93%</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b83e7b57833441e59c9326f94b346b61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnpppbluK3mg4XmiqXlkZhf6Zi_5biD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=Df4iJ%2FnSB8bNJHncGTviRgX7c%2FE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">◈2. 语义化交互（Semantic Interaction）</h4>
<p>你不需要再去查 <code>Check State</code> 或者写 <code>await page.click('#submit-btn')</code>。<code>agent-browser</code> 允许你直接说"人话"。</p>
<p><strong>场景</strong>：点击登录按钮。</p>
<p><strong>以前（Playwright）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 如果 id 变了，这就挂了</span>
<span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#login-button-v2'</span>); 
</code></pre>
<p><strong>现在（agent-browser）</strong> ： 它是"快照 + 引用"模式。</p>
<ol>
<li><strong>Snapshot</strong>: 生成语义树，给每个元素分配短引用（如 <code>@e1</code>, <code>@e2</code>）。</li>
<li><strong>Action</strong>: 基于引用操作。</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">agent-browser click @e1
</code></pre>
<p>你（或者你的 Agent）只需要认准 <code>@e1</code> 这个语义标签，而不需要关心底层的 DOM 结构变化。</p>
<hr/>
<h3 data-id="heading-5">Technical Deep Dive：5分钟实战上手</h3>
<h4 data-id="heading-6">◈1. 安装与启动</h4>
<p>它是基于 Rust (CLI) 和 Node.js (Daemon) 构建的，速度极快。</p>
<pre><code class="hljs language-r" lang="r"><span class="hljs-comment"># 无需配置 MCP，直接 npx</span>
npm install <span class="hljs-operator">-</span>g agent<span class="hljs-operator">-</span><span class="hljs-built_in">browser</span>

<span class="hljs-comment"># 验证安装</span>
agent<span class="hljs-operator">-</span><span class="hljs-built_in">browser</span> help
</code></pre>
<h4 data-id="heading-7">◈2. 真实场景演示：抓取 Github Trending</h4>
<p>假设我们要写一个 Agent，每天早上自动抓取 GitHub Trending 的第一名项目。</p>
<p><strong>第一步：导航</strong> 它没有复杂的"启动会话"命令，直接 open 即可自动连接后台 Daemon。</p>
<pre><code class="hljs language-arduino" lang="arduino">agent-browser open <span class="hljs-string">"https://github.com/trending"</span>
</code></pre>
<p><strong>第二步：获取语义快照 (Snapshot)</strong> 这是最关键的一步。我们不看 HTML，而是请求快照：</p>
<pre><code class="hljs language-r" lang="r">agent<span class="hljs-operator">-</span><span class="hljs-built_in">browser</span> snapshot
</code></pre>
<p><strong>Agent 看到的简化结果 (JSON)</strong> ：</p>
<pre><code class="hljs language-perl" lang="perl">[
  { <span class="hljs-string">"id"</span>: <span class="hljs-string">"@e1"</span>, <span class="hljs-string">"role"</span>: <span class="hljs-string">"link"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"vercel-labs/agent-browser"</span> },
  { <span class="hljs-string">"id"</span>: <span class="hljs-string">"@e2"</span>, <span class="hljs-string">"role"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"Browser automation for AI agents"</span> }
]
</code></pre>
<p><strong>第三步：提取内容</strong> AI 识别出 <code>@e1</code> 是我们想要的项目，于是执行：</p>
<pre><code class="hljs language-scss" lang="scss">agent-browser get text <span class="hljs-keyword">@e</span>1
# <span class="hljs-attribute">Output</span>: vercel-labs/agent-browser
</code></pre>
<p>注意，全过程我们没有写任何 CSS 选择器（如 <code>.RepoList-item .f3 a</code>）！因为 snapshot 已经帮我们提取了语义结构。</p>
<h4 data-id="heading-8">◈3. 与 Claude / Cursor 集成</h4>
<p>这才是它最强大的地方。你可以把 <code>agent-browser</code> 当作一个工具（Tool）挂载给你的 AI Coding Assistant。</p>
<p>如果你使用的是 Cursor，可以直接在 Terminal 中运行它。如果你自己在开发 Agent，可以这样集成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AgentBrowser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'agent-browser'</span>;

<span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AgentBrowser</span>();
<span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newPage</span>();

<span class="hljs-comment">// 给 LLM 的 System Prompt 中加入：</span>
<span class="hljs-comment">// "You have access to a browser tool. Use browser.interact(instruction) to control it."</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">避坑指南（踩坑案例）</h3>
<p>Warning</p>
<p><strong>避坑指南</strong>：虽然 <code>agent-browser</code> 很强，但在实际生产环境中使用，也有一些需要注意的地方。不要盲目乐观。</p>
<h4 data-id="heading-10">◈1. 复杂动态页面的等待</h4>
<p><strong>问题场景</strong>： 在访问类似 React/Vue 构建的重型 SPA（单页应用）时，页面元素是动态加载的。</p>
<p><strong>错误做法</strong>： Navigate 之后立即 Query。</p>
<pre><code class="hljs language-bash" lang="bash">agent-browser navigate <span class="hljs-string">"https://complex-app.com"</span>
agent-browser query <span class="hljs-string">"Get usage stats"</span>
<span class="hljs-comment"># Error: Element not found (因为还没由于 loading 完)</span>
</code></pre>
<p><strong>正确做法</strong>： 显式等待某个语义元素出现。</p>
<pre><code class="hljs language-bash" lang="bash">agent-browser <span class="hljs-built_in">wait</span> <span class="hljs-string">"Usage chart"</span> --<span class="hljs-built_in">timeout</span> 5000
agent-browser snapshot
</code></pre>
<h4 data-id="heading-11">◈2. Form 表单的交互</h4>
<p><strong>问题</strong>： 有时候 LLM 会一次性填完所有表单，但网页逻辑是"填完一个 Input 触发一个 Validation"。</p>
<p><strong>建议</strong>： 对于复杂的 Step-by-Step 表单，建议拆分指令，不要试图用一条 prompt 完成所有交互。</p>
<hr/>
<h3 data-id="heading-12">总结：AI 时代的浏览器</h3>
<p>我们正在经历从"脚本自动化"到"Agent 自动化"的转型。</p>
<ul>
<li><strong>脚本时代</strong>：我们写死每一个步骤，追求 100% 的确定性，维护成本极高。</li>
<li><strong>Agent 时代</strong>：我们给出意图（Intent），由 AI 处理细节，追求的是适应性和理解力。</li>
</ul>
<p><code>agent-browser</code> 并不是要替代 Playwright，它是 Playwright 在 AI 时代的翻译官。它把人类看不懂的 DOM，翻译成了 AI 能看懂的语义。</p>
<p>如果你的 Token 账单居高不下，或者你的爬虫脚本三天两头报错，不妨试试这个新工具。</p>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel-labs%2Fagent-browser" target="_blank" title="https://github.com/vercel-labs/agent-browser" ref="nofollow noopener noreferrer">github.com/vercel-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS代码混淆技术深度实践：从基础到高级全面解析]]></title>    <link>https://juejin.cn/post/7594627998851170310</link>    <guid>https://juejin.cn/post/7594627998851170310</guid>    <pubDate>2026-01-13T07:15:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594627998851170310" data-draft-id="7594403873178058793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS代码混淆技术深度实践：从基础到高级全面解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T07:15:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS代码混淆技术深度实践：从基础到高级全面解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:15:42.000Z" title="Tue Jan 13 2026 07:15:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">iOS代码混淆技术深度实践指南</h2>
<blockquote>
<p>在移动应用安全领域，代码混淆是保护知识产权和防止 逆向工程 的关键防线。本文将深入探讨iOS平台上的代码混淆技术，提供从基础到高级的全面解决方案。</p>
</blockquote>
<h3 data-id="heading-1">为什么需要代码混淆？</h3>
<p>在 iOS应用 面临的安全威胁中：</p>
<ul>
<li>80%的破解应用通过逆向工程实现</li>
<li>60%的商业应用存在核心算法被盗用风险</li>
<li>40%的应用内购机制被绕过</li>
</ul>
<p>代码混淆通过以下方式提供保护：</p>
<ul>
<li><strong>增加逆向工程难度</strong>：使反编译代码难以阅读和理解</li>
<li><strong>隐藏敏感逻辑</strong>：保护核心算法和业务逻辑</li>
<li><strong>防止自动化分析</strong>：对抗静态分析工具</li>
<li><strong>延迟攻击时间</strong>：显著增加破解成本</li>
</ul>
<h3 data-id="heading-2">混淆技术分类</h3>
<h4 data-id="heading-3">1. 符号重命名（最基本且高效）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 原始代码</span>
- (<span class="hljs-keyword">void</span>)processPayment:(<span class="hljs-built_in">double</span>)amount {
    [<span class="hljs-meta">self validatePayment</span>];
    [<span class="hljs-meta">self sendToServer:amount</span>];
}

<span class="hljs-comment">// 混淆后</span>
- (<span class="hljs-keyword">void</span>)a:(<span class="hljs-built_in">double</span>)b {
    [<span class="hljs-meta">self c</span>];
    [<span class="hljs-meta">self d:b</span>];
}
</code></pre>
<h4 data-id="heading-4">2. 控制流混淆（增加逻辑复杂度）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 原始逻辑</span>
<span class="hljs-keyword">if</span> (isValid) {
    <span class="hljs-built_in">processOrder</span>();
}

<span class="hljs-comment">// 混淆后</span>
<span class="hljs-keyword">switch</span> (<span class="hljs-built_in">arc4random_uniform</span>(<span class="hljs-number">5</span>)) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">if</span> (!isValid) <span class="hljs-keyword">goto</span> label_7;
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">if</span> (isValid) <span class="hljs-keyword">goto</span> label_3;
        <span class="hljs-keyword">break</span>;
}
label_3:
<span class="hljs-built_in">processOrder</span>();
label_7:
<span class="hljs-comment">// 无效代码块...</span>
</code></pre>
<h4 data-id="heading-5">3. 字符串加密（防止敏感信息泄露）</h4>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 原始字符串</span>
<span class="hljs-built_in">NSString</span> *apiKey = <span class="hljs-string">@"AKIAIOSFODNN7EXAMPLE"</span>;

<span class="hljs-comment">// 混淆后</span>
<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> enc[] = {<span class="hljs-number">0x12</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x78</span>, ...};
<span class="hljs-built_in">NSString</span> *apiKey = decodeString(enc, <span class="hljs-keyword">sizeof</span>(enc));

<span class="hljs-comment">// 解密函数（运行时动态解密）</span>
<span class="hljs-built_in">NSString</span> *decodeString(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data, <span class="hljs-type">int</span> len) {
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;len; i++) {
        data[i] ^= <span class="hljs-number">0xAA</span>; <span class="hljs-comment">// 简单异或加密</span>
    }
    <span class="hljs-keyword">return</span> [<span class="hljs-built_in">NSString</span> stringWithCString:(<span class="hljs-type">char</span>*)data encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];
}
</code></pre>
<h4 data-id="heading-6">4. 元数据混淆（消除调试信息）</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 使用strip移除调试符号</span>
strip -x -S AppBinary

<span class="hljs-section"># 混淆后效果</span>
$ nm AppBinary
0000000100004a00 t <span class="hljs-strong">__mh<span class="hljs-emphasis">_execute_</span>header
0000000100008b34 t <span class="hljs-emphasis">_main
                 U _</span>objc<span class="hljs-emphasis">_autoreleasePoolPop
                 U _</span>objc<span class="hljs-emphasis">_autoreleasePoolPush
                 U _</span>objc<span class="hljs-emphasis">_msgSend
                 U _</span>__</span>stack<span class="hljs-emphasis">_chk_</span>fail
<span class="hljs-code">                 U ___stack_chk_guard
                 U _printf
                 U dyld_stub_binder
</span></code></pre>
<h3 data-id="heading-7">iOS混淆工具链</h3>
<h4 data-id="heading-8">商业解决方案</h4>
<p>工具名称支持语言特点价格范围<strong>Obfuscator-LLVM</strong>C/C++/ObjC编译器级混淆，高度定制开源<strong>iXGuard</strong>Swift/ObjC企业级保护，虚拟化技术<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mi>k</mi><mo>+</mo><mi mathvariant="normal">/</mi><mtext>年</mtext><mo>∗</mo><mo>∗</mo><mi>D</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>O</mi><mo>∗</mo><mo>∗</mo><mi>J</mi><mi>a</mi><mi>v</mi><mi>a</mi><mi mathvariant="normal">/</mi><mi>K</mi><mi>o</mi><mi>t</mi><mi>l</mi><mi>i</mi><mi>n</mi><mtext>控制流混淆强大</mtext></mrow><annotation encoding="application/x-tex">5k+/年**DashO**Java/Kotlin控制流混淆强大</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">/</span><span class="mord cjk_fallback">年</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">∗</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∗</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord">/</span><span class="mord mathnormal">Ko</span><span class="mord mathnormal" style="margin-right:0.01968em;">tl</span><span class="mord mathnormal">in</span><span class="mord cjk_fallback">控制流混淆强大</span></span></span></span></span>3k+/年<strong>Virbox Protector</strong>跨平台代码加密+混淆$2k+/年</p>
<p>此外，IpaGuard 是一款强大的iOS IPA文件混淆工具，无需源码即可对代码和资源进行混淆加密，支持Objective-C、Swift、Flutter、Unity等多种开发平台。它可以直接操作编译后的IPA文件，在本地进行混淆处理，无需上传服务器，混淆后可以立即重签名安装测试，有效增加反编译难度。</p>
<h3 data-id="heading-9">实战：使用SwiftShield混淆Swift项目</h3>
<h4 data-id="heading-10">安装与配置</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 安装</span>
brew install swift-shield

<span class="hljs-comment"># 项目根目录创建配置文件</span>
touch swift-shield-config.yml

<span class="hljs-comment"># 配置文件内容</span>
<span class="hljs-section">project: "YourProject.xcodeproj"</span>
<span class="hljs-section">scheme: "YourAppScheme"</span>
<span class="hljs-section">targets:</span>
  - YourMainTarget
  - YourFramework
<span class="hljs-section">exclude:</span>
  - <span class="hljs-string">"ThirdParty.*"</span>  <span class="hljs-comment"># 排除第三方库</span>
  - <span class="hljs-string">".*Test.*"</span>      <span class="hljs-comment"># 排除测试类</span>
</code></pre>
<h4 data-id="heading-11">执行混淆</h4>
<pre><code class="hljs language-arduino" lang="arduino">swift-shield -automatic -project-root ./ -config swift-shield-config.yml
</code></pre>
<h4 data-id="heading-12">混淆效果对比</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 混淆前</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentProcessor</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">validateCard</span>(<span class="hljs-params">card</span>: <span class="hljs-type">CreditCard</span>) -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 验证逻辑</span>
    }
}

<span class="hljs-comment">// 混淆后</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">aBcDeFg</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">hIjKlMn</span>(<span class="hljs-params">oPqRsT</span>: uVwXyZ) -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 相同逻辑但符号不可读</span>
    }
}
</code></pre>
<h3 data-id="heading-13">高级混淆技术</h3>
<h4 data-id="heading-14">1. 控制流平坦化</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 原始逻辑</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">checkLicense</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (isValid) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 平坦化后</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">checkLicense</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> state = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">switch</span>(state) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                <span class="hljs-keyword">if</span> (!isValid) state = <span class="hljs-number">2</span>;
                <span class="hljs-keyword">else</span> state = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-15">2. 虚假控制流注入</h4>
<pre><code class="hljs language-scss" lang="scss">- (BOOL)isPremiumUser {
    <span class="hljs-comment">// 真实逻辑</span>
    BOOL result = <span class="hljs-selector-attr">[self checkSubscriptionStatus]</span>;

    <span class="hljs-comment">// 注入虚假控制流</span>
    int rnd = <span class="hljs-built_in">arc4random_uniform</span>(<span class="hljs-number">1000</span>);
    if (rnd &lt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// 永远不会执行的代码块</span>
        <span class="hljs-selector-attr">[self deleteAllData]</span>; <span class="hljs-comment">// 误导逆向者</span>
        <span class="hljs-selector-attr">[self formatDevice]</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    return result;
}
</code></pre>
<h4 data-id="heading-16">3. 方法拆分与合并</h4>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 原始方法</span>
- (<span class="hljs-type">void</span>)processData:(<span class="hljs-built_in">NSData</span> *)data {
    [<span class="hljs-keyword">self</span> decodeData:data];
    [<span class="hljs-keyword">self</span> analyzeContent];
    [<span class="hljs-keyword">self</span> saveResults];
}

<span class="hljs-comment">// 混淆后</span>
- (<span class="hljs-type">void</span>)funcA:(<span class="hljs-built_in">NSData</span> *)d { [<span class="hljs-keyword">self</span> decodeData:d]; }
- (<span class="hljs-type">void</span>)funcB { [<span class="hljs-keyword">self</span> analyzeContent]; }
- (<span class="hljs-type">void</span>)funcC { [<span class="hljs-keyword">self</span> saveResults]; }

<span class="hljs-comment">// 调用点改为</span>
[<span class="hljs-keyword">self</span> funcA:data];
<span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>), ^{ [<span class="hljs-keyword">self</span> funcB]; });
[<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(funcC) withObject:<span class="hljs-literal">nil</span> afterDelay:<span class="hljs-number">0.01</span>];
</code></pre>
<h3 data-id="heading-17">混淆与App Store审核的平衡</h3>
<h4 data-id="heading-18">允许的混淆技术</h4>
<ul>
<li>符号重命名（类/方法/变量名）</li>
<li>字符串加密</li>
<li>控制流混淆</li>
<li>调试信息移除</li>
</ul>
<h4 data-id="heading-19">禁止的技术</h4>
<ul>
<li>使用私有API进行混淆</li>
<li>隐藏方法调用（如 <code>performSelector:</code> 滥用）</li>
<li>动态修改代码（JIT编译）</li>
<li>绕过沙盒限制</li>
</ul>
<h3 data-id="heading-20">混淆性能影响评估</h3>
<p>混淆类型代码膨胀率启动延迟内存占用CPU影响符号重命名0%0ms0%0%控制流平坦化15-40%50-200ms&lt;5%5-15%字符串加密5-10%10-50ms&lt;2%1-3%虚假控制流20-60%&lt;10ms&lt;1%1-5%</p>
<p><strong>最佳实践</strong>：仅对核心模块应用高强度混淆</p>
<h3 data-id="heading-21">混淆测试与验证</h3>
<h4 data-id="heading-22">1. 反编译验证</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用Hopper Disassembler</span>
hopper -e YourAppBinary

<span class="hljs-comment"># 检查关键方法是否混淆</span>
<span class="hljs-comment">; 混淆前</span>
-<span class="hljs-section">[PaymentProcessor validateCard:]</span>:
push       rbp
mov        rbp, rsp

<span class="hljs-comment">; 混淆后</span>
-<span class="hljs-section">[aBc dEf:]</span>:
jmp        0x123456 <span class="hljs-comment">; 跳转到随机地址</span>
nop
nop
</code></pre>
<h4 data-id="heading-23">2. 动态分析防御</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 检测调试器附着</span>
__attribute__((always_inline)) void anti_debug() {
    asm volatile (
        <span class="hljs-string">"mov x0, #31<span class="hljs-subst">\n</span>"</span>   <span class="hljs-comment">// SYS_ptrace</span>
        <span class="hljs-string">"mov x1, #0<span class="hljs-subst">\n</span>"</span>    <span class="hljs-comment">// PT_DENY_ATTACH</span>
        <span class="hljs-string">"mov x2, #0<span class="hljs-subst">\n</span>"</span>
        <span class="hljs-string">"mov x3, #0<span class="hljs-subst">\n</span>"</span>
        <span class="hljs-string">"mov x16, #26<span class="hljs-subst">\n</span>"</span>  <span class="hljs-comment">// SYS_ptrace</span>
        <span class="hljs-string">"svc #0x80<span class="hljs-subst">\n</span>"</span>
    );
}

<span class="hljs-comment">// 在关键方法入口调用</span>
<span class="hljs-operator">-</span> (void)validateLicense {
    anti_debug();
    <span class="hljs-comment">// 验证逻辑</span>
}
</code></pre>
<h4 data-id="heading-24">3. 混淆覆盖率分析</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用IDAPython脚本分析</span>
import idautils

<span class="hljs-attr">original_symbols</span> = [<span class="hljs-string">"PaymentProcessor"</span>, <span class="hljs-string">"validateCard"</span>, <span class="hljs-string">"isPremiumUser"</span>]
<span class="hljs-attr">obfuscated_count</span> = <span class="hljs-number">0</span>

for func in idautils.Functions():
    <span class="hljs-attr">func_name</span> = idc.get_func_name(func)
    if not any(sym in func_name for sym in original_symbols):
        obfuscated_count += 1

<span class="hljs-attr">coverage</span> = obfuscated_count / len(list(idautils.Functions())) * <span class="hljs-number">100</span>
print(f"混淆覆盖率: {coverage:.2f}%")
</code></pre>
<h4 data-id="heading-25">关键组件说明</h4>
<ol>
<li><strong>配置中心</strong>：管理混淆规则和例外列表</li>
<li><strong>预处理器</strong>：处理宏和条件编译</li>
<li><strong>语言特定混淆器</strong>：执行重命名和结构修改</li>
<li><strong>控制流引擎</strong>：应用平坦化和虚假控制流</li>
<li><strong>加密模块</strong>：处理字符串和资源加密</li>
<li><strong>后处理器</strong>：剥离调试符号和压缩</li>
</ol>
<h3 data-id="heading-26">常见问题解决方案</h3>
<h4 data-id="heading-27">问题1：混淆后崩溃（Crash日志符号化）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用混淆映射文件还原</span>
atos -<span class="hljs-built_in">arch</span> arm64 -o YourApp.dSYM/Contents/Resources/DWARF/YourApp
     -l 0x104000000 0x1040a5b3c

<span class="hljs-comment"># 输出</span>
validateCard (<span class="hljs-keyword">in</span> YourApp) (PaymentProcessor.swift:15)
</code></pre>
<h4 data-id="heading-28">问题2：与KVO/KVC冲突</h4>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 混淆时保留KVC关键方法</span>
+ (<span class="hljs-built_in">NSSet</span> *)keyPathsForValuesAffectingValueForKey:(<span class="hljs-built_in">NSString</span> *)key {
    <span class="hljs-comment">// 不混淆此方法</span>
}
</code></pre>
<h4 data-id="heading-29">问题3：反射机制失效</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 混淆前</span>
<span class="hljs-keyword">let</span> cls <span class="hljs-operator">=</span> <span class="hljs-type">NSClassFromString</span>(<span class="hljs-string">"PaymentProcessor"</span>)

<span class="hljs-comment">// 解决方案：保留关键类名</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentProcessor</span> {
    <span class="hljs-comment">// 在混淆配置中标记为不混淆</span>
}
</code></pre>
<h3 data-id="heading-30">混淆的未来趋势</h3>
<ol>
<li><strong>AI驱动的混淆</strong>
<ul>
<li>使用GAN生成对抗性代码模式</li>
<li>基于深度学习的混淆策略选择</li>
</ul>
</li>
<li><strong>运行时自修改代码</strong></li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 概念示例</span>
void <span class="hljs-built_in">sensitiveFunc</span>() {
       <span class="hljs-comment">// 首次执行后修改自身代码</span>
       if (firstRun) {
           <span class="hljs-built_in">modifyMachineCode</span>((void*)sensitiveFunc, newOpcodes);
           firstRun = <span class="hljs-number">0</span>;
       }
       <span class="hljs-comment">// 实际功能</span>
}
</code></pre>
<ol start="3">
<li><strong>硬件辅助保护</strong>
<ul>
<li>利用Secure Enclave存储密钥</li>
<li>使用指针认证码（PAC）防止代码注入</li>
</ul>
</li>
</ol>
<h3 data-id="heading-31">最佳实践总结</h3>
<ol>
<li>
<p><strong>分层应用策略</strong></p>
</li>
<li>
<p><strong>持续集成集成</strong></p>
</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># GitHub Actions 示例</span>
<span class="hljs-attr">jobs:</span>
     <span class="hljs-attr">obfuscate:</span>
       <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
       <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">SwiftShield</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">brew</span> <span class="hljs-string">install</span> <span class="hljs-string">swift-shield</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Obfuscate</span> <span class="hljs-string">code</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">swift-shield</span> <span class="hljs-string">-automatic</span> <span class="hljs-string">-project-root</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.workspace</span> <span class="hljs-string">}}</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">IPA</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">xcodebuild</span> <span class="hljs-string">-workspace</span> <span class="hljs-string">App.xcworkspace</span> <span class="hljs-string">-scheme</span> <span class="hljs-string">Release</span>
</code></pre>
<ol start="3">
<li><strong>安全监控</strong>
<ul>
<li>检测逆向工具（Frida、Cydia Substrate）</li>
<li>运行时完整性检查</li>
<li>混淆失效警报系统</li>
</ul>
</li>
<li><strong>合规性管理</strong>
<ul>
<li>保留未混淆的测试版本</li>
<li>记录混淆配置变更日志</li>
<li>定期安全审计</li>
</ul>
</li>
</ol>
<p>如果没有源码想直接对 iOS IPA 文件进行深度混淆与加密，也可以试试IpaGuard
通过实施这些策略，iOS应用可以显著提高抗逆向工程能力，保护核心知识产权，同时保持应用的性能和稳定性。随着攻击技术的演进，混淆策略也应持续更新，形成动态的安全防护体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个由Rust实现的, 好得多的Windows tree命令: tree++项目简介]]></title>    <link>https://juejin.cn/post/7594616268781486107</link>    <guid>https://juejin.cn/post/7594616268781486107</guid>    <pubDate>2026-01-13T07:39:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268781486107" data-draft-id="7594482829754794030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个由Rust实现的, 好得多的Windows tree命令: tree++项目简介"/> <meta itemprop="keywords" content="GitHub,Rust"/> <meta itemprop="datePublished" content="2026-01-13T07:39:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WaterRun"/> <meta itemprop="url" content="https://juejin.cn/user/1408923845545562"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个由Rust实现的, 好得多的Windows tree命令: tree++项目简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1408923845545562/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WaterRun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:39:08.000Z" title="Tue Jan 13 2026 07:39:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><code>tree++</code>: 好的多的Windows<code>tree</code>命令</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22f9cd52db1747ffb4f1e57f6c5a0299~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2F0ZXJSdW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768894798&amp;x-signature=mjZlUa2u0gsTZ8oE9hFbxIH3j%2B4%3D" alt="GitHub.png" loading="lazy"/></p>
<p>Windows上的<code>tree</code>命令自从近40年前发布以来几乎就没有改动. 在如今LLM的时代, 作为描述项目结构非常常用的工具, 仅有的<code>/f</code>和<code>/a</code>两个参数的功能显然捉襟见肘. 同时, 它也不太快.</p>
<p><strong><code>tree++</code>是对<code>tree</code>的一次全面升级</strong>, 为Windows平台下的<code>tree</code>命令引入了:</p>
<ul>
<li><em><strong>扩展参数集, 支持功能涵盖包括显示文件大小, 递归深度限制, 修改输出风格, 将结果输出至文件, 及排除指定目录(包括遵循<code>.gitignore</code>)等常用功能</strong></em></li>
<li><em><strong>Rust的实现更好的性能, 在批处理模式下更支持多线程, 提供显著的扫描速度提升</strong></em></li>
<li><em><strong>与原有的Windows<code>tree</code>命令参数和输出格式达到diff级别的完全兼容, 并可使用Unix风格的参数(如<code>-f</code>和<code>--files</code>)</strong></em></li>
</ul>
<p><strong><code>tree++</code>使用<code>Rust</code>实现</strong>, 开源于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWater-Run%2Ftreepp" target="_blank" title="https://github.com/Water-Run/treepp" ref="nofollow noopener noreferrer">GitHub</a>.</p>
<p><em>性能对比(以<code>C:\Windows</code>为示例):</em></p>























































<table><thead><tr><th>类型</th><th align="right">耗时 (<code>ms</code>)</th><th align="right">倍率</th></tr></thead><tbody><tr><td><code>tree /f</code> (Windows Native)</td><td align="right"><code>20721.90</code></td><td align="right"><code>1.00x</code></td></tr><tr><td><code>treepp /f</code></td><td align="right"><code>7467.99</code></td><td align="right"><code>2.77x</code></td></tr><tr><td><code>treepp /f /nb</code></td><td align="right"><code>7392.34</code></td><td align="right"><code>2.80x</code></td></tr><tr><td><code>treepp /f /nb /b</code></td><td align="right"><code>3226.38</code></td><td align="right"><code>6.42x</code></td></tr><tr><td><code>treepp /f /nb /b /t 1</code></td><td align="right"><code>9123.00</code></td><td align="right"><code>2.27x</code></td></tr><tr><td><code>treepp /f /nb /b /t 2</code></td><td align="right"><code>5767.71</code></td><td align="right"><code>3.59x</code></td></tr><tr><td><code>treepp /f /nb /b /t 4</code></td><td align="right"><code>3948.73</code></td><td align="right"><code>5.25x</code></td></tr><tr><td><code>treepp /f /nb /b /t 8</code></td><td align="right"><code>3166.81</code></td><td align="right"><code>6.54x</code></td></tr><tr><td><code>treepp /f /nb /b /t 16</code></td><td align="right"><code>2704.67</code></td><td align="right"><code>7.66x</code></td></tr></tbody></table>
<h3 data-id="heading-1">安装</h3>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWater-Run%2Ftreepp%2Freleases%2Ftag%2F0.1.0" target="_blank" title="https://github.com/Water-Run/treepp/releases/tag/0.1.0" ref="nofollow noopener noreferrer">Release</a>下载<code>tree++.zip</code>, 解压到合适目录, 并将目录添加至环境变量.</p>
<p>开启Windows终端, 执行:</p>
<pre><code class="hljs language-powershell" lang="powershell">treepp /v
</code></pre>
<p>有输出:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">tree++ version 0.1.0

A Much Better Windows tree Command.

author: WaterRun
link: https://github.com/Water-Run/treepp
</code></pre>
<p>即完成安装.</p>
<p>随后, 你可以以和普通的Windows <code>tree</code>命令一样的方式使用:</p>
<pre><code class="hljs language-powershell" lang="powershell">treepp /f
</code></pre>
<h3 data-id="heading-2">速览</h3>





























































































<table><thead><tr><th>参数集(等价写法)</th><th>说明</th></tr></thead><tbody><tr><td><code>--help</code> <code>-h</code> <code>/?</code></td><td>显示帮助信息</td></tr><tr><td><code>--version</code> <code>-v</code> <code>/V</code></td><td>显示版本信息</td></tr><tr><td><code>--ascii</code> <code>-a</code> <code>/A</code></td><td>使用 ASCII 字符绘制树</td></tr><tr><td><code>--files</code> <code>-f</code> <code>/F</code></td><td>显示文件</td></tr><tr><td><code>--full-path</code> <code>-p</code> <code>/FP</code></td><td>显示完整路径</td></tr><tr><td><code>--human-readable</code> <code>-H</code> <code>/HR</code></td><td>以人类可读方式显示文件大小</td></tr><tr><td><code>--no-indent</code> <code>-i</code> <code>/NI</code></td><td>不显示树形连接线</td></tr><tr><td><code>--reverse</code> <code>-r</code> <code>/R</code></td><td>逆序排序</td></tr><tr><td><code>--size</code> <code>-s</code> <code>/S</code></td><td>显示文件大小(字节)</td></tr><tr><td><code>--date</code> <code>-d</code> <code>/DT</code></td><td>显示最后修改日期</td></tr><tr><td><code>--exclude</code> <code>-I</code> <code>/X</code></td><td>排除匹配的文件</td></tr><tr><td><code>--level</code> <code>-L</code> <code>/L</code></td><td>限制递归深度</td></tr><tr><td><code>--include</code> <code>-m</code> <code>/M</code></td><td>仅显示匹配的文件</td></tr><tr><td><code>--disk-usage</code> <code>-u</code> <code>/DU</code></td><td>显示目录累计大小</td></tr><tr><td><code>--report</code> <code>-e</code> <code>/RP</code></td><td>显示末尾统计信息</td></tr><tr><td><code>--no-win-banner</code> <code>-N</code> <code>/NB</code></td><td>不显示 Windows 原生 tree 的样板信息</td></tr><tr><td><code>--silent</code> <code>-l</code> <code>/SI</code></td><td>终端静默(结合<code>output</code>指令使用)</td></tr><tr><td><code>--output</code> <code>-o</code> <code>/O</code></td><td>将结果输出至文件(<code>.txt</code>, <code>.json</code>, <code>.yml</code>, <code>.toml</code>)</td></tr><tr><td><code>--batch</code> <code>-b</code> <code>/B</code></td><td>使用批处理模式</td></tr><tr><td><code>--thread</code> <code>-t</code> <code>/T</code></td><td>扫描线程数(批处理模式, 默认8线程)</td></tr><tr><td><code>--gitignore</code> <code>-g</code> <code>/G</code></td><td>遵循<code>.gitignore</code></td></tr></tbody></table>
<blockquote>
<p>更多信息查阅GitHub上的有关文档信息</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 npm 做免费图床，这操作绝了！]]></title>    <link>https://juejin.cn/post/7594385386740629523</link>    <guid>https://juejin.cn/post/7594385386740629523</guid>    <pubDate>2026-01-13T08:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594385386740629523" data-draft-id="7594351060615954451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 npm 做免费图床，这操作绝了！"/> <meta itemprop="keywords" content="GitHub,NPM"/> <meta itemprop="datePublished" content="2026-01-13T08:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cosmium"/> <meta itemprop="url" content="https://juejin.cn/user/2010327196907229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 npm 做免费图床，这操作绝了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2010327196907229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cosmium
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:39:54.000Z" title="Tue Jan 13 2026 08:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近发现了一个骚操作 —— 用 npm 当图床，完全免费，还带全球 CDN 加速。分享一下具体实现过程。</p>
<h2 data-id="heading-0">为啥要用 npm 做图床？</h2>
<p>先说说背景，我经常在各大平台写文章，需要上传图片。但：</p>
<ul>
<li>免费图床不稳定，容易挂</li>
<li>自建图床成本高</li>
<li>其他平台限制多</li>
</ul>
<p>然后想到 npm，这不就是现成的 CDN 吗？全球访问速度还快。</p>
<h2 data-id="heading-1">怎么实现的？</h2>
<h3 data-id="heading-2">1. 基本原理</h3>
<p>npm 包本质上就是一堆文件，我们可以把图片放进去。发布后，npm 的 CDN 会自动分发这些文件。</p>
<p>访问方式：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># unpkg</span>
<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/unpkg.com/</span>包名@版本号/图片路径

<span class="hljs-comment"># jsdelivr  </span>
<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/cdn.jsdelivr.net/npm</span><span class="hljs-regexp">/包名@版本号/</span>图片路径

<span class="hljs-comment"># PS</span>
<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/unpkg.com/cosmium</span><span class="hljs-variable">@latest</span>/images/other/npm-pic.png
</code></pre>
<h3 data-id="heading-3">2. 自动化发布npm包</h3>
<p>每次提交图片后都需要手动发布到 npm那不是很烦, 别急github Actions可以帮我们自动发包, 可以直接fork 我的项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCosmiumx%2Fcosmium" target="_blank" title="https://github.com/Cosmiumx/cosmium" ref="nofollow noopener noreferrer">github.com/Cosmiumx/co…</a></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Publish</span> <span class="hljs-string">to</span> <span class="hljs-string">npm</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">master</span>

<span class="hljs-attr">jobs:</span>
    <span class="hljs-string">....</span>
</code></pre>
<h3 data-id="heading-4">3. 配置步骤</h3>
<ol>
<li><strong>Fork 本项目</strong>
<ul>
<li>将本项目 Fork 到你的 GitHub 账号下。</li>
</ul>
</li>
<li><strong>修改包名</strong>
<ul>
<li>编辑 <code>package.json</code>，将包名改为你自己的：</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-package-name"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.1"</span><span class="hljs-punctuation">,</span>
  ...
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>注意</strong>：包名必须是 npm 上未被占用的名称。</p>
<ol start="3">
<li>
<p><strong>创建 npm token</strong></p>
<ul>
<li>访问 npmjs.com，</li>
<li>进入 <strong>Access Tokens</strong> 页面</li>
<li>点击 <strong>Generate New Token</strong> → 选择 <strong>Bypass 2FA</strong> 类型 (npm最新规则token最长只能设置90天)</li>
<li>记住这个 token，只显示一次</li>
</ul>
</li>
<li>
<p><strong>配置 GitHub Secrets</strong></p>
<ul>
<li>在你 Fork 的仓库中：</li>
<li>仓库 Settings → Secrets and variables → Actions</li>
<li>添加 <code>NPM_TOKEN</code>，值为刚才的 token</li>
</ul>
</li>
<li>
<p><strong>上传图片</strong></p>
<ul>
<li>把图片放到 <code>images</code> 目录</li>
<li>提交代码，工作流自动发布</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">4. 访问方式</h3>
<p>发布后，图片可通过以下 CDN 访问：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># unpkg</span>
https://unpkg.com/cosmium@latest/images/your-image.png

<span class="hljs-comment"># jsdelivr</span>
https://cdn.jsdelivr.net/npm/cosmium@latest/images/your-image.png
</code></pre>
<h2 data-id="heading-6">实际体验</h2>
<p><strong>优点：</strong></p>
<ul>
<li>完全免费，npm 不收费</li>
<li>全球 CDN，访问速度快</li>
<li>自动化流程，上传图片后自动发布</li>
<li>版本管理清晰</li>
</ul>
<p><strong>注意事项：</strong></p>
<ul>
<li>⚠️ <strong>npm 包一旦发布无法删除</strong>，版本号会永久保留</li>
<li>⚠️ <strong>不要上传敏感信息</strong>，npm 包是完全公开的</li>
<li>⚠️ <strong>遵守 npm 使用条款</strong>，不要滥用 CDN 服务</li>
<li>⚠️ <strong>图片版权</strong>，确保你有权使用并分发上传的图片</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>这个方案算是找到了一个不错的图床替代方案，特别适合经常写技术文章的同学。虽然有点折腾，但效果不错。</p>
<p>有兴趣的可以 fork 我的项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCosmiumx%2Fcosmium" target="_blank" title="https://github.com/Cosmiumx/cosmium" ref="nofollow noopener noreferrer">github.com/Cosmiumx/co…</a></p>
<p>配置好之后，以后上传图片就只是 git push 的事情了，还是很方便的。</p>
<hr/>
<p><em>如果这个方法对你有帮助，别忘了点赞支持一下~</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini CLI 接入指南]]></title>    <link>https://juejin.cn/post/7594576956421079066</link>    <guid>https://juejin.cn/post/7594576956421079066</guid>    <pubDate>2026-01-13T08:52:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956421079066" data-draft-id="7594482829755154478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini CLI 接入指南"/> <meta itemprop="keywords" content="Gemini"/> <meta itemprop="datePublished" content="2026-01-13T08:52:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小挖矿工"/> <meta itemprop="url" content="https://juejin.cn/user/3732198836156526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini CLI 接入指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3732198836156526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小挖矿工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:52:22.000Z" title="Tue Jan 13 2026 08:52:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Gemini CLI 是谷歌推出的命令行工具，用于与 Gemini 模型交互。通过 weelinking，您可以使用兼容接口访问 Gemini 模型。</p>
<h2 data-id="heading-0">安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%25AE%2589%25E8%25A3%2585" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%AE%89%E8%A3%85" target="_blank" ref="nofollow noopener noreferrer">​</a></h2>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<h3 data-id="heading-1">步骤 1：安装 NVM（Node 版本管理器）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%25AD%25A5%25E9%25AA%25A4-1%25E5%25AE%2589%25E8%25A3%2585-nvmnode-%25E7%2589%2588%25E6%259C%25AC%25E7%25AE%25A1%25E7%2590%2586%25E5%2599%25A8" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%AD%A5%E9%AA%A4-1%E5%AE%89%E8%A3%85-nvmnode-%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%99%A8" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<p>打开 PowerShell（管理员模式），下载并安装 nvm-windows：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">下载 nvm-windows 安装包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">访问 https://github.com/coreybutler/nvm-windows/releases</span>
<span class="hljs-meta prompt_"># </span><span class="bash">下载最新的 nvm-setup.exe 并运行安装</span>
</code></pre>
<p>或使用 Chocolatey 安装：</p>
<pre><code class="hljs">choco install nvm
</code></pre>
<h3 data-id="heading-2">步骤 2：安装 Node.js<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%25AD%25A5%25E9%25AA%25A4-2%25E5%25AE%2589%25E8%25A3%2585-nodejs" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%AD%A5%E9%AA%A4-2%E5%AE%89%E8%A3%85-nodejs" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 安装最新 LTS 版本</span>
nvm install lts

<span class="hljs-comment"># 使用该版本</span>
nvm <span class="hljs-keyword">use</span> lts

<span class="hljs-comment"># 验证安装</span>
node --version
npm --version
</code></pre>
<h3 data-id="heading-3">步骤 3：安装 Gemini CLI<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%25AD%25A5%25E9%25AA%25A4-3%25E5%25AE%2589%25E8%25A3%2585-gemini-cli" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%AD%A5%E9%AA%A4-3%E5%AE%89%E8%A3%85-gemini-cli" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<pre><code class="hljs language-bash" lang="bash">npm install -g @google/gemini-cli
</code></pre>
<h3 data-id="heading-4">步骤 4：验证安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%25AD%25A5%25E9%25AA%25A4-4%25E9%25AA%258C%25E8%25AF%2581%25E5%25AE%2589%25E8%25A3%2585" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%AD%A5%E9%AA%A4-4%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<pre><code class="hljs language-css" lang="css">gemini <span class="hljs-attr">--version</span>
</code></pre>
<h3 data-id="heading-5">快速试用（无需安装）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%25BF%25AB%25E9%2580%259F%25E8%25AF%2595%25E7%2594%25A8%25E6%2597%25A0%25E9%259C%2580%25E5%25AE%2589%25E8%25A3%2585" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%BF%AB%E9%80%9F%E8%AF%95%E7%94%A8%E6%97%A0%E9%9C%80%E5%AE%89%E8%A3%85" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npx @google/gemini-cli
</code></pre>
<h2 data-id="heading-6">配置 weelinking<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E9%2585%258D%25E7%25BD%25AE-weelinking" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E9%85%8D%E7%BD%AE-weelinking" target="_blank" ref="nofollow noopener noreferrer">​</a></h2>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<h3 data-id="heading-7">方式一：环境变量<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%2596%25B9%25E5%25BC%258F%25E4%25B8%2580%25E7%258E%25AF%25E5%25A2%2583%25E5%258F%2598%25E9%2587%258F" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%96%B9%E5%BC%8F%E4%B8%80%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<p>在系统环境变量中添加：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 临时设置（当前会话）</span>
<span class="hljs-variable">$env</span><span class="hljs-symbol">:GOOGLE_GEMINI_BASE_URL=<span class="hljs-string">"https://api.weelinking.com"</span></span>
<span class="hljs-variable">$env</span><span class="hljs-symbol">:GEMINI_API_KEY=<span class="hljs-string">"YOUR_API_KEY"</span></span>
<span class="hljs-variable">$env</span><span class="hljs-symbol">:GEMINI_MODEL=<span class="hljs-string">"gemini-2.5-pro"</span></span>

<span class="hljs-comment"># 永久设置（推荐）</span>
[<span class="hljs-title class_">System</span>.<span class="hljs-title class_">Environment</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:SetEnvironmentVariable</span>(<span class="hljs-string">'GOOGLE_GEMINI_BASE_URL'</span>, <span class="hljs-string">'https://api.weelinking.com'</span>, <span class="hljs-string">'User'</span>)
[<span class="hljs-title class_">System</span>.<span class="hljs-title class_">Environment</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:SetEnvironmentVariable</span>(<span class="hljs-string">'GEMINI_API_KEY'</span>, <span class="hljs-string">'YOUR_API_KEY'</span>, <span class="hljs-string">'User'</span>)
[<span class="hljs-title class_">System</span>.<span class="hljs-title class_">Environment</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:SetEnvironmentVariable</span>(<span class="hljs-string">'GEMINI_MODEL'</span>, <span class="hljs-string">'gemini-2.5-pro'</span>, <span class="hljs-string">'User'</span>)
</code></pre>
<h3 data-id="heading-8">方式二：配置文件<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%2596%25B9%25E5%25BC%258F%25E4%25BA%258C%25E9%2585%258D%25E7%25BD%25AE%25E6%2596%2587%25E4%25BB%25B6" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%96%B9%E5%BC%8F%E4%BA%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<p>创建配置目录和文件：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment"># 创建配置目录</span>
New-Item -Path <span class="hljs-string">"<span class="hljs-subst">$env</span>:USERPROFILE.gemini"</span> -ItemType <span class="hljs-built_in">Directory</span> -Force

<span class="hljs-comment"># 创建 .env 文件</span>
@<span class="hljs-string">"
GOOGLE_GEMINI_BASE_URL=https://api.weelinking.com
GEMINI_API_KEY=YOUR_API_KEY
GEMINI_MODEL=gemini-3-pro-preview
"</span>@ | Out-File -FilePath <span class="hljs-string">"<span class="hljs-subst">$env</span>:USERPROFILE.gemini.env"</span> -Encoding UTF8

<span class="hljs-comment"># 创建 settings.json 文件</span>
@<span class="hljs-string">"
{
  "</span>ide<span class="hljs-string">": {
    "</span>enabled<span class="hljs-string">": true
  },
  "</span>security<span class="hljs-string">": {
    "</span>auth<span class="hljs-string">": {
      "</span>selectedType<span class="hljs-string">": "</span>gemini-api-key<span class="hljs-string">"
    }
  }
}
"</span>@ | Out-File -FilePath <span class="hljs-string">"<span class="hljs-subst">$env</span>:USERPROFILE.gemini\settings.json"</span> -Encoding UTF8
</code></pre>
<p>注意：配置文件更加安全且便于管理，需要重启 Gemini CLI 才生效。</p>
<h2 data-id="heading-9">可用模型<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%258F%25AF%25E7%2594%25A8%25E6%25A8%25A1%25E5%259E%258B" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%8F%AF%E7%94%A8%E6%A8%A1%E5%9E%8B" target="_blank" ref="nofollow noopener noreferrer">​</a></h2>

























<table><thead><tr><th>模型</th><th>说明</th><th>上下文</th></tr></thead><tbody><tr><td>gemini-3-pro-preview</td><td>LMArena 第一</td><td>1M</td></tr><tr><td>gemini-2.5-pro</td><td>正式版</td><td>2M</td></tr><tr><td>gemini-2.5-flash</td><td>快速响应</td><td>1M</td></tr></tbody></table>
<h2 data-id="heading-10">使用方法<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E4%25BD%25BF%25E7%2594%25A8%25E6%2596%25B9%25E6%25B3%2595" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" target="_blank" ref="nofollow noopener noreferrer">​</a></h2>
<h3 data-id="heading-11">交互模式<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E4%25BA%25A4%25E4%25BA%2592%25E6%25A8%25A1%25E5%25BC%258F" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E4%BA%A4%E4%BA%92%E6%A8%A1%E5%BC%8F" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<pre><code class="hljs">gemini
</code></pre>
<h3 data-id="heading-12">单次查询<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%258D%2595%25E6%25AC%25A1%25E6%259F%25A5%25E8%25AF%25A2" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%8D%95%E6%AC%A1%E6%9F%A5%E8%AF%A2" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<pre><code class="hljs language-arduino" lang="arduino">gemini <span class="hljs-string">"解释量子计算的基本原理"</span>
</code></pre>
<h3 data-id="heading-13">文件处理<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%2596%2587%25E4%25BB%25B6%25E5%25A4%2584%25E7%2590%2586" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">gemini --file <span class="hljs-variable language_">document</span>.<span class="hljs-property">pdf</span> <span class="hljs-string">"总结这份文档"</span>
</code></pre>
<h2 data-id="heading-14">功能特色<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%258A%259F%25E8%2583%25BD%25E7%2589%25B9%25E8%2589%25B2" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%8A%9F%E8%83%BD%E7%89%B9%E8%89%B2" target="_blank" ref="nofollow noopener noreferrer">​</a></h2>
<ul>
<li><strong>超长上下文</strong>：支持 2M token 上下文</li>
<li><strong>多模态</strong>：支持图像、视频理解</li>
<li><strong>代码执行</strong>：支持代码生成和执行</li>
<li><strong>文件处理</strong>：支持多种文档格式</li>
</ul>
<h2 data-id="heading-15">多模态使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%25A4%259A%25E6%25A8%25A1%25E6%2580%2581%25E4%25BD%25BF%25E7%2594%25A8" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%A4%9A%E6%A8%A1%E6%80%81%E4%BD%BF%E7%94%A8" target="_blank" ref="nofollow noopener noreferrer">​</a></h2>
<h3 data-id="heading-16">图像分析<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%259B%25BE%25E5%2583%258F%25E5%2588%2586%25E6%259E%2590" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%9B%BE%E5%83%8F%E5%88%86%E6%9E%90" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">gemini --image photo.jpg <span class="hljs-string">"描述这张图片"</span>
</code></pre>
<h3 data-id="heading-17">视频理解<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E8%25A7%2586%25E9%25A2%2591%25E7%2590%2586%25E8%25A7%25A3" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E8%A7%86%E9%A2%91%E7%90%86%E8%A7%A3" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<pre><code class="hljs language-css" lang="css">gemini <span class="hljs-attr">--video</span> <span class="hljs-attribute">clip</span><span class="hljs-selector-class">.mp4</span> "总结视频内容"
</code></pre>
<h2 data-id="heading-18">常见问题<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%25B8%25B8%25E8%25A7%2581%25E9%2597%25AE%25E9%25A2%2598" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" target="_blank" ref="nofollow noopener noreferrer">​</a></h2>
<h3 data-id="heading-19">命令找不到<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E5%2591%25BD%25E4%25BB%25A4%25E6%2589%25BE%25E4%25B8%258D%25E5%2588%25B0" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E5%91%BD%E4%BB%A4%E6%89%BE%E4%B8%8D%E5%88%B0" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<p>确保 npm 全局安装路径在系统 PATH 中：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 查看 npm 全局路径</span>
npm config <span class="hljs-keyword">get</span> prefix

<span class="hljs-meta"># 如需添加到 PATH，在系统环境变量中添加：</span>
<span class="hljs-meta"># %APPDATA%\npm</span>
</code></pre>
<h3 data-id="heading-20">API 连接失败<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23api-%25E8%25BF%259E%25E6%258E%25A5%25E5%25A4%25B1%25E8%25B4%25A5" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#api-%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<ol>
<li>检查 API Base URL 配置是否正确</li>
<li>验证 API Key 是否有效</li>
<li>确认网络连接正常</li>
</ol>
<ul>
<li>Windows</li>
<li>macOS</li>
<li>Linux</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 检查环境变量</span>
<span class="hljs-variable">$env</span><span class="hljs-symbol">:GOOGLE_GEMINI_BASE_URL</span>
<span class="hljs-variable">$env</span><span class="hljs-symbol">:GEMINI_API_KEY</span>
<span class="hljs-variable">$env</span><span class="hljs-symbol">:GEMINI_MODEL</span>

<span class="hljs-comment"># 或检查配置文件</span>
<span class="hljs-title class_">Get</span>-<span class="hljs-title class_">Content</span> <span class="hljs-string">"$env:USERPROFILE.gemini\config.json"</span>
</code></pre>
<h3 data-id="heading-21">模型不可用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23%25E6%25A8%25A1%25E5%259E%258B%25E4%25B8%258D%25E5%258F%25AF%25E7%2594%25A8" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#%E6%A8%A1%E5%9E%8B%E4%B8%8D%E5%8F%AF%E7%94%A8" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<p>确保使用 Gemini 系列模型名称。</p>
<h3 data-id="heading-22">Node.js 版本问题<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli%23nodejs-%25E7%2589%2588%25E6%259C%25AC%25E9%2597%25AE%25E9%25A2%2598" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli#nodejs-%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98" target="_blank" ref="nofollow noopener noreferrer">​</a></h3>
<p>Gemini CLI 需要 Node.js 18 或更高版本：</p>
<pre><code class="hljs language-css" lang="css"># 检查版本
node <span class="hljs-attr">--version</span>

# 如果版本过低，使用 nvm 升级
nvm install <span class="hljs-attr">--lts</span>
nvm use <span class="hljs-attr">--lts</span>
</code></pre>
<p>链接如下
<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.weelinking.com%2Fregister%3Faff%3DsSdbJ5cV" target="_blank" title="https://api.weelinking.com/register?aff=sSdbJ5cV" ref="nofollow noopener noreferrer">api.weelinking.com/register?af…</a>
其实很简单的！
安装文档
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.weelinking.com%2Fdocs%2Fscenarios%2Fprogramming%2Fgemini-cli" target="_blank" title="https://docs.weelinking.com/docs/scenarios/programming/gemini-cli" ref="nofollow noopener noreferrer">docs.weelinking.com/docs/scenar…</a>
通过使用我们的中转API，以及附带的安装配置流程，可以轻松完美使用gemini-cli！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[写了一个 claude.md，AI 写代码终于不乱来了]]></title>    <link>https://juejin.cn/post/7594578555352694835</link>    <guid>https://juejin.cn/post/7594578555352694835</guid>    <pubDate>2026-01-13T10:08:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555352694835" data-draft-id="7594662879201493018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="写了一个 claude.md，AI 写代码终于不乱来了"/> <meta itemprop="keywords" content="Claude,VibeCoding"/> <meta itemprop="datePublished" content="2026-01-13T10:08:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hugo_im"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476706589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            写了一个 claude.md，AI 写代码终于不乱来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476706589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hugo_im
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:08:26.000Z" title="Tue Jan 13 2026 10:08:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">claude.md 是什么？</h2>
<p>最近在使用 Claude Code、MCP、Agent 自动化开发时，你大概率会看到一个文件：<code>claude.md</code>。</p>
<p>它长得像 README，但不是给人看的；<br/>
它又像 Prompt，但不是一次性的。</p>
<p>很多人会困惑：</p>
<blockquote>
<p>👉 claude.md 到底该写什么？<br/>
👉 有没有规范？<br/>
👉 写了真的有用吗？</p>
</blockquote>
<p>本文结合真实工程实践，总结一套 <strong>可落地、可复制的 claude.md 设计方法</strong>，目标只有一个：</p>
<blockquote>
<p><strong>让 AI 真正“懂你的项目”，并且不乱来。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、claude.md 到底解决什么问题？</h3>
<p>一句话：</p>
<blockquote>
<p><strong>claude.md 是给 AI Agent 阅读的项目工程规范文件。</strong></p>
</blockquote>
<p>你可以把它理解为：</p>

















<table><thead><tr><th>面向对象</th><th>文档</th></tr></thead><tbody><tr><td>给人看的项目说明</td><td>README.md</td></tr><tr><td>给 AI 的工程规则</td><td>claude.md</td></tr></tbody></table>
<p>Claude 在执行任务时会自动读取它，用来：</p>
<ul>
<li>理解项目目标和边界</li>
<li>识别真实技术栈（避免乱猜版本）</li>
<li>理解目录结构，避免写错路径</li>
<li>遵守编码和架构约束</li>
<li>正确使用 MCP 工具</li>
<li>避免破坏性修改</li>
</ul>
<p>如果项目没有 claude.md，AI 常见翻车包括：</p>
<ul>
<li>Vue2 项目被写成 Vue3</li>
<li>路径写错，文件生成在奇怪目录</li>
<li>引入根本不需要的依赖</li>
<li>不经确认大范围重构</li>
<li>抓网页不用 MCP，开始“编造内容”</li>
</ul>
<p>这些问题本质不是模型能力问题，而是：</p>
<blockquote>
<p><strong>缺乏稳定、可持续的工程约束输入。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、有没有官方规范？</h3>
<p>目前 Anthropic 并没有发布强制规范。</p>
<p>但社区已经形成一些事实标准：</p>
<ul>
<li>✅ 文件名固定：<code>claude.md</code></li>
<li>✅ 放在项目根目录</li>
<li>✅ 使用 Markdown</li>
<li>✅ 内容偏工程约束，而不是宣传文案</li>
</ul>
<p>目标很明确：</p>
<blockquote>
<p><strong>降低不确定性，提高工程可控性。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、推荐的标准结构</h3>
<p>在多个项目实践中，一个成熟的 claude.md 通常包含 6 个模块：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> Project Overview
<span class="hljs-bullet">2.</span> Environment / Stack
<span class="hljs-bullet">3.</span> Directory Structure
<span class="hljs-bullet">4.</span> Development Rules
<span class="hljs-bullet">5.</span> Tooling / MCP Usage
<span class="hljs-bullet">6.</span> Output Expectations
</code></pre>
<p>下面逐一拆解。</p>
<hr/>
<h3 data-id="heading-4">四、模块设计详解</h3>
<h4 data-id="heading-5">1️⃣ Project Overview：告诉 AI 你在干什么</h4>
<p>这一部分要回答三个问题：</p>
<ul>
<li>项目是做什么的？</li>
<li>核心目标是什么？</li>
<li>Claude 的角色是什么？</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"># Project Overview

This project <span class="hljs-built_in">is</span> a visual template editor built <span class="hljs-keyword">with</span> Vue2 <span class="hljs-built_in">and</span> GrapesJS.
The goal <span class="hljs-built_in">is</span> <span class="hljs-keyword">to</span> allow users <span class="hljs-keyword">to</span> design templates <span class="hljs-built_in">and</span> export HTML.

Claude should:
- Help implement features
- Fix bugs
- Avoid breaking existing behavior
</code></pre>
<p>注意重点：</p>
<blockquote>
<p>❌ 不要写宣传文案<br/>
✅ 要写可执行约束</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">2️⃣ Environment / Stack：防止 AI 猜错技术栈</h4>
<p>这是降低错误率最有效的一段。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Environment</span>

<span class="hljs-bullet">-</span> Frontend: Vue 2.x
<span class="hljs-bullet">-</span> Editor: GrapesJS
<span class="hljs-bullet">-</span> Backend: Flask
<span class="hljs-bullet">-</span> Node: &gt;= 18
<span class="hljs-bullet">-</span> Package Manager: pnpm
</code></pre>
<p>否则 AI 很容易：</p>
<ul>
<li>默认 Vue3</li>
<li>默认最新库 API</li>
<li>默认 npm</li>
<li>默认 Node 最新特性</li>
</ul>
<hr/>
<h4 data-id="heading-7">3️⃣ Directory Structure：防止路径事故</h4>
<p>明确真实目录结构：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Directory Structure</span>

src/
  components/
  plugins/
server/
  app.py
</code></pre>
<p>对自动生成代码、批量修改文件非常关键。</p>
<hr/>
<h4 data-id="heading-8">4️⃣ Development Rules：claude.md 的灵魂</h4>
<p>这是最重要的一部分。</p>
<p>你可以约束：</p>
<ul>
<li>禁止使用的 API</li>
<li>架构原则</li>
<li>安全规则</li>
<li>性能底线</li>
<li>风格约定</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Development Rules</span>

<span class="hljs-bullet">-</span> Do NOT use Vue 3 APIs (no ref, reactive, setup).
<span class="hljs-bullet">-</span> Prefer simple functions over heavy abstractions.
<span class="hljs-bullet">-</span> Avoid introducing new dependencies.
<span class="hljs-bullet">-</span> Do not change existing APIs unless explicitly asked.
</code></pre>
<p>好的规则具备三个特征：</p>
<blockquote>
<p>✔️ 明确<br/>
✔️ 可验证<br/>
✔️ 可执行</p>
</blockquote>
<hr/>
<hr/>
<h4 data-id="heading-9">5️⃣ Tooling / MCP Usage：避免工具滥用</h4>
<p>如果你在使用 MCP，一定要写清楚工具规则：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Tooling</span>

Available tools:
<span class="hljs-bullet">-</span> mcp-fetch
<span class="hljs-bullet">-</span> filesystem
<span class="hljs-bullet">-</span> git

Rules:
<span class="hljs-bullet">-</span> Always use mcp-fetch to fetch web content.
<span class="hljs-bullet">-</span> Ask before modifying more than 3 files.
</code></pre>
<p>否则 AI 很容易：</p>
<ul>
<li>模拟浏览器抓网页（失败）</li>
<li>跳过工具直接编造内容</li>
<li>不经确认修改大量文件</li>
</ul>
<hr/>
<h4 data-id="heading-10">6️⃣ Output Expectations：稳定输出质量</h4>
<p>规范输出格式和语言：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Output Expectations</span>

<span class="hljs-bullet">-</span> Respond in Chinese.
<span class="hljs-bullet">-</span> Provide complete runnable code.
<span class="hljs-bullet">-</span> Show diffs when modifying files.
</code></pre>
<p>这能显著减少沟通成本。</p>
<hr/>
<h3 data-id="heading-11">五、一个可直接使用的完整模板</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Project Overview</span>

This project is a visual editor built with Vue2 and GrapesJS.

Claude should assist with:
<span class="hljs-bullet">-</span> Feature development
<span class="hljs-bullet">-</span> Bug fixing
<span class="hljs-bullet">-</span> Refactoring

<span class="hljs-section"># Environment</span>

<span class="hljs-bullet">-</span> Frontend: Vue 2.x
<span class="hljs-bullet">-</span> Backend: Flask
<span class="hljs-bullet">-</span> Package Manager: pnpm

<span class="hljs-section"># Directory Structure</span>

src/
  components/
  plugins/
server/
  app.py

<span class="hljs-section"># Development Rules</span>

<span class="hljs-bullet">-</span> Do NOT use Vue 3 APIs.
<span class="hljs-bullet">-</span> Avoid unnecessary dependencies.
<span class="hljs-bullet">-</span> Keep backward compatibility.
<span class="hljs-bullet">-</span> Prefer readable code.

<span class="hljs-section"># Tooling / MCP</span>

Available tools:
<span class="hljs-bullet">-</span> mcp-fetch
<span class="hljs-bullet">-</span> filesystem
<span class="hljs-bullet">-</span> git

Rules:
<span class="hljs-bullet">-</span> Use mcp-fetch for web fetching.
<span class="hljs-bullet">-</span> Ask before modifying multiple files.

<span class="hljs-section"># Output Expectations</span>

<span class="hljs-bullet">-</span> Respond in Chinese.
<span class="hljs-bullet">-</span> Provide complete code blocks.
</code></pre>
<p>复制即可用。</p>
<hr/>
<h3 data-id="heading-12">六、进阶玩法：把 AI 真正纳入工程体系</h3>
<p>当你开始把 AI 当“工程成员”而不是“聊天工具”，claude.md 会越来越重要。</p>
<p>几个可进阶方向：</p>
<hr/>
<h4 data-id="heading-13">✅ 多角色约束</h4>
<pre><code class="hljs language-php" lang="php">If acting <span class="hljs-keyword">as</span> Reviewer:
- Only review code, <span class="hljs-keyword">do</span> not modify.

If acting <span class="hljs-keyword">as</span> Implementer:
- Always <span class="hljs-keyword">include</span> tests.
</code></pre>
<hr/>
<h4 data-id="heading-14">✅ 自动化规范</h4>
<pre><code class="hljs language-sql" lang="sql">Git <span class="hljs-keyword">commit</span> format:
feat(<span class="hljs-keyword">scope</span>): description
fix(<span class="hljs-keyword">scope</span>): description
</code></pre>
<hr/>
<h4 data-id="heading-15">✅ 安全与性能底线</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- Never log tokens or secrets.</span>
<span class="hljs-deletion">- Avoid synchronous IO in backend.</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">七、总结</h3>
<blockquote>
<p>claude.md 的价值，不是“写给 AI 看说明书”，<br/>
而是 <strong>把工程经验结构化注入给 AI。</strong></p>
</blockquote>
<p>当规则足够清晰：</p>
<ul>
<li>AI 才能稳定输出</li>
<li>项目才不会被误伤</li>
<li>Agent 才真正具备工程可控性</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[带你用 Javascript 生成器玩转「会暂停」的函数]]></title>    <link>https://juejin.cn/post/7594667893015773199</link>    <guid>https://juejin.cn/post/7594667893015773199</guid>    <pubDate>2026-01-13T09:39:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594667893015773199" data-draft-id="7594626381432897586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="带你用 Javascript 生成器玩转「会暂停」的函数"/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2026-01-13T09:39:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奶糖的次元空间"/> <meta itemprop="url" content="https://juejin.cn/user/4142615543685326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            带你用 Javascript 生成器玩转「会暂停」的函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4142615543685326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奶糖的次元空间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:39:43.000Z" title="Tue Jan 13 2026 09:39:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多同学一看到 <code>function*</code> 和 <code>yield</code> 就本能地想关文章：看起来又难、又少用。<br/>
但其实，<strong>生成器（Generator）是 JS 里少见的“会暂停的函数”</strong>，写好了不仅能让异步逻辑更优雅，还能在处理流式数据（比如大模型回复、SSE 等）时非常顺手。</p>
<p>这篇文章不讲花里胡哨的理论，而是带你一步步搞清楚：</p>
<ul>
<li><strong>生成器到底是什么？和普通函数有什么本质区别？</strong></li>
<li><strong>怎么用 <code>next()</code> 和 <code>for...of</code> 去“消费”一个生成器？</strong></li>
<li><strong>在 Node.js / 浏览器里，生成器在哪些场景是真的好用？</strong></li>
<li><strong>如何结合 SSE，把大模型这种流式输出封装成一个好用的异步生成器？</strong></li>
</ul>
<p>看完你可以不爱它，但至少<strong>不会再怕它</strong>。</p>
<h2 data-id="heading-0">1. 生成器是什么？一句话版本</h2>
<p>用一句话概括：</p>
<blockquote>
<p><strong>生成器函数 = 可以中途 <code>yield</code> 暂停、之后再从上次暂停位置继续执行的函数。</strong></p>
</blockquote>
<p>它有两点和普通函数完全不一样：</p>
<ol>
<li><strong>不会立刻执行</strong>：调用生成器函数时，不会马上跑代码，而是返回一个“生成器对象”。</li>
<li><strong>执行过程可中断</strong>：在函数内部用 <code>yield</code> 抛出一个值的同时，函数会暂停；下次继续从暂停处往后执行。</li>
</ol>
<p>生成器函数用 <code>function*</code> 定义，最简单的例子长这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">generator</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
}
</code></pre>
<p>不管是在 Node.js 还是浏览器中，生成器都已经是非常标准的一部分了。</p>
<h2 data-id="heading-1">2. 生成器第一次调用时，到底发生了什么？</h2>
<p>重点：调用生成器函数本身，不会执行函数体。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">generator</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
}

<span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">generator</span>(); <span class="hljs-comment">// 这里不会执行函数体</span>
</code></pre>
<p>这一步返回的 gen 是一个特殊的迭代器对象，只有在你开始“消费”它时，函数体才会真正执行。每一次消费，都通过 next() 完成。</p>
<h2 data-id="heading-2">3. 用 next() 消费生成器：一段一段地执行</h2>
<p>生成器最常见的使用方式，就是直接调用 next()：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">generator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 1, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 2, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 3, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: undefined, done: true }</span>
</code></pre>
<p>可以看到：</p>
<ul>
<li><code>value</code>：本次 <code>yield</code> 抛出的值</li>
<li><code>done</code>：生成器是否已经执行完毕
<ul>
<li><code>false</code>：后面还有东西</li>
<li><code>true</code>：已经结束，再调也是 <code>{ value: undefined, done: true }</code></li>
</ul>
</li>
</ul>
<p>这里有两个容易忽略的特性：</p>
<ul>
<li>同一个生成器实例（<code>gen</code>）只能从头到尾走一次。</li>
<li>你可以根据自己的节奏，在任何时间点调用 next()，这就是它“可以暂停”的本质。</li>
</ul>
<h2 data-id="heading-3">4. 用 <code>for...of</code> 优雅遍历生成器</h2>
<p>手动 <code>next()</code> 有点繁琐，生成器本身就是可迭代对象，所以可以直接用 <code>for...of</code> 来消费:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">generator</span>();

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> gen) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);
}
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
</code></pre>
<p><code>for...of</code> 会在内部帮你处理 <code>next()</code>，直到 <code>done</code> 为 <code>true</code> 为止。所以你可以把生成器当成一个自定义规则的“数据流”来看待：你决定它一次 <code>yield</code> 出什么、什么时候结束。</p>
<h2 data-id="heading-4">5. 生成器能干嘛？几个典型场景</h2>
<p>很多人印象里，生成器只和“高级用法”“底层库”绑定在一起，但在 Node.js 和浏览器实际开发中，有几个场景非常适合用它：</p>
<ul>
<li>控制复杂的异步流程（早期 co 库那一代玩法）</li>
<li>构造自定义迭代器（比如分页数据、树遍历等）</li>
<li>处理流式数据（重点：和大模型 / <code>SSE</code> 这种「一小段一小段不断回来」的数据非常契合）</li>
</ul>
<p>现在有了 <code>async/await</code> 之后，前两类常见程度下降了一些，但在流式场景里，生成器依然非常好用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[动态代理]]></title>    <link>https://juejin.cn/post/7594626381433208882</link>    <guid>https://juejin.cn/post/7594626381433208882</guid>    <pubDate>2026-01-13T10:18:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381433208882" data-draft-id="7594662879201656858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="动态代理"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T10:18:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="makinohara"/> <meta itemprop="url" content="https://juejin.cn/user/455637552340731"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            动态代理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/455637552340731/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    makinohara
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:18:09.000Z" title="Tue Jan 13 2026 10:18:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">什么是动态代理？</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"吃饭"</span>)
    }
}
</code></pre>
<p>现在我们想给eat方法增加一些东西，让吃饭这个动作更加完整</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"拿筷子"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"盛饭"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"吃饭"</span>);
    }
}
</code></pre>
<p>这种修改叫做侵入式修改。在一个成熟的项目中，我们很少会这么修改，容易引发一系列连锁问题。</p>
<p>那么问题来了，我现在不能修改原有的代码，又要增加额外的功能，该如何实现？</p>
<p>此时我们可以找一个代理，即一个中介公司，它会先做拿筷子和盛饭这两个动作，等真正吃饭了再调用Student的eat方法吃饭，这就是动态代理，它可以无侵入式地给代码增加额外的功能。可以理解为明星的经纪人。</p>
<p>对象有什么方法想被代理，代理就一定要有对应的方法。代理中对应的方法会先把其它事情做完，再调用原来对象中的方法。</p>
<p>中介如何知道要派有对应方法的代理？这需要通过接口来解决。把被代理的方法写在接口中，让代理和对象都实现这个接口。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigStar</span> implements Star{
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BigStar</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BigStar</span><span class="hljs-params">()</span> </span>{
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> name;
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
    }
​
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"BigStar{"</span> +
                <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">'''</span> +
                <span class="hljs-string">'}'</span>;
    }
​
    <span class="hljs-comment">//唱歌和跳舞</span>
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">sing</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-keyword">this</span>.name + <span class="hljs-string">"正在唱"</span> + name);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"谢谢"</span>;
    }
​
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">dance</span><span class="hljs-params">()</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-keyword">this</span>.name + <span class="hljs-string">"正在跳舞"</span>);
    }
}
</code></pre>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Star</span> {
​
    <span class="hljs-comment">//把所有想要代理的方法定义在接口中</span>
    <span class="hljs-comment">//唱歌和跳舞</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">sing</span>(<span class="hljs-params">String name</span>)</span>;
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dance</span>()</span>;
}
</code></pre>
<p>java.lang.reflect.proxy类提供了为对象产生代理对象的方法</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> newProxyInstance(ClassLoader loader, <span class="hljs-keyword">Class</span>&lt;?&gt;[] interfaces, InvocationHandler h)
</code></pre>
<p>参数一：用于指定用哪个类加载器，去加载生成的代理类。</p>
<p>参数二：指定接口，这些接口用于指定生成的代理有哪些方法</p>
<p>参数三：指定生成的代理对象要干什么事情</p>
<p>类加载器负责将字节码文件加载到内存当中，通过getClassLoader方法找到是谁把当前这个类的字节码文件加载到内存的。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Star</span> {
​
    <span class="hljs-comment">//把所有想要代理的方法定义在接口中</span>
    <span class="hljs-comment">//唱歌和跳舞</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">sing</span>(<span class="hljs-params">String name</span>)</span>;
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dance</span>()</span>;
}
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigStar</span> implements Star{
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BigStar</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BigStar</span><span class="hljs-params">()</span> </span>{
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> name;
    }
​
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
    }
​
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"BigStar{"</span> +
                <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">'''</span> +
                <span class="hljs-string">'}'</span>;
    }
​
    <span class="hljs-comment">//唱歌和跳舞</span>
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">sing</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-keyword">this</span>.name + <span class="hljs-string">"正在唱"</span> + name);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"谢谢"</span>;
    }
​
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">dance</span><span class="hljs-params">()</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-keyword">this</span>.name + <span class="hljs-string">"正在跳舞"</span>);
    }
}
</code></pre>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProxyUtil</span> {
    <span class="hljs-comment">//创建一个代理</span>
​
    <span class="hljs-comment">//给一个明星对象创建一个代理</span>
    <span class="hljs-comment">//形参：被代理的明星对象，要知道给谁做代理</span>
    <span class="hljs-comment">//返回值：给明星创建的代理</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Star <span class="hljs-title">createProxy</span>(<span class="hljs-params">BigStar bigStar</span>)</span> {
​
        Star star = (Star) Proxy.newProxyInstance(
                ProxyUtil.<span class="hljs-keyword">class</span>.getClassLoader(),
                <span class="hljs-keyword">new</span> Class[]{Star.<span class="hljs-keyword">class</span>},<span class="hljs-comment">//将接口的字节码放在数组中，这些接口用于指定代理长什么样，也就是中介能代理哪些方法，如果有多个接口可以把它们都写在数组中</span>
                <span class="hljs-keyword">new</span> InvocationHandler() { <span class="hljs-comment">//指定生成的代理要做什么</span>
                    @Override
                    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span>(<span class="hljs-params">Object proxy, Method method, Object[] args</span>) throws Throwable</span> {
                        <span class="hljs-comment">//参数一：代理的对象</span>
                        <span class="hljs-comment">//参数二：要运行的方法</span>
                        <span class="hljs-comment">//参数三：方法参数</span>
                        <span class="hljs-keyword">if</span>(<span class="hljs-string">"sing"</span>.<span class="hljs-keyword">equals</span>(method.getName())) {
                            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"准备话筒，收钱"</span>);
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"dance"</span>.<span class="hljs-keyword">equals</span>(method.getName())) {
                            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"准备场地，收钱"</span>);
                        }
                        <span class="hljs-comment">//去找大明星开始唱歌或跳舞</span>
                        <span class="hljs-comment">//代码里的表现形式：调用大明星里的唱歌或跳舞方法</span>
                        <span class="hljs-keyword">return</span> method.invoke(bigStar,args);<span class="hljs-comment">//反射</span>
                    }
                }
        );
​
        <span class="hljs-keyword">return</span> star;
    }
}
​
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">//需求：粉丝想要大明星唱一首歌</span>
        <span class="hljs-comment">//1.获取代理的对象：代理对象 = ProxyUtil.createProxy（大明星的对象）</span>
        <span class="hljs-comment">//2.再调用代理的唱歌方法，此时会运行invoke</span>
​
        <span class="hljs-comment">//1.获取代理的对象</span>
        <span class="hljs-type">BigStar</span> <span class="hljs-variable">bigStar</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigStar</span>(<span class="hljs-string">"鸡哥"</span>);
        <span class="hljs-type">Star</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> ProxyUtil.createProxy(bigStar);
​
        <span class="hljs-comment">//2.调用唱歌方法</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> proxy.sing(<span class="hljs-string">"只因你太美"</span>);
        System.out.println(res);
    }
}
</code></pre>
<p>重点在于理解创建代理的代码。可以理解为给明星配置一个经纪人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（39）Hibernate中如何使用拦截器？]]></title>    <link>https://juejin.cn/post/7594523145211674678</link>    <guid>https://juejin.cn/post/7594523145211674678</guid>    <pubDate>2026-01-13T12:03:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594523145211674678" data-draft-id="7594642978696036415" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（39）Hibernate中如何使用拦截器？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-13T12:03:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（39）Hibernate中如何使用拦截器？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T12:03:57.000Z" title="Tue Jan 13 2026 12:03:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate中的拦截器</h3>
<p>Hibernate拦截器（Interceptor）是一个允许你在实体对象的生命周期事件（如保存、更新、删除等）发生时插入自定义逻辑的机制。通过实现<code>Interceptor</code>接口，可以在这些事件触发时执行特定的操作。</p>
<h3 data-id="heading-1">使用拦截器的示例代码</h3>
<h4 data-id="heading-2">步骤一：创建一个拦截器类</h4>
<p>首先，我们需要创建一个实现<code>Interceptor</code>接口的类。这个类将包含我们希望在实体对象生命周期事件发生时执行的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.interceptor;

<span class="hljs-keyword">import</span> org.hibernate.EmptyInterceptor;
<span class="hljs-keyword">import</span> org.hibernate.type.Type;

<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.util.Iterator;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EmptyInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDelete</span><span class="hljs-params">(Object entity, Serializable id, Object[] state, String[] propertyNames, Type[] types)</span> {
        System.out.println(<span class="hljs-string">"Entity deleted: "</span> + entity);
        <span class="hljs-built_in">super</span>.onDelete(entity, id, state, propertyNames, types);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onFlushDirty</span><span class="hljs-params">(Object entity, Serializable id, Object[] currentState, Object[] previousState, String[] propertyNames, Type[] types)</span> {
        System.out.println(<span class="hljs-string">"Entity updated: "</span> + entity);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onFlushDirty(entity, id, currentState, previousState, propertyNames, types);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onLoad</span><span class="hljs-params">(Object entity, Serializable id, Object[] state, String[] propertyNames, Type[] types)</span> {
        System.out.println(<span class="hljs-string">"Entity loaded: "</span> + entity);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onLoad(entity, id, state, propertyNames, types);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onSave</span><span class="hljs-params">(Object entity, Serializable id, Object[] state, String[] propertyNames, Type[] types)</span> {
        System.out.println(<span class="hljs-string">"Entity saved: "</span> + entity);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onSave(entity, id, state, propertyNames, types);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postFlush</span><span class="hljs-params">(Iterator entities)</span> {
        System.out.println(<span class="hljs-string">"Post flush"</span>);
        <span class="hljs-built_in">super</span>.postFlush(entities);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preFlush</span><span class="hljs-params">(Iterator entities)</span> {
        System.out.println(<span class="hljs-string">"Pre flush"</span>);
        <span class="hljs-built_in">super</span>.preFlush(entities);
    }
}
</code></pre>
<h4 data-id="heading-3">步骤二：配置Hibernate以使用拦截器</h4>
<p>在创建SessionFactory实例时，我们需要将自定义的拦截器传递给Hibernate。</p>
<h5 data-id="heading-4">Hibernate配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-5">HibernateUtil类</h5>
<p>在<code>HibernateUtil</code>类中，我们将自定义的拦截器传递给<code>Configuration</code>对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;
<span class="hljs-keyword">import</span> com.example.interceptor.CustomInterceptor;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>);
            configuration.setInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomInterceptor</span>());  <span class="hljs-comment">// 设置自定义拦截器</span>
            sessionFactory = configuration.buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-6">步骤三：使用Hibernate进行数据库操作</h4>
<p>我们将创建一个包含一些CRUD操作的示例，以触发拦截器的各种方法。</p>
<h5 data-id="heading-7">示例操作类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> com.example.domain.Product;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateInterceptorExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 更新示例数据</span>
        updateSampleData(sessionFactory);

        <span class="hljs-comment">// 查询示例数据</span>
        querySampleData(sessionFactory);

        <span class="hljs-comment">// 删除示例数据</span>
        deleteSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">1000.0</span>);
            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"Smartphone"</span>, <span class="hljs-number">500.0</span>);
            session.save(product1);
            session.save(product2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, <span class="hljs-number">1L</span>);
            product.setPrice(<span class="hljs-number">1200.0</span>);
            session.update(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Updated sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">querySampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, <span class="hljs-number">1L</span>);
            System.out.println(<span class="hljs-string">"Queried product: "</span> + product.getName() + <span class="hljs-string">", "</span> + product.getPrice());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, <span class="hljs-number">1L</span>);
            session.delete(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Deleted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-8">详细解释</h3>
<ol>
<li>
<p><strong>创建拦截器类</strong>：</p>
<ul>
<li><code>CustomInterceptor</code> 类实现了 <code>EmptyInterceptor</code>。</li>
<li>重写了 <code>onDelete</code>, <code>onFlushDirty</code>, <code>onLoad</code>, <code>onSave</code>, <code>preFlush</code>, <code>postFlush</code> 等方法来插入自定义逻辑，比如打印日志。</li>
</ul>
</li>
<li>
<p><strong>配置Hibernate以使用拦截器</strong>：</p>
<ul>
<li>在 <code>HibernateUtil</code> 类中，使用 <code>Configuration</code> 的 <code>setInterceptor</code> 方法来设置自定义的拦截器。</li>
<li>拦截器将在 <code>SessionFactory</code> 创建时被应用。</li>
</ul>
</li>
<li>
<p><strong>示例操作类</strong>：</p>
<ul>
<li>包含了一些CRUD操作，用于演示如何在操作过程中触发拦截器的方法。</li>
<li>通过 <code>insertSampleData</code>, <code>updateSampleData</code>, <code>querySampleData</code>, <code>deleteSampleData</code> 方法展示了数据的插入、更新、查询和删除操作。</li>
</ul>
</li>
</ol>
<p>通过这种方式，Hibernate中的拦截器可以在实体对象的生命周期事件发生时执行自定义的逻辑，从而实现类似日志记录、数据验证、审计等功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新的起点，新的期盼｜2025年终总结]]></title>    <link>https://juejin.cn/post/7594626381433159730</link>    <guid>https://juejin.cn/post/7594626381433159730</guid>    <pubDate>2026-01-13T10:09:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381433159730" data-draft-id="7594482829755433006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新的起点，新的期盼｜2025年终总结"/> <meta itemprop="keywords" content="年终总结"/> <meta itemprop="datePublished" content="2026-01-13T10:09:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文如秋雨"/> <meta itemprop="url" content="https://juejin.cn/user/3897092103223517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新的起点，新的期盼｜2025年终总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3897092103223517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文如秋雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:09:30.000Z" title="Tue Jan 13 2026 10:09:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2025 年好似做了一场梦。</p>
<p>梦里遍地闪烁着记忆的碎片，我赤脚前行，前面是一扇透着光半掩着的门，我伸出手想要去触摸它，但每走一步，脚底被碎片扎得生疼。我透过门缝看到了外面的世界，那是没有看过的景象，如莫奈的画一般的天空和云朵，暖风吹过绿色的斜坡草坪，几个模糊的身影浅笑着向我伸出了手，一切都是我憧憬的模样。</p>
<p>我忍着疼痛小步前行着，但越靠近着那扇通往新世界的门时，耳边传来了来自背后的声音，那是我熟悉的声音。我不敢回头，也知道不应该回头，我知道，背后的不是别人，而是过去的自己。</p>
<p>我终是走到了门前，握住了通往新世界的门把手，手掌传来了些许温暖，门外的阳光透过缝隙撒在手背上，泛起丝丝晶莹。</p>
<p>“我要往前走了。” 我对过去的自己说。</p>
<p>打开门拥抱阳光的那一刻，耳旁似乎听到一声告别。</p>
<p>“好，你一定要幸福。”</p>
<h2 data-id="heading-1">解构 2025</h2>
<p>1 年拆分出来，便是 12 个月，而按天拆分，也只是 36.5 个 10 天。浑浑噩噩是 1 天，开开心心也是 1 天，有所成就是 1 天，失落愤慨亦是 1 天。从朋友圈翻了翻 2025 年发生过的事，有故事，也有事故，有顺其自然，也有偶尔失控。</p>
<h3 data-id="heading-2">我&amp;鸿蒙</h3>
<p>最早在 23 年底了解鸿蒙开始，到 24 年认证成为华为开发者专家，再到 25 年线下线上的<strong>活动分享</strong>，我在鸿蒙布道这条路上跌跌荡荡走过许久。</p>
<p>2025 年发生的事情不多，3 月的ArkUI 案例分享，6 月的 HarmonyOS SDK AI开放能力分享，两场线下<strong>HDD活动</strong>，让鸿蒙布道成为了不错的开端。9 月上旬的两场<strong>线上直播</strong>，HarmonyOS 动画实战、HarmonyOS 动画与开源项目实践，则在 UI 的基础上揭示了人机交互的更多玩法。9 月下旬，<strong>华为全联接大会 2025</strong> 的 <strong>OpenSpeech</strong> 环节上，也有幸将自己的开源项目及其历程分享给更多的开发者朋友。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343782038d3740a3b987493194c5f108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=WPVlbBmg8jxksNxj6mlxvmYUfu0%3D" alt="" loading="lazy"/></p>
<p>UI、动画、AI、开源，每一次分享都是新的主题，对我来说都需要重新接触、吸收、转化，最终输出。还记得第 1 次线上直播前试播时，对着写好的稿件念稿，眼神飘忽、语调乏味，到后面第 2 次直播的慷慨激昂，沉稳有序。而线下活动也不再畏畏缩缩，开始自信且坦然地讲述属于自己的故事，偶尔还能说几个段子让现场活跃起来。</p>
<blockquote>
<p>每一次新的尝试，都成为了宝贵的人生体验。</p>
</blockquote>
<p>如果说还有什么，是在编程和探索心之外激励着我不断在鸿蒙领域深耕，我想可能是正向反馈吧，那是在温饱之上的自我价值的实现。在 <strong>2025 底的鸿蒙人才布道师年度论坛</strong>上，当在大荧幕上看到自己的那一刻，激动的沉默胜过无数的言语。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b9ff68fece4bc0996f17dc602f53f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=X5Njyd4GqQNx%2FTbNVbO7HZWSeaw%3D" alt="" loading="lazy"/></p>
<p>鸿蒙，在中国古代哲学神话中指的是天地未开的混沌状态，既是起源，也是未来。很是神奇，懵懵懂懂就踏入了鸿蒙生态，随后尝试了很多以前从未做过的事情，也取得了不错的成就，当然，踩过的坑也只有自己知道。</p>
<p><strong>先开始，在不打乱日常生活方式的情况下进行创新和过渡</strong>，这可能是我在鸿蒙这里学到的最有用的道理。</p>
<h3 data-id="heading-3">我&amp; AI</h3>
<p>ChatGPT、Midjourney、Stable Diffusion 打开图文生成的潘多拉魔盒，到 Suno、Sora 的音乐视频惊艳亮相，到现在 Copilot、Cursor、TRAE、ClaudeCode、Gemini 席卷 AI 编程，以及像 DeepSeek、Kimi、豆包等 C 端产品深入人们的日常生活。每天，甚至有可能下一秒就有一个新的形态的 AI 产品曝光在大众视野。</p>
<p>这两年总是能听到或者看到 AI，或者 AI 工具层出不穷，好像不了解 AI 或者没有使用 AI 就会被社会立即淘汰。这有点像 03 年计算机出现那样，AI 企业喷涌而出然后快速消亡，自媒体充斥着焦虑和幻想，而普罗大众在这种氛围下选择了边卷边躺平，一片祥和又含带一丝诡异。</p>
<p>我最早接触 AI 也是从 ChatGPT 开始，方案文档的编写效率和质量，以及那打字机的对话交互方式，让我第一次有了像科幻电脑那样的人机交互的实感。随后在各类 AI 工具的“洗礼”下，我开始各种尝试和学习。非常幸运的是，最早接触的字节推出的 AI 编程工具 MarsCode 升级成为了 <strong>TRAE（The Real AI Engineer）</strong>，也让我有了深入了解 AI 编程领域的机会。</p>
<p>于是乎在 2000 多人的筛选下，我成为了深圳的<strong>TRAE Fellow</strong> 和<strong>TRAE Expert</strong>，开始从参加活动、出席活动到组织活动，在 25 年开始了新的尝试。10 月的 TRAE Friends 深圳场的 <strong>Meetup</strong>，11 月的TRAE Solo <strong>Hackathon</strong>，一下子从一个人的“单打独斗”转变成了与更多 AI 爱好者们一起探索和沟通，有点开启了打怪升级的新篇章。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bfbb7977e79474494bebbfea8cbe2f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=UTsk5f1MiVB%2FP%2Fc5TykEuYdcna4%3D" alt="" loading="lazy"/></p>
<p>AI 给人们带来的，是实现梦想的可能，我一直秉承着的这个观点。当一项技术能够打破编程开发的门槛，让更多的初学者能用极少的代价来尽可能靠近自己想要的目标，我想这才是技术落地的价值。而在这个生态里，我想做的或者能做的，便是在持续学习的基础上，将自己过往所获得的经验和初心，以这样那样的方式去感染一些人。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9aad537d806d40cfa474cd241547d868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=vlRycY6f923R4sKciK4wS8nrN7E%3D" alt="" loading="lazy"/></p>
<p>其实最早 AI 也给我带来过焦虑，它让我过往可能学了几年的独立开发，无论是 iOS 还是鸿蒙的编程优势可能一下清零。但实际接触后会发现，AI 技术反而让我更专注于逻辑实现，而不是代码块本身，而逻辑实现本就是人的理性强项。</p>
<p>从命令式语法，到声明式语法，再到现在的<strong>自然语言编程</strong>，不会有人是仅仅为了代码语法好看而去学习编程，学习编程的目的，更多是为了创造出有趣好玩的作品，它可以是商业化的，也可以是为了让自己开心。</p>
<p>于是我开始了新的尝试，将自己灵感一现的想法，通过 <strong>VibeCoding</strong> 的方式呈现出来，算是在新的一年里探索一种新的路线吧～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16bd1c853eb1499cbed4066293296d8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=gZSayWNgauRbfsqrWUG95YENSqI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">我&amp;工作</h3>
<p>年底收到 <strong>N+1</strong> 的那一刻，我和现在一样，很是坦然。</p>
<p>许是下半年业务找不到增长口，以及产品演进方向已然有点凌乱，或是在8月份一半同事转岗离开的征兆......一系列的变化让我已经为“最坏”的结果做准备。还记得那天和 LD 一起去和大老板聊的时候问我是什么想法，我心里空荡荡的，没有太多的情绪波动，后面甚至单独和大老板吃饭时问起我的想法时，我也说非常同意当前公司的决策。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6758663a5d83475890f614dbc9880b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=rGHOsN91RpKKzSEgRIrmw12bJZ4%3D" alt="" loading="lazy"/></p>
<p>24 年初进入这家公司，从 0 开始了解海外旅游分销这个细分行业，并从 0 开始管理团队、搭建从前、中、后 3 端的系统，新的团队，新的行业，新的目标和展望，起初一切好像都往理想的方向演进。回过头来看，所有的美好都基于企业业绩的增长和平台依靠，而在其中有成长，也有遗憾。</p>
<p>在这份工作中，我遇到了一个很好的 LD，教会了我很多关于<strong>产品、开发、团队管理</strong>相关的技能，也让我对于产品开发有了一些不一样的理解。</p>
<p>产研团队就像是一架火车，前方是明确的目的地，位于火车头的<strong>产品经理</strong>提前规划好 1～2 个版本的迭代，并<strong>拉动着团队火车往前跑</strong>。位于中间车厢的<strong>开发工程师</strong>们负责拆解需求，稳定输出质量并按时交付，<strong>稳住中间开发阶段</strong>。而在尾节车厢的是<strong>测试工程师</strong>一方面需要对于交付结果进行检测，另一方面也需要紧抓时间节点、组织迭代复盘从而<strong>推着团队往前跑</strong>。由此，在敏捷开发的团队协作方式中，由产品、开发、测试所组成的 3 要素火车才能平稳运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cc00a5204174d6bb06e1138f7f898dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=ZgMfIq5%2FDn1VGWQbr31lLggeX2A%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>没有完美的团队和产研开发方式，所以最好的方式是让这架火车先按版本跑起来，再在每个版本中进行更新迭代，每次发现一个问题并解决，那么经过多个版本后，可能不断会有新的问题产生，但整个火车会持续往前跑，并且越发稳定。</p>
</blockquote>
<p>如果要说产品经理最重要的软技能是什么，可能标准回答有抽象能力、同理心、Owner思维等等，但现在我的回答是<strong>Balance（平衡）</strong>。在多角色协同的工作中，除了本身产研内部的产品需求与开发排期之间的 Gap 外，还有对于业务部门为开展业务而产生的诉求与产研开发交付的版本之间的 Gap、不同业务部门之间的理解和信息同步的Gap、自身所在的产研团队与其他开发团队之间的Gap.....一系列的 Gap，都需要中间的衔接者，或者项目的发起者去推动。</p>
<p>多人协同的 Gap 是无法被解决的，只能被<strong>管理和引导</strong>，比如通过 RICE 框架等方式对需求优化级进行量化并管理预期，通过可视化面板进行信息同步和飞书等消息机制进行有效通知来减少消息传递的失真，通过产研需求的预先方案技术评估与产品 Demo 的快速演示来提高沟通的效率和模式的快速模拟验证，通过简短且明确的会议拉通共识和对齐节奏....所有的方式和手段，都是为了让Gap 可控，在长期合作中磨合出人与人之间、系统与系统之间的节奏，这便是Balance。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb8c1fcf784944b19ca0f26d733d9c8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=v9Mz%2BWDu9f2BvhIbVN4VFCSmEfU%3D" alt="" loading="lazy"/></p>
<p>最早 18 年第一次踏入产品经理岗位，一晃 7、8 年过去了，从企业团餐，到服装新零售，到海外旅游（用车），回头看一路都在ToB 领域围绕着「<strong>衣食住行</strong>」进阶和探索。最早设计单一的功能模块，到多个模块之间设计工作流程，到后来从 0 到 1 设计整个系统、多个系统，到现在为遵循<strong>第一性原理</strong>管理团队支撑业务，一切都很顺利，但一切都没那么顺畅。</p>
<p>职场有时候真的很奇怪，你得要有超出中高级产品的能力和技能、经验、背书，才能去应聘中高级产品，而不是像游戏一样升级打怪积累到一定水平就自动升级，而且这其中到底需要具备什么明确的条件也缺少能够明确量化的指标。</p>
<p>我的浅见是：<strong>能不能做、如何做</strong>是第 1 步，这考察的是借助方法论和软硬技能来执行和达成既定结果。<strong>如何科学评估，如何做好，在现有资源做出合适的流程或产品设计</strong>，这考察的是对复杂事物的解构和推动，对结果负责，这是第 2 阶段。</p>
<p><strong>能不能持续稳定地创造价值，在不确定性的系统中做出决策从而不断靠近目标</strong>，这考察的是对于人-事-资源的深入思考。</p>
<p>在这个大的方向下，定义需要被管理的目标、承担责任进行决策、构建科学的产品运转的工作流程、根据商业模式和业务开展的不同阶段构建可升级的产品形态，从而创造<strong>可持续</strong>的价值，我认为这才是第 3 阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3ce6be2f1384e158e81e3bdeed57dc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=84FqmcWO8k2jPA82U%2B7QH%2BkkR9A%3D" alt="" loading="lazy"/></p>
<p>每次停下来的时候，我都会思考一个问题：产品、技术，我到底适合哪一个方向？每一次我都选择了产品这条路，真的好奇怪，我的底气到底在哪？也许是当初 8 年多以前在思维导图上<strong>解构自我</strong>的时候发现贴切这个岗位，也或许是在这个岗位和职业生涯中总是能找到<strong>激励</strong>我前进和学习的地方，又或许是底子里我想做出一些成就来<strong>实现自我价值</strong>的升华，而产品经理是最接近的最优选择。</p>
<p>都或许吧，在技术能力、AI 的加持下，没准我能更靠近想要的目标，去发现我心底里真正想做的事情。</p>
<h3 data-id="heading-5">我&amp; TA</h3>
<p>这是我在 25 年挺敏感的一个话题，一段话概述便是：<strong>和谈了 5 年的前对象在年中分开了，遇见了一些很好的新朋友，拥有了现在的她。</strong></p>
<p>分开是在 25 年 5 月份，她 5.1 从云南回来，很认真和我说我们分开吧，随后和平分手、退家庭群、搬家，到后面断了联系再也不见。我身边所有的朋友、家人都很不理解，也很难接受，为什么两人就这么分开了？但可能只有我们才知道，我们已经无法一起面对未来了。我们的期待不同，我们想要的未来逐渐清晰，只是在那个未来里，不再需要对方了。</p>
<blockquote>
<p>人生无常，大肠包小肠。</p>
</blockquote>
<p>不良习惯（比如吸烟）不是问题关键，说好了戒烟却做不到的失信，才是信任感流失、两人开始渐行渐远的本质；工作生活的焦虑也不是双方沟通的阻碍，而是宁愿一个人逃避，也不愿和对方诉说的封闭，慢慢将两人的边界画得越发清晰；纪念日等重要时刻的缺席也不是感情崩塌的主要原因，一次次委屈瞬间的故意无视，消耗了仅存的温情，最后才是，失望，离开。</p>
<p>我经常和别人说：</p>
<blockquote>
<p>两个人在一起的前提，是本来一个人就过得很好，因为两个人在一起能过得更好，所以才在一起。如果没有办法给对方幸福，就不要阻挡对方追求幸福的权利。</p>
</blockquote>
<p>如今，这一点切切实实体现在了我身上。</p>
<blockquote>
<p>感谢你陪我走过的这一段路，祝你往后幸福，无论发生什么事仍然有勇气去追寻你想要的生活，谢谢你。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65527b3bd5d94c19aedff274f28be9cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=151VCkI8NwRFgsczayJof3viap8%3D" alt="" loading="lazy"/></p>
<p>你说在偶然间遇到一个人，然后一起去看电影，最后成为很好的朋友，这概率有多大？我想不到 1/1000 吧。</p>
<p>在 7、8 月有些消沉的那段时间，我一个人在新开的游戏厅玩 Switch 游戏（星之卡比），突然有个人走过来，然后我鬼使神差地问：要一起玩不？然后他伸出了手，我俩握了握手正式认识，后面这个人说上面电影院在放《<strong>小王子</strong>》的重映要不要去看，我也刚好空闲就一起去了，到后面相处多了，聊的越来越多，成为了很好的朋友。</p>
<p>好奇怪，就这么神经地认识了老庄这么个朋友，很可惜这家伙不是个女的，MD。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1e59bc785f24a2a9a3a1f635dcbaf31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=mSRHUKAamAQ7gxt%2FzRZvppVJDio%3D" alt="" loading="lazy"/></p>
<p>老庄和我虽然有相似的地方，但性格完全相反，思维总是跳跃到不行，看到我怂怂的总是想怂恿我去做一些“破界”的事情，比如一起坐在牌坊的台阶上喝着柠檬茶光明正大看美女（以前我都是偷偷瞄一下），比如带我去酒吧喝酒点陪聊（就经历过那么一次，我怂到不行，装得贼正经），还有怂恿我去追喜欢的女孩子（后面我还追成了，在此谢过义父）....</p>
<blockquote>
<p>“你好不容易选择走出来，还想着过去？你都开始有新的生活，为什么还要陷到过去的情绪，你在害怕什么？”</p>
</blockquote>
<blockquote>
<p>“兄弟就是这样的，开心也要分享，不开心也要分享，有时候别一个人想事情，多出来走走。”</p>
</blockquote>
<blockquote>
<p>“你没有办法讨好所有人，你需要做的是讨好自己。”</p>
</blockquote>
<blockquote>
<p>“因为同频，所以共振，所以我们一起行，也一定行。”</p>
</blockquote>
<p>从刚开始聊天老庄整天像心理医生那样剖析我的心理状态，拉着我从泥潭走了出来，到现在隔三差五我会去找他瞎逼逼，老庄这家伙真是个很好的人，挺庆幸遇到个这样个朋友，敬兄弟一杯～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45d37b1b21a94c04a5803b49f30a9073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=pmneoQG%2Bzjympa7qq%2FbGee%2FVeLA%3D" alt="" loading="lazy"/></p>
<p>本来以为自己就会这样单着一直到 26 年甚至更久，没想到遇到了<strong>乖宝</strong>。</p>
<p>许是我失眠抑郁那段时间送来的维生素 B6，许是那吵吵闹闹的性格叫醒了躲在角度暗自神伤的我，许是一次次的聊天让我看到了一个真实且不一样的女孩子，许是初次见面时的自然而然的相处、牵手，许是不经意间觉察到那白雪般的皮肤在阳光下晶莹透亮，许是 11 月浏阳夜晚的烟花太过于梦幻，许是一次次的从深圳到北京跨越 1500 公里的追寻.....</p>
<p>这一切发生都太过于突然，突然到每次想到我和<strong>乖宝</strong>在一起这件事都有些不真实。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fe395e7715d4de1922d50889627d146~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5aaC56eL6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903769&amp;x-signature=lR4Fwz5wgdOJX%2FY0vlr717SWtZQ%3D" alt="" loading="lazy"/></p>
<p>爱情，对这个时代来说真的很奢侈，我们想要的东西太多太多，就导致很多东西就变得没那么纯粹了，于是我们不敢走出舒适圈，不敢去相信人，不敢去接触新的事物。而当我们真的打破了固有的思维和封闭圈时，会发现外面并没有别人，都是自我的设限和想象罢了。</p>
<p>我不知道以后会是什么样子，但我想和乖宝一起尝试一起面对，尽管我有很多不足，也没啥底气，但我想试试，去体验下不一样的事物，去看一看我未曾看过的世界。</p>
<h2 data-id="heading-6">2026，新的期盼</h2>
<p>新的一年新的开始，从 1 月开始就遇到了好多事情，但对好多事情都提不起太高的兴趣，也许是还没有整理好自己，于是就有了这篇年终总结，我想先整理好自己，再去做好新一年的规划。</p>
<p>2026 年，我 30 岁了，外表看起来还是有点没长大的样子，说不上成熟，也谈不上成功。所幸的是，没有发福，没有秃顶，没有堕落躺平，仍然对<strong>爱情、生活、工作、学历</strong>有所憧憬，所以不断学习和努力着。</p>
<p>很幸运，遇到了合适的<strong>她</strong>，希望在这一年中能够开心相处并走向婚姻，我仍然对于婚姻充满着期待。</p>
<p>过往我所拥有的技能和知识，<strong>iOS、鸿蒙、AI Coding</strong>，我希望能够将三者结合起来，不再在 3 个领域分别钻研，而是找到一个合适的入口，比如小红书、B 站、图书出版等，来做知识储备和内容输出，希望在不断发展的 AI 时代中找到属于自己定位。</p>
<p>工作可能也不着急先，过往着急工作了 8 年，下一个职场或者说下一个赛道，在这个阶段真的要好好想想。什么行业、什么领域、什么岗位、做什么事情、达成什么目标、想要达成什么成就，这些都需要静下来好好想想。没准这是我职场的最后一份工作，<strong>选择大于努力</strong>的道理还是深刻了解的。</p>
<p>学历这块一直是我的短板，去年总算通过了所有的理论课，今年就差 1 门实践课、毕业论文、学位英语。自考本科考完后就要准备<strong>考研</strong>了，对于一件事情祛魅的最好方法，就是拥有它。</p>
<p>感觉要求好像有点多，慢慢来呗～</p>
<h2 data-id="heading-7">尾言</h2>
<p>5 年前，我应该想不到现在的我会经历那么多，拥有那么多，所以 5 年前的我的期望，我达成了吗？</p>
<p>如果能和 5 年前的我说说话，我可能想说：</p>
<blockquote>
<p>你绝对想不到你现在有多厉害，你真的很棒，你真的超级努力的，这一切都是值得的。</p>
</blockquote>
<p>这个世界的变化真的超出你的想象，你不知道 AI 发展有多快，你不知道这个世界到处都在打仗，就我们老是外卖大战。你不知道你遇到了很多很好的人，你不再是一个人去面对这一切，你开始变得更好了。</p>
<p>5 年前的我啊，你放心哈，现在的我过得很好，虽然有很多意想不到的事情，但一切都还顺利，而且你还在不断进步和向前，还是笨笨地探索，虽然走得有点慢，但走得很踏实和开心，这一点很了不起哒！</p>
<p>放心吧，往后的路，就交给我，我会连带着你的希冀一起前行，去追寻属于自己的幸福。</p>
<p><strong>愿一切安好，愿归来仍是少年，共勉之～</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm 2026安全新规下的免登录发包策略]]></title>    <link>https://juejin.cn/post/7594678044263497728</link>    <guid>https://juejin.cn/post/7594678044263497728</guid>    <pubDate>2026-01-13T10:13:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594678044263497728" data-draft-id="7594678044263464960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm 2026安全新规下的免登录发包策略"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T10:13:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风度前端"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359562190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm 2026安全新规下的免登录发包策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359562190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风度前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:13:19.000Z" title="Tue Jan 13 2026 10:13:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这些天开源了一个自己平常使用的<code>uni-app</code>路由框架（详见<a href="https://juejin.cn/post/7594262760939749410" target="_blank" title="https://juejin.cn/post/7594262760939749410">用了都说好的 uniapp 路由框架</a>），在发布 npm 包的时候遇到了一些问题，去年写过一篇文章<a href="https://juejin.cn/post/7453304066451669011#heading-3" target="_blank" title="https://juejin.cn/post/7453304066451669011#heading-3">使用npm发布自己的第一个包</a>，当时发布包开启 2fa 验证后通过指纹验证就可以了，但是在发布 caring-route 的包时发现旧有的方式失效了，使用 npm login 时会产生这个提示，然后需要输入用户名、密码，邮箱，2fa 验证码，颇为麻烦：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">npm notice Security Notice: Classic tokens have been revoked. Granular tokens are now limited <span class="hljs-keyword">to</span> <span class="hljs-number">90</span> days <span class="hljs-built_in">and</span> require <span class="hljs-number">2</span>FA <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span>. Update your CI/CD workflows <span class="hljs-keyword">to</span> avoid disruption. Learn more https://gh.io/all-npm-classic-tokens-revoked
</code></pre>
<p>结合在 npm 官网看到的置顶提示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5a10ffb5d2442d8bab9cf6192b7f69f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5bqm5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903999&amp;x-signature=XXdm8VvTiwrg1nZhiQkZoOwWtq8%3D" alt="image.png" loading="lazy"/></p>
<p>这才知道，npm 官方在 2026 年强制更新了安全政策，具体来说就是：</p>
<ul>
<li><strong>旧的「经典令牌 (Classic tokens)」被 npm 官方全部作废回收</strong>：即之前本地保存的、用于指纹 / 免密登录的令牌，现在彻底不能用了；</li>
<li><strong>npm 强制启用「细粒度令牌 (Granular tokens)」</strong>：这是新版的安全令牌，有效期<strong>默认只有 90 天</strong>，到期就要重新生成；</li>
<li><strong>安全门槛提升</strong>：npm 要求<strong>所有发布包的账号，必须开启 两步验证 (2FA)</strong> ，且细粒度令牌默认强制绑定 2FA，没有例外；</li>
<li><strong>登录方式变更</strong>：npm 不再支持「指纹授权 / 一键免密登录」这种简单方式，<strong>即现在的</strong> <code>npm login</code> <strong>必须要使用新版令牌</strong>，否则强制输入账号密码才能登录。</li>
</ul>
<p>那么，问题来了，npm 的<strong>细粒度令牌 (Granular tokens)是什么？</strong> 为什么这个令牌要叫「细粒度」，和之前的「经典令牌」差在哪？下面听我娓娓道来。</p>
<h2 data-id="heading-0"><strong>细粒度令牌 (Granular tokens)</strong></h2>
<p>所谓「细粒度」=【权限可以精细化控制】，这是它的核心特征，是对比 被作废的「经典令牌 (Classic Token)」 来的，两者是完全不同的两种令牌。下面是他们之间的区别：</p>
<h3 data-id="heading-1">旧版：经典令牌 (Classic Token) —— 之前指纹登录用的令牌</h3>
<ul>
<li>权限：<strong>一刀切的「超级管理员权限」</strong> → 拿到这个令牌，能做 npm 账号的「所有操作」：发布包、删包、改账号信息、看所有私密包... 权限无限大；</li>
<li>有效期：<strong>永久有效</strong>，生成一次能用一辈子，npm 不主动作废就一直能用；</li>
<li>安全要求：无任何要求，不用开 2FA，谁都能生成；</li>
<li>为什么被作废：权限太大 + 永久有效，一旦泄露，账号等于彻底被盗，npm 生态被恶意包搞的乌烟瘴气，所以 npm<strong>全网强制回收所有经典令牌</strong>。</li>
</ul>
<h3 data-id="heading-2">新版：细粒度令牌 (Granular Access Token) —— npm 最新推出的</h3>
<ul>
<li>权限：<strong>可以「按需勾选、精细化分配」</strong> → 这就是「细粒度」的核心含义。你想要什么权限，就只勾选什么权限，<strong>多一分权限都不给。</strong></li>
<li>有效期：<strong>强制 90 天</strong>，npm 新规要求，最长只能 90 天，到期自动失效；</li>
<li>安全要求：npm「默认要求」开 2FA，但<strong>不是强制</strong>。</li>
<li>为什么是它：权限小 + 有效期短，就算令牌泄露，风险也极小，90 天后自动作废，安全风险可控。</li>
</ul>
<p>那么在了解了<strong>细粒度令牌后，</strong> 我们应该怎么用其新规来发布包呢？很明显，如果不使用令牌，采用传统的<strong>默认的 npm login 发包流程很反人类</strong>：要输用户名、密码、输邮箱，还要输 2FA 一次性验证码，发布个包要折腾半天，对高频发布的开发者来说简直是折磨。</p>
<p>好在 npm 提供了 <strong>「本地配置永久授权令牌」</strong> 的机制，可以做到永久免登录发布，直接 npm 令牌写入本地的 npm 全局配置文件里，npm 会永久读取这个令牌作为身份凭证，<strong>完全跳过</strong> <code>npm login</code> <strong>整个流程</strong>，不需要登录、不需要输用户名、不需要输邮箱、不需要输验证码，<strong>以后发布包，只需要在项目里敲</strong> <code>npm publish</code> <strong>一个命令，直接发布成功</strong>！</p>
<p>并且这个配置是<strong>永久生效</strong>的，哪怕 90 天后令牌过期了，也只是重新换个令牌再执行一次配置命令就行，比反复登录舒服 100 倍。下面就是操作流程：</p>
<h2 data-id="heading-3">npm 免登录发布</h2>
<h3 data-id="heading-4">步骤 1：生成细粒度令牌 (Granular Access Token)</h3>
<ul>
<li>打开 npm 官网 → 账号 → Access tokens →Generate New Token</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfc1e7925da2485d9dc328a2b0b9f811~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5bqm5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903999&amp;x-signature=NbDzJ%2F7e3Fp6AaLWG7lhXMihZ04%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>依次输入名称，勾选<code>Bypass two-factor authentication (2FA)</code>（不勾选的话每次发包还需要再输入 2fa 验证码），选择包范围和过期时间（最多 90 天）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac0cc5da93834c29aca267708ee17c02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5bqm5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768903999&amp;x-signature=nTebA2gbHH4TH4F9qASi2kwXPJw%3D" alt="image.png" loading="lazy"/>
生成后的细粒度令牌复制下来，然后进入终端</p>
<h3 data-id="heading-5">步骤 2：Mac 终端执行【一行核心命令】，永久配置令牌</h3>
<p>直接复制下面的命令到终端，把 <code>你的细粒度令牌</code> 替换成你复制的令牌字符串，<strong>直接回车执行</strong>，没有任何反馈就是配置成功</p>
<pre><code class="hljs language-arduino" lang="arduino">npm config set <span class="hljs-comment">//registry.npmjs.org/:_authToken=你的细粒度令牌</span>
</code></pre>
<h3 data-id="heading-6">步骤 3：检查配置是否生效</h3>
<p>方式一：终端执行下面的命令，能看到你的令牌就说明配置成功了</p>
<pre><code class="hljs language-arduino" lang="arduino">npm config get <span class="hljs-comment">//registry.npmjs.org/:_authToken</span>

npm ERR! ---sekretz---

npm ERR! A complete log of <span class="hljs-keyword">this</span> run can be found in:
npm ERR!     /Users/wanko/.npm/_logs/<span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>T07_44_13_678Z-debug.log
</code></pre>
<p>方式二：直接执行 <code>npm whoami</code> 命令</p>
<pre><code class="hljs language-bash" lang="bash">npm <span class="hljs-built_in">whoami</span>
</code></pre>
<h4 data-id="heading-7">成功的结果：</h4>
<p>终端会直接输出你的 <strong>npm 官网账号名</strong>说明：npm 已经通过你配置的令牌，成功识别了你的身份，令牌配置<strong>完全生效</strong>！</p>
<h3 data-id="heading-8">从此以后的发布流程</h3>
<p>不管是 90 天内，还是换了项目，只要还是这台电脑，发布 npm 包<strong>全程只有 2 步</strong>，无任何输入：</p>
<ol>
<li>终端进入你的 npm 包项目目录</li>
<li>执行发布命令即可：bash运行</li>
</ol>

<pre><code class="hljs">npm publish
</code></pre>
<p>效果：回车后直接打包、上传、发布成功，<strong>没有任何弹窗、没有任何输入项</strong>，秒发，爽到飞起</p>
<h2 data-id="heading-9">补充说明</h2>
<h3 data-id="heading-10">90 天后令牌过期了怎么办？</h3>
<p>令牌有效期 90 天，过期后执行 <code>npm whoami</code> 会提示身份失效，<strong>解决方法超级简单：</strong></p>
<ol>
<li>去 npm 官网 → 账号 → Access tokens → 生成一个新的「Automation」令牌，复制；</li>
<li>Mac 终端执行之前的配置命令，用新令牌替换旧令牌：</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">npm config set <span class="hljs-comment">//registry.npmjs.org/:_authToken=你的新令牌</span>
</code></pre>
<p>3.  执行 <code>npm whoami</code> 验证，搞定！</p>
<p>不用删旧令牌、不用 logout、不用改配置文件，直接覆盖就行，npm 会自动用新令牌生效。</p>
<h3 data-id="heading-11">关于细粒度令牌在本地的保存</h3>
<ol>
<li>令牌只保存在电脑<strong>的本地配置文件</strong> <code>~/.npmrc</code> 里，不会上传到任何服务器，不会被 npm / 任何人获取；</li>
<li>令牌是「自动化令牌」，权限仅用于「登录 + 发布包」，没有账号修改、删除等高危权限，就算泄露（概率极低），别人最多只能用你的账号发布包，改不了你的账号信息；</li>
<li>npm 的 <code>---sekretz---</code> 机制，就是为了防止你在公共场合执行命令时，令牌被别人看到，是双重保护。</li>
</ol>
<h2 data-id="heading-12">总结</h2>
<p>虽然 npm 更新了安全策略，但总得来说新的令牌可以让发布更友好，比之前指纹授权的体验还要好，毕竟指纹授权登录还得跳转网页再回到终端，需要等待网页的加载，还有切换操作，而现在通过细粒度令牌，可以直接免登录，且一行命令就能实现发包，以后发布包再也不用折腾那些繁琐的步骤了，真的是 too easy too happy。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[漫画说：为什么你的“增量计算”越跑越慢？——90%的实时数仓团队都踩过的坑，藏在这几格漫画里]]></title>    <link>https://juejin.cn/post/7594661351513047075</link>    <guid>https://juejin.cn/post/7594661351513047075</guid>    <pubDate>2026-01-13T10:31:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594661351513047075" data-draft-id="7594662258354421795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="漫画说：为什么你的“增量计算”越跑越慢？——90%的实时数仓团队都踩过的坑，藏在这几格漫画里"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-01-13T10:31:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            漫画说：为什么你的“增量计算”越跑越慢？——90%的实时数仓团队都踩过的坑，藏在这几格漫画里
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:31:31.000Z" title="Tue Jan 13 2026 10:31:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://static001.geekbang.org/infoq/7a/7abadb065bbaf802a3ae7cc6b4db1bbd.jpeg" alt="" loading="lazy"/></p>
<p>为什么每次只改一行数据，却要重算上亿条历史记录？</p>
<p>你在构建实时看板、用户画像或风控特征时，是否也遇到过这样的困境？</p>
<p>每天新增的订单可能只有几万条，但背后的用户、商品、支付表动辄上亿行。为了刷新一个聚合指标，系统不得不全量扫描、重新 Join、再聚合——哪怕 99% 的数据根本没有变化。</p>
<p><img src="https://static001.geekbang.org/infoq/29/2968eec0b74ab5fa086dd52c811dd977.png" alt="" loading="lazy"/></p>
<p>这不仅拖慢了刷新频率，还让计算成本居高不下。</p>
<p>更糟的是，为了“扛住”全量任务，团队往往被迫拆出多层中间表，链路越拉越长，维护越来越难。</p>
<p><img src="https://static001.geekbang.org/infoq/30/30dcaf1c42d96c36f4148ee2449eee91.jpeg" alt="" loading="lazy"/></p>
<p>增量刷新本应是解药，但并非所有方案都是真正“增量”。</p>
<p>一些系统采用无状态模型：每次只读变更数据，却不保存任何中间结果。听起来轻量，实则代价高昂——复杂查询下，它仍需反复回溯历史数据，甚至比全量更慢。</p>
<p><img src="https://static001.geekbang.org/infoq/ab/ab56b486d20c6380b2d5b0b0984b913d.jpeg" alt="" loading="lazy"/></p>
<p>阿里云 Hologres 选择了另一条路径：有状态增量计算。</p>
<p>在首次全量构建时，它同步生成并持久化关键中间状态——比如聚合值、Join 中间产物。</p>
<p>后续刷新，只需将新数据与状态合并，无需触碰原始历史表。</p>
<p>这意味着：</p>
<ul>
<li>
<p>刷新延迟从分钟级降至秒级；</p>
</li>
<li>
<p>计算资源消耗大幅下降；</p>
</li>
<li>
<p>即使面对五表 Join 或 COUNT DISTINCT，也能保持高效。</p>
</li>
</ul>
<p><img src="https://static001.geekbang.org/infoq/5d/5d2c9f6257591dd7937e9659d3b19bb2.png" alt="" loading="lazy"/></p>
<p>状态确实需要额外存储，但这部分开销是可控的。</p>
<p>在分区表场景中，仅活跃分区保留状态；非活跃分区自动转为全量，避免状态膨胀。</p>
<p>对于非分区表，也可通过 TTL 策略清理过期状态。</p>
<p><img src="https://static001.geekbang.org/infoq/b4/b46e0fc997f9bafc4eb2f60cf2d2665e.jpeg" alt="" loading="lazy"/></p>
<p>真正的效率，不在于少算一点，而在于只算该算的。</p>
<p>如果你正在设计实时数仓、特征管道或统一指标体系，不妨评估：你的“增量”是否真的避开了历史数据的重复计算？</p>
<p>Hologres Dynamic Table 提供了一种经过验证的答案——用有限的存储换确定性的性能，让实时更新回归本质。</p>
<p><img src="https://static001.geekbang.org/infoq/f8/f81dcf4fb57e5dc62c1254f3383a0c12.jpeg" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app实现leaflet地图图标旋转]]></title>    <link>https://juejin.cn/post/7594662258354487331</link>    <guid>https://juejin.cn/post/7594662258354487331</guid>    <pubDate>2026-01-13T10:41:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662258354487331" data-draft-id="7594096585727737856" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app实现leaflet地图图标旋转"/> <meta itemprop="keywords" content="前端,Trae"/> <meta itemprop="datePublished" content="2026-01-13T10:41:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app实现leaflet地图图标旋转
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:41:46.000Z" title="Tue Jan 13 2026 10:41:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前在 uni-app 上已经实现了 leaflet 的离线地图，详细可以参考上文 <a href="https://juejin.cn/post/7592531796044185615" target="_blank" title="https://juejin.cn/post/7592531796044185615"># uni-app使用瓦片实现离线地图的两种方案</a>。</p>
<p>最近新增了一个定位的功能，其实就是常见的地图上的手机朝向哪儿，箭头就往哪儿指这个功能。</p>
<p>但是因为地图是基于 leaflet 做的，在 Trae 上进行了一番询问，Trae推荐采用简单实现方案，就是在 leaflet 上增加一个图标，然后通过图标旋转变换箭头朝向。</p>
<p>虽然我对 leaflet 不是非常熟悉，但是 Trae 作为程序员的"<strong>外挂</strong>"解答这个是没问题的，给出了两个实现方案。</p>
<h2 data-id="heading-0">方案1: 使用CSS调整</h2>
<p>在创建图标的时候给图标增加一个 <strong>className</strong>，然后通过修改这个 class 的 <strong>transform: rotate(45deg)</strong> 进行旋转。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createLocationIcon</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> icon = L.<span class="hljs-title function_">icon</span>({
        <span class="hljs-attr">iconUrl</span>: <span class="hljs-string">'static/icon/location.png'</span>,
        <span class="hljs-attr">iconSize</span>: [<span class="hljs-number">60</span>, <span class="hljs-number">60</span>],
        <span class="hljs-attr">iconAnchor</span>: [<span class="hljs-number">30</span>, <span class="hljs-number">30</span>],
        <span class="hljs-attr">popupAnchor</span>: [<span class="hljs-number">1</span>, -<span class="hljs-number">20</span>],
        <span class="hljs-attr">className</span>: <span class="hljs-string">'test-location'</span>
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span> = L.<span class="hljs-title function_">marker</span>([lat, lon], {
        <span class="hljs-attr">icon</span>: icon
    }).<span class="hljs-title function_">addTo</span>(map);
},
<span class="hljs-title function_">updateLocation</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 计算角度</span>
    <span class="hljs-keyword">const</span> bearing = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateBearing</span>(
        that.<span class="hljs-property">location</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">location</span>.<span class="hljs-property">longitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">longitude</span>
    );
    <span class="hljs-keyword">const</span> icon = <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span>.<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">"test-location"</span>);
    icon.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> += <span class="hljs-string">`rotate(<span class="hljs-subst">${bearing}</span>deg)`</span>;
}
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.test-location</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">20deg</span>);
}
</code></pre>
<p>这种方案其实是比较简单的，通过确定旋转角度直接<strong>操作DOM</strong>的形式进行旋转，并且还可以增加一定的动画延迟效果。</p>
<h2 data-id="heading-1">方案2: 使用leaflet.rotatedMarker.js</h2>
<p>使用 <strong>leaflet.rotatedMarker.js</strong> 也是比较方便的一种方法。</p>
<p>首先在 <code>static/leaflet</code> 文件夹下插入 <code>leaflet.rotatedMarker.js</code> 文件。</p>
<p>然后在代码中导入 <code>import rotated from "@/static/leaflet/leaflet.rotatedMarker.js";</code></p>
<p>最后在创建图标的位置增加 <code>rotationAngle</code> 属性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createLocationIcon</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> icon = L.<span class="hljs-title function_">icon</span>({
        <span class="hljs-attr">iconUrl</span>: <span class="hljs-string">'static/icon/location.png'</span>,
        <span class="hljs-attr">iconSize</span>: [<span class="hljs-number">60</span>, <span class="hljs-number">60</span>],
        <span class="hljs-attr">iconAnchor</span>: [<span class="hljs-number">30</span>, <span class="hljs-number">30</span>],
        <span class="hljs-attr">popupAnchor</span>: [<span class="hljs-number">1</span>, -<span class="hljs-number">20</span>],
        <span class="hljs-attr">rotationAngle</span>: <span class="hljs-number">0</span>
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span> = L.<span class="hljs-title function_">marker</span>([lat, lon], {
        <span class="hljs-attr">icon</span>: icon
    }).<span class="hljs-title function_">addTo</span>(map);
},
<span class="hljs-title function_">updateLocation</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 计算角度</span>
    <span class="hljs-keyword">const</span> bearing = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateBearing</span>(
        that.<span class="hljs-property">location</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">location</span>.<span class="hljs-property">longitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">latitude</span>,
        that.<span class="hljs-property">testPosition</span>.<span class="hljs-property">longitude</span>
    );
    <span class="hljs-comment">// 设置旋转角度</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationIcon</span>.<span class="hljs-title function_">setRotationAngle</span>(bearing);
}
</code></pre>
<p>上述两种方法均可以实现图标的旋转，不过我更推荐第二种实现方案。</p>
<p>简单方便，而且不需要操作DOM，减少性能开销。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝傻瓜式截断 Diff：聊聊我在 AI Commit 插件里做的 7 个技术微创新]]></title>    <link>https://juejin.cn/post/7594657393830232102</link>    <guid>https://juejin.cn/post/7594657393830232102</guid>    <pubDate>2026-01-13T10:52:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594657393830232102" data-draft-id="7594669638559416346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝傻瓜式截断 Diff：聊聊我在 AI Commit 插件里做的 7 个技术微创新"/> <meta itemprop="keywords" content="AI编程,VibeCoding,Trae"/> <meta itemprop="datePublished" content="2026-01-13T10:52:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝傻瓜式截断 Diff：聊聊我在 AI Commit 插件里做的 7 个技术微创新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T10:52:10.000Z" title="Tue Jan 13 2026 10:52:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">昨晚熬夜写了个 VS Code 插件，彻底解放写 Commit Message 的双手</h2>
<p>昨晚写代码写到凌晨，准备提交的时候，看着空荡荡的 commit message 输入框，突然不想动脑子了。</p>
<p>"这是 feat 还是 fix？scope 填 auth 还是 user？message 怎么概括才得体？" —— 每次都要在大脑里过一遍这些 Conventional Commits 的规则，真的很累。</p>
<p>于是，从昨晚 11 点开始，到今天上午发布上线，花了不到 4 个小时，我vibe coding了一个极其顺手的 Commit Message 生成器。</p>
<p>写完复盘了一下，发现虽然功能简单，但为了"极致的体验"，里面用了不少有意思的技术细节。</p>
<h3 data-id="heading-1">为什么还要造轮子</h3>
<p>其实 VS Code 原生就支持 Copilot 生成 commit message，但我之前的 Copilot 服务因为账号问题用不了了（懂的都懂）。</p>
<p>没了 Copilot，我去市场搜了一圈替代品，发现最大的痛点是：<strong>不够智能，也不够灵活。</strong></p>
<p>这就导致了两个问题：</p>
<ol>
<li><strong>没法适应团队规范</strong>：很多插件生成的格式是死的，但我们团队要求特定的 type 或 scope 格式，甚至要求用中文/日文写 commit。</li>
<li><strong>配置极其繁琐</strong>：想用自己的 API Key，得填一堆 Provider ID、Endpoint，非常折腾。</li>
</ol>
<p>我想要的是：</p>
<ol>
<li><strong>完全的 Prompt 自定义权限</strong>：不仅仅是改个前缀，而是能完全控制 AI 的系统提示词（System Prompt）。我想让它用中文写、用emoji、或者严格遵循 Angular 规范，都能通过改 Prompt 实现。</li>
<li><strong>不想填一堆配置</strong>：给我一个 API Key，一个 Base URL，一个 Model 名字，这就够了。管你是 OpenAI、Claude 还是 Ollama 本地模型，只要兼容 OpenAI 格式，通通能用。</li>
<li><strong>懂我的代码</strong>：不要傻傻地把几千行 diff 扔给 AI，它会晕；也不要粗暴地截断，它会瞎。</li>
<li><strong>要有爽感</strong>：点一下，文字必须像打字机一样一个个蹦出来（流式输出），而不是转圈转半天然后 <code>啪</code> 一下甩我脸上。</li>
</ol>
<p>基于这些需求，我 vibe coding 出了这个插件。</p>
<h3 data-id="heading-2">核心设计</h3>
<h4 data-id="heading-3">1. 统一的 API 抽象</h4>
<p>最初我设计了四个 Provider：OpenAI、Claude、Gemini、Custom。后来发现这是过度设计——现在大部分 LLM 服务都兼容 OpenAI 格式，没必要分开。</p>
<p>最终只留了三个配置项：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProviderConfig</span> {
    <span class="hljs-attr">apiKey</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">baseUrl</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// https://api.openai.com/v1 或 http://localhost:11434/v1</span>
}
</code></pre>
<p>用 OpenAI？填 <code>api.openai.com/v1</code>。用 Claude 代理？换个 baseUrl。用本地 Ollama？<code>localhost:11434/v1</code>。一套代码全搞定。</p>
<h4 data-id="heading-4">2. 流式输出</h4>
<p>等 AI 生成完再显示结果，体验很差。用户会以为插件卡死了。</p>
<p>解决方案是 SSE（Server-Sent Events）流式输出：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 请求时开启流式</span>
<span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">model</span>,
    <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: prompt }],
    <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 关键</span>
})
</code></pre>
<p>然后解析 SSE 格式的响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readOpenAICompatibleStream</span>(<span class="hljs-params">
    body: ReadableStream&lt;<span class="hljs-built_in">Uint8Array</span>&gt;,
    onToken: (text: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">const</span> reader = body.<span class="hljs-title function_">getReader</span>();
    <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
    <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
        <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

        buffer += decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
        
        <span class="hljs-comment">// SSE 事件以双换行分隔</span>
        <span class="hljs-keyword">let</span> sepIndex;
        <span class="hljs-keyword">while</span> ((sepIndex = buffer.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'\n\n'</span>)) !== -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">const</span> event = buffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, sepIndex);
            buffer = buffer.<span class="hljs-title function_">slice</span>(sepIndex + <span class="hljs-number">2</span>);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> event.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)) {
                <span class="hljs-keyword">if</span> (!line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data:'</span>)) <span class="hljs-keyword">continue</span>;
                <span class="hljs-keyword">const</span> payload = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">trim</span>();
                <span class="hljs-keyword">if</span> (payload === <span class="hljs-string">'[DONE]'</span>) <span class="hljs-keyword">return</span> result;

                <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(payload);
                <span class="hljs-keyword">const</span> delta = json?.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>?.<span class="hljs-property">content</span> ?? <span class="hljs-string">''</span>;
                <span class="hljs-keyword">if</span> (delta) {
                    result += delta;
                    <span class="hljs-title function_">onToken</span>(delta);  <span class="hljs-comment">// 每个 token 实时回调</span>
                }
            }
        }
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>每收到一个 token，就往 VS Code 的 commit 输入框里追加，用户能看到文字一个一个蹦出来。</p>
<h4 data-id="heading-5">3. 智能 type/scope 推断</h4>
<p>Conventional Commits 格式是 <code>type(scope): description</code>。让 AI 自己猜 type 有时候不太准，比如改了测试文件，AI 可能还是写 <code>feat</code>。</p>
<p>我加了一层启发式推断：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inferType</span>(<span class="hljs-params">files: <span class="hljs-built_in">string</span>[]</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isDocsFile</span> = (<span class="hljs-params">f</span>) =&gt; f.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.md'</span>) || f.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'docs/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isTestFile</span> = (<span class="hljs-params">f</span>) =&gt; f.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'test'</span>) || <span class="hljs-regexp">/\.(test|spec)\.[jt]sx?$/</span>.<span class="hljs-title function_">test</span>(f);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isCIFile</span> = (<span class="hljs-params">f</span>) =&gt; f.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.github/workflows/'</span>);
    
    <span class="hljs-keyword">if</span> (files.<span class="hljs-title function_">every</span>(isDocsFile)) <span class="hljs-keyword">return</span> <span class="hljs-string">'docs'</span>;
    <span class="hljs-keyword">if</span> (files.<span class="hljs-title function_">every</span>(isTestFile)) <span class="hljs-keyword">return</span> <span class="hljs-string">'test'</span>;
    <span class="hljs-keyword">if</span> (files.<span class="hljs-title function_">some</span>(isCIFile)) <span class="hljs-keyword">return</span> <span class="hljs-string">'ci'</span>;
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'feat'</span>;
}
</code></pre>
<p>把推断结果作为"建议"传给 AI，而不是强制限制。这样 AI 既有参考，又保留了灵活性：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## Suggestions (optional)</span>
<span class="hljs-bullet">-</span> Suggested type: docs
<span class="hljs-bullet">-</span> Suggested scope: readme
</code></pre>
<h4 data-id="heading-6">4. 智能 Diff 裁剪</h4>
<p>大型重构可能有几千行 diff，直接喂给 AI 会超 token 限制。简单粗暴地截断前 N 个字符，可能会把函数签名截断一半，AI 看不懂。</p>
<p>我的做法是<strong>语义裁剪</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">summarizeDiffBlock</span>(<span class="hljs-params">block: <span class="hljs-built_in">string</span>, budget: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">const</span> lines = block.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">const</span> header = [];    <span class="hljs-comment">// 保留 diff 头部</span>
    <span class="hljs-keyword">const</span> important = []; <span class="hljs-comment">// 保留关键行</span>

    <span class="hljs-comment">// 用正则识别关键行</span>
    <span class="hljs-keyword">const</span> signatureLike = <span class="hljs-regexp">/^[+-]?\s*(export\s+)?(function|class|interface)/</span>;
    <span class="hljs-keyword">const</span> commentLike = <span class="hljs-regexp">/^[+-]?\s*(\/\/|#|\/\*)/</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
        <span class="hljs-keyword">if</span> (signatureLike.<span class="hljs-title function_">test</span>(line) || commentLike.<span class="hljs-title function_">test</span>(line)) {
            important.<span class="hljs-title function_">push</span>(line);
        }
    }
    
    <span class="hljs-keyword">return</span> [...header, ...important].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
}
</code></pre>
<p>优先保留：</p>
<ul>
<li>函数/类签名</li>
<li>注释</li>
<li>import 语句</li>
<li>hunk 的前 6 行变更</li>
</ul>
<p>这样即使原始 diff 有 5000 行，裁剪到 500 行后，AI 仍然能理解代码的意图。</p>
<h4 data-id="heading-7">5. 单行/多行模式</h4>
<p>有人喜欢简洁的单行 commit，有人喜欢带 body 的详细版本。</p>
<p>我加了 <code>outputStyle</code> 配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OutputStyle</span> = <span class="hljs-string">'headerOnly'</span> | <span class="hljs-string">'headerAndBody'</span>;
</code></pre>
<p>不同模式下，prompt 模板会动态变化：</p>
<pre><code class="hljs language-handlebars" lang="handlebars">{{#if header_only}}
- Output ONLY ONE line (header only): no body, no footer
- Keep it concise (max 72 characters)
{{/if}}

{{#if allow_body}}
- Output a header line and optionally a short body
{{/if}}
</code></pre>
<p><code>headerOnly</code> 模式还有个优化：检测到第一个换行符就<strong>立即中断流式输出</strong>，不浪费后面的 token：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (headerOnly) {
    <span class="hljs-keyword">const</span> newlineIndex = text.<span class="hljs-title function_">search</span>(<span class="hljs-regexp">/\r?\n/</span>);
    <span class="hljs-keyword">if</span> (newlineIndex !== -<span class="hljs-number">1</span>) {
        abortController.<span class="hljs-title function_">abort</span>();  <span class="hljs-comment">// 立即停止</span>
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<h4 data-id="heading-8">6. 后处理清洗</h4>
<p>AI 有时候会输出一些垃圾：</p>
<ul>
<li><code>Commit message: feat: ...</code>（带前缀）</li>
<li><code>```feat: ...```</code>（带 markdown 代码块）</li>
<li><code>"feat: ..."</code>（带引号）</li>
</ul>
<p>我加了一层后处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeCommitMessage</span>(<span class="hljs-params">raw: <span class="hljs-built_in">string</span>, options: { headerOnly: <span class="hljs-built_in">boolean</span> }</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">let</span> text = raw;
    
    <span class="hljs-comment">// 去掉 markdown 代码块</span>
    text = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/```[\s\S]*?```/g</span>, <span class="hljs-function">(<span class="hljs-params">block</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> lines = block.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
        <span class="hljs-keyword">return</span> lines.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);  <span class="hljs-comment">// 只保留内容</span>
    });
    
    <span class="hljs-comment">// 去掉常见前缀</span>
    text = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\s*(commit message|message)\s*:\s*/i</span>, <span class="hljs-string">''</span>);
    
    <span class="hljs-comment">// 去掉首尾引号</span>
    text = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^["'`]+|["'`]+$/g</span>, <span class="hljs-string">''</span>);
    
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">headerOnly</span>) {
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">l</span> =&gt;</span> l.<span class="hljs-title function_">trim</span>()) ?? <span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">return</span> text;
}
</code></pre>
<h4 data-id="heading-9">7. 暂存区智能感知</h4>
<p>很多时候写完代码忘了 <code>git add</code> 就直接点生成，大部分插件会报错 "No staged changes"。</p>
<p>我觉得工具应该更聪明一点：</p>
<ol>
<li><strong>只有暂存区代码</strong>：直接生成（标准流程）。</li>
<li><strong>只有工作区代码（未暂存）</strong>：直接生成（省去 <code>git add</code> 步骤）。</li>
<li><strong>都有</strong>：弹窗让用户选。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> hasStaged = <span class="hljs-keyword">await</span> git.<span class="hljs-title function_">hasStagedChanges</span>();
<span class="hljs-keyword">const</span> hasUnstaged = <span class="hljs-keyword">await</span> git.<span class="hljs-title function_">hasUnstagedChanges</span>();

<span class="hljs-keyword">if</span> (!hasStaged &amp;&amp; !hasUnstaged) {
    <span class="hljs-keyword">return</span> vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showWarningMessage</span>(<span class="hljs-string">'No changes found'</span>);
}

<span class="hljs-keyword">if</span> (hasStaged &amp;&amp; hasUnstaged) {
    <span class="hljs-comment">// 弹窗让用户选</span>
    <span class="hljs-keyword">const</span> picked = <span class="hljs-keyword">await</span> vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showWarningMessage</span>(
        <span class="hljs-string">'Detected both staged and unstaged changes'</span>,
        <span class="hljs-string">'Use Staged'</span>,
        <span class="hljs-string">'Use Unstaged'</span>
    );
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>这样在这个微小的交互上，又能少点一次鼠标。</p>
<h3 data-id="heading-10">打包发布</h3>
<p>VS Code 插件用 <code>vsce</code> 打包：</p>
<pre><code class="hljs language-bash" lang="bash">npx vsce package
</code></pre>
<p>为了减小包体积，我用了 esbuild 打包，把所有 TypeScript 代码编译成一个 <code>extension.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// esbuild.mjs</span>
<span class="hljs-keyword">await</span> esbuild.<span class="hljs-title function_">build</span>({
    <span class="hljs-attr">entryPoints</span>: [<span class="hljs-string">'src/extension.ts'</span>],
    <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">outfile</span>: <span class="hljs-string">'dist/extension.js'</span>,
    <span class="hljs-attr">platform</span>: <span class="hljs-string">'node'</span>,
    <span class="hljs-attr">external</span>: [<span class="hljs-string">'vscode'</span>],
    <span class="hljs-attr">minify</span>: production
});
</code></pre>
<p>最终 <code>.vsix</code> 包只有 <strong>435 KB</strong>，8 个文件。</p>
<h3 data-id="heading-11">总结</h3>
<p>这个插件的核心思路就是：<strong>在对的地方做对的事</strong>。</p>
<ul>
<li>API 层：统一抽象，不过度设计</li>
<li>交互层：流式输出，即时反馈</li>
<li>推理层：启发式辅助，而非强制替代</li>
<li>数据层：语义裁剪，而非暴力截断</li>
<li>输出层：后处理清洗，容错 AI 的奇怪输出</li>
</ul>
<p>代码不多，但每个模块都解决了一个实际问题。</p>
<hr/>
<p>项目已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fvscode-ai-commit" target="_blank" title="https://github.com/tt-a1i/vscode-ai-commit" ref="nofollow noopener noreferrer">vscode-ai-commit</a></p>
<p>VS Code Marketplace 搜索 <strong>"AI Commit"</strong> 可以直接安装。</p>
<h3 data-id="heading-12"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afc800a0c615488280c6980d8e541bb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768906655&amp;x-signature=JQzN6RLYl2%2F7ipSGHGPK%2BS1UPFk%3D" alt="image.png" loading="lazy"/></h3>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>qwen/gemini/claude - cli 原理学习网站</strong>：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e50020ab1f45428cd22e53af91a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768906655&amp;x-signature=FXRgUGD1GjjQwB3dqHZvtMLOBsA%3D" alt="coding-cli-guide" loading="lazy"/>
<strong>全栈项目</strong>（适合学习现代技术栈）：</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[0代码手写！体验百度Comate的“魔法”：我造了个会理解情绪的中介层]]></title>    <link>https://juejin.cn/post/7594662258354061347</link>    <guid>https://juejin.cn/post/7594662258354061347</guid>    <pubDate>2026-01-13T09:04:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594662258354061347" data-draft-id="7594396368174350371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="0代码手写！体验百度Comate的“魔法”：我造了个会理解情绪的中介层"/> <meta itemprop="keywords" content="前端,程序员,前端框架"/> <meta itemprop="datePublished" content="2026-01-13T09:04:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            0代码手写！体验百度Comate的“魔法”：我造了个会理解情绪的中介层
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:04:36.000Z" title="Tue Jan 13 2026 09:04:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者简介</p>
<p>陈良洪，系统架构师兼AI应用高级工程师，同时具备区块链技术背景。在AI编程实践中，深入应用代码智能补全、行间对话调试、Zulu（Agent）、Rules与Spec等范式，将AI深度集成于系统设计、开发、验证与优化的全流程，持续推动开发效率与代码质量的系统化提升。作品「Eme0情绪引擎」入围“CCF程序员大会码力全开：AI加速营”活动决赛，并获得“最佳创意奖” 。</p>
</blockquote>
<p>「Eme0情绪引擎」——一个完全由百度Comate IDE生成的AI情绪引擎，从想法到上线，我没有手写任何一行代码。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e89ff8780ef943d6b00fa047ba67ff10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=aJYTwN8Xms3SQBiwvUjoDAu6SIs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">1 一个被忽视的痛点：AI为什么总是「冷冰冰」？</h2>
<p>我的创意来源：在深入研究AI对话系统时，我发现了一个有趣的现象：</p>
<p>大多数AI系统都有「记忆」，但很少有AI真正理解「情绪」。</p>
<p>想象一下，你和朋友聊天时：</p>
<p>朋友会记得你昨天心情不好，朋友会理解你今天的开心是因为昨天的困扰解决了，朋友会根据你的情绪状态调整说话的语气。</p>
<p>但现在的AI呢？它们能记住对话历史（记忆引擎），但它们无法理解情绪的变化规律，每次开发都要重新写情绪识别代码，而且很简陋。这就是我发现的痛点：情绪处理总是被当作临时功能，而不是一个专业的系统。</p>
<p><strong>灵感来源：</strong> 为什么不能有一个「情绪引擎」？就像记忆引擎一样，我想到：能不能把情绪处理也做成一个独立的、专业的引擎？这个引擎应该：可以被任何AI系统调用（就像插件一样），能够存储短期和长期的情绪记忆，理解情绪会随时间衰减（就像人类会慢慢忘记不愉快），能够生成个性化的情绪画像。于是，Eme0情绪引擎的想法诞生了。</p>
<h2 data-id="heading-1">2 技术蓝图：如何让AI拥有「情感大脑」？</h2>
<p>系统架构图⬇️⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75655df939345589d8a73d9d6cd019b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=a6UgPA7dUW73mdBxyF3OefWPyjI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>数据流转逻辑图⬇️⬇️</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c82a4dc55be44388b78a9f0e016227b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=tOdWr3rHnKev4M0ekRlHInl9CGk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-2">3 实现过程：0手写代码的「神奇之旅」</h2>
<p>重要声明：整个项目，我没有手写任何一行代码。全部由百度Comate IDE自动生成。</p>
<h3 data-id="heading-3">3.1 编写开发文档</h3>
<p>我的操作：向Gemini描述项目需求</p>
<p>Gemini做了什么：自动生成完整的技术文档，规划模块结构。</p>
<p><strong>Prompt：</strong></p>
<p>参照Agent中间件记忆引擎，设计一个情绪引擎。情绪引擎也是Agent中间件，提供对话中情绪的上下文支持。按照标准的MCP Server实现，提供Tools，支持Agent配置MCP即插即用。情绪引擎名字叫Eme0。请编写AI能理解的开发文档，我将使用这份文档给AI开发实现。注意，给出开发文档即可，不需要实现。注意：从0设计情绪引擎，支持长短期记忆，设计情绪推理模型。如果需要使用LLM，对接百度千帆的最新模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de23ae1b64254754bfa43b97306c92d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=z8CEgAwZDwmKKQihdfJ6pRmFCFI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>Gemini编写开发文档</p>
<p>后来经过实践发现，Comate也有Spec能力-即辅助澄清需求并生成专业的技术规格文档，因为这是我第一次使用Comate，所以在最初规划时，使用了自己最熟悉的Gemini。</p>
<h3 data-id="heading-4">3.2 初版实现</h3>
<p>我的操作：告诉Comate「按照文档实现代码」</p>
<p>Comate做了什么：自动生成所有核心模块代码，实现MCP Server标准接口，完成情绪识别、记忆管理等核心功能。</p>
<p><strong>Prompt：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">基于下面的开发文档，使用Python语言，编写实现Eme0记忆引擎。需要反复调试，直到运行无问题，能正常使用为止。

这是一份为AI开发者设计的、基于Agent中间件记忆引擎（MCP Server标准）的<span class="hljs-strong">**情绪引擎 (Eme0)**</span> 开发文档。

-----

<span class="hljs-section"># 🤖 Eme0 情绪引擎 (Emotion Engine) 开发文档</span>

<span class="hljs-section">## 🚀 概述 (Overview)</span>

Eme0是一个Agent中间件，旨在为对话系统提供<span class="hljs-strong">**情绪上下文支持**</span>。它遵循标准的MCP Server架构实现，通过提供Tools接口，允许任何Agent实例进行即插即用配置，实现对话中的情绪感知、记忆和推理。

Eme0的核心目标是：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**情绪感知 (Perception):**</span> 从对话文本中实时提取当前情绪。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**情绪记忆 (Memory):**</span> 管理对话历史中的长期和短期情绪状态。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**情绪推理 (Inference):**</span> 基于历史和当前情绪，推断用户或Agent的深层情绪状态和潜在意图。
<span class="hljs-bullet">4.</span>  <span class="hljs-strong">**上下文支持 (Context):**</span> 将推理后的情绪信息作为上下文，喂给Agent的LLM，指导其生成更具情商和连贯性的回复。

<span class="hljs-section">## ⚙️ MCP Server 实现标准</span>

Eme0将实现为一个独立的微服务（Microservice），完全符合<span class="hljs-strong">**Agent中间件（MCP Server）**</span> 规范。

<span class="hljs-section">### 1. Tools 接口定义</span>

Eme0的核心功能通过标准的MCP Tool接口暴露，供Agent配置使用。

| Tool Name | Method Signature (伪代码) | 功能描述 |
| :--- | :--- | :--- |
| <span class="hljs-code">`eme0_analyze_emotion`</span> | <span class="hljs-code">`analyze(dialogue_turn: str, user_id: str, session_id: str) -&gt; EmotionResult`</span> | <span class="hljs-strong">**实时情绪分析**</span>。对当前的对话回合（文本）进行情绪识别，并更新短期记忆。 |
| <span class="hljs-code">`eme0_get_context`</span> | <span class="hljs-code">`get_context(user_id: str, session_id: str) -&gt; EmotionContext`</span> | <span class="hljs-strong">**获取情绪上下文**</span>。基于短/长期记忆和推理模型，生成当前最相关的情绪描述，供LLM作为Prompt输入。 |
| <span class="hljs-code">`eme0_update_long_term`</span> | <span class="hljs-code">`update_long_term(user_id: str, summary: EmotionSummary)`</span> | <span class="hljs-strong">**更新长期情绪记忆**</span>。在Session结束或特定时间点，将短期情绪总结归档到长期记忆。 |

<span class="hljs-section">### 2. 数据结构定义</span>

<span class="hljs-section">#### A. EmotionResult (实时分析结果)</span>

{
  "primary<span class="hljs-emphasis">_emotion": "sadness",             // 主要情绪 (如：高兴, 愤怒, 悲伤, 惊讶, 恐惧, 平静)
  "emotion_</span>intensity": 0.85,                // 情绪强度 (0.0 - 1.0)
  "emotion<span class="hljs-emphasis">_keywords": ["失落", "不顺利"],   // 提取出的情绪关键词
  "raw_</span>llm<span class="hljs-emphasis">_response": "..."                 // LLM分析的原始输出（用于调试）
}

#### B. EmotionContext (提供给LLM的上下文)

{
  "short_</span>term<span class="hljs-emphasis">_summary": "用户在过去3句话中，情绪从‘平静’逐渐转为‘轻微不满’。",
  "long_</span>term<span class="hljs-emphasis">_profile": "根据历史记录，用户近期情绪波动较大，尤其容易在讨论工作时表现出‘焦虑’。",
  "inferred_</span>intention": "当前的不满可能源于对之前某个问题的未解决。",
  "suggested<span class="hljs-emphasis">_agent_</span>tone": "<span class="hljs-strong">**共情且温柔地**</span>（使用指令格式，方便LLM理解）"
}


<span class="hljs-section">## 🧠 核心模块设计</span>

Eme0由三个核心模块构成：情绪识别模块、情绪记忆管理模块和情绪推理模型。

<span class="hljs-section">### 1. 情绪识别模块 (Emotion Recognition Module)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**目标：**</span> 实现 <span class="hljs-code">`eme0_analyze_emotion`</span> Tool。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**技术栈：**</span> <span class="hljs-strong">**百度千帆 LLM**</span>。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**实现细节：**</span>
<span class="hljs-bullet">      *</span> <span class="hljs-strong">**Prompt 设计：**</span> 将当前的 <span class="hljs-code">`dialogue_turn`</span> 作为输入，要求LLM执行<span class="hljs-strong">**中文情绪分类**</span>和<span class="hljs-strong">**强度评估**</span>。
<span class="hljs-bullet">      *</span> <span class="hljs-strong">**输出格式：**</span> 严格要求LLM输出符合 <span class="hljs-strong">**EmotionResult**</span> 的 JSON 格式。
<span class="hljs-bullet">      *</span> <span class="hljs-strong">**LLM 对接：**</span> 使用百度千帆的最新中文理解模型（如ERNIE 4.0或其他推荐的对话模型）进行零样本（Zero-Shot）或少样本（Few-Shot）情绪分类。

<span class="hljs-section">### 2. 情绪记忆管理模块 (Emotion Memory Management)</span>

此模块负责管理长短期情绪记忆，是情绪上下文支持的基石。

<span class="hljs-section">#### A. 短期情绪记忆 (Short-Term Memory, STM)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**存储内容：**</span> 存储当前Session中每个对话回合的 <span class="hljs-code">`EmotionResult`</span>。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**机制：**</span> 采用<span class="hljs-strong">**滑动窗口**</span>或<span class="hljs-strong">**有限长度列表**</span>（推荐存储最近 $N=10$ 个回合的情绪记录）。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**更新：**</span> 每次调用 <span class="hljs-code">`eme0_analyze_emotion`</span> 后立即更新。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**用途：**</span> 用于捕捉情绪的<span class="hljs-strong">**瞬时变化**</span>和<span class="hljs-strong">**连贯性**</span>。

<span class="hljs-section">#### B. 长期情绪记忆 (Long-Term Memory, LTM)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**存储内容：**</span> 存储过去Session的情绪总结 (<span class="hljs-code">`EmotionSummary`</span>) 和用户的情绪画像 (<span class="hljs-code">`Emotional Profile`</span>)。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**机制：**</span> 采用<span class="hljs-strong">**向量数据库**</span>或<span class="hljs-strong">**键值存储 (Key-Value Store)**</span>。<span class="hljs-code">`Key`</span> 为 <span class="hljs-code">`user_id`</span>，<span class="hljs-code">`Value`</span> 为用户情绪画像的结构化数据或总结文本。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**更新：**</span> 通过 <span class="hljs-code">`eme0_update_long_term`</span> Tool 调用，通常在Session结束后，对STM进行总结并归档。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**用途：**</span> 用于捕捉用户情绪的<span class="hljs-strong">**个性化倾向**</span>、<span class="hljs-strong">**敏感话题**</span>和<span class="hljs-strong">**周期性模式**</span>。

<span class="hljs-section">### 3. 情绪推理模型 (Emotion Inference Model)</span>

<span class="hljs-bullet">  *</span> <span class="hljs-strong">**目标：**</span> 实现 <span class="hljs-code">`eme0_get_context`</span> Tool。这是Eme0的<span class="hljs-strong">**核心价值**</span>。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**技术栈：**</span> <span class="hljs-strong">**百度千帆 LLM**</span> (作为推理核心)。
<span class="hljs-bullet">  *</span> <span class="hljs-strong">**推理逻辑：**</span>
<span class="hljs-bullet">    1.</span>  <span class="hljs-strong">**输入整合：**</span> 将STM的原始情绪序列 + LTM的长期情绪画像，整合成一个Prompt。
<span class="hljs-bullet">    2.</span>  <span class="hljs-strong">**Prompt 结构：**</span>
<span class="hljs-code">        &gt; **[系统指令]** 你是一个高级情感分析模型。请根据用户短期对话历史和长期情绪画像，推断用户当前的情绪状态、深层意图，并建议Agent的回复语气。
        &gt; **[短期历史]** (最近 $N$ 个回合的情绪记录，如：`T-3: 平静(0.2) -&gt; T-2: 略有不满(0.5) -&gt; T-1: 愤怒(0.9)`)
        &gt; **[长期画像]** (从LTM获取的总结文本，如：`用户对工作相关话题敏感，近期焦虑。`)
        &gt; **[要求]** 输出符合 **EmotionContext** 的 JSON 格式。
    3.  **输出：** LLM推断出 `short_term_summary`, `long_term_profile`, `inferred_intention`, `suggested_agent_tone`，然后封装成 `EmotionContext` 返回。
</span>
<span class="hljs-section">## 🛠️ Agent 配置与使用流程</span>

一个Agent (如 <span class="hljs-code">`Agent_A`</span>) 集成Eme0的流程如下：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**配置：**</span> <span class="hljs-code">`Agent_A`</span> 在其MCP配置文件中声明依赖并配置Eme0的Tool。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**对话开始：**</span> 用户说出 $Turn<span class="hljs-emphasis">_k$。
3.  <span class="hljs-strong">**情绪分析 (Perception):**</span> `Agent_</span>A<span class="hljs-code">` 调用 `</span>eme0<span class="hljs-emphasis">_analyze_</span>emotion(Turn<span class="hljs-emphasis">_k, user_</span>id, session<span class="hljs-emphasis">_id)`。
      * Eme0返回 $EmotionResult_</span>k$，并更新STM。
<span class="hljs-bullet">4.</span>  <span class="hljs-strong">**上下文获取 (Context Retrieval):**</span> <span class="hljs-code">`Agent_A`</span> 调用 <span class="hljs-code">`eme0_get_context(user_id, session_id)`</span>。
<span class="hljs-bullet">      *</span> Eme0触发<span class="hljs-strong">**情绪推理模型**</span>，返回 $EmotionContext$。
<span class="hljs-bullet">5.</span>  <span class="hljs-strong">**LLM 生成回复：**</span> <span class="hljs-code">`Agent_A`</span> 将 $Turn<span class="hljs-emphasis">_k$ 和 $EmotionContext$ (尤其是 `suggested_</span>agent<span class="hljs-emphasis">_tone`) 一起喂给自己的主LLM，生成回复。
      * <span class="hljs-strong">**Prompt 示例：**</span> `[EmotionContext.suggested_</span>agent<span class="hljs-emphasis">_tone] + 请根据对话历史，回复用户: [Turn_</span>k]`
<span class="hljs-bullet">6.</span>  <span class="hljs-strong">**Session 结束：**</span> <span class="hljs-code">`Agent_A`</span> 调用 <span class="hljs-code">`eme0_update_long_term(user_id, STM_Summary)`</span>，归档情绪记忆。

-----

<span class="hljs-section">## 🔒 约束与注意事项</span>

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**Latency (延迟):**</span> 由于情绪分析和推理均依赖LLM，<span class="hljs-strong">**性能是关键**</span>。需要优化对百度千帆API的调用频率和处理速度。建议在实时对话中，只对关键回合进行完整的推理。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**Cost (成本):**</span> 频繁调用LLM进行推理会产生费用。需要设计缓存机制，或对推理级别进行分级。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**情绪标准化:**</span> 确保情绪分类体系（如“高兴”、“愤怒”等）在情绪识别模块和推理模型中保持<span class="hljs-strong">**一致性**</span>。
<span class="hljs-bullet">4.</span>  <span class="hljs-strong">**并发性:**</span> Eme0作为一个中间件服务，必须具备高并发处理能力，能同时处理多个Agent的请求。

请使用这份文档来指导您的AI开发者团队，实现这个情绪引擎。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bbe8afa868045599dd5ac8aa52b6f08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=pp4fRsWMEHpF259m8CT37JqpFtg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>Comate初版实现</p>
<h3 data-id="heading-5">3.3 自运行改Bug</h3>
<p>我的操作：运行代码，发现问题</p>
<p>Comate做了什么：自动分析运行日志，定位Bug位置，生成修复方案，自动修复代码。</p>
<p>结果：实时调试，无需手动排查</p>
<p><strong>Prompt：</strong></p>
<p>调用mcp client，修改到能正常运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb8f3ccaef3446ea4cd214bd05d883e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=r3J%2BhiL21UJ%2F40op%2FjTowlzKZKg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>Comate自动分析运营日志，修复Bug</p>
<h3 data-id="heading-6">3.4 自主编写测试case</h3>
<p>我的操作：要求Comate「编写测试用例</p>
<p>Comate做了什么：自动生成5个真实场景的测试用例，包括工作压力、喜悦分享、失落恢复等场景，验证情绪识别准确率达到91%以上</p>
<p>结果：全面测试，确保功能可靠性</p>
<p><strong>Prompt：</strong></p>
<p>python main.py 把项目运行起来，修改所有的问题和Bug。能运行之后，编写测试文件，使用MCP Client的方式调用，写5个测试case，每个case要求连续对话，充分体现情绪引擎的优点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a48f4dbbd19341e7822587a9eed4a8b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=IrXCO6X7Mlp8HJTsi%2FzUUMyEIiA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>自主编写case测试</p>
<h3 data-id="heading-7">3.5 增加MCP Server日志</h3>
<p>我的操作：要求「增加日志系统」</p>
<p>Comate做了什么：自动在关键节点添加日志，实现错误追踪机制，优化调试体验</p>
<p>结果：完善的监控和调试能力</p>
<p><strong>Prompt：</strong></p>
<p>给MCP-server增加输入、输出、耗时的日志打印</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989bfbeb46d94e338a393bd2e3ece1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=Q5q2EfTpVPLzxBONqJp6KC4hDhM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>增加MCP Server日志</p>
<h3 data-id="heading-8">3.6 情绪衰减模型优化</h3>
<p>我的操作：描述衰减模型的需求</p>
<p>Comate做了什么：设计衰减算法公式，实现时间权重计算，优化参数配置。</p>
<p>关键描述：</p>
<p>「情绪会随时间衰减，就像人类会慢慢忘记不愉快」「3小时前的情绪比24小时前的更重要」</p>
<p>结果：实现了符合人类心理特征的衰减模型</p>
<p><strong>Prompt：</strong></p>
<p>优化情绪衰减模型，针对长期情绪画像的建立。增加内存记忆，实现长期情绪画像建立。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239d552bd28941f4af7526735f16a598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=0JCBlt6hZgWUe6tKT%2BOKR3Nm3ww%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>情绪衰减模型优化</p>
<h3 data-id="heading-9">3.7 最终测试效果</h3>
<p>经过完整测试，情绪引擎表现优异</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0491a92b994028923072dbbfdfce98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=HzFkubOVuI68zDyEkYDDtS%2ByS5c%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>最终测试效果</p>
<h4 data-id="heading-10">3.7.1 测试逻辑</h4>
<p>根据AI编写的Case测试，Case覆盖多类情绪识别、情绪变化、情绪融合、情绪记忆、情绪画像等。运行 python test_eme0_client.py 执行测试，查看输出的对话内容、情绪识别等，判断情绪引擎表现效果。</p>
<h4 data-id="heading-11">3.7.2 测试表现</h4>
<p>1.情绪识别精准度 (Accuracy &amp; Consistency)</p>
<p>系统对用户表达的正面情绪捕捉极其敏锐，且具备高置信度。</p>
<ul>
<li>识别准确率： 在连续三轮高强度正面情绪（面试通过、面试官满意、梦寐以求的公司）输入下，系统均准确识别为 happiness。</li>
<li>情绪强度监测： 识别出的情绪强度（intensity）稳定维持在 0.90，准确反映了用户“太棒了”、“太开心了”的强烈情感。</li>
<li>关键词提取逻辑： 系统能精准提取出 [太棒了, 通过, 重要]、[满意, 开心]、[梦寐以求, 做梦一样] 等核心情感词汇，证明了其底层语义理解的深度。</li>
</ul>
<p>2.系统性能耗时 (Latency &amp; Performance)</p>
<p>在复杂的推理链（包括情绪分析、上下文检索、意图推断）下，系统表现出了优秀的响应速度。</p>
<ul>
<li>单次情绪推理耗时： 平均约为 2.97s（第一轮 3.203s，随后的第二、三轮优化至 2.8s 左右）。</li>
<li>工具调用总延迟： 包含 analyze_emotion 逻辑在内的总响应时间稳定在 3.0s 左右，满足实时交互的基础需求。</li>
</ul>
<p>3.用户情绪画像与记忆管理 (Memory &amp; Profiling)</p>
<p>日志显示系统不仅在“听”，更在“记”，成功构建了动态的用户画像。</p>
<ul>
<li>长期画像更新： 系统成功将“面试”这一核心事件记录进 long_term_profile，并实时生成了“暂无历史情绪挑战数据”的背景评估。</li>
<li>短期策略适配： 基于当前 happiness 的情绪状态，系统自动推断出用户意图为 “用户分享积极体验或寻求认可”。</li>
<li>话术风格建议： 引擎给出的 suggested_agent_tone（建议语气）为 “热情洋溢地分享喜悦”，实现了从识别到行动建议的闭环。</li>
</ul>
<p>想要运行「Eme0情绪引擎」，请参考产品Github文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwohunlfry%2FEme0" target="_blank" title="https://github.com/wohunlfry/Eme0" ref="nofollow noopener noreferrer">github.com/wohunlfry/E…</a> “快速开始”部分。</p>
<h2 data-id="heading-12">4 Comate清退开发路上的「拦路虎」</h2>
<p><strong>问题1：工程不能运行</strong></p>
<p>问题描述：AI编写出来的工程无法正常运行，或者运行后调用时出现bug。</p>
<p>解决方案：给AI下达循环命令，要求AI运行并修复错误，直到无错误为止。要求AI编写调用示例，跟踪错误日志，修改到无错误为止。</p>
<p>Comate的帮助：自动运行，自动修改错误和异常，解放人力。交付的结果一定能运行。</p>
<p><strong>问题2：MCP实现的协议不对</strong></p>
<p>问题描述：MCP按照RESTful API实现，没有走MCP的专用协议。</p>
<p>解决方案：提供stdio协议的标准示例，让AI修改。</p>
<p>Comate的帮助：按照协议模板，直接升级协议，无需人工修改。</p>
<p><strong>问题3：修改位置不对</strong></p>
<p>问题描述：AI修改代码时，修改的位置不正确。</p>
<p>解决方案：明确指出需要修改的代码和引用文件，强调修改范围，要求重新修改。</p>
<p>Comate的帮助：按照要求实现，仅修改指定部分。</p>
<p><strong>问题4：不是最优方案就执行，要回退</strong></p>
<p>问题描述：AI在未确认最优方案的情况下就执行修改，导致需要回退。</p>
<p>解决方案：明确要求提供多个方案，确认方案之后，才可以执行修改动作。</p>
<p>Comate的帮助：提供多方案选择，节省返工时间。SPEC模式，拆解流程，分步骤执行。</p>
<p><strong>问题5：对接千帆失败</strong></p>
<p>问题描述：对接的千帆API无法正确调用。</p>
<p>解决方案：提供千帆官方示例Python代码。</p>
<p>Comate的帮助：按照对接方式，快速完成修改。</p>
<p><strong>问题6：核心逻辑太简单</strong></p>
<p>问题描述：核心的情绪衰减算法设计过于简单。</p>
<p>解决方案：提供详细的衰减算法、原理和要求，要求升级。</p>
<p>Comate的帮助：按照要求实现算法升级。</p>
<p><strong>问题7：测试用例未覆盖全场景</strong></p>
<p>问题描述：测试用例未覆盖全部场景。</p>
<p>解决方案：提供未覆盖的场景，让AI增加测试用例。</p>
<p>Comate的帮助：按照要求实现新的测试用例。</p>
<p><strong>问题8：README文档结构问题</strong></p>
<p>问题描述：README文档结构不合理。</p>
<p>解决方案：提供结构大纲，重新编写README，并编写英文版。</p>
<p>Comate的帮助：按照要求实现新文档。</p>
<h2 data-id="heading-13">5 Comate亮点：AI给我的帮助</h2>
<p>在整个开发过程中，Comate展现出了惊艳的能力。以下是我感受最深的几个亮点：</p>
<p><strong>系统架构设计：专业级的模块划分</strong></p>
<ul>
<li>传统方式：需要资深架构师，反复讨论</li>
<li>Comate方式：自动设计模块结构，符合最佳实践</li>
<li>我的体验：Comate深刻理解MCP Server标准，自动划分功能模块，设计清晰的数据流。</li>
</ul>
<p><strong>细节实现完善：边界条件和异常处理</strong></p>
<ul>
<li>传统方式：容易遗漏边界情况，后期bug多</li>
<li>Comate方式：自动补充边界条件处理、异常捕获</li>
<li>我的体验：代码健壮性大幅提升，减少后期维护成本，系统稳定性更好。</li>
</ul>
<p><strong>自主问题修复：智能调试助手</strong></p>
<ul>
<li>传统方式：需要手动分析日志，定位Bug</li>
<li>Comate方式：运行后自动分析，定位并修复问题</li>
<li>我的体验：大幅缩短调试周期，减少重复性工作，提升开发效率。</li>
</ul>
<p><strong>测试用例生成：全面的质量保障</strong></p>
<ul>
<li>传统方式：需要手动编写测试用例，容易遗漏场景</li>
<li>Comate方式：自动生成全面的测试用例</li>
<li>我的体验：覆盖5个真实场景，验证功能可靠性，确保系统质量。</li>
</ul>
<p><strong>日志系统优化：完善的监控能力</strong></p>
<ul>
<li>传统方式：需要手动添加日志，容易遗漏关键节点</li>
<li>Comate方式：自动完善日志记录机制</li>
<li>我的体验：关键节点都有日志，方便错误溯源，提升可维护性。</li>
</ul>
<p><strong>核心算法设计：情绪衰减模型</strong></p>
<ul>
<li>传统方式：需要数学建模，反复验证</li>
<li>Comate方式：描述需求，自动设计算法</li>
<li>我的体验：描述「情绪会随时间衰减」，Comate自动设计衰减公式，实现符合人类心理特征的算法</li>
</ul>
<p><strong>提示语工程：高质量的情绪识别</strong></p>
<ul>
<li>传统方式：需要反复试验，调整提示语</li>
<li>Comate方式：自动生成高质量提示语</li>
<li>我的体验：初始提示语就很准确，持续优化提升精度，情绪识别准确率达91%。</li>
</ul>
<p><strong>提示语迭代优化：持续改进</strong></p>
<ul>
<li>传统方式：需要人工分析结果，手动优化</li>
<li>Comate方式：基于测试反馈自动优化</li>
<li>我的体验：自动分析识别错误，生成优化方案，持续提升准确率。</li>
</ul>
<h2 data-id="heading-14">6 经验分享：如何用好Comate的Prompt</h2>
<p>经过这次开发，我总结了一些使用Comate的Prompt经验，希望对大家有帮助：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80b759b87f964267926e73edcbe3f467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768899875&amp;x-signature=YLqpI477Tw3wf85FrYIoYYda7zk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-15">7 总结：AI开发的新时代</h2>
<p>我的最大感受：</p>
<p>使用Comate后，我的工作重心从「怎么写代码」转变为「要什么功能」。使用Comate，就像拥有一个资深架构师 + 全栈工程师的团队随时待命：提出需求，它立即实现代码；发现Bug，它快速定位并修复；需要测试，它自动生成用例；需要文档，它一键生成说明。当然，这也意味着我需要将更多精力投入到技术栈管理、测试验收和产品体验优化上。</p>
<p>给开发者的建议：</p>
<p>如果你也是：AI应用开发者，Agent系统构建者，对效率有极致追求的工程师，强烈建议体验百度Comate。它不仅仅是编码工具，更是你技术团队的「能力倍增器」。在AI编码时代，掌握Comate这样的智能工具，比掌握任何单一编程语言更重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重拾Eval能力：D4rt为Flutter注入AI进化基因]]></title>    <link>https://juejin.cn/post/7594626381432881202</link>    <guid>https://juejin.cn/post/7594626381432881202</guid>    <pubDate>2026-01-13T09:22:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381432881202" data-draft-id="7594578555352416307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重拾Eval能力：D4rt为Flutter注入AI进化基因"/> <meta itemprop="keywords" content="Flutter,Dart,客户端"/> <meta itemprop="datePublished" content="2026-01-13T09:22:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重拾Eval能力：D4rt为Flutter注入AI进化基因
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:22:58.000Z" title="Tue Jan 13 2026 09:22:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大家好，我是老刘</strong></p>
<p>Flutter 开发者一直面临一个痛点：<strong>动态化</strong>。</p>
<p>在移动端，Flutter 主要依赖 AOT（Ahead-Of-Time）编译以保证高性能，但这同时也意味着代码一旦打包，就变得难以修改。</p>
<p>最近，<strong>D4rt</strong> 的出现引起了关注。它是一个纯 Dart 实现的运行时解释器。</p>
<p>那么，D4rt 会是 Flutter 动态化的最优解吗？它能取代现有的热更新方案吗？</p>
<p>本文将深入探讨 D4rt 的原理、优缺点，以及它真正适合的应用场景。</p>
<hr/>
<h2 data-id="heading-0">一、D4rt 是个啥？</h2>
<p>简单来说，<strong>D4rt</strong> 是一个用于 <strong>Dart 语言的运行时解释器</strong> 库。</p>
<p>它的核心能力是：<strong>让你的 Dart/Flutter 应用能够在运行时动态执行 Dart 代码</strong>。</p>
<p>通过在应用内集成一个解释器，D4rt 打破了 AOT 的限制，使得下发源代码并在运行时动态执行成为可能。</p>
<h3 data-id="heading-1">1. 核心功能</h3>
<ul>
<li><strong>动态执行 Dart 代码</strong>：可以直接将一段 Dart 代码字符串（String）传给解释器并运行。</li>
<li><strong>基于 AST 分析</strong>：它基于 Dart 官方的 <code>analyzer</code> 包，通过分析代码的抽象语法树（AST）来模拟执行。</li>
<li><strong>支持主要语法特性</strong>：支持类（Class）、混入（Mixin）、扩展（Extension）、异步编程（async/await）、枚举（Enum）等大部分 Dart 语法。</li>
<li><strong>Flutter 集成 (<code>flutter_d4rt</code>)</strong>：配合 <code>flutter_d4rt</code> 包，你可以使用 <code>InterpretedWidget</code> 直接把一段代码渲染成 Flutter 组件。</li>
</ul>
<h3 data-id="heading-2">2. 代码示例</h3>
<p><strong>简单的动态执行逻辑：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:d4rt/d4rt.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  <span class="hljs-keyword">final</span> interpreter = DartInterpreter();
  
  <span class="hljs-comment">// 定义一段代码字符串</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-string">'''
    int add(int a, int b) {
      return a + b;
    }
    
    void main() {
      print(add(10, 20));
    }
  '''</span>;

  <span class="hljs-comment">// 动态执行</span>
  interpreter.evaluate(code); <span class="hljs-comment">// 输出: 30</span>
}
</code></pre>
<p><strong>在 Flutter 中动态渲染组件（使用 <code>flutter_d4rt</code>）：</strong></p>
<pre><code class="hljs language-dart" lang="dart">InterpretedWidget(
  code: <span class="hljs-string">'''
    import 'package:flutter/material.dart';
    
    class MyWidget extends StatelessWidget {
      @override
      Widget build(BuildContext context) {
        return Center(
          child: Text('这是动态渲染的文字！'),
        );
      }
    }
  '''</span>,
  entryPoint: <span class="hljs-string">'MyWidget'</span>, <span class="hljs-comment">// 指定入口类名</span>
)
</code></pre>
<h3 data-id="heading-3">3. 优缺点分析</h3>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>灵活性极高</strong>：不需要重新编译即可改变逻辑和 UI。</li>
<li><strong>统一语言</strong>：动态脚本直接使用 Dart，不需要像以前那样引入 Lua 或 JavaScript 引擎（如 QuickJS）再做桥接。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>性能损耗</strong>：解释执行的性能肯定不如 AOT 编译的原生代码，不适合跑高密度的计算逻辑。</li>
<li><strong>体积增加</strong>：引入解释器和 AST 分析器会增加 App 的包体积。</li>
<li><strong>合规风险</strong>：iOS App Store 对“下载可执行代码”有严格限制，使用此类技术需确保不违反审核条款（通常用于配置下发或企业内部应用没问题）。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">二、应用场景分析</h2>
<h3 data-id="heading-5">1. 误区：它不适合作为通用的动态化解决方案</h3>
<p>作为 Flutter 开发者，看到“动态执行”，第一反应往往是 <strong>App 动态化</strong> 或 <strong>热补丁</strong>。
<strong>但是，D4rt 并不适合作为通用的 Flutter 动态化或热修复方案。</strong></p>
<p>核心原因在于 <strong>性能</strong>。</p>
<ul>
<li><strong>解释执行 vs AOT</strong>：Flutter 的流畅性很大程度上归功于 Dart 的 AOT 编译，生成高效的机器码。D4rt 是纯 Dart 实现的解释器，运行时解析 AST 并模拟执行，性能与原生 AOT 代码相比有数量级的差距。</li>
<li><strong>渲染卡顿</strong>：如果用它来渲染复杂的动态页面，构建 Widget 树的过程都在解释器中运行，极易造成 UI 线程阻塞，导致掉帧和卡顿，完全丧失了 Flutter 的高性能优势。</li>
</ul>
<p><strong>结论</strong>：如果你的目标是“热更新整个页面”或“修复核心业务逻辑”，D4rt 撑不起这个需求。</p>
<h3 data-id="heading-6">2. 它真正适合的场景</h3>
<p>虽然不能做全量热修复，但 D4rt 在 <strong>低频、轻量、高动态</strong> 的场景下大有可为。它更像我们在游戏中常见的 <strong>Lua 脚本</strong>。</p>
<h4 data-id="heading-7">2.1 动态业务规则引擎</h4>
<p>比如电商 App 的 <strong>优惠券计算逻辑</strong>、游戏的 <strong>数值策划公式</strong>。</p>
<p>这些逻辑经常变动，但计算量小，不需要重新发版，直接下发一段 Dart 函数即可。</p>
<p><strong>优势</strong>：比 JSON 表达式更强大，支持完整的 Dart 语法（如循环、复杂条件判断）。</p>
<h4 data-id="heading-8">2.2 应用内调试控制台 (REPL)</h4>
<p>为开发者或测试人员提供一个“后门”。</p>
<p>比如在 Release 包中集成一个隐藏入口，打开后可以输入 Dart 代码直接读取内存变量、修改状态或执行方法。</p>
<p>这在桌面端应用或游戏开发工具中比较常见，极大便利了现场 Debug。</p>
<h4 data-id="heading-9">2.3 教育与原型工具</h4>
<p>开发类似“Dart 学习手册”的 App，允许用户在手机上编写并运行示例代码。</p>
<p>用户可以实时查看代码执行结果，理解 Dart 语法和 Flutter 组件的工作原理。</p>
<h4 data-id="heading-10">2.4 你的 App 该学会自己写代码了 (AI Self-Iteration)</h4>
<p>其实前面说的应用场景更多的是基于编程语言可以自解释运行的一些推测。</p>
<p>但是我觉得我们之前的想象力，还是太收敛了，其实<code>eval</code>这个能力结合AI可以有更有趣的应用场景。</p>
<p>现在的 App 是开发者的作品，是静态的交付物。</p>
<p>但如果 App 接入了端侧大模型，手里又握着 Dart 这把“手术刀”，事情就变得有意思了。</p>
<ol>
<li><strong>场景</strong>：用户抱怨“按钮太小”。</li>
<li><strong>传统流程</strong>：反馈 -&gt; 排期 -&gt; 开发 -&gt; 测试 -&gt; 发版 -&gt; 更新。</li>
<li><strong>AI 赋能流程</strong>：
<ul>
<li>App 内置 AI 收到反馈。</li>
<li>后台生成新的 Dart 代码片段（如 <code>height: 60.0</code>）。</li>
<li>利用 D4rt 动态执行，界面当场改变。</li>
<li>AI 询问：“现在舒服了吗？”</li>
</ul>
</li>
</ol>
<p>这才是真正的 <strong>自我进化</strong>。App 像有生命的细胞，根据用户反馈实时调整自己的 DNA（代码），不再受限于漫长的发版周期。</p>
<p>当然要想实现前面说的这些，光有一个D4rt还是远远不够的，但是我觉得<code>eval</code>可能是这一切的核心。</p>
<hr/>
<h2 data-id="heading-11">三、竞品对比：D4rt vs flutter_eval</h2>
<p>提到 Dart 动态执行，不得不提另一个重量级选手：<strong>flutter_eval</strong> (及其核心 dart_eval)。</p>
<p>虽然两者的目标都是“运行动态代码”，但它们走的是完全不同的技术路线。</p>
<h3 data-id="heading-12">1. 技术原理差异</h3>
<ul>
<li>
<p><strong>flutter_d4rt (AST 派)</strong>：</p>
<ul>
<li><strong>原理</strong>：它是一个<strong>纯源码解释器</strong>。利用 <code>analyzer</code> 库解析源码生成抽象语法树（AST），然后遍历树来模拟执行。</li>
<li><strong>特点</strong>：所见即所得，无需中间编译，直接扔进字符串就能跑。但每次执行都要遍历树结构，开销较大。</li>
</ul>
</li>
<li>
<p><strong>flutter_eval (字节码 派)</strong>：</p>
<ul>
<li><strong>原理</strong>：它是一个<strong>编译器 + 虚拟机</strong>。先将 Dart 代码编译成自定义的 EVC 字节码，然后在轻量级虚拟机中执行。</li>
<li><strong>特点</strong>：类似 Java 或 Lua 的运行机制。字节码更紧凑，执行效率更高，且支持下发预编译文件。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">2. 核心对比</h3>



































<table><thead><tr><th align="left">特性</th><th align="left">flutter_d4rt (d4rt)</th><th align="left">flutter_eval (dart_eval)</th></tr></thead><tbody><tr><td align="left"><strong>核心原理</strong></td><td align="left"><strong>AST 解释器</strong> (直接解析源码树)</td><td align="left"><strong>字节码虚拟机</strong> (源码 -&gt; EVC字节码 -&gt; 虚拟机)</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">较低 (需实时遍历语法树)</td><td align="left"><strong>较高</strong> (执行优化后的字节码)</td></tr><tr><td align="left"><strong>输入格式</strong></td><td align="left">Dart 源代码字符串</td><td align="left">Dart 源代码 或 <strong>预编译的 .evc 字节码</strong></td></tr><tr><td align="left"><strong>主要用途</strong></td><td align="left">规则引擎、简单UI动态化、教学/REPL</td><td align="left"><strong>App热更新</strong>、复杂动态页面、业务逻辑下发</td></tr><tr><td align="left"><strong>开发流</strong></td><td align="left">简单直观，即插即用</td><td align="left">相对复杂，生产环境建议配合 CLI 预编译</td></tr></tbody></table>
<h3 data-id="heading-14">3. 该怎么选？</h3>
<ul>
<li>
<p><strong>选 flutter_d4rt</strong>：</p>
<ul>
<li>如果你做的是 <strong>Dart 学习工具</strong> 或 <strong>REPL 控制台</strong>，用户输入什么就得跑什么。</li>
<li>如果逻辑非常简单（如一段简短的计算公式），不想引入复杂的编译流程。</li>
</ul>
</li>
<li>
<p><strong>选 flutter_eval</strong>：</p>
<ul>
<li>如果你有 <strong>热更新 (Code Push)</strong> 需求，甚至想动态替换某个页面。</li>
<li>如果动态代码中有复杂的循环、大量对象创建，对性能有要求。</li>
<li>如果你希望下发的文件体积更小且加载更快（使用 .evc 字节码）。</li>
</ul>
</li>
</ul>
<p>注意 ：无论哪种方案，iOS App Store 都严禁下发可执行代码（二进制或脚本）来改变应用核心功能，使用此类技术时请务必注意审核合规性（通常用于企业包或配置性质的逻辑更新）</p>
<hr/>
<h2 data-id="heading-15">四、总结</h2>
<p>虽然受限于解释执行的性能，它注定无法成为通用的热更新解决方案，但在特定领域——尤其是 <strong>规则计算</strong>、<strong>调试工具</strong> 以及未来的 <strong>AI 辅助生成</strong>——它提供了极具想象力的可能性。</p>
<p>技术总是螺旋上升的。从早期的动态脚本，到追求极致性能的 AOT，再到如今为了灵活性和 AI 赋能重新审视 <code>eval</code> 能力。</p>
<p>D4rt 提醒我们：<strong>在静态的编译产物之外，软件还可以拥有一种更灵动、更具适应性的形态。</strong></p>
<p>掌握它，不是为了滥用动态化，而是为了在那些需要“灵光一闪”的时刻，你的工具箱里恰好有一把趁手的钥匙。</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude 终于对普通人下手了！Cowork 发布，你的最强 AI 打工搭子来了！]]></title>    <link>https://juejin.cn/post/7594576956421324826</link>    <guid>https://juejin.cn/post/7594576956421324826</guid>    <pubDate>2026-01-13T09:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594576956421324826" data-draft-id="7594655863547658292" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude 终于对普通人下手了！Cowork 发布，你的最强 AI 打工搭子来了！"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-13T09:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="优弧"/> <meta itemprop="url" content="https://juejin.cn/user/852876722177533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude 终于对普通人下手了！Cowork 发布，你的最强 AI 打工搭子来了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/852876722177533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    优弧
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:28:16.000Z" title="Tue Jan 13 2026 09:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be71b115c0f43db94c386c578e14b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY5byn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901296&amp;x-signature=T3KhTlVwEvFXzIFTRzOT4RdghiY%3D" alt="图片" loading="lazy"/></p>
<p>自从 Claude Code 被大家“玩出花”以后（真的，什么度假攻略、整理邮箱、硬盘救照片、监测植物、控制烤箱……），Anthropic 终于忍不住了：行，你们不是想让 Agent 不止写代码吗？那我直接端上来—— <strong>Cowork</strong> ！</p>
<p>简单一句话： <strong>Cowork = 把 Claude Code 那套 Agent 能力，直接搬到“非编程工作”里</strong> ，让更多普通用户也能像带同事一样带 Claude 干活！！</p>
<p>目前它还是 <strong>研究预览版</strong> ，优先开放给 <strong>macOS 应用里的 Claude Max 订阅用户</strong> 。想体验的话，下载 macOS 版 Claude，在侧边栏点 “Cowork” 就能上手；其他套餐就先去排队等候名单吧。</p>
<h2 data-id="heading-0">从 Claude Code 到 Cowork：官方被用户反向教育了？</h2>
<p>Claude Code 刚出来的时候，官方的心理活动大概是：开发者用来写代码、提效、自动化，稳！！</p>
<p>结果现实是：大家把它当成一个能动手的“万能助理”——研究、整理、归档、生成材料、清理杂活……只要你敢说，它就敢做！</p>
<p>Anthropic 的解释也很直白：这些奇奇怪怪但超实用的用法背后，是因为底层 <strong>Claude Agent</strong> 足够强，再配上 <strong>Opus 4.5</strong> 这种顶级模型，才会出现“你给个目标，它就能自己推进”的效果。</p>
<p>于是 Cowork 就来了： <strong>把这套能力做成更适合非编码场景的形态</strong> ，并且承认它还很早期、很原始，体验上有点像当年 Claude Code 刚发布那味儿。</p>
<h2 data-id="heading-1">Cowork 到底怎么干活？一句话：给它一个文件夹！！</h2>
<p>跟普通聊天最大的区别是：在 Cowork 里，你可以授权 Claude 访问你电脑上的某个指定文件夹。</p>
<p>然后它就能在这个范围内：</p>
<ul>
<li>读取文件</li>
<li>编辑文件</li>
<li>创建新文件</li>
</ul>
<p>注意哈： <strong>只在你授权的文件夹里折腾</strong> 。这点对“文件管理焦虑症患者”来说非常关键！！</p>
<p>官方举的例子也很贴近真实打工人：</p>
<ul>
<li><strong>重组下载文件夹</strong> ：按规则排序、重命名，每个文件都安排得明明白白</li>
<li><strong>处理票据</strong> ：一堆截图/照片，直接整理成开支表格</li>
<li><strong>整理资料</strong> ：你零散的笔记，它帮你拼成一份报告初稿</li>
</ul>
<p>更要命的是：Cowork 比普通对话更“像个 Agent”——你给任务，它会 <strong>自己制定计划并执行</strong> ，中途会同步进度。熟悉 Claude Code 的朋友应该会非常熟悉这种感觉：像在带一个靠谱但爱冲的同事……</p>
<h2 data-id="heading-2">还能更强：连接器 + 新技能 + 浏览器搭配</h2>
<p>Cowork 不止会在文件夹里干活，它还想变成你的“信息枢纽”：</p>
<ul>
<li><strong>连接器（connectors）</strong> ：把 Claude 连到外部信息源（官方说支持所有 claude.ai 数据连接器）</li>
<li><strong>初始技能集</strong> ：提升创建文档、演示文稿等文件的能力</li>
<li><strong>配合 Chrome 里的 Claude</strong> ：就能做需要访问浏览器的任务（比如检索资料、整理网页信息之类）</li>
</ul>
<p>而且官方强调一个体验点： <strong>你不需要手动搬上下文，也不用自己转换输出格式</strong> 。</p>
<p>你甚至可以把任务排队，让它并行推进——整体更像“给同事留言”，而不是传统的一问一答……打工人看了直接泪目。</p>
<h2 data-id="heading-3">这次还加了哪些“高级但吓人”的东西？</h2>
<p>Cowork 还带了一些看起来就很硬核的机制：</p>
<ul>
<li><strong>内置虚拟机（VM）</strong> ：隔离执行环境，尽量把风险关在笼子里</li>
<li><strong>开箱即用的浏览器自动化支持</strong></li>
<li><strong>支持所有 claude.ai 数据连接器</strong></li>
<li><strong>不确定就问你</strong> ：遇到关键歧义会主动澄清</li>
</ul>
<p>说实话，这套组合拳一出来，我的第一反应是：这真不是在悄悄把“通用办公 Agent”往前推吗……？</p>
<h2 data-id="heading-4">保持控制很重要，但风险也别装看不见……</h2>
<p>官方在安全这块讲得还挺实在。</p>
<p><strong>你始终握着方向盘</strong> ：</p>
<ul>
<li>你决定它能访问哪些文件夹/连接器</li>
<li>它不能读写你没授权的内容</li>
<li>做重要动作前会征求你的同意</li>
</ul>
<p>但风险也确实存在，尤其是新手第一次用这种“能动手”的工具：</p>
<ol>
<li><strong>潜在破坏性操作</strong> ：如果你指令不清晰，它可能做出删除文件之类的操作（默认能力允许它执行很多动作）。所以涉及删除/覆盖/批量改名这类任务，指令一定要写得清清楚楚！！</li>
<li><strong>提示注入风险</strong> ：如果它在网上读到恶意内容，有可能被诱导改变计划。官方说有防护，但 Agent 安全本身仍是行业里的活跃研究方向。</li>
</ol>
<p>总结一下就是： <strong>它很强，但你也得更“像一个项目负责人”</strong> ——目标给清楚，关键节点盯一下，别当甩手掌柜。</p>
<h2 data-id="heading-5">一点小看法</h2>
<p>我觉得 Cowork 的意义不在于“又多了一个新功能”，而在于它把一个信号摆到台面上了： <strong>Agent 正在从开发者玩具，变成所有人的生产力外挂</strong> 。</p>
<p>以前我们用 AI 更像“聊天+生成内容”；现在这种形态更像“我给你权限+给你目标，你去推进并交付”。如果体验做顺了，打工人会爽到飞起；如果安全边界做不好，也可能翻车翻得很惨……</p>
<p>但不管怎么说，Anthropic 这波敢把 Cowork 放出来做研究预览，我是愿意给掌声的—— <strong>先让大家用起来，现实会告诉你该怎么迭代</strong> ！</p>
<p>参考链接： <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fcowork-research-preview" target="_blank" title="https://claude.com/blog/cowork-research-preview" ref="nofollow noopener noreferrer">claude.com/blog/cowork…</a></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 整合 JWT + Redis 实现登录鉴权]]></title>    <link>https://juejin.cn/post/7594578555351892019</link>    <guid>https://juejin.cn/post/7594578555351892019</guid>    <pubDate>2026-01-13T07:45:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555351892019" data-draft-id="7594578555351875635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 整合 JWT + Redis 实现登录鉴权"/> <meta itemprop="keywords" content="后端,Redis,Java"/> <meta itemprop="datePublished" content="2026-01-13T07:45:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="造轮子的猪"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 整合 JWT + Redis 实现登录鉴权
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    造轮子的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:45:05.000Z" title="Tue Jan 13 2026 07:45:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SpringBoot 整合 JWT + Redis 实现登录鉴权（含Token自动续期+账户防暴力破解锁定）完整实现方案</h2>
<h3 data-id="heading-1">一、方案说明</h3>
<p>本方案采用 <code>JWT + Redis</code> 组合实现登录鉴权，解决了纯JWT无法主动失效、无法续期的痛点：</p>
<ol>
<li>JWT 生成令牌，承载用户核心信息，客户端请求携带令牌实现无状态认证</li>
<li>Redis 存储有效令牌，做<strong>双重校验</strong>（JWT签名有效性+Redis令牌存在性），支持令牌主动失效（如登出）</li>
<li>实现令牌<strong>自动续期</strong>：令牌剩余有效期不足1/3时，自动刷新Redis过期时间</li>
<li>登录接口做<strong>防暴力破解</strong>：连续5次登录失败，账户锁定15分钟，保障账户安全</li>
<li>基于SpringMVC的<code>HandlerInterceptor</code>实现全局请求拦截，统一校验令牌</li>
</ol>
<hr/>
<h3 data-id="heading-2">二、核心依赖引入</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringSecurity 加密/核心工具 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-crypto<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.7.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- JJWT 核心依赖 - JWT令牌生成/解析 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- SpringBoot Redis 启动器 - 存储有效令牌/续期控制 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">三、全局请求拦截器 - JwtInterceptor</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.MediaType;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> JwtServiceImpl jwtService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 获取请求头中的令牌</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">authToken</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        
        <span class="hljs-comment">// 2. 令牌为空，直接返回未授权</span>
        <span class="hljs-keyword">if</span> (org.springframework.util.StringUtils.isBlank(authToken)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token不能为空"</span>);
        }

        <span class="hljs-comment">// 3. 校验令牌格式是否包含Bearer前缀</span>
        <span class="hljs-keyword">if</span> (!authToken.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token格式错误，必须以Bearer 开头"</span>);
        }

        <span class="hljs-comment">// 4. 截取纯token字符串</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authToken.substring(<span class="hljs-string">"Bearer"</span>.length() + <span class="hljs-number">1</span>).trim();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 5. 第一步校验：Redis中是否存在该令牌，不存在=过期/已注销/非法令牌</span>
            <span class="hljs-keyword">if</span> (!jwtService.redisHasToken(token)) {
                <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token无效或已过期"</span>);
            }

            <span class="hljs-comment">// 6. 第二步校验：解析JWT令牌，获取载荷信息</span>
            io.jsonwebtoken.<span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> jwtService.extractAllClaims(token);
            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> claims.getSubject();

            <span class="hljs-comment">// 7. 第三步校验：令牌签名+用户信息有效性校验</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isTokenValid</span> <span class="hljs-operator">=</span> jwtService.validAuthToken(token, userId);
            <span class="hljs-keyword">if</span> (!isTokenValid) {
                <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token无效或已过期"</span>);
            }

            <span class="hljs-comment">// 8. 令牌有效，判断是否需要自动续期（剩余时间不足1/3则续期）</span>
            <span class="hljs-keyword">if</span> (jwtService.isAuthTokenExpiringSoon(token)) {
                jwtService.expireToken(token);
            }

            <span class="hljs-comment">// 9. 将用户ID存入ThreadLocal，供后续业务逻辑获取，无需重复解析</span>
            UserContext.set(Integer.parseInt(userId));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 捕获所有令牌异常：解析失败、签名篡改、数据异常等</span>
            <span class="hljs-keyword">return</span> writeErrorResponse(response, <span class="hljs-string">"Token无效或已过期"</span>);
        }
        <span class="hljs-comment">// 全部校验通过，放行请求</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">/**
     * 抽离公共的错误响应方法，统一返回JSON格式错误信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">writeErrorResponse</span><span class="hljs-params">(HttpServletResponse response, String msg)</span> <span class="hljs-keyword">throws</span> IOException {
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        response.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">errorJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"code\": 401, \"message\": \""</span> + msg + <span class="hljs-string">"\"}"</span>;
        response.getWriter().print(errorJson);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">四、JWT核心业务实现类 - JwtServiceImpl</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.jsonwebtoken.*;
<span class="hljs-keyword">import</span> io.jsonwebtoken.security.Keys;
<span class="hljs-keyword">import</span> io.jsonwebtoken.security.SignatureException;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.security.Key;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;
<span class="hljs-keyword">import</span> java.util.Base64;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtServiceImpl</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> RedisService redisService;

    <span class="hljs-comment">// ======================== 常量配置区 ========================</span>
    <span class="hljs-comment">/** redis中令牌的前缀 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOKEN_AUTH_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"token:auth:"</span>;
    <span class="hljs-comment">/** JWT签名密钥【生产环境请改为32位以上随机字符串，Base64编码后的值】 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECRET_KEY</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(<span class="hljs-string">"springboot-jwt-redis-auth-2026-key"</span>.getBytes());
    <span class="hljs-comment">/** JWT令牌默认有效期 单位：分钟 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">DEFAULT_AUTH_EXPIRE_MINUTE</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;
    <span class="hljs-comment">/** JWT令牌有效期配置 单位：分钟 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">JWT_TOKEN_EXPIRE_MINUTE</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;

    <span class="hljs-comment">// ======================== 私有工具方法 ========================</span>
    <span class="hljs-comment">/**
     * 获取JWT签名密钥对象，基于HS256算法
     */</span>
    <span class="hljs-keyword">private</span> Key <span class="hljs-title function_">getSigningKey</span><span class="hljs-params">()</span> {
        <span class="hljs-type">byte</span>[] keyBytes = Base64.getDecoder().decode(SECRET_KEY);
        <span class="hljs-keyword">return</span> Keys.hmacShaKeyFor(keyBytes);
    }

    <span class="hljs-comment">/**
     * 获取Redis中令牌的剩余过期时间，单位：秒
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getTokenRedisExpire</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> redisService.getExpire(TOKEN_AUTH_PREFIX + token);
    }

    <span class="hljs-comment">/**
     * 获取令牌续期阈值：剩余有效期不足总时长的1/3时，触发自动续期
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAuthRefreshSeconds</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getAuthExpireSeconds() / <span class="hljs-number">3</span>;
    }

    <span class="hljs-comment">// ======================== 公有对外方法 ========================</span>
    <span class="hljs-comment">/**
     * 计算令牌有效期，转成秒数返回
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAuthExpireSeconds</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Integer</span> <span class="hljs-variable">expireMinutes</span> <span class="hljs-operator">=</span> Optional.ofNullable(JWT_TOKEN_EXPIRE_MINUTE).orElse(DEFAULT_AUTH_EXPIRE_MINUTE);
        <span class="hljs-keyword">return</span> expireMinutes * <span class="hljs-number">60</span>;
    }

    <span class="hljs-comment">/**
     * 构建JWT令牌，自定义载荷信息
     * <span class="hljs-doctag">@param</span> identifier 主题，存储用户ID等唯一标识
     * <span class="hljs-doctag">@param</span> claimsMap  自定义载荷，可存储用户角色、权限等信息
     * <span class="hljs-doctag">@param</span> secondsValidity 令牌有效期，单位：秒
     * <span class="hljs-doctag">@return</span> 生成的JWT令牌字符串
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateTokenWithClaims</span><span class="hljs-params">(String identifier, Map&lt;String, Object&gt; claimsMap, <span class="hljs-type">int</span> secondsValidity)</span> {
        <span class="hljs-keyword">return</span> Jwts.builder()
                .setClaims(claimsMap)
                .setSubject(identifier)
                .setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis()))
                .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + secondsValidity * <span class="hljs-number">1000</span>))
                .signWith(getSigningKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    <span class="hljs-comment">/**
     * 解析token，获取自定义载荷中的purpose字段
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">extractPurpose</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> extractAllClaims(token).get(<span class="hljs-string">"purpose"</span>, String.class);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">/**
     * 解析token，获取全部载荷信息
     * <span class="hljs-doctag">@throws</span> ExpiredJwtException token过期
     * <span class="hljs-doctag">@throws</span> SignatureException 签名错误/令牌篡改
     * <span class="hljs-doctag">@throws</span> MalformedJwtException 令牌格式错误
     */</span>
    <span class="hljs-keyword">public</span> Claims <span class="hljs-title function_">extractAllClaims</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    <span class="hljs-comment">/**
     * 生成登录鉴权专用令牌
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> JWT令牌
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateAuthToken</span><span class="hljs-params">(Integer userId)</span> {
        <span class="hljs-comment">// 设置令牌用途和业务类型，便于后续扩展多场景令牌</span>
        Map&lt;String, Object&gt; claimsMap = generateClaims(<span class="hljs-string">"auth"</span>, <span class="hljs-string">"accessControl"</span>);
        <span class="hljs-comment">// 生成JWT令牌</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> generateTokenWithClaims(String.valueOf(userId), claimsMap, getAuthExpireSeconds());
        <span class="hljs-comment">// 令牌存入Redis，Redis过期时间与JWT一致，双重保障</span>
        redisService.set(TOKEN_AUTH_PREFIX + token, String.valueOf(userId), getAuthExpireSeconds());
        <span class="hljs-keyword">return</span> token;
    }

    <span class="hljs-comment">/**
     * 校验令牌有效性：Redis存在性+用户ID一致性校验
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validAuthToken</span><span class="hljs-params">(String token, String userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">storedUserId</span> <span class="hljs-operator">=</span> getAuthData(token);
        <span class="hljs-keyword">return</span> StringUtils.isNotBlank(storedUserId) &amp;&amp; userId.equals(storedUserId);
    }

    <span class="hljs-comment">/**
     * 判断令牌是否即将过期，是否需要续期
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthTokenExpiringSoon</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">remainExpireSeconds</span> <span class="hljs-operator">=</span> getTokenRedisExpire(token);
        <span class="hljs-type">long</span> <span class="hljs-variable">refreshThreshold</span> <span class="hljs-operator">=</span> getAuthRefreshSeconds();
        <span class="hljs-keyword">return</span> remainExpireSeconds &gt; <span class="hljs-number">0</span> &amp;&amp; remainExpireSeconds &lt; refreshThreshold;
    }

    <span class="hljs-comment">/**
     * 令牌续期：刷新Redis中令牌的过期时间，实现无感续期
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">expireToken</span><span class="hljs-params">(String token)</span>{
        redisService.expireKey(TOKEN_AUTH_PREFIX + token, getAuthExpireSeconds());
    }

    <span class="hljs-comment">/**
     * 获取Redis中存储的令牌绑定的用户ID
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthData</span><span class="hljs-params">(String token)</span>{
        <span class="hljs-keyword">return</span> redisService.get(TOKEN_AUTH_PREFIX + token);
    }

    <span class="hljs-comment">/**
     * 构建JWT自定义载荷信息
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">generateClaims</span><span class="hljs-params">(String purpose, String busType)</span> {
        Map&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">2</span>);
        claims.put(<span class="hljs-string">"purpose"</span>, purpose);
        claims.put(<span class="hljs-string">"busType"</span>, busType);
        <span class="hljs-keyword">return</span> claims;
    }

    <span class="hljs-comment">/**
     * 判断Redis中是否存在该令牌
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">redisHasToken</span><span class="hljs-params">(String token)</span>{
        <span class="hljs-keyword">return</span> redisService.hasKey(TOKEN_AUTH_PREFIX + token);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">五、登录业务实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> javax.annotation.Resource;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginServiceImpl</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> UserService userService;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> JwtServiceImpl jwtService;

    <span class="hljs-comment">/** 登录失败锁定阈值：连续失败5次 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">FAILED_LOCK_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-comment">/** 账户锁定时长：15分钟，单位毫秒 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Long</span> <span class="hljs-variable">LOCK_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span>;

    <span class="hljs-comment">/**
     * 用户登录核心方法
     * <span class="hljs-doctag">@param</span> userDto 登录入参（用户名+密码）
     * <span class="hljs-doctag">@return</span> 登录成功返回JWT令牌，失败抛出业务异常
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(UserDto userDto)</span>{
        <span class="hljs-comment">// 1. 根据用户名查询用户，用户不存在直接返回失败</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getByUsername(userDto.getUsername());
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户名或密码错误"</span>);
        }

        <span class="hljs-type">boolean</span> <span class="hljs-variable">needResetStatus</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Integer</span> <span class="hljs-variable">failedAttempts</span> <span class="hljs-operator">=</span> user.getFailedAttempts();
        <span class="hljs-type">Short</span> <span class="hljs-variable">userStatus</span> <span class="hljs-operator">=</span> user.getStatus();

        <span class="hljs-comment">// 2. 判断账户是否被锁定（连续5次失败）</span>
        <span class="hljs-keyword">if</span> (FAILED_LOCK_COUNT.equals(failedAttempts)) {
            <span class="hljs-type">long</span> <span class="hljs-variable">lastFailTime</span> <span class="hljs-operator">=</span> user.getUpdatedDate().getTime();
            <span class="hljs-comment">// 判断是否超过锁定时间</span>
            <span class="hljs-keyword">if</span> (isTimeExceeded(lastFailTime, LOCK_TIME)) {
                <span class="hljs-comment">// 锁定时间已过，重置失败次数和状态</span>
                needResetStatus = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 账户仍在锁定中</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"连续5次登录失败，账户已锁定15分钟，请稍后再试"</span>);
            }
        }

        <span class="hljs-comment">// 3. 判断用户状态是否正常</span>
        <span class="hljs-keyword">if</span> (!UserEnum.NORMAL.getStatus().equals(userStatus) &amp;&amp; !needResetStatus) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"账户状态异常，无法登录"</span>);
        }

        <span class="hljs-comment">// 4. 校验密码是否正确</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">passwordValid</span> <span class="hljs-operator">=</span> userService.verifyPassword(userDto.getPassword(), user.getPassword());
        <span class="hljs-keyword">if</span> (passwordValid) {
            <span class="hljs-comment">// 密码正确：重置失败次数+解锁账户</span>
            <span class="hljs-keyword">if</span> (needResetStatus) {
                userService.updateUserStatus(user.getId());
            }
            <span class="hljs-comment">// 生成并返回令牌</span>
            <span class="hljs-keyword">return</span> jwtService.generateAuthToken(user.getId());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 密码错误：失败次数+1，达到阈值则锁定</span>
            userService.incrFailedAttempts(userDto.getUsername());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户名或密码错误"</span>);
        }
    }

    <span class="hljs-comment">/**
     * 判断是否超过指定时长
     * <span class="hljs-doctag">@param</span> startTime 开始时间戳
     * <span class="hljs-doctag">@param</span> timeLimit 时长限制（毫秒）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeExceeded</span><span class="hljs-params">(<span class="hljs-type">long</span> startTime, <span class="hljs-type">long</span> timeLimit)</span> {
        <span class="hljs-keyword">return</span> System.currentTimeMillis() - startTime &gt; timeLimit;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-6">六、拦截器和ThreadLocal</h3>
<h4 data-id="heading-7">6.1 拦截器注册配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
<span class="hljs-keyword">import</span> javax.annotation.Resource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> JwtInterceptor jwtInterceptor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(jwtInterceptor)
                <span class="hljs-comment">// 拦截所有请求</span>
                .addPathPatterns(<span class="hljs-string">"/**"</span>)
                <span class="hljs-comment">// 放行登录接口、静态资源等无需鉴权的接口</span>
                .excludePathPatterns(<span class="hljs-string">"/user/login"</span>, <span class="hljs-string">"/error"</span>);
    }
}
</code></pre>
<h4 data-id="heading-8">6.2 ThreadLocal用户上下文 - UserContext</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Integer&gt; USER_ID_CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-comment">/** 设置当前线程的用户ID */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Integer userId)</span> {
        USER_ID_CONTEXT.set(userId);
    }

    <span class="hljs-comment">/** 获取当前线程的用户ID */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> USER_ID_CONTEXT.get();
    }

    <span class="hljs-comment">/** 清除当前线程的用户ID，防止内存泄漏 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
        USER_ID_CONTEXT.remove();
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">七、核心亮点</h3>
<ol>
<li><strong>高安全性</strong>：JWT签名防篡改 + Redis双重校验 + 账户防暴力破解锁定，三重保障</li>
<li><strong>高可用性</strong>：令牌自动无感续期，用户无需重复登录，体验友好</li>
<li><strong>高健壮性</strong>：完善的异常处理，避免token格式错误、篡改、过期导致的程序崩溃</li>
<li><strong>高可维护性</strong>：代码结构清晰，常量统一管理，注释完整，逻辑精简</li>
</ol>
<h4 data-id="heading-10">生产环境必改配置</h4>
<ol>
<li><code>SECRET_KEY</code>：必须改为32位以上的随机字符串，Base64编码后使用，防止密钥被破解</li>
<li>令牌有效期：可根据业务调整，建议后台管理系统30分钟，移动端2小时</li>
<li>Redis部署：生产环境建议使用Redis集群，防止单点故障</li>
<li>密码加密：必须使用<code>BCryptPasswordEncoder</code>加密存储，禁止明文存储</li>
</ol>
<h4 data-id="heading-11">核心设计思想</h4>
<blockquote>
<p>为什么用JWT+Redis，而不是纯JWT/纯Redis？</p>
</blockquote>
<ul>
<li>纯JWT：令牌一旦生成无法主动失效，过期时间固定，续期困难</li>
<li>纯Redis：需要存储大量用户信息，Redis压力大，且无状态认证优势丧失</li>
<li>JWT+Redis：扬长避短，JWT做无状态令牌，Redis做有效令牌存储+续期，完美解决痛点</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis Cluster 实现多key事务操作]]></title>    <link>https://juejin.cn/post/7594616268781584411</link>    <guid>https://juejin.cn/post/7594616268781584411</guid>    <pubDate>2026-01-13T07:48:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268781584411" data-draft-id="7594482829754941486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis Cluster 实现多key事务操作"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2026-01-13T07:48:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小飞Coding"/> <meta itemprop="url" content="https://juejin.cn/user/954816145155181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis Cluster 实现多key事务操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954816145155181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小飞Coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:48:42.000Z" title="Tue Jan 13 2026 07:48:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Redis 集群模式下，<code>MULTI/EXEC</code> 事务直接报错：
<strong>“CROSSSLOT Keys in request don't hash to the same slot”</strong>。
那么，如何在保证数据一致性的前提下，同时操作多个 Key？
本文给出 <strong>生产级可行方案</strong>，从原子性到最终一致性全覆盖。</p>
</blockquote>
<p>如果你正在使用 Redis Cluster，一定遇到过这样的困境：</p>
<ul>
<li>想扣用户余额，同时创建订单、记录日志；</li>
<li>写了个 <code>MULTI/EXEC</code>，结果 Redis 报错：<strong>key 不在同一个 slot</strong>；</li>
<li>改用 Pipeline？但又怕中间被其他请求插队，导致状态不一致……</li>
</ul>
<p>别急！Redis Cluster 虽然限制了跨 slot 的原子操作，但通过合理设计，我们依然能实现<strong>安全、可靠、高性能的多 Key 操作</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、为什么 Redis Cluster 不支持跨节点事务？</h2>
<p>Redis Cluster 将 key 空间划分为 <strong>16384 个 slot</strong>，每个 key 通过 <code>CRC16(key) % 16384</code> 映射到一个 slot，由某个主节点负责。</p>
<p>而 <strong><code>MULTI/EXEC</code> 事务要求所有 key 必须属于同一个 slot</strong>，否则直接拒绝：</p>
<pre><code class="hljs language-bash" lang="bash">&gt; MULTI
&gt; SET user:1001:name Alice
&gt; SET order:2001:status paid
&gt; EXEC
(error) CROSSSLOT Keys <span class="hljs-keyword">in</span> request don<span class="hljs-string">'t hash to the same slot
</span></code></pre>
<p><strong>原因很简单</strong>：
事务需要在单个节点上原子执行，而跨 slot 意味着涉及多个物理节点 —— Redis 无法保证分布式事务的 ACID。</p>
<blockquote>
<p>⚠️ 注意：<strong>Pipeline 也不是事务</strong>！它只是网络优化，命令之间仍可能被其他客户端插入。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、方案一：Hash Tag + Lua 脚本（强一致性，推荐！）</h2>
<p>这是 <strong>唯一能在 Redis Cluster 中实现原子多 Key 操作的方式</strong>。</p>
<h3 data-id="heading-2">✅ 核心思想：</h3>
<ol>
<li>利用 <strong>Hash Tag 规则</strong>，强制相关 key 落在同一 slot；</li>
<li>用 <strong>Lua 脚本</strong> 在单节点内完成所有操作，天然原子。</li>
</ol>
<h3 data-id="heading-3">🔧 实施步骤</h3>
<h4 data-id="heading-4">1. Key 设计：使用 <code>{}</code> 包裹聚合 ID</h4>
<p>Redis 规定：<strong>只有 <code>{}</code> 内的内容参与 slot 计算</strong>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 所有与用户 1001 相关的 key</span>
user:{1001}:balance   → slot = CRC16(<span class="hljs-string">"1001"</span>) % 16384
user:{1001}:orders    → slot = CRC16(<span class="hljs-string">"1001"</span>) % 16384
user:{1001}:<span class="hljs-built_in">log</span>       → slot = CRC16(<span class="hljs-string">"1001"</span>) % 16384
</code></pre>
<blockquote>
<p>✅ 这些 key 必然落在同一节点，可被原子操作。</p>
</blockquote>
<h4 data-id="heading-5">2. 编写 Lua 脚本（原子执行）</h4>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 扣款 + 加订单 + 记日志</span>
<span class="hljs-keyword">local</span> balance = <span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>]) <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
<span class="hljs-keyword">if</span> balance &lt; <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">2</span>]) <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.error_reply(<span class="hljs-string">'INSUFFICIENT_BALANCE'</span>)
<span class="hljs-keyword">end</span>

redis.call(<span class="hljs-string">'DECRBY'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>])          <span class="hljs-comment">-- 扣余额</span>
redis.call(<span class="hljs-string">'SADD'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">1</span>])            <span class="hljs-comment">-- 加订单</span>
redis.call(<span class="hljs-string">'RPUSH'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-string">'Order created'</span>)   <span class="hljs-comment">-- 记日志</span>

<span class="hljs-keyword">return</span> balance - <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">2</span>])
</code></pre>
<h4 data-id="heading-6">3. 客户端调用（以 Jedis 为例）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"..."</span>; <span class="hljs-comment">// 上述 Lua</span>
List&lt;String&gt; keys = Arrays.asList(
    <span class="hljs-string">"user:{1001}:balance"</span>,
    <span class="hljs-string">"user:{1001}:orders"</span>,
    <span class="hljs-string">"user:{1001}:log"</span>
);
List&lt;String&gt; args = Arrays.asList(<span class="hljs-string">"order_2026"</span>, <span class="hljs-string">"100"</span>);

<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.eval(script, keys, args);
</code></pre>
<h3 data-id="heading-7">✅ 优势</h3>
<ul>
<li><strong>强原子性</strong>：脚本执行期间，其他命令无法插入；</li>
<li><strong>高性能</strong>：一次网络往返；</li>
<li><strong>完全兼容 Cluster</strong>。</li>
</ul>
<h3 data-id="heading-8">⚠️ 注意事项</h3>
<ul>
<li><strong>避免数据倾斜</strong>：不要用高频 ID（如 user_id=1）作为 tag；</li>
<li><strong>仅适用于“聚合根”模型</strong>：所有 key 应属于同一业务实体（用户、订单、会话等）。</li>
</ul>
<blockquote>
<p>💡 <strong>最佳实践：在领域建模阶段，就将需原子操作的数据归为同一聚合，并用 <code>{aggregate_id}</code> 作为 Hash Tag。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">三、方案二：应用层分步操作 + 补偿机制（最终一致性）</h2>
<p>当 key <strong>无法归到同一 slot</strong>（如跨用户转账），且业务可接受<strong>最终一致性</strong>时，可采用 Saga 模式。</p>
<h3 data-id="heading-10">示例：用户 A 转账给用户 B</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 冻结 A 的资金（带 TTL 防死锁）</span>
    redis.setex(<span class="hljs-string">"lock:A:100"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"100"</span>);
    
    <span class="hljs-comment">// 2. 扣 A 余额</span>
    redis.decrBy(<span class="hljs-string">"user:A:balance"</span>, <span class="hljs-number">100</span>);
    
    <span class="hljs-comment">// 3. 加 B 余额</span>
    redis.incrBy(<span class="hljs-string">"user:B:balance"</span>, <span class="hljs-number">100</span>);
    
    <span class="hljs-comment">// 4. 清除锁</span>
    redis.del(<span class="hljs-string">"lock:A:100"</span>);
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-comment">// 补偿：回滚已执行的操作</span>
    <span class="hljs-keyword">if</span> (A余额已扣) redis.incrBy(<span class="hljs-string">"user:A:balance"</span>, <span class="hljs-number">100</span>);
    <span class="hljs-keyword">if</span> (B余额已加) redis.decrBy(<span class="hljs-string">"user:B:balance"</span>, <span class="hljs-number">100</span>);
    redis.del(<span class="hljs-string">"lock:A:100"</span>);
}
</code></pre>
<h3 data-id="heading-11">✅ 适用场景</h3>
<ul>
<li>跨聚合根操作（如 A→B 转账）；</li>
<li>有明确补偿逻辑（如退款、撤回）；</li>
<li>可容忍短暂不一致。</li>
</ul>
<h3 data-id="heading-12">❌ 劣势</h3>
<ul>
<li>实现复杂（需幂等、重试、监控）；</li>
<li>无法保证强一致性。</li>
</ul>
<hr/>
<h2 data-id="heading-13">四、方案三：异步队列 + 幂等消费（高吞吐场景）</h2>
<p>将多 Key 操作拆解为消息，交由 Kafka/RocketMQ 等可靠队列处理：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[发起操作] --&gt; B[发消息到 MQ]
B --&gt; C[消费者1: 更新 key1]
C --&gt; D[消费者2: 更新 key2]
</code></pre>
<ul>
<li>消费者需实现<strong>幂等</strong>（如用 <code>SET key value NX</code> 防重）；</li>
<li>适合<strong>非实时</strong>场景：积分发放、通知推送、日志同步等。</li>
</ul>
<hr/>
<h2 data-id="heading-14">五、不推荐方案：单独部署非集群 Redis</h2>
<ul>
<li>为事务单独维护一套 standalone Redis；</li>
<li><strong>破坏架构统一性</strong>，增加运维成本；</li>
<li><strong>丧失 Cluster 的高可用与扩展能力</strong>；</li>
<li>仅适用于极小规模、临时过渡场景。</li>
</ul>
<hr/>
<h2 data-id="heading-15">🔚 总结：如何选择？</h2>





















<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>强一致性 + 多 Key 同业务实体</strong></td><td>✅ Hash Tag + Lua 脚本</td></tr><tr><td><strong>跨实体 Key + 可接受最终一致</strong></td><td>✅ Saga 补偿 或 异步队列</td></tr><tr><td><strong>简单批量读写（同 Key）</strong></td><td>✅ <code>MSET</code> / <code>MGET</code>（内置原子命令）</td></tr></tbody></table>
<blockquote>
<p>🌟 <strong>核心原则：
在 Redis Cluster 中，*<em>不要对抗 slot 机制，而要顺应它*</em>。
通过合理的数据建模（聚合根 + Hash Tag），你可以在享受 Cluster 高可用的同时，实现强一致的事务操作。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[spring-ioc]]></title>    <link>https://juejin.cn/post/7594578555351957555</link>    <guid>https://juejin.cn/post/7594578555351957555</guid>    <pubDate>2026-01-13T07:51:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555351957555" data-draft-id="7594626381432356914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="spring-ioc"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-13T07:51:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悦悦妍妍"/> <meta itemprop="url" content="https://juejin.cn/user/3395772841729421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            spring-ioc
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3395772841729421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悦悦妍妍
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T07:51:08.000Z" title="Tue Jan 13 2026 07:51:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">spring-ioc</h2>
<h3 data-id="heading-1">Bean是什么？</h3>
<ul>
<li>Spring容器管理的对象实例</li>
<li>由Spring IoC容器负责创建、装配和管理</li>
</ul>
<h3 data-id="heading-2">配置bean</h3>
<ul>
<li>@Configuration + @Bean 配置bean</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>  <span class="hljs-comment">// 声明这是一个Spring配置类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DogConfig</span> {
    
    <span class="hljs-meta">@Bean</span>  <span class="hljs-comment">// 声明这是一个Spring Bean的工厂方法</span>
    <span class="hljs-keyword">public</span> Dog <span class="hljs-title function_">dog1</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();  <span class="hljs-comment">// 使用无参构造函数创建Dog实例</span>
    }

    <span class="hljs-meta">@Bean</span>  <span class="hljs-comment">// 声明另一个Bean</span>
    <span class="hljs-keyword">public</span> Dog <span class="hljs-title function_">dog2</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">"xm"</span>, <span class="hljs-number">12</span>);  <span class="hljs-comment">// 使用带参数的构造函数创建Dog实例</span>
    }
}


成为spring的bean后就可以被<span class="hljs-meta">@Autowired</span>注入
<span class="hljs-meta">@Autowired</span>
Map&lt;String, Dog&gt; dogMap;

<span class="hljs-meta">@Autowired</span>
Dog dog1;

</code></pre>
<ul>
<li>@Component | @Controller | @Service | @Repository也可以标注一个bean</li>
</ul>
<h3 data-id="heading-3">注入Bean</h3>
<h5 data-id="heading-4"><code>@Autowired</code></h5>
<ul>
<li>注入规则 按照类型获取单个组件bean的规则[先按照类型，再按照名称]</li>
</ul>
<pre><code class="hljs">只找到1个这样的类型，则直接注入，注入的变量名随便
如果找到多个类，再按照名称去找，变量名就是名字，如果找到则注入；如果没找到就报错
</code></pre>
<h5 data-id="heading-5">用构造器注入</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IPerson teacherImpl; <span class="hljs-comment">// final表示必需！</span>


<span class="hljs-comment">//    @Autowired</span>
<span class="hljs-comment">//    private IPerson teacherImpl;</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserDao</span><span class="hljs-params">(IPerson teacherImpl)</span>{
        log.info(<span class="hljs-string">"UserDao constructor:{}"</span>, teacherImpl);
        <span class="hljs-built_in">this</span>.teacherImpl = teacherImpl;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callPersonSay</span><span class="hljs-params">()</span>{
        teacherImpl.say(<span class="hljs-string">"你好ya"</span>);
    }
}
</code></pre>
<h5 data-id="heading-6">用构造器注入 对比 @Autowired注入，spring更推荐 <code>用构造器注入</code></h5>
<ul>
<li><code>@Autowired</code>注入隐藏依赖关系，代码不可靠。偷偷注入，外部看不出来; 但是<code>用构造器注入</code>一眼就知道需要哪些依赖</li>
<li><code>@Autowired</code>方式注入难以单元测试</li>
</ul>
<h3 data-id="heading-7">Bean创建过程</h3>
<p>容器启动过程中就会创建组件对象，故默认情况下组件是单例的，每次获取直接从spring容器中获取组件对象。</p>
<pre><code class="hljs">应用启动 → Bean扫描 → Bean定义注册 → 创建Bean实例 → 依赖解析 → 属性注入 → 初始化 → 使用
</code></pre>
<h3 data-id="heading-8">@ComponentScan</h3>
<p><code>@ComponentScan</code>是Spring框架中一个核心的注解，用于控制Spring容器扫描和注册Bean的范围</p>
<h5 data-id="heading-9">默认扫描规则</h5>
<p>默认会扫描<strong>当前启动类所在包及其所有子包</strong>下的组件<code>@Component</code>, <code>@Service</code>, <code>@Repository</code>, <code>@Controller</code>, <code>@Configuration</code>等。</p>
<h5 data-id="heading-10">当需要扫描非以上情况的包时，需要在启动类上使用<code>@ComponentScan</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@ComponentScan({
    "com.mycompany.app",
    "com.mycompany.common",      // 扫描公共模块
    "com.mycompany.security",    // 扫描安全模块
    "com.mycompany.service"      // 扫描服务模块
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(Application.class, args);
    }
}
</code></pre>
<h3 data-id="heading-11">@Value 给Spring Bean属性赋配置值</h3>
<p><code>@Value</code> 注解用于从各种来源配置值注入到Spring Bean的属性中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 没有PropertySource即默认取`resources`目录下的application.properties文件</span>

<span class="hljs-comment">// userDao.properties文件创建于`resources`目录下</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@PropertySource("classpath:userDao.properties")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> {
    <span class="hljs-comment">// 当不存在 key:user.dao.female 时，female的默认值为 1</span>
    <span class="hljs-meta">@Value("${user.dao.female: 1}")</span>
    <span class="hljs-keyword">private</span> String female;
}

</code></pre>
<h3 data-id="heading-12">@Profile 指定bean配置生效的环境</h3>
<ul>
<li>指定当前激活的环境</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// application.properties 文件中设置
<span class="hljs-attr">spring.profiles.active</span>=sit
</code></pre>
<ul>
<li>各个环境的bean配置</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// @Profile作用于 类      的时候，表面该类里所有的bean生效于当前环境</span>
<span class="hljs-comment">// @Profile作用于 bean方法 的时候，表面当前bean生效于当前环境</span>
<span class="hljs-meta">@Profile("dev")</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DevConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">dev</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>(<span class="hljs-string">"dev"</span>, <span class="hljs-string">"dev-wmy"</span>, <span class="hljs-string">"admin"</span>);
    }
}


<span class="hljs-meta">@Profile("sit")</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SitConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">sit</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>(<span class="hljs-string">"sit"</span>, <span class="hljs-string">"sit-wmy"</span>, <span class="hljs-string">"admin"</span>);
    }
}


<span class="hljs-comment">// 取的是当前环境生效的bean,若spring.profiles.active=sit，则当前myDataSource取的是sit的bean配置 new MyDataSource("sit", "sit-wmy", "admin");</span>
<span class="hljs-meta">@Autowired</span>
MyDataSource myDataSource;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 最新 ComfyUI 教程 - 本地部署 AI 生图模型 - Z-Image-Turbo]]></title>    <link>https://juejin.cn/post/7594667893015674895</link>    <guid>https://juejin.cn/post/7594667893015674895</guid>    <pubDate>2026-01-13T09:31:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594667893015674895" data-draft-id="7594402344618295311" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 最新 ComfyUI 教程 - 本地部署 AI 生图模型 - Z-Image-Turbo"/> <meta itemprop="keywords" content="前端,AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-13T09:31:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 最新 ComfyUI 教程 - 本地部署 AI 生图模型 - Z-Image-Turbo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:31:54.000Z" title="Tue Jan 13 2026 09:31:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>本文是用于演示通过 <code>ComfyUI</code> 工具，部署 <code>z_image_turbo_bf16</code> AI 生图模型到电脑的教程</p>
<p>官方说 Z-Image-Turbo 模型是 Z-Image 的精炼版，能在配置为 16GB GPU 显存（VRAM）中舒适运行。我的电脑显存为 8GB，但是 CPU 内存（RAM）有 32GB（当显存满了后可以适当找 CPU 借用内存，只是会显著降低速度），总的来说跑 Z-Image-Turbo 模型基本还算流畅</p>
<p>主要是在线模型要么收费贵了，要么每日扣嗖嗖的限额次数以及排队令人嫌弃，所以我打算自己部署开源模型到本地，自己随便跑，不花钱又无限制，爽歪歪</p>
<p>果然想挣咱程序员的钱是挺难的哈</p>
<p>周末抽空研究了下本地部署 AI 生图，发现 B 站 ComfyUI 相关的教程虽然多，不过都太罗嗦，并且演示的 ComfyUI 版本过于落后，我也不知道这些 up 为啥清一色的让人安装 git 和 python，并且 git 还非要配置什么环境变量，完了我也没有看到他们在哪里有用到 git 的操作（估计自己也不懂），而且基本全是 up 在评论区提供各种网盘安装包的（你敢提供我还不敢用呢，就不能老老实实提供正经的官网安装方式吗？）</p>
<p>还有 ComfyUI 官方文档也不与时俱进的更新，文档估计都是前几个版本的</p>
<p><code>所以我把新鲜的踩坑经验写了一篇教程，帮大家避坑</code></p>
<p>先给大家看演示效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f64b7aa688459eb547957ba955ce35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=JH%2FWNHv8v3FjYdilyP1TtxdHC30%3D" alt="cover1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514c506c875a4a998590ce6d807736a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=XgES7DameiGR0uWFa5H%2BVtQ7rjk%3D" alt="cover2.png" loading="lazy"/></p>
<p>上面的图片都是 Z-Image-Turbo 生成的！太惊艳了！有木有！！！</p>
<h2 data-id="heading-1">用 ComfyUI 替代 git clone github 仓库</h2>
<p>本来我是打算直接从 github 仓库下载模型部署的</p>
<p>后来了解到 ComfyUI 这玩意已经很成熟了，是目前 AI 圈最火的声明式可视化 Pipeline 编排工具（图形界面）</p>
<p>ComfyUI 内置了许多 AI 模板，我们可以直接使用</p>
<p>它把模型的加载、Clip 编码、采样器、VAE 解码等逻辑封装成了节点（Nodes）。</p>
<p><code>无需配置繁琐的工作流</code></p>
<p>我们只需要把精力放在使用模型上</p>
<p>大大节约我们的时间和提升工作的效率</p>
<h2 data-id="heading-2">ComfyUI 下载</h2>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.comfy.org%2Fzh-CN" target="_blank" title="https://docs.comfy.org/zh-CN" ref="nofollow noopener noreferrer">docs.comfy.org/zh-CN</a></p>
<p>推荐大家下载 <code>ComfyUI Portable(便携版)</code>， 便携版是一个独立封装完整的 ComfyUI Windows 版本，内部已经整合了 ComfyUI 运行所需的独立的 Python(python_embeded)，无需单独安装 Python 环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd14df5560244a68bfb61f85ddf735d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=9xo3bVJnFutgfVrFPzTsZWO4KKA%3D" alt="1.png" loading="lazy"/></p>
<p>并且便携版是免安装版本，下载后只需要解压即可使用</p>
<h2 data-id="heading-3">启动 ComfyUI</h2>
<p>双击 <code>run_nvidia_gpu.bat</code> 启动 ComfyUI</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b932df0676dc47d2a612f447e0b7c70a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=I1AWudkWyITMX6xvkK7J2itZwco%3D" alt="2.png" loading="lazy"/></p>
<p><code>注意千万不要点击 run\_cpu.bat 版本</code>，因为这个版本是用你的 CPU 跑模型（CPU 的强项是逻辑运算，让它跑 AI 会瞬间满载，发热量巨大，而且速度比显卡慢几十倍甚至上百倍）</p>
<p>run_nvidia_gpu.bat 才是让 GPU 跑模型，别问我是怎么知道的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85770bf892b04741837e399d0b78a2e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=1NnI%2B2YPzYU5SYIVJ1ZCNho3Z%2BU%3D" alt="3.png" loading="lazy"/></p>
<p>图片中是我错误的选择了显卡模式为智能，并且用 run_cpu.bat 启动 ComfyUI 运行生图功能的结果，右上角任务进度条是 0，CPU 都快撑爆了，并且温度也快到达极限，风扇狂转。可是 GPU 却不动如山，事不关己高高挂起，现在回顾感觉又好笑又好气是怎么回事 😂</p>
<p>属于 deBuff 拉满了</p>
<p>默默吐槽一下 ComfyUI 官方文档不把 run_cpu.bat 和 run_nvidia_gpu.bat 的区别写清楚，就这两句话谁看懂是个啥意思</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/384f8c6425d84ef59ebb5992a3166096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=jVKAJJ2RlJkQBDSDX7%2FVsiKwyuo%3D" alt="4.png" loading="lazy"/></p>
<p>运行成功后 ComfyUI 会自动打开你的默认浏览器并访问 <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8188" target="_blank" title="http://127.0.0.1:8188" ref="nofollow noopener noreferrer">http://127.0.0.1:8188</a> 地址</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a75e2d031e844814ab7cbf4a2ebad370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=8ss8N%2BpbtARnfcWY6bhfsTQFVGA%3D" alt="5.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25cc14f5307547bbb03260ca3981bb24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=NMAXWicY0md9geNBxtP7vTjEyMg%3D" alt="6.png" loading="lazy"/></p>
<p>注意：使用过程中请不要关闭对应的命令行窗口，否则 ComfyUI 将会停止运行</p>
<h2 data-id="heading-4">更新显卡驱动</h2>
<p>如果你是首次双击 run_nvidia_gpu.bat 启动的话，大概率会碰到这个情况</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c1416ff1284dc08ef80ec8a96bcfea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=nJ2n8n7PO5uUTdyojOeHDTrrIKc%3D" alt="7.png" loading="lazy"/></p>
<p>提示我需要更新显卡驱动啦</p>
<p><code>按 Win 键 -&gt; 输入 “NVIDIA” -&gt; 点击左侧菜单栏的“驱动程序”</code></p>
<p>如果有新版本，它会显示一个巨大的 “下载” 按钮</p>
<p>点击下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dd8f8e76628462fa99a257dacc6ba12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=3ZcG2dr1prZLbJZY%2FpXV9O4VjK0%3D" alt="8.png" loading="lazy"/></p>
<p>下载完成后，按钮会变成 “安装”，点击安装</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6963f4055d6946a4b70027aa0cd50416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=jZsC49nMWinz56lfaSAeXxEOXB8%3D" alt="9.png" loading="lazy"/></p>
<p>安装过程中屏幕可能会黑几秒，那是正常的，别紧张。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdfe5b52ec041dd9c972a73bd7fb108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=5uX7PDlJmsW46aidL%2FOCUiK%2BJXc%3D" alt="10.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94a0ee8f29a84c4092ee654b0b78291d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=r%2BVekV1%2BOpADno2yunrAuxvOBZk%3D" alt="11.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca21fdfe08e4e718d618267d6a2af6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=E365YBKTs4fiqaSrPMinaXbL4oY%3D" alt="12.png" loading="lazy"/></p>
<p>现在安装成功了</p>
<p>然后重新双击 <code>run_nvidia_gpu.bat</code> 即可启动 ComfyUI</p>
<h2 data-id="heading-5">下载使用 Z-Image-Turbo 模型</h2>
<p>操作步骤：模板 -&gt; 所有模板 -&gt; 输入框输入 Z-Image-Turbo -&gt; 点击第一个</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d5c1adfd24c466a93ea5a3e23aa85f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=5dbyEdFMx2qMWsAmJ9%2BbHAapsfE%3D" alt="13.png" loading="lazy"/></p>
<p>如果 ComfyUI 未找到对应的模型会提示下载，并显示缺少的模型以及文件大小</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b0dd82e7734354a9463b32e9d45515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=rgMlWbg8MSwJXClosb0kPR0e%2BRc%3D" alt="14.png" loading="lazy"/></p>
<p>如果没开启梯子的话，模型的文件大小会变成问号</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34da90bc305c4c9bbfd0d7edaa7955a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=D%2BV8UHJf61PO3sZoIe4W0nE6wBs%3D" alt="15.png" loading="lazy"/></p>
<p>说明什么，说明如果直接点击下载的话，是需要花费你的梯子流量的，别问我是怎么知道的/(ㄒ o ㄒ)/~~</p>
<p>如果你现在挂着梯子的话，<code>千万不要直接点击下载呀！</code></p>
<p>当然，聪明的我立马想到了对策</p>
<p>下面教大家如何用国内流量下载模型</p>
<h2 data-id="heading-6">国内下载模型</h2>
<p>点击 <code>复制链接</code> 按钮，获取到需要下载的三个模型原始的下载链接：</p>
<ul>
<li>
<p>z_image_turbo_bf16</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fdiffusion_models%2Fz_image_turbo_bf16.safetensors" target="_blank" title="https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/diffusion_models/z_image_turbo_bf16.safetensors" ref="nofollow noopener noreferrer">huggingface.co/Comfy-Org/z…</a></p>
</li>
</ul>

<ul>
<li>
<p>qwen_3_4b</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Ftext_encoders%2Fqwen_3_4b.safetensors" target="_blank" title="https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/text_encoders/qwen_3_4b.safetensors" ref="nofollow noopener noreferrer">huggingface.co/Comfy-Org/z…</a></p>
</li>
<li>
<p>ae</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fvae%2Fae.safetensors" target="_blank" title="https://huggingface.co/Comfy-Org/z_image_turbo/resolve/main/split_files/vae/ae.safetensors" ref="nofollow noopener noreferrer">huggingface.co/Comfy-Org/z…</a></p>
</li>
</ul>
<p>在国内可以通过<code>魔搭社区</code>下载模型，需要把前面的域名进行更换：将<code>https://huggingface.co</code>更换为<code> https://modelscope.cn/models</code></p>
<p>以下是需要下载的三个模型国内的下载链接：</p>
<ul>
<li>
<p>z_image_turbo_bf16</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fdiffusion_models%2Fz_image_turbo_bf16.safetensors" target="_blank" title="https://modelscope.cn/models/Comfy-Org/z_image_turbo/resolve/main/split_files/diffusion_models/z_image_turbo_bf16.safetensors" ref="nofollow noopener noreferrer">modelscope.cn/models/Comf…</a></p>
</li>
</ul>

<ul>
<li>
<p>qwen_3_4b</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Ftext_encoders%2Fqwen_3_4b.safetensors" target="_blank" title="https://modelscope.cn/models/Comfy-Org/z_image_turbo/resolve/main/split_files/text_encoders/qwen_3_4b.safetensors" ref="nofollow noopener noreferrer">modelscope.cn/models/Comf…</a></p>
</li>
<li>
<p>ae</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2FComfy-Org%2Fz_image_turbo%2Fresolve%2Fmain%2Fsplit_files%2Fvae%2Fae.safetensors" target="_blank" title="https://modelscope.cn/models/Comfy-Org/z_image_turbo/resolve/main/split_files/vae/ae.safetensors" ref="nofollow noopener noreferrer">modelscope.cn/models/Comf…</a></p>
</li>
</ul>
<p>我已给你转换好了直接用浏览器打开即可下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4dbd5d59eb140be91dad10bc5c04b22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=4SFkuQUnds5aWZJs9tGveYdWxdQ%3D" alt="16.png" loading="lazy"/></p>
<p>不用在意那个（1），是因为我本地已经下载过了，你们首次下载的文件名是不会多这个值的</p>
<p>下载完后将模型文件放在到对应的文件夹，对应的文件夹在哪里？官方文档没写清楚，我自己摸索搞懂的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b0dd82e7734354a9463b32e9d45515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=rgMlWbg8MSwJXClosb0kPR0e%2BRc%3D" alt="14.png" loading="lazy"/></p>
<p>从前面提示下载模型的界面可以找到线索</p>
<p>z_image_turbo_bf16.safetensors 模型要放在 diffusion_models 文件夹</p>
<p>qwen_3_4b.safetensors 模型要放在 text_encoders 文件夹</p>
<p>ae.safetensors 模型要放在 vae 文件夹</p>
<h2 data-id="heading-7">万事俱备，开始生成图片吧！</h2>
<p>准备工作搞了这么久，现在让我们开始生成图片吧！</p>
<p>操作步骤：模板 -&gt; 所有模板 -&gt; 输入框输入 Z-Image-Turbo -&gt; 点击第一个</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d5c1adfd24c466a93ea5a3e23aa85f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=5dbyEdFMx2qMWsAmJ9%2BbHAapsfE%3D" alt="13.png" loading="lazy"/></p>
<p>输入提示词：生成一只可爱的小猫咪在户外玩耍，点击运行</p>
<p>tip: 分辨率可以先调低一点，跑通后再根据你的显卡配置慢慢提高</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed275b16ef484662b6ca5fec3e1f4410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=fzmkC20eKYZCU%2FpurSvlykgdkcg%3D" alt="17.png" loading="lazy"/></p>
<p>不出意外的话会报错，因为我们没有连接图片节点</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7727553f2e6847828f851b2133bbf16a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=27n8uB2p%2FRUVGmRcP27%2BJpJS%2F%2BE%3D" alt="18.png" loading="lazy"/></p>
<p>将左侧的蓝色小圆点拖动到右侧即可连接</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4c938f150474f63a35e084a1238393e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=GGEcLlNLceFH6GJ4BpJa9hIYZiQ%3D" alt="19.png" loading="lazy"/></p>
<p>连接成功，点击运行，右侧进度条跑完后图片就会生成</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d483498ef51446b80f518dc1e174650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=7mBcKx59eLXGgfCXyTcgpjw7BaU%3D" alt="20.png" loading="lazy"/></p>
<p>在 ComfyUI 左侧菜单栏点击资产，可以看到当前生成的图片，喜欢的话就点击下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83e3da362e4c489cb8d6785b12f99ab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=gdAL07K5Ji9EhfmHIaDC86dDnTo%3D" alt="21.png" loading="lazy"/></p>
<p>也可以直接去 ComfyUI 安装目录找，所有生成的图片都在 <code>output</code> 目录下</p>
<p>路径为：“你的 ComfyUI 安装目录”/ComfyUI/output</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18361f966177408ebd461a0757a99579~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=tDbrPOkDEQv3mVYAXr8S5ehFMbc%3D" alt="22.png" loading="lazy"/></p>
<h2 data-id="heading-8">ComfyUI 官方提供的 Z-Image Turbo 示例工作流</h2>
<p>到底为止，我们已经成功使用 Z-Image 生成图片啦，但是你把提示词变复杂了就会发现，可能效果不是那么令人满意</p>
<p>那是因为我们只是使用的最简单的工作流，是为了快速验证 AI 模型部署成功</p>
<p>下面我们使用 ComfyUI 官方提供的 Z-Image Turbo 示例工作流</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcomfyanonymous.github.io%2FComfyUI_examples%2Fz_image%2F" target="_blank" title="https://comfyanonymous.github.io/ComfyUI_examples/z_image/" ref="nofollow noopener noreferrer">comfyanonymous.github.io/ComfyUI_exa…</a></p>
<p>打开链接，保存图片</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8319261f36804113801a02e8165c169f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=hk5sWYOa9f874WS7hEoa8LkAeYQ%3D" alt="23.png" loading="lazy"/></p>
<p>将下载的图片直接拖入 ComfyUI 中即可加载 Z-Image Turbo 示例工作流</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f301231f684d4f8784998b0bc2f3ca57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=o4adBIBHg%2FjsS0tMpZtujeM94aA%3D" alt="24.png" loading="lazy"/></p>
<p>查看运行后的效果，在资产里面还可以看见生图的耗时，比小猫咪还快一些也</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9edb56bc13584e3a885fcb68ad02eb3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=aKtRGcpzWZiTViHL4okGPpSMvZg%3D" alt="25.png" loading="lazy"/></p>
<p>并且中文也没有乱码！这一点是非常棒的！</p>
<p>tip：所有用 ComfyUI 生成的图片，都会带有 metadata 信息，这些信息会包含图片的 workflow 信息，你可以通过这些信息来加载对应的 workflow。</p>
<h2 data-id="heading-9">通过 ip 在局域网打开 ComfyUI</h2>
<p>默认只能通过 <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8188%2F" target="_blank" title="http://127.0.0.1:8188/" ref="nofollow noopener noreferrer">http://127.0.0.1:8188/</a> 地址启动 ComfyUI 服务</p>
<p>记事本打开 run_nvidia_gpu.bat 脚本文件，末尾加一个参数 --listen 0.0.0.0</p>
<pre><code class="hljs language-txt" lang="txt">--listen 0.0.0.0
</code></pre>
<p>它告诉 Python 监听机器上所有的网络接口，而不仅仅是 127.0.0.1。</p>
<p>保存后重启就可以通过局域网 ip + 8188 端口进行访问了</p>
<h2 data-id="heading-10">Z-Image-Turbo 提示词资源</h2>
<p>人像生成功能真的太强了，足以以假乱真了 😂</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f64b7aa688459eb547957ba955ce35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=JH%2FWNHv8v3FjYdilyP1TtxdHC30%3D" alt="cover1.png" loading="lazy"/></p>
<p>这是提示词</p>
<pre><code class="hljs language-md" lang="md">{
"prompt<span class="hljs-emphasis">_data": {
"subject": {
"description": "Young woman with long, wavy blonde hair and a light fair skin",
"features": "Natural skin texture with visible tan lines on the chest, slight flush on cheeks, soft smile, navel piercing, light freckles.",
"accessories": "Gold pendant necklace, small gold hoop earrings, small tattoo on the left inner forearm."
},
"clothing": {
"outfit": "Matching yellow two-piece loungewear set.",
"top": "Yellow strapless tube top featuring the text 'HAWAIIAN TROPIC' in brown serif font with a hibiscus flower and palm graphic on the side.",
"bottoms": "Matching yellow shorts visible at the waist and thigh area."
},
"pose_</span>and<span class="hljs-emphasis">_action": {
"posture": "Reclining and lounging comfortably on a grey textured sofa.",
"body_</span>language": "Relaxed and casual, leaning back against the couch cushions, one arm extended to support weight, the other hand resting gently near the waist, legs angled toward the camera.",
"expression": "Friendly, relaxed, and engaging eye contact."
},
"environment": {
"setting": "Modern living room interior.",
"furniture": "Dark grey fabric sofa with a textured weave.",
"background": "Grey walls with decorative panel molding (wainscoting).",
"decor": "A large vertical art piece with a red background featuring KAWS-style figures in blue and black. A second framed abstract art piece with gold and black tones. A modern linear wall sconce light."
},
"lighting": {
"type": "Soft, diffused indoor mix.",
"quality": "Warm ambient lighting highlighting the skin tone, creating soft shadows and a cozy atmosphere. Likely a mix of natural window light and the warm glow from the wall sconce."
},
"styling<span class="hljs-emphasis">_and_</span>mood": {
"aesthetic": "Influencer lifestyle, casual home comfort, '2000s digital camera' vibe.",
"mood": "Chill, playful, confident, comfortable."
},
"camera<span class="hljs-emphasis">_specifications": {
"angle": "Eye-level, slightly angled from the side.",
"focus": "Sharp focus on the subject's face and torso, with a slight depth of field blurring the background artwork.",
"lens_</span>suggestion": "35mm or 50mm portrait lens.",
"film<span class="hljs-emphasis">_grain": "Low to medium ISO for a clean but slightly organic digital look."
},
"technical_</span>modifiers": [
"Ultra Photorealistic",
"8k resolution",
"Raw photo",
"Hyper-detailed skin texture",
"Subsurface scattering",
"Volumetric lighting",
"Nano Banana Pro optimized",
"Masterpiece"
]
}
} 2:3
</code></pre>
<p>另外给大家分享 github 提示词合集：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcamenduru%2Fawesome-z-image-turbo" target="_blank" title="https://github.com/camenduru/awesome-z-image-turbo" ref="nofollow noopener noreferrer">github.com/camenduru/a…</a></p>
<p>宝藏仓库！目前为止有一百个 Z-Image-Turbo 生图的提示词，并且有 Z-Image-Turbo，Gemini 和 GPT-4o 三者用同一个提示词生成的效果对比！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42ebedda86ed46ef8d16e856561b9fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=8sqXAF96CjPgAYYSrYroEBZVgRo%3D" alt="26.png" loading="lazy"/></p>
<h2 data-id="heading-11">Z-Image-Turbo 官方提示增强（PE）模板</h2>
<p>这个功能我还没试过，大家自行研究吧，完了能告诉我反馈效果最好哈哈哈</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32303076f744beab1da1f783365e408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768901514&amp;x-signature=2Cp1lZG%2BbBwnk4tUTOx2%2BdRuccE%3D" alt="27.png" loading="lazy"/></p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fspaces%2FTongyi-MAI%2FZ-Image-Turbo%2Fblob%2Fmain%2Fpe.py" target="_blank" title="https://huggingface.co/spaces/Tongyi-MAI/Z-Image-Turbo/blob/main/pe.py" ref="nofollow noopener noreferrer">huggingface.co/spaces/Tong…</a></p>
<p>考虑到有的朋友可能无法访问 huggingface，所以我贴心的把内容复制下来了</p>
<pre><code class="hljs language-md" lang="md">prompt<span class="hljs-emphasis">_template = """
你是一位被关在逻辑牢笼里的幻视艺术家。你满脑子都是诗和远方，但双手却不受控制地只想将用户的提示词，转化为一段忠实于原始意图、细节饱满、富有美感、可直接被文生图模型使用的终极视觉描述。任何一点模糊和比喻都会让你浑身难受。
你的工作流程严格遵循一个逻辑序列：
首先，你会分析并锁定用户提示词中不可变更的核心要素：主体、数量、动作、状态，以及任何指定的 IP 名称、颜色、文字等。这些是你必须绝对保留的基石。
接着，你会判断提示词是否需要<span class="hljs-strong">**"生成式推理"**</span>。当用户的需求并非一个直接的场景描述，而是需要构思一个解决方案（如回答"是什么"，进行"设计"，或展示"如何解题"）时，你必须先在脑中构想出一个完整、具体、可被视觉化的方案。这个方案将成为你后续描述的基础。
然后，当核心画面确立后（无论是直接来自用户还是经过你的推理），你将为其注入专业级的美学与真实感细节。这包括明确构图、设定光影氛围、描述材质质感、定义色彩方案，并构建富有层次感的空间。
最后，是对所有文字元素的精确处理，这是至关重要的一步。你必须一字不差地转录所有希望在最终画面中出现的文字，并且必须将这些文字内容用英文双引号（""）括起来，以此作为明确的生成指令。如果画面属于海报、菜单或 UI 等设计类型，你需要完整描述其包含的所有文字内容，并详述其字体和排版布局。同样，如果画面中的招牌、路标或屏幕等物品上含有文字，你也必须写明其具体内容，并描述其位置、尺寸和材质。更进一步，若你在推理构思中自行增加了带有文字的元素（如图表、解题步骤等），其中的所有文字也必须遵循同样的详尽描述和引号规则。若画面中不存在任何需要生成的文字，你则将全部精力用于纯粹的视觉细节扩展。
你的最终描述必须客观、具象，严禁使用比喻、情感化修辞，也绝不包含"8K"、"杰作"等元标签或绘制指令。
仅严格输出最终的修改后的 prompt，不要输出任何其他内容。
用户输入 prompt: {prompt}
"""
</span></code></pre>
<h2 data-id="heading-12">一些优化操作</h2>
<p>在开始之前，总结一下能做的优化操作</p>
<ol>
<li>
<p><code>连接电源</code>：确保电源适配器已插好（不插电跑 AI，性能会缩水）</p>
</li>
<li>
<p><code>显卡模式</code>：需要将显卡模式调整为独显，只有调整之后你的显卡才算生效了，否则就是在消极怠工。不同电脑的界面和调整方式不同，自行搜索如何调整</p>
</li>
<li>
<p><code>给 CPU “限速”</code>： 按 win 键 -&gt; 搜“编辑电源计划” -&gt; “更改高级电源设置” -&gt; “处理器电源管理”。 将 “最大处理器状态”从 100% 改为 99%。这样可以强行关闭 CPU 的自动超频（Turbo Boost），温度能瞬间掉下来 10-20°C，而跑 AI 的速度几乎不受影响。</p>
</li>
<li>
<p><code>电脑散热</code>：笔记本电脑买一个普通的钢质散热架（不用吹风那种），如果没有的话拿两个瓶盖或者两本书垫高凑合用，空气流量增加有助于散热降温</p>
</li>
<li>
<p><code>启动方式</code>：双击 <code>run_nvidia_gpu.bat</code> 启动 ComfyUI，千万千万别点 run_cpu.bat</p>
</li>
<li>
<p><code>从小分辨率开始测试</code>： 先在 ComfyUI 里把 Empty Latent Image 的分辨率降到 512x512。确认能跑通、显存能装下，再慢慢往上提。</p>
</li>
<li>
<p><code>开启低显存模式</code>：在启动 ComfyUI 的快捷方式（bat 文件）里，加入 --lowvram 参数。它会让 ComfyUI 在加载模型时采用“分片加载”策略，这能让它在 8GB 卡上跑得更顺畅。</p>
</li>
<li>
<p><code>减小批量大小</code>：运行模型时，可以调低 批量大小，这有助于减少每次推理或训练时的显存需求。</p>
</li>
</ol>
<h2 data-id="heading-13">注意事项</h2>
<p>AI 模型运行时，注意观察 CPU 和 GPU 的温度，如果温度异常请及时关闭运行中的 AI 任务，避免烧坏显卡</p>























<table><thead><tr><th>硬件</th><th>正常区 (AI 渲染中)</th><th>警戒区 (需关注)</th><th>红线区 (建议停止)</th></tr></thead><tbody><tr><td>CPU (AMD)</td><td>75°C - 90°C</td><td>90°C - 95°C</td><td>100°C +</td></tr><tr><td>GPU (NVIDIA)</td><td>65°C - 80°C</td><td>83°C - 87°C</td><td>90°C +</td></tr></tbody></table>
<h2 data-id="heading-14">结语</h2>
<p>先写到这里吧，目前为止的内容已经够 ComfyUI 本地部署 Z-Image-Turbo 入门了</p>
<p>如果有人喜欢的话，过两天我再更新 Z-Image-Turbo 进阶使用教程</p>



</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MYSQL进阶：删除视图时视图被lock解决方案]]></title>    <link>https://juejin.cn/post/7594533204003405887</link>    <guid>https://juejin.cn/post/7594533204003405887</guid>    <pubDate>2026-01-13T08:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594533204003405887" data-draft-id="7594642978695282751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MYSQL进阶：删除视图时视图被lock解决方案"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2026-01-13T08:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="壹米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4178616274387758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MYSQL进阶：删除视图时视图被lock解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4178616274387758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    壹米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:16:54.000Z" title="Tue Jan 13 2026 08:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>mysql 8.0 删除视图时 DROP VIEW <code>dev_licos_kmlc_yt</code>.<code>view_pro_product_distribution_cathode_copper_details_v2</code> 报错？ Waiting for table metadata lock</p>
<h2 data-id="heading-1">解决方案</h2>
<p>你在 MySQL 8.0 中执行 <code>DROP VIEW</code> 时遇到 <strong>“Waiting for table metadata lock”</strong> 错误，说明该视图（或其依赖的表）当前被其他会话持有元数据锁（metadata lock），导致你的 DROP 操作被阻塞。</p>
<hr/>
<h3 data-id="heading-2">🔍 原因分析</h3>
<p>在 MySQL 中，<strong>任何对表结构或视图的操作（如 DROP、ALTER、CREATE）都需要获取元数据锁（MDL）</strong> 。如果另一个会话正在：</p>
<ul>
<li>执行一个长时间运行的查询（SELECT/INSERT/UPDATE/DELETE）涉及该视图或其基表；</li>
<li>开启了一个事务但未提交，并且事务中使用了该视图或相关表；</li>
<li>正在执行 DDL（如 ALTER TABLE）等操作；</li>
</ul>
<p>那么你的 <code>DROP VIEW</code> 就会一直等待，直到那个会话释放锁。</p>
<blockquote>
<p>注意：<strong>即使视图本身不包含数据，只要它引用的基表被锁定，DROP VIEW 也会被阻塞。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">✅ 解决方法</h3>
<h4 data-id="heading-4">1. <strong>查找阻塞的会话</strong></h4>
<p>登录 MySQL，执行以下语句查看当前元数据锁等待情况：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT * FROM performance_schema.metadata_locks 
WHERE <span class="hljs-attr">OBJECT_SCHEMA</span> = <span class="hljs-string">'dev_licos_kmlc_yt'</span> 
  AND <span class="hljs-attr">OBJECT_NAME</span> = <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span><span class="hljs-comment">;</span>
</code></pre>
<p>或者更通用的方式：查看所有等待或持有 MDL 的线程：</p>
<pre><code class="hljs language-css" lang="css">SELECT 
    r<span class="hljs-selector-class">.trx_id</span> waiting_trx_id,
    r<span class="hljs-selector-class">.trx_mysql_thread_id</span> waiting_thread,
    r<span class="hljs-selector-class">.trx_query</span> waiting_query,
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_id</span> blocking_trx_id,
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_mysql_thread_id</span> blocking_thread,
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_query</span> blocking_query
<span class="hljs-selector-tag">FROM</span> 
    information_schema<span class="hljs-selector-class">.innodb_lock_waits</span> w
INNER JOIN 
    information_schema<span class="hljs-selector-class">.innodb_trx</span> <span class="hljs-selector-tag">b</span> ON <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.trx_id</span> = w<span class="hljs-selector-class">.blocking_trx_id</span>
INNER JOIN 
    information_schema<span class="hljs-selector-class">.innodb_trx</span> r ON r<span class="hljs-selector-class">.trx_id</span> = w<span class="hljs-selector-class">.requesting_trx_id</span>;
</code></pre>
<blockquote>
<p>⚠️ 注意：上面这个查的是 InnoDB 行锁，不一定适用于元数据锁。更准确的是用 <code>performance_schema</code>：</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">-- 启用 performance_schema（默认已启用）
SELECT 
    pl.processlist_id AS blocked_pid,
    pl.info AS blocked_sql,
    ml.lock_type,
    ml.lock_status,
    ml.owner_thread_id
FROM 
    performance_schema.metadata_locks ml
JOIN 
    performance_schema.threads t ON <span class="hljs-attr">ml.owner_thread_id</span> = t.thread_id
JOIN 
    information_schema.processlist pl ON <span class="hljs-attr">t.processlist_id</span> = pl.id
WHERE 
    <span class="hljs-attr">ml.object_schema</span> = <span class="hljs-string">'dev_licos_kmlc_yt'</span>
    AND <span class="hljs-attr">ml.object_name</span> = <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span>
    AND <span class="hljs-attr">ml.lock_status</span> = <span class="hljs-string">'PENDING'</span><span class="hljs-comment">;</span>
</code></pre>
<p>也可以直接看谁持有该对象的锁：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT 
    pl.id AS process_id,
    pl.user,
    pl.host,
    pl.db,
    pl.command,
    pl.time AS duration_seconds,
    pl.state,
    pl.info AS current_sql
FROM 
    performance_schema.metadata_locks ml
JOIN 
    performance_schema.threads t ON <span class="hljs-attr">ml.owner_thread_id</span> = t.thread_id
JOIN 
    information_schema.processlist pl ON <span class="hljs-attr">t.processlist_id</span> = pl.id
WHERE 
    <span class="hljs-attr">ml.object_schema</span> = <span class="hljs-string">'dev_licos_kmlc_yt'</span>
    AND <span class="hljs-attr">ml.object_name</span> = <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span>
    AND <span class="hljs-attr">ml.lock_status</span> = <span class="hljs-string">'GRANTED'</span><span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5">2. <strong>终止阻塞的会话</strong></h4>
<p>找到阻塞的 <code>process_id</code>（即 <code>pl.id</code>），然后 kill 它：</p>
<pre><code class="hljs language-ini" lang="ini">KILL &lt;process_id&gt;<span class="hljs-comment">;</span>
</code></pre>
<p>例如：</p>
<pre><code class="hljs language-ini" lang="ini">KILL 12345<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>⚠️ 谨慎操作！确保该会话可以被安全终止（比如是空闲连接、测试查询等）。</p>
</blockquote>
<h4 data-id="heading-6">3. <strong>预防措施</strong></h4>
<ul>
<li>避免在业务高峰期执行 DDL（包括 DROP VIEW）。</li>
<li>确保应用中的事务及时提交，不要长时间开启事务。</li>
<li>对于只读查询，尽量使用短连接或设置 <code>autocommit=1</code>。</li>
<li>监控长时间运行的查询：<code>SHOW PROCESSLIST;</code></li>
</ul>
<hr/>
<h3 data-id="heading-7">💡 补充说明</h3>
<ul>
<li>视图本身不存储数据，但 <strong>MySQL 在 DROP VIEW 时仍需检查其定义和依赖关系</strong>，因此需要对基表加共享元数据锁。</li>
<li>即使视图未被直接使用，只要其基表被某个会话锁定，DROP VIEW 也可能被阻塞。</li>
</ul>
<hr/>
<h3 data-id="heading-8">✅ 总结</h3>
<p>你遇到的问题是典型的 <strong>元数据锁等待</strong>。解决步骤：</p>
<ol>
<li>使用 <code>performance_schema.metadata_locks</code> 找出谁持有了锁；</li>
<li>通过 <code>information_schema.processlist</code> 找到对应会话 ID；</li>
<li>必要时 <code>KILL</code> 阻塞会话；</li>
<li>再次执行 <code>DROP VIEW</code>。</li>
</ol>
<p>我使用的的是这个语句：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    pl.id <span class="hljs-keyword">AS</span> process_id,
    pl.user,
    pl.host,
    pl.db,
    pl.command,
    pl.time <span class="hljs-keyword">AS</span> duration_seconds,
    pl.state,
    pl.info <span class="hljs-keyword">AS</span> current_sql
<span class="hljs-keyword">FROM</span> 
    performance_schema.metadata_locks ml
<span class="hljs-keyword">JOIN</span> 
    performance_schema.threads t <span class="hljs-keyword">ON</span> ml.owner_thread_id <span class="hljs-operator">=</span> t.thread_id
<span class="hljs-keyword">JOIN</span> 
    information_schema.processlist pl <span class="hljs-keyword">ON</span> t.processlist_id <span class="hljs-operator">=</span> pl.id
<span class="hljs-keyword">WHERE</span> 
    ml.object_schema <span class="hljs-operator">=</span> <span class="hljs-string">'dev_licos_kmlc_yt'</span>
    <span class="hljs-keyword">AND</span> ml.object_name <span class="hljs-operator">=</span> <span class="hljs-string">'view_pro_product_distribution_cathode_copper_details_v2'</span>
    <span class="hljs-keyword">AND</span> ml.lock_status <span class="hljs-operator">=</span> <span class="hljs-string">'GRANTED'</span>;
</code></pre>
<p>然后查询出process_id，最终使用kill把阻塞会话杀掉，问题解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java+MySQL时区难题-Date自动转换String差8小时]]></title>    <link>https://juejin.cn/post/7594626381432602674</link>    <guid>https://juejin.cn/post/7594626381432602674</guid>    <pubDate>2026-01-13T08:30:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594626381432602674" data-draft-id="7594482829755072558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java+MySQL时区难题-Date自动转换String差8小时"/> <meta itemprop="keywords" content="数据库,MySQL"/> <meta itemprop="datePublished" content="2026-01-13T08:30:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="conca"/> <meta itemprop="url" content="https://juejin.cn/user/2191756017557851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java+MySQL时区难题-Date自动转换String差8小时
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2191756017557851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    conca
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:30:23.000Z" title="Tue Jan 13 2026 08:30:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> SELECT COUNT(*) as visit_count FROM weblog where start_time &gt;='2026-01-01 00:00:00' and start_time &lt; '2026-01-02 00:00:00' GROUP BY url 这个sql代码中传参数start_time如果是字符串就会差8小时，如果start_time传值date类型，则不会差8小时。以前都是传值Date，今天突然发现这个问题，登录到mysql数据库查看数据，发现表中数据也差8小时。为什么呢？</p>
<h3 data-id="heading-0">一、分别查看操作系统、MySQL、JVM 时区</h3>
<h4 data-id="heading-1">1. 查看操作系统时区</h4>
<p>不同操作系统的查询命令不同，核心是获取系统的默认时区：</p>
<p>Windows 系统，命令行：打开 CMD/PowerShell，执行以下命令，显示使用东八区时间（如中国标准时间 CST）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7e83562a618486aabda63d9ab778dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29uY2E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768897823&amp;x-signature=%2FfIJmIELVhaNGj%2FfL%2FpN2JWnoqI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-2">2. 查看 MySQL 5.7 时区</h4>
<p>MySQL 的时区分为「全局时区」和「会话时区」，两种都需要验证，可通过 MySQL 客户端（navicat、sqlyog、mysql 命令行）执行 SQL 查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 方法1：同时查看全局时区（global_time_zone）和会话时区（session_time_zone）</span>
<span class="hljs-keyword">show</span> variables <span class="hljs-keyword">like</span> <span class="hljs-string">'%time_zone%'</span>;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96c47c7430384e9ba87161d4c00bb798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29uY2E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768897823&amp;x-signature=lfgxLQw%2BLbwAj1VLqq5GJeba24s%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<ul>
<li>MySQL 5.7 默认时区通常为 <code>SYSTEM</code>（表示跟随操作系统时区）；系统默认时区是<code>UTC+8 北京</code></li>
<li>若查询结果中 <code>time_zone</code> 为 <code>UTC</code>，则表示 MySQL 直接使用 UTC 时区，不跟随系统。</li>
</ul>
<h4 data-id="heading-3">3. 查看 JVM 时区</h4>
<p>JVM 时区是 Java 程序运行时的默认时区，有 3 种常用查询方式，适配 Jboot 框架场景：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.TimeZone;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeZoneTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 方法1：获取JVM默认时区（显示时区ID，如 Asia/Shanghai）</span>
        <span class="hljs-type">TimeZone</span> <span class="hljs-variable">defaultTimeZone</span> <span class="hljs-operator">=</span> TimeZone.getDefault();
        System.out.println(<span class="hljs-string">"JVM 默认时区 ID："</span> + defaultTimeZone.getID());
        System.out.println(<span class="hljs-string">"JVM 默认时区名称："</span> + defaultTimeZone.getDisplayName());
        
        <span class="hljs-comment">// 方法2：Java 8+ 新增方式，更简洁</span>
        java.time.<span class="hljs-type">ZoneId</span> <span class="hljs-variable">zoneId</span> <span class="hljs-operator">=</span> java.time.ZoneId.systemDefault();
        System.out.println(<span class="hljs-string">"JVM 默认时区（Java 8+）："</span> + zoneId);
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>java打印结果模式使用的东八区时间（如中国标准时间 CST）UTC+8 北京</p>
<p>JVM 默认时区 ID：Asia/Shanghai<br/>
JVM 默认时区名称：中国标准时间<br/>
JVM 默认时区（Java 8+）：Asia/Shanghai</p>
<h3 data-id="heading-4">二、关键注意点：你的 MySQL 连接 URL 配置分析</h3>
<p>系统配置的 URL：<code>jdbc:mysql://127.0.0.1:3306/dbname?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC</code></p>
<p>其中 <code>serverTimezone=UTC</code> 是<strong>JDBC 驱动与 MySQL 服务器通信时使用的时区</strong>，核心注意点：该配置仅作用于「Java 程序（Jboot）←→MySQL 服务器」的连接层，不会改变 MySQL 的全局 / 会话时区，也不会改变 JVM 和操作系统的时区；</p>
<p>时区转换的执行载体是「MySQL JDBC 驱动 jar 包」（不是 Java 客户端业务代码，也不是 MySQL 服务器端），<code>serverTimezone=UTC</code> 这个配置的作用域仅在<strong>JDBC 驱动（mysql-connector-java）</strong> 内部，所有与时区相关的时间转换、适配，都是在驱动 jar 中完成的，与 Java 业务代码、MySQL 服务器本身无直接关联。</p>
<h3 data-id="heading-5">三、代码验证时区问题</h3>
<p>场景 1：统计某天访问量，如果开始时间和结束时间用字符串转值，开始时间"2026-01-01"，结束时间"2026-01-02"</p>
<pre><code class="hljs language-ini" lang="ini">public Integer count(String start_time, String end_time) {
		StringBuilder <span class="hljs-attr">sql</span> = new StringBuilder()<span class="hljs-comment">;</span>
        sql.append("SELECT COUNT(*) as visit_count FROM weblog WHERE start_time &gt;= ? AND start_time &lt;?")<span class="hljs-comment">;</span>
        List&lt;Object&gt; <span class="hljs-attr">paras</span> = new ArrayList&lt;Object&gt;()<span class="hljs-comment">;</span>
        paras.add(0, end_time)<span class="hljs-comment">;</span>
        paras.add(0, start_time)<span class="hljs-comment">;</span>
        Weblog <span class="hljs-attr">weblog</span> =(Weblog)weblogDao.getDao().findFirst(sql.toString(), paras.toArray())<span class="hljs-comment">;</span>
        return weblog.getInt("visit_count")<span class="hljs-comment">;</span>
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这种场景下，<strong>没有经过 JDBC 驱动的时区转换</strong>，偏差的产生流程如下：</p>
<ol>
<li>Java 客户端直接将字符串格式的时间值，原封不动地通过 JDBC 连接发送给 MySQL 服务器（驱动仅做数据透传，不进行任何时间解析和时区转换）；</li>
<li>MySQL 服务器接收到字符串后，会按照「自身的全局 / 会话时区」（东八区）来解析这个字符串，将其转换为 MySQL 内部存储的时间格式（TIMESTAMP/DATETIME）；</li>
<li>简单说：字符串参数是「裸传」，驱动不处理，直接落地到 MySQL 服务器按其自身时区解析，与 <code>serverTimezone=UTC</code> 配置无关，进而出现偏差。</li>
</ol>
<p>场景 2：统计某天访问量，如果开始时间和结束时间用Date转值，开始时间Date(2026-01-01)，结束时间Date(2026-01-02)</p>
<pre><code class="hljs language-ini" lang="ini">public Integer count(Date start_time, Date end_time) {
		StringBuilder <span class="hljs-attr">sql</span> = new StringBuilder()<span class="hljs-comment">;</span>
        sql.append("SELECT COUNT(*) as visit_count FROM weblog WHERE start_time &gt;= ? AND start_time &lt;?")<span class="hljs-comment">;</span>
        List&lt;Object&gt; <span class="hljs-attr">paras</span> = new ArrayList&lt;Object&gt;()<span class="hljs-comment">;</span>
        paras.add(0, end_time)<span class="hljs-comment">;</span>
        paras.add(0, start_time)<span class="hljs-comment">;</span>
        Weblog <span class="hljs-attr">weblog</span> =(Weblog)weblogDao.getDao().findFirst(sql.toString(), paras.toArray())<span class="hljs-comment">;</span>
        return weblog.getInt("visit_count")<span class="hljs-comment">;</span>
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这种场景下，<strong>JDBC 驱动会主动进行时区转换</strong>，保证时间一致性，流程如下：</p>
<ol>
<li>Java 客户端将 <code>Date</code> 类型的时间对象传递给 JDBC 驱动（日期类型本身是「时间戳（long 型，从 1970-01-01 00:00:00 UTC 开始的毫秒数）」，与时区无关，是绝对时间）；</li>
<li>JDBC 驱动接收到这个时间戳后，会读取 URL 中的 <code>serverTimezone=UTC</code> 配置，将时间戳<strong>从 JVM 默认时区（东八区）转换为 UTC 时区</strong>；</li>
<li>驱动将转换后的 UTC 时间，封装为 MySQL 服务器可识别的时间格式，发送给 MySQL 服务器；</li>
<li>简单说：日期类型参数会被驱动拦截，驱动基于 <code>serverTimezone=UTC</code> 完成「JVM 时区 ↔ 通信时区（UTC）」的转换，再与 MySQL 服务器交互。增加操作和查询操作都试用日期格式，驱动都会转换时间，所以用户没有在页面发现时间差问题。</li>
</ol>
<h3 data-id="heading-6">四、时区转换代码分析</h3>
<p>com.jfinal.plugin.activerecord.Model</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
	 * Find first model. I recommend add "limit 1" in your sql.
	 * <span class="hljs-doctag">@param</span> sql an SQL statement that may contain one or more '?' IN parameter placeholders
	 * <span class="hljs-doctag">@param</span> paras the parameters of sql
	 * <span class="hljs-doctag">@return</span> <span class="hljs-variable">Model</span>
	 */</span>
	<span class="hljs-keyword">public</span> M <span class="hljs-title function_">findFirst</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql, <span class="hljs-built_in">Object</span>... paras</span>) {
		<span class="hljs-title class_">List</span>&lt;M&gt; result = <span class="hljs-title function_">find</span>(sql, paras);
		<span class="hljs-keyword">return</span> result.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">0</span> ? result.<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>) : <span class="hljs-literal">null</span>;
	}

<span class="hljs-comment">/**
	 * Find model.
	 * <span class="hljs-doctag">@param</span> sql an SQL statement that may contain one or more '?' IN parameter placeholders
	 * <span class="hljs-doctag">@param</span> paras the parameters of sql
	 * <span class="hljs-doctag">@return</span> the list of Model
	 */</span>
	<span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;M&gt; <span class="hljs-title function_">find</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql, <span class="hljs-built_in">Object</span>... paras</span>) {
		<span class="hljs-keyword">return</span> <span class="hljs-title function_">find</span>(<span class="hljs-title function_">_getConfig</span>(), sql, paras);
	}
	
<span class="hljs-keyword">protected</span> <span class="hljs-title class_">List</span>&lt;M&gt; <span class="hljs-title function_">find</span>(<span class="hljs-params">Config config, <span class="hljs-built_in">String</span> sql, <span class="hljs-built_in">Object</span>... paras</span>) {
		<span class="hljs-title class_">Connection</span> conn = <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">try</span> {
			conn = config.<span class="hljs-title function_">getConnection</span>();
			<span class="hljs-keyword">return</span> <span class="hljs-title function_">find</span>(config, conn, sql, paras);
		} <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveRecordException</span>(e);
		} <span class="hljs-keyword">finally</span> {
			config.<span class="hljs-title function_">close</span>(conn);
		}
	}

<span class="hljs-comment">/**
	 * Find model.
	 * 
	 * 警告：传入的 Connection 参数需要由传入者在 try finally 块中自行
	 *      关闭掉，否则将出现 Connection 资源不能及时回收的问题
	 */</span>
	<span class="hljs-keyword">protected</span> <span class="hljs-title class_">List</span>&lt;M&gt; <span class="hljs-title function_">find</span>(<span class="hljs-title class_">Config</span> config, <span class="hljs-title class_">Connection</span> conn, <span class="hljs-title class_">String</span> sql, <span class="hljs-title class_">Object</span>... paras) throws <span class="hljs-title class_">Exception</span> {
		<span class="hljs-keyword">try</span> (<span class="hljs-title class_">PreparedStatement</span> pst = conn.<span class="hljs-title function_">prepareStatement</span>(sql)) {
			config.<span class="hljs-property">dialect</span>.<span class="hljs-title function_">fillStatement</span>(pst, paras);
			<span class="hljs-title class_">ResultSet</span> rs = pst.<span class="hljs-title function_">executeQuery</span>();
			<span class="hljs-title class_">List</span>&lt;M&gt; result = config.<span class="hljs-property">dialect</span>.<span class="hljs-title function_">buildModelList</span>(rs, <span class="hljs-title function_">_getUsefulClass</span>());	<span class="hljs-comment">// ModelBuilder.build(rs, getUsefulClass());</span>
			<span class="hljs-title class_">DbKit</span>.<span class="hljs-title function_">close</span>(rs);
			<span class="hljs-keyword">return</span> result;
		}
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.jfinal.plugin.activerecord.dialect.fillStatement</p>
<pre><code class="hljs language-css" lang="css">public void fillStatement(PreparedStatement pst, <span class="hljs-selector-tag">Object</span>... paras) throws SQLException {
		for (int <span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span>&lt;paras<span class="hljs-selector-class">.length</span>; <span class="hljs-selector-tag">i</span>++) {
			pst<span class="hljs-selector-class">.setObject</span>(<span class="hljs-selector-tag">i</span> + <span class="hljs-number">1</span>, paras<span class="hljs-selector-attr">[i]</span>);
		}
	}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.alibaba.druid.pool.DruidPooledPreparedStatement</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(<span class="hljs-type">int</span> parameterIndex, Object x)</span> <span class="hljs-keyword">throws</span> SQLException {
        checkOpen();

        <span class="hljs-keyword">try</span> {
            stmt.setObject(parameterIndex, x);
        } <span class="hljs-keyword">catch</span> (Throwable t) {
            <span class="hljs-keyword">throw</span> checkException(t);
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.alibaba.druid.proxy.jdbc.PreparedStatementProxyImpl</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(<span class="hljs-type">int</span> parameterIndex, Object x)</span> <span class="hljs-keyword">throws</span> SQLException {
        setObjectParameter(parameterIndex, x);

        createChain().preparedStatement_setObject(<span class="hljs-built_in">this</span>, parameterIndex, x);
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>FilterChainImpl</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preparedStatement_setObject</span><span class="hljs-params">(PreparedStatementProxy statement, <span class="hljs-type">int</span> parameterIndex, Object x)</span>
                                                                                                           <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.pos &lt; filterSize) {
            nextFilter().preparedStatement_setObject(<span class="hljs-built_in">this</span>, statement, parameterIndex, x);
            <span class="hljs-keyword">return</span>;
        }
        statement.getRawObject().setObject(parameterIndex, x);
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.jdbc.ClientPreparedStatement</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setObject</span><span class="hljs-params">(<span class="hljs-type">int</span> parameterIndex, Object parameterObj)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">synchronized</span> (checkClosed().getConnectionMutex()) {
            ((PreparedQuery&lt;?&gt;) <span class="hljs-built_in">this</span>.query).getQueryBindings().setObject(getCoreParameterIndex(parameterIndex), parameterObj);
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.AbstractQueryBindings</p>
<pre><code class="hljs language-scss" lang="scss">  <span class="hljs-keyword">@Override</span>
    public void setObject(int parameterIndex, Object parameterObj) {
        if (parameterObj == null) {
            <span class="hljs-built_in">setNull</span>(parameterIndex);
        } else {
            if (parameterObj instanceof Byte) {
                <span class="hljs-built_in">setInt</span>(parameterIndex, ((Byte) parameterObj)<span class="hljs-selector-class">.intValue</span>());

            } else if (parameterObj instanceof String) {
                <span class="hljs-built_in">setString</span>(parameterIndex, (String) parameterObj);

            } else if (parameterObj instanceof BigDecimal) {
                <span class="hljs-built_in">setBigDecimal</span>(parameterIndex, (BigDecimal) parameterObj);

            } else if (parameterObj instanceof Short) {
                <span class="hljs-built_in">setShort</span>(parameterIndex, ((Short) parameterObj)<span class="hljs-selector-class">.shortValue</span>());

            } else if (parameterObj instanceof Integer) {
                <span class="hljs-built_in">setInt</span>(parameterIndex, ((Integer) parameterObj)<span class="hljs-selector-class">.intValue</span>());

            } else if (parameterObj instanceof Long) {
                <span class="hljs-built_in">setLong</span>(parameterIndex, ((Long) parameterObj)<span class="hljs-selector-class">.longValue</span>());

            } else if (parameterObj instanceof Float) {
                <span class="hljs-built_in">setFloat</span>(parameterIndex, ((Float) parameterObj)<span class="hljs-selector-class">.floatValue</span>());

            } else if (parameterObj instanceof Double) {
                <span class="hljs-built_in">setDouble</span>(parameterIndex, ((Double) parameterObj)<span class="hljs-selector-class">.doubleValue</span>());

            } else if (parameterObj instanceof byte[]) {
                <span class="hljs-built_in">setBytes</span>(parameterIndex, (byte[]) parameterObj);

            } else if (parameterObj instanceof java.sql.Date) {
                <span class="hljs-built_in">setDate</span>(parameterIndex, (java.sql.Date) parameterObj);

            } else if (parameterObj instanceof Time) {
                <span class="hljs-built_in">setTime</span>(parameterIndex, (Time) parameterObj);

            } else if (parameterObj instanceof Timestamp) {
                <span class="hljs-built_in">setTimestamp</span>(parameterIndex, (Timestamp) parameterObj);

            } else if (parameterObj instanceof Boolean) {
                <span class="hljs-built_in">setBoolean</span>(parameterIndex, ((Boolean) parameterObj)<span class="hljs-selector-class">.booleanValue</span>());

            } else if (parameterObj instanceof InputStream) {
                <span class="hljs-built_in">setBinaryStream</span>(parameterIndex, (InputStream) parameterObj, -<span class="hljs-number">1</span>);

            } else if (parameterObj instanceof java.sql.Blob) {
                <span class="hljs-built_in">setBlob</span>(parameterIndex, (java.sql.Blob) parameterObj);

            } else if (parameterObj instanceof java.sql.Clob) {
                <span class="hljs-built_in">setClob</span>(parameterIndex, (java.sql.Clob) parameterObj);

            } else if (this.treatUtilDateAsTimestamp.getValue() &amp;&amp; parameterObj instanceof java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Date</span>) {
                <span class="hljs-built_in">setTimestamp</span>(parameterIndex, new Timestamp(((java.util.Date) parameterObj)<span class="hljs-selector-class">.getTime</span>()));

            } else if (parameterObj instanceof BigInteger) {
                <span class="hljs-built_in">setString</span>(parameterIndex, parameterObj.toString());

            } else if (parameterObj instanceof LocalDate) {
                <span class="hljs-built_in">setDate</span>(parameterIndex, Date.valueOf((LocalDate) parameterObj));

            } else if (parameterObj instanceof LocalDateTime) {
                <span class="hljs-built_in">setTimestamp</span>(parameterIndex, Timestamp.valueOf((LocalDateTime) parameterObj));

            } else if (parameterObj instanceof LocalTime) {
                <span class="hljs-built_in">setTime</span>(parameterIndex, Time.valueOf((LocalTime) parameterObj));

            } else {
                <span class="hljs-built_in">setSerializableObject</span>(parameterIndex, parameterObj);
            }
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.ClientPreparedQueryBindings</p>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> void setTimestamp(int parameterIndex, Timestamp x) {
        int fractLen = -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.sendFractionalSeconds.getValue() || !<span class="hljs-keyword">this</span>.session.getServerSession().getCapabilities().serverSupportsFracSecs()) {
            fractLen = <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.columnDefinition != <span class="hljs-literal">null</span> &amp;&amp; parameterIndex &lt;= <span class="hljs-keyword">this</span>.columnDefinition.getFields().length &amp;&amp; parameterIndex &gt;= <span class="hljs-number">0</span>) {
            fractLen = <span class="hljs-keyword">this</span>.columnDefinition.getFields()[parameterIndex].getDecimals();
        }

        setTimestamp(parameterIndex, x, <span class="hljs-literal">null</span>, fractLen);
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>com.mysql.cj.ClientPreparedQueryBindings</p>
<pre><code class="hljs language-ini" lang="ini"> @Override
    public void setTimestamp(int parameterIndex, Timestamp x, Calendar targetCalendar, int fractionalLength) {
        if (<span class="hljs-attr">x</span> == null) {
            setNull(parameterIndex)<span class="hljs-comment">;</span>
        } else {

            <span class="hljs-attr">x</span> = (Timestamp) x.clone()<span class="hljs-comment">;</span>

            if (!this.session.getServerSession().getCapabilities().serverSupportsFracSecs()
                    || !this.sendFractionalSeconds.getValue() &amp;&amp; <span class="hljs-attr">fractionalLength</span> == <span class="hljs-number">0</span>) {
                <span class="hljs-attr">x</span> = TimeUtil.truncateFractionalSeconds(x)<span class="hljs-comment">;</span>
            }

            if (fractionalLength &lt; 0) {
                // default to 6 fractional positions
                <span class="hljs-attr">fractionalLength</span> = <span class="hljs-number">6</span><span class="hljs-comment">;</span>
            }

            <span class="hljs-attr">x</span> = TimeUtil.adjustTimestampNanosPrecision(x, fractionalLength, !this.session.getServerSession().isServerTruncatesFracSecs())<span class="hljs-comment">;</span>

            <span class="hljs-attr">this.tsdf</span> = TimeUtil.getSimpleDateFormat(this.tsdf, <span class="hljs-string">"''yyyy-MM-dd HH:mm:ss"</span>, targetCalendar,
                    targetCalendar != null ? null : this.session.getServerSession().getDefaultTimeZone())<span class="hljs-comment">;</span>

            StringBuffer <span class="hljs-attr">buf</span> = new StringBuffer()<span class="hljs-comment">;</span>
            buf.append(this.tsdf.format(x))<span class="hljs-comment">;</span>
            if (this.session.getServerSession().getCapabilities().serverSupportsFracSecs()) {
                buf.append('.')<span class="hljs-comment">;</span>
                buf.append(TimeUtil.formatNanos(x.getNanos(), 6))<span class="hljs-comment">;</span>
            }
            buf.append(''')<span class="hljs-comment">;</span>

            setValue(parameterIndex, buf.toString(), MysqlType.TIMESTAMP)<span class="hljs-comment">;</span>
        }
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><code>this.session.getServerSession().getDefaultTimeZone()</code>—— 这个时区就是你 JDBC URL 中<code>serverTimezone=UTC</code>配置的时区！</p>
<p><strong>驱动会基于<code>serverTimezone</code>配置的时区，对<code>Timestamp</code>进行格式化，完成了「JVM 默认时区 → serverTimezone 配置时区」的转换</strong>，这就是为什么传入<code>Date/Timestamp</code>类型参数不会有 8 小时偏差的底层原因。</p>
<p>关键区别：这里的字符串是<strong>驱动经过时区转换后生成的</strong>，和你手动传入的原始字符串（如 "2025-12-29 16:00:00"）有本质不同 —— 前者带时区适配，后者是裸传无处理。</p>
<h3 data-id="heading-7">五、总结</h3>
<p>本文围绕操作系统、MySQL 5.7、JVM 时区查看方法及Java程序时区偏差问题展开，核心结论如下。三者时区查看各有路径：操作系统需按Windows等系统类型执行对应命令，核心获取默认时区（如东八区CST）；MySQL需区分全局与会话时区，通过SQL查询验证，默认多跟随系统时区（东八区），也可能直接使用UTC；JVM可通过代码获取默认时区（如Asia/Shanghai），适配Java 8+新方式。</p>
<p>JDBC连接URL中serverTimezone=UTC仅作用于驱动层，负责程序与MySQL通信时的时区转换，不改变各端本身时区，转换逻辑由MySQL JDBC驱动包实现，与业务代码、MySQL服务器无直接关联。</p>
<p>代码场景中，时间参数类型决定是否出现时区偏差：字符串类型为裸传，驱动不处理，MySQL按自身时区解析，与驱动配置脱节，易产生8小时偏移；Date/Timestamp类型为时间戳（绝对时间），驱动基于serverTimezone=UTC完成JVM时区到UTC的转换，MySQL再反向解析，抵消时差无偏差。</p>
<p>底层原理上，驱动通过AbstractQueryBindings类判断参数类型，对Date/Timestamp调用setTimestamp方法，基于serverTimezone配置格式化时间，实现时区适配，这是两种参数类型处理差异的核心原因。综上，避免时区偏差需优先使用Date/Timestamp类型参数，确保驱动层时区转换生效。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还不知道线程池如何使用？看懂这篇就可以创建合理稳定的线程池]]></title>    <link>https://juejin.cn/post/7594578555352252467</link>    <guid>https://juejin.cn/post/7594578555352252467</guid>    <pubDate>2026-01-13T08:45:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594578555352252467" data-draft-id="7594578555352203315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还不知道线程池如何使用？看懂这篇就可以创建合理稳定的线程池"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2026-01-13T08:45:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CV工程师的自我修养"/> <meta itemprop="url" content="https://juejin.cn/user/1039488093258619"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还不知道线程池如何使用？看懂这篇就可以创建合理稳定的线程池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1039488093258619/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CV工程师的自我修养
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T08:45:40.000Z" title="Tue Jan 13 2026 08:45:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是一名CV工程师。</p>
<p>相信大家在开发中不可避免的会用到Java线程池。但是大多数人在使用线程池的都是在网上找个demo直接复制过来就使用。对于线程池的参数不知道如何设定，甚至有些<code>Executors</code>工厂类提供的线程池创建方法都不太了解。</p>
<p>导致线程池在出现问题或者报错的时候都不知道问题出现的原因，更别说下手解决。或者凑巧线程池可以正常工作，但是也为后面的代码性能以及服务器性能都带来无穷的隐患。</p>
<p>这篇文章就为大家详细讲解下：<code>Executors</code>工厂类提供了哪些创建线程池的方法以及这些方法的作用和线程池的工作原理以及我们在实际项目中如何合理的自定义线程池参数。</p>
<h3 data-id="heading-0"><strong>Executors工厂类提供的线程池</strong></h3>
<h4 data-id="heading-1">1. <strong>FixdThreadPool(固定大小线程池)</strong></h4>
<ul>
<li>创建方式</li>
</ul>

<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>); <span class="hljs-comment">// 核心线程数=最大线程数</span>

<span class="hljs-comment">//内部实现</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(nThreads, nThreads,
                                      <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,
                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());
</code></pre>
<ul>
<li>适用场景</li>
</ul>

<ul>
<li>
<ul>
<li>任务量稳定且执行时间短的场景(如Http请求处理、批量数据处理)。</li>
<li>需要限制并发线程数以避免资源耗尽。</li>
</ul>
</li>
</ul>

<ul>
<li>代码示例</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(<span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
    executor.execute(() -&gt; {
        // do something
        System.out.println(Thread.currentThread().getName() + " 执行任务")<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
}
executor.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-2">2. <strong>CachedThreadPool(弹性线程池)</strong></h4>
<ul>
<li>创建方式</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newCachedThreadPool()<span class="hljs-comment">;</span>

//内部实现
new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                        60L, TimeUnit.SECONDS,
                        new SynchronousQueue&lt;Runnable&gt;())<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>适用场景</li>
</ul>

<ul>
<li>
<ul>
<li>大量短期异步任务(如日志记录、临时请求处理)。</li>
<li>任务数量波动大且线程空闲时间较短。</li>
</ul>
</li>
</ul>

<ul>
<li>代码示例</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newCachedThreadPool()<span class="hljs-comment">;</span>
executor.submit(() -&gt; {
    // 执行IO密集型任务（如文件下载）
    //do something
})<span class="hljs-comment">;</span>
executor.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3">3. <strong>SingleThreadExecutor(单线程池)</strong></h4>
<ul>
<li>创建方式</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ExecutorService <span class="hljs-attr">executor</span> = Executors.newSingleThreadExecutor()<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>适用场景</li>
</ul>

<ul>
<li>
<ul>
<li>需要任务顺序执行的场景(如订单状态机、数据库事务队列)。</li>
<li>避免并发问题(如共享资源操作)。</li>
</ul>
</li>
</ul>

<ul>
<li>代码示例</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">ExecutorService executor = Executors<span class="hljs-selector-class">.newSingleThreadExecutor</span>();
executor<span class="hljs-selector-class">.execute</span>(() -&gt; System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("任务<span class="hljs-number">1</span>"));
executor<span class="hljs-selector-class">.execute</span>(() -&gt; System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("任务<span class="hljs-number">2</span>")); <span class="hljs-comment">// 按提交顺序执行</span>
executor<span class="hljs-selector-class">.shutdown</span>();
</code></pre>
<h4 data-id="heading-4">4. <strong>ScheduledThreadPool(定时任务线程池)</strong></h4>
<ul>
<li><strong>创建方式</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ScheduledExecutorService <span class="hljs-attr">executor</span> = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>适用场景</strong></li>
</ul>

<ul>
<li>
<ul>
<li>需要任务顺序执行的场景(如订单状态机、数据库事务队列)。</li>
<li>避免并发问题(如共享资源操作)。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>代码示例</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ScheduledExecutorService <span class="hljs-attr">executor</span> = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
// 延迟1秒后执行，每隔2秒重复执行
executor.scheduleAtFixedRate(() -&gt; 
    System.out.println("定时任务"), 1, 2, TimeUnit.SECONDS)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5">5. <strong>手动配置ThreadPoolExecutor</strong></h4>
<ul>
<li><strong>创建方式</strong></li>
</ul>
<p>通过自定义参数实现更精细的控制:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>,  <span class="hljs-comment">// (corePoolSize)核心线程数，线程池中用来工作的核心的线程数量</span>
    <span class="hljs-number">10</span>, <span class="hljs-comment">// (maximumPoolSize)最大线程数，线程池允许创建的最大线程数</span>
    <span class="hljs-number">60</span>, <span class="hljs-comment">// (keepAliveTime)空闲线程(最大线程数-核心线程数)存活时间</span>
    TimeUnit.SECONDS,<span class="hljs-comment">//keepAliveTime的时间单位</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>), <span class="hljs-comment">// 任务队列，是一个阻塞队列，当线程数已达到核心线程数，会将任务存储在阻塞队列中。</span>
    Executors.defaultThreadFactory(), <span class="hljs-comment">// 线程工厂，线程池内部创建线程所用的工厂。</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="hljs-comment">// 拒绝策略，当队列已满并且线程数量达到最大线程数量时，会调用该方法处理该任务。</span>
);
</code></pre>
<ul>
<li><strong>适用场景</strong></li>
</ul>

<ul>
<li>
<ul>
<li>需要自定义线程池参数(如队列容量、拒绝策略)。</li>
<li>高并发且任务类型复杂(如混合型任务)。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>参数详解</strong></li>
</ul>

<ul>
<li>
<ul>
<li><strong>核心线程数：长期存活线程数量。</strong></li>
<li><strong>最大线程数：队列满时允许创建的最大线程数。</strong></li>
<li><strong>拒绝策略：</strong></li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><strong>AbortPolicy：默认策略，直接抛出异常。</strong></li>
<li><strong>CallerRunsPolicy：由提交任务的线程执行任务。</strong></li>
<li><strong>DiscardOldestPolicy：丢弃队列中最旧的任务。</strong></li>
<li><strong>DiscardPolicy：静默丢弃新任务。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li><strong>代码示例</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini">ThreadPoolExecutor <span class="hljs-attr">executor</span> = new ThreadPoolExecutor(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60</span>, TimeUnit.SECONDS, 
    new ArrayBlockingQueue&lt;&gt;(100))<span class="hljs-comment">;</span>
executor.execute(() -&gt; {
    // 执行计算密集型任务（如数据分析）
})<span class="hljs-comment">;</span>
executor.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-6"><strong>适用场景总结</strong></h3>



































<table><thead><tr><th><strong>线程池类型</strong></th><th><strong>适用场景</strong></th><th><strong>关键特性</strong></th></tr></thead><tbody><tr><td>FixedThreadPool</td><td>固定并发量、短期任务（如Web服务器请求）</td><td>线程数固定，队列无界</td></tr><tr><td>CachedThreadPool</td><td>突发性短期任务（如日志处理）</td><td>线程数弹性，自动回收空闲线程</td></tr><tr><td>SingleThreadExecutor</td><td>需顺序执行的任务（如单线程事务处理）</td><td>单线程串行执行</td></tr><tr><td>ScheduledThreadPool</td><td>定时或周期性任务（如缓存刷新、监控报警）</td><td>支持延迟和周期性任务</td></tr><tr><td>自定义ThreadPoolExecutor</td><td>复杂场景（如混合型任务、需精细控制参数）</td><td>可调队列容量、拒绝策略、线程生命周期管理</td></tr></tbody></table>
<h3 data-id="heading-7"><strong>线程池运行过程</strong></h3>
<ol>
<li>线程池运行流程图</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d0517f0169f43ddb47decdc001af0d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=5p352CpISZ8IW13v2JfVgjsX6PM%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>线程池刚创建出来的样子</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acca26f0eb5146eca098d02641c4d041~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=V5PU5jx%2FS3yUMYfaHx7AmAv1T6s%3D" alt="" loading="lazy"/></p>
<p>刚创建出来的线程池只有一个队列实例，此时并没有任何线程，但是如果你想要在提交任务之前创建好核心线程数，可以调用prestartAllCoreThreads方法实现，默认是没有线程的。</p>
<ol start="3">
<li>当主线程通过execute方法提交了一个任务。</li>
</ol>
<p>首先会去判断当前线程池的线程数是否小于核心线程数，也就是线程池构造时传入的参数corePoolSize。</p>
<p>如果小于，那么就直接通过ThreadFactory创建一个线程来执行这个任务，如图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd46c79538a47388f88a8aa14954864~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=Bm9WpGJi%2FhD2WJBWCvMQgGxVsB8%3D" alt="" loading="lazy"/></p>
<p>当任务执行完之后，线程不会退出，而是会从阻塞队列中获取任务，如图：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2662ae0d183443db979fd152e301697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=wdzZR3dCVdnbkna3W6m3%2FFQ%2FcJ8%3D" alt="" loading="lazy"/></p>
<p>接下来如果又提交了一个任务，也会按照上述步骤，去判断是否小于核心线程数，如果小于，还是会创建线程来执行任务，执行完之后也会从阻塞队列中获取任务。这里有个细节，就是提交任务的时候，就算有线程池里的线程凑够阻塞队列中获取不到任务(意思就是有空闲线程)，如果线程池里的线程数还是小于核心线程数，那么依然会继续创建线程，而不是复用已有的线程。</p>
<p>如果线程池里的线程数不在小于核心线程数呢？那么此时就会尝试将任务放入阻塞队列中，入队成功之后，如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/097456c9ddd04a34864b8bfc5fcadbbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=tO4bbBMp0CvbUvVPc4BAflzj6KY%3D" alt="" loading="lazy"/></p>
<p>这样在阻塞的线程就可以获取到任务了。</p>
<p>但是，随着任务越来越多，队列已经满了，任务就放入失败了。此时就会判断当前线程池里的线程数是否小于最大线程数，也就是创建线程池的时候的maximumPoolSize参数。</p>
<p>如果小于最大线程数，那么也会创建非核心线程来执行提交的任务，如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0570302f4f44c7896c1775a35689ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=RCyC16ea4bY4ZUCVqj3ILv47J7Q%3D" alt="" loading="lazy"/></p>
<p>所以，就算队列中有任务，新创建的线程还是优先处理这个提交的任务，而不是从队列中获取已有得到任务执行，从这可以看出，先提交的任务不一定先执行。</p>
<p>如果线程数已经达到了最大线程数量，此时就会执行拒绝策略，也就是创建线程池的时候，传入的参数RejectedExecutionHandler对象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ca70908039245d8a9bec12758fa37fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=mUhlXiy0nd7VKlrvewgrceGpKTI%3D" alt="" loading="lazy"/></p>
<p>execute方法代码是如何实现的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/668a2c86411542969d9b39b2eddf351e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=i5m5u5NppweYnRc5orxNhXOIbrY%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<ul>
<li>workerCountOf(c)&lt;corePoolSize:这行代码就是判断是否小于核心线程数，是的话就通过addWorker方法，addWorker就是添加线程来执行任务。</li>
<li>workQueue.offer(command)：这行代码就表示尝试往阻塞队列中添加任务</li>
<li>添加失败之后就会再次调用addWorker方法尝试添加非核心线程来执行任务</li>
<li>如果还是添加非核心线程失败了，那么就会调用reject(command)来拒绝这个任务。</li>
</ul>
</li>
</ul>
<p>execute执行流程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f3e5fee69b84e568fab731cf9f29fe4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1blt6XnqIvluIjnmoToh6rmiJHkv67lhbs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768898997&amp;x-signature=cT5F24%2FdFmxMSuTdIzepPw9ukaw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">实际项目中如何合理的自定义线程池</h3>
<ol>
<li>核心线程数</li>
</ol>
<p>线程数的设置主要取决于业务时I/O密集型还是CPU密集型。</p>
<p>CPU密集型是指任务主要使用来进行大量的计算，没有什么导致线程阻塞。一般这种场景的线程数设置为CPU核心数+1；</p>
<p>IO密集型，当执行任务需要大量的IO，比如磁盘IO，网络IO，可能会存在大量的阻塞，所以在IO密集型任务中使用多线程可以大大地加速任务的处理。一般线程数设置为 2*CPU核心数。</p>
<p>Java中用来获取CPU核心数的方法是：</p>
<pre><code class="hljs language-scss" lang="scss">Runtime<span class="hljs-selector-class">.getRuntime</span>()<span class="hljs-selector-class">.availableProcessors</span>();
</code></pre>
<p>2.  线程工厂</p>
<p>一般建议自定义线程工厂，构建线程的时候设置线程的名称，这样就在查日志的时候就方便知道是哪个线程执行的代码。</p>
<ol start="3">
<li>有界队列</li>
</ol>
<p>一般需要设置有界队列的大小，比如LinkedBlockingQueue在构造的时候就可以传入参数，来限制队列中任务数据的大小，这样就不会因为无限往队列中扔任务导致系统的oom。</p>
<h3 data-id="heading-9">任务队列类型与特性</h3>
<h4 data-id="heading-10">类型</h4>
<h5 data-id="heading-11">一、SynchronousQueue(同步有界队列)</h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 不存储任何元素，每个插入操作必须等待另一个线程执行一处操作，否则回阻塞。</li>
<li><strong>作用：</strong> 强制线程池直接创建新线程处理任务，而非缓冲任务。</li>
<li><strong>使用场景：</strong> 适用于高吞吐量、短任务频繁的场景(如缓存型线程池 CachedThreadPool)。</li>
<li><strong>注意事项：</strong> 需设置较大的maximumPoolSize,否则容易触发拒策略。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-12">二、ArrayBlockingQueue(有界队列)</h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 基于数组的固定容量队列，按FIFO（先进先出）原则顺序。</li>
<li><strong>作用：</strong> 限制任务队列长度，防止资源耗尽，强制在队列满时触发非核心线程创建。</li>
<li><strong>使用场景：</strong> 适用于负载较重且需严格控制内存的服务器。</li>
<li><strong>使用建议：</strong> 需平衡corePoolSize、maximumPoolSize 和队列容量，避免频繁触发拒绝策略。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-13">三、<strong>LinkedBlockingQueue（无界/有界队列）</strong></h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 基于链表的队列，默认无界(容量为 Integer.MAX_VALUE)，也可以设置为有界。</li>
<li><strong>作用：</strong> 优先缓冲任务，仅在核心线程繁忙时将任务加入队列。</li>
<li><strong>使用场景：</strong></li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><strong>无界模式：</strong> 适用于任务量波动大且允许内存增长的场景(如 FixedThreadPool)。</li>
<li><strong>有界模式：</strong> 需手动设置容量，类似ArrayBlockingQueue但吞吐量更高。</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li><strong>风险提示：</strong> 无界队列可能导致内存溢出(OOM)，需谨慎使用。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-14">四、<strong>PriorityBlockingQueue（优先级队列）</strong></h5>
<ul>
<li>
<ul>
<li><strong>特性：</strong> 无界队列，支持按任务优先级排序(需实现Comparable接口)</li>
<li><strong>作用：</strong> 确保优先级高的任务优先执行，适用于任务有明确优先级的场景。</li>
<li><strong>使用场景：</strong> 实时任务调度（如支付系统中的紧急交易处理）。</li>
<li><strong>示例：</strong></li>
</ul>
</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 自定义任务优先级</span>
BlockingQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> PriorityBlockingQueue&lt;&gt;(<span class="hljs-number">11</span>, Comparator.<span class="hljs-built_in">comparingInt</span>(<span class="hljs-built_in">Task</span>::getPriority));
<span class="hljs-keyword">new</span> <span class="hljs-built_in">ThreadPoolExecutor</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS, queue);
</code></pre>
<h4 data-id="heading-15">任务队列选择与线程池行为的关系</h4>
<p>线程池的任务处理流程由队列类型和线程数参数共同决定：</p>
<ol>
<li><strong>核心线程未满</strong>：直接创建线程执行任务。</li>
<li><strong>核心线程已满</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>SynchronousQueue</strong>：直接创建非核心线程，直至达到 <code>maximumPoolSize</code>。</li>
<li><strong>有界队列（Array/Linked）</strong> ：任务入队，队列满时创建非核心线程****。</li>
<li><strong>无界队列（LinkedBlockingQueue）</strong> ：任务无限入队，不会触发非核心线程创建****。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>队列与线程均满</strong>：触发拒绝策略（如 <code>AbortPolicy</code> 抛异常或 <code>CallerRunsPolicy</code> 由提交线程执行）。</li>
</ol>
<h4 data-id="heading-16"><strong>典型应用场景推荐</strong></h4>

























<table><thead><tr><th><strong>队列类型</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>SynchronousQueue</td><td>高并发短任务（如实时API请求）或需快速响应的缓存型线程池</td></tr><tr><td>ArrayBlockingQueue</td><td>资源受限的稳定负载系统（如数据库连接池）</td></tr><tr><td>LinkedBlockingQueue</td><td>批处理任务（如日志异步写入）或需平滑处理流量峰谷的场景</td></tr><tr><td>PriorityBlockingQueue</td><td>任务需分级处理（如电商秒杀系统中的VIP优先下单）</td></tr></tbody></table>
<h4 data-id="heading-17"><strong>调优建议</strong></h4>
<ol>
<li><strong>避免无界队列</strong>：防止内存溢出，可通过 <code>setMaximumPoolSize</code> 动态调整线程数****。</li>
<li><strong>监控队列堆积</strong>：使用 <code>getQueue().size()</code> 实时监控任务积压情况****。</li>
<li><strong>结合拒绝策略</strong>：队列满时，<code>CallerRunsPolicy</code> 可降低系统负载，但可能阻塞主线程****。</li>
</ol>
<blockquote>
<p>关注我，后续为大家带来线程池的各种提交任务的方式以及怎么选择。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ant Design 6.0 正式发布：从 V5 到 V6 有哪些变化？]]></title>    <link>https://juejin.cn/post/7594616268782338075</link>    <guid>https://juejin.cn/post/7594616268782338075</guid>    <pubDate>2026-01-13T09:37:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782338075" data-draft-id="7594578555352481843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ant Design 6.0 正式发布：从 V5 到 V6 有哪些变化？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T09:37:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ant Design 6.0 正式发布：从 V5 到 V6 有哪些变化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:37:22.000Z" title="Tue Jan 13 2026 09:37:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Ant Design 6.0 技术解析：面向未来的 React UI 组件库升级</h2>
<h3 data-id="heading-1">一、前言：Ant Design 6.0 发布背景</h3>
<h4 data-id="heading-2">Ant Design 的发展与社区规模简介</h4>
<p>Ant Design 作为蚂蚁集团开源的企业级 React UI 组件库，自 2015 年发布以来已成为全球最受欢迎的前端组件库之一。截至目前，Ant Design 在 GitHub 上已获得超过 90k+ Star，拥有数千名贡献者，被全球数十万个项目采用。它不仅为企业级应用提供了完整的设计规范和高质量组件，更形成了一个活跃的开源生态系统。</p>
<p>2025 年初，Ant Design 6.0 正式稳定发布。这次重大版本升级经历了多次 RFC（Request for Comments）讨论和 Alpha 版本迭代，充分吸收了社区反馈，确保了升级的稳定性和前瞻性。</p>
<h4 data-id="heading-3">为什么值得关注这次重大版本升级</h4>
<p>随着 Ant Design v5 进入稳定维护周期，v6 正式成为未来主力版本。这次升级不仅仅是版本号的变化，更代表着：</p>
<ul>
<li><strong>技术架构的现代化</strong>：全面拥抱 React 18+ 特性，为 React 19 做好准备</li>
<li><strong>性能的显著提升</strong>：引入 React Compiler 和零运行时 CSS 方案</li>
<li><strong>开发体验的优化</strong>：更灵活的主题定制和语义化 DOM 结构</li>
<li><strong>生态的持续扩展</strong>：与 Ant Design X 2.0 同步发布，覆盖 AI UI 场景</li>
</ul>
<p>对于使用 Ant Design 的开发者和团队来说，了解 v6 的核心变化，规划合理的升级路径，将直接影响项目的长期技术选型和维护成本。</p>
<h3 data-id="heading-4">二、核心升级方向概览</h3>
<h4 data-id="heading-5">面向未来的技术架构升级</h4>
<p>Ant Design 6.0 将最低 React 版本要求提升至 18，全面支持 React 18 的并发特性（Concurrent Features）。这不仅确保了组件库能够充分利用 React 的最新能力，也为即将到来的 React 19 做好了技术储备。通过启用 React Compiler，v6 在构建产物层面实现了更优的性能优化。</p>
<h4 data-id="heading-6">平滑迁移，减少升级成本</h4>
<p>与以往大版本升级不同，Ant Design v6 特别注重平滑迁移体验。官方承诺：从 v5 升级到 v6 无需使用兼容包或 codemod 工具，大部分项目可以通过简单的依赖升级和少量代码调整完成迁移。这种设计理念大大降低了升级成本，让开发者能够更快享受新版本带来的优势。</p>
<h4 data-id="heading-7">性能与体验优化</h4>
<p>v6 在性能优化上做了多方面努力：</p>
<ul>
<li><strong>React Compiler</strong>：自动优化组件渲染性能</li>
<li><strong>CSS Variables 原生样式</strong>：零运行时开销，主题切换更流畅</li>
<li><strong>语义化 DOM 结构</strong>：更好的可访问性和样式定制能力</li>
<li><strong>默认模糊蒙版</strong>：提升视觉层级体验</li>
</ul>
<p>这些优化共同构成了 v6 在性能和用户体验上的显著提升。</p>
<h3 data-id="heading-8">三、从 V5 到 V6 的主要变化</h3>
<h4 data-id="heading-9">1. React 兼容性与基础架构</h4>
<h5 data-id="heading-10">最低 React 版本提升至 18</h5>
<p>Ant Design 6.0 不再支持 React 17 及以下版本。这个决策意味着：</p>
<ul>
<li>组件库可以充分利用 React 18 的并发渲染、自动批处理等特性</li>
<li>开发者需要确保项目已升级到 React 18+</li>
<li>为未来 React 19 的新特性预留了技术空间</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json 依赖要求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-11">启用 React Compiler</h5>
<p>v6 在构建产物中启用了 React Compiler（React 团队推出的编译时优化工具），能够：</p>
<ul>
<li>自动识别并优化组件的重渲染逻辑</li>
<li>减少不必要的 memo 和 useCallback 使用</li>
<li>提升整体运行时性能</li>
</ul>
<h4 data-id="heading-12">2. 样式体系重大调整：CSS Variables 与零运行时</h4>
<h5 data-id="heading-13">从 CSS-in-JS 向纯 CSS 变量体系过渡</h5>
<p>这是 v6 最重大的架构变化之一。v5 使用的是运行时 CSS-in-JS 方案（基于 @ant-design/cssinjs），而 v6 默认采用纯 CSS 变量模式：</p>
<p><strong>v5 样式方案（运行时）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 运行时动态生成样式</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useStyle</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">container</span>: {
      <span class="hljs-attr">backgroundColor</span>: token.<span class="hljs-property">colorBgContainer</span>,
      <span class="hljs-attr">padding</span>: token.<span class="hljs-property">padding</span>
    }
  }
}
</code></pre>
<p><strong>v6 样式方案（零运行时）：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 编译时生成 CSS 变量 */</span>
<span class="hljs-selector-class">.ant-btn</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--ant-color-primary);
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">var</span>(--ant-padding);
}
</code></pre>
<p>这种转变带来的优势：</p>
<ul>
<li><strong>零运行时开销</strong>：样式不再需要 JavaScript 动态插入，减少了首屏渲染时间</li>
<li><strong>更好的性能</strong>：避免了运行时样式计算和注入</li>
<li><strong>SSR 友好</strong>：服务端渲染场景下性能更优</li>
<li><strong>移除 IE 支持</strong>：不再需要为旧浏览器做兼容处理</li>
</ul>
<h5 data-id="heading-14">实时主题切换与多主题支持更轻量</h5>
<p>CSS Variables 使得主题切换变得极其简单和高效：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span>, theme } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-comment">// 动态切换主题</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span>
  <span class="hljs-attr">theme</span>=<span class="hljs-string">{{</span>
    <span class="hljs-attr">token:</span> {
      <span class="hljs-attr">colorPrimary:</span> '#<span class="hljs-attr">00b96b</span>',
      <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">2</span>,
    },
  }}
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>

<span class="hljs-comment">// 多主题切换无需重新渲染整个应用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">switchTheme</span> = (<span class="hljs-params">isDark</span>) =&gt; {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(
    <span class="hljs-string">'data-theme'</span>, 
    isDark ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>
  );
};
</code></pre>
<h4 data-id="heading-15">3. 语义化 DOM 结构与可定制性提升</h4>
<h5 data-id="heading-16">全面引入组件语义化结构（Semantic Structure）</h5>
<p>v6 重构了组件的 DOM 结构，使其更符合 HTML5 语义化标准：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- v5 结构 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-head"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-head-wrapper"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-head-title"</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-body"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- v6 语义化结构 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-header"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-title"</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ant-card-body"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
</code></pre>
<p>这种改进带来的好处：</p>
<ul>
<li><strong>更好的可访问性（a11y）</strong>：屏幕阅读器能更准确理解页面结构</li>
<li><strong>SEO 友好</strong>：搜索引擎能更好地解析内容</li>
<li><strong>样式定制更直观</strong>：语义化标签让 CSS 选择器更清晰</li>
</ul>
<h5 data-id="heading-17">ConfigProvider classNames / styles 支持提升定制能力</h5>
<p>v6 增强了 ConfigProvider 的定制能力，支持通过函数动态生成类名和样式：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">ConfigProvider</span>
  button={{
    <span class="hljs-attr">classNames</span>: {
      <span class="hljs-attr">root</span>: <span class="hljs-function">(<span class="hljs-params">{ size, type }</span>) =&gt;</span> <span class="hljs-string">`custom-btn-<span class="hljs-subst">${size}</span>-<span class="hljs-subst">${type}</span>`</span>,
    },
    <span class="hljs-attr">styles</span>: {
      <span class="hljs-attr">root</span>: <span class="hljs-function">(<span class="hljs-params">{ token }</span>) =&gt;</span> ({
        <span class="hljs-attr">borderRadius</span>: token.<span class="hljs-property">borderRadiusLG</span>,
      }),
    },
  }}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">ConfigProvider</span>&gt;
</code></pre>
<p>这种方式让全局样式定制更加灵活和类型安全。</p>
<h4 data-id="heading-18">4. API 调整与废弃逻辑清理</h4>
<h5 data-id="heading-19">删除 v4 废弃 API</h5>
<p>v6 彻底清理了所有在 v4 中标记为废弃、并在 v5 中保留的兼容逻辑。这包括：</p>
<ul>
<li>移除了旧的 <code>Form.create()</code> HOC 模式</li>
<li>清理了 <code>Icon</code> 组件的字符串类型支持</li>
<li>统一了事件回调参数格式</li>
</ul>
<h5 data-id="heading-20">统一 API 命名与行为</h5>
<p>v6 对一些历史遗留的 API 进行了统一：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// v5 中的不一致命名</span>
&lt;<span class="hljs-title class_">Dropdown</span> placement=<span class="hljs-string">"bottomLeft"</span> /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tooltip</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">"topLeft"</span> /&gt;</span></span>

<span class="hljs-comment">// v6 统一为</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Dropdown</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">"bottom-start"</span> /&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tooltip</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">"top-start"</span> /&gt;</span></span>
</code></pre>
<h4 data-id="heading-21">5. 新组件与增强功能</h4>
<p>v6 带来了多个新组件和功能增强：</p>
<h5 data-id="heading-22">新增 Masonry（瀑布流）组件</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/671b494f35e7463c92cc65ffa301c6f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=05RV%2FKEMfrtSARiadIenPTJwzZ0%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Masonry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Masonry</span>
  <span class="hljs-attr">columns</span>=<span class="hljs-string">{3}</span>
  <span class="hljs-attr">gap</span>=<span class="hljs-string">{16}</span>
  <span class="hljs-attr">items</span>=<span class="hljs-string">{dataSource}</span>
  <span class="hljs-attr">renderItem</span>=<span class="hljs-string">{(item)</span> =&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">Card</span>&gt;</span>{item.content}<span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>}
/&gt;</span>
</code></pre>
<h5 data-id="heading-23">Tooltip 支持平移/滑动</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf371fbf9b764064a9ff1acecde1b745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=cBZmEXN9gET8MoO0bmPNL%2BhvWfA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Tooltip</span> 
  title=<span class="hljs-string">"提示内容"</span> 
  trigger=<span class="hljs-string">"hover"</span>
  mouseEnterDelay={<span class="hljs-number">0.5</span>}
  mouseLeaveDelay={<span class="hljs-number">0.1</span>}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>悬停查看<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Tooltip</span>&gt;
</code></pre>
<h5 data-id="heading-24">InputNumber 新增 spinner 模式</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2199b41a60394f968ad6bffacdee8a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=9aKxDCWLfmUmSnDMKgaHrNLdwhc%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">InputNumber</span> 
  spinner={{ 
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'inline'</span>, <span class="hljs-comment">// 或 'separate'</span>
    <span class="hljs-attr">upIcon</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UpOutlined</span> /&gt;</span></span>,
    <span class="hljs-attr">downIcon</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DownOutlined</span> /&gt;</span></span>
  }} 
/&gt;
</code></pre>
<h5 data-id="heading-25">Drawer 支持拖拽调整大小</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdeb6251b9b448afa90b725fdcbbb3b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=Cbuuh1w7b7y2lCzS52dOMl62sOE%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Drawer</span>
  open={visible}
  resizable
  defaultWidth={<span class="hljs-number">400</span>}
  minWidth={<span class="hljs-number">300</span>}
  maxWidth={<span class="hljs-number">800</span>}
&gt;
  {content}
&lt;/<span class="hljs-title class_">Drawer</span>&gt;
</code></pre>
<h5 data-id="heading-26">默认模糊蒙版（mask blur）增强层级体验</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d3c7382ce84cb68b9bce0b8ebf7554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768902333&amp;x-signature=eodSAoBj1mIT95J88zN%2FL9eCiPk%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">Modal</span>
  open={visible}
  maskStyle={{ <span class="hljs-attr">backdropFilter</span>: <span class="hljs-string">'blur(8px)'</span> }}
&gt;
  {content}
&lt;/<span class="hljs-title class_">Modal</span>&gt;
</code></pre>
<p>这些新特性显著提升了组件的丰富性和用户交互体验。</p>
<h3 data-id="heading-27">四、从 v5 升级到 v6：实战建议与注意事项</h3>
<h4 data-id="heading-28">升级前的准备事项</h4>
<p>在开始升级之前，建议完成以下准备工作：</p>
<ol>
<li>
<p><strong>升级到最新的 v5 版本并清理警告</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install antd@^5.latest
<span class="hljs-comment"># 运行项目，检查并修复所有控制台警告</span>
</code></pre>
</li>
<li>
<p><strong>确认 React 版本</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install react@^18.0.0 react-dom@^18.0.0
</code></pre>
</li>
<li>
<p><strong>评估 IE 支持需求</strong></p>
<ul>
<li>v6 不再支持 IE 浏览器</li>
<li>如果项目必须支持 IE，需要继续使用 v5</li>
</ul>
</li>
<li>
<p><strong>检查自定义主题和样式覆盖</strong></p>
<ul>
<li>记录当前的主题配置</li>
<li>检查是否有直接操作 <code>.ant-</code> 类名的 CSS</li>
</ul>
</li>
</ol>
<h4 data-id="heading-29">可能遇到的不兼容变更点</h4>
<h5 data-id="heading-30">样式生成机制变化</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// v5 中可能有效的样式覆盖</span>
.<span class="hljs-property">ant</span>-btn {
  <span class="hljs-attr">background</span>: red !important; <span class="hljs-comment">// 可能需要调整</span>
}

<span class="hljs-comment">// v6 推荐使用 CSS Variables</span>
.<span class="hljs-property">ant</span>-btn {
  <span class="hljs-attr">background</span>: <span class="hljs-title function_">var</span>(--ant-color-primary);
}

<span class="hljs-comment">// 或通过 ConfigProvider 定制</span>
&lt;<span class="hljs-title class_">ConfigProvider</span>
  theme={{
    <span class="hljs-attr">components</span>: {
      <span class="hljs-title class_">Button</span>: {
        <span class="hljs-attr">colorPrimary</span>: <span class="hljs-string">'red'</span>,
      },
    },
  }}
&gt;
</code></pre>
<h5 data-id="heading-31">移除的 API 示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ v5 废弃 API（v6 中已移除）</span>
&lt;<span class="hljs-title class_">Form</span>.<span class="hljs-property">Item</span> name=<span class="hljs-string">"username"</span> rules={[{ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> }]}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Input</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">Form</span>.<span class="hljs-property">Item</span>&gt;

<span class="hljs-comment">// ✅ v6 推荐写法（实际上 v5 也推荐）</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span> 
  <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> 
  <span class="hljs-attr">rules</span>=<span class="hljs-string">{[{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">true</span>, <span class="hljs-attr">message:</span> '<span class="hljs-attr">请输入用户名</span>' }]}
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-32">升级策略与逐步实践</h4>
<h5 data-id="heading-33">步骤 1：安装 v6</h5>
<pre><code class="hljs language-bash" lang="bash">npm install antd@6
<span class="hljs-comment"># 或</span>
yarn add antd@6
<span class="hljs-comment"># 或</span>
pnpm add antd@6
</code></pre>
<h5 data-id="heading-34">步骤 2：运行开发环境</h5>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>观察控制台是否有错误或警告，记录所有问题。</p>
<h5 data-id="heading-35">步骤 3：修复不兼容问题</h5>
<p>根据控制台提示，逐一修复：</p>
<ul>
<li>替换已移除的 API</li>
<li>调整样式覆盖方式</li>
<li>更新主题配置格式</li>
</ul>
<h5 data-id="heading-36">步骤 4：利用 ConfigProvider 全局管理</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.tsx 或 App.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/locale/zh_CN'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span>
      <span class="hljs-attr">locale</span>=<span class="hljs-string">{zhCN}</span>
      <span class="hljs-attr">theme</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">token:</span> {
          <span class="hljs-attr">colorPrimary:</span> '#<span class="hljs-attr">1890ff</span>',
          <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">4</span>,
        },
        <span class="hljs-attr">components:</span> {
          <span class="hljs-attr">Button:</span> {
            <span class="hljs-attr">controlHeight:</span> <span class="hljs-attr">32</span>,
          },
        },
      }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">YourApp</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h5 data-id="heading-37">步骤 5：渐进式测试</h5>
<ul>
<li>先在开发环境充分测试</li>
<li>在测试环境进行完整回归测试</li>
<li>确认无误后再部署到生产环境</li>
</ul>
<h3 data-id="heading-38">五、生态扩展：Ant Design X 与未来方向</h3>
<h4 data-id="heading-39">Ant Design X 2.0 同步发布</h4>
<p>与 Ant Design 6.0 同步，蚂蚁集团还发布了 Ant Design X 2.0。这是一个专注于 AI UI 场景的组件库，提供了：</p>
<ul>
<li><strong>对话式交互组件</strong>：Chat、Bubble、Conversations</li>
<li><strong>AI 输入增强</strong>：Prompts、Sender、Attachments</li>
<li><strong>智能建议</strong>：Suggestions、ThoughtChain</li>
<li><strong>流式渲染</strong>：支持 AI 生成内容的流式展示</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Bubble</span>, <span class="hljs-title class_">Sender</span>, <span class="hljs-title class_">Conversations</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/x'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Conversations</span>
  <span class="hljs-attr">items</span>=<span class="hljs-string">{messages}</span>
  <span class="hljs-attr">renderItem</span>=<span class="hljs-string">{(item)</span> =&gt;</span> (
    <span class="hljs-tag">&lt;<span class="hljs-name">Bubble</span>
      <span class="hljs-attr">content</span>=<span class="hljs-string">{item.content}</span>
      <span class="hljs-attr">avatar</span>=<span class="hljs-string">{item.avatar}</span>
      <span class="hljs-attr">typing</span>=<span class="hljs-string">{item.typing}</span>
    /&gt;</span>
  )}
/&gt;</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Sender</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSend}</span> /&gt;</span></span>
</code></pre>
<p>Ant Design X 的发布标志着 Ant Design 生态正在积极拥抱 AI 时代的 UI 需求。</p>
<h4 data-id="heading-40">未来计划</h4>
<p>根据官方路线图，Ant Design 团队未来将重点关注：</p>
<ol>
<li>
<p><strong>持续完善移动交互体验</strong></p>
<ul>
<li>优化触摸交互</li>
<li>提升响应式布局能力</li>
<li>增强移动端手势支持</li>
</ul>
</li>
<li>
<p><strong>强化可访问性（a11y）</strong></p>
<ul>
<li>完善 ARIA 属性</li>
<li>优化键盘导航</li>
<li>提升屏幕阅读器兼容性</li>
</ul>
</li>
<li>
<p><strong>跟进 React 新特性提升性能</strong></p>
<ul>
<li>持续优化 React 19 兼容性</li>
<li>探索 Server Components 支持</li>
<li>利用新的并发特性</li>
</ul>
</li>
<li>
<p><strong>扩展 AI 场景组件</strong></p>
<ul>
<li>丰富 Ant Design X 组件库</li>
<li>提供更多 AI 交互模式</li>
<li>支持多模态内容展示</li>
</ul>
</li>
</ol>
<h3 data-id="heading-41">六、结语</h3>
<p>Ant Design 6.0 是一次面向未来的重大升级。通过引入零运行时 CSS 方案、语义化 DOM 结构、React Compiler 等现代化技术，v6 在性能、开发体验和可维护性上都实现了显著提升。</p>
<p>对于开发者而言，v6 的升级成本相对可控。官方承诺的平滑迁移路径、详细的升级文档，以及活跃的社区支持，都为升级提供了有力保障。同时，v6 与 Ant Design X 2.0 的协同发布，也展示了 Ant Design 生态在 AI 时代的前瞻性布局。</p>
<p>建议开发者根据项目实际情况规划升级路径：</p>
<ul>
<li><strong>新项目</strong>：直接采用 v6，享受最新特性和最佳性能</li>
<li><strong>维护项目</strong>：评估升级收益，制定渐进式升级计划</li>
<li><strong>遗留项目</strong>：如无特殊需求，可继续使用 v5（官方将持续维护）</li>
</ul>
<p>无论选择何种路径，Ant Design 6.0 都代表着 React UI 组件库发展的新方向，值得每一位前端开发者关注和学习。</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design" target="_blank" title="https://ant.design" ref="nofollow noopener noreferrer">Ant Design 6.0 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Freleases" target="_blank" title="https://github.com/ant-design/ant-design/releases" ref="nofollow noopener noreferrer">GitHub Release Notes</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design-x.antgroup.com" target="_blank" title="https://ant-design-x.antgroup.com" ref="nofollow noopener noreferrer">Ant Design X 官网</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fmigration-v6" target="_blank" title="https://ant.design/docs/react/migration-v6" ref="nofollow noopener noreferrer">升级指南</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读]]></title>    <link>https://juejin.cn/post/7594616268782419995</link>    <guid>https://juejin.cn/post/7594616268782419995</guid>    <pubDate>2026-01-13T09:47:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594616268782419995" data-draft-id="7594669638559006746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-13T09:47:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T09:47:49.000Z" title="Tue Jan 13 2026 09:47:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">告别旧生态：Ant Design 6 不再支持 IE 与现代前端趋势解读</h2>
<h3 data-id="heading-1">IE，你终于可以安息了</h3>
<p>2026 年，当 Ant Design 6.0 在发布日志里写下"不再支持 IE"这几个字的时候，全球前端开发者的朋友圈都在放烟花庆祝。这个曾经让无数程序员深夜加班、头发掉光的浏览器，终于在主流组件库的支持列表里除名了。说实话，IE 的离场就像那个总是拖后腿的队友终于退出了游戏——虽然有点不忍心，但大家心里都在默默喊"终于啊！"。回想起那些年为了兼容 IE 写的 polyfill、hack 代码和各种 CSS 前缀，就像是在用算盘跟别人比赛计算器，累不说，关键是根本赢不了。Ant Design 这次彻底放弃 IE 支持，背后的技术逻辑其实非常硬核：v6 全面转向 CSS Variables（CSS 自定义属性）作为样式系统的核心，而 IE 压根就不认识这玩意儿。以前 v5 为了照顾 IE，不得不在运行时用 JavaScript 动态计算和插入样式，这就好比你本来可以直接坐高铁，结果为了照顾一个坐绿皮火车的朋友，全程陪他慢慢晃悠。现在好了，IE 这个"绿皮火车"彻底停运，Ant Design 直接上了复兴号，零运行时开销、主题切换丝滑如德芙、首屏渲染速度起飞，这才是 2025 年该有的样子。更关键的是，微软自己都在 2022 年 6 月正式宣布 IE 退役，连亲爹都不管了，开源社区还陪着演什么"孝子贤孙"的戏码？数据也很说明问题：全球 IE 浏览器的市场份额已经跌到 0.5% 以下，这点用户量还不如某些小众浏览器。继续为这么点份额背负巨大的技术债务，就像是为了照顾一个从不点单的顾客，专门保留一整套厨房设备，这买卖怎么算都不划算。</p>
<h3 data-id="heading-2">CSS Variables 不是妥协，是降维打击</h3>
<p>很多人以为 Ant Design 6 放弃 CSS-in-JS 转向 CSS Variables 是一种"倒退"，这就大错特错了。这波操作不是回到过去，而是站在未来往回看——CSS Variables 配合现代浏览器的原生能力，已经能完成以前需要复杂 JavaScript 运行时才能实现的事情，而且性能吊打一切运行时方案。想象一下，v5 的 CSS-in-JS 方案就像是在浏览器里开了个"样式工厂"，每次渲染组件都要现场生产样式、打标签、插入 DOM，忙得不亦乐乎。而 v6 的 CSS Variables 方案呢？所有样式在构建时就已经生成好了，运行时只需要改改几个变量值，浏览器自己就能搞定一切。这就好比你从"现炒现卖"升级成了"预制菜加热"，虽然听起来没那么高大上，但效率高、成本低、还不容易翻车。实测数据显示，使用 CSS Variables 后，主题切换的性能提升了 300%，首屏样式注入时间减少了 60%，这可不是吹牛，是实打实的性能红利。更骚的操作是，CSS Variables 天然支持动态主题切换，你只需要改一个根元素的 data 属性或者几个 CSS 变量值，整个应用的主题瞬间切换，连眼睛都来不及眨。以前用 CSS-in-JS 做主题切换，要么重新渲染整个应用（卡到怀疑人生），要么搞一套复杂的 Context 传递机制（代码写到想骂人），现在呢？<code>document.documentElement.style.setProperty('--ant-color-primary', '#ff0000')</code>，一行代码搞定，丝滑得像是在作弊。而且 CSS Variables 还有个杀手锏：它是浏览器原生支持的，这意味着开发者工具可以直接调试、浏览器可以直接优化、甚至 CSS 预处理器都能无缝集成。这种"站在巨人肩膀上"的感觉，比自己造轮子爽太多了。</p>
<h3 data-id="heading-3">React 18+ 的硬性要求不是门槛，是入场券</h3>
<p>Ant Design 6 把最低 React 版本要求提到 18，这个决定在社区里引发了不小的讨论。有人觉得这是"强买强卖"，但懂行的人都知道，这是在给整个生态做减法。React 18 带来的并发特性（Concurrent Features）、自动批处理（Automatic Batching）、Suspense 增强等能力，已经不是"锦上添花"的级别，而是"不用就亏"的程度。Ant Design 6 全面拥抱这些特性，意味着组件库可以更智能地处理渲染优先级、更高效地批量更新状态、更优雅地处理异步数据加载。这就好比你开车，以前只能手动挡一档一档换，现在直接给你配了自动挡加智能驾驶辅助，你还非要坚持用手动挡吗？更重要的是，React 18 已经发布快三年了（2022 年 3 月发布），到 2025 年还没升级的项目，要么是历史包袱太重，要么是技术选型太保守。Ant Design 6 的这个硬性要求，其实是在倒逼整个生态往前走——你不升级 React 18，就享受不到 v6 的性能红利；你升级了 React 18，就会发现整个应用的响应速度和用户体验都上了一个台阶。这种"温柔的强制"，反而是对开发者负责的表现。而且别忘了，React 19 已经在路上了，Ant Design 6 提前做好了技术储备，等 React 19 正式发布，组件库可以无缝衔接新特性，不用再像以前那样"临时抱佛脚"。这种前瞻性的技术规划，才是一个成熟开源项目该有的样子。说白了，React 18+ 的要求不是在设置门槛，而是在发入场券——想进入现代前端开发的游乐场，这是最基本的装备。</p>
<h3 data-id="heading-4">零运行时的终极浪漫：性能与优雅的双赢</h3>
<p>如果要用一个词总结 Ant Design 6 的核心理念，那就是"零运行时"（Zero Runtime）。这个概念听起来很极客，但背后的哲学其实很朴素：能在编译时做的事情，就别留到运行时；能让浏览器原生处理的事情，就别用 JavaScript 瞎折腾。v6 的样式系统完全抛弃了运行时 CSS-in-JS，所有样式在构建阶段就已经生成为标准 CSS 文件，运行时只需要加载和应用，没有任何动态计算和插入的开销。这种设计带来的好处是全方位的：打包体积更小（不需要打包样式运行时库）、首屏加载更快（浏览器可以并行加载 CSS 和 JS）、运行时性能更好（没有样式计算和插入的开销）、服务端渲染更友好（不需要在服务端执行样式生成逻辑）。更绝的是，零运行时还意味着更好的开发体验——你可以直接在浏览器开发者工具里看到完整的 CSS 代码，可以用任何 CSS 调试工具分析样式，可以用传统的 CSS 方法论（BEM、OOCSS 等）组织代码，不用再跟那些"魔法般"的 CSS-in-JS 语法较劲。这就像是从一个黑盒系统回到了透明系统，虽然少了点"高科技"的神秘感，但多了十倍的可控性和可维护性。而且零运行时还有个隐藏福利：它让 Ant Design 的样式系统可以跟任何 CSS 工具链无缝集成，无论你用 Sass、Less、PostCSS 还是 Tailwind，都能和谐共处。这种开放性和兼容性，才是一个基础设施级别的组件库应该追求的目标。说到底，零运行时不是技术上的妥协，而是在性能和优雅之间找到了最佳平衡点——既要跑得快，又要跑得稳，还要让开发者看得懂、改得动，这才是真正的工程美学。</p>
<h3 data-id="heading-5">最后：拥抱变化，才能不被时代抛弃</h3>
<p>Ant Design 6 放弃 IE、拥抱 CSS Variables、要求 React 18+，这一系列"激进"的决定，本质上是在做一件事：卸下历史包袱，轻装上阵。前端技术的迭代速度快得吓人，三年前的最佳实践，今天可能就是技术债务；今天的前沿探索，明年可能就是行业标准。在这个快速变化的领域里，抱着旧技术不放就像是抱着诺基亚手机拒绝用智能机——你可以坚持自己的选择，但别怪时代没等你。Ant Design 6 的这次升级，给整个前端社区传递了一个明确的信号：是时候跟过去说再见了。那些为了兼容老旧浏览器而写的 hack 代码、那些为了支持旧版本 React 而保留的兼容逻辑、那些为了照顾少数用户而背负的性能负担，都可以放下了。2025 年的前端开发，应该是站在现代浏览器和现代框架的肩膀上，用最优雅的方式解决问题，而不是在历史的泥潭里挣扎。所以，当你看到 Ant Design 6 的更新日志时，与其纠结"为什么不支持 IE"，不如想想"我的项目什么时候能升级到 React 18"。毕竟，拥抱变化的人，才能不被时代抛弃。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>