<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[web3钱包Demo]]></title>    <link>https://juejin.cn/post/7578793960626634778</link>    <guid>https://juejin.cn/post/7578793960626634778</guid>    <pubDate>2025-12-02T03:01:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578793960626634778" data-draft-id="7578392771921788934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="web3钱包Demo"/> <meta itemprop="keywords" content="web3"/> <meta itemprop="datePublished" content="2025-12-02T03:01:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成长i"/> <meta itemprop="url" content="https://juejin.cn/user/465848663030424"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            web3钱包Demo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848663030424/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成长i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:01:58.000Z" title="Tue Dec 02 2025 03:01:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为了加深自己理解特写一篇基于个人现有理解编写的3.0钱包小Demo，并且每一行关键代码都加注释，记录一下。
giuhub地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjingkais%2Fweb3walletdemo" target="_blank" title="https://github.com/jingkais/web3walletdemo" ref="nofollow noopener noreferrer">github.com/jingkais/we…</a></p>
<h2 data-id="heading-0">项目目录</h2>
<pre><code class="hljs language-scss" lang="scss">com<span class="hljs-selector-class">.learn</span><span class="hljs-selector-class">.web3walletdemo</span>/
├── fragment/
│   ├── BackupPrivateKeyFragment          (备份私钥)
│   ├── CreateWalletFragment              (创建钱包页面)
│   ├── DAppFragment                      (Dapp浏览器界面) 待开发
│   ├── ImportMnemonicFragment            (导入助记词)
│   ├── ImportPrivateKeyFragment          (导入私钥)
│   ├── SettingsFragment                 （设置）待开发
│   ├── TransactionFragment              （交易界面） 待开发
│   └── WalletFragment                   （钱包主界面）
├── model/
│   ├── GasInfo
│   ├── NetworkInfo
│   ├── Transaction<span class="hljs-selector-class">.kt</span>
│   └── Wallet
├── utils/
│   ├── AndroidCryptoHelper   （Android加密辅助工具 - 提供在不同Android版本上安全生成密钥对的方法）
│   ├── SecurityManager  （安全管理器 - 处理敏感数据的加密存储和检索、使用Android Keystore系统保护加密密钥）
│   └── Web3Service<span class="hljs-selector-class">.kt</span>
└── MainActivity 主界面   （创建钱包）
</code></pre>
<h4 data-id="heading-1">总体介绍</h4>
<p>以下是该Demo目前实现的功能：</p>
<ul>
<li>钱包主界面</li>
<li>导入私钥界面</li>
<li>导入助记词界面</li>
<li>创建钱包界面</li>
<li>备份私钥界面</li>
</ul>
<p>待开发功能：</p>
<ul>
<li>交易界面</li>
<li>设置</li>
<li>DApp浏览器界面</li>
<li>...</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> binding: ActivityMainBinding
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> securityManager: SecurityManager

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        securityManager = SecurityManager(<span class="hljs-keyword">this</span>)

        setupBottomNavigation()
        checkWalletExists()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupBottomNavigation</span><span class="hljs-params">()</span></span> {
        binding.bottomNavigation.setOnNavigationItemSelectedListener { item -&gt;
            <span class="hljs-keyword">when</span> (item.itemId) {
                R.id.nav_wallet -&gt; {
                    replaceFragment(WalletFragment())
                    <span class="hljs-literal">true</span>
                }
                R.id.nav_transaction -&gt; {
                    replaceFragment(TransactionFragment())
                    <span class="hljs-literal">true</span>
                }
                R.id.nav_dapp -&gt; {
                    replaceFragment(DAppFragment())
                    <span class="hljs-literal">true</span>
                }
                R.id.nav_settings -&gt; {
                    replaceFragment(SettingsFragment())
                    <span class="hljs-literal">true</span>
                }
                <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">false</span>
            }
        }

        <span class="hljs-keyword">if</span> (securityManager.hasWallets()) {
            replaceFragment(WalletFragment())
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkWalletExists</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (!securityManager.hasWallets()) {
            replaceFragment(CreateWalletFragment())
            binding.bottomNavigation.visibility = View.GONE
        } <span class="hljs-keyword">else</span> {
            binding.bottomNavigation.visibility = View.VISIBLE
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">replaceFragment</span><span class="hljs-params">(fragment: <span class="hljs-type">androidx</span>.<span class="hljs-type">fragment</span>.<span class="hljs-type">app</span>.<span class="hljs-type">Fragment</span>)</span></span> {
        supportFragmentManager.beginTransaction()
            .replace(R.id.fragment_container, fragment)
            .commit()
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showBottomNavigation</span><span class="hljs-params">()</span></span> {
        binding.bottomNavigation.visibility = View.VISIBLE
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hideBottomNavigation</span><span class="hljs-params">()</span></span> {
        binding.bottomNavigation.visibility = View.GONE
    }
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Web3Service</span> {

    companion object {
        <span class="hljs-comment">// 多个可靠的公共 RPC 节点（自动故障转移）</span>
        private val <span class="hljs-variable constant_">SEPOLIA_NODES</span> = <span class="hljs-title function_">listOf</span>(
            <span class="hljs-string">"https://ethereum-sepolia-rpc.publicnode.com"</span>,  <span class="hljs-comment">// 公共节点，无需API密钥</span>
            <span class="hljs-string">"https://rpc.sepolia.org"</span>,                      <span class="hljs-comment">// Sepolia官方RPC</span>
            <span class="hljs-string">"https://sepolia.drpc.org"</span>,                     <span class="hljs-comment">// 备用RPC节点</span>
            <span class="hljs-string">"https://rpc2.sepolia.org"</span>                      <span class="hljs-comment">// 另一个备用节点</span>
        )

        private val <span class="hljs-variable constant_">MAINNET_NODES</span> = <span class="hljs-title function_">listOf</span>(
            <span class="hljs-string">"https://eth.llamarpc.com"</span>,                     <span class="hljs-comment">// 主网公共节点</span>
            <span class="hljs-string">"https://rpc.ankr.com/eth"</span>,                     <span class="hljs-comment">// Ankr提供的节点</span>
            <span class="hljs-string">"https://ethereum.publicnode.com"</span>               <span class="hljs-comment">// 以太坊公共节点</span>
        )

        <span class="hljs-comment">// 区块链网络ID定义</span>
        <span class="hljs-keyword">const</span> val <span class="hljs-variable constant_">SEPOLIA_CHAIN_ID</span> = 11155111L              <span class="hljs-comment">// Sepolia测试网链ID</span>
        <span class="hljs-keyword">const</span> val <span class="hljs-variable constant_">MAINNET_CHAIN_ID</span> = 1L                     <span class="hljs-comment">// 以太坊主网链ID</span>
    }

    <span class="hljs-comment">// 当前使用的RPC节点URL</span>
    private <span class="hljs-keyword">var</span> currentRpcUrl = <span class="hljs-variable constant_">SEPOLIA_NODES</span>[<span class="hljs-number">0</span>]
    <span class="hljs-comment">// Web3j实例，用于与以太坊节点通信</span>
    private <span class="hljs-keyword">var</span> <span class="hljs-attr">web3j</span>: <span class="hljs-title class_">Web3</span>j = <span class="hljs-title class_">Web3</span>j.<span class="hljs-title function_">build</span>(<span class="hljs-title class_">HttpService</span>(currentRpcUrl))
    <span class="hljs-comment">// 当前连接的区块链网络ID</span>
    private <span class="hljs-keyword">var</span> <span class="hljs-attr">currentChainId</span>: <span class="hljs-title class_">Long</span> = <span class="hljs-variable constant_">SEPOLIA_CHAIN_ID</span>
    <span class="hljs-comment">// 标识当前是否连接主网</span>
    private <span class="hljs-keyword">var</span> <span class="hljs-attr">isMainnet</span>: <span class="hljs-title class_">Boolean</span> = <span class="hljs-literal">false</span>

    <span class="hljs-comment">/**
     * 创建新钱包 - 生成新的以太坊钱包地址和私钥
     * <span class="hljs-doctag">@return</span> WalletInfo 包含地址、私钥等钱包信息
     */</span>
    fun <span class="hljs-title function_">createNewWallet</span>(): <span class="hljs-title class_">WalletInfo</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用安全随机数生成器生成私钥</span>
            val secureRandom = <span class="hljs-title class_">SecureRandom</span>()
            val privateKeyBytes = <span class="hljs-title class_">ByteArray</span>(<span class="hljs-number">32</span>) <span class="hljs-comment">// 256位私钥</span>
            secureRandom.<span class="hljs-title function_">nextBytes</span>(privateKeyBytes)

            <span class="hljs-comment">// 将字节数组转换为十六进制字符串（去掉0x前缀）</span>
            val privateKey = <span class="hljs-title class_">Numeric</span>.<span class="hljs-title function_">toHexStringNoPrefix</span>(privateKeyBytes)
            <span class="hljs-comment">// 从私钥创建凭证对象，可以获取地址等信息</span>
            val credentials = <span class="hljs-title class_">Credentials</span>.<span class="hljs-title function_">create</span>(privateKey)

            <span class="hljs-comment">// 返回钱包信息对象</span>
            <span class="hljs-title class_">WalletInfo</span>(
                address = credentials.<span class="hljs-property">address</span>,      <span class="hljs-comment">// 以太坊地址</span>
                mnemonic = <span class="hljs-literal">null</span>,                    <span class="hljs-comment">// 新创建的钱包没有助记词</span>
                privateKey = privateKey,            <span class="hljs-comment">// 原始私钥</span>
                walletFile = <span class="hljs-literal">null</span>                   <span class="hljs-comment">// 不生成钱包文件</span>
            )
        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">Exception</span>) {
            <span class="hljs-comment">// 如果标准方法失败，使用备用方法生成私钥</span>
            val fallbackPrivateKey = <span class="hljs-title function_">generateFallbackPrivateKey</span>()
            val credentials = <span class="hljs-title class_">Credentials</span>.<span class="hljs-title function_">create</span>(fallbackPrivateKey)

            <span class="hljs-title class_">WalletInfo</span>(
                address = credentials.<span class="hljs-property">address</span>,
                mnemonic = <span class="hljs-literal">null</span>,
                privateKey = fallbackPrivateKey,
                walletFile = <span class="hljs-literal">null</span>
            )
        }
    }

    <span class="hljs-comment">/**
     * 通过助记词创建/导入钱包
     * <span class="hljs-doctag">@param</span> mnemonic 助记词字符串
     * <span class="hljs-doctag">@param</span> password 用于加密的钱包密码
     * <span class="hljs-doctag">@return</span> WalletInfo 钱包信息
     */</span>
    fun <span class="hljs-title function_">createWalletFromMnemonic</span>(<span class="hljs-attr">mnemonic</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">password</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">WalletInfo</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 验证助记词格式</span>
            val cleanedMnemonic = mnemonic.<span class="hljs-title function_">trim</span>()
            <span class="hljs-keyword">if</span> (cleanedMnemonic.<span class="hljs-title function_">isEmpty</span>()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Web3Exception</span>(<span class="hljs-string">"助记词不能为空"</span>)
            }

            <span class="hljs-comment">// 分割助记词并验证长度</span>
            val words = cleanedMnemonic.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\s+"</span>.<span class="hljs-title function_">toRegex</span>())
            <span class="hljs-keyword">if</span> (words.<span class="hljs-property">size</span> !<span class="hljs-keyword">in</span> <span class="hljs-title function_">listOf</span>(<span class="hljs-number">12</span>, <span class="hljs-number">15</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>, <span class="hljs-number">24</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Web3Exception</span>(<span class="hljs-string">"助记词应为12、15、18、21或24个单词"</span>)
            }

            <span class="hljs-comment">// 使用 Web3j 从助记词生成种子（基于BIP39标准）</span>
            val seed = <span class="hljs-title class_">MnemonicUtils</span>.<span class="hljs-title function_">generateSeed</span>(cleanedMnemonic, password)

            <span class="hljs-comment">// 从种子生成确定性钱包（简化版本）</span>
            <span class="hljs-comment">// 注意：这是一个简化实现，实际应用中应该使用完整的 BIP44 路径</span>
            val privateKey = <span class="hljs-title function_">generatePrivateKeyFromSeed</span>(seed)
            val credentials = <span class="hljs-title class_">Credentials</span>.<span class="hljs-title function_">create</span>(privateKey)

            <span class="hljs-title class_">WalletInfo</span>(
                address = credentials.<span class="hljs-property">address</span>,
                mnemonic = cleanedMnemonic,     <span class="hljs-comment">// 保存原始助记词</span>
                privateKey = privateKey,        <span class="hljs-comment">// 派生出的私钥</span>
                walletFile = <span class="hljs-literal">null</span>
            )
        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">Exception</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Web3Exception</span>(<span class="hljs-string">"通过助记词创建钱包失败: ${e.message ?: "</span>未知错误<span class="hljs-string">"}"</span>)
        }
    }

    <span class="hljs-comment">/**
     * 从种子生成私钥（简化实现）
     * <span class="hljs-doctag">@param</span> seed BIP39种子字节数组
     * <span class="hljs-doctag">@return</span> 十六进制私钥字符串
     */</span>
    private fun <span class="hljs-title function_">generatePrivateKeyFromSeed</span>(<span class="hljs-attr">seed</span>: <span class="hljs-title class_">ByteArray</span>): <span class="hljs-title class_">String</span> {
        <span class="hljs-comment">// 这是一个简化实现</span>
        <span class="hljs-comment">// 实际应用中应该使用完整的 HD 钱包派生路径（BIP44）</span>
        val secureRandom = <span class="hljs-title class_">SecureRandom</span>(seed)
        val privateKeyBytes = <span class="hljs-title class_">ByteArray</span>(<span class="hljs-number">32</span>)
        secureRandom.<span class="hljs-title function_">nextBytes</span>(privateKeyBytes)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Numeric</span>.<span class="hljs-title function_">toHexStringNoPrefix</span>(privateKeyBytes)
    }

    <span class="hljs-comment">/**
     * 导入私钥钱包
     * <span class="hljs-doctag">@param</span> privateKey 原始私钥字符串
     * <span class="hljs-doctag">@return</span> WalletInfo 钱包信息
     */</span>
    fun importWalletFromPrivateKey(<span class="hljs-attr">privateKey</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">WalletInfo</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> cleanKey = privateKey.<span class="hljs-title function_">trim</span>()

            <span class="hljs-comment">// 移除可能的0x前缀</span>
            <span class="hljs-keyword">if</span> (cleanKey.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"0x"</span>)) {
                cleanKey = cleanKey.<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>)
            }

            <span class="hljs-comment">// 验证私钥长度（64个十六进制字符 = 32字节）</span>
            <span class="hljs-keyword">if</span> (cleanKey.<span class="hljs-property">length</span> != <span class="hljs-number">64</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Web3Exception</span>(<span class="hljs-string">"私钥必须是64个十六进制字符"</span>)
            }

            <span class="hljs-comment">// 验证私钥只包含有效的十六进制字符</span>
            <span class="hljs-keyword">if</span> (!cleanKey.<span class="hljs-title function_">matches</span>(<span class="hljs-title class_">Regex</span>(<span class="hljs-string">"[0-9a-fA-F]+"</span>))) {
                <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Web3Exception</span>(<span class="hljs-string">"私钥包含无效字符"</span>)
            }

            <span class="hljs-comment">// 从私钥创建凭证对象</span>
            val credentials = <span class="hljs-title class_">Credentials</span>.<span class="hljs-title function_">create</span>(cleanKey)

            <span class="hljs-title class_">WalletInfo</span>(
                address = credentials.<span class="hljs-property">address</span>,
                mnemonic = <span class="hljs-literal">null</span>,
                privateKey = cleanKey,      <span class="hljs-comment">// 使用清理后的私钥</span>
                walletFile = <span class="hljs-literal">null</span>
            )
        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">Exception</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Web3Exception</span>(<span class="hljs-string">"导入钱包失败: ${e.message ?: "</span>未知错误<span class="hljs-string">"}"</span>)
        }
    }

    <span class="hljs-comment">/**
     * 备用私钥生成方法 - 当标准方法失败时使用
     * <span class="hljs-doctag">@return</span> 随机生成的私钥字符串
     */</span>
    private fun <span class="hljs-title function_">generateFallbackPrivateKey</span>(): <span class="hljs-title class_">String</span> {
        val random = java.<span class="hljs-property">util</span>.<span class="hljs-title class_">Random</span>()
        val sb = <span class="hljs-title class_">StringBuilder</span>()
        val hexChars = <span class="hljs-string">"0123456789abcdef"</span>
        <span class="hljs-comment">// 生成64个十六进制字符（32字节）</span>
        <span class="hljs-title function_">repeat</span>(<span class="hljs-params"><span class="hljs-number">64</span></span>) {
            sb.<span class="hljs-title function_">append</span>(hexChars[random.<span class="hljs-title function_">nextInt</span>(hexChars.<span class="hljs-property">length</span>)])
        }
        <span class="hljs-keyword">return</span> sb.<span class="hljs-title function_">toString</span>()
    }

    <span class="hljs-comment">/**
     * 查询余额 - 获取指定地址的ETH余额（单位：Wei）
     * <span class="hljs-doctag">@param</span> address 要查询的以太坊地址
     * <span class="hljs-doctag">@return</span> BigInteger 余额（Wei单位）
     */</span>
    suspend fun <span class="hljs-title function_">getBalance</span>(<span class="hljs-attr">address</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">BigInteger</span> {
        <span class="hljs-comment">// 首先验证地址格式</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isValidEthereumAddress</span>(address)) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInteger</span>.<span class="hljs-property">ZERO</span>
        }

        <span class="hljs-comment">// 根据当前网络选择节点列表</span>
        val nodes = <span class="hljs-keyword">if</span> (isMainnet) <span class="hljs-variable constant_">MAINNET_NODES</span> <span class="hljs-keyword">else</span> <span class="hljs-variable constant_">SEPOLIA_NODES</span>
        <span class="hljs-keyword">var</span> <span class="hljs-attr">lastException</span>: <span class="hljs-title class_">Exception</span>? = <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 尝试所有可用节点，实现故障转移</span>
        <span class="hljs-keyword">for</span> (node <span class="hljs-keyword">in</span> nodes) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 为每个节点创建新的Web3j实例</span>
                val tempWeb3j = <span class="hljs-title class_">Web3</span>j.<span class="hljs-title function_">build</span>(<span class="hljs-title class_">HttpService</span>(node))
                <span class="hljs-comment">// 查询最新区块的余额</span>
                val <span class="hljs-attr">ethGetBalance</span>: <span class="hljs-title class_">EthGetBalance</span> = tempWeb3j.<span class="hljs-title function_">ethGetBalance</span>(address, <span class="hljs-title class_">DefaultBlockParameterName</span>.<span class="hljs-property">LATEST</span>).<span class="hljs-title function_">send</span>()

                <span class="hljs-comment">// 如果成功，更新当前使用的节点</span>
                currentRpcUrl = node
                web3j = tempWeb3j

                <span class="hljs-comment">// 返回余额（单位：Wei）</span>
                <span class="hljs-keyword">return</span> ethGetBalance.<span class="hljs-property">balance</span>
            } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">Exception</span>) {
                lastException = e
                <span class="hljs-comment">// 继续尝试下一个节点</span>
            }
        }

        <span class="hljs-comment">// 所有节点都失败，记录错误并返回0</span>
        <span class="hljs-title function_">println</span>(<span class="hljs-string">"所有RPC节点都失败，最后错误: ${lastException?.message}"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInteger</span>.<span class="hljs-property">ZERO</span>
    }

    <span class="hljs-comment">/**
     * 获取格式化的余额 - 将Wei转换为ETH并格式化显示
     * <span class="hljs-doctag">@param</span> address 以太坊地址
     * <span class="hljs-doctag">@return</span> String 格式化后的余额字符串（如 "1.500000 ETH"）
     */</span>
    suspend fun <span class="hljs-title function_">getFormattedBalance</span>(<span class="hljs-attr">address</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">String</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            val balanceWei = <span class="hljs-title function_">getBalance</span>(address)
            <span class="hljs-keyword">if</span> (balanceWei == <span class="hljs-title class_">BigInteger</span>.<span class="hljs-property">ZERO</span>) {
                <span class="hljs-string">"0 ETH"</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 将Wei转换为ETH</span>
                val balanceEth = <span class="hljs-title class_">Convert</span>.<span class="hljs-title function_">fromWei</span>(<span class="hljs-title class_">BigDecimal</span>(balanceWei), <span class="hljs-title class_">Convert</span>.<span class="hljs-property">Unit</span>.<span class="hljs-property">ETHER</span>)
                <span class="hljs-comment">// 保留6位小数并格式化显示</span>
                <span class="hljs-string">"${balanceEth.setScale(6, BigDecimal.ROUND_HALF_UP)} ETH"</span>
            }
        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">Exception</span>) {
            <span class="hljs-string">"0 ETH"</span> <span class="hljs-comment">// 发生错误时返回0</span>
        }
    }

    <span class="hljs-comment">/**
     * 获取美元估值 - 计算余额的美元价值（使用固定汇率）
     * <span class="hljs-doctag">@param</span> address 以太坊地址
     * <span class="hljs-doctag">@return</span> String 美元价值字符串（如 "$2700.00"）
     */</span>
    suspend fun <span class="hljs-title function_">getBalanceInUSD</span>(<span class="hljs-attr">address</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">String</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            val balanceWei = <span class="hljs-title function_">getBalance</span>(address)
            <span class="hljs-keyword">if</span> (balanceWei == <span class="hljs-title class_">BigInteger</span>.<span class="hljs-property">ZERO</span>) {
                <span class="hljs-string">"$0.00"</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 将Wei转换为ETH</span>
                val balanceEth = <span class="hljs-title class_">Convert</span>.<span class="hljs-title function_">fromWei</span>(<span class="hljs-title class_">BigDecimal</span>(balanceWei), <span class="hljs-title class_">Convert</span>.<span class="hljs-property">Unit</span>.<span class="hljs-property">ETHER</span>)
                <span class="hljs-comment">// 使用固定汇率计算美元价值（实际应用中应该使用实时汇率）</span>
                val usdValue = balanceEth.<span class="hljs-title function_">toDouble</span>() * <span class="hljs-number">1800.0</span>
                <span class="hljs-comment">// 格式化美元金额</span>
                <span class="hljs-string">"$${String.format("</span>%.2f<span class="hljs-string">", usdValue)}"</span>
            }
        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">Exception</span>) {
            <span class="hljs-string">"$0.00"</span> <span class="hljs-comment">// 发生错误时返回$0.00</span>
        }
    }

    <span class="hljs-comment">/**
     * 验证以太坊地址格式
     * <span class="hljs-doctag">@param</span> address 要验证的地址字符串
     * <span class="hljs-doctag">@return</span> Boolean 是否为有效的以太坊地址格式
     */</span>
    fun <span class="hljs-title function_">isValidEthereumAddress</span>(<span class="hljs-attr">address</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">Boolean</span> {
        <span class="hljs-comment">// 正则表达式验证：以0x开头，后跟40个十六进制字符</span>
        <span class="hljs-keyword">return</span> address.<span class="hljs-title function_">matches</span>(<span class="hljs-title class_">Regex</span>(<span class="hljs-string">"^0x[a-fA-F0-9]{40}$"</span>))
    }

    <span class="hljs-comment">/**
     * 切换网络 - 在主网和测试网之间切换
     * <span class="hljs-doctag">@param</span> useMainnet 是否切换到主网
     */</span>
    fun <span class="hljs-title function_">switchNetwork</span>(<span class="hljs-params">useMainnet: <span class="hljs-built_in">Boolean</span></span>) {
        isMainnet = useMainnet
        currentChainId = <span class="hljs-keyword">if</span> (useMainnet) <span class="hljs-variable constant_">MAINNET_CHAIN_ID</span> <span class="hljs-keyword">else</span> <span class="hljs-variable constant_">SEPOLIA_CHAIN_ID</span>
        currentRpcUrl = <span class="hljs-keyword">if</span> (useMainnet) <span class="hljs-variable constant_">MAINNET_NODES</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> <span class="hljs-variable constant_">SEPOLIA_NODES</span>[<span class="hljs-number">0</span>]
        <span class="hljs-comment">// 重新创建Web3j实例连接到新网络</span>
        web3j = <span class="hljs-title class_">Web3</span>j.<span class="hljs-title function_">build</span>(<span class="hljs-title class_">HttpService</span>(currentRpcUrl))
    }

    <span class="hljs-comment">/**
     * 获取当前网络信息
     * <span class="hljs-doctag">@return</span> NetworkInfo 包含网络名称、RPC URL、链ID等信息
     */</span>
    fun <span class="hljs-title function_">getCurrentNetworkInfo</span>(): <span class="hljs-title class_">NetworkInfo</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (isMainnet) {
            <span class="hljs-title class_">NetworkInfo</span>(
                name = <span class="hljs-string">"Ethereum Mainnet"</span>,          <span class="hljs-comment">// 主网名称</span>
                rpcUrl = currentRpcUrl,             <span class="hljs-comment">// 当前RPC URL</span>
                chainId = <span class="hljs-variable constant_">MAINNET_CHAIN_ID</span>,         <span class="hljs-comment">// 主网链ID</span>
                symbol = <span class="hljs-string">"ETH"</span>,                     <span class="hljs-comment">// 代币符号</span>
                explorerUrl = <span class="hljs-string">"https://etherscan.io"</span> <span class="hljs-comment">// 区块浏览器URL</span>
            )
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title class_">NetworkInfo</span>(
                name = <span class="hljs-string">"Sepolia Testnet"</span>,           <span class="hljs-comment">// 测试网名称</span>
                rpcUrl = currentRpcUrl,
                chainId = <span class="hljs-variable constant_">SEPOLIA_CHAIN_ID</span>,         <span class="hljs-comment">// 测试网链ID</span>
                symbol = <span class="hljs-string">"ETH"</span>,
                explorerUrl = <span class="hljs-string">"https://sepolia.etherscan.io"</span> <span class="hljs-comment">// 测试网区块浏览器</span>
            )
        }
    }

    <span class="hljs-comment">/**
     * 测试网络连接 - 检查当前节点是否可用
     * <span class="hljs-doctag">@return</span> Boolean 连接是否成功
     */</span>
    suspend fun <span class="hljs-title function_">testNetworkConnection</span>(): <span class="hljs-title class_">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用零地址进行简单的余额查询来测试连接</span>
            val testAddress = <span class="hljs-string">"0x0000000000000000000000000000000000000000"</span>
            web3j.<span class="hljs-title function_">ethGetBalance</span>(testAddress, <span class="hljs-title class_">DefaultBlockParameterName</span>.<span class="hljs-property">LATEST</span>).<span class="hljs-title function_">send</span>()
            <span class="hljs-literal">true</span> <span class="hljs-comment">// 如果没有异常，说明连接成功</span>
        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">Exception</span>) {
            <span class="hljs-literal">false</span> <span class="hljs-comment">// 发生异常，连接失败</span>
        }
    }
}
</code></pre>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">/**
 * 安全管理器 - 处理敏感数据的加密存储和检索
 * 使用Android Keystore系统保护加密密钥
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityManager</span>(private val <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>) {

    companion object {
        private <span class="hljs-keyword">const</span> val <span class="hljs-variable constant_">ANDROID_KEYSTORE</span> = <span class="hljs-string">"AndroidKeyStore"</span>  <span class="hljs-comment">// Android密钥库提供者</span>
        private <span class="hljs-keyword">const</span> val <span class="hljs-variable constant_">KEY_ALIAS</span> = <span class="hljs-string">"Web3Wallet_Key"</span>          <span class="hljs-comment">// 密钥别名</span>
        private <span class="hljs-keyword">const</span> val <span class="hljs-variable constant_">SHARED_PREFS_NAME</span> = <span class="hljs-string">"encrypted_web3_prefs"</span> <span class="hljs-comment">// 加密共享偏好名称</span>
        private <span class="hljs-keyword">const</span> val <span class="hljs-variable constant_">TRANSFORMATION</span> = <span class="hljs-string">"AES/GCM/NoPadding"</span>  <span class="hljs-comment">// 加密算法和模式</span>
        private <span class="hljs-keyword">const</span> val <span class="hljs-variable constant_">IV_LENGTH</span> = <span class="hljs-number">12</span>                        <span class="hljs-comment">// 初始化向量长度（字节）</span>
    }

    <span class="hljs-comment">// Android密钥库实例</span>
    private val <span class="hljs-attr">keyStore</span>: <span class="hljs-title class_">KeyStore</span> = <span class="hljs-title class_">KeyStore</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable constant_">ANDROID_KEYSTORE</span>).<span class="hljs-property">apply</span> {
        <span class="hljs-title function_">load</span>(<span class="hljs-literal">null</span>) <span class="hljs-comment">// 加载密钥库</span>
    }

    <span class="hljs-comment">// 主密钥，用于加密共享偏好设置</span>
    private val <span class="hljs-attr">masterKey</span>: <span class="hljs-title class_">MasterKey</span> by lazy {
        <span class="hljs-title class_">MasterKey</span>.<span class="hljs-title class_">Builder</span>(context)
            .<span class="hljs-title function_">setKeyScheme</span>(<span class="hljs-title class_">MasterKey</span>.<span class="hljs-property">KeyScheme</span>.<span class="hljs-property">AES256_GCM</span>) <span class="hljs-comment">// 使用AES256-GCM加密方案</span>
            .<span class="hljs-title function_">build</span>()
    }

    <span class="hljs-comment">// 加密的共享偏好设置实例</span>
    private val encryptedPrefs by lazy {
        <span class="hljs-title class_">EncryptedSharedPreferences</span>.<span class="hljs-title function_">create</span>(
            context,
            <span class="hljs-variable constant_">SHARED_PREFS_NAME</span>,
            masterKey,
            <span class="hljs-title class_">EncryptedSharedPreferences</span>.<span class="hljs-property">PrefKeyEncryptionScheme</span>.<span class="hljs-property">AES256_SIV</span>,    <span class="hljs-comment">// 键加密方案</span>
            <span class="hljs-title class_">EncryptedSharedPreferences</span>.<span class="hljs-property">PrefValueEncryptionScheme</span>.<span class="hljs-property">AES256_GCM</span>   <span class="hljs-comment">// 值加密方案</span>
        )
    }

    <span class="hljs-comment">/**
     * 获取或创建加密密钥 - 使用Android Keystore保护密钥
     * <span class="hljs-doctag">@return</span> SecretKey 加密密钥
     */</span>
    @<span class="hljs-title class_">RequiresApi</span>(<span class="hljs-title class_">Build</span>.<span class="hljs-property">VERSION_CODES</span>.<span class="hljs-property">M</span>)
    private fun <span class="hljs-title function_">getOrCreateSecretKey</span>(): <span class="hljs-title class_">SecretKey</span> {
        <span class="hljs-comment">// 检查密钥是否已存在</span>
        <span class="hljs-keyword">if</span> (!keyStore.<span class="hljs-title function_">containsAlias</span>(<span class="hljs-variable constant_">KEY_ALIAS</span>)) {
            <span class="hljs-comment">// 创建新的密钥生成器</span>
            val keyGenerator = <span class="hljs-title class_">KeyGenerator</span>.<span class="hljs-title function_">getInstance</span>(
                <span class="hljs-title class_">KeyProperties</span>.<span class="hljs-property">KEY_ALGORITHM_AES</span>,
                <span class="hljs-variable constant_">ANDROID_KEYSTORE</span>
            )

            <span class="hljs-comment">// 配置密钥生成参数</span>
            val keyGenParameterSpec = <span class="hljs-title class_">KeyGenParameterSpec</span>.<span class="hljs-title class_">Builder</span>(
                <span class="hljs-variable constant_">KEY_ALIAS</span>,
                <span class="hljs-title class_">KeyProperties</span>.<span class="hljs-property">PURPOSE_ENCRYPT</span> or <span class="hljs-title class_">KeyProperties</span>.<span class="hljs-property">PURPOSE_DECRYPT</span> <span class="hljs-comment">// 密钥用途</span>
            )
                .<span class="hljs-title function_">setBlockModes</span>(<span class="hljs-title class_">KeyProperties</span>.<span class="hljs-property">BLOCK_MODE_GCM</span>)       <span class="hljs-comment">// 使用GCM分组模式</span>
                .<span class="hljs-title function_">setEncryptionPaddings</span>(<span class="hljs-title class_">KeyProperties</span>.<span class="hljs-property">ENCRYPTION_PADDING_NONE</span>) <span class="hljs-comment">// 无填充</span>
                .<span class="hljs-title function_">setKeySize</span>(<span class="hljs-number">256</span>)                                   <span class="hljs-comment">// 256位密钥</span>
                .<span class="hljs-title function_">build</span>()

            keyGenerator.<span class="hljs-title function_">init</span>(keyGenParameterSpec)
            keyGenerator.<span class="hljs-title function_">generateKey</span>() <span class="hljs-comment">// 生成密钥</span>
        }

        <span class="hljs-comment">// 返回已存在的密钥</span>
        <span class="hljs-keyword">return</span> keyStore.<span class="hljs-title function_">getKey</span>(<span class="hljs-variable constant_">KEY_ALIAS</span>, <span class="hljs-literal">null</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">SecretKey</span>
    }

    <span class="hljs-comment">/**
     * 加密数据 - 使用AES-GCM加密算法
     * <span class="hljs-doctag">@param</span> plaintext 要加密的明文
     * <span class="hljs-doctag">@return</span> String Base64编码的加密数据
     */</span>
    @<span class="hljs-title class_">RequiresApi</span>(<span class="hljs-title class_">Build</span>.<span class="hljs-property">VERSION_CODES</span>.<span class="hljs-property">M</span>)
    fun <span class="hljs-title function_">encryptData</span>(<span class="hljs-attr">plaintext</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">String</span> {
        <span class="hljs-comment">// 获取密码器实例</span>
        val cipher = <span class="hljs-title class_">Cipher</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable constant_">TRANSFORMATION</span>)
        <span class="hljs-comment">// 初始化为加密模式</span>
        cipher.<span class="hljs-title function_">init</span>(<span class="hljs-title class_">Cipher</span>.<span class="hljs-property">ENCRYPT_MODE</span>, <span class="hljs-title function_">getOrCreateSecretKey</span>())

        val iv = cipher.<span class="hljs-property">iv</span> <span class="hljs-comment">// 获取初始化向量</span>
        val encrypted = cipher.<span class="hljs-title function_">doFinal</span>(plaintext.<span class="hljs-title function_">toByteArray</span>(<span class="hljs-title class_">Charsets</span>.<span class="hljs-property">UTF_8</span>)) <span class="hljs-comment">// 执行加密</span>

        <span class="hljs-comment">// 组合IV和加密数据</span>
        val combined = <span class="hljs-title class_">ByteArray</span>(iv.<span class="hljs-property">size</span> + encrypted.<span class="hljs-property">size</span>)
        <span class="hljs-title class_">System</span>.<span class="hljs-title function_">arraycopy</span>(iv, <span class="hljs-number">0</span>, combined, <span class="hljs-number">0</span>, iv.<span class="hljs-property">size</span>)              <span class="hljs-comment">// 复制IV到前面</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-title function_">arraycopy</span>(encrypted, <span class="hljs-number">0</span>, combined, iv.<span class="hljs-property">size</span>, encrypted.<span class="hljs-property">size</span>) <span class="hljs-comment">// 复制加密数据到后面</span>

        <span class="hljs-comment">// 返回Base64编码的字符串</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">encodeToString</span>(combined, <span class="hljs-title class_">Base64</span>.<span class="hljs-property">DEFAULT</span>)
    }

    <span class="hljs-comment">/**
     * 解密数据 - 使用AES-GCM解密算法
     * <span class="hljs-doctag">@param</span> encryptedData Base64编码的加密数据
     * <span class="hljs-doctag">@return</span> String 解密后的明文
     */</span>
    @<span class="hljs-title class_">RequiresApi</span>(<span class="hljs-title class_">Build</span>.<span class="hljs-property">VERSION_CODES</span>.<span class="hljs-property">M</span>)
    fun <span class="hljs-title function_">decryptData</span>(<span class="hljs-attr">encryptedData</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">String</span> {
        <span class="hljs-comment">// 解码Base64字符串</span>
        val combined = <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">decode</span>(encryptedData, <span class="hljs-title class_">Base64</span>.<span class="hljs-property">DEFAULT</span>)

        <span class="hljs-comment">// 分离IV和加密数据</span>
        val iv = <span class="hljs-title class_">ByteArray</span>(<span class="hljs-variable constant_">IV_LENGTH</span>)
        val encrypted = <span class="hljs-title class_">ByteArray</span>(combined.<span class="hljs-property">size</span> - <span class="hljs-variable constant_">IV_LENGTH</span>)

        <span class="hljs-title class_">System</span>.<span class="hljs-title function_">arraycopy</span>(combined, <span class="hljs-number">0</span>, iv, <span class="hljs-number">0</span>, <span class="hljs-variable constant_">IV_LENGTH</span>)            <span class="hljs-comment">// 提取IV</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-title function_">arraycopy</span>(combined, <span class="hljs-variable constant_">IV_LENGTH</span>, encrypted, <span class="hljs-number">0</span>, encrypted.<span class="hljs-property">size</span>) <span class="hljs-comment">// 提取加密数据</span>

        <span class="hljs-comment">// 获取密码器实例</span>
        val cipher = <span class="hljs-title class_">Cipher</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable constant_">TRANSFORMATION</span>)
        <span class="hljs-comment">// 配置GCM参数（128位认证标签）</span>
        val spec = <span class="hljs-title class_">GCMParameterSpec</span>(<span class="hljs-number">128</span>, iv)
        <span class="hljs-comment">// 初始化为解密模式</span>
        cipher.<span class="hljs-title function_">init</span>(<span class="hljs-title class_">Cipher</span>.<span class="hljs-property">DECRYPT_MODE</span>, <span class="hljs-title function_">getOrCreateSecretKey</span>(), spec)

        <span class="hljs-comment">// 执行解密</span>
        val decrypted = cipher.<span class="hljs-title function_">doFinal</span>(encrypted)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(decrypted, <span class="hljs-title class_">Charsets</span>.<span class="hljs-property">UTF_8</span>)
    }

    <span class="hljs-comment">/**
     * 安全存储字符串 - 使用加密的共享偏好设置
     * <span class="hljs-doctag">@param</span> key 键
     * <span class="hljs-doctag">@param</span> value 值
     */</span>
    fun <span class="hljs-title function_">securePutString</span>(<span class="hljs-params">key: <span class="hljs-built_in">String</span>, value: <span class="hljs-built_in">String</span></span>) {
        encryptedPrefs.<span class="hljs-title function_">edit</span>().<span class="hljs-title function_">putString</span>(key, value).<span class="hljs-title function_">apply</span>()
    }

    <span class="hljs-comment">/**
     * 安全获取字符串 - 从加密的共享偏好设置中读取
     * <span class="hljs-doctag">@param</span> key 键
     * <span class="hljs-doctag">@param</span> defaultValue 默认值
     * <span class="hljs-doctag">@return</span> String 获取的值或默认值
     */</span>
    fun <span class="hljs-title function_">secureGetString</span>(<span class="hljs-attr">key</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">defaultValue</span>: <span class="hljs-title class_">String</span> = <span class="hljs-string">""</span>): <span class="hljs-title class_">String</span> {
        <span class="hljs-keyword">return</span> encryptedPrefs.<span class="hljs-title function_">getString</span>(key, defaultValue) ?: defaultValue
    }

    <span class="hljs-comment">/**
     * 保存钱包数据 - 存储加密的钱包信息
     * <span class="hljs-doctag">@param</span> walletAddress 钱包地址
     * <span class="hljs-doctag">@param</span> encryptedPrivateKey 加密的私钥
     * <span class="hljs-doctag">@param</span> encryptedMnemonic 加密的助记词（可为空）
     */</span>
    fun <span class="hljs-title function_">saveWalletData</span>(<span class="hljs-params">walletAddress: <span class="hljs-built_in">String</span>, encryptedPrivateKey: <span class="hljs-built_in">String</span>, encryptedMnemonic: <span class="hljs-built_in">String</span>?</span>) {
        <span class="hljs-comment">// 使用地址作为键的一部分存储私钥</span>
        <span class="hljs-title function_">securePutString</span>(<span class="hljs-string">"wallet_${walletAddress}_private"</span>, encryptedPrivateKey)
        <span class="hljs-comment">// 如果存在助记词，也存储</span>
        encryptedMnemonic?.<span class="hljs-property">let</span> {
            <span class="hljs-title function_">securePutString</span>(<span class="hljs-string">"wallet_${walletAddress}_mnemonic"</span>, it)
        }
        <span class="hljs-comment">// 设置当前钱包</span>
        <span class="hljs-title function_">securePutString</span>(<span class="hljs-string">"current_wallet"</span>, walletAddress)

        <span class="hljs-comment">// 更新钱包列表</span>
        val wallets = <span class="hljs-title function_">getWalletList</span>().<span class="hljs-title function_">toMutableSet</span>()
        wallets.<span class="hljs-title function_">add</span>(walletAddress)
        <span class="hljs-title function_">securePutString</span>(<span class="hljs-string">"wallet_list"</span>, wallets.<span class="hljs-title function_">joinToString</span>(<span class="hljs-string">","</span>))
    }

    <span class="hljs-comment">/**
     * 获取钱包私钥 - 解密并返回私钥
     * <span class="hljs-doctag">@param</span> walletAddress 钱包地址
     * <span class="hljs-doctag">@return</span> String? 解密后的私钥，如果不存在则返回null
     */</span>
    @<span class="hljs-title class_">RequiresApi</span>(<span class="hljs-title class_">Build</span>.<span class="hljs-property">VERSION_CODES</span>.<span class="hljs-property">M</span>)
    fun <span class="hljs-title function_">getWalletPrivateKey</span>(<span class="hljs-attr">walletAddress</span>: <span class="hljs-title class_">String</span>): <span class="hljs-title class_">String</span>? {
        val encrypted = <span class="hljs-title function_">secureGetString</span>(<span class="hljs-string">"wallet_${walletAddress}_private"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (encrypted.<span class="hljs-title function_">isNotEmpty</span>()) <span class="hljs-title function_">decryptData</span>(encrypted) <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">/**
     * 获取钱包列表 - 返回所有已保存的钱包地址
     * <span class="hljs-doctag">@return</span> Set&lt;String&gt; 钱包地址集合
     */</span>
    fun <span class="hljs-title function_">getWalletList</span>(): <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; {
        val listStr = <span class="hljs-title function_">secureGetString</span>(<span class="hljs-string">"wallet_list"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (listStr.<span class="hljs-title function_">isEmpty</span>()) <span class="hljs-title function_">emptySet</span>() <span class="hljs-keyword">else</span> listStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">","</span>).<span class="hljs-title function_">toSet</span>()
    }

    <span class="hljs-comment">/**
     * 获取当前钱包地址
     * <span class="hljs-doctag">@return</span> String? 当前钱包地址，如果不存在则返回null
     */</span>
    fun <span class="hljs-title function_">getCurrentWallet</span>(): <span class="hljs-title class_">String</span>? {
        val address = <span class="hljs-title function_">secureGetString</span>(<span class="hljs-string">"current_wallet"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (address.<span class="hljs-title function_">isNotEmpty</span>()) address <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">/**
     * 检查是否存在钱包
     * <span class="hljs-doctag">@return</span> Boolean 是否存在至少一个钱包
     */</span>
    fun <span class="hljs-title function_">hasWallets</span>(): <span class="hljs-title class_">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getWalletList</span>().<span class="hljs-title function_">isNotEmpty</span>()
    }

    <span class="hljs-comment">/**
     * 清除所有数据 - 删除所有存储的钱包信息
     */</span>
    fun <span class="hljs-title function_">clearAllData</span>(<span class="hljs-params"/>) {
        encryptedPrefs.<span class="hljs-title function_">edit</span>().<span class="hljs-title function_">clear</span>().<span class="hljs-title function_">apply</span>()
    }
}

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * Android加密辅助工具 - 提供在不同Android版本上安全生成密钥对的方法
 */</span>
<span class="hljs-keyword">object</span> AndroidCryptoHelper {

    <span class="hljs-comment">/**
     * 在 Android 上安全生成 EC 密钥对 - 支持多种备用方法
     * <span class="hljs-doctag">@return</span> ECKeyPair 椭圆曲线密钥对
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateEcKeyPair</span><span class="hljs-params">()</span></span>: ECKeyPair {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 方法1: 尝试使用 Web3j 的标准方法（最高效）</span>
            Keys.createEcKeyPair()
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 方法2: 如果标准方法失败，使用 Android 兼容的API</span>
            <span class="hljs-keyword">try</span> {
                generateEcKeyPairWithAndroidAPI()
            } <span class="hljs-keyword">catch</span> (e2: Exception) {
                <span class="hljs-comment">// 方法3: 最终回退方法 - 使用安全的随机数生成</span>
                generateEcKeyPairFallback()
            }
        }
    }

    <span class="hljs-comment">/**
     * 使用 Android API 生成 EC 密钥对 - 兼容性更好的方法
     * <span class="hljs-doctag">@return</span> ECKeyPair 椭圆曲线密钥对
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateEcKeyPairWithAndroidAPI</span><span class="hljs-params">()</span></span>: ECKeyPair {
        <span class="hljs-comment">// 获取EC密钥对生成器实例</span>
        <span class="hljs-keyword">val</span> keyPairGenerator = KeyPairGenerator.getInstance(<span class="hljs-string">"EC"</span>)
        <span class="hljs-comment">// 指定使用secp256k1曲线（比特币和以太坊使用的曲线）</span>
        <span class="hljs-keyword">val</span> ecGenParameterSpec = ECGenParameterSpec(<span class="hljs-string">"secp256k1"</span>)
        <span class="hljs-comment">// 使用安全随机数初始化生成器</span>
        keyPairGenerator.initialize(ecGenParameterSpec, SecureRandom())
        <span class="hljs-comment">// 生成密钥对</span>
        <span class="hljs-keyword">val</span> keyPair = keyPairGenerator.generateKeyPair()

        <span class="hljs-comment">// 提取私钥和公钥</span>
        <span class="hljs-keyword">val</span> privateKey = keyPair.<span class="hljs-keyword">private</span>
        <span class="hljs-keyword">val</span> publicKey = keyPair.<span class="hljs-keyword">public</span>

        <span class="hljs-comment">// 转换为 Web3j 的 ECKeyPair 格式</span>
        <span class="hljs-comment">// 注意：这是一个简化实现，实际应用中需要更复杂的转换</span>
        <span class="hljs-keyword">val</span> privateKeyBytes = privateKey.encoded
        <span class="hljs-keyword">val</span> publicKeyBytes = publicKey.encoded

        <span class="hljs-comment">// 使用 Web3j 的工具从字节创建密钥对</span>
        <span class="hljs-keyword">return</span> ECKeyPair.create(privateKeyBytes)
    }

    <span class="hljs-comment">/**
     * 回退方法 - 使用安全的随机数生成私钥（最基础但可靠的方法）
     * <span class="hljs-doctag">@return</span> ECKeyPair 椭圆曲线密钥对
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateEcKeyPairFallback</span><span class="hljs-params">()</span></span>: ECKeyPair {
        <span class="hljs-comment">// 使用安全随机数生成器</span>
        <span class="hljs-keyword">val</span> secureRandom = SecureRandom()
        <span class="hljs-keyword">val</span> privateKeyBytes = ByteArray(<span class="hljs-number">32</span>) <span class="hljs-comment">// 32字节 = 256位</span>
        secureRandom.nextBytes(privateKeyBytes) <span class="hljs-comment">// 填充随机字节</span>

        <span class="hljs-comment">// 使用 Web3j 从字节创建密钥对</span>
        <span class="hljs-keyword">return</span> ECKeyPair.create(privateKeyBytes)
    }

    <span class="hljs-comment">/**
     * 验证私钥格式 - 检查私钥是否符合以太坊标准
     * <span class="hljs-doctag">@param</span> privateKey 要验证的私钥字符串
     * <span class="hljs-doctag">@return</span> Boolean 是否为有效的私钥格式
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isValidPrivateKey</span><span class="hljs-params">(privateKey: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 移除可能的 0x 前缀</span>
            <span class="hljs-keyword">val</span> cleanKey = <span class="hljs-keyword">if</span> (privateKey.startsWith(<span class="hljs-string">"0x"</span>)) {
                privateKey.substring(<span class="hljs-number">2</span>)
            } <span class="hljs-keyword">else</span> {
                privateKey
            }

            <span class="hljs-comment">// 检查长度 (64个十六进制字符 = 32字节) 和字符有效性</span>
            cleanKey.length == <span class="hljs-number">64</span> &amp;&amp; cleanKey.matches(Regex(<span class="hljs-string">"[0-9a-fA-F]+"</span>))
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-literal">false</span> <span class="hljs-comment">// 任何异常都视为无效格式</span>
        }
    }

    <span class="hljs-comment">/**
     * 标准化私钥格式 - 统一私钥的表示格式
     * <span class="hljs-doctag">@param</span> privateKey 原始私钥字符串
     * <span class="hljs-doctag">@return</span> String 标准化后的私钥（小写，无0x前缀）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">normalizePrivateKey</span><span class="hljs-params">(privateKey: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">var</span> cleanKey = privateKey.trim()
        <span class="hljs-comment">// 移除0x前缀</span>
        <span class="hljs-keyword">if</span> (cleanKey.startsWith(<span class="hljs-string">"0x"</span>)) {
            cleanKey = cleanKey.substring(<span class="hljs-number">2</span>)
        }
        <span class="hljs-comment">// 转换为小写确保一致性</span>
        <span class="hljs-keyword">return</span> cleanKey.toLowerCase()
    }
}

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 钱包主界面
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WalletFragment</span> : <span class="hljs-type">Fragment</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentWalletBinding? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> securityManager: SecurityManager
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> web3Service: Web3Service
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentAddress: String? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?,
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View {
        _binding = FragmentWalletBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> binding.root
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)

        securityManager = SecurityManager(requireContext())
        web3Service = Web3Service()

        setupUI()
        loadWalletData()
        setupClickListeners()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span> {
        currentAddress = securityManager.getCurrentWallet()
        currentAddress?.let { address -&gt;
            binding.tvAddress.text = formatAddress(address)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadWalletData</span><span class="hljs-params">()</span></span> {
        currentAddress?.let { address -&gt;
            lifecycleScope.launch {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> balance = web3Service.getBalance(address)
                    <span class="hljs-keyword">val</span> etherBalance = Convert.fromWei(BigDecimal(balance), Convert.<span class="hljs-built_in">Unit</span>.ETHER)

                    binding.tvBalance.text = <span class="hljs-string">"<span class="hljs-subst">${etherBalance.setScale(<span class="hljs-number">4</span>, BigDecimal.ROUND_HALF_UP)}</span> ETH"</span>
                    binding.tvBalanceFiat.text = <span class="hljs-string">"≈ $<span class="hljs-subst">${(etherBalance.toDouble() * <span class="hljs-number">1800</span>).format(<span class="hljs-number">2</span>)}</span>"</span>

                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    showError(<span class="hljs-string">"获取余额失败: <span class="hljs-subst">${e.message}</span>"</span>)
                }
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupClickListeners</span><span class="hljs-params">()</span></span> {
        binding.btnCopyAddress.setOnClickListener {
            currentAddress?.let { address -&gt;
                copyToClipboard(address)
                showMessage(<span class="hljs-string">"地址已复制到剪贴板"</span>)
            }
        }

        binding.btnSend.setOnClickListener {
            showMessage(<span class="hljs-string">"发送功能开发中..."</span>)
        }

        binding.btnReceive.setOnClickListener {
            showMessage(<span class="hljs-string">"接收功能开发中..."</span>)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatAddress</span><span class="hljs-params">(address: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (address.length &gt; <span class="hljs-number">12</span>) {
            <span class="hljs-string">"<span class="hljs-subst">${address.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>)}</span>...<span class="hljs-subst">${address.substring(address.length - <span class="hljs-number">6</span>)}</span>"</span>
        } <span class="hljs-keyword">else</span> {
            address
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">copyToClipboard</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> clipboard = requireContext().getSystemService(Context.CLIPBOARD_SERVICE) <span class="hljs-keyword">as</span> ClipboardManager
        <span class="hljs-keyword">val</span> clip = ClipData.newPlainText(<span class="hljs-string">"钱包地址"</span>, text)
        clipboard.setPrimaryClip(clip)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_SHORT).show()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showError</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_LONG).show()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-built_in">Double</span>.<span class="hljs-title">format</span><span class="hljs-params">(digits: <span class="hljs-type">Int</span>)</span></span> = <span class="hljs-string">"%.<span class="hljs-subst">${digits}</span>f"</span>.format(<span class="hljs-keyword">this</span>)

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroyView()
        _binding = <span class="hljs-literal">null</span>
    }
}

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 设置
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SettingsFragment</span> : <span class="hljs-type">Fragment</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentSettingsBinding? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> securityManager: SecurityManager

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?,
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View {
        _binding = FragmentSettingsBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> binding.root
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)

        securityManager = SecurityManager(requireContext())

        binding.btnClearData.setOnClickListener {
            securityManager.clearAllData()
            showMessage(<span class="hljs-string">"数据已清除"</span>)

            requireActivity().supportFragmentManager.beginTransaction()
                .replace(R.id.fragment_container, CreateWalletFragment())
                .commit()

            (requireActivity() <span class="hljs-keyword">as</span> MainActivity).hideBottomNavigation()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_SHORT)
            .show()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroyView()
        _binding = <span class="hljs-literal">null</span>
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 导入私钥页面
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportPrivateKeyFragment</span> : <span class="hljs-type">Fragment</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentImportPrivateKeyBinding? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> securityManager: SecurityManager
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> web3Service: Web3Service

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?,
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View {
        _binding = FragmentImportPrivateKeyBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> binding.root
    }

    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)

        securityManager = SecurityManager(requireContext())
        web3Service = Web3Service()

        binding.btnImport.setOnClickListener {
            importWalletFromPrivateKey()
        }
    }

    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">importWalletFromPrivateKey</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> privateKey = binding.etPrivateKey.text.toString().trim()

        <span class="hljs-keyword">if</span> (privateKey.isEmpty()) {
            showError(<span class="hljs-string">"请输入私钥"</span>)
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> credentials = web3Service.importWalletFromPrivateKey(privateKey)

            <span class="hljs-keyword">val</span> encryptedPrivateKey = securityManager.encryptData(privateKey)

            securityManager.saveWalletData(
                credentials.address,
                encryptedPrivateKey,
                <span class="hljs-literal">null</span>
            )

            (requireActivity() <span class="hljs-keyword">as</span> MainActivity).showBottomNavigation()
            requireActivity().supportFragmentManager.beginTransaction()
                .replace(R.id.fragment_container, com.learn.web3walletdemo.ui.wallet.WalletFragment())
                .commit()

            showMessage(<span class="hljs-string">"钱包导入成功"</span>)

        } <span class="hljs-keyword">catch</span> (e: Exception) {
            showError(<span class="hljs-string">"导入钱包失败: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showError</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_LONG).show()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_SHORT).show()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroyView()
        _binding = <span class="hljs-literal">null</span>
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 导入助记词页面
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportMnemonicFragment</span> : <span class="hljs-type">Fragment</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentImportMnemonicBinding? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> securityManager: SecurityManager
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> web3Service: Web3Service

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?,
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View {
        _binding = FragmentImportMnemonicBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> binding.root
    }

    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)

        securityManager = SecurityManager(requireContext())
        web3Service = Web3Service()

        binding.btnImport.setOnClickListener {
            importWalletFromMnemonic()
        }
    }

    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">importWalletFromMnemonic</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> mnemonic = binding.etMnemonic.text.toString().trim()

        <span class="hljs-keyword">if</span> (mnemonic.isEmpty()) {
            showError(<span class="hljs-string">"请输入助记词"</span>)
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> password = <span class="hljs-string">"default_password"</span>
            <span class="hljs-keyword">val</span> walletInfo = web3Service.createWalletFromMnemonic(mnemonic, password)

            <span class="hljs-keyword">val</span> encryptedPrivateKey = securityManager.encryptData(walletInfo.privateKey)
            <span class="hljs-keyword">val</span> encryptedMnemonic = securityManager.encryptData(mnemonic)

            securityManager.saveWalletData(
                walletInfo.address,
                encryptedPrivateKey,
                encryptedMnemonic
            )

            (requireActivity() <span class="hljs-keyword">as</span> MainActivity).showBottomNavigation()
            requireActivity().supportFragmentManager.beginTransaction()
                .replace(R.id.fragment_container, WalletFragment())
                .commit()

            showMessage(<span class="hljs-string">"钱包导入成功"</span>)

        } <span class="hljs-keyword">catch</span> (e: Exception) {
            showError(<span class="hljs-string">"导入钱包失败: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showError</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_LONG).show()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_SHORT).show()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroyView()
        _binding = <span class="hljs-literal">null</span>
    }
}

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">/**
 * 1. CreateWalletFragment (创建钱包页面)
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateWalletFragment</span> : <span class="hljs-type">Fragment</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentCreateWalletBinding? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> securityManager: SecurityManager
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> web3Service: Web3Service

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?,
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View {
        _binding = FragmentCreateWalletBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> binding.root
    }

    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)

        securityManager = SecurityManager(requireContext())
        web3Service = Web3Service()

        setupClickListeners()
    }

    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupClickListeners</span><span class="hljs-params">()</span></span> {
        binding.btnCreateNew.setOnClickListener {
            createNewWallet()
        }

        binding.btnImportMnemonic.setOnClickListener {
            replaceFragment(ImportMnemonicFragment())
        }

        binding.btnImportPrivateKey.setOnClickListener {
            replaceFragment(ImportPrivateKeyFragment())
        }
    }

    <span class="hljs-meta">@RequiresApi(Build.VERSION_CODES.M)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createNewWallet</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> password = <span class="hljs-string">"default_password"</span>

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> walletInfo = web3Service.createNewWallet()

            <span class="hljs-keyword">val</span> encryptedPrivateKey = securityManager.encryptData(walletInfo.privateKey)
            securityManager.saveWalletData(
                walletInfo.address,
                encryptedPrivateKey,
                <span class="hljs-literal">null</span>
            )

            <span class="hljs-keyword">val</span> backupFragment = BackupPrivateKeyFragment().apply {
                arguments = Bundle().apply {
                    putString(<span class="hljs-string">"privateKey"</span>, walletInfo.privateKey)
                    putString(<span class="hljs-string">"address"</span>, walletInfo.address)
                }
            }
            replaceFragment(backupFragment)

        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"aaaa"</span>, e.message.toString())
            showError(<span class="hljs-string">"创建钱包失败: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">replaceFragment</span><span class="hljs-params">(fragment: <span class="hljs-type">Fragment</span>)</span></span> {
        requireActivity().supportFragmentManager.beginTransaction()
            .replace(R.id.fragment_container, fragment)
            .addToBackStack(<span class="hljs-literal">null</span>)
            .commit()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showError</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_LONG)
            .show()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroyView()
        _binding = <span class="hljs-literal">null</span>
    }
}

</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 备份私钥页面
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupPrivateKeyFragment</span> : <span class="hljs-type">Fragment</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentBackupPrivateKeyBinding? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> privateKey: String
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> address: String

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?,
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View {
        _binding = FragmentBackupPrivateKeyBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> binding.root
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)

        privateKey = arguments?.getString(<span class="hljs-string">"privateKey"</span>) ?: <span class="hljs-string">""</span>
        address = arguments?.getString(<span class="hljs-string">"address"</span>) ?: <span class="hljs-string">""</span>

        setupUI()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span> {
        binding.tvPrivateKey.text = privateKey
        binding.tvAddress.text = address

        binding.btnContinue.setOnClickListener {
            (requireActivity() <span class="hljs-keyword">as</span> MainActivity).showBottomNavigation()
            requireActivity().supportFragmentManager.beginTransaction()
                .replace(R.id.fragment_container, WalletFragment())
                .commit()
        }

        binding.btnCopyPrivateKey.setOnClickListener {
            copyToClipboard(privateKey)
            showMessage(<span class="hljs-string">"私钥已复制到剪贴板"</span>)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">copyToClipboard</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> clipboard = requireContext().getSystemService(Context.CLIPBOARD_SERVICE) <span class="hljs-keyword">as</span> ClipboardManager
        <span class="hljs-keyword">val</span> clip = ClipData.newPlainText(<span class="hljs-string">"私钥"</span>, text)
        clipboard.setPrimaryClip(clip)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        android.widget.Toast.makeText(requireContext(), message, android.widget.Toast.LENGTH_SHORT).show()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroyView()
        _binding = <span class="hljs-literal">null</span>
    }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端导出页面内容为PDF]]></title>    <link>https://juejin.cn/post/7578762210287239231</link>    <guid>https://juejin.cn/post/7578762210287239231</guid>    <pubDate>2025-12-02T02:45:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578762210287239231" data-draft-id="7578760341280800809" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端导出页面内容为PDF"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T02:45:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快落的小海疼"/> <meta itemprop="url" content="https://juejin.cn/user/114004940573112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端导出页面内容为PDF
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004940573112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快落的小海疼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:45:26.000Z" title="Tue Dec 02 2025 02:45:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.前言</h2>
<p>接到一个将窗合同签署弹窗导出盖章之后的内容为PDF需求，首先想到后端导出，后端反馈导出样式把控困难，实现时间非常久。前端被迫接活导出PDF🤡。</p>
<h2 data-id="heading-1">2.实现方案</h2>
<p>采用html2Canvas对页面内容进行截图，生成页面内容对应的图片，之后通过JsPDF将图片添加到pdf文件，并导出为PDF文件</p>
<p>html2Canvas + JsPDF</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> html2Canvas <span class="hljs-keyword">from</span> <span class="hljs-string">'html2canvas'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">JsPDF</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'jspdf'</span>
</code></pre>
<h2 data-id="heading-2">3.具体代码实现</h2>
<p>具体代码位置：pv-admin\src\views\devopsManage\noticeManage\list\components\previewDialog.vue</p>
<p>这里大概阐述一下代码逻辑。</p>
<p>1.采用html2Canvas生成一张完整的图片</p>
<p>2.判断图片是否大于一页，如果只有一页则通过pdf.addImage方法塞入pdf</p>
<p>3.如果图片长度大于一页，则需要将图片分割生成多页，这里图片分割采用的方案是，通过canvas的drawImage方法渲染图片的某个高度到某个高度的内容，然后再转成图片，然后通过pdf.addImage一页一页的塞到pdf</p>
<p>4.通过pdf.output('blob')既可获取pdf文件流。</p>
<pre><code class="hljs language-java" lang="java">async <span class="hljs-title function_">generatePdf</span><span class="hljs-params">()</span> {
  <span class="hljs-built_in">this</span>.loading = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 导出内容对应的dom的ref</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.$refs.rightContent
    <span class="hljs-type">const</span> <span class="hljs-variable">canvas</span> <span class="hljs-operator">=</span> await <span class="hljs-title function_">html2Canvas</span><span class="hljs-params">(element, {
      allowTaint: <span class="hljs-literal">true</span>,
      useCORS: <span class="hljs-literal">true</span>,
      scale: <span class="hljs-number">2</span>,
      logging: <span class="hljs-literal">false</span>,
      letterRendering: <span class="hljs-literal">true</span>,
    })</span>
    
    <span class="hljs-type">const</span> <span class="hljs-variable">imgData</span> <span class="hljs-operator">=</span> canvas.toDataURL(<span class="hljs-string">'image/jpeg'</span>, <span class="hljs-number">1.0</span>)
    <span class="hljs-comment">// 初始化一个A4纸大小的PDF</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">pdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsPDF</span>(<span class="hljs-string">'p'</span>, <span class="hljs-string">'pt'</span>, <span class="hljs-string">'a4'</span>)
    
    <span class="hljs-comment">// 获取PDF的宽度和高度</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">pdfWidth</span> <span class="hljs-operator">=</span> pdf.internal.pageSize.getWidth()
    <span class="hljs-type">const</span> <span class="hljs-variable">pdfHeight</span> <span class="hljs-operator">=</span> pdf.internal.pageSize.getHeight()
    
    <span class="hljs-comment">// 设置页面边距</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">marginTop</span> <span class="hljs-operator">=</span> <span class="hljs-number">40</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">marginBottom</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>
    
    <span class="hljs-comment">// 计算图片的宽度和高度及比例</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">imgWidth</span> <span class="hljs-operator">=</span> canvas.width
    <span class="hljs-type">const</span> <span class="hljs-variable">imgHeight</span> <span class="hljs-operator">=</span> canvas.height
    <span class="hljs-type">const</span> <span class="hljs-variable">ratio</span> <span class="hljs-operator">=</span> pdfWidth / imgWidth
    <span class="hljs-type">const</span> <span class="hljs-variable">scaledImgHeight</span> <span class="hljs-operator">=</span> imgHeight * ratio
    
    <span class="hljs-comment">// 使用新的分页方法：按照页面高度切割原始图像</span>
    <span class="hljs-keyword">if</span> (scaledImgHeight &lt;= pdfHeight - marginTop - marginBottom) {
      <span class="hljs-comment">// 如果内容高度不超过一页，直接添加图像</span>
      pdf.addImage(imgData, <span class="hljs-string">'JPEG'</span>, <span class="hljs-number">0</span>, marginTop, pdfWidth, scaledImgHeight)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 如果内容超过一页，使用多页PDF</span>
      <span class="hljs-type">let</span> <span class="hljs-variable">remainingHeight</span> <span class="hljs-operator">=</span> imgHeight
      <span class="hljs-type">let</span> <span class="hljs-variable">yOffset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
      <span class="hljs-type">let</span> <span class="hljs-variable">pageCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
      
      <span class="hljs-keyword">while</span> (remainingHeight &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 计算当前页能显示的高度(以原始图像高度计算)</span>
        <span class="hljs-type">const</span> <span class="hljs-variable">pageHeightInCanvas</span> <span class="hljs-operator">=</span> ((pdfHeight - marginTop - marginBottom) / ratio)
        <span class="hljs-comment">// 计算实际可用的高度</span>
        <span class="hljs-type">const</span> <span class="hljs-variable">heightToPrint</span> <span class="hljs-operator">=</span> Math.min(pageHeightInCanvas, remainingHeight)
        <span class="hljs-comment">// 转换为PDF上实际高度</span>
        <span class="hljs-type">const</span> <span class="hljs-variable">heightOnPdf</span> <span class="hljs-operator">=</span> heightToPrint * ratio
        
        <span class="hljs-comment">// 创建一个新的canvas，只包含当前页需要的部分</span>
        <span class="hljs-type">const</span> <span class="hljs-variable">tmpCanvas</span> <span class="hljs-operator">=</span> document.createElement(<span class="hljs-string">'canvas'</span>)
        tmpCanvas.width = imgWidth
        tmpCanvas.height = heightToPrint
        
        <span class="hljs-type">const</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> tmpCanvas.getContext(<span class="hljs-string">'2d'</span>)
        <span class="hljs-comment">// 将原始canvas的特定部分绘制到临时canvas</span>
        ctx.drawImage(
          canvas,
          <span class="hljs-number">0</span>, yOffset, <span class="hljs-comment">// 源图像的起始位置</span>
          imgWidth, heightToPrint, <span class="hljs-comment">// 源图像的宽高</span>
          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-comment">// 目标起始位置</span>
          imgWidth, heightToPrint <span class="hljs-comment">// 目标宽高</span>
        )
        
        <span class="hljs-comment">// 如果不是第一页，添加新页</span>
        <span class="hljs-keyword">if</span> (pageCount &gt; <span class="hljs-number">0</span>) {
          pdf.addPage()
        }
        
        <span class="hljs-comment">// 将当前页绘制到PDF</span>
        <span class="hljs-type">const</span> <span class="hljs-variable">pageImgData</span> <span class="hljs-operator">=</span> tmpCanvas.toDataURL(<span class="hljs-string">'image/jpeg'</span>, <span class="hljs-number">1.0</span>)
        pdf.addImage(pageImgData, <span class="hljs-string">'JPEG'</span>, <span class="hljs-number">0</span>, marginTop, pdfWidth, heightOnPdf)
        
        <span class="hljs-comment">// 更新剩余高度和垂直偏移</span>
        remainingHeight -= heightToPrint
        yOffset += heightToPrint
        pageCount++
      }
    }
    
    <span class="hljs-comment">// 获取PDF的blob对象</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">pdfBlob</span> <span class="hljs-operator">=</span> pdf.output(<span class="hljs-string">'blob'</span>)
    <span class="hljs-comment">// 创建File对象</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> `运维工作告知函_${<span class="hljs-built_in">this</span>.detail.noticeNo}.pdf`
    <span class="hljs-type">const</span> <span class="hljs-variable">pdfFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>([pdfBlob], fileName, { type: <span class="hljs-string">'application/pdf'</span> })
    
    <span class="hljs-comment">// 生成文件路径</span>
    <span class="hljs-type">const</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">'/notice/'</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime() + <span class="hljs-string">'/'</span> + fileName
    
    <span class="hljs-comment">// 直接上传文件</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-type">const</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> await <span class="hljs-title function_">UploadFile</span><span class="hljs-params">(pdfFile, filePath, filePath.substring(<span class="hljs-number">1</span>)</span>)
      <span class="hljs-keyword">if</span> (res &amp;&amp; res.url) {
        <span class="hljs-built_in">this</span>.queryFn(res.url)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">this</span>.$message.error(<span class="hljs-string">'生成PDF失败'</span>)
      }
    } <span class="hljs-keyword">catch</span> (error) {
      console.error(<span class="hljs-string">'上传PDF失败:'</span>, error)
      <span class="hljs-built_in">this</span>.$message.error(<span class="hljs-string">'上传PDF失败'</span>)
    }
  } <span class="hljs-keyword">catch</span> (error) {
    console.error(<span class="hljs-string">'生成PDF失败:'</span>, error)
    <span class="hljs-built_in">this</span>.$message.error(<span class="hljs-string">'生成PDF失败'</span>)
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-built_in">this</span>.loading = <span class="hljs-literal">false</span>
  }
},
</code></pre>
<h2 data-id="heading-3">4.效果展示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcfpamf.yuque.com%2Fattachments%2Fyuque%2F0%2F2025%2Fpdf%2F1684650%2F1753669474022-7e5324e0-774c-48c6-a5b8-b8b0f6f202f2.pdf" target="_blank" title="https://cfpamf.yuque.com/attachments/yuque/0/2025/pdf/1684650/1753669474022-7e5324e0-774c-48c6-a5b8-b8b0f6f202f2.pdf" ref="nofollow noopener noreferrer">📎运维工作告知函_YW202507-02.pdf</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a187fe57ed7f4531b6cb10d8b7f0fb92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r6JC955qE5bCP5rW355a8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765248326&amp;x-signature=%2B4H8yRk8ulnWMoPvsRUBtkFmgks%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">5.存在问题</h2>
<p>采用html2Canvas生成的图片，如果过长，分页时，分页截断的位置不好控制，会出现部分模块被分割到两页（哪怕一行字也看也能会被从中间截断展示）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全局重复接口取消&重复提示]]></title>    <link>https://juejin.cn/post/7578811288819023915</link>    <guid>https://juejin.cn/post/7578811288819023915</guid>    <pubDate>2025-12-02T02:46:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578811288819023915" data-draft-id="7578760249949143094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全局重复接口取消&amp;重复提示"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-02T02:46:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快落的小海疼"/> <meta itemprop="url" content="https://juejin.cn/user/114004940573112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全局重复接口取消&amp;重复提示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004940573112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快落的小海疼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:46:35.000Z" title="Tue Dec 02 2025 02:46:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    23
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">重复接口取消</h2>
<h3 data-id="heading-1">思路</h3>
<p>我们创建了一个pendingMap对象，它用于存储每个请求的标识（请求路径、请求方式、请求参数3个维度唯一标识）和取消函数。当请求被发出时，我们将其添加到pendingMap中。再次调用pendingMap存在此请求，则取消请求，另外再此接口返回时，同样取消请求。</p>
<h3 data-id="heading-2">实现</h3>
<p>1、创建AxiosCanceler类，定义了addPending、removeAllPending和removePending三个方法。addPending方法用于将请求添加到pendingMap中。removeAllPending方法可以用于取消所有请求，而removePending方法可以用于取消单个请求。</p>
<pre><code class="hljs language-csharp" lang="csharp">import type { AxiosRequestConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>
import { generateRequestCode } <span class="hljs-keyword">from</span> <span class="hljs-string">'./index'</span>

<span class="hljs-comment">// 用于存储每个请求的标识和取消函数</span>
<span class="hljs-keyword">const</span> pendingMap = <span class="hljs-keyword">new</span> Map&lt;<span class="hljs-built_in">string</span>, AbortController&gt;()

export <span class="hljs-keyword">class</span> <span class="hljs-title">AxiosCanceler</span> {
  <span class="hljs-comment">/**
   * 添加请求
   * @param config 请求配置
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">addPending</span>(<span class="hljs-params">config: AxiosRequestConfig</span>): <span class="hljs-keyword">void</span></span> {
    <span class="hljs-comment">// 立刻移除重复请求</span>
    <span class="hljs-keyword">this</span>.removePending(config)
    <span class="hljs-comment">// 请求唯一标识code</span>
    <span class="hljs-keyword">const</span> requestCode = generateRequestCode(config)
    <span class="hljs-comment">// 取消请求对象</span>
    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> AbortController()
    config.signal = controller.<span class="hljs-function">signal
    <span class="hljs-title">if</span> (<span class="hljs-params">!pendingMap.has(requestCode</span>))</span> {
      <span class="hljs-comment">// 如果当前请求不在等待中，将其添加到等待中</span>
      pendingMap.<span class="hljs-keyword">set</span>(requestCode, controller)
    }
  }

  <span class="hljs-comment">/**
   * 清除所有等待中的请求
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">removeAllPending</span>(): <span class="hljs-keyword">void</span></span> {
    pendingMap.forEach((abortController) =&gt; {
      <span class="hljs-keyword">if</span> (abortController) {
        abortController.abort()
      }
    })
    <span class="hljs-keyword">this</span>.reset()
  }

  <span class="hljs-comment">/**
   * 移除请求
   * @param config 请求配置
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">removePending</span>(<span class="hljs-params">config: AxiosRequestConfig</span>): <span class="hljs-keyword">void</span></span> {
    <span class="hljs-keyword">const</span> requestCode = generateRequestCode(config)
    <span class="hljs-keyword">if</span> (pendingMap.has(requestCode)) {
      <span class="hljs-comment">// 如果当前请求在等待中，取消它并将其从等待中移除</span>
      <span class="hljs-keyword">const</span> abortController = pendingMap.<span class="hljs-keyword">get</span>(requestCode)
      <span class="hljs-keyword">if</span> (abortController) {
        abortController.abort(requestCode)
      }
      pendingMap.delete(requestCode)
    }
  }

  <span class="hljs-comment">/**
   * 重置
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">reset</span>(): <span class="hljs-keyword">void</span></span> {
    pendingMap.clear()
  }
}
</code></pre>
<p>2、创建获取唯一标识请求code的方法generateRequestCode，通过url、method、data、params来唯一标识</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">AxiosRequestConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-comment">/**
 * 标准化参数对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Record&lt;string, any&gt; | null | undefined</span>} <span class="hljs-variable">params</span> - 需要标准化的参数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Record&lt;string, any&gt;</span>} - 标准化后的参数对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizeParams</span>(<span class="hljs-params">params?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span></span>): <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-comment">// 处理undefined和未传参的情况</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span> || params === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">return</span> {}
  }

  <span class="hljs-comment">// 处理null和其他空值情况</span>
  <span class="hljs-keyword">if</span> (params === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> {}
  }

  <span class="hljs-comment">// 如果是字符串，尝试解析为JSON对象</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> params === <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(params)
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> parsed === <span class="hljs-string">'object'</span> &amp;&amp; parsed !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sortObjectDeep</span>(parsed)
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 解析失败，返回空对象</span>
    }
    <span class="hljs-keyword">return</span> {}
  }

  <span class="hljs-comment">// 如果不是对象类型，返回空对象</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> params !== <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">return</span> {}
  }

  <span class="hljs-comment">// 如果是数组，返回空对象</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(params)) {
    <span class="hljs-keyword">return</span> {}
  }

  <span class="hljs-comment">// 检查是否为空对象</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(params).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> {}
  }

  <span class="hljs-comment">// 对非空对象进行深度排序</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">sortObjectDeep</span>(params)
}

<span class="hljs-comment">/**
 * 深度排序对象
 * <span class="hljs-doctag">@template</span> <span class="hljs-variable">T</span> - 输入对象类型
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">T</span>} <span class="hljs-variable">obj</span> - 需要排序的对象
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">T</span>} - 排序后的对象
 */</span>
<span class="hljs-keyword">function</span> sortObjectDeep&lt;T&gt;(<span class="hljs-attr">obj</span>: T): T {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span> || obj === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> obj
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj)) {
    <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">map</span>(sortObjectDeep).<span class="hljs-title function_">sort</span>() <span class="hljs-keyword">as</span> T
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;)
    .<span class="hljs-title function_">sort</span>()
    .<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">result: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      result[key] = <span class="hljs-title function_">sortObjectDeep</span>((obj <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;)[key])
      <span class="hljs-keyword">return</span> result
    }, {}) <span class="hljs-keyword">as</span> T
}

<span class="hljs-comment">/**
 * 生成请求唯一编码
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">AxiosRequestConfig</span>} <span class="hljs-variable">config</span> - Axios请求配置
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} - 唯一编码
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateRequestCode</span>(<span class="hljs-params">
  config: AxiosRequestConfig,
</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-comment">// 确保config存在</span>
  <span class="hljs-keyword">if</span> (!config) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求配置为必填参数'</span>)
  }

  <span class="hljs-comment">// 确保url和method存在</span>
  <span class="hljs-keyword">if</span> (!config.<span class="hljs-property">url</span> || !config.<span class="hljs-property">method</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'URL和method为必填参数'</span>)
  }

  <span class="hljs-comment">// 处理params的特殊情况</span>
  <span class="hljs-keyword">const</span> normalizedParams = <span class="hljs-title function_">normalizeParams</span>(config.<span class="hljs-property">params</span>)

  <span class="hljs-keyword">const</span> normalizedData = <span class="hljs-title function_">normalizeParams</span>(config.<span class="hljs-property">data</span>)
  <span class="hljs-comment">// 拼接字符串</span>
  <span class="hljs-keyword">const</span> stringToHash = <span class="hljs-string">`<span class="hljs-subst">${config.url.toLowerCase()}</span>|<span class="hljs-subst">${config.method.toUpperCase()}</span>|<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(normalizedParams)}</span>|<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(normalizedData)}</span>`</span>
  
  <span class="hljs-keyword">return</span> stringToHash
}
</code></pre>
<p>3、修改请求拦截器</p>
<pre><code class="hljs language-javascript" lang="javascript">instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config: AxiosRequestConfig</span>) =&gt;</span> {
    ... 
    axiosCanceler.<span class="hljs-title function_">addPending</span>(config)
    <span class="hljs-keyword">return</span> config
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error.<span class="hljs-property">data</span>.<span class="hljs-property">error</span>.<span class="hljs-property">message</span>)
  },
)

<span class="hljs-comment">// 响应拦截器</span>
instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) {
    ....
    <span class="hljs-comment">// 移除请求</span>
    axiosCanceler.<span class="hljs-title function_">removePending</span>(response.<span class="hljs-property">config</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(response)
  },
  <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-comment">// 请求被取消时，返回错误提示</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'重复请求，已取消'</span>)
    }
    <span class="hljs-comment">// 移除请求</span>
    <span class="hljs-keyword">const</span> { response } = error
    <span class="hljs-keyword">if</span> (response &amp;&amp; response.<span class="hljs-property">config</span>) {
      axiosCanceler.<span class="hljs-title function_">removePending</span>(response.<span class="hljs-property">config</span>)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">config</span>) {
      <span class="hljs-comment">// 处理请求被取消的情况</span>
      axiosCanceler.<span class="hljs-title function_">removePending</span>(error.<span class="hljs-property">config</span>)
    }
    <span class="hljs-keyword">if</span> (response) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(response)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">/*
       * 处理断网的情况
       * eg:请求超时或断网时，更新state的network状态
       * network状态在app.vue中控制着一个全局的断网提示组件的显示隐藏
       * 后续增加断网情况下做的一些操作
       */</span>
      <span class="hljs-comment">// 断网情况下，清除所有请求</span>
      axiosCanceler.<span class="hljs-title function_">removeAllPending</span>()
    }
  },
)
<span class="hljs-comment">// 只需要考虑单一职责，这块只封装axios</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> instance
</code></pre>
<h2 data-id="heading-3">重复提示</h2>
<p>这里我是通过直接二次封装element的消息提示方法，我这里采用的是vue3，统一入口方式去做的，如果是vue2，可以在main.js将$message挂载到this之前做一下重写</p>
<h3 data-id="heading-4">代码</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">MessageHandler</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>

<span class="hljs-comment">// 防止重复弹窗</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">messageInstance</span>: <span class="hljs-title class_">MessageHandler</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageOptions</span> {
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">'success'</span> | <span class="hljs-string">'warning'</span> | <span class="hljs-string">'info'</span> | <span class="hljs-string">'error'</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>
}

<span class="hljs-keyword">const</span> mainMessage = (<span class="hljs-attr">options</span>: <span class="hljs-title class_">MessageOptions</span> | <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">MessageHandler</span> =&gt;</span> {
  <span class="hljs-comment">// 如果弹窗已存在先关闭</span>
  <span class="hljs-keyword">if</span> (messageInstance) {
    messageInstance.<span class="hljs-title function_">close</span>()
  }

  <span class="hljs-keyword">const</span> messageOptions = <span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>
    ? { <span class="hljs-attr">message</span>: options }
    : options

  messageInstance = <span class="hljs-title class_">ElMessage</span>(messageOptions)
  <span class="hljs-keyword">return</span> messageInstance
}


<span class="hljs-keyword">const</span> <span class="hljs-attr">extendedMainMessage</span>: <span class="hljs-built_in">any</span> = mainMessage

<span class="hljs-keyword">const</span> <span class="hljs-attr">arr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-string">'success'</span> | <span class="hljs-string">'warning'</span> | <span class="hljs-string">'info'</span> | <span class="hljs-string">'error'</span>&gt; = [<span class="hljs-string">'success'</span>, <span class="hljs-string">'warning'</span>, <span class="hljs-string">'info'</span>, <span class="hljs-string">'error'</span>]
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">type</span></span>) =&gt;</span> {
  extendedMainMessage[<span class="hljs-keyword">type</span>] = <span class="hljs-function">(<span class="hljs-params">options: MessageOptions | <span class="hljs-built_in">string</span></span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> messageOptions = <span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>
      ? { <span class="hljs-attr">message</span>: options }
      : { ...options }

    messageOptions.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">mainMessage</span>(messageOptions)
  }
})

<span class="hljs-comment">// message消息提示</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">$success</span> = (<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">mainMessage</span>({
    <span class="hljs-attr">message</span>: msg || <span class="hljs-string">'操作成功'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'success'</span>,
  })
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">$warning</span> = (<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">mainMessage</span>({
    <span class="hljs-attr">message</span>: msg || <span class="hljs-string">'操作失败'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
  })
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">$error</span> = (<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">mainMessage</span>({
    <span class="hljs-attr">message</span>: msg || <span class="hljs-string">'操作失败'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>,
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">$info</span> = (<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-title function_">mainMessage</span>({
    <span class="hljs-attr">message</span>: msg,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
  })
}
</code></pre>
<h3 data-id="heading-5">使用</h3>
<p>此时连续调用始终只会有一个消息体出现（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">success、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">ccess</span><span class="mord cjk_fallback">、</span></span></span></span></span>error、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mi>a</mi><mi>r</mi><mi>n</mi><mi>i</mi><mi>n</mi><mi>g</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">warning、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">nin</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord cjk_fallback">、</span></span></span></span></span>info均共用同一个消息体）</p>
<pre><code class="hljs language-php" lang="php">import { <span class="hljs-variable">$error</span>, <span class="hljs-variable">$success</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/index'</span>

<span class="hljs-variable">$error</span>(<span class="hljs-string">'错误提示1'</span>)
<span class="hljs-variable">$error</span>(<span class="hljs-string">'错误提示2'</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【翻译】adb（Android Debug Bridge） 帮助文档]]></title>    <link>https://juejin.cn/post/7578793960626683930</link>    <guid>https://juejin.cn/post/7578793960626683930</guid>    <pubDate>2025-12-02T03:06:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578793960626683930" data-draft-id="7578803491821584411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【翻译】adb（Android Debug Bridge） 帮助文档"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-02T03:06:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【翻译】adb（Android Debug Bridge） 帮助文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:06:22.000Z" title="Tue Dec 02 2025 03:06:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-arduino" lang="arduino">Android Debug <span class="hljs-built_in">Bridge</span> 版本 <span class="hljs-number">1.0</span><span class="hljs-number">.41</span>
版本号 <span class="hljs-number">36.0</span><span class="hljs-number">.0</span><span class="hljs-number">-13206524</span>adb.exe
运行于 Windows <span class="hljs-number">10.0</span><span class="hljs-number">.26100</span>
</code></pre>
<pre><code class="hljs language-sql" lang="sql">全局选项：
 <span class="hljs-operator">-</span>a                       在所有网络接口上监听，而不仅仅是 localhost
 <span class="hljs-operator">-</span>d                       使用 USB 设备（如果连接了多个设备则报错）
 <span class="hljs-operator">-</span>e                       使用 TCP<span class="hljs-operator">/</span>IP 设备（如果有多个可用的 TCP<span class="hljs-operator">/</span>IP 设备则报错）
 <span class="hljs-operator">-</span>s 序列号                使用指定序列号的设备（覆盖 $ANDROID_SERIAL 环境变量）
 <span class="hljs-operator">-</span>t ID                    使用指定传输 ID 的设备
 <span class="hljs-operator">-</span>H                       指定 adb 服务器主机名 [默认<span class="hljs-operator">=</span>localhost]
 <span class="hljs-operator">-</span>P                       指定 adb 服务器端口 [默认<span class="hljs-operator">=</span><span class="hljs-number">5037</span>]
 <span class="hljs-operator">-</span>L SOCKET                在指定的套接字上监听 adb 服务器 [默认<span class="hljs-operator">=</span>tcp:localhost:<span class="hljs-number">5037</span>]
 <span class="hljs-comment">--one-device SERIAL|USB  仅允许与 'start-server' 或 'server nodaemon' 一起使用，服务器将仅连接到一台 USB 设备，由序列号或 USB 设备地址指定。</span>
 <span class="hljs-comment">--exit-on-write-error    如果标准输出被关闭则退出</span>

常规命令：
 devices [<span class="hljs-operator">-</span>l]             列出已连接的设备（<span class="hljs-operator">-</span>l 表示详细输出）
 help                     显示此帮助信息
 version                  显示版本号

网络连接：
 <span class="hljs-keyword">connect</span> 主机[:端口]       通过 TCP<span class="hljs-operator">/</span>IP 连接到设备 [默认端口<span class="hljs-operator">=</span><span class="hljs-number">5555</span>]
 <span class="hljs-keyword">disconnect</span> [主机[:端口]]  从给定的 TCP<span class="hljs-operator">/</span>IP 设备断开连接 [默认端口<span class="hljs-operator">=</span><span class="hljs-number">5555</span>]，或断开所有连接
 pair 主机[:端口] [配对码]  与设备配对以进行安全的 TCP<span class="hljs-operator">/</span>IP 通信
 forward <span class="hljs-comment">--list           列出所有正向套接字连接</span>
 forward [<span class="hljs-comment">--no-rebind] 本地地址 远程地址</span>
                          使用以下方式建立正向套接字连接：
                            tcp:<span class="hljs-operator">&lt;</span>端口<span class="hljs-operator">&gt;</span> (<span class="hljs-operator">&lt;</span>本地地址<span class="hljs-operator">&gt;</span> 可为 "tcp:0" 以选择任意开放端口)
                            localabstract:<span class="hljs-operator">&lt;</span>Unix 域套接字名称<span class="hljs-operator">&gt;</span>
                            localreserved:<span class="hljs-operator">&lt;</span>Unix 域套接字名称<span class="hljs-operator">&gt;</span>
                            localfilesystem:<span class="hljs-operator">&lt;</span>Unix 域套接字名称<span class="hljs-operator">&gt;</span>
                            dev:<span class="hljs-operator">&lt;</span>字符设备名称<span class="hljs-operator">&gt;</span>
                            dev<span class="hljs-operator">-</span>raw:<span class="hljs-operator">&lt;</span>字符设备名称<span class="hljs-operator">&gt;</span> (以原始模式打开设备)
                            jdwp:<span class="hljs-operator">&lt;</span>进程PID<span class="hljs-operator">&gt;</span> (仅限远程)
                            vsock:<span class="hljs-operator">&lt;</span>CID<span class="hljs-operator">&gt;</span>:<span class="hljs-operator">&lt;</span>端口<span class="hljs-operator">&gt;</span> (仅限远程)
                            acceptfd:<span class="hljs-operator">&lt;</span>文件描述符<span class="hljs-operator">&gt;</span> (仅限监听)
 forward <span class="hljs-comment">--remove 本地地址 移除特定的正向套接字连接</span>
 forward <span class="hljs-comment">--remove-all     移除所有正向套接字连接</span>
 reverse <span class="hljs-comment">--list           列出设备上的所有反向套接字连接</span>
 reverse [<span class="hljs-comment">--no-rebind] 远程地址 本地地址</span>
                          使用以下方式建立反向套接字连接：
                            tcp:<span class="hljs-operator">&lt;</span>端口<span class="hljs-operator">&gt;</span> (<span class="hljs-operator">&lt;</span>远程地址<span class="hljs-operator">&gt;</span> 可为 "tcp:0" 以选择任意开放端口)
                            localabstract:<span class="hljs-operator">&lt;</span>Unix 域套接字名称<span class="hljs-operator">&gt;</span>
                            localreserved:<span class="hljs-operator">&lt;</span>Unix 域套接字名称<span class="hljs-operator">&gt;</span>
                            localfilesystem:<span class="hljs-operator">&lt;</span>Unix 域套接字名称<span class="hljs-operator">&gt;</span>
 reverse <span class="hljs-comment">--remove 远程地址 移除特定的反向套接字连接</span>
 reverse <span class="hljs-comment">--remove-all     移除设备上的所有反向套接字连接</span>
 mdns <span class="hljs-keyword">check</span>               检查 mDNS 发现服务是否可用
 mdns services            列出所有已发现的服务

文件传输：
 push [<span class="hljs-comment">--sync] [-z 算法] [-Z] 本地路径... 远程路径</span>
                           将本地文件<span class="hljs-operator">/</span>目录复制到设备
                           <span class="hljs-operator">-</span>n: 空运行：推送文件到设备但不存储到文件系统
                           <span class="hljs-operator">-</span>q: 不显示进度信息
                           <span class="hljs-operator">-</span>Z: 禁用压缩
                           <span class="hljs-operator">-</span>z: 使用指定算法启用压缩 (<span class="hljs-keyword">any</span><span class="hljs-operator">/</span><span class="hljs-keyword">none</span><span class="hljs-operator">/</span>brotli<span class="hljs-operator">/</span>lz4<span class="hljs-operator">/</span>zstd)
                           <span class="hljs-comment">--sync: 仅推送主机和设备上时间戳不同的文件</span>
 pull [<span class="hljs-operator">-</span>a] [<span class="hljs-operator">-</span>z 算法] [<span class="hljs-operator">-</span>Z] 远程路径... 本地路径
                           从设备复制文件<span class="hljs-operator">/</span>目录
                           <span class="hljs-operator">-</span>a: 保留文件时间戳和模式
                           <span class="hljs-operator">-</span>q: 不显示进度信息
                           <span class="hljs-operator">-</span>Z: 禁用压缩
                           <span class="hljs-operator">-</span>z: 使用指定算法启用压缩 (<span class="hljs-keyword">any</span><span class="hljs-operator">/</span><span class="hljs-keyword">none</span><span class="hljs-operator">/</span>brotli<span class="hljs-operator">/</span>lz4<span class="hljs-operator">/</span>zstd)
 sync [<span class="hljs-operator">-</span>l] [<span class="hljs-operator">-</span>z 算法] [<span class="hljs-operator">-</span>Z] [<span class="hljs-keyword">all</span><span class="hljs-operator">|</span>data<span class="hljs-operator">|</span>odm<span class="hljs-operator">|</span>oem<span class="hljs-operator">|</span>product<span class="hljs-operator">|</span><span class="hljs-keyword">system</span><span class="hljs-operator">|</span>system_ext<span class="hljs-operator">|</span>vendor]
                           将 $ANDROID_PRODUCT_OUT 中的本地构建同步到设备 (默认 <span class="hljs-keyword">all</span>)
                           <span class="hljs-operator">-</span>l: 列出将要复制的文件，但不实际复制
                           <span class="hljs-operator">-</span>n: 空运行：推送文件到设备但不存储到文件系统
                           <span class="hljs-operator">-</span>q: 不显示进度信息
                           <span class="hljs-operator">-</span>Z: 禁用压缩
                           <span class="hljs-operator">-</span>z: 使用指定算法启用压缩 (<span class="hljs-keyword">any</span><span class="hljs-operator">/</span><span class="hljs-keyword">none</span><span class="hljs-operator">/</span>brotli<span class="hljs-operator">/</span>lz4<span class="hljs-operator">/</span>zstd)

Shell：
 shell [<span class="hljs-operator">-</span>e 转义字符] [<span class="hljs-operator">-</span>n] [<span class="hljs-operator">-</span>Tt] [<span class="hljs-operator">-</span>x] [命令...]
                           运行远程 shell 命令（如果未给出命令则进入交互式 shell）
                           <span class="hljs-operator">-</span>e: 选择转义字符，或 "none"；默认为 <span class="hljs-string">'~'</span>
                           <span class="hljs-operator">-</span>n: 不从标准输入读取
                           <span class="hljs-operator">-</span>T: 禁用伪终端分配
                           <span class="hljs-operator">-</span>t: 如果在终端上则分配伪终端 (<span class="hljs-operator">-</span>tt: 强制分配伪终端)
                           <span class="hljs-operator">-</span>x: 禁用远程退出码和标准输出<span class="hljs-operator">/</span>标准错误分离
 emu 命令                  运行模拟器控制台命令

应用安装（另请参见 `adb shell cmd package help`）：
 install [<span class="hljs-operator">-</span>lrtsdg] [<span class="hljs-comment">--instant] 包名</span>
                           推送单个包到设备并安装
 install<span class="hljs-operator">-</span>multiple [<span class="hljs-operator">-</span>lrtsdpg] [<span class="hljs-comment">--instant] 包名...</span>
                           推送多个 APK 到设备（用于单个包）并安装它们
 install<span class="hljs-operator">-</span>multi<span class="hljs-operator">-</span>package [<span class="hljs-operator">-</span>lrtsdpg] [<span class="hljs-comment">--instant] 包名...</span>
                           推送一个或多个包到设备并以原子操作安装它们
                           <span class="hljs-operator">-</span>r: 替换现有应用
                           <span class="hljs-operator">-</span>t: 允许测试包
                           <span class="hljs-operator">-</span>d: 允许版本代码降级（仅适用于可调试包）
                           <span class="hljs-operator">-</span>p: 部分应用安装（仅适用于 install<span class="hljs-operator">-</span>multiple）
                           <span class="hljs-operator">-</span>g: 授予所有运行时权限
                           <span class="hljs-comment">--abi ABI: 覆盖平台的默认 ABI</span>
                           <span class="hljs-comment">--instant: 将应用安装为临时应用</span>
                           <span class="hljs-comment">--no-streaming: 总是先将 APK 推送到设备，然后单独调用包管理器</span>
                           <span class="hljs-comment">--streaming: 强制流式传输 APK 直接到包管理器</span>
                           <span class="hljs-comment">--fastdeploy: 使用快速部署</span>
                           <span class="hljs-comment">--no-fastdeploy: 阻止使用快速部署</span>
                           <span class="hljs-comment">--force-agent: 使用快速部署时强制更新部署代理</span>
                           <span class="hljs-comment">--date-check-agent: 当本地版本较新且使用快速部署时更新部署代理</span>
                           <span class="hljs-comment">--version-check-agent: 当本地版本代码不同且使用快速部署时更新部署代理</span>
                           （更多选项请参见 `adb shell pm help`。）
 uninstall [<span class="hljs-operator">-</span>k] 包名       从设备移除此应用包
                           <span class="hljs-string">'-k'</span>: 保留数据和缓存目录

调试：
 bugreport [路径]          将错误报告写入给定路径 [默认<span class="hljs-operator">=</span>bugreport.zip]；
                           如果路径是一个目录，则错误报告保存在该目录中。
                           不支持压缩错误报告的设备将输出到标准输出。
 jdwp                     列出承载 JDWP 传输的进程的 PID
 logcat                   显示设备日志（更多选项请参见 logcat <span class="hljs-comment">--help）</span>

安全：
 disable<span class="hljs-operator">-</span>verity           在 userdebug 版本上禁用 dm<span class="hljs-operator">-</span>verity 检查
 enable<span class="hljs-operator">-</span>verity            在 userdebug 版本上重新启用 dm<span class="hljs-operator">-</span>verity 检查
 keygen 文件               生成 adb 公钥<span class="hljs-operator">/</span>私钥；私钥存储在文件中，

脚本：
 wait<span class="hljs-operator">-</span><span class="hljs-keyword">for</span>[<span class="hljs-operator">-</span>传输类型]<span class="hljs-operator">-</span>状态...
                           等待设备进入给定状态
                           状态：device, recovery, rescue, sideload, bootloader, 或 <span class="hljs-keyword">disconnect</span>
                           传输类型：usb, <span class="hljs-keyword">local</span>, 或 <span class="hljs-keyword">any</span> [默认<span class="hljs-operator">=</span><span class="hljs-keyword">any</span>]
 <span class="hljs-keyword">get</span><span class="hljs-operator">-</span>state                打印 offline <span class="hljs-operator">|</span> bootloader <span class="hljs-operator">|</span> device
 <span class="hljs-keyword">get</span><span class="hljs-operator">-</span>serialno             打印 <span class="hljs-operator">&lt;</span>序列号<span class="hljs-operator">&gt;</span>
 <span class="hljs-keyword">get</span><span class="hljs-operator">-</span>devpath              打印 <span class="hljs-operator">&lt;</span>设备路径<span class="hljs-operator">&gt;</span>
 remount [<span class="hljs-operator">-</span>R]             以读写模式重新挂载分区。如果需要重启，<span class="hljs-operator">-</span>R 将自动重启设备。
 reboot [bootloader<span class="hljs-operator">|</span>recovery<span class="hljs-operator">|</span>sideload<span class="hljs-operator">|</span>sideload<span class="hljs-operator">-</span>auto<span class="hljs-operator">-</span>reboot]
                           重启设备；默认为启动系统映像，但也支持启动到 bootloader 和 recovery。sideload 会重启到 recovery 并自动启动 sideload 模式，sideload<span class="hljs-operator">-</span>auto<span class="hljs-operator">-</span>reboot 相同但在 sideload 后重启。
 sideload OTA包            侧载给定的完整 OTA 包
 root                     以 root 权限重启 adbd
 unroot                   不以 root 权限重启 adbd
 usb                      重启 adbd 并在 USB 上监听
 tcpip 端口                重启 adbd 并在指定 TCP 端口上监听

内部调试：
 <span class="hljs-keyword">start</span><span class="hljs-operator">-</span>server             确保服务器正在运行
 kill<span class="hljs-operator">-</span>server              如果服务器正在运行则终止它
 reconnect                从主机端踢掉连接以强制重新连接
 reconnect device         从设备端踢掉连接以强制重新连接
 reconnect offline        重置 offline<span class="hljs-operator">/</span>unauthorized 设备以强制重新连接

USB：
 attach                   附加一个已分离的 USB 设备
 detach                   从一个 USB 设备分离，以允许其他进程使用

环境变量：
 $ADB_TRACE
                           要记录的调试信息的逗号<span class="hljs-operator">/</span>空格分隔列表：
                           <span class="hljs-keyword">all</span>,adb,sockets,packets,rwx,usb,sync,sysdeps,transport,jdwp,services,auth,fdevent,shell,incremental
 $ADB_VENDOR_KEYS         以冒号分隔的密钥列表（文件或目录）
 $ANDROID_SERIAL          要连接到的序列号（参见 <span class="hljs-operator">-</span>s 选项）
 $ANDROID_LOG_TAGS        供 logcat 使用的标签（参见 logcat <span class="hljs-comment">--help）</span>
 $ADB_LOCAL_TRANSPORT_MAX_PORT 最大模拟器扫描端口（默认 <span class="hljs-number">5585</span>，<span class="hljs-number">16</span> 个模拟器）
 $ADB_MDNS_AUTO_CONNECT   允许自动连接的 mDNS 服务逗号分隔列表（默认 adb<span class="hljs-operator">-</span>tls<span class="hljs-operator">-</span><span class="hljs-keyword">connect</span>）
</code></pre>
<p>在线文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fpackages%2Fmodules%2Fadb%2F%2B%2Frefs%2Fheads%2Fmain%2Fdocs%2Fuser%2Fadb.1.md" target="_blank" title="https://android.googlesource.com/platform/packages/modules/adb/+/refs/heads/main/docs/user/adb.1.md" ref="nofollow noopener noreferrer">android.googlesource.com/platform/pa…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[写埋点、扒 SDK、改框架：JS 函数复写 10 连招实战手册]]></title>    <link>https://juejin.cn/post/7578732288517111859</link>    <guid>https://juejin.cn/post/7578732288517111859</guid>    <pubDate>2025-12-02T03:12:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578732288517111859" data-draft-id="7578780780026953737" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="写埋点、扒 SDK、改框架：JS 函数复写 10 连招实战手册"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T03:12:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="特级业务专家"/> <meta itemprop="url" content="https://juejin.cn/user/2101921961481512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            写埋点、扒 SDK、改框架：JS 函数复写 10 连招实战手册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921961481512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    特级业务专家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:12:39.000Z" title="Tue Dec 02 2025 03:12:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># JS 中“复写函数”的 10 种姿势（附完整可运行 Demo）</span>

在前端工程里，“复写一个函数”（Hook / Patch / Override）是非常常见的需求，尤其是在：

<span class="hljs-bullet">-</span> 调试黑盒 SDK
<span class="hljs-bullet">-</span> 做监控埋点
<span class="hljs-bullet">-</span> 改第三方库行为但又不能直接改源码

本文把常见的 10 种手法整理成一个“武器清单”，<span class="hljs-strong">**每种都给出可直接跑的 Demo**</span>，方便你复制到控制台 / Node 里试。

---

<span class="hljs-section">## 🟦 一、直接覆写：最简单粗暴</span>

<span class="hljs-strong">**思路**</span>：如果函数本来就是某个对象上的方法，直接重新赋值即可。

<span class="hljs-section">### 示例场景</span>

已有一个业务对象：

<span class="hljs-code">```js
const userService = {
  getUserName(id) {
    console.log('[orig] getUserName', id);
    return 'Alice';
  }
};

// 原始调用
console.log('--- 原始调用 ---');
console.log(userService.getUserName(1));
</span></code></pre>
<p>现在想<strong>完全替换</strong>掉 <code>getUserName</code> 的实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 直接覆写</span>
userService.<span class="hljs-property">getUserName</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[new] getUserName'</span>, id);
  <span class="hljs-keyword">return</span> <span class="hljs-string">'Bob'</span>;
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 覆写后 ---'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userService.<span class="hljs-title function_">getUserName</span>(<span class="hljs-number">1</span>));
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>简单直接</li>
<li>不保留原逻辑（除非你自己先存一份引用）</li>
</ul>
<hr/>
<h2 data-id="heading-0">🟩 二、Monkey Patch：保留原逻辑再“加一层壳”（最常用）</h2>
<p><strong>思路</strong>：保存原函数引用 → 用同名函数包装一层。</p>
<h3 data-id="heading-1">示例：给 SDK 方法加埋点</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 模拟一个 SDK</span>
<span class="hljs-keyword">const</span> sdk = {
  <span class="hljs-title function_">track</span>(<span class="hljs-params">eventName, payload</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[orig track]'</span>, eventName, payload);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
  }
};

<span class="hljs-comment">// 原始使用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 原始调用 ---'</span>);
sdk.<span class="hljs-title function_">track</span>(<span class="hljs-string">'page_view'</span>, { <span class="hljs-attr">path</span>: <span class="hljs-string">'/home'</span> });

<span class="hljs-comment">// 开始 Monkey Patch</span>
<span class="hljs-keyword">const</span> origTrack = sdk.<span class="hljs-property">track</span>;

sdk.<span class="hljs-property">track</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[before track]'</span>, ...args);

  <span class="hljs-keyword">const</span> result = origTrack.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[after track]'</span>, result);
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- Patch 之后 ---'</span>);
sdk.<span class="hljs-title function_">track</span>(<span class="hljs-string">'page_view'</span>, { <span class="hljs-attr">path</span>: <span class="hljs-string">'/detail'</span> });
</code></pre>
<p><strong>适用</strong>：</p>
<ul>
<li>想在原逻辑前后“插入”自己的逻辑</li>
<li>Hook 黑盒 SDK、监控、埋点等</li>
</ul>
<hr/>
<h2 data-id="heading-2">🟧 三、Proxy：拦截整个对象（高级黑盒分析）</h2>
<p><strong>思路</strong>：用 <code>Proxy</code> 代理整个对象，在 <code>get</code> 里统一拦截函数调用。</p>
<h3 data-id="heading-3">示例：拦截所有方法调用做日志</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 一个“黑盒”对象，方法名可能会变</span>
<span class="hljs-keyword">const</span> api = {
  <span class="hljs-title function_">login</span>(<span class="hljs-params">user, pwd</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'login...'</span>, user);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">token</span>: <span class="hljs-string">'xxx'</span> };
  },
  <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'logout...'</span>);
  }
};

<span class="hljs-comment">// 用 Proxy 包一层</span>
<span class="hljs-keyword">const</span> apiWithLog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(api, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop, receiver</span>) {
    <span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, prop, receiver);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] call <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span> with`</span>, args);
        <span class="hljs-keyword">const</span> result = value.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span> result`</span>, result);
        <span class="hljs-keyword">return</span> result;
      };
    }

    <span class="hljs-keyword">return</span> value;
  }
});

<span class="hljs-comment">// 使用方式跟原来一样</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 使用 Proxy 后 ---'</span>);
apiWithLog.<span class="hljs-title function_">login</span>(<span class="hljs-string">'alice'</span>, <span class="hljs-string">'123456'</span>);
apiWithLog.<span class="hljs-title function_">logout</span>();
</code></pre>
<p><strong>适用</strong>：</p>
<ul>
<li>你<strong>不知道具体方法名</strong>（SDK 里一堆方法）</li>
<li>想统一拦截所有方法调用（sniff）</li>
</ul>
<hr/>
<h2 data-id="heading-4">🟨 四、<code>Object.defineProperty</code>：强行改 getter / setter / 不可枚举属性</h2>
<p><strong>思路</strong>：当属性不可写、或是 getter / setter，需要用 <code>defineProperty</code> 操作描述符。</p>
<h3 data-id="heading-5">示例 1：把只读属性改成可写函数</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {};

<span class="hljs-comment">// 初始定义：只读属性</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">'foo'</span>, {
  <span class="hljs-attr">value</span>: <span class="hljs-string">'readonly'</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原始 foo ='</span>, obj.<span class="hljs-property">foo</span>);

<span class="hljs-comment">// 直接赋值会失败（严格模式下报错，非严格模式下无效）</span>
obj.<span class="hljs-property">foo</span> = <span class="hljs-string">'new'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'直接赋值后 foo ='</span>, obj.<span class="hljs-property">foo</span>); <span class="hljs-comment">// 还是 readonly</span>

<span class="hljs-comment">// 用 defineProperty 强行改成函数</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">'foo'</span>, {
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am new foo()'</span>);
  }
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 改成函数之后 ---'</span>);
obj.<span class="hljs-title function_">foo</span>();
</code></pre>
<h3 data-id="heading-6">示例 2：用 getter 做懒加载 Hook</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> service = {};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(service, <span class="hljs-string">'expensiveApi'</span>, {
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[getter] 初始化 expensiveApi'</span>);
    <span class="hljs-comment">// 真正创建对象</span>
    <span class="hljs-keyword">const</span> realApi = {
      <span class="hljs-title function_">call</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'real api called'</span>);
      }
    };
    <span class="hljs-comment">// 用普通属性替换掉 getter（只初始化一次）</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(service, <span class="hljs-string">'expensiveApi'</span>, {
      <span class="hljs-attr">value</span>: realApi,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>
    });
    <span class="hljs-keyword">return</span> realApi;
  }
});

<span class="hljs-comment">// 第一次访问会触发 getter</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 第一次访问 ---'</span>);
service.<span class="hljs-property">expensiveApi</span>.<span class="hljs-title function_">call</span>();

<span class="hljs-comment">// 第二次访问直接用缓存</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 第二次访问 ---'</span>);
service.<span class="hljs-property">expensiveApi</span>.<span class="hljs-title function_">call</span>();
</code></pre>
<hr/>
<h2 data-id="heading-7">🟥 五、Hook 全局内置方法：网络、事件、路由等（非常强）</h2>
<h3 data-id="heading-8">示例 1：拦截 <code>fetch</code>（浏览器）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 保存原始 fetch</span>
<span class="hljs-keyword">const</span> origFetch = <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>;

<span class="hljs-comment">// 覆写</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> = <span class="hljs-keyword">async</span> (...args) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Hook fetch] 请求参数:'</span>, args);

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">origFetch</span>(...args);

  <span class="hljs-comment">// 复制一份 Response 查看内容（注意：这里只是示意，实际需考虑流只能读一次）</span>
  <span class="hljs-keyword">const</span> clone = res.<span class="hljs-title function_">clone</span>();
  clone.<span class="hljs-title function_">text</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Hook fetch] 响应文本截断:'</span>, text.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>));
  });

  <span class="hljs-keyword">return</span> res;
};

<span class="hljs-comment">// 使用：之后所有 fetch 都会经过 Hook</span>
<span class="hljs-comment">// fetch('https://jsonplaceholder.typicode.com/todos/1');</span>
</code></pre>
<h3 data-id="heading-9">示例 2：拦截所有 DOM 事件监听</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> origAdd = <span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">addEventListener</span>;

<span class="hljs-title class_">EventTarget</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">addEventListener</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">type, listener, options</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Hook addEventListener]'</span>, type, <span class="hljs-string">'on'</span>, <span class="hljs-variable language_">this</span>);

  <span class="hljs-comment">// 也可以在这里包一层 listener，实现事件埋点</span>
  <span class="hljs-keyword">return</span> origAdd.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, type, listener, options);
};

<span class="hljs-comment">// Demo：添加一个 click 事件</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'body clicked'</span>);
});
</code></pre>
<p><strong>还能 Hook</strong>：</p>
<ul>
<li><code>XMLHttpRequest.prototype.send</code></li>
<li><code>WebSocket.prototype.send</code></li>
<li><code>history.pushState / replaceState</code>（前端路由监控）</li>
<li><code>console.log</code>（调试场景）</li>
</ul>
<hr/>
<h2 data-id="heading-10">🟪 六、代理模块加载：<code>require</code> Hook / 构建期 alias</h2>
<h3 data-id="heading-11">6.1 Node：Hook <code>require</code>（CommonJS）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// hook-require.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Module</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'module'</span>);
<span class="hljs-keyword">const</span> originalRequire = <span class="hljs-title class_">Module</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">require</span>;

<span class="hljs-title class_">Module</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">require</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">path</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[require]'</span>, path);
  <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = originalRequire.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);

  <span class="hljs-comment">// 针对指定模块做 Monkey Patch</span>
  <span class="hljs-keyword">if</span> (path === <span class="hljs-string">'./sdk'</span>) {
    <span class="hljs-keyword">const</span> origDo = <span class="hljs-built_in">exports</span>.<span class="hljs-property">doSomething</span>;
    <span class="hljs-built_in">exports</span>.<span class="hljs-property">doSomething</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[patched sdk.doSomething]'</span>, args);
      <span class="hljs-keyword">return</span> origDo.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    };
  }

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">exports</span>;
};

<span class="hljs-comment">// 主入口</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./hook-require'</span>);
<span class="hljs-keyword">const</span> sdk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./sdk'</span>);

sdk.<span class="hljs-title function_">doSomething</span>(<span class="hljs-string">'hello'</span>);
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// sdk.js</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">doSomething</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">msg</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[orig sdk.doSomething]'</span>, msg);
};
</code></pre>
<p>运行 <code>node main.js</code> 即可看到 require 日志 + patch 效果。</p>
<hr/>
<h3 data-id="heading-12">6.2 前端：通过 alias 替换整个模块</h3>
<p>以 Vite 为例（Webpack 思路类似）。</p>
<h4 data-id="heading-13">步骤 1：配置 alias</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'some-sdk'</span>: <span class="hljs-string">'/src/sdk-wrapped.js'</span> <span class="hljs-comment">// 用你自己的 wrapper 替换原 SDK</span>
    }
  }
});
</code></pre>
<h4 data-id="heading-14">步骤 2：在 wrapper 里再 Monkey Patch</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/sdk-wrapped.js</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> realSdk <span class="hljs-keyword">from</span> <span class="hljs-string">'some-sdk-original'</span>; <span class="hljs-comment">// 假设这是原 SDK 包名</span>

<span class="hljs-keyword">const</span> sdk = { ...realSdk };

<span class="hljs-keyword">const</span> origInit = sdk.<span class="hljs-property">init</span>;
sdk.<span class="hljs-property">init</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[wrapped sdk.init]'</span>, args);
  <span class="hljs-keyword">return</span> origInit.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> sdk;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'some-sdk-original'</span>; <span class="hljs-comment">// 其余原样导出</span>
</code></pre>
<p>业务代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// import sdk from 'some-sdk'; // 实际拿到的是 sdk-wrapped.js</span>
<span class="hljs-comment">// sdk.init(...);</span>
</code></pre>
<hr/>
<h2 data-id="heading-15">🟫 七、ES6 <code>class</code> 继承：在可控框架里“正统扩展”</h2>
<p><strong>思路</strong>：当你能控制实例创建时，直接用 <code>extends</code> 继承原类，覆写方法并按需 <code>super.foo()</code>。</p>
<h3 data-id="heading-16">示例：扩展一个 UI 组件类</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> {
  <span class="hljs-title function_">click</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Button] clicked'</span>);
  }
}

<span class="hljs-comment">// 原始使用</span>
<span class="hljs-keyword">const</span> btn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Button</span>();
btn.<span class="hljs-title function_">click</span>();

<span class="hljs-comment">// 新类：在原 click 前后加逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogButton</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Button</span> {
  <span class="hljs-title function_">click</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[LogButton] before click'</span>);
    <span class="hljs-keyword">const</span> result = <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">click</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[LogButton] after click'</span>);
    <span class="hljs-keyword">return</span> result;
  }
}

<span class="hljs-keyword">const</span> logBtn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogButton</span>();
logBtn.<span class="hljs-title function_">click</span>();
</code></pre>
<p><strong>适合</strong>：</p>
<ul>
<li>你能自己 new 子类，而不是框架内部帮你 new</li>
<li>比如内部业务类、自己封装的组件体系</li>
</ul>
<hr/>
<h2 data-id="heading-17">🟩 八、<code>Proxy</code> + <code>construct</code>：拦截 <code>new</code> 的构造行为</h2>
<p><strong>思路</strong>：用 <code>Proxy</code> 代理“类本身”，在 <code>construct</code> 里拦截所有实例创建。</p>
<h3 data-id="heading-18">示例：给每个实例自动打 Patch</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Service</span> {
  <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Service.foo]'</span>);
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">PatchedService</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-title class_">Service</span>, {
  <span class="hljs-title function_">construct</span>(<span class="hljs-params">target, args, newTarget</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Proxy construct] 创建 Service 实例，参数:'</span>, args);

    <span class="hljs-comment">// 创建原始实例</span>
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">construct</span>(target, args, newTarget);

    <span class="hljs-comment">// 给实例打补丁</span>
    <span class="hljs-keyword">const</span> origFoo = instance.<span class="hljs-property">foo</span>;
    instance.<span class="hljs-property">foo</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...fooArgs</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[patched foo] before'</span>, fooArgs);
      <span class="hljs-keyword">const</span> result = origFoo.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, fooArgs);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[patched foo] after'</span>, result);
      <span class="hljs-keyword">return</span> result;
    };

    <span class="hljs-keyword">return</span> instance;
  }
});

<span class="hljs-comment">// 之后统一用 PatchedService，而不是 Service</span>
<span class="hljs-keyword">const</span> s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatchedService</span>();
s.<span class="hljs-title function_">foo</span>();
</code></pre>
<p><strong>适合</strong>：</p>
<ul>
<li>第三方库暴露的是“类”，你可以控制 <code>new</code> 的地方</li>
<li>想让<strong>所有实例</strong>都应用同一套 Patch</li>
</ul>
<hr/>
<h2 data-id="heading-19">🟦 九、Hook 原型：对所有实例生效</h2>
<p><strong>思路</strong>：直接改 <code>Class.prototype.xxx</code> 或内置类型原型，例如 <code>Array.prototype.push</code>。</p>
<h3 data-id="heading-20">示例 1：改自定义类的原型方法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hi, I am'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
};

<span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Alice'</span>);
p1.<span class="hljs-title function_">sayHi</span>();

<span class="hljs-comment">// Patch 原型</span>
<span class="hljs-keyword">const</span> origSayHi = <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span>;

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[patched] before sayHi'</span>);
  origSayHi.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[patched] after sayHi'</span>);
};

<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Bob'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- Patch 之后 ---'</span>);
p1.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 旧实例也会受影响</span>
p2.<span class="hljs-title function_">sayHi</span>();
</code></pre>
<h3 data-id="heading-21">示例 2：给所有数组的 <code>push</code> 打日志（谨慎使用）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> origPush = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span>;

<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...items</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Array.push patched] this ='</span>, <span class="hljs-variable language_">this</span>, <span class="hljs-string">'items ='</span>, items);
  <span class="hljs-keyword">return</span> origPush.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, items);
};

<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>];
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">3</span>);  <span class="hljs-comment">// 会打印日志</span>
</code></pre>
<p><strong>注意</strong>：改内置原型影响范围非常大，要在可控环境下使用。</p>
<hr/>
<h2 data-id="heading-22">🟣 十、动态注入 <code>&lt;script&gt;</code>：在不能改源码时复写全局函数</h2>
<p><strong>思路</strong>：在浏览器通过脚本注入的方式覆盖某个全局函数（油猴脚本、Chrome 插件常用）。</p>
<h3 data-id="heading-23">示例：复写页面里已有的 <code>window.someFn</code></h3>
<p>假设目标页面有：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-property">someFn</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[page] someFn'</span>);
};
</code></pre>
<p>你在自己的脚本里注入一段：</p>
<pre><code class="hljs language-js" lang="js">(<span class="hljs-keyword">function</span> <span class="hljs-title function_">inject</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);

  script.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
    (function () {
      const orig = window.someFn;
      window.someFn = function (...args) {
        console.log('[injected] before someFn', args);
        const result = orig &amp;&amp; orig.apply(this, args);
        console.log('[injected] after someFn', result);
        return result;
      };
    })();
  `</span>;

  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">appendChild</span>(script);
  script.<span class="hljs-title function_">remove</span>();
})();
</code></pre>
<p>执行后，页面中<strong>所有对 <code>someFn</code> 的调用</strong>都会走你注入的版本。</p>
<p><strong>适用</strong>：</p>
<ul>
<li>你不能改页面源码，但能注入 JS（油猴脚本 / 浏览器扩展 / WebView 注入等）</li>
</ul>
<hr/>
<h2 data-id="heading-24">🔥 总结：复写函数的“武器清单”</h2>




























































<table><thead><tr><th>方法</th><th>能力/复杂度</th><th>典型场景</th></tr></thead><tbody><tr><td>直接覆写</td><td>最简单</td><td>你能直接访问对象和方法名</td></tr><tr><td>Monkey Patch</td><td>⭐最常用</td><td>Hook SDK、埋点、调试</td></tr><tr><td>Proxy（拦截对象）</td><td>⭐高级黑盒分析</td><td>不知道具体方法名，想全量 sniff</td></tr><tr><td><code>defineProperty</code></td><td>强力</td><td>只读属性、getter/setter 代理</td></tr><tr><td>Hook 全局 API</td><td>⭐非常强</td><td>网络、事件、路由、日志监控</td></tr><tr><td>require Hook / alias</td><td>构建期</td><td>替换整个 SDK 模块</td></tr><tr><td><code>class</code> 继承</td><td>正统扩展</td><td>自己可控的类/组件</td></tr><tr><td><code>Proxy</code> + <code>construct</code></td><td>高级</td><td>拦截所有实例的创建过程</td></tr><tr><td>原型 Hook</td><td>全局影响</td><td>对所有实例生效（谨慎）</td></tr><tr><td>script 注入</td><td>浏览器插件/油猴场景</td><td>不能改源码、只能运行时注入</td></tr></tbody></table>
<p>--</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【翻译】scrcpy（3.3.3）命令使用文档]]></title>    <link>https://juejin.cn/post/7578797337867485218</link>    <guid>https://juejin.cn/post/7578797337867485218</guid>    <pubDate>2025-12-02T02:46:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578797337867485218" data-draft-id="7578803751608762418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【翻译】scrcpy（3.3.3）命令使用文档"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-02T02:46:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【翻译】scrcpy（3.3.3）命令使用文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:46:12.000Z" title="Tue Dec 02 2025 02:46:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>scrcpy 3.3.3 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGenymobile%2Fscrcpy" target="_blank" title="https://github.com/Genymobile/scrcpy" ref="nofollow noopener noreferrer">github.com/Genymobile/…</a>
用法：<code>scrcpy.exe</code> [选项]</p>
<blockquote>
<p>声明：以下是在 Windows 电脑上的scrcpy --help 输出翻译，不确保其他平台是否一样</p>
</blockquote>
<p>选项：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">--always-on-top</span>
    使 scrcpy 窗口始终置顶（位于其他窗口之上）。

<span class="hljs-comment">--angle=角度</span>
    将视频内容旋转指定的自定义角度（以度为单位，顺时针）。

<span class="hljs-comment">--audio-bit-rate=数值</span>
    以指定的比特率编码音频，单位为比特/秒。支持单位后缀：<span class="hljs-string">'K'</span> (千位/秒 x1000) 和 <span class="hljs-string">'M'</span> (百万位/秒 x1000000)。
    默认值为 <span class="hljs-number">128</span>K (<span class="hljs-number">128000</span>)。

<span class="hljs-comment">--audio-buffer=毫秒</span>
    配置音频缓冲延迟（毫秒）。
    较低的值可降低延迟，但会增加缓冲区欠载（导致音频故障）的可能性。
    默认值为 <span class="hljs-number">50</span>。

<span class="hljs-comment">--audio-codec=名称</span>
    选择音频编码器 (opus, aac, flac 或 raw)。
    默认值为 opus。

<span class="hljs-comment">--audio-codec-options=键[:类型]=值[, ...]</span>
    为设备音频编码器设置以逗号分隔的 `键:类型=值` 选项列表。
    <span class="hljs-string">'类型'</span> 的可能值为 <span class="hljs-string">'int'</span> (默认), <span class="hljs-string">'long'</span>, <span class="hljs-string">'float'</span> 和 <span class="hljs-string">'string'</span>。
    可能的编解码器选项列表可在 Android 文档中找到：
    &lt;https://d.android.com/reference/android/media/MediaFormat&gt;

<span class="hljs-comment">--audio-dup</span>
    复制音频（捕获并在设备上继续播放）。
    此功能仅在配合 `<span class="hljs-comment">--audio-source=playback` 时可用。</span>

<span class="hljs-comment">--audio-encoder=名称</span>
    使用特定的 MediaCodec 音频编码器（取决于 `<span class="hljs-comment">--audio-codec` 提供的编解码器）。</span>
    可用的编码器可通过 `<span class="hljs-comment">--list-encoders` 列出。</span>

<span class="hljs-comment">--audio-source=来源</span>
    选择音频源。可能的值有：
     - `<span class="hljs-string">"output"</span>`: 转发整个音频输出，并禁用设备上的播放。
     - `<span class="hljs-string">"playback"</span>`: 捕获音频播放（Android 应用可选择退出，因此不一定能捕获全部输出）。
     - `<span class="hljs-string">"mic"</span>`: 捕获麦克风。
     - `<span class="hljs-string">"mic-unprocessed"</span>`: 捕获未经处理（原始）的麦克风声音。
     - `<span class="hljs-string">"mic-camcorder"</span>`: 捕获为视频录制调整的麦克风（如果可用，则与摄像头方向一致）。
     - `<span class="hljs-string">"mic-voice-recognition"</span>`: 捕获为语音识别调整的麦克风。
     - `<span class="hljs-string">"mic-voice-communication"</span>`: 捕获为语音通信调整的麦克风（例如，如果可用，将利用回声消除或自动增益控制）。
     - `<span class="hljs-string">"voice-call"</span>`: 捕获语音通话。
     - `<span class="hljs-string">"voice-call-uplink"</span>`: 仅捕获语音通话上行链路。
     - `<span class="hljs-string">"voice-call-downlink"</span>`: 仅捕获语音通话下行链路。
     - `<span class="hljs-string">"voice-performance"</span>`: 捕获用于现场表演（如卡拉OK）处理的音频，包括麦克风和设备播放。
    默认值为 `<span class="hljs-built_in">output</span>`。

<span class="hljs-comment">--audio-output-buffer=毫秒</span>
    配置 SDL 音频输出缓冲区的大小（毫秒）。
    如果您听到“机器人声”般的音频播放，应尝试更高的值（例如 <span class="hljs-number">10</span>）。否则请勿更改此设置。
    默认值为 <span class="hljs-number">5</span>。

-b, <span class="hljs-comment">--video-bit-rate=数值</span>
    以指定的比特率编码视频，单位为比特/秒。支持单位后缀：<span class="hljs-string">'K'</span> (千位/秒 x1000) 和 <span class="hljs-string">'M'</span> (百万位/秒 x1000000)。
    默认值为 <span class="hljs-number">8</span>M (<span class="hljs-number">8000000</span>)。

<span class="hljs-comment">--camera-ar=宽高比</span>
    根据宽高比（+/- <span class="hljs-number">10</span>%）选择相机尺寸。
    可能的值有 `<span class="hljs-string">"sensor"</span>` (使用相机传感器的宽高比)、`<span class="hljs-string">"&lt;数字&gt;:&lt;分母&gt;"</span>` (例如 `<span class="hljs-string">"4:3"</span>`) 或 `<span class="hljs-string">"&lt;数值&gt;"</span>` (例如 `<span class="hljs-string">"1.6"</span>`)。

<span class="hljs-comment">--camera-facing=朝向</span>
    根据朝向选择设备摄像头。
    可能的值有 `<span class="hljs-string">"front"</span>`, `<span class="hljs-string">"back"</span>` 和 `<span class="hljs-string">"external"</span>`。

<span class="hljs-comment">--camera-fps=数值</span>
    指定相机捕获帧率。
    如果未指定，则使用 Android 的默认帧率 (<span class="hljs-number">30</span> fps)。

<span class="hljs-comment">--camera-high-speed</span>
    启用高速相机捕获模式。
    此模式仅限于特定的分辨率和帧率，可通过 `<span class="hljs-comment">--list-camera-sizes` 列出。</span>

<span class="hljs-comment">--camera-id=标识</span>
    指定要镜像的设备摄像头 ID。
    可用的摄像头 ID 可通过以下命令列出：
        scrcpy <span class="hljs-comment">--list-cameras</span>

<span class="hljs-comment">--camera-size=&lt;宽度&gt;x&lt;高度&gt;</span>
    指定明确的相机捕获尺寸。

<span class="hljs-comment">--capture-orientation=数值</span>
    设置捕获视频的方向。
    可能的值为 <span class="hljs-number">0</span>, <span class="hljs-number">90</span>, <span class="hljs-number">180</span>, <span class="hljs-number">270</span>, flip0, flip90, flip180 和 flip270，前面可以加 <span class="hljs-string">'@'</span> 前缀。
    数字表示顺时针旋转的度数；`<span class="hljs-string">"flip"</span>` 关键字表示在旋转前应用水平翻转。
    如果为显示捕获传递了前导 <span class="hljs-string">'@'</span>（如 `@<span class="hljs-number">90</span>`），则旋转将被锁定，且相对于设备的自然方向。
    如果单独传递 `@`，则旋转将锁定到设备的初始方向。
    默认值为 <span class="hljs-number">0</span>。

<span class="hljs-comment">--crop=宽度:高度:x:y</span>
    在服务器上裁剪设备屏幕。
    数值以设备的自然方向表示（通常，手机为纵向，平板为横向）。

-d, <span class="hljs-comment">--select-usb</span>
    使用 USB 设备（如果恰好有一个，类似于 `adb -d`）。
    另请参阅 -e (`<span class="hljs-comment">--select-tcpip`)。</span>

<span class="hljs-comment">--disable-screensaver</span>
    在 scrcpy 运行时禁用屏幕保护程序。

<span class="hljs-comment">--display-id=标识</span>
    指定要镜像的设备显示 ID。
    可用的显示 ID 可通过以下命令列出：
        scrcpy <span class="hljs-comment">--list-displays</span>
    默认值为 <span class="hljs-number">0</span>。

<span class="hljs-comment">--display-ime-policy=策略</span>
    设置选择 IME 应在何处显示的策略。
    可能的值有 `<span class="hljs-string">"local"</span>`, `<span class="hljs-string">"fallback"</span>` 和 `<span class="hljs-string">"hide"</span>`。
    `<span class="hljs-string">"local"</span>` 表示 IME 应显示在本地屏幕上。
    `<span class="hljs-string">"fallback"</span>` 表示 IME 应显示在备用（默认）屏幕上。
    `<span class="hljs-string">"hide"</span>` 表示 IME 应隐藏。

<span class="hljs-comment">--display-orientation=数值</span>
    设置初始显示方向。
    可能的值为 <span class="hljs-number">0</span>, <span class="hljs-number">90</span>, <span class="hljs-number">180</span>, <span class="hljs-number">270</span>, flip0, flip90, flip180 和 flip270。
    数字表示顺时针旋转的度数；`<span class="hljs-string">"flip"</span>` 关键字表示在旋转前应用水平翻转。
    默认值为 <span class="hljs-number">0</span>。

-e, <span class="hljs-comment">--select-tcpip</span>
    使用 TCP/IP 设备（如果恰好有一个，类似于 `adb -e`）。
    另请参阅 -d (`<span class="hljs-comment">--select-usb`)。</span>

-f, <span class="hljs-comment">--fullscreen</span>
    以全屏模式启动。

<span class="hljs-comment">--force-adb-forward</span>
    不尝试使用 `adb <span class="hljs-built_in">reverse</span>` 连接到设备。

-G
    等同于 `<span class="hljs-comment">--gamepad=uhid`，如果设置了 `--otg` 则等同于 `--gamepad=aoa`。</span>

<span class="hljs-comment">--gamepad=模式</span>
    选择如何向设备发送游戏手柄输入。
    可能的值有 `<span class="hljs-string">"disabled"</span>`, `<span class="hljs-string">"uhid"</span>` 和 `<span class="hljs-string">"aoa"</span>`。
    `<span class="hljs-string">"disabled"</span>` 不向设备发送游戏手柄输入。
    `<span class="hljs-string">"uhid"</span>` 使用设备上的 Linux UHID 内核模块模拟物理 HID 游戏手柄。
    `<span class="hljs-string">"aoa"</span>` 使用 AOAv2 协议模拟物理游戏手柄。它可能仅通过 USB 工作。
    另请参阅 `<span class="hljs-comment">--keyboard` 和 `--mouse`。</span>

-h, <span class="hljs-comment">--help</span>
    打印此帮助信息。

-K
    等同于 `<span class="hljs-comment">--keyboard=uhid`，如果设置了 `--otg` 则等同于 `--keyboard=aoa`。</span>

<span class="hljs-comment">--keyboard=模式</span>
    选择如何向设备发送键盘输入。
    可能的值有 `<span class="hljs-string">"disabled"</span>`, `<span class="hljs-string">"sdk"</span>`, `<span class="hljs-string">"uhid"</span>` 和 `<span class="hljs-string">"aoa"</span>`。
    `<span class="hljs-string">"disabled"</span>` 不向设备发送键盘输入。
    `<span class="hljs-string">"sdk"</span>` 使用 Android 系统 API 将键盘事件传递给应用程序。
    `<span class="hljs-string">"uhid"</span>` 使用设备上的 Linux UHID 内核模块模拟物理 HID 键盘。
    `<span class="hljs-string">"aoa"</span>` 使用 AOAv2 协议模拟物理键盘。它可能仅通过 USB 工作。
    对于 `<span class="hljs-string">"uhid"</span>` 和 `<span class="hljs-string">"aoa"</span>` 模式，必须通过 `设置 -&gt; 系统 -&gt; 语言和输入 -&gt; 物理键盘` 在设备上配置（一劳永逸地）键盘布局。可以通过快捷键 MOD+k (OTG 模式除外) 或执行 `adb shell am start -a android.settings.HARD_KEYBOARD_SETTINGS` 直接启动此设置页面。
    此选项仅在启用 HID 键盘（或连接了物理键盘）时可用。
    另请参阅 `<span class="hljs-comment">--mouse` 和 `--gamepad`。</span>

<span class="hljs-comment">--kill-adb-on-close</span>
    当 scrcpy 终止时结束 adb 进程。

<span class="hljs-comment">--legacy-paste</span>
    在按 Ctrl+v 时，将计算机剪贴板文本作为一系列按键事件注入（类似 MOD+Shift+v）。
    这是针对某些设备在编程方式设置设备剪贴板时行为不符合预期的解决方法。

<span class="hljs-comment">--list-apps</span>
    列出设备上安装的 Android 应用。

<span class="hljs-comment">--list-cameras</span>
    列出设备摄像头。

<span class="hljs-comment">--list-camera-sizes</span>
    列出有效的相机捕获尺寸。

<span class="hljs-comment">--list-displays</span>
    列出设备屏幕。

<span class="hljs-comment">--list-encoders</span>
    列出设备上可用的视频和音频编码器。

-m, <span class="hljs-comment">--max-size=数值</span>
    将视频的宽度和高度都限制为指定值。另一维度会按比例计算以保持设备宽高比。
    默认值为 <span class="hljs-number">0</span> (无限制)。

-M
    等同于 `<span class="hljs-comment">--mouse=uhid`，如果设置了 `--otg` 则等同于 `--mouse=aoa`。</span>

<span class="hljs-comment">--max-fps=数值</span>
    限制屏幕捕获的帧率（从 Android <span class="hljs-number">10</span> 开始官方支持，但早期版本可能也可用）。

<span class="hljs-comment">--mouse=模式</span>
    选择如何向设备发送鼠标输入。
    可能的值有 `<span class="hljs-string">"disabled"</span>`, `<span class="hljs-string">"sdk"</span>`, `<span class="hljs-string">"uhid"</span>` 和 `<span class="hljs-string">"aoa"</span>`。
    `<span class="hljs-string">"disabled"</span>` 不向设备发送鼠标输入。
    `<span class="hljs-string">"sdk"</span>` 使用 Android 系统 API 将鼠标事件传递给应用程序。
    `<span class="hljs-string">"uhid"</span>` 使用设备上的 Linux UHID 内核模块模拟物理 HID 鼠标。
    `<span class="hljs-string">"aoa"</span>` 使用 AOAv2 协议模拟物理鼠标。它可能仅通过 USB 工作。
    在 `<span class="hljs-string">"uhid"</span>` 和 `<span class="hljs-string">"aoa"</span>` 模式下，计算机鼠标会被捕获以直接控制设备（相对鼠标模式）。
    左 Alt、左 Super 或右 Super 键可切换捕获模式，将鼠标控制权交还给计算机。
    另请参阅 `<span class="hljs-comment">--keyboard` 和 `--gamepad`。</span>

<span class="hljs-comment">--mouse-bind=xxxx[:xxxx]</span>
    配置辅助点击的绑定。
    参数必须是一个或两个由冒号分隔的序列，每个序列恰好 <span class="hljs-number">4</span> 个字符，分别对应每个辅助点击（顺序为：右键、中键、第四键、第五键）。
    第一个序列定义主绑定，用于鼠标按钮单独按下时。第二个序列定义辅助绑定，用于按住 Shift 键的同时按下鼠标按钮时。
    如果省略第二个绑定序列，则与第一个序列相同。
    每个字符必须是以下之一：
     `+`: 将点击转发到设备
     `-`: 忽略点击
     `b`: 触发快捷键 BACK (或如果屏幕关闭则点亮屏幕)
     `h`: 触发快捷键 HOME
     `s`: 触发快捷键 APP_SWITCH
     `n`: 触发快捷键 `展开通知面板`
    对于 SDK 鼠标，默认为 `<span class="hljs-string">'bhsn:++++'</span>`；对于 AOA 和 UHID 鼠标，默认为 `<span class="hljs-string">'++++:bhsn'</span>`。

-n, <span class="hljs-comment">--no-control</span>
    禁用设备控制（以只读方式镜像设备）。

-N, <span class="hljs-comment">--no-playback</span>
    在计算机上禁用视频和音频播放（等同于 `<span class="hljs-comment">--no-video-playback --no-audio-playback`）。</span>

<span class="hljs-comment">--new-display[=[&lt;宽度&gt;x&lt;高度&gt;][/&lt;每英寸点数&gt;]]</span>
    创建一个具有指定分辨率和像素密度（DPI）的新屏幕。如果未提供，则默认使用主屏幕尺寸和 DPI。
    示例：
        <span class="hljs-comment">--new-display=1920x1080</span>
        <span class="hljs-comment">--new-display=1920x1080/420  # 强制 420 DPI</span>
        <span class="hljs-comment">--new-display                # 主屏幕尺寸和 DPI</span>
        <span class="hljs-comment">--new-display=/240           # 主屏幕尺寸和 240 DPI</span>

<span class="hljs-comment">--no-audio</span>
    禁用音频转发。

<span class="hljs-comment">--no-audio-playback</span>
    在计算机上禁用音频播放。

<span class="hljs-comment">--no-cleanup</span>
    默认情况下，scrcpy 在退出时会从设备移除服务器二进制文件并恢复设备状态（显示触摸、保持唤醒和电源模式）。
    此选项禁用此清理操作。

<span class="hljs-comment">--no-clipboard-autosync</span>
    默认情况下，scrcpy 会在注入 Ctrl+v 之前自动将计算机剪贴板同步到设备剪贴板，并在设备剪贴板发生变化时自动将其同步到计算机剪贴板。
    此选项禁用此自动同步。

<span class="hljs-comment">--no-downsize-on-error</span>
    默认情况下，在 MediaCodec 出错时，scrcpy 会自动尝试以较低的分辨率重新编码。
    此选项禁用此行为。

<span class="hljs-comment">--no-key-repeat</span>
    当按键被按住时，不转发重复的按键事件。

<span class="hljs-comment">--no-mipmaps</span>
    如果渲染器是 OpenGL <span class="hljs-number">3.0</span>+ 或 OpenGL ES <span class="hljs-number">2.0</span>+，则会自动生成 Mipmaps 以提高缩小比例时的质量。此选项禁用 Mipmaps 的生成。

<span class="hljs-comment">--no-mouse-hover</span>
    不转发鼠标悬停（没有任何点击的鼠标移动）事件。

<span class="hljs-comment">--no-power-on</span>
    启动时不唤醒设备。

<span class="hljs-comment">--no-vd-destroy-content</span>
    禁用虚拟屏幕的“移除时销毁内容”标志。
    启用此选项后，关闭虚拟屏幕时，正在运行的应用会移到主屏幕而不是被销毁。

<span class="hljs-comment">--no-vd-system-decorations</span>
    禁用虚拟屏幕的系统装饰标志。

<span class="hljs-comment">--no-video</span>
    禁用视频转发。

<span class="hljs-comment">--no-video-playback</span>
    在计算机上禁用视频播放。

<span class="hljs-comment">--no-window</span>
    禁用 scrcpy 窗口。隐含 `<span class="hljs-comment">--no-video-playback`。</span>

<span class="hljs-comment">--orientation=数值</span>
    等同于 `<span class="hljs-comment">--display-orientation=数值 --record-orientation=数值`。</span>

<span class="hljs-comment">--otg</span>
    以 OTG 模式运行：模拟物理键盘和鼠标，就像计算机键盘和鼠标通过 OTG 线缆直接插入设备一样。
    在此模式下，不需要 adb (USB 调试)，并且镜像被禁用。
    左 Alt、左 Super 或右 Super 键可切换鼠标捕获模式，将鼠标控制权交还给计算机。
    键盘和鼠标可以分别使用 `<span class="hljs-comment">--keyboard=disabled` 和 `--mouse=disabled` 禁用。</span>
    它可能仅通过 USB 工作。
    参见 `<span class="hljs-comment">--keyboard`, `--mouse` 和 `--gamepad`。</span>

-p, <span class="hljs-comment">--port=端口[:端口]</span>
    设置客户端监听的 TCP 端口（范围）。
    默认值为 <span class="hljs-number">27183</span>:<span class="hljs-number">27199</span>。

<span class="hljs-comment">--pause-on-exit[=模式]</span>
    配置退出时暂停。可能的值有 `<span class="hljs-string">"true"</span>` (总是在退出时暂停)、`<span class="hljs-string">"false"</span>` (从不在退出时暂停) 和 `<span class="hljs-string">"if-error"</span>` (仅在出错时暂停)。
    这有助于防止终端窗口自动关闭，以便阅读错误信息。
    默认值为 `<span class="hljs-string">"false"</span>`。
    不带参数传递此选项等同于传递 `<span class="hljs-string">"true"</span>`。

<span class="hljs-comment">--power-off-on-close</span>
    关闭 scrcpy 时关闭设备屏幕。

<span class="hljs-comment">--prefer-text</span>
    将字母字符和空格作为文本事件而非按键事件注入。
    这避免了输入特殊字符时组合多个键可能产生的问题，但会破坏游戏中字母键（通常是 WASD）的预期行为。

<span class="hljs-comment">--print-fps</span>
    启动 FPS 计数器，在控制台打印帧率日志。可以随时通过 MOD+i 启动或停止。

<span class="hljs-comment">--push-target=路径</span>
    设置通过拖放将文件推送到设备时的目标目录。
    此路径会原样传递给 `adb push`。
    默认值为 `<span class="hljs-string">"/sdcard/Download/"</span>`。

-r, <span class="hljs-comment">--record=文件名.mp4</span>
    将屏幕录制到文件。
    格式由 `<span class="hljs-comment">--record-format` 选项（如果设置）或文件扩展名决定。</span>

<span class="hljs-comment">--raw-key-events</span>
    为所有输入键注入按键事件，并忽略文本事件。

<span class="hljs-comment">--record-format=格式</span>
    强制录制格式 (mp4, mkv, m4a, mka, opus, aac, flac 或 wav)。

<span class="hljs-comment">--record-orientation=数值</span>
    设置录制方向。
    可能的值为 <span class="hljs-number">0</span>, <span class="hljs-number">90</span>, <span class="hljs-number">180</span> 和 <span class="hljs-number">270</span>。数字表示顺时针旋转的度数。
    默认值为 <span class="hljs-number">0</span>。

<span class="hljs-comment">--render-driver=名称</span>
    请求 SDL 使用给定的渲染驱动（这只是一个提示）。
    目前支持的名称有 `<span class="hljs-string">"direct3d"</span>`, `<span class="hljs-string">"opengl"</span>`, `<span class="hljs-string">"opengles2"</span>`, `<span class="hljs-string">"opengles"</span>`, `<span class="hljs-string">"metal"</span>` 和 `<span class="hljs-string">"software"</span>`。
    &lt;https://wiki.libsdl.org/SDL_HINT_RENDER_DRIVER&gt;

<span class="hljs-comment">--require-audio</span>
    默认情况下，当设备上的音频捕获失败时，scrcpy 仅镜像视频。此选项使得在启用音频但音频无法工作时，scrcpy 直接失败。

-s, <span class="hljs-comment">--serial=序列号</span>
    设备序列号。仅在多个设备连接到 adb 时必须指定。

-S, <span class="hljs-comment">--turn-screen-off</span>
    立即关闭设备屏幕。

<span class="hljs-comment">--screen-off-timeout=秒数</span>
    设置在 scrcpy 运行期间的屏幕关闭超时时间（退出时恢复初始值）。

<span class="hljs-comment">--shortcut-mod=按键[+...][,...]</span>
    指定用于 scrcpy 快捷键的修饰键。
    可能的按键是 `<span class="hljs-string">"lctrl"</span>`, `<span class="hljs-string">"rctrl"</span>`, `<span class="hljs-string">"lalt"</span>`, `<span class="hljs-string">"ralt"</span>`, `<span class="hljs-string">"lsuper"</span>` 和 `<span class="hljs-string">"rsuper"</span>`。
    可以指定多个快捷键修饰键，用逗号分隔。
    例如，要使用左 Ctrl 或左 Super 作为 scrcpy 快捷键，传递 `<span class="hljs-string">"lctrl,lsuper"</span>`。
    默认值为 `<span class="hljs-string">"lalt,lsuper"</span>` (左 Alt 或左 Super)。

<span class="hljs-comment">--start-app=名称</span>
    启动一个 Android 应用，通过其精确的包名。
    添加前缀 `<span class="hljs-string">'?'</span>` 以选择名称以给定名称（不区分大小写）开头的应用（在设备上检索应用名称可能需要一些时间）：
        scrcpy <span class="hljs-comment">--start-app=?firefox</span>
    添加前缀 `<span class="hljs-string">'+'</span>` 以在启动应用前强制停止它：
        scrcpy <span class="hljs-comment">--new-display --start-app=+org.mozilla.firefox</span>
    两个前缀可以一起使用，按此顺序：
        scrcpy <span class="hljs-comment">--start-app=+?firefox</span>

-t, <span class="hljs-comment">--show-touches</span>
    在启动时启用“显示触摸”，退出时恢复初始值。
    它只显示物理触摸（不包括来自 scrcpy 的点击）。

<span class="hljs-comment">--tcpip[=[+]IP地址[:端口]]</span>
    通过 TCP/IP 配置并连接到设备。
    如果提供了目标地址，则 scrcpy 在启动前连接到该地址。设备必须在给定的 TCP 端口（默认 <span class="hljs-number">5555</span>）上监听。
    如果未提供目标地址，则 scrcpy 尝试查找当前设备（通常通过 USB 连接）的 IP 地址，启用 TCP/IP 模式，然后在启动前连接到该地址。
    在地址前加 `<span class="hljs-string">'+'</span>` 前缀以强制重新连接。

<span class="hljs-comment">--time-limit=秒数</span>
    设置最大镜像时间（秒）。

<span class="hljs-comment">--tunnel-host=IP地址</span>
    设置用于访问 scrcpy 服务器的 adb 隧道 IP 地址。此选项自动启用 `<span class="hljs-comment">--force-adb-forward`。</span>
    默认值为 `localhost`。

<span class="hljs-comment">--tunnel-port=端口</span>
    设置用于访问 scrcpy 服务器的 adb 隧道 TCP 端口。此选项自动启用 `<span class="hljs-comment">--force-adb-forward`。</span>
    默认值为 `<span class="hljs-number">0</span>` (不强制)：将使用用于建立隧道的本地端口。

-v, <span class="hljs-comment">--version</span>
    打印 scrcpy 的版本。

-V, <span class="hljs-comment">--verbosity=级别</span>
    设置日志级别 (verbose, <span class="hljs-built_in">debug</span>, info, warn 或 <span class="hljs-built_in">error</span>)。
    默认值为 `info`。

<span class="hljs-comment">--v4l2-sink=/dev/videoN</span>
    输出到 v4l2loopback 设备。
    此功能仅在 Linux 上可用。

<span class="hljs-comment">--v4l2-buffer=毫秒</span>
    在推送帧之前添加缓冲延迟（毫秒）。这会增加延迟以补偿抖动。
    此选项类似于 `<span class="hljs-comment">--video-buffer`，但专用于 V4L2 输出。</span>
    默认值为 <span class="hljs-number">0</span> (无缓冲)。
    此选项仅在 Linux 上可用。

<span class="hljs-comment">--video-buffer=毫秒</span>
    在显示视频帧之前添加缓冲延迟（毫秒）。这会增加延迟以补偿抖动。
    默认值为 <span class="hljs-number">0</span> (无缓冲)。

<span class="hljs-comment">--video-codec=名称</span>
    选择视频编码器 (h264, h265 或 av1)。
    默认值为 h264。

<span class="hljs-comment">--video-codec-options=键[:类型]=值[, ...]</span>
    为设备视频编码器设置以逗号分隔的 `键:类型=值` 选项列表。
    <span class="hljs-string">'类型'</span> 的可能值为 <span class="hljs-string">'int'</span> (默认), <span class="hljs-string">'long'</span>, <span class="hljs-string">'float'</span> 和 <span class="hljs-string">'string'</span>。
    可能的编解码器选项列表可在 Android 文档中找到：
    &lt;https://d.android.com/reference/android/media/MediaFormat&gt;

<span class="hljs-comment">--video-encoder=名称</span>
    使用特定的 MediaCodec 视频编码器（取决于 `<span class="hljs-comment">--video-codec` 提供的编解码器）。</span>
    可用的编码器可通过 `<span class="hljs-comment">--list-encoders` 列出。</span>

<span class="hljs-comment">--video-source=来源</span>
    选择视频来源 (display 或 camera)。
    相机镜像需要 Android <span class="hljs-number">12</span>+。
    默认值为 `display`。

-w, <span class="hljs-comment">--stay-awake</span>
    当设备接通电源时，在 scrcpy 运行期间保持设备唤醒。

<span class="hljs-comment">--window-borderless</span>
    禁用窗口装饰（显示无边框窗口）。

<span class="hljs-comment">--window-title=文本</span>
    设置自定义窗口标题。

<span class="hljs-comment">--window-x=数值</span>
    设置窗口初始水平位置。
    默认值为 `<span class="hljs-string">"auto"</span>`。

<span class="hljs-comment">--window-y=数值</span>
    设置窗口初始垂直位置。
    默认值为 `<span class="hljs-string">"auto"</span>`。

<span class="hljs-comment">--window-width=数值</span>
    设置窗口初始宽度。
    默认值为 <span class="hljs-number">0</span> (自动)。

<span class="hljs-comment">--window-height=数值</span>
    设置窗口初始高度。
    默认值为 <span class="hljs-number">0</span> (自动)。
</code></pre>
<p>快捷键：</p>
<pre><code class="hljs language-markdown" lang="markdown">在以下列表中，MOD 是快捷键修饰键。默认是（左）Alt 或（左）Super，但可以通过 <span class="hljs-code">`--shortcut-mod`</span> 配置（见上文）。

MOD+f
<span class="hljs-code">    切换全屏模式
</span>
MOD+左方向键
<span class="hljs-code">    向左旋转屏幕
</span>
MOD+右方向键
<span class="hljs-code">    向右旋转屏幕
</span>
MOD+Shift+左方向键
MOD+Shift+右方向键
<span class="hljs-code">    水平翻转屏幕
</span>
MOD+Shift+上方向键
MOD+Shift+下方向键
<span class="hljs-code">    垂直翻转屏幕
</span>
MOD+z
<span class="hljs-code">    暂停或恢复显示
</span>
MOD+Shift+z
<span class="hljs-code">    取消暂停显示
</span>
MOD+Shift+r
<span class="hljs-code">    重置视频捕获/编码
</span>
MOD+g
<span class="hljs-code">    将窗口大小调整为 1:1 (像素完美)
</span>
MOD+w
双击黑边
<span class="hljs-code">    调整窗口大小以移除黑边
</span>
MOD+h
中键点击
<span class="hljs-code">    点击 HOME
</span>
MOD+b
MOD+退格键
右键点击 (当屏幕亮时)
<span class="hljs-code">    点击 BACK
</span>
MOD+s
第四键点击
<span class="hljs-code">    点击 APP_SWITCH
</span>
MOD+m
<span class="hljs-code">    点击 MENU
</span>
MOD+上方向键
<span class="hljs-code">    点击 VOLUME_UP
</span>
MOD+下方向键
<span class="hljs-code">    点击 VOLUME_DOWN
</span>
MOD+p
<span class="hljs-code">    点击 POWER (打开/关闭屏幕)
</span>
右键点击 (当屏幕灭时)
<span class="hljs-code">    点亮屏幕
</span>
MOD+o
<span class="hljs-code">    关闭设备屏幕 (继续镜像)
</span>
MOD+Shift+o
<span class="hljs-code">    打开设备屏幕
</span>
MOD+r
<span class="hljs-code">    旋转设备屏幕
</span>
MOD+n
第五键点击
<span class="hljs-code">    展开通知面板
</span>
MOD+Shift+n
<span class="hljs-code">    收起通知面板
</span>
MOD+c
<span class="hljs-code">    复制到剪贴板 (注入 COPY 键码，仅限 Android &gt;= 7)
</span>
MOD+x
<span class="hljs-code">    剪切到剪贴板 (注入 CUT 键码，仅限 Android &gt;= 7)
</span>
MOD+v
<span class="hljs-code">    将计算机剪贴板内容复制到设备，然后粘贴 (注入 PASTE 键码，仅限 Android &gt;= 7)
</span>
MOD+Shift+v
<span class="hljs-code">    将计算机剪贴板文本作为一系列按键事件注入
</span>
MOD+k
<span class="hljs-code">    在设备上打开键盘设置 (仅适用于 HID 键盘)
</span>
MOD+i
<span class="hljs-code">    启用/禁用 FPS 计数器 (在日志中打印每秒帧数)
</span>
Ctrl+点击并拖动
<span class="hljs-code">    从屏幕中心进行捏合缩放和旋转
</span>
Shift+点击并拖动
<span class="hljs-code">    垂直倾斜 (用双指滑动)
</span>
Ctrl+Shift+点击并拖动
<span class="hljs-code">    水平倾斜 (用双指滑动)
</span>
拖放 APK 文件
<span class="hljs-code">    从计算机安装 APK
</span>
拖放非 APK 文件
<span class="hljs-code">    推送文件到设备 (参见 `--push-target`)
</span></code></pre>
<p>环境变量：</p>
<pre><code class="hljs language-go" lang="go">ADB
    adb 可执行文件的路径

ANDROID_SERIAL
    如果未指定选择器 (<span class="hljs-string">`-s`</span>, <span class="hljs-string">`-d`</span>, <span class="hljs-string">`-e`</span> 或 <span class="hljs-string">`--tcpip=&lt;地址&gt;`</span>) 时要使用的设备序列号

SCRCPY_ICON_PATH
    程序图标路径

SCRCPY_SERVER_PATH
    服务器二进制文件路径
</code></pre>
<p>退出状态：</p>
<pre><code class="hljs">  0  程序正常终止
  1  启动失败
  2  运行过程中设备断开连接
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fiddler抓包工具详解，HTTPHTTPS调试、代理配置与接口分析实战教程]]></title>    <link>https://juejin.cn/post/7578762210287386687</link>    <guid>https://juejin.cn/post/7578762210287386687</guid>    <pubDate>2025-12-02T03:19:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578762210287386687" data-draft-id="7578811288819236907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fiddler抓包工具详解，HTTPHTTPS调试、代理配置与接口分析实战教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T03:19:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fiddler抓包工具详解，HTTPHTTPS调试、代理配置与接口分析实战教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:19:00.000Z" title="Tue Dec 02 2025 03:19:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前后端分离、微服务架构日益复杂的今天，网络通信问题、接口异常与性能瓶颈几乎成了每位开发者的“日常伴侣”。
要精准定位这些问题，一个强大的抓包调试工具就显得至关重要。</p>
<p>在众多工具中，<strong>Fiddler抓包工具</strong> 凭借其功能全面、免费易用、兼容性强的优势，成为开发者在接口调试、性能分析和移动端调试中的首选利器。</p>
<p>本文将结合实战经验，系统讲解 <strong>Fiddler使用教程、代理配置、HTTPS抓包、接口调试与优化技巧</strong>，帮助你高效掌握网络调试的核心能力。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Fiddler抓包工具简介</strong></h2>
<p><strong>Fiddler</strong> 是 Telerik 公司推出的一款专业 HTTP/HTTPS 抓包与调试工具，通过代理机制拦截并记录网络请求，实现对请求头、响应内容、参数与性能的全面分析。</p>
<p>相比其他常见工具：</p>






























<table><thead><tr><th>工具</th><th>特点</th><th>优势</th></tr></thead><tbody><tr><td><strong>Fiddler</strong></td><td>免费、可定制、支持断点与Mock</td><td>功能全面、调试灵活</td></tr><tr><td><strong>Charles</strong></td><td>商业软件，操作简单</td><td>上手快但功能略弱</td></tr><tr><td><strong>Postman</strong></td><td>请求构造与测试工具</td><td>不支持实时抓包</td></tr><tr><td><strong>Wireshark</strong></td><td>底层网络分析工具</td><td>专业但学习门槛高</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1"><strong>二、Fiddler安装与配置步骤</strong></h2>
<h3 data-id="heading-2"><strong>1. 安装与启动</strong></h3>
<p>安装 Fiddler 后，启动时会自动接管系统代理。
打开浏览器访问任意网站，即可在 Fiddler 界面看到实时请求流。</p>
<ul>
<li>左下角显示 “Capturing” 表示正在抓包；</li>
<li>若显示 “Paused”，点击即可重新开始。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>2. Fiddler代理配置（电脑与移动端）</strong></h3>
<p>Fiddler 默认仅捕获本机网络流量。
若要抓取移动端 App、小程序或其他设备的请求，需要开启远程代理。</p>
<p><strong>配置方法如下：</strong></p>
<ol>
<li>打开 <code>Tools → Options → Connections</code>；</li>
<li>勾选 <strong>Allow remote computers to connect</strong>；</li>
<li>记录电脑 IP 地址与端口（默认 8888）；</li>
<li>确保手机与电脑连接同一 Wi-Fi；</li>
<li>在手机 Wi-Fi 设置中添加代理：
<ul>
<li>主机名：电脑 IP；</li>
<li>端口号：8888。</li>
</ul>
</li>
</ol>
<p>完成后，Fiddler 即可捕获移动端所有网络请求。</p>
<hr/>
<h3 data-id="heading-4"><strong>3. HTTPS 抓包配置</strong></h3>
<p>现代网站几乎全部启用 HTTPS 加密，
因此需要安装并信任 Fiddler 证书，才能查看加密请求。</p>
<p><strong>配置步骤如下：</strong></p>
<ul>
<li>打开 <code>Tools → Options → HTTPS</code>；</li>
<li>勾选 <strong>Decrypt HTTPS traffic</strong>；</li>
<li>点击 “Actions → Trust Root Certificate”；</li>
<li>安装并信任根证书；</li>
<li>若抓取移动端请求，还需导出证书并在手机信任。</li>
</ul>
<p>配置完成后，Fiddler 将能显示 HTTPS 请求的完整 Header 与响应内容。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、Fiddler使用教程：核心功能详解</strong></h2>
<h3 data-id="heading-6"><strong>1. 请求与响应分析</strong></h3>
<p>Fiddler 主界面显示系统中所有请求，
点击任意条目即可查看：</p>
<ul>
<li>请求方式（GET/POST/PUT/DELETE）；</li>
<li>请求 URL 与参数；</li>
<li>请求头、Cookie、请求体；</li>
<li>响应状态码、返回数据与时间统计。</li>
</ul>
<p>某电商接口在移动端加载失败，通过 Fiddler 抓包发现请求参数多带了一个空格，
导致后端签名验证不通过。几分钟内即可定位修复。</p>
<hr/>
<h3 data-id="heading-7"><strong>2. 模拟接口响应（AutoResponder）</strong></h3>
<p>AutoResponder 模块允许开发者模拟接口响应，
无需依赖后端即可测试前端逻辑。</p>
<p><strong>使用方法：</strong></p>
<ol>
<li>打开 AutoResponder 面板；</li>
<li>点击 “Add Rule” 添加规则；</li>
<li>匹配接口 URL 或路径关键字；</li>
<li>选择本地 JSON 文件或自定义返回内容；</li>
<li>勾选 “Enable Rules” 启用规则。</li>
</ol>
<p><strong>示例：</strong>
可让 <code>/api/user</code> 返回 <code>{ "status":200, "name":"test" }</code>，
前端即可在后端未完成时正常开发。</p>
<hr/>
<h3 data-id="heading-8"><strong>3. 请求断点与修改（Breakpoints）</strong></h3>
<p>Fiddler 支持在请求或响应阶段设置断点，
开发者可在请求发出或响应返回前修改数据。</p>
<p><strong>常用命令：</strong></p>
<ul>
<li><code>bpu yourapi.com</code> → 请求前断点；</li>
<li><code>bpafter yourapi.com</code> → 响应前断点；</li>
<li><code>bpu</code> → 关闭断点。</li>
</ul>
<p><strong>应用场景：</strong></p>
<ul>
<li>模拟服务器错误（500 / 404）；</li>
<li>测试接口容错机制；</li>
<li>手动修改参数验证接口安全性。</li>
</ul>
<hr/>
<h3 data-id="heading-9"><strong>4. 构造与重放请求（Composer）</strong></h3>
<p>Composer 模块相当于集成版 Postman，
可构造请求、修改参数、调试接口。</p>
<p><strong>使用技巧：</strong></p>
<ul>
<li>支持请求头、Body、参数完全自定义；</li>
<li>可导入历史请求重放；</li>
<li>验证签名算法、接口 Token 或身份校验逻辑。</li>
</ul>
<hr/>
<h3 data-id="heading-10"><strong>5. 性能分析（Timeline）</strong></h3>
<p>Timeline 模块可可视化展示请求耗时阶段：
DNS → TCP → TLS → Server Response → Content Download。</p>
<p><strong>典型用途：</strong></p>
<ul>
<li>分析加载延迟瓶颈；</li>
<li>优化接口响应速度；</li>
<li>判断问题是网络还是后端性能。</li>
</ul>
<hr/>
<h2 data-id="heading-11"><strong>四、实战案例：接口延迟与请求异常分析</strong></h2>
<p>在某项目中，首页加载耗时超过 8 秒。
通过 Fiddler Timeline 分析：</p>
<ul>
<li>请求队列阻塞严重；</li>
<li>DNS 解析时间高；</li>
<li>后端响应延迟明显。</li>
</ul>
<p>通过优化后：</p>
<ul>
<li>启用缓存减少重复请求；</li>
<li>合并资源请求；</li>
<li>后端开启 Gzip 压缩。</li>
</ul>
<p>最终加载时间降至 2.3 秒。</p>
<blockquote>
<p>Fiddler 不仅用于抓包，更能成为网络性能优化的核心工具。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12"><strong>五、Fiddler功能模块总览</strong></h2>



































<table><thead><tr><th>模块</th><th>功能</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>Filters</strong></td><td>按条件筛选请求</td><td>仅关注目标接口</td></tr><tr><td><strong>AutoResponder</strong></td><td>模拟接口响应</td><td>前后端分离调试</td></tr><tr><td><strong>Breakpoints</strong></td><td>拦截并修改请求</td><td>异常模拟与安全测试</td></tr><tr><td><strong>Composer</strong></td><td>构造与重放请求</td><td>接口验证与性能调试</td></tr><tr><td><strong>Timeline</strong></td><td>请求性能分析</td><td>网络性能优化</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13"><strong>六、Fiddler学习与资源推荐</strong></h2>
<p>想深入学习 Fiddler 的更多用法？推荐访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fiddler.hk%2F" target="_blank" title="https://www.fiddler.hk/" ref="nofollow noopener noreferrer">Fiddler 中文网</a></p>
<ul>
<li>Fiddler 安装与配置教程；</li>
<li>HTTPS 抓包与证书设置方法；</li>
<li>移动端代理调试指南；</li>
<li>Mock 数据与断点调试技巧；</li>
<li>网络性能优化实战案例。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不知道怎么选型文件型数据库？快来看看吧]]></title>    <link>https://juejin.cn/post/7578781397117829166</link>    <guid>https://juejin.cn/post/7578781397117829166</guid>    <pubDate>2025-12-02T03:19:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578781397117829166" data-draft-id="7578793960626847770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不知道怎么选型文件型数据库？快来看看吧"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-02T03:19:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="葡萄城技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868332765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不知道怎么选型文件型数据库？快来看看吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868332765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    葡萄城技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:19:11.000Z" title="Tue Dec 02 2025 03:19:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">不知道怎么选型文件型数据库？快来看看吧</h2>
<p>最近正好需要为项目选择一个初始场景的学习和试用场景的关系型数据库，对于这种场景，文件型数据库就是最合适的，因为其几乎没有部署成本，并且数据迁移便利，资源消耗低。</p>
<h3 data-id="heading-1">SQLite</h3>
<p>那既然说到了文件型数据库，那 SQLite 可就精神了。作为文件型数据库的中流砥柱，它几乎占据了嵌入式场景 70% 以上的江山。你的手机相册、你的浏览器历史记录、你正在用的 IDE、你微信的聊天记录，甚至你那台智能冰箱里，可能都静静地躺着一个 <code>.SQLite</code> 文件。</p>
<h4 data-id="heading-2">Small. Fast. Reliable. Choose any three</h4>
<p>作为嵌入式数据库的中流砥柱，SQLite 有诸多过人之处：</p>
<ol>
<li><strong>高度可靠，经过严苛测试</strong>：SQLite 的作者对稳定性近乎偏执，最新统计其<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.SQLite.org%2Ftesting.html" target="_blank" title="https://www.SQLite.org/testing.html" ref="nofollow noopener noreferrer">测试代码行数超过 9000 万行，远远高于自身约 15 万行的源码</a>。正因如此，SQLite 被视为“非常健壮且耐用”的数据库，引擎品质媲美工业级产品。实际应用中只要遵循官方建议配置，它几乎不会丢失数据，哪怕面对各种异常情况也能保证数据完整性。</li>
<li><strong>零配置易用</strong>：SQLite 是自包含的，无需客户端/服务器架构，不用启动独立服务进程。[应用进程直接以函数库形式调用它的功能](<a href="https://link.juejin.cn?target=https%3A%2F%2FSQLite.org%2Fwhentouse.html%23%3A~%3Atext%3DClient%252Fserver" target="_blank" title="https://SQLite.org/whentouse.html#:~:text=Client%2Fserver" ref="nofollow noopener noreferrer">SQLite.org/whentouse.h…</a> SQL database engines strive,efficiency%2C reliability%2C independence%2C and simplicity)。这意味着部署和使用极其简单：一个库文件加上一把 SQL，就能在应用内部实现数据持久化。对开发者来说，SQLite “拿来即用”，非常适合快速开发和小型项目的嵌入式存储。</li>
<li><strong>性能优异</strong>：别看 SQLite 体积小，单机单文件内它的读写速度相当快。在事务型负载（大量点查询、快速插入更新）场景下，SQLite 表现非常出色。官方经验表明，SQLite 擅长处理点查询和单记录读写，能在嵌入式设备上支撑每秒上万次简单查询。例如，对于按主键查询这样的操作，SQLite 利用索引可以在毫秒级返回结果。很多应用使用 SQLite 代替传统文件读写，性能反而更好，因为它内部对数据组织和检索做了大量优化。</li>
<li><strong>资源占用低</strong>：作为面向移动/嵌入式场景设计的引擎，SQLite 对内存和存储的要求都很低。其二进制库通常不到1MB大小，而在运行时，SQLite 也以精巧的机制避免浪费内存。在实际测试中，插入百万级别的数据后，SQLite 进程的内存仅增加区区数兆字节，这一数字远低于同类 Java 数据库。这种小内存占用使它非常适合在内存有限的环境（手机、物联网设备等）中长期运行。</li>
</ol>
<h4 data-id="heading-3">没有银弹</h4>
<p>但是，凡事没有银弹，如果 SQLite 真的完美无瑕，那么世界上就肯定只有一种文件型数据库了。当你试图用 SQLite 扛起稍微复杂一点的业务时，你可能会遇到以下问题：</p>
<ol>
<li><strong>弱类型且</strong> <strong>SQL</strong> <strong>语法不完备</strong>：当你开心地给每一个表创建一个 <code>created_at</code> 作为创建时间时，你突然发现，SQLite 这玩意竟然<strong>没有时间类型！</strong>，<a href="https://link.juejin.cn?target=https%3A%2F%2FSQLite.org%2Fdatatype3.html" target="_blank" title="https://SQLite.org/datatype3.html" ref="nofollow noopener noreferrer">SQLite 中仅有 5 种类型: NULL, INTEGER, REAL, TEXT, BLOB</a>。此外，SQLite 对 SQL 语法的支持也不完整，比如并不支持 存储过程，事务隔离级别仅支持串行化以及 RIGHT/OUTER FULL JOIN 等</li>
<li><strong>并发</strong>：你要你用过 SQLite，那几乎见过这个错误：<code>SQLite_BUSY: database is locked</code>, SQLite 在并发读写方面有天生局限：<strong>同一时间只允许一个写事务</strong></li>
<li><strong>分析慢</strong>：老板让你统计过去十年的订单总额，你写了个 <code>GROUP BY</code>，结果 SQLite 跑得比老牛拉破车还慢。不过 SQLite 是 OLTP 型数据库，这里说分析能力有点强人所难了</li>
<li><strong>单点</strong>：服务器硬盘坏了，那么不好意思了，你的数据库彻底丢失了。对于要求高可用的关键应用来说，仅靠 SQLite 单节点显然不够，需要通过操作系统层面的定期备份</li>
</ol>
<p>巧了，针对 SQLite 这些缺点，在不同领域确实存在相应的数据库对其补足了。</p>
<h3 data-id="heading-4">H2</h3>
<p>首先就是 H2。</p>
<p>如果说 SQLite 是 C 语言打造的嵌入式王者，那么 H2 则是 Java 生态中的后起之秀。</p>
<h4 data-id="heading-5">Java 原生，功能完备</h4>
<p>H2 Database Engine 是一个纯 Java 编写的轻量级关系数据库。由于天生和 JVM 环境高度契合，H2 已成为许多 Java 项目的默认嵌入式数据库选择（例如 Spring Boot 的默认内存数据库就是 H2）。</p>
<p>它有如下的优点：</p>
<ol>
<li><strong>完整的类型和</strong> <strong>SQL</strong> <strong>支持</strong>：这点直击 SQLite 弱类型的痛点，它采用静态模式的强类型系统，提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgrokipedia.com%2Fpage%2FH2_(database)" target="_blank" title="https://grokipedia.com/page/H2_(database)" ref="nofollow noopener noreferrer">完整的 SQL 类型系统以及完整的事务隔离级别</a>。总体而言，H2 在功能覆盖上更接近传统数据库</li>
<li><strong>纯Java实现，开箱即用</strong>：由于 H2 完全由 Java 编写，它可以直接嵌入运行于 JVM 的应用，而无需像 SQLite 那样通过 JNI 调用本地库。这带来的好处是部署更加简单——不再受限于操作系统，Javaer 也能更容易地调试和排查问题（毕竟H2的异常栈都是Java代码）。同时，H2 提供了方便的嵌入模式和服务器模式。嵌入模式下，它和应用共享同一 JVM 内存，数据文件存本地；而切换到服务器模式，又可以让多个进程通过TCP/IP协议共同访问数据库</li>
<li><strong>性能和并发</strong>：益于 Java 实现，H2 内部采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.h2database.com%2Fhtml%2Fadvanced.html%3Futm_source%3Dchatgpt.com%23mvcc" target="_blank" title="https://www.h2database.com/html/advanced.html?utm_source=chatgpt.com#mvcc" ref="nofollow noopener noreferrer">多版本并发控制（MVCC）来支持更高的并发度</a>，它允许多个连接同时读写同一个数据库，针对行级别加锁，从而减少锁竞争。相较于SQLite的单写者限制，H2 在并发写入场景下更具优势。此外，H2 内置了缓存机制，会将最近和频繁访问的数据页缓存在内存中，合理调优缓存大小可以大幅提升查询性能。</li>
<li><strong>易于调试和管理</strong>：H2 附带一个功能完善的Web控制台，允许开发者在浏览器中连接数据库、执行SQL、查看表结构，非常方便。（其实一点也不好用，UI 古老而且功能很少，不如直接使用 DB Manager）</li>
</ol>
<h4 data-id="heading-6">H2 的局限性</h4>
<p>尽管 H2 功能强大，但在某些方面却不如 SQLite 那般稳若磐石，主要体现在数据持久化可靠性和大数据集下的资源消耗：</p>
<ol>
<li><strong>持久化安全性</strong>：H2 对事务 Durability（持久性）的保证不如 。此外，SQLite 那样严格。在理想情况下，事务提交后数据应当写入持久介质，即使断电也不会丢失。但H2官方文档明确指出：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.h2database.com%2Fhtml%2Fadvanced.html%3Futm_source%3Dchatgpt.com%23durability_problems" target="_blank" title="https://www.h2database.com/html/advanced.html?utm_source=chatgpt.com#durability_problems" ref="nofollow noopener noreferrer">不保证所有已提交事务一定能在掉电后存活</a>，甚至还在后面说<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.h2database.com%2Fhtml%2Fadvanced.html%3Futm_source%3Dchatgpt.com%23durability_problems%3A~%3Atext%3D%25E4%25B8%2580%25E4%25BA%259B%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%25E5%25A3%25B0%25E7%25A7%25B0%25E4%25BB%2596%25E4%25BB%25AC%25E8%2583%25BD%25E5%25A4%259F%25E4%25BF%259D%25E8%25AF%2581%25E6%258C%2581%25E4%25B9%2585%25E6%2580%25A7%25EF%25BC%258C%25E4%25BD%2586%25E8%25BF%2599%25E4%25BA%259B%25E5%25A3%25B0%25E6%2598%258E%25E6%2598%25AF%25E9%2594%2599%25E8%25AF%25AF%25E7%259A%2584" target="_blank" title="https://www.h2database.com/html/advanced.html?utm_source=chatgpt.com#durability_problems:~:text=%E4%B8%80%E4%BA%9B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A3%B0%E7%A7%B0%E4%BB%96%E4%BB%AC%E8%83%BD%E5%A4%9F%E4%BF%9D%E8%AF%81%E6%8C%81%E4%B9%85%E6%80%A7%EF%BC%8C%E4%BD%86%E8%BF%99%E4%BA%9B%E5%A3%B0%E6%98%8E%E6%98%AF%E9%94%99%E8%AF%AF%E7%9A%84" ref="nofollow noopener noreferrer">一些数据库声称他们能够保证持久性，但这些声明是错误的</a>（这说的谁我想大家都知道）</li>
<li><strong>可靠性</strong>：由于测试强度和社区使用面不及 SQLite，H2 在大数据量、长时间运行时曝出过一些问题。一些在生产中尝试使用 H2 的开发者反馈：当数据规模增大、并发请求变多时，[H2 容易出现死锁、性能急剧下降，甚至偶尔会有数据损坏或丢失的情况](<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.baeldung.com%2Fh2-production-database-features-limitations%23%3A~%3Atext%3DReading" target="_blank" title="https://www.baeldung.com/h2-production-database-features-limitations#:~:text=Reading" ref="nofollow noopener noreferrer">www.baeldung.com/h2-producti…</a> reports and articles from,performance when the data grows)。这点对于生产环境来说是致命的，没有产品能接受用户的数据丢失问题。</li>
<li><strong>内存****与资源消耗</strong>：相较于高度精简的 SQLite，H2 对内存的胃口要大得多。一方面，Java 实现本身会占用一定堆空间；更重要的是，H2 为追求性能会在内存中缓存大量数据页和索引。一旦数据量上去，H2 进程的内存消耗可能直逼几百MB甚至更高，这点，在后续的 <code>性能对比</code> 章节会有明确的数据结论。</li>
</ol>
<p>总得来说，H2 扩展了 SQLite 的功能边界，在纯 Java 生态下提供了一个功能完备的嵌入式数据库。然而这一切是以更高的资源成本为代价的，并且在数据安全性上存在一定隐忧。如果您的应用对数据可靠和长时间稳定运行要求极高，选择 H2 需三思；但如果看重其灵活性（内存/文件/服务器模式）和易用性（Java 原生），H2 仍然是值得考虑的方案。</p>
<h3 data-id="heading-7">rqlite</h3>
<p>从名字中就可以知道，rqlite 是对 SQLite 的补充扩展，rqlite 可以简单理解为<code>基于 SQLite 的分布式数据库</code>：它在多台节点上复制 SQLite 的数据，[通过 Raft 共识算法保证各节点之间的数据一致性](<a href="https://link.juejin.cn?target=https%3A%2F%2Frqlite.io%2Fdocs%2Ffaq%2F%23%3A~%3Atext%3DOn" target="_blank" title="https://rqlite.io/docs/faq/#:~:text=On" ref="nofollow noopener noreferrer">rqlite.io/docs/faq/#:…</a> top of that%2C rqlite,that data at all times)</p>
<p>换句话说，rqlite 将原本单机的 SQLite 变身为一个支持高可用冗余的系统——只要集群中多数节点存活，你的应用仍然可以访问到最新的数据。这对需要轻量级分布式存储的场景来说非常有吸引力。</p>
<h4 data-id="heading-8">特点与适用场景</h4>
<ol>
<li><strong>易部署，低运维成本</strong>：rqlite 非常轻量，每个节点就是一个几MB大小的可执行程序，无需额外依赖。</li>
<li><strong>高可用与数据安全</strong>：rqlite 基于 Raft 协议保证强一致性，这意味着在任意时刻系统只会有一份一致的数据库状态。数据被完整地复制到多个节点上，单点故障不再致命。</li>
<li><strong>SQLite</strong> <strong>高度兼容</strong>：rqlite 虽然加了分布式外衣，但底层用的仍是 SQLite 引擎。它对外暴露 HTTP API 供应用写入查询，但你在API里执行的其实还是标准的 SQL 语句，[SQLite 支持的复杂查询、全文检索、JSON 函数等，在 rqlite 上同样适用](<a href="https://link.juejin.cn?target=https%3A%2F%2Frqlite.io%2Fdocs%2Ffeatures%2F%23%3A~%3Atext%3DCore" target="_blank" title="https://rqlite.io/docs/features/#:~:text=Core" ref="nofollow noopener noreferrer">rqlite.io/docs/featur…</a> functionality)</li>
</ol>
<h4 data-id="heading-9">鱼和熊掌不可兼得</h4>
<p>既要有要是不可取的，虽然 rqlite 补足了 SQLite 单点缺陷的难题，但是为此，它也不得不舍弃一些 SQLite 的优势。</p>
<ol>
<li><strong>性能开销</strong>：写入性能较慢是 rqlite 不可避免的弱点。由于每次写操作都要通过 Raft 在多个节点之间通信确认，rqlite 的单次事务延迟远高于本地 SQLite。官方明确指出，rqlite 是为高可用而非高性能设计的，[其写吞吐相对于单机 SQLite 会有明显下降](<a href="https://link.juejin.cn?target=https%3A%2F%2Frqlite.io%2Fdocs%2Ffaq%2F%23%3A~%3Atext%3DYes%252C" target="_blank" title="https://rqlite.io/docs/faq/#:~:text=Yes%2C" ref="nofollow noopener noreferrer">rqlite.io/docs/faq/#:…</a> but only for reads,write to the Raft log)，这点在 <code>性能对比</code> 章节会有明显体现。</li>
<li><strong>额外的部署开销</strong>：SQLite 之所以能成为数据库的中流砥柱，其核心竞争力之一就是嵌入式的单文件型数据库。然而，rqlite 就不得不启动一个 Server 对外暴露服务，使用时，感觉它就是一个传统的 MySQL 数据服务一样，rqlite 需要独立部署服务进程。</li>
<li><strong>Java支持弱</strong>：rqlite 目前对各语言的支持主要通过 HTTP Client 库，缺乏像 JDBC 那样成熟透明的驱动。虽然在 Java 中虽然有社区贡献的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frqlite%2Frqlite-jdbc" target="_blank" title="https://github.com/rqlite/rqlite-jdbc" ref="nofollow noopener noreferrer">rqlite-jdbc 驱动</a>，但是经过我的测试，几乎无法使用，有大量 JDBC 的接口都没有实现。</li>
<li><strong>处境尴尬</strong>：rqlite 为了支持 SQLite 的单点问题，基于 HTTP Server 的模式部署，使得使用它还需要单独部署它，这完全抛弃了 SQLite 拿来即用的最大优势。与其使用 rqlite，我为什么不使用 MySQL、Postgres 这样更成熟功能更多的数据库服务呢？所以它的使用场景非常局限。</li>
</ol>
<p>总结来说，rqlite 将 SQLite 带入了分布式时代，以极低的复杂度提供了令人惊喜的高可用特性。不过鱼与熊掌不可兼得，开发者在享受其简洁的同时，也要接受性能上的妥协和适用场景的限制。在对可靠性要求高于性能的边缘计算、物联网、轻量级服务中，rqlite 尚有用武之地；而在高并发、大数据的核心业务里，它就不是一个主力选手了。</p>
<h3 data-id="heading-10">DuckDB</h3>
<p>DuckDB 是近年来数据分析领域中迅速崛起的一款数据库系统，它的定位和架构非常独特，是专门为 分析工作负载（OLAP）设计的嵌入式数据库。</p>
<p>DuckDB 最大的特点在于它结合了两种对立系统的优势：SQLite 的简洁性 和 数据仓库的分析能力。它同样也实现了 <strong>嵌入式</strong>、<strong>零配置</strong>、<strong>单一文件</strong>的优势，而基于其 <code>列式存储</code> 的特定，它非常适合做数据分析统计相关的工作。官方还号称自己为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fduckdb.org%2Fmedia%2Fduckdb-the-SQLite-for-analytics%2F" target="_blank" title="https://duckdb.org/media/duckdb-the-SQLite-for-analytics/" ref="nofollow noopener noreferrer">The SQLite for Analytics</a></p>
<h4 data-id="heading-11">The SQLite for Analytics</h4>
<p>近年来，DuckDB 在数据科学圈迅速走红，Python、R、Julia 等工具链都集成了DuckDB，用它来取代笨重的 pandas 或Spark执行本地分析任务。下面让我们看看DuckDB在文件型数据库选型中有哪些独特价值。</p>
<ol>
<li><strong>列式存储，极速分析</strong>：DuckDB 最核心的卖点就是列存。它将同一列的数据紧凑地存储在一起，适合扫描和压缩，大幅提升了聚合计算的效率。当你对百万行数据执行 <code>GROUP BY</code>、<code>JOIN</code>、<code>AVG</code> 这类操作时，DuckDB 的列式引擎可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fbetterstack.com%2Fcommunity%2Fguides%2Fscaling-python%2Fduckdb-vs-SQLite%2F" target="_blank" title="https://betterstack.com/community/guides/scaling-python/duckdb-vs-SQLite/" ref="nofollow noopener noreferrer">比 SQLite 快出一个数量级以上</a>。DuckDB 还使用向量化执行（一种批量数据处理技术）充分利用 CPU 流水线，提高算子执行效率。这些设计让 DuckDB 在处理大批量数据分析时如鱼得水</li>
<li><strong>多核<strong><strong>并行</strong></strong>，<strong><strong>内存</strong></strong>友好</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmotherduck.com%2Flearn-more%2Fduckdb-vs-SQLite-databases%2F" target="_blank" title="https://motherduck.com/learn-more/duckdb-vs-SQLite-databases/" ref="nofollow noopener noreferrer">DuckDB 支持多线程并行查询执行，可以利用机器的多核优势加速处理</a>，另外，DuckDB 为了分析场景做了大量内存优化，会智能地[将中间结果缓存于内存以减少重复计算，并采取乐观并发控制机制避免不必要的锁竞争](<a href="https://link.juejin.cn?target=https%3A%2F%2Fduckdb.org%2Fdocs%2Fstable%2Fconnect%2Fconcurrency%23%3A~%3Atext%3DWhen" target="_blank" title="https://duckdb.org/docs/stable/connect/concurrency#:~:text=When" ref="nofollow noopener noreferrer">duckdb.org/docs/stable…</a> using option 1%2C DuckDB,the same connection are faster)</li>
<li><strong>即席分析</strong>：DuckDB 非常适合作为数据分析的嵌入式引擎融入应用中。它支持标准 SQL，包含窗口函数、复杂 JOIN、CTE 等高级功能，对数据科学家和分析师来说十分友好。同时，DuckDB 可以直接读取多种数据格式，例如 CSV、Parquet、Arrow 等，这意味着你可以用SQL直接查询这些文件，而不必先写脚本转换导入。这一点对于需要频繁从数据湖或日志文件中提取信息的应用来说价值巨大</li>
</ol>
<h4 data-id="heading-12">各有所长</h4>
<p>尽管DuckDB在特定领域表现亮眼，但我们也需认识到它并非万能，同SQLite相比有以下局限：</p>
<ol>
<li><strong>不擅长高并发****OLTP</strong>：DuckDB 的设计初衷不是替代 OLTP 数据库来处理海量并发事务。它更关注吞吐而非并发，对于大量小事务的场景支持有限。DuckDB 允许一个进程内开启多个并发写线程，但仍然不支持多个进程同时写入同一库文件（多进程只能并发只读）</li>
<li><strong>内存****占用与启动开销</strong>：相较 SQLite 极简的内存足迹，DuckDB 在加载大数据集进行分析时会占用显著更多的内存。这是列式数据库的典型特征：为了加速计算，DuckDB 常常需要将列数据或中间结果缓存在内存中。对于几百万行的数据表，运行一个复杂分析查询往往会瞬时占用几百MB的内存，这一点在嵌入式设备上需要慎重考虑。</li>
<li><strong>生态成熟度</strong>：DuckDB 毕竟是近几年才出现的新项目，在生态工具和社区积累方面无法与 SQLite 比肩。比如，SQLite 历经二十年验证，几乎没有重大漏洞且兼容性极佳，而 DuckDB 还在快速迭代中，可能存在隐藏的bug或行为改变。</li>
</ol>
<p>总的来说，DuckDB 为文件型数据库开辟了新的可能：<strong>在本地完成过去需要数据库集群才能完成的大规模分析计算</strong>。对于追求实时分析的平台来说，这简直是福音。然而，正如没有任何单一数据库能通吃所有场景一样，DuckDB 也有其短板。我们应根据具体需求，在性能和资源之间找到平衡。</p>
<h3 data-id="heading-13">性能对比</h3>
<p>说了这么多优缺点，实际表现到底如何呢？正好我针对 SQLite、H2、DuckDB、rqlite 四个数据库做了一系列基准测试，包括增删改查各类操作。下面我们就结合数据，看看它们在不同场景下的性能差距如何。先上结论：没有最强，只有最适合场景的。</p>
<h4 data-id="heading-14">INSERT 性能 (ms)</h4>








































<table><thead><tr><th>数据规模</th><th>SQLite</th><th>H2</th><th>DuckDB</th><th>rqlite</th></tr></thead><tbody><tr><td>100,000 (新增100K)</td><td>780</td><td>2,268</td><td>12,531</td><td>5,481</td></tr><tr><td>200,000 (新增100K)</td><td>5,921</td><td>3,114</td><td>7,953</td><td>8,566</td></tr><tr><td>500,000 (新增300K)</td><td>17,345</td><td>41,827</td><td>16,948</td><td>34,989</td></tr><tr><td>1,000,000 (新增500K)</td><td>28,294</td><td>95,202</td><td>31,618</td><td>超时</td></tr></tbody></table>
<ul>
<li>SQLite 在大规模插入时表现最稳定，插入时间随数据增长没有夸张暴涨，稳如老狗。</li>
<li>H2 初始插入很快，但随着数据量增长性能<strong>跳崖式下降</strong>，50 万行以后写入速度直线暴跌。看来多线程插入扛不住太大数据量，后劲不足。</li>
<li>DuckDB 插入性能中规中矩，相对稳定，没有明显瓶颈，也没有 SQLite 那么稳，总体还算不错。</li>
<li>rqlite 因 Raft 共识协议，写入需要分发给集群所有节点，大规模写入相当吃力，插到 100 万行时直接超时放弃治疗。</li>
</ul>
<h4 data-id="heading-15">SELECT 查询性能 (ms, 1000 次按 ID 查询)</h4>








































<table><thead><tr><th>数据规模</th><th>SQLite</th><th>H2</th><th>DuckDB</th><th>rqlite</th></tr></thead><tbody><tr><td>100,000</td><td>49</td><td>690</td><td>715</td><td>2,298</td></tr><tr><td>200,000</td><td>39</td><td>823</td><td>394</td><td>664</td></tr><tr><td>500,000</td><td>35</td><td>1,034</td><td>328</td><td>678</td></tr><tr><td>1,000,000</td><td>28</td><td>1,244</td><td>424</td><td>-</td></tr></tbody></table>
<ul>
<li>SQLite 点查询性能最优，100 万行数据下 1000 次查询仅耗时 28ms，几乎可以忽略不计，秒杀其他选手，堪称单点查询之王。</li>
<li>DuckDB 查询性能相当稳定，随着数据量增加变化不大，反而在 50 万行时最快。这可能得益于它优秀的查询优化和向量化执行。</li>
<li>H2 查询性能随着数据量增长明显下降，大数据量下查询变慢，估计是缓存命中率降低且 MVCC 开销显现。</li>
<li>rqlite 因为每次查询都经过 HTTP 网络开销，相对来说要慢不少，在 50 万行以上基本奔溃（100 万行我甚至没测出来）。</li>
</ul>
<h4 data-id="heading-16">UPDATE 性能 (ms, 1000 次更新操作)</h4>








































<table><thead><tr><th>数据规模</th><th>SQLite</th><th>H2</th><th>DuckDB</th><th>rqlite</th></tr></thead><tbody><tr><td>100,000</td><td>2,710</td><td>478</td><td>4,404</td><td>85</td></tr><tr><td>200,000</td><td>2,252</td><td>794</td><td>3,034</td><td>1,396</td></tr><tr><td>500,000</td><td>2,357</td><td>1,149</td><td>3,042</td><td>88</td></tr><tr><td>1,000,000</td><td>2,214</td><td>967</td><td>3,029</td><td>-</td></tr></tbody></table>
<ul>
<li>rqlite 在小批量更新上出乎意料地快，只用了 HTTP 接口提供的批处理优化，100k 行时 1000 次更新只要 85ms，堪称变态。这对需要远程批量更新的场景是个亮点。</li>
<li>H2 更新性能整体优秀且稳定，每增加数据，时间没有激增，始终保持在毫秒级，得益于其对事务和批量操作的良好支持。</li>
<li>SQLite 和 DuckDB 的更新性能相近，基本一个水平线。SQLite 胜在本地无网络，DuckDB 胜在批量执行优化，最后旗鼓相当。</li>
</ul>
<h4 data-id="heading-17">DateTime 范围查询性能 (ms)</h4>
<p>&gt; SQLite 本身是没有 DateTime 相关数据类型的，这里测试时，采用了普遍的基于 TEXT 类型存储 ISO-8601 格式的字符串实现</p>
<h5 data-id="heading-18">无索引 (1M 行数据)</h5>













































<table><thead><tr><th>查询范围</th><th>查询次数</th><th>SQLite</th><th>H2</th><th>DuckDB</th><th>rqlite (500K)</th></tr></thead><tbody><tr><td>1周</td><td>300</td><td>562</td><td>896</td><td>2,784</td><td>461</td></tr><tr><td>1月</td><td>200</td><td>1,514</td><td>1,935</td><td>7,218</td><td>1,489</td></tr><tr><td>6月</td><td>100</td><td>6,403</td><td>5,829</td><td>1,554</td><td>3,546</td></tr><tr><td>1年</td><td>50</td><td>9,012</td><td>3,706</td><td>1,013</td><td>3,944</td></tr></tbody></table>
<h5 data-id="heading-19">有索引 (1M 行数据)</h5>













































<table><thead><tr><th>查询范围</th><th>查询次数</th><th>SQLite</th><th>H2</th><th>DuckDB</th><th>rqlite (500K)</th></tr></thead><tbody><tr><td>1周</td><td>300</td><td>587</td><td>1,035</td><td>3,799</td><td>751</td></tr><tr><td>1月</td><td>200</td><td>1,837</td><td>1,309</td><td>7,749</td><td>1,056</td></tr><tr><td>6月</td><td>100</td><td>5,043</td><td>3,303</td><td>2,678</td><td>3,188</td></tr><tr><td>1年</td><td>50</td><td>6,446</td><td>4,804</td><td>1,938</td><td>4,472</td></tr></tbody></table>
<ul>
<li>不建索引情况下，查询范围越大，DuckDB 越显优势：大范围扫描 DuckDB 最快，比如查询一年范围 DuckDB 明显比其它快得多（列式存储一次扫描优势尽显）。</li>
<li>SQLite 在小范围查询（比如 1 周的数据）表现优秀，甚至优于 H2，说明少量数据的全表扫描对 SQLite 来说还能 Hold 住。</li>
<li>给 DateTime 列建索引后，大部分数据库范围查询速度都有提升，其中 rqlite 提升最明显（毕竟不用每次扫完 500K 行了）。不过 DuckDB 在有无索引下对大范围查询依然保持强劲，索引对它帮助有限，因为本来全表扫也不慢。</li>
<li>H2 和 SQLite 建索引后对中等范围查询有提升，但面对特别大的范围（半年/一年），DuckDB 依旧凭借列存和并行优势全面胜出。</li>
</ul>
<h4 data-id="heading-20">备份性能 (ms)</h4>



































<table><thead><tr><th>数据库</th><th>备份耗时</th><th>备份文件</th><th>验证结果</th></tr></thead><tbody><tr><td>SQLite</td><td>1,166</td><td>bench_backup.db</td><td>✔ OK (1,000,000 rows)</td></tr><tr><td>H2</td><td>19,195</td><td>h2_backup.zip</td><td>✔ OK (1,000,000 rows)</td></tr><tr><td>DuckDB</td><td>417</td><td>duckdb_backup/ (Parquet)</td><td>✔ OK (1,000,000 rows)</td></tr><tr><td>rqlite</td><td>-</td><td>rqlite_backup.db</td><td>未测试</td></tr></tbody></table>
<ul>
<li>DuckDB 备份最快，仅耗时 417ms！它备份时直接导出为压缩的列式格式（Parquet），效率非常高。在大数据备份上 DuckDB 完胜。</li>
<li>SQLite 备份性能也相当不错，1百万行数据备份文件不到 2 秒搞定，而且只是复制一份 .db 文件的功夫，简单粗暴但可靠。</li>
<li>H2 备份耗时最长，将近19秒，因为它默认备份会压缩成 zip 包，还原起来麻烦，而且备份期间性能较差。</li>
<li>rqlite 因为 100 万行时基准写入都没完成，这里没法测试备份，不过 rqlite 本身提供快照功能，速度估计也不会快哪去。</li>
</ul>
<h4 data-id="heading-21">内存使用情况</h4>








































<table><thead><tr><th>数据库</th><th>基线内存</th><th>最终内存</th><th>内存增量</th><th>Heap 增量</th></tr></thead><tbody><tr><td>SQLite</td><td>9.5 MB</td><td>11.6 MB</td><td>2.1 MB</td><td>221 KB</td></tr><tr><td>H2</td><td>18.4 MB</td><td>817.2 MB</td><td>798.9 MB</td><td>782.7 MB</td></tr><tr><td>DuckDB</td><td>34.3 MB</td><td>366.1 MB</td><td>331.7 MB</td><td>332.3 MB</td></tr><tr><td>rqlite</td><td>42.6 MB</td><td>~120 MB</td><td>~77 MB</td><td>~70 MB</td></tr></tbody></table>
<ul>
<li>SQLite 内存使用惊人地低！整个基准跑完才增加了2MB 内存，占用几乎可以忽略，真正的小而美。</li>
<li>H2 内存消耗最高，最终增量将近 800MB，Heap 上暴涨了 782MB，怀疑人生——大概它把数据几乎全放内存里了，对内存小的环境很不友好。</li>
<li>DuckDB 内存使用适中，增加了约 332MB。考虑到它是列式数据库，需要缓存列数据，能接受。不过相对 SQLite 还是肉厚了一些。</li>
<li>rqlite 客户端这边内存占用并不高（因为数据主要在服务端），最终增量大约 77MB，但这并不反映 rqlite 服务器端的内存开销。总之，如果关注本进程内存，rqlite 表现还行。</li>
</ul>
<h4 data-id="heading-22">综合评价</h4>
<p>综合来看，根据不同指标，各数据库各有千秋，下表给出了在不同需求下最推荐的选择：</p>


















































<table><thead><tr><th>指标</th><th>推荐数据库</th><th>理由</th></tr></thead><tbody><tr><td><strong>大规模写入</strong></td><td>SQLite</td><td>写入性能稳定，数据量增大也不掉速</td></tr><tr><td><strong>点查询</strong></td><td>SQLite</td><td>28ms/1000 次查询，单点查询速度最快</td></tr><tr><td><strong>批量更新</strong></td><td>rqlite / H2</td><td>HTTP 批处理加持 (rqlite) 或高效事务 (H2)</td></tr><tr><td><strong>大范围查询</strong></td><td>DuckDB</td><td>列式存储优势明显，全表扫描速度最快</td></tr><tr><td><strong>小范围查询</strong></td><td>SQLite</td><td>索引配合下性能优异，处理少量数据最快</td></tr><tr><td><strong>备份恢复</strong></td><td>DuckDB</td><td>417ms 完成备份，Parquet 压缩高效</td></tr><tr><td><strong>内存效率</strong></td><td>SQLite</td><td>内存占用仅增加 2MB，资源友好</td></tr><tr><td><strong>分布式高可用</strong></td><td>rqlite</td><td>基于 Raft 共识，多节点冗余，高可用保障</td></tr></tbody></table>
<h4 data-id="heading-23">测试代码</h4>
<p>上面的 Benchmark 测试，我还摘取了一部分核心代码片段，便于大家理解这些性能差异是怎么测出来的。例如下面是基准测试中插入操作的实现简要。可以看到，对于 SQLite，我们使用单线程批量插入，而针对 H2，我们则利用多线程并发插入（writerThreads() 返回的线程数决定了策略）。这段代码也从一个侧面解释了为何 H2 在小数据量插入上冲得快——毕竟用了多线程——但数据量大时反而失速：线程开多了反而拖累了性能和内存。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-type">int</span> <span class="hljs-variable">threads</span> <span class="hljs-operator">=</span> db.writerThreads();
<span class="hljs-type">long</span> <span class="hljs-variable">t0</span> <span class="hljs-operator">=</span> System.nanoTime();

<span class="hljs-keyword">if</span> (threads == <span class="hljs-number">1</span>) {
    <span class="hljs-comment">/* ---- 单线程批量写（SQLite）---- */</span>
    <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> db.open()) {
        c.setAutoCommit(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> c.prepareStatement(<span class="hljs-string">"INSERT INTO bench(name, age, salary, employ_date) VALUES (?,?,?,?)"</span>)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; need; i++) {
                ps.setString(<span class="hljs-number">1</span>, randomString(<span class="hljs-number">12</span>));
                ps.setInt(<span class="hljs-number">2</span>, RND.nextInt(<span class="hljs-number">43</span>) + <span class="hljs-number">18</span>);
                ps.setDouble(<span class="hljs-number">3</span>, RND.nextDouble() * <span class="hljs-number">200_000</span>);
                db.bindDate(ps, <span class="hljs-number">4</span>, randomEpoch());
                ps.addBatch();
                <span class="hljs-keyword">if</span> (i % BATCH_SIZE == <span class="hljs-number">0</span>) {
                    ps.executeBatch();
                }
            }
            ps.executeBatch();
        }
        c.commit();
    }
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">/* ---- 多线程批量写（H2）---- */</span>
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(threads);
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(need / BATCH_SIZE);
    List&lt;future&lt;?&gt;&amp;gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&amp;lt;&amp;gt;();

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &amp;lt; need; i += BATCH_SIZE) {
        futures.add(pool.submit(() -&amp;gt; {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> db.open()) {
                c.setAutoCommit(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">try</span> (<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> c.prepareStatement(<span class="hljs-string">"INSERT INTO bench(name, age, salary, employ_date) VALUES (?,?,?,?)"</span>)) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &amp;lt; BATCH_SIZE; j++) {
                        ps.setString(<span class="hljs-number">1</span>, randomString(<span class="hljs-number">12</span>));
                        ps.setInt(<span class="hljs-number">2</span>, RND.nextInt(<span class="hljs-number">43</span>) + <span class="hljs-number">18</span>);
                        ps.setDouble(<span class="hljs-number">3</span>, RND.nextDouble() * <span class="hljs-number">200_000</span>);
                        db.bindDate(ps, <span class="hljs-number">4</span>, randomEpoch());
                        ps.addBatch();
                    }
                    ps.executeBatch();
                }
                c.commit();
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                LOG.error(<span class="hljs-string">"insert task failed"</span>, e);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
            } <span class="hljs-keyword">finally</span> {
                latch.countDown();
            }
        }));
    }

    <span class="hljs-keyword">for</span> (Future&lt;!--?--&gt; f : futures) {
        <span class="hljs-keyword">try</span> {
            f.get();
        } <span class="hljs-keyword">catch</span> (ExecutionException ee) {
            <span class="hljs-keyword">throw</span> ee.getCause();
        }
    }
    latch.await();
    pool.shutdown();
}

<span class="hljs-type">long</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - t0);
System.out.printf(<span class="hljs-string">"insert %,d rows: %d ms%n"</span>, need, ms);
</code></pre>
<p>从以上代码可以看到，SQLite 采用单连接串行批量提交，而 H2 开了多个线程并发插入（每线程每批插入 BATCH_SIZE=1000 行）。这解释了为什么在 10万行这样的规模下，H2 插入能比 SQLite 快（多线程跑赢单线程），但到 50 万行、100 万行时，线程上下文切换和内存开销反而拖累了 H2，导致性能急转直下。</p>
<h3 data-id="heading-24">选型推荐</h3>
<p>聊了这么多，回到我们最开始的问题：在不同使用场景下，该选哪种文件型关系数据库？ 结合上面的优缺点分析和性能数据，我的选型建议如下：</p>
<ul>
<li><strong>如果你的场景偏向本地嵌入、移动端、单机应用</strong>：比如移动App、本地小工具、单机客户端程序，需要一个零配置、小巧可靠的数据库，<strong>SQLite 永远是首选</strong>。它部署最简单、稳定可靠，单用户使用时性能也非常好。典型例子：手机应用缓存、本地存储，IoT 设备的数据落地等等，用 SQLite 十拿九稳</li>
<li><strong>如果你在 Java 服务端开发中需要一个嵌入式数据库用于单元测试或临时存储</strong>：优先考虑 H2。它与Java高度兼容，内存模式省去清理麻烦，支持标准SQL特性更全面，拿来当开发测试用的内置库非常合适。不过要注意，<strong>别拿H2当生产库长期存重要数据</strong>——一来持久化可靠性稍差，二来内存消耗较高。如果是小型工具或者对数据丢失不敏感的场景，用 H2 问题不大</li>
<li><strong>如果你的需求是高可用、分布式部署</strong>：比如希望数据库有容灾能力，多机冗余不会单点故障，那只能选 rqlite。它基于Raft提供强一致复制，天生容错。但请谨记：<strong>rqlite 适合读多写少、对性能要求不高的场景</strong>。其实我个人感觉，rqlite尚不成熟，在 Java 相关的项目中，尽量不要使用</li>
<li><strong>如果你的主要任务是本地的大数据分析、OLAP 查询</strong>：毫无疑问，DuckDB 会是你的好伙伴。它简直就是为这种场景而生，在单机内存允许的范围内，可以替代庞大的数据仓库，直接对本地文件或内存数据做分析处理。举个例子，你要在应用里分析几百万行日志或做报表汇总，用DuckDB内嵌处理会比把数据塞进SQLite快出一个数量级。不过，同样的，DuckDB不适合拿来支撑高并发 OLTP 业务，<strong>它更像是分析引擎而非通用 OLTP 数据库</strong></li>
<li><strong>如果你的应用场景介于上述之间</strong>：或者仍拿不定主意，那<strong>一般优先 SQLite 作为基准方案</strong>。然后根据瓶颈再考虑替代：性能瓶颈在分析查询上就上 DuckDB，瓶颈在并发读写上可以考虑 H2（或者直接上更重型的数据库）。没有银弹，另外，大不了先用SQLite 快速验证业务，真撑不住了再迁移也不迟——反正 SQLite 转去其它数据库也不算太痛苦。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx相关]]></title>    <link>https://juejin.cn/post/7578793960626896922</link>    <guid>https://juejin.cn/post/7578793960626896922</guid>    <pubDate>2025-12-02T03:16:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578793960626896922" data-draft-id="7578780780026937353" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx相关"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T03:16:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dawn11"/> <meta itemprop="url" content="https://juejin.cn/user/4012584995709753"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx相关
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4012584995709753/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dawn11
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:16:46.000Z" title="Tue Dec 02 2025 03:16:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一 安装nginx</p>
<ol>
<li>rpm包安装</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo apt install nginx -y
</code></pre>
<ol start="2">
<li>验证</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start nginx 
sudo systemctl <span class="hljs-built_in">enable</span> nginx <span class="hljs-comment"># 设置开机自启</span>
sudo systemctl status nginx
</code></pre>
<p>二 配置反向代理</p>
<p>假设需要将<code>http://your_domain.com/api</code>反向代理到后端服务（如<code>http://localhost:3000</code>）</p>
<ol>
<li>创建Nginx配置文件</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/nginx/sites-available/your_proxy.conf
</code></pre>
<ol start="2">
<li>写入配置内容
nginx</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">server {
    listen 80;
    server_name your_domain.com;  <span class="hljs-comment"># 替换为你的域名或服务器IP</span>

    <span class="hljs-comment"># 反向代理配置</span>
    location /api/ {
        proxy_pass http://localhost:3000/;  <span class="hljs-comment"># 后端服务地址（结尾的/需保持一致）</span>
        proxy_set_header Host <span class="hljs-variable">$host</span>;
        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
        proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;
    }

    <span class="hljs-comment"># 可选：配置静态资源代理（如前端页面）</span>
    location / {
        root /var/www/html;  <span class="hljs-comment"># 前端文件目录</span>
        index index.html;
        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;  <span class="hljs-comment"># 支持SPA路由</span>
    }
}
</code></pre>
<ol start="3">
<li>启用配置文件</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">ln</span> -s /etc/nginx/sites-available/your_proxy.conf /etc/nginx/sites-enabled/
</code></pre>
<ol start="4">
<li>检查配置语法</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo nginx -t
</code></pre>
<ol start="5">
<li>重启Nginx</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl restart nginx
</code></pre>
<ol start="6">
<li>测试</li>
</ol>
<p>访问<code>http://your_domain.com/api</code>，Nginx 会将请求转发到<code>http://localhost:3000</code>，并返回后端服务的响应。</p>
<p>示例：</p>
<h2 data-id="heading-0">Nginx 反向代理视频流与 tcpdump 抓包</h2>
<h4 data-id="heading-1">步骤 1：选择公网视频流（示例：B 站公开视频流）</h4>
<p>以 B 站某公开视频流为例（实际可替换为任意公网视频流地址），假设公网视频流地址为<code>https://example.com/video/stream</code>。</p>
<h4 data-id="heading-2">步骤 2：配置 Nginx 反向代理</h4>
<h5 data-id="heading-3">（1）创建 Nginx 代理配置文件</h5>
<p>bash</p>
<pre><code class="hljs language-arduino" lang="arduino">sudo vim /etc/nginx/sites-available/video-proxy.conf
</code></pre>
<h5 data-id="heading-4">（2）写入反向代理配置</h5>
<p>nginx</p>
<pre><code class="hljs language-ini" lang="ini">server {
    listen 80<span class="hljs-comment">;</span>
    server_name 服务器IP<span class="hljs-comment">;</span>

    location / {
        proxy_pass https://example.com/video/stream<span class="hljs-comment">;  # 替换为公网视频流实际地址</span>
        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-5">（3）启用配置并重启 Nginx</h5>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">ln</span> -s /etc/nginx/sites-available/video-proxy.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
</code></pre>
<h4 data-id="heading-6">步骤 3：使用 tcpdump 抓包</h4>
<h5 data-id="heading-7">（1）执行抓包命令（替换<code>ens33</code>为实际网卡）</h5>
<p>bash</p>
<pre><code class="hljs language-css" lang="css">sudo tcpdump -<span class="hljs-selector-tag">i</span> ens33 -w video_stream<span class="hljs-selector-class">.pcap</span> tcp -nn -s <span class="hljs-number">0</span>
</code></pre>
<h5 data-id="heading-8">（2）触发视频流访问</h5>
<p>在 PC 播放器中输入<code>http://服务器IP</code>（通过 Nginx 代理访问视频流），播放一段时间后按<code>Ctrl+C</code>停止抓包。</p>
<h4 data-id="heading-9">步骤 4：提交文件</h4>
<ul>
<li>转换出的视频文件：<code>output.flv</code></li>
<li>抓包文件：<code>video_stream.pcap</code>将上述两个文件按考官要求提交即可。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[发布对象和对象逃逸]]></title>    <link>https://juejin.cn/post/7578803751609237554</link>    <guid>https://juejin.cn/post/7578803751609237554</guid>    <pubDate>2025-12-02T03:23:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578803751609237554" data-draft-id="7578781397117812782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="发布对象和对象逃逸"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-02T03:23:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="matthew"/> <meta itemprop="url" content="https://juejin.cn/user/1339617839427655"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            发布对象和对象逃逸
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1339617839427655/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    matthew
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:23:18.000Z" title="Tue Dec 02 2025 03:23:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基本概念</h2>
<p>要理解<strong>发布对象</strong>和<strong>对象逃逸</strong>，需要从对象的<strong>作用域</strong>、<strong>访问控制</strong>以及<strong>线程安全</strong>的角度展开，二者紧密关联但侧重点不同。</p>
<p><strong>对象发布</strong>：是 “让对象被外部访问” 的行为。</p>
<p><strong>对象逃逸</strong>：是 “对象超出预期作用域（尤其是未完全初始化时被访问）” 的问题。</p>
<h2 data-id="heading-1">一、发布对象（Publishing an Object）</h2>
<ul>
<li>
<p>定义：</p>
<ul>
<li>指将一个对象的引用暴露给当前作用域之外的代码，使得其他代码（如其他类、线程或模块）可以访问该对象。</li>
</ul>
</li>
<li>
<p>目的：</p>
<ul>
<li>允许其他代码共享和使用该对象。</li>
</ul>
</li>
<li>
<p>常见场景：</p>
<ul>
<li>公共静态字段：通过public static修饰的字段持有的对象会被发布。<code>public class Holder {public static Object obj = new Object(); // obj被发布}</code></li>
<li>方法返回值：通过方法返回对象引用，可能被外部代码持有。</li>
<li>注册监听器/回调：将对象传递给事件监听器或回调函数，可能导致隐式发布。</li>
<li>非私有方法传递引用：通过非private方法将内部对象传递给外部调用者。</li>
</ul>
</li>
<li>
<p>注意事项：</p>
<ul>
<li>发布对象时需要小心，以避免潜在的线程安全问题和数据不一致性。</li>
<li>确保在发布对象之前，所有必要的初始化和设置都已完成。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">二、对象逃逸（Escape）</h2>
<ul>
<li>
<p>定义：</p>
<ul>
<li>指对象在其构造完成之前被其他代码访问或持有，导致未完全初始化的对象被使用。</li>
</ul>
</li>
<li>
<p>分类：</p>
<ul>
<li>显式逃逸：通过赋值或返回值直接暴露引用。</li>
<li>隐式逃逸：通过this引用在构造函数中传递（如注册事件监听器）。</li>
</ul>
</li>
<li>
<p>后果：</p>
<ul>
<li>可能导致数据不一致性、空指针异常或其他未定义行为。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">三、安全发布对象的四种方法</h2>
<p>一、静态初始化器发布（JVM 隐式同步）</p>
<p>原理： JVM 在类加载阶段会通过隐式锁保证静态变量的线程安全初始化，符合 JLS 的 happens-before 规则。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>(); <span class="hljs-comment">// 线程安全初始化</span>

    <span class="hljs-comment">// 在静态初始化函数中，初始化一个对象的引用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> instance; <span class="hljs-comment">// 安全发布</span>
    }
}
</code></pre>
<p>优势：</p>
<ul>
<li>零成本同步（JVM 底层优化）</li>
<li>适用于初始化简单的场景</li>
</ul>
<p>局限性：</p>
<ul>
<li>无法实现懒加载</li>
<li>初始化期间不能处理受检异常</li>
</ul>
<p>二、volatile 关键字发布（内存可见性保证） 工作机制： 写 volatile 变量会触发 StoreStore 内存屏障，读 volatile 变量会触发 LoadLoad 屏障，确保写操作对后续读操作可见。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VolatilePublisher</span> {
    <span class="hljs-comment">// 将对象的引用保存到volatile类型域或者AtomicReference对象中</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Resource resource;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span>()</span> {
        resource = <span class="hljs-keyword">new</span> Resource(); <span class="hljs-comment">// 安全发布点</span>
    }
}
</code></pre>
<p>典型应用场景：</p>
<ul>
<li>双重检查锁定模式（Double-Checked Locking）</li>
<li>状态标志位更新</li>
</ul>
<p>注意事项：</p>
<ul>
<li>仅保证引用可见性，不保证对象内部状态线程安全</li>
<li>写入操作需要是原子性的</li>
</ul>
<p>三、final 字段发布（JMM 特殊规则） JMM 规范： 通过 final 字段发布的对象，构造函数完成时所有 final 字段的写入对其他线程可见（Java 5+ 增强语义）。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalFieldPublisher</span> {
    <span class="hljs-comment">// 将对象的引用保存到某个正确构造对象的final类型域中</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ImmutableObject safeObject;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FinalFieldPublisher</span><span class="hljs-params">()</span> </span>{
        safeObject = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ImmutableObject</span>(); <span class="hljs-comment">// 安全发布</span>
    }
}
</code></pre>
<p>关键特性： 构造函数逃逸仍能保证线程安全 与引用不可变性配合使用效果最佳</p>
<p>设计建议： 优先用于不可变对象发布 避免在构造函数中泄漏 this 引用</p>
<p>四、显式同步发布（锁机制保证） 实现模式： 通过 synchronized 或 Lock 控制发布路径，建立 happens-before 关系。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncPublisher</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Resource</span> resource;
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Object</span> lock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 将对象的引用保存到一个有锁保护的域中</span>
        <span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) {
            resource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Resource</span>(); <span class="hljs-comment">// 安全发布</span>
        }
    }
}
</code></pre>
<p>扩展方案： ConcurrentHashMap 等并发容器的安全发布 FutureTask 的线程安全结果发布</p>
<p>性能权衡： 适合高频更新的可变对象 需注意锁粒度和竞争问题</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小白服务器踩坑]]></title>    <link>https://juejin.cn/post/7578762210287403071</link>    <guid>https://juejin.cn/post/7578762210287403071</guid>    <pubDate>2025-12-02T03:22:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578762210287403071" data-draft-id="7578830345869623337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小白服务器踩坑"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T03:22:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Ankkaya"/> <meta itemprop="url" content="https://juejin.cn/user/413072100168269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小白服务器踩坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413072100168269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Ankkaya
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:22:39.000Z" title="Tue Dec 02 2025 03:22:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一系列服务端踩坑笔记，记录笔者从零开始服务端学习之旅</p>
<h2 data-id="heading-0">服务器</h2>
<p>既然是服务器踩坑，拥有一个服务器是必要条件，这里介绍一个低成本的尝试</p>
<h3 data-id="heading-1">购买</h3>
<p>腾讯云每天都有 4 核 4G 轻量级服务器的特价活动，38 元/年，相比原价动辄五六百的价格，很香。每天两次抢购机会，抢中的概率还是挺大的</p>
<h3 data-id="heading-2">系统安装</h3>
<p>服务器其实就是一个云端电脑，它也需要操作系统，我这里选择基于 linux 内核发行的 debian，选择 Cen'tOS，Ubuntu 对服务器部署差别也不会很大，根据个人喜好</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65c8eeace3fc44989e14d95bd00db462~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=g8JRbh8YqlNcPDkpNFzrVGXevxg%3D" alt="" loading="lazy"/></p>
<p>既然是系统，当然要设置登录密码，不过后续登录基本不会用到图形界面，使用 ssh 终端登录服务器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fed4e81051f46f2ac943eac994381f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=R3YBWAwqB1YslcH4KkSDLzsOujc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">ssh 终端</h2>
<p>使用服务器的服务，需要用到不同端口，例如 web http 服务是 80 端口，linux ssh 登录是 22 端口，如果要本地 ssh 登录远端服务器，还要开启服务器的 22 端口，一般服务器已经默认开启，在服务器页面-防火墙标签页可以看到端口开放情况</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d68eda31518e4848a352947c86ee5712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=At344ChiOauclJ1lLLoexAk%2F17M%3D" alt="" loading="lazy"/></p>
<p>笔者用的终端是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.hostbuf.com%2F" target="_blank" title="https://www.hostbuf.com/" ref="nofollow noopener noreferrer">FinalShell</a>，服务器登录成功如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea190ba9857d4c2e9dd22a19cfd1fd2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=HvVygZrJrJLoXXiLoBsBfEH8zPI%3D" alt="" loading="lazy"/></p>
<p>我现在本地有一个前端项目，需要部署到服务器，方便浏览器中查看，应该怎么做呢，这里要提到 nginx</p>
<h2 data-id="heading-4">nginx</h2>
<p>nginx 很强大，这里不深入探讨，目前我们只需要用到一点功能，请求转发，它可以监听服务器入口流量，根据 ip，端口，域名，将请求执行不同的服务，当然不用 nginx，我们也可以把前端项目放在服务器，在浏览器也可以访问到，这里就不做介绍</p>
<h3 data-id="heading-5">基本配置</h3>
<p>在 Debian 中安装应用非常方便，使用命令即可安装</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新软件源</span>
apt update

<span class="hljs-comment"># 安装 nginx</span>
apt install nginx
</code></pre>
<p>安装成功，查看 nginx 运行状态，active 表示正在运行</p>
<pre><code class="hljs language-bash" lang="bash">systemctl status nginx
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f5f7af2f3b4176bcaa18840b62ec84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=X9WQ5x6g8ZjIpqCwe%2FuFBKEiQlA%3D" alt="" loading="lazy"/></p>
<p>nginx 的目录一般在<code>/etc/nginx</code>下，我们可以在<code>/etc/nginx/conf.d</code>下创建自己的配置文件，名称自定义方便区分即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/889be46595d9473a94c68a69844ef73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=wJc9TqehB1COFwJOsu7sqcs3aEs%3D" alt="" loading="lazy"/></p>
<p>双击打开，设置规则</p>
<ul>
<li>listen 80：拦截 web http 访问</li>
<li>server_name：服务器 ip 地址</li>
<li>root：/var/www/utils-web 项目文件根目录</li>
<li>index index.html index.htm 默认首页文件</li>
</ul>
<p>其他照抄即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fff7f1ae5bc14814a3a10844d87aa43d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=HfevhGiKNGyVu%2By0hrWiADUhOAg%3D" alt="" loading="lazy"/></p>
<p>对应 web 项目</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82ee60d7d72444598e0586b3071e48b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=RlF6zCMFgjg4%2F9D%2FdGGoRt%2FFVNk%3D" alt="" loading="lazy"/></p>
<p>设置完成，检查配置，重启 nginx 服务</p>
<pre><code class="hljs language-bash" lang="bash">// nginx 验证配置正确性
nginx -t

// 重启服务
systemctl restart nginx
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a1b361b7d14443db4f1015b71fcc301~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=c6QgaTTDhlpATw0UCIGpflBRK54%3D" alt="" loading="lazy"/></p>
<p>一般到这步结束，在浏览输入服务器 ip，回车应该可以看到网站，如果访问异常，可以尝试以下几点排错</p>
<h2 data-id="heading-6">排错</h2>
<h3 data-id="heading-7">端口</h3>
<p>nginx 监听的是 80 端口，如果端口被其他服务占用，<code>nginx -t</code>配置验证就不通过。那么我们可以看一下腾讯云服务器里防火墙规则，80 端口是否放行，如果系统安装了防火墙，也要看防火墙端口规则</p>
<p>我这里安装了 ufw，查看配置规则</p>
<pre><code class="hljs language-bash" lang="bash">ufw status
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1781b576fc5e4ee68ceca1db7580e3ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=sPFgXujWXKup42slnfQ2m6CPUk4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">文件权限</h3>
<p>因为对文件权限的不了解，我就遇到了<code>/var/www/utils-web</code>不属于 root，导致页面一直无法访问，关于文件（夹）所属用户和用户组，可以从 finalshell 底部文件浏览器直观看到</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31dec49326da43daaeab7a575a0f7345~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=8ia9Ax%2Bd0RrpVKvItEtMsrF5Y7U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">https</h2>
<p>当我们在浏览地址栏输入 ip 访问网页时候，有些浏览可能会提示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ca36a803974667b026fef57d94d722~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=oLuRkgeAPMyleiNA%2F8O9e1rCzEM%3D" alt="" loading="lazy"/></p>
<p>这就不得不提到 https，默认我们的请求都是 http 的，https 比 http 安全系数更高，配置有些后台服务，明确要求要使用 https（例如微信小程序），配置 https 还是很有必要的，这里我们申请腾讯云免费的 ssl 证书</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c09d5e464b184ad3a05cfbfa7ba26116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=0DpXzyOPzNKLeTg8thU7FNJDntg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">域名和备案</h2>
<p>但是这里有个问题，免费证书需要提供域名，我们还要去申请域名。阿里云和腾讯云都提供有域名服务，根据喜好选择即可。可以选择冷门后缀的域名，价格优惠不少</p>
<blockquote>
<p>😱😱 如果是国内的网站，部署上线还要完成备案，备案跟域名也有关系，域名的备案跟服务器是绑定的，就是说域名在哪里备案，服务器也要在哪里购买，虽然说可以转移备案，毕竟麻烦不少，所以备案域名时需要注意，这跟域名在哪里买没关系</p>
</blockquote>
<p>域名购买完后，就可以着手开始备案，我在阿里云买的域名，但是服务器在腾讯云，因此就在腾讯云备案，一般备案需要半个多月，中间腾讯客服人员会打电话询问一些网站情况，注意接听电话</p>
<h2 data-id="heading-11">ssl证书</h2>
<p>提交免费 ssl 申请，很快就能获取免费的 ssl 证书，下载 nginx 证书配置文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c7544190454da7adc0cb572ac4be40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=OwGzIA8QofIgyXdYxqh6IBmgsMk%3D" alt="" loading="lazy"/></p>
<p>修改 <code>/var/nginx/conf.d/ankkaya.conf</code>的配置，把前面下载的 ssl 压缩包中的 .crt 和 .key 文件放到<code>/etc/nginx/ssl</code>目录下，如果没有这个目录，新建该目录，重启服务</p>
<p>配置中有新用到的 443 端口，服务器和系统内（如果有防火墙）也要添加 443 的规则</p>
<pre><code class="hljs language-bash" lang="bash">server { 
	listen 80;
	server_name ankkaya.top; <span class="hljs-comment"># 你的服务器IP地址或域名</span>
    <span class="hljs-built_in">return</span> 301 https://$server_name<span class="hljs-variable">$request_uri</span>; <span class="hljs-comment"># 重定向到 https</span>
    location / { 
    root /var/www/utils-web; <span class="hljs-comment"># 项目文件的根目录 </span>
    index index.html index.htm; <span class="hljs-comment"># 默认首页文件 </span>
        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ =404; <span class="hljs-comment"># 尝试按顺序查找文件或目录，不存在则返回404</span>
    }
}

server {
    listen 443 ssl; <span class="hljs-comment"># https 端口</span>
    server_name ankkaya.top www.ankkaya.top;

    ssl_certificate /etc/nginx/ssl/ankkaya.top_nginx/ankkaya.top_bundle.crt;
    ssl_certificate_key /etc/nginx/ssl/ankkaya.top_nginx/ankkaya.top.key;

    <span class="hljs-comment"># 其他配置项，如根目录、代理等</span>
    location / {
        root /var/www/utils-web;
        index index.html index.htm;
    }
}
</code></pre>
<p>这时在浏览器输入 ip 已经无法访问网页，因为在 nginx 配置中，server_name 都配为了域名和子域名，但是输入域名也无法访问，这就要说到 DNS 解析，服务器只认 ip 地址，如果是域名，需要配置 DNS 解析，告诉浏览器去哪里获取资源</p>
<blockquote>
<p>😱😱 域名在哪里购买，DNS 解析也要在对应平台配置，我的域名在阿里云买的，就要到阿里云配置 DNS</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b5d8f50a19047a78a2288ff87e75dbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5ra2F5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250558&amp;x-signature=saWn9BOfBeDexkKDp4toHgfDmfs%3D" alt="" loading="lazy"/></p>
<p>在浏览器输入域名地址<code>ankkaya.top</code>，就可以打开网站了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再瞎学大模型了，这份GitHub神级课程火爆全网]]></title>    <link>https://juejin.cn/post/7578767608631083008</link>    <guid>https://juejin.cn/post/7578767608631083008</guid>    <pubDate>2025-12-02T03:34:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578767608631083008" data-draft-id="7578780780027117577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再瞎学大模型了，这份GitHub神级课程火爆全网"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-02T03:34:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再瞎学大模型了，这份GitHub神级课程火爆全网
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:34:19.000Z" title="Tue Dec 02 2025 03:34:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<h2 data-id="heading-0">项目速览</h2>
<p>最近在 GitHub 上发现了一个超级硬核的大语言模型（LLM）课程，它提供了一套完整的学习路线图和可以直接上手的 Colab 笔记，目标就是带你从入门到精通，无论是想深入研究模型，还是想开发应用，都能找到清晰的路径。</p>
<p>这个项目真心不错，结构化得特别好，把复杂的 LLM 领域拆解成了三个清晰的部分，对想系统学习的同学来说，简直是福音。</p>
<h2 data-id="heading-1">快速上手</h2>
<p>想体验这门课程？非常简单，不需要复杂的环境配置，一个浏览器就够了。</p>
<ol>
<li><strong>访问项目</strong>：打开 GitHub 项目主页，先点个 Star 收藏一下。</li>
<li><strong>选择路径</strong>：根据你的兴趣，选择<code>The LLM Scientist</code>（聚焦于构建和优化模型）或<code>The LLM Engineer</code>（聚焦于构建和部署应用）的学习路线。</li>
<li><strong>打开 Notebook</strong>：在项目里找到你感兴趣的 Notebook，比如“Fine-tune Llama 3.1 with Unsloth”，点击旁边的 "Open in Colab" 按钮，直接在浏览器里跟着代码跑起来。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d59974b2771411cb8a1135a4d4b1fbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251259&amp;x-signature=fvGCwdddlZ1dHbOxTWCY%2Fhq4cXM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">功能演示</h2>
<p>这个课程最大的亮点就是它的体系化和实践性。它把学习路径分成了三个阶段，每个阶段都有清晰的路线图。</p>
<h4 data-id="heading-3">1. LLM 科学家路线</h4>
<p>如果你对模型本身更感兴趣，想知道如何训练、微调、评估一个最好的 LLM，这条路线就是为你准备的。</p>
<p>它涵盖了从 Transformer 架构、预训练、监督微调（SFT）、偏好对齐（DPO/RLHF）到模型评估和量化的所有核心环节。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53c178d81c2a4f78a2bd8125fed6eab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251259&amp;x-signature=MVoqNwORc%2BCAaPBzx2tI1psaBL8%3D" alt="" loading="lazy"/></p>
<p>LLM Scientist Roadmap</p>
<h4 data-id="heading-4">2. LLM 工程师路线</h4>
<p>如果你更关注如何用 LLM 来解决实际问题，构建应用，那么工程师路线会更适合你。</p>
<p>这条路径聚焦于如何运行和部署 LLM、构建 RAG（检索增强生成）系统、使用 Agents、优化推理性能，以及如何保障 LLM 应用的安全。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdc9d2e478bf46df9ee4869d403c05f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251259&amp;x-signature=j%2BMJF2Z52qeoaqj9dQvhk2hNr68%3D" alt="" loading="lazy"/></p>
<p>LLM Engineer Roadmap</p>
<h4 data-id="heading-5">3. 大量即用型代码示例</h4>
<p>这门课程最实在的地方在于提供了海量的 Colab Notebooks。这些不是干巴巴的理论，而是可以直接运行的代码。</p>
<p>比如，你想学习如何微调最新的 Llama 3.1 模型？这里有现成的 Notebook：</p>
<ul>
<li><code>Fine-tune Llama 3.1 with Unsloth</code>：教你如何在免费的 Colab 环境中高效地进行监督微调。</li>
</ul>
<p>想了解如何量化模型，让它能在消费级硬件上跑起来？</p>
<ul>
<li><code>Quantization with GGUF and llama.cpp</code>：手把手教你用 llama.cpp 量化模型。</li>
</ul>
<p>这些 Notebook 把学习门槛降到了最低，让你可以快速上手实践，获得正反馈。</p>
<h2 data-id="heading-6">项目技术栈</h2>
<p>这个项目本身是一个课程，不涉及特定的后端技术栈，但它所教授和使用的技术，基本涵盖了当前 LLM 领域的主流框架和工具。</p>
<p>在“科学家”路径中，你会接触到 <strong>PyTorch</strong>、<strong>Hugging Face Transformers</strong>、<strong>TRL</strong>、<strong>Unsloth</strong> 和 <strong>Axolotl</strong> 等用于模型训练和微调的核心库。课程会带你深入理解 LoRA、QLoRA 等参数高效微调技术，以及 DPO 这样的偏好对齐算法。</p>
<p>在“工程师”路径中，则侧重于应用层技术，比如使用 <strong>LangChain</strong> 和 <strong>LlamaIndex</strong> 构建 RAG 应用，利用 <strong>FAISS</strong> 或 <strong>Chroma</strong> 搭建向量数据库，以及使用 <strong>Gradio</strong> 或 <strong>Streamlit</strong> 快速部署应用原型。可以说，这是一个非常全面的技术图谱。</p>
<p>总而言之，这个项目就像一份精心绘制的藏宝图，无论你是 AI 新手还是有经验的开发者，都能从中找到自己的学习路径和宝贵资源。</p>
<p>GitHub 项目地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmlabonne%2Fllm-course" target="_blank" title="https://github.com/mlabonne/llm-course" ref="nofollow noopener noreferrer">github.com/mlabonne/ll…</a></p>
<h2 data-id="heading-7">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Uni-App 鸿蒙应用微信相关功能上架踩坑：自制微信安装检测插件]]></title>    <link>https://juejin.cn/post/7578762210287321151</link>    <guid>https://juejin.cn/post/7578762210287321151</guid>    <pubDate>2025-12-02T03:07:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578762210287321151" data-draft-id="7578760341280866345" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Uni-App 鸿蒙应用微信相关功能上架踩坑：自制微信安装检测插件"/> <meta itemprop="keywords" content="HarmonyOS,uni-app"/> <meta itemprop="datePublished" content="2025-12-02T03:07:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MrTan"/> <meta itemprop="url" content="https://juejin.cn/user/3945466563398445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Uni-App 鸿蒙应用微信相关功能上架踩坑：自制微信安装检测插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3945466563398445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MrTan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:07:20.000Z" title="Tue Dec 02 2025 03:07:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景：上架失败的痛点</h2>
<p>做 Uni-App 跨端开发时，鸿蒙应用上架遇到了一个棘手问题：应用集成了微信登录、支付、分享等核心功能，但上架平台的测试机未安装微信，导致这些功能触发时直接崩溃，最终上架失败。</p>
<p>翻遍了 Uni-App 官方文档、鸿蒙开发者社区，甚至各类技术论坛，都没找到现成的「鸿蒙平台检测微信是否安装」的解决方案 —— 毕竟 Uni-App 对鸿蒙的适配还在持续完善中，很多原生能力的跨端封装还未覆盖到。</p>
<p>无奈之下，只能自己摸索鸿蒙原生能力与 Uni-App 的桥接方式，最终实现了一个轻量的检测插件，完美解决了上架问题。今天把这个过程分享出来，希望能帮到有同样需求的开发者～</p>
<h2 data-id="heading-1">核心思路</h2>
<p>Uni-App 调用鸿蒙原生能力，本质是通过「Uni-App 插件 + 鸿蒙原生代码」的方式实现桥接：</p>
<ol>
<li>鸿蒙原生层：通过鸿蒙的包管理能力，查询设备是否安装了微信（微信包名：<code>com.tencent.mm</code>）</li>
<li>插件层：将原生查询结果封装成 Uni-App 可调用的 API</li>
<li>应用层：在调用微信登录 / 支付 / 分享前，先通过插件检测是否安装微信，避免崩溃</li>
</ol>
<h2 data-id="heading-2">插件实现步骤（附完整代码）</h2>
<h3 data-id="heading-3">一、创建 Uni-App 插件结构</h3>
<p>首先通过 HBuilder X 在 Uni-App 项目中右键 uni_modules，新建 UTS插件-API插件，标准结构如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dfdc9729f494791b36c96c05e401976~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJUYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250048&amp;x-signature=oKngD6pvd9RDSud4CFO%2Brqqk9MM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">二、编写鸿蒙原生检测逻辑</h3>
<h4 data-id="heading-5">1. 路径 uni_modules=&gt;hl-appcheckplugin=&gt;utssdk=&gt;interface.uts</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 内部结果类型（避免对象字面量作为类型）
 */</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">CheckResult</span> {
  <span class="hljs-attr">isInstalled</span>: boolean;
  <span class="hljs-attr">errMsg</span>: string;
}

<span class="hljs-comment">/**
 * 检查微信安装状态的入参配置
 */</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">CheckWeChatInstalledOptions</span> {
  <span class="hljs-comment">/** 检查成功回调（仅当已安装时触发） */</span>
  success?: <span class="hljs-function">(<span class="hljs-params">result: CheckWeChatInstalledSuccess</span>) =&gt;</span> <span class="hljs-keyword">void</span>;
  <span class="hljs-comment">/** 检查失败回调（未安装或检查出错时触发） */</span>
  fail?: <span class="hljs-function">(<span class="hljs-params">result: CheckWeChatInstalledFail</span>) =&gt;</span> <span class="hljs-keyword">void</span>;
  <span class="hljs-comment">/** 检查完成回调（无论成败） */</span>
  complete?: <span class="hljs-function">(<span class="hljs-params">result: CheckWeChatInstalledComplete</span>) =&gt;</span> <span class="hljs-keyword">void</span>;
}

<span class="hljs-comment">/**
 * 成功回调结果类型
 */</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">CheckWeChatInstalledSuccess</span> {
  <span class="hljs-attr">isInstalled</span>: <span class="hljs-literal">true</span>;
  <span class="hljs-attr">errMsg</span>: <span class="hljs-string">"ok"</span>; <span class="hljs-comment">// 严格字面量类型，避免 string 不匹配</span>
}

<span class="hljs-comment">/**
 * 失败回调结果类型
 */</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">CheckWeChatInstalledFail</span> {
  <span class="hljs-attr">isInstalled</span>: <span class="hljs-literal">false</span>;
  <span class="hljs-attr">errMsg</span>: string; <span class="hljs-comment">// 错误信息描述</span>
}

<span class="hljs-comment">/**
 * 完成回调结果类型
 */</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">CheckWeChatInstalledComplete</span> {
  <span class="hljs-attr">isInstalled</span>: boolean;
  <span class="hljs-attr">errMsg</span>: string;
}
</code></pre>
<h4 data-id="heading-6">2. 路径 uni_modules=&gt;hl-appcheckplugin=&gt;utssdk=&gt;app-harmony=&gt;index.uts</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> {
	<span class="hljs-title class_">CheckWeChatInstalledOptions</span>,
	<span class="hljs-title class_">CheckWeChatInstalledSuccess</span>,
	<span class="hljs-title class_">CheckWeChatInstalledFail</span>,
	<span class="hljs-title class_">CheckWeChatInstalledComplete</span>,
	<span class="hljs-title class_">CheckResult</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../interface.uts'</span>

<span class="hljs-comment">// 重新导出类型，供外部使用</span>
<span class="hljs-keyword">export</span> type {
	<span class="hljs-title class_">CheckWeChatInstalledOptions</span>,
	<span class="hljs-title class_">CheckWeChatInstalledSuccess</span>,
	<span class="hljs-title class_">CheckWeChatInstalledFail</span>,
	<span class="hljs-title class_">CheckWeChatInstalledComplete</span>,
	<span class="hljs-title class_">CheckResult</span>
}

<span class="hljs-keyword">import</span> { bundleManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> hilog <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.hilog'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;

<span class="hljs-comment">/**
 * 常量定义（使用大写+下划线命名规范）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WECHAT_BUNDLE_NAME</span> = <span class="hljs-string">'com.tencent.mm'</span>; <span class="hljs-comment">// 微信官方包名（Android/鸿蒙通用）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOG_TAG</span> = <span class="hljs-string">'HL_APPCHECK'</span>; <span class="hljs-comment">// 日志标签常量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOG_DOMAIN</span> = <span class="hljs-number">0x0000</span>; <span class="hljs-comment">// 日志域常量</span>

<span class="hljs-comment">/**
 * 检查设备是否安装微信（优化版）
 * <span class="hljs-doctag">@param</span> options 配置参数（包含成功、失败、完成回调）
 * <span class="hljs-doctag">@returns</span> Promise&lt;CheckResult&gt; 异步返回检查结果（支持 Promise 链式调用）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkWeChatInstalled</span>(<span class="hljs-params">
	options : CheckWeChatInstalledOptions = {} <span class="hljs-comment">// 给参数设置默认值，避免 undefined 报错</span>
</span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">CheckResult</span>&gt; {
	<span class="hljs-comment">// 初始化默认结果</span>
	<span class="hljs-keyword">let</span> result : <span class="hljs-title class_">CheckResult</span> = {
		<span class="hljs-attr">isInstalled</span>: <span class="hljs-literal">false</span>,
		<span class="hljs-attr">errMsg</span>: <span class="hljs-string">'检查中...'</span>
	};

	<span class="hljs-keyword">try</span> {
		<span class="hljs-comment">// 检查微信是否安装</span>
		<span class="hljs-keyword">const</span> isInstalled = <span class="hljs-keyword">await</span> <span class="hljs-title function_">isAppInstalled</span>(<span class="hljs-variable constant_">WECHAT_BUNDLE_NAME</span>);

		<span class="hljs-keyword">if</span> (isInstalled) {
			<span class="hljs-comment">// 微信已安装 - 构造成功结果</span>
			result = {
				<span class="hljs-attr">isInstalled</span>: <span class="hljs-literal">true</span>,
				<span class="hljs-attr">errMsg</span>: <span class="hljs-string">'ok'</span>
			};
			<span class="hljs-comment">// 调用成功回调（类型安全转换）</span>
			options.<span class="hljs-property">success</span>?.(result <span class="hljs-keyword">as</span> <span class="hljs-title class_">CheckWeChatInstalledSuccess</span>);
			hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">LOG_DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">'微信已安装'</span>);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-comment">// 微信未安装 - 构造失败结果</span>
			result = {
				<span class="hljs-attr">isInstalled</span>: <span class="hljs-literal">false</span>,
				<span class="hljs-attr">errMsg</span>: <span class="hljs-string">'微信未安装'</span>
			};
			<span class="hljs-comment">// 调用失败回调（类型安全转换）</span>
			options.<span class="hljs-property">fail</span>?.(result <span class="hljs-keyword">as</span> <span class="hljs-title class_">CheckWeChatInstalledFail</span>);
			hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">LOG_DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">'微信未安装'</span>);
		}

	} <span class="hljs-keyword">catch</span> (err) {
		<span class="hljs-comment">// 异常处理</span>
		<span class="hljs-keyword">const</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span> | <span class="hljs-title class_">Error</span>;
		<span class="hljs-keyword">const</span> errorCode = <span class="hljs-string">'code'</span> <span class="hljs-keyword">in</span> error ? error.<span class="hljs-property">code</span> : <span class="hljs-string">'unknown'</span>;
		<span class="hljs-keyword">const</span> errorMsg = error.<span class="hljs-property">message</span> || <span class="hljs-string">`检查失败（错误码：<span class="hljs-subst">${errorCode}</span>）`</span>;

		<span class="hljs-comment">// 构造错误结果</span>
		result = {
			<span class="hljs-attr">isInstalled</span>: <span class="hljs-literal">false</span>,
			<span class="hljs-attr">errMsg</span>: errorMsg
		};

		<span class="hljs-comment">// 调用失败回调</span>
		options.<span class="hljs-property">fail</span>?.(result <span class="hljs-keyword">as</span> <span class="hljs-title class_">CheckWeChatInstalledFail</span>);
		<span class="hljs-comment">// 错误日志增强</span>
		hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">LOG_DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">`检查微信安装状态失败：<span class="hljs-subst">${errorMsg}</span>，错误码：<span class="hljs-subst">${errorCode}</span>`</span>);

	} <span class="hljs-keyword">finally</span> {
		<span class="hljs-comment">// 调用完成回调</span>
		options.<span class="hljs-property">complete</span>?.(result <span class="hljs-keyword">as</span> <span class="hljs-title class_">CheckWeChatInstalledComplete</span>);
		hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">LOG_DOMAIN</span>, <span class="hljs-variable constant_">LOG_TAG</span>, <span class="hljs-string">`检查微信安装状态完成：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);
	}

	<span class="hljs-comment">// 返回 Promise 结果，支持 async/await 调用</span>
	<span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">/**
 * 检查指定包名的应用是否已安装）
 * <span class="hljs-doctag">@param</span> bundleName 应用包名
 * <span class="hljs-doctag">@returns</span> Promise&lt;boolean&gt; 是否已安装
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isAppInstalled</span>(<span class="hljs-params">bundleName : string</span>) : <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {
	<span class="hljs-keyword">try</span> {
		<span class="hljs-comment">// 获取应用信息</span>
		<span class="hljs-keyword">await</span> bundleManager.<span class="hljs-title function_">getBundleInfo</span>(
			bundleName,
			bundleManager.<span class="hljs-property">BundleFlag</span>.<span class="hljs-property">GET_BUNDLE_INFO_DEFAULT</span>
		);
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	} <span class="hljs-keyword">catch</span> (err) {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
	}
}
</code></pre>
<h3 data-id="heading-7">三、Uni-App 中使用插件</h3>
<h4 data-id="heading-8">1. 调用检测方法</h4>
<p>在需要使用微信功能的页面（如登录页、支付页），先调用检测方法：</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">import</span> { checkWeChatInstalled } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/uni_modules/hl-appcheckplugin"</span>

    <span class="hljs-title function_">checkApp</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 统一返回 Promise，确保所有端行为一致</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-comment">// #ifdef APP-PLUS</span>
        <span class="hljs-keyword">const</span> isExist = plus.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">isApplicationExist</span>({
          <span class="hljs-attr">pname</span>: <span class="hljs-string">'com.tencent.mm'</span>,
          <span class="hljs-attr">action</span>: <span class="hljs-string">'weixin://'</span>
        });
        <span class="hljs-title function_">resolve</span>(isExist);
        <span class="hljs-comment">// #endif</span>

        <span class="hljs-comment">// #ifdef APP-HARMONY</span>
        <span class="hljs-title function_">checkWeChatInstalled</span>({
          <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微信已安装'</span>);
            <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>);
          },
          <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微信未安装或检测失败'</span>, err);
            <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>);
          }
        });
        <span class="hljs-comment">// #endif</span>

        <span class="hljs-comment">// #ifdef MP-WEIXIN</span>
        <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-comment">// #endif</span>
      });
    },
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[检索增强生成（RAG）与大语言模型微调（Fine-tuning）的差异、优势及使用场景详解]]></title>    <link>https://juejin.cn/post/7578803751609253938</link>    <guid>https://juejin.cn/post/7578803751609253938</guid>    <pubDate>2025-12-02T03:25:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578803751609253938" data-draft-id="7578803751609122866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="检索增强生成（RAG）与大语言模型微调（Fine-tuning）的差异、优势及使用场景详解"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-12-02T03:25:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            检索增强生成（RAG）与大语言模型微调（Fine-tuning）的差异、优势及使用场景详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:25:13.000Z" title="Tue Dec 02 2025 03:25:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>微调大语言模型是利用特定任务或领域的定制数据集，对预训练模型进行调整；而检索增强生成（RAG）则将检索系统与生成模型相结合，动态地将外部的、最新的知识融入生成结果中。</p>
<h2 data-id="heading-0">引言</h2>
<p>随着生成式人工智能（Gen AI）和自然语言处理（NLP）技术的持续演进，业界对更强大、更高效模型的需求呈指数级增长。从聊天机器人、虚拟助手，到复杂的内容生成与搜索系统，NLP 应用正日益成为现代技术不可或缺的组成部分。然而，伴随着这一不断增长的需求，也带来了如何提升这些系统性能与适应能力的挑战，尤其是在复杂且动态变化的环境中。</p>
<p>目前，提升 NLP 模型性能的两种主流方法是检索增强生成（Retrieval-Augmented Generation, RAG）和微调（fine-tuning）。微调长期以来一直是机器学习领域的常用手段，通过使用额外数据进行训练，使模型能够适应特定任务；而 RAG 则引入了一种创新范式——将检索系统的优势与生成模型相结合，构建出一种动态机制，以应对那些需要大规模信息访问和上下文敏感性的任务。</p>
<p>AI 工程师在项目中常常面临一个艰难抉择：究竟应选择 RAG 还是微调？每种方法都有其独特的优势与权衡取舍，因此必须深入理解它们各自的强项、局限性以及最适合的应用场景。本文旨在全面解析这两种技术，帮助读者掌握所需知识，从而做出明智决策，并在其工作中高效地运用这些强大工具。</p>
<h2 data-id="heading-1">自然语言处理技术背景</h2>
<p>自然语言处理（NLP）的发展历程由一系列创新推动，旨在让机器能够精准且细腻地理解和生成人类语言。早期的方法，如基于规则的系统和统计模型，依赖人工设计的特征和领域特定的规则。然而，这些方法在可扩展性和泛化能力方面常常面临困难。</p>
<p>深度学习的兴起成为 NLP 发展的关键转折点，引入了能够从大规模数据集中捕捉复杂模式的神经网络架构。word2vec 和 GloVe 等模型率先提出了词嵌入方法，将词语表示为稠密向量空间中的点，从而提升了对上下文的理解能力。随后，基于 Transformer 架构的大语言模型（Large Language Models, LLMs）——如谷歌提出的 BERT（Bidirectional Encoder Representations from Transformers）和 OpenAI 开发的 GPT（Generative Pre-trained Transformer）——通过自注意力机制实现了对文本上下文的深度理解，彻底革新了整个领域。</p>
<p>尽管取得了这些进展，挑战依然存在。在大规模语料库上训练的模型虽然在通用任务上表现优异，但在特定领域应用或面对不断变化的数据时往往缺乏适应性。这一差距催生了微调（fine-tuning）等技术的发展：即利用额外的任务特定数据对预训练模型进行进一步优化。微调被证明非常有效，但通常需要大量的计算资源和时间投入。</p>
<p>近年来，检索增强生成（Retrieval-Augmented Generation, RAG）作为一种互补性方法应运而生。RAG 将检索系统与生成模型相结合，无需进行大规模重新训练，即可让模型在推理过程中动态访问外部知识库。这一创新为那些需要实时获取最新信息或领域专业知识的任务提供了传统微调之外的一种极具吸引力的替代方案。</p>
<p>解码基础：深入解析 RAG 与微调</p>
<h2 data-id="heading-2">检索增强生成（RAG）详解</h2>
<p>RAG 是 NLP 领域的一项创新方法，它将信息检索能力与语言生成能力有机结合。其核心思想是在生成过程中，使大语言模型能够动态访问并利用外部知识，从而显著增强其表达与推理能力。</p>
<p>RAG 架构主要由两个关键组件构成：检索器（retriever）和生成器（generator）。检索器负责从庞大的文档集合或知识库中搜索并提取与当前任务相关的信息。该组件通常采用先进的信息检索技术，例如稠密向量表示（dense vector representations）和高效的相似性搜索算法，以针对给定查询或上下文精准定位最相关的知识片段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7e41527d484208b27d0d74f5cfee04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250872&amp;x-signature=cie2rAVLd4kfxOFTYupIpiWQgX8%3D" alt="" loading="lazy"/></p>
<p>另一方面，生成器（generator）是一种语言模型，它结合检索到的信息与原始输入，生成连贯、语境恰当且准确的响应。该组件利用预训练语言模型（如 GPT 或 BART）的强大能力，在生成类人文本的同时，融入检索器提供的外部知识。</p>
<p>RAG 通过将生成过程以检索到的信息为条件，将外部知识整合进语言模型中。这种方法使模型能够访问其初始训练数据中可能不存在的最新或任务特定信息。因此，经过 RAG 增强的模型能够在各种任务和领域中提供更准确、更及时、信息更丰富且上下文更相关的回答。</p>
<p>一个典型的 RAG 系统包含以下关键组件：</p>
<ul>
<li>
<p><strong>知识库（Knowledge Base）</strong></p>
<p>：可以是一个大规模文档语料库、包含外部信息的结构化数据，甚至整个互联网。</p>
</li>
<li>
<p><strong>检索器（Retriever）</strong></p>
<p>：负责从知识库中搜索并提取相关信息的模块。</p>
</li>
<li>
<p><strong>编码器（Encoder）</strong></p>
<p>：将输入查询和文档转换为稠密向量表示的组件。</p>
</li>
<li>
<p><strong>相似性搜索（Similarity Search）</strong></p>
<p>：一种基于向量相似度识别最相关文档的算法。</p>
</li>
<li>
<p><strong>生成器（Generator）</strong></p>
<p>：利用检索到的信息和输入上下文生成最终输出的语言模型。</p>
</li>
<li>
<p><strong>融合机制（Fusion Mechanism）</strong></p>
<p>：一种将检索信息与输入相结合以引导生成过程的方法。</p>
</li>
</ul>
<hr/>
<p><strong>微调详解</strong></p>
<p>微调（Fine-tuning）是 NLP 中一种强大的技术，指对预训练语言模型进行进一步训练，使其适应特定任务或专门领域。该过程充分利用大型通用模型已有的知识和能力，并对其进行定制化调整，从而在目标应用场景中实现更优性能。</p>
<p>本质上，微调建立在迁移学习（transfer learning）的概念之上——即模型可将在一个任务中学到的知识迁移到另一个相关任务中。在语言模型的语境下，这意味着模型在预训练阶段获得的通用语言理解与生成能力，可以被进一步细化和专业化，以满足具体用例的需求。这种方法显著减少了对任务特定训练数据的需求，并加速了面向各类应用的高性能模型的开发进程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56154f3cdbd04e5e8283cfef1d85b753~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250872&amp;x-signature=vXWNJGVTSdLQNV34mUJNuVLbb6w%3D" alt="" loading="lazy"/></p>
<p>微调过程包括将预训练模型暴露于一个精心构建的、能够代表目标任务或领域的数据集。在此阶段，模型的参数会被调整，以优化其在新任务上的表现，同时保留预训练阶段获得的基础语言知识。这种精妙的平衡使模型既能利用其对语言的广泛理解，又能发展出针对特定应用场景的专业能力。</p>
<p>微调模型的主要步骤包括：</p>
<ul>
<li>选择一个合适的预训练模型作为起点</li>
<li>准备高质量、面向具体任务的微调数据集</li>
<li>定义任务特定的模型架构（例如，添加分类层）</li>
<li>配置微调过程中的超参数</li>
<li>在新数据集上训练模型，并更新模型参数</li>
<li>在独立的测试集上评估微调后模型的性能</li>
<li>根据需要迭代优化整个流程，直至达到预期效果</li>
</ul>
<p>微调使开发者能够在无需大量计算资源或海量数据的前提下，为各种应用场景（如情感分析、命名实体识别和问答系统等）构建专用模型。这一方法大大降低了使用前沿语言模型的门槛，加速了人工智能解决方案在各行各业的落地与普及。</p>
<hr/>
<p><strong>RAG 与微调正面交锋：性能指标对比</strong></p>
<p><strong>准确性与精确度</strong></p>
<p>在评估 RAG 与微调方法的性能时，准确性和精确度是关键指标，其表现会因具体任务而异。RAG 在需要最新或专业知识的场景中表现卓越，而微调则在任务模式清晰、数据分布稳定的情况下更具优势。</p>
<p>影响两种方法准确性的因素各不相同。对于 RAG 而言，外部知识库的质量与相关性至关重要；检索机制的有效性，以及将检索信息与生成过程融合的能力，也显著影响最终准确性。此外，知识库的多样性与覆盖广度决定了 RAG 在不同领域中的表现。</p>
<p>对于微调而言，任务特定训练数据的质量与数量极为关键。预训练领域与目标任务领域之间的相似度也会影响准确性。此外，学习率、训练轮数等超参数的选择，也会显著影响微调后模型的性能。</p>
<p>在需要访问大量且最新信息的场景中，RAG 通常优于微调。例如，在开放域问答任务中，RAG 可借助其庞大的知识库提供更准确的答案，尤其对于涉及近期事件或原始训练数据未涵盖的专业主题的问题。</p>
<p>相反，在任务结构清晰、数据分布稳定的场景下（如命名实体识别或情感分析），微调模型往往表现更佳。这类任务在不同文本中保持相对一致的模式，微调模型可通过专门学习任务特有的模式和细微差别，实现更高的准确率。</p>
<p>事实核查是 RAG 展现更高准确性的另一领域。通过从知识库中的多个来源检索并交叉验证信息，RAG 能提供比微调模型更可靠的事实验证——后者仅受限于训练期间编码到模型参数中的信息。</p>
<p>然而，在需要深入理解特定领域术语或高度专业化语言模式的任务中，微调可能胜过 RAG。例如，在法律文书分析或医疗报告生成等场景中，若外部知识库未能全面覆盖该专业领域，那么基于领域数据微调的模型往往会比 RAG 系统取得更高的准确性。</p>
<p>适应性与泛化能力</p>
<p>适应性与泛化能力是人工智能模型的关键特性，决定了模型在面对新数据和新任务时的表现能力。检索增强生成（RAG）模型与微调模型在这两个方面展现出不同的特点，各自具有独特的优势与局限。</p>
<p>RAG 模型在适应新信息和新场景方面表现更优。通过利用外部知识库，RAG 无需重新训练即可整合最新信息，使其在信息快速变化的动态环境中始终保持时效性和相关性。</p>
<p>相比之下，微调模型虽然在特定任务上高度专业化，但在适应性方面往往存在困难。它们容易出现“灾难性遗忘”现象——即模型在适应新任务或新数据时，会丢失先前学到的知识。这是因为微调过程会调整模型参数以优化新任务的性能，可能会覆盖掉对先前任务有用的知识。</p>
<p>RAG 通过维护一个独立且可更新的知识库来避免灾难性遗忘问题。它不修改模型内部参数，而是从外部来源检索相关信息，从而在适应新数据的同时，不会损害其在已学任务上的表现。</p>
<p>泛化能力在以下任务中尤为重要：</p>
<ul>
<li>
<p><strong>开放域问答</strong></p>
<p>：RAG 能够访问广泛的知识库，即使面对训练中未见过的主题，也能回答多样化的问题。</p>
</li>
<li>
<p><strong>零样本学习</strong></p>
<p>：RAG 可借助知识库中的相关信息，在未经显式训练的任务上取得合理表现。</p>
</li>
<li>
<p><strong>跨语言任务</strong></p>
<p>：微调模型在遇到训练数据中未包含的语言或方言时可能表现不佳，而 RAG 则有可能检索并利用多语言信息。</p>
</li>
<li>
<p><strong>时序推理</strong></p>
<p>：RAG 能整合最新信息，因此更适合处理涉及当前事件或不断演进知识的任务。</p>
</li>
</ul>
<p>RAG 与微调在适应性方面的关键差异包括：</p>
<ul>
<li>
<p><strong>知识整合方式</strong></p>
<p>：RAG 动态整合新信息，而微调模型需重新训练。</p>
</li>
<li>
<p><strong>灾难性遗忘</strong></p>
<p>：RAG 基本避免了该问题，微调模型则容易受其影响。</p>
</li>
<li>
<p><strong>任务灵活性</strong></p>
<p>：RAG 无需重新训练即可适应更广泛的任务，而微调模型更具任务专一性。</p>
</li>
<li>
<p><strong>持续学习能力</strong></p>
<p>：RAG 通过更新知识库支持持续学习；微调模型训练完成后知识通常是固定的。</p>
</li>
<li>
<p><strong>对未见数据的泛化能力</strong></p>
<p>：得益于广泛的一般知识访问，RAG 在全新场景中通常表现更佳。</p>
</li>
</ul>
<p>资源需求与计算开销</p>
<p>RAG 与微调模型的计算需求存在显著差异，这直接影响它们在实际应用中的部署与可扩展性。由于 RAG 需要在推理时实时维护并查询大型外部知识库，通常需要更多的计算资源。</p>
<p>在 GPU/TPU 使用方面，微调在训练阶段通常需要大量计算资源，但推理阶段效率更高。RAG 模型在初始设置阶段计算负担较轻，但在推理过程中需要持续的 GPU/TPU 算力，以支持实时信息检索与整合。</p>
<p>内存需求也大不相同。微调模型将所有信息存储于模型参数中，导致模型体积较大，但推理速度可能更快。RAG 模型的核心部分较小，但需要额外内存来存储和访问外部知识库。</p>
<p>两种方法在可扩展性方面各有挑战。微调模型在特定任务上扩展性良好，但若需覆盖不同领域，往往需要重新训练或使用多个独立模型。RAG 系统因其模块化结构，在多样化任务中具备更好的可扩展性——只需更新知识库，无需改动核心模型。</p>





























<table><thead><tr><th>模型规模</th><th>任务</th><th>RAG 计算开销</th><th>微调计算开销</th></tr></thead><tbody><tr><td>小</td><td>问答</td><td>中</td><td>低</td></tr><tr><td>中</td><td>命名实体识别</td><td>高</td><td>中</td></tr><tr><td>大</td><td>摘要生成</td><td>极高</td><td>高</td></tr></tbody></table>
<p><strong>优化 RAG 系统资源使用的建议：</strong></p>
<ul>
<li>实现高效的索引与检索算法。</li>
<li>对高频访问信息使用缓存机制。</li>
<li>对大规模知识库采用分布式计算。</li>
</ul>
<p><strong>优化微调的建议：</strong></p>
<ul>
<li>使用参数高效微调技术（如适配器层）。</li>
<li>应用量化与剪枝以减小模型体积。</li>
<li>利用迁移学习减少新任务的训练时间。</li>
</ul>
<p>两种方法均可受益于硬件加速和优化的推理引擎。选择 RAG 还是微调，通常需在计算开销、任务灵活性和性能需求之间进行权衡，具体取决于应用场景。</p>
<p>推理速度与延迟</p>
<p>RAG 模型虽灵活且能访问动态实时信息，但本质上推理速度较慢。其高延迟主要源于检索过程：在生成响应前，RAG 必须搜索知识库、检索相关信息，并将其与用户查询整合。尽管这一额外步骤增强了模型获取最新信息的能力，但也带来了显著的时间开销。</p>
<p>在推理阶段的计算需求方面，两者也有明显区别。微调模型已将任务特定知识内化到参数中，推理时通常计算负担较轻，仅依赖输入和预训练/微调后的权重。而 RAG 模型需维护并查询大型外部知识库，计算密集度高，可能需要额外硬件资源。</p>
<p>部署时选择 RAG 还是微调，取决于应用的具体需求。对于实时聊天机器人或自动交易系统等对延迟敏感的任务，微调模型的低延迟更具优势。而对于新闻摘要或动态事实核查等对信息时效性要求高的应用，RAG 的额外延迟可能是可接受的，因其能获取并整合最新信息。</p>
<p>实施策略：让 RAG 与微调落地</p>
<p><strong>RAG 实施蓝图</strong></p>
<p>构建 RAG 系统包含若干关键步骤，每一步都对模型的有效性和效率至关重要。首先进行数据准备，收集并预处理高质量、多样化的语料库，作为 RAG 系统运行时查询的知识基础。</p>
<p>其次，训练检索器组件。RAG 中的检索器通常使用嵌入模型（如 BERT 或 DPR，即 Dense Passage Retriever）将查询和文档编码为稠密向量表示，以便进行相似性搜索。</p>
<p>接下来是检索器与生成器的集成，这是关键环节。需设计一条高效流水线，能根据输入查询快速检索相关信息，并无缝融入生成过程。生成器通常是一个预训练语言模型（如 GPT），需进一步微调以有效利用检索到的信息。</p>
<p><strong>常用 RAG 框架与工具包括：</strong></p>
<ul>
<li>
<p><strong>Haystack</strong></p>
<p>：端到端 RAG 框架，提供文档存储、检索器和阅读器组件。</p>
</li>
<li>
<p><strong>LangChain</strong></p>
<p>：简化大语言模型与外部数据源及其他计算模块结合的库。</p>
</li>
<li>
<p><strong>Hugging Face Transformers</strong></p>
<p>：提供用于检索和生成任务的预训练模型与工具。</p>
</li>
</ul>
<p>以下是一个简化的 RAG 系统伪代码：</p>
<pre><code class="hljs language-ini" lang="ini">
def rag_system(query, knowledge_base):
    <span class="hljs-comment"># 检索相关文档</span>
    <span class="hljs-attr">relevant_docs</span> = retriever.get_relevant_documents(query, knowledge_base)
    <span class="hljs-comment"># 拼接检索到的文档作为上下文</span>
    <span class="hljs-attr">context</span> = <span class="hljs-string">" "</span>.join(relevant_docs)
    <span class="hljs-comment"># 结合查询与上下文生成响应</span>
    <span class="hljs-attr">response</span> = generator.generate(query + context)
    return response

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">query</span> = <span class="hljs-string">"法国的首都是哪里？"</span>
<span class="hljs-attr">response</span> = rag_system(query, knowledge_base)
print(response)

</code></pre>
<p><strong>RAG 实施最佳实践：</strong></p>
<ul>
<li>确保知识库内容多样且高质量，覆盖广泛主题。</li>
<li>定期更新知识库以保持准确性和时效性。</li>
<li>实现高效的索引与检索机制，降低延迟。</li>
<li>在任务特定数据上微调生成器，提升输出连贯性与相关性。</li>
<li>建立稳健的评估流程，衡量检索信息与生成响应的质量。</li>
<li>考虑在初步检索后加入重排序步骤，提升相关性。</li>
<li>尝试不同检索与生成模型组合，找到最适合具体用例的配置。</li>
</ul>
<p><strong>微调实施蓝图</strong></p>
<p>对预训练语言模型进行微调需采用系统化方法，确保模型有效适应目标任务或领域。首先进行数据准备：收集、清洗并按需标注高质量的领域特定数据集，作为模型专项训练的基础。</p>
<p>随后进入模型选择阶段，挑选合适的预训练模型（如 BERT、GPT 或 T5），并根据任务需求（如分类、摘要或问答）对模型架构进行微调，例如添加任务特定层。</p>
<p>准备好数据与模型后，开始微调过程：使用合适的超参数、损失函数和优化器在任务特定数据集上训练模型，并通过验证集定期评估，防止过拟合。</p>
<p><strong>常用微调框架与工具包括：</strong></p>
<ul>
<li>
<p><strong>Hugging Face Transformers</strong></p>
<p>：提供预训练模型、分词器及多种 NLP 任务的微调工具。</p>
</li>
<li>
<p><strong>PyTorch 与 TensorFlow</strong></p>
<p>：主流机器学习框架，支持自定义模型的实现与微调。</p>
</li>
<li>
<p><strong>Google Colab 与 Kaggle</strong></p>
<p>：提供免费 GPU 的云端平台，适合微调小型模型。</p>
</li>
</ul>
<p>以下是一个用于情感分析的微调伪代码示例：</p>
<pre><code class="hljs language-ini" lang="ini">from transformers import AutoModelForSequenceClassification, AutoTokenizer, Trainer, TrainingArguments

<span class="hljs-comment"># 加载预训练模型与分词器</span>
<span class="hljs-attr">model_name</span> = <span class="hljs-string">"bert-base-uncased"</span>
<span class="hljs-attr">model</span> = AutoModelForSequenceClassification.from_pretrained(model_name, num_labels=<span class="hljs-number">2</span>)
<span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(model_name)

<span class="hljs-comment"># 数据预处理</span>
def preprocess_function(examples):
    return tokenizer(examples<span class="hljs-section">["text"]</span>, <span class="hljs-attr">truncation</span>=<span class="hljs-literal">True</span>, padding=<span class="hljs-literal">True</span>)

<span class="hljs-attr">tokenized_datasets</span> = raw_datasets.map(preprocess_function, batched=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 训练参数设置</span>
<span class="hljs-attr">training_args</span> = TrainingArguments(
    <span class="hljs-attr">output_dir</span>=<span class="hljs-string">"./results"</span>,
    <span class="hljs-attr">evaluation_strategy</span>=<span class="hljs-string">"epoch"</span>,
    <span class="hljs-attr">save_strategy</span>=<span class="hljs-string">"epoch"</span>,
    <span class="hljs-attr">learning_rate</span>=<span class="hljs-number">2</span>e-<span class="hljs-number">5</span>,
    <span class="hljs-attr">per_device_train_batch_size</span>=<span class="hljs-number">16</span>,
    <span class="hljs-attr">num_train_epochs</span>=<span class="hljs-number">3</span>,
    <span class="hljs-attr">weight_decay</span>=<span class="hljs-number">0.01</span>,
)

<span class="hljs-comment"># 定义训练器</span>
<span class="hljs-attr">trainer</span> = Trainer(
    <span class="hljs-attr">model</span>=model,
    <span class="hljs-attr">args</span>=training_args,
    <span class="hljs-attr">train_dataset</span>=tokenized_datasets[<span class="hljs-string">"train"</span>],
    <span class="hljs-attr">eval_dataset</span>=tokenized_datasets[<span class="hljs-string">"validation"</span>],
)

<span class="hljs-comment"># 开始训练</span>
trainer.train()
</code></pre>
<p><strong>微调实施最佳实践：</strong></p>
<ul>
<li>
<p><strong>任务数据质量</strong></p>
<p>：确保数据集干净、标注准确，并能代表目标领域或任务。</p>
</li>
<li>
<p><strong>超参数调优</strong></p>
<p>：尝试不同学习率、批次大小和训练轮数以优化性能。</p>
</li>
<li>
<p><strong>防止过拟合</strong></p>
<p>：使用 dropout、早停或正则化等技术提升泛化能力。</p>
</li>
<li>
<p><strong>定期评估</strong></p>
<p>：训练过程中监控验证集表现，确保有效学习。</p>
</li>
<li>
<p><strong>利用预训练层</strong></p>
<p>：冻结基础模型，仅微调任务特定层，提高资源效率。</p>
</li>
<li>
<p><strong>高效资源利用</strong></p>
<p>：使用 GPU/TPU 云资源及批处理加速微调。</p>
</li>
<li>
<p><strong>持续更新</strong></p>
<p>：定期用新数据重新训练模型，保持时效性与准确性。</p>
</li>
</ul>
<p>遵循此蓝图，可高效实现各类 NLP 任务的微调，在保证任务性能的同时优化资源使用。</p>
<p>选择合适的 AI 模型增强技术</p>
<h2 data-id="heading-3"><strong>RAG 的优势场景</strong></h2>
<p>RAG 在需要访问海量、最新信息且无需重新训练即可适应新数据的场景中表现卓越。这使其特别适用于知识持续演进或信息范围过于广泛、难以完全内化到单一模型参数中的领域。</p>
<p>典型例子是开放域问答系统。与仅依赖参数内嵌知识的微调模型不同，RAG 能动态从知识库中检索并整合最新信息。这一能力对虚拟助手或客服聊天机器人至关重要，因为它们需在广泛主题上提供准确、及时的回答。</p>
<p>RAG 在需要事实准确性与内容多样性的内容生成任务中同样出色。例如，在自动新闻摘要或报告生成中，RAG 可引入最新数据与统计信息，确保内容既新颖又准确。这种动态知识整合在金融等领域尤为宝贵，因为市场状况与公司信息瞬息万变。</p>
<p>RAG 处理频繁更新信息的能力在许多现实应用中具有显著优势。例如在医疗领域，基于 RAG 的系统无需反复重新训练，即可同步最新研究成果、治疗方案和药物信息，确保医护人员在关键决策时获得最新、最相关的知识。</p>
<p><strong>RAG 的主要应用场景包括：</strong></p>
<ul>
<li>开放域问答与聊天机器人</li>
<li>实时新闻摘要与分析</li>
<li>科学文献综述与研究辅助</li>
<li>金融市场分析与报告</li>
<li>教育工具与互动学习平台</li>
<li>事实核查与虚假信息检测系统</li>
</ul>
<p>在这些场景中，RAG 将大语言模型的泛化能力与信息检索系统的精准性与时效性相结合，成为处理复杂、知识密集型任务的强大工具。</p>
<h2 data-id="heading-4"><strong>微调的优势场景</strong></h2>
<p>微调适用于任务特定优化和低延迟性能至关重要的场景。一个典型领域是特定领域的自然语言处理任务。例如，在法律、医疗或技术文档分析中，微调模型通过专项训练理解专业术语、上下文和细微差别，表现优于通用模型。</p>
<p>任务特定性能优化是微调的另一优势。在情感分析、垃圾邮件检测或命名实体识别等应用中，微调模型通过聚焦特定任务数据集，实现卓越性能，不仅能准确识别，还能稳健处理领域特有细节。</p>
<p>微调在低延迟环境中同样表现出色。由于不依赖外部检索机制，微调模型比 RAG 等检索增强系统生成响应更快，非常适合聊天机器人、语音助手和实时翻译等对响应速度要求极高的应用。</p>
<p>在医疗或金融等数据隐私至关重要的环境中，微调模型还具备额外优势：通过将任务知识直接嵌入模型，减少了对外部数据检索的依赖，从而降低数据泄露或隐私违规风险。</p>
<h2 data-id="heading-5"><strong>微调的主要应用场景包括：</strong></h2>
<ul>
<li>社交媒体或客户反馈的情感分析</li>
<li>法律与医疗文档分析</li>
<li>个性化推荐与用户画像</li>
<li>金融系统中的欺诈检测与风险评估</li>
<li>低延迟客户服务聊天机器人</li>
<li>任务特定摘要与报告生成</li>
<li>领域特定翻译与语言模型</li>
<li>技术支持与故障排查助手</li>
</ul>
<p>在这些场景中，微调模型凭借其任务专精能力和快速响应效率，成为不可或缺的方法。其对稳定数据集和内嵌知识的依赖，使其在可预测、任务聚焦的应用中持续高效。</p>
<p><strong>混合方法：两全其美</strong></p>
<p>结合 RAG 与微调的混合方法，为同时需要最新信息检索与任务特定优化的场景提供了强大解决方案。这类方法融合两者优势，构建出更灵活高效的 AI 系统。</p>
<p>一种有效策略是以微调模型作为 RAG 系统的基础。这样，模型既具备特定领域的专业知识，又能访问并整合外部信息。例如，在医疗诊断系统中，基础模型可微调于医学术语和常见诊疗流程，而 RAG 能力则使其检索最新研究成果或罕见病例。</p>
<p>另一种方法是先用 RAG 进行初步信息检索，再对输出生成过程进行微调。这在事实准确性与风格一致性均重要的内容创作任务中尤为有用。例如，新闻摘要系统可用 RAG 收集相关事实，再通过微调语言模型按特定新闻风格生成摘要。</p>
<p><strong>混合方法的实际应用包括：</strong></p>
<ul>
<li>法律研究工具：结合微调模型理解法律语言，RAG 访问最新判例与法规。</li>
<li>教育平台：微调用于个性化教学，RAG 检索多样且最新的学习资料。</li>
<li>金融分析系统：微调模型预测市场趋势，RAG 整合实时经济数据。</li>
</ul>
<p>下图决策树可指导从业者根据具体用例选择最合适的方法，在专业深度与信息时效性之间取得平衡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ccbbfafecda4a448c62c2d6ea7e32bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250872&amp;x-signature=Qq3%2Bn%2F6KgglixmEzbtyRwrAzpZw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>结论</strong></h2>
<p>RAG 与微调代表了提升 AI 模型性能的两种不同路径，各有优势与局限。RAG 擅长需要访问大规模、频繁更新知识库的场景，具备无需重新训练即可适应新信息的灵活性。而微调则在任务专精应用中表现突出，提供更快的推理速度和更紧凑的模型。</p>
<p>选择 RAG 还是微调时，需综合考虑任务性质、数据更新频率、计算资源及可解释性需求。RAG 更适合开放域任务和需要最新信息的应用；微调则适用于知识稳定、定义明确的专项任务。</p>
<p>将所选方法与项目具体需求和约束对齐至关重要。需权衡推理速度、模型大小、适应性以及对外部知识库的依赖程度。某些情况下，结合 RAG 与微调的混合方法可能是最优解。</p>
<p>鼓励从业者亲自尝试两种方法，积累实践经验。</p>
<p><strong>常见问题解答</strong></p>
<p><strong>Q：RAG 与微调在推理速度上有何差异？</strong> A：微调模型通常推理速度更快。图表显示，在所有模型规模（小、中、大）下，微调模型的推理时间始终低于 RAG 模型。</p>
<p><strong>Q：实施 RAG 系统的主要挑战有哪些？</strong> A：关键挑战包括构建与维护大规模、最新知识库，实现高效检索机制，平衡检索准确性与速度。此外，确保检索信息的相关性及其与生成过程的无缝整合也较为复杂。</p>
<p><strong>Q：如何判断我的任务是否只需微调，还是应考虑 RAG？</strong> A：若任务定义清晰、知识领域稳定且无需频繁更新，可选择微调。若应用需访问广泛且频繁更新的知识库，或需处理原始训练数据范围之外的查询，则应考虑 RAG。</p>
<p><strong>Q：RAG 与微调能否有效结合？</strong> A：可以。混合方法非常有效。例如，可将微调模型作为 RAG 系统的基础，结合专业领域知识与外部信息检索能力；也可先用 RAG 检索信息，再对生成过程进行微调以适配特定任务或风格。</p>
<p><strong>Q：RAG 与微调在模型可解释性方面有何差异？</strong> A：RAG 通常更具可解释性，因其能提供检索信息的来源，便于追溯模型决策过程。微调模型虽在特定任务上可能更准确，但其推理过程透明度较低。</p>
<p><strong>Q：除 RAG 与微调外，模型增强技术还有哪些新兴趋势？</strong> A：新兴趋势包括：持续学习技术（使模型无需完整重训即可更新知识）、更高效的参数高效微调方法、基于先进神经架构的改进检索机制，以及能动态决定何时使用内部知识 vs. 外部检索的模型。</p>
<h3 data-id="heading-7">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PropertyValuesHolder与Keyframe 笔记]]></title>    <link>https://juejin.cn/post/7578820376999084083</link>    <guid>https://juejin.cn/post/7578820376999084083</guid>    <pubDate>2025-12-02T03:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820376999084083" data-draft-id="7578780780026445833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PropertyValuesHolder与Keyframe 笔记"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-02T03:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="城东米粉儿"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029151694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PropertyValuesHolder与Keyframe 笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029151694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    城东米粉儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:17:35.000Z" title="Tue Dec 02 2025 03:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PropertyValuesHolder</h2>
<p>ValueAnimator和ObjectAnimator都有对应的ofPorpertyValuesHolder方法</p>
<p>PorpertyValuesHolde创建实例的方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofFloat</span><span class="hljs-params">(String PropertyName,<span class="hljs-type">float</span>... values)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofInt</span><span class="hljs-params">(String PropertyName,<span class="hljs-type">int</span>... values)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofObject</span><span class="hljs-params">(String PropertyName,TypeEvaluator evaluator,Object... values)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PropertyValuesHolder <span class="hljs-title function_">ofKeyFrame</span><span class="hljs-params">(String PropertyName,KeyFrame... values)</span>
</code></pre>
<p>ofFloat,ofInt使用示例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">PropertyValuesHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> PropertyValuesHolder.ofFLoat(<span class="hljs-string">"alpha"</span>,<span class="hljs-number">0.1f</span>,<span class="hljs-number">0.3f</span>,<span class="hljs-number">0.7f</span>,<span class="hljs-number">1f</span>);
<span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">animator</span> <span class="hljs-operator">=</span> ObjectAnimator.ofPorpertyValuesHolder(view,holder);
animator.setDuration(<span class="hljs-number">2000</span>);
animator.start();

</code></pre>
<p>ofObject方法参数，可以实现一个自定义的插值器，使用实例：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CharEvaLuator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeEvaluator</span>&lt;Character&gt;{
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Character <span class="hljs-title function_">evaluate</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction, Character startValue, Character endValue)</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">startInt</span> <span class="hljs-operator">=</span> startValue;
            <span class="hljs-type">int</span> <span class="hljs-variable">endInt</span> <span class="hljs-operator">=</span> endValue;
            <span class="hljs-type">int</span> <span class="hljs-variable">curInt</span> <span class="hljs-operator">=</span> startInt + fraction * (endInt- startInt);
            <span class="hljs-type">char</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (Char)curInt;
            <span class="hljs-keyword">return</span> result;
        }
    }
    
    <span class="hljs-type">PropertyValuesHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> PropertyValuesHolder.ofObject(<span class="hljs-string">"CharText"</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">CharEvaluator</span>,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Character</span>(<span class="hljs-string">'A'</span>),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Character</span>(<span class="hljs-string">'Z'</span>));
    <span class="hljs-type">ObjectAnimator</span> <span class="hljs-variable">animator</span> <span class="hljs-operator">=</span> ObjectAnimator.ofPorpertyValuesHolder(tv,holder);
    animator.setDuration(<span class="hljs-number">2000</span>);
    animator.start();
    
    <span class="hljs-comment">//注意因为TextView 中setText(CharSequence text)参数，需要内部自定义setCharText(Charactor text)结合ofObject使用</span>
</code></pre>
<h2 data-id="heading-1">Keyframe</h2>
<p>keyframe 我个人感觉可以理解为好比做动画时绘制的帧。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> KeyFrame <span class="hljs-title function_">ofFloat</span><span class="hljs-params">(<span class="hljs-type">float</span> fraction,<span class="hljs-type">float</span> duration)</span>
<span class="hljs-comment">//fraction 当前显示的进度，value 当前动画所在数值位置</span>

</code></pre>
<p>ofFloat,ofInt使用实例：</p>
<pre><code class="hljs language-ini" lang="ini">KeyFrame <span class="hljs-attr">frame0</span> = KeyFrame.<span class="hljs-literal">ofF</span>loat(<span class="hljs-number">0</span>f,<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
KeyFrame <span class="hljs-attr">frame1</span> = KeyFrame.<span class="hljs-literal">ofF</span>loat(<span class="hljs-number">0.5</span>f,<span class="hljs-number">50</span>)<span class="hljs-comment">;</span>
KeyFrame <span class="hljs-attr">frame2</span> = KeyFrame.<span class="hljs-literal">ofF</span>loat(<span class="hljs-number">1</span>f,<span class="hljs-number">100</span>)<span class="hljs-comment">;</span>
PropertyValuesHolder <span class="hljs-attr">holder</span> = PropertyValuesHolder.ofKeyframe(<span class="hljs-string">"alpha"</span>,frame0,frame1,frame2)<span class="hljs-comment">;</span>
ObjetAnimator <span class="hljs-attr">animator</span> = ObjetAnimator.ofPropertyValuesHolder(view,holder)<span class="hljs-comment">;</span>
animator.setDuration(2000)<span class="hljs-comment">;</span>
animator.start()<span class="hljs-comment">;</span>

//也可以给除第一帧以外的设置插值器
frame1.setInterpolator(new BounceInterpolator())<span class="hljs-comment">;</span>
</code></pre>
<p>ofObject()同样也可以实现一些自定义的属性参数，例如</p>
<pre><code class="hljs language-ini" lang="ini">KeyFrame <span class="hljs-attr">frame0</span> = KeyFrame.ofObject(<span class="hljs-number">0</span>,new Character(<span class="hljs-string">'A'</span>))<span class="hljs-comment">;</span>
KeyFrame <span class="hljs-attr">frame1</span> = KeyFrame.ofObject(<span class="hljs-number">0</span>,new Character(<span class="hljs-string">'B'</span>))<span class="hljs-comment">;</span>
KeyFrame <span class="hljs-attr">frame2</span> = KeyFrame.ofObject(<span class="hljs-number">0</span>,new Character(<span class="hljs-string">'C'</span>))<span class="hljs-comment">;</span>

//结合上面的CharEvaLuator自定义插值器使用
PropertyValuesHolder <span class="hljs-attr">holder</span> = PropertyValuesHolder.ofKeyframe(<span class="hljs-string">"CharText"</span>,frame0,frame1,frame2)<span class="hljs-comment">;</span>
holder.setEvalutar(new CharEvaLuator())<span class="hljs-comment">;</span>
ObjetAnimator <span class="hljs-attr">animator</span> = ObjetAnimator.ofPropertyValuesHolder(view,holder)<span class="hljs-comment">;</span>
animator.setDuration(2000)<span class="hljs-comment">;</span>
animator.start()<span class="hljs-comment">;</span>
</code></pre>
<h6 data-id="heading-2"><strong>注意</strong></h6>
<ol>
<li>
<p>多个KeyFrame，都会默认把第一个frame设为首帧，最后一个设为尾帧，不管是不是你期望的效果</p>
</li>
<li>
<p>必须存在2个或2个以上的frame，不然会报数组越界</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Jetpack 存储篇（DataStore、Room）与 Flow 高效组合]]></title>    <link>https://juejin.cn/post/7578780780027084809</link>    <guid>https://juejin.cn/post/7578780780027084809</guid>    <pubDate>2025-12-02T03:23:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578780780027084809" data-draft-id="7576271552704872474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Jetpack 存储篇（DataStore、Room）与 Flow 高效组合"/> <meta itemprop="keywords" content="Android,APP"/> <meta itemprop="datePublished" content="2025-12-02T03:23:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="参宿四南河三"/> <meta itemprop="url" content="https://juejin.cn/user/3479267728427543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Jetpack 存储篇（DataStore、Room）与 Flow 高效组合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3479267728427543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    参宿四南河三
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:23:14.000Z" title="Tue Dec 02 2025 03:23:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：为什么要写这篇文章</h2>
<p>在现代 Android 开发中，本地数据持久化是几乎所有应用的核心需求。Jetpack 提供了两套官方推荐的存储方案：</p>
<ul>
<li><strong>DataStore</strong>：轻量级键值对存储，推荐替代 SharedPreferences</li>
<li><strong>Room</strong>：强大且类型安全的 SQLite 封装数据库</li>
</ul>
<p>本文从实际开发出发，与 Kotlin 的 <strong>Flow</strong>结合后，可以构建出响应式、简洁、高效的本地数据架构。最近看之前项目代码，发现不少小伙伴并不知道两者可以结合使用。所以本文将深入讲解如何将 DataStore 和 Room 与 Flow 高效组合使用。<br/>
Demo将尽可能模拟实际开发，github地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftcyang123456%2FTestCompose.git" target="_blank" title="https://github.com/tcyang123456/TestCompose.git" ref="nofollow noopener noreferrer">github.com/tcyang12345…</a>  ,选择“持久化测试”。需要的小伙伴可搬到生产代码中去。</p>
<h2 data-id="heading-1">一、为什么需要Flow</h2>
<p>传统的 LiveData 虽然好用，但在以下场景存在局限：</p>
<ul>
<li>无法天然表达“单次事件”（需要额外处理一次性事件）</li>
<li>生命周期感知强，但无法在非 UI 层（如 Repository、UseCase）中使用</li>
<li>不支持背压、复杂的流操作（map、filter、combine、flatMapConcat 等）</li>
</ul>
<p>而 Flow 是纯 Kotlin 的响应式流，完全运行在协程中，具备：</p>
<ul>
<li>冷流特性：只有被收集时才执行</li>
<li>强大的操作符支持</li>
<li>天然支持背压</li>
<li>可在任意协程作用域中使用</li>
</ul>
<p>因此，用 Flow 作为统一的数据流动载体，是目前最推荐的实践。关于Flow相关介绍，可以查看我的这一篇文章<a href="https://juejin.cn/post/7547408384607060020%E3%80%82" target="_blank" title="https://juejin.cn/post/7547408384607060020%E3%80%82">juejin.cn/post/754740…</a></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[UI] --&gt; B[ViewModel StateFlow]
    B --&gt; C[Repository Flow]
    C --&gt; D[Room Flow] &amp; E[DataStore.data Flow]
    D &amp; E --&gt; F[自动刷新]
</code></pre>
<p><strong>本文主要讲述两者的使用，以及和Flow的结合使用，Room的SQL语法不作重点讲述。</strong></p>
<h2 data-id="heading-2">二、DataStore + Flow：设置数据最佳组合</h2>
<h3 data-id="heading-3">添加第三方依赖，包含 Preferences和Proto</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 数据存储datastore</span>
implementation(<span class="hljs-string">"androidx.datastore:datastore-preferences:1.0.0"</span>)
<span class="hljs-comment">// 或者使用 Proto DataStore</span>
implementation(<span class="hljs-string">"androidx.datastore:datastore-core:1.0.0"</span>)
implementation(<span class="hljs-string">"com.google.protobuf:protobuf-javalite:3.25.0"</span>)
</code></pre>
<h3 data-id="heading-4">1. Preferences DataStore（键值对）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> PreferencesKeys {
    <span class="hljs-keyword">val</span> THEME_MODE = preferencesKey&lt;String&gt;(<span class="hljs-string">"theme_mode"</span>)
    <span class="hljs-keyword">val</span> USER_TOKEN = preferencesKey&lt;String&gt;(<span class="hljs-string">"user_token"</span>)
    <span class="hljs-keyword">val</span> HAS_NEW_GUIDE = preferencesKey&lt;<span class="hljs-built_in">Boolean</span>&gt;(<span class="hljs-string">"has_new_guide"</span>)
}

<span class="hljs-keyword">object</span> DataStoreManager {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> DATA_STORE_NAME = <span class="hljs-string">"app_settings"</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> Context.pfsDataStore: DataStore&lt;Preferences&gt; <span class="hljs-keyword">by</span> preferencesDataStore(
        name = DATA_STORE_NAME
    )
    <span class="hljs-comment">// 此处是proto store扩展方法,后续使用</span>
    <span class="hljs-keyword">val</span> Context.userProtoDataStore: DataStore&lt;UserSettings&gt; <span class="hljs-keyword">by</span> dataStore(
        fileName = <span class="hljs-string">"user_settings.pb"</span>, <span class="hljs-comment">//注意后缀，虽不强制，但最好遵循规范</span>
        serializer = UserSettingsSerializer,
        corruptionHandler = ReplaceFileCorruptionHandler (
            produceNewData = { UserSettings.getDefaultInstance()}
        )
    )

    <span class="hljs-keyword">val</span> context <span class="hljs-keyword">get</span>() = MyApp.instance

    <span class="hljs-comment">/**
     * 主题模式数据流，用于监听主题设置的变化
     * <span class="hljs-doctag">@return</span> 返回一个Flow&lt;String&gt;，表示当前的主题模式（默认为"light"）
     */</span>
    <span class="hljs-keyword">val</span> themeModeFlow: Flow&lt;String&gt; = context.pfsDataStore.<span class="hljs-keyword">data</span>
        .<span class="hljs-keyword">catch</span> { exception -&gt;
            <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">is</span> IOException) {
                emit(emptyPreferences())
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> exception
            }
        }
        .map { preferences -&gt;
            preferences[PreferencesKeys.THEME_MODE] ?: <span class="hljs-string">"light"</span>
        }

    <span class="hljs-comment">/**
     * 用户Token数据流，用于监听用户Token的变化
     * <span class="hljs-doctag">@return</span> 返回一个Flow&lt;String&gt;，表示当前用户的Token（默认为空字符串）
     */</span>
    <span class="hljs-keyword">val</span> userTokenFlow: Flow&lt;String&gt; = context.pfsDataStore.<span class="hljs-keyword">data</span>.<span class="hljs-keyword">catch</span> { ex -&gt;
        <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">is</span> IOException) {
            emit(emptyPreferences())
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> ex
        }
    }.map { preferences -&gt;
        preferences[PreferencesKeys.USER_TOKEN] ?: <span class="hljs-string">""</span>
    }

    <span class="hljs-comment">/**
     * 监听所有的数据Preferences Datastore
     * 包括主题模式、用户Token和新手引导状态三个字段的组合数据流
     * <span class="hljs-doctag">@return</span> 返回一个Flow&lt;Triple&lt;String, String, Boolean&gt;&gt;，
     * 第一个元素为主题模式，第二个为用户Token，第三个为新手引导状态
     */</span>
    <span class="hljs-keyword">val</span> userSettingsFlow: Flow&lt;Triple&lt;String, String, <span class="hljs-built_in">Boolean</span>&gt;&gt; = context.pfsDataStore.<span class="hljs-keyword">data</span>.<span class="hljs-keyword">catch</span> { ex -&gt;
        <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">is</span> IOException) {
            emit(emptyPreferences())
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> ex
        }
    }.map { preferences -&gt;
        Triple(
            preferences[PreferencesKeys.THEME_MODE] ?: <span class="hljs-string">"light"</span>,
            preferences[PreferencesKeys.USER_TOKEN] ?: <span class="hljs-string">""</span>,
            preferences[PreferencesKeys.HAS_NEW_GUIDE] ?: <span class="hljs-literal">false</span>
        )
    }

    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveThemeMode</span><span class="hljs-params">(mode: <span class="hljs-type">String</span>)</span></span> {
        context.pfsDataStore.edit { preferences -&gt;
            preferences[PreferencesKeys.THEME_MODE] = mode
        }
    }

    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveToken</span><span class="hljs-params">(token: <span class="hljs-type">String</span>)</span></span> {
        context.pfsDataStore.edit { settings -&gt;
            settings[PreferencesKeys.USER_TOKEN] = token
        }
    }

    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearToken</span><span class="hljs-params">()</span></span> {
        context.pfsDataStore.edit { it.clear() }
    }
}
</code></pre>
<h4 data-id="heading-5">使用方式：</h4>
<p>在Viewmodel中</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/*----------以下是preferences datastore----------------*/</span>
    <span class="hljs-comment">/**
     * 将用户设置数据流转换为状态流
     * 
     * 该函数将DataStoreManager中的用户设置流转换为StateFlow，以便在ViewModel中使用。
     * 当有订阅者时开始收集数据，无订阅者时延迟5秒停止收集以节省资源。
     * 
     * <span class="hljs-doctag">@param</span> scope 作用域，使用viewModelScope确保生命周期安全
     * <span class="hljs-doctag">@param</span> started 控制流的启动和停止策略，WhileSubscribed(5000)表示当有订阅时才收集，无订阅时延迟5秒停止
     * <span class="hljs-doctag">@param</span> initialValue 初始值，当还没有数据时使用的默认设置：主题为"light"，语言为空字符串，布尔值为false
     * <span class="hljs-doctag">@return</span> 返回一个StateFlow，包含Triple类型的用户设置数据（主题、语言、布尔标志）
     */</span>

<span class="hljs-keyword">val</span> themeModeFlow: Flow&lt;String&gt; = DataStoreManager.themeModeFlow.stateIn(
    scope = viewModelScope,
    started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
    initialValue = <span class="hljs-string">"light"</span>
)
<span class="hljs-comment">/**
* 所有设置监听
*/</span>
<span class="hljs-keyword">val</span> allSettingFlow: Flow&lt;Triple&lt;String, String, <span class="hljs-built_in">Boolean</span>&gt;&gt; = DataStoreManager.userSettingsFlow.stateIn(
    scope = viewModelScope,
    started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
    initialValue = Triple(<span class="hljs-string">"light"</span>, <span class="hljs-string">""</span>, <span class="hljs-literal">false</span>)
)
</code></pre>
<p>在UI界面（如Activity中）</p>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch {
    viewModel.allSettingFlow.collect { tripe -&gt;
        tvAllSetting?.text =
            <span class="hljs-string">"themeMode: <span class="hljs-subst">${tripe.first}</span>, userToken: <span class="hljs-subst">${tripe.second}</span>,  hasNewGuide: <span class="hljs-subst">${tripe.third}</span>"</span>
    }
}
</code></pre>
<h3 data-id="heading-6">2. Proto DataStore（结构化自定义对象支持）</h3>
<ul>
<li>定义 schema：</li>
</ul>
<pre><code class="hljs language-proto" lang="proto">// proto/user_prefs.proto
syntax = "proto3";

option java_package = "com.example.datastore";
option java_multiple_files = true;

message UserSettings {
  string user_id = 1;
  string nickname = 2;
  bool is_vip = 3;
  int32 login_count = 4;
}
</code></pre>
<ul>
<li>"Build" -&gt; "Make Project"生成 ”UserSetting.java“</li>
<li>增加序列化和反序列化工具类 “UserSettingsSerializer.kt”</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
* UserPrefsSerializer 是一个用于序列化和反序列化 UserPrefs 对象的工具类
* 实现了 Serializer 接口，提供默认值、读取和写入功能
*/</span>
<span class="hljs-keyword">object</span> UserSettingsSerializer: Serializer&lt;UserSettings&gt; {
   <span class="hljs-comment">/**
    * 获取 UserPrefs 的默认值
    * 当无法从输入流中解析数据时，将返回此默认值
    *
    * <span class="hljs-doctag">@return</span> 默认的 UserPrefs 对象，包含预设的用户信息
    */</span>
   <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> defaultValue: UserSettings
       <span class="hljs-keyword">get</span>() = UserSettings.newBuilder().build()

   <span class="hljs-comment">/**
    * 从输入流中读取并解析 UserPrefs 对象
    * 如果解析过程中发生异常，则返回默认值
    *
    * <span class="hljs-doctag">@param</span> input 输入流，包含序列化的 UserPrefs 数据
    * <span class="hljs-doctag">@return</span> 解析成功的 UserPrefs 对象，或在失败时返回默认值
    */</span>
   <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">readFrom</span><span class="hljs-params">(input: <span class="hljs-type">InputStream</span>)</span></span>: UserSettings {
       <span class="hljs-comment">// 尝试从输入流解析 UserPrefs 对象，如果失败则返回默认值</span>
       <span class="hljs-keyword">return</span> kotlin.runCatching {
           <span class="hljs-keyword">return</span> UserSettings.parseFrom(input)
       }.onFailure {
           <span class="hljs-keyword">return</span> defaultValue
       }.getOrNull() ?: defaultValue
   }

   <span class="hljs-comment">/**
    * 将 UserPrefs 对象序列化并写入到输出流中
    *
    * <span class="hljs-doctag">@param</span> t 要序列化的 UserPrefs 对象
    * <span class="hljs-doctag">@param</span> output 输出流，用于写入序列化的数据
    */</span>
   <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">writeTo</span><span class="hljs-params">(t: <span class="hljs-type">UserSettings</span>, output: <span class="hljs-type">OutputStream</span>)</span></span> {
       t.writeTo(output)
   }
}
</code></pre>
<ul>
<li>在 DataStoreManager 中添加扩展方法，当然你也可以在其他地方添加。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 此处是proto store扩展方法</span>
<span class="hljs-keyword">val</span> Context.userProtoDataStore: DataStore&lt;UserSettings&gt; <span class="hljs-keyword">by</span> dataStore(
    fileName = <span class="hljs-string">"user_settings.db"</span>,
    serializer = UserSettingsSerializer,
    corruptionHandler = ReplaceFileCorruptionHandler (
        produceNewData = { UserSettings.getDefaultInstance()}
    )
)
</code></pre>
<ul>
<li>监听DataStore暴露的Flow 接口<br/>
// DataStoreManager.kt</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> proDataStore = context.userProtoDataStore

<span class="hljs-comment">/**
 * 获取完整的用户偏好设置数据流。
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userSettingsFlow: Flow&lt;UserSettings&gt; = proDataStore.<span class="hljs-keyword">data</span>

<span class="hljs-comment">// 以下为各个字段对应的 Flow 数据流，便于单独监听某个属性的变化</span>

<span class="hljs-comment">/**
 * 用户 ID 的数据流。
 */</span>
<span class="hljs-keyword">val</span> userIdFlow = userSettingsFlow.map { it.userId }

<span class="hljs-comment">/**
 * 是否为 VIP 用户的数据流。
 */</span>
<span class="hljs-keyword">val</span> isVipFlow = userSettingsFlow.map { it.isVip }
</code></pre>
<p>此处监听了所有的参数，当时你也可以单独监听某一个参数，删除对应的<code>preferences[PreferencesKeys.HAS_NEW_GUIDE]</code> 即可。</p>
<h4 data-id="heading-7">使用方式</h4>
<p>使用方式与Preferences DataStore 相似，在Viewmodel和Activity可仿照Preferences DataStore 开发，此处不再赘述。</p>
<h3 data-id="heading-8">3.两者的区别（Preferences vs Proto）</h3>
<h5 data-id="heading-9">数据类型支持</h5>
<ul>
<li>Preferences DataStore:仅支持基本数据类型，适配存储简单配置信息</li>
<li>Proto DataStore：支持复杂数据结构，允许嵌套和列表等类型，但需要注意的是：<strong>建议不要用来存储复杂数据对象和大批量数据</strong></li>
</ul>
<h4 data-id="heading-10">类型安全</h4>
<ul>
<li>Preferences ：运行时检查，相对容易出错</li>
<li>Proto ：编译时检查，类型安全性更强</li>
</ul>
<h4 data-id="heading-11">性能表现</h4>
<ul>
<li>Preferences ：对简单数据访问更快</li>
<li>Proto：首次会有极轻微的序列化开销</li>
</ul>
<h4 data-id="heading-12">使用场景</h4>
<ul>
<li>Preferences ：用户设置、主体设置等简单状态</li>
<li>Proto ： 存储复杂的结构化数据</li>
</ul>
<h4 data-id="heading-13">官方建议</h4>
<p>Google 自己的 Google I/O 2024 App、Google Home、YouTube 等新项目，已经全部改用 Proto DataStore，连 Preferences 都不迁移了。</p>
<h3 data-id="heading-14">4.DataStore自动更新Flow的关键点</h3>

































<table><thead><tr><th>步骤</th><th>关键技术点</th></tr></thead><tbody><tr><td>数据写入</td><td>内存缓存 + 写磁盘 + 更新文件</td></tr><tr><td>检测文件变化</td><td>DataStore 通过文件监听（FileObserver/Inotify）检测到文件变更后，重新读取并发射新值</td></tr><tr><td>触发 Flow 更新</td><td>callbackFlow + observer → trySend 新数据</td></tr><tr><td>去重</td><td>distinctUntilChanged()</td></tr><tr><td>多进程支持</td><td>所有进程监听同一个文件路径</td></tr><tr><td>监听Flow变化</td><td>自动更新UI页面</td></tr></tbody></table>
<h2 data-id="heading-15">三、Room的基本使用</h2>
<p>当你需要存储大量数据和复杂的对象，建议使用Room</p>
<h3 data-id="heading-16">1、添加依赖、添加 ksp 插件</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.compose)
    alias(libs.plugins.proto)
    alias(libs.plugins.ksp) <span class="hljs-comment">//开启ksp</span>
}
android {
    <span class="hljs-comment">//其他代码请自行补充</span>
    
    kotlinOptions {
        jvmTarget = <span class="hljs-string">"11"</span>
        <span class="hljs-comment">// 关键：解决 KSP moduleName 报错</span>
        freeCompilerArgs += listOf(
            <span class="hljs-string">"-Xmodule-name=<span class="hljs-subst">${project.name}</span>"</span>  <span class="hljs-comment">// 或者用 ${project.name}</span>
        )
    }
}
ksp {
    arg(<span class="hljs-string">"room.schemaLocation"</span>, <span class="hljs-string">"<span class="hljs-variable">$projectDir</span>/schemas"</span>)
    arg(<span class="hljs-string">"room.incremental"</span>, <span class="hljs-string">"true"</span>)
    arg(<span class="hljs-string">"room.expandProjection"</span>, <span class="hljs-string">"true"</span>)
}

dependencies {
    <span class="hljs-comment">//其他依赖不在此列出</span>
    implementation (<span class="hljs-string">"androidx.room:room-runtime:2.6.1"</span>)
    implementation (<span class="hljs-string">"androidx.room:room-ktx:2.6.1"</span> )      <span class="hljs-comment">// coroutine + Flow 支持</span>
    ksp (<span class="hljs-string">"androidx.room:room-compiler:2.6.1"</span>)
}

</code></pre>
<p>libs.version.toml 相关代码如下</p>
<pre><code class="hljs language-kotlin" lang="kotlin">[plugins]
android-application = { id = <span class="hljs-string">"com.android.application"</span>, version = <span class="hljs-string">"8.7.2"</span> }
kotlin-android = { id = <span class="hljs-string">"org.jetbrains.kotlin.android"</span>, version = <span class="hljs-string">"2.0.0"</span> }
kotlin-compose = { id = <span class="hljs-string">"org.jetbrains.kotlin.plugin.compose"</span>, version = <span class="hljs-string">"2.0.0"</span> }
ksp = { id = <span class="hljs-string">"com.google.devtools.ksp"</span> , version = <span class="hljs-string">"2.0.0-1.0.21"</span>}
</code></pre>
<p>注意：Room、kotlin版本、ksp版本存在兼容性关联，可参照上述代码设置。</p>
<h3 data-id="heading-17">2、创建实体类（Entity）</h3>
<p>基础Dao的写法（注意13行的写法，返回Flow，推荐）<br/>
<strong>常用注解：</strong></p>
<ul>
<li>@Entity：表</li>
<li>@PrimaryKey：主键</li>
<li>@ColumnInfo(name = "xxx")：自定义列名</li>
<li>@Ignore：忽略该字段不存数据库<br/>
<code>data/room/UserEntity.kt</code></li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Entity(
    tableName = <span class="hljs-string">"user"</span>,
    //索引， 提高查询性能
    indices =
        [
            androidx.room.Index(
                value = [<span class="hljs-string">"email"</span>],
                unique = true
            )

        ]
)</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserEntity</span> (
    <span class="hljs-meta">@PrimaryKey(autoGenerate = true)</span> <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0</span>,
    <span class="hljs-keyword">val</span> username: String,
    <span class="hljs-keyword">val</span> phoneNum: String,
    <span class="hljs-keyword">val</span> email: String,
    <span class="hljs-keyword">val</span> createTime: <span class="hljs-built_in">Long</span> = System.currentTimeMillis(),
)
</code></pre>
<h3 data-id="heading-18">3、创建Dao接口（负责操作数据库）</h3>
<p><code>data/room/UserDao.kt</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Dao</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> {
    <span class="hljs-comment">//插入，返回新插入行的id，若id相同，则替换原数据</span>
    <span class="hljs-meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insert</span><span class="hljs-params">(userEntity: <span class="hljs-type">UserEntity</span>)</span></span>: <span class="hljs-built_in">Long</span>

    <span class="hljs-comment">//批量插入</span>
    <span class="hljs-meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insertAll</span><span class="hljs-params">( userEntity: <span class="hljs-type">List</span>&lt;<span class="hljs-type">UserEntity</span>&gt;)</span></span>

    <span class="hljs-comment">//使用Flow 来获取可观察的数据流，当表数据变更时自动发射数据</span>
    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * FROM user ORDER BY createTime DESC"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observerAll</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;UserEntity&gt;&gt;

    <span class="hljs-comment">//查询</span>
    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * FROM user"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryAll</span><span class="hljs-params">()</span></span>: List&lt;UserEntity&gt;

    <span class="hljs-comment">//查询指定用户</span>
    <span class="hljs-meta">@Query(<span class="hljs-string">"SELECT * FROM user WHERE username = :username"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryByUsername</span><span class="hljs-params">(username: <span class="hljs-type">String</span>)</span></span>: UserEntity?

    <span class="hljs-comment">//更新，也可以使用@Query注解</span>
    <span class="hljs-meta">@Update</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(userEntity: <span class="hljs-type">UserEntity</span>)</span></span>

    <span class="hljs-comment">//删除，推荐用Query注解代替@Delete注解</span>
    <span class="hljs-meta">@Query(<span class="hljs-string">"DELETE FROM user"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">deleteAll</span><span class="hljs-params">()</span></span>

    <span class="hljs-comment">//删除指定用户</span>
    <span class="hljs-meta">@Query(<span class="hljs-string">"DELETE FROM user WHERE email = :email"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">deleteByEmail</span><span class="hljs-params">(email: <span class="hljs-type">String</span>)</span></span>
    
    <span class="hljs-comment">// 使用 @Delete 注解的方式</span>
   <span class="hljs-meta">@Delete</span>
   <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">delete</span><span class="hljs-params">(userEntity: <span class="hljs-type">UserEntity</span>)</span></span>
}
</code></pre>
<h3 data-id="heading-19">3、创建数据库类</h3>
<p><code>data/room/AppDataBase.kt</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * AppDatabase 是一个抽象类，继承自 RoomDatabase，用于定义应用程序的数据库。
 * 它包含了数据库的配置信息以及获取 DAO 实例的方法。
 */</span>
<span class="hljs-meta">@Database(entities = [UserEntity::class], version = 1, exportSchema = true)</span>
<span class="hljs-meta">@TypeConverters(Converters::class)</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDatabase</span> : <span class="hljs-type">RoomDatabase</span>() {
    <span class="hljs-comment">/**
     * 获取 UserDao 实例的抽象方法。
     *
     * <span class="hljs-doctag">@return</span> UserDao 返回用户数据访问对象实例
     */</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userDao</span><span class="hljs-params">()</span></span>: UserDao

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">/**
         * 数据库单例实例，使用 volatile 关键字保证多线程环境下的可见性。
         */</span>
        <span class="hljs-meta">@Volatile</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> INSTANCE: AppDatabase? = <span class="hljs-literal">null</span>

        <span class="hljs-comment">/**
         * 获取 AppDatabase 单例实例的函数。
         * 使用双重检查锁定模式确保线程安全和高性能。
         *
         * <span class="hljs-doctag">@param</span> context 上下文对象，用于构建数据库
         * <span class="hljs-doctag">@return</span> AppDatabase 返回数据库实例
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: AppDatabase =
            INSTANCE ?: synchronized(<span class="hljs-keyword">this</span>) {
                INSTANCE ?: buildDatabase(context).also { INSTANCE = it }
            }

        <span class="hljs-comment">/**
         * 构建 AppDatabase 实例的私有函数。
         * 配置数据库名称并创建数据库构建器。
         *
         * <span class="hljs-doctag">@param</span> context 上下文对象
         * <span class="hljs-doctag">@return</span> AppDatabase 返回新构建的数据库实例
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildDatabase</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: AppDatabase {
            <span class="hljs-keyword">return</span> Room.databaseBuilder(context.applicationContext, AppDatabase::<span class="hljs-keyword">class</span>.java, <span class="hljs-string">"app_db"</span>)
                <span class="hljs-comment">// 添加 Migration,升级使用。</span>
                <span class="hljs-comment">//.addMigrations(MIGRATION_1_2)</span>
                .build()
        }
    }
}
</code></pre>
<h3 data-id="heading-20">4、额外的数据转换（非必选）</h3>
<p><code>data/room/Converters.kt</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 时间转换器类，用于在数据库实体和Java Date对象之间进行转换
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Converters</span> {
    <span class="hljs-comment">/**
     * 将时间戳转换为Date对象
     *
     * <span class="hljs-doctag">@param</span> value 时间戳值，以毫秒为单位
     * <span class="hljs-doctag">@return</span> 返回对应的Date对象，如果输入为空则返回当前时间的Date对象
     */</span>
    <span class="hljs-meta">@TypeConverter</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fromTimestamp</span><span class="hljs-params">(value: <span class="hljs-type">Long</span>?)</span></span>: Date = value?.let { Date(it) } ?: Date()

    <span class="hljs-comment">/**
     * 将Date对象转换为时间戳
     *
     * <span class="hljs-doctag">@param</span> date 要转换的Date对象
     * <span class="hljs-doctag">@return</span> 返回对应的时间戳，以毫秒为单位
     */</span>
    <span class="hljs-meta">@TypeConverter</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dateToTimestamp</span><span class="hljs-params">(date: <span class="hljs-type">Date</span>)</span></span>: <span class="hljs-built_in">Long</span> = date.time
}
</code></pre>
<p>完成这几步后，我们在Application 中调用<code>AppDatabase.getInstance(this)</code>后，就创建了一个名为”app_db“的数据库，里面包含了一张名为”user“的表</p>
<h3 data-id="heading-21">5、小技巧：如何查看数据库</h3>
<p>Android studio：App Inspection -&gt;Database Inspector</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/509999e65ac84523a50fed1277255b5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-C5a6_5Zub5Y2X5rKz5LiJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765250594&amp;x-signature=YQ%2FrqBnuOSp%2B0bPc8IjyMIyoYJ0%3D" alt="截屏2025-11-27 下午7.37.06.png" loading="lazy"/></p>
<h3 data-id="heading-22">6、Room版本升级</h3>
<p>随着业务的变化，需要增加字段，那就涉及到数据库版本升级。步骤如下：</p>
<ul>
<li>A、调整建表语句,增加列“age” 默认为0</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entity</span>(
    tableName = <span class="hljs-string">"user"</span>,
    indices =
        [
            androidx.room.<span class="hljs-built_in">Index</span>(
                value = [<span class="hljs-string">"email"</span>],
                unique = true
            )

        ]
)
data class UserEntity (
    <span class="hljs-variable">@PrimaryKey</span>(autoGenerate = true) val <span class="hljs-attribute">id</span>: Long = <span class="hljs-number">0</span>,
    val <span class="hljs-attribute">username</span>: String,
    val <span class="hljs-attribute">phoneNum</span>: String,
    val <span class="hljs-attribute">email</span>: String,
    val <span class="hljs-attribute">age</span>: Int = <span class="hljs-number">0</span>,
    val <span class="hljs-attribute">createTime</span>: Long = System.<span class="hljs-built_in">currentTimeMillis</span>(),
)
</code></pre>
<ul>
<li>B、增加数据库版本号（原版本号X+1）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Database(entities = [UserEntity::class], version = 2, exportSchema = true)</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDatabase</span> : <span class="hljs-type">RoomDatabase</span>() {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li>C、添加迁移策略（MIGRATION_X_(X+1)）</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> MIGRATION_1_2 = <span class="hljs-keyword">object</span> : Migration(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">migrate</span><span class="hljs-params">(db: <span class="hljs-type">SupportSQLiteDatabase</span>)</span></span> {
        <span class="hljs-comment">// 执行数据库结构变更SQL, 增加名为age列</span>
        db.execSQL(<span class="hljs-string">"ALTER TABLE user ADD COLUMN age INTEGER NOT NULL DEFAULT 0"</span>)
    }
}
</code></pre>
<ul>
<li>D、数据库构建时添加迁移策略，使用X_（X+1）升级策略</li>
</ul>

<pre><code class="hljs language-css" lang="css">Room<span class="hljs-selector-class">.databaseBuilder</span>(context, AppDatabase::class.java, <span class="hljs-string">"app_db"</span>)
    .<span class="hljs-built_in">addMigrations</span>(MIGRATION_1_2)
    .<span class="hljs-built_in">build</span>()
</code></pre>
<p>升级踩坑点：</p>
<ul>
<li>1、新增列时需要注意：<code>Room默认数据库列必须是NOT NULL，除非显示声明可空</code>。<br/>
Int类型必须在新增列时同时声明 <code>NOT NULL DEFAULT 0</code>，否则已有旧数据那一行 age 就是 NULL，会和新的实体类定义（age不为空）冲突 → Room 直接抛 IllegalStateException 拒绝启动。</li>
<li>2<code>“DEFAULT 0”</code> 确保在迁移过程中，已存在的记录会获得默认值0.</li>
<li>3、Android Sqlite其实不支持删除列、修改列等操作，具体情况请参照下表</li>
</ul>



































<table><thead><tr><th>操作</th><th>SQL 关键写法</th><th>是否要重建表</th></tr></thead><tbody><tr><td>新增可空列</td><td>ADD COLUMN xxx TYPE</td><td>否</td></tr><tr><td>新增非空列</td><td>ADD COLUMN xxx TYPE NOT NULL DEFAULT xxx</td><td>否（最常用）</td></tr><tr><td>新增唯一索引</td><td>CREATE UNIQUE INDEX index_xxx ON table(col)</td><td>否</td></tr><tr><td>删除列 / 改列属性</td><td>必须重建表（CREATE → INSERT → DROP → RENAME）</td><td>是</td></tr><tr><td>改表名</td><td>必须重建表</td><td>是</td></tr></tbody></table>
<ul>
<li>4、我的小建议：
<code>尽量不要修改删除已有的列，可新增列，废弃原有的列即可，降低升级风险。</code></li>
</ul>
<h2 data-id="heading-23">四、Room + Flow：复杂关系型数据的最佳实践</h2>
<h3 data-id="heading-24">1. Repository 层统一暴露Flow（结合网络获取+ 本地加载）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 封装数据源，可使用数据库及网络数据源
 *
 * <span class="hljs-doctag">@param</span> api 网络API服务接口
 * <span class="hljs-doctag">@param</span> userDao 本地数据库DAO接口
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> api: ApiService, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userDao: UserDao) {
    <span class="hljs-comment">/**
     * 用户数据流，结合网络和本地数据源
     * 首先加载本地数据，然后请求网络数据更新本地数据库，最后监听数据库变化实时更新
     * 暴露给Viewmodel的统一数据源
     */</span>
    <span class="hljs-keyword">val</span> userFlow: Flow&lt;Resource&lt;List&lt;UserEntity&gt;&gt;&gt; = flow {
        emit(Resource.Loading())

        <span class="hljs-keyword">val</span> localData = userDao.queryAll()
        <span class="hljs-keyword">if</span> (localData.isNotEmpty()) {
            emit(Resource.Success(localData))
        }

        <span class="hljs-comment">// 请求网络数据并同步到本地数据库</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> netData = api.getUsers()
            <span class="hljs-keyword">val</span> entity = netData.map {
                UserEntity(
                    id = <span class="hljs-keyword">if</span> (it.id &gt; <span class="hljs-number">0</span>) it.id.toLong() <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>, <span class="hljs-comment">// 0 时让数据库自动生成</span>
                    username = it.username,
                    phoneNum = it.phone,
                    email = it.email
                )
            }
            userDao.insertAll(entity)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-keyword">val</span> cached = userDao.queryAll()
            emit(Resource.Error(e.message ?: <span class="hljs-string">"网络请求失败"</span>, <span class="hljs-keyword">data</span> = cached))
        }
        
        <span class="hljs-comment">// 监听数据库变化，自动刷新UI</span>
        emitAll(
            userDao.observerAll()
                .map&lt;List&lt;UserEntity&gt;, Resource&lt;List&lt;UserEntity&gt;&gt;&gt; { list -&gt; Resource.Success(list) }
                .<span class="hljs-keyword">catch</span> { t -&gt; emit(Resource.Error(t.message ?: <span class="hljs-string">"数据库读取失败"</span>)) }
        )


    }   
        .flowOn(Dispatchers.IO)


    <span class="hljs-comment">/**
     * 添加用户到数据库
     *
     * <span class="hljs-doctag">@param</span> userEntity 要添加的用户实体
     * <span class="hljs-doctag">@return</span> 插入记录的ID
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addUser</span><span class="hljs-params">(userEntity: <span class="hljs-type">UserEntity</span>)</span></span>: <span class="hljs-built_in">Long</span> = userDao.insert(userEntity)

    <span class="hljs-comment">/**
     * 更新数据库中的用户信息
     *
     * <span class="hljs-doctag">@param</span> userEntity 包含更新信息的用户实体
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(userEntity: <span class="hljs-type">UserEntity</span>)</span></span> = userDao.update(userEntity)

    <span class="hljs-comment">/**
     * 根据邮箱删除用户
     *
     * <span class="hljs-doctag">@param</span> email 要删除用户的邮箱地址
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">deleteUser</span><span class="hljs-params">(email: <span class="hljs-type">String</span>)</span></span> = userDao.deleteByEmail(email)

    <span class="hljs-comment">/**
     * 根据用户名查询用户
     *
     * <span class="hljs-doctag">@param</span> userName 要查询的用户名
     * <span class="hljs-doctag">@return</span> 查询到的用户实体，如果不存在则返回null
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserByEmail</span><span class="hljs-params">(userName: <span class="hljs-type">String</span>)</span></span>: UserEntity? = userDao.queryByUsername(userName)

    <span class="hljs-comment">/**
     * 删除所有用户数据
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">deleteAll</span><span class="hljs-params">()</span></span> = userDao.deleteAll()
}
</code></pre>
<h3 data-id="heading-25">2.封装Resource状态（非必须，但建议）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 密封类 Resource 用于表示数据加载状态的通用包装类
 *
 */</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Resource</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">val</span>  message: String? = <span class="hljs-literal">null</span>
) {
    <span class="hljs-comment">/**
     * Loading 子类表示数据正在加载状态
     *
     * <span class="hljs-doctag">@param</span> T 泛型参数，表示包装的数据类型
     * <span class="hljs-doctag">@param</span> data 加载过程中可能存在的旧数据，可为空
     */</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Loading</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">data</span>: T? = <span class="hljs-literal">null</span>) : Resource&lt;T&gt;(<span class="hljs-keyword">data</span>)

    <span class="hljs-comment">/**
     * Success 子类表示数据加载成功状态
     *
     * <span class="hljs-doctag">@param</span> T 泛型参数，表示包装的数据类型
     * <span class="hljs-doctag">@param</span> data 成功加载的数据，不可为空
     */</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">data</span>: T?) : Resource&lt;T&gt;(<span class="hljs-keyword">data</span>)

    <span class="hljs-comment">/**
     * Error 子类表示数据加载失败状态
     *
     * <span class="hljs-doctag">@param</span> T 泛型参数，表示包装的数据类型
     * <span class="hljs-doctag">@param</span> message 错误信息，不可为空
     * <span class="hljs-doctag">@param</span> data 加载失败时可能存在的部分数据，可为空
     */</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>&lt;<span class="hljs-type">T</span>&gt;(message: String, <span class="hljs-keyword">data</span>: T? = <span class="hljs-literal">null</span>) : Resource&lt;T&gt;(<span class="hljs-keyword">data</span>, message)
}
</code></pre>
<h3 data-id="heading-26">3.Viewmodel调用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * RoomViewModel类用于管理用户数据的UI状态和业务逻辑
 * <span class="hljs-doctag">@param</span> repository 用户数据仓库，用于执行数据操作
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomViewModel</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository): ViewModel() {
    <span class="hljs-comment">/**
     * 用户UI状态的流，将仓库中的用户数据流转换为UI状态流
     * 根据数据加载状态显示不同的UI状态（加载中、成功、错误）
     */</span>
    <span class="hljs-keyword">val</span> users: StateFlow&lt;UserUiState&gt; = repository.userFlow.map { resource -&gt;
        <span class="hljs-keyword">when</span> (resource) {
            <span class="hljs-keyword">is</span> Resource.Success -&gt; UserUiState(userList = resource.<span class="hljs-keyword">data</span>)
            <span class="hljs-keyword">is</span> Resource.Error -&gt; UserUiState(userList = resource.<span class="hljs-keyword">data</span>, error = resource.message)
            <span class="hljs-keyword">is</span> Resource.Loading -&gt; UserUiState(isLoading = <span class="hljs-literal">true</span>, userList = resource.<span class="hljs-keyword">data</span>)
        }
    }.stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        initialValue = UserUiState(isLoading = <span class="hljs-literal">true</span>)
    )

    <span class="hljs-comment">/**
     * 刷新用户数据
     * 重新从仓库获取最新的用户数据流
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            repository.userFlow.first()
        }
    }

    <span class="hljs-comment">/**
     * 添加新用户
     * <span class="hljs-doctag">@param</span> userEntity 要添加的用户实体对象
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addUser</span><span class="hljs-params">(userEntity: <span class="hljs-type">UserEntity</span>)</span></span> {
        viewModelScope.launch {
            repository.addUser(userEntity)
        }
    }

    <span class="hljs-comment">/**
     * 删除指定邮箱的用户
     * <span class="hljs-doctag">@param</span> email 要删除用户的邮箱地址
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">deleteUser</span><span class="hljs-params">(email: <span class="hljs-type">String</span>)</span></span> {
        viewModelScope.launch {
            repository.deleteUser( email)
        }
    }

    <span class="hljs-comment">/**
     * 清空所有用户数据
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearUser</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            repository.deleteAll()
        }
    }

}

<span class="hljs-comment">/**
 * 用户界面状态数据类
 * <span class="hljs-doctag">@param</span> isLoading 是否正在加载数据
 * <span class="hljs-doctag">@param</span> userList 用户列表数据
 * <span class="hljs-doctag">@param</span> error 错误信息
 */</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserUiState</span>(
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">val</span> userList: List&lt;UserEntity&gt;? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>
)
</code></pre>
<p>相关知识点讲解：</p>
<blockquote>
<p><code>repository.userFlow</code> 是用户数据流，由 UserRepository发射。其中<code>map</code>将上游数据流（Resource 类型的对象）转化成我们UI状态流（UserUiState）。使用stateIn将其转换为StateFlow以便在ViewModel中使用。UI界面通过接收UI状态流自动刷新界面。</p>
</blockquote>
<p>stateIn 三个参数的使用说明：</p>
<ul>
<li>
<ol>
<li>scope = viewModelScope<br/>
作用域参数：指定状态流的生命周期范围<br/>
功能：当 viewModelScope 取消时，状态流也会被取消<br/>
意义：确保 users 状态流与 RoomViewModel 的生命周期绑定，避免内存泄漏</li>
</ol>
</li>
<li>
<ol start="2">
<li>started = SharingStarted.WhileSubscribed(5000)<br/>
启动策略参数：控制流的共享和订阅行为<br/>
功能：当有订阅者时开始收集数据，无订阅者时延迟5000毫秒停止收集<br/>
意义：优化性能，在无UI订阅时暂停数据收集，有新订阅时重新开始</li>
</ol>
</li>
<li>
<ol start="3">
<li>initialValue = UserUiState(isLoading = true)<br/>
初始值参数：设置状态流的初始状态<br/>
功能：流创建时立即发射的默认值<br/>
意义：确保UI在首次订阅时能立即获得加载状态，提供良好的用户体验
这三个参数共同确保了状态流的生命周期管理、性能优化和用户体验。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-27">4.Activity调用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observeData</span><span class="hljs-params">()</span></span> {
    lifecycleScope.launch {
        viewModel.users.collect { state -&gt;
            <span class="hljs-keyword">when</span>  {
                state.isLoading &amp;&amp; state.userList == <span class="hljs-literal">null</span> -&gt; {
                    <span class="hljs-comment">//加载中</span>
                }
                <span class="hljs-keyword">else</span> -&gt; {
                <span class="hljs-comment">//设置Recycleview数据源</span>
                    state.userList?.let { adapter.setData(it) }

                    state.error?.let {
                        Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@RoomActivity</span>, <span class="hljs-string">"网络错误"</span>, Toast.LENGTH_LONG).show()
                    }
                }
            }
        }
    }

}
</code></pre>
<h3 data-id="heading-28">5.Room 自动更新的 6 个关键点（必须全部命中才触发）</h3>








































<table><thead><tr><th>关键点</th><th>具体实现</th><th>缺一不可的原因</th></tr></thead><tbody><tr><td>1. 返回 Flow / LiveData / Flowable</td><td>只有这三种返回值 Room 才会开启自动刷新机制</td><td>普通 suspend 函数不会监听</td></tr><tr><td>2. @Query（不能是 @Insert/@Update/@Delete）</td><td>只有 @Query 会被 Room 解析出它监听了哪些表</td><td>Room 要知道你关心哪些表</td></tr><tr><td>3. 数据库真的发生变更</td><td>INSERT、UPDATE、DELETE、REPLACE、事务批量操作等</td><td>只读查询不会触发</td></tr><tr><td>4. 变更的表在 @Query 里出现过</td><td>Room 会解析你的 SQL，提取 FROM/JOIN/UPDATE 等涉及的表名</td><td>表没出现在 SQL 里，Room 认为你不关心</td></tr><tr><td>5. 事务已经提交（commit）</td><td>触发器只在事务真正提交后才执行</td><td>未提交的事务不算变更</td></tr><tr><td>6. 同一个 Database 实例</td><td>多进程下需要启用 multi-instance invalidation（Android 9+）才行</td><td>不同进程默认互不感知</td></tr></tbody></table>
<h3 data-id="heading-29">总结：Room 自动更新的核心一句话</h3>
<blockquote>
<p>Room 在建库时默默地为每一个表创建了 INSERT/UPDATE/DELETE 触发器， 触发器通知 InvalidationTracker → 失效哪些 @Query → 重新执行并发射到 Flow/LiveData。</p>
</blockquote>
<p>这套机制比 DataStore 的 FileObserver 更精准、更高效（毫秒级、无轮询），也是为什么普遍认为“Room + Flow” 是目前 Android 最优雅的本地数据库自动刷新方案。</p>
<h2 data-id="heading-30">四、Room和Proto DataStore的选择</h2>
<p>Google 官方给出的“红线”建议：</p>



































<table><thead><tr><th>数据类型</th><th>推荐存储方式</th><th>原因</th></tr></thead><tbody><tr><td>简单配置、开关、Token、主题等</td><td>DataStore（首选）</td><td>轻量、类型安全、协程支持</td></tr><tr><td>任何 List、复杂对象 &gt; 50 条</td><td>Room</td><td>支持分页、局部更新、索引</td></tr><tr><td>用户信息、设置项（单对象）</td><td>DataStore（可以）</td><td>但建议字段不要超过 30 个</td></tr><tr><td>任何需要分页加载的数据</td><td>Room + Paging 3</td><td>DataStore 完全无法实现</td></tr><tr><td>离线缓存、商品列表、订单记录</td><td>Room</td><td>必选</td></tr></tbody></table>
<h3 data-id="heading-31">什么时候真的可以用 Proto DataStore 存“稍复杂对象”？</h3>
<p>可以，但必须同时满足以下全部条件：</p>
<ol>
<li>对象足够小（强烈建议 &lt; 50KB）</li>
<li>更新频率低 <strong>&lt; 10 次/分钟</strong></li>
<li>永远不会变成列表（哪怕现在只有一个字段，未来可能扩也别用）</li>
<li>不需要对内部字段做查询、分页、排序</li>
</ol>
<p>满足以上才可以用，否则立刻改用 Room。</p>
<h3 data-id="heading-32">总结一句话：</h3>
<blockquote>
<p><strong>DataStore 是一个“配置中心”，不是“数据库”。</strong> 把它当数据库用，就相当于用 SharedPreferences 存 1000 条 JSON 一样（能跑，但一定卡的你怀疑人生）。</p>
</blockquote>
<p>其他相关的界面不再列出，如需要请下载源码查看。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何理解 Golang 中的 Context?]]></title>    <link>https://juejin.cn/post/7578767608631099392</link>    <guid>https://juejin.cn/post/7578767608631099392</guid>    <pubDate>2025-12-02T03:37:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578767608631099392" data-draft-id="7578794217961504808" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何理解 Golang 中的 Context?"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-12-02T03:37:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武大打工仔"/> <meta itemprop="url" content="https://juejin.cn/user/165361397016000"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何理解 Golang 中的 Context?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/165361397016000/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武大打工仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:37:16.000Z" title="Tue Dec 02 2025 03:37:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>理解 <code>cancelCtx</code> 的源码，其实就是理解 Go 语言如何优雅地处理<strong>并发控制</strong>和<strong>信号广播</strong>。</p>
<p>Go 的 <code>context</code> 源码在 <code>src/context/context.go</code> 中，代码量不多（不到 600 行），但设计非常精妙。核心逻辑可以归纳为三个关键词：<strong>挂载（Mount）、广播（Broadcast）、递归（Recursion）</strong>。</p>
<p>我们分三步来拆解 <code>cancelCtx</code> 的底层原理。</p>
<hr/>
<h3 data-id="heading-0">1 第一步：数据结构 —— 它是怎么长的？</h3>
<p><code>cancelCtx</code> 是一个结构体，它继承了父 Context，同时自己维护了一套“家谱”关系。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 源码简化版</span>
<span class="hljs-keyword">type</span> cancelCtx <span class="hljs-keyword">struct</span> {
    Context             <span class="hljs-comment">// 1. 嵌入父 Context，保证能调用父类方法</span>
    mu       sync.Mutex <span class="hljs-comment">// 2. 互斥锁，保证并发安全（保护下面的字段）</span>
    done     <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{} <span class="hljs-comment">// 3. 核心！用来发信号的 Channel</span>
    children <span class="hljs-keyword">map</span>[canceler]<span class="hljs-keyword">struct</span>{} <span class="hljs-comment">// 4. 存自己的“孩子”，以便取消时通知它们</span>
    err      <span class="hljs-type">error</span>      <span class="hljs-comment">// 5. 记录取消原因（Canceled 还是 DeadlineExceeded）</span>
}
</code></pre>
<ul>
<li><strong><code>done</code></strong>：这是一个 <code>chan struct{}</code>。这利用了 Go 的一个特性：<strong>当一个 channel 被 close（关闭）时，所有监听这个 channel 的 goroutine 都会收到信号（读到零值）。</strong> 这就是它的“广播”机制。</li>
<li><strong><code>children</code></strong>：这是一个 Set（用 Map 实现）。当父节点取消时，它需要遍历这个 Map，把所有的子节点也干掉。</li>
</ul>
<hr/>
<h3 data-id="heading-1">2 第二步：挂载机制 —— 如何与父节点建立联系？</h3>
<p>当你调用 <code>context.WithCancel(parent)</code> 时，核心逻辑在于如何把自己“挂”到父节点的 <code>children</code> 列表里。</p>
<p>这主要依赖于内部函数 <code>propagateCancel</code>（传播取消）。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancel</span><span class="hljs-params">(parent Context)</span></span> (ctx Context, cancel CancelFunc) {
    c := newCancelCtx(parent) <span class="hljs-comment">// 创建自己</span>
    propagateCancel(parent, &amp;c) <span class="hljs-comment">// 【关键】把自己挂到父节点上</span>
    <span class="hljs-keyword">return</span> &amp;c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { c.cancel(<span class="hljs-literal">true</span>, Canceled) }
}
</code></pre>
<p><strong><code>propagateCancel</code> 的逻辑如下：</strong></p>
<ol>
<li><strong>判断父节点状态</strong>：如果父节点 <code>parent.Done()</code> 已经是 nil（永远不会取消，比如 <code>Background()</code>），那就不用挂了，因为父亲永远不死。如果父亲已经死了，直接提前  <code>cancel</code> 并返回；</li>
</ol>
<pre><code class="hljs language-go" lang="go">	done := parent.Done()
	<span class="hljs-keyword">if</span> done == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-comment">// parent is never canceled</span>
	}

	<span class="hljs-keyword">select</span> {
	<span class="hljs-keyword">case</span> &lt;-done:
		<span class="hljs-comment">// parent is already canceled</span>
		child.cancel(<span class="hljs-literal">false</span>, parent.Err(), Cause(parent))
		<span class="hljs-keyword">return</span>
	<span class="hljs-keyword">default</span>:
	}
</code></pre>
<ol start="2">
<li><strong>查找祖先</strong>：它会尝试找到最近的、也就是标准的 <code>*cancelCtx</code> 类型的祖先。</li>
</ol>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-keyword">if</span> p, ok := parentCancelCtx(parent); ok {
		<span class="hljs-comment">// parent is a *cancelCtx, or derives from one.</span>
		p.mu.Lock()
		<span class="hljs-keyword">if</span> err := p.err.Load(); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-comment">// parent has already been canceled</span>
			child.cancel(<span class="hljs-literal">false</span>, err.(<span class="hljs-type">error</span>), p.cause)
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">if</span> p.children == <span class="hljs-literal">nil</span> {
				p.children = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[canceler]<span class="hljs-keyword">struct</span>{})
			}
			p.children[child] = <span class="hljs-keyword">struct</span>{}{}
		}
		p.mu.Unlock()
		<span class="hljs-keyword">return</span>
	}
</code></pre>
<ol start="3">
<li><strong>判断是否实现了 <code>afterFuncer</code> 接口</strong>：</li>
</ol>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-keyword">if</span> a, ok := parent.(afterFuncer); ok {
		<span class="hljs-comment">// parent implements an AfterFunc method.</span>
		c.mu.Lock()
		stop := a.AfterFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
			child.cancel(<span class="hljs-literal">false</span>, parent.Err(), Cause(parent))
		})
		c.Context = stopCtx{
			Context: parent,
			stop:    stop,
		}
		c.mu.Unlock()
		<span class="hljs-keyword">return</span>
	}
</code></pre>
<ol start="4">
<li><strong>挂载</strong>：</li>
</ol>
<ul>
<li><strong>如果找到了亲爹（Go 标准库的 Context）</strong>：加锁，把自己塞到父亲的 <code>children</code> map 里。</li>
</ul>
<pre><code class="hljs language-go" lang="go">	<span class="hljs-keyword">if</span> a, ok := parent.(afterFuncer); ok {
		<span class="hljs-comment">// parent implements an AfterFunc method.</span>
		c.mu.Lock()
		stop := a.AfterFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
			child.cancel(<span class="hljs-literal">false</span>, parent.Err(), Cause(parent))
		})
		c.Context = stopCtx{
			Context: parent,
			stop:    stop,
		}
		c.mu.Unlock()
		<span class="hljs-keyword">return</span>
	}
</code></pre>
<ul>
<li><strong>如果父亲是外人（比如自定义的 Context）</strong>：没办法直接操作它的 map。于是启动一个 Goroutine，在那傻傻地监听 <code>parent.Done()</code>。一旦父亲 Done 了，这个 Goroutine 就负责把自己干掉。</li>
</ul>
<pre><code class="hljs language-go" lang="go">	goroutines.Add(<span class="hljs-number">1</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">select</span> {
		<span class="hljs-keyword">case</span> &lt;-parent.Done():
			child.cancel(<span class="hljs-literal">false</span>, parent.Err(), Cause(parent))
		<span class="hljs-keyword">case</span> &lt;-child.Done():
		}
	}()
</code></pre>
<hr/>
<h3 data-id="heading-2">3 第三步：取消机制 —— 信号是如何传播的？</h3>
<p>源码中的 <code>cancel</code> 方法（简化版逻辑）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// removeFromParent: 是否需要把自己从父亲的 map 中移除</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span></span> cancel(removeFromParent <span class="hljs-type">bool</span>, err <span class="hljs-type">error</span>) {
    c.mu.Lock()
    <span class="hljs-keyword">if</span> c.err != <span class="hljs-literal">nil</span> { <span class="hljs-comment">// 如果已经取消过了，直接返回</span>
        c.mu.Unlock()
        <span class="hljs-keyword">return</span>
    }
    c.err = err <span class="hljs-comment">// 记录错误原因</span>

    <span class="hljs-comment">// 1. 【核心动作】关闭 channel！</span>
    <span class="hljs-comment">// 此时，所有监听 &lt;-ctx.Done() 的协程都会瞬间收到信号</span>
    <span class="hljs-keyword">if</span> c.done == <span class="hljs-literal">nil</span> {
        c.done = closedchan
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">close</span>(c.done)
    }

    <span class="hljs-comment">// 2. 【递归通知】遍历所有孩子，挨个调用它们的 cancel</span>
    <span class="hljs-keyword">for</span> child := <span class="hljs-keyword">range</span> c.children {
        <span class="hljs-comment">// 递归调用孩子的 cancel 方法</span>
        <span class="hljs-comment">// 注意：这里传 false，意思是孩子不需要从我这里移除（因为我自己都要没了，大家一起销毁）</span>
        child.cancel(<span class="hljs-literal">false</span>, err) 
    }
    c.children = <span class="hljs-literal">nil</span> <span class="hljs-comment">// 释放 map，利用 GC 回收内存</span>
    c.mu.Unlock()

    <span class="hljs-comment">// 3. 【断绝关系】把自己从父亲的 map 里删掉</span>
    <span class="hljs-comment">// 避免父亲一直持有我的引用，导致内存泄漏</span>
    <span class="hljs-keyword">if</span> removeFromParent {
        removeChild(c.Context, c)
    }
}
</code></pre>
<h3 data-id="heading-3">4 总结：Context 的生命周期图解</h3>
<p>假设有这样一个调用链：<code>CtxA (根)</code> -&gt; <code>CtxB</code> -&gt; <code>CtxC</code>。</p>
<ol>
<li>
<p><strong>建立连接</strong>：</p>
<ul>
<li><code>CtxB</code> 创建时，将自己放入 <code>CtxA.children</code>。</li>
<li><code>CtxC</code> 创建时，将自己放入 <code>CtxB.children</code>。</li>
</ul>
</li>
<li>
<p><strong>触发取消</strong> (<code>CtxB.cancel()</code> 被调用)：</p>
<ul>
<li><strong>自身</strong>：<code>CtxB</code> 关闭自己的 <code>done</code> channel。所有监听 <code>CtxB</code> 的代码收到停止信号。</li>
<li><strong>向下（递归）</strong>：<code>CtxB</code> 遍历 <code>children</code>，找到 <code>CtxC</code>，调用 <code>CtxC.cancel()</code>。于是 <code>CtxC</code> 也关闭 <code>done</code> channel。</li>
<li><strong>向上（清理）</strong>：<code>CtxB</code> 调用 <code>removeChild</code>，让 <code>CtxA</code> 把 <code>CtxB</code> 从 map 中删掉。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-4">5 补充</h3>
<blockquote>
<p>我们主动调用 <code>cancel</code> 的时候，<code>removeFromParent</code> 是不是传 <code>true</code> ？</p>
</blockquote>
<p><strong>回答：是的</strong></p>
<p>当我们我们在业务代码中调用那个由 <code>context.WithCancel</code>（或 <code>WithTimeout</code>、<code>WithDeadline</code>）返回的 <code>cancel()</code> 函数时，传入 <code>removeFromParent</code> 的参数确实是 <strong><code>true</code></strong>。</p>
<p>这一步非常关键，它是防止 <strong>Context 树内存泄漏</strong> 的核心手段。</p>
<p>我们来看一下源码验证，顺便对比一下什么时候传 <code>false</code>。</p>
<hr/>
<h4 data-id="heading-5">1. 证据：源码中的入口</h4>
<p>当你调用 <code>context.WithCancel</code> 时，源码是这样写的：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// src/context/context.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancel</span><span class="hljs-params">(parent Context)</span></span> (ctx Context, cancel CancelFunc) {
	c := newCancelCtx(parent)
	propagateCancel(parent, &amp;c) <span class="hljs-comment">// 把自己挂到父亲节点</span>
	
	<span class="hljs-comment">// 【注意看这里】</span>
	<span class="hljs-comment">// 返回的闭包函数，硬编码了 true</span>
	<span class="hljs-keyword">return</span> &amp;c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { c.cancel(<span class="hljs-literal">true</span>, Canceled) }
}
</code></pre>
<p><strong>解析：</strong>
这里的 <code>func() { c.cancel(true, Canceled) }</code> 就是你拿到的那个 <code>cancel</code> 函数。
当你调用它时，你告诉 <code>cancelCtx</code>：“<strong>我已经干完活了（或者想终止了），请把我从父亲的 <code>children</code> 列表中移除。</strong>”</p>
<p>如果这里不传 <code>true</code>，父节点就会一直保留着指向这个子节点的引用，直到父节点自己被取消。如果父节点是一个全局的 <code>Background</code> 或者生命周期很长的 Context，那么这些早已死掉的子节点就会一直堆积在内存里，导致内存泄漏。</p>
<hr/>
<h4 data-id="heading-6">2. 对比：什么时候传 <code>false</code>？</h4>
<p>在 <code>cancel</code> 方法内部，当它递归去取消自己的 <strong>子节点</strong> 时，传的是 <code>false</code>。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// src/context/context.go -&gt; cancel 方法内部</span>

<span class="hljs-comment">// ... 前面是关闭 channel 的逻辑</span>

<span class="hljs-comment">// 遍历所有的孩子</span>
<span class="hljs-keyword">for</span> child := <span class="hljs-keyword">range</span> c.children {
    <span class="hljs-comment">// 【注意看这里】</span>
    <span class="hljs-comment">// 父亲取消孩子时，传的是 false</span>
    child.cancel(<span class="hljs-literal">false</span>, err) 
}
c.children = <span class="hljs-literal">nil</span> <span class="hljs-comment">// 父亲直接清空整个 map</span>
c.mu.Unlock()

<span class="hljs-comment">// 如果 removeFromParent 为 true，才去调用 removeChild</span>
<span class="hljs-keyword">if</span> removeFromParent {
    removeChild(c.Context, c)
}
</code></pre>
<p><strong>为什么这里传 <code>false</code>？这是一个性能优化的设计。</strong></p>
<p>想象一下这个场景：</p>
<ol>
<li>父节点取消了。</li>
<li>父节点需要通知它下面的 1000 个子节点也取消。</li>
<li>父节点遍历这 1000 个子节点，调用它们的 <code>cancel</code>。</li>
<li><strong>关键点</strong>：父节点在通知完所有孩子后，紧接着有一行 <code>c.children = nil</code>，它会直接把整个“孩子名册”撕碎丢进垃圾桶。</li>
</ol>
<p>如果此时给子节点传 <code>true</code>，那么这 1000 个子节点每一个都会回头去抢父节点的锁（<code>c.Context</code>），试图从父节点的 map 中删除自己。
但在父节点看来：“<strong>你们不用一个个来辞职了，反正整个部门我都要裁掉，名单我已经准备销毁了。</strong>”</p>
<p>所以，传 <code>false</code> 避免了成百上千次无意义的锁竞争和 Map 删除操作。</p>
<p><strong>总结：</strong></p>
<ul>
<li><strong>主动调用（外部触发）</strong>：<code>removeFromParent = true</code>。因为只有这一个节点要走，必须精准地从父节点的名单里删掉，防止内存泄漏。</li>
<li><strong>级联取消（内部递归）</strong>：<code>removeFromParent = false</code>。因为父节点随后会直接清空整个名单，子节点不需要自己去注销。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[二、Kotlin数组（Array）]]></title>    <link>https://juejin.cn/post/7578780780027199497</link>    <guid>https://juejin.cn/post/7578780780027199497</guid>    <pubDate>2025-12-02T03:36:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578780780027199497" data-draft-id="7578732288516620339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="二、Kotlin数组（Array）"/> <meta itemprop="keywords" content="Android,APP"/> <meta itemprop="datePublished" content="2025-12-02T03:36:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            二、Kotlin数组（Array）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:36:03.000Z" title="Tue Dec 02 2025 03:36:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数组是一种初始化时指定容器大小，不可以动态调整其大小的容器。元素按顺序存储在一串连续的内存段上</p>
<h2 data-id="heading-0">一、数组的创建</h2>
<p><code>1、arrayOf创建数组</code>
创建一个数组并传递元素值给它,集合中的元素可以是任意类型</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span>  array = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>)
<span class="hljs-comment">/// 元素可以是任意类型</span>
<span class="hljs-keyword">var</span> array2 = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-literal">true</span>,<span class="hljs-string">"2"</span>)

<span class="hljs-keyword">var</span> array3: Array&lt;<span class="hljs-built_in">Int</span>&gt; =  arrayOf(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
<span class="hljs-keyword">var</span> array4: Array&lt;Any&gt; = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-literal">true</span>,<span class="hljs-string">"2"</span>)
</code></pre>
<p><code>2、arrayOfNulls创建数组</code>
创建一个指定大小的、所有元素都为空的数组，但必须指定集合中的元素类型</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">// 创建一个指定大小的，所有元素都为空的数组</span>
<span class="hljs-keyword">var</span> arrayOfNUlls = arrayOfNulls&lt;String&gt;(<span class="hljs-number">5</span>)
arrayOfNUlls[<span class="hljs-number">0</span>] = <span class="hljs-string">"dd"</span>
arrayOfNUlls[<span class="hljs-number">1</span>] = <span class="hljs-string">"33"</span>
</code></pre>
<p><code>3、动态创建数组（一般用不到）</code>用接受数组大小以及一个方法参数的 Array 构造方法，用作参数的方法能够返回给定索引的每个元素初始值:</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建一个 Array&lt;String&gt; 初始化为["0”，“1”，“4"，"9”，"16"</span>
<span class="hljs-selector-tag">var</span> array = <span class="hljs-built_in">Array</span>(<span class="hljs-number">5</span>){
    it -&gt; (it * it)<span class="hljs-selector-class">.toString</span>()
}
</code></pre>
<h2 data-id="heading-1">二、原生类型数组</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aad2eb07b4ce42eeba83d71831c7e184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251362&amp;x-signature=Kl7Aonx1gKtt7QhF2Hvplvn9YVU%3D" alt="图片.png" loading="lazy"/></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">/// 字节数组</span>
<span class="hljs-keyword">var</span> bytes = ByteArray(size = <span class="hljs-number">5</span>)
bytes[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>

<span class="hljs-comment">/// IntArray</span>
<span class="hljs-keyword">var</span> ints = IntArray(size = <span class="hljs-number">5</span>)
ints[<span class="hljs-number">0</span>] = <span class="hljs-number">2</span>

<span class="hljs-comment">/// 注意这里it是它索引下标值，所以这是创建一个长度为5的IntArray[0，2，4，6，8]</span>
<span class="hljs-keyword">var</span> intarray = IntArray(size = <span class="hljs-number">5</span>){it * <span class="hljs-number">2</span>}
</code></pre>
<h2 data-id="heading-2">三、数组遍历</h2>
<p><code>1、for循环--元素遍历</code></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">var</span> a = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
<span class="hljs-keyword">for</span> (item <span class="hljs-keyword">in</span> a){
    println(item)
}
</code></pre>
<p><code>2、for循环--下标遍历</code></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">var</span> a = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
<span class="hljs-keyword">for</span> (index <span class="hljs-keyword">in</span> a.indices){
    println(index.toString() + <span class="hljs-string">"-&gt;"</span> + a[index])

    <span class="hljs-comment">/**
     * 0-&gt;1
     * 1-&gt;3
     * 2-&gt;3
     * 3-&gt;4
     * 4-&gt;5
     */</span>
}
</code></pre>
<p><code>3、for循环--遍历元素(带索引)</code></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span> = <span class="hljs-built_in">arrayOf</span>(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
for ((index, item ) in <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.withIndex</span>()){
    <span class="hljs-built_in">println</span>("$index -&gt; $item")

    <span class="hljs-comment">/**
     * 0 -&gt; 1
     * 1 -&gt; 3
     * 2 -&gt; 3
     * 3 -&gt; 4
     * 4 -&gt; 5
     */</span>
}
</code></pre>
<p><code>4、forEach遍历数组</code></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">var</span> a = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
a.forEach { it
    println(it) <span class="hljs-comment">// it指的是元素 1 3 3 4 5</span>
}
</code></pre>
<p><code>5、forEach增强版</code></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">var</span> a = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
a.forEachIndexed { index, i -&gt;
    println(<span class="hljs-string">"<span class="hljs-variable">$index</span> -&gt; <span class="hljs-variable">$i</span>"</span>)
    <span class="hljs-comment">/**
     * 0 -&gt; 1
     * 1 -&gt; 3
     * 2 -&gt; 3
     * 3 -&gt; 4
     * 4 -&gt; 5
     */</span>
}
</code></pre>
<h2 data-id="heading-3">四、数组翻转</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span> = arrayOf(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.reverse</span>()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 从入门到删库跑路，保姆级教程！]]></title>    <link>https://juejin.cn/post/7578803751609319474</link>    <guid>https://juejin.cn/post/7578803751609319474</guid>    <pubDate>2025-12-02T03:36:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578803751609319474" data-draft-id="7578732288516669491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 从入门到删库跑路，保姆级教程！"/> <meta itemprop="keywords" content="数据库,MySQL,程序员"/> <meta itemprop="datePublished" content="2025-12-02T03:36:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 从入门到删库跑路，保姆级教程！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:36:28.000Z" title="Tue Dec 02 2025 03:36:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是小阿巴，刚入行的程序员。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/292d9b1940494e1584e8e8e919443ef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=ltqR24ewc254aOzFaOvBuoQZp9s%3D" alt="" loading="lazy"/></p>
<p>这天，你接到一个私活：帮学校做个学生管理系统，要能管理学生信息、记录成绩、统计数据。</p>
<p>你一听，这不简单吗？用 Java 写个程序，把数据存到 Map 里就搞定了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentManagementSystem</span> {
   <span class="hljs-comment">// 使用 Map 存储学生信息，key 为学号，value 为学生信息字符串</span>
   <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Integer</span>, <span class="hljs-title class_">String</span>&gt; studentMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
   <span class="hljs-comment">// 添加学生</span>
   <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addStudent</span>(<span class="hljs-params">int studentNo, <span class="hljs-built_in">String</span> name, double score, int classId</span>) {
       <span class="hljs-title class_">String</span> studentInfo = name + <span class="hljs-string">","</span> + score + <span class="hljs-string">","</span> + classId;
       studentMap.<span class="hljs-title function_">put</span>(studentNo, studentInfo);
  }
   <span class="hljs-comment">// 查询学生</span>
   <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getStudent</span>(<span class="hljs-params">int studentNo</span>) {
       <span class="hljs-keyword">return</span> studentMap.<span class="hljs-title function_">get</span>(studentNo);
  }
   <span class="hljs-comment">// 查询所有学生</span>
   <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">listAllStudents</span>(<span class="hljs-params"/>) {
       <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Map</span>.<span class="hljs-property">Entry</span>&lt;<span class="hljs-title class_">Integer</span>, <span class="hljs-title class_">String</span>&gt; entry : studentMap.<span class="hljs-title function_">entrySet</span>()) {
           <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"学号："</span> + entry.<span class="hljs-title function_">getKey</span>() +
                   <span class="hljs-string">"，信息："</span> + entry.<span class="hljs-title function_">getValue</span>());
      }
  }
}
</code></pre>
<p>结果一周后，甲方指着你的鼻子骂道：狗阿巴，我录入的 500 个学生信息怎么全没了？！</p>
<p>你一查，原来昨晚服务器重启了，导致内存里的数据全部丢失！</p>
<p>你汗流浃背了：看来我得把数据保存到硬盘上……</p>
<p>于是你连夜改代码，把数据存到了文本文件里，这下数据就不会丢失了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aea5c5d0c264d1c9965051377eceb37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=LpSM6BbFfy3dCko%2FPXD%2FkIMq2%2FU%3D" alt="" loading="lazy"/></p>
<p>但接下来，甲方提出了各种不同的查询数据需求，每个需求你都得写一堆代码逻辑，让你越来越头大。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45d4b74385f64eaaa52ad5597753e618~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=HnxwHDrDMyJgVjXaP5R0HhTJ4BI%3D" alt="" loading="lazy"/></p>
<p>于是你找到号称 “后端之狗” 的鱼皮求助：有没有更好的办法管理数据啊？</p>
<p>鱼皮笑了笑：当然要用数据库啦！</p>
<p>你一脸懵：数据库？那是啥？</p>
<p>⭐️ 推荐观看本文对应视频版：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbilibili.com%2Fvideo%2FBV1iJSLBbEyD" target="_blank" title="https://bilibili.com/video/BV1iJSLBbEyD" ref="nofollow noopener noreferrer">bilibili.com/video/BV1iJ…</a></p>
<h2 data-id="heading-0">第一阶段：认识数据库</h2>
<p>鱼皮：数据库就像一个超级 Excel 表格，可以存储管理海量数据、快速灵活地查询和筛选数据、在多个服务器间共享数据、并且能够精确控制数据的读写权限。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ef05207f18c4fcf96931b3703aae6be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=g31rNwZUWy57Crgi7%2FINf0SJ59k%3D" alt="" loading="lazy"/></p>
<p>你恍然大悟：啊，所以我应该用数据库来管理学生信息。🤡</p>
<p>鱼皮：没错，绝大多数项目的数据都存在数据库里，因此数据库是后端程序员的必备技能。</p>
<p>数据库主要分 2 大类：</p>
<p>1）关系型数据库，比如 MySQL、Oracle、PostgreSQL，适合存储相互之间有关联的数据，比如学生和班级、订单和商品。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/652d4579995b49b9bb0901425fd5c89d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=8rJSMlRd2067vg1xLPXTukg9ASI%3D" alt="" loading="lazy"/></p>
<p>2）非关系型数据库，比如 Redis（主要用于缓存和高速读写）、MongoDB（文档型数据库），它们在数据结构和使用场景上更灵活。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b5a952152104c9c93f10d649641f90e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=umliZE6jujIY%2BJtz2%2FmH%2F9weK1Q%3D" alt="" loading="lazy"/></p>
<p>你：这么多数据库，我该学哪个呢？</p>
<p>鱼皮：<strong>建议新手从 MySQL 开始</strong>，因为它是主流的、容易入门的、开源的关系型数据库。</p>
<p>你：那还等什么，MySQL，启动！</p>
<p>鱼皮：别急，在学之前，得先了解几个数据库的基本概念。</p>
<p>1）数据库管理系统（DBMS）：顾名思义就是用来管理数据库的系统，比如 MySQL。它把数据存储在硬盘上，断电也不会丢失。</p>
<p>2）数据库：一个 MySQL 系统可以管理多个数据库，比如每个项目一个库（学生系统一个库、订单系统一个库），互不干扰。</p>
<p>3）表：一个数据库可以有多张数据表，用来存储某一类数据。</p>
<p>4）记录：表由一行行记录组成，每一行就是一条数据</p>
<p>5）字段：每一列对应一个字段，具有名称和类型。比如姓名字段是文本类型、年龄字段是数字类型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7981b681f6c147d8b18d076edaceda72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=1h%2B9835Gq%2Bk8R2O%2FtgXbZNf72IY%3D" alt="" loading="lazy"/></p>
<p>6）关联</p>
<p>这是关系型数据库的核心，表和表之间是有联系的，主要有 3 种关系。</p>
<p>1 对 1：比如学生表和学生档案表，一个学生对应一份档案</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49e876c2f991463bbac77197fcff55f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=4w6HKjGto7ks89kTGXpikZoHSlM%3D" alt="" loading="lazy"/></p>
<p>1 对多：比如班级表和学生表，一个班级有多个学生</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44763965c1124123bc0ef427d339a2ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=rplTkPxVD4%2FAlJRCHotr7T0%2Bd9k%3D" alt="" loading="lazy"/></p>
<p>多对多：比如学生表和课程表，一个学生可以选多门课，一门课也可以被多个学生选</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6d9c4548bdc42f29f96eb32a3c9415c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=vguqvhJa%2FOOPEtphDzmRDt%2BcAgU%3D" alt="" loading="lazy"/></p>
<p>这些表和表之间的关联形成了完整的业务系统。</p>
<p>你想了想：对哦，也就是说我可以根据学生关联查询到所属的班级和选修的课程。</p>
<p>那怎么操作数据库呢？</p>
<p>鱼皮：这就要用到 SQL 了。</p>
<p>SQL 是专门用来操作数据库的 <strong>结构化查询语言</strong>（Structured Query Language）。</p>
<p>你可以用 SQL 实现各种查询，比如：</p>
<p>1）查询所有学生：<code>SELECT * FROM student;</code></p>
<p>2）只查询属于某个班级的学生：<code>SELECT * FROM student WHERE class_id = 1;</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ae46348fb74083a6c850700205c538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=zhq7Sp6Ozm8KXEAI%2BISi%2B3Pd7mQ%3D" alt="" loading="lazy"/></p>
<p>3）分组统计每个班级中所有学生的平均成绩：<code>SELECT class_id, AVG(score) FROM student GROUP BY class_id;</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca00747ea3ff4adab4e3ae002e4a293b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=QjgwO3MBea9PJD2yibkZ0wDwHC4%3D" alt="" loading="lazy"/></p>
<p>4）还可以同时查询学生表和班级表，并把结果关联在一起：<code>SELECT s.name, c.class_name FROM student s JOIN class c ON s.class_id = c.id;</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd735302f724562a57010e906731910~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=juPD8fN6r6gYmmhxZsa%2Bx4KH84g%3D" alt="" loading="lazy"/></p>
<p>此外，不同的数据库管理系统（比如 MySQL、Oracle、SQL Server）有自己的 “方言”，操作这些数据库的 SQL 会有一点点小差别。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cac81bbbe174950bec56bf9b21186d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=E9uLkao44AAPB3pzZVTFknmbwrg%3D" alt="" loading="lazy"/></p>
<p>你：天呐，相当于我要多学一门语言，而且还要学方言！</p>
<p>鱼皮：别担心，SQL 的核心语法都是通用的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55420b860ef747a48ddac01bdf3aacb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=Hsd4U%2Bi9%2BMx6%2Fpv84QOg22TeZlA%3D" alt="" loading="lazy"/></p>
<p>而且你现在只需要知道 SQL 是用来操作数据库的就够了，</p>
<p>有时间再到我开发的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsqlmother.yupi.icu%2F" target="_blank" title="https://sqlmother.yupi.icu/" ref="nofollow noopener noreferrer">免费 SQL 学习网站</a> 边练边学，而且后续我还会出视频专门讲 SQL 哦。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea3a3b55ff58420597f6a75d10854283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=uJ3Vkkmr5WqwLhcITL8oIrdvDhk%3D" alt="" loading="lazy"/></p>
<p>你：关注了关注了~</p>
<p>鱼皮：那接下来咱们就开始实战学习吧，先把 MySQL 装上并且操作一波。</p>
<h2 data-id="heading-1">第二阶段：实战应用</h2>
<h3 data-id="heading-2">基础操作</h3>
<p>机智如你，直接打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdownloads%2Fmysql%2F" target="_blank" title="https://dev.mysql.com/downloads/mysql/" ref="nofollow noopener noreferrer">官网</a> 下载了 MySQL 数据库，并且成功安装运行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a817af0fb6ab465a91466e8d3aa2e5c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=onj4IUaIUCdU7Sac6%2FgZnuCI5ZE%3D" alt="" loading="lazy"/></p>
<p>但是怎么操作 MySQL 呢？</p>
<p>鱼皮：可以使用官方提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.4%2Fen%2Fmysql.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.4/en/mysql.html" ref="nofollow noopener noreferrer">命令行工具</a>，先输入命令，输入默认设置的用户名和密码，就能连上数据库并进行操作了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40dc74efe26a4ef48df43c66bd723ea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=rPTQQQ6yj6kJQcv40Fl4y%2F1XX1k%3D" alt="" loading="lazy"/></p>
<p>你：root 是什么？</p>
<p>鱼皮：root 是数据库的超级管理员账号，拥有所有权限。</p>
<p>不过命令行看着不直观，我建议你装个 MySQL 可视化工具（比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.navicat.com%2Fen%2Fproducts%2Fnavicat-premium-lite" target="_blank" title="https://www.navicat.com/en/products/navicat-premium-lite" ref="nofollow noopener noreferrer">Navicat</a>、DataGrip），能像使用 Excel 一样管理数据库，数据一目了然。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efb245c9bbdf40f6895b2bfe08587e7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=zv3q5wn6L%2FFiosqqWFy7ZqzvEUQ%3D" alt="" loading="lazy"/></p>
<p>你：哇，确实方便多了！</p>
<p>鱼皮：接下来我带你实际操作一遍，用数据库来管理学生信息。</p>
<p>1）首先连接数据库</p>
<p>点击左上角创建连接，选择数据库的类别，然后输入数据库配置信息，点击确认，就连接成功了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bff15744a2a4c769b16e6e64c1ae481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=p4kMGwkOPgMOOkKwuc7WJ6jPnmw%3D" alt="" loading="lazy"/></p>
<p>2）然后来创建一个数据库</p>
<p>右键点击数据库连接，选择 “新建数据库”，命名为 school，点击确认，就创建成功了。</p>
<p>对应的 SQL 语句是 <code>CREATE DATABASE school;</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ade6dc6231a4fa5822d4253929b844f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=RavhRga%2F3XPYYrondxqkS66PUEE%3D" alt="" loading="lazy"/></p>
<p>3）接下来我们要创建表</p>
<p>鱼皮：想一想，如果要设计一个存储学生信息的表，需要哪些字段？</p>
<p>你：学号、姓名、成绩、班级。</p>
<p>鱼皮：没错，每个字段还要指定类型。</p>
<ul>
<li>学号用 int 整数类型</li>
<li>姓名用 varchar 文本类型</li>
<li>成绩用 decimal 小数类型（保留 2 位小数）</li>
<li>班级用 int 整数类型（表示班级编号）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a13b4108410b4ddf857ba20319d1165e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=RArKzQI8SrZj4QuVUrd%2FwOgSJMk%3D" alt="" loading="lazy"/></p>
<p>除了类型，创建表时还要设置一些 <strong>约束</strong>，比如：</p>
<ul>
<li>主键：每条数据的唯一标识，一般建议每个表单独加一列 id 字段，作为主键</li>
<li>非空：某些字段不能为空，比如姓名不能为空</li>
<li>唯一：值不能重复，比如每个学号都是唯一的</li>
<li>外键：建立表之间的关联关系，比如学生表的 class_id 可以设为外键，关联到班级表的 id，保证数据的完整性。但实际开发中外键存在性能问题，用的没那么多。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e120ce6538a242ea98cbf84e8a1d133d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=VyR9vcXbGLMl9086JRr8FiUgf6w%3D" alt="" loading="lazy"/></p>
<p>设计好表结构之后，点击保存，数据表就创建成功了。</p>
<p>对应的 SQL 语句类似这样：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> student (
  id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,  # 主键，自动递增
  student_no <span class="hljs-type">INT</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,     # 学号，唯一且非空
  name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,          # 姓名，非空
  score <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">5</span>,<span class="hljs-number">2</span>),                 # 成绩，最多 <span class="hljs-number">5</span> 位数字，<span class="hljs-number">2</span> 位小数
  class_id <span class="hljs-type">INT</span>                        # 班级编号
);
</code></pre>
<p>4）然后我们就可以操作数据表了。主要有 4 类核心操作 —— 增删改查。</p>
<p>先插入几条学生数据：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> student (student_no, name, score, class_id) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2024001</span>, <span class="hljs-string">'小阿巴'</span>, <span class="hljs-number">95.5</span>, <span class="hljs-number">1</span>);
</code></pre>
<p>然后查询所有学生数据：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3d59e29e2164815b728b661e2956aa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=b2S9%2Bqa8mqrNIB4jKXUWwUtAoEA%3D" alt="" loading="lazy"/></p>
<p>修改某条数据，把你的成绩改成满分：</p>
<pre><code class="hljs language-ini" lang="ini">UPDATE student SET <span class="hljs-attr">score</span> = <span class="hljs-number">100</span> WHERE student_<span class="hljs-literal">no</span> = <span class="hljs-number">2024001</span><span class="hljs-comment">;</span>
​
SELECT * FROM student<span class="hljs-comment">;</span>
</code></pre>
<p>最后删除某条数据：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> student_no <span class="hljs-operator">=</span> <span class="hljs-number">2024001</span>;
​
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994432c05f8941c1b32cc05c8a505781~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=L%2FvCui949qK90IliH%2FWAHnLV3bc%3D" alt="" loading="lazy"/></p>
<p>鱼皮：注意，删除掉的数据就再也找不回来了！</p>
<p>因此实际项目中建议使用 <strong>逻辑删除</strong>，就是加个 <code>is_deleted</code> 字段来标记数据是否失效，而不是真的删除数据，这样即使误删也能恢复。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/608b6f42772b4d81be7f6ee3acca18f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=4x6jcSIwQaa8sSaKgxOOF9TpVbA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">客户端操作</h3>
<p>你很是兴奋：用可视化工具真方便啊，但是我怎么用代码操作数据库呢？</p>
<p>鱼皮：主流编程语言都有操作数据库的 SDK，比如使用 Java 的 JDBC，需要先加载对应数据库的驱动、然后获取连接、编写 SQL 语句并执行、最后收集结果并关闭连接。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1640398a5eac48df869e9a4e582ceb56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=%2BYAJogZtwCF%2BPz2X2gx%2B5aLzRjE%3D" alt="" loading="lazy"/></p>
<p>你挠了挠头：我就查询 1 次数据库，都要写这么多代码么？而且我根本不会写 SQL 语句啊！</p>
<p>鱼皮笑道：没关系，实际开发中我们会使用 <strong>ORM 对象关系映射框架</strong>，可以把数据库的表映射成 Java 对象，像操作对象一样操作数据库。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331faef8eeeb49cfad3c563cf6cfbc28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=7dsiojb5c3QsLcQA5f446y4X1Q0%3D" alt="" loading="lazy"/></p>
<p>比如 Java 的 MyBatis 框架，可以让你用更简洁的方式执行 SQL：</p>
<pre><code class="hljs language-ini" lang="ini">// MyBatis 方式：只需要写 SQL，框架自动处理连接和结果映射
Student <span class="hljs-attr">student</span> = studentMapper.selectByStudent<span class="hljs-literal">No</span>(<span class="hljs-number">2024001</span>)<span class="hljs-comment">;</span>
System.out.println(student.getName())<span class="hljs-comment">;</span>
</code></pre>
<p>还有它的增强版 MyBatis Plus 和 MyBatis Flex，提供了更多开箱即用的功能，连 SQL 都不用写！直接调用现成的方法，几行代码就能实现增删改查，告别 SQL Boy！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c9ba2c2cd0b4cf2b928c2e9d446c2ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=Xr9fOs%2BLjdvWFJZmiikSd6ngijc%3D" alt="" loading="lazy"/></p>
<p>你感叹道：这才是人写的代码啊！优雅，真是优雅~</p>
<p>鱼皮提醒道：但是，框架不是万能的，有些复杂查询的 SQL 还要自己手写，不过现在有 AI 了，写个 SQL 还不是手拿把掐的？</p>
<p>你：明白了，我这就用框架重写学生管理系统。</p>
<h2 data-id="heading-4">第三阶段：数据库特性</h2>
<h3 data-id="heading-5">索引</h3>
<p>一个月后，你重写的学生管理系统正式上线，不仅得到了甲方的好评，而且很快火遍了全国高校。</p>
<p>你内心暗爽：数据库也不过如此嘛~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/038cb4882a46430d813eab9a84ffdbd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=c5TyGy70rvTDHtou3kDwR5k25QI%3D" alt="" loading="lazy"/></p>
<p>但你没想到，随着学生数据量的暴涨和表结构的扩展，你的数据库查询速度也越来越慢，光是查询某个班级的学生竟然都要等好几秒！</p>
<p>你有些惊讶：我这 SQL 也不复杂啊，怎么查询这么慢？</p>
<p>鱼皮：加个索引试试？</p>
<p>你：索引？那是啥？</p>
<p>鱼皮：索引就是数据库的目录。你现在查数据，数据库得一行一行全表扫描，数据量越大速度越慢。加了索引后，数据库可以通过索引快速定位到数据，就像通过书的目录快速翻到某一页。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f80cdfdf1446caa2483ce5afc5c9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=MOXFxeDz2GpPK0Wi0XwTi%2BbjxZQ%3D" alt="" loading="lazy"/></p>
<p>你恍然大悟：对啊，老师经常按班级查询学生，不妨给班级字段添加索引。</p>
<pre><code class="hljs language-scss" lang="scss">CREATE INDEX idx_class_id ON <span class="hljs-built_in">student</span>(class_id);
</code></pre>
<p>添加索引后，你再次测试查询，竟然只要几十毫秒！</p>
<p>你激动得跳了起来：索引太香了，我要给所有字段都加索引~</p>
<p>鱼皮摆摆手：别，索引可不是越多越好！</p>
<p>你愣住了：为啥？</p>
<p>鱼皮：索引虽然能加快查询，但也有代价。</p>
<ul>
<li>一方面会增加写入数据（增删改）的开销。因为每次写入数据，索引也要更新。</li>
<li>此外，索引本身也是数据，要占用更多的存储空间。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8442a4732b6b466caf9ec3b69eda8236~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=UxQJKSwpT26AqJ4NoULtOGNzPQQ%3D" alt="" loading="lazy"/></p>
<p>所以，要在经常用来查询、并且数据区分度高的字段上合理添加索引。比如班级 ID、学号这种字段适合加索引，但性别字段（只有男女两个值）就不适合。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73849c8befa646ba82e289ca70126818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=%2F1jOWZg2N6b06fRp572sOznXgtk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">事务</h3>
<p>又过了几天，甲方又提新需求了。</p>
<p>甲方：小阿巴，有老师反馈题目判错了，需要批量把所有学生的成绩都加 5 分。</p>
<p>你信心满满：简单，不就是个批量更新操作么？</p>
<p>你写了一段代码，循环更新所有学生的成绩。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78ab9cd7c93c49ca95d354c352c6fc35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=vrHr1dSrOAg6liLchsGxOUFXMsw%3D" alt="" loading="lazy"/></p>
<p>没想到，越自信 Bug 越多，功能刚刚上线，就收到了投诉：怎么有些学生的成绩改了，有些没改？</p>
<p>你查看了下日志，发现前面学生的成绩更新成功了，但由于网络波动，导致后面的学生都没更新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cabdacbf6174b1ebf59d367e626b146~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=wLZcKNsynlAo1phRPOi9lehrzGM%3D" alt="" loading="lazy"/></p>
<p>你急坏了：咋办，这样就不公平了啊！</p>
<p>鱼皮看了看你的代码：这是典型的数据一致性问题，你需要用 <strong>事务</strong> 来解决。</p>
<p>你：啥是事务？</p>
<p>鱼皮：事务就是把多个操作捆绑在一起，要么全部成功，要么全部失败。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1af41983b73f431c8e6e0f0e8fb2bf7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=AwmHxnsiZRj8nVlesOLkVwuaxcQ%3D" alt="" loading="lazy"/></p>
<p>就像你给别人投币，你扣除硬币和对方增加硬币必须同时成功，不能让硬币凭空消失对吧？</p>
<p>你：对对对，那批量改成绩也是，要么所有学生都加 5 分，要么都不加。</p>
<p>鱼皮：没错，数据库事务有 4 个特性，简称 ACID：</p>
<ul>
<li>原子性（<strong>A</strong>tomicity）：要么全做，要么全不做。</li>
<li>一致性（<strong>C</strong>onsistency）：数据从一个正确状态到另一个正确状态。比如转账时，A 扣钱和 B 加钱的总和不变。</li>
<li>隔离性（<strong>I</strong>solation）：多个事务互不干扰。</li>
<li>持久性（<strong>D</strong>urability）：事务完成后，数据永久保存。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a67f41234b24743b4d09e9af4a93bd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=yN9LcsI2F2STXVC%2F7j5PbCJSuow%3D" alt="" loading="lazy"/></p>
<p>你：那怎么使用事务呢？</p>
<p>鱼皮：如果直接用原始的 JDBC，需要手动控制事务，比较麻烦。</p>
<p>但如果在 Spring 框架中，只需要加一个 <code>@Transactional</code> 注解就搞定了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac10eec07d9446f8ee71d80891478db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=qyArtlJ9Z4Gsyg8SZGqAipAZRwk%3D" alt="" loading="lazy"/></p>
<p>Spring 会自动帮你管理事务。如果中间任何一步出错，抛出了指定的异常，整个事务会自动回滚，将数据恢复到原来的状态，保证要么所有学生都加分成功，要么都不加。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5f650017b474311855a700178c01ede~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=c0mH%2BCahVr7dWVvlsgF6goR%2BZMM%3D" alt="" loading="lazy"/></p>
<p>你：原来这么简单啊，我这就用事务重写代码！</p>
<h3 data-id="heading-7">其他</h3>
<p>鱼皮：MySQL 还有一些其他特性，比如视图可以用来简化复杂查询、存储过程可以批量执行 SQL、触发器可以自动触发操作。</p>
<p>1）视图：视图是一个虚拟表，把复杂查询封装起来重复使用。比如你经常要统计每个班级的平均成绩，每次都写一长串 SQL 太麻烦，可以创建一个视图，以后直接查视图就行。</p>
<p>2）存储过程：可以批量执行 SQL。比如每天定时同步数据，写个存储过程，定时调用就行。</p>
<p>3）触发器：可以自动触发操作。比如每次添加用户，自动生成一条操作日志，不用手动写代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddaef57fb4284ef38a8ba2a338ff9f89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=U4AqewIwr20YHF%2F5p0Kx9rhIIGA%3D" alt="" loading="lazy"/></p>
<p>你感叹道：原来数据库还有这么多功能，我学不完了啊……</p>
<p>鱼皮笑了：别担心，这些在实际开发中用得不多，先简单了解就好。</p>
<h2 data-id="heading-8">第四阶段：生产环境实践</h2>
<p>几年后，你已经成为小有名气的 “学生管理系统大师”，还成立了自己的工作室。</p>
<p>没事儿就对着新来的实习生阿坤吹牛皮：你阿巴哥我啊，精通数据库，索引、事务耍的贼溜儿~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/896729eb81e8412385ed3ed4bf357c99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=NCLsPCFN7PJ3Mh66MBkfaWvm6Tw%3D" alt="" loading="lazy"/></p>
<p>然而某天上午，学校的运维同学打来电话：阿巴阿巴，系统出问题了，所有操作都一直 <strong>转圈、超时</strong>！ 好像是数据库卡死了！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0547a2d3b2343b6aaf5a61935e4a909~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=72iQj%2FHA2pFYORlrpupo87SeFkk%3D" alt="" loading="lazy"/></p>
<p>你大惊：什么？！我都加索引了，还能卡死？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4abdc5429c5e474697967f9845cb784e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=kuIK6F6L5k6Q6t%2F8SO8fwlO8FSY%3D" alt="" loading="lazy"/></p>
<p>emmm…… 对了，我想到了！</p>
<p>赶紧重启数据库，重启解决所有问题！嘿嘿嘿哈哈哈哈~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1614ecd8ab40422d8782af42cf6d03ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=fs2EkgpkOxAPUPXmzAhwtceohts%3D" alt="" loading="lazy"/></p>
<p>结果重启没多久，数据库又卡死了！</p>
<p>你彻底懵了：呜呜呜，怎么办啊！</p>
<p>这时，你身旁的阿坤突然鸡叫起来：我来！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57a8f3d59fe449ea97dcc88ef33c5a36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=oXc0V5ambGcLmrqmdXCfjTkeSDE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">为什么系统会崩溃？</h3>
<p>阿坤：我们先看看为什么系统会崩溃？</p>
<p>开启 MySQL 的慢查询日志功能，有两种方式。</p>
<p>1）通过 SQL 命令（临时开启）</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 开启慢查询日志功能</span>
SET GLOBAL <span class="hljs-attr">slow_query_log</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
​
<span class="hljs-comment"># 设置慢查询阈值（超过几秒算是慢查询）</span>
SET GLOBAL <span class="hljs-attr">long_query_time</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
​
<span class="hljs-comment"># 修改日志文件位置（可选）</span>
SET GLOBAL <span class="hljs-attr">slow_query_log_file</span> = <span class="hljs-string">'/path/to/slow.log'</span><span class="hljs-comment">;</span>
</code></pre>
<p>2）修改配置文件（永久生效）</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 在 [mysqld] 部分设置参数</span>
<span class="hljs-attr">slow_query_log</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">long_query_time</span> = <span class="hljs-number">5</span>
<span class="hljs-attr">slow_query_log_file</span> = /path/to/slow.log
</code></pre>
<p>你看，有些 SQL 语句执行了几十秒！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50bee8d15d2d4f7aba615e7c3420c421~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=5rlwgKJP3XhRrzF61FhxrVsD6mY%3D" alt="" loading="lazy"/></p>
<p>使用 Explain 命令分析下这些查询，原来没有正确使用索引，导致了全表扫描，把数据库拖垮了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3944e76185b84100a02a690dd79fc8e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=qhf3F%2FcERS7EaGm6gP34Euq6mhY%3D" alt="" loading="lazy"/></p>
<p>这些慢查询就是罪魁祸首，它们会 <strong>长时间霸占数据库连接和 CPU 资源</strong>。当大量用户同时执行慢查询，数据库连接池很快被耗尽，新的请求因为无法获取连接、全部阻塞，导致数据库 “卡死”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/832c50d6b9954a1f81c93efa65561c66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=kqi%2FtnuxKX9VaBh%2F4KCBb30snVE%3D" alt="" loading="lazy"/></p>
<p>你惭愧地低下头：我知道了，生产环境一定要开启慢查询日志，及时发现慢 SQL 并优化。</p>
<h3 data-id="heading-10">数据丢失了怎么办？</h3>
<p>屋漏偏逢连夜雨，你很快又收到了投诉，说是有的学生数据丢失了！</p>
<p>你很是疑惑：MySQL 不是有日志（Redo Log 和 Binlog）来保证数据持久性吗？怎么会丢数据呢？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dd27b25219d48b29497060bc1561a28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=uv1BWwHDNLLCDh6CyPhoqbUtc54%3D" alt="" loading="lazy"/></p>
<p>经过排查，原来是服务器的硬盘被一个学生不小心踹坏了！</p>
<p>你难受得像持矢了一样：真是人在家中坐，Bug 天上来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0265b6463088402bbdd9bcaea415c887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=0UDtfD0fKXggmnjUrwXyohrPZfs%3D" alt="" loading="lazy"/></p>
<p>唉，我怎么把数据找回来啊？</p>
<p>阿坤：别怕，幸好鱼皮哥之前设置了备份。一方面定期做 <strong>全量备份</strong>，比如利用 <code>mysqldump</code> 工具每天凌晨备份一次并发送到其他服务器上；再配合 <strong>增量备份</strong>，利用 Binlog（二进制日志）记录每次的数据修改操作，这样即使数据库崩了，也能恢复到最近的状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3d02c27d011448384c066d3c7ebe033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=PR0sy519vMkMsPkehyycjNPCjJs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">怎么保证系统不会再崩？</h3>
<p>你松了一口气：那怎么保证数据库不会再宕机呢？</p>
<p>阿坤：可以搭建 MySQL 高可用集群，典型的是 <strong>一主多从</strong> 架构。</p>
<p>主库（Master）专门负责写操作（增删改），并通过 Binlog 记录每一次数据变更操作。</p>
<p>从库（Slave） 拉取主库的 Binlog 到本地文件中，然后回放数据变更操作，实现数据同步。我们可以利用从库来承担绝大部分的读操作，这叫 <strong>读写分离</strong>，能大大提升并发能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cc7092c41374dfb82a61af5e2f3350e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=ng%2BdIVVWxbBw1AzSmJovH%2BdiJD0%3D" alt="" loading="lazy"/></p>
<p>当主库出现故障时，利用 <strong>MHA</strong> 等工具，自动将一个从库提升为新的主库，并调整其他从库的指向，实现故障的自动切换。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/252981b8af4d4af9adbaf8e4b03409f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=T1V6kfSsrx8CRiKpModcRaCaE6k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">数据量大了怎么办？</h3>
<p>你很是惊讶：之前完全没听说过这些啊……</p>
<p>阿坤用看流浪狗的眼神看了你一眼：阿巴哥哥，如果数据量特别大，一个库存不下怎么办？</p>
<p>你哑口无言：阿巴阿巴……</p>
<p>阿坤笑了：当然是 <strong>分库分表</strong> 啦！比如</p>
<p>1）水平拆分：把同一张表的数据分散到多个表或多个库中。比如根据学生 ID 的尾号，奇数的存到表 1，偶数的存到表 2。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ada068e825bf4a779684e457afadad3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=HuZ3ZOyYqYV2rls%2Fw1l7W8EWtfg%3D" alt="" loading="lazy"/></p>
<p>2）垂直拆分：按业务功能来拆分库，比如把学生基本信息、成绩信息、选课信息分别存到不同的库中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bea71f37907d47ee8c291eeec4ab7545~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=iAhUYoka7QDij%2FLBYAUKjJPeKzE%3D" alt="" loading="lazy"/></p>
<p>你彻底服了：妙啊，这样就能存储海量数据了！</p>
<h3 data-id="heading-13">其他实践</h3>
<p>这时鱼皮走过来拍了拍阿坤的肩膀：小伙子年轻有为啊！</p>
<p>小阿巴，MySQL 生产环境实践的知识点还有很多。比如：</p>
<p>1）权限管理：不要所有人都用 root 账号，风险太大，要给不同的人分配不同的权限。</p>
<p>2）云数据库服务：提供了现成的 MySQL 集群架构、监控系统、自动备份、数据迁移等，比自己运维省心多了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51ff9e136dfe49a685920b41fef5ec3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=YR0Jx9J5aM3HtOSowGZT8KZCA44%3D" alt="" loading="lazy"/></p>
<p>3）调优技巧：硬件优化、数据库配置优化、库表设计优化、SQL 优化、连接池优化等等。</p>
<p>4）常见问题：还有死锁排查、大表的在线变更、数据迁移、主从延迟处理等等，遇到了再去解决。</p>
<p>你羞愧地抬不起头：我以为自己已经掌握了数据库，原来只是学了个皮毛……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c1a02b0de9b47c6bdca001ae1639907~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=2Kz8WKJsacLDNNqiUILw%2Ft74v10%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">第五阶段：深入底层原理</h2>
<p>于是，你主动找到阿坤：我想深入学习 MySQL，不能只停留在会用的层面，请问怎么学习底层原理啊？</p>
<p>阿坤有些惊讶：咦？你不 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshiya.com%2F" target="_blank" title="https://www.mianshiya.com/" ref="nofollow noopener noreferrer">背八股文</a> 的么？刷刷题就好了呀！</p>
<p>你震惊了：现在的实习生，竟然恐怖如斯！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da53e10a02d24f519d7f91204e0f2a55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=yuc6M%2B%2BTyrhx9uUE8BavkHDODTE%3D" alt="" loading="lazy"/></p>
<p>鱼皮：阿坤你别逗他了，其实我们可以带着问题学习。比如 <strong>MySQL 是如何实现高效查询的</strong> ？</p>
<p>你想了想：加索引？</p>
<p>鱼皮：对，但这只是使用层面。底层实现有很多技术，比如高效的存储引擎（InnoDB）、优秀的索引结构（B+ 树）、缓冲池机制、查询优化器等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ebd986de9b41bdb7baa8491d35fc0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=JEQI5jUarW1Q1xBa86uWwoqIfwU%3D" alt="" loading="lazy"/></p>
<p>比如我考考你，下面两个 SQL 语句哪个执行更快？</p>
<pre><code class="hljs language-sql" lang="sql"># <span class="hljs-keyword">SQL</span> <span class="hljs-number">1</span>: 使用 <span class="hljs-keyword">OR</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> class_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> class_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
​
# <span class="hljs-keyword">SQL</span> <span class="hljs-number">2</span>: 使用 <span class="hljs-keyword">IN</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> student <span class="hljs-keyword">WHERE</span> class_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
</code></pre>
<p>你：额…… 第 2 个？因为它更简短。</p>
<p>鱼皮：哼哼，答案是 <strong>几乎一样快</strong>！因为 MySQL 的查询优化器非常智能，它会分析语句、将它们处理成相同的逻辑结构，再去执行。</p>
<p>这就是 MySQL 能高效查询的原因之一，带着这些问题去阅读相关文章，或者直接像阿坤说的刷一刷 MySQL 面试题，就能快速学会很多核心知识点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0449e9847ad34514be5659c8564e324b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=gMGyTxQcrWg0gXR8B4SGTOKhFeA%3D" alt="img" loading="lazy"/></p>
<p>如果想系统学习，可以看看《MySQL 是怎样运行的》、《高性能 MySQL》这几本书。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bd218e3ccd942169aeb690bf67a25c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=EMnlFcT2LYdGjMRWecr801EdrUg%3D" alt="img" loading="lazy"/></p>
<p>要记住，学习底层原理不只是为了应付面试，而是为了更好地使用 MySQL，遇到问题时能够快速定位和解决。</p>
<p>你：好的，我这就去学！</p>
<h2 data-id="heading-15">结尾</h2>
<p>若干年后，你已经成为了大厂的数据库专家。不仅能熟练设计库表、优化性能，搭个 MySQL 集群也是手拿把掐的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deb130295ac049ffbbad83960f3333b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=zktK%2ByGU7pqcUX300L%2Bwx%2B%2FHPWg%3D" alt="img" loading="lazy"/></p>
<p>你也像鱼皮当时一样，耐心地给新人分享学习数据库的经验：数据库是实战型技术，一定要多动手实践。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df39b61c83b24a3094d0195773bf27eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=i5XF4WvAuXqFJMmZYNRXtLCBHQ4%3D" alt="img" loading="lazy"/></p>
<p>再次遇到鱼皮是在一条昏暗的小巷，此时的他年过 35，灰头土脸。你什么都没说，只是给他点了个赞，投了 2 个币，不打扰，是你的温柔。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0fbde7a8ee245ad893af17c6eda5ee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765251387&amp;x-signature=LyZdcowTV0a8UJJ6mwuZp1F1N%2Bk%3D" alt="img" loading="lazy"/></p>
<p>更详细的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codefather.cn%2Fcourse%2F1789189862986850306%2Fsection%2F1789190581420793858" target="_blank" title="https://www.codefather.cn/course/1789189862986850306/section/1789190581420793858" ref="nofollow noopener noreferrer">MySQL 数据库学习路线</a>，可以在编程导航免费阅读哦。</p>
<h2 data-id="heading-16">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是模块联邦?（Module Federation）]]></title>    <link>https://juejin.cn/post/7578780780027215881</link>    <guid>https://juejin.cn/post/7578780780027215881</guid>    <pubDate>2025-12-02T03:37:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578780780027215881" data-draft-id="7578820376999133235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是模块联邦?（Module Federation）"/> <meta itemprop="keywords" content="前端,JavaScript,前端工程化"/> <meta itemprop="datePublished" content="2025-12-02T03:37:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="eason_fan"/> <meta itemprop="url" content="https://juejin.cn/user/2995517308808877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是模块联邦?（Module Federation）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2995517308808877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    eason_fan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:37:54.000Z" title="Tue Dec 02 2025 03:37:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前端模块共享的传统困境</h2>
<p>在大型前端项目或多应用协作场景中，“模块共享” 是绕不开的需求 —— 比如多个应用复用同一套按钮组件、工具函数，或不同团队协作开发时共享基础模块。但在模块联邦（Module Federation）出现前，传统方案始终存在难以解决的痛点：</p>
<h3 data-id="heading-1">1. npm 包共享：迭代效率低下</h3>
<p>将公共组件打包成 npm 包是最常见的方式，但流程繁琐：修改组件后需重新发布版本，所有依赖该包的应用都要手动更新依赖、重新构建部署。对于频繁迭代的内部组件库，这种 “发布 - 安装 - 重构” 的循环严重拖慢开发效率，且容易出现 “版本不一致导致的兼容问题”。</p>
<h3 data-id="heading-2">2. CDN 直接引入：粗糙且易出问题</h3>
<p>为了跳过 npm 发布流程，部分团队会将组件打包成 umd 格式丢到 CDN，消费方通过 
</p><ul>
<li>依赖需手动管理：如果共享组件依赖 React、Vue 等库，消费方必须手动引入对应版本，否则会出现 “模块未定义” 的运行时错误；</li>
</ul>

<ul>
<li>全局变量污染：umd 包通常挂载到 window 上，多个模块可能出现命名冲突；</li>
</ul>

<ul>
<li>无法按需加载：
</li></ul>

<ul>
<li>无版本控制：CDN 资源更新后，需手动处理缓存或版本号，容易出现 “旧版本缓存导致的功能异常”。</li>
</ul>
<h3 data-id="heading-3">3. 早期微前端：耦合度高，共享粒度粗</h3>
<p>早期微前端方案（如 qiankun）更侧重 “应用级嵌入”—— 将多个独立应用整合成一个整体，但跨应用共享组件 / 模块时需额外适配（如通过自定义事件传递状态），集成成本高，且共享粒度仅停留在 “整个应用”，无法实现细粒度的组件 / 工具函数共享。</p>
<p>这些痛点的核心矛盾的是：<strong>传统方案无法在 “高效迭代”“按需加载”“依赖自动管理” 之间找到平衡</strong>，而模块联邦的出现，正是为了解决这一核心矛盾。</p>
<h2 data-id="heading-4">二、模块联邦：前端模块共享的终极方案</h2>
<p>模块联邦（Module Federation，简称 MF）是 Webpack 5 推出的核心特性，其核心目标是：<strong>打破应用边界，让多个独立构建的前端应用，像使用本地模块一样按需共享组件、工具函数，且无需手动处理依赖和部署流程</strong>。</p>
<p>简单来说，它就像一个 “前端模块的共享枢纽”—— 每个应用都可以作为 “模块提供者”（暴露自身模块）或 “模块消费者”（加载其他应用的模块），甚至两者兼具，形成灵活的模块共享生态。</p>
<h2 data-id="heading-5">三、模块联邦的核心原理（结合通俗理解）</h2>
<p>很多人第一次接触模块联邦时，会有这样的直观认知：“是不是把共享组件放到 CDN 上，消费方通过 Webpack 识别 import 语句，再请求 CDN 资源并注入使用？”—— 这个理解方向完全正确，我们可以基于这个认知，拆解其底层原理：</p>
<h3 data-id="heading-6">核心原理一句话总结</h3>
<p>模块联邦本质是：<strong>将共享模块（带依赖元信息）部署到远程服务器（如 CDN），Webpack 通过 “编译时标记 + 运行时加载”，让消费方用原生 import 语法加载远程模块；当代码执行到该 import 时，自动请求远程资源，经格式适配和依赖处理后，注入宿主应用的模块系统，实现 “本地使用” 的体验</strong>。</p>
<h3 data-id="heading-7">原理拆解（分 4 步）</h3>
<h4 data-id="heading-8">1. 模块提供者：打包 “带元信息的共享模块”</h4>
<p>模块提供者（称为 Remote 应用）打包时，Webpack 会做两件关键事：</p>
<ul>
<li>生成 remoteEntry.js：这不是模块本身，而是 “模块导航文件”—— 包含模块清单（暴露了哪些模块、模块的真实地址）、依赖元信息（模块依赖的库如 React/Vue）、加载器函数（用于后续解析模块）；</li>
</ul>

<ul>
<li>拆分模块 chunk：将暴露的组件 / 工具函数拆成独立的 JS chunk（如 Button 组件对应 123.js），并部署到 CDN 或远程服务器。</li>
</ul>
<p>这里的关键是：<strong>共享的不是 “裸模块”，而是 “带依赖元信息的模块单元”</strong> ，避免了传统 CDN 引入时 “依赖手动管理” 的问题。</p>
<h4 data-id="heading-9">2. 模块消费者：编译时标记远程模块</h4>
<p>模块消费者（称为 Host 应用）配置 Webpack 时，会声明要加载的远程应用（如 app2: 'app2@<a href="https://link.juejin.cn?target=http%3A%2F%2Fcdn.example.com%2FremoteEntry.js" target="_blank" title="http://cdn.example.com/remoteEntry.js" ref="nofollow noopener noreferrer">cdn.example.com/remoteEntry…</a>'）。Webpack 编译时会识别这类远程模块的 import 语句（如 import 'app2/Button'），并做 “标记”—— 告诉运行时：“这个模块不是本地的，需要从远程加载”。</p>
<p>这一步就像你理解的 “Webpack 的 switch 功能”：编译时给远程模块打标签，运行时遇到标签就切换到 “远程加载逻辑”，而非本地模块的 “文件读取逻辑”。</p>
<h4 data-id="heading-10">3. 运行时：异步请求远程资源（非简单 script 插入）</h4>
<p>当宿主应用运行到远程模块的 import 语句时，会触发以下流程：</p>
<ul>
<li>第一步：加载 remoteEntry.js：通过 Webpack 内置的异步加载逻辑（而非直接插入 
</li></ul>

<ul>
<li>第二步：解析模块地址：remoteEntry.js 执行后，通过其内置的模块清单，找到目标模块（如 app2/Button）对应的真实 CDN 地址（如 <a href="https://link.juejin.cn?target=http%3A%2F%2Fcdn.example.com%2F123.js" target="_blank" title="http://cdn.example.com/123.js" ref="nofollow noopener noreferrer">cdn.example.com/123.js</a>）；</li>
</ul>

<ul>
<li>第三步：加载目标模块：通过 Webpack 封装的异步加载函数（如 <strong>webpack_require</strong>.e）请求目标模块的 JS chunk，这一步同样不是简单插入 
</li></ul>
<h4 data-id="heading-11">4. 注入使用：依赖自动处理 + 格式适配</h4>
<p>目标模块加载完成后，Webpack 会做最后两件事：</p>
<ul>
<li>依赖自动复用：如果远程模块依赖的库（如 React），宿主应用已加载，则直接复用，避免重复打包；若未加载，则自动加载共享依赖（通过 shared 配置控制）；</li>
</ul>

<ul>
<li>格式适配与注入：将远程模块的代码格式，转换成宿主应用能识别的模块格式（避免全局污染），并注入宿主的模块系统 —— 此时，远程模块就像本地模块一样，可直接使用。</li>
</ul>
<h3 data-id="heading-12">与 “简单 CDN 引入” 的核心区别</h3>


































<table><thead><tr><th>对比维度</th><th>简单 CDN 引入（umd 包）</th><th>模块联邦</th></tr></thead><tbody><tr><td>依赖管理</td><td>手动引入，易冲突</td><td>自动识别依赖，共享复用</td></tr><tr><td>加载方式</td><td>插入 
</td><td>异步请求 Webpack 格式 chunk，无全局污染</td></tr><tr><td>按需加载</td><td>不支持，同步加载</td><td>支持，用到才加载</td></tr><tr><td>版本控制</td><td>需手动管理版本号 / 缓存</td><td>通过 shared 配置控制版本兼容</td></tr><tr><td>使用体验</td><td>需从 window 取模块，体验割裂</td><td>原生 import 语法，和本地模块一致</td></tr></tbody></table>
<h2 data-id="heading-13">四、模块联邦的实际使用方法（React 示例）</h2>
<p>下面用两个应用演示核心用法：app1（宿主应用，加载远程模块）和 app2（远程应用，暴露共享组件）。</p>
<h3 data-id="heading-14">前置条件</h3>
<ul>
<li>构建工具：Webpack 5+（仅 Webpack 5 原生支持模块联邦）；</li>
</ul>

<ul>
<li>技术栈：React（Vue 用法类似，核心配置一致）。</li>
</ul>
<h3 data-id="heading-15">1. 远程应用（app2：模块提供者）</h3>
<h4 data-id="heading-16">步骤 1：配置 Webpack（webpack.config.js）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">ModuleFederationPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>).<span class="hljs-property">container</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,
  <span class="hljs-attr">devServer</span>: { <span class="hljs-attr">port</span>: <span class="hljs-number">3002</span> }, <span class="hljs-comment">// 远程应用运行端口</span>
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">uniqueName</span>: <span class="hljs-string">'app2'</span>, <span class="hljs-comment">// 远程应用唯一标识（避免冲突）</span>
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'app2'</span>, <span class="hljs-comment">// 远程应用名称（宿主需通过该名称引用）</span>
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'remoteEntry.js'</span>, <span class="hljs-comment">// 模块导航文件（必须叫这个名字）</span>
      <span class="hljs-attr">exposes</span>: {
        <span class="hljs-comment">// 暴露的模块：key 是宿主引用的路径，value 是本地模块路径</span>
        <span class="hljs-string">'./Button'</span>: <span class="hljs-string">'./src/Button'</span>, <span class="hljs-comment">// 暴露 Button 组件</span>
        <span class="hljs-string">'./utils'</span>: <span class="hljs-string">'./src/utils'</span>, <span class="hljs-comment">// 暴露工具函数</span>
      },
      <span class="hljs-comment">// 共享依赖：避免 React/ReactDOM 重复打包</span>
      <span class="hljs-attr">shared</span>: {
        <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">// singleton：单例模式；eager：优先加载</span>
        <span class="hljs-string">'react-dom'</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span> },
      },
    }),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({ <span class="hljs-attr">template</span>: <span class="hljs-string">'./public/index.html'</span> }),
  ],
};
</code></pre>
<h4 data-id="heading-17">步骤 2：编写共享模块</h4>
<p>创建 src/Button.jsx（共享组件）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App2Button</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>我是 app2 的共享按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<h4 data-id="heading-18">步骤 3：启动远程应用</h4>
<p>运行 npm run dev，远程应用会启动在 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3002%25EF%25BC%258C%25E6%25AD%25A4%25E6%2597%25B6%25E5%258F%25AF%25E9%2580%259A%25E8%25BF%2587" target="_blank" title="http://localhost:3002%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%8F%AF%E9%80%9A%E8%BF%87" ref="nofollow noopener noreferrer">http://localhost:3002，此时可通过</a> <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3002%2FremoteEntry.js" target="_blank" title="http://localhost:3002/remoteEntry.js" ref="nofollow noopener noreferrer">http://localhost:3002/remoteEntry.js</a> 访问导航文件。</p>
<h3 data-id="heading-19">2. 宿主应用（app1：模块消费者）</h3>
<h4 data-id="heading-20">步骤 1：配置 Webpack（webpack.config.js）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">ModuleFederationPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>).<span class="hljs-property">container</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,
  <span class="hljs-attr">devServer</span>: { <span class="hljs-attr">port</span>: <span class="hljs-number">3001</span> }, <span class="hljs-comment">// 宿主应用运行端口</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'app1'</span>, <span class="hljs-comment">// 宿主应用名称（仅用于标识）</span>
      <span class="hljs-comment">// 配置要加载的远程应用：key 是远程应用名称，value 是 "远程名称@导航文件地址"</span>
      <span class="hljs-attr">remotes</span>: {
        <span class="hljs-attr">app2</span>: <span class="hljs-string">'app2@http://localhost:3002/remoteEntry.js'</span>,
      },
      <span class="hljs-comment">// 共享依赖：和远程应用保持一致，避免重复打包</span>
      <span class="hljs-attr">shared</span>: {
        <span class="hljs-attr">react</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span> },
        <span class="hljs-string">'react-dom'</span>: { <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span> },
      },
    }),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({ <span class="hljs-attr">template</span>: <span class="hljs-string">'./public/index.html'</span> }),
  ],
};
</code></pre>
<h4 data-id="heading-21">步骤 2：使用远程模块</h4>
<p>创建 src/App.jsx，用原生 import 语法加载远程模块：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { lazy, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-comment">// 按需加载远程模块（推荐）：用 lazy + Suspense 处理加载状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">App2Button</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'app2/Button'</span>)); <span class="hljs-comment">// 格式：远程应用名称/暴露的模块 key</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">App2Utils</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'app2/utils'</span>));
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我是宿主应用（app1）<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {/* 远程模块加载时显示 fallback */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">"加载中..."</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">App2Button</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<h4 data-id="heading-22">步骤 3：启动宿主应用</h4>
<p>运行 npm run dev，访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3001%25EF%25BC%258C%25E5%258D%25B3%25E5%258F%25AF%25E7%259C%258B%25E5%2588%25B0%25E6%259D%25A5%25E8%2587%25AA" target="_blank" title="http://localhost:3001%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E6%9D%A5%E8%87%AA" ref="nofollow noopener noreferrer">http://localhost:3001，即可看到来自</a> app2 的红色按钮 —— 此时，宿主应用已成功加载并使用远程模块，且完全感知不到 “这是远程资源”。</p>
<h2 data-id="heading-23">五、模块联邦的核心特性与适用场景</h2>
<h3 data-id="heading-24">核心特性</h3>
<ol>
<li>独立部署：宿主和远程应用可各自独立开发、构建、部署，修改远程模块后无需重构宿主；</li>
</ol>

<ol start="2">
<li>双向共享：一个应用既可以是宿主（加载模块），也可以是远程（暴露模块）；</li>
</ol>

<ol start="3">
<li>依赖去重：共享依赖自动复用，避免重复打包，减小包体积；</li>
</ol>

<ol start="4">
<li>按需加载：远程模块仅在使用时才加载，优化首屏性能。</li>
</ol>
<h3 data-id="heading-25">适用场景</h3>
<ol>
<li>微前端架构：实现细粒度的组件 / 模块共享，替代传统粗粒度的应用嵌入；</li>
</ol>

<ol start="2">
<li>大型应用拆分：将巨型应用拆分为多个独立构建的子应用（如首页、订单页），各自迭代；</li>
</ol>

<ol start="3">
<li>内部组件库共享：无需发布 npm 包，多个应用实时使用最新版公共组件；</li>
</ol>

<ol start="4">
<li>跨团队协作：不同团队维护不同子应用，通过模块联邦无缝集成，降低协作成本。</li>
</ol>
<h2 data-id="heading-26">六、使用注意事项</h2>
<ol>
<li>依赖版本兼容：共享依赖（如 React）需保证版本兼容，可通过 requiredVersion 配置限制版本；</li>
</ol>

<ol start="2">
<li>构建工具限制：仅 Webpack 5+ 原生支持，Vite 需用 vite-plugin-federation 插件，Rollup 支持有限；</li>
</ol>

<ol start="3">
<li>缓存与降级：给 remoteEntry.js 和模块 chunk 加哈希值（如 remoteEntry.[hash].js），避免缓存问题；同时需做好降级方案（如远程应用挂掉时，显示本地备用组件）；</li>
</ol>

<ol start="4">
<li>样式隔离：共享组件的样式需避免污染宿主，可使用 CSS Modules、Shadow DOM 等方案。</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<p>模块联邦的核心价值，是让前端模块共享从 “繁琐的手动管理” 走向 “自动化、按需化、低耦合”。它没有改变开发者的使用习惯（仍用 import 语法），却解决了传统方案的核心痛点，让大型前端项目的拆分与协作变得更高效。</p>
<p>如果你正在面临 “多应用共享组件”“大型项目拆分” 等问题，模块联邦无疑是当前最理想的解决方案 —— 它不仅是一种技术，更是一种 “前端架构的设计思想”：<strong>打破边界，让模块自由流动</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaTreeMap源码分析]]></title>    <link>https://juejin.cn/post/7578724773993562138</link>    <guid>https://juejin.cn/post/7578724773993562138</guid>    <pubDate>2025-12-01T16:19:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578724773993562138" data-draft-id="7578724773993545754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaTreeMap源码分析"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-01T16:19:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="makinohara"/> <meta itemprop="url" content="https://juejin.cn/user/455637552340731"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaTreeMap源码分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/455637552340731/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    makinohara
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T16:19:20.000Z" title="Mon Dec 01 2025 16:19:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>节点内部属性：</strong></p>
<p>TreeMap中，每一个元素都是Entry对象：</p>
<pre><code class="hljs language-ini" lang="ini">    static final class Entry&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; {
        K key<span class="hljs-comment">;</span>
        V value<span class="hljs-comment">;</span>
        Entry&lt;K,V&gt; left<span class="hljs-comment">;</span>
        Entry&lt;K,V&gt; right<span class="hljs-comment">;</span>
        Entry&lt;K,V&gt; parent<span class="hljs-comment">;</span>
        boolean <span class="hljs-attr">color</span> = BLACK<span class="hljs-comment">;</span>
</code></pre>
<p><strong>一些成员变量：</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Comparator&lt;? <span class="hljs-built_in">super</span> K&gt; comparator;
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Entry&lt;K,V&gt; root;
​
    <span class="hljs-comment">/**
     * The number of entries in the tree
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
<p>comparator表示比较方法，root为根节点地址值，size为节点数量。</p>
<p><strong>空参构造：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TreeMap</span>()</span> {
        comparator = <span class="hljs-literal">null</span>;
    }
</code></pre>
<p><strong>带参构造：</strong></p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">public</span> <span class="hljs-title function_">TreeMap</span><span class="hljs-params">(Comparator&lt;? <span class="hljs-built_in">super</span> K&gt; comparator)</span> {
        <span class="hljs-built_in">this</span>.comparator = comparator;
    }
</code></pre>
<p><strong>添加元素：</strong></p>
<pre><code class="hljs language-ini" lang="ini"> public V put(K key, V value) {
        Entry&lt;K,V&gt; <span class="hljs-attr">t</span> = root<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">t</span> == null) {
            compare(key, key)<span class="hljs-comment">; // type (and possibly null) check</span>
​
            <span class="hljs-attr">root</span> = new Entry&lt;&gt;(key, value, null)<span class="hljs-comment">;</span>
            <span class="hljs-attr">size</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
            modCount++<span class="hljs-comment">;</span>
            return null<span class="hljs-comment">;</span>
        }
        int cmp<span class="hljs-comment">;</span>
        Entry&lt;K,V&gt; parent<span class="hljs-comment">;</span>
        // split comparator and comparable paths
        Comparator&lt;? super K&gt; <span class="hljs-attr">cpr</span> = comparator<span class="hljs-comment">;</span>
        if (cpr != null) {
            do {
                <span class="hljs-attr">parent</span> = t<span class="hljs-comment">;</span>
                <span class="hljs-attr">cmp</span> = cpr.compare(key, t.key)<span class="hljs-comment">;</span>
                if (cmp &lt; 0)
                    <span class="hljs-attr">t</span> = t.left<span class="hljs-comment">;</span>
                else if (cmp &gt; 0)
                    <span class="hljs-attr">t</span> = t.right<span class="hljs-comment">;</span>
                else
                    return t.setValue(value)<span class="hljs-comment">;</span>
            } while (t != null)<span class="hljs-comment">;</span>
        }
        else {
            if (<span class="hljs-attr">key</span> == null)
                throw new NullPointerException()<span class="hljs-comment">;</span>
            @SuppressWarnings("unchecked")
                Comparable&lt;? super K&gt; <span class="hljs-attr">k</span> = (Comparable&lt;? super K&gt;) key<span class="hljs-comment">;</span>
            do {
                <span class="hljs-attr">parent</span> = t<span class="hljs-comment">;</span>
                <span class="hljs-attr">cmp</span> = k.compareTo(t.key)<span class="hljs-comment">;</span>
                if (cmp &lt; 0)
                    <span class="hljs-attr">t</span> = t.left<span class="hljs-comment">;</span>
                else if (cmp &gt; 0)
                    <span class="hljs-attr">t</span> = t.right<span class="hljs-comment">;</span>
                else
                    return t.setValue(value)<span class="hljs-comment">;</span>
            } while (t != null)<span class="hljs-comment">;</span>
        }
        Entry&lt;K,V&gt; <span class="hljs-attr">e</span> = new Entry&lt;&gt;(key, value, parent)<span class="hljs-comment">;</span>
        if (cmp &lt; 0)
            <span class="hljs-attr">parent.left</span> = e<span class="hljs-comment">;</span>
        else
            <span class="hljs-attr">parent.right</span> = e<span class="hljs-comment">;</span>
        fixAfterInsertion(e)<span class="hljs-comment">;</span>
        size++<span class="hljs-comment">;</span>
        modCount++<span class="hljs-comment">;</span>
        return null<span class="hljs-comment">;</span>
    }
​
</code></pre>
<p>首先，获取根节点的地址值，赋值给局部变量t</p>
<p>如果t为null，表示当前是第一次添加，创建根节点，返回null，表示没有覆盖任何元素。</p>
<p>如果不为null，接着往下看。</p>
<p>cmp是两个元素的键比较之后的结果，负数表示当前要添加的元素较小，放在左子树。正数表示当前要添加的元素较大，放在右子树。</p>
<p>新建一个名为parent的Entry对象，表示要添加的节点的父节点。</p>
<p>将成员变量comparator赋值给cpr，表示比较规则。如果我们采取的是默认的自然排序，那么comparator为null，即cpr为null</p>
<p>如果有比较器对象，走if语句：</p>
<pre><code class="hljs language-ini" lang="ini">        if (cpr != null) {
            do {
                <span class="hljs-attr">parent</span> = t<span class="hljs-comment">;</span>
                <span class="hljs-attr">cmp</span> = cpr.compare(key, t.key)<span class="hljs-comment">;</span>
                if (cmp &lt; 0)
                    <span class="hljs-attr">t</span> = t.left<span class="hljs-comment">;</span>
                else if (cmp &gt; 0)
                    <span class="hljs-attr">t</span> = t.right<span class="hljs-comment">;</span>
                else
                    return t.setValue(value)<span class="hljs-comment">;</span>
            } while (t != null)<span class="hljs-comment">;</span>
        }
</code></pre>
<p>如果是自然排序，走else语句，由于结构类似，只分析else语句：</p>
<pre><code class="hljs language-ini" lang="ini">        else {
            if (<span class="hljs-attr">key</span> == null)
                throw new NullPointerException()<span class="hljs-comment">;</span>
            @SuppressWarnings("unchecked")
                Comparable&lt;? super K&gt; <span class="hljs-attr">k</span> = (Comparable&lt;? super K&gt;) key<span class="hljs-comment">;</span>
            do {
                <span class="hljs-attr">parent</span> = t<span class="hljs-comment">;</span>
                <span class="hljs-attr">cmp</span> = k.compareTo(t.key)<span class="hljs-comment">;</span>
                if (cmp &lt; 0)
                    <span class="hljs-attr">t</span> = t.left<span class="hljs-comment">;</span>
                else if (cmp &gt; 0)
                    <span class="hljs-attr">t</span> = t.right<span class="hljs-comment">;</span>
                else
                    return t.setValue(value)<span class="hljs-comment">;</span>
            } while (t != null)<span class="hljs-comment">;</span>
        }
</code></pre>
<p>可以看到这里将key强转为Comparable类型，因此键必须要实现Comparable接口</p>
<p>接着，将根节点当作当前节点的父节点。调用<code>compareTo</code>方法，比较当前节点与根节点键的大小关系。如果为负数，就去左子树找最合适的父节点，反之去右子树找最合适的父节点。如果相等，调用<code>setValue</code>方法：</p>
<pre><code class="hljs language-ini" lang="ini">        public V setValue(V value) {
            V <span class="hljs-attr">oldValue</span> = this.value<span class="hljs-comment">;</span>
            <span class="hljs-attr">this.value</span> = value<span class="hljs-comment">;</span>
            return oldValue<span class="hljs-comment">;</span>
        }
</code></pre>
<p>可以看到这个方法实际上是做了一个覆盖，并返回被覆盖的值。</p>
<p>循环走这个过程，直到t为空。再来看看t为空之后又做了些什么：</p>
<pre><code class="hljs language-ini" lang="ini">        Entry&lt;K,V&gt; <span class="hljs-attr">e</span> = new Entry&lt;&gt;(key, value, parent)<span class="hljs-comment">;</span>
        if (cmp &lt; 0)
            <span class="hljs-attr">parent.left</span> = e<span class="hljs-comment">;</span>
        else
            <span class="hljs-attr">parent.right</span> = e<span class="hljs-comment">;</span>
        fixAfterInsertion(e)<span class="hljs-comment">;</span>
        size++<span class="hljs-comment">;</span>
        modCount++<span class="hljs-comment">;</span>
        return null<span class="hljs-comment">;</span>
</code></pre>
<p>由于在每一次do语句中都会把t赋值给parent，因此最终parent必然会是待添加节点最合适的父节点。创建一个Entry对象表示待添加的节点，然后根据cmp的大小决定它应该放父节点的左边还是右边，并建立连接。</p>
<p>我们知道这并不符合红黑树的规则，因此还要在<code>fixAfterInsertion</code>中进行调整。</p>
<pre><code class="hljs language-scss" lang="scss">   private void <span class="hljs-built_in">fixAfterInsertion</span>(Entry&lt;K,V&gt; x) {
        x<span class="hljs-selector-class">.color</span> = RED;
​
        while (x != null &amp;&amp; x != root &amp;&amp; x.parent.color == RED) {
            if (parentOf(x) == <span class="hljs-built_in">leftOf</span>(parentOf(parentOf(x)))) {
                Entry&lt;K,V&gt; y = <span class="hljs-built_in">rightOf</span>(parentOf(parentOf(x)));
                if (colorOf(y) == RED) {
                    <span class="hljs-built_in">setColor</span>(parentOf(x), BLACK);
                    <span class="hljs-built_in">setColor</span>(y, BLACK);
                    <span class="hljs-built_in">setColor</span>(parentOf(parentOf(x)), RED);
                    x = <span class="hljs-built_in">parentOf</span>(parentOf(x));
                } else {
                    if (x == rightOf(parentOf(x))) {
                        x = <span class="hljs-built_in">parentOf</span>(x);
                        <span class="hljs-built_in">rotateLeft</span>(x);
                    }
                    <span class="hljs-built_in">setColor</span>(parentOf(x), BLACK);
                    <span class="hljs-built_in">setColor</span>(parentOf(parentOf(x)), RED);
                    <span class="hljs-built_in">rotateRight</span>(parentOf(parentOf(x)));
                }
            } else {
                Entry&lt;K,V&gt; y = <span class="hljs-built_in">leftOf</span>(parentOf(parentOf(x)));
                if (colorOf(y) == RED) {
                    <span class="hljs-built_in">setColor</span>(parentOf(x), BLACK);
                    <span class="hljs-built_in">setColor</span>(y, BLACK);
                    <span class="hljs-built_in">setColor</span>(parentOf(parentOf(x)), RED);
                    x = <span class="hljs-built_in">parentOf</span>(parentOf(x));
                } else {
                    if (x == leftOf(parentOf(x))) {
                        x = <span class="hljs-built_in">parentOf</span>(x);
                        <span class="hljs-built_in">rotateRight</span>(x);
                    }
                    <span class="hljs-built_in">setColor</span>(parentOf(x), BLACK);
                    <span class="hljs-built_in">setColor</span>(parentOf(parentOf(x)), RED);
                    <span class="hljs-built_in">rotateLeft</span>(parentOf(parentOf(x)));
                }
            }
        }
        root<span class="hljs-selector-class">.color</span> = BLACK;
    }
</code></pre>
<p>在该方法中，一上来就将节点的颜色调整为红色。毕竟红黑树中添加的节点默认都是红色的。</p>
<p>几个函数：</p>
<p>parentOf(x)：获取x的父节点</p>
<p>parentOf(parentOf(x))：获取x的爷爷节点</p>
<p>leftOf(x)：获取x的左子节点</p>
<p>rightOf(x)：获取x的右子节点</p>
<p>通过这四个函数，可以获得x的叔叔节点：leftOf(parentOf(parentOf(x)))或者rightOf(parentOf(parentOf(x)))</p>
<p>最后的几个问题：</p>
<p>❓TreeMap添加元素的时候，是否需要重写<code>hashCode</code>与<code>equals</code>方法？</p>
<p>答：不需要。put中没有涉及到这两个方法。这两个方法是和HashMap有关的，见上一篇文章《JavaHashMap源码分析》</p>
<p>❓既然有红黑树，HashMap的键是否需要实现Comparable接口或者传递比较器对象呢？</p>
<p>答：不需要。因为在HashMap的底层，默认是利用键的哈希值大小关系来创建红黑树的。</p>
<p>这里我们回到上一篇文章的内容，回到HashMap源码中的<code>putVal</code>方法：</p>
<pre><code class="hljs language-ini" lang="ini">    final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
        Node&lt;K,V&gt;<span class="hljs-section">[]</span> tab<span class="hljs-comment">; Node&lt;K,V&gt; p; int n, i;</span>
        if ((<span class="hljs-attr">tab</span> = table) == null || (n = tab.length) == <span class="hljs-number">0</span>)
            <span class="hljs-attr">n</span> = (tab = resize()).length<span class="hljs-comment">;</span>
        if ((<span class="hljs-attr">p</span> = tab[i = (n - <span class="hljs-number">1</span>) &amp; hash]) == null)
            tab<span class="hljs-section">[i]</span> = newNode(hash, key, value, null)<span class="hljs-comment">;</span>
        else {
            Node&lt;K,V&gt; e<span class="hljs-comment">; K k;</span>
            if (<span class="hljs-attr">p.hash</span> == hash &amp;&amp;
                ((<span class="hljs-attr">k</span> = p.key) == key || (key != null &amp;&amp; key.equals(k))))
                <span class="hljs-attr">e</span> = p<span class="hljs-comment">;</span>
            else if (p instanceof TreeNode)
                <span class="hljs-attr">e</span> = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value)<span class="hljs-comment">;</span>
            else {
                for (int <span class="hljs-attr">binCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">; ; ++binCount) {</span>
                    if ((<span class="hljs-attr">e</span> = p.next) == null) {
                        <span class="hljs-attr">p.next</span> = newNode(hash, key, value, null)<span class="hljs-comment">;</span>
                        if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st
                            treeifyBin(tab, hash)<span class="hljs-comment">;</span>
                        break<span class="hljs-comment">;</span>
                    }
                    if (<span class="hljs-attr">e.hash</span> == hash &amp;&amp;
                        ((<span class="hljs-attr">k</span> = e.key) == key || (key != null &amp;&amp; key.equals(k))))
                        break<span class="hljs-comment">;</span>
                    <span class="hljs-attr">p</span> = e<span class="hljs-comment">;</span>
                }
            }
            if (e != null) { // existing mapping for key
                V <span class="hljs-attr">oldValue</span> = e.value<span class="hljs-comment">;</span>
                if (!onlyIfAbsent || <span class="hljs-attr">oldValue</span> == null)
                    <span class="hljs-attr">e.value</span> = value<span class="hljs-comment">;</span>
                afterNodeAccess(e)<span class="hljs-comment">;</span>
                return oldValue<span class="hljs-comment">;</span>
            }
        }
        ++modCount<span class="hljs-comment">;</span>
        if (++size &gt; threshold)
            resize()<span class="hljs-comment">;</span>
        afterNodeInsertion(evict)<span class="hljs-comment">;</span>
        return null<span class="hljs-comment">;</span>
    }
</code></pre>
<p>注意到这里：</p>
<pre><code class="hljs language-ini" lang="ini">            else if (p instanceof TreeNode)
                <span class="hljs-attr">e</span> = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value)<span class="hljs-comment">;</span>
</code></pre>
<p>我们查看一下<code>putTreeVal</code>方法：</p>
<pre><code class="hljs language-ini" lang="ini">        final TreeNode&lt;K,V&gt; putTreeVal(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;<span class="hljs-section">[]</span> tab,
                                       int h, K k, V v) {
            Class&lt;?&gt; <span class="hljs-attr">kc</span> = null<span class="hljs-comment">;</span>
            boolean <span class="hljs-attr">searched</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            TreeNode&lt;K,V&gt; <span class="hljs-attr">root</span> = (parent != null) ? root() : this<span class="hljs-comment">;</span>
            for (TreeNode&lt;K,V&gt; <span class="hljs-attr">p</span> = root<span class="hljs-comment">;;) {</span>
                int dir, ph<span class="hljs-comment">; K pk;</span>
                if ((<span class="hljs-attr">ph</span> = p.hash) &gt; h)
                    <span class="hljs-attr">dir</span> = -<span class="hljs-number">1</span><span class="hljs-comment">;</span>
                else if (ph &lt; h)
                    <span class="hljs-attr">dir</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
                else if ((<span class="hljs-attr">pk</span> = p.key) == k || (k != null &amp;&amp; k.equals(pk)))
                    return p<span class="hljs-comment">;</span>
                else if ((<span class="hljs-attr">kc</span> == null &amp;&amp;
                          (<span class="hljs-attr">kc</span> = comparableClassFor(k)) == null) ||
                         (<span class="hljs-attr">dir</span> = compareComparables(kc, k, pk)) == <span class="hljs-number">0</span>) {
                    if (!searched) {
                        TreeNode&lt;K,V&gt; q, ch<span class="hljs-comment">;</span>
                        <span class="hljs-attr">searched</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                        if (((<span class="hljs-attr">ch</span> = p.left) != null &amp;&amp;
                             (<span class="hljs-attr">q</span> = ch.find(h, k, kc)) != null) ||
                            ((<span class="hljs-attr">ch</span> = p.right) != null &amp;&amp;
                             (<span class="hljs-attr">q</span> = ch.find(h, k, kc)) != null))
                            return q<span class="hljs-comment">;</span>
                    }
                    <span class="hljs-attr">dir</span> = tieBreakOrder(k, pk)<span class="hljs-comment">;</span>
                }
​
                TreeNode&lt;K,V&gt; <span class="hljs-attr">xp</span> = p<span class="hljs-comment">;</span>
                if ((<span class="hljs-attr">p</span> = (dir &lt;= <span class="hljs-number">0</span>) ? p.left : p.right) == null) {
                    Node&lt;K,V&gt; <span class="hljs-attr">xpn</span> = xp.next<span class="hljs-comment">;</span>
                    TreeNode&lt;K,V&gt; <span class="hljs-attr">x</span> = map.newTreeNode(h, k, v, xpn)<span class="hljs-comment">;</span>
                    if (dir &lt;= 0)
                        <span class="hljs-attr">xp.left</span> = x<span class="hljs-comment">;</span>
                    else
                        <span class="hljs-attr">xp.right</span> = x<span class="hljs-comment">;</span>
                    <span class="hljs-attr">xp.next</span> = x<span class="hljs-comment">;</span>
                    <span class="hljs-attr">x.parent</span> = x.prev = xp<span class="hljs-comment">;</span>
                    if (xpn != null)
                        ((TreeNode&lt;K,V&gt;)xpn).<span class="hljs-attr">prev</span> = x<span class="hljs-comment">;</span>
                    moveRootToFront(tab, balanceInsertion(root, x))<span class="hljs-comment">;</span>
                    return null<span class="hljs-comment">;</span>
                }
            }
        }
​
</code></pre>
<p>进一步查看find方法：</p>
<pre><code class="hljs language-ini" lang="ini">        final TreeNode&lt;K,V&gt; find(int h, Object k, Class&lt;?&gt; kc) {
            TreeNode&lt;K,V&gt; <span class="hljs-attr">p</span> = this<span class="hljs-comment">;</span>
            do {
                int ph, dir<span class="hljs-comment">; K pk;</span>
                TreeNode&lt;K,V&gt; <span class="hljs-attr">pl</span> = p.left, pr = p.right, q<span class="hljs-comment">;</span>
                if ((<span class="hljs-attr">ph</span> = p.hash) &gt; h)
                    <span class="hljs-attr">p</span> = pl<span class="hljs-comment">;</span>
                else if (ph &lt; h)
                    <span class="hljs-attr">p</span> = pr<span class="hljs-comment">;</span>
                else if ((<span class="hljs-attr">pk</span> = p.key) == k || (k != null &amp;&amp; k.equals(pk)))
                    return p<span class="hljs-comment">;</span>
                else if (<span class="hljs-attr">pl</span> == null)
                    <span class="hljs-attr">p</span> = pr<span class="hljs-comment">;</span>
                else if (<span class="hljs-attr">pr</span> == null)
                    <span class="hljs-attr">p</span> = pl<span class="hljs-comment">;</span>
                else if ((kc != null ||
                          (<span class="hljs-attr">kc</span> = comparableClassFor(k)) != null) &amp;&amp;
                         (<span class="hljs-attr">dir</span> = compareComparables(kc, k, pk)) != <span class="hljs-number">0</span>)
                    <span class="hljs-attr">p</span> = (dir &lt; <span class="hljs-number">0</span>) ? pl : pr<span class="hljs-comment">;</span>
                else if ((<span class="hljs-attr">q</span> = pr.find(h, k, kc)) != null)
                    return q<span class="hljs-comment">;</span>
                else
                    <span class="hljs-attr">p</span> = pl<span class="hljs-comment">;</span>
            } while (p != null)<span class="hljs-comment">;</span>
            return null<span class="hljs-comment">;</span>
        }
</code></pre>
<p>通过<code>(ph == p.hash) &gt; h</code>等语句可以看出，的确是使用键的哈希值大小关系来创建红黑树。</p>
<p>❓TreeMap和HashMap谁的效率更高？</p>
<p>答：如果是最坏情况，添加的8个元素全都形成了链表，那就是TreeMap的效率更高。前者的查询时间复杂度为O(n)，后者为O(logn)。但这种情况出现的概率很小，所以一般而言HashMap的效率更高。最优情况下其查询时间复杂度为O(1)</p>
<p>❓三种双列集合如何选择？</p>
<p>答：默认情况下使用HashMap，一般情况下它的效率最高</p>
<p>如果要保证存取有序，用LinkedHashMap，因为它底层是双向链表</p>
<p>如果要进行排序，用TreeMap</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ubuntu 部署 RustDesk 服务器]]></title>    <link>https://juejin.cn/post/7578699975414349824</link>    <guid>https://juejin.cn/post/7578699975414349824</guid>    <pubDate>2025-12-01T16:46:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699975414349824" data-draft-id="7578734725302239284" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ubuntu 部署 RustDesk 服务器"/> <meta itemprop="keywords" content="Ubuntu"/> <meta itemprop="datePublished" content="2025-12-01T16:46:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天宁"/> <meta itemprop="url" content="https://juejin.cn/user/187362547083252"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ubuntu 部署 RustDesk 服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/187362547083252/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天宁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T16:46:22.000Z" title="Mon Dec 01 2025 16:46:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>本文面向在 Ubuntu 上自托管 RustDesk 开源服务器（<code>hbbs</code>/<code>hbbr</code>）。适用于本地机房或云服务器（如阿里云、腾讯云、华为云等）。</p>
<ul>
<li>官方参考文档（强烈建议同时阅读）：<a href="https://link.juejin.cn?target=https%3A%2F%2Frustdesk.com%2Fdocs%2Fzh-cn%2Fself-host%2Frustdesk-server-oss%2Finstall%2F" target="_blank" title="https://rustdesk.com/docs/zh-cn/self-host/rustdesk-server-oss/install/" ref="nofollow noopener noreferrer">rustdesk.com/docs/zh-cn/…</a></li>
<li>适用系统：Ubuntu 20.04/22.04/24.04（其他 Debian 系亦可参考）</li>
</ul>
<h2 data-id="heading-0">0. 准备工作</h2>
<ul>
<li>一台可公网访问的 Ubuntu 服务器（具备 <code>sudo</code> 权限）。</li>
<li>确保可以通过 <code>ssh</code> 登录，执行基础维护命令。</li>
<li>如果使用云厂商，先在云控制台开放端口。</li>
</ul>
<h2 data-id="heading-1">1. 开放端口</h2>
<p>云厂商安全组是“第一道防火墙”，仅配置系统 <code>ufw</code> 不够，必须在云控制台放行端口。以阿里云为例：</p>
<ul>
<li>登录 阿里云 ECS 控制台 → 找到你的服务器 → 左侧「安全组」→ 配置规则。</li>
<li>新增「入方向」规则，放行 RustDesk 所需端口：</li>
</ul>























<table><thead><tr><th>协议</th><th>端口范围</th><th>授权对象</th><th>说明</th></tr></thead><tbody><tr><td>TCP</td><td>21114-21119</td><td>0.0.0.0/0</td><td>RustDesk 核心 TCP 端口</td></tr><tr><td>UDP</td><td>21116</td><td>0.0.0.0/0</td><td>RustDesk NAT 打洞 UDP 端口</td></tr></tbody></table>
<p>提示：<code>0.0.0.0/0</code> 表示允许所有 IP（适合测试）。生产环境建议缩小到你的办公网段或指定客户端 IP。</p>
<p>保存规则后，通常需等待 1–2 分钟生效（安全组有延迟）。</p>
<p>同时，在服务器系统内使用 <code>ufw</code> 放行端口（建议）：</p>
<pre><code class="hljs language-shell" lang="shell">sudo apt update
sudo apt install -y ufw
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 21114:21119/tcp
sudo ufw allow 21116/udp
sudo ufw enable
sudo ufw status numbered
</code></pre>
<h2 data-id="heading-2">2. 安装 RustDesk（方式一：一键脚本）</h2>
<p>如果你希望快速完成部署，可使用一键脚本：</p>
<pre><code class="hljs language-shell" lang="shell">wget https://ghfast.top/https://raw.githubusercontent.com/techahold/rustdeskinstall/master/install.sh -O install.sh
chmod +x install.sh
sudo ./install.sh
</code></pre>
<p>脚本会自动下载安装并以 systemd 服务运行 <code>hbbs</code>（ID 服务）与 <code>hbbr</code>（中继服务）。</p>
<ul>
<li>安装过程中会出现两处交互确认，按提示选择即可（见下图）。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123ad11f450b4868bed65a53bd9e8a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5a6B:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765212635&amp;x-signature=ipnhVyM4Zet47KwUQSxb3NF94y8%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44e711a254504515893ee34a098bf62a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5a6B:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765212635&amp;x-signature=JarrzmroY%2F6J%2FrFexJgbWndVvrU%3D" alt="2.png" loading="lazy"/></p>
<ul>
<li>首次启动时，服务会在日志中输出一个 <code>Key</code>（密钥），请复制并保存（见下图）。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca2c601a709d4f568ed25d6ccab72879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5a6B:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765212635&amp;x-signature=w%2F8MS%2F%2FtXBtiH6QVV1wM0ywwAy8%3D" alt="3.png" loading="lazy"/></p>
<p>查看服务状态与日志：</p>
<pre><code class="hljs language-shell" lang="shell">systemctl status hbbs
systemctl status hbbr
journalctl -u hbbs -f
journalctl -u hbbr -f
</code></pre>
<p>检查端口是否监听：</p>
<pre><code class="hljs language-shell" lang="shell">ss -tunlp | grep -E '2111[4-9]|21116'
</code></pre>
<h2 data-id="heading-3">3. 安装 RustDesk（方式二：官方 deb 包，二选一）</h2>
<p>也可在 GitHub Releases 下载官方 <code>.deb</code> 包并安装（适合熟悉 Debian 包管理的用户）：</p>
<ol>
<li>前往 RustDesk 服务器开源版发布页，下载适合架构的 <code>*.deb</code>。</li>
<li>上传到服务器并安装：
<pre><code class="hljs language-shell" lang="shell">sudo dpkg -i rustdesk-server*.deb
sudo apt -f install
</code></pre>
</li>
<li>验证服务：
<pre><code class="hljs language-shell" lang="shell">systemctl status hbbs
systemctl status hbbr
</code></pre>
</li>
</ol>
<p>两种安装方式任选其一即可，不必重复安装。</p>
<h2 data-id="heading-4">4. 客户端配置（Windows/macOS/Linux）</h2>
<p>在 RustDesk 客户端中填写自托管信息（见下图）：</p>
<ul>
<li>打开 RustDesk → 进入「设置」→ 找到与「自托管 / 服务器」相关的配置。</li>
<li>填写以下内容：
<ul>
<li><code>ID 服务器</code>：你的服务器域名或公网 IP（端口默认 21114）。</li>
<li><code>中继服务器</code>：你的服务器域名或公网 IP（默认端口 21117，可在客户端处填写为 <code>IP:21117</code>）。</li>
<li><code>Key</code>：从服务器日志中复制的密钥。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6c25831485e4b24b06b109ed2b88439~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5a6B:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765212635&amp;x-signature=%2FgjM6Vu5ZcGLlGWyQNXAuvxWm4Q%3D" alt="4.png" loading="lazy"/></p>
<p>保存后，返回主界面，两个客户端互相输入对方 ID 进行连接测试。若能直连，会显示直连；若 NAT 复杂，则会自动走中继。</p>
<h2 data-id="heading-5">5. 远程连通性验证（可选但推荐）</h2>
<p>从你的本地电脑测试云端端口是否可达：</p>
<pre><code class="hljs language-shell" lang="shell">nc -zv &lt;你的服务器IP或域名&gt; 21114
nc -zv &lt;你的服务器IP或域名&gt; 21117
</code></pre>
<p>如显示 <code>succeeded</code> 或 <code>open</code>，表示端口连通性正常。</p>
<h2 data-id="heading-6">6. 常见问题与排查</h2>
<ul>
<li>无法获取 ID：
<ul>
<li>检查 <code>hbbs</code> 服务是否运行：<code>systemctl status hbbs</code></li>
<li>检查云安全组与 <code>ufw</code> 是否已放行 21114–21119/TCP 与 21116/UDP。</li>
</ul>
</li>
<li>连接总是走中继：
<ul>
<li>很可能是客户端之间 NAT 穿透失败。确保 21116/UDP 放行；或接受通过中继连接。</li>
</ul>
</li>
<li>提示 Key 不匹配：
<ul>
<li>确保客户端填写的 <code>Key</code> 与服务器当前输出的一致；变更服务器后需更新客户端配置。</li>
</ul>
</li>
<li>服务名不确定：
<ul>
<li>可执行 <code>systemctl list-units | grep hbbs</code> 与 <code>grep hbbr</code> 查找具体服务名称。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">7. 运维与升级（简要）</h2>
<ul>
<li>重启服务：
<pre><code class="hljs language-shell" lang="shell">sudo systemctl restart hbbs
sudo systemctl restart hbbr
</code></pre>
</li>
<li>日志查看：
<pre><code class="hljs language-shell" lang="shell">journalctl -u hbbs --no-pager -n 200
journalctl -u hbbr --no-pager -n 200
</code></pre>
</li>
<li>安全建议：
<ul>
<li>生产环境将安全组授权对象从 <code>0.0.0.0/0</code> 收紧到可信网段。</li>
<li>定期更新系统并重启服务，减少已知漏洞风险。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-8">8. 一键更换默认端口脚本（含安全收敛）</h2>
<p>为便于快速落地，提供一键脚本：</p>
<ul>
<li>让 <code>hbbs/hbbr</code> 在自定义端口监听（需要提供中继主机与可选密钥文件）。</li>
</ul>
<p>端口范围与建议：</p>
<ul>
<li>可修改范围：<code>1024–65535</code>（避免使用 <code>0–1023</code> 的保留端口）。</li>
<li>推荐选择高位端口（如 <code>20000–40000</code>），并提前检查占用：<code>ss -tunlp | grep &lt;PORT&gt;</code>。</li>
</ul>
<p>将脚本文件 <code>rustdesk-port-switch.sh</code> 上传到服务器（例如 <code>/usr/local/sbin/</code>），并赋予执行权限：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/usr/bin/env bash</span>
set -euo pipefail
<span class="hljs-meta prompt_">
# </span><span class="bash">常量: 默认端口</span>
DEFAULT_NAT=21116
DEFAULT_RELAY=21117
DEFAULT_HBBS_WS=21118
DEFAULT_HBBR_WS=21119

BASE=""
NAT_PORT=""
RELAY_PORT=""
HBBS_WS=""
HBBR_WS=""
RELAY_HOST=""
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 打印用法说明与端口范围</span>
usage() {
  cat &lt;&lt;'USAGE'
用法: sudo bash rustdesk-port-switch.sh
说明: 纯交互式，直接修改 hbbs/hbbr 监听端口（override 模式）
端口范围: 1024–65535，建议 20000–40000，避免 0–1023 保留端口
USAGE
}
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 检查是否 root</span>
require_root() {
  if [ "${EUID:-$(id -u)}" -ne 0 ]; then
    echo "需要以 root 运行" &gt;&amp;2
    exit 1
  fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 验证端口范围与合法性</span>
validate_port() {
  local p="$1"
  [[ "$p" =~ ^[0-9]+$ ]] || { echo "端口必须为数字: $p" &gt;&amp;2; exit 1; }
  if [ "$p" -lt 1024 ] || [ "$p" -gt 65535 ]; then
    echo "端口超出允许范围(1024–65535): $p" &gt;&amp;2
    exit 1
  fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 计算最终端口组合</span>
compute_ports() {
  if [ -n "$BASE" ]; then
    NAT_PORT="$BASE"
    RELAY_PORT=$((BASE+2))
    # WebSocket 端口仅在显式指定时设置
  fi
  : "${NAT_PORT:=${NAT_PORT:-}}"
  : "${RELAY_PORT:=${RELAY_PORT:-}}"
  [ -n "$NAT_PORT" ] || NAT_PORT="$DEFAULT_NAT"
  [ -n "$RELAY_PORT" ] || RELAY_PORT="$DEFAULT_RELAY"

  validate_port "$NAT_PORT"; validate_port "$RELAY_PORT"
  [ -n "$HBBS_WS" ] &amp;&amp; validate_port "$HBBS_WS"
  [ -n "$HBBR_WS" ] &amp;&amp; validate_port "$HBBR_WS"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 交互式询问模式/端口/安全选项</span>
is_port_used() {
  local p="$1"
  ss -H -l -n | awk '{print $5}' | awk -F: '{print $NF}' | grep -qx "$p"
}

suggest_base_port() {
  local tries=0 max=30 b
  while [ $tries -lt $max ]; do
    b=$((20000 + RANDOM % 20001))
    [ $((b+4)) -le 65535 ] || { tries=$((tries+1)); continue; }
    if is_port_used "$b" || is_port_used $((b+2)) || is_port_used $((b+3)) || is_port_used $((b+4)); then
      tries=$((tries+1)); continue
    fi
    BASE_SUG="$b"
    HBBS_WS_SUG=$((b+3))
    HBBR_WS_SUG=$((b+4))
    return 0
  done
  BASE_SUG=30022
  HBBS_WS_SUG=30025
  HBBR_WS_SUG=30026
}

interactive_prompt() {
  suggest_base_port
  echo "推荐基准端口: ${BASE_SUG} (hbbs(NAT)=${BASE_SUG}, hbbr(Relay)=$((BASE_SUG+2)); WS: hbbs=${HBBS_WS_SUG}, hbbr=${HBBR_WS_SUG})"
  echo "可输入基准端口(如 30022), 将自动设置: hbbs(NAT)=base, hbbr(Relay)=base+2"
  read -r -p "基准端口(回车使用推荐 ${BASE_SUG}): " BASE
  if [ -z "$BASE" ]; then BASE="$BASE_SUG"; fi
  validate_port "$BASE"

  NAT_PORT="$BASE"; RELAY_PORT=$((BASE+2))
<span class="hljs-meta prompt_">
  # </span><span class="bash">可选 WebSocket 端口</span>
  read -r -p "是否设置 WebSocket 端口（推荐 hbbs=${HBBS_WS_SUG} hbbr=${HBBR_WS_SUG}，官方默认 21118/21119）[y/N]: " ws_sel
  case "${ws_sel,,}" in
    y|yes)
      echo "推荐 WebSocket 端口: hbbs=${HBBS_WS_SUG} hbbr=${HBBR_WS_SUG}"
      read -r -p "hbbs WebSocket 端口(回车使用推荐 ${HBBS_WS_SUG}): " HBBS_WS
      [ -z "$HBBS_WS" ] &amp;&amp; HBBS_WS="$HBBS_WS_SUG"
      validate_port "$HBBS_WS"
      read -r -p "hbbr WebSocket 端口(回车使用推荐 ${HBBR_WS_SUG}): " HBBR_WS
      [ -z "$HBBR_WS" ] &amp;&amp; HBBR_WS="$HBBR_WS_SUG"
      validate_port "$HBBR_WS"
      ;;
    *) : ;;
  esac

  read -r -p "中继主机(域名或IP): " RELAY_HOST
  if [ -z "$RELAY_HOST" ]; then
    echo "需要提供中继主机"; exit 1
  fi

  echo "\n配置摘要:";
  echo "hbbs(NAT) 端口: ${NAT_PORT}  hbbr(Relay) 端口: ${RELAY_PORT}"
  [ -n "$HBBS_WS" ] &amp;&amp; echo "hbbs WS: ${HBBS_WS}"
  [ -n "$HBBR_WS" ] &amp;&amp; echo "hbbr WS: ${HBBR_WS}"
  echo "中继主机: ${RELAY_HOST}"

  read -r -p "继续执行? [y/N]: " go
  case "${go,,}" in y|yes) : ;; *) echo "已取消"; exit 1;; esac
}
<span class="hljs-meta prompt_">
# </span><span class="bash">(移除 NAT 重定向逻辑)</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: UFW 开放新端口</span>
ensure_ufw_rules() {
  if ! command -v ufw &gt;/dev/null 2&gt;&amp;1; then
    apt-get update -y &amp;&amp; apt-get install -y ufw
  fi
  ufw allow "${NAT_PORT}/udp" || true
  ufw allow "${NAT_PORT}/tcp" || true
  ufw allow "${RELAY_PORT}/tcp" || true
  [ -n "$HBBS_WS" ] &amp;&amp; ufw allow "${HBBS_WS}/tcp" || true
  [ -n "$HBBR_WS" ] &amp;&amp; ufw allow "${HBBR_WS}/tcp" || true
  ufw status | cat
}
<span class="hljs-meta prompt_">
# </span><span class="bash">(移除持久化 iptables 逻辑)</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 写入 systemd override</span>
write_override() {
  local hbbs_path hbbr_path unit path_guess
<span class="hljs-meta prompt_">
  # </span><span class="bash">优先使用用户指定路径</span>
  hbbs_path="${HBBS_PATH:-}"
  hbbr_path="${HBBR_PATH:-}"
<span class="hljs-meta prompt_">
  # </span><span class="bash">通过 PATH 查找</span>
  [ -z "$hbbs_path" ] &amp;&amp; hbbs_path="$(command -v hbbs || true)"
  [ -z "$hbbr_path" ] &amp;&amp; hbbr_path="$(command -v hbbr || true)"
<span class="hljs-meta prompt_">
  # </span><span class="bash">通过 systemd 单元解析 ExecStart</span>
  if [ -z "$hbbs_path" ]; then
    unit="$(systemctl cat hbbs 2&gt;/dev/null || true)"
    path_guess="$(echo "$unit" | awk -F= '/^ExecStart=/{print $2}' | awk '{print $1}' | tail -n1)"
    [ -n "$path_guess" ] &amp;&amp; hbbs_path="$path_guess"
  fi
  if [ -z "$hbbr_path" ]; then
    unit="$(systemctl cat hbbr 2&gt;/dev/null || true)"
    path_guess="$(echo "$unit" | awk -F= '/^ExecStart=/{print $2}' | awk '{print $1}' | tail -n1)"
    [ -n "$path_guess" ] &amp;&amp; hbbr_path="$path_guess"
  fi
<span class="hljs-meta prompt_">
  # </span><span class="bash">常见路径回退</span>
  [ -z "$hbbs_path" ] &amp;&amp; for p in /usr/local/bin/hbbs /usr/bin/hbbs /opt/rustdesk/hbbs /opt/rustdesk-server/hbbs; do [ -x "$p" ] &amp;&amp; hbbs_path="$p" &amp;&amp; break; done
  [ -z "$hbbr_path" ] &amp;&amp; for p in /usr/local/bin/hbbr /usr/bin/hbbr /opt/rustdesk/hbbr /opt/rustdesk-server/hbbr; do [ -x "$p" ] &amp;&amp; hbbr_path="$p" &amp;&amp; break; done

  [ -n "$hbbs_path" ] &amp;&amp; [ -x "$hbbs_path" ] || { echo "未找到可执行的 hbbs, 请确认安装在 /opt/rustdesk/hbbs 或 /usr/local/bin/hbbs"; exit 1; }
  [ -n "$hbbr_path" ] &amp;&amp; [ -x "$hbbr_path" ] || { echo "未找到可执行的 hbbr, 请确认安装在 /opt/rustdesk/hbbr 或 /usr/local/bin/hbbr"; exit 1; }
<span class="hljs-meta prompt_">
  # </span><span class="bash">写入 systemd 配置：若主单元存在则写 override；否则创建新的单元文件</span>
  if systemctl cat hbbs &gt;/dev/null 2&gt;&amp;1; then
    mkdir -p /etc/systemd/system/hbbs.service.d
    cat &gt;/etc/systemd/system/hbbs.service.d/override.conf &lt;&lt;EOF
[Service]
ExecStart=
ExecStart=${hbbs_path} -p ${NAT_PORT} -r ${RELAY_HOST}:${RELAY_PORT}
EOF
  else
    cat &gt;/etc/systemd/system/hbbs.service &lt;&lt;EOF
[Unit]
Description=RustDesk HBBS (ID server)
After=network.target

[Service]
Type=simple
ExecStart=${hbbs_path} -p ${NAT_PORT} -r ${RELAY_HOST}:${RELAY_PORT}
Restart=always
RestartSec=2s
User=root

[Install]
WantedBy=multi-user.target
EOF
  fi

  if systemctl cat hbbr &gt;/dev/null 2&gt;&amp;1; then
    mkdir -p /etc/systemd/system/hbbr.service.d
    cat &gt;/etc/systemd/system/hbbr.service.d/override.conf &lt;&lt;EOF
[Service]
ExecStart=
ExecStart=${hbbr_path} -p ${RELAY_PORT}
EOF
  else
    cat &gt;/etc/systemd/system/hbbr.service &lt;&lt;EOF
[Unit]
Description=RustDesk HBBR (Relay server)
After=network.target

[Service]
Type=simple
ExecStart=${hbbr_path} -p ${RELAY_PORT}
Restart=always
RestartSec=2s
User=root

[Install]
WantedBy=multi-user.target
EOF
  fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 重载并重启服务</span>
restart_services() {
  systemctl daemon-reload
  systemctl enable hbbs &gt;/dev/null 2&gt;&amp;1 || true
  systemctl enable hbbr &gt;/dev/null 2&gt;&amp;1 || true
  systemctl restart hbbs || true
  systemctl restart hbbr || true
  systemctl --no-pager -q status hbbs hbbr || true
}
<span class="hljs-meta prompt_">
# </span><span class="bash">函数: 提取并保存最新 Key 到脚本同级目录，并打印</span>
save_and_print_key() {
  local key line script_dir key_file
<span class="hljs-meta prompt_">  # </span><span class="bash">从 hbbs 日志提取最新 Key</span>
  line=$(journalctl -u hbbs -n 200 --no-pager 2&gt;/dev/null | grep -E "Key:" | tail -n1 || true)
  if [ -z "$line" ]; then
    line=$(journalctl -u hbbr -n 200 --no-pager 2&gt;/dev/null | grep -E "Key:" | tail -n1 || true)
  fi
  key=$(echo "$line" | sed -E 's/^.*Key:\s*([A-Za-z0-9+\/=]+).*$/\1/' )
  script_dir=$(cd -- "$(dirname -- "$0")" &amp;&amp; pwd)
  key_file="$script_dir/rustdesk.key"
  if [ -n "$key" ]; then
    printf "%s\n" "$key" &gt; "$key_file"
    chmod 600 "$key_file" 2&gt;/dev/null || true
    echo "- ID 服务器 ： ${RELAY_HOST}:${NAT_PORT}"
    echo "- 中继服务器 ： ${RELAY_HOST}:${RELAY_PORT}"
    echo "- Key: $key"
    echo "已保存到: $key_file"
  else
    echo "- ID 服务器 ： ${RELAY_HOST}:${NAT_PORT}"
    echo "- 中继服务器 ： ${RELAY_HOST}:${RELAY_PORT}"
    echo "- Key: (未解析)"
    echo "未从日志解析到 Key。可稍后运行: journalctl -u hbbs -n 200 | grep -i Key"
  fi
}

require_root
interactive_prompt

if [ -z "$RELAY_HOST" ]; then
  echo "需要提供中继主机" &gt;&amp;2
  exit 1
fi
write_override
restart_services
ensure_ufw_rules
save_and_print_key
</code></pre>
<pre><code class="hljs language-shell" lang="shell">sudo mv rustdesk-port-switch.sh /usr/local/sbin/
sudo chmod +x /usr/local/sbin/rustdesk-port-switch.sh
</code></pre>
<p>交互式运行（无需参数）：</p>
<pre><code class="hljs language-shell" lang="shell">sudo bash /usr/local/sbin/rustdesk-port-switch.sh
</code></pre>
<ul>
<li>将依次询问基准端口或分别输入 hbbs/hbbr 端口、是否设置 WebSocket 端口，以及中继主机与密钥文件，确认后自动执行。</li>
<li>已内置自动探测 <code>hbbs</code>/<code>hbbr</code> 路径（包含 <code>/opt/rustdesk/hbbs</code> 与 <code>/opt/rustdesk/hbbr</code> 等常见位置），无需手动输入路径。</li>
<li>每次运行脚本都会随机推荐一组高位端口（避开已占用），包含 <code>hbbs(NAT)</code>、<code>hbbr(Relay)</code> 以及可选的 WebSocket 端口；直接回车可使用推荐值。</li>
<li>脚本会在执行完成后自动从日志解析最新 <code>Key</code>，并保存为脚本同级目录的 <code>rustdesk.key</code>（覆盖旧文件），同时在终端打印当前 <code>Key</code>。</li>
</ul>
<p>执行完成后终端将输出如下摘要，便于在客户端填写：</p>
<ul>
<li>ID 服务器 ： <code>&lt;你的域名或IP&gt;:&lt;hbbs端口&gt;</code></li>
<li>中继服务器 ： <code>&lt;你的域名或IP&gt;:&lt;hbbr端口&gt;</code></li>
<li>Key: <code>&lt;服务器当前Key&gt;</code></li>
<li>已保存到: <code>&lt;脚本同级目录&gt;/rustdesk.key</code></li>
</ul>
<blockquote>
<p>记得去阿里云等安全组开放重新设置的端口</p>
</blockquote>
<p>验证：3001[5-9]记得换成&lt;新设置的端口&gt;</p>
<pre><code class="hljs language-shell" lang="shell">ss -tunlp | grep -E '3001[5-9]'
nc -zv &lt;域名或IP&gt; &lt;新设置的端口&gt;
nc -zv &lt;域名或IP&gt; &lt;新设置的端口&gt;
</code></pre>
<h2 data-id="heading-9">9. 端口说明（了解即可）</h2>
<p>RustDesk 服务器默认使用 <code>21114–21119/TCP</code> 与 <code>21116/UDP</code>：</p>
<ul>
<li><code>21116/UDP</code>：NAT 打洞。</li>
<li><code>21117/TCP</code>：中继通道。</li>
<li>其余端口用于 ID 注册、握手与控制信令等（保留默认即可）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mutable.Set的特性，以及自定义类中equals和hashCode方法对集合去重逻辑的影响]]></title>    <link>https://juejin.cn/post/7578820431018754063</link>    <guid>https://juejin.cn/post/7578820431018754063</guid>    <pubDate>2025-12-02T00:40:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820431018754063" data-draft-id="7578699975414579200" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mutable.Set的特性，以及自定义类中equals和hashCode方法对集合去重逻辑的影响"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-02T00:40:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐老总"/> <meta itemprop="url" content="https://juejin.cn/user/3344078309963692"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mutable.Set的特性，以及自定义类中equals和hashCode方法对集合去重逻辑的影响
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3344078309963692/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐老总
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T00:40:12.000Z" title="Tue Dec 02 2025 00:40:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> caseclass

<span class="hljs-keyword">import</span> scala.collection.mutable

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">caseclass1</span> </span>{
   <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">var id: <span class="hljs-type">Int</span>, var name: <span class="hljs-type">String</span></span>) </span>{
     <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">equals</span></span>(obj: <span class="hljs-type">Any</span>): <span class="hljs-type">Boolean</span> = {
       <span class="hljs-keyword">val</span> other = obj.asInstanceOf[<span class="hljs-type">Book</span>]
       other.id == id &amp;&amp; other.name == name
     }

     <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hashCode</span></span>(): <span class="hljs-type">Int</span> = id
   }
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
      <span class="hljs-keyword">val</span> set1: mutable.<span class="hljs-type">Set</span>[<span class="hljs-type">Int</span>] = mutable.<span class="hljs-type">Set</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)


      set1 += <span class="hljs-number">1</span>
      set1 += <span class="hljs-number">1</span>
      set1 += <span class="hljs-number">1</span>
      set1 += <span class="hljs-number">1</span>
      println(set1)

      <span class="hljs-keyword">val</span> book1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Book</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"西游记"</span>)
      <span class="hljs-keyword">val</span> book2 = <span class="hljs-keyword">new</span> <span class="hljs-type">Book</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"西游记"</span>)

      println(book1 == book2)

      <span class="hljs-comment">//定义一个set，它的类型是Book，它可以装入的数据是book类型</span>
      <span class="hljs-keyword">val</span> set2: mutable.<span class="hljs-type">Set</span>[<span class="hljs-type">Book</span>] = mutable.<span class="hljs-type">Set</span>()
      set2 += book1
      set2 += book2

      println(set2)
    }
  }
</code></pre>
<p>这段 Scala 代码主要演示了可变集合<code>mutable.Set</code>的特性，以及自定义类中<code>equals</code>和<code>hashCode</code>方法对集合去重逻辑的影响，具体分析如下：</p>
<h3 data-id="heading-0">代码功能与执行结果</h3>
<ol>
<li><strong>整数集合去重</strong>：定义<code>mutable.Set[Int]</code>类型的<code>set1</code>，初始包含<code>1</code>和<code>2</code>，多次添加<code>1</code>后，集合仍为<code>Set(1, 2)</code>。因为<code>Set</code>的特性是自动去重，整数类型的相等性判断基于值，重复元素会被自动忽略。</li>
<li><strong>自定义类对象的相等性</strong>：自定义<code>Book</code>类重写了<code>equals</code>方法（通过<code>id</code>和<code>name</code>判断相等）和<code>hashCode</code>方法（基于<code>id</code>生成哈希值）。创建<code>book1</code>和<code>book2</code>（<code>id</code>和<code>name</code>均相同），<code>book1 == book2</code>输出<code>true</code>，符合重写...</li>
</ol>
<p>解释</p>
<p>这段 Scala 代码主要围绕<strong>可变集合<code>mutable.Set</code>的去重逻辑</strong>、<strong>自定义类的<code>equals</code>和<code>hashCode</code>方法重写</strong>展开，我们逐部分拆解解释：</p>
<h3 data-id="heading-1">1. 整数集合的去重演示</h3>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino">val set1: <span class="hljs-keyword">mutable</span>.Set[Int] = <span class="hljs-keyword">mutable</span>.<span class="hljs-built_in">Set</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
set1 += <span class="hljs-number">1</span>
set1 += <span class="hljs-number">1</span>
<span class="hljs-built_in">println</span>(set1)  <span class="hljs-comment">// 输出：Set(1, 2)</span>
</code></pre>
<ul>
<li><code>Set</code>（无论可变 / 不可变）的核心特性是<strong>元素唯一性</strong>，会自动过滤重复元素。</li>
<li>这里多次向<code>set1</code>添加<code>1</code>，但最终集合仍只保留一个<code>1</code>，因为整数类型（<code>Int</code>）的相等性判断是基于<strong>值本身</strong>的，<code>1 == 1</code>始终成立，所以重复添加无效。</li>
</ul>
<h3 data-id="heading-2">2. 自定义类<code>Book</code>的<code>equals</code>和<code>hashCode</code>重写</h3>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span>(<span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">var</span> name: String) {
  <span class="hljs-comment">// 重写equals：通过id和name判断两个Book对象是否相等</span>
  <span class="hljs-keyword">override</span> def equals(obj: Any): <span class="hljs-built_in">Boolean</span> = {
    <span class="hljs-keyword">val</span> other = obj.asInstanceOf[Book]  <span class="hljs-comment">// 将Any类型强转为Book</span>
    other.id == id &amp;&amp; other.name == name
  }

  <span class="hljs-comment">// 重写hashCode：基于id生成哈希值</span>
  <span class="hljs-keyword">override</span> def hashCode(): <span class="hljs-built_in">Int</span> = id
}
</code></pre>
<ul>
<li><strong><code>equals</code>方法</strong>：默认情况下，类的<code>equals</code>是基于<strong>对象引用</strong>的（即两个对象必须是内存中同一个实例才相等）。这里重写后，只要两个<code>Book</code>对象的<code>id</code>和<code>name</code>相同，就判定为相等（<code>book1 == book2</code>返回<code>true</code>）。</li>
<li><strong><code>hashCode</code>方法</strong>：哈希值是集合（如<code>Set</code>）存储元素时的 “快速索引”，<code>Set</code>会先通过<code>hashCode</code>分组，再对同组元素用<code>equals</code>判断是否重复。这里<code>hashCode</code>基于<code>id</code>生成，意味着<code>id</code>相同的<code>Book</code>对象会被分到同一组。</li>
</ul>
<h3 data-id="heading-3">3. <code>Book</code>对象存入<code>Set</code>的 “看似矛盾” 现象</h3>
<p>scala</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">book1</span> = new Book(<span class="hljs-number">1</span>, <span class="hljs-string">"西游记"</span>)
val <span class="hljs-attr">book2</span> = new Book(<span class="hljs-number">1</span>, <span class="hljs-string">"西游记"</span>)
println(<span class="hljs-attr">book1</span> == book2)  // 输出：<span class="hljs-literal">true</span>

val set2: mutable.Set<span class="hljs-section">[Book]</span> = mutable.Set()
set2 += book1
set2 += book2
println(set2)  // 输出：Set(Book@1, Book@1)（看似重复，实际是两个不同实例）
</code></pre>
<ul>
<li>
<p><strong><code>book1 == book2</code>为<code>true</code></strong>：因为我们重写了<code>equals</code>，<code>book1</code>和<code>book2</code>的<code>id</code>、<code>name</code>都相同，所以相等性判断成立。</p>
</li>
<li>
<p><strong><code>set2</code>中同时存在<code>book1</code>和<code>book2</code></strong>：这是关键的 “矛盾点”—— 明明<code>book1 == book2</code>为<code>true</code>，但<code>Set</code>却没有去重？原因在于：<code>Set</code>的去重逻辑依赖 <strong><code>hashCode</code>和<code>equals</code>的协同 <strong>，且对于</strong>普通类</strong>（非样例类），即使重写了<code>equals</code>和<code>hashCode</code>，<code>Set</code>仍会结合<strong>对象引用</strong>辅助判断（或因 JVM 的哈希碰撞处理细节）。更本质的是：</p>
<ul>
<li><code>book1</code>和<code>book2</code>是<strong>两个不同的对象实例</strong>（内存地址不同），而<code>mutable.Set</code>对普通类的去重逻辑，在<code>hashCode</code>相同、<code>equals</code>为<code>true</code>时，仍可能因 “实例唯一性” 保留多个对象（这是普通类与样例类的核心区别）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">4. 为什么用样例类（<code>case class</code>）就能正确去重？</h3>
<p>如果将<code>Book</code>定义为<strong>样例类</strong>：</p>
<p>scala</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">case</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span>(<span class="hljs-keyword">var</span> <span class="hljs-attr">id</span>: <span class="hljs-title class_">Int</span>, <span class="hljs-keyword">var</span> <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>)  <span class="hljs-comment">// 无需手动重写equals/hashCode</span>
</code></pre>
<p>此时<code>set2 += book1; set2 += book2</code>会输出<code>Set(Book(1,西游记))</code>，因为样例类会<strong>自动生成基于构造参数的<code>equals</code>和<code>hashCode</code></strong>，完全遵循 “值相等即对象相等” 的逻辑，<code>Set</code>会正确识别重复并去重。</p>
<h3 data-id="heading-5">总结</h3>
<ul>
<li><code>Set</code>的去重依赖<code>hashCode</code>（分组）和<code>equals</code>（判重）的协同。</li>
<li>普通类需手动重写<code>equals</code>和<code>hashCode</code>，但仍可能因 “实例引用” 导致<code>Set</code>去重失效；样例类自动实现正确的<code>equals</code>和<code>hashCode</code>，是 Scala 中实现 “值相等” 的推荐方式。</li>
<li>整数等基础类型的<code>equals</code>和<code>hashCode</code>已默认实现 “值相等”，因此<code>Set</code>对基础类型的去重始终有效。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙系统 4.1.0 兼容 Android apk 如何检测兼容的 Android 系统版本是多少]]></title>    <link>https://juejin.cn/post/7578780780026609673</link>    <guid>https://juejin.cn/post/7578780780026609673</guid>    <pubDate>2025-12-02T02:15:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578780780026609673" data-draft-id="7578803751608582194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙系统 4.1.0 兼容 Android apk 如何检测兼容的 Android 系统版本是多少"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-02T02:15:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lichong951"/> <meta itemprop="url" content="https://juejin.cn/user/1486195453865687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙系统 4.1.0 兼容 Android apk 如何检测兼容的 Android 系统版本是多少
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1486195453865687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lichong951
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:15:53.000Z" title="Tue Dec 02 2025 02:15:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>HarmonyOS 4.1.0 仍属于“兼容 AOSP”的常规版本，<strong>并未切换到纯血鸿蒙 NEXT</strong>。
根据华为官方版本对照表，<strong>HarmonyOS 4.1 对应的 Android 兼容层为 Android 12（API 31）</strong>，与 4.0 同属一个分支，只是补丁级别更高 。
因此，在 4.1.0 设备上安装 APK 时，<strong>按 Android 12 的兼容性进行测试即可</strong>；若出现仅 Android 13+ 才引入的 API，需要降级或做兼容性判断。</p>
<hr/>
<p>在“兼容 AOSP”的鸿蒙版本（3.x/4.x，非 NEXT）上，Java 代码与 Android 完全相同，直接读取 <code>Build.VERSION</code> 即可得到当前运行时的 Android 兼容层版本，示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> android.os.Build;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getAndroidCompatibleVersion</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 示例返回：12</span>
    <span class="hljs-keyword">return</span> Build.VERSION.RELEASE;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAndroidCompatibleSdkInt</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 示例返回：31（对应 Android 12）</span>
    <span class="hljs-keyword">return</span> Build.VERSION.SDK_INT;
}
</code></pre>
<p>若还想确认“是不是鸿蒙”，可再取两项系统属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 厂商</span>
<span class="hljs-type">String</span> <span class="hljs-variable">manu</span> <span class="hljs-operator">=</span> Build.MANUFACTURER;          <span class="hljs-comment">// HUAWEI  </span>
<span class="hljs-comment">// 2. 鸿蒙增量版本号（仅鸿蒙设备存在）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">incremental</span> <span class="hljs-operator">=</span> Build.VERSION.INCREMENTAL; <span class="hljs-comment">// 例如 4.1.0.xxx</span>
</code></pre>
<p>当 <code>manu.equals("HUAWEI")</code> 且 <code>incremental</code> 以 <code>"Harmony"</code> 或 <code>"4.1.0"</code> 等开头时，即可判定为鸿蒙系统，同时 <code>Build.VERSION.RELEASE</code> 就是它所兼容的 Android 版本，鸿蒙 4.1.x 通常为 <strong>Android 12（API 31）</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[收到第一封推广邮件：我的 App 正在被看见]]></title>    <link>https://juejin.cn/post/7578781397117386798</link>    <guid>https://juejin.cn/post/7578781397117386798</guid>    <pubDate>2025-12-02T02:21:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578781397117386798" data-draft-id="7578724773994332186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="收到第一封推广邮件：我的 App 正在被看见"/> <meta itemprop="keywords" content="后端,前端,产品"/> <meta itemprop="datePublished" content="2025-12-02T02:21:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HBLOG"/> <meta itemprop="url" content="https://juejin.cn/user/131597124767479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            收到第一封推广邮件：我的 App 正在被看见
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597124767479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HBLOG
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:21:58.000Z" title="Tue Dec 02 2025 02:21:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上线 App 才没多久，今天忽然收到了一封推广邮件。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2025%2F12%2Fimage.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2025/12/image.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7f86360bf224498a9bdfc8234879008~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765246918&amp;x-signature=rz0nhasniXI%2BLAJCQwxG%2F3nDH8A%3D" alt="" loading="lazy"/></a></p>
<p>说实话，看到的那一刻，心里竟然有一点点惊喜。</p>
<p>不是因为邮件本身，而是那种——<br/>
“原来真的有人在关注、有人在尝试、有人愿意了解我们”的感觉。<br/>
做产品的人应该都懂：<br/>
从灵感到设计，从功能到体验，从打磨到上线……<br/>
每一步都像把自己的心血推向世界，但到底有没有人在意，却永远是未知数。</p>
<p>所以，当第一封推广邮件悄悄出现，就像有人轻轻拍了一下肩膀：<br/>
<strong>“嘿，你做的事情，确实有人看见了。”</strong></p>
<p>它不代表成功，但说明方向没错；<br/>
不代表爆发，但代表开始有了涟漪。<br/>
这封邮件让我重新感到被肯定，也让我更确信：<br/>
所有那些深夜的构思、反复的修改、不断的技术调整，是真的值得的。</p>
<p>未来会怎样我不知道，但至少现在的我，会继续踏实地把每一个功能做到更好，把每一个细节做得更让人喜欢。</p>
<p>毕竟，这是属于我们和这款 App 的第一封信号灯。<br/>
它微弱，却真实；<br/>
不耀眼，却温暖；<br/>
但它告诉我：<br/>
<strong>“继续往前走，就对了。”</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 文字信息图表的技术选型]]></title>    <link>https://juejin.cn/post/7578793960626536474</link>    <guid>https://juejin.cn/post/7578793960626536474</guid>    <pubDate>2025-12-02T02:24:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578793960626536474" data-draft-id="7578781397117370414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 文字信息图表的技术选型"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-12-02T02:24:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据体验技术"/> <meta itemprop="url" content="https://juejin.cn/user/1486195450988471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 文字信息图表的技术选型
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6944740539795259422/posts" data-v-d326b38e=""><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9909c804423411fa9fa1df65b5069d8~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6944740539795259422/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="蚂蚁集团数据体验技术团队" class="title" data-v-d326b38e="">蚂蚁集团数据体验技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-02T02:24:04.000Z" title="Tue Dec 02 2025 02:24:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-02
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                7
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读5分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              数据可视化
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>文字信息是最朴素的信息载体，即使是 AI 时代，大模型的输出都是文字信息居多。</p>
<h2 data-id="heading-0">文本信息图</h2>
<p>我们大量的产品，其实都是在做文字信息的整合和可视化，比如：PPT、流程图、思维导图、信息海报等软件，包括一些博客的图文混排模式，其实都是在对文字信息进行归纳和可视化，这部分我们都可以称之为文本信息的可视化，或者信息图可视化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edc4beb0c63946aa9b58398cf24f3794~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=C3hNiEY869f1k4YPhiuLfxNhnEw%3D" alt="image.png" loading="lazy"/></p>
<p>AI 时代下，文本大模型对于文本信息理解和处理能力大大加强，大模型能很清楚的理解文字的结构信息，表达的核心观点，以及从非结构信息中抽取和推理有用的、结构化信息。</p>
<p>所以在 AI 来临之后，有大量的 AI Agent 应用都是关注在文字的处理和呈现上的，比如 AI PPT、AI 流程图、AI 图表、以及各类的 DeepResearch 应用。</p>
<p>最近蚂蚁集团发布的很火的灵光，抢眼的表现，原因之一就是灵光可以让模型输出更多形态的内容，包括图片、视频、3D、交互图表，信息图等。</p>
<h2 data-id="heading-1">技术实现和选型</h2>
<p>业界上，实现文本信息可视化的，有一些形态，但是大部分，都是信息图的制作平台。如果大家做过调研，大概就知道如下的产品。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7451fb008b0148bf8eb31e5d44da1491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=%2F%2FO%2F1ip1d08%2F6gSxn%2FdHWaaW6mw%3D" alt="image.png" loading="lazy"/></p>
<p>核心功能基本都是一致的：</p>
<ul>
<li>AI 能力层：选择合适的模版，从用户文本抽取数据。</li>
<li>输出信息图：支持导出 PNG/SVG 等多种媒介格式。</li>
<li>信息图编辑：提供在线 Web 可视化界面交互配置。</li>
<li>数据存储：设计DSL Schema / 画布状态保存数据。</li>
<li>信息图渲染：基于浏览器 Canvas/SVG 封装渲染引擎。</li>
</ul>
<p>但是问题也很明显：付费使用、模板灵活性低、闭源的生态、集成到应用基本不可能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e2245d33ed40fdad76d466fb8f9df4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=uatFno1zlF3GfiQSEVj5We7LEGU%3D" alt="image.png" loading="lazy"/></p>
<p>所以我们在想，如果我们的业务系统需要实现类似的文本信息图可视化该怎么做，有几种方案：</p>
<h3 data-id="heading-2">Mermaid</h3>
<p>是一个基于 JavaScript 的绘图和图表工具，呈现受 Markdown 启发的文本定义，以动态创建和修改图表。常用于创建：时序图、流程图、类图、时间轴，等 ~20 中图表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e9f4c51aed4e219195c96f720f7d08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=g%2FDYClrJTeZ%2F7lO3W%2FaHw1YY8mo%3D" alt="image.png" loading="lazy"/></p>
<p>是社区广泛采用的一种方案，当然，问题就是图形一般偏技术的同学看的，对于普通的文字内容和结构呈现，并不适合。</p>
<h3 data-id="heading-3">使用 AI 直出 HTML + SVG</h3>
<p>使用 AI 大模型 + 提示词，生成最终的 HTML 或者 SVG，然后最终生成对应的 HTML 或者 SVG 渲染，这个可能是未来长期的方向。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1bc5b2d94134c459b6ff3d012b315c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=5n2iwVtuJG%2FUtGUOTmxceGxzDBw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dc8476f5304440c9d0d209710cdc9bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=rUU9GmwZW3F9ZlUz4Y3twFygmcc%3D" alt="image.png" loading="lazy"/></p>
<p>不过就目前的效果来看，HTML 效果比 SVG 要稍微好一点，SVG 生成依然会遇到各种布局点的位置，特别像文字碰撞基本无法处理；HTML 上就是风格上会比较单一一些，颜色和 border 上，有很强的 AI 味道。</p>
<h3 data-id="heading-4">使用多模态大模型生成信息图图片</h3>
<p>gemini 3 发布，加上 banana pro 的发布，让多模态模型直接输出信息图，基本变成了现实，效果很好，而且在大部分多模态遇到的中文问题，也能很好的解决。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dacd03d5fe846128962dbc96dad5bad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=4MNa780v8UwV4TsqwS8aPiu3AaM%3D" alt="image.png" loading="lazy"/></p>
<p>当然，也会有一些小问题，这些问题更多是图片这个存储格式带来的：</p>
<ol>
<li>无法二次编辑，或者很好做到很好的二次编辑</li>
<li>无法实现动画效果</li>
<li>无法交互</li>
</ol>
<h3 data-id="heading-5">AntV Infographic</h3>
<p>Infographic 是 AntV 在 2025 年 11 月 22 日开源出来的一个信息图可视化框架，主要关注在渲染部分，提供了 100+ 的优质信息图模版，除此之外，也增加了自定义的开发能力，让模版数量能倍数增长；图的设计风格比较适用于 PPT 和写文章配图的那种场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39ecea2d094d4578a6cd8a1789bc5e24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=1SQcC4IiXAbkNa1S%2FpM3BCxk9IQ%3D" alt="image.png" loading="lazy"/></p>
<p>也有提供各种风格，内置深色模式、手绘、纹理视觉风格，手绘风格这个很酷。另外，为了在 AI 上更好的使用，也做了 AI 友好的配置和描述，并在官网提供了 AI Agent 来使用，以及用于二次编辑的编辑器组件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/204fb7f2e41f484fb77398c736565fc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=A1zraFDlXchKKBrRmlhDaBDGxWw%3D" alt="image.png" loading="lazy"/></p>
<p>所以相关文本信息图可视化的业务，接入的时候，只需要参考响应的提示词，生成 Infographic 的配置，然后使用 Infographic 渲染即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c1932d48fa54cb3aa674ea7905b1093~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247507&amp;x-signature=IitGkLia%2BE0tsfWog6d9wUACIng%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">技术选型总结</h2>
<p>最后总结一下，AI 产品在处理文本信息图可视化的方案对比，仅供参考。</p>






























<table><thead><tr><th><strong>方案</strong></th><th><strong>优势</strong></th><th><strong>劣势</strong></th></tr></thead><tbody><tr><td>Mermaid</td><td>+ 社区影响力大<br/>+ 能力丰富，强大<br/>+ 模型输出准确</td><td>- 技术类型的信息图<br/>- 不适用于普通文本信息可视化<br/>- 包比较大 2.7 Mb</td></tr><tr><td>AI 出 HTML / SVG</td><td>+ 接入简单容易</td><td>- 准确度、风格不可控<br/>- 模版样式比较单一<br/>- 会容易出现一些体验问题</td></tr><tr><td>多模态出图片</td><td>+ 新的 banana pro 效果不错</td><td>- 无法编辑、无动画和交互<br/>- 闭源模型，调用贵</td></tr><tr><td>AntV Infographic</td><td>+ 开源、免费<br/>+ 模版丰富，目前内置 100+，可开发扩展，支持不同风格<br/>+ 支持编辑，以及提供编辑器<br/>+ 接入过程完全可控<br/>+ 包轻量，410 Kb</td><td>- 集成有 Agent 研发工作量（开发和测评）</td></tr></tbody></table>
<blockquote>
<p>综上，个人建议，如果在做 AI 文字配图，信息图之类的需求，可以考虑使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantvis%2Finfographic" target="_blank" title="https://github.com/antvis/infographic" ref="nofollow noopener noreferrer">AntV Infographic</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.js.org%2F" target="_blank" title="https://mermaid.js.org/" ref="nofollow noopener noreferrer">Mermaid</a> 相结合的方式，技术图表使用 Mermaid，常见的 PPT、文字结构配图，使用 AntV Infographic。</p>
</blockquote>
<h2 data-id="heading-7">最后</h2>
<p>信息图的生成，未来大模型一定会支持直出代码，但是当前来看，这个时间可能依然还是 2-3 年后，个人感觉这丝毫不影响信息图渲染技术的持续迭代。</p>
<p>因为 AI 不会减少需求，反而会扩大用户量，提升需求和用户量，而信息图渲染技术 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2F" target="_blank" title="https://infographic.antv.vision/" ref="nofollow noopener noreferrer">Infographic</a> 会因为这个需求的增长，具有更多的用户量。</p>
<blockquote>
<p>AI 直接出码是趋势，但是不代表基础技术库消亡，而是作为出码的依赖存在。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java `this` 关键字深度解析]]></title>    <link>https://juejin.cn/post/7578777952726499362</link>    <guid>https://juejin.cn/post/7578777952726499362</guid>    <pubDate>2025-12-02T02:19:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578777952726499362" data-draft-id="7578797337867272226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java `this` 关键字深度解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T02:19:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小周在成长"/> <meta itemprop="url" content="https://juejin.cn/user/3632442150752573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java `this` 关键字深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3632442150752573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小周在成长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:19:47.000Z" title="Tue Dec 02 2025 02:19:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📖 <code>this</code> 关键字概述</h2>
<h3 data-id="heading-1"><strong>什么是 this？</strong></h3>
<p><code>this</code> 是一个指向<strong>当前对象</strong>的引用变量，在实例方法和构造器中使用。</p>
<h3 data-id="heading-2"><strong>this 的核心作用</strong></h3>
<ul>
<li>指向当前对象实例</li>
<li>解决<strong>变量名冲突</strong></li>
<li>在构造器中调用其他构造器</li>
<li>作为参数传递当前对象</li>
</ul>
<h2 data-id="heading-3">🎯 <code>this</code> 的四种用法</h2>
<h3 data-id="heading-4"><strong>用法1：引用当前对象的成员变量（最常见）</strong></h3>
<h4 data-id="heading-5"><strong>解决局部变量与成员变量同名问题</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">private</span> String name;    <span class="hljs-comment">// 成员变量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;        <span class="hljs-comment">// 成员变量</span>
    
    <span class="hljs-comment">// 构造器参数与成员变量同名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-comment">// 使用this区分成员变量和局部变量</span>
        <span class="hljs-built_in">this</span>.name = name;   <span class="hljs-comment">// this.name 是成员变量，name是参数</span>
        <span class="hljs-built_in">this</span>.age = age;     <span class="hljs-comment">// this.age 是成员变量，age是参数</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;   <span class="hljs-comment">// 区分成员变量和参数</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
    
    <span class="hljs-comment">// 没有歧义时，this可以省略</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这里没有局部变量name和age，可以直接访问成员变量</span>
        System.out.println(<span class="hljs-string">"姓名: "</span> + name + <span class="hljs-string">", 年龄: "</span> + age);
        
        <span class="hljs-comment">// 使用this也可以（但没必要）</span>
        System.out.println(<span class="hljs-string">"姓名: "</span> + <span class="hljs-built_in">this</span>.name + <span class="hljs-string">", 年龄: "</span> + <span class="hljs-built_in">this</span>.age);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Student</span> <span class="hljs-variable">stu</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">20</span>);
        stu.display();
    }
}
</code></pre>
<h4 data-id="heading-6"><strong>更复杂的例子</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> salary;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateEmployee</span><span class="hljs-params">(<span class="hljs-type">int</span> id, String name, <span class="hljs-type">double</span> salary)</span> {
        <span class="hljs-comment">// 使用this明确区分</span>
        <span class="hljs-built_in">this</span>.id = id;           <span class="hljs-comment">// 左边是成员变量，右边是参数</span>
        <span class="hljs-built_in">this</span>.name = name;       <span class="hljs-comment">// 左边是成员变量，右边是参数</span>
        <span class="hljs-built_in">this</span>.salary = salary;   <span class="hljs-comment">// 左边是成员变量，右边是参数</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 没有局部变量冲突，可以不用this（但用this更清晰）</span>
        System.out.println(<span class="hljs-string">"ID: "</span> + <span class="hljs-built_in">this</span>.id);
        System.out.println(<span class="hljs-string">"姓名: "</span> + <span class="hljs-built_in">this</span>.name);
        System.out.println(<span class="hljs-string">"薪资: "</span> + <span class="hljs-built_in">this</span>.salary);
    }
}
</code></pre>
<h3 data-id="heading-7"><strong>用法2：在构造器中调用其他构造器（this()）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> width;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> height;
    <span class="hljs-keyword">private</span> String color;
    
    <span class="hljs-comment">// 构造器1：默认构造器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Rectangle</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 调用三参构造器，提供默认值</span>
        <span class="hljs-built_in">this</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"黑色"</span>);
        System.out.println(<span class="hljs-string">"调用默认构造器"</span>);
    }
    
    <span class="hljs-comment">// 构造器2：只有宽高</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Rectangle</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> {
        <span class="hljs-comment">// 调用三参构造器，使用默认颜色</span>
        <span class="hljs-built_in">this</span>(width, height, <span class="hljs-string">"黑色"</span>);
        System.out.println(<span class="hljs-string">"调用双参构造器"</span>);
    }
    
    <span class="hljs-comment">// 构造器3：完整参数（主要构造器）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Rectangle</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, String color)</span> {
        <span class="hljs-built_in">this</span>.width = width;
        <span class="hljs-built_in">this</span>.height = height;
        <span class="hljs-built_in">this</span>.color = color;
        System.out.println(<span class="hljs-string">"调用三参构造器"</span>);
    }
    
    <span class="hljs-comment">// 错误示例：不能形成循环调用</span>
    <span class="hljs-comment">/*
    public Rectangle() {
        this(10, 10);  // 调用双参构造器
    }
    
    public Rectangle(int width, int height) {
        this();  // ❌ 错误：循环调用，编译错误
    }
    */</span>
    
    <span class="hljs-comment">// 重要规则：this()必须是构造器的第一条语句</span>
    <span class="hljs-comment">/*
    public Rectangle() {
        System.out.println("初始化开始");  // ❌ 错误：必须在this()之前
        this(10, 10);  // 编译错误
    }
    */</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"宽: "</span> + width + <span class="hljs-string">", 高: "</span> + height + <span class="hljs-string">", 颜色: "</span> + color);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 创建对象1 ==="</span>);
        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">r1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>();
        r1.display();
        
        System.out.println(<span class="hljs-string">"\n=== 创建对象2 ==="</span>);
        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">r2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>(<span class="hljs-number">20</span>, <span class="hljs-number">30</span>);
        r2.display();
        
        System.out.println(<span class="hljs-string">"\n=== 创建对象3 ==="</span>);
        <span class="hljs-type">Rectangle</span> <span class="hljs-variable">r3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>(<span class="hljs-number">40</span>, <span class="hljs-number">50</span>, <span class="hljs-string">"红色"</span>);
        r3.display();
    }
}
</code></pre>
<h3 data-id="heading-8"><strong>用法3：作为参数传递当前对象</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThisAsParameter</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"methodA被调用"</span>);
        methodB(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// 将当前对象传递给methodB</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">(ThisAsParameter obj)</span> {
        System.out.println(<span class="hljs-string">"methodB接收到对象: "</span> + obj);
        obj.methodC();  <span class="hljs-comment">// 通过参数调用方法</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodC</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"methodC被调用"</span>);
    }
    
    <span class="hljs-comment">// 实际应用：链式调用</span>
    <span class="hljs-keyword">public</span> ThisAsParameter <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"设置名称: "</span> + name);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;  <span class="hljs-comment">// 返回当前对象，支持链式调用</span>
    }
    
    <span class="hljs-keyword">public</span> ThisAsParameter <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        System.out.println(<span class="hljs-string">"设置年龄: "</span> + age);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-keyword">public</span> ThisAsParameter <span class="hljs-title function_">setCity</span><span class="hljs-params">(String city)</span> {
        System.out.println(<span class="hljs-string">"设置城市: "</span> + city);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ThisAsParameter</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThisAsParameter</span>();
        
        <span class="hljs-comment">// 普通调用</span>
        obj.methodA();
        
        System.out.println(<span class="hljs-string">"\n=== 链式调用 ==="</span>);
        <span class="hljs-comment">// 链式调用（流畅接口）</span>
        obj.setName(<span class="hljs-string">"张三"</span>)
           .setAge(<span class="hljs-number">25</span>)
           .setCity(<span class="hljs-string">"北京"</span>);
           
        <span class="hljs-comment">// 等价于：</span>
        <span class="hljs-comment">// obj.setName("张三");</span>
        <span class="hljs-comment">// obj.setAge(25);</span>
        <span class="hljs-comment">// obj.setCity("北京");</span>
    }
}
</code></pre>
<h3 data-id="heading-9"><strong>用法4：返回当前对象（用于链式调用）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonBuilder</span> {
    <span class="hljs-keyword">private</span> String firstName;
    <span class="hljs-keyword">private</span> String lastName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> String address;
    
    <span class="hljs-comment">// 返回this，支持链式调用</span>
    <span class="hljs-keyword">public</span> PersonBuilder <span class="hljs-title function_">setFirstName</span><span class="hljs-params">(String firstName)</span> {
        <span class="hljs-built_in">this</span>.firstName = firstName;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-keyword">public</span> PersonBuilder <span class="hljs-title function_">setLastName</span><span class="hljs-params">(String lastName)</span> {
        <span class="hljs-built_in">this</span>.lastName = lastName;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-keyword">public</span> PersonBuilder <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-keyword">public</span> PersonBuilder <span class="hljs-title function_">setAddress</span><span class="hljs-params">(String address)</span> {
        <span class="hljs-built_in">this</span>.address = address;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(firstName, lastName, age, address);
    }
    
    <span class="hljs-comment">// 静态工厂方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PersonBuilder <span class="hljs-title function_">builder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersonBuilder</span>();
    }
    
    <span class="hljs-comment">// Person类</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
        <span class="hljs-keyword">private</span> String firstName;
        <span class="hljs-keyword">private</span> String lastName;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
        <span class="hljs-keyword">private</span> String address;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String firstName, String lastName, <span class="hljs-type">int</span> age, String address)</span> {
            <span class="hljs-built_in">this</span>.firstName = firstName;
            <span class="hljs-built_in">this</span>.lastName = lastName;
            <span class="hljs-built_in">this</span>.age = age;
            <span class="hljs-built_in">this</span>.address = address;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Person{firstName='%s', lastName='%s', age=%d, address='%s'}"</span>,
                               firstName, lastName, age, address);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 传统的多行设置</span>
        <span class="hljs-type">PersonBuilder</span> <span class="hljs-variable">builder1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersonBuilder</span>();
        builder1.setFirstName(<span class="hljs-string">"张"</span>);
        builder1.setLastName(<span class="hljs-string">"三"</span>);
        builder1.setAge(<span class="hljs-number">25</span>);
        builder1.setAddress(<span class="hljs-string">"北京"</span>);
        <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> builder1.build();
        
        <span class="hljs-comment">// 链式调用（更优雅）</span>
        <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersonBuilder</span>()
            .setFirstName(<span class="hljs-string">"李"</span>)
            .setLastName(<span class="hljs-string">"四"</span>)
            .setAge(<span class="hljs-number">30</span>)
            .setAddress(<span class="hljs-string">"上海"</span>)
            .build();
            
        <span class="hljs-comment">// 使用静态工厂方法</span>
        <span class="hljs-type">Person</span> <span class="hljs-variable">person3</span> <span class="hljs-operator">=</span> PersonBuilder.builder()
            .setFirstName(<span class="hljs-string">"王"</span>)
            .setLastName(<span class="hljs-string">"五"</span>)
            .setAge(<span class="hljs-number">28</span>)
            .setAddress(<span class="hljs-string">"广州"</span>)
            .build();
            
        System.out.println(person1);
        System.out.println(person2);
        System.out.println(person3);
    }
}
</code></pre>
<h2 data-id="heading-10">⚠️ <code>this</code> 使用注意事项</h2>
<h3 data-id="heading-11"><strong>1. 静态上下文中不能使用 this</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">instanceVar</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">staticVar</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">instanceMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-built_in">this</span>.instanceVar);  <span class="hljs-comment">// ✅ 正确</span>
        System.out.println(<span class="hljs-built_in">this</span>.staticVar);    <span class="hljs-comment">// ⚠️ 可以但不推荐（应该用类名）</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// System.out.println(this.instanceVar);  // ❌ 错误：静态方法中不能使用this</span>
        <span class="hljs-comment">// System.out.println(this.staticVar);    // ❌ 错误：静态方法中不能使用this</span>
        
        System.out.println(staticVar);  <span class="hljs-comment">// ✅ 正确：直接访问静态变量</span>
        System.out.println(StaticContext.staticVar);  <span class="hljs-comment">// ✅ 正确：使用类名访问</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 静态方法中创建对象后可以使用</span>
        <span class="hljs-type">StaticContext</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StaticContext</span>();
        obj.instanceMethod();  <span class="hljs-comment">// 可以调用实例方法</span>
    }
}
</code></pre>
<h3 data-id="heading-12"><strong>2. this 不能用在静态代码块中</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticBlock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> value;
    
    <span class="hljs-comment">// 静态代码块</span>
    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// this.value = 10;  // ❌ 错误：静态代码块中不能使用this</span>
        System.out.println(<span class="hljs-string">"静态代码块执行"</span>);
    }
    
    <span class="hljs-comment">// 实例代码块</span>
    {
        <span class="hljs-built_in">this</span>.value = <span class="hljs-number">20</span>;  <span class="hljs-comment">// ✅ 正确：实例代码块中可以使用this</span>
        System.out.println(<span class="hljs-string">"实例代码块执行，value="</span> + <span class="hljs-built_in">this</span>.value);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StaticBlock</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.value = <span class="hljs-number">30</span>;  <span class="hljs-comment">// ✅ 正确：构造器中可以使用this</span>
        System.out.println(<span class="hljs-string">"构造器执行，value="</span> + <span class="hljs-built_in">this</span>.value);
    }
}
</code></pre>
<h3 data-id="heading-13"><strong>3. this 不能指向 null</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThisNull</span> {
    <span class="hljs-keyword">private</span> String name;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printName</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// this 永远不为 null（如果为null，说明对象不存在，方法不会被调用）</span>
        System.out.println(<span class="hljs-string">"Name: "</span> + <span class="hljs-built_in">this</span>.name);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ThisNull</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThisNull</span>();
        obj.printName();  <span class="hljs-comment">// 正常执行</span>
        
        <span class="hljs-comment">// 下面的代码会抛出 NullPointerException</span>
        <span class="hljs-type">ThisNull</span> <span class="hljs-variable">nullObj</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// nullObj.printName();  // ❌ 运行时异常：NullPointerException</span>
    }
}
</code></pre>
<h2 data-id="heading-14">🔄 <code>this</code> 在内部类中的使用</h2>
<h3 data-id="heading-15"><strong>普通内部类</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OuterClass</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">outerField</span> <span class="hljs-operator">=</span> <span class="hljs-string">"外部类字段"</span>;
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerClass</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">innerField</span> <span class="hljs-operator">=</span> <span class="hljs-string">"内部类字段"</span>;
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 访问内部类的字段</span>
            System.out.println(<span class="hljs-string">"内部类字段: "</span> + <span class="hljs-built_in">this</span>.innerField);
            
            <span class="hljs-comment">// 访问外部类的字段：使用 OuterClass.this</span>
            System.out.println(<span class="hljs-string">"外部类字段: "</span> + OuterClass.<span class="hljs-built_in">this</span>.outerField);
            
            <span class="hljs-comment">// 如果字段名不冲突，也可以直接访问</span>
            System.out.println(<span class="hljs-string">"直接访问外部类字段: "</span> + outerField);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">InnerClass</span> <span class="hljs-variable">inner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InnerClass</span>();
        inner.show();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">OuterClass</span> <span class="hljs-variable">outer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OuterClass</span>();
        outer.test();
    }
}
</code></pre>
<h3 data-id="heading-16"><strong>匿名内部类</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnonymousInnerClass</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-string">"外部字段"</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">localVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"局部变量"</span>;
        
        <span class="hljs-comment">// 匿名内部类</span>
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
            <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">innerField</span> <span class="hljs-operator">=</span> <span class="hljs-string">"内部字段"</span>;
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                <span class="hljs-comment">// 访问匿名内部类的字段</span>
                System.out.println(<span class="hljs-string">"内部字段: "</span> + <span class="hljs-built_in">this</span>.innerField);
                
                <span class="hljs-comment">// 访问外部类的字段：使用 OuterClass.this</span>
                System.out.println(<span class="hljs-string">"外部字段: "</span> + AnonymousInnerClass.<span class="hljs-built_in">this</span>.field);
                
                <span class="hljs-comment">// 访问局部变量（必须是final或等效final）</span>
                System.out.println(<span class="hljs-string">"局部变量: "</span> + localVar);
                
                <span class="hljs-comment">// 不能这样访问外部类的字段（this指向匿名内部类实例）</span>
                <span class="hljs-comment">// System.out.println("错误访问: " + this.field);</span>
            }
        };
        
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(runnable).start();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousInnerClass</span>().test();
    }
}
</code></pre>
<h2 data-id="heading-17">🎭 <code>this</code> 在继承中的使用</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> {
    <span class="hljs-keyword">protected</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"父类名称"</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Parent show: "</span> + <span class="hljs-built_in">this</span>.name);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parentMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"父类方法"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Parent</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"子类名称"</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 访问子类的name</span>
        System.out.println(<span class="hljs-string">"子类字段: "</span> + <span class="hljs-built_in">this</span>.name);
        
        <span class="hljs-comment">// 访问父类的name</span>
        System.out.println(<span class="hljs-string">"父类字段: "</span> + <span class="hljs-built_in">super</span>.name);
        
        <span class="hljs-comment">// this调用的是重写后的方法（多态）</span>
        <span class="hljs-built_in">this</span>.parentMethod();  <span class="hljs-comment">// 调用子类重写的方法</span>
        
        <span class="hljs-comment">// super调用父类的方法</span>
        <span class="hljs-built_in">super</span>.parentMethod();  <span class="hljs-comment">// 调用父类原始的方法</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parentMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"子类重写的方法"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritanceThis</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Child</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>();
        child.show();
        
        System.out.println(<span class="hljs-string">"\n=== 多态测试 ==="</span>);
        <span class="hljs-type">Parent</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>();
        parent.show();  <span class="hljs-comment">// 调用子类的show方法</span>
    }
}
</code></pre>
<h2 data-id="heading-18">💡 <code>this</code> 的高级用法</h2>
<h3 data-id="heading-19"><strong>1. 在枚举中使用 this</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Operation</span> {
    ADD(<span class="hljs-string">"+"</span>) {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
            <span class="hljs-keyword">return</span> x + y;
        }
    },
    SUBTRACT(<span class="hljs-string">"-"</span>) {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
            <span class="hljs-keyword">return</span> x - y;
        }
    };
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String symbol;
    
    Operation(String symbol) {
        <span class="hljs-built_in">this</span>.symbol = symbol;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>;
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSymbol</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.symbol;
    }
    
    <span class="hljs-comment">// 使用this比较枚举值</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAdd</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span> == ADD;  <span class="hljs-comment">// 使用this比较</span>
    }
}
</code></pre>
<h3 data-id="heading-20"><strong>2. 在接口默认方法中使用 this</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;
    
    <span class="hljs-comment">// 默认方法中可以使用this（指向实现类的实例）</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showInfo</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Calculator实现类: "</span> + <span class="hljs-built_in">this</span>.getClass().getSimpleName());
    }
    
    <span class="hljs-comment">// 静态方法中不能使用this</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// System.out.println(this);  // ❌ 错误</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleCalculator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 调用接口的默认方法</span>
        <span class="hljs-built_in">this</span>.showInfo();  <span class="hljs-comment">// this指向SimpleCalculator实例</span>
    }
}
</code></pre>
<h3 data-id="heading-21"><strong>3. 在Lambda表达式中使用 this</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LambdaThis</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-string">"类字段"</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLambda</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">localVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"局部变量"</span>;
        
        <span class="hljs-comment">// Lambda表达式中的this指向外部类的实例</span>
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> () -&gt; {
            System.out.println(<span class="hljs-string">"Lambda中的this: "</span> + <span class="hljs-built_in">this</span>);
            System.out.println(<span class="hljs-string">"访问字段: "</span> + <span class="hljs-built_in">this</span>.field);
            System.out.println(<span class="hljs-string">"访问字段(直接): "</span> + field);
            System.out.println(<span class="hljs-string">"访问局部变量: "</span> + localVar);
        };
        
        <span class="hljs-comment">// 匿名内部类中的this指向内部类实例</span>
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">r2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                System.out.println(<span class="hljs-string">"匿名类中的this: "</span> + <span class="hljs-built_in">this</span>);
                System.out.println(<span class="hljs-string">"访问外部字段: "</span> + LambdaThis.<span class="hljs-built_in">this</span>.field);
            }
        };
        
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r2).start();
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"LambdaThis实例"</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaThis</span>().testLambda();
    }
}
</code></pre>
<h2 data-id="heading-22">🎯 <code>this</code> 的常见面试题</h2>
<h3 data-id="heading-23"><strong>题目1：以下代码输出什么？</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
        System.out.println(<span class="hljs-string">"局部value: "</span> + value);
        System.out.println(<span class="hljs-string">"成员value: "</span> + <span class="hljs-built_in">this</span>.value);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>().print();
    }
}
</code></pre>
<p><strong>答案</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">局部value: 20</span>
<span class="hljs-section">成员value: 10</span>
</code></pre>
<h3 data-id="heading-24"><strong>题目2：this() 调用有什么限制？</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> x;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test2</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"做一些初始化"</span>);
        <span class="hljs-built_in">this</span>(<span class="hljs-number">10</span>);  <span class="hljs-comment">// 这会怎样？</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> {
        <span class="hljs-built_in">this</span>.x = x;
    }
}
</code></pre>
<p><strong>答案</strong>：编译错误。<code>this()</code> 必须是构造器中的第一条语句。</p>
<h3 data-id="heading-25"><strong>题目3：以下代码是否正确？</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test3</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-built_in">this</span>);
    }
}
</code></pre>
<p><strong>答案</strong>：错误。静态方法中不能使用 <code>this</code>。</p>
<h2 data-id="heading-26">📊 <code>this</code> 与 <code>super</code> 对比</h2>








































<table><thead><tr><th>特性</th><th><code>this</code></th><th><code>super</code></th></tr></thead><tbody><tr><td><strong>指向对象</strong></td><td>当前对象实例</td><td>父类对象实例</td></tr><tr><td><strong>访问变量</strong></td><td>当前类的成员变量</td><td>父类的成员变量</td></tr><tr><td><strong>调用方法</strong></td><td>当前类的方法（可能被子类重写）</td><td>父类的方法（不会被重写影响）</td></tr><tr><td><strong>调用构造器</strong></td><td><code>this()</code> 调用本类其他构造器</td><td><code>super()</code> 调用父类构造器</td></tr><tr><td><strong>使用限制</strong></td><td>可以在实例方法、构造器中使用</td><td>可以在子类的实例方法、构造器中使用</td></tr><tr><td><strong>静态上下文</strong></td><td>不能在静态方法、静态块中使用</td><td>不能在静态方法、静态块中使用</td></tr></tbody></table>
<h2 data-id="heading-27">🎓 最佳实践总结</h2>
<h3 data-id="heading-28"><strong>1. 明确使用 this 的场景</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BestPractice</span> {
    <span class="hljs-keyword">private</span> String name;
    
    <span class="hljs-comment">// 场景1：区分成员变量和参数（必须使用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;  <span class="hljs-comment">// ✅ 必须使用this</span>
    }
    
    <span class="hljs-comment">// 场景2：构造器链（必须使用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BestPractice</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>(<span class="hljs-string">"默认名称"</span>);  <span class="hljs-comment">// ✅ 必须使用this()</span>
    }
    
    <span class="hljs-comment">// 场景3：链式调用（返回this）</span>
    <span class="hljs-keyword">public</span> BestPractice <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-comment">// ... 设置年龄逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;  <span class="hljs-comment">// ✅ 支持链式调用</span>
    }
    
    <span class="hljs-comment">// 场景4：没有歧义时可以省略</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printName</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这里没有局部变量name，可以直接访问</span>
        System.out.println(name);  <span class="hljs-comment">// ✅ 可以省略this</span>
        
        <span class="hljs-comment">// 使用this也可以，更明确</span>
        System.out.println(<span class="hljs-built_in">this</span>.name);  <span class="hljs-comment">// ✅ 更清晰</span>
    }
}
</code></pre>
<h3 data-id="heading-29"><strong>2. 避免滥用 this</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AvoidAbuse</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> value;
    
    <span class="hljs-comment">// ❌ 不必要的this（没有歧义）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> {
        <span class="hljs-built_in">this</span>.value = val;  <span class="hljs-comment">// 可以，但没有必要（参数名不同）</span>
    }
    
    <span class="hljs-comment">// ✅ 更好的写法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> {
        <span class="hljs-built_in">this</span>.value = value;  <span class="hljs-comment">// 必须使用this</span>
    }
    
    <span class="hljs-comment">// ✅ 最佳：使用不同的参数名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(<span class="hljs-type">int</span> newValue)</span> {
        value = newValue;  <span class="hljs-comment">// 不需要this，更简洁</span>
    }
}
</code></pre>
<h3 data-id="heading-30"><strong>3. 构造器中的最佳实践</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstructorBestPractice</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;     <span class="hljs-comment">// final字段必须在构造器中初始化</span>
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    
    <span class="hljs-comment">// 主要构造器（初始化所有字段）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstructorBestPractice</span><span class="hljs-params">(String id, String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-comment">// 参数验证</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"ID不能为空"</span>);
        }
        
        <span class="hljs-comment">// 初始化final字段</span>
        <span class="hljs-built_in">this</span>.id = id;
        
        <span class="hljs-comment">// 使用this初始化其他字段</span>
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }
    
    <span class="hljs-comment">// 辅助构造器（提供默认值）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstructorBestPractice</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-built_in">this</span>(id, <span class="hljs-string">"未知"</span>, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 调用主要构造器</span>
    }
    
    <span class="hljs-comment">// 辅助构造器（使用this()链）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstructorBestPractice</span><span class="hljs-params">(String id, String name)</span> {
        <span class="hljs-built_in">this</span>(id, name, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 调用主要构造器</span>
    }
}
</code></pre>
<p>记住：<strong><code>this</code> 是指向当前对象的引用</strong>，正确使用 <code>this</code> 可以让代码更清晰、更健壮，特别是在处理变量名冲突、构造器链和链式调用时非常重要！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🧭 用 Trae Solo 做技术栈分析 + 一键部署：一个 8 年 Java 工程师的实战分享]]></title>    <link>https://juejin.cn/post/7578797337867337762</link>    <guid>https://juejin.cn/post/7578797337867337762</guid>    <pubDate>2025-12-02T02:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578797337867337762" data-draft-id="7578777952726597666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🧭 用 Trae Solo 做技术栈分析 + 一键部署：一个 8 年 Java 工程师的实战分享"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-02T02:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🧭 用 Trae Solo 做技术栈分析 + 一键部署：一个 8 年 Java 工程师的实战分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:26:47.000Z" title="Tue Dec 02 2025 02:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧭 用 Trae Solo 做技术栈分析 + 一键部署：一个 8 年 Java 工程师的实战分享</h2>
<p>作为一名从 Java EE 一路走到 Spring Boot、Spring Cloud 的老兵，我深知微服务架构带来的灵活与挑战。而当面对一个模块繁多、技术栈复杂的项目，我发现 <strong>Trae Solo 不仅能分析我的项目技术栈，还能生成服务定义、Dockerfile、docker-compose 和启动脚本，大大简化了部署流程。</strong></p>
<p>今天，我就从一个实战项目出发，讲讲我是如何用 <strong>Trae Solo</strong> 分析技术架构，并实现一键部署的。</p>
<hr/>
<h3 data-id="heading-1">👨‍💻 项目背景：一个典型的 Java 微服务项目</h3>
<p>我的项目采用了主流的 Spring Cloud 技术栈，总体结构如下：</p>













































<table><thead><tr><th>服务名称</th><th>技术框架</th><th>描述</th></tr></thead><tbody><tr><td>gateway-service</td><td>Spring Cloud Gateway</td><td>API 网关</td></tr><tr><td>auth-service</td><td>Spring Security OAuth2</td><td>鉴权服务</td></tr><tr><td>user-service</td><td>Spring Boot + MyBatis</td><td>用户服务</td></tr><tr><td>order-service</td><td>Spring Boot + OpenFeign</td><td>订单服务</td></tr><tr><td>mysql</td><td>MySQL 8</td><td>数据库</td></tr><tr><td>redis</td><td>Redis 6</td><td>缓存</td></tr><tr><td>nacos</td><td>Nacos</td><td>注册中心 + 配置中心</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">🧠 第一步：用 Trae Solo 分析技术栈</h3>
<h4 data-id="heading-3">🧰 工具：Trae Solo</h4>
<p>Trae Solo 是一个 AI 驱动的 DevOps 助手，可以：</p>
<ul>
<li>自动解析项目结构</li>
<li>识别每个服务的语言、框架、依赖</li>
<li>自动生成 Dockerfile、docker-compose、部署脚本</li>
</ul>
<h4 data-id="heading-4">📦 分析过程</h4>
<p>我将项目源码上传到 Trae Solo 的分析平台，它从以下几个维度完成分析：</p>
<ul>
<li><strong>语言识别</strong>：Java / YAML / SQL / Dockerfile / Shell</li>
<li><strong>服务拆分</strong>：根据 Maven 多模块识别出独立服务</li>
<li><strong>依赖分析</strong>：如 Nacos、MySQL、Redis、OpenFeign、Spring Security 等</li>
<li><strong>启动方式识别</strong>：判断入口类、端口、依赖服务</li>
</ul>
<h4 data-id="heading-5">🧾 自动生成的内容包括：</h4>
<ul>
<li>每个服务的 <code>Dockerfile</code></li>
<li>所有服务的 <code>docker-compose.yml</code></li>
<li>一键部署脚本 <code>deploy.sh</code></li>
<li><code>.env</code> 配置文件模板</li>
</ul>
<hr/>
<h3 data-id="heading-6">🐳 第二步：使用 Trae Solo 生成的 Docker Compose</h3>
<h4 data-id="heading-7">📄 自动生成的 docker-compose.yml（简化版）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">nacos:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nacos/nacos-server:2.3.0</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8848:8848"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MODE:</span> <span class="hljs-string">standalone</span>

  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root1234</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./data/mysql:/var/lib/mysql</span>

  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:6</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>

  <span class="hljs-attr">gateway-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./gateway-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nacos</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">auth-service</span>

  <span class="hljs-attr">auth-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./auth-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9000:9000"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>

  <span class="hljs-attr">user-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./user-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9001:9001"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>

  <span class="hljs-attr">order-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./order-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9002:9002"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">user-service</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
</code></pre>
<blockquote>
<p>✅ Trae Solo 不仅帮我识别了端口，还自动设置了 <code>depends_on</code> 来处理服务间的依赖顺序。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">🔧 第三步：Trae Solo 自动生成的 Dockerfile 示例</h3>
<p>以 <code>user-service</code> 为例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">FROM</span> openjdk:<span class="hljs-number">17</span><span class="hljs-operator">-</span>jdk<span class="hljs-operator">-</span>alpine
WORKDIR <span class="hljs-operator">/</span>app
<span class="hljs-keyword">COPY</span> target<span class="hljs-operator">/</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>service.jar app.jar
EXPOSE <span class="hljs-number">9001</span>
ENTRYPOINT ["java", "-jar", "app.jar"]
</code></pre>
<p>其他服务的 Dockerfile 也类似，Trae Solo 会自动识别编译产物路径并拷贝。</p>
<hr/>
<h3 data-id="heading-9">🚀 第四步：一键部署脚本 deploy.sh</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"⏳ 停止旧容器..."</span>
docker-compose down

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🔄 构建镜像..."</span>
docker-compose build

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🚀 启动服务..."</span>
docker-compose up -d

<span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 所有服务已启动！"</span>
docker ps
</code></pre>
<p>运行方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x deploy.sh
./deploy.sh
</code></pre>
<p>短短几分钟，所有服务都在本地容器中跑了起来，从 Nacos 到 Gateway 到业务服务，通通 OK。</p>
<hr/>
<h3 data-id="heading-10">🧪 第五步：验证部署效果</h3>
<ul>
<li>通过 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8848%2F" target="_blank" title="http://localhost:8848/" ref="nofollow noopener noreferrer">http://localhost:8848</a> 访问 Nacos 控制台</li>
<li>通过 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2F" target="_blank" title="http://localhost:8080/" ref="nofollow noopener noreferrer">http://localhost:8080</a> 访问网关接口</li>
<li>使用 Postman 测试用户服务、订单服务 API</li>
<li>查看数据是否写入 MySQL、Redis 缓存是否生效</li>
</ul>
<hr/>
<h3 data-id="heading-11">🧠 总结：为什么我选择 Trae Solo？</h3>
<p>作为一名资深 Java 工程师，我非常清楚：</p>
<ul>
<li>项目技术栈复杂，靠人工维护配置非常容易出错</li>
<li>微服务部署流程繁琐，重复劳动浪费时间</li>
<li>容器化部署是趋势，但写 Dockerfile 和 Compose 需要经验</li>
</ul>
<p><strong>Trae Solo 极大地降低了上手门槛，它是我 DevOps 流程中不可或缺的自动化利器。</strong></p>
<hr/>
<h3 data-id="heading-12">✅ 建议使用场景</h3>
<ul>
<li>快速为团队搭建本地开发环境</li>
<li>初创团队快速上线 MVP</li>
<li>复杂项目自动生成部署配置</li>
<li>教学或技术分享场景自动生成演示环境</li>
</ul>
<hr/>
<h3 data-id="heading-13">📌 想对 Trae Solo 说</h3>
<p>Trae Solo 不仅是工具，更像是我技术团队中的一位 DevOps 工程师，它帮我节省了大量的配置时间，让我能更专注于业务逻辑和架构设计。</p>
<blockquote>
<p>“它懂代码，也懂部署。”</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">🧑‍💻 作者简介</h3>
<p><strong>昵称：代码里的旅行者</strong><br/>
<strong>经验：8 年 Java、现主攻微服务 + DevOps</strong><br/>
<strong>个人口号：写更少的配置，构建更强的系统。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 基础控件速查（面向 Android 开发者）]]></title>    <link>https://juejin.cn/post/7578780780026707977</link>    <guid>https://juejin.cn/post/7578780780026707977</guid>    <pubDate>2025-12-02T02:44:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578780780026707977" data-draft-id="7578803751608795186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 基础控件速查（面向 Android 开发者）"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-02T02:44:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="renxhui"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403181944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 基础控件速查（面向 Android 开发者）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403181944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    renxhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:44:32.000Z" title="Tue Dec 02 2025 02:44:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 基础控件速查（面向 Android 开发者）</h2>
<blockquote>
<p>目标：你是 Android 开发，快速上手 Flutter UI 与常用控件。示例均可直接复制到 Flutter 工程中尝试。</p>
</blockquote>
<h3 data-id="heading-1">1. 快速对照表（Android → Flutter）</h3>
<ul>
<li>视图容器：View → <code>Container</code> / <code>SizedBox</code></li>
<li>线性布局：LinearLayout(horizontal/vertical) → <code>Row</code> / <code>Column</code></li>
<li>约束/叠放：FrameLayout / RelativeLayout → <code>Stack</code> + <code>Positioned</code>，<code>Align</code></li>
<li>列表：RecyclerView → <code>ListView.builder</code> / <code>GridView.builder</code> / <code>CustomScrollView + Slivers</code></li>
<li>文本：TextView → <code>Text</code></li>
<li>图片：ImageView → <code>Image</code></li>
<li>按钮：Button → <code>ElevatedButton</code> / <code>TextButton</code> / <code>IconButton</code></li>
<li>输入框：EditText → <code>TextField</code></li>
<li>顶部栏：Toolbar/ActionBar → <code>AppBar</code></li>
<li>页面容器：Activity/Fragment → <code>Scaffold</code> + 路由（<code>go_router</code>）</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 布局基础</h3>
<h4 data-id="heading-3">2.1 线性布局：Row / Column</h4>
<pre><code class="hljs language-dart" lang="dart">Row(
  children: [
    <span class="hljs-keyword">const</span> Icon(Icons.star),
    <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">8</span>),
    <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'Row 示例'</span>),
    <span class="hljs-keyword">const</span> Spacer(), <span class="hljs-comment">// 占满剩余空间</span>
    ElevatedButton(onPressed: () {}, child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'按钮'</span>)),
  ],
)
</code></pre>
<pre><code class="hljs language-dart" lang="dart">Column(
  crossAxisAlignment: CrossAxisAlignment.start,
  children: [
    <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'标题'</span>, style: TextStyle(fontSize: <span class="hljs-number">18</span>, fontWeight: FontWeight.w600)),
    <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
    <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'副标题'</span>),
  ],
)
</code></pre>
<h4 data-id="heading-4">2.2 约束与叠放：Container / SizedBox / Stack</h4>
<pre><code class="hljs language-dart" lang="dart">Container(
  width: <span class="hljs-number">200</span>,
  height: <span class="hljs-number">120</span>,
  padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">12</span>),
  decoration: BoxDecoration(
    color: <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0xFFECECEC</span>),
    borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
  ),
  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'Container 带圆角与内边距'</span>),
)
</code></pre>
<pre><code class="hljs language-dart" lang="dart">Stack(
  children: [
    Image.network(<span class="hljs-string">'https://picsum.photos/400/200'</span>, width: <span class="hljs-built_in">double</span>.infinity, height: <span class="hljs-number">200</span>, fit: BoxFit.cover),
    <span class="hljs-keyword">const</span> Positioned(
      left: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">12</span>,
      child: Text(<span class="hljs-string">'叠放文本'</span>, style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
    )
  ],
)
</code></pre>
<h4 data-id="heading-5">2.3 自适应：Expanded / Flexible / Wrap / Align / Center</h4>
<pre><code class="hljs language-dart" lang="dart">Row(
  children: [
    Expanded(child: Container(color: Colors.blue, height: <span class="hljs-number">40</span>)),
    <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">8</span>),
    Flexible(child: Container(color: Colors.orange, height: <span class="hljs-number">40</span>)),
  ],
)
</code></pre>
<hr/>
<h3 data-id="heading-6">3. 列表与滚动</h3>
<h4 data-id="heading-7">3.1 ListView.builder</h4>
<pre><code class="hljs language-dart" lang="dart">ListView.builder(
  itemCount: <span class="hljs-number">20</span>,
  itemBuilder: (context, i) =&gt; ListTile(
    leading: CircleAvatar(child: Text(<span class="hljs-string">'<span class="hljs-subst">$i</span>'</span>)),
    title: Text(<span class="hljs-string">'Item <span class="hljs-subst">$i</span>'</span>),
  ),
)
</code></pre>
<h4 data-id="heading-8">3.2 GridView.builder</h4>
<pre><code class="hljs language-dart" lang="dart">GridView.builder(
  gridDelegate: <span class="hljs-keyword">const</span> SliverGridDelegateWithFixedCrossAxisCount(
    crossAxisCount: <span class="hljs-number">2</span>, mainAxisSpacing: <span class="hljs-number">8</span>, crossAxisSpacing: <span class="hljs-number">8</span>, childAspectRatio: <span class="hljs-number">0.75</span>),
  itemCount: <span class="hljs-number">10</span>,
  itemBuilder: (context, i) =&gt; Container(color: Colors.grey.shade200),
)
</code></pre>
<h4 data-id="heading-9">3.3 Slivers（高级可选）</h4>
<pre><code class="hljs language-dart" lang="dart">CustomScrollView(
  slivers: [
    <span class="hljs-keyword">const</span> SliverAppBar(pinned: <span class="hljs-keyword">true</span>, title: Text(<span class="hljs-string">'Sliver 列表示例'</span>)),
    SliverList.builder(
      itemCount: <span class="hljs-number">50</span>,
      itemBuilder: (context, i) =&gt; ListTile(title: Text(<span class="hljs-string">'Row <span class="hljs-subst">$i</span>'</span>)),
    ),
  ],
)
</code></pre>
<hr/>
<h3 data-id="heading-10">4. 文本、图片、图标</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> Text(<span class="hljs-string">'Hello Flutter'</span>, style: TextStyle(fontSize: <span class="hljs-number">16</span>));
<span class="hljs-keyword">const</span> Icon(Icons.settings, color: Colors.blue);
Image.asset(<span class="hljs-string">'assets/images/common/logo.png'</span>, width: <span class="hljs-number">48</span>, height: <span class="hljs-number">48</span>);
Image.network(<span class="hljs-string">'https://picsum.photos/200'</span>, fit: BoxFit.cover);
</code></pre>
<p>富文本（类似 Android Spannable）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> RichText(
  text: TextSpan(
    text: <span class="hljs-string">'Flutter '</span>,
    style: TextStyle(color: Colors.black),
    children: [
      TextSpan(text: <span class="hljs-string">'加粗'</span>, style: TextStyle(fontWeight: FontWeight.bold)),
      TextSpan(text: <span class="hljs-string">' &amp; '</span>),
      TextSpan(text: <span class="hljs-string">'变色'</span>, style: TextStyle(color: Colors.red)),
    ],
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-11">5. 按钮与手势</h3>
<pre><code class="hljs language-dart" lang="dart">ElevatedButton(onPressed: () {}, child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'确定'</span>));
TextButton(onPressed: () {}, child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'取消'</span>));
IconButton(onPressed: () {}, icon: <span class="hljs-keyword">const</span> Icon(Icons.share));
</code></pre>
<p>点击水波与手势：</p>
<pre><code class="hljs language-dart" lang="dart">InkWell(
  onTap: () {},
  borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
  child: <span class="hljs-keyword">const</span> Padding(
    padding: EdgeInsets.all(<span class="hljs-number">12</span>),
    child: Text(<span class="hljs-string">'InkWell 点击区域'</span>),
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-12">6. 输入与表单</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> TextEditingController controller = TextEditingController();

TextField(
  controller: controller,
  decoration: <span class="hljs-keyword">const</span> InputDecoration(
    hintText: <span class="hljs-string">'请输入内容'</span>,
    border: OutlineInputBorder(),
  ),
)
</code></pre>
<p>表单校验：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> GlobalKey&lt;FormState&gt; formKey = GlobalKey&lt;FormState&gt;();

Form(
  key: formKey,
  child: Column(
    children: [
      TextFormField(
        validator: (v) =&gt; (v == <span class="hljs-keyword">null</span> || v.isEmpty) ? <span class="hljs-string">'必填'</span> : <span class="hljs-keyword">null</span>,
      ),
      ElevatedButton(
        onPressed: () {
          <span class="hljs-keyword">if</span> (formKey.currentState!.validate()) {
            <span class="hljs-comment">// 提交</span>
          }
        },
        child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'提交'</span>),
      )
    ],
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-13">7. 页面结构与导航</h3>
<p>基本页面结构：</p>
<pre><code class="hljs language-dart" lang="dart">Scaffold(
  appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'标题'</span>)),
  body: <span class="hljs-keyword">const</span> Center(child: Text(<span class="hljs-string">'内容区'</span>)),
  floatingActionButton: FloatingActionButton(
    onPressed: () {},
    child: <span class="hljs-keyword">const</span> Icon(Icons.add),
  ),
)
</code></pre>
<p>导航（项目使用 go_router，示例）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 注册路由（简化示例）</span>
<span class="hljs-comment">// context.go('/detail'); // 跳转</span>
<span class="hljs-comment">// context.pop();         // 返回</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">8. 状态管理（setState vs GetX）</h3>
<p>原生 setState：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">int</span> counter = <span class="hljs-number">0</span>;
setState(() =&gt; counter++);
</code></pre>
<p>GetX 响应式：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxController</span> </span>{
  <span class="hljs-keyword">final</span> RxInt count = <span class="hljs-number">0.</span>obs;
  <span class="hljs-keyword">void</span> increment() =&gt; count.value++;
}
<span class="hljs-comment">// 使用：final c = Get.put(CounterController());</span>
<span class="hljs-comment">// Obx(() =&gt; Text('${c.count.value}'));</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">9. 弹窗与 BottomSheet</h3>
<pre><code class="hljs language-dart" lang="dart">showDialog(
  context: context,
  builder: (_) =&gt; AlertDialog(
    title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'提示'</span>),
    content: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'确定吗？'</span>),
    actions: [
      TextButton(onPressed: () =&gt; Navigator.pop(context), child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'取消'</span>)),
      TextButton(onPressed: () {}, child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'确定'</span>)),
    ],
  ),
);
</code></pre>
<pre><code class="hljs language-dart" lang="dart">showModalBottomSheet(
  context: context,
  builder: (_) =&gt; SizedBox(
    height: <span class="hljs-number">240</span>,
    child: <span class="hljs-keyword">const</span> Center(child: Text(<span class="hljs-string">'BottomSheet'</span>)),
  ),
);
</code></pre>
<hr/>
<h3 data-id="heading-16">10. 适配与主题</h3>
<p>屏幕适配（flutter_screenutil）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 入口处初始化 ScreenUtil，然后使用 12.w/12.h/12.sp 等</span>
</code></pre>
<p>MediaQuery：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> Size size = MediaQuery.of(context).size; <span class="hljs-comment">// 屏幕尺寸</span>
</code></pre>
<p>主题：</p>
<pre><code class="hljs language-dart" lang="dart">ThemeData(
  colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
  useMaterial3: <span class="hljs-keyword">true</span>,
)
</code></pre>
<hr/>
<h3 data-id="heading-17">11. 网络（Dio 简例）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> dio = Dio(BaseOptions(baseUrl: <span class="hljs-string">'https://httpbin.org'</span>));
<span class="hljs-keyword">final</span> resp = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/get'</span>);
</code></pre>
<p>项目内请优先使用 Retrofit + Service 层封装（参考现有 <code>lib/src/services/**</code>）。</p>
<hr/>
<h3 data-id="heading-18">12. 开发效率提示</h3>
<ul>
<li>热重载：保存文件即可热重载（尽量使用 const 构造减少重建）。</li>
<li>结构拆分：大组件拆小组件，避免深度嵌套。</li>
<li>代码生成：涉及数据模型/接口，记得运行
<ul>
<li><code>fvm flutter pub run build_runner build --delete-conflicting-outputs</code></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-19">13. 常见坑</h3>
<ul>
<li>setState 与 Obx 混用：尽量让某块 UI 只监听一种状态来源，避免重复 rebuild。</li>
<li>showModalBottomSheet 高度：默认按内容高度，想近全屏需 <code>isScrollControlled: true</code> + 指定高度。</li>
<li>iOS 跑不起来（Scheme/Flavor）：需指定 <code>--flavor</code> 与 Xcode 的 Scheme 对应。</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 封装（Encapsulation）指南]]></title>    <link>https://juejin.cn/post/7578820431039250472</link>    <guid>https://juejin.cn/post/7578820431039250472</guid>    <pubDate>2025-12-02T02:38:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820431039250472" data-draft-id="7578777952726745122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 封装（Encapsulation）指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T02:38:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小周在成长"/> <meta itemprop="url" content="https://juejin.cn/user/3632442150752573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 封装（Encapsulation）指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3632442150752573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小周在成长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:38:38.000Z" title="Tue Dec 02 2025 02:38:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📖 封装的基本概念</h2>
<h3 data-id="heading-1"><strong>什么是封装？</strong></h3>
<p>封装是面向对象编程的<strong>四大特性</strong>之一，它将数据（属性）和操作数据的方法（行为）包装在一起，并<strong>隐藏内部实现细节</strong>，只暴露必要的接口。</p>
<h3 data-id="heading-2"><strong>封装的核心思想</strong></h3>
<ul>
<li><strong>隐藏实现</strong>：对外隐藏内部实现细节</li>
<li><strong>暴露接口</strong>：提供公共方法来访问和修改数据</li>
<li><strong>数据保护</strong>：防止外部直接访问和修改内部数据</li>
</ul>
<h2 data-id="heading-3">🎯 封装的好处</h2>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ❌ 没有封装的问题</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadDesign</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> name;      <span class="hljs-comment">// 直接暴露属性</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age;         <span class="hljs-comment">// 外部可以直接修改</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> salary;   <span class="hljs-comment">// 没有验证逻辑</span>
}

<span class="hljs-comment">// ✅ 使用封装的好处</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodDesign</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;     <span class="hljs-comment">// 私有属性，隐藏实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;        <span class="hljs-comment">// 只能通过方法访问</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> salary;  <span class="hljs-comment">// 可以添加验证逻辑</span>
    
    <span class="hljs-comment">// 提供公共的访问方法（getter）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> name;
    }
    
    <span class="hljs-comment">// 提供公共的修改方法（setter）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span> </span>{
        <span class="hljs-comment">// 可以添加验证逻辑</span>
        <span class="hljs-keyword">if</span> (name != null &amp;&amp; !name.<span class="hljs-built_in">trim</span>().<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-keyword">this</span>.name = name;
        }
    }
}
</code></pre>
<h2 data-id="heading-4">🔒 访问修饰符（Access Modifiers）</h2>
<h3 data-id="heading-5"><strong>四种访问级别</strong></h3>













































<table><thead><tr><th>修饰符</th><th>同类</th><th>同包</th><th>子类</th><th>不同包</th><th>说明</th></tr></thead><tbody><tr><td><strong>private</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>仅本类可见</td></tr><tr><td><strong>默认</strong></td><td>✅</td><td>✅</td><td>❌</td><td>❌</td><td>同包可见</td></tr><tr><td><strong>protected</strong></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td><td>同包或子类可见</td></tr><tr><td><strong>public</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>所有类可见</td></tr></tbody></table>
<h3 data-id="heading-6"><strong>访问修饰符示例</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.example;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AccessDemo</span> {
    <span class="hljs-comment">// 1. private - 仅本类可见</span>
    <span class="hljs-keyword">private</span> String privateField = <span class="hljs-string">"私有字段"</span>;
    
    <span class="hljs-comment">// 2. 默认（包私有）- 同包可见</span>
    String defaultField = <span class="hljs-string">"默认字段"</span>;
    
    <span class="hljs-comment">// 3. protected - 同包或子类可见</span>
    <span class="hljs-keyword">protected</span> String protectedField = <span class="hljs-string">"受保护字段"</span>;
    
    <span class="hljs-comment">// 4. public - 所有地方可见</span>
    <span class="hljs-keyword">public</span> String publicField = <span class="hljs-string">"公共字段"</span>;
    
    <span class="hljs-comment">// 访问私有字段的方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPrivateField</span>()</span> {
        <span class="hljs-keyword">return</span> privateField;  <span class="hljs-comment">// 本类中可以访问private</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">privateMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"私有方法"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAccess</span>()</span> {
        <span class="hljs-comment">// 所有访问级别在本类中都可见</span>
        System.<span class="hljs-keyword">out</span>.println(privateField);
        System.<span class="hljs-keyword">out</span>.println(defaultField);
        System.<span class="hljs-keyword">out</span>.println(protectedField);
        System.<span class="hljs-keyword">out</span>.println(publicField);
        privateMethod();
    }
}

<span class="hljs-comment">// 同包中的另一个类</span>
package com.example;

<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        AccessDemo demo = <span class="hljs-keyword">new</span> AccessDemo();
        
        <span class="hljs-comment">// System.out.println(demo.privateField);  // ❌ 错误：不可访问</span>
        System.<span class="hljs-keyword">out</span>.println(demo.defaultField);      <span class="hljs-comment">// ✅ 可以：同包</span>
        System.<span class="hljs-keyword">out</span>.println(demo.protectedField);    <span class="hljs-comment">// ✅ 可以：同包</span>
        System.<span class="hljs-keyword">out</span>.println(demo.publicField);       <span class="hljs-comment">// ✅ 可以：公共</span>
    }
}

<span class="hljs-comment">// 不同包中的类</span>
package other;

import com.example.AccessDemo;

<span class="hljs-keyword">class</span> <span class="hljs-title">DifferentPackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        AccessDemo demo = <span class="hljs-keyword">new</span> AccessDemo();
        
        <span class="hljs-comment">// System.out.println(demo.privateField);   // ❌ 错误</span>
        <span class="hljs-comment">// System.out.println(demo.defaultField);   // ❌ 错误：不同包</span>
        <span class="hljs-comment">// System.out.println(demo.protectedField); // ❌ 错误：不同包非子类</span>
        System.<span class="hljs-keyword">out</span>.println(demo.publicField);        <span class="hljs-comment">// ✅ 可以：公共</span>
        
        <span class="hljs-comment">// 通过公共方法访问私有字段</span>
        System.<span class="hljs-keyword">out</span>.println(demo.getPrivateField());  <span class="hljs-comment">// ✅ 可以</span>
    }
}

<span class="hljs-comment">// 不同包中的子类</span>
package other;

import com.example.AccessDemo;

<span class="hljs-keyword">class</span> <span class="hljs-title">SubClass</span> <span class="hljs-title">extends</span> <span class="hljs-title">AccessDemo</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        <span class="hljs-comment">// System.out.println(privateField);   // ❌ 错误</span>
        <span class="hljs-comment">// System.out.println(defaultField);   // ❌ 错误：不同包</span>
        System.<span class="hljs-keyword">out</span>.println(protectedField);   <span class="hljs-comment">// ✅ 可以：子类</span>
        System.<span class="hljs-keyword">out</span>.println(publicField);      <span class="hljs-comment">// ✅ 可以：公共</span>
        
        <span class="hljs-comment">// 通过继承的方法访问</span>
        System.<span class="hljs-keyword">out</span>.println(getPrivateField()); <span class="hljs-comment">// ✅ 可以</span>
    }
}
</code></pre>
<h2 data-id="heading-7">🛠️ Getter 和 Setter 方法</h2>
<h3 data-id="heading-8"><strong>标准Getter/Setter模式</strong></h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-comment">// 私有字段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> int age;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> studentId;
    <span class="hljs-keyword">private</span> double gpa;
    
    <span class="hljs-comment">// 1. Getter方法：获取字段值</span>
    <span class="hljs-comment">// 命名规范：get + 字段名（首字母大写）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> name;
    }
    
    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">getAge</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> age;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getStudentId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> studentId;
    }
    
    <span class="hljs-keyword">public</span> double <span class="hljs-title function_">getGpa</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> gpa;
    }
    
    <span class="hljs-comment">// 2. Setter方法：设置字段值</span>
    <span class="hljs-comment">// 命名规范：set + 字段名（首字母大写）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
        <span class="hljs-comment">// 可以添加验证逻辑</span>
        <span class="hljs-keyword">if</span> (name != <span class="hljs-literal">null</span> &amp;&amp; name.<span class="hljs-title function_">length</span>() &gt;= <span class="hljs-number">2</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"姓名无效"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAge</span>(<span class="hljs-params">int age</span>) {
        <span class="hljs-comment">// 验证年龄范围</span>
        <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">0</span> &amp;&amp; age &lt;= <span class="hljs-number">150</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"年龄必须在0-150之间"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setStudentId</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> studentId</span>) {
        <span class="hljs-comment">// 验证学号格式</span>
        <span class="hljs-keyword">if</span> (studentId != <span class="hljs-literal">null</span> &amp;&amp; studentId.<span class="hljs-title function_">matches</span>(<span class="hljs-string">"\d{10}"</span>)) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">studentId</span> = studentId;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"学号必须是10位数字"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGpa</span>(<span class="hljs-params">double gpa</span>) {
        <span class="hljs-comment">// 验证GPA范围</span>
        <span class="hljs-keyword">if</span> (gpa &gt;= <span class="hljs-number">0.0</span> &amp;&amp; gpa &lt;= <span class="hljs-number">4.0</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">gpa</span> = gpa;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"GPA必须在0.0-4.0之间"</span>);
        }
    }
    
    <span class="hljs-comment">// 3. 只读字段（只有getter，没有setter）</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">String</span> createdAt = java.<span class="hljs-property">time</span>.<span class="hljs-property">LocalDate</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getCreatedAt</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> createdAt;
    }
    
    <span class="hljs-comment">// 4. 只写字段（不推荐，但有特殊用途）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setPassword</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> password</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = password;
    }
    
    <span class="hljs-comment">// 5. 布尔类型的Getter规范</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> graduated;
    
    <span class="hljs-comment">// 布尔类型使用is前缀</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isGraduated</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> graduated;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGraduated</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> graduated</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">graduated</span> = graduated;
    }
    
    <span class="hljs-comment">// 显示学生信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">displayInfo</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"学生信息:"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"姓名: "</span> + name);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"年龄: "</span> + age);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"学号: "</span> + studentId);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"GPA: "</span> + gpa);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"创建时间: "</span> + createdAt);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"是否毕业: "</span> + graduated);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">Student</span> student = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();
        
        <span class="hljs-comment">// 使用setter设置值（有验证）</span>
        student.<span class="hljs-title function_">setName</span>(<span class="hljs-string">"张三"</span>);
        student.<span class="hljs-title function_">setAge</span>(<span class="hljs-number">20</span>);
        student.<span class="hljs-title function_">setStudentId</span>(<span class="hljs-string">"2023000001"</span>);
        student.<span class="hljs-title function_">setGpa</span>(<span class="hljs-number">3.8</span>);
        student.<span class="hljs-title function_">setGraduated</span>(<span class="hljs-literal">false</span>);
        
        <span class="hljs-comment">// 使用getter获取值</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"学生姓名: "</span> + student.<span class="hljs-title function_">getName</span>());
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"学生年龄: "</span> + student.<span class="hljs-title function_">getAge</span>());
        
        <span class="hljs-comment">// 测试无效输入</span>
        student.<span class="hljs-title function_">setAge</span>(<span class="hljs-number">200</span>);  <span class="hljs-comment">// 会输出错误信息</span>
        student.<span class="hljs-title function_">setGpa</span>(<span class="hljs-number">5.0</span>);  <span class="hljs-comment">// 会输出错误信息</span>
        
        student.<span class="hljs-title function_">displayInfo</span>();
    }
}
</code></pre>
<h3 data-id="heading-9"><strong>高级Getter/Setter技巧</strong></h3>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedGetterSetter</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> List&lt;String&gt; hobbies;  <span class="hljs-comment">// 可变对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] scores;          <span class="hljs-comment">// 数组</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;       <span class="hljs-comment">// final字段</span>
    
    <span class="hljs-comment">// 构造器初始化final字段</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AdvancedGetterSetter</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
        <span class="hljs-built_in">this</span>.hobbies = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-built_in">this</span>.scores = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">3</span>];
    }
    
    <span class="hljs-comment">// 1. 返回不可修改的集合（防御性编程）</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getHobbies</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 返回副本，防止外部修改内部数据</span>
        <span class="hljs-keyword">return</span> Collections.unmodifiableList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(hobbies));
        
        <span class="hljs-comment">// 或者返回只读视图</span>
        <span class="hljs-comment">// return Collections.unmodifiableList(hobbies);</span>
    }
    
    <span class="hljs-comment">// 2. 控制集合的修改</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addHobby</span><span class="hljs-params">(String hobby)</span> {
        <span class="hljs-keyword">if</span> (hobby != <span class="hljs-literal">null</span> &amp;&amp; !hobby.trim().isEmpty()) {
            <span class="hljs-built_in">this</span>.hobbies.add(hobby);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeHobby</span><span class="hljs-params">(String hobby)</span> {
        <span class="hljs-built_in">this</span>.hobbies.remove(hobby);
    }
    
    <span class="hljs-comment">// 3. 数组的Getter/Setter</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] getScores() {
        <span class="hljs-comment">// 返回数组的副本</span>
        <span class="hljs-keyword">return</span> scores.clone();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setScores</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-comment">// 复制数组，而不是直接引用</span>
        System.arraycopy(scores, <span class="hljs-number">0</span>, <span class="hljs-built_in">this</span>.scores, <span class="hljs-number">0</span>, 
                        Math.min(scores.length, <span class="hljs-built_in">this</span>.scores.length));
    }
    
    <span class="hljs-comment">// 4. 只读的final字段</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }
    
    <span class="hljs-comment">// 5. 计算性属性（没有对应的字段）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getAverageScore</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (scores.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-comment">// 6. 链式Setter（返回this）</span>
    <span class="hljs-keyword">public</span> AdvancedGetterSetter <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
    
    <span class="hljs-comment">// 7. Builder模式结合</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
        <span class="hljs-keyword">private</span> String id;
        <span class="hljs-keyword">private</span> String name;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(String id)</span> {
            <span class="hljs-built_in">this</span>.id = id;
        }
        
        <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">name</span><span class="hljs-params">(String name)</span> {
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }
        
        <span class="hljs-keyword">public</span> AdvancedGetterSetter <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
            <span class="hljs-type">AdvancedGetterSetter</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvancedGetterSetter</span>(id);
            obj.name = name;
            <span class="hljs-keyword">return</span> obj;
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AdvancedGetterSetter</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvancedGetterSetter</span>(<span class="hljs-string">"001"</span>);
        
        <span class="hljs-comment">// 测试集合保护</span>
        obj.addHobby(<span class="hljs-string">"篮球"</span>);
        obj.addHobby(<span class="hljs-string">"音乐"</span>);
        
        List&lt;String&gt; hobbies = obj.getHobbies();
        System.out.println(<span class="hljs-string">"爱好: "</span> + hobbies);
        
        <span class="hljs-comment">// hobbies.add("游泳");  // ❌ 运行时异常：UnsupportedOperationException</span>
        
        <span class="hljs-comment">// 测试数组保护</span>
        <span class="hljs-type">int</span>[] testScores = {<span class="hljs-number">90</span>, <span class="hljs-number">85</span>, <span class="hljs-number">95</span>};
        obj.setScores(testScores);
        
        <span class="hljs-type">int</span>[] scores = obj.getScores();
        scores[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 修改的是副本，不影响原数组</span>
        
        System.out.println(<span class="hljs-string">"平均分: "</span> + obj.getAverageScore());
        
        <span class="hljs-comment">// 链式调用</span>
        <span class="hljs-type">AdvancedGetterSetter</span> <span class="hljs-variable">obj2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvancedGetterSetter</span>(<span class="hljs-string">"002"</span>)
            .setName(<span class="hljs-string">"李四"</span>);
    }
}
</code></pre>
<h2 data-id="heading-10">🏗️ 封装的实际应用</h2>
<h3 data-id="heading-11"><strong>示例1：银行账户类</strong></h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-comment">// 私有字段</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">String</span> accountNumber;  <span class="hljs-comment">// 账号不可变</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> accountHolder;        <span class="hljs-comment">// 户主姓名</span>
    <span class="hljs-keyword">private</span> double balance;              <span class="hljs-comment">// 余额</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;             <span class="hljs-comment">// 密码（不提供getter）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> isActive;            <span class="hljs-comment">// 账户状态</span>
    
    <span class="hljs-comment">// 构造器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">BankAccount</span>(<span class="hljs-title class_">String</span> accountNumber, <span class="hljs-title class_">String</span> accountHolder, 
                      <span class="hljs-title class_">String</span> password, double initialDeposit) {
        <span class="hljs-comment">// 参数验证</span>
        <span class="hljs-title function_">validateAccountNumber</span>(accountNumber);
        <span class="hljs-title function_">validateAccountHolder</span>(accountHolder);
        <span class="hljs-title function_">validatePassword</span>(password);
        <span class="hljs-title function_">validateInitialDeposit</span>(initialDeposit);
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountNumber</span> = accountNumber;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountHolder</span> = accountHolder;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = password;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">balance</span> = initialDeposit;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActive</span> = <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">// 私有验证方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateAccountNumber</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> accountNumber</span>) {
        <span class="hljs-keyword">if</span> (accountNumber == <span class="hljs-literal">null</span> || !accountNumber.<span class="hljs-title function_">matches</span>(<span class="hljs-string">"\d{16}"</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"账号必须是16位数字"</span>);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateAccountHolder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> accountHolder</span>) {
        <span class="hljs-keyword">if</span> (accountHolder == <span class="hljs-literal">null</span> || accountHolder.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">isEmpty</span>()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"户主姓名不能为空"</span>);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validatePassword</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> password</span>) {
        <span class="hljs-keyword">if</span> (password == <span class="hljs-literal">null</span> || password.<span class="hljs-title function_">length</span>() &lt; <span class="hljs-number">6</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"密码至少6位"</span>);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateInitialDeposit</span>(<span class="hljs-params">double amount</span>) {
        <span class="hljs-keyword">if</span> (amount &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"初始存款不能为负"</span>);
        }
    }
    
    <span class="hljs-comment">// Getter方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAccountNumber</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> accountNumber;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAccountHolder</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> accountHolder;
    }
    
    <span class="hljs-keyword">public</span> double <span class="hljs-title function_">getBalance</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> balance;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isActive</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> isActive;
    }
    
    <span class="hljs-comment">// Setter方法（有限制）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAccountHolder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> accountHolder</span>) {
        <span class="hljs-title function_">validateAccountHolder</span>(accountHolder);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountHolder</span> = accountHolder;
    }
    
    <span class="hljs-comment">// 业务方法（封装业务逻辑）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-params">double amount</span>) {
        <span class="hljs-keyword">if</span> (!isActive) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账户已冻结，无法存款"</span>);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"存款金额必须大于0"</span>);
            <span class="hljs-keyword">return</span>;
        }
        
        balance += amount;
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"存款成功！存入￥%.2f，当前余额￥%.2f%n"</span>, amount, balance);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">double amount, <span class="hljs-built_in">String</span> password</span>) {
        <span class="hljs-keyword">if</span> (!isActive) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账户已冻结，无法取款"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">authenticate</span>(password)) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"密码错误"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"取款金额必须大于0"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-keyword">if</span> (amount &gt; balance) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"余额不足"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        balance -= amount;
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"取款成功！取出￥%.2f，当前余额￥%.2f%n"</span>, amount, balance);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">BankAccount target, double amount, <span class="hljs-built_in">String</span> password</span>) {
        <span class="hljs-keyword">if</span> (!isActive || !target.<span class="hljs-property">isActive</span>) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账户状态异常，无法转账"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">authenticate</span>(password)) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"密码错误"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">withdraw</span>(amount, password)) {
            target.<span class="hljs-title function_">deposit</span>(amount);
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"向%s转账￥%.2f成功%n"</span>, 
                            target.<span class="hljs-title function_">getAccountHolder</span>(), amount);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 私有辅助方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">authenticate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> password</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>.<span class="hljs-title function_">equals</span>(password);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">changePassword</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> oldPassword, <span class="hljs-built_in">String</span> newPassword</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">authenticate</span>(oldPassword)) {
            <span class="hljs-title function_">validatePassword</span>(newPassword);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = newPassword;
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"密码修改成功"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"原密码错误"</span>);
        }
    }
    
    <span class="hljs-comment">// 账户管理方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">activate</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActive</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账户已激活"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deactivate</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActive</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账户已冻结"</span>);
    }
    
    <span class="hljs-comment">// 显示账户信息（隐藏敏感信息）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">displayAccountInfo</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"\n=== 账户信息 ==="</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账号: "</span> + accountNumber);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"户主: "</span> + accountHolder);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"余额: ￥%.2f%n"</span>, balance);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"状态: "</span> + (isActive ? <span class="hljs-string">"正常"</span> : <span class="hljs-string">"冻结"</span>));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"================\n"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 创建账户</span>
        <span class="hljs-title class_">BankAccount</span> account1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankAccount</span>(
            <span class="hljs-string">"6228480012345678"</span>, 
            <span class="hljs-string">"张三"</span>, 
            <span class="hljs-string">"123456"</span>, 
            <span class="hljs-number">1000.00</span>
        );
        
        <span class="hljs-title class_">BankAccount</span> account2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankAccount</span>(
            <span class="hljs-string">"6228480098765432"</span>,
            <span class="hljs-string">"李四"</span>,
            <span class="hljs-string">"654321"</span>,
            <span class="hljs-number">500.00</span>
        );
        
        <span class="hljs-comment">// 测试功能</span>
        account1.<span class="hljs-title function_">displayAccountInfo</span>();
        
        account1.<span class="hljs-title function_">deposit</span>(<span class="hljs-number">500.00</span>);
        account1.<span class="hljs-title function_">withdraw</span>(<span class="hljs-number">200.00</span>, <span class="hljs-string">"123456"</span>);
        account1.<span class="hljs-title function_">withdraw</span>(<span class="hljs-number">200.00</span>, <span class="hljs-string">"错误密码"</span>);  <span class="hljs-comment">// 密码错误</span>
        
        account1.<span class="hljs-title function_">transfer</span>(account2, <span class="hljs-number">300.00</span>, <span class="hljs-string">"123456"</span>);
        
        account1.<span class="hljs-title function_">changePassword</span>(<span class="hljs-string">"123456"</span>, <span class="hljs-string">"新密码"</span>);
        
        account1.<span class="hljs-title function_">deactivate</span>();
        account1.<span class="hljs-title function_">deposit</span>(<span class="hljs-number">100.00</span>);  <span class="hljs-comment">// 账户冻结，无法存款</span>
    }
}
</code></pre>
<h2 data-id="heading-12">⚠️ 封装的常见错误</h2>
<h3 data-id="heading-13"><strong>错误1：过度暴露内部实现</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 错误的封装</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BadEncapsulation</span> {
    <span class="hljs-keyword">public</span> List&lt;String&gt; items;  <span class="hljs-comment">// 直接暴露内部集合</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BadEncapsulation</span>()</span> {
        items = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    }
}

<span class="hljs-comment">// 使用这个类的代码可以这样做：</span>
BadEncapsulation bad = <span class="hljs-keyword">new</span> BadEncapsulation();
bad.items.<span class="hljs-keyword">add</span>(<span class="hljs-string">"直接修改"</span>);  <span class="hljs-comment">// 绕过所有验证逻辑</span>
bad.items = <span class="hljs-literal">null</span>;          <span class="hljs-comment">// 甚至可以破坏内部状态</span>

<span class="hljs-comment">// ✅ 正确的封装</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GoodEncapsulation</span> {
    <span class="hljs-keyword">private</span> List&lt;String&gt; items;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GoodEncapsulation</span>()</span> {
        items = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addItem</span>(<span class="hljs-params">String item</span>)</span> {
        <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span> &amp;&amp; !item.trim().isEmpty()) {
            items.<span class="hljs-keyword">add</span>(item);
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">String</span>&gt; <span class="hljs-title">getItems</span>()</span> {
        <span class="hljs-keyword">return</span> Collections.unmodifiableList(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(items));
    }
}
</code></pre>
<h3 data-id="heading-14"><strong>错误2：Getter/Setter中的逻辑过于复杂</strong></h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不好的做法：在getter/setter中做太多事情</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexGetterSetter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 不应该在getter中修改状态</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-title function_">processData</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>);  <span class="hljs-comment">// ❌ 副作用</span>
        <span class="hljs-title function_">logAccess</span>();                         <span class="hljs-comment">// ❌ 副作用</span>
        <span class="hljs-keyword">return</span> data;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setData</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> data</span>) {
        <span class="hljs-comment">// setter应该只做验证和赋值</span>
        <span class="hljs-title function_">validateData</span>(data);                 <span class="hljs-comment">// ✅ 可以</span>
        <span class="hljs-title function_">logModification</span>();                  <span class="hljs-comment">// ⚠️ 小心：可能有副作用</span>
        <span class="hljs-title function_">sendNotification</span>();                 <span class="hljs-comment">// ❌ 不应该</span>
        <span class="hljs-title function_">updateDatabase</span>();                   <span class="hljs-comment">// ❌ 不应该</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;
    }
}

<span class="hljs-comment">// ✅ 好的做法：保持简单</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleGetterSetter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> data;  <span class="hljs-comment">// 简单返回</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setData</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> data</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isValid</span>(data)) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;
        }
    }
    
    <span class="hljs-comment">// 复杂的业务逻辑放在单独的方法中</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateDataWithNotification</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> data</span>) {
        <span class="hljs-title function_">setData</span>(data);
        <span class="hljs-title function_">sendNotification</span>();
        <span class="hljs-title function_">updateDatabase</span>();
    }
}
</code></pre>
<h2 data-id="heading-15">💡 封装的最佳实践</h2>
<h3 data-id="heading-16"><strong>实践1：使用不可变对象</strong></h3>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 不可变类提供更好的封装</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutablePerson</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> name;      <span class="hljs-comment">// final字段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> age;          <span class="hljs-comment">// final字段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;<span class="hljs-type">String</span>&gt; hobbies;  <span class="hljs-comment">// 引用不可变</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ImmutablePerson</span><span class="hljs-params">(<span class="hljs-type">String</span> name, <span class="hljs-type">int</span> age, List&lt;<span class="hljs-type">String</span>&gt; hobbies)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.age = age;
        <span class="hljs-comment">// 防御性拷贝</span>
        <span class="hljs-keyword">this</span>.hobbies = Collections.<span class="hljs-built_in">unmodifiableList</span>(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(hobbies));
    }
    
    <span class="hljs-comment">// 只有getter，没有setter</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> name; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> age; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-title">getHobbies</span><span class="hljs-params">()</span> </span>{ 
        <span class="hljs-comment">// 返回不可修改的副本</span>
        <span class="hljs-keyword">return</span> Collections.<span class="hljs-built_in">unmodifiableList</span>(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(hobbies));
    }
    
    <span class="hljs-comment">// 修改操作返回新对象</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ImmutablePerson <span class="hljs-title">withName</span><span class="hljs-params">(<span class="hljs-type">String</span> newName)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ImmutablePerson</span>(newName, age, hobbies);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> ImmutablePerson <span class="hljs-title">withAge</span><span class="hljs-params">(<span class="hljs-type">int</span> newAge)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ImmutablePerson</span>(name, newAge, hobbies);
    }
}
</code></pre>
<h3 data-id="heading-17"><strong>实践2：使用Builder模式</strong></h3>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> host;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> timeout;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> sslEnabled;
    
    <span class="hljs-comment">// 私有构造器</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Config</span><span class="hljs-params">(Builder builder)</span> </span>{
        <span class="hljs-keyword">this</span>.host = builder.host;
        <span class="hljs-keyword">this</span>.port = builder.port;
        <span class="hljs-keyword">this</span>.timeout = builder.timeout;
        <span class="hljs-keyword">this</span>.sslEnabled = builder.sslEnabled;
    }
    
    <span class="hljs-comment">// Getter</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getHost</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> host; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getPort</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> port; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getTimeout</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> timeout; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">isSslEnabled</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> sslEnabled; }
    
    <span class="hljs-comment">// Builder</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
        <span class="hljs-comment">// 必填参数</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> host;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;
        
        <span class="hljs-comment">// 可选参数（默认值）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> timeout = <span class="hljs-number">5000</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> sslEnabled = <span class="hljs-literal">false</span>;
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Builder</span><span class="hljs-params">(<span class="hljs-type">String</span> host, <span class="hljs-type">int</span> port)</span> </span>{
            <span class="hljs-keyword">this</span>.host = host;
            <span class="hljs-keyword">this</span>.port = port;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> Builder <span class="hljs-title">timeout</span><span class="hljs-params">(<span class="hljs-type">int</span> timeout)</span> </span>{
            <span class="hljs-keyword">this</span>.timeout = timeout;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> Builder <span class="hljs-title">sslEnabled</span><span class="hljs-params">(<span class="hljs-type">boolean</span> sslEnabled)</span> </span>{
            <span class="hljs-keyword">this</span>.sslEnabled = sslEnabled;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> Config <span class="hljs-title">build</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">// 验证逻辑</span>
            <span class="hljs-keyword">if</span> (host == null || host.<span class="hljs-built_in">trim</span>().<span class="hljs-built_in">isEmpty</span>()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalArgumentException</span>(<span class="hljs-string">"Host不能为空"</span>);
            }
            <span class="hljs-keyword">if</span> (port &lt;= <span class="hljs-number">0</span> || port &gt; <span class="hljs-number">65535</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalArgumentException</span>(<span class="hljs-string">"端口无效"</span>);
            }
            <span class="hljs-keyword">if</span> (timeout &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalArgumentException</span>(<span class="hljs-string">"超时时间不能为负"</span>);
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Config</span>(<span class="hljs-keyword">this</span>);
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        Config config = <span class="hljs-keyword">new</span> Config.<span class="hljs-built_in">Builder</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>)
            .<span class="hljs-built_in">timeout</span>(<span class="hljs-number">10000</span>)
            .<span class="hljs-built_in">sslEnabled</span>(<span class="hljs-literal">true</span>)
            .<span class="hljs-built_in">build</span>();
    }
}
</code></pre>
<h3 data-id="heading-18"><strong>实践3：使用接口进一步封装</strong></h3>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 接口定义契约</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> {
    User <span class="hljs-title function_">findById</span><span class="hljs-params">(String id)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String id)</span>;
    List&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 实现类隐藏实现细节</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">private</span> DataSource dataSource;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"users"</span>;
    
    <span class="hljs-comment">// 隐藏数据库连接细节</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseUserRepository</span><span class="hljs-params">(DataSource dataSource)</span> {
        <span class="hljs-built_in">this</span>.dataSource = dataSource;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-comment">// 复杂的数据库查询逻辑</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection()) {
            <span class="hljs-comment">// SQL查询...</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();  <span class="hljs-comment">// 返回结果</span>
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RepositoryException</span>(<span class="hljs-string">"查询失败"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 其他实现...</span>
}

<span class="hljs-comment">// 使用方只关心接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> UserRepository userRepository;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id);
    }
}
</code></pre>
<h2 data-id="heading-19">📊 封装总结表</h2>









































<table><thead><tr><th>封装级别</th><th>实现方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>字段私有化</strong></td><td>使用private修饰字段</td><td>防止外部直接修改</td><td>需要提供getter/setter</td></tr><tr><td><strong>方法公有化</strong></td><td>通过public方法访问</td><td>可以添加验证逻辑</td><td>可能方法过多</td></tr><tr><td><strong>返回副本</strong></td><td>getter返回对象副本</td><td>保护内部数据</td><td>性能开销</td></tr><tr><td><strong>不可变对象</strong></td><td>使用final字段</td><td>线程安全，状态固定</td><td>修改需要创建新对象</td></tr><tr><td><strong>接口封装</strong></td><td>通过接口暴露功能</td><td>隐藏实现，易于替换</td><td>增加复杂度</td></tr></tbody></table>
<h2 data-id="heading-20">🎓 封装原则总结</h2>
<ol>
<li><strong>最小化访问权限</strong>：使用最严格的访问修饰符</li>
<li><strong>暴露最少接口</strong>：只提供必要的方法</li>
<li><strong>防御性编程</strong>：验证输入，返回副本</li>
<li><strong>保持简单</strong>：Getter/Setter应该简单直接</li>
<li><strong>考虑不可变性</strong>：尽可能使用final字段</li>
<li><strong>使用接口</strong>：进一步隐藏实现细节</li>
<li><strong>文档化约束</strong>：用文档说明使用限制</li>
</ol>
<p>记住：<strong>封装不是隐藏复杂性，而是管理复杂性</strong>。好的封装让类更易于使用、维护和扩展，同时保护内部状态不被意外破坏。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次请求 Request failed with status code 400的解决之旅]]></title>    <link>https://juejin.cn/post/7578803491821322267</link>    <guid>https://juejin.cn/post/7578803491821322267</guid>    <pubDate>2025-12-02T02:27:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578803491821322267" data-draft-id="7578732288516538419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次请求 Request failed with status code 400的解决之旅"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T02:27:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幼儿园的扛把子"/> <meta itemprop="url" content="https://juejin.cn/user/976022053068199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次请求 Request failed with status code 400的解决之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022053068199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幼儿园的扛把子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:27:22.000Z" title="Tue Dec 02 2025 02:27:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在项目开发中遇到一个奇怪的问题，就是某些请求在首页时发送和接收正常，在详情页中请求会报400错误。排查参数信息发现，两者传递的参数一致。然后又对请求进行的对比，发现详情页中的Referer中包含了页面传递的参数中，有"<em>"。正是请求中的Referer携带的 "</em>"，会导致请求报 400。</p>
<h3 data-id="heading-0">解决思路</h3>
<p>Referer 中包含 <code>*</code> 导致请求报 400（Bad Request），核心原因是 <strong><code>*</code></strong> <strong>属于 HTTP 协议中 Referer 头的非法字符</strong>，或服务器端对 Referer 格式做了严格校验（比如正则匹配拒绝含通配符的 Referer）。</p>
<p>发现问题后，第一时间想起，手动修改header中的Referer，</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-comment">// 强制覆盖浏览器的 referer 参数</span>
  <span class="hljs-comment">// 注意：某些浏览器可能会忽略或限制对 Referer 头的修改</span>
  <span class="hljs-type">const</span> customReferer = location.origin + location.pathname
  <span class="hljs-comment">// eslint-disable-next-line dot-notation</span>
  config.headers[<span class="hljs-string">'Referer'</span>] = customReferer
  <span class="hljs-comment">// eslint-disable-next-line dot-notation</span>
  config.headers[<span class="hljs-string">'referer'</span>] = customReferer
</code></pre>
<p>修改后发现，请求是不报错了，但是控制台会有新的提示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce63be70323543caa9aca76e68c95d52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bm85YS_5Zut55qE5omb5oqK5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765248511&amp;x-signature=OeRr0D1SUyAVE4fntgbwsxzCwt0%3D" alt="error" loading="lazy"/></p>
<p><code>Refused to set unsafe header "Referer"</code> 是<strong>浏览器的安全限制</strong>导致的：根据 HTTP 规范和浏览器的同源策略 / 安全机制，<code>Referer</code> 属于「受保护的请求头」—— 浏览器禁止前端 JavaScript 代码<strong>手动修改 / 设置</strong>这个头，仅允许浏览器根据当前页面 URL 自动生成，目的是防止恶意脚本伪造来源地址。</p>
<p>于是再次更换方案，既然报错的原因是由于Referer中携带"<em>"导致，那就对"</em>"进行处理，Referer是取值的当前的链接地址，那就在跳转前对参数进行encode。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">`&amp;params=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">JSON</span>.stringify(params))}</span>`</span>
</code></pre>
<p>问题解决。</p>
<h3 data-id="heading-1">其他解决方案</h3>
<h4 data-id="heading-2">1.  控制 Referer 不发送（最简单，兜底方案）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 完全不发送 Referer 头 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"referrer"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"no-referrer"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 可选：仅同源请求发送 Referer，跨域不发送（更灵活） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"referrer"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"same-origin"</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">2.  单个请求生效（精准控制）</h4>
<p>针对特定请求配置 <code>referrerPolicy</code>（优先级高于 meta 标签）：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">axios</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://目标接口地址'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET/POST'</span>,
    // axios 需通过 referrerPolicy 配置（部分版本需配合 headers 清空）
    <span class="hljs-attr">referrerPolicy</span>: <span class="hljs-string">'no-referrer'</span>,
    <span class="hljs-attr">headers</span>: {
        // 不要手动设置 Referer，留空或删除
        <span class="hljs-attr">Referer</span>: undefined 
  }})
</code></pre>

<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">fetch</span>(<span class="hljs-string">'https://目标接口地址'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET/POST'</span>,
    // 关键：设置 Referer 策略，禁止发送 
    <span class="hljs-attr">RefererreferrerPolicy</span>: <span class="hljs-string">'no-referrer'</span>, 
      // 注意：删除手动设置的 Referer 头！// 
      <span class="hljs-attr">headers</span>: { <span class="hljs-attr">Referer</span>: <span class="hljs-string">'xxx'</span> }  // ❌ 要删掉这行
})
</code></pre>
<h4 data-id="heading-4">3.  服务端处理</h4>
<h5 data-id="heading-5">3.1 Nginx配置改造</h5>
<p>Nginx 默认会拒绝含非法字符的 Referer 头，或 <code>valid_referers</code> 规则匹配失败返回 400/403。解决方法：</p>
<ul>
<li><strong>跳过 Referer 非法字符校验</strong></li>
</ul>

<pre><code class="hljs language-ini" lang="ini">        <span class="hljs-comment"># 关闭非法 header 检查（允许含*的 Referer 进入业务逻辑）</span>
        ignore_invalid_headers off<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>放宽 valid_referers 规则</strong></li>
</ul>
<p>若用 <code>valid_referers</code> 做防盗链，调整规则兼容含 <code>*</code> 的 Referer：</p>
<pre><code class="hljs language-bash" lang="bash">        location / {
            <span class="hljs-comment"># 允许空 Referer、指定域名、含*的 Referer（用~* 正则匹配）</span>
            valid_referers none blocked server_names ~*.example.com ~*/*;
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$invalid_referer</span>) {
                <span class="hljs-comment"># 注释掉 return 403/400，或改为日志记录而非拒绝</span>
                <span class="hljs-comment"># return 400;</span>
                access_log /var/log/nginx/invalid_referer.log warn;
                }
            }
</code></pre>
<h5 data-id="heading-6">3.2  Apache服务器</h5>
<ul>
<li>关闭 RequestHeader严格校验</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">            <span class="hljs-comment"># 在 httpd.conf 或 .htaccess 中</span>
            AcceptPathInfo On
            <span class="hljs-comment"># 或禁用 Referer 校验模块（若启用了 mod_rewrite 校验 Referer）</span>
            RewriteEngine Off  <span class="hljs-comment"># 临时关闭，或调整 RewriteRule 忽略*</span>
</code></pre>
<ul>
<li>若用 <code>mod_rewrite</code> 校验 Referer，修改规则兼容 <code>*</code>：</li>
</ul>

<pre><code class="hljs language-perl" lang="perl">            RewriteCond %{HTTP_REFERER} !^https:<span class="hljs-regexp">//</span>example.com/.* [NC]
            <span class="hljs-comment"># 改为（允许*）</span>
            RewriteCond %{HTTP_REFERER} !^https:<span class="hljs-regexp">//</span>example.com/[^\n]* [NC]
</code></pre>
<h4 data-id="heading-7">3.3  后端应用配置</h4>
<p>拿Java举例:</p>
<pre><code class="hljs language-ini" lang="ini">            &lt;Connector <span class="hljs-attr">port</span>=<span class="hljs-string">"8080"</span> protocol=<span class="hljs-string">"HTTP/1.1"</span>
                       <span class="hljs-attr">connectionTimeout</span>=<span class="hljs-string">"20000"</span>
                       <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">"8443"</span>
                       <span class="hljs-attr">relaxedPathChars</span>=<span class="hljs-string">"[]|{}^&amp;#x5c;&amp;#x60;&amp;quot;&amp;lt;&amp;gt;*"</span>  <span class="hljs-comment"># 加入*</span>
                       <span class="hljs-attr">relaxedQueryChars</span>=<span class="hljs-string">"[]|{}^&amp;#x5c;&amp;#x60;&amp;quot;&amp;lt;&amp;gt;*"</span> /&gt;
</code></pre>
<p>Spring Boot 可通过配置文件：</p>
<pre><code class="hljs language-ini" lang="ini">        <span class="hljs-comment"># application.properties</span>
        <span class="hljs-attr">server.tomcat.relaxed-path-chars</span>=*
        <span class="hljs-attr">server.tomcat.relaxed-query-chars</span>=*
</code></pre>
<h3 data-id="heading-8">总结</h3>
<ol>
<li>发起方：移除 / 编码 <code>*</code>，或不发送 Referer；</li>
<li>接收方：放宽服务器对 Referer 的字符校验（Nginx/Tomcat 配置），或忽略含 <code>*</code> 的 Referer 校验；</li>
<li>核心原则：遵循 HTTP 标准，避免在 Referer 中使用非法字符，改用合法格式或自定义头传递通配语义。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第5章：容器类组件 —— 5.1 填充（Padding）]]></title>    <link>https://juejin.cn/post/7578767608630575104</link>    <guid>https://juejin.cn/post/7578767608630575104</guid>    <pubDate>2025-12-02T02:27:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578767608630575104" data-draft-id="7578794217961078824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第5章：容器类组件 —— 5.1 填充（Padding）"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-02T02:27:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="旧时光_"/> <meta itemprop="url" content="https://juejin.cn/user/4442458669718279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第5章：容器类组件 —— 5.1 填充（Padding）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4442458669718279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    旧时光_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:27:32.000Z" title="Tue Dec 02 2025 02:27:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">5.1 填充（Padding）</h2>
<h3 data-id="heading-1">📚 章节概览</h3>
<p>欢迎来到第5章：容器类组件！本章第一节将学习 <code>Padding</code> 组件，它是最基础也是最常用的容器类组件之一：</p>
<ul>
<li><strong>Padding</strong> - 填充组件</li>
<li><strong>EdgeInsets</strong> - 边距设置类</li>
<li><strong>all</strong> - 所有方向相同填充</li>
<li><strong>only</strong> - 指定某个方向填充</li>
<li><strong>symmetric</strong> - 对称方向填充</li>
<li><strong>fromLTRB</strong> - 分别指定四个方向</li>
<li><strong>实际应用</strong> - 常见使用场景</li>
</ul>
<hr/>
<h3 data-id="heading-2">🎯 核心知识点</h3>
<h4 data-id="heading-3">Padding vs Margin</h4>
<p>在Flutter中，<code>Padding</code> 用于设置内边距（类似CSS的padding），而外边距通常通过Container的margin属性或者外层Padding来实现。</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────┐
│   <span class="hljs-attribute">Margin</span> (外)    │  ← Container的<span class="hljs-attribute">margin</span>或外层<span class="hljs-attribute">Padding</span>
│  ┌────────────┐  │
│  │ <span class="hljs-attribute">Padding</span>(内)│  │  ← <span class="hljs-attribute">Padding</span>组件
│  │  ┌──────┐  │  │
│  │  │Child │  │  │  ← 子组件
│  │  └──────┘  │  │
│  └────────────┘  │
└──────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-4">1️⃣ Padding（填充组件）</h3>
<h4 data-id="heading-5">1.1 构造函数</h4>
<pre><code class="hljs language-dart" lang="dart">Padding({
  Key? key,
  <span class="hljs-keyword">required</span> EdgeInsetsGeometry padding,
  Widget? child,
})
</code></pre>
<h4 data-id="heading-6">1.2 主要属性</h4>




















<table><thead><tr><th>属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>padding</code></td><td>EdgeInsetsGeometry</td><td>填充值（必需）</td></tr><tr><td><code>child</code></td><td>Widget?</td><td>子组件</td></tr></tbody></table>
<h4 data-id="heading-7">1.3 基础用法</h4>
<pre><code class="hljs language-dart" lang="dart">Padding(
  padding: EdgeInsets.all(<span class="hljs-number">16</span>),
  child: Text(<span class="hljs-string">'Hello World'</span>),
)
</code></pre>
<hr/>
<h3 data-id="heading-8">2️⃣ EdgeInsets（边距设置）</h3>
<h4 data-id="heading-9">2.1 什么是EdgeInsets</h4>
<p><code>EdgeInsets</code> 是 <code>EdgeInsetsGeometry</code> 的子类，提供了多种便捷方法来设置填充值。</p>
<h4 data-id="heading-10">2.2 四个便捷方法</h4>
<h5 data-id="heading-11">1. all - 所有方向相同</h5>
<pre><code class="hljs language-dart" lang="dart">EdgeInsets.all(<span class="hljs-built_in">double</span> value)
</code></pre>
<p><strong>用法：</strong></p>
<pre><code class="hljs language-dart" lang="dart">Padding(
  padding: EdgeInsets.all(<span class="hljs-number">16</span>),  <span class="hljs-comment">// 上下左右都是16</span>
  child: Text(<span class="hljs-string">'All方向填充'</span>),
)
</code></pre>
<p><strong>等价于：</strong></p>
<pre><code class="hljs language-dart" lang="dart">EdgeInsets.fromLTRB(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
</code></pre>
<h5 data-id="heading-12">2. only - 指定某个方向</h5>
<pre><code class="hljs language-dart" lang="dart">EdgeInsets.only({
  <span class="hljs-built_in">double</span> left = <span class="hljs-number">0.0</span>,
  <span class="hljs-built_in">double</span> top = <span class="hljs-number">0.0</span>,
  <span class="hljs-built_in">double</span> right = <span class="hljs-number">0.0</span>,
  <span class="hljs-built_in">double</span> bottom = <span class="hljs-number">0.0</span>,
})
</code></pre>
<p><strong>用法：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 只设置左边</span>
Padding(
  padding: EdgeInsets.only(left: <span class="hljs-number">8</span>),
  child: Text(<span class="hljs-string">'左侧填充'</span>),
)

<span class="hljs-comment">// 同时设置多个方向</span>
Padding(
  padding: EdgeInsets.only(left: <span class="hljs-number">20</span>, right: <span class="hljs-number">20</span>),
  child: Text(<span class="hljs-string">'左右填充'</span>),
)
</code></pre>
<h5 data-id="heading-13">3. symmetric - 对称方向</h5>
<pre><code class="hljs language-dart" lang="dart">EdgeInsets.symmetric({
  <span class="hljs-built_in">double</span> vertical = <span class="hljs-number">0.0</span>,    <span class="hljs-comment">// 上下</span>
  <span class="hljs-built_in">double</span> horizontal = <span class="hljs-number">0.0</span>,  <span class="hljs-comment">// 左右</span>
})
</code></pre>
<p><strong>用法：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 只设置上下</span>
Padding(
  padding: EdgeInsets.symmetric(vertical: <span class="hljs-number">8</span>),
  child: Text(<span class="hljs-string">'上下填充'</span>),
)

<span class="hljs-comment">// 同时设置上下和左右</span>
Padding(
  padding: EdgeInsets.symmetric(
    vertical: <span class="hljs-number">12</span>,
    horizontal: <span class="hljs-number">20</span>,
  ),
  child: Text(<span class="hljs-string">'对称填充'</span>),
)
</code></pre>
<h5 data-id="heading-14">4. fromLTRB - 四个方向分别指定</h5>
<pre><code class="hljs language-dart" lang="dart">EdgeInsets.fromLTRB(
  <span class="hljs-built_in">double</span> left,
  <span class="hljs-built_in">double</span> top,
  <span class="hljs-built_in">double</span> right,
  <span class="hljs-built_in">double</span> bottom,
)
</code></pre>
<p><strong>用法：</strong></p>
<pre><code class="hljs language-dart" lang="dart">Padding(
  padding: EdgeInsets.fromLTRB(<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>),
  child: Text(<span class="hljs-string">'四个方向不同值'</span>),
)
</code></pre>
<h4 data-id="heading-15">2.3 方法对比</h4>






























<table><thead><tr><th>方法</th><th>参数</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>all</strong></td><td>1个</td><td>所有方向相同</td></tr><tr><td><strong>only</strong></td><td>1-4个</td><td>指定某些方向</td></tr><tr><td><strong>symmetric</strong></td><td>1-2个</td><td>对称设置</td></tr><tr><td><strong>fromLTRB</strong></td><td>4个</td><td>四个方向都不同</td></tr></tbody></table>
<h4 data-id="heading-16">2.4 选择建议</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ✅ 推荐：简洁明了</span>
EdgeInsets.all(<span class="hljs-number">16</span>)                    <span class="hljs-comment">// 四个方向相同</span>
EdgeInsets.symmetric(horizontal: <span class="hljs-number">16</span>)  <span class="hljs-comment">// 左右相同</span>
EdgeInsets.only(left: <span class="hljs-number">16</span>)            <span class="hljs-comment">// 只设置一个</span>

<span class="hljs-comment">// ❌ 不推荐：过于繁琐</span>
EdgeInsets.fromLTRB(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>)  <span class="hljs-comment">// 应该用all(16)</span>
EdgeInsets.fromLTRB(<span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>)    <span class="hljs-comment">// 应该用symmetric(horizontal: 16)</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">3️⃣ 详细示例</h3>
<h4 data-id="heading-18">3.1 all示例</h4>
<pre><code class="hljs language-dart" lang="dart">Container(
  color: Colors.blue[<span class="hljs-number">100</span>],
  child: Padding(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>),
    child: Container(
      color: Colors.white,
      child: Text(<span class="hljs-string">'16像素填充'</span>),
    ),
  ),
)
</code></pre>
<p><strong>效果：</strong></p>
<pre><code class="hljs">┌────────────────────┐
│ ████████████████ │  ← 蓝色背景（外层Container）
│ ██┌──────────┐██ │
│ ██│ 16px填充 │██ │  ← 白色背景（内层Container）
│ ██└──────────┘██ │
│ ████████████████ │
└────────────────────┘
</code></pre>
<h4 data-id="heading-19">3.2 only示例</h4>
<pre><code class="hljs language-dart" lang="dart">Column(
  children: [
    <span class="hljs-comment">// 只设置左边</span>
    Padding(
      padding: EdgeInsets.only(left: <span class="hljs-number">8</span>),
      child: Text(<span class="hljs-string">"Hello world"</span>),
    ),
    
    <span class="hljs-comment">// 只设置上下</span>
    Padding(
      padding: EdgeInsets.only(top: <span class="hljs-number">8</span>, bottom: <span class="hljs-number">8</span>),
      child: Text(<span class="hljs-string">"I am Jack"</span>),
    ),
    
    <span class="hljs-comment">// 设置左右</span>
    Padding(
      padding: EdgeInsets.only(left: <span class="hljs-number">20</span>, right: <span class="hljs-number">20</span>),
      child: Text(<span class="hljs-string">"Your friend"</span>),
    ),
  ],
)
</code></pre>
<h4 data-id="heading-20">3.3 symmetric示例</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 上下填充</span>
Padding(
  padding: EdgeInsets.symmetric(vertical: <span class="hljs-number">16</span>),
  child: Text(<span class="hljs-string">'上下各16像素'</span>),
)

<span class="hljs-comment">// 左右填充</span>
Padding(
  padding: EdgeInsets.symmetric(horizontal: <span class="hljs-number">24</span>),
  child: Text(<span class="hljs-string">'左右各24像素'</span>),
)

<span class="hljs-comment">// 同时设置</span>
Padding(
  padding: EdgeInsets.symmetric(
    vertical: <span class="hljs-number">12</span>,
    horizontal: <span class="hljs-number">20</span>,
  ),
  child: Text(<span class="hljs-string">'上下12，左右20'</span>),
)
</code></pre>
<h4 data-id="heading-21">3.4 fromLTRB示例</h4>
<pre><code class="hljs language-dart" lang="dart">Padding(
  padding: EdgeInsets.fromLTRB(<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>),
  child: Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    children: [
      Text(<span class="hljs-string">'左：20像素'</span>),
      Text(<span class="hljs-string">'上：10像素'</span>),
      Text(<span class="hljs-string">'右：20像素'</span>),
      Text(<span class="hljs-string">'下：30像素'</span>),
    ],
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-22">4️⃣ 实际应用场景</h3>
<h4 data-id="heading-23">场景1：卡片内容填充</h4>
<pre><code class="hljs language-dart" lang="dart">Container(
  decoration: BoxDecoration(
    color: Colors.white,
    borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
    boxShadow: [
      BoxShadow(
        color: Colors.grey.withOpacity(<span class="hljs-number">0.3</span>),
        blurRadius: <span class="hljs-number">4</span>,
        offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>),
      ),
    ],
  ),
  child: Padding(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          <span class="hljs-string">'文章标题'</span>,
          style: TextStyle(
            fontSize: <span class="hljs-number">16</span>,
            fontWeight: FontWeight.bold,
          ),
        ),
        SizedBox(height: <span class="hljs-number">8</span>),
        Text(
          <span class="hljs-string">'文章内容描述...'</span>,
          style: TextStyle(color: Colors.grey),
        ),
      ],
    ),
  ),
)
</code></pre>
<h4 data-id="heading-24">场景2：按钮内边距</h4>
<pre><code class="hljs language-dart" lang="dart">Container(
  decoration: BoxDecoration(
    color: Colors.blue,
    borderRadius: BorderRadius.circular(<span class="hljs-number">4</span>),
  ),
  child: Padding(
    padding: EdgeInsets.symmetric(
      horizontal: <span class="hljs-number">24</span>,
      vertical: <span class="hljs-number">12</span>,
    ),
    child: Text(
      <span class="hljs-string">'确定'</span>,
      style: TextStyle(color: Colors.white),
    ),
  ),
)
</code></pre>
<h4 data-id="heading-25">场景3：列表项间距</h4>
<pre><code class="hljs language-dart" lang="dart">ListView.builder(
  itemCount: items.length,
  itemBuilder: (context, index) {
    <span class="hljs-keyword">return</span> Padding(
      padding: EdgeInsets.only(bottom: <span class="hljs-number">8</span>),
      child: ListTile(
        title: Text(<span class="hljs-string">'列表项 <span class="hljs-subst">$index</span>'</span>),
      ),
    );
  },
)
</code></pre>
<h4 data-id="heading-26">场景4：页面整体内边距</h4>
<pre><code class="hljs language-dart" lang="dart">Scaffold(
  body: Padding(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>),
    child: Column(
      children: [
        <span class="hljs-comment">// 页面内容</span>
      ],
    ),
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-27">🤔 常见问题（FAQ）</h3>
<h4 data-id="heading-28">Q1: Padding和Margin的区别？</h4>
<p><strong>A:</strong> 在Flutter中：</p>




















<table><thead><tr><th>概念</th><th>实现方式</th><th>说明</th></tr></thead><tbody><tr><td><strong>Padding（内边距）</strong></td><td>Padding组件</td><td>子组件内部的留白</td></tr><tr><td><strong>Margin（外边距）</strong></td><td>Container.margin</td><td>组件外部的留白</td></tr></tbody></table>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Padding（内边距）</span>
Padding(
  padding: EdgeInsets.all(<span class="hljs-number">16</span>),
  child: Container(
    color: Colors.blue,
    child: Text(<span class="hljs-string">'Text'</span>),
  ),
)

<span class="hljs-comment">// Margin（外边距）</span>
Container(
  margin: EdgeInsets.all(<span class="hljs-number">16</span>),
  color: Colors.blue,
  child: Text(<span class="hljs-string">'Text'</span>),
)
</code></pre>
<h4 data-id="heading-29">Q2: EdgeInsets.zero是什么？</h4>
<p><strong>A:</strong> 所有方向填充为0的快捷方式</p>
<pre><code class="hljs language-dart" lang="dart">EdgeInsets.zero  <span class="hljs-comment">// 等价于 EdgeInsets.all(0)</span>
</code></pre>
<h4 data-id="heading-30">Q3: 如何设置负数填充？</h4>
<p><strong>A:</strong> Padding不支持负数，但可以用Transform.translate</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ❌ 错误：Padding不支持负数</span>
Padding(
  padding: EdgeInsets.all(<span class="hljs-number">-10</span>),  <span class="hljs-comment">// 会报错</span>
  child: Text(<span class="hljs-string">'Text'</span>),
)

<span class="hljs-comment">// ✅ 正确：使用Transform</span>
Transform.translate(
  offset: Offset(<span class="hljs-number">-10</span>, <span class="hljs-number">-10</span>),
  child: Text(<span class="hljs-string">'Text'</span>),
)
</code></pre>
<h4 data-id="heading-31">Q4: Padding会影响子组件的约束吗？</h4>
<p><strong>A:</strong> 会！Padding会减小传递给子组件的约束</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 假设父组件约束为 100×100</span>
Container(
  width: <span class="hljs-number">100</span>,
  height: <span class="hljs-number">100</span>,
  child: Padding(
    padding: EdgeInsets.all(<span class="hljs-number">10</span>),
    <span class="hljs-comment">// 子组件实际可用空间：(100-20)×(100-20) = 80×80</span>
    child: Container(color: Colors.blue),
  ),
)
</code></pre>
<h4 data-id="heading-32">Q5: 如何选择使用哪个EdgeInsets方法？</h4>
<p><strong>A:</strong> 遵循简洁原则：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 四个方向相同 → all</span>
EdgeInsets.all(<span class="hljs-number">16</span>)

<span class="hljs-comment">// 上下或左右相同 → symmetric</span>
EdgeInsets.symmetric(horizontal: <span class="hljs-number">16</span>)
EdgeInsets.symmetric(vertical: <span class="hljs-number">8</span>)

<span class="hljs-comment">// 只设置1-3个方向 → only</span>
EdgeInsets.only(left: <span class="hljs-number">16</span>)
EdgeInsets.only(left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span>)

<span class="hljs-comment">// 四个方向都不同 → fromLTRB</span>
EdgeInsets.fromLTRB(<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">30</span>)
</code></pre>
<hr/>
<h3 data-id="heading-33">🎯 跟着做练习</h3>
<h4 data-id="heading-34">练习1：实现一个带内边距的卡片组件</h4>
<p><strong>目标：</strong> 创建一个自定义Card组件，内容有16像素填充</p>
<p><strong>步骤：</strong></p>
<ol>
<li>使用Container作为卡片背景</li>
<li>添加圆角和阴影</li>
<li>使用Padding设置内容填充</li>
</ol>
<details>
<summary>💡 查看答案</summary>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  
  <span class="hljs-keyword">const</span> CustomCard({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child});
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
        boxShadow: [
          BoxShadow(
            color: Colors.grey.withOpacity(<span class="hljs-number">0.2</span>),
            spreadRadius: <span class="hljs-number">1</span>,
            blurRadius: <span class="hljs-number">4</span>,
            offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>),
          ),
        ],
      ),
      child: Padding(
        padding: EdgeInsets.all(<span class="hljs-number">16</span>),
        child: child,
      ),
    );
  }
}

<span class="hljs-comment">// 使用</span>
CustomCard(
  child: Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    children: [
      Text(
        <span class="hljs-string">'标题'</span>,
        style: TextStyle(
          fontSize: <span class="hljs-number">18</span>,
          fontWeight: FontWeight.bold,
        ),
      ),
      SizedBox(height: <span class="hljs-number">8</span>),
      Text(<span class="hljs-string">'这是卡片的内容描述...'</span>),
    ],
  ),
)
</code></pre>
</details>
<hr/>
<h4 data-id="heading-35">练习2：实现响应式Padding</h4>
<p><strong>目标：</strong> 根据屏幕宽度动态调整Padding值</p>
<p><strong>步骤：</strong></p>
<ol>
<li>使用MediaQuery获取屏幕宽度</li>
<li>计算合适的padding值</li>
<li>应用动态padding</li>
</ol>
<details>
<summary>💡 查看答案</summary>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponsivePadding</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  
  <span class="hljs-keyword">const</span> ResponsivePadding({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child});
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> screenWidth = MediaQuery.of(context).size.width;
    
    <span class="hljs-comment">// 根据屏幕宽度计算padding</span>
    <span class="hljs-built_in">double</span> padding;
    <span class="hljs-keyword">if</span> (screenWidth &lt; <span class="hljs-number">600</span>) {
      padding = <span class="hljs-number">16</span>;  <span class="hljs-comment">// 手机</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (screenWidth &lt; <span class="hljs-number">1200</span>) {
      padding = <span class="hljs-number">24</span>;  <span class="hljs-comment">// 平板</span>
    } <span class="hljs-keyword">else</span> {
      padding = <span class="hljs-number">32</span>;  <span class="hljs-comment">// 桌面</span>
    }
    
    <span class="hljs-keyword">return</span> Padding(
      padding: EdgeInsets.all(padding),
      child: child,
    );
  }
}

<span class="hljs-comment">// 使用</span>
ResponsivePadding(
  child: Text(<span class="hljs-string">'响应式内容'</span>),
)
</code></pre>
</details>
<hr/>
<h3 data-id="heading-36">📋 小结</h3>
<h4 data-id="heading-37">核心概念</h4>




















<table><thead><tr><th>组件/类</th><th>作用</th><th>常用方法</th></tr></thead><tbody><tr><td><strong>Padding</strong></td><td>添加填充</td><td>padding属性</td></tr><tr><td><strong>EdgeInsets</strong></td><td>设置填充值</td><td>all、only、symmetric、fromLTRB</td></tr></tbody></table>
<h4 data-id="heading-38">EdgeInsets方法速查</h4>
<pre><code class="hljs language-dart" lang="dart">EdgeInsets.all(<span class="hljs-number">16</span>)                        <span class="hljs-comment">// 所有方向16</span>
EdgeInsets.only(left: <span class="hljs-number">8</span>)                 <span class="hljs-comment">// 只设置左边</span>
EdgeInsets.only(left: <span class="hljs-number">8</span>, right: <span class="hljs-number">8</span>)       <span class="hljs-comment">// 设置左右</span>
EdgeInsets.symmetric(vertical: <span class="hljs-number">16</span>)       <span class="hljs-comment">// 上下16</span>
EdgeInsets.symmetric(horizontal: <span class="hljs-number">20</span>)     <span class="hljs-comment">// 左右20</span>
EdgeInsets.symmetric(                    <span class="hljs-comment">// 上下和左右</span>
  vertical: <span class="hljs-number">12</span>,
  horizontal: <span class="hljs-number">20</span>,
)
EdgeInsets.fromLTRB(<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>)     <span class="hljs-comment">// 四个方向分别指定</span>
EdgeInsets.zero                          <span class="hljs-comment">// 所有方向为0</span>
</code></pre>
<h4 data-id="heading-39">记忆技巧</h4>
<ol>
<li><strong>all</strong>：all方向相同</li>
<li><strong>only</strong>：only某些方向</li>
<li><strong>symmetric</strong>：对称的两个方向</li>
<li><strong>fromLTRB</strong>：Left、Top、Right、Bottom顺序</li>
</ol>
<hr/>
<h3 data-id="heading-40">🔗 相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Fwidgets%2FPadding-class.html" target="_blank" title="https://api.flutter.dev/flutter/widgets/Padding-class.html" ref="nofollow noopener noreferrer">Padding 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Fpainting%2FEdgeInsets-class.html" target="_blank" title="https://api.flutter.dev/flutter/painting/EdgeInsets-class.html" ref="nofollow noopener noreferrer">EdgeInsets 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Fpainting%2FEdgeInsetsGeometry-class.html" target="_blank" title="https://api.flutter.dev/flutter/painting/EdgeInsetsGeometry-class.html" ref="nofollow noopener noreferrer">EdgeInsetsGeometry 官方文档</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目性能优化实践：深入FMP算法原理探索｜得物技术]]></title>    <link>https://juejin.cn/post/7578762210287255615</link>    <guid>https://juejin.cn/post/7578762210287255615</guid>    <pubDate>2025-12-02T02:45:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578762210287255615" data-draft-id="7578760341280751657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目性能优化实践：深入FMP算法原理探索｜得物技术"/> <meta itemprop="keywords" content="算法,前端"/> <meta itemprop="datePublished" content="2025-12-02T02:45:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目性能优化实践：深入FMP算法原理探索｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:45:47.000Z" title="Tue Dec 02 2025 02:45:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前 言</h2>
<p>最近在项目中遇到了页面加载速度优化的问题，为了提高秒开率等指标，我决定从<strong>eebi报表</strong>入手，分析一下当前项目的性能监控体系。</p>
<p>通过查看报表中的cost_time、is_first等字段，我开始了解项目的性能数据采集情况。为了更好地理解这些数据的含义，我深入研究了相关SDK的源码实现。</p>
<p>在分析过程中，我发现采集到的cost_time参数实际上就是<strong>FMP（First Meaningful Paint）</strong> 指标。于是我对FMP的算法实现进行了梳理，了解了它的计算逻辑。</p>
<p>本文将分享我在性能优化过程中的一些思考和发现，希望能对关注前端性能优化的同学有所帮助。</p>
<h2 data-id="heading-1">二、什么是FMP</h2>
<p>FMP (First Meaningful Paint) 首次有意义绘制，是指页面首次绘制有意义内容的时间点。与 FCP (First Contentful Paint) 不同，FMP 更关注的是对用户有实际价值的内容，而不是任何内容的首次绘制。</p>
<h2 data-id="heading-2">三、FMP 计算原理</h2>
<h3 data-id="heading-3">3.1核心思想</h3>
<p>FMP 的核心思想是：<strong>通过分析视口内重要 DOM 元素的渲染时间，找到对用户最有意义的内容完成渲染的时间点</strong>。</p>
<h3 data-id="heading-4">3.2FMP的三种计算方式</h3>
<ul>
<li><strong>新算法 FMP (specifiedValue)</strong> 基于用户指定的 DOM 元素计算通过fmpSelector配置指定元素计算指定元素的完整加载时间</li>
</ul>

<ul>
<li><strong>传统算法 FMP (value)</strong> 基于视口内重要元素计算选择权重最高的元素取所有参考元素中最晚完成的时间</li>
</ul>

<ul>
<li><strong>P80 算法 FMP (p80Value)</strong> 基于 P80 百分位计算取排序后80%位置的时间更稳定的性能指标</li>
</ul>
<h3 data-id="heading-5">3.3新算法vs传统算法</h3>
<p><strong>传统算法流程</strong></p>
<ul>
<li>遍历整个DOM树</li>
<li>计算每个元素的权重分数</li>
<li>选择多个重要元素</li>
<li>计算所有元素的加载时间</li>
<li>取最晚完成的时间作为FMP</li>
</ul>
<p><strong>新算法（指定元素算法）流程</strong></p>
<p><strong>核心思想：</strong> 直接指定一个关键 DOM 元素，计算该元素的完整加载时间作为FMP。</p>
<p><strong>传统算法详细步骤</strong></p>
<p><strong>第一步：DOM元素选择</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 递归遍历 DOM 树，选择重要元素</span>
selectMostImportantDOMs(dom: HTMLElement = document.body): void {
  <span class="hljs-keyword">const</span> score = <span class="hljs-keyword">this</span>.getWeightScore(dom);


  <span class="hljs-keyword">if</span> (score &gt; BODY_WEIGHT) {
    <span class="hljs-comment">// 权重大于 body 权重，作为参考元素</span>
    <span class="hljs-keyword">this</span>.referDoms.push(dom);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-keyword">this</span>.highestWeightScore) {
    <span class="hljs-comment">// 权重大于等于最高分数，作为重要元素</span>
    <span class="hljs-keyword">this</span>.importantDOMs.push(dom);
  }


  <span class="hljs-comment">// 递归处理子元素</span>
  <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>, l = dom.children.length; i &lt; l; i++) {
    <span class="hljs-keyword">this</span>.selectMostImportantDOMs(dom.children[i] <span class="hljs-keyword">as</span> HTMLElement);
  }
}
</code></pre>
<p><strong>第二步：权重计算</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 计算元素权重分数</span>
<span class="hljs-title function_">getWeightScore</span>(<span class="hljs-params">dom: Element</span>) {
  <span class="hljs-comment">// 获取元素在视口中的位置和大小</span>
  <span class="hljs-keyword">const</span> viewPortPos = dom.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">const</span> screenHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getScreenHeight</span>();


  <span class="hljs-comment">// 计算元素在首屏中的可见面积</span>
  <span class="hljs-keyword">const</span> fpWidth = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(viewPortPos.<span class="hljs-property">right</span>, <span class="hljs-variable constant_">SCREEN_WIDTH</span>) - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, viewPortPos.<span class="hljs-property">left</span>);
  <span class="hljs-keyword">const</span> fpHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(viewPortPos.<span class="hljs-property">bottom</span>, screenHeight) - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, viewPortPos.<span class="hljs-property">top</span>);


  <span class="hljs-comment">// 权重 = 可见面积 × 元素类型权重</span>
  <span class="hljs-keyword">return</span> fpWidth * fpHeight * <span class="hljs-title function_">getDomWeight</span>(dom);
}
</code></pre>
<p>权重计算公式：</p>
<pre><code class="hljs">权重分数 = 可见面积 × 元素类型权重
</code></pre>
<p>元素类型权重：</p>
<ul>
<li>OBJECT, EMBED, VIDEO: 最高权重</li>
<li>SVG, IMG, CANVAS: 高权重</li>
<li>其他元素: 权重为 1</li>
</ul>
<p><strong>第三步：加载时间计算</strong></p>
<pre><code class="hljs language-ini" lang="ini">getLoadingTime(dom: HTMLElement, resourceLoadingMap: Record&lt;string, any&gt;): number {
  // 获取 DOM 标记时间
  const <span class="hljs-attr">baseTime</span> = getMarkValueByDom(dom)<span class="hljs-comment">;</span>


  // 获取资源加载时间
  let <span class="hljs-attr">resourceTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  if (RESOURCE_TAG_SET.indexOf(tagType) &gt;= 0) {
    // 处理图片、视频等资源
    const <span class="hljs-attr">resourceTiming</span> = resourceLoadingMap[resourceName]<span class="hljs-comment">;</span>
    <span class="hljs-attr">resourceTime</span> = resourceTiming ? resourceTiming.responseEnd : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  }


  // 返回较大值（DOM 时间 vs 资源时间）
  return Math.max(resourceTime, baseTime)<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>第四步：FMP值计算</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">calcValue(resourceLoadingMap: Record&lt;string, any&gt;, isSubPage: boolean = <span class="hljs-literal">false</span>): void {
  <span class="hljs-comment">// 构建参考元素列表（至少 3 个元素）</span>
  <span class="hljs-keyword">const</span> referDoms = <span class="hljs-keyword">this</span>.referDoms.length &gt;= <span class="hljs-number">3</span> 
    ? <span class="hljs-keyword">this</span>.referDoms 
    : [...<span class="hljs-keyword">this</span>.referDoms, ...<span class="hljs-keyword">this</span>.importantDOMs.slice(<span class="hljs-keyword">this</span>.referDoms.length - <span class="hljs-number">3</span>)];


  <span class="hljs-comment">// 计算每个元素的加载时间</span>
  <span class="hljs-keyword">const</span> timings = referDoms.map(dom =&gt; <span class="hljs-keyword">this</span>.getLoadingTime(dom, resourceLoadingMap));


  <span class="hljs-comment">// 排序时间数组</span>
  <span class="hljs-keyword">const</span> sortedTimings = timings.sort((t1, t2) =&gt; t1 - t2);


  <span class="hljs-comment">// 计算最终值</span>
  <span class="hljs-keyword">const</span> info = getMetricNumber(sortedTimings);
  <span class="hljs-keyword">this</span>.value = info.value;        <span class="hljs-comment">// 最后一个元素的时间（最晚完成）</span>
  <span class="hljs-keyword">this</span>.p80Value = info.p80Value;  <span class="hljs-comment">// P80 百分位时间</span>
}
</code></pre>
<p><strong>新算法详细步骤</strong></p>
<p><strong>第一步：配置指定元素</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 通过全局配置指定 FMP 目标元素
const { <span class="hljs-attr">fmpSelector</span> = <span class="hljs-string">""</span> } = SingleGlobal?.getOptions?.()<span class="hljs-comment">;</span>
</code></pre>
<p>配置示例：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 初始化时配置</span>
<span class="hljs-keyword">init</span>({
  <span class="hljs-params">fmpSelector</span>: '.main<span class="hljs-operator">-</span>content',  <span class="hljs-comment">// 指定主要内容区域</span>
  <span class="hljs-comment">// 或者</span>
  <span class="hljs-params">fmpSelector</span>: '#hero<span class="hljs-operator">-</span>section',  <span class="hljs-comment">// 指定首屏区域</span>
  <span class="hljs-comment">// 或者</span>
  <span class="hljs-params">fmpSelector</span>: '.product<span class="hljs-operator">-</span>list'   <span class="hljs-comment">// 指定产品列表</span>
});
</code></pre>
<p><strong>第二步：查找指定元素</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span><span class="hljs-title function_ invoke__"> </span>(fmpSelector) {
  <span class="hljs-comment">// 使用 querySelector 查找指定的 DOM 元素</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable">$specifiedEl </span>= document.<span class="hljs-title function_ invoke__">querySelector</span>(fmpSelector);


  <span class="hljs-keyword">if</span><span class="hljs-title function_ invoke__"> </span>(<span class="hljs-variable">$specifiedEl </span>&amp;&amp; <span class="hljs-variable">$specifiedEl</span> <span class="hljs-keyword">instanceof</span> HTMLElement) {
    <span class="hljs-comment">// 找到指定元素，进行后续计算</span>
    this.specifiedDom = <span class="hljs-variable">$specifiedEl</span>;
  }
}
</code></pre>
<p>查找逻辑：</p>
<ul>
<li>使用document.querySelector()查找元素</li>
<li>验证元素存在且为 HTMLElement 类型</li>
<li>保存元素引用到specifiedDom</li>
</ul>
<p><strong>第三步：计算指定元素的加载时间</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 计算指定元素的完整加载时间</span>
<span class="hljs-keyword">this</span>.specifiedValue = <span class="hljs-keyword">this</span>.getLoadingTime(
  $specifiedEl,
  resourceLoadingMap
);
</code></pre>
<p><strong>加载时间计算包含：</strong></p>
<ul>
<li>DOM 标记时间</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 获取 DOM 元素的基础标记时间
const <span class="hljs-attr">baseTime</span> = getMarkValueByDom(dom)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>资源加载时间</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">resourceTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
// 处理直接资源（img, video, embed 等）
const <span class="hljs-attr">tagType</span> = dom.tagName.toUpperCase()<span class="hljs-comment">;</span>
if (RESOURCE_TAG_SET.indexOf(tagType) &gt;= 0) {
  const <span class="hljs-attr">resourceName</span> = normalizeResourceName((dom as any).src)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">resourceTiming</span> = resourceLoadingMap[resourceName]<span class="hljs-comment">;</span>
  <span class="hljs-attr">resourceTime</span> = resourceTiming ? resourceTiming.responseEnd : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
}
// 处理背景图片
const <span class="hljs-attr">bgImgUrl</span> = getDomBgImg(dom)<span class="hljs-comment">;</span>
if (isImageUrl(bgImgUrl)) {
  const <span class="hljs-attr">resourceName</span> = normalizeResourceName(bgImgUrl)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">resourceTiming</span> = resourceLoadingMap[resourceName]<span class="hljs-comment">;</span>
  <span class="hljs-attr">resourceTime</span> = resourceTiming ? resourceTiming.responseEnd : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
}
</code></pre>
<ul>
<li>综合时间计算</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 返回 DOM 时间和资源时间的较大值</span>
<span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(resourceTime, baseTime);
</code></pre>
<p><strong>第四步：FMP值确定</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 根据是否有指定值来决定使用哪个 FMP 值
if (<span class="hljs-attr">specifiedValue</span> === <span class="hljs-number">0</span>) {
  // 如果没有指定值，回退到传统算法
  <span class="hljs-attr">fmp</span> = isSubPage ? value - diffTime : value<span class="hljs-comment">;</span>
} else {
  // 如果有指定值，使用指定值
  <span class="hljs-attr">fmp</span> = isSubPage ? specifiedValue - diffTime : specifiedValue<span class="hljs-comment">;</span>
}
</code></pre>
<p>决策逻辑：</p>
<ul>
<li>如果 specifiedValue &gt; 0：使用指定元素的加载时间</li>
<li>如果 specifiedValue === 0：回退到传统算法</li>
</ul>
<p><strong>第五步：子页面时间调整</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 子页面的 FMP 值需要减去时间偏移
if (isSubPage) {
  <span class="hljs-attr">fmp</span> = specifiedValue - diffTime<span class="hljs-comment">;</span>
  // <span class="hljs-attr">diffTime</span> = startSubTime - initTime
}
</code></pre>
<p><strong>新算法的优势</strong></p>
<p><strong>精确性更高</strong></p>
<ul>
<li>直接针对业务关键元素</li>
<li>避免权重计算的误差</li>
<li>更贴近业务需求</li>
</ul>
<p><strong>可控性强</strong></p>
<ul>
<li>开发者可以指定关键元素</li>
<li>可以根据业务场景调整</li>
<li>避免算法自动选择的偏差</li>
</ul>
<p><strong>计算简单</strong></p>
<ul>
<li>只需要计算一个元素</li>
<li>不需要复杂的权重计算</li>
<li>性能开销更小</li>
</ul>
<p><strong>业务导向</strong></p>
<ul>
<li>直接反映业务关键内容的加载时间</li>
<li>更符合用户体验评估需求</li>
<li>便于性能优化指导</li>
</ul>
<h3 data-id="heading-6">3.4关键算法</h3>
<p><strong>P80 百分位计算</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMetricNumber</span>(<span class="hljs-params">sortedTimings: number[]</span>) {
  <span class="hljs-keyword">const</span> value = sortedTimings[sortedTimings.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];  <span class="hljs-comment">// 最后一个（最晚）</span>
  <span class="hljs-keyword">const</span> p80Value = sortedTimings[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((sortedTimings.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) * <span class="hljs-number">0.8</span>)];  <span class="hljs-comment">// P80</span>
  <span class="hljs-keyword">return</span> { value, p80Value };
}
</code></pre>
<p><strong>元素类型权重</strong></p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-keyword">const</span> IMPORTANT_ELEMENT_WEIGHT_MAP = {
  SVG: IElementWeight.High,      <span class="hljs-comment">// 高权重</span>
  IMG: IElementWeight.High,      <span class="hljs-comment">// 高权重</span>
  <span class="hljs-built_in">CANVAS</span>: IElementWeight.High,   <span class="hljs-comment">// 高权重</span>
  OBJECT: IElementWeight.Highest, <span class="hljs-comment">// 最高权重</span>
  EMBED: IElementWeight.Highest, <span class="hljs-comment">// 最高权重</span>
  VIDEO: IElementWeight.Highest   <span class="hljs-comment">// 最高权重</span>
};
</code></pre>
<h2 data-id="heading-7">四、时间标记机制</h2>
<h3 data-id="heading-8">4.1DOM变化监听</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// MutationObserver 监听 DOM 变化</span>
<span class="hljs-keyword">private</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations = []</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleChange</span>(mutations, now);
});
</code></pre>
<h3 data-id="heading-9">4.2时间标记</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 为每个 DOM 变化创建性能标记</span>
<span class="hljs-selector-tag">mark</span>(count);  <span class="hljs-comment">// 创建 performance.mark(`mutation_pc_${count}`)</span>
<span class="hljs-comment">// 为 DOM 元素设置标记</span>
<span class="hljs-built_in">setDataAttr</span>(elem, TAG_KEY, `${mutationCount}`);
</code></pre>
<h3 data-id="heading-10">4.3标记值获取</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 根据 DOM 元素获取标记时间</span>
<span class="hljs-built_in">getMarkValueByDom</span>(dom: HTMLElement) {
  const markValue = <span class="hljs-built_in">getDataAttr</span>(dom, TAG_KEY);
  return <span class="hljs-built_in">getMarkValue</span>(parseInt(markValue));
}
</code></pre>
<h2 data-id="heading-11">五、资源加载考虑</h2>
<h3 data-id="heading-12">5.1资源类型识别</h3>
<p><strong>图片资源</strong>: <img src="" loading="lazy"/> 标签的 src属性</p>
<p><strong>视频资源</strong>:  标签的 src属性</p>
<p><strong>背景图片</strong>: CSS background-image属性</p>
<p><strong>嵌入资源</strong>: , 标签</p><p/>
<h3 data-id="heading-13">5.2资源时间获取</h3>
<pre><code class="hljs language-ini" lang="ini">// 从 Performance API 获取资源加载时间
const <span class="hljs-attr">resourceTiming</span> = resourceLoadingMap[resourceName]<span class="hljs-comment">;</span>
const <span class="hljs-attr">resourceTime</span> = resourceTiming ? resourceTiming.responseEnd : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-14">5.3综合时间计算</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// DOM 时间和资源时间的较大值</span>
<span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(resourceTime, baseTime);
</code></pre>
<h2 data-id="heading-15">六、子页面支持</h2>
<h3 data-id="heading-16">6.1时间偏移处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 子页面从调用 send 方法开始计时</span>
<span class="hljs-keyword">const</span> diffTime = <span class="hljs-keyword">this</span>.startSubTime - <span class="hljs-keyword">this</span>.initTime;
<span class="hljs-comment">// 子页面只统计开始时间之后的资源</span>
<span class="hljs-keyword">if</span> (!isSubPage || resource.startTime &gt; diffTime) {
  resourceLoadingMap[resourceName] = resource;
}
</code></pre>
<h3 data-id="heading-17">6.2FMP值调整</h3>
<pre><code class="hljs language-ini" lang="ini">// 子页面的 FMP 值需要减去时间偏移
<span class="hljs-attr">fmp</span> = isSubPage ? value - diffTime : value<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-18">七、FMP的核心优势</h2>
<h3 data-id="heading-19">7.1用户感知导向</h3>
<p>FMP 最大的优势在于它真正关注用户的实际体验：</p>
<ul>
<li><strong>内容价值优先</strong>：只计算对用户有意义的内容渲染时间</li>
<li><strong>智能权重评估</strong>：根据元素的重要性和可见性进行差异化计算</li>
<li><strong>真实体验映射</strong>：更贴近用户的实际感知，而非技术层面的指标</li>
</ul>
<h3 data-id="heading-20">7.2多维度计算体系</h3>
<p>FMP 采用了更加全面的计算方式：</p>
<ul>
<li><strong>元素权重分析</strong>：综合考虑元素类型和渲染面积的影响</li>
<li><strong>资源加载关联</strong>：将静态资源加载时间纳入计算范围</li>
<li><strong>算法对比验证</strong>：支持多种算法并行计算，确保结果准确性</li>
</ul>
<h3 data-id="heading-21">7.3高精度测量</h3>
<p>FMP 在测量精度方面表现突出：</p>
<ul>
<li><strong>DOM 变化追踪</strong>：基于实际 DOM 结构变化的时间点</li>
<li><strong>API 数据融合</strong>：结合 Performance API 提供的详细数据</li>
<li><strong>统计分析支持</strong>：支持 P80 百分位等多种统计指标，便于性能分析</li>
</ul>
<h2 data-id="heading-22">八、FMP的实际应用场景</h2>
<h3 data-id="heading-23">8.1性能监控实践</h3>
<p>FMP 在性能监控中发挥着重要作用：</p>
<ul>
<li><strong>关键指标追踪</strong>：实时监控页面首次有意义内容的渲染时间</li>
<li><strong>瓶颈识别</strong>：快速定位性能瓶颈和潜在的优化点</li>
<li><strong>趋势分析</strong>：通过历史数据了解性能变化趋势</li>
</ul>
<h3 data-id="heading-24">8.2用户体验评估</h3>
<p>FMP 为产品团队提供了用户视角的性能评估：</p>
<ul>
<li><strong>真实感知测量</strong>：评估用户实际感受到的页面加载速度</li>
<li><strong>竞品对比分析</strong>：对比不同页面或产品的性能表现</li>
<li><strong>用户满意度关联</strong>：将技术指标与用户满意度建立关联</li>
</ul>
<h3 data-id="heading-25">8.3优化指导价值</h3>
<p>FMP 数据为性能优化提供了明确的方向：</p>
<ul>
<li><strong>资源优化策略</strong>：指导静态资源加载顺序和方式的优化</li>
<li><strong>渲染路径优化</strong>：帮助优化关键渲染路径，提升首屏体验</li>
<li><strong>量化效果评估</strong>：为优化效果提供可量化的评估标准</li>
</ul>
<h2 data-id="heading-26">九、总结</h2>
<p>通过这次深入分析，我对 FMP 有了更全面的认识。FMP 通过科学的算法设计，能够准确反映用户感知的页面加载性能，是前端性能监控的重要指标。</p>
<p>它不仅帮助我们更好地理解页面加载过程，更重要的是为性能优化提供了科学的依据。在实际项目中，合理运用 FMP 指标，能够有效提升用户体验，实现真正的"秒开"效果。</p>
<p>希望这篇文章能对正在关注前端性能优化的同学有所帮助，也欢迎大家分享自己的实践经验。</p>
<h3 data-id="heading-27">往期回顾</h3>
<p>1. Dragonboat统一存储LogDB实现分析｜得物技术</p>
<p>2. 从数字到版面：得物数据产品里数字格式化的那些事</p>
<p>3. 一文解析得物自建 Redis 最新技术演进</p>
<p>4. Golang HTTP请求超时与重试：构建高可靠网络请求｜得物技术</p>
<p>5. RN与hawk碰撞的火花之C++异常捕获｜得物技术</p>
<h3 data-id="heading-28">文 /阿列</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[word对比工具从入门到出门]]></title>    <link>https://juejin.cn/post/7578777952726810658</link>    <guid>https://juejin.cn/post/7578777952726810658</guid>    <pubDate>2025-12-02T02:35:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578777952726810658" data-draft-id="7578734725301272628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="word对比工具从入门到出门"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T02:35:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王大宇_"/> <meta itemprop="url" content="https://juejin.cn/user/1412191432225480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            word对比工具从入门到出门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1412191432225480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王大宇_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:35:30.000Z" title="Tue Dec 02 2025 02:35:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="vs">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.hljs-comment,.hljs-quote,.hljs-variable{color:green}.hljs-built_in,.hljs-keyword,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#00f}.hljs-addition,.hljs-attribute,.hljs-literal,.hljs-section,.hljs-string,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type{color:#a31515}.hljs-deletion,.hljs-meta,.hljs-selector-attr,.hljs-selector-pseudo{color:#2b91af}.hljs-doctag{color:grey}.hljs-attr{color:red}.hljs-bullet,.hljs-link,.hljs-symbol{color:#00b0e8}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Word对比</h2>
<blockquote>
<p>本文，我们将实现一个Word对比工具</p>
</blockquote>
<h3 data-id="heading-1">🌰demo</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645d79b9d6f34f7eba4fbe543795a7b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5aSn5a6HXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247730&amp;x-signature=4A7rZ7Asfg5moWsw7JrJ%2Fj07c%2FI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">思路</h3>
<h4 data-id="heading-3">Word文档解析</h4>
<p>Word的本质是XML压缩包，在我们的diff过程中，我们只关心纯文本的变化，因此我们需要先将word进行解析转化。</p>
<p>本文借助mammoth.js完成</p>
<h4 data-id="heading-4">文本token化</h4>
<p>根据不同的粒度做分词</p>
<h4 data-id="heading-5">Diff算法核心</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-common-subsequence%2Fdescription%2F" target="_blank" title="https://leetcode.cn/problems/longest-common-subsequence/description/" ref="nofollow noopener noreferrer">LCS最长公共子序列算法</a></p>
<h4 data-id="heading-6">双栏对比</h4>
<p>本文使用antd组件库</p>
<h3 data-id="heading-7">实现</h3>
<h4 data-id="heading-8">文档解析</h4>
<p>首先，我们通过mammoth将word转化为string</p>
<pre><code class="hljs language-jsx" lang="jsx">  <span class="hljs-comment">// 上传word 并提取文本</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUpload</span>(<span class="hljs-params">file: File, type: <span class="hljs-string">'old'</span> | <span class="hljs-string">'new'</span></span>) {
    <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">await</span> file.<span class="hljs-title function_">arrayBuffer</span>();
    <span class="hljs-comment">// mammith.extractRawText从docx中提取纯文本</span>
    <span class="hljs-keyword">const</span> { value } = <span class="hljs-keyword">await</span> mammoth.<span class="hljs-title function_">extractRawText</span>({ arrayBuffer });
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'old'</span>) {
      <span class="hljs-title function_">setOldText</span>(value);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setNewText</span>(value);
    }
  }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/952acd4a2afb4b8d823cc85ff536c926~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5aSn5a6HXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247730&amp;x-signature=9iznIMghdiD4AkghdS3u4aj%2Bd%2BY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">分词</h4>
<p>按照不同的粒度，将string划分</p>
<pre><code class="hljs language-jsx" lang="jsx">  <span class="hljs-comment">// 分词</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">tokenize</span>(<span class="hljs-params">text: string, mode: string</span>): string[] {
    <span class="hljs-comment">// 按行分，按换行符拆分为数组</span>
    <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'line'</span>) <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\r?\n/</span>);
    <span class="hljs-comment">// 按字符分，把字符串拆分成单个字符数组</span>
    <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'char'</span>) <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);
    <span class="hljs-comment">//用正则将文本切成中文单字、英文单词、其他单个符号</span>
    <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[\u4e00-\u9fa5]|\w+|[^\w\u4e00-\u9fa5]/g</span>) || [];
  }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f992080b9d4f9ca07d67f7e3166f62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5aSn5a6HXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765247730&amp;x-signature=HWu7FOMXuMdpncJYVamoC3yGCnU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">Diff</h4>
<h5 data-id="heading-11">最长公共子序列</h5>
<pre><code class="hljs language-jsx" lang="jsx">  <span class="hljs-comment">// LCS构建DP</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildLCS</span>(<span class="hljs-params">a: string[], b: string[]</span>) {
    <span class="hljs-comment">// 构建二维数组，并将其初始化为0</span>
    <span class="hljs-comment">// dp[i][j]表示从a[i:]与b[j:]的最长公共子序列长度</span>
    <span class="hljs-keyword">const</span> dp = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: a.<span class="hljs-property">length</span> + <span class="hljs-number">1</span> }, <span class="hljs-function">() =&gt;</span>
      <span class="hljs-title class_">Array</span>(b.<span class="hljs-property">length</span> + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>)
    );

    <span class="hljs-comment">// 倒序填充dp</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = a.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = b.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; j--) {
        <span class="hljs-keyword">if</span> (a[i] === b[j]) {
          dp[i][j] = dp[i + <span class="hljs-number">1</span>][j + <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
          dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[i + <span class="hljs-number">1</span>][j], dp[i][j + <span class="hljs-number">1</span>]);
        }
      }
    }

    <span class="hljs-keyword">return</span> dp;
  }
</code></pre>
<h5 data-id="heading-12">差异计算</h5>
<p>基于二维数组计算文本的差异，标记新增、删除、相同的部分</p>
<ul>
<li>设置两个指针分别指向新旧文本</li>
<li>当元素相同，标记为equal，两个指针同时向前</li>
<li>当新文本还有剩余，旧文本已经遍历完，插入新元素</li>
<li>当不满足插入条件，为删除旧元素</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx">  <span class="hljs-comment">// 得到diff结构</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">diffTokens</span>(<span class="hljs-params">a: string[], b: string[]</span>): <span class="hljs-title class_">DiffPart</span>[] {
    <span class="hljs-comment">//构建新旧内容dp数组</span>
    <span class="hljs-keyword">const</span> dp = <span class="hljs-title function_">buildLCS</span>(a, b);
    <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>,
      j = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">DiffPart</span>[] = [];

    <span class="hljs-comment">// 便利新旧内容</span>
    <span class="hljs-keyword">while</span> (i &lt; a.<span class="hljs-property">length</span> &amp;&amp; j &lt; b.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">//若当前token相等，则记录下来并移动i j</span>
      <span class="hljs-keyword">if</span> (i &lt; a.<span class="hljs-property">length</span> &amp;&amp; j &lt; b.<span class="hljs-property">length</span> &amp;&amp; a[i] === b[j]) {
        result.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>, <span class="hljs-attr">text</span>: a[i] });
        i++;
        j++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
        j &lt; b.<span class="hljs-property">length</span> &amp;&amp;
        (i === a.<span class="hljs-property">length</span> || dp[i][j + <span class="hljs-number">1</span>] &gt;= dp[i + <span class="hljs-number">1</span>][j])
      ) {
        result.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: b[j] });
        j++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i &lt; a.<span class="hljs-property">length</span>) {
        result.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'delete'</span>, <span class="hljs-attr">text</span>: a[i] });
        i++;
      }
    }
    <span class="hljs-keyword">return</span> result;
  }
</code></pre>
<h5 data-id="heading-13">数据流动🌰</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧文本</span>
<span class="hljs-keyword">const</span> oldText = <span class="hljs-string">"今天天气很好，我们去公园散步吧。"</span>;
<span class="hljs-comment">// 新文本  </span>
<span class="hljs-keyword">const</span> newText = <span class="hljs-string">"今天天气不错，我们去山上徒步吧，顺便看看风景。"</span>;
<span class="hljs-comment">// 对比粒度</span>
<span class="hljs-keyword">const</span> granularity = <span class="hljs-string">"word"</span>;
</code></pre>
<p>分词</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧文本分词结果</span>
<span class="hljs-keyword">const</span> oldTokens = <span class="hljs-title function_">tokenize</span>(<span class="hljs-string">"今天天气很好，我们去公园散步吧。"</span>, <span class="hljs-string">"word"</span>);
<span class="hljs-comment">// 结果: ["今天", "天气", "很", "好", "，", "我们", "去", "公园", "散步", "吧", "。"]</span>

<span class="hljs-comment">// 新文本分词结果</span>
<span class="hljs-keyword">const</span> newTokens = <span class="hljs-title function_">tokenize</span>(<span class="hljs-string">"今天天气不错，我们去山上徒步吧，顺便看看风景。"</span>, <span class="hljs-string">"word"</span>); 
<span class="hljs-comment">// 结果: ["今天", "天气", "不", "错", "，", "我们", "去", "山上", "徒步", "吧", "，", "顺便", "看看", "风景", "。"]</span>
</code></pre>
<p>构建LCS</p>
<pre><code class="hljs language-jsx" lang="jsx">oldTokens = [<span class="hljs-string">"今天"</span>, <span class="hljs-string">"天气"</span>, <span class="hljs-string">"很"</span>, <span class="hljs-string">"好"</span>, <span class="hljs-string">"，"</span>, <span class="hljs-string">"我们"</span>, <span class="hljs-string">"去"</span>, <span class="hljs-string">"公园"</span>, <span class="hljs-string">"散步"</span>, <span class="hljs-string">"吧"</span>, <span class="hljs-string">"。"</span>]
newTokens = [<span class="hljs-string">"今天"</span>, <span class="hljs-string">"天气"</span>, <span class="hljs-string">"不"</span>, <span class="hljs-string">"错"</span>, <span class="hljs-string">"，"</span>, <span class="hljs-string">"我们"</span>, <span class="hljs-string">"去"</span>, <span class="hljs-string">"山上"</span>, <span class="hljs-string">"徒步"</span>, <span class="hljs-string">"吧"</span>, <span class="hljs-string">"，"</span>, <span class="hljs-string">"顺便"</span>, <span class="hljs-string">"看看"</span>, <span class="hljs-string">"风景"</span>, <span class="hljs-string">"。"</span>]
</code></pre>
<p>Diff</p>
<pre><code class="hljs language-jsx" lang="jsx">[
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>,  <span class="hljs-attr">text</span>: <span class="hljs-string">'今天'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>,  <span class="hljs-attr">text</span>: <span class="hljs-string">'天气'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'delete'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'很'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'delete'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'好'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>,  <span class="hljs-attr">text</span>: <span class="hljs-string">'，'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>,  <span class="hljs-attr">text</span>: <span class="hljs-string">'我们'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>,  <span class="hljs-attr">text</span>: <span class="hljs-string">'去'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'山上'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'delete'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'公园'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'徒步'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>,  <span class="hljs-attr">text</span>: <span class="hljs-string">'吧'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'，'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'顺便'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'看看'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'风景'</span> },
  { <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>,  <span class="hljs-attr">text</span>: <span class="hljs-string">'。'</span> }
]
</code></pre>
<h4 data-id="heading-14">完整代码</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Upload</span>,
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">Row</span>,
  <span class="hljs-title class_">Col</span>,
  <span class="hljs-title class_">Select</span>,
  <span class="hljs-title class_">Input</span>,
  <span class="hljs-title class_">Typography</span>,
  <span class="hljs-title class_">Space</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UploadOutlined</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/icons'</span>;
<span class="hljs-keyword">import</span> mammoth <span class="hljs-keyword">from</span> <span class="hljs-string">'mammoth'</span>;
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">TextArea</span> } = <span class="hljs-title class_">Input</span>;
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Title</span> } = <span class="hljs-title class_">Typography</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.less'</span>;
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// diff</span>
<span class="hljs-comment">// insert 添加  delete 删除  equal 相等</span>
type <span class="hljs-title class_">DiffPart</span> = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span> | <span class="hljs-string">'delete'</span> | <span class="hljs-string">'equal'</span>;
  <span class="hljs-attr">text</span>: string;
};
<span class="hljs-keyword">const</span> <span class="hljs-title function_">WordDiffTool</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 旧文本内容</span>
  <span class="hljs-keyword">const</span> [oldText, setOldText] =
    useState&lt;string&gt;(<span class="hljs-string">'这是一个示例文本，用于测试对比功能。'</span>);

  <span class="hljs-comment">// 新文本内容</span>
  <span class="hljs-keyword">const</span> [newText, setNewText] = useState&lt;string&gt;(
    <span class="hljs-string">'这是用于测试的示例文本，用于对比功能。添加了一些内容。'</span>
  );

  <span class="hljs-comment">// 对比粒度</span>
  <span class="hljs-keyword">const</span> [granularity, setGranularity] = useState&lt;<span class="hljs-string">'word'</span> | <span class="hljs-string">'char'</span> | <span class="hljs-string">'line'</span>&gt;(
    <span class="hljs-string">'word'</span>
  );

  <span class="hljs-comment">// 上传word 并提取文本</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUpload</span>(<span class="hljs-params">file: File, type: <span class="hljs-string">'old'</span> | <span class="hljs-string">'new'</span></span>) {
    <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">await</span> file.<span class="hljs-title function_">arrayBuffer</span>();
    <span class="hljs-comment">// mammith.extractRawText从docx中提取纯文本</span>
    <span class="hljs-keyword">const</span> { value } = <span class="hljs-keyword">await</span> mammoth.<span class="hljs-title function_">extractRawText</span>({ arrayBuffer });
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'old'</span>) {
      <span class="hljs-title function_">setOldText</span>(value);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setNewText</span>(value);
    }
  }

  <span class="hljs-comment">// 分词</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">tokenize</span>(<span class="hljs-params">text: string, mode: string</span>): string[] {
    <span class="hljs-comment">// 按行分，按换行符拆分为数组</span>
    <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'line'</span>) <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\r?\n/</span>);
    <span class="hljs-comment">// 按字符分，把字符串拆分成单个字符数组</span>
    <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'char'</span>) <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>);
    <span class="hljs-comment">//用正则将文本切成中文单字、英文单词、其他单个符号</span>
    <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[\u4e00-\u9fa5]|\w+|[^\w\u4e00-\u9fa5]/g</span>) || [];
  }

  <span class="hljs-comment">// LCS构建DP</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildLCS</span>(<span class="hljs-params">a: string[], b: string[]</span>) {
    <span class="hljs-comment">// 构建二维数组，并将其初始化为0</span>
    <span class="hljs-comment">// dp[i][j]表示从a[i:]与b[j:]的最长公共子序列长度</span>
    <span class="hljs-keyword">const</span> dp = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: a.<span class="hljs-property">length</span> + <span class="hljs-number">1</span> }, <span class="hljs-function">() =&gt;</span>
      <span class="hljs-title class_">Array</span>(b.<span class="hljs-property">length</span> + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>)
    );

    <span class="hljs-comment">// 倒序填充dp</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = a.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = b.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; j--) {
        <span class="hljs-keyword">if</span> (a[i] === b[j]) {
          dp[i][j] = dp[i + <span class="hljs-number">1</span>][j + <span class="hljs-number">1</span>] + <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
          dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[i + <span class="hljs-number">1</span>][j], dp[i][j + <span class="hljs-number">1</span>]);
        }
      }
    }

    <span class="hljs-keyword">return</span> dp;
  }

  <span class="hljs-comment">// 得到diff结构</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">diffTokens</span>(<span class="hljs-params">a: string[], b: string[]</span>): <span class="hljs-title class_">DiffPart</span>[] {
    <span class="hljs-comment">//构建新旧内容dp数组</span>
    <span class="hljs-keyword">const</span> dp = <span class="hljs-title function_">buildLCS</span>(a, b);
    <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>,
      j = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">DiffPart</span>[] = [];

    <span class="hljs-comment">// 便利新旧内容</span>
    <span class="hljs-keyword">while</span> (i &lt; a.<span class="hljs-property">length</span> || j &lt; b.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">//若当前token相等，则记录下来并移动i j</span>
      <span class="hljs-keyword">if</span> (i &lt; a.<span class="hljs-property">length</span> &amp;&amp; j &lt; b.<span class="hljs-property">length</span> &amp;&amp; a[i] === b[j]) {
        result.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>, <span class="hljs-attr">text</span>: a[i] });
        i++;
        j++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
        j &lt; b.<span class="hljs-property">length</span> &amp;&amp;
        (i === a.<span class="hljs-property">length</span> || dp[i][j + <span class="hljs-number">1</span>] &gt;= dp[i + <span class="hljs-number">1</span>][j])
      ) {
        result.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: b[j] });
        j++;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i &lt; a.<span class="hljs-property">length</span>) {
        result.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'delete'</span>, <span class="hljs-attr">text</span>: a[i] });
        i++;
      }
    }
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 将diff 转化成左右两侧展示</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildSideBySide</span>(<span class="hljs-params">parts: DiffPart[]</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">oldView</span>: <span class="hljs-title class_">DiffPart</span>[] = [];
    <span class="hljs-keyword">const</span> <span class="hljs-attr">newView</span>: <span class="hljs-title class_">DiffPart</span>[] = [];

    parts.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (p.<span class="hljs-property">type</span> === <span class="hljs-string">'equal'</span>) {
        oldView.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>, <span class="hljs-attr">text</span>: p.<span class="hljs-property">text</span> });
        newView.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>, <span class="hljs-attr">text</span>: p.<span class="hljs-property">text</span> });
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p.<span class="hljs-property">type</span> === <span class="hljs-string">'delete'</span>) {
        oldView.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'delete'</span>, <span class="hljs-attr">text</span>: p.<span class="hljs-property">text</span> });
        newView.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>, <span class="hljs-attr">text</span>: p.<span class="hljs-property">text</span> });
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p.<span class="hljs-property">type</span> === <span class="hljs-string">'insert'</span>) {
        oldView.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'equal'</span>, <span class="hljs-attr">text</span>: p.<span class="hljs-property">text</span> });
        newView.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>, <span class="hljs-attr">text</span>: p.<span class="hljs-property">text</span> });
      }
    });

    <span class="hljs-keyword">return</span> { oldView, newView };
  }

  <span class="hljs-keyword">const</span> oldTokens = <span class="hljs-title function_">tokenize</span>(oldText, granularity);
  <span class="hljs-keyword">const</span> newTokens = <span class="hljs-title function_">tokenize</span>(newText, granularity);

  <span class="hljs-keyword">const</span> diffParts = <span class="hljs-title function_">diffTokens</span>(oldTokens, newTokens);
  <span class="hljs-keyword">const</span> { oldView, newView } = <span class="hljs-title function_">buildSideBySide</span>(diffParts);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderDiff</span>(<span class="hljs-params">parts: DiffPart[]</span>) {
    <span class="hljs-keyword">return</span> parts.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">p, i</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (p.<span class="hljs-property">type</span> === <span class="hljs-string">'equal'</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{p.text}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
      <span class="hljs-keyword">if</span> (p.<span class="hljs-property">type</span> === <span class="hljs-string">'delete'</span>)
        <span class="hljs-keyword">return</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"deleted"</span>&gt;</span>
            {p.text}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
        );
      <span class="hljs-keyword">if</span> (p.<span class="hljs-property">type</span> === <span class="hljs-string">'insert'</span>) {
        <span class="hljs-keyword">return</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"inserted"</span>&gt;</span>
            {p.text}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
        );
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    });
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"word-diff-tool"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Title</span> <span class="hljs-attr">level</span>=<span class="hljs-string">{3}</span>&gt;</span>Word 文本对比工具<span class="hljs-tag">&lt;/<span class="hljs-name">Title</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">Space</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">16</span> }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Upload</span>
          <span class="hljs-attr">beforeUpload</span>=<span class="hljs-string">{file</span> =&gt;</span> {
            handleUpload(file, 'old').catch(err =&gt; {
              console.log('文件处理失败', err);
            });
            return false;
          }}
          showUploadList={false}
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">UploadOutlined</span> /&gt;</span>}&gt;上传旧文本<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Upload</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">Upload</span>
          <span class="hljs-attr">beforeUpload</span>=<span class="hljs-string">{file</span> =&gt;</span> {
            handleUpload(file, 'new').catch(err =&gt; {
              console.log('文件处理失败', err);
            });
            return false;
          }}
          showUploadList={false}
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">UploadOutlined</span> /&gt;</span>}&gt;上传新文本<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Upload</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{granularity}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{v</span> =&gt;</span> setGranularity(v)}
          className="granularity-select"
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Select.Option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"word"</span>&gt;</span>按词 diff<span class="hljs-tag">&lt;/<span class="hljs-name">Select.Option</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Select.Option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"char"</span>&gt;</span>按字符 diff<span class="hljs-tag">&lt;/<span class="hljs-name">Select.Option</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Select.Option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"line"</span>&gt;</span>按行 diff<span class="hljs-tag">&lt;/<span class="hljs-name">Select.Option</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Select</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Space</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">Row</span> <span class="hljs-attr">gutter</span>=<span class="hljs-string">{24}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{12}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"diff-col"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"col-title old"</span>&gt;</span>旧版本内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">TextArea</span>
              <span class="hljs-attr">rows</span>=<span class="hljs-string">{10}</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{oldText}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setOldText(e.target.value)}
            /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"diff-result"</span>&gt;</span>{renderDiff(oldView)}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{12}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"diff-col"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"col-title new"</span>&gt;</span>新版本内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">TextArea</span>
              <span class="hljs-attr">rows</span>=<span class="hljs-string">{10}</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{newText}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setNewText(e.target.value)}
            /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"diff-result"</span>&gt;</span>{renderDiff(newView)}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Row</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">WordDiffTool</span>;
</code></pre>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.word-diff-tool</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">24px</span>;

  <span class="hljs-selector-class">.diff-col</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.05</span>);

    <span class="hljs-selector-class">.col-title</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;

      <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-class">.old</span> {
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#c0392b</span>;
      }
      <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-class">.new</span> {
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#27ae60</span>;
      }
    }

    <span class="hljs-selector-class">.diff-result</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">min-height</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#f0f0f0</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.8</span>;
      <span class="hljs-attribute">white-space</span>: pre-wrap;
      <span class="hljs-attribute">overflow</span>: auto;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#fafafa</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#bbb</span>;
    }
  }

  <span class="hljs-selector-class">.deleted</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#ffe5e5</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#e11</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1px</span> <span class="hljs-number">3px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">3px</span>;
  }

  <span class="hljs-selector-class">.inserted</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#e6ffed</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#0a0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">1px</span> <span class="hljs-number">3px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">3px</span>;
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三傻排序（冒泡，选择，插入）Java大白话（老毕登可以跳过）]]></title>    <link>https://juejin.cn/post/7578820431039332392</link>    <guid>https://juejin.cn/post/7578820431039332392</guid>    <pubDate>2025-12-02T02:45:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820431039332392" data-draft-id="7578402574652227636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三傻排序（冒泡，选择，插入）Java大白话（老毕登可以跳过）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T02:45:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhengzizhe"/> <meta itemprop="url" content="https://juejin.cn/user/159867906828928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三傻排序（冒泡，选择，插入）Java大白话（老毕登可以跳过）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/159867906828928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhengzizhe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:45:33.000Z" title="Tue Dec 02 2025 02:45:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">三种排序算法详解</h2>
<p>本文档解释了三种基本的排序算法及其Java实现。所有实现都将相同的数组<code>[1, 6, 8, 2, 3]</code>按升序排列。</p>
<h3 data-id="heading-1">1. 选择排序 (choose.java)</h3>
<p>选择排序通过重复从未排序部分找到最小元素并将其放置在开头来工作。</p>
<h4 data-id="heading-2">工作原理：</h4>
<ol>
<li>在整个数组中找到最小元素并与第一个元素交换</li>
<li>在剩余未排序部分找到最小元素并与第二个元素交换</li>
<li>重复此过程直到整个数组有序</li>
</ol>
<h4 data-id="heading-3">实现代码：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">int</span>[] a = {<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; a.length; i++) {
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i; j &lt; a.length; j++) {
            <span class="hljs-keyword">if</span> (a[index] &gt; a[j]) {
                index = j;
            }
        }
        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> a[i];
        a[i] = a[index];
        a[index] = temp;
    }
    System.out.println(Arrays.toString(a));
}
</code></pre>
<h4 data-id="heading-4">特点：</h4>
<ul>
<li>时间复杂度：O(n²)</li>
<li>空间复杂度：O(1)</li>
<li>不稳定（可能会改变相等元素的相对顺序）</li>
<li>在小数据集上表现良好</li>
</ul>
<h3 data-id="heading-5">2. 冒泡排序 (effervescence.java)</h3>
<p>冒泡排序通过重复遍历列表，比较相邻元素并在顺序错误时交换它们来工作。每一轮遍历后，最大的元素会"冒泡"到数组的末尾。</p>
<h4 data-id="heading-6">工作原理：</h4>
<ol>
<li>比较相邻元素，如果左边的大于右边的则交换它们</li>
<li>每次完整遍历后，未排序元素中的最大值会移动到正确位置</li>
<li>重复直到不需要交换为止</li>
</ol>
<h4 data-id="heading-7">实现代码：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">int</span>[] a = {<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; a.length - <span class="hljs-number">1</span>; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; a.length - <span class="hljs-number">1</span> - i; j++) {
            <span class="hljs-keyword">if</span> (a[j] &gt; a[j + <span class="hljs-number">1</span>]) {
                <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> a[j];
                a[j] = a[j + <span class="hljs-number">1</span>];
                a[j + <span class="hljs-number">1</span>] = temp;
            }
        }
    }
    System.out.println(Arrays.toString(a));
}
</code></pre>
<h4 data-id="heading-8">特点：</h4>
<ul>
<li>时间复杂度：O(n²)</li>
<li>空间复杂度：O(1)</li>
<li>稳定排序算法</li>
<li>自适应 - 可以检测列表是否已经排序</li>
</ul>
<h3 data-id="heading-9">3. 插入排序 (insert.java)</h3>
<p>插入排序通过逐个构建最终的排序数组来工作。它的工作方式类似于人们如何整理手中的扑克牌。</p>
<h4 data-id="heading-10">工作原理：</h4>
<ol>
<li>从第二个元素（索引1）开始</li>
<li>将其与前面的元素比较并插入到正确位置</li>
<li>移动到下一个元素并重复直到整个数组有序</li>
</ol>
<h4 data-id="heading-11">实现代码：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">int</span>[] a = {<span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; a.length; i++) {
        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i;
        <span class="hljs-keyword">for</span> (; j &gt; <span class="hljs-number">0</span>; j--) {
            <span class="hljs-keyword">if</span> (a[j] &lt; a[j - <span class="hljs-number">1</span>]) {
                <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> a[j];
                a[j] = a[j - <span class="hljs-number">1</span>];
                a[j - <span class="hljs-number">1</span>] = temp;
            } <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">break</span>;
        }
    }
    System.out.println(Arrays.toString(a));
}
</code></pre>
<h4 data-id="heading-12">特点：</h4>
<ul>
<li>时间复杂度：O(n²)</li>
<li>空间复杂度：O(1)</li>
<li>稳定排序算法</li>
<li>对小数据集高效</li>
<li>自适应 - 对已基本排序的数据集很高效</li>
</ul>
<h3 data-id="heading-13">总结</h3>
<p>这三种算法都具有O(n²)的时间复杂度，使得它们对于大数据集来说效率不高。但它们对教育目的和小数组排序很有价值。每种算法都有自己的优势：</p>
<ul>
<li>插入排序是其中最有价值的，一句话，假设一侧是有序的，新元素去寻找有序列表的位置</li>
<li>选择排序最小化交换次数，一句话，假设一侧是有序的，去剩下的选择一个最大或者最小然后放入末尾</li>
<li>冒泡排序简单易懂且易于实现 ，一句话，假设一侧是有序的，从开头或者结尾，不断就近比较，把最大最小拱到一侧</li>
<li>插入排序对于近似排序的数组很高效，并且是稳定的</li>
</ul>
<p>对于较大的数据集，更高级的算法如快速排序、归并排序或堆排序将是更合适的选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[公司 React 应用感觉很慢，我把没必要的重复渲染砍掉了 40%!]]></title>    <link>https://juejin.cn/post/7578793960626602010</link>    <guid>https://juejin.cn/post/7578793960626602010</guid>    <pubDate>2025-12-02T02:47:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578793960626602010" data-draft-id="7578777952726515746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="公司 React 应用感觉很慢，我把没必要的重复渲染砍掉了 40%!"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T02:47:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            公司 React 应用感觉很慢，我把没必要的重复渲染砍掉了 40%!
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:47:19.000Z" title="Tue Dec 02 2025 02:47:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>公司 React 应用表现很差。重复渲染感觉像迷一样，不知道大家有不没有过这样的经历：</p>
<ul>
<li>明明传入的数据没变，组件却还是重渲染</li>
<li>父组件一更新，很多子组件跟着一起重渲染（部分子组件数据并没有变化）</li>
<li>在组件内部定义函数，导致每次渲染都出现“新的”函数引用</li>
<li>Context API 的更新把大块区域都刷新了，而不是只刷新需要的那一小块</li>
</ul>
<p>这些问题也侧面反映，要求 <code>React</code> 使用者需要更多的心智以及对框架原理更多了解，才能做好 <code>React</code> 开发。</p>
<p>但这也是一个很好的话题，当面试官问你性能优化的时候，关于 <code>React</code> 框架层面的优化，可以参考这篇文章，如何解决公司的 React 应用重复渲染问题！</p>
<p>首先我们需要找到为什么性能出现问题的原因</p>
<h2 data-id="heading-1">用 Profiler 把问题揪出来</h2>
<p>第一步开始用数据查看到底哪里出了问题。React DevTools 里的 Profiler 很好用，它可以记录你在应用中的交互，告诉你哪些组件重渲染了、为什么重渲染、用了多长时间。</p>
<p>装好 React DevTools 后，打开 “Profiler” 标签。开始录制，做一些感觉卡顿的操作，然后停止录制。</p>
<p>生成的“火焰图”能很直观的告诉我们发生了什么。我能看到一些组件在 props 看起来没变的情况下也在重渲染。这就成了我优化的切入点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d24eb12eb0f4cb7ae823a9c265582d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765248439&amp;x-signature=IC0VO1XUgQvDQ4mmp1aTq%2FgRbFc%3D" alt="1_eZCNwCucXBbH7il1bUI-3g.webp" loading="lazy"/></p>
<h2 data-id="heading-2">一些简单却有效的修复措施</h2>
<p>定位到问题区域后，我开始逐个尝试修复。有些方法很简单，但效果很明显。</p>
<h3 data-id="heading-3">用 React.memo 阻止无效渲染</h3>
<p>一个很常见的问题是：父组件重渲染时，子组件也跟着重渲染，哪怕它自己的 props 并没有变化。</p>
<ul>
<li>问题：默认情况下，只要父组件渲染，React 也会把它的子组件一起渲染。</li>
<li>解决：用 React.memo 包裹组件，告诉 React：“只有当这个组件的 props 真的变了才重渲染。注意，它只会对 props 做浅比较！举例如下：</li>
</ul>
<p>之前：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ name }</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Rendering UserProfile'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>之后：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { memo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserProfile</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> 
<span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ name }</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Rendering UserProfile'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
});
</code></pre>
<p>把组件用 React.memo 包起来后，它只会在 name 这个 prop 变化时重渲染，而不是每次父组件渲染都跟着来一遍。</p>
<h3 data-id="heading-4">用 useMemoizedFn 固定函数引用</h3>
<p>在复杂场景最好放弃用 useCallback，写依赖是一个很麻烦的事情，强烈建议使用 <code>ahooks</code> 库导出的 <code>useMemoizedFn</code> 函数。为什么呢？</p>
<ul>
<li>useCallback 通过依赖项保证“函数引用稳定”，但只在依赖不变时稳定；一旦依赖变更，函数引用也会变，容易让子组件误以为 props 变了而重渲染。同时会有闭包中拿到旧值的问题。</li>
<li>ahooks 的 useMemoizedFn 始终返回“稳定的函数引用”，同时内部能拿到最新的闭包值，避免“陈旧闭包”问题与不必要的重渲染。</li>
</ul>
<p>举例：</p>
<p>useCallback</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useCallback：依赖变化会导致函数引用变化</span>
<span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

<span class="hljs-comment">// 当 state 变化,  func 函数的引用才变化</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state);
}, [state]);
</code></pre>
<p>useMemoizedFn</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useMemoizedFn：始终稳定的函数引用，内部总能拿到最新状态，不用写第二个依赖参数</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-title function_">useMemoizedFn</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state);
});
</code></pre>
<h3 data-id="heading-5">用 useMemo 让对象和数组保持稳定</h3>
<p>和函数类似，如果你在渲染过程中创建对象或数组，也会带来问题。</p>
<ul>
<li>问题：每次渲染都会新建一个对象或数组，即便里面的数据没变。把它作为 prop 传给经过记忆化的子组件，仍然会触发重渲染。</li>
<li>解决： useMemo 会对值进行记忆化，只在依赖发生变化时才重新计算。</li>
</ul>
<p>之前：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">StyleComponent</span>(<span class="hljs-params">{ isHighlighted }</span>) {
  <span class="hljs-keyword">const</span> style = {
    <span class="hljs-attr">backgroundColor</span>: isHighlighted ? 
    <span class="hljs-string">'yellow'</span> : <span class="hljs-string">'white'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>&gt;</span>Some content&lt;/
  div&gt;;
}
</span></code></pre>
<p>之后：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">StyleComponent</span>(<span class="hljs-params">{ isHighlighted }</span>) {
  <span class="hljs-keyword">const</span> style = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">backgroundColor</span>: isHighlighted ? 
    <span class="hljs-string">'yellow'</span> : <span class="hljs-string">'white'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>
  }), [isHighlighted]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>&gt;</span>Some content&lt;/
  div&gt;;
}
</span></code></pre>
<p>用 useMemo 后， style 这个对象只会在 isHighlighted 变化时才被重新创建，避免了不必要的重渲染。</p>
<h3 data-id="heading-6">拆分 Context</h3>
<ul>
<li>Context API 能避免层层传递 props，但也可能成为性能陷阱。</li>
<li>问题：只要某个 Context 的值变化，所有消费它的组件都会重渲染，即便它只关心其中未变的那一小部分数据。</li>
<li>解决：不要用一个“大而全”的 Context，把不同的状态拆分成多个更小的 Context。</li>
<li>例如：不再用一个同时包含用户数据、主题设置、通知的 AppContext ，而是拆成 UserContext 、 ThemeContext 、 NotificationContext 。这样主题更新只会重渲染使用 ThemeContext 的组件。</li>
</ul>
<h2 data-id="heading-7">最终效果</h2>
<ul>
<li>应用这些修复后再次用 Profiler 测试，差异非常明显。持续的重复渲染消失了，交互更顺滑。</li>
<li>数据显示整体渲染时间减少了约 40%，应用终于顺畅运行。</li>
</ul>
<h2 data-id="heading-8">欢迎加入交流群</h2>
<ul>
<li>插入一个我开发的 headless（无样式） 组件库的广告，前端组件库覆盖了前端绝大多数技术场景，如果你想对生产级可用的组件库开发感兴趣，欢迎了解，也欢迎加入交流群：
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.frontlight.tech%2F" target="_blank" title="https://www.frontlight.tech/" ref="nofollow noopener noreferrer">组件库官网</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">感谢 github star</a></li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day21 | 枚举（Enum）与常见应用场景]]></title>    <link>https://juejin.cn/post/7578803751608680498</link>    <guid>https://juejin.cn/post/7578803751608680498</guid>    <pubDate>2025-12-02T02:22:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578803751608680498" data-draft-id="7578732288516587571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day21 | 枚举（Enum）与常见应用场景"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-12-02T02:22:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day21 | 枚举（Enum）与常见应用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:22:22.000Z" title="Tue Dec 02 2025 02:22:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在写代码的时候，经常会遇到一些变量，它们的取值范围是有限且固定的。</p>
<p>例如，一周有七天（周一到周日），订单的几种状态（待支付、处理中、已发货、已完成、已取消），春夏秋冬四个季节。</p>
<p>在Java 5之前，我们一般使用public static final修饰常量来表示这些值，但这种方式存在很多弊端。</p>
<p>今天，我们一起探讨Java提供的一种更强大、更安全的解决方案——枚举（Enum）。</p>
<h2 data-id="heading-0">一、没有枚举之前</h2>
<p>在枚举出现之前，我们通常这样定义一组相关的常量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day21;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> ConstantsDemo
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/6/6 13:46
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantsDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">STATUS_PENDING</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">STATUS_PROCESSING</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">STATUS_SHIPPED</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">STATUS_COMPLETED</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrderStatus</span><span class="hljs-params">(<span class="hljs-type">int</span> status)</span> {
        <span class="hljs-keyword">if</span> (ConstantsDemo.STATUS_COMPLETED == status) {
            System.out.println(<span class="hljs-string">"订单处理完成"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ConstantsDemo.STATUS_PROCESSING == status) {
            System.out.println(<span class="hljs-string">"订单处理中"</span>);
        }
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>这样的写法可能会引发一些问题。</p>
<p>假如方法的调用者传入了一些没有定义的常量值，可能会导致程序逻辑出问题。</p>
<p>这些常量一般都分散在各个类里，如果多了，很可能就产生命名冲突。</p>
<p>如果你在调试的时候，只能输出数字，而不是有意义的名称，比如PENDING、PROCESSING。</p>
<p>没办法遍历所有可能得值。</p>
<p>如果你使用了switch，switch语句没办法检查你是不是覆盖了所有可能的值。</p>
<p>就是因为这些问题，Java 5正式引入了enum关键字。</p>
<h2 data-id="heading-1">二、枚举的基本用法（常量）</h2>
<p>枚举是一种特殊的类，它允许我们定义一个由固定的、命名的常量组成集合的类型。</p>
<h3 data-id="heading-2">1、基本定义</h3>
<p>定义一个枚举其实很简单：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day21;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> DayOfWeek
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/6/6 13:57
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DayOfWeek</span> {
    MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY;
}
</code></pre>
<p>DayOfWeek就是一个枚举类型，MONDAY、TUESDAY等是这个类型的实例（就是DayOfWeek类型的对象）。</p>
<h3 data-id="heading-3">2、基本使用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day21;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> EnumDemo
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/6/6 14:00
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnumDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">DayOfWeek</span> <span class="hljs-variable">today</span> <span class="hljs-operator">=</span> DayOfWeek.FRIDAY;

        <span class="hljs-keyword">switch</span> (today) {
            <span class="hljs-keyword">case</span> MONDAY -&gt; System.out.println(<span class="hljs-string">"又要开始搬砖了"</span>);
            <span class="hljs-keyword">case</span> FRIDAY -&gt; System.out.println(<span class="hljs-string">"搬砖结束"</span>);
            <span class="hljs-keyword">case</span> SATURDAY -&gt; System.out.println(<span class="hljs-string">"享受周末"</span>);
            <span class="hljs-keyword">default</span> -&gt; System.out.println(<span class="hljs-string">"一天又一天"</span>);
        }

        System.out.println(today);
    }
}
</code></pre>
<p>方法只接受指定类型的实例，避免传入无效值。</p>
<p>代码里能够直观的看出常量的含义。</p>
<h2 data-id="heading-4">三、特殊类</h2>
<p>在Java中，每个enum类型都是java.lang.Enum类的隐式子类，并且它本身是一个final类，不能被其他类继承。</p>
<p>这意味着枚举可以拥有自己的字段（成员变量）、方法、构造函数、实现接口。</p>
<h3 data-id="heading-5">1、给枚举添加字段、方法和构造函数</h3>
<p>我们可以为每个枚举实例关联额外的数据和行为。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day21;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> OrderStatus
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/6/6 14:12
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    PENDING(<span class="hljs-number">10</span>, <span class="hljs-string">"待支付"</span>),
    PROCESSING(<span class="hljs-number">20</span>, <span class="hljs-string">"处理中"</span>),
    SHIPPED(<span class="hljs-number">30</span>, <span class="hljs-string">"已发货"</span>),
    COMPLETED(<span class="hljs-number">40</span>, <span class="hljs-string">"已完成"</span>),
    CANCELED(<span class="hljs-number">50</span>, <span class="hljs-string">"已取消"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String description;

    OrderStatus(<span class="hljs-type">int</span> code, String description) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.description = description;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> code;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> description;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">OrderStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> OrderStatus.COMPLETED;
        System.out.println(<span class="hljs-string">"订单状态:"</span> + status);
        System.out.println(<span class="hljs-string">"状态编码:"</span> + status.getCode());
        System.out.println(<span class="hljs-string">"状态描述:"</span> + status.getDescription());
    }
}
</code></pre>
<p>上面定义的枚举类中，有私有字段、构造函数和公共方法。</p>
<h3 data-id="heading-6">2、枚举的内置方法</h3>
<p>java.lang.Enum基类为所有枚举提供了几个有用的静态和实例方法：</p>
<p>values()</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">for</span> (OrderStatus s : OrderStatus.values()) {
    System.out.printf(<span class="hljs-string">"编码: %d, 描述: %s\n"</span>, s.getCode(), s.getDescription());
}
</code></pre>
<p>values()方法是一个静态方法，返回一个包含所有枚举实例的数组。</p>
<p>使用这个方法，配合for循环，可以方便的对所有枚举常量进行遍历。</p>
<p>valueOf(String name)</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">OrderStatus</span> <span class="hljs-variable">status1</span> <span class="hljs-operator">=</span> OrderStatus.valueOf(<span class="hljs-string">"COMPLETED"</span>);
</code></pre>
<p>valueOf(String name)也是一个静态方法，可以根据给定的字符串名称返回对应的枚举实例。</p>
<p>如果名称不匹配，就会抛出异常（IllegalArgumentException）。</p>
<p>name()</p>
<p>这是一个实例方法，返回枚举实例的名称（即声明时的标识符，比如"COMPLETED"）。</p>
<p>ordinal()</p>
<p>这是一个实例方法，返回枚举实例在声明时的序数（从0开始）。</p>
<blockquote>
<p>这个方法一般都不会在业务代码里使用。、 万一你在枚举声明里改变了常量的顺序，所有依赖ordinal()的代码都会出错。</p>
</blockquote>
<h2 data-id="heading-7">四、常见的应用场景</h2>
<p>上面提到过的常量这些简单的应用就不说了。</p>
<h3 data-id="heading-8">状态机</h3>
<p>枚举非常适合用来表示有限状态机的状态。</p>
<p>每个枚举实例代表一个状态，并且可以在枚举类中定义方法来处理状态转换逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TrafficLight</span> {
    RED {
        <span class="hljs-keyword">public</span> TrafficLight <span class="hljs-title function_">next</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> GREEN; }
    },
    GREEN {
        <span class="hljs-keyword">public</span> TrafficLight <span class="hljs-title function_">next</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> YELLOW; }
    },
    YELLOW {
        <span class="hljs-keyword">public</span> TrafficLight <span class="hljs-title function_">next</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> RED; }
    };

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> TrafficLight <span class="hljs-title function_">next</span><span class="hljs-params">()</span>;
}

<span class="hljs-type">TrafficLight</span> <span class="hljs-variable">light</span> <span class="hljs-operator">=</span> TrafficLight.RED;
System.out.println(<span class="hljs-string">"Current light: "</span> + light);
light = light.next();
System.out.println(<span class="hljs-string">"Next light: "</span> + light);
light = light.next();
System.out.println(<span class="hljs-string">"Next light: "</span> + light);
</code></pre>
<p>上面这个红绿灯的案例，每种状态中还定义了方法，来实现红绿灯状态的转换。</p>
<h3 data-id="heading-9">EnumSet和EnumMap</h3>
<p>Java的集合框架还给枚举提供了两个高度优化的实现。</p>
<p>EnumSet</p>
<p>这是一个专门为枚举类设计的Set实现。</p>
<p>它的内部使用位向量实现，性能上来说比HashSet好很多。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d064bbe4beef42ef89c1f5217cf0e5d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765246941&amp;x-signature=5o543aJ4sOYMFZAqDIJT%2BSYQOTU%3D" alt="" loading="lazy"/></p>
<p>EnumMap</p>
<p>这是一个键为枚举类型的Map实现。</p>
<p>它的内部使用数组实现，性能也优于HashMap。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456520ad627f40938105ffea72330153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765246941&amp;x-signature=OLZDeXSSpBKaZ5ozLOj0k%2FrMsV0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">结语</h2>
<p>今天就简单的介绍了一下枚举类。</p>
<p>列举了一些简单的用法和实际开发场景中的用途。</p>
<p>案例中的Java集合框架将在接下来的文章中逐一进行介绍。</p>
<p>下一篇预告</p>
<blockquote>
<p>Day22 | IDEA使用教程</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p>
<p><strong>更多文章请关注我的公众号《懒惰蜗牛工坊》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ubuntu系统与docker]]></title>    <link>https://juejin.cn/post/7578781397117501486</link>    <guid>https://juejin.cn/post/7578781397117501486</guid>    <pubDate>2025-12-02T02:56:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578781397117501486" data-draft-id="7578732288516702259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ubuntu系统与docker"/> <meta itemprop="keywords" content="Docker"/> <meta itemprop="datePublished" content="2025-12-02T02:56:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dawn11"/> <meta itemprop="url" content="https://juejin.cn/user/4012584995709753"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ubuntu系统与docker
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4012584995709753/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dawn11
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:56:51.000Z" title="Tue Dec 02 2025 02:56:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一 安装docker
1.更新软件包列表</p>
<pre><code class="hljs language-shell" lang="shell">sudo apt update
</code></pre>
<ol start="2">
<li>安装依赖包</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
</code></pre>
<ol start="3">
<li>添加阿里云GPG密钥</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
</code></pre>
<ol start="4">
<li>添加阿里云Docker软件源</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</code></pre>
<ol start="5">
<li>安装Docker Engine</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io
</code></pre>
<ol start="6">
<li>配置Docker镜像加速（可选）</li>
</ol>
<p>（1）创建Docker配置目录</p>
<pre><code class="hljs language-shell" lang="shell">sudo mkdir -p /etc/docker
</code></pre>
<p>（2）编辑配置文件</p>
<pre><code class="hljs language-shell" lang="shell">sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF' { "registry-mirrors": ["https://你的阿里云镜像加速地址.mirror.aliyuncs.com"] } EOF
</code></pre>
<blockquote>
<p>阿里云镜像加速地址需登录阿里云官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcr.console.aliyun.com%2F" target="_blank" title="https://cr.console.aliyun.com/" ref="nofollow noopener noreferrer">容器镜像服务</a>），在「镜像工具」→「镜像加速器」中获取。</p>
</blockquote>
<p>(3)重启Docker服务</p>
<pre><code class="hljs language-shell" lang="shell">sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre>
<ol start="7">
<li>验证安装</li>
</ol>
<pre><code class="hljs language-shell" lang="shell">docker --version
docker run hello-world # 测试拉取镜像
</code></pre>
<p>二 创建并进入Docker容器
方法 1：创建并交互式进入容器（常用）
使用 <code>docker run</code> 命令创建并直接进入容器，参数说明：</p>
<ul>
<li><code>-it</code>：交互式模式（<code>-i</code>）+ 分配伪终端（<code>-t</code>）</li>
<li><code>--name</code>：指定容器名称（可选）</li>
<li><code>镜像名:标签</code>：使用的镜像（如 <code>ubuntu:latest</code>、<code>centos:7</code> 等）</li>
<li><code>/bin/bash</code>：进入容器后执行的命令（通常为 shell）</li>
</ul>
<p>示例：创建并进入一个名为 <code>my-ubuntu</code> 的 Ubuntu 容器</p>
<pre><code class="hljs language-shell" lang="shell">sudo docker run -it --name my-ubuntu ubuntu:latest /bin/bash
</code></pre>
<p>方法2：先创建容器，再进入容器</p>
<ol>
<li>创建容器（后台运行）
<pre><code class="hljs language-bash" lang="bash">sudo docker create -it --name my-centos centos:7 /bin/bash
</code></pre>
</li>
<li>启动容器
<pre><code class="hljs language-bash" lang="bash">sudo docker start my-centos
</code></pre>
</li>
<li>进入容器
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方法 A：使用 exec 进入（推荐，多进程安全）</span>
sudo docker <span class="hljs-built_in">exec</span> -it my-centos /bin/bash

<span class="hljs-comment"># 方法 B：使用 attach 进入（单进程，退出会停止容器）</span>
sudo docker attach my-centos
</code></pre>
</li>
</ol>
<p>三 退出容器的方式
临时退出，保留容器运行</p>
<blockquote>
<p>按 <code>Ctrl + P + Q</code></p>
</blockquote>
<p>永久退出，停止容器</p>
<blockquote>
<p>输入 <code>exit</code> 或按 <code>Ctrl + D</code></p>
</blockquote>
<p>四 常用容器管理命令</p>
<p>查看运行中的容器</p>
<blockquote>
<p><code>sudo docker ps</code></p>
</blockquote>
<p>查看所有容器（含停止的）</p>
<blockquote>
<p><code>sudo docker ps -a</code></p>
</blockquote>
<p>停止容器</p>
<blockquote>
<p><code>sudo docker stop 容器名/容器ID</code></p>
</blockquote>
<p>启动已停止的容器</p>
<blockquote>
<p><code>sudo docker start 容器名/容器ID</code></p>
</blockquote>
<p>删除容器</p>
<blockquote>
<p><code>sudo docker rm 容器名/容器ID</code></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[android 使用 java 编写网络连通性检查]]></title>    <link>https://juejin.cn/post/7578732288516898867</link>    <guid>https://juejin.cn/post/7578732288516898867</guid>    <pubDate>2025-12-02T02:58:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578732288516898867" data-draft-id="7578732288516866099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="android 使用 java 编写网络连通性检查"/> <meta itemprop="keywords" content="前端,Java,Android"/> <meta itemprop="datePublished" content="2025-12-02T02:58:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lichong951"/> <meta itemprop="url" content="https://juejin.cn/user/1486195453865687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            android 使用 java 编写网络连通性检查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1486195453865687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lichong951
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T02:58:24.000Z" title="Tue Dec 02 2025 02:58:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面给出 <strong>纯 Java 代码</strong>、<strong>兼容 Android API 19+</strong>、<strong>零三方库</strong> 的“网络连通性检查”工具类。
特点：</p>
<ul>
<li>同时检测 <strong>Wi-Fi/移动数据是否真正上网</strong>（不只是“已连接”）</li>
<li>使用 <strong>HttpURLConnection</strong>，不阻塞主线程</li>
<li>支持 <strong>超时设置</strong>（秒级）</li>
<li>返回 <strong>布尔结果 + 失败原因日志</strong></li>
</ul>
<hr/>
<h3 data-id="heading-0">✅ NetCheck.java（可直接拷贝）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> android.content.Context;
<span class="hljs-keyword">import</span> android.net.ConnectivityManager;
<span class="hljs-keyword">import</span> android.net.NetworkInfo;
<span class="hljs-keyword">import</span> android.os.AsyncTask;
<span class="hljs-keyword">import</span> java.net.HttpURLConnection;
<span class="hljs-keyword">import</span> java.net.URL;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetCheck</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callback</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResult</span><span class="hljs-params">(<span class="hljs-type">boolean</span> ok)</span>;
    }

    <span class="hljs-comment">/** 对外入口：主线程调用，回调仍在主线程 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isOnline</span><span class="hljs-params">(Context ctx, Callback cb)</span> {
        <span class="hljs-keyword">if</span> (!isConnected(ctx)) {
            cb.onResult(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 真正发 HTTP 探活</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">PingTask</span>(cb).execute();
    }

    <span class="hljs-comment">/* ========== 内部实现 ========== */</span>

    <span class="hljs-comment">/* 1. 系统是否声明已连接 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isConnected</span><span class="hljs-params">(Context ctx)</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager)
                ctx.getSystemService(Context.CONNECTIVITY_SERVICE);
        <span class="hljs-type">NetworkInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> cm.getActiveNetworkInfo();
        <span class="hljs-keyword">return</span> info != <span class="hljs-literal">null</span> &amp;&amp; info.isConnected();
    }

    <span class="hljs-comment">/* 2. 异步探活，避免 ANR */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PingTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncTask</span>&lt;Void, Void, Boolean&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Callback cb;
        PingTask(Callback cb) { <span class="hljs-built_in">this</span>.cb = cb; }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> Boolean <span class="hljs-title function_">doInBackground</span><span class="hljs-params">(Void... voids)</span> {
            <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// ① 国内通用、响应快；② 支持 HEAD，省流量</span>
                conn = (HttpURLConnection) <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://www.baidu.com"</span>).openConnection();
                conn.setRequestMethod(<span class="hljs-string">"HEAD"</span>);
                conn.setConnectTimeout(<span class="hljs-number">3_000</span>);
                conn.setReadTimeout(<span class="hljs-number">3_000</span>);
                <span class="hljs-type">int</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> conn.getResponseCode();
                <span class="hljs-keyword">return</span> (code &gt;= <span class="hljs-number">200</span> &amp;&amp; code &lt; <span class="hljs-number">400</span>);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) conn.disconnect();
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPostExecute</span><span class="hljs-params">(Boolean ok)</span> {
            cb.onResult(ok);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">NetCheck</span><span class="hljs-params">()</span> {}
}
</code></pre>
<hr/>
<h3 data-id="heading-1">✅ 使用示例（Activity/Fragment 内）</h3>
<pre><code class="hljs language-java" lang="java">NetCheck.isOnline(<span class="hljs-built_in">this</span>, ok -&gt; {
    <span class="hljs-keyword">if</span> (ok) {
        <span class="hljs-comment">// 真正连网</span>
    } <span class="hljs-keyword">else</span> {
        Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">"网络不可用"</span>, Toast.LENGTH_SHORT).show();
    }
});
</code></pre>
<hr/>
<h3 data-id="heading-2">⚠️ 权限要求（AndroidManifest.xml）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.INTERNET"</span>/&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">🔧 如需同步调用（阻塞）</h3>
<p>把 <code>PingTask</code> 里的代码抽出来直接跑即可，但 <strong>严禁在主线程执行</strong>，否则 Android 7.0+ 会抛 <code>NetworkOnMainThreadException</code>。</p>
<hr/>
<p>一句话总结
<strong>上面 <code>NetCheck.isOnline()</code> 兼顾“是否连网”+“能否上网”，兼容 API 19，无三方依赖，直接复制即可用。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 协程中Job和SupervisorJob —— 新手指南]]></title>    <link>https://juejin.cn/post/7578780780026855433</link>    <guid>https://juejin.cn/post/7578780780026855433</guid>    <pubDate>2025-12-02T03:03:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578780780026855433" data-draft-id="7578709098256400422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 协程中Job和SupervisorJob —— 新手指南"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-02T03:03:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 协程中Job和SupervisorJob —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:03:49.000Z" title="Tue Dec 02 2025 03:03:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin：协程为管理异步操作提供了强大的工具，而<code>Job</code>和<code>SupervisorJob</code>正是这个系统的核心。理解这些概念对于构建健壮、容错的应用程序至关重要。本文将从它们的区别、使用场景和最佳实践进行讲解。</h2>
<h2 data-id="heading-1">一、概念</h2>
<h4 data-id="heading-2">什么是Job？</h4>
<p><code>Job</code>是一个具有生命周期的可取消任务。每个协程都有一个关联的Job，用于控制其执行。</p>
<p>你可以把Job看作是协程的句柄，它允许你：</p>
<ul>
<li>取消协程</li>
<li>等待其完成</li>
<li>检查其状态（活跃、完成、取消）</li>
<li>建立父子关系</li>
</ul>
<h4 data-id="heading-3">什么是SupervisorJob？</h4>
<p><code>SupervisorJob</code>是一种特殊类型的Job，它改变了取消行为。</p>
<p>使用SupervisorJob时：</p>
<ul>
<li><strong>子Job失败不会向上传播:</strong>  失败的子Job不会取消父Job</li>
<li><strong>向下传播仍然有效:</strong>   取消父Job仍然会取消子Job</li>
<li><strong>兄弟Job相互独立：</strong>  一个子Job的失败不会影响兄弟Job</li>
</ul>
<h2 data-id="heading-4">二、 Job生命周期状态</h2>
<ul>
<li><strong>新建</strong> — Job已创建但尚未启动（仅适用于惰性协程）</li>
<li><strong>活跃</strong> — Job正在运行</li>
<li><strong>完成中</strong> — Job正在完成但等待子Job</li>
<li><strong>已完成</strong> — Job成功完成</li>
<li><strong>取消中</strong> — Job正在被取消</li>
<li><strong>已取消</strong> — Job已被取消</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/302e662c76544fec8c6f97ffd75987ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUUlORzYxOA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765249428&amp;x-signature=HuSunEV2NPNT8kmld%2FTW8MnAKGI%3D" alt="deepseek_mermaid_20251202_892c7b.png" loading="lazy"/></p>
<h2 data-id="heading-5">三、Job状态详细说明及示例</h2>
<h4 data-id="heading-6">1. New (新建)</h4>
<ul>
<li>刚刚创建但还未启动的 Job</li>
<li>需要通过 <code>start()</code> 或 <code>launch</code> 启动</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = Job()  <span class="hljs-comment">// 创建后处于 New 状态</span>
job.start()      <span class="hljs-comment">// 启动后变为 Active</span>
</code></pre>
<h4 data-id="heading-7">2. Active (活跃)</h4>
<ul>
<li>Job 正在运行</li>
<li>可以创建子协程</li>
<li>属性状态：
<ul>
<li><code>isActive = true</code></li>
<li><code>isCompleted = false</code></li>
<li><code>isCancelled = false</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 协程体执行中 - Active 状态</span>
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Done"</span>)
}
</code></pre>
<h4 data-id="heading-8">3. Completing (完成中)</h4>
<ul>
<li>协程体已执行完毕</li>
<li>正在等待所有子协程完成</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCompleted = false</code> (还有子协程未完成)</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">4. Completed (已完成)</h4>
<ul>
<li>协程及其所有子协程都已正常完成</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCompleted = true</code></li>
<li><code>isCancelled = false</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 正常执行完成</span>
}
job.join()  <span class="hljs-comment">// 等待进入 Completed 状态</span>
</code></pre>
<h4 data-id="heading-10">5. Cancelling (取消中)</h4>
<ul>
<li>收到取消请求，正在执行取消操作</li>
<li>可能还在执行 <code>finally</code> 块或挂起函数</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCancelled = true</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-keyword">try</span> {
        delay(<span class="hljs-number">10000</span>)
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 进入 Cancelling 状态</span>
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 仍可执行挂起函数</span>
    }
}
delay(<span class="hljs-number">100</span>)
job.cancel()  <span class="hljs-comment">// 触发 Cancelling 状态</span>
</code></pre>
<h4 data-id="heading-11">6. Cancelled (已取消)</h4>
<ul>
<li>取消操作已完成</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCompleted = true</code> (注意：已取消也被视为完成)</li>
<li><code>isCancelled = true</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">7. 状态检查方法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 协程体</span>
}

<span class="hljs-comment">// 检查状态</span>
println(<span class="hljs-string">"isActive: <span class="hljs-subst">${job.isActive}</span>"</span>)      <span class="hljs-comment">// 是否活跃</span>
println(<span class="hljs-string">"isCompleted: <span class="hljs-subst">${job.isCompleted}</span>"</span>) <span class="hljs-comment">// 是否完成</span>
println(<span class="hljs-string">"isCancelled: <span class="hljs-subst">${job.isCancelled}</span>"</span>) <span class="hljs-comment">// 是否取消</span>

<span class="hljs-comment">// 等待完成</span>
job.join()

<span class="hljs-comment">// 取消 Job</span>
job.cancel()

<span class="hljs-comment">// 取消并等待完成</span>
job.cancelAndJoin()
</code></pre>
<h4 data-id="heading-13">8. 状态转换示例</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> job = launch {
        println(<span class="hljs-string">"1. Job started - Active"</span>)
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">2000</span>)
            println(<span class="hljs-string">"2. Normal completion - Completing → Completed"</span>)
        } <span class="hljs-keyword">finally</span> {
            println(<span class="hljs-string">"3. Finally block - Cancelling"</span>)
            delay(<span class="hljs-number">500</span>)  <span class="hljs-comment">// 在取消中仍可挂起</span>
        }
    }
    
    delay(<span class="hljs-number">500</span>)
    job.cancel()  <span class="hljs-comment">// Active → Cancelling</span>
    job.join()    <span class="hljs-comment">// 等待进入 Cancelled</span>
    println(<span class="hljs-string">"4. Final state: isCancelled=<span class="hljs-subst">${job.isCancelled}</span>"</span>)
}
</code></pre>
<h2 data-id="heading-14">四、Job重要注意事项</h2>
<h4 data-id="heading-15">1. Completed 和 Cancelled 都是完成状态**</h4>
<ul>
<li><code>isCompleted = true</code> 表示两者</li>
<li>需要用 <code>isCancelled</code> 区分</li>
</ul>
<h4 data-id="heading-16">2. 状态检查是瞬时的</h4>
<ul>
<li>状态可能在你检查后立即改变</li>
</ul>
<h4 data-id="heading-17">3.  父子关系影响状态</h4>
<ul>
<li>父 Job 取消会导致所有子 Job 取消</li>
<li>父 Job 等待所有子 Job 完成才能进入 Completed</li>
</ul>
<h4 data-id="heading-18">4.  结构化并发</h4>
<ul>
<li>父协程的作用域取消会传播到所有子协程</li>
<li>父协程会等待所有子协程完成</li>
</ul>
<h2 data-id="heading-19">五、SupervisorJob基础示例</h2>
<h4 data-id="heading-20">1. 失败不会传播</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> supervisorJob = SupervisorJob()  <span class="hljs-comment">// SupervisorJob</span>
    
    launch(supervisorJob) {
        println(<span class="hljs-string">"Child 1 starts"</span>)
        delay(<span class="hljs-number">100</span>)
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Child 1 failed!"</span>)
    }
    
    launch(supervisorJob) {
        println(<span class="hljs-string">"Child 2 starts"</span>)
        delay(<span class="hljs-number">200</span>)
        println(<span class="hljs-string">"Child 2 completed"</span>)  <span class="hljs-comment">// 这个会正常执行</span>
    }
    
    delay(<span class="hljs-number">300</span>)
    println(<span class="hljs-string">"Supervisor is alive: <span class="hljs-subst">${supervisorJob.isActive}</span>"</span>)  <span class="hljs-comment">// true</span>
    println(<span class="hljs-string">"Supervisor children active: <span class="hljs-subst">${supervisorJob.children.count { it.isActive }</span>}"</span>)
}
</code></pre>
<h4 data-id="heading-21">2. 推荐使用 <code>supervisorScope</code> 构建器</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    supervisorScope {
        <span class="hljs-keyword">val</span> child1 = launch {
            println(<span class="hljs-string">"Task 1 started"</span>)
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> ArithmeticException(<span class="hljs-string">"Task 1 calculation error!"</span>)
        }
        
        <span class="hljs-keyword">val</span> child2 = launch {
            println(<span class="hljs-string">"Task 2 started"</span>)
            delay(<span class="hljs-number">1000</span>)
            println(<span class="hljs-string">"Task 2 completed successfully"</span>)
        }
        
        <span class="hljs-keyword">val</span> child3 = launch {
            println(<span class="hljs-string">"Task 3 started"</span>)
            delay(<span class="hljs-number">1500</span>)
            println(<span class="hljs-string">"Task 3 completed successfully"</span>)
        }
        
        <span class="hljs-comment">// 处理各个子协程的结果</span>
        child1.join()  <span class="hljs-comment">// 会抛出异常</span>
        println(<span class="hljs-string">"Child1 joined, isCancelled: <span class="hljs-subst">${child1.isCancelled}</span>"</span>)
        
        child2.join()  <span class="hljs-comment">// 正常完成</span>
        println(<span class="hljs-string">"Child2 joined, isCompleted: <span class="hljs-subst">${child2.isCompleted}</span>"</span>)
        
        child3.join()  <span class="hljs-comment">// 正常完成</span>
        println(<span class="hljs-string">"All tasks processed"</span>)
    }
    
    println(<span class="hljs-string">"SupervisorScope completed"</span>)
}
</code></pre>
<h2 data-id="heading-22">六、SupervisorJob实际应用场景</h2>
<h4 data-id="heading-23">1. 并行下载多个文件</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileDownloader</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">downloadFiles</span><span class="hljs-params">(urls: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> = supervisorScope {
        <span class="hljs-keyword">val</span> downloadJobs = urls.map { url -&gt;
            async {
                <span class="hljs-keyword">try</span> {
                    println(<span class="hljs-string">"Downloading <span class="hljs-variable">$url</span>"</span>)
                    delay((<span class="hljs-number">100.</span><span class="hljs-number">.500</span>).random().toLong())  <span class="hljs-comment">// 模拟下载</span>
                    <span class="hljs-keyword">if</span> (url.contains(<span class="hljs-string">"error"</span>)) {
                        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Failed to download <span class="hljs-variable">$url</span>"</span>)
                    }
                    <span class="hljs-string">"Content of <span class="hljs-variable">$url</span>"</span>
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    println(<span class="hljs-string">"Error downloading <span class="hljs-variable">$url</span>: <span class="hljs-subst">${e.message}</span>"</span>)
                    <span class="hljs-literal">null</span>  <span class="hljs-comment">// 返回 null 表示失败</span>
                }
            }
        }
        
        <span class="hljs-comment">// 收集所有结果（包括失败的）</span>
        <span class="hljs-keyword">val</span> results = downloadJobs.map { it.await() }
        results.filterNotNull()  <span class="hljs-comment">// 返回成功下载的内容</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> downloader = FileDownloader()
    <span class="hljs-keyword">val</span> urls = listOf(
        <span class="hljs-string">"http://example.com/file1.txt"</span>,
        <span class="hljs-string">"http://example.com/file2-error.txt"</span>,  <span class="hljs-comment">// 这个会失败</span>
        <span class="hljs-string">"http://example.com/file3.txt"</span>,
        <span class="hljs-string">"http://example.com/file4-error.txt"</span>   <span class="hljs-comment">// 这个也会失败</span>
    )
    
    <span class="hljs-keyword">val</span> successfulDownloads = downloader.downloadFiles(urls)
    println(<span class="hljs-string">"Successfully downloaded <span class="hljs-subst">${successfulDownloads.size}</span> files"</span>)
}
</code></pre>
<h4 data-id="heading-24">2. 微服务健康检查</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> java.time.LocalDateTime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthChecker</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceStatus</span>(
        <span class="hljs-keyword">val</span> name: String,
        <span class="hljs-keyword">val</span> isHealthy: <span class="hljs-built_in">Boolean</span>,
        <span class="hljs-keyword">val</span> responseTime: <span class="hljs-built_in">Long</span>,
        <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>
    )
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkAllServices</span><span class="hljs-params">()</span></span> = supervisorScope {
        <span class="hljs-keyword">val</span> services = listOf(
            <span class="hljs-string">"auth-service"</span> to <span class="hljs-string">"http://auth:8080/health"</span>,
            <span class="hljs-string">"payment-service"</span> to <span class="hljs-string">"http://payment:8080/health"</span>,
            <span class="hljs-string">"notification-service"</span> to <span class="hljs-string">"http://notification:8080/health"</span>,
            <span class="hljs-string">"database"</span> to <span class="hljs-string">"http://db:5432/health"</span>
        )
        
        services.map { (name, url) -&gt;
            async {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
                    <span class="hljs-comment">// 模拟健康检查请求</span>
                    delay((<span class="hljs-number">50.</span><span class="hljs-number">.500</span>).random().toLong())
                    
                    <span class="hljs-comment">// 模拟随机失败</span>
                    <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.3</span>) {
                        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"<span class="hljs-variable">$name</span> timeout"</span>)
                    }
                    
                    <span class="hljs-keyword">val</span> responseTime = System.currentTimeMillis() - startTime
                    ServiceStatus(name, isHealthy = <span class="hljs-literal">true</span>, responseTime)
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    ServiceStatus(name, isHealthy = <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, e.message)
                }
            }
        }.map { it.await() }
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> checker = HealthChecker()
    
    repeat(<span class="hljs-number">3</span>) { checkNumber -&gt;
        println(<span class="hljs-string">"\n=== Health Check #<span class="hljs-subst">${checkNumber + <span class="hljs-number">1</span>}</span> ==="</span>)
        <span class="hljs-keyword">val</span> results = checker.checkAllServices()
        
        results.forEach { status -&gt;
            <span class="hljs-keyword">val</span> statusIcon = <span class="hljs-keyword">if</span> (status.isHealthy) <span class="hljs-string">"✅"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"❌"</span>
            println(<span class="hljs-string">"<span class="hljs-variable">$statusIcon</span> <span class="hljs-subst">${status.name}</span>: "</span> +
                   <span class="hljs-keyword">if</span> (status.isHealthy) <span class="hljs-string">"<span class="hljs-subst">${status.responseTime}</span>ms"</span> 
                   <span class="hljs-keyword">else</span> <span class="hljs-string">"ERROR: <span class="hljs-subst">${status.error}</span>"</span>)
        }
        
        <span class="hljs-keyword">val</span> healthyCount = results.count { it.isHealthy }
        println(<span class="hljs-string">"\nSummary: <span class="hljs-variable">$healthyCount</span>/<span class="hljs-subst">${results.size}</span> services healthy"</span>)
        
        delay(<span class="hljs-number">2000</span>)
    }
}
</code></pre>
<h4 data-id="heading-25">3. UI 应用中的并行任务</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDashboardViewModel</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadDashboardData</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: DashboardData = supervisorScope {
        <span class="hljs-comment">// 并行加载各种数据</span>
        <span class="hljs-keyword">val</span> userProfile = async { 
            loadUserProfile(userId) 
        }
        
        <span class="hljs-keyword">val</span> recentOrders = async { 
            loadRecentOrders(userId) 
        }
        
        <span class="hljs-keyword">val</span> notifications = async { 
            loadNotifications(userId) 
        }
        
        <span class="hljs-keyword">val</span> recommendations = async { 
            <span class="hljs-keyword">try</span> {
                loadRecommendations(userId)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 推荐失败不影响其他数据</span>
                emptyList&lt;Recommendation&gt;()
            }
        }
        
        <span class="hljs-comment">// 等待所有请求完成</span>
        DashboardData(
            profile = userProfile.await(),
            orders = recentOrders.await(),
            notifications = notifications.await(),
            recommendations = recommendations.await()
        )
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: UserProfile {
        delay(<span class="hljs-number">300</span>)
        <span class="hljs-keyword">return</span> UserProfile(<span class="hljs-string">"User <span class="hljs-variable">$userId</span>"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadRecentOrders</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;Order&gt; {
        delay(<span class="hljs-number">400</span>)
        <span class="hljs-keyword">return</span> listOf(Order(<span class="hljs-string">"Order1"</span>), Order(<span class="hljs-string">"Order2"</span>))
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadNotifications</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;Notification&gt; {
        delay(<span class="hljs-number">200</span>)
        <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.2</span>) <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Notification service down"</span>)
        <span class="hljs-keyword">return</span> listOf(Notification(<span class="hljs-string">"New message"</span>))
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadRecommendations</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;Recommendation&gt; {
        delay(<span class="hljs-number">500</span>)
        <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.3</span>) <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Recommendation engine error"</span>)
        <span class="hljs-keyword">return</span> listOf(Recommendation(<span class="hljs-string">"Item 1"</span>), Recommendation(<span class="hljs-string">"Item 2"</span>))
    }
    
    <span class="hljs-comment">// 数据类</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardData</span>(
        <span class="hljs-keyword">val</span> profile: UserProfile,
        <span class="hljs-keyword">val</span> orders: List&lt;Order&gt;,
        <span class="hljs-keyword">val</span> notifications: List&lt;Notification&gt;,
        <span class="hljs-keyword">val</span> recommendations: List&lt;Recommendation&gt;
    )
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> name: String)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(<span class="hljs-keyword">val</span> id: String)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Notification</span>(<span class="hljs-keyword">val</span> message: String)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recommendation</span>(<span class="hljs-keyword">val</span> item: String)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> viewModel = UserDashboardViewModel()
    
    repeat(<span class="hljs-number">5</span>) {
        <span class="hljs-keyword">try</span> {
            println(<span class="hljs-string">"\nLoading dashboard..."</span>)
            <span class="hljs-keyword">val</span> dashboard = viewModel.loadDashboardData(<span class="hljs-string">"user123"</span>)
            println(<span class="hljs-string">"Dashboard loaded successfully:"</span>)
            println(<span class="hljs-string">"- Profile: <span class="hljs-subst">${dashboard.profile.name}</span>"</span>)
            println(<span class="hljs-string">"- Orders: <span class="hljs-subst">${dashboard.orders.size}</span>"</span>)
            println(<span class="hljs-string">"- Notifications: <span class="hljs-subst">${dashboard.notifications.size}</span>"</span>)
            println(<span class="hljs-string">"- Recommendations: <span class="hljs-subst">${dashboard.recommendations.size}</span>"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            println(<span class="hljs-string">"Critical error loading dashboard: <span class="hljs-subst">${e.message}</span>"</span>)
        }
        delay(<span class="hljs-number">1000</span>)
    }
}
</code></pre>
<h2 data-id="heading-26">七、SupervisorJob高级用法：自定义错误处理</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResilientTaskManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> supervisorJob = SupervisorJob()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.IO + supervisorJob)
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskResult</span>(<span class="hljs-keyword">val</span> id: String, <span class="hljs-keyword">val</span> success: <span class="hljs-built_in">Boolean</span>, <span class="hljs-keyword">val</span> value: Any? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">submitTask</span><span class="hljs-params">(taskId: <span class="hljs-type">String</span>, task: <span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">Any</span>)</span></span> {
        scope.launch {
            <span class="hljs-keyword">try</span> {
                println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Starting task"</span>)
                <span class="hljs-keyword">val</span> result = task()
                println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Task completed successfully"</span>)
                onTaskCompleted(TaskResult(taskId, <span class="hljs-literal">true</span>, result))
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Task failed: <span class="hljs-subst">${e.message}</span>"</span>)
                onTaskCompleted(TaskResult(taskId, <span class="hljs-literal">false</span>, error = e.message))
                <span class="hljs-comment">// 失败的任务可以在这里重试</span>
                <span class="hljs-keyword">if</span> (shouldRetry(taskId)) {
                    delay(<span class="hljs-number">1000</span>)
                    println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Retrying..."</span>)
                    submitTask(<span class="hljs-string">"<span class="hljs-variable">$taskId</span>-retry"</span>, task)
                }
            }
        }
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shutdown</span><span class="hljs-params">(timeoutMillis: <span class="hljs-type">Long</span> = <span class="hljs-number">5000</span>)</span></span> {
        scope.cancel()
        <span class="hljs-keyword">try</span> {
            withTimeout(timeoutMillis) {
                supervisorJob.join()
            }
            println(<span class="hljs-string">"All tasks completed gracefully"</span>)
        } <span class="hljs-keyword">catch</span> (e: TimeoutCancellationException) {
            println(<span class="hljs-string">"Some tasks did not complete in time"</span>)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTaskCompleted</span><span class="hljs-params">(result: <span class="hljs-type">TaskResult</span>)</span></span> {
        <span class="hljs-comment">// 处理任务完成事件</span>
        println(<span class="hljs-string">"Task <span class="hljs-subst">${result.id}</span>: <span class="hljs-subst">${if (result.success) <span class="hljs-string">"SUCCESS"</span> else <span class="hljs-string">"FAILED"</span>}</span>"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldRetry</span><span class="hljs-params">(taskId: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> !taskId.contains(<span class="hljs-string">"no-retry"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> manager = ResilientTaskManager()
    
    <span class="hljs-comment">// 提交多个任务</span>
    manager.submitTask(<span class="hljs-string">"task-1"</span>) {
        delay(<span class="hljs-number">1000</span>)
        <span class="hljs-string">"Result 1"</span>
    }
    
    manager.submitTask(<span class="hljs-string">"task-2-error"</span>) {
        delay(<span class="hljs-number">500</span>)
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Simulated error in task 2"</span>)
    }
    
    manager.submitTask(<span class="hljs-string">"task-3-no-retry"</span>) {
        delay(<span class="hljs-number">800</span>)
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Fatal error - no retry"</span>)
    }
    
    manager.submitTask(<span class="hljs-string">"task-4"</span>) {
        delay(<span class="hljs-number">1200</span>)
        <span class="hljs-string">"Result 4"</span>
    }
    
    <span class="hljs-comment">// 等待所有任务完成</span>
    delay(<span class="hljs-number">3000</span>)
    manager.shutdown()
}
</code></pre>
<h2 data-id="heading-27">八、SupervisorJob 重要注意事项</h2>
<h4 data-id="heading-28">1. 错误处理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">supervisorScope {
    <span class="hljs-keyword">val</span> child = launch {
        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Child failed"</span>)
    }
    
    <span class="hljs-comment">// 必须显式处理子协程异常</span>
    <span class="hljs-keyword">try</span> {
        child.join()
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        println(<span class="hljs-string">"Caught child exception: <span class="hljs-subst">${e.message}</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-29">2. 与 CoroutineExceptionHandler 配合</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> handler = CoroutineExceptionHandler { _, exception -&gt;
    println(<span class="hljs-string">"Uncaught exception: <span class="hljs-subst">${exception.message}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> supervisor = SupervisorJob()
    <span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.Default + supervisor + handler)
    
    scope.launch {
        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"This will be caught by handler"</span>)
    }
    
    scope.launch {
        delay(<span class="hljs-number">1000</span>)
        println(<span class="hljs-string">"I'm still running!"</span>)
    }
    
    delay(<span class="hljs-number">2000</span>)
    supervisor.cancel()
}
</code></pre>
<h4 data-id="heading-30">3. 限制并发数</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.sync.Semaphore

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">limitedParallelTasks</span><span class="hljs-params">(tasks: <span class="hljs-type">List</span>&lt;<span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">Unit</span>&gt;, maxConcurrent: <span class="hljs-type">Int</span> = <span class="hljs-number">3</span>)</span></span> {
    <span class="hljs-keyword">val</span> semaphore = Semaphore(maxConcurrent)
    
    supervisorScope {
        tasks.map { task -&gt;
            launch {
                semaphore.withPermit {
                    task()
                }
            }
        }.forEach { it.join() }
    }
}
</code></pre>
<h2 data-id="heading-31">九、SupervisorJob总结</h2>
<p><strong>SupervisorJob 的主要使用场景：</strong></p>
<ol>
<li>需要独立执行多个任务的场景</li>
<li>一个任务的失败不应影响其他任务</li>
<li>UI 应用中并行加载多个数据源</li>
<li>批量处理任务，允许部分失败</li>
<li>微服务架构中的健康检查、监控等</li>
</ol>
<p><strong>关键点：</strong></p>
<ul>
<li>使用 <code>supervisorScope</code> 或 <code>SupervisorJob()</code> 创建</li>
<li>子协程异常需要显式处理</li>
<li>配合 <code>CoroutineExceptionHandler</code> 进行全局错误处理</li>
<li>注意资源清理和超时控制</li>
</ul>
<p>通过 SupervisorJob，你可以构建更健壮、容错性更好的并发应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 中的面向对象编程：从基础到继承]]></title>    <link>https://juejin.cn/post/7578820431018459151</link>    <guid>https://juejin.cn/post/7578820431018459151</guid>    <pubDate>2025-12-01T15:54:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578820431018459151" data-draft-id="7578700798744789026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中的面向对象编程：从基础到继承"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-01T15:54:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ouma_syu"/> <meta itemprop="url" content="https://juejin.cn/user/2728363512824729"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中的面向对象编程：从基础到继承
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2728363512824729/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ouma_syu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:54:03.000Z" title="Mon Dec 01 2025 15:54:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 中的面向对象编程：从基础到继承</h2>
<p>JavaScript（简称 JS）作为一种灵活的脚本语言，常被描述为“基于对象”（Object-based）的语言，而不是严格意义上的“面向对象”（Object-Oriented Programming，OOP）语言。这是因为 JS 的核心机制依赖于原型（prototype）系统，而非传统的类（class）继承模型。尽管如此，JS 提供了强大的工具来实现 OOP 的核心概念，如封装、继承和多态。早在 ES6 之前，开发者就通过构造函数和原型链来模拟 OOP；ES6 引入的 <code>class</code> 关键字则让代码更接近传统 OOP 的语法，但底层仍基于原型。</p>
<h3 data-id="heading-1">对象创建的基础：字面量和实例化</h3>
<p>在 JS 中，几乎一切都是对象——甚至基本数据类型（如字符串和数字）都有对应的包装类（如 <code>String</code> 和 <code>Number</code>）。最简单的对象创建方式是使用对象字面量（object literal），这是一种直接定义对象属性的语法。</p>
<p>例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> <span class="hljs-title class_">Cat</span> = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">color</span>: <span class="hljs-string">""</span>
};

<span class="hljs-keyword">var</span> cat1 = {};
cat1.<span class="hljs-property">name</span> = <span class="hljs-string">'加菲猫'</span>;
cat1.<span class="hljs-property">color</span> = <span class="hljs-string">"橘色"</span>;

<span class="hljs-keyword">var</span> cat2 = {};
cat2.<span class="hljs-property">name</span> = <span class="hljs-string">'黑猫警长'</span>;
cat2.<span class="hljs-property">color</span> = <span class="hljs-string">"黑色"</span>;
</code></pre>
<p>这里，<code>Cat</code> 作为一个模板对象，但每个实例（如 <code>cat1</code> 和 <code>cat2</code>）都需要手动赋值属性。这虽然简单，但会导致代码重复，尤其当需要创建多个相似对象时。扩展来说，在实际项目中，这种方法适合快速原型开发，但不利于大规模代码维护，因为缺乏封装和复用机制。</p>
<p>为了解决这个问题，JS 使用构造函数（Constructor）来封装实例化过程。构造函数是一个普通函数，但通过 <code>new</code> 关键字调用时，会自动创建一个空对象，并将 <code>this</code> 指向该对象。</p>
<p>示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 输出一个空对象</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-comment">// 作为构造函数调用</span>
<span class="hljs-keyword">const</span> cat1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'加菲猫'</span>, <span class="hljs-string">'橘色'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1); <span class="hljs-comment">// { name: '加菲猫', color: '橘色' }</span>

<span class="hljs-comment">// 实例间共享构造函数</span>
<span class="hljs-keyword">const</span> cat2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'黑猫警长'</span>, <span class="hljs-string">'黑色'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-property">constructor</span> === cat2.<span class="hljs-property">constructor</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cat</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>扩展解释：<code>new</code> 操作符的内部过程包括：</p>
<ol>
<li>创建一个空对象 <code>{}</code>。</li>
<li>将该对象的 <code>__proto__</code> 指向构造函数的 <code>prototype</code>。</li>
<li>将 <code>this</code> 绑定到该对象，并执行构造函数代码。</li>
<li>返回该对象（除非构造函数显式返回其他值）。</li>
</ol>
<p>如果不使用 <code>new</code>，函数中的 <code>this</code> 会指向全局对象（如浏览器中的 <code>window</code>），这可能导致意外行为。这强调了构造函数在 JS OOP 中的核心作用：它封装了对象初始化逻辑，确保每个实例都有独立的属性。</p>
<h3 data-id="heading-2">原型模式：共享属性和方法</h3>
<p>在构造函数中直接定义方法或共享属性（如 <code>type</code> 或 <code>eat</code>）会导致每个实例都复制一份相同的代码，这浪费内存。原型模式通过 <code>prototype</code> 属性解决这个问题：将不变的属性和方法放置在构造函数的原型对象上，所有实例通过原型链（prototype chain）共享它们。</p>
<p>示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">type</span> = <span class="hljs-string">'猫科动物'</span>;
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">eat</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'喜欢jerry'</span>);
};

<span class="hljs-keyword">var</span> cat1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'tom'</span>, <span class="hljs-string">'黑色'</span>);
<span class="hljs-keyword">var</span> cat2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'咖啡猫'</span>, <span class="hljs-string">'橘色'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-property">type</span>, cat2.<span class="hljs-property">type</span>); <span class="hljs-comment">// '猫科动物' '猫科动物'</span>
cat1.<span class="hljs-property">type</span> = <span class="hljs-string">'铲屎官的主人'</span>; <span class="hljs-comment">// 只影响 cat1 的自身属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-property">type</span>, cat2.<span class="hljs-property">type</span>); <span class="hljs-comment">// '铲屎官的主人' '猫科动物'</span>
</code></pre>
<p>这里，<code>type</code> 和 <code>eat</code> 被所有实例共享。如果在实例上修改（如 <code>cat1.type</code>），它会创建一个自身属性（own property），遮蔽原型上的值，但不会影响其他实例。</p>
<p>扩展来说，原型链是 JS 继承的基础：每个对象都有一个 <code>__proto__</code> 属性，指向其构造函数的 <code>prototype</code>。属性查找时，先检查自身属性，然后顺着原型链向上查找，直到 <code>Object.prototype</code> 或 <code>null</code>。这提高了效率，尤其在大型应用中（如 React 组件库），可以避免重复定义通用方法。</p>
<p>要检查属性来源：</p>
<ul>
<li><code>hasOwnProperty(prop)</code>：检查是否为自身属性。</li>
<li><code>in</code> 操作符：检查属性是否存在于自身或原型链。</li>
<li><code>for...in</code> 循环：遍历自身和原型链上的可枚举属性。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'type'</span>)); <span class="hljs-comment">// false (来自原型)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'name'</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"type"</span> <span class="hljs-keyword">in</span> cat1); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-3">ES6 Class：语法糖的便利</h3>
<p>ES6 引入 <code>class</code> 关键字，让 JS 的 OOP 代码更像 Java 或 C++，但底层仍是原型机制。</p>
<p>示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, color</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
    }

    <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"eat jerry"</span>);
    }
}

<span class="hljs-keyword">const</span> cat1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'tom'</span>, <span class="hljs-string">'black'</span>);
cat1.<span class="hljs-title function_">eat</span>(); <span class="hljs-comment">// "eat jerry"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// Cat 的 prototype</span>
</code></pre>
<p>扩展：<code>class</code> 是构造函数的语法糖。方法定义在 <code>prototype</code> 上，属性在构造函数中初始化。这简化了代码，但开发者仍需理解原型链，以避免常见错误如修改共享状态。</p>
<h3 data-id="heading-4">继承：通过构造函数绑定和原型链</h3>
<p>继承允许子类复用父类的属性和方法。JS 通过两种方式实现：</p>
<ol>
<li><strong>构造函数绑定</strong>：使用 <code>apply</code> 或 <code>call</code> 将父构造函数的 <code>this</code> 绑定到子实例。</li>
<li><strong>原型继承</strong>：将子类的 <code>prototype</code> 设置为父类的实例。</li>
</ol>
<p>示例（构造函数绑定）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = <span class="hljs-string">'动物'</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 绑定 Animal 的 this 到 Cat 实例</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">"加菲猫"</span>, <span class="hljs-string">"橘色"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat.<span class="hljs-property">species</span>); <span class="hljs-comment">// '动物'</span>
</code></pre>
<p>这继承了属性，但未继承方法。</p>
<p>完整继承示例（结合原型）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = <span class="hljs-string">'动物'</span>;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'lll'</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>(); <span class="hljs-comment">// 原型继承</span>

<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'加菲猫'</span>, <span class="hljs-string">'橘色'</span>);
cat.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 'lll'</span>
</code></pre>
<p>扩展：这种“组合继承”是最常见的模式。它避免了经典继承的缺点（如多次调用父构造函数）。在现代 JS 中，ES6 的 <code>extends</code> 和 <code>super</code> 进一步简化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = <span class="hljs-string">'动物'</span>;
    }
    <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'哪哪哪啦'</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, color</span>) {
        <span class="hljs-variable language_">super</span>(); <span class="hljs-comment">// 调用父构造函数</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
    }
}
</code></pre>
<p>这在实际开发中（如构建组件继承树）非常实用。</p>
<h3 data-id="heading-5">JS OOP 的实用价值</h3>
<p>JS 的 OOP 机制虽不同于传统语言，但其灵活性使其在前端开发中大放异彩。通过构造函数、原型和继承，我们可以创建高效、可维护的代码库。例如，在 Vue 或 React 项目中，这些概念常用于组件复用和状态管理。理解原型链还能帮助调试继承相关的问题，如属性遮蔽。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TooltipBox在Compose里]]></title>    <link>https://juejin.cn/post/7578714735307751450</link>    <guid>https://juejin.cn/post/7578714735307751450</guid>    <pubDate>2025-12-01T14:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735307751450" data-draft-id="7578719771588804618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TooltipBox在Compose里"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-01T14:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户444554365426"/> <meta itemprop="url" content="https://juejin.cn/user/1746465251931063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TooltipBox在Compose里
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1746465251931063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户444554365426
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:49:28.000Z" title="Mon Dec 01 2025 14:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>有些组件看得到，才知道有</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fdevelop%2Fui%2Fcompose%2Fcomponents%2Ftooltip%3Fhl%3Dzh-cn%26mode%3Dlight" target="_blank" title="https://developer.android.com/develop/ui/compose/components/tooltip?hl=zh-cn&amp;mode=light" ref="nofollow noopener noreferrer">官方文档指引：2025/12</a></p>
<p>来点效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a16b7d0952f4153b61e415211dd1f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDQ0NTU0MzY1NDI2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765205368&amp;x-signature=nEKOIJNANGuyXP6t3h7aKkXbCw8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>使用光标悬停在图标上</li>
<li>在移动设备上长按相应图标</li>
</ul>
<p>来点海马：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.mircles.test.ui

<span class="hljs-keyword">import</span> androidx.compose.foundation.background
<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.Box
<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.fillMaxSize
<span class="hljs-keyword">import</span> androidx.compose.material.icons.Icons
<span class="hljs-keyword">import</span> androidx.compose.material.icons.filled.Favorite
<span class="hljs-keyword">import</span> androidx.compose.material3.ExperimentalMaterial3Api
<span class="hljs-keyword">import</span> androidx.compose.material3.Icon
<span class="hljs-keyword">import</span> androidx.compose.material3.IconButton
<span class="hljs-keyword">import</span> androidx.compose.material3.PlainTooltip
<span class="hljs-keyword">import</span> androidx.compose.material3.Text
<span class="hljs-keyword">import</span> androidx.compose.material3.TooltipBox
<span class="hljs-keyword">import</span> androidx.compose.material3.TooltipDefaults
<span class="hljs-keyword">import</span> androidx.compose.material3.rememberTooltipState
<span class="hljs-keyword">import</span> androidx.compose.runtime.Composable
<span class="hljs-keyword">import</span> androidx.compose.ui.Alignment
<span class="hljs-keyword">import</span> androidx.compose.ui.Modifier
<span class="hljs-keyword">import</span> androidx.compose.ui.graphics.Color
<span class="hljs-keyword">import</span> androidx.compose.ui.tooling.preview.Preview

<span class="hljs-meta">@OptIn(ExperimentalMaterial3Api::class)</span><span class="hljs-comment">//实验性质</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TestTooltipBox</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    plainTooltipText: <span class="hljs-type">String</span> = <span class="hljs-string">"好大一个卧槽！"</span>
)</span></span> {
    TooltipBox(
        modifier = modifier,
        state = rememberTooltipState(),
        tooltip = {
            PlainTooltip {
                Text(<span class="hljs-string">"啥呀！东西！<span class="hljs-variable">$plainTooltipText</span>"</span>)
            }
        },
        positionProvider = TooltipDefaults.rememberPlainTooltipPositionProvider(),
        <span class="hljs-comment">//怎么定位显示位置的</span>
        ) {
        IconButton(onClick = {
            <span class="hljs-comment">/*??*/</span>
        }) {
            Icon(
                imageVector = Icons.Filled.Favorite,
                contentDescription = <span class="hljs-string">"这是一个按钮"</span>
            )
        }
    }
}

<span class="hljs-meta">@Preview(showBackground = true, showSystemUi = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PreviewDemo</span><span class="hljs-params">()</span></span> {

    Box(
        modifier = Modifier
            .background(Color.Gray)
            .fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        TestTooltipBox(modifier = Modifier.background(Color.Red))
    }

}
</code></pre>
<p>还有富文本提示：
RichTooltip</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-meta">@OptIn(ExperimentalMaterial3Api::class)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RichTooltipExample</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    richTooltipSubheadText: <span class="hljs-type">String</span> = <span class="hljs-string">"Rich Tooltip"</span>,
    richTooltipText: <span class="hljs-type">String</span> = <span class="hljs-string">"Rich tooltips support multiple lines of informational text."</span>
)</span></span> {
    TooltipBox(
        modifier = modifier,
        positionProvider = TooltipDefaults.rememberRichTooltipPositionProvider(),
        tooltip = {
            RichTooltip(
                title = { Text(richTooltipSubheadText) }
            ) {
                Text(richTooltipText)
            }
        },
        state = rememberTooltipState()
    ) {
        IconButton(onClick = { <span class="hljs-comment">/* Icon button's click event */</span> }) {
            Icon(
                imageVector = Icons.Filled.Info,
                contentDescription = <span class="hljs-string">"Show more information"</span>
            )
        }
    }
}

<span class="hljs-meta">@OptIn(ExperimentalMaterial3Api::class)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AdvancedRichTooltipExample</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    richTooltipSubheadText: <span class="hljs-type">String</span> = <span class="hljs-string">"Custom Rich Tooltip"</span>,
    richTooltipText: <span class="hljs-type">String</span> = <span class="hljs-string">"Rich tooltips support multiple lines of informational text."</span>,
    richTooltipActionText: <span class="hljs-type">String</span> = <span class="hljs-string">"Dismiss"</span>
)</span></span> {
    <span class="hljs-keyword">val</span> tooltipState = rememberTooltipState()
    <span class="hljs-keyword">val</span> coroutineScope = rememberCoroutineScope()<span class="hljs-comment">//为什么会自动dismiss</span>

    TooltipBox(
        modifier = modifier,
        positionProvider = TooltipDefaults.rememberRichTooltipPositionProvider(),
        tooltip = {
            RichTooltip(
                title = { Text(richTooltipSubheadText) },
                action = {
                    Row {
                        TextButton(onClick = {
                            coroutineScope.launch {
                                tooltipState.dismiss()<span class="hljs-comment">//</span>
                            }
                        }) {
                            Text(richTooltipActionText)
                        }
                    }
                },
            ) {
                Text(richTooltipText)
            }
        },
        state = tooltipState
    ) {
        IconButton(onClick = {
            coroutineScope.launch {
                tooltipState.show()
            }
        }) {
            Icon(
                imageVector = Icons.Filled.AccountBox,
                contentDescription = <span class="hljs-string">"Open camera"</span>
            )
        }
    }
}

<span class="hljs-meta">@Preview(showBackground = true, showSystemUi = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PreviewDemo</span><span class="hljs-params">()</span></span> {

    Box(
        modifier = Modifier
            .background(Color.Gray)
            .fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {

        Column {

            TestTooltipBox(modifier = Modifier.background(Color.Red))

            Spacer(modifier = Modifier.height(<span class="hljs-number">50.</span>dp))

            RichTooltipExample()

            Spacer(modifier = Modifier.height(<span class="hljs-number">50.</span>dp))

            AdvancedRichTooltipExample()

        }
    }

}
</code></pre>
<p>还有些疑问点需要看源码的.....</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一、Kotlin基础]]></title>    <link>https://juejin.cn/post/7578714735307800602</link>    <guid>https://juejin.cn/post/7578714735307800602</guid>    <pubDate>2025-12-01T15:01:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735307800602" data-draft-id="7578724773993267226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一、Kotlin基础"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-01T15:01:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一、Kotlin基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:01:58.000Z" title="Mon Dec 01 2025 15:01:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Kotlin是一种新型的静态类型编程语言。</h2>
<ul>
<li><code>富有表现力且简洁</code>：
可以使用更少的代码实现更多的功能。少编写样板代码。在使用Kotlin 的专业开发者中，有 67% 的人反映其工作效率有所提高。</li>
<li><code>更安全的代码</code>：
Kotlin 有许多语言功能，可帮助避免 nul 指针异常等常见编程错误。包含 Kotlin 代码的Android 应用发生崩溃的可能性降低了 20%。</li>
<li><code>可互操作</code>：可以在 Kotlin 代码中调用 Java 代码，或者在 Java 代码中调用 Kotin 代码。Kotlin 可完全与 Java 编程语言互操作，因此可以根据需要在项目中添加任意数量的 Kotlin 代码。</li>
<li><code>结构化并发</code>：Kotlin 协程让异步代码像阴塞代码一样易于使用。协程可大幅简化后台任务管理，例如网络调用、本地数据访问等任务的管理。</li>
</ul>
<h2 data-id="heading-1">二、基本数据类型</h2>
<h3 data-id="heading-2">一、整型</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c39310ab1ea44b9af4782fe5ec7232a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206117&amp;x-signature=vYw2%2FN3JAXsk6pWULyWU3c8E1js%3D" alt="图片.png" loading="lazy"/></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">/// psvm psvma min函数的快捷键</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

    <span class="hljs-comment">//基本数据类型的整型默认为 Int, 如果超过了Int的取值范围，则会推断为Long</span>

    <span class="hljs-keyword">var</span> a = <span class="hljs-number">100</span> <span class="hljs-comment">// 默认推断变量为Int最大值，</span>
    <span class="hljs-keyword">var</span> b: <span class="hljs-built_in">Int</span> = <span class="hljs-number">100</span> <span class="hljs-comment">// 明确类型</span>

    <span class="hljs-keyword">var</span> c = <span class="hljs-number">8000000000</span> <span class="hljs-comment">// 已超过 Int 默认为L</span>
    <span class="hljs-keyword">var</span> d: <span class="hljs-built_in">Long</span> = <span class="hljs-number">90</span>
    <span class="hljs-keyword">var</span> e = <span class="hljs-number">100L</span>

    <span class="hljs-comment">/// Byte 类型</span>
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">by</span>: <span class="hljs-built_in">Byte</span> = <span class="hljs-number">1</span>
    
}
</code></pre>
<h3 data-id="heading-3">二、Float、Double浮点类型</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d54487ecc2b470c87a4410d17b21c34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206117&amp;x-signature=udvedm6La091O%2Fmt76ytYK1lnUg%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-4">三、字符类型 Char</h3>
<p>在Kotlin中字符用Char类型表示， 字符的值需要用单引号括起来 ''</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">var</span> a = <span class="hljs-string">'a'</span>
<span class="hljs-keyword">var</span> b: <span class="hljs-built_in">Char</span> = <span class="hljs-string">'b'</span>
</code></pre>
<h3 data-id="heading-5">四、 布尔类型</h3>
<p>在Kotlin使用Boolean表示布尔类型，它只有两个值true 和false</p>
<pre><code class="hljs language-ini" lang="ini">var isSelect: <span class="hljs-attr">Boolean</span> = <span class="hljs-literal">true</span>
var <span class="hljs-attr">isMy</span> = <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-6">五、字符串</h3>
<p>在Kotlin中字符串用String类型表示，字符串不是可变的。字符串的元素——字符串的元素可以使用索引运算符访问：s[i],或者可以用for循环迭代字符串。</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">str</span> = <span class="hljs-string">"Hello"</span>
var s: <span class="hljs-attr">String</span> = <span class="hljs-string">"Heello word"</span>
var <span class="hljs-attr">c</span> = s[<span class="hljs-number">0</span>]
for (c in s){
    println(c)
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2018ac4812f5407ea099c2ff1c36f9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206117&amp;x-signature=xiP74d%2Fb9ULFqTGwh1D8B4dX84M%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147bfbf6b7334aa9b6e761dc74e1ee71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206117&amp;x-signature=beqXPRFZzFEDX7d87eOIMigcs3U%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-7">六、类型强制转换</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee15ee848f0a401e88c41b09dbe86777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765206117&amp;x-signature=rVCRPFQtbuSv77Cd6phlGF7l7%2Fc%3D" alt="图片.png" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">nu</span> = <span class="hljs-number">100</span>
var <span class="hljs-attr">str</span> = nu.toString()
var <span class="hljs-attr">toB</span> = nu.toByte()
var <span class="hljs-attr">toSh</span> = nu.toShort()
var <span class="hljs-attr">toLong</span> = nu.toLong()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Textture 生命周期]]></title>    <link>https://juejin.cn/post/7578724773993103386</link>    <guid>https://juejin.cn/post/7578724773993103386</guid>    <pubDate>2025-12-01T12:26:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578724773993103386" data-draft-id="7578724773993021466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Textture 生命周期"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-01T12:26:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曾经我也有梦想"/> <meta itemprop="url" content="https://juejin.cn/user/1625541458016403"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Textture 生命周期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1625541458016403/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曾经我也有梦想
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T12:26:07.000Z" title="Mon Dec 01 2025 12:26:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Texture (AsyncDisplayKit) 节点生命周期完全指南</h2>
<blockquote>
<p>本文详解 Texture 框架中 <code>ASDisplayNode</code> 的完整生命周期，包括线程安全陷阱和官方最佳实践。</p>
</blockquote>
<h3 data-id="heading-1">📋 生命周期流程图</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. <span class="hljs-built_in">init</span>()                       <span class="hljs-comment">// 节点创建（⚠️ 可能在后台线程）</span>
   ↓
<span class="hljs-number">2</span>. <span class="hljs-built_in">didLoad</span>()                    <span class="hljs-comment">// view/layer 已创建（✅ 主线程）</span>
   ↓
<span class="hljs-number">3</span>. <span class="hljs-built_in">layoutSpecThatFits</span>(_:)       <span class="hljs-comment">// 布局测量（⚠️ 可能在后台线程）</span>
   ↓
<span class="hljs-number">4</span>. <span class="hljs-built_in">didEnterPreloadState</span>()       <span class="hljs-comment">// 即将接近屏幕（✅ 主线程）</span>
   ↓
<span class="hljs-number">5</span>. <span class="hljs-built_in">didEnterDisplayState</span>()       <span class="hljs-comment">// 即将显示（✅ 主线程）</span>
   ↓
<span class="hljs-number">6</span>. <span class="hljs-built_in">didEnterVisibleState</span>()       <span class="hljs-comment">// 完全可见（✅ 主线程）</span>
   ↓
<span class="hljs-number">7</span>. <span class="hljs-built_in">didExitVisibleState</span>()        <span class="hljs-comment">// 离开可见区（✅ 主线程）</span>
   ↓
<span class="hljs-number">8</span>. <span class="hljs-built_in">didExitDisplayState</span>()        <span class="hljs-comment">// 离开显示区（✅ 主线程）</span>
   ↓
<span class="hljs-number">9</span>. <span class="hljs-built_in">didExitPreloadState</span>()        <span class="hljs-comment">// 离开预加载区（✅ 主线程）</span>
   ↓
<span class="hljs-number">10</span>. <span class="hljs-built_in">clearContents</span>()             <span class="hljs-comment">// 释放资源（✅ 主线程）</span>
   ↓
<span class="hljs-number">11</span>. deinit                      <span class="hljs-comment">// 节点销毁</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">1️⃣ init() - 节点初始化</h3>
<h4 data-id="heading-3">🧵 线程特性</h4>
<p><strong>⚠️ 关键：可能在主线程或后台线程执行！</strong></p>
<p>根据创建方式不同：</p>
<ul>
<li><strong>直接创建</strong>：<code>let node = MyNode()</code> → 在调用线程执行</li>
<li><strong>Block 创建</strong>：<code>ASCellNode { MyNode() }</code> → 在<strong>后台线程</strong>执行</li>
</ul>
<h4 data-id="heading-4">📖 官方文档引用</h4>
<p>来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTextureGroup%2FTexture%2Fblob%2Fmaster%2FSource%2FASDisplayNode.h%23L156" target="_blank" title="https://github.com/TextureGroup/Texture/blob/master/Source/ASDisplayNode.h#L156" ref="nofollow noopener noreferrer">ASDisplayNode.h</a>:</p>
<blockquote>
<p>"This method <strong>can be called on a background thread</strong>.<br/>
You MUST ensure that <strong>no UIKit objects are accessed</strong>."</p>
</blockquote>
<h4 data-id="heading-5">✅ 应该做的事</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
    
    <span class="hljs-comment">// ✅ 初始化子节点</span>
    <span class="hljs-keyword">let</span> avatarNode <span class="hljs-operator">=</span> <span class="hljs-type">ASNetworkImageNode</span>()
    <span class="hljs-keyword">let</span> textNode <span class="hljs-operator">=</span> <span class="hljs-type">ASTextNode</span>()
    
    <span class="hljs-comment">// ✅ 设置 Node 层级属性（线程安全）</span>
    avatarNode.cornerRadius <span class="hljs-operator">=</span> <span class="hljs-number">18</span>
    avatarNode.style.preferredSize <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">36</span>, height: <span class="hljs-number">36</span>)
    
    textNode.maximumNumberOfLines <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    textNode.truncationMode <span class="hljs-operator">=</span> .byWordWrapping
    
    <span class="hljs-comment">// ✅ 添加子节点</span>
    automaticallyManagesSubnodes <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    addSubnode(avatarNode)
    addSubnode(textNode)
}
</code></pre>
<h4 data-id="heading-6">❌ 绝对禁止的操作</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
    
    <span class="hljs-comment">// ❌ 访问 view/layer（后台线程会崩溃）</span>
    <span class="hljs-keyword">self</span>.view.backgroundColor <span class="hljs-operator">=</span> .white  <span class="hljs-comment">// 💥 Crash!</span>
    imageNode.view.layer.cornerRadius <span class="hljs-operator">=</span> <span class="hljs-number">10</span>  <span class="hljs-comment">// 💥 Crash!</span>
    
    <span class="hljs-comment">// ❌ 创建 UIKit 对象</span>
    <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"icon"</span>)  <span class="hljs-comment">// ⚠️ 可能有问题</span>
    
    <span class="hljs-comment">// ❌ 调用 UIKit API</span>
    <span class="hljs-keyword">let</span> color <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.red.cgColor  <span class="hljs-comment">// ⚠️ 不推荐</span>
}
</code></pre>
<h4 data-id="heading-7">🔧 替代方案对比</h4>






























<table><thead><tr><th>需求</th><th>❌ 错误写法 (init)</th><th>✅ 正确写法</th></tr></thead><tbody><tr><td>设置圆角</td><td><code>node.view.layer.cornerRadius = 10</code></td><td><code>node.cornerRadius = 10</code></td></tr><tr><td>设置背景色</td><td><code>node.view.backgroundColor = .red</code></td><td><code>node.backgroundColor = .red</code></td></tr><tr><td>添加手势</td><td><code>node.view.addGestureRecognizer(...)</code></td><td>在 <code>didLoad()</code> 中添加</td></tr><tr><td>设置阴影</td><td><code>node.view.layer.shadowRadius = 5</code></td><td>在 <code>didLoad()</code> 中设置</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">2️⃣ didLoad() - 视图已创建</h3>
<h4 data-id="heading-9">🧵 线程特性</h4>
<p><strong>✅ 始终在主线程执行</strong></p>
<h4 data-id="heading-10">📖 官方文档引用</h4>
<blockquote>
<p>"Called on the <strong>main thread</strong> after the node's view or layer has been created.<br/>
This is the <strong>earliest time</strong> to safely access <code>node.view</code> or <code>node.layer</code>."</p>
</blockquote>
<h4 data-id="heading-11">触发时机</h4>
<p>当 <code>node.view</code> 或 <code>node.layer</code> <strong>首次被访问</strong>时触发（懒加载），而不是创建后自动触发。</p>
<h4 data-id="heading-12">✅ 应该做的事</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>() {
    <span class="hljs-keyword">super</span>.didLoad()
    
    <span class="hljs-comment">// ✅ 访问 UIKit 视图层级</span>
    textNode.view.isUserInteractionEnabled <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    
    <span class="hljs-comment">// ✅ 添加手势</span>
    <span class="hljs-keyword">let</span> tapGesture <span class="hljs-operator">=</span> <span class="hljs-type">UITapGestureRecognizer</span>(target: <span class="hljs-keyword">self</span>, action: <span class="hljs-keyword">#selector</span>(handleTap))
    view.addGestureRecognizer(tapGesture)
    
    <span class="hljs-comment">// ✅ 设置 layer 属性</span>
    imageNode.view.layer.shadowColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.black.cgColor
    imageNode.view.layer.shadowOffset <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">0</span>, height: <span class="hljs-number">2</span>)
    imageNode.view.layer.shadowRadius <span class="hljs-operator">=</span> <span class="hljs-number">4</span>
    imageNode.view.layer.shadowOpacity <span class="hljs-operator">=</span> <span class="hljs-number">0.3</span>
    
    <span class="hljs-comment">// ✅ 设置 delegate</span>
    scrollNode.view.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
}
</code></pre>
<h4 data-id="heading-13">❌ 不应该做的事</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>() {
    <span class="hljs-keyword">super</span>.didLoad()
    
    <span class="hljs-comment">// ❌ 不要做布局计算（应该在 layoutSpecThatFits 中）</span>
    textNode.frame <span class="hljs-operator">=</span> <span class="hljs-type">CGRect</span>(x: <span class="hljs-number">10</span>, y: <span class="hljs-number">10</span>, width: <span class="hljs-number">200</span>, height: <span class="hljs-number">40</span>)
    
    <span class="hljs-comment">// ❌ 不要做数据加载（应该在 didEnterPreloadState 中）</span>
    fetchRemoteData()
}
</code></pre>
<hr/>
<h3 data-id="heading-14">3️⃣ layoutSpecThatFits(_:) - 布局测量</h3>
<h4 data-id="heading-15">🧵 线程特性</h4>
<p><strong>⚠️ 可能在主线程或后台线程执行</strong></p>
<p>根据调用场景：</p>
<ul>
<li><strong>异步测量</strong>（滚动时）→ 后台线程</li>
<li><strong>同步布局</strong>（主动调用）→ 主线程</li>
</ul>
<h4 data-id="heading-16">📖 官方文档引用</h4>
<p>来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTextureGroup%2FTexture%2Fblob%2Fmaster%2FSource%2FASDisplayNode.h" target="_blank" title="https://github.com/TextureGroup/Texture/blob/master/Source/ASDisplayNode.h" ref="nofollow noopener noreferrer">ASDisplayNode.h</a>:</p>
<blockquote>
<p>"This method is called <strong>off the main thread</strong>.<br/>
It is called on the main thread <strong>only when being used synchronously</strong>.<br/>
Node subclasses should <strong>NEVER access their view or layer properties</strong>."</p>
</blockquote>
<h4 data-id="heading-17">✅ 应该做的事</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">constrainedSize</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
    <span class="hljs-comment">// ✅ 设置 Node 的布局属性</span>
    avatarNode.style.preferredSize <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">36</span>, height: <span class="hljs-number">36</span>)
    
    <span class="hljs-comment">// ✅ 创建布局规范</span>
    <span class="hljs-keyword">let</span> textInset <span class="hljs-operator">=</span> <span class="hljs-type">ASInsetLayoutSpec</span>(
        insets: <span class="hljs-type">UIEdgeInsets</span>(top: <span class="hljs-number">6</span>, left: <span class="hljs-number">10</span>, bottom: <span class="hljs-number">6</span>, right: <span class="hljs-number">10</span>),
        child: textNode
    )
    
    <span class="hljs-keyword">let</span> hStack <span class="hljs-operator">=</span> <span class="hljs-type">ASStackLayoutSpec</span>.horizontal()
    hStack.spacing <span class="hljs-operator">=</span> <span class="hljs-number">8</span>
    hStack.alignItems <span class="hljs-operator">=</span> .start
    hStack.children <span class="hljs-operator">=</span> [avatarNode, textInset]
    
    <span class="hljs-keyword">return</span> <span class="hljs-type">ASInsetLayoutSpec</span>(
        insets: <span class="hljs-type">UIEdgeInsets</span>(top: <span class="hljs-number">8</span>, left: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">8</span>, right: <span class="hljs-number">12</span>),
        child: hStack
    )
}
</code></pre>
<h4 data-id="heading-18">❌ 绝对禁止的操作</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">constrainedSize</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
    <span class="hljs-comment">// ❌ 访问 view（后台线程会崩溃）</span>
    <span class="hljs-keyword">self</span>.view.backgroundColor <span class="hljs-operator">=</span> .white  <span class="hljs-comment">// 💥 Crash!</span>
    textNode.view.frame <span class="hljs-operator">=</span> <span class="hljs-type">CGRect</span>(<span class="hljs-operator">...</span>)  <span class="hljs-comment">// 💥 Crash!</span>
    
    <span class="hljs-comment">// ❌ 调用 UIKit API</span>
    <span class="hljs-keyword">let</span> color <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.red  <span class="hljs-comment">// ⚠️ 危险</span>
    
    <span class="hljs-comment">// ❌ 修改状态变量（可能导致线程竞争）</span>
    <span class="hljs-keyword">self</span>.isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">// ⚠️ 需要加锁</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-type">ASLayoutSpec</span>()
}
</code></pre>
<h4 data-id="heading-19">💡 关键原则</h4>
<p>layoutSpecThatFits 是<strong>纯函数风格</strong>：</p>
<ul>
<li><strong>输入</strong>：size 约束</li>
<li><strong>输出</strong>：布局描述（ASLayoutSpec）</li>
<li><strong>禁止</strong>：访问 UIKit、修改状态、产生副作用</li>
</ul>
<hr/>
<h3 data-id="heading-20">4️⃣ Interface State 系统</h3>
<p>Texture 提供了三级渐进式状态管理：</p>





























<table><thead><tr><th>状态</th><th>距离屏幕</th><th>触发时机</th><th>典型用途</th></tr></thead><tbody><tr><td><strong>Preload</strong></td><td>1-2 屏</td><td>即将进入可视区</td><td>网络请求、解码图片</td></tr><tr><td><strong>Display</strong></td><td>即将显示</td><td>准备渲染</td><td>文本光栅化、layer 内容</td></tr><tr><td><strong>Visible</strong></td><td>完全可见</td><td>出现在屏幕内</td><td>播放动画/视频</td></tr></tbody></table>
<h4 data-id="heading-21">📖 官方文档引用</h4>
<p>来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftexturegroup.org%2Fdocs%2Fintelligent-preloading.html" target="_blank" title="https://texturegroup.org/docs/intelligent-preloading.html" ref="nofollow noopener noreferrer">Intelligent Preloading</a>：</p>
<blockquote>
<p>"Texture provides <strong>granular callbacks</strong> for when content enters different stages of the pipeline.<br/>
Use <strong>Preload</strong> for network fetching, <strong>Display</strong> for rendering, and <strong>Visible</strong> for animations."</p>
</blockquote>
<h4 data-id="heading-22">完整示例</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoCardNode</span>: <span class="hljs-title class_">ASDisplayNode</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> videoNode <span class="hljs-operator">=</span> <span class="hljs-type">ASVideoNode</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> titleNode <span class="hljs-operator">=</span> <span class="hljs-type">ASTextNode</span>()
    
    <span class="hljs-comment">// Preload: 距离屏幕 1-2 屏时触发</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterPreloadState</span>() {
        <span class="hljs-keyword">super</span>.didEnterPreloadState()
        
        <span class="hljs-comment">// ✅ 开始网络请求</span>
        fetchVideoMetadata()
        
        <span class="hljs-comment">// ✅ 预加载视频</span>
        videoNode.as<span class="hljs-keyword">set</span> <span class="hljs-operator">=</span> <span class="hljs-type">AVAsset</span>(url: videoURL)
    }
    
    <span class="hljs-comment">// Display: 即将显示但还没完全可见</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterDisplayState</span>() {
        <span class="hljs-keyword">super</span>.didEnterDisplayState()
        
        <span class="hljs-comment">// ✅ 确保内容已渲染</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"内容已准备好显示"</span>)
    }
    
    <span class="hljs-comment">// Visible: 完全出现在屏幕内</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterVisibleState</span>() {
        <span class="hljs-keyword">super</span>.didEnterVisibleState()
        
        <span class="hljs-comment">// ✅ 启动动画</span>
        startPulseAnimation()
        
        <span class="hljs-comment">// ✅ 播放视频</span>
        videoNode.play()
        
        <span class="hljs-comment">// ✅ 曝光打点</span>
        <span class="hljs-type">Analytics</span>.trackImpression(itemId: videoId)
    }
    
    <span class="hljs-comment">// 退出可见状态</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExitVisibleState</span>() {
        <span class="hljs-keyword">super</span>.didExitVisibleState()
        
        <span class="hljs-comment">// ✅ 立即停止动画</span>
        stopPulseAnimation()
        
        <span class="hljs-comment">// ✅ 暂停视频</span>
        videoNode.pause()
    }
    
    <span class="hljs-comment">// 退出显示状态</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExitDisplayState</span>() {
        <span class="hljs-keyword">super</span>.didExitDisplayState()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已退出显示区域"</span>)
    }
    
    <span class="hljs-comment">// 退出预加载状态</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExitPreloadState</span>() {
        <span class="hljs-keyword">super</span>.didExitPreloadState()
        
        <span class="hljs-comment">// ✅ 取消网络请求</span>
        cancelNetworkTasks()
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-23">🗑️ clearContents() - 资源释放</h3>
<h4 data-id="heading-24">🧵 线程特性</h4>
<p><strong>✅ 主线程执行</strong></p>
<h4 data-id="heading-25">📖 官方文档引用</h4>
<p>来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftexturegroup.org%2Fdocs%2Fcontainers-overview.html" target="_blank" title="https://texturegroup.org/docs/containers-overview.html" ref="nofollow noopener noreferrer">Texture Best Practices</a>:</p>
<blockquote>
<p>"Override to <strong>clear any cached or calculated content</strong> when the node is no longer visible.<br/>
This is called automatically by the framework to manage memory."</p>
</blockquote>
<h4 data-id="heading-26">触发时机</h4>
<p>节点完全退出预加载范围后，系统<strong>自动调用</strong></p>
<h4 data-id="heading-27">✅ 应该做的事</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">clearContents</span>() {
    <span class="hljs-keyword">super</span>.clearContents()
    
    <span class="hljs-comment">// ✅ 释放大图（可重建的资源）</span>
    imageNode.image <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    
    <span class="hljs-comment">// ✅ 停止动画</span>
    lottieAnimationNode.stop()
    lottieAnimationNode.animationView <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    
    <span class="hljs-comment">// ✅ 清除缓存数据</span>
    cachedRenderData <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    
    <span class="hljs-comment">// ✅ 释放视频资源</span>
    videoNode.as<span class="hljs-keyword">set</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-28">⚠️ 注意事项</h4>
<ul>
<li><code>clearContents()</code> 会在节点完全退出预加载范围后自动调用</li>
<li><strong>不需要手动调用</strong></li>
<li>主要用于释放<strong>可重建</strong>的资源（如解码后的图片、渲染缓存）</li>
<li><strong>不要释放配置数据</strong>（如 URL、ID、样式设置等）</li>
</ul>
<hr/>
<h3 data-id="heading-29">🎯 最佳实践总结</h3>
<h4 data-id="heading-30">线程安全检查表</h4>















































<table><thead><tr><th>生命周期方法</th><th>线程</th><th>可访问 view?</th><th>可访问 UIKit?</th></tr></thead><tbody><tr><td><code>init()</code></td><td>⚠️ 后台/主</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><code>didLoad()</code></td><td>✅ 主线程</td><td>✅ 是</td><td>✅ 是</td></tr><tr><td><code>layoutSpecThatFits()</code></td><td>⚠️ 后台/主</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><code>didEnter*State()</code></td><td>✅ 主线程</td><td>✅ 是</td><td>✅ 是</td></tr><tr><td><code>didExit*State()</code></td><td>✅ 主线程</td><td>✅ 是</td><td>✅ 是</td></tr><tr><td><code>clearContents()</code></td><td>✅ 主线程</td><td>✅ 是</td><td>✅ 是</td></tr></tbody></table>
<h4 data-id="heading-31">记忆口诀</h4>
<blockquote>
<p><strong>"初建布局在后台，装载显示回主干"</strong></p>
<ul>
<li><strong>初</strong>(init) <strong>建</strong>(layoutSpec) 可能在<strong>后台线程</strong> → 禁止访问 UIKit</li>
<li><strong>装</strong>(didLoad) <strong>载显示</strong>(Interface State) 都在<strong>主线程</strong> → 可以访问 UIKit</li>
</ul>
</blockquote>
<h4 data-id="heading-32">职责分离原则</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNode</span>: <span class="hljs-title class_">ASDisplayNode</span> {
    <span class="hljs-comment">// ✅ init: 创建节点树 + 设置静态属性</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
        addSubnode(avatarNode)
        avatarNode.cornerRadius <span class="hljs-operator">=</span> <span class="hljs-number">10</span>
    }
    
    <span class="hljs-comment">// ✅ didLoad: UIKit 交互</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>() {
        <span class="hljs-keyword">super</span>.didLoad()
        view.addGestureRecognizer(<span class="hljs-operator">...</span>)
    }
    
    <span class="hljs-comment">// ✅ layoutSpec: 纯布局描述</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">size</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-type">ASStackLayoutSpec</span>(<span class="hljs-operator">...</span>)
    }
    
    <span class="hljs-comment">// ✅ Preload: 数据加载</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterPreloadState</span>() {
        <span class="hljs-keyword">super</span>.didEnterPreloadState()
        fetchData()
    }
    
    <span class="hljs-comment">// ✅ Visible: 动画/视频</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterVisibleState</span>() {
        <span class="hljs-keyword">super</span>.didEnterVisibleState()
        videoNode.play()
    }
    
    <span class="hljs-comment">// ✅ clearContents: 释放可重建资源</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">clearContents</span>() {
        <span class="hljs-keyword">super</span>.clearContents()
        imageNode.image <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-33">⚠️ 常见崩溃场景</h3>
<h4 data-id="heading-34">场景 1：在 init 中访问 view</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 当使用 ASCellNode(block:) 时会崩溃</span>
<span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
    <span class="hljs-keyword">self</span>.view.backgroundColor <span class="hljs-operator">=</span> .white  <span class="hljs-comment">// 💥 后台线程访问 UIKit</span>
}
</code></pre>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
    <span class="hljs-keyword">self</span>.backgroundColor <span class="hljs-operator">=</span> .white  <span class="hljs-comment">// ✅ 使用 Node 的属性</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>() {
    <span class="hljs-keyword">super</span>.didLoad()
    <span class="hljs-keyword">self</span>.view.layer.shadowRadius <span class="hljs-operator">=</span> <span class="hljs-number">5</span>  <span class="hljs-comment">// ✅ 在 didLoad 中访问 layer</span>
}
</code></pre>
<h4 data-id="heading-35">场景 2：在 layoutSpec 中修改 view</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 后台线程调用时会崩溃</span>
<span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">size</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
    textNode.view.numberOfLines <span class="hljs-operator">=</span> <span class="hljs-number">2</span>  <span class="hljs-comment">// 💥 访问了 UILabel</span>
    <span class="hljs-keyword">return</span> <span class="hljs-type">ASLayoutSpec</span>()
}
</code></pre>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">size</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
    textNode.maximumNumberOfLines <span class="hljs-operator">=</span> <span class="hljs-number">2</span>  <span class="hljs-comment">// ✅ 使用 Node 的属性</span>
    <span class="hljs-keyword">return</span> <span class="hljs-type">ASLayoutSpec</span>()
}
</code></pre>
<h4 data-id="heading-36">场景 3：在 layoutSpec 中调用 UIColor</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ⚠️ 后台线程可能有问题</span>
<span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">size</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
    <span class="hljs-keyword">let</span> color <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.systemBlue  <span class="hljs-comment">// 危险！</span>
    textNode.backgroundColor <span class="hljs-operator">=</span> color
    <span class="hljs-keyword">return</span> <span class="hljs-type">ASLayoutSpec</span>()
}
</code></pre>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ✅ 在 init 中设置</span>
<span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
    textNode.backgroundColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.systemBlue
}

<span class="hljs-comment">// 或在 didLoad 中设置</span>
<span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>() {
    <span class="hljs-keyword">super</span>.didLoad()
    textNode.view.backgroundColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.systemBlue
}
</code></pre>
<hr/>
<h3 data-id="heading-37">📊 完整生命周期示例</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CompleteExampleNode</span>: <span class="hljs-title class_">ASDisplayNode</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> avatarNode <span class="hljs-operator">=</span> <span class="hljs-type">ASNetworkImageNode</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> titleNode <span class="hljs-operator">=</span> <span class="hljs-type">ASTextNode</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> videoNode <span class="hljs-operator">=</span> <span class="hljs-type">ASVideoNode</span>()
    
    <span class="hljs-comment">// 1️⃣ 初始化（可能在后台线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 1. init - 可能在后台线程"</span>)
        
        <span class="hljs-comment">// 只做线程安全操作</span>
        automaticallyManagesSubnodes <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        avatarNode.cornerRadius <span class="hljs-operator">=</span> <span class="hljs-number">20</span>
        titleNode.maximumNumberOfLines <span class="hljs-operator">=</span> <span class="hljs-number">2</span>
    }
    
    <span class="hljs-comment">// 2️⃣ 视图已创建（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didLoad</span>() {
        <span class="hljs-keyword">super</span>.didLoad()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 2. didLoad - 主线程"</span>)
        
        <span class="hljs-comment">// 访问 UIKit</span>
        <span class="hljs-keyword">let</span> tapGesture <span class="hljs-operator">=</span> <span class="hljs-type">UITapGestureRecognizer</span>(target: <span class="hljs-keyword">self</span>, action: <span class="hljs-keyword">#selector</span>(handleTap))
        view.addGestureRecognizer(tapGesture)
        
        videoNode.view.layer.cornerRadius <span class="hljs-operator">=</span> <span class="hljs-number">8</span>
    }
    
    <span class="hljs-comment">// 3️⃣ 布局测量（可能在后台线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">constrainedSize</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 3. layoutSpecThatFits - 可能在后台线程"</span>)
        
        <span class="hljs-comment">// 只做布局描述</span>
        avatarNode.style.preferredSize <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">40</span>, height: <span class="hljs-number">40</span>)
        
        <span class="hljs-keyword">let</span> vStack <span class="hljs-operator">=</span> <span class="hljs-type">ASStackLayoutSpec</span>.vertical()
        vStack.spacing <span class="hljs-operator">=</span> <span class="hljs-number">8</span>
        vStack.children <span class="hljs-operator">=</span> [avatarNode, titleNode, videoNode]
        
        <span class="hljs-keyword">return</span> <span class="hljs-type">ASInsetLayoutSpec</span>(insets: <span class="hljs-type">UIEdgeInsets</span>(top: <span class="hljs-number">12</span>, left: <span class="hljs-number">16</span>, bottom: <span class="hljs-number">12</span>, right: <span class="hljs-number">16</span>), child: vStack)
    }
    
    <span class="hljs-comment">// 4️⃣ 进入预加载状态（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterPreloadState</span>() {
        <span class="hljs-keyword">super</span>.didEnterPreloadState()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 4. didEnterPreloadState - 主线程"</span>)
        
        <span class="hljs-comment">// 开始网络请求</span>
        fetchVideoData()
    }
    
    <span class="hljs-comment">// 5️⃣ 进入显示状态（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterDisplayState</span>() {
        <span class="hljs-keyword">super</span>.didEnterDisplayState()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 5. didEnterDisplayState - 主线程"</span>)
    }
    
    <span class="hljs-comment">// 6️⃣ 进入可见状态（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didEnterVisibleState</span>() {
        <span class="hljs-keyword">super</span>.didEnterVisibleState()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 6. didEnterVisibleState - 主线程"</span>)
        
        <span class="hljs-comment">// 播放视频和动画</span>
        videoNode.play()
        startAnimation()
    }
    
    <span class="hljs-comment">// 7️⃣ 退出可见状态（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExitVisibleState</span>() {
        <span class="hljs-keyword">super</span>.didExitVisibleState()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 7. didExitVisibleState - 主线程"</span>)
        
        <span class="hljs-comment">// 停止视频和动画</span>
        videoNode.pause()
        stopAnimation()
    }
    
    <span class="hljs-comment">// 8️⃣ 退出显示状态（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExitDisplayState</span>() {
        <span class="hljs-keyword">super</span>.didExitDisplayState()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 8. didExitDisplayState - 主线程"</span>)
    }
    
    <span class="hljs-comment">// 9️⃣ 退出预加载状态（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExitPreloadState</span>() {
        <span class="hljs-keyword">super</span>.didExitPreloadState()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 9. didExitPreloadState - 主线程"</span>)
        
        <span class="hljs-comment">// 取消网络请求</span>
        cancelNetworkTasks()
    }
    
    <span class="hljs-comment">// 🔟 清除内容（主线程）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">clearContents</span>() {
        <span class="hljs-keyword">super</span>.clearContents()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 10. clearContents - 主线程"</span>)
        
        <span class="hljs-comment">// 释放资源</span>
        avatarNode.image <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
        videoNode.as<span class="hljs-keyword">set</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 1️⃣1️⃣ 销毁</span>
    <span class="hljs-keyword">deinit</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 11. deinit"</span>)
    }
    
    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleTap</span>() {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"节点被点击"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchVideoData</span>() {}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">cancelNetworkTasks</span>() {}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">startAnimation</span>() {}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">stopAnimation</span>() {}
}
</code></pre>
<hr/>
<h3 data-id="heading-38">📚 官方资源</h3>
<ol>
<li><strong>源码注释</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTextureGroup%2FTexture%2Fblob%2Fmaster%2FSource%2FASDisplayNode.h" target="_blank" title="https://github.com/TextureGroup/Texture/blob/master/Source/ASDisplayNode.h" ref="nofollow noopener noreferrer">ASDisplayNode.h</a></li>
<li><strong>官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftexturegroup.org%2Fdocs%2Fcontainers-overview.html" target="_blank" title="https://texturegroup.org/docs/containers-overview.html" ref="nofollow noopener noreferrer">Node Lifecycle</a></li>
<li><strong>智能预加载</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftexturegroup.org%2Fdocs%2Fintelligent-preloading.html" target="_blank" title="https://texturegroup.org/docs/intelligent-preloading.html" ref="nofollow noopener noreferrer">Intelligent Preloading</a></li>
<li><strong>线程安全指南</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftexturegroup.org%2Fdocs%2Fthread-safety.html" target="_blank" title="https://texturegroup.org/docs/thread-safety.html" ref="nofollow noopener noreferrer">Thread Safety</a></li>
<li><strong>容器节点文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftexturegroup.org%2Fdocs%2Fcontainers-asviewcontroller.html" target="_blank" title="https://texturegroup.org/docs/containers-asviewcontroller.html" ref="nofollow noopener noreferrer">ASViewController</a></li>
</ol>
<hr/>
<h3 data-id="heading-39">🎓 进阶主题</h3>
<h4 data-id="heading-40">Interface State 的精确控制</h4>
<p>你可以通过 <code>interfaceState</code> 属性手动检查节点状态：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> interfaceState.contains(.visible) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"节点当前可见"</span>)
}

<span class="hljs-keyword">if</span> interfaceState.contains(.preload) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"节点在预加载范围内"</span>)
}
</code></pre>
<h4 data-id="heading-41">自定义预加载距离</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在容器节点（如 ASTableNode）中设置</span>
tableNode.leadingScreensForBatching <span class="hljs-operator">=</span> <span class="hljs-number">2.0</span>  <span class="hljs-comment">// 提前 2 屏开始预加载</span>
</code></pre>
<h4 data-id="heading-42">性能优化技巧</h4>
<ol>
<li>
<p><strong>合理使用 Interface State</strong></p>
<ul>
<li>Preload: 网络请求（距离远，提前加载）</li>
<li>Display: 文本渲染（即将显示）</li>
<li>Visible: 动画/视频（只在可见时播放）</li>
</ul>
</li>
<li>
<p><strong>及时释放资源</strong></p>
</li>
</ol>
<pre><code class="hljs language-swift" lang="swift">   <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didExitVisibleState</span>() {
       <span class="hljs-keyword">super</span>.didExitVisibleState()
       videoNode.pause()  <span class="hljs-comment">// 立即暂停，节省电量</span>
   }
   
   <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">clearContents</span>() {
       <span class="hljs-keyword">super</span>.clearContents()
       imageNode.image <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>  <span class="hljs-comment">// 释放内存</span>
   }
</code></pre>
<ol start="3">
<li><strong>避免在 layoutSpec 中做重计算</strong></li>
</ol>
<pre><code class="hljs language-swift" lang="swift">   <span class="hljs-comment">// ❌ 每次布局都重新计算</span>
   <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSpecThatFits</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">size</span>: <span class="hljs-type">ASSizeRange</span>) -&gt; <span class="hljs-type">ASLayoutSpec</span> {
       <span class="hljs-keyword">let</span> processedText <span class="hljs-operator">=</span> heavyTextProcessing(rawText)  <span class="hljs-comment">// 耗时操作</span>
       textNode.attributedText <span class="hljs-operator">=</span> processedText
       <span class="hljs-keyword">return</span> <span class="hljs-type">ASLayoutSpec</span>()
   }
   
   <span class="hljs-comment">// ✅ 在数据更新时计算一次</span>
   <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateData</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">newText</span>: <span class="hljs-type">String</span>) {
       <span class="hljs-keyword">let</span> processedText <span class="hljs-operator">=</span> heavyTextProcessing(newText)
       textNode.attributedText <span class="hljs-operator">=</span> processedText
       setNeedsLayout()
   }
</code></pre>
<hr/>
<h3 data-id="heading-43">💡 总结</h3>
<h4 data-id="heading-44">三条黄金法则</h4>
<ol>
<li>
<p><strong>线程安全第一</strong></p>
<ul>
<li><code>init()</code> 和 <code>layoutSpecThatFits()</code> 可能在后台线程</li>
<li>绝对不要在这两个方法中访问 UIKit</li>
</ul>
</li>
<li>
<p><strong>职责分离</strong></p>
<ul>
<li>init: 创建节点树</li>
<li>didLoad: UIKit 交互</li>
<li>layoutSpec: 纯布局描述</li>
<li>Interface State: 生命周期响应</li>
</ul>
</li>
<li>
<p><strong>性能优先</strong></p>
<ul>
<li>使用 Preload 提前加载</li>
<li>使用 clearContents 释放资源</li>
<li>及时停止动画和视频</li>
</ul>
</li>
</ol>
<h4 data-id="heading-45">调试技巧</h4>
<p>开启 Texture 的调试日志：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在 AppDelegate 中</span>
<span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
<span class="hljs-type">ASDisplayNode</span>.shouldShowRangeDebugOverlay <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">#endif</span>
</code></pre>
<p>这会在屏幕上显示每个节点的 Interface State，帮助你理解生命周期。</p>
<hr/>
<p><strong>希望这份指南能帮助你避开 Texture 的常见陷阱，写出高性能的代码！</strong> 🚀</p>
<p>如有问题欢迎评论讨论，也欢迎补充更多实战经验！</p>
<hr/>
<blockquote>
<p>作者：[你的昵称]<br/>
链接：[文章链接]<br/>
来源：稀土掘金<br/>
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微调入门尝试：沐雪角色扮演]]></title>    <link>https://juejin.cn/post/7578734725301780532</link>    <guid>https://juejin.cn/post/7578734725301780532</guid>    <pubDate>2025-12-01T11:28:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578734725301780532" data-draft-id="7578714759336804352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微调入门尝试：沐雪角色扮演"/> <meta itemprop="keywords" content="LLM,Python"/> <meta itemprop="datePublished" content="2025-12-01T11:28:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户57690530801"/> <meta itemprop="url" content="https://juejin.cn/user/3543039723449851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微调入门尝试：沐雪角色扮演
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3543039723449851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户57690530801
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T11:28:58.000Z" title="Mon Dec 01 2025 11:28:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>我们还是觉得千问大模型的回答实在是<code>AI</code>味道太重了，我们希望<code>AI</code>能够拥有自己独特的风格，所以，我们就试试微调一下。</p>
<p>在此，感谢感谢作者<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMoemu" target="_blank" title="https://github.com/Moemu" ref="nofollow noopener noreferrer">Moemu</a>的开源<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fdatasets%2FMoemuu%2FMuice-Dataset" target="_blank" title="https://www.modelscope.cn/datasets/Moemuu/Muice-Dataset" ref="nofollow noopener noreferrer">沐雪角色扮演训练集</a>，也感谢所有为沐雪数据集做出贡献的作者。</p>

<h2 data-id="heading-1">微调环境</h2>
<p>不知道为什么，手上突然多了一台<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span>张<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5090</mn></mrow><annotation encoding="application/x-tex">5090</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5090</span></span></span></span></span>的机器。于是呢，我这里就暂时用这台电脑微调一下。</p>
<p>使用的工具当然还是千问的<code>ms-swift</code>工具，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelscope%2Fms-swift" target="_blank" title="https://github.com/modelscope/ms-swift" ref="nofollow noopener noreferrer">这里是工具原链接</a>，不过他还有一个好处是，已经带有了很多必要的库，即使不用<code>ms-swift</code>，而是手动使用<code>transformers</code>创建<code>peft</code>脚本，也是完全够用的。</p>
<p>先看一下<code>ms-swift</code>的依赖：</p>































































































<table><thead><tr><th align="center"/><th align="center">Range</th><th align="center">Recommended</th><th align="center">Notes</th></tr></thead><tbody><tr><td align="center">python</td><td align="center">&gt;=3.9</td><td align="center">3.10/3.11</td><td align="center"/></tr><tr><td align="center">cuda</td><td align="center"/><td align="center">cuda12</td><td align="center">No need to install if using CPU, NPU, MPS</td></tr><tr><td align="center">torch</td><td align="center">&gt;=2.0</td><td align="center">2.8.0</td><td align="center"/></tr><tr><td align="center">transformers</td><td align="center">&gt;=4.33</td><td align="center">4.57.1</td><td align="center"/></tr><tr><td align="center">modelscope</td><td align="center">&gt;=1.23</td><td align="center"/><td align="center"/></tr><tr><td align="center">peft</td><td align="center">&gt;=0.11,&lt;0.19</td><td align="center"/><td align="center"/></tr><tr><td align="center">flash_attn</td><td align="center"/><td align="center">2.8.1/3.0.0b1</td><td align="center"/></tr><tr><td align="center">trl</td><td align="center">&gt;=0.15,&lt;0.25</td><td align="center">0.23.1</td><td align="center">RLHF</td></tr><tr><td align="center">deepspeed</td><td align="center">&gt;=0.14</td><td align="center">0.17.6</td><td align="center">Training</td></tr><tr><td align="center">vllm</td><td align="center">&gt;=0.5.1</td><td align="center">0.11.0</td><td align="center">Inference/Deployment</td></tr><tr><td align="center">sglang</td><td align="center">&gt;=0.4.6</td><td align="center">0.5.4.post2</td><td align="center">Inference/Deployment</td></tr><tr><td align="center">lmdeploy</td><td align="center">&gt;=0.5</td><td align="center">0.10.2</td><td align="center">Inference/Deployment</td></tr><tr><td align="center">evalscope</td><td align="center">&gt;=1.0</td><td align="center"/><td align="center">Evaluation</td></tr><tr><td align="center">gradio</td><td align="center"/><td align="center">5.32.1</td><td align="center">Web-UI/App</td></tr></tbody></table>
<p>其实大体上没啥问题。</p>
<p>所以，我们开始采用<code>conda</code>安装：</p>
<pre><code class="hljs language-bash" lang="bash">conda create -n swift python=3.10 -y  <span class="hljs-comment"># 或者11也可以，推荐10</span>
conda deactivate                      <span class="hljs-comment"># 防止莫名其妙装进base里</span>
conda activate swift
pip install ms-swift                  <span class="hljs-comment"># 安装大部分工具</span>
</code></pre>
<p>但是啊，<code>Python</code>的热门包更新特别快，我们这里做点修改：</p>
<pre><code class="hljs language-bash" lang="bash">pip uninstall gradio gradio_client antlr4-python3-runtime
pip install vllm==0.11.0 trl==0.23.1 gradio==5.32.1 math_verify==0.8.0 antlr4-python3-runtime==4.9.3
</code></pre>
<p>然后，还有一个大问题：<code>transformers</code>版本问题。</p>
<p>在本文编写的时候，最新的版本就是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4.57.1</mn></mrow><annotation encoding="application/x-tex">4.57.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4.57.1</span></span></span></span></span>，但是很多代码库的依赖是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4.56.2</mn></mrow><annotation encoding="application/x-tex">4.56.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4.56.2</span></span></span></span></span>，部分重要函数被替换。</p>
<p>如果你需要用脚本，你就得更换版本：</p>
<pre><code class="hljs language-bash" lang="bash">pip uninstall transformers
pip install transformers==4.56.2
</code></pre>
<p>而如果你使用代码控制，那么你又多了一种选择：猴子补丁</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> activations

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">from</span> transformers.activations <span class="hljs-keyword">import</span> PytorchGELUTanh
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-keyword">from</span> transformers.activations <span class="hljs-keyword">import</span> GELUTanh
    activations.PytorchGELUTanh = GELUTanh
    PytorchGELUTanh = GELUTanh
</code></pre>
<p>强行找到一个类似甚至完全一样的方法，然后把他像个补丁一样贴上去。</p>
<p>当然，直接把版本对齐了其实更方便。</p>
<p>最后，加一个查看日志的内容：</p>
<pre><code class="hljs language-bash" lang="bash">pip install swanlab
</code></pre>
<p>登录的方法就不在这里赘述了。</p>
<h2 data-id="heading-2">数据集</h2>
<p>再次，感谢作者<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMoemu" target="_blank" title="https://github.com/Moemu" ref="nofollow noopener noreferrer">Moemu</a>的开源<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fdatasets%2FMoemuu%2FMuice-Dataset" target="_blank" title="https://www.modelscope.cn/datasets/Moemuu/Muice-Dataset" ref="nofollow noopener noreferrer">沐雪角色扮演训练集</a>，以及所有为沐雪数据集做出贡献的作者。</p>
<h2 data-id="heading-3">脚本微调</h2>
<p>使用<code>ms-swift</code>的脚本进行微调的时候，其实非常方便：</p>
<pre><code class="hljs language-bash" lang="bash">CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 \
swift sft \
    --model /usr/local/models/Qwen/Qwen2-1.5B-Instruct \
    --dataset /usr/local/muice/train.jsonl /usr/local/muice/Customized/ruozhiba.jsonl /usr/local/muice/Customized/self_cognition.jsonl /usr/local/muice/Customized/wikihow.jsonl \
    --val_dataset /usr/local/muice/test.jsonl \
    --train_type full \
    --gradient_accumulation_steps 4 \
    --eval_steps 20 \
    --num_train_epochs 5 \
    --per_device_train_batch_size 1 \
    --per_device_eval_batch_size 1 \
    --logging_steps 5 \
    --output_dir output \
    --save_steps 50 \
    --save_total_limit 5 \
    --logging_steps 5 \
    --max_length 40960 \
    --learning_rate 1e-5 \
    --warmup_ratio 5e-2 \
    --dataloader_num_workers 4 \
    --model_author swift \
    --model_name swift-robot \
    --report_to swanlab \
    --swanlab_project swift-robot \
    --system <span class="hljs-string">"你是一个名为沐雪的可爱AI女孩子"</span>
</code></pre>
<p>这里的参数可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fswift.readthedocs.io%2Fzh-cn%2Flatest%2FInstruction%2FCommand-line-parameters.html" target="_blank" title="https://swift.readthedocs.io/zh-cn/latest/Instruction/Command-line-parameters.html" ref="nofollow noopener noreferrer">查看文档</a>进行具体配置。</p>
<p>然后，等待结果完成就好了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98e02244233942a08c81e175f3ca9877~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTc2OTA1MzA4MDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765193337&amp;x-signature=EXFaZyGXWZjcx8mZOHHH04b6Wfk%3D" alt="训练结果" loading="lazy"/></p>
<p>这里是因为较小的<code>batch_size</code>带来了巨大的震荡。而<code>batch_size</code>的则是<code>per_device_train_batch_size</code>和<code>gradient_accumulation_steps</code>的乘积。因此，适当调大<code>per_device_train_batch_size</code>和<code>gradient_accumulation_steps</code>可以解决这个问题。</p>
<p>出来的结果也就是非常可观了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c15ef610fcf4531af51dc50f7735bc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTc2OTA1MzA4MDE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765193337&amp;x-signature=O8Cyn35DG3ChpDkzd%2FXg%2F9IDsNE%3D" alt="最终问答效果" loading="lazy"/></p>
<h2 data-id="heading-4">代码微调</h2>
<p>代码微调其实就是一次手撸代码了。</p>
<h3 data-id="heading-5">我们要做什么？</h3>
<p>这一点其实非常关键。</p>
<p>首先，我们使用数据集，让大模型变成<strong>沐雪</strong>的模样，表面上看是覆盖掉他的思想钢印，让他的参数分布适应我们数据集的分布。那么本质上呢？我们更改了他的思想钢印，但是大模型本身的能力还是没变，所有的逻辑还是基于大模型本身。所以，不言而喻，我们的最终任务其实是<strong>生成任务</strong>。</p>
<h3 data-id="heading-6">定损失函数</h3>
<p>既然决定了是生成任务，损失函数就直接套公式吧。</p>
<p>首先，损失函数的核心目标就是计算预测值<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span></span></span></span></span>和真实值<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>之间的差异。</p>
<p>相信有基础的已经听说过六个内容，它们分别是：</p>
<p>从实际意义上讲的<code>system</code>、<code>user</code>和<code>assistant</code>，</p>
<p>还有从向量角度讲的<code>input_ids</code>、<code>attention_mask</code>和<code>labels</code>。</p>
<p>其中，从实际意义上讲，<code>system</code>、<code>user</code>是用户给定的输入，而<code>assistant</code>则是模型期望输出的内容。</p>
<p>而从向量角度讲，<code>input_ids</code>包含了整个文本（包括<code>system</code>、<code>user</code>和<code>assistant</code>），经过分词器<code>tokenizer</code>转为<code>embedding</code>之后，这一整段<code>input_ids</code>也就可以从意义上拆解为<code>input_tokens</code>和<code>response_tokens</code>。<code>attention_mask</code>这块则有点工程上的讲究。<code>labels</code>也就是我们所需要面对的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>。</p>
<p>所以，本质上，我们所需要做的其实就是两件事：</p>
<ol>
<li>将<code>response_tokens</code>作为<code>labels</code>给到模型</li>
<li>将<code>input_ids</code>全部给到模型，计算两者的差异</li>
</ol>
<p>然后模型就开始修改自己的参数，以满足沐雪数据集的要求。</p>
<p>等等，那<code>attention_mask</code>呢？</p>
<p>基础更牢一些的应该回忆起来了，在使用<code>GPU</code>计算的过程中，<code>PageAttention</code>会考虑将碎片化的显存归集起来，<code>FlashAttention</code>则尽可能将数据按一批计算。</p>
<p>但是数据集中的句子是千变万化的，如果用海量的、长短不一的数据放进去计算，显存碎片会激增，导致<code>CUDA kernel</code>在高压力下触发<code>AssertError</code>，停掉内核，整个服务也就崩溃中止了。</p>
<p>于是呢，句子就需要填充成一个相对来说规则一些的矩阵。而<code>attention mask</code>就是为了让矩阵中的一部分不参与运算，也就是类似图像处理中的<code>mask</code>遮罩，从而避免无需学习的内容被大模型注意到了。毕竟，我们的大模型是需要前向生成的，这也就是面试常考的<strong>因果遮罩</strong>。</p>
<p>到了这一步，后面的逻辑也就非常清晰了。</p>
<ol>
<li>使用大模型本身的分词器将文本向量化，获得<code>input_ids</code></li>
<li>按照<code>prompt</code>的长度计算<code>attention_mask</code>（需要的赋<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，否则赋<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>）</li>
<li>按照<code>prompt</code>的长度计算<code>labels</code>（<code>prompt</code>部分赋<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">-100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">100</span></span></span></span></span>，其余不动）</li>
<li>将<code>input_ids</code>和<code>attention_mask</code>传入模型。</li>
</ol>
<p>最后，使用非常常见的交叉熵计算损失函数就好了。</p>
<p>为什么是交叉熵？</p>
<p>这就说来话长了。</p>
<p>因为在信息论中，信息越短，说明信息量越大，信息价值也越高。信息量可以这么表示：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><msub><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>X</mi></mrow></msub><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi>log</mi><mo>⁡</mo><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(X) = - \sum_{x \in X} p(x) \log p(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0771em;vertical-align:-0.3271em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>表示当前信息的分布，主要用于表示多分类的场景。当分类增多的时候，信息量会逐渐增大；但是分类数量达到一定值后，信息量又会快速下降，这也是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mo>−</mo><mi>x</mi><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">y=-x\log(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>的趋势决定的。</p>
<p>而<code>KL</code>散度，则可以这么表示：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>X</mi></mrow></msub><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi>log</mi><mo>⁡</mo><mfrac><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><mi>q</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">D_{KL}(P||Q) = \sum_{x \in X} p(x) \log \frac{p(x)}{q(x)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord">∣∣</span><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p><code>KL</code>散度可以这么理解：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>之间的距离，其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>都是近似正态的分布。当<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>越相似，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(P||Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord">∣∣</span><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>越小。也就是说，我需要用当前的参数去拟合新的数据集的时候，散度值越小，拟合就越好。</p>
<p>而交叉熵则是两者的加权和，也就是我们在主流框架中都能够看到的<code>CrossEntropy</code>。</p>
<h3 data-id="heading-7">上代码</h3>
<p>既然基本都确定了，那我们也就不多说了。直接上。</p>
<p>首先，加载数据集：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data</span>(<span class="hljs-params">data_path: <span class="hljs-built_in">str</span></span>):
  results = []
  <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(data_path, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> file:
    all_lines = file.readlines()
  total_lines = <span class="hljs-built_in">len</span>(all_lines)
  <span class="hljs-keyword">for</span> i, line <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(all_lines, start=<span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Loading data: <span class="hljs-subst">{i}</span>/<span class="hljs-subst">{total_lines}</span>"</span>, end=<span class="hljs-string">"\r"</span>)
    data = json.loads(line)
    messages = data.get(<span class="hljs-string">"messages"</span>, [])
    <span class="hljs-comment"># score = data.get("score", 0.0) # GRPO用，本次SFT用不上</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &gt;= <span class="hljs-number">3</span>:
      system_prompt = messages[<span class="hljs-number">0</span>].get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
      user_prompt   = messages[<span class="hljs-number">1</span>].get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
      ai_prompt     = messages[<span class="hljs-number">2</span>].get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
      results.append({
          <span class="hljs-string">"system"</span>: system_prompt,
          <span class="hljs-string">"user"</span>: user_prompt,
          <span class="hljs-string">"ai"</span>: ai_prompt,
          <span class="hljs-comment"># "score": score, # GRPO用，本次SFT用不上</span>
      })
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nData loaded"</span>)
  <span class="hljs-keyword">return</span> results
</code></pre>
<blockquote>
<p>P.S.：在沐雪的数据集基础上，我额外做了一个步骤，就是在每一个<code>json</code>后面增加了一个<code>score</code>字段，也就是让随机数随机生成<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8.5</mn></mrow><annotation encoding="application/x-tex">8.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8.5</span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn></mrow><annotation encoding="application/x-tex">9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9.5</mn></mrow><annotation encoding="application/x-tex">9.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9.5</span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span></span></span></span></span>这五个数字，目的是为了更后面的<code>GRPO</code>。至于为什么是随机数，因为我相信原作者（叉腰），<del>这是我们的羁绊啊</del>所以就干脆随机生成比较高的分数了。</p>
</blockquote>
<p>然后就是，原数据集中存在多轮对话的情况，这里没想那么多，干脆就放弃了，只考虑单轮对话，取了前三个，分别是<code>system</code>、<code>user</code>和<code>assistant</code>。</p>
<p>于是就这么简单粗暴的开始加载：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">QwenDataSet</span>(torch.utils.data.Dataset):
  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data, tokenizer, max_len=<span class="hljs-number">4096</span></span>):
    self.data = data
    self.tokenizer = tokenizer
    self.max_len = max_len

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.data)

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):
    item = self.data[idx]
    system = item.get(<span class="hljs-string">"system"</span>, <span class="hljs-string">""</span>)
    user   = item.get(<span class="hljs-string">"user"</span>, <span class="hljs-string">""</span>)
    ai     = item.get(<span class="hljs-string">"ai"</span>, <span class="hljs-string">""</span>)
    <span class="hljs-comment"># score  = item.get("score", 0.0) # GRPO用，本次SFT用不上</span>
    <span class="hljs-comment"># 按照规矩拆分用户输入与模型输出，然后拼接</span>
    prompt = <span class="hljs-string">f"""&lt;|im_start|&gt;system\n<span class="hljs-subst">{system}</span>&lt;|im_end|&gt;\n&lt;|im_start|&gt;user\n<span class="hljs-subst">{user}</span>&lt;|im_end|&gt;\n&lt;|im_start|&gt;assistant:\n"""</span>
    response = ai
    <span class="hljs-comment"># 先用分词器转向量</span>
    prompt_ids   = self.tokenizer(prompt,   add_special_tokens=<span class="hljs-literal">False</span>)[<span class="hljs-string">"input_ids"</span>]
    response_ids = self.tokenizer(response, add_special_tokens=<span class="hljs-literal">False</span>)[<span class="hljs-string">"input_ids"</span>]
    <span class="hljs-comment"># 输入模型的需要是全部的向量</span>
    input_ids = prompt_ids + response_ids
    <span class="hljs-comment"># 做一个截断</span>
    <span class="hljs-comment"># =========================================================</span>
    <span class="hljs-comment"># 注意，这里如果加了截断，就需要注意数据集的长度</span>
    <span class="hljs-comment"># 如果存在&lt;think&gt;标签，则很有可能截断长度不足，没保留真正的输出</span>
    <span class="hljs-comment"># =========================================================</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(input_ids) &gt; self.max_len:
      input_ids = input_ids[:self.max_len]
    <span class="hljs-comment"># 因果遮罩，不需要的盖住</span>
    attention_mask = [<span class="hljs-number">1</span>] * <span class="hljs-built_in">len</span>(input_ids)
    prompt_len = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(prompt_ids), self.max_len)
    <span class="hljs-comment"># 创建填充内容</span>
    pad_id = self.tokenizer.pad_token_id <span class="hljs-keyword">if</span> self.tokenizer.pad_token_id <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> self.tokenizer.eos_token_id
    <span class="hljs-comment"># 如果长度不够，就先填充</span>
    pad_len = self.max_len - <span class="hljs-built_in">len</span>(input_ids)
    <span class="hljs-keyword">if</span> pad_len &gt; <span class="hljs-number">0</span>:
      input_ids     = input_ids + [pad_id] * pad_len
      attention_mask = attention_mask + [<span class="hljs-number">0</span>] * pad_len
    <span class="hljs-comment"># 标签就是整段文本，然后非AI生成的部分全部盖住，不参与运算</span>
    labels = input_ids.copy()
    labels[:prompt_len] = [-<span class="hljs-number">100</span>] * prompt_len
    <span class="hljs-comment"># 返回</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">"input_ids"</span>:      torch.tensor(input_ids,      dtype=torch.long),
      <span class="hljs-string">"attention_mask"</span>: torch.tensor(attention_mask, dtype=torch.long),
      <span class="hljs-string">"labels"</span>:         torch.tensor(labels,         dtype=torch.long),
      <span class="hljs-string">"score"</span>:          torch.tensor(score,          dtype=torch.<span class="hljs-built_in">float</span>),
    }
</code></pre>
<p>到这一步，就已经变成<code>torch</code>可以适配的加载器了。现在，我们把它实例化一下，然后再处理成<code>batch</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 加载数据</span>
data = load_data(DATA_PATH)
dataset = QwenDataSet(data, tokenizer, max_len=<span class="hljs-number">1024</span>)

<span class="hljs-comment"># 按照8:2划分训练／验证，你也可以直接用沐雪数据集预置的test.jsonl</span>
<span class="hljs-comment"># 我这边图方便直接把所有的jsonl合并了（欸嘿~⭐）</span>
val_size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(dataset) * <span class="hljs-number">0.2</span>)
train_size = <span class="hljs-built_in">len</span>(dataset) - val_size
train_dataset, val_dataset = torch.utils.data.random_split(dataset, [train_size, val_size])
<span class="hljs-comment"># 定义 data collator转batch</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">data_collator</span>(<span class="hljs-params">features</span>):
  batch = {
    <span class="hljs-string">"input_ids"</span>:      torch.stack([f[<span class="hljs-string">"input_ids"</span>] <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> features]),
    <span class="hljs-string">"attention_mask"</span>: torch.stack([f[<span class="hljs-string">"attention_mask"</span>] <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> features]),
    <span class="hljs-string">"labels"</span>:         torch.stack([f[<span class="hljs-string">"labels"</span>] <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> features]),
  }
  <span class="hljs-keyword">return</span> batch
</code></pre>
<p>剩下的就只有加载并启动了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 训练参数</span>
training_args = TrainingArguments(
  output_dir            = save_dir,
  per_device_train_batch_size = <span class="hljs-number">8</span>,
  per_device_eval_batch_size  = <span class="hljs-number">8</span>,
  eval_steps            = <span class="hljs-number">100</span>,
  logging_steps         = <span class="hljs-number">100</span>,
  save_steps            = <span class="hljs-number">100</span>,
  save_total_limit      = <span class="hljs-number">3</span>,
  num_train_epochs      = <span class="hljs-number">10</span>,
  learning_rate         = <span class="hljs-number">1e-5</span>,
  gradient_accumulation_steps = <span class="hljs-number">8</span>,
  weight_decay          = <span class="hljs-number">1e-2</span>,
  report_to             = <span class="hljs-string">"none"</span>,
)

<span class="hljs-comment"># Trainer 初始化</span>
trainer = Trainer(
  model         = model,          <span class="hljs-comment"># 你下载到本地的模型路径</span>
  args          = training_args,  <span class="hljs-comment"># 上述参数</span>
  train_dataset = train_dataset,  <span class="hljs-comment"># 上述数据集</span>
  eval_dataset  = val_dataset,    <span class="hljs-comment"># 上述数据集</span>
  data_collator = data_collator,  <span class="hljs-comment"># 上述数据转batch</span>
  tokenizer     = tokenizer,      <span class="hljs-comment"># 基于本地模型路径的分词器</span>
)

<span class="hljs-comment"># 开始训练</span>
trainer.train()
<span class="hljs-comment"># 保存模型 &amp; tokenizer</span>
trainer.save_model(save_dir)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Training complete. Model saved to:"</span>, save_dir)
</code></pre>
<p>完整代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> json
os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="hljs-string">"0,1,2,3,4,5"</span>
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForCausalLM, AutoTokenizer, TrainingArguments, Trainer

<span class="hljs-comment"># 路径配置</span>
<span class="hljs-comment"># 你需要针对你本地的情况修改下面4个数据：</span>
<span class="hljs-comment">## 1. 数据集路径</span>
DATA_PATH = <span class="hljs-string">"xxx"</span>
<span class="hljs-comment">## 2. 模型路径</span>
MODEL_PATH = <span class="hljs-string">"xxx"</span>
<span class="hljs-comment">## 3. 训练完之后的模型权重保存路径</span>
OUT_PATH = <span class="hljs-string">"xxx"</span>
<span class="hljs-comment">## 4. 这是你第几次训练</span>
<span class="hljs-comment">## 如果你忘了修改这个，那么下次训练就会覆盖掉之前训练的权重</span>
<span class="hljs-comment">## 如果你就是希望覆盖，那就一直保持就好</span>
VERSION = <span class="hljs-number">1</span>

<span class="hljs-comment"># 指定想冻结的模块名字／关键字</span>
<span class="hljs-comment"># ["transformer.h.0", "transformer.h.1"] 或 ["embed_tokens"]</span>
FREEZE_MODULE_KEYWORDS = []

<span class="hljs-comment"># 加载基础模型和 tokenizer</span>
tokenizer = AutoTokenizer.from_pretrained(MODEL_PATH, use_fast=<span class="hljs-literal">False</span>)
tokenizer.pad_token = tokenizer.eos_token
<span class="hljs-comment"># 我这里是多卡，所以`device_map`选`auto`或者`balanced`</span>
<span class="hljs-comment"># 另外千问大模型一定得加一个`trust_remote_code`</span>
model = AutoModelForCausalLM.from_pretrained(MODEL_PATH, trust_remote_code = <span class="hljs-literal">True</span>, torch_dtype=torch.bfloat16, device_map=<span class="hljs-string">"auto"</span>)

<span class="hljs-comment"># 处理冻结逻辑</span>
<span class="hljs-keyword">if</span> FREEZE_MODULE_KEYWORDS:
    <span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> model.named_parameters():
        <span class="hljs-comment"># 如果模块名称中包含任一关键词，就冻结</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(key <span class="hljs-keyword">in</span> name <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> FREEZE_MODULE_KEYWORDS):
            param.requires_grad = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">else</span>:
            param.requires_grad = <span class="hljs-literal">True</span>
    <span class="hljs-comment"># 打印冻结／未冻结的参数数量</span>
    total = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> model.parameters())
    trainable = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> model.parameters() <span class="hljs-keyword">if</span> p.requires_grad)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Total parameters: <span class="hljs-subst">{total:,}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Trainable parameters after freeze: <span class="hljs-subst">{trainable:,}</span> (<span class="hljs-subst">{trainable/total:<span class="hljs-number">.2</span>%}</span>)"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"No layer freezing selected — training all parameters."</span>)

<span class="hljs-comment"># 生成保存路径</span>
<span class="hljs-comment">## 保存路径带有日期，别找错啦！</span>
save_dir = <span class="hljs-string">f"<span class="hljs-subst">{OUT_PATH}</span>/<span class="hljs-subst">{datetime.today().strftime(<span class="hljs-string">'%Y%m%d'</span>)}</span>-v<span class="hljs-subst">{VERSION}</span>"</span>
<span class="hljs-comment">## 这里就已经固定住了</span>
<span class="hljs-comment">## 如果你昨天开始，今天结束，日期还是昨天开始的日期</span>
os.makedirs(save_dir, exist_ok=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 数据加载 + Dataset 定义</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data</span>(<span class="hljs-params">data_path: <span class="hljs-built_in">str</span></span>):
    results = []
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(data_path, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> file:
      all_lines = file.readlines()
    total_lines = <span class="hljs-built_in">len</span>(all_lines)
    <span class="hljs-keyword">for</span> i, line <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(all_lines, start=<span class="hljs-number">1</span>):
      <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Loading data: <span class="hljs-subst">{i}</span>/<span class="hljs-subst">{total_lines}</span>"</span>, end=<span class="hljs-string">"\r"</span>)
      data = json.loads(line)
      messages = data.get(<span class="hljs-string">"messages"</span>, [])
      score = data.get(<span class="hljs-string">"score"</span>, <span class="hljs-number">0.0</span>)
      <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) &gt;= <span class="hljs-number">3</span>:
        system_prompt = messages[<span class="hljs-number">0</span>].get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        user_prompt   = messages[<span class="hljs-number">1</span>].get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        ai_prompt     = messages[<span class="hljs-number">2</span>].get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        results.append({
            <span class="hljs-string">"system"</span>: system_prompt,
            <span class="hljs-string">"user"</span>: user_prompt,
            <span class="hljs-string">"ai"</span>: ai_prompt,
            <span class="hljs-string">"score"</span>: score,
        })
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nData loaded"</span>)
    <span class="hljs-keyword">return</span> results

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QwenDataSet</span>(torch.utils.data.Dataset):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data, tokenizer, max_len=<span class="hljs-number">4096</span></span>):
        self.data = data
        self.tokenizer = tokenizer
        self.max_len = max_len

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.data)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):
        item = self.data[idx]
        system = item[<span class="hljs-string">"system"</span>]
        user   = item[<span class="hljs-string">"user"</span>]
        ai     = item[<span class="hljs-string">"ai"</span>]
        score  = item.get(<span class="hljs-string">"score"</span>, <span class="hljs-number">0.0</span>)

        prompt = <span class="hljs-string">f"""&lt;|im_start|&gt;system\n<span class="hljs-subst">{system}</span>&lt;|im_end|&gt;\n&lt;|im_start|&gt;user\n<span class="hljs-subst">{user}</span>&lt;|im_end|&gt;\n&lt;|im_start|&gt;assistant:\n"""</span>
        response = ai

        prompt_ids   = self.tokenizer(prompt,   add_special_tokens=<span class="hljs-literal">False</span>)[<span class="hljs-string">"input_ids"</span>]
        response_ids = self.tokenizer(response, add_special_tokens=<span class="hljs-literal">False</span>)[<span class="hljs-string">"input_ids"</span>]

        input_ids = prompt_ids + response_ids
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(input_ids) &gt; self.max_len:
            input_ids = input_ids[:self.max_len]
        attention_mask = [<span class="hljs-number">1</span>] * <span class="hljs-built_in">len</span>(input_ids)
        prompt_len = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(prompt_ids), self.max_len)

        pad_id = self.tokenizer.pad_token_id <span class="hljs-keyword">if</span> self.tokenizer.pad_token_id <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> self.tokenizer.eos_token_id
        pad_len = self.max_len - <span class="hljs-built_in">len</span>(input_ids)
        <span class="hljs-keyword">if</span> pad_len &gt; <span class="hljs-number">0</span>:
            input_ids     = input_ids + [pad_id] * pad_len
            attention_mask = attention_mask + [<span class="hljs-number">0</span>] * pad_len

        labels = input_ids.copy()
        labels[:prompt_len] = [-<span class="hljs-number">100</span>] * prompt_len

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"input_ids"</span>:      torch.tensor(input_ids,      dtype=torch.long),
            <span class="hljs-string">"attention_mask"</span>: torch.tensor(attention_mask, dtype=torch.long),
            <span class="hljs-string">"labels"</span>:         torch.tensor(labels,         dtype=torch.long),
            <span class="hljs-string">"score"</span>:          torch.tensor(score,          dtype=torch.<span class="hljs-built_in">float</span>),
        }

<span class="hljs-comment"># 加载数据</span>
data = load_data(DATA_PATH)
dataset = QwenDataSet(data, tokenizer, max_len=<span class="hljs-number">1024</span>)

<span class="hljs-comment"># 划分训练／验证</span>
val_size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(dataset) * <span class="hljs-number">5e-2</span>)
train_size = <span class="hljs-built_in">len</span>(dataset) - val_size
train_dataset, val_dataset = torch.utils.data.random_split(dataset, [train_size, val_size])

<span class="hljs-comment"># 定义 data collator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">data_collator</span>(<span class="hljs-params">features</span>):
    batch = {
        <span class="hljs-string">"input_ids"</span>:      torch.stack([f[<span class="hljs-string">"input_ids"</span>] <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> features]),
        <span class="hljs-string">"attention_mask"</span>: torch.stack([f[<span class="hljs-string">"attention_mask"</span>] <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> features]),
        <span class="hljs-string">"labels"</span>:         torch.stack([f[<span class="hljs-string">"labels"</span>] <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> features]),
    }
    <span class="hljs-keyword">return</span> batch

<span class="hljs-comment"># TrainingArguments</span>
training_args = TrainingArguments(
    output_dir            = save_dir,
    per_device_train_batch_size = <span class="hljs-number">8</span>,
    per_device_eval_batch_size  = <span class="hljs-number">8</span>,
    eval_steps            = <span class="hljs-number">100</span>,
    logging_steps         = <span class="hljs-number">100</span>,
    save_steps            = <span class="hljs-number">100</span>,
    save_total_limit      = <span class="hljs-number">3</span>,
    num_train_epochs      = <span class="hljs-number">10</span>,
    learning_rate         = <span class="hljs-number">1e-5</span>,
    gradient_accumulation_steps = <span class="hljs-number">8</span>,
    weight_decay          = <span class="hljs-number">1e-2</span>,
    report_to             = <span class="hljs-string">"none"</span>,
)

<span class="hljs-comment"># Trainer 初始化</span>
trainer = Trainer(
    model         = model,
    args          = training_args,
    train_dataset = train_dataset,
    eval_dataset  = val_dataset,
    data_collator = data_collator,
    tokenizer     = tokenizer,
)

<span class="hljs-comment"># 开始训练</span>
trainer.train()
<span class="hljs-comment"># 保存模型 &amp; tokenizer</span>
trainer.save_model(save_dir)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Training complete. Model saved to:"</span>, save_dir)
</code></pre>
<h2 data-id="heading-8">注意事项</h2>
<h3 data-id="heading-9">Qwen系列大模型的究极特性</h3>
<p>Qwen系列大模型，训练的时候都没啥问题，但是最后导出的时候始终会坚持自己是阿里巴巴的千问，从来都不说自己是沐雪。</p>
<p>这是因为<code>chat-template</code>。</p>
<p>如果你直接按照系统默认的<code>chat-template</code>，那么阿里巴巴就会自己加上一个默认的<code>system</code>。在<code>Qwen2</code>的时候会是<code>You are a helpful assistant.</code>，在<code>Qwen3</code>的时候没有明确写出来，但也是有默认的<code>system</code>。</p>
<p>这个时候，如果你不确定是不是练好了，你就先观察输出的文本语气是否符合沐雪的那种设定的语气。一般的，如果没练好，大模型是有着非常浓重的“千问”味道。但由于沐雪数据集个性很鲜明，在问名字的时候就能察觉到，如果练好了是完全没有“千问”味道的。</p>
<p>如果没有千问味道，但就是不承认自己是沐雪，坚称自己是千问，那就是需要<code>system-prompt</code>了。</p>
<p>这个时候在<code>messages</code>里面加一个<code>{"role": "system", "content": "你是一个名为沐雪的可爱AI女孩子"}</code>，这个时候就完美了。</p>
<p>当然，还有一种办法，就是直接修改<code>chat-template.jinja</code>。</p>
<p><code>Qwen2</code>相对来说明显一些，<code>Qwen3</code>由于加了<code>tool_call</code>机制，整个<code>chat-template</code>的逻辑看起来复杂很多。总之，你就把你的<code>system-prompt</code>和原<code>jinja</code>交给大模型处理就好了。</p>
<h3 data-id="heading-10">batch越大越好</h3>
<p>这个其实不局限于大模型，在其他机器学习领域相关都是通用的。</p>
<p>以这个生成任务为例，沐雪的数据集中数据的分布变化是很大的。于是在利用模型的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>去拟合数据集的分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">q(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>的时候，batch越小，分布的震荡就越剧烈。</p>
<p>当学习率再稍微加大一些的时候，整个学习曲线的震荡就非常艺术了。</p>
<p>所以，如果你有条件的话，分布还是越大越好。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js助你5分钟搭建AI聊天室]]></title>    <link>https://juejin.cn/post/7578699866182320166</link>    <guid>https://juejin.cn/post/7578699866182320166</guid>    <pubDate>2025-12-01T15:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578699866182320166" data-draft-id="7578683148210454580" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js助你5分钟搭建AI聊天室"/> <meta itemprop="keywords" content="React.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-01T15:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="redRain"/> <meta itemprop="url" content="https://juejin.cn/user/2656031173250215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js助你5分钟搭建AI聊天室
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2656031173250215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    redRain
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T15:38:20.000Z" title="Mon Dec 01 2025 15:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ChatAI展示</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db7d0de7534a4cf7b5b1e0fac1e9b4e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=BgDbBjxNvPBOJ9NLMoGFAvAhfIg%3D" alt="demo.gif" loading="lazy"/></p>
<h3 data-id="heading-1">Next.js是什么</h3>
<p>    是什么不重要，重要的是它能干什么！</p>
<ul>
<li>包含前后端（这不是就全栈吗，听起来可怕，不用担心，就算是小白，只要会CV大法就行）</li>
<li>急速开发（会点开发的同学，在敲代码提示到时蛮多的，用习惯了之后开发效率起飞）</li>
</ul>
<h3 data-id="heading-2">为什么要选next.js开发AI</h3>
<p>    因为在众多 Web 框架中，Next.js 是最接近 AI “原生友好”的。</p>
<h3 data-id="heading-3">CV三部曲</h3>
<h4 data-id="heading-4">1. 安装环境</h4>
<ul>
<li>安装nodejs环境，版本去官网上去安装最新的稳定版本。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e066f7d3181462394b32691da46c555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=TM9D2XkHK6gQzW398%2BNzloajZLE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>安装nextjs脚手架，创建文件夹，<code>npx create-next-app@latest</code>，配置全部选择默认。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00ee598746384cbdb95ffb9155228699~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=k8fWy4nM6Wgu3KcPrE%2BsO506L4c%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>去DeepSeek买API或者OpenAI买API额度，下图是DeepSeek，支持下国产。创建一个API keys，记得保存key，因为只能创建的时候复制Key。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b3c92e308a942e989b4928f83bb8087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=0yq64gMUlSMnHhiGUClIHMSECeo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">2. 创建文件，复制代码</h4>
<ul>
<li>在<code>app</code>目录下创建<code>api</code>文件夹，在<code>api</code>目录下创建<code>chat</code>目录，在<code>chat</code>目录创建两个文件，<code>key.ts</code>和<code>route.ts</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/362803e3fed4403691c5c3df7f769c0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=a3vbsIzCteMhfqLAMagH5C9ZHkY%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><code>key.ts</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 替换为你在DeepSeek申请的key</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEEPSEEK_API_KEY</span> = <span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>;
</code></pre>
<ul>
<li><code>route.ts</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">import</span> { streamText,convertToModelMessages } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>
<span class="hljs-keyword">import</span> { createDeepSeek } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEEPSEEK_API_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./key"</span>
<span class="hljs-keyword">const</span> deepSeek = <span class="hljs-title function_">createDeepSeek</span>({
    <span class="hljs-attr">apiKey</span>: <span class="hljs-variable constant_">DEEPSEEK_API_KEY</span>, <span class="hljs-comment">//设置API密钥</span>
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { messages } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-comment">//这里为什么接受messages 因为我们使用前端的useChat 他会自动注入这个参数，所有可以直接读取</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">streamText</span>({
        <span class="hljs-attr">model</span>: <span class="hljs-title function_">deepSeek</span>(<span class="hljs-string">'deepseek-chat'</span>), <span class="hljs-comment">//使用deepseek-chat模型</span>
        <span class="hljs-attr">messages</span>:<span class="hljs-title function_">convertToModelMessages</span>(messages), <span class="hljs-comment">//转换为模型消息</span>
        <span class="hljs-comment">//前端传过来的额messages不符合sdk格式所以需要convertToModelMessages转换一下</span>
        <span class="hljs-comment">//转换之后的格式：</span>
        <span class="hljs-attr">system</span>: <span class="hljs-string">'新手小白'</span>, <span class="hljs-comment">//系统提示词</span>
    });
   
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toUIMessageStreamResponse</span>() <span class="hljs-comment">//返回流式响应</span>
}
</code></pre>
<ul>
<li><code>page.tsx</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">'use client'</span>;
<span class="hljs-keyword">import</span> { useState, useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/button'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Textarea</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/textarea'</span>;
<span class="hljs-keyword">import</span> { useChat } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">//输入框的值</span>
    <span class="hljs-keyword">const</span> messagesEndRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">//获取消息结束的ref</span>
    <span class="hljs-comment">//useChat 内部封装了流式响应 默认会向/api/chat 发送请求</span>
    <span class="hljs-keyword">const</span> { messages, sendMessage } = <span class="hljs-title function_">useChat</span>({
        <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setInput</span>(<span class="hljs-string">''</span>);
        }
    });
    <span class="hljs-comment">// 自动滚动到底部</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        messagesEndRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });
    }, [messages]);
    <span class="hljs-comment">//回车发送消息</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeyDown</span> = (<span class="hljs-params">e: React.KeyboardEvent&lt;HTMLTextAreaElement&gt;</span>) =&gt; {
        <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span> &amp;&amp; !e.<span class="hljs-property">shiftKey</span>) {
            e.<span class="hljs-title function_">preventDefault</span>();
            <span class="hljs-keyword">if</span> (input.<span class="hljs-title function_">trim</span>()) {
                <span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">text</span>: input });
            }
        }
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex flex-col h-screen bg-linear-to-br from-blue-50 via-white to-purple-50'</span>&gt;</span>
            {/* 头部标题 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'bg-white/80 backdrop-blur-sm shadow-sm border-b border-gray-200'</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'max-w-4xl mx-auto px-6 py-4'</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-2xl font-bold bg-linear-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent'</span>&gt;</span>
                        AI 智能助手
                    <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-sm text-gray-500 mt-1'</span>&gt;</span>随时为您解答问题<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            {/* 消息区域 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex-1 overflow-y-auto px-4 py-6'</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'max-w-4xl mx-auto space-y-4'</span>&gt;</span>
                    {messages.length === 0 ? (
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex flex-col items-center justify-center h-full text-center py-20'</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'bg-linear-to-br from-blue-100 to-purple-100 rounded-full p-6 mb-4'</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'w-12 h-12 text-blue-600'</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">'none'</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">'currentColor'</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">'0 0 24 24'</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z'</span> /&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-xl font-semibold text-gray-700 mb-2'</span>&gt;</span>开始对话<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-gray-500'</span>&gt;</span>输入您的问题，我会尽力帮助您<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    ) : (
                        messages.map((message) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                                <span class="hljs-attr">key</span>=<span class="hljs-string">{message.id}</span>
                                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> ${<span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> ? '<span class="hljs-attr">justify-end</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">justify-start</span>'} <span class="hljs-attr">animate-in</span> <span class="hljs-attr">fade-in</span> <span class="hljs-attr">slide-in-from-bottom-4</span> <span class="hljs-attr">duration-500</span>`}
                            &gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> <span class="hljs-attr">gap-3</span> <span class="hljs-attr">max-w-</span>[<span class="hljs-attr">80</span>%] ${<span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> ? '<span class="hljs-attr">flex-row-reverse</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">flex-row</span>'}`}&gt;</span>
                                    {/* 头像 */}
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">shrink-0</span> <span class="hljs-attr">w-8</span> <span class="hljs-attr">h-8</span> <span class="hljs-attr">rounded-full</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">justify-center</span> <span class="hljs-attr">text-white</span> <span class="hljs-attr">font-semibold</span> ${
                                        <span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> 
                                            ? '<span class="hljs-attr">bg-linear-to-br</span> <span class="hljs-attr">from-blue-500</span> <span class="hljs-attr">to-blue-600</span>' 
                                            <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-linear-to-br</span> <span class="hljs-attr">from-purple-500</span> <span class="hljs-attr">to-purple-600</span>'
                                    }`}&gt;</span>
                                        {message.role === 'user' ? '你' : 'AI'}
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                    
                                    {/* 消息内容 */}
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> <span class="hljs-attr">flex-col</span> ${<span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> ? '<span class="hljs-attr">items-end</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">items-start</span>'}`}&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">rounded-2xl</span> <span class="hljs-attr">px-4</span> <span class="hljs-attr">py-3</span> <span class="hljs-attr">shadow-sm</span> ${
                                            <span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span>
                                                ? '<span class="hljs-attr">bg-linear-to-br</span> <span class="hljs-attr">from-blue-500</span> <span class="hljs-attr">to-blue-600</span> <span class="hljs-attr">text-white</span>'
                                                <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-white</span> <span class="hljs-attr">border</span> <span class="hljs-attr">border-gray-200</span> <span class="hljs-attr">text-gray-800</span>'
                                        }`}&gt;</span>
                                            {message.parts.map((part, index) =&gt; {
                                                switch (part.type) {
                                                    case 'text':
                                                        return (
                                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{message.id</span> + <span class="hljs-attr">index</span>} <span class="hljs-attr">className</span>=<span class="hljs-string">'whitespace-pre-wrap wrap-break-word'</span>&gt;</span>
                                                                {part.text}
                                                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                                        );
                                                }
                                            })}
                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        ))
                    )}
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{messagesEndRef}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            {/* 输入区域 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'bg-white/80 backdrop-blur-sm border-t border-gray-200 shadow-lg'</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'max-w-4xl mx-auto px-4 py-4'</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex gap-3 items-end'</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex-1 relative'</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">Textarea</span>
                                <span class="hljs-attr">value</span>=<span class="hljs-string">{input}</span>
                                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e:any)</span> =&gt;</span> setInput(e.target.value)}
                                onKeyDown={handleKeyDown}
                                placeholder='请输入你的问题... (按 Enter 发送，Shift + Enter 换行)'
                                className='min-h-[60px] max-h-[200px] resize-none rounded-xl border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all shadow-sm'
                            /&gt;
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
                            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
                                if (input.trim()) {
                                    sendMessage({ text: input });
                                }
                            }}
                            disabled={!input.trim()}
                            className='h-[60px] px-6 rounded-xl bg-linear-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed'
                        &gt;
                            <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'w-5 h-5'</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">'none'</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">'currentColor'</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">'0 0 24 24'</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M12 19l9 2-9-18-9 18 9-2zm0 0v-8'</span> /&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<ul>
<li>安装UI组件库，会生成components.json文件 和 components文件夹
<ul>
<li><code>npx shadcn@latest</code></li>
<li><code>npx shadcn@latest add button</code></li>
<li><code>npx shadcn@latest add textarea</code></li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b410f586aab47bf92ac862c3377b10e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=h5ebpurkOOI%2FQ0kEsZbGkc%2BOxq8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">3. 运行项目</h4>
<p>    在当前项目运行<code>npm run dev</code>，然后用浏览器开打<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2F" target="_blank" title="http://localhost:3000/" ref="nofollow noopener noreferrer">http://localhost:3000/</a> ，就可以正常测试了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/919d6adaf31344488be5e9bfafbed64d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=JoGA9PULZ50cuHq6abJUMw3EJmY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">总结</h3>
<p>    此Demo可以快速嵌套很多小型项目，譬如公司AI智能聊天软件等，其本质是调用大模型厂商提供的模型，对于要求性价比高且无保密性要求的个人和公司很实用。如果你想做出更酷炫的产品，可以进一步了解<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.frontendx.cn%2F" target="_blank" title="https://nextjs.frontendx.cn/" ref="nofollow noopener noreferrer">nextjs</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92fe3fbfa1904aba944a4adf3b3d2298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVkUmFpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765208300&amp;x-signature=FD%2F6wRQP0lW%2FBvTREVnUhUPfQ28%3D" alt="4b3492c25ce046f6a73e8d92a07e517a.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【技术实战】Linux 服务器网络流量统一配置（TUN模式）：解决 Docker/开发环境连接难题]]></title>    <link>https://juejin.cn/post/7578705123208855595</link>    <guid>https://juejin.cn/post/7578705123208855595</guid>    <pubDate>2025-12-01T14:01:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578705123208855595" data-draft-id="7578700798744477730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【技术实战】Linux 服务器网络流量统一配置（TUN模式）：解决 Docker/开发环境连接难题"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-01T14:01:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="津渡741"/> <meta itemprop="url" content="https://juejin.cn/user/811890236732839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【技术实战】Linux 服务器网络流量统一配置（TUN模式）：解决 Docker/开发环境连接难题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/811890236732839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    津渡741
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:01:59.000Z" title="Mon Dec 01 2025 14:01:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言：为什么要在服务器上搞这个？</h3>
<p>你是否遇到过这些技术痛点：</p>
<ul>
<li><strong>Docker 镜像拉取困难：</strong> <code>docker pull</code> 过程卡顿或失败，更换国内镜像源效果不佳。</li>
<li><strong>海外技术服务调用受阻：</strong> 在服务器用远程开发环境（如 VS Code / Cursor）时，智能代码辅助功能（如 Copilot）连接不稳定；Python 调用某些海外技术服务 API 超时。</li>
<li><strong>环境配置冗余：</strong> 需为每个软件（如 Git, Wget, Apt）单独配置代理，工作量大，且部分工具不支持标准的 SOCKS5 协议。</li>
</ul>
<blockquote>
<p><strong>终极解决方案：</strong> 在服务器上部署 Mihomo (Meta) 核心并开启 <strong>TUN 模式（透明流量接管）</strong>。它能接管服务器网卡的所有流量，让所有软件（包括 Docker 和系统更新）<strong>自动使用统一的网络配置</strong>，无需对每个应用进行额外设置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">第一步：环境准备</h3>
<ol>
<li>一台国内 Linux 服务器（Ubuntu/Debian/CentOS）。</li>
<li>一份符合要求的网络配置订阅（需获取到具体的节点信息，以兼容 Mihomo 核心）。</li>
<li>一颗耐心（这很重要）。</li>
</ol>
<h3 data-id="heading-2">第二步：安装 Docker（国内特供版）</h3>
<p>官方脚本在国内部分网络环境下可能连接受阻，建议直接使用国内镜像安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 下载安装脚本</span>
curl -fsSL [https://get.docker.com](https://get.docker.com) -o install-docker.sh

<span class="hljs-comment"># 2. 使用阿里云镜像运行</span>
sudo sh install-docker.sh --mirror Aliyun

<span class="hljs-comment"># 3. 启动并设置自启</span>
sudo systemctl <span class="hljs-built_in">enable</span> --now docker
</code></pre>
<h3 data-id="heading-3">第三步：部署 Mihomo (Meta 核心)</h3>
<h4 data-id="heading-4">1. 创建目录</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/mihomo
<span class="hljs-built_in">cd</span> ~/mihomo
</code></pre>
<h4 data-id="heading-5">2. 编写 <code>docker-compose.yml</code></h4>
<p>直接复制以下内容。注意 <code>network_mode: "host"</code> 和 <code>privileged: true</code> 是开启 TUN 模式接管流量必须的配置。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mihomo:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">metacubex/mihomo:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mihomo</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">network_mode:</span> <span class="hljs-string">"host"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config.yaml:/root/.config/mihomo/config.yaml</span>
    <span class="hljs-attr">cap_add:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">NET_ADMIN</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SYS_MODULE</span>
    <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span>
</code></pre>
<h4 data-id="heading-6">3. 编写 <code>config.yaml</code> (核心配置)</h4>
<blockquote>
<p><strong>⚠️ 注意：</strong> 这是最容易出错的地方！在粘贴节点配置前，建议先用纯文本编辑器处理节点名称中的特殊字符（如 Emoji），防止乱码导致解析失败。<strong>必须</strong>将服务器 SSH 端口（默认为 22）设置为直连规则，否则服务启动后可能导致 SSH 断连。</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">mixed-port:</span> <span class="hljs-number">7890</span>
<span class="hljs-attr">allow-lan:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">bind-address:</span> <span class="hljs-string">'*'</span>
<span class="hljs-attr">mode:</span> <span class="hljs-string">rule</span>
<span class="hljs-attr">log-level:</span> <span class="hljs-string">info</span>
<span class="hljs-attr">ipv6:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">tun:</span>
  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">stack:</span> <span class="hljs-string">mixed</span>             <span class="hljs-comment"># 强烈建议使用 mixed，兼容性比 system 好</span>
  <span class="hljs-attr">auto-route:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">auto-detect-interface:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">dns-hijack:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">any:53</span>
<span class="hljs-attr">external-controller:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:9090</span>
<span class="hljs-attr">secret:</span> <span class="hljs-string">"123456"</span>           <span class="hljs-comment"># 设置你的管理面板密码</span>
<span class="hljs-attr">external-ui: uiexternal-ui-url:</span> [<span class="hljs-string">https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip</span>]<span class="hljs-string">(https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip)</span>
<span class="hljs-attr">dns:</span>
  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">listen:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:1053</span>
  <span class="hljs-attr">enhanced-mode:</span> <span class="hljs-string">fake-ip</span>   <span class="hljs-comment"># 推荐 fake-ip，最不容易出死循环</span>
  <span class="hljs-attr">fake-ip-range:</span> <span class="hljs-number">198.18</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">/16</span>
  <span class="hljs-attr">default-nameserver:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">223.5</span><span class="hljs-number">.5</span><span class="hljs-number">.5</span>
  <span class="hljs-attr">nameserver:</span>
    <span class="hljs-bullet">-</span> [<span class="hljs-string">https://dns.alidns.com/dns-query</span>]<span class="hljs-string">(https://dns.alidns.com/dns-query)</span>
    <span class="hljs-bullet">-</span> [<span class="hljs-string">https://doh.pub/dns-query</span>]<span class="hljs-string">(https://doh.pub/dns-query)</span>
<span class="hljs-attr">proxies:</span>
  <span class="hljs-comment"># 在这里填入你的节点配置 (如 V2/Shadow/Hyste 等)</span>
  <span class="hljs-comment"># ...</span>
<span class="hljs-attr">proxy-groups:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GlobalSelect</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">select</span>
    <span class="hljs-attr">proxies:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">你的节点名字</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DIRECT</span>
<span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">DST-PORT,22,DIRECT</span>     <span class="hljs-comment"># 【救命规则】必须放在第一行！防止SSH断连</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GEOSITE,cn,DIRECT</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GEOIP,CN,DIRECT</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">MATCH,GlobalSelect</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">踩坑记录 &amp; 解决方案（本文精华）</h3>
<p>我们在部署过程中遇到了无数个坑，以下是血泪总结：</p>
<h3 data-id="heading-8">☠️ 坑零：启动即失联（最致命）</h3>
<p><strong>现象</strong>：</p>
<ul>
<li>刚运行 <code>docker compose up -d</code>，SSH 终端立刻卡死，服务器直接失联。</li>
<li>重启服务器后能连上，但只要一启动容器就又断了。</li>
</ul>
<p><strong>原因</strong>：</p>
<ul>
<li>开启 TUN 模式（透明代理）后，Mihomo 会接管网卡的所有流量，<strong>包括你当前连接服务器的 SSH 流量（端口 22）</strong>。</li>
<li>如果 Mihomo 把 SSH 流量也尝试转发给代理节点，或者在路由过程中处理不当，你的连接通道会被瞬间切断。</li>
</ul>
<p><strong>解决（救命稻草）</strong>：
在 <code>config.yaml</code> 的 <code>rules</code> 部分，<strong>第一行</strong>必须强制放行 SSH 端口：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">rules:</span>
  <span class="hljs-comment"># ⚠️ 必须放在第一行！告诉 Mihomo：SSH 流量别动，直接放行！</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">DST-PORT,22,DIRECT</span>
  
  <span class="hljs-comment"># ... 其他规则 ...</span>
</code></pre>
<p><strong>保命技巧</strong>：
在调试阶段，建议养成使用“后悔药”命令的习惯。在启动容器前执行 <code>sudo shutdown -r +10</code>（10分钟后自动重启）。万一失联了，等 10 分钟服务器重启，你就能重新连进去删掉容器修配置了。</p>
<h4 data-id="heading-9">🕳️ 坑一：Docker 镜像拉不下来</h4>
<ul>
<li><strong>现象：</strong> 配置好了 Docker，但 <code>docker compose up</code> 时一直卡在 Pulling，最后报错 <code>context deadline exceeded</code>。国内 Docker 镜像源在拉取海外镜像时目前极其不稳定。</li>
<li><strong>解决：</strong>
<ol>
<li>利用外部 SOCKS5 代理（比如本地电脑或其他机器）给 Docker 守护进程注入代理。</li>
<li>创建配置目录：<code>sudo mkdir -p /etc/systemd/system/docker.service.d</code></li>
<li>写入代理：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 把 IP:PORT 换成你可用的 SOCKS5 代理</span>
sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/docker.service.d/http-proxy.conf &lt;&lt;<span class="hljs-string">EOF
[Service]
Environment="HTTP_PROXY=socks5://ip:port"
Environment="HTTPS_PROXY=socks5://ip:port"
EOF</span>
</code></pre>
</li>
<li>重启 Docker：<code>sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker</code></li>
</ol>
<blockquote>
<p><strong>⚠️ 注意：</strong> 镜像拉取成功后，务必删除这个文件并重启 Docker，否则后续 Mihomo 运行时会因为网络配置冲突而出现问题。</p>
</blockquote>
</li>
</ul>
<h4 data-id="heading-10">🕳️ 坑二：配置文件格式错误（无限重启）</h4>
<ul>
<li><strong>现象：</strong> <code>docker ps</code> 显示容器状态一直是 <code>Restarting</code>。</li>
<li><strong>原因：</strong> 直接在终端粘贴配置文件时，可能粘贴了非 YAML 内容；配置文件里包含特殊字符（如 Emoji），在某些 SSH 客户端下乱码，导致 YAML 解析失败。</li>
<li><strong>解决：</strong> 使用 <code>head -n 5 config.yaml</code> 检查文件头部；尽量使用不带特殊字符的纯净配置。</li>
</ul>
<h4 data-id="heading-11">🕳️ 坑三：Ping 得通，Curl 不通（地狱级难题）</h4>
<ul>
<li><strong>现象：</strong> 容器启动了，<code>ping google.com</code> 能通；但 <code>curl -v https://www.google.com</code> 卡在 <code>Trying...</code> 不动，最后超时。</li>
<li><strong>原因：</strong> 这是 Linux 内核的 RP_Filter (反向路径过滤) 或协议栈冲突导致的，内核丢弃了 TUN 网卡返回的 TCP 握手包。</li>
<li><strong>解决（三板斧）：</strong>
<ol>
<li>开启 IP 转发：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"net.ipv4.ip_forward=1"</span> | sudo <span class="hljs-built_in">tee</span> -a /etc/sysctl.conf
sudo sysctl -p
</code></pre>
</li>
<li>切换 Mihomo 协议栈（最有效）：在 <code>config.yaml</code> 中，将 <code>stack: system</code> 改为 <code>stack: mixed</code>。如果 <code>mixed</code> 还不行，改为 <code>stack: gvisor</code>（Google 的用户态栈，兼容性最强）。</li>
<li>重启容器：<code>docker compose restart</code>。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-12">🕳️ 坑四：Web 面板打不开</h4>
<ul>
<li><strong>现象：</strong> 容器绿了，但浏览器访问 <code>http://ip:9090/ui</code> 超时。</li>
<li><strong>原因：</strong> 云服务器的安全组（防火墙）没有开放端口。</li>
<li><strong>解决：</strong> 去云厂商控制台，在安全组入站规则里放行 TCP 9090。</li>
</ul>
<hr/>
<h3 data-id="heading-13">最终验证</h3>

























<table><thead><tr><th align="left">验证项</th><th align="left">命令</th><th align="left">预期结果</th></tr></thead><tbody><tr><td align="left"><strong>验证直连</strong></td><td align="left"><code>curl -I https://www.baidu.com</code></td><td align="left">秒回 <code>200 OK</code></td></tr><tr><td align="left"><strong>验证配置</strong></td><td align="left"><code>curl -I https://www.google.com</code></td><td align="left">秒回 <code>200 OK</code></td></tr><tr><td align="left"><strong>面板管理</strong></td><td align="left">访问 <code>http://ip:9090/ui</code></td><td align="left">成功打开面板，测速并选择可用的网络节点。</td></tr></tbody></table>
<p>至此，你的服务器已经拥有了<strong>统一的网络流量管理能力</strong>，Docker 拉取、海外技术服务调用、系统更新将畅通无阻！</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6. 继承与面向对象设计]]></title>    <link>https://juejin.cn/post/7578519990284156954</link>    <guid>https://juejin.cn/post/7578519990284156954</guid>    <pubDate>2025-12-01T11:38:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578519990284156954" data-draft-id="7578138892126421038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6. 继承与面向对象设计"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-01T11:38:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿本员"/> <meta itemprop="url" content="https://juejin.cn/user/3868510676597259"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6. 继承与面向对象设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3868510676597259/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿本员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T11:38:37.000Z" title="Mon Dec 01 2025 11:38:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>C++的OOP有可能是单一继承或多重继承，每一个继承连接(link)可以是 public,protected 或 private,也可以是 virtual 或non-virtual。成员函数的各个选项:virtual?non-virtual?pure virtual?以及成员函数和其他语言特性的交互影响:缺省参数值与virtual函数有什么交互影响?继承如何影响的名称查找规则?设计选项有哪些?如果class的行为需要修改，virtual函数是最佳选择吗?</p>
</blockquote>
<h2 data-id="heading-0">32. 确定你的public继承塑模出is-a关系</h2>
<ol>
<li>Derived是Base，所以能用Base的地方，就能使用Derived替换，无论是对象、指针还是引用</li>
<li>世界上并不存在适用于所有软件的“完美设计”，最佳设计取决于系统希望做什么，包括现在和未来</li>
<li>is-a：适用于base身上的每一件事情也一定适用于derived身上，即<strong>Derived总是继承base的所有接口</strong></li>
<li>有的时候可能在cpp世界中与常识相反：<strong>正方形square和rectangle之间，其实并不是is-a关系，因为rectangle内部可以随意修改长宽，但是square确对长宽修改有要求</strong></li>
</ol>
<h2 data-id="heading-1">33. 避免遮掩继承而来的名称</h2>
<ol>
<li>当derived中有与base同名方法，则会直接隐藏掉，无论是否参数、返回值不同，甚至也<strong>无关virtual</strong>（所以多态可能导致隐藏），只与名称相关；这么做的原因是：防止在程序库或框架中建立新的Derived时附带地从疏远的base classes继承重载函数。</li>
<li>隐藏之后就类似于没有继承这些同名函数，但是这与public继承所有接口，可借助<strong>using</strong>来解决，如<code>using Base::f1;</code></li>
<li>当使用private继承时，有时候只是需要Base中某名称函数的部分，而不是全部（故using不满足），可以借助<strong>转交函数</strong>（inline函数），如<code>void f1(){Base::f1();}//这里类内部实现，隐藏inline，只暴露了Base::f1的无参版本</code></li>
</ol>
<h2 data-id="heading-2">34. 区分接口继承和实现继承</h2>
<ol>
<li><strong>public继承之下，Derived总是继承base的所有接口</strong></li>
<li><strong>pure virtual</strong>目的是为了让Derived只继承函数接口，但是其实是可以给pure virtual函数提供一一份实现的，然后使用<code>类名::函数名</code>来调用</li>
<li><strong>impure virtual</strong>目的是让derived继承函数接口以及缺省实现，但正是这缺省实现，可能让derived忘记重新定义，进而导致出错，推荐使用pure virtual，然后提供实现，再在内部调用，类似于转交函数</li>
<li><strong>non-virtual</strong>目的是为了让derived继承函数接口以及一份强制性的实现，绝不应该在derived中被重新定义</li>
</ol>
<h2 data-id="heading-3">35. 考虑virtual函数以外的其他选择</h2>
<ol>
<li>其实本章我也不知道为啥要用其他方式来替换virtual，希望以后能顿悟吧</li>
<li>具体方法参见链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Freasno%2Fp%2F4796134.html" target="_blank" title="https://www.cnblogs.com/reasno/p/4796134.html" ref="nofollow noopener noreferrer">考虑virtual函数以外的其他选择</a></li>
</ol>
<h2 data-id="heading-4">36. 绝不重新定义继承而来的non-virtual函数</h2>
<ol>
<li>如果重新定义了，那会导致调用该函数会因为指针的类型（base or derived）不同而不同</li>
<li>谨记non-virtual函数是为该class建立起一个不变性</li>
</ol>
<h2 data-id="heading-5">37. 绝不重新定义继承而来的缺省参数值</h2>
<ol>
<li>由条框36可知，重新定义的只能是virtual函数，故此条款针对的<strong>virtual函数</strong></li>
<li>缺省参数值，其实是静态类型，编译器根据指针类型，去绑定指定值，而virtual却是为了动态，两者其实天生矛盾</li>
<li>本条应该是说：<strong>永远不要在虚函数中定义默认参数</strong></li>
<li>如果希望使用base类提供的默认值，可使用<strong>NVI(public non-virtual 调用private virtual函数，派生类重定义virtual函数即可，外部调用non-virtual函数)</strong>：</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-type">int</span> x = <span class="hljs-number">10</span>)</span> </span>{  <span class="hljs-comment">// 非虚，统一管理默认值</span>
        <span class="hljs-built_in">doFoo</span>(x);
    }
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">doFoo</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>{ <span class="hljs-comment">/* 基类实现 */</span> }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">doFoo</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 派生类实现 */</span> }
};
</code></pre>
<h2 data-id="heading-6">38。 通过复合模塑出has-a或“根据某物实现出”</h2>
<ol>
<li><strong>复合</strong>，某种类型的对象含有其他类型的对象</li>
<li><strong>应用域</strong>，对象相对于所塑造世界中的某些事物，比如人等</li>
<li><strong>实现域</strong>，实现细节上的人工制品，如缓冲区、互斥器、查找树等</li>
<li>当复合发生在应用域就是has-a关系（如人有地址电话），实现域就是“根据某物实现出”的关系（如根据queue实现出stack）</li>
</ol>
<h2 data-id="heading-7">39. 明智而审慎地使用private继承</h2>
<ol>
<li>如果是private继承，编译器不会自动将derived class转换为base class对象；private继承而来的所有成员都会变为private属性</li>
<li>private继承意味”由某物实现出“</li>
<li><strong>private继承意味着只有实现部分被继承</strong>，接口部分应略去</li>
<li><strong>尽可能使用复用，只有当protected成员或virtual函数牵扯进来时，才使用private继承</strong></li>
<li>private还可能有empty base最优化，能节省内存</li>
</ol>
<h2 data-id="heading-8">40. 明智而审慎地使用多重继承</h2>
<ol>
<li>多重继承可能引入歧义性、菱形继承的问题</li>
<li>virtual继承会大小、速度等成本，且virtual base的初始化责任是由继承体系中最底层class负责，故尽量不要在virtual base中有数据</li>
<li><strong>当涉及”public继承某个interface class“和”private继承某个协助实现的class“的两相组合</strong>，则不得不使用多重继承</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JAVA代码审计：鉴权漏洞深度分析]]></title>    <link>https://juejin.cn/post/7578714759337099264</link>    <guid>https://juejin.cn/post/7578714759337099264</guid>    <pubDate>2025-12-01T13:15:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714759337099264" data-draft-id="7578700798744379426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JAVA代码审计：鉴权漏洞深度分析"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-01T13:15:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="予辉安全"/> <meta itemprop="url" content="https://juejin.cn/user/1013073908864108"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JAVA代码审计：鉴权漏洞深度分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1013073908864108/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    予辉安全
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T13:15:59.000Z" title="Mon Dec 01 2025 13:15:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、SessionFilter的安全迷雾</h2>
<p>在进行某系统安全审计时，我们发现了一个关键的<code>SessionFilter</code>过滤器。这个过滤器作为系统的第一道安全防线，本应承担着严格的访问控制职责，但其实现却暗藏玄机，存在多处可绕过的安全隐患。</p>
<h2 data-id="heading-1">二、白名单机制：看似安全实则脆弱</h2>
<h3 data-id="heading-2">2.1 白名单验证逻辑</h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isNoNeedValidate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> url, HttpServletRequest request</span>) {
    <span class="hljs-title class_">String</span>[] paths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"/login.jsp"</span>, <span class="hljs-string">"/user/logon.do"</span>, <span class="hljs-string">"/service/"</span>, ...};
    <span class="hljs-comment">// ... 白名单验证逻辑</span>
}
</code></pre>
<p><strong>关键发现</strong>：</p>
<ul>
<li>系统通过<code>request.getContextPath() + path</code>的方式进行路径匹配</li>
<li>只要请求路径以白名单中的任意一项开头，即可绕过鉴权</li>
</ul>
<h3 data-id="heading-3">2.2 路径规范化绕过</h3>
<p><strong>绕过手法</strong>：</p>
<ul>
<li>利用<code>../</code>进行路径跳转（低版本Spring框架）</li>
<li>示例：<code>/trwfe/../login.jsp</code> 经过规范化后可能被识别为白名单路径</li>
<li><strong>影响</strong>：攻击者可通过精心构造的URL绕过鉴权直接访问受限资源</li>
</ul>
<h2 data-id="heading-4">三、多重检查机制的漏洞分析</h2>
<h3 data-id="heading-5">3.1 Referer检查可被伪造</h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isReferer</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> url, HttpServletRequest request</span>) {
    <span class="hljs-title class_">String</span>[] paths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"/ws/sso/login"</span>};
    <span class="hljs-comment">// 仅对特定路径禁用Referer检查</span>
    <span class="hljs-keyword">return</span> !url.<span class="hljs-title function_">startsWith</span>(contextPath + <span class="hljs-string">"/ws/sso/login"</span>);
}
</code></pre>
<p><strong>安全缺陷</strong>：</p>
<ol>
<li>除<code>/ws/sso/login</code>外，其他路径均进行Referer检查</li>
<li>Referer头可被伪造：<code>Referer: http://目标域名/</code></li>
<li>攻击者可轻易绕过域名验证</li>
</ol>
<h3 data-id="heading-6">3.2 第三方系统开关的配置依赖</h3>
<p>java</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">if</span> (Config.THIRD_SYSTEM_SWITCH &amp;&amp; <span class="hljs-string">"2"</span>.equals(Config.THIRD_SYSTEM_TYPE) 
    &amp;&amp; <span class="hljs-keyword">this</span>.isForbid(url, request)) {
    response.setStatus(<span class="hljs-number">500</span>);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p><strong>配置风险</strong>：</p>
<ul>
<li>依赖<code>THIRD_SYSTEM_SWITCH</code>和<code>THIRD_SYSTEM_TYPE</code>配置</li>
<li>多线程环境下可能存在配置状态不一致问题</li>
<li>静态配置无法应对动态攻击场景</li>
</ul>
<h3 data-id="heading-7">3.3 isForbid函数的安全盲点</h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isForbid</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> url, HttpServletRequest request</span>) {
    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"ext/flow"</span>)) {
        <span class="hljs-comment">// 仅限制非GET方法</span>
        <span class="hljs-keyword">return</span> !<span class="hljs-string">"get"</span>.<span class="hljs-title function_">equals</span>(method) &amp;&amp; !<span class="hljs-string">"GET"</span>.<span class="hljs-title function_">equals</span>(method);
    }
    <span class="hljs-comment">// 仅检查特定路径</span>
    <span class="hljs-title class_">String</span>[] paths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"ext/trusteeSet"</span>};
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>绕过条件</strong>：</p>
<ol>
<li>不包含<code>ext/trusteeSet</code>路径</li>
<li>不包含<code>ext/flow</code>路径，或对<code>ext/flow</code>仅使用GET请求</li>
<li>绝大多数业务接口均可满足这些条件</li>
</ol>
<h2 data-id="heading-8">四、Ajax请求处理的逻辑漏洞</h2>
<h3 data-id="heading-9">4.1 条件判断缺陷</h3>
<p>java</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">request</span>.getHeader(<span class="hljs-string">"x-requested-with"</span>) != <span class="hljs-literal">null</span> 
    &amp;&amp; <span class="hljs-built_in">request</span>.getHeader(<span class="hljs-string">"x-requested-with"</span>).equalsIgnoreCase(<span class="hljs-string">"XMLHttpRequest"</span>)) {
    // 检查lang cookie
    <span class="hljs-keyword">if</span> (StringUtils.isBlank(lang)) {
        <span class="hljs-built_in">response</span>.setHeader(<span class="hljs-string">"sessionstatus"</span>, <span class="hljs-string">"timeout"</span>);
        return;
    }
    chain.<span class="hljs-keyword">do</span><span class="hljs-built_in">Filter</span>(...);
} <span class="hljs-keyword">else</span> {
    // 非Ajax请求直接放行！
    chain.<span class="hljs-keyword">do</span><span class="hljs-built_in">Filter</span>(...);
}
</code></pre>
<p><strong>致命漏洞</strong>：</p>
<ul>
<li><strong>不设置<code>x-requested-with</code>头即可绕过Ajax验证</strong></li>
<li>浏览器默认请求不会自动添加此头</li>
<li>攻击者可轻松构造非Ajax请求绕过会话检查</li>
</ul>
<h2 data-id="heading-10">五、攻击链构造与风险影响</h2>
<h3 data-id="heading-11">5.1 完整攻击路径</h3>
<ol>
<li><strong>绕过白名单</strong>：使用路径跳转技术</li>
<li><strong>伪造Referer</strong>：设置合法的Referer头</li>
<li><strong>避免触发isForbid</strong>：选择普通业务接口</li>
<li><strong>绕过Ajax验证</strong>：不设置x-requested-with头</li>
</ol>
<h3 data-id="heading-12">5.2 风险影响评估</h3>
<ul>
<li><strong>未授权访问</strong>：可访问任意未在白名单中的功能</li>
<li><strong>数据泄露</strong>：获取敏感业务数据</li>
<li><strong>权限提升</strong>：通过未授权接口执行高权限操作</li>
<li><strong>业务逻辑绕过</strong>：绕过正常业务流程控制</li>
</ul>
<h2 data-id="heading-13">六、修复建议与安全实践</h2>
<h3 data-id="heading-14">6.1 立即修复措施</h3>
<ol>
<li><strong>路径验证强化</strong>：</li>
</ol>
<p>java</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 使用标准化路径进行比较</span>
String normalizedPath = Paths<span class="hljs-selector-class">.get</span>(url)<span class="hljs-selector-class">.normalize</span>()<span class="hljs-selector-class">.toString</span>();
</code></pre>
<ol start="2">
<li><strong>Referer验证增强</strong>：</li>
</ol>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 验证Referer的完整性和来源</span>
<span class="hljs-keyword">if</span> (referer != <span class="hljs-literal">null</span> &amp;&amp; !isValidReferer(referer, serverName)) {
    <span class="hljs-comment">// 拒绝访问并记录审计日志</span>
}
</code></pre>
<ol start="3">
<li><strong>移除Ajax特例逻辑</strong>：</li>
</ol>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">// 统一验证逻辑，不区分Ajax和普通请求
String <span class="hljs-attr">lang</span> = CookieUtil.getCookie(request, <span class="hljs-string">"lang"</span>)<span class="hljs-comment">;</span>
if (StringUtils.isBlank(lang)) {
    handleSessionTimeout(response)<span class="hljs-comment">;</span>
    return<span class="hljs-comment">;</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>