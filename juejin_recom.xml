<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[WPF/C#：使用Microsoft Agent Framework框架创建一个带有审批功能的终端Agent]]></title>    <link>https://juejin.cn/post/7572012699628175387</link>    <guid>https://juejin.cn/post/7572012699628175387</guid>    <pubDate>2025-11-13T12:04:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572012699628175387" data-draft-id="7572132100327227442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WPF/C#：使用Microsoft Agent Framework框架创建一个带有审批功能的终端Agent"/> <meta itemprop="keywords" content="C#"/> <meta itemprop="datePublished" content="2025-11-13T12:04:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WPF/C#：使用Microsoft Agent Framework框架创建一个带有审批功能的终端Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:04:50.000Z" title="Thu Nov 13 2025 12:04:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近新出了一个Microsoft Agent Framework框架，我感觉还挺有意思的，就通过它的那个<code>Using function tools with human in the loop approvals</code>例子，做了一个终端助手Agent。我觉得使用这个作为学习人在环上这个例子蛮合适的，因为对于需要执行敏感操作（如系统命令）的场景，人工审批机制显得尤为重要。本文以Rouyan为例，说明如何使用Microsoft Agent Framework创建一个能够执行终端命令并具备人工审批功能的WPF应用。</p>
<p>在详细介绍之前，先来看看它的效果。</p>
<p>1、比如获取当前时间</p>
<p>会先弹出一个人工审批窗口：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b3770138d9b49a98967ccc9b80c76dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=F%2F3MT3ek%2FuAVwsxjD2czV9M2Oyk%3D" alt="image-20251017213637660" loading="lazy"/></p>
<p>然后你点击同意了才会执行：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afd53c18c5a24b568bb4e783d49624d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=Xxt%2F8daPwCpAP7%2Fgz4%2B8%2FEdeO5Y%3D" alt="image-20251017213716893" loading="lazy"/></p>
<p>如果你拒绝了就是这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2055b23647745f7a94f91619316c4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=OKzISgXqI4E%2B%2FZvBiesROYm7BqA%3D" alt="image-20251017213755043" loading="lazy"/></p>
<p>实际上你可以利用终端做很多事情，我再举一个例子。</p>
<p>2、新建一个文件，写入你好：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c47d29e703346e599c37f9d02b72268~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=OObNqWnQmoRONzYyOz7L%2FZZQcGU%3D" alt="image-20251017214320364" loading="lazy"/></p>
<p>选择同意，结果如图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/516d19eac35d4a9e82f723dbf61c9d15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=dz8VY7Barr%2B6kY5RM7e4J26rNL4%3D" alt="image-20251017214407194" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08900a30970048bd8305bf1a32c5069b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=5LxGYBMMfjS6z4%2BErrAxptmHqMM%3D" alt="image-20251017214543527" loading="lazy"/></p>
<p>在介绍如何具体实现之前，先来介绍一下Microsoft Agent Framework。</p>
<h2 data-id="heading-1">Microsoft Agent Framework介绍</h2>
<p>GitHub上的简介是：“一个用于构建、编排和部署AI代理及多代理工作流程的框架，支持Python和.NET。”</p>
<p>GitHub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-framework" target="_blank" title="https://github.com/microsoft/agent-framework" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8521ff892e474b848f6c624a882986~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=Ei2lnlS7LGYVHcWg%2FdAhiFJ0NpM%3D" alt="image-20251017215713327" loading="lazy"/></p>
<p>Microsoft Agent Framework 是一个开源开发工具包，用于为 .NET 和 Python 构建 AI 代理和多代理工作流。它整合并扩展了 Semantic Kernel 和 AutoGen 项目的思想，融合了两者的优点，并新增了多项功能。该框架由同一团队开发，将成为未来构建 AI 代理的统一基础。</p>
<p>Agent Framework 提供了两大主要功能类别：</p>
<p><span>AI 代理：单个代理利用大语言模型（LLM）处理用户输入，调用工具和 MCP 服务器执行操作，并生成响应。代理支持的模型提供商包括 Azure OpenAI、OpenAI 和 Azure AI。</span></p>
<p><span>工作流：基于图形的工作流，用于连接多个代理和功能，以执行复杂的多步骤任务。工作流支持基于类型的路由、嵌套、检查点以及适用于人工干预场景的请求/响应模式。</span></p>
<p>该框架还提供了基础构建模块，包括模型客户端（聊天补全和响应）、用于状态管理的代理线程、用于代理记忆的上下文提供程序、用于拦截代理操作的中间件，以及用于工具集成的MCP客户端。这些组件共同为您提供灵活性和强大功能，以构建交互性强、稳健且安全的AI应用程序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89fcc75f98fa4ec6abad031d75cda563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=8Plt1SX%2BGDgjtet2Q8eMHhLcpdU%3D" alt="image-20251017215856749" loading="lazy"/></p>
<h2 data-id="heading-2">具体实现</h2>
<p>1、安装Nuget包：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/143d83bac73e426b841408fbfc5bd51d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=imV6DJQAE6TlQNnMMenP3sNOM2o%3D" alt="image-20251017220544499" loading="lazy"/></p>
<p>2、编写运行脚本的函数</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Description(<span class="hljs-string">"Execute a Windows cmd.exe script and return its output."</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ExecuteCmd</span>(<span class="hljs-params">[Description(<span class="hljs-string">"The script content to run via 'cmd.exe /c'."</span></span>)] <span class="hljs-built_in">string</span> script)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> psi = <span class="hljs-keyword">new</span> ProcessStartInfo(<span class="hljs-string">"cmd.exe"</span>, <span class="hljs-string">"/c "</span> + script)
        {
            UseShellExecute = <span class="hljs-literal">false</span>,
            RedirectStandardOutput = <span class="hljs-literal">true</span>,
            RedirectStandardError = <span class="hljs-literal">true</span>,
            CreateNoWindow = <span class="hljs-literal">true</span>
        };

        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> process = <span class="hljs-keyword">new</span> Process())
        {
            process.StartInfo = psi;
            process.Start();

            <span class="hljs-built_in">string</span> output = process.StandardOutput.ReadToEnd();
            <span class="hljs-built_in">string</span> error = process.StandardError.ReadToEnd();

            process.WaitForExit();

            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrWhiteSpace(error))
            {
                <span class="hljs-keyword">return</span> <span class="hljs-string">$"错误: <span class="hljs-subst">{error.Trim()}</span>"</span>;
            }

            <span class="hljs-keyword">return</span> output.Trim();
        }
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-string">$"执行失败: <span class="hljs-subst">{ex.Message}</span>"</span>;
    }
}
</code></pre>
<p>3、配置AI Agent</p>
<p>文档中只写了Azure中怎么使用，兼容OpenAI格式的可以这样写：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 配置AI Agent</span>
 DotEnv.Load();
 <span class="hljs-keyword">var</span> envVars = DotEnv.Read();

 <span class="hljs-keyword">var</span> apiKey = envVars[<span class="hljs-string">"OPENAI_API_KEY"</span>];
 <span class="hljs-keyword">var</span> model = envVars[<span class="hljs-string">"OPENAI_CHAT_MODEL"</span>];
 <span class="hljs-keyword">var</span> baseUrl = <span class="hljs-keyword">new</span> Uri(envVars[<span class="hljs-string">"OPENAI_BASE_URL"</span>]);

 ApiKeyCredential apiKeyCredential = <span class="hljs-keyword">new</span> ApiKeyCredential(apiKey);

 OpenAIClientOptions openAIClientOptions = <span class="hljs-keyword">new</span> OpenAIClientOptions();
 openAIClientOptions.Endpoint = baseUrl;

 AIAgent agent = <span class="hljs-keyword">new</span> OpenAIClient(apiKeyCredential, openAIClientOptions)
     .GetChatClient(model)
     .CreateAIAgent(instructions: <span class="hljs-string">"你是一个乐于助人的助手，可以执行命令行脚本。请使用中文回答。"</span>, tools: [<span class="hljs-keyword">new</span> ApprovalRequiredAIFunction(AIFunctionFactory.Create(ExecuteCmd))]);
</code></pre>
<p>这里有一个新东西就是<code>ApprovalRequiredAIFunction</code>。</p>
<p>这说明如果调用这个函数需要经过人工审批。</p>
<p>4、审批流程</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Call the agent and check if there are any user input requests to handle.</span>
AgentThread thread = agent.GetNewThread();

<span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> agent.RunAsync(InputText, thread);
<span class="hljs-keyword">var</span> userInputRequests = response.UserInputRequests.ToList();
</code></pre>
<p>我们先来看看这个是什么，运行起来打个断点看看：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41392255d63f487fb79f26089f363fe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=FAPDpG5dKI%2F%2FXceaJkehnTzDrL0%3D" alt="image-20251017221907635" loading="lazy"/></p>
<p>这就是一个Agent想要执行的函数，那么现在来看看如何审批：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">while</span> (userInputRequests.Count &gt; <span class="hljs-number">0</span>)
{
    <span class="hljs-keyword">var</span> userInputResponses = <span class="hljs-keyword">new</span> List&lt;ChatMessage&gt;();

    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> functionApprovalRequest <span class="hljs-keyword">in</span> userInputRequests.OfType&lt;FunctionApprovalRequestContent&gt;())
    {
        <span class="hljs-keyword">var</span> scriptContent = functionApprovalRequest.FunctionCall.Arguments?[<span class="hljs-string">"script"</span>]?.ToString() ?? <span class="hljs-string">"未知脚本"</span>;
        <span class="hljs-keyword">var</span> functionName = functionApprovalRequest.FunctionCall.Name;

        <span class="hljs-keyword">var</span> dialogVm = <span class="hljs-keyword">new</span> HumanApprovalDialogViewModel
        {
            Title = <span class="hljs-string">"命令执行审批"</span>,
            Message = <span class="hljs-string">$"是否同意执行以下命令？\n\n函数名称: <span class="hljs-subst">{functionName}</span>\n脚本内容: <span class="hljs-subst">{scriptContent}</span>"</span>
        };

        <span class="hljs-built_in">bool</span>? result = _windowManager.ShowDialog(dialogVm);
        <span class="hljs-built_in">bool</span> approved = result == <span class="hljs-literal">true</span>;

        userInputResponses.Add(<span class="hljs-keyword">new</span> ChatMessage(ChatRole.User, [functionApprovalRequest.CreateResponse(approved)]));
    }

    <span class="hljs-comment">// Pass the user input responses back to the agent for further processing.</span>
    response = <span class="hljs-keyword">await</span> agent.RunAsync(userInputResponses, thread);
    userInputRequests = response.UserInputRequests.ToList();
}
</code></pre>
<p>根据这个地方<code>userInputResponses.Add(new ChatMessage(ChatRole.User, [functionApprovalRequest.CreateResponse(approved)]));</code>中的approved传入的是true还是false表示用户是同意还是拒绝。</p>
<p>然后发送请求获取新的回复，直到没有需要人工审批的函数为止。</p>
<p>5、流式响应</p>
<p>最后再获取一个流式响应：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> update <span class="hljs-keyword">in</span> agent.RunStreamingAsync(<span class="hljs-string">"输出最终答案"</span>, thread))
{
    OutputText += update.Text;
}
</code></pre>
<h2 data-id="heading-3">最后</h2>
<p>以上就是本期的全部内容，希望对你有所帮助。</p>
<p>全部代码已上传至GitHub，地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMing-jiayou%2FRouyan%25E3%2580%2582" target="_blank" title="https://github.com/Ming-jiayou/Rouyan%E3%80%82" ref="nofollow noopener noreferrer">github.com/Ming-jiayou…</a></p>
<p>终端助手的代码主要在src/Rouyan/Pages/ViewModel/TerminalAgentViewModel.cs中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Forrester调研400位高级决策者，揭示AI应用未来]]></title>    <link>https://juejin.cn/post/7572164122235109386</link>    <guid>https://juejin.cn/post/7572164122235109386</guid>    <pubDate>2025-11-13T12:12:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572164122235109386" data-draft-id="7572021695294324786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Forrester调研400位高级决策者，揭示AI应用未来"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-11-13T12:12:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Forrester调研400位高级决策者，揭示AI应用未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:12:17.000Z" title="Thu Nov 13 2025 12:12:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>根据Gartner预测，2025年全球人工智能支出预计将达到6440亿美元，较2024年增长76.4%。在此背景下，企业已将AI视为关乎生存的战略要务。然而，它们在投资AI时具体关注哪些方面？</p>
<p>我们决定与Forrester合作寻找答案。我们对400名负责AI和企业云战略的高级决策者进行了双盲研究。受访者包括来自科技、金融服务、媒体、零售、制造和医疗保健行业的总监、副总裁和C级高管。</p>
<p>本研究旨在揭示企业如何规划近期及长期的AI工作流程和AI工具，尤其关注期望值最高的面向客户的应用。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fforrester-enterprise-ai-report-2025%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251113_external1_blogarticles226" target="_blank" title="https://www.akamai.com/zh/lp/forrester-enterprise-ai-report-2025?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251113_external1_blogarticles226" ref="nofollow noopener noreferrer">《企业级AI现状：积累经验，管理风险》</a>（Forrester OSNAP报告）揭示，AI已成为跨行业、跨地区的战略要务。</p>
<p>为理解这些结果的重要性，让我们深入探讨其驱动因素、当前采用模式背后的原因，以及组织和开发团队接下来该如何保持行业领先地位。</p>
<h4 data-id="heading-0"><strong><strong>AI正定义竞争格局</strong></strong></h4>
<p>Forrester数据显示，76%的企业应用AI解决方案和应用来改善客户体验，71%用以加强客户留存，76%用以提升运营效率。这些是收入增长和竞争优势的核心驱动力。</p>
<p>成功部署AI的组织更能：</p>
<ul>
<li>通过客户体验实现差异化</li>
<li>获取并保护市场份额</li>
<li>加速创新周期</li>
<li>释放运营杠杆效应</li>
<li>构建抵御颠覆的未来韧性</li>
</ul>
<p><strong><strong>通过客户体验实现差异化</strong></strong></p>
<p>个性化服务或推荐、通过自动化实现更快速的服务、智能服务解决，这些都直接改善了客户体验—Forrester将其确定为AI投资的头号驱动因素。在竞争激烈的市场中，客户互动的质量是决定用户忠诚度和留存的关键。</p>
<p><strong><strong>获取并保护市场份额</strong></strong></p>
<p>通过将生成式AI等人工智能能力深度融入客户旅程，企业得以打造更具用户粘性、且难以被竞争对手复制的体验。这不仅有效提升了客户净留存率，也显著增加了用户的转换成本。</p>
<p><strong><strong>加速创新周期</strong></strong></p>
<p>使用AI的企业能够更快地推出新产品和服务，尤其是在整合了程序化内容生成、视觉搜索与预测分析等高级能力后。在那些上市速度与市场份额增长紧密相关的行业中，这构成了一个决定性优势。</p>
<p><strong><strong>释放运营杠杆</strong></strong></p>
<p>AI驱动效率提升，无论是通过流程自动化还是员工能力增强，都将直接转化为成本降低、扩展加速，以及更高价值工作的聚焦。</p>
<p><strong><strong>构建抗颠覆韧性</strong></strong></p>
<p>正如Forrester所指，企业评估AI成功不仅看效率，更关注其对长期收入与客户终身价值的影响。行动迟缓者，恐将被已将AI深度融入核心能力的对手所超越。</p>
<p>从开发者视角看，这一转变意味着AI已嵌入关键业务路径。支撑AI的代码直接牵动客户终身价值与净留存率等核心指标，使可靠性、可扩展性与伦理考量，成为AI设计的重中之重。</p>
<h4 data-id="heading-1"><strong><strong>已验证的用例与下一波创新浪潮</strong></strong></h4>
<p>Forrester强调，采用最广泛的AI用例是那些直接影响客户触点的领域：个性化（53%）、自动化客户服务解决（53%）和回答客户问题（52%）。这些用例占主导地位，是因为它们能带来可衡量的短期成果。</p>
<p>与投资回报不明确的抽象AI计划相比，能够提升转化率的推荐引擎或减少客户流失的聊天机器人，更容易获得领导层的支持。对于企业及其开发团队而言，这种侧重转化为对能够扩展、处理实时数据并最大限度减少客户互动延迟的系统的持续需求。</p>
<p><strong><strong>技术选择将决定AI竞赛的赢家与输家</strong></strong></p>
<p>企业正纷纷加入这波强大的AI浪潮，但力求避免"翻船"。关于AI陷阱和失败的报道屡见不鲜，因此需要深思熟虑和审慎的方法才能成为成功案例之一。</p>
<p>通常，选择从已确定的用例（如AI聊天机器人）入手以快速见效，有助于建立对其AI战略的信心并提升AI应用熟练度。</p>
<p>反过来，这种信心为开展更复杂或更贴合其业务需求的细分AI实施打开了大门。这些应用往往因行业而异。例如：</p>
<ul>
<li>零售和旅游业专注于个性化和视觉搜索以提升客户体验。</li>
<li>金融服务更看重自动化和欺诈检测。</li>
<li>医疗保健和生命科学领域采用AI更为谨慎，在创新与合规及风险之间取得平衡。</li>
</ul>
<p>除了这些已确定的用例，实验性探索正在增加。近半数（46%）的组织正在试点程序化内容创建，40%在测试视觉搜索，而37%在探索面部识别。</p>
<p>这些实验性研发很重要，因为今天的"副业项目"可能成为明天的竞争基准。回想一下酒店业的移动入住是如何从新奇事物转变为必需服务的。鼓励开发团队试点新兴技术的企业更有可能为AI驱动工具和解决方案的爆发式增长做好准备。</p>
<h4 data-id="heading-2"><strong><strong>风险、安全与声誉：AI的隐性成本</strong></strong></h4>
<p>该研究也揭示了多项发人深省的现状。总共63%的受访者将安全担忧列为首要障碍，55%担心合规问题，近半数（45%）担心若AI未能达到预期会损害声誉。</p>
<p>从技术角度看，这些数字强调了对于以下治理框架的需求：</p>
<ul>
<li>保护数据管道以防泄漏</li>
<li>模型监控以检测漂移或偏差</li>
<li>模拟生产环境的测试协议</li>
</ul>
<p>但降低这些风险不仅仅需要技术保障措施。</p>
<p>企业可以从全局性的风险管理思维中受益。安全不仅需要强化的基础设施，还需要清晰的数据处理政策和定期审计，以便在攻击者之前发现漏洞。合规要求开发团队、法律团队和监管专家之间的协作，以确保模型符合不断发展的行业和地区标准。而声誉风险则要求透明度和问责制。</p>
<p>能够解释其AI系统如何决策并证明其公平性的公司，在出现问题时遭遇强烈反对的可能性要小得多。换言之，企业不仅仅是在编写模型，更是在部署关乎业务成败、并反映组织诚信的系统。</p>
<p>降低风险意味着将工程纪律与组织问责相结合，从而确保对创新的追求不以牺牲安全、合规或信任为代价。</p>
<h4 data-id="heading-3"><strong><strong>克服集成障碍</strong></strong></h4>
<p>企业正通过多种技术方法来分散风险。Forrester报告显示，云原生技术（81%）、开源AI（72%）和AI托管服务（77%）的采用率很高。然而，仍有55%的组织将技术和平台差距视为其首要挑战。</p>
<p>这种双重性反映了一个开发者熟知的现实：工具易得，集成难。专有API、碎片化的生态系统以及参差不齐的合规要求都拖慢了进展。那些构建灵活、混合架构的组织——利用开源创新、托管服务实现扩展、边缘部署实现低延迟体验——更能克服这一障碍。</p>
<p>旨在短期内全球部署AI的公司需要的不仅仅是云基础设施：他们需要能够跨监管区域运营、支持本地数据驻留并提供一致性能的合作伙伴。</p>
<p>在Forrester的数据中，专业AI提供商被评为首选合作伙伴。这与我在实践中观察到的情况一致：组织希望供应商既能提供全球覆盖，又具备深厚的技术专长。</p>
<h4 data-id="heading-4"><strong><strong>企业当前可采取的五项行动</strong></strong></h4>
<p>Forrester研究指出：AI已是常态，企业的成败取决于其把握机遇与管理风险的能力。基于最新洞察，我们建议立即推进以下五项措施：</p>
<ol>
<li><strong><strong>以客户价值锚定AI</strong></strong><br/>
每次AI部署都应与客户体验、留存率或收入的可量化提升直接挂钩。</li>
<li><strong><strong>兼顾速度与治理</strong></strong><br/>
在快速推进的同时，将合规、测试与监控前置至开发初始阶段。</li>
<li><strong><strong>构建灵活架构</strong></strong><br/>
结合开源、云原生与AI托管服务，从技术上规避供应商锁定。</li>
<li><strong><strong>审慎选择合作伙伴</strong></strong><br/>
优先考虑具备全球规模、本地化合规能力与可靠交付记录的供应商。</li>
<li><strong><strong>将实验纳入研发体系</strong></strong><br/>
打破试点孤岛，把AI实践的经验融入长期技术路线图。</li>
</ol>
<h4 data-id="heading-5"><strong><strong>定义AI新时代</strong></strong></h4>
<p>Forrester研究印证了我们共同的观察：AI已成为企业战略的核心。然而数据也揭示出，企业愿景与现实部署之间仍存张力。</p>
<p>开发者、架构师与业务领导者必须意识到：今天所构建的AI，不仅影响产品功能，更将决定未来的客户体验与品牌信誉。那些以客户为中心、采纳灵活技术策略并携手可信合作伙伴的组织，不仅能在AI浪潮中立足，更将共同定义这个时代。</p>
<h4 data-id="heading-6"><strong><strong>了解更多</strong></strong></h4>
<p>如果您有兴趣进一步了解企业AI的现状，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fforrester-enterprise-ai-report-2025%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251113_external2_blogarticles226" target="_blank" title="https://www.akamai.com/zh/lp/forrester-enterprise-ai-report-2025?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251113_external2_blogarticles226" ref="nofollow noopener noreferrer">请阅读完整报告</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？]]></title>    <link>https://juejin.cn/post/7572010680896749608</link>    <guid>https://juejin.cn/post/7572010680896749608</guid>    <pubDate>2025-11-13T12:33:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896749608" data-draft-id="7572020278386982946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-13T12:33:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:33:17.000Z" title="Thu Nov 13 2025 12:33:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？</h2>
<p>在当今的大模型（LLM）领域，MoE（Mixture of Experts）架构已经成为实现“更快、更强、更大”的黄金门票。通过“稀疏激活”，MoE 允许模型拥有数千亿甚至万亿的总参数（知识库），同时保持着极低（且可控）的计算成本（推理速度）。</p>
<p>但这个“天下没有免费的午餐”的故事里，有一个致命的“阿喀琉斯之踵”——<strong>负载均衡 (Load Balancing)</strong> 。</p>
<p>如果你不加约束，Gating 网络（分诊台）会很快“偷懒”，发现有几个专家特别“聪明”，然后把所有任务都交给它们。这会导致“明星专家”过劳，而“摸鱼专家”完全得不到训练，白白浪费了宝贵的 GPU 资源和模型容量。</p>
<p>为了解决这个问题，研究者们设计了“辅助损失函数” (Auxiliary Loss Function) 来“惩罚”这种不均衡。今天，我们就来深入对比两种最著名、最有代表性的负载均衡策略。</p>
<p>这不仅仅是一场数学公式的较量，更是一场“统计纯洁性”与“工程实用性”的对决。</p>
<hr/>
<h3 data-id="heading-1">策略一：“统计主义”的优雅——CV 损失 (GShard)</h3>
<p>第一种方法来自 Google GShard 等早期 MoE 论文，它在数学上非常“优雅”，力求实现统计上的完美均衡。</p>
<p><strong>核心思想：</strong> 我们应该让所有专家被 Gating 网络赋予的**“总重要性” (Total Importance)** 保持一致。</p>
<p>核心公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>Importance</mtext></msub><mo>=</mo><msub><mi>w</mi><mtext>Importance</mtext></msub><mo>⋅</mo><mtext>CV</mtext><mo stretchy="false">(</mo><mtext>Importance</mtext><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L_{\text{Importance}} = w_{\text{Importance}} \cdot \text{CV}(\text{Importance}(X))^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Importance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7306em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Importance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">CV</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">Importance</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>公式分解：</strong></p>
<ol>
<li>
<p><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></strong> ：Gating 网络为单个 Token <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 输出的、<em>经过 Top-K 筛选和 Softmax 归一化</em>的稀疏概率向量。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Importance</mtext><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>X</mi></mrow></msub><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Importance}(X) = \sum_{x \in X} G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Importance</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0771em;vertical-align:-0.3271em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>：</p>
<p>这是最关键的一步。我们把一个批次 (Batch) 中所有 Token 的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 向量全部加起来，得到一个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 维（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 为专家数）的“总重要性”向量。例如 [150.3, 149.8, 150.1, 149.9]。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>CV</mtext><mo stretchy="false">(</mo><mo>…</mo><mtext> </mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{CV}(\dots)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">CV</span></span><span class="mopen">(</span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mclose">)</span></span></span></span></span>：</p>
<p>计算这个“总重要性”向量的变异系数 (Coefficient of Variation)，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mtext>标准差</mtext><mtext>平均值</mtext></mfrac></mrow><annotation encoding="application/x-tex">\frac{\text{标准差}}{\text{平均值}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">平均值</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">标准差</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>Importance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{Importance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Importance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<p>我们最小化这个变异系数的平方。</p>
</li>
</ol>
<p>直觉：</p>
<p>变异系数是衡量“不均衡性”的完美指标。</p>
<ul>
<li><strong>完美均衡：</strong> <code>[150, 150, 150]</code>。标准差 = 0，CV = 0，损失 = 0。</li>
<li><strong>极度失衡：</strong> <code>[450, 0, 0]</code>。标准差和 CV 都非常高，损失非常大。</li>
</ul>
<p>这种方法在理论上近乎完美，它只需要一次 <code>AllReduce</code>（计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>），计算高效且数学逻辑清晰。</p>
<hr/>
<h3 data-id="heading-2">策略二：“实用主义”的胜利——Switch 损失 (Mixtral)</h3>
<p>第二种方法来自 Google 的 Switch Transformer 论文，并被 Mixtral 8x7B 等当前最先进的开源模型所采用。它看起来“更复杂”或“更不直观”，但它解决了一个致命的漏洞。</p>
<p><strong>核心思想：</strong> 我们必须<em>同时</em>平衡 Gating 网络的“路由信心”和专家的“实际工作量”。</p>
<p>核心公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum_{i=1}^{N} f_i \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p><strong>公式分解：</strong></p>
<ol>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均路由概率)：</p>
<p>Gating 网络在这个批次中，平均分配给专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的**“概率”**（即“意向”）。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (任务分配比例)：</p>
<p>通过 Top-K 硬决策后，专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 实际 被分配到的 Token 比例（即“实际工作量”）。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<p>我们最小化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量的“点积”（Dot Product）。</p>
</li>
</ol>
<p>直觉：</p>
<p>这个公式的巧妙之处在于，它将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（一个不可微分的“硬决策”结果）和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（一个可微分的“软概率”）绑定在了一起。我们稍后会看到，这不仅解决了负载均衡，还顺便解决了“梯度回传”的难题。</p>
<hr/>
<h3 data-id="heading-3">巅峰对决：CV 损失的“致命漏洞”</h3>
<p>表面上看，CV 损失（策略一）更简单、更高效。为什么 Mixtral 反而选择了更复杂的 Switch 损失（策略二）呢？</p>
<p><strong>因为 CV 损失可以被 Gating 网络“欺骗”。</strong></p>
<p>CV 损失平衡的是“概率总和”，而不是“实际工作”。让我们来看一个 Gating 网络“作弊”的场景：</p>
<blockquote>
<p><strong>作弊场景 (Top-K=1, N=2)：</strong></p>
<p>假设 Gating 网络决定“作弊”：</p>
<ul>
<li>它将 <strong>1000 个 Token</strong> 路由给<strong>专家 1</strong>，但每次只给 <strong>0.1</strong> 的低概率。</li>
<li>它将 <strong>100 个 Token</strong> 路由给<strong>专家 2</strong>，但每次都给 <strong>1.0</strong> 的高概率。</li>
</ul>
<p><strong>1. CV 损失（策略一）如何看待：</strong></p>
<ul>
<li>专家 1 的“总重要性”： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mo>×</mo><mn>0.1</mn><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">1000 \times 0.1 = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1000</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span></span></span></span></span></li>
<li>专家 2 的“总重要性”： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>×</mo><mn>1.0</mn><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">100 \times 1.0 = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Importance</mtext></mrow><annotation encoding="application/x-tex">\text{Importance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">Importance</span></span></span></span></span></span> 向量 = <code>[100, 100]</code></li>
<li><strong>CV = 0！损失 = 0！</strong></li>
<li><strong>结论：</strong> CV 损失认为这是“完美均衡”。</li>
</ul>
<p><strong>2. 实际 GPU 上的情况：</strong></p>
<ul>
<li>专家 1（GPU 1）被激活了 <strong>1000 次</strong>。</li>
<li>专家 2（GPU 2）被激活了 <strong>100 次</strong>。</li>
<li><strong>结论：</strong> 负载<strong>极度不均衡</strong>！GPU 1 过劳，GPU 2 摸鱼。</li>
</ul>
</blockquote>
<p>CV 损失被 Gating 网络的“花言巧语”（概率）所蒙蔽，而没有看到“实际工作”的分配。</p>
<p><strong>Switch 损失（策略二）如何看待：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">f_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (实际工作量) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>0.91</mn></mrow><annotation encoding="application/x-tex">\approx 0.91</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.91</span></span></span></span></span> (91% 的 Token 去了 1 号)</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">f_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (实际工作量) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>0.09</mn></mrow><annotation encoding="application/x-tex">\approx 0.09</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.09</span></span></span></span></span> (9% 的 Token 去了 2 号)</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">P_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均概率) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>0.1</mn></mrow><annotation encoding="application/x-tex">\approx 0.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.1</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">P_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均概率) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">\approx 1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.0</span></span></span></span></span></li>
</ul>
<p>Switch 损失会发现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量 (<code>[0.91, 0.09]</code>) 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量 (<code>[0.1, 1.0]</code>) 都极度不均衡，它们的点积（损失）会<strong>非常高</strong>，从而产生一个巨大的“惩罚”信号，迫使 Gating 网络停止这种“作弊”行为。</p>
<hr/>
<h3 data-id="heading-4">对比总结：为何“实用”胜过“优雅”？</h3>








































<table><thead><tr><th><strong>特性</strong></th><th><strong>策略一 (CV Loss / GShard)</strong></th><th><strong>策略二 (Switch Loss / Mixtral)</strong></th></tr></thead><tbody><tr><td><strong>核心理念</strong></td><td>统计主义：平衡“总概率”</td><td>实用主义：平衡“实际工作”</td></tr><tr><td><strong>平衡对象</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (概率/意向)</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (意向) <strong>和</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (实际工作量)</td></tr><tr><td><strong>计算开销</strong></td><td>理论上更低（1 次 AllReduce）</td><td>略高（2 次 AllReduce）</td></tr><tr><td><strong>鲁棒性</strong></td><td><strong>低</strong>。可被 Gating“欺骗”</td><td><strong>高</strong>。能捕捉到“实际负载”的不均</td></tr><tr><td><strong>主要用户</strong></td><td>早期 Google MoE 研究</td><td><strong>Mixtral</strong>、Switch Transformer</td></tr><tr><td><strong>额外优势</strong></td><td>无</td><td>巧妙地利用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 解决了 Top-K 的“不可微分”问题</td></tr></tbody></table>
<h4 data-id="heading-5">最后的赢家：Switch 损失的“一箭双雕”</h4>
<p>Switch 损失（策略二）的胜利不仅在于它更鲁棒，还在于它的设计是“一箭双雕”。</p>
<p>我们之前讨论过，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（实际工作量）来自 Top-K 硬决策，它本身是<strong>不可微分</strong>的（梯度无法回传）。</p>
<p>而 Switch 损失 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><mo>∑</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum (f_i \cdot P_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 在反向传播时，被设计为**“绕过”**了这个障碍。它将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 视为一个“常数”，梯度只通过 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 回传（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>L</mi><mo>∝</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\nabla L \propto f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∇</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）。</p>
<p>这意味着：</p>
<ol>
<li>它利用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 来<strong>实现负载均衡</strong>。</li>
<li>它利用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为“权重”，为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 这条<strong>可微分路径</strong>提供了梯度。</li>
</ol>
<p>结论：</p>
<p>CV 损失是一个“优雅”的数学公式，它试图平衡一个“代理指标”（概率），但最终失败了。</p>
<p>Switch 损失是一个“实用”的工程方案，它看起来更复杂，但它牢牢抓住了**“平衡实际 GPU 计算量”**这个核心目标，并顺便解决了梯度难题。</p>
<p>在构建强大、高效、可靠的 MoE 模型时，选择一个能“看穿谎言”的损失函数至关重要。在这场对决中，Mixtral 所代表的“实用主义”显然赢得了胜利。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[揭秘 MoE 训练的“三驾马车”]]></title>    <link>https://juejin.cn/post/7572010680896782376</link>    <guid>https://juejin.cn/post/7572010680896782376</guid>    <pubDate>2025-11-13T12:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896782376" data-draft-id="7572010680896765992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="揭秘 MoE 训练的“三驾马车”"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-13T12:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            揭秘 MoE 训练的“三驾马车”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:42:56.000Z" title="Thu Nov 13 2025 12:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">揭秘 MoE 训练的“三驾马车”：一篇博客看懂 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></h2>
<p>在混合专家模型（MoE）的宏伟蓝图中，我们惊叹于它如何用“稀疏激活”撬动万亿参数，实现了前所未有的性能和效率。但一个鲜为人知的事实是：<strong>训练 MoE 模型是一场极其精妙的“多目标优化”</strong> 。</p>
<p>仅仅告诉模型“你要预测准确”（即最小化主损失 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）是远远不够的。这样做，你的 Gating 网络（分诊台）会迅速“偷懒”或“崩溃”。</p>
<p>为了“驯服” Gating 网络，使其高效、公平、稳定地工作，我们必须引入另外两个“辅助损失函数”。它们与主损失一起，构成了 MoE 训练的“三驾马车”。</p>
<p>今天，我们将深入探讨这三大损失各自的使命，以及它们如何协同作战。</p>
<hr/>
<h3 data-id="heading-1">一号马车：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (主损失) —— “前进的方向”</h3>
<p>这是最简单、最核心的损失。</p>
<ul>
<li><strong>目标：</strong> 任务性能。</li>
<li><strong>公式：</strong> 通常是“交叉熵损失” (Cross-Entropy Loss)。</li>
<li><strong>它告诉模型：</strong> “<strong>你的最终答案必须是正确的！</strong> ”</li>
</ul>
<p>无论架构多复杂，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 始终是拉动整个模型向“更智能”方向前进的核心驱动力。但只有它，Gating 网络会“野蛮生长”，导致以下两个核心问题。</p>
<hr/>
<h3 data-id="heading-2">二号马车：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (负载均衡损失) —— “公平与效率”</h3>
<p><strong>问题：</strong> Gating 网络会“偷懒”，发现有几个专家特别“聪明”，然后把所有任务都交给它们。这导致“明星专家”过劳，“摸鱼专家”完全得不到训练，白白浪费了模型容量。</p>
<p><strong>目标：</strong> 强制 Gating 网络“雨露均沾”，确保工作负载被<em>公平地</em>分配给所有专家。</p>
<ul>
<li><strong>它告诉 Gating 网络：</strong> “<strong>你必须把工作公平地分配给所有人，不许有明星和摸鱼！</strong> ”</li>
</ul>
<p>我们之前详细对比了两种实现方式，其中“Switch 损失”因其鲁棒性而成为现代 MoE（如 Mixtral）的首选。</p>
<h5 data-id="heading-3">1. 策略一（已过时）：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>CV</mtext><mo stretchy="false">(</mo><mo>…</mo><mtext> </mtext><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\text{CV}(\dots)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">CV</span></span><span class="mopen">(</span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 损失 (GShard)</h5>
<ul>
<li><strong>理念：</strong> “统计主义”。平衡 Gating 网络的“总概率”（即“意向”）。</li>
<li><strong>漏洞：</strong> 它可以被 Gating 网络“欺骗”。Gating 可以给 1000 个 Token 0.1 的概率（总和 100），给 100 个 Token 1.0 的概率（总和 100）。CV 损失认为这很“均衡”，但<em>实际工作量</em>却是 1000 vs 100，极不均衡。</li>
</ul>
<h5 data-id="heading-4">2. 策略二（当前主流）：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 损失 (Switch / Mixtral)</h5>
<ul>
<li><strong>理念：</strong> “实用主义”。<strong>同时</strong>平衡“实际工作量” (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 和“路由信心” (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)。</li>
<li><strong>优势：</strong> 它能完美捕捉到上述“作弊”行为。由于它直接惩罚“实际工作量” (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 的不均衡，Gating 网络无法“撒谎”，必须老老实实地将 Token <em>真正地</em>平均分配到不同的 GPU（专家）上。</li>
</ul>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 确保了 MoE 模型的“效率”和“容量”能被充分利用。但它只解决了“公平”，没有解决“稳定”。</p>
<hr/>
<h3 data-id="heading-5">三号马车：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (z-损失) —— “稳定与克制”</h3>
<p><strong>问题：</strong> 即使 Gating 网络学会了“公平”，它也可能在训练中变得“过度自信”。它可能会输出<em>极大</em>的原始分数（Logits），比如 <code>[50, 1, -10, ...]</code>。</p>
<p><strong>为什么“大分数”是坏事？</strong></p>
<ol>
<li><strong>数值不稳定：</strong> 极大的 Logits 会导致梯度爆炸或消失，让训练过程（尤其是使用 16 位浮点数时）非常不稳定。</li>
<li><strong>过早收敛：</strong> Gating 过早地“焊死”了它的路由决策，丧失了“探索”其他专家组合的灵活性，导致模型陷入局部最优。</li>
</ol>
<p><strong>目标：</strong> 正则化。防止 Gating 网络输出的 Logits 数值过大。</p>
<ul>
<li><strong>它告诉 Gating 网络：</strong> “<strong>你可以有偏好，但你不许过度自信！把你的分数（Logits）保持在 0 附近！</strong> ”</li>
</ul>
<p>核心公式（简化版）：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub><mo>∝</mo><msub><mo>∑</mo><mtext>batch</mtext></msub><msup><mrow><mo fence="true">(</mo><mtext>LogSumExp</mtext><mo stretchy="false">(</mo><mtext>Top-K Logits</mtext><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L_{\text{router-z}} \propto \sum_{\text{batch}} \left( \text{LogSumExp}(\text{Top-K Logits}) \right)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2537em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">batch</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">LogSumExp</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">Top-K Logits</span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.954em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>工作原理：</strong></p>
<ul>
<li><strong>LogSumExp (LSE)</strong> 是一个“平滑的最大值”函数。当 Logits 很大时（例如 <code>[50, 1]</code>），LSE 的结果也会非常大（约等于 50）。</li>
<li>这个损失函数的目标是<strong>最小化 LSE 的平方</strong>。</li>
<li>因此，每当 Gating 网络试图输出一个很大的 Logit（如 50），<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就会产生一个<strong>巨大的惩罚</strong>，迫使 Gating 网络把这个值“拉回”到更小的、接近 0 的范围（比如 <code>[1.5, 0.5]</code>）。</li>
</ul>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就像一个“缰绳”，防止 Gating 网络这匹马（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）在“公平”的道路上跑得太快而“失控”。</p>
<hr/>
<h3 data-id="heading-6">总结：三驾马车的协同作战</h3>
<p>MoE 模型的最终训练，就是一场精妙的“多目标优化”。工程师需要通过超参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 来平衡这三驾马车：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>Total</mtext></msub><mo>=</mo><msub><mi>L</mi><mtext>main</mtext></msub><mo>+</mo><mi>α</mi><mo>⋅</mo><msub><mi>L</mi><mtext>balance</mtext></msub><mo>+</mo><mi>β</mi><mo>⋅</mo><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{Total}} = L_{\text{main}} + \alpha \cdot L_{\text{balance}} + \beta \cdot L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Total</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4445em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<ol>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (主损失)</strong> ：拉动马车向着“正确答案”前进。（<strong>性能</strong>）</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (负载均衡)</strong> ：确保所有拉车的马（专家）都在平均用力，没有马“摸鱼”。（<strong>效率</strong>）</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (z-损失)</strong> ：确保 Gating 网络（车夫）在挥鞭子（路由）时保持“冷静”和“克制”，防止马车失控。（<strong>稳定</strong>）</li>
</ol>
<p>只有当这三股力量达到完美的和谐与平衡时，MoE 这个庞大、复杂而又强大的模型，才能被成功地“驯服”，发挥出它的全部潜力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从逻辑到直觉，我的疑难问题方法论]]></title>    <link>https://juejin.cn/post/7572010680896864296</link>    <guid>https://juejin.cn/post/7572010680896864296</guid>    <pubDate>2025-11-13T12:56:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896864296" data-draft-id="7572020278387032098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从逻辑到直觉，我的疑难问题方法论"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-13T12:56:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码农胖大海"/> <meta itemprop="url" content="https://juejin.cn/user/4195392102086967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从逻辑到直觉，我的疑难问题方法论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4195392102086967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码农胖大海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:56:31.000Z" title="Thu Nov 13 2025 12:56:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>解决疑难问题是一场心智的马拉松，是科学、艺术与经验的结合。</p>
</blockquote>
<h2 data-id="heading-0">一、前言</h2>
<p>笔者从事前端开发已逾十年，其中近半时间深耕于前端基础设施团队，专注技术支撑工作。</p>
<p>在日常工作中，我发现无论是团队内部还是业务侧的同学，在排查复杂、疑难问题时，常常陷入思维混乱、在错误的方向上反复试探，最终耗费大量时间却徒劳无功的困境。</p>
<p>所幸，因岗位性质所致，我亲身经历并解决过的各类“疑难杂症”可谓数不胜数。基于这些宝贵的实战经验，我系统地总结了一套问题定位与解决的方法论。旨在帮助你在面对复杂问题时，能快速理清头绪、找准方向，从容、高效地解决问题。</p>
<h2 data-id="heading-1">二、共识</h2>
<p>在开始之前，我们必须达成一项核心共识：解决复杂问题，本质上是一场严密的逻辑推理。 唯有坚守逻辑，才能跳出思维混乱的泥潭，避免在错误的方向上反复打转。</p>
<p>逻辑是一个抽象的概念，为避免歧义，我首先阐明自己对它的认识与理解。仅以此为共识基础，你需要在长期分析问题的过程中构建、践行自己的“逻辑”。</p>
<ol>
<li>逻辑，是严谨的因果链
<ul>
<li>它要求我们就像侦探一样，基于线索提出假设，并通过实验快速验证，继而用环环相扣、确凿的证据，构建坚实的推理链条，最终得到“真相”这个答案。</li>
</ul>
</li>
<li>逻辑，是科学的论证方法
<ul>
<li>就像控制变量法，在其他条件完全一致时，结果的改变才能唯一地归因于那个被改变的变量。这是构建有效逻辑的基石。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">三、实践</h2>
<p>下面这几条，已经刻进我的DNA里，成了遇到问题后的条件反射。你可以把它看作一个排查流程，但不必死板照搬，关键是形成这种思维习惯。</p>
<ol>
<li>
<p>先彻底搞懂问题</p>
<ul>
<li>花足够的时间，把问题的现象、发生的场景、稳定的复现步骤搞清楚后再行动。</li>
<li>千万不要犯经验主义错误，才听一两句描述就自动联想为某个已知问题，盲目下手。</li>
</ul>
</li>
<li>
<p>依靠直觉快速验证</p>
<ul>
<li>没错，解决问题最快的方式就是依靠直觉。依靠你多年积累的经验、对系统的熟悉度。觉得“这儿可能有问题”或者“跟上次那个Bug很像”，就立刻去验证或者直接上解决方案。这是最效率的做法。</li>
<li>经验主义”在这里上大分，但千万不要思维定式，如果验证下来不对，果断止损，下一步。</li>
</ul>
</li>
<li>
<p>搜搜看，常有意外之喜</p>
<ul>
<li>你遇到的难题，很可能已被千万程序员踩过一遍。去搜索引擎、去技术社区、去官方Issues里找找看，说不定有惊喜。</li>
<li>工具方面推荐：搜索引擎（如必应、AI问答）、技术社区（如掘金、知乎）、官方渠道（MDN、GitHub Issues）。至于百度与CSDN……珍爱生命，尽早远离。</li>
</ul>
</li>
<li>
<p>展现真正的技术：删、比、问</p>
<ul>
<li>删。通过删除/注释代码，不断缩小问题出现的范围；或者通过编写最简Demo，找到最小复现条件。</li>
<li>比。对比正常与异常场景，从环境、网络、账号、依赖到代码逻辑逐一比较，差异点往往就是破案关键线索。 </li>
<li>问。把清晰的复现步骤和关键代码喂给AI，它有时能提供意想不到的分析视角。</li>
</ul>
</li>
<li>
<p>做好复盘，沉淀为直觉</p>
<ul>
<li>问题解决后，及时记录总结，构建个人案例库。这正是你未来“直觉”的来源。</li>
<li>《程序员的思维修炼》把这种依靠“直觉”解决问题的能力，作为区分专家与学徒的关键。</li>
<li>记录至少应包括：问题现象、原因分析、解决方案、复盘改进。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-3">四、感悟</h2>
<ol>
<li>
<p>及时求助</p>
<ul>
<li>
<p>每个人都有自身局限性，你不可能解决所有问题。及时向同事或更资深的人求助，没什么难为情的。</p>
</li>
<li>
<p>寻求帮助前做好功课，并不会降低别人对你的评价</p>
</li>
<li>
<p>功课的内容至少包含，问题的现象、自己已经做的分析猜测以及尝试，最好有个文档</p>
</li>
</ul>
</li>
<li>
<p>沟通与商务，也是解决方案</p>
<ul>
<li>不是所有问题都需要用技术硬解。有些问题在技术层面解决成本极高，或者本身就是由沟通误解、商务限制引起的。此时，推动沟通或调整需求，往往是更优解。</li>
</ul>
</li>
<li>
<p>最后，所有的方法都只是技巧，高效、正确的解决问题根本上还依赖技术和经验的长期积累。与君共勉，加油！</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端高频面试题之Vue（高级篇）]]></title>    <link>https://juejin.cn/post/7571972751529017380</link>    <guid>https://juejin.cn/post/7571972751529017380</guid>    <pubDate>2025-11-13T13:00:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571972751529017380" data-draft-id="7571815573933801535" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端高频面试题之Vue（高级篇）"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2025-11-13T13:00:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端高频面试题之Vue（高级篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T13:00:21.000Z" title="Thu Nov 13 2025 13:00:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、说一下 Vue.js 的响应式原理</h2>
<h3 data-id="heading-1">1.1 Vue2 响应式原理</h3>
<p>核心原理就是通过 <code>Object.defineProperty</code> 对对象属性进行劫持，重新定义对象的 <code>getter</code> 和 <code>setter</code>，在 <code>getter</code> 取值时收集依赖，在 <code>setter</code> 修改值时触发依赖更新，更新页面。</p>
<p>Vue2 对数组和对象做了两种不同方式的处理。</p>
<p><strong>监听对象变化：</strong></p>
<p>针对对象来说，Vue 会循环遍历对象的每一个属性，用 defineReactive 重新定义 <code>getter</code> 和 <code>setter</code>。</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">target,key,value</span>){
    <span class="hljs-title function_">observer</span>(value);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target,key,{ ¸v
        <span class="hljs-title function_">get</span>(<span class="hljs-params"/>){
            <span class="hljs-comment">// ... 收集依赖逻辑</span>
            <span class="hljs-keyword">return</span> value;
        },
        <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>){
            <span class="hljs-keyword">if</span> (value !== newValue) {
                value = newValue;
                <span class="hljs-title function_">observer</span>(newValue) <span class="hljs-comment">// 把新设置的值包装成响应式</span>
            }
            <span class="hljs-comment">// ...触发依赖更新逻辑</span>
        }
    })
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observer</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> data !== <span class="hljs-string">'object'</span>){
        <span class="hljs-keyword">return</span> data
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> data){
        <span class="hljs-title function_">defineReactive</span>(data,key,data[key]);
    }
}
</code></pre>
<p><strong>监听数组变化：</strong></p>
<p>我们都知道，数组其实也是对象，同样可以用 <code>Object.defineProperty</code> 劫持数组的每一项，但如果数组有100万项，那就要调用 <code>Object.defineProperty</code> 一百万次，这样的话性能太低了。鉴于平时我们操作数组大都是采用数组提供的原生方法，于是 Vue 对数组重写原型链，在调用7个能改变自身的原生方法(<code>push</code>，<code>pop</code>，<code>shift</code>，<code>unshift</code>，<code>splice</code>，<code>sort</code>，<code>reverse</code>)时，通知页面进行刷新，具体实现过程如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 先拿到数组的原型</span>
<span class="hljs-keyword">const</span> oldArrayProtoMethods = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-comment">// 用Object.create创建一个以oldArrayProtoMethods为原型的对象</span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(oldArrayProtoMethods)
<span class="hljs-keyword">const</span> methods = [
    <span class="hljs-string">'push'</span>,
    <span class="hljs-string">'pop'</span>,
    <span class="hljs-string">'shift'</span>,
    <span class="hljs-string">'unshift'</span>,
    <span class="hljs-string">'sort'</span>,
    <span class="hljs-string">'reverse'</span>,
    <span class="hljs-string">'splice'</span>
]
methods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
    <span class="hljs-comment">// 给arrayMethods定义7个方法</span>
    arrayMethods[method] = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>){
        <span class="hljs-comment">// 先找到数组对应的原生方法进行调用</span>
        <span class="hljs-keyword">const</span> result = oldArrayProtoMethods[method].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
        <span class="hljs-comment">// 声明inserted，用来保存数组新增的数据</span>
        <span class="hljs-keyword">let</span> inserted
        <span class="hljs-comment">// __ob__是Observer类实例的一个属性，data中的每个对象都是一个Observer类的实例</span>
        <span class="hljs-keyword">const</span> ob = <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>
        <span class="hljs-keyword">switch</span>(method) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'push'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'unshift'</span>:
                inserted = args
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'splice'</span>:
                inserted = args.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)
            <span class="hljs-attr">default</span>:
                <span class="hljs-keyword">break</span>
        }
        <span class="hljs-comment">// 比如有新增的数据，新增数据也要被定义为响应式</span>
        <span class="hljs-keyword">if</span>(inserted) ob.<span class="hljs-title function_">observeArray</span>(inserted)
        <span class="hljs-comment">// 通知页面更新</span>
        ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
        <span class="hljs-keyword">return</span> result
    }
})
</code></pre>
<p><strong>Object.defineProperty的缺点：</strong></p>
<ol>
<li>无法监听新增属性和删除属性的变化，需要通过 <code>$set</code>、<code>$delete</code> 实现。</li>
<li>监测数组的索引性能太低，故而直接通过数组索引改值无法触发响应式。</li>
<li>初始化时需要一次性递归调用，性能较差。</li>
</ol>
<h3 data-id="heading-2">1.2 Vue3 的响应式改进</h3>
<p>Vue3 采用 <code>Proxy + Reflect</code> 配合实现响应式。能解决上述 <code>Object.defineProperty</code> 的所有缺陷，唯一缺点就是兼容性没有 <code>Object.defineProperty</code> 好。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> handler = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[key] === <span class="hljs-string">"object"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target[key], handler);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key);
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value</span>) {
    <span class="hljs-keyword">let</span> oldValue = target[key];
    <span class="hljs-keyword">if</span> (oldValue !== value) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },
};
<span class="hljs-keyword">let</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, handler);
</code></pre>
<h2 data-id="heading-3">2、介绍一下 Vue 中的 diff 算法？</h2>
<p>Vue 的 diff 算法是平级比较，不考虑跨级比较的情况。内部采用<strong>深度递归的方式 + 双指针</strong>的方式进行比较。</p>
<p><strong>比较过程:</strong></p>
<ol>
<li>先比较是否是相同节点。</li>
<li>相同节点比较属性,并复用老节点。</li>
<li>比较儿子节点，考虑老节点和新节点儿子的情况。</li>
<li>优化比较：头头、尾尾、头尾、尾头。</li>
<li>比对查找进行复用。</li>
</ol>
<p>Vue3 在这个比较过程的基础上增加了<strong>最长递增子序列</strong>实现diff算法。</p>
<ul>
<li>找出不需要移动的现有节点。</li>
<li>只对需要移动的节点进行操作。</li>
<li>最小化 DOM 操作次数。</li>
</ul>
<h2 data-id="heading-4">3、Vue 的模板编译原理是什么？</h2>
<p>Vue 中的模板编译就是把我们写的 <code>template</code> 转换为渲染函数(<code>render function</code>) 的过程，它主要经历3个步骤：</p>
<ol>
<li><strong>解析（Parse）</strong>：将 template 模板转换成 ast 抽象语法树。</li>
<li><strong>优化（Optimize）</strong>：对静态节点做静态标记，减少 diff 过程中的比对。</li>
<li><strong>生成（Generate）</strong>：重新生成代码，将 ast 抽象语法数转化成可执行的渲染函数代码。</li>
</ol>
<h3 data-id="heading-5">3.1 解析阶段</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>用 HTML 解析器将模板解析为 AST。</li>
<li>AST中用 js 对象描述模板，里面包含了元素类型、属性、子节点等信息。</li>
<li>解析指令（<code>v-for、v-if</code>）和事件（<code>@click</code>）、插值表达式<code>{{}}</code>等 vue 语法。</li>
</ul>
<h3 data-id="heading-6">3.2 优化阶段</h3>
<ul>
<li>遍历上一步生成的 ast，标记静态节点，比如用 <code>v-once</code> 的节点，以及没有用到响应式数据的节点。</li>
<li>标记静态根节点，避免不必要的渲染。</li>
</ul>
<h3 data-id="heading-7">3.3 代码生成阶段</h3>
<p>vue2 解析结果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">with</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, {
      <span class="hljs-attr">attrs</span>: {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"app"</span>
      }
    }, [<span class="hljs-title function_">_c</span>(<span class="hljs-string">'p'</span>, [<span class="hljs-title function_">_v</span>(<span class="hljs-title function_">_s</span>(message))])])
  }
}
</code></pre>
<ul>
<li><code>_c</code>: 是 createElement 的别名，用于创建 VNode。</li>
<li><code>_v</code>: 创建文本 VNode。</li>
<li><code>_s</code>: 是 toString 的别名，用于将值转换为字符串。</li>
</ul>
<p>vue3 解析结果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { toDisplayString <span class="hljs-keyword">as</span> _toDisplayString, createElementVNode <span class="hljs-keyword">as</span> _createElementVNode, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {
  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"div"</span>, { <span class="hljs-attr">id</span>: <span class="hljs-string">"app"</span> }, [
    <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">_toDisplayString</span>(_ctx.<span class="hljs-property">message</span>), <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>)
  ]))
}
</code></pre>
<ul>
<li><code>_openBlock</code>: 开启一个"block"区域，用于收集动态子节点。</li>
<li><code>_createElementBlock</code>: 创建一个块级虚拟 DOM 节点。</li>
<li><code>_createElementVNode</code>: 创建一个普通虚拟 DOM 节点。</li>
<li><code>_toDisplayString</code>: 将响应式数据 _ctx.message 转换为显示字符串，或者处理 null/undefined 等值，确保它们能正确渲染为空白字符串。</li>
</ul>
<p>vue2在线编译：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftemplate-explorer.vuejs.org%2F" target="_blank" title="https://template-explorer.vuejs.org/" ref="nofollow noopener noreferrer">template-explorer.vuejs.org/</a>。</p>
<p>vue3在线编译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.template-explorer.vuejs.org%2F" target="_blank" title="https://v2.template-explorer.vuejs.org/" ref="nofollow noopener noreferrer">v2.template-explorer.vuejs.org/</a>。</p>
<p><strong>运行时+编译(runtime-compiler) vs 仅运行时(runtime-only)：</strong></p>
<ol>
<li>完整版（运行时+编译）：
<ul>
<li>包含编译模块，可以写 template 模版。</li>
<li>体积较大（～30kb）。</li>
</ul>
</li>
<li>仅运行时版本
<ul>
<li>需要在打包时使用 <code>vue-loader</code> 进行编译。</li>
<li>体积较小（～20kb）。</li>
</ul>
</li>
</ol>
<p>平时开发项目推荐使用仅运行时(runtime-only)版本。</p>
<p><strong>编译后的特点：</strong></p>
<ol>
<li><strong>虚拟DOM</strong>：渲染函数生成的是虚拟DOM节点(VNode)。</li>
<li><strong>响应式绑定</strong>：渲染函数中的变量会自动建立依赖关系。</li>
<li><strong>性能优化</strong>：通过静态节点标记减少不必要的更新。</li>
</ol>
<h2 data-id="heading-8">4、v-show 和 v-if 的原理</h2>
<p>简单来说，<code>v-if</code> 内部是通过一个三元表达式来实现的，而 <code>v-show</code> 则是通过控制 DOM 元素的 <code>display</code> 属性来实现的。</p>
<p>v-if 源码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">genIfConditions</span> (
    <span class="hljs-attr">conditions</span>: <span class="hljs-title class_">ASTIfConditions</span>,
    <span class="hljs-attr">state</span>: <span class="hljs-title class_">CodegenState</span>,
    altGen?: <span class="hljs-title class_">Function</span>,
    altEmpty?: string
    ): string {
    <span class="hljs-keyword">if</span> (!conditions.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> altEmpty || <span class="hljs-string">'_e()'</span>
    }
    <span class="hljs-keyword">const</span> condition = conditions.<span class="hljs-title function_">shift</span>()
    <span class="hljs-keyword">if</span> (condition.<span class="hljs-property">exp</span>) {   <span class="hljs-comment">// 如果有表达式</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`(<span class="hljs-subst">${condition.exp}</span>)?<span class="hljs-subst">${ // 将表达式作为条件拼接成元素
        genTernaryExp(condition.block)
        }</span>:<span class="hljs-subst">${
        genIfConditions(conditions, state, altGen, altEmpty)
        }</span>`</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${genTernaryExp(condition.block)}</span>`</span> <span class="hljs-comment">// 没有表达式直接生成元素 像v-else</span>
    }

    <span class="hljs-comment">// v-if with v-once should generate code like (a)?_m(0):_m(1)</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">genTernaryExp</span> (el) {
        <span class="hljs-keyword">return</span> altGen
        ? <span class="hljs-title function_">altGen</span>(el, state)
        : el.<span class="hljs-property">once</span>
            ? <span class="hljs-title function_">genOnce</span>(el, state)
            : <span class="hljs-title function_">genElement</span>(el, state)
    }
}
</code></pre>
<p>v-show 源码：</p>
<pre><code class="hljs language-js" lang="js">{
    bind (<span class="hljs-attr">el</span>: any, { value }: <span class="hljs-title class_">VNodeDirective</span>, <span class="hljs-attr">vnode</span>: <span class="hljs-title class_">VNodeWithData</span>) {
    <span class="hljs-keyword">const</span> originalDisplay = el.<span class="hljs-property">__vOriginalDisplay</span> =
        el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span> ? <span class="hljs-string">''</span> : el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> <span class="hljs-comment">// 获取原始显示值</span>
        el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = value ? originalDisplay : <span class="hljs-string">'none'</span> <span class="hljs-comment">// 根据属性控制显示或者隐藏</span>
    }  
} 
</code></pre>
<h2 data-id="heading-9">5、v-if 和 v-for  哪个优先级更高？为什么？</h2>
<ul>
<li>vue2 中 <code>v-for</code> 的优先级比 <code>v-if</code> 高，它们作用于一个节点上会导致先循环后对每一项进行判断，浪费性能。</li>
<li>vue3 中 <code>v-if</code> 的优先级比 <code>v-for</code> 高，这就会导致 <code>v-if</code> 中的条件无法访问 <code>v-for</code> 作用域名中定义的变量别名。</li>
</ul>
<pre><code class="hljs language-vue" lang="vue">&lt;li v-for="item in arr" v-if="item.visible"&gt;
  {{ item}}
&lt;/li&gt;
</code></pre>
<p>以上代码在 <code>vue3</code> 的编译结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { renderList <span class="hljs-keyword">as</span> _renderList, <span class="hljs-title class_">Fragment</span> <span class="hljs-keyword">as</span> _Fragment, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock, toDisplayString <span class="hljs-keyword">as</span> _toDisplayString, createCommentVNode <span class="hljs-keyword">as</span> _createCommentVNode } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {
  <span class="hljs-keyword">return</span> (_ctx.<span class="hljs-property">item</span>.<span class="hljs-property">visible</span>)
    ? (<span class="hljs-title function_">_openBlock</span>(<span class="hljs-literal">true</span>), <span class="hljs-title function_">_createElementBlock</span>(_Fragment, { <span class="hljs-attr">key</span>: <span class="hljs-number">0</span> }, <span class="hljs-title function_">_renderList</span>(_ctx.<span class="hljs-property">arr</span>, <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"li"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">_toDisplayString</span>(item), <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>))
      }), <span class="hljs-number">256</span> <span class="hljs-comment">/* UNKEYED_FRAGMENT */</span>))
    : <span class="hljs-title function_">_createCommentVNode</span>(<span class="hljs-string">"v-if"</span>, <span class="hljs-literal">true</span>)
}
</code></pre>
<p>可以看出 <code>vue3</code> 在编译时会先判断 <code>v-if</code>，然后再走 <code>v-for</code> 的循环，所以在 <code>v-if</code> 中自然就无法访问 <code>v-for</code> 作用域名中定义的变量别名。</p>
<p>这样的写法在 vue3 中会抛出一个警告⚠️，<code>[Vue warn]: Property "item" was accessed during render but is not defined on instance</code>，导致渲染失败。</p>
<p>以上代码在 <code>vue2</code> 还不能直接编译，因为 <code>vue2</code> 的组件需要一个根节点，所以我们在外层加一个 <code>div</code>：</p>
<pre><code class="hljs language-js" lang="js">&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in arr"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"item.visible"</span>&gt;</span>
    {{ item}}
  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<p>其编译结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">with</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, <span class="hljs-title function_">_l</span>((arr), <span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) {
      <span class="hljs-keyword">return</span> (item.<span class="hljs-property">visible</span>) ? <span class="hljs-title function_">_c</span>(<span class="hljs-string">'li'</span>, [<span class="hljs-title function_">_v</span>(<span class="hljs-string">"\n    "</span> + <span class="hljs-title function_">_s</span>(item) + <span class="hljs-string">"\n  "</span>)]) :
        <span class="hljs-title function_">_e</span>()
    }), <span class="hljs-number">0</span>)
  }
}
</code></pre>
<p>很明显是先循环 <code>arr</code>，然后每一项再用 <code>item.visible</code> 去判断的，也印证了在 <code>vue2</code> 中， <code>v-for</code> 的优先级高于 <code>v-if</code>。</p>
<blockquote>
<p>所以不管是 <code>vue2</code> 还是 <code>vue3</code>，都不推荐同时使用 <code>v-if</code> 和 <code>v-for</code>，更好的方案是采用计算属性，或者在外层再包裹一个容器元素，将 <code>v-if</code> 作用在容器元素上。</p>
</blockquote>
<h2 data-id="heading-10">6、nextTick 的原理是什么？</h2>
<h3 data-id="heading-11">6.1 Vue2 的 nextTick：</h3>
<ul>
<li>首选微任务：
<ul>
<li><strong>Promise.resolve().then(flushCallbacks)</strong>：最常见，使用 Promise 创建微任务。</li>
<li><strong>MutationObserver</strong>：如果 Promise 不可用，创建一个文本节点，修改其内容触发 MutationObserver 的观察器回调。</li>
</ul>
</li>
<li>回退宏任务：
<ul>
<li><strong>setImmediate</strong>：如果环境支持 setImmediate，比如 node 环境，则会优先使用 setImmediate 。</li>
<li><strong>setTimeout(flushCallbacks, 0)</strong>：最后使用定时器。</li>
</ul>
</li>
</ul>
<p>这里体现了<strong>优雅降级</strong>的思想。</p>
<h3 data-id="heading-12">6.2 Vue3 的 nextTick：</h3>
<ul>
<li>由于 Vue3 不再考虑 promise 的兼容性，所以 nextTick 的实现原理就是 promise.then 方法。</li>
</ul>
<h2 data-id="heading-13">7、Vue.set 方法是如何实现的?</h2>
<p><strong>Vue2的实现</strong>：在 Vue 2 中，Vue.set 的实现主要位于 <code>src/core/observer/index.js</code> 中：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">set</span> (<span class="hljs-attr">target</span>: <span class="hljs-title class_">Array</span> | <span class="hljs-title class_">Object</span>, <span class="hljs-attr">key</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">val</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">any</span> {
    <span class="hljs-comment">// 1.如果是数组 Vue.set(array,1,100); 调用我们重写的splice方法 (这样可以更新视图)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(target) &amp;&amp; <span class="hljs-title function_">isValidArrayIndex</span>(key)) {
        target.<span class="hljs-property">length</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(target.<span class="hljs-property">length</span>, key)
        target.<span class="hljs-title function_">splice</span>(key, <span class="hljs-number">1</span>, val)
        <span class="hljs-keyword">return</span> val
    }
    <span class="hljs-comment">// 2.如果是对象本身的属性，则直接添加即可</span>
    <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> target &amp;&amp; !(key <span class="hljs-keyword">in</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)) {
        target[key] = val
        <span class="hljs-keyword">return</span> val
    }
    <span class="hljs-keyword">const</span> ob = (<span class="hljs-attr">target</span>: <span class="hljs-built_in">any</span>).<span class="hljs-property">__ob__</span>
    <span class="hljs-comment">// 3.如果是响应式的也不需要将其定义成响应式属性</span>
    <span class="hljs-keyword">if</span> (!ob) {
        target[key] = val
        <span class="hljs-keyword">return</span> val
    }
    <span class="hljs-comment">// 4.将属性定义成响应式的</span>
    <span class="hljs-title function_">defineReactive</span>(ob.<span class="hljs-property">value</span>, key, val)
    <span class="hljs-comment">// 5.通知视图更新</span>
    ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    <span class="hljs-keyword">return</span> val
}
</code></pre>
<p>Vue3 中 set 方法已经被移除，因为 proxy 天然弥补 vue2 响应式的缺陷。</p>
<h2 data-id="heading-14">8、Vue.use 是干什么的?原理是什么?</h2>
<p>Vue.use 是用来使用插件的，我们可以在插件中扩展全局组件、指令、原型方法等。</p>
<p>Vue.use 源码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Vue</span>.<span class="hljs-property">use</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">plugin: <span class="hljs-built_in">Function</span> | <span class="hljs-built_in">Object</span></span>) {
    <span class="hljs-comment">// 插件不能重复的加载</span>
    <span class="hljs-keyword">const</span> installedPlugins = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_installedPlugins</span> || (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_installedPlugins</span> = []))
    <span class="hljs-keyword">if</span> (installedPlugins.<span class="hljs-title function_">indexOf</span>(plugin) &gt; -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
    }
    <span class="hljs-comment">// additional parameters</span>
    <span class="hljs-keyword">const</span> args = <span class="hljs-title function_">toArray</span>(<span class="hljs-variable language_">arguments</span>, <span class="hljs-number">1</span>)
    args.<span class="hljs-title function_">unshift</span>(<span class="hljs-variable language_">this</span>)  <span class="hljs-comment">// install方法的第一个参数是Vue的构造函数，其他参数是Vue.use中除了第一个参数的其他参数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin.<span class="hljs-property">install</span> === <span class="hljs-string">'function'</span>) { <span class="hljs-comment">// 调用插件的install方法</span>
        plugin.<span class="hljs-property">install</span>.<span class="hljs-title function_">apply</span>(plugin, args)  <span class="hljs-title class_">Vue</span>.<span class="hljs-property">install</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">Vue,args</span>){}
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin === <span class="hljs-string">'function'</span>) { <span class="hljs-comment">// 插件本身是一个函数，直接让函数执行</span>
        plugin.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, args) 
    }
    installedPlugins.<span class="hljs-title function_">push</span>(plugin) <span class="hljs-comment">// 缓存插件</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
}
</code></pre>
<h2 data-id="heading-15">9、介绍下 Vue 中的 mixin，Vue3 为何不再推荐使用它？</h2>
<p>mixin 是 Vue 2 中一种复用组件逻辑的方式，允许将可复用的配置（data、methods、computed、lifecycle hooks 等）抽离成一个对象，然后通过 mixins: [] 合并到组件中。支持全局注入和局部注入。</p>
<ul>
<li>作用：抽离公共的业务逻辑</li>
<li>原理：类似“对象的继承”，当组件初始化时会调用 <code>mergeOptions</code> 方法进行合并，采用策略模式针对不同的属性进行合并。如果混入的数据和本身组件中的数据冲突，会采用“就近原则”以组件的数据为准。</li>
</ul>
<p><strong>mixin 的优点：</strong></p>
<ul>
<li>复用逻辑（如表单验证、权限判断）。</li>
<li>全局注入（如日志、埋点）。</li>
<li>减少重复代码。</li>
</ul>
<p><strong>mixin 中有很多缺陷：</strong></p>
<ul>
<li>命名冲突问题：mixin 中的变量、函数名可能会与组件中的重名。</li>
<li>依赖问题：</li>
<li>数据来源问题：</li>
</ul>
<p><strong>vue3 不再推荐使用它的理由如下：</strong></p>





























<table><thead><tr><th>问题</th><th>说明</th></tr></thead><tbody><tr><td><strong>1. 隐式依赖 &amp; 数据来源不明确</strong></td><td>组件行为来自多个 mixin，难以追踪 data、methods 是从哪里来的。</td></tr><tr><td><strong>2. 命名冲突</strong></td><td>多个 mixin 可能定义同名 data、methods，合并规则复杂（同名 methods 后者覆盖前者，data 合并为对象，同名 Key 后者覆盖前者）。</td></tr><tr><td><strong>3. 调试和维护困难</strong></td><td>父组件无法知道子组件内部有哪些 mixin 注入的属性，排查 bug 和调试困难。</td></tr><tr><td><strong>4. 不利于 Tree-shaking</strong></td><td>打包时难以移除未使用的 mixin 代码。</td></tr><tr><td><strong>5. 与 Composition API 理念冲突</strong></td><td>Mixin 是“横切关注点”，而 Composition API 强调显式、可组合的逻辑。</td></tr></tbody></table>
<p>Vue 3 推荐替代方案：Composition API + 可复用函数（Composables）。</p>



































<table><thead><tr><th>特性</th><th>Mixin</th><th>Composables</th></tr></thead><tbody><tr><td>数据来源明确</td><td>隐式</td><td>显式（import）</td></tr><tr><td>是否有命名冲突问题</td><td>有</td><td>无</td></tr><tr><td>逻辑封装</td><td>全局污染</td><td>按需引入</td></tr><tr><td>Tree-shaking 支持</td><td>差</td><td>好</td></tr><tr><td>TypeScript 支持</td><td>差</td><td>好</td></tr></tbody></table>
<p>对于全局混入（Global Mixin），Vue3 虽然提供了 <code>app.mixin()</code>，但不推荐，推荐使用:</p>
<ol>
<li><code>app.config.globalProperties</code>。</li>
<li><code>app.provide</code> 在顶层提供数据，组件通过 <code>inject</code> 方法消费数据。</li>
</ol>
<h2 data-id="heading-16">10、介绍下 Vue.js 中的函数式组件、异步组件和递归组件</h2>
<h3 data-id="heading-17">10.1 函数式组件（Functional Components）</h3>
<p>函数式组件是一种轻量级、无状态的组件形式。它们很像纯函数：接收 props，返回 虚拟 DOM（vnode）。函数式组件在渲染过程中不会创建组件实例 (也就是说，没有 this)，也不会触发常规的组件生命周期钩子。没有响应式系统、生命周期和实例的开销，函数式组件自然在渲染上更加高效和快速。</p>
<p>总而言之，函数式组件有<strong>无状态</strong>、<strong>无this</strong>、<strong>无生命周期</strong>、<strong>性能更高</strong>等特点。</p>
<p>使用场景：适合简单、静态的 UI 元素，如列表项或包装组件。</p>
<p>在 Vue 2 中，通过 <code>functional: true</code> 声明；在 Vue 3 中，函数式组件更简单，直接返回渲染函数。</p>
<p><strong>Vue2 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template functional&gt;
  &lt;div&gt;{{ props.msg }}&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>或者 js 形式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">functional</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'msg'</span>],
  <span class="hljs-title function_">render</span>(<span class="hljs-params">h, { props }</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, props.<span class="hljs-property">msg</span>);
  }
};
</code></pre>
<p><strong>Vue3 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { h } from 'vue';

const FunctionalComp = (props) =&gt; h('div', props.msg);
&lt;/script&gt;

&lt;template&gt;
  &lt;FunctionalComp msg="Hello Functional" /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-18">10.2 异步组件（Async Components）</h3>
<p>异步组件是一种懒加载（Lazy Loading）机制，用于按需加载组件代码，优化初始加载时间和性能。Vue 会动态导入组件，只有在使用时才下载和渲染，常用于路由或大型组件。</p>
<p><strong>特点：</strong></p>
<ul>
<li>通过 <code>import()</code> 动态加载，返回 Promise。</li>
<li>支持加载中（loading）、错误（error）和超时（timeout）处理。</li>
<li>在 Vue 3 中，使用 <code>defineAsyncComponent</code> 更规范，支持与 <code>&lt;Suspense&gt;</code> 结合（Vue 3 独有，用于统一处理异步）。</li>
</ul>
<p><strong>Vue2 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  components: {
    AsyncComp: () =&gt; import('./AsyncComp.vue')
  }
};
&lt;/script&gt;

&lt;template&gt;
  &lt;AsyncComp /&gt;
&lt;/template&gt;
</code></pre>
<p><strong>Vue3 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { defineAsyncComponent } from 'vue';

const AsyncComp = defineAsyncComponent(() =&gt; import('./AsyncComp.vue'));
&lt;/script&gt;

&lt;template&gt;
  &lt;Suspense&gt;
    &lt;template #default&gt;
      &lt;AsyncComp /&gt;
    &lt;/template&gt;
    &lt;template #fallback&gt;加载中...&lt;/template&gt;
  &lt;/Suspense&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-19">10.3 递归组件（Recursive Components）</h3>
<p>递归组件是指组件内部调用自身，用于处理树形或嵌套数据结构，如菜单、树视图或评论回复。Vue 支持组件自引用，但需注意避免无限循环（通过条件终止递归）。</p>
<p><strong>特点：</strong></p>
<ul>
<li>组件需有名称（<code>name</code> 选项），才能自引用。</li>
<li>常结合 <code>v-for</code> 和 props 传递数据。</li>
</ul>
<p><strong>Vue 2 示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="item in tree" :key="item.id"&gt;
      {{ item.name }}
      &lt;Tree v-if="item.children" :tree="item.children" /&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'Tree',  // 必须有 name
  props: ['tree']
};
&lt;/script&gt;
</code></pre>
<p><strong>Vue 3 示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { defineAsyncComponent } from 'vue';  // 可选：异步加载避免循环

const Tree = defineAsyncComponent(() =&gt; import('./Tree.vue'));  // 自引用
defineProps(['tree']);
&lt;/script&gt;

&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="item in tree" :key="item.id"&gt;
      {{ item.name }}
      &lt;Tree v-if="item.children" :tree="item.children" /&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-20">11、Vue.js 中的 vue-loader 是什么？</h2>
<p>Vue-loader 是一个专为 Vue.js 设计的 <code>Webpack loader</code>（加载器），其主要作用是将 Vue 的单文件组件（Single-File Components，简称 SFC，即 .vue 文件）转换为可执行的 JavaScript 模块。 它允许开发者以一种结构化的方式编写组件，将模板（template）、脚本（script）和样式（style）封装在同一个文件中，便于管理和维护。</p>
<p><strong>核心功能</strong>:</p>
<ul>
<li><strong>解析 SFC 文件</strong>：Vue-loader 会自动处理 <code>.vue</code> 文件中的三个部分：
<ul>
<li><strong>template 部分</strong>：编译为 Vue 的渲染函数（render function）。</li>
<li><strong>script 部分</strong>：提取为组件的 JavaScript 逻辑，支持 ES 模块和 TypeScript。</li>
<li><strong>style部分</strong>：处理 CSS，支持预处理器（如 Sass、Less）并可选地应用 scoped（作用域样式）或 CSS Modules。</li>
</ul>
</li>
<li><strong>热重载（Hot Module Replacement，HMR）</strong>：在开发模式下，支持组件的热更新，无需刷新页面即可看到变化，提高开发效率。</li>
<li><strong>自定义块（Custom Blocks）</strong>：支持扩展，如添加 <code>&lt;docs&gt;</code> 或其他自定义标签，用于文档生成或其他工具集成。</li>
<li><strong>预处理器支持</strong>：无缝集成 Babel、PostCSS 等工具链。</li>
</ul>
<h2 data-id="heading-21">12、Vue.extend 方法的作用？</h2>
<p><code>Vue.extend</code>方法可以作为基础 Vue 构造器，创建一个“子类”。参数是一个包含组件选项的对象。</p>
<p><strong>Vue2 示例：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> dialog = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">extend</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">"&lt;div&gt;{{hello}} {{world}}&lt;/div&gt;"</span>,
  <span class="hljs-attr">data</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">hello</span>: <span class="hljs-string">"hello"</span>,
      <span class="hljs-attr">world</span>: <span class="hljs-string">"world"</span>,
    };
  },
});
<span class="hljs-comment">// 创建 dialog 实例，并手动挂载到一个元素上。</span>
<span class="hljs-keyword">new</span> <span class="hljs-title function_">dialog</span>().$mount(<span class="hljs-string">"#app"</span>);
</code></pre>
<blockquote>
<p>注意：在 <code>Vue.extend</code> 中的 <code>data</code> 必须是一个函数，要不然会报错。</p>
</blockquote>
<p><strong>Vue3 示例：</strong></p>
<p>Vue3 中不在使用 Vue.extend 方法，而是采用render方法进行手动渲染。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Modal.vue --&gt;
&lt;template&gt;
  &lt;div class="modal"&gt;这是一个弹窗&lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'Modal',
}
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div id="box"&gt;&lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { h, render, createApp, onMounted } from 'vue'
import Modal from './Modal.vue'

onMounted(() =&gt; {
  render(h(Modal), document.getElementById('box'));
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-22">13、keep-alive 的原理</h2>
<p><code>&lt;keep-alive&gt;</code> 是 Vue.js 的内置组件，它的功能是在多个组件间动态切换时缓存被移除的组件实例，避免重复渲染和状态丢失，提高性能。它是一个抽象组件（abstract: true），不会渲染到 DOM，也不会出现在组件树中，而是通过插槽（slots）和自定义 render 函数实现缓存逻辑。</p>
<p><strong>核心实现机制：</strong></p>
<ol>
<li><strong>抽象组件与 Render 函数：</strong></li>
</ol>
<ul>
<li><code>&lt;keep-alive&gt;</code> 通过 render 函数处理包裹的内容（通常是动态组件，如 <code>&lt;component&gt;</code> 或 v-if 切换的组件）。</li>
<li>在 render 中，它从插槽获取子组件的 VNode（虚拟节点）。如果子组件有 key（推荐使用），则用 key 作为缓存标识；否则用组件的 tag 或 cid（组件 ID）。</li>
<li>如果组件已缓存，直接返回缓存的 VNode（设置 vnode.componentInstance.keepAlive = true 以标记缓存状态）；否则，渲染新实例并存入缓存。</li>
</ul>
<ol start="2">
<li><strong>缓存存储：</strong></li>
</ol>
<ul>
<li>内部使用一个对象（this.cache）作为缓存 Map，以 key 为键，值为 VNode 对象（包含组件实例）。</li>
<li>当组件首次渲染时，存入缓存；切换回时，从缓存取出，避免重新创建实例和执行 mounted 钩子。</li>
</ul>
<ol start="3">
<li><strong>LRU 缓存算法：</strong></li>
</ol>
<ul>
<li>支持 max 属性设置最大缓存数量（Vue 2.5+）。</li>
<li>使用 Least Recently Used（最近最少使用）算法：当缓存超出 max 时，删除最久未访问的组件（通过 this.keys 数组跟踪访问顺序）。</li>
<li>访问组件时，将其 key 移到数组末尾（最近使用）；超出时，删除数组开头的 key，并销毁对应实例（调用 $destroy）。</li>
</ul>
<ol start="4">
<li><strong>过滤规则（include/exclude）：</strong></li>
</ol>
<ul>
<li>通过 include（白名单）和 exclude（黑名单）属性决定哪些组件缓存，支持字符串、正则、数组或函数。</li>
<li>在 created 钩子中，监听这些 prop 的变化，并调用 pruneCache 更新缓存（移除不匹配的组件）。</li>
</ul>
<ol start="5">
<li><strong>生命周期钩子：</strong></li>
</ol>
<ul>
<li>缓存组件不会触发 destroyed/unmounted，而是使用 activated（激活时）和 deactivated（失活时）钩子。</li>
<li>这允许开发者在切换时管理状态（如暂停定时器），而非完全销毁。</li>
</ul>
<blockquote>
<p><strong>注意事项：</strong></p>
<ul>
<li>只缓存一个直接子组件（插槽内容），不支持多个。</li>
<li>Vue 3 中原理类似，但优化了 VNode 处理和 Composition API 支持。</li>
<li>潜在问题：缓存过多导致内存占用；需手动清理资源（如在 deactivated 中停止监听）。</li>
</ul>
</blockquote>
<h2 data-id="heading-23">14、Vue.js 中使用了哪些设计模式?</h2>
<h3 data-id="heading-24">1. 观察者模式 (Observer Pattern)</h3>
<ul>
<li>描述：Vue 的响应式系统使用观察者模式，通过 Proxy (Vue 3) 或 Object.defineProperty (Vue 2) 拦截对象属性的 get/set 操作。当数据变化时，通知订阅者（Watcher）更新视图。</li>
<li>应用：在 reactive() 函数中，返回 Proxy 对象，get 陷阱用于依赖收集 (track)，set 陷阱用于触发更新 (trigger)。</li>
<li>优势：实现了细粒度的变更检测，避免全局重渲染。</li>
</ul>
<h3 data-id="heading-25">2. 发布-订阅模式 (Publish-Subscribe Pattern)</h3>
<ul>
<li>描述：Vue 的事件系统和响应式通知机制采用 Pub-Sub 模式。数据变化时发布事件，订阅者（如组件渲染函数）接收并响应。</li>
<li>应用：在响应式系统中，trigger() 函数检索订阅者效果并调用它们；事件 API 如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>i</mi><mi>t</mi><mtext>和</mtext></mrow><annotation encoding="application/x-tex">emit 和 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mi</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">和</span></span></span></span></span>on 也基于此。</li>
<li>优势：解耦了数据生产者和消费者，支持异步更新。</li>
</ul>
<h3 data-id="heading-26">3. 代理模式 (Proxy Pattern)</h3>
<p>描述：Vue 3 的响应式系统直接使用 ES6 Proxy 作为代理层，拦截对象操作，实现透明的响应式。
应用：reactive() 返回 Proxy 对象，代理目标对象的访问和修改。
优势：比 Vue 2 的 defineProperty 更强大，支持数组和 Map/Set 等类型。</p>
<h3 data-id="heading-27">4. 策略模式 (Strategy Pattern)</h3>
<ul>
<li>描述：Vue 的虚拟 DOM diff 算法使用不同策略（如 key-based diff 或简单 patch）来优化更新。</li>
<li>应用：在渲染过程中，根据节点类型选择 diff 策略。</li>
<li>优势：最小化 DOM 操作，提高渲染效率。</li>
</ul>
<h3 data-id="heading-28">5. 单例模式(Singleton Pattern)</h3>
<ul>
<li>描述：整个程序中有且仅有一个实例。</li>
<li>应用：vuex 的 store 和插件。</li>
<li>优势：全局唯一、节约资源、便于管理。</li>
</ul>
<h3 data-id="heading-29">6. 工厂模式(Factory Pattern)</h3>
<ul>
<li>描述：提供了一种创建对象的方式，使得创建对象的过程与使用对象的过程分离。</li>
<li>应用：Vue2 中的组件创建，传入参数给 <code>createComponentInstance</code> 就可以创建实例。</li>
<li>优势：解藕，易于维护。</li>
</ul>
<h2 data-id="heading-30">15、Vue.js 应用中常见的内存泄漏来源有哪些？</h2>
<ol>
<li>未清理的事件监听器、定时器、动画</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { onMounted, onUnmounted } from 'vue';

let timer = null;
let controller = null;
let raf = null;

onMounted(() =&gt; {
  // 定时器
  timer = setInterval(() =&gt; {}, 1000);
  // 动画
  raf = requestAnimationFrame(() =&gt; {});
  // 事件监听
  window.addEventListener('resize', handleResize);
});

onUnmounted(() =&gt; {
  clearInterval(timer);
  cancelAnimationFrame(this.raf);
  window.removeEventListener('resize', handleResize);
});
&lt;/script&gt;
</code></pre>
<ol start="2">
<li>未移除的第三方库实例</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { onMounted, onUnmounted } from 'vue';

let chart = null;

onMounted(() =&gt; {
  chart = echarts.init(this.$refs.chart);
});

onUnmounted(() =&gt; {
  chart?.dispose();
});
&lt;/script&gt;
</code></pre>
<ol start="3">
<li>事件总线（Event Bus）未解绑</li>
</ol>
<p>vue2 用可以用 <code>new Vue</code> 全局创建一个事件总线实例，或者在组件中直接使用 <code>this.$on</code>、<code>this.$emit</code>、<code>this.$off</code>。</p>
<p>vue3 则需要借助第三库，比如 mitt 来实现事件总线。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { onMounted, onUnmounted } from 'vue';
import mitt from 'mitt';

// 创建事件总线实例
const emitter = mitt();

onMounted(() =&gt; {
  emitter.on('update', this.handler);
});

onUnmounted(() =&gt; {
  emitter.off('update', this.handler);
});
&lt;/script&gt;
</code></pre>
<p>顺便提一下， vue3 为啥去掉 <code>$on、$emit、$off</code> 这些 API，主要有以下原因：</p>
<ol>
<li>设计理念的调整</li>
</ol>
<p>Vue 3 更加注重组件间通信的明确性和可维护性。$on 这类事件 API 本质上是一种 "发布 - 订阅" 模式，容易导致组件间关系模糊（多个组件可能监听同一个事件，难以追踪事件来源和流向）。Vue 3 推荐使用更明确的通信方式，如：</p>
<ul>
<li>父子组件通过 props 和 emit 通信</li>
<li>跨组件通信使用 provide/inject 或 Pinia/Vuex 等状态管理库</li>
<li>复杂场景可使用专门的事件总线库（如 mitt</li>
</ul>
<ol start="2">
<li>与 Composition API 的适配</li>
</ol>
<p>Vue 3 主推的 Composition API 强调逻辑的封装和复用，而 $on 基于选项式 API 的实例方法，与 Composition API 的函数式思维不太契合。移除后，开发者可以更自然地使用响应式变量或第三方事件库来实现类似功能。</p>
<ol start="3">
<li>减少潜在问题</li>
</ol>
<ul>
<li>$on 容易导致内存泄漏（忘记解绑事件）</li>
<li>事件名称可能冲突（全局事件总线尤其明显）</li>
<li>不利于 TypeScript 类型推断，难以实现类型安全</li>
</ul>
<h3 data-id="heading-31">4. 未清理的 Watcher</h3>
<p>Vue 本身不会泄漏内存，泄漏几乎都来自<strong>开发者未清理的副作用</strong>。养成“创建即清理”的习惯，使用 <code>beforeDestroy</code> 或者 <code>onUnmounted</code> 集中清理，在使用 <code>keep-alive</code> 的组件中，视情况在 <code>deactivated</code> 钩子中清理资源。</p>
<h2 data-id="heading-32">16、Vue.js 中的性能优化手段有哪些？</h2>
<h3 data-id="heading-33">16.1 数据相关</h3>
<ul>
<li>Vue2 中数据层级不易过深，合理设置响应式数据；</li>
<li>Vue2 非响应式数据可以通过 Object.freeze()方法冻结属性；</li>
<li>合理使用 computed，利用其缓存能力提高性能。</li>
</ul>
<h3 data-id="heading-34">16.2 组件相关</h3>
<ul>
<li>控制组件粒度（Vue 采用组件级更新）；</li>
<li>合适场景可使用函数式组件（函数式组件开销低）；</li>
<li>采用异步组件（借助构建工具的分包的能力，减少主包体积）；</li>
<li>在组件卸载或者非激活状态及时清除定时器、DOM事件、事件总线、三方库的实例等。</li>
<li>v-on 按需监听、使用动态 watch 和及时销毁 watch。</li>
</ul>
<h3 data-id="heading-35">16.3 渲染相关</h3>
<ul>
<li>合理设置 key 属性；</li>
<li>v-show 和 v-if 的选取；</li>
<li>使用防抖、节流、分页、虚拟滚动、时间分片等策略；</li>
<li>合理使用 keep-alive 、v-once、v-memo 进行逻辑优化。</li>
</ul>
<h2 data-id="heading-36">结语</h2>
<p>以上是整理的 Vue 高级的高频面试题，如有错误或者可以优化的地方欢迎评论区指正，后续还会更新 Vuex 和 Vue-router 相关面试题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 ffmpeg 查看多媒体解码的配置信息]]></title>    <link>https://juejin.cn/post/7572164122234929162</link>    <guid>https://juejin.cn/post/7572164122234929162</guid>    <pubDate>2025-11-13T11:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572164122234929162" data-draft-id="7572012699628027931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 ffmpeg 查看多媒体解码的配置信息"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-13T11:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 ffmpeg 查看多媒体解码的配置信息
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:04:24.000Z" title="Thu Nov 13 2025 11:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 ffmpeg 查看多媒体解码的配置信息</h3>
<pre><code class="hljs language-c" lang="c">code@uos:~$ ffmpeg
ffmpeg version <span class="hljs-number">4.4</span><span class="hljs-number">.2</span>-deepin4 <span class="hljs-title function_">Copyright</span> <span class="hljs-params">(c)</span> 2000-2021 the FFmpeg developers
  built with gcc 8 <span class="hljs-params">(Uos <span class="hljs-number">8.3</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>-deepin1)</span>
  configuration: --prefix=/usr --extra-version=deepin4 --toolchain=hardened --libdir=/usr/lib/aarch64-linux-gnu --incdir=/usr/include/aarch64-linux-gnu --arch=arm64 --enable-gpl --disable-stripping --enable-avresample --disable-filter=resample --enable-gnutls --enable-ladspa --enable-libaom --enable-libass --enable-libbluray --enable-libbs2b --enable-libcaca --enable-libcdio --enable-libcodec2 --enable-libdav1d --enable-libflite --enable-libfontconfig --enable-libfreetype --enable-libfribidi --enable-libgme --enable-libgsm --enable-libjack --enable-libmp3lame --enable-libmysofa --enable-libopenjpeg --enable-libopenmpt --enable-libopus --enable-libpulse --enable-librabbitmq --enable-librubberband --enable-libshine --enable-libsnappy --enable-libsoxr --enable-libspeex --enable-libsrt --enable-libssh --enable-libtheora --enable-libtwolame --enable-libvidstab --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx265 --enable-libxml2 --enable-libxvid --enable-libzimg --enable-libzmq --enable-libzvbi --enable-lv2 --enable-omx --enable-ftomx --enable-openal --enable-opencl --enable-opengl --enable-sdl2 --enable-libdavs2 --enable-libxavs2 --disable-sndio --enable-pocketsphinx --enable-librsvg --enable-libdc1394 --enable-libdrm --enable-libiec61883 --enable-chromaprint --enable-frei0r --enable-libx264 --enable-shared
  libavutil      <span class="hljs-number">56.</span> <span class="hljs-number">70.100</span> / <span class="hljs-number">56.</span> <span class="hljs-number">70.100</span>
  libavcodec     <span class="hljs-number">58.134</span><span class="hljs-number">.100</span> / <span class="hljs-number">58.134</span><span class="hljs-number">.100</span>
  libavformat    <span class="hljs-number">58.</span> <span class="hljs-number">76.100</span> / <span class="hljs-number">58.</span> <span class="hljs-number">76.100</span>
  libavdevice    <span class="hljs-number">58.</span> <span class="hljs-number">13.100</span> / <span class="hljs-number">58.</span> <span class="hljs-number">13.100</span>
  libavfilter     <span class="hljs-number">7.110</span><span class="hljs-number">.100</span> /  <span class="hljs-number">7.110</span><span class="hljs-number">.100</span>
  libavresample   <span class="hljs-number">4.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0</span> /  <span class="hljs-number">4.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0</span>
  libswscale      <span class="hljs-number">5.</span>  <span class="hljs-number">9.100</span> /  <span class="hljs-number">5.</span>  <span class="hljs-number">9.100</span>
  libswresample   <span class="hljs-number">3.</span>  <span class="hljs-number">9.100</span> /  <span class="hljs-number">3.</span>  <span class="hljs-number">9.100</span>
  libpostproc    <span class="hljs-number">55.</span>  <span class="hljs-number">9.100</span> / <span class="hljs-number">55.</span>  <span class="hljs-number">9.100</span>
Hyper fast Audio and Video encoder
usage: ffmpeg [options] [[infile options] -i infile]... {[outfile options] outfile}...

Use -h to get full help or, even better, run <span class="hljs-string">'man ffmpeg'</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从面条代码到抽象能力：一个小表单场景里的前端成长四阶段]]></title>    <link>https://juejin.cn/post/7571972751528673316</link>    <guid>https://juejin.cn/post/7571972751528673316</guid>    <pubDate>2025-11-13T11:08:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571972751528673316" data-draft-id="7571815573933310015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从面条代码到抽象能力：一个小表单场景里的前端成长四阶段"/> <meta itemprop="keywords" content="前端,架构,设计模式"/> <meta itemprop="datePublished" content="2025-11-13T11:08:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮有石头"/> <meta itemprop="url" content="https://juejin.cn/user/3526889032395613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从面条代码到抽象能力：一个小表单场景里的前端成长四阶段
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889032395613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮有石头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:08:25.000Z" title="Thu Nov 13 2025 11:08:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常业务开发里，有一类场景出现频率极高：</p>
<ul>
<li>页面里有一个子表单组件（用 <code>ref</code> 引用）</li>
<li>提交前要让子表单先做一轮校验</li>
<li>校验通过后，从当前组件的数据里组装一个 payload 发给后端</li>
</ul>
<p>看起来再普通不过，比如下面这样一段代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
  <span class="hljs-comment">// 先让子表单组件校验</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>?.<span class="hljs-title function_">validate</span>();
  <span class="hljs-keyword">if</span> (!res || !res.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(res?.<span class="hljs-property">message</span> || <span class="hljs-string">'请完善自评信息'</span>);
  }
}

<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">reviewContent</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>,
  <span class="hljs-attr">attachmentList</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">attachmentList</span>,
};

<span class="hljs-comment">// 调接口……</span>
</code></pre>
<ul>
<li>有内容就校验；</li>
<li>校验不过就提示；</li>
<li>校验通过就拼一个 <code>payload</code> 去提交。</li>
</ul>
<p>很多前端的“表单生涯”，就是从这种<strong>线性、直接、带一点点面条味</strong>的代码开始的。</p>
<p>有意思的是：<br/>
<strong>同样一个需求，不同水平的前端，会写出完全不同层次的代码。</strong><br/>
从这个小例子出发，我们刚好可以串一条：<strong>初级 → 中级 → 高级 → 架构</strong> 的成长路径。</p>
<hr/>
<h2 data-id="heading-0">一、初级前端：能把流程串起来，就是胜利 🎯</h2>
<h3 data-id="heading-1">典型写法</h3>
<p>还是这段最“朴素”的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>?.<span class="hljs-title function_">validate</span>();
  <span class="hljs-keyword">if</span> (!res || !res.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(res?.<span class="hljs-property">message</span> || <span class="hljs-string">'请完善自评信息'</span>);
  }
}

<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">reviewContent</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>,
  <span class="hljs-attr">attachmentList</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">attachmentList</span>,
};

<span class="hljs-comment">// 调用接口，比如：api.submit(payload)</span>
</code></pre>
<p>逻辑完全按脑子里的流程来：</p>
<ol>
<li>有自评内容吗？（<code>this.reviewContent?.length</code>）</li>
<li>有的话就调用子表单的 <code>validate()</code></li>
<li>校验没过就弹一条错误消息</li>
<li>校验通过，拼一个请求体对象</li>
<li>调接口</li>
</ol>
<h3 data-id="heading-2">这个阶段的特点</h3>
<ul>
<li>
<p>✅ 优点：</p>
<ul>
<li>写起来非常快；</li>
<li>读起来也很直接——业务同学都能看懂。</li>
</ul>
</li>
<li>
<p>❌ 问题：</p>
<ul>
<li>
<p><strong>强耦合在当前组件</strong>：</p>
<ul>
<li>假设 <code>$refs.reviewForm</code> 一定存在；</li>
<li>假设 <code>validate()</code> 返回 <code>{ ok, message }</code>；</li>
<li>假设消息提示必须在这里做。</li>
</ul>
</li>
<li>
<p>逻辑、UI 提示、payload 结构全部糊在一起；</p>
</li>
<li>
<p>若别的页面也要搞“先校验子表单再组装 payload”，往往是复制粘贴一份再改改字段。</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>初级阶段的核心目标其实只有一个：  <strong>“我能把功能做出来。”</strong><br/>
想到哪写到哪，是完全正常的。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、中级前端：开始对“重复”和“耦合”过敏 🧩</h2>
<p>当你写了第三、第四个类似的提交流程后，会开始皱眉头：</p>
<ul>
<li>“怎么又是先 <code>validate</code> 再拼对象？”</li>
<li>“为什么到处都有同样的错误提示逻辑？”</li>
<li>“这要是修改字段名，不得全项目搜索一遍？”</li>
</ul>
<p>这时候，就会自然走向第一步抽象：<strong>提取工具函数</strong>。</p>
<h3 data-id="heading-4">第一步：按“模块”抽函数</h3>
<p>比如我们为这块自评表单单独写一个工具文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/reviewForm.js</span>

<span class="hljs-comment">// 校验自评表单</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateReview</span>(<span class="hljs-params">vm</span>) {
  <span class="hljs-keyword">if</span> (!vm.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
    <span class="hljs-comment">// 没填内容，视为不需要校验</span>
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
  }

  <span class="hljs-keyword">const</span> form = vm.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>;
  <span class="hljs-keyword">if</span> (!form || <span class="hljs-keyword">typeof</span> form.<span class="hljs-property">validate</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-comment">// 看业务需求，这里也可以认为是异常</span>
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
  }

  <span class="hljs-keyword">const</span> res = form.<span class="hljs-title function_">validate</span>();

  <span class="hljs-keyword">if</span> (!res || res.<span class="hljs-property">ok</span> === <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">const</span> msg = res?.<span class="hljs-property">message</span> || <span class="hljs-string">'自评信息校验未通过'</span>;
    vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: msg };
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
}

<span class="hljs-comment">// 构建自评 payload</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildReviewPayload</span>(<span class="hljs-params">vm</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">reviewContent</span>: vm.<span class="hljs-property">reviewContent</span>,
    <span class="hljs-attr">attachmentList</span>: vm.<span class="hljs-property">attachmentList</span>,
  };
}
</code></pre>
<p>组件里就可以这样用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { validateReview, buildReviewPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/reviewForm'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { ok } = <span class="hljs-title function_">validateReview</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">if</span> (!ok) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> payload = <span class="hljs-title function_">buildReviewPayload</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(payload);
}
</code></pre>
<h3 data-id="heading-5">中级前端的思维变化</h3>
<ul>
<li>不再满足于“能跑”，开始追求“以后好改一点”；</li>
<li>能意识到：可以把<strong>公共逻辑抽成函数</strong>，避免重复粘贴；</li>
<li>但抽象粒度通常还是<strong>按业务模块划分</strong>：<br/>
<code>reviewFormUtils</code>、<code>baseInfoUtils</code>、<code>priceUtils</code>……</li>
</ul>
<p>封装有了，代码好了不少，但还停留在“<strong>每个业务模块一套</strong>”的阶段：<br/>
每加一个新表单，又是一组新的 <code>validateXxx + buildXxxPayload</code>。</p>
<hr/>
<h2 data-id="heading-6">三、高级前端：从“封装”走向“抽象模式” 🧠</h2>
<p>再往前走一步，你会开始问更有意思的问题：</p>
<blockquote>
<ul>
<li>这些校验 + payload 的套路，本质上是不是一样的？</li>
<li>哪些是“流程”，哪些是“策略/细节”？</li>
<li>我能不能写一份通用逻辑，让所有表单都用？</li>
</ul>
</blockquote>
<h3 data-id="heading-7">1）提炼通用流程：getPayload</h3>
<p>观察会发现，每个表单提交流程几乎都是：</p>
<ol>
<li>根据某个 <code>ref</code> 拿到子表单组件；</li>
<li>调用 <code>validate()</code> 做校验；</li>
<li>如果失败 → 提示并中断；</li>
<li>如果成功 → 根据当前组件数据构造 payload。</li>
</ol>
<p>于是可以写出一个<strong>只关心流程</strong>的函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/getPayload.js</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Vue</span>} <span class="hljs-variable">vm</span> - 当前组件实例
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">buildPayload</span> - (vm) =&gt; payload 对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">String</span>} <span class="hljs-variable">refName</span> - 子表单的 ref 名
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPayload</span>(<span class="hljs-params">vm, buildPayload, refName</span>) {
  <span class="hljs-keyword">const</span> form = vm.<span class="hljs-property">$refs</span>?.[refName];

  <span class="hljs-comment">// 没有这个表单：视为无需校验，直接拼 payload</span>
  <span class="hljs-keyword">if</span> (!form || <span class="hljs-keyword">typeof</span> form.<span class="hljs-property">validate</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params">res</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!res || res.<span class="hljs-property">ok</span> === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">const</span> msg = res?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验未通过'</span>;
      vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  };

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> maybe = form.<span class="hljs-title function_">validate</span>();

    <span class="hljs-comment">// 支持 Promise 风格的 validate</span>
    <span class="hljs-keyword">if</span> (maybe &amp;&amp; <span class="hljs-keyword">typeof</span> maybe.<span class="hljs-property">then</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> maybe.<span class="hljs-title function_">then</span>(handle).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
        vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
      });
    }

    <span class="hljs-comment">// 同步返回</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">handle</span>(maybe);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
    vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
  }
}
</code></pre>
<p>组件使用示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { getPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/getPayload'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(
    <span class="hljs-variable language_">this</span>,
    <span class="hljs-function">(<span class="hljs-params">vm</span>) =&gt;</span> ({
      <span class="hljs-attr">reviewContent</span>: vm.<span class="hljs-property">reviewContent</span>,
      <span class="hljs-attr">attachmentList</span>: vm.<span class="hljs-property">attachmentList</span>,
    }),
    <span class="hljs-string">'reviewForm'</span>,
  );

  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
}
</code></pre>
<p>此时，<code>getPayload</code>：</p>
<ul>
<li>不再关心 payload 结构；</li>
<li>不再关心具体业务，只负责：<br/>
<strong>“找到表单 → 校验 → 错误处理 → 调用参数构造 payload”</strong> 。</li>
</ul>
<h3 data-id="heading-8">2）这里已经有设计模式的影子</h3>
<ul>
<li>
<p><code>getPayload</code> 像是一个小号的 <strong>模板方法模式</strong>（Template Method）：</p>
<ul>
<li>固定了流程：<strong>校验 → 错误处理 → 构建 payload</strong>；</li>
<li>把“payload 怎么构”这一段留给调用方（作为“模板中的可变步骤”）。</li>
</ul>
</li>
<li>
<p><code>buildPayload</code> 实际上也符合 <strong>策略模式</strong>（Strategy）的思路：</p>
<ul>
<li>同一个处理流程，根据不同策略函数（buildXxxPayload），构建不同业务数据。</li>
</ul>
</li>
</ul>
<p>高级前端的特点是：</p>
<ul>
<li>不只是“会封装”，而是会从逻辑里识别出<strong>模式</strong>；</li>
<li>能把“稳定的部分”和“易变的部分”拆开，分别对待；</li>
<li>会刻意让代码有<strong>可扩展点</strong>，而不是为了当前需求把东西都焊死。</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、前端架构：把“表单校验 + payload”升级成一种通用能力 🏗️</h2>
<p>再往上一个段位，前端架构考虑的不只是“这段代码写得好不好看”，而是：</p>
<blockquote>
<p>“这种模式在<strong>整个项目范围内</strong>，要怎么用、怎么演进？”</p>
</blockquote>
<p>如果全站有 N 个子表单，每个都要：</p>
<ul>
<li>ref + validate</li>
<li>再拼各自的 payload</li>
</ul>
<p>那么架构会更倾向于做一件事：</p>
<blockquote>
<p>把这种模式<strong>正式命名、抽象成一类‘能力’</strong>，然后由所有页面共同复用。</p>
</blockquote>
<h3 data-id="heading-10">1）用配置表达“表单 → payload”的映射关系</h3>
<p>先把“这个 ref 对应什么 payload”抽成配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// config/formPayloadMap.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formPayloadMap = {
  <span class="hljs-comment">// 自评表单</span>
  <span class="hljs-title function_">reviewForm</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">reviewContent</span>: vm.<span class="hljs-property">reviewContent</span>,
      <span class="hljs-attr">attachmentList</span>: vm.<span class="hljs-property">attachmentList</span>,
    };
  },

  <span class="hljs-comment">// 基础信息表单</span>
  <span class="hljs-title function_">baseForm</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">baseInfo</span>: vm.<span class="hljs-property">baseInfo</span>,
      <span class="hljs-attr">projectId</span>: vm.<span class="hljs-property">projectId</span>,
    };
  },

  <span class="hljs-comment">// 报价表单</span>
  <span class="hljs-title function_">priceForm</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">priceList</span>: vm.<span class="hljs-property">priceList</span>,
    };
  },

  <span class="hljs-comment">// ……</span>
};
</code></pre>
<h3 data-id="heading-11">2）getPayload：只需要传 refName</h3>
<p>现在改造 <code>getPayload</code>，变成只需要 <code>vm + refName</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/getPayload.js</span>
<span class="hljs-keyword">import</span> { formPayloadMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/config/formPayloadMap'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPayload</span>(<span class="hljs-params">vm, refName</span>) {
  <span class="hljs-keyword">const</span> buildPayload = formPayloadMap[refName];

  <span class="hljs-keyword">if</span> (!buildPayload) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[getPayload] 未配置 ref "<span class="hljs-subst">${refName}</span>" 对应的 payload 构造函数`</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">`未配置 <span class="hljs-subst">${refName}</span> 映射`</span> };
  }

  <span class="hljs-keyword">const</span> form = vm.<span class="hljs-property">$refs</span>?.[refName];

  <span class="hljs-comment">// 没有表单：视为无需校验，直接拼 payload</span>
  <span class="hljs-keyword">if</span> (!form || <span class="hljs-keyword">typeof</span> form.<span class="hljs-property">validate</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params">res</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!res || res.<span class="hljs-property">ok</span> === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">const</span> msg = res?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验未通过'</span>;
      vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  };

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> maybe = form.<span class="hljs-title function_">validate</span>();

    <span class="hljs-keyword">if</span> (maybe &amp;&amp; <span class="hljs-keyword">typeof</span> maybe.<span class="hljs-property">then</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> maybe
        .<span class="hljs-title function_">then</span>(handle)
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
          vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
        });
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">handle</span>(maybe);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
    vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
  }
}
</code></pre>
<p>组件里的使用体验就变成：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { getPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/getPayload'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'reviewForm'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
}
</code></pre>
<p><strong>调用方只需要关心：</strong></p>
<ul>
<li>“我这块用的是哪个 <code>ref</code> 的表单？”</li>
</ul>
<p>至于：</p>
<ul>
<li>要不要校验；</li>
<li>校验怎么提示；</li>
<li>payload 字段怎么组装；</li>
</ul>
<p>全部由统一机制 + 配置来处理。</p>
<h3 data-id="heading-12">3）架构视角下，多了几件事要考虑</h3>
<p>在这个阶段，思考重心变成了：</p>
<ul>
<li>
<p><strong>一致性</strong>：</p>
<ul>
<li>表单校验行为统一；</li>
<li>错误提示统一；</li>
<li>payload 结构的调整有统一入口。</li>
</ul>
</li>
<li>
<p><strong>可配置 / 可扩展</strong>：</p>
<ul>
<li>
<p>新增表单只需要：</p>
<ol>
<li>约定好 ref 名；</li>
<li>在 <code>formPayloadMap</code> 里加一个构造函数；</li>
</ol>
</li>
<li>
<p>对核心流程无侵入。</p>
</li>
</ul>
</li>
<li>
<p><strong>领域化</strong>：</p>
<ul>
<li>不再把子表单当成“某个页面的实现细节”，<br/>
而是当成领域里的一个“实体”：<br/>
<code>reviewForm</code>、<code>baseForm</code>、<code>priceForm</code>……</li>
<li>每个实体都有“校验 + 构造请求体”的统一接口。</li>
</ul>
</li>
<li>
<p><strong>长期演进成本</strong>：</p>
<ul>
<li>
<p>将来如果：</p>
<ul>
<li>改用新的 UI 表单库；</li>
<li>数据结构升级；</li>
<li>Vue2 升 Vue3；</li>
</ul>
</li>
<li>
<p>——绝大多数改动都可以限制在小范围内完成。</p>
</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、同一个需求，不同段位的差别到底是什么？</h2>
<p>用一句话概括每个阶段的心智模式：</p>
<ul>
<li>
<p><strong>初级前端：</strong></p>
<blockquote>
<p>“我能把这个流程串起来，让它跑起来。”</p>
</blockquote>
</li>
<li>
<p><strong>中级前端：</strong></p>
<blockquote>
<p>“这里有重复，我抽一个函数出来，大家都用。”</p>
</blockquote>
</li>
<li>
<p><strong>高级前端：</strong></p>
<blockquote>
<p>“这是一种模式。<br/>
哪些是稳定流程？哪些是可变策略？<br/>
我怎么设计抽象，让一份逻辑服务多个业务？”</p>
</blockquote>
</li>
<li>
<p><strong>前端架构：</strong></p>
<blockquote>
<p>“这不仅是个工具函数，而是一类‘通用能力’。<br/>
我要用机制 + 配置，把它变成整个项目的基础设施。”</p>
</blockquote>
</li>
</ul>
<p>而最初那段看起来有点“面条味”的代码，其实只是起点。</p>
<p><strong>当你开始嫌弃这类代码，开始思考“能不能抽象、能不能通用”的那一刻，你就已经在从“写代码的人”，向“设计代码的人”迈进了。</strong></p>
<hr/>
<p>如果你现在项目里正好到处都是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">xxx</span>.<span class="hljs-title function_">validate</span>();
<span class="hljs-comment">// if (!res.ok) ...</span>
<span class="hljs-comment">// const payload = { ... }</span>
</code></pre>
<p>不妨找一个最典型的提交流程，从：</p>
<blockquote>
<p>直接写 → 提取函数 → 通用流程 + 策略 → 配置化</p>
</blockquote>
<p>这四步路径里，选你觉得<strong>当前团队能接受的一步</strong>先落地。<br/>
技术成长很多时候不是换框架、追新库，而是搞定这种“看起来很小，但无处不在”的模式。</p>
<hr/>
<h2 data-id="heading-14">六、如果业务继续变复杂：往“建造者风格”进化 🧱</h2>
<p>前面那套 <code>getPayload + formPayloadMap</code>，足以覆盖<strong>大部分常规业务表单</strong>场景：</p>
<ul>
<li>每个表单的 payload 结构相对固定；</li>
<li>只要从 <code>vm</code> 上摘几个字段拼一下就行。</li>
</ul>
<p>但真实项目有时候会长成这样：</p>
<blockquote>
<ul>
<li>某些字段是「勾选了某个开关才需要拼进去」</li>
<li>某些片段要按不同的业务类型组合（比如：普通流程 / 加急流程 / 审批流）</li>
<li>有时还需要先异步拿一部分数据，再参与构建 payload</li>
</ul>
</blockquote>
<p>这时候，简单的：</p>
<pre><code class="hljs language-js" lang="js">formPayloadMap[refName](vm) {
  <span class="hljs-keyword">return</span> { ... };
}
</code></pre>
<p>就可能开始变得又长又丑了：里面充满 if / switch / 三元运算符。</p>
<p>这个时候，就可以考虑往**“建造者风格（Builder-style）”**上进化：<br/>
把一个“大 payload”拆成多个可组合的构建步骤。</p>
<h3 data-id="heading-15">1）一个简化版 PayloadBuilder 示例</h3>
<p>先来个最小可用的版本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// builders/PayloadBuilder.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayloadBuilder</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = {};
  }

  <span class="hljs-title function_">withReview</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">reviewContent</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">reviewContent</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withAttachments</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">attachmentList</span>)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">attachmentList</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">attachmentList</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withBaseInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">baseInfo</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">baseInfo</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">baseInfo</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 你可以继续加更多 withXxx 模块…</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>;
  }
}
</code></pre>
<p>使用方式（举个场景）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PayloadBuilder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/builders/PayloadBuilder'</span>;
<span class="hljs-keyword">import</span> { getPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/getPayload'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(
    <span class="hljs-variable language_">this</span>,
    <span class="hljs-function">(<span class="hljs-params">vm</span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayloadBuilder</span>(vm)
      .<span class="hljs-title function_">withReview</span>()
      .<span class="hljs-title function_">withAttachments</span>()
      .<span class="hljs-title function_">withBaseInfo</span>()
      .<span class="hljs-title function_">build</span>(),
    <span class="hljs-string">'reviewForm'</span>,
  );

  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
}
</code></pre>
<p>这里发生了几件事：</p>
<ul>
<li>
<p><code>getPayload</code> 仍然负责：<br/>
<strong>找到 ref → 校验 → 错误处理</strong>；</p>
</li>
<li>
<p>具体 payload 构建过程交给 <code>PayloadBuilder</code>：</p>
<ul>
<li>每个 <code>withXxx()</code> 负责一个独立模块；</li>
<li><code>build()</code> 返回最终对象。</li>
</ul>
</li>
</ul>
<p>好处是：</p>
<ul>
<li>
<p>可以非常自然地按业务组合：</p>
<ul>
<li>某些场景只要 <code>.withReview().withAttachments()</code></li>
<li>另一些场景再 <code>.withBaseInfo().withSomethingElse()</code></li>
</ul>
</li>
<li>
<p>单个 <code>withXxx</code> 内部逻辑变复杂也不怕，<strong>不会把一个函数搞成 200 行 if-else</strong>。</p>
</li>
</ul>
<h3 data-id="heading-16">2）什么时候才值得用 Builder 风格？</h3>
<p>简单粗暴的判断：</p>
<ul>
<li>
<p>✅ <strong>值得上 Builder 的情况</strong>：</p>
<ul>
<li>payload 真的是**「很多块拼起来」**的；</li>
<li>不同业务场景需要「选择性启用某些块」；</li>
<li>每块内部逻辑都可能变得很复杂（多条件、多分支、甚至异步）。</li>
</ul>
</li>
<li>
<p>❌ <strong>没必要上 Builder 的情况</strong>：</p>
<ul>
<li>只是把 3～5 个字段丢进对象里；</li>
<li>变动很少，大部分字段都是 1:1 映射；</li>
<li>没有复杂的组合逻辑。</li>
</ul>
</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p>Builder 风格的价值，在于<strong>把一个复杂构建过程拆成多个可组合的小模块</strong>。<br/>
如果你的业务没有复杂到这个程度，<br/>
现在这套 <code>formPayloadMap[refName](vm)</code> + 少量 if，其实已经刚刚好。</p>
</blockquote>
<h3 data-id="heading-17">3）和前面几级抽象的关系</h3>
<p>可以把这几层理解成「渐进增强」：</p>
<ul>
<li>
<p>Lv.3 高级前端：</p>
<blockquote>
<p><code>getPayload(vm, buildPayload, refName)</code></p>
</blockquote>
<ul>
<li>通用流程 + 策略函数，已经很好用了。</li>
</ul>
</li>
<li>
<p>Lv.4/架构阶段：</p>
<blockquote>
<p>配一个 <code>formPayloadMap[refName] = buildPayload</code></p>
</blockquote>
<ul>
<li>把“谁负责构建什么”集中管理。</li>
</ul>
</li>
<li>
<p>Builder 风格：</p>
<blockquote>
<p>在单个 <code>buildPayload(vm)</code> 的实现内部，如果逻辑变复杂，再引入 <code>PayloadBuilder</code></p>
</blockquote>
<ul>
<li>是对<strong>某一个领域的构建细节</strong>做进一步拆分，而不是推翻整个体系。</li>
</ul>
</li>
</ul>
<p>也就是说，<strong>Builder 不是替代前面的抽象，而是为「某个复杂 payload」加的一层“精细化构建工具”。</strong></p>
<hr/>
<h2 data-id="heading-18">七、这条路还能怎么走？一些扩展方向思路 🚀</h2>
<p>最后顺带聊几个可以继续进化的方向，你可以根据项目实际情况慢慢加，不用一口吃胖子。</p>
<h3 data-id="heading-19">1）配合 TypeScript 做强类型约束</h3>
<p>当前的写法都是 JS 靠自觉：</p>
<ul>
<li><code>formPayloadMap</code> 的 key/返回结构完全靠约定；</li>
<li><code>getPayload</code> 的返回 <code>{ ok, payload }</code> 也没有类型提示。</li>
</ul>
<p>如果用 TS，可以做几件事：</p>
<ul>
<li>
<p>为 <code>formPayloadMap</code> 建立一个统一的类型 Map：</p>
<ul>
<li>比如：<code>type FormPayloadMap = { reviewForm: ReviewPayload; baseForm: BasePayload; ... }</code></li>
</ul>
</li>
<li>
<p>让 <code>getPayload</code> 根据 <code>refName</code> 返回不同的 payload 类型（泛型 + 索引类型）；</p>
</li>
<li>
<p>给 <code>PayloadBuilder</code> 每个 <code>withXxx()</code> 加上返回类型约束，防止漏字段/写错字段名。</p>
</li>
</ul>
<p>好处是：<strong>一旦后端改了字段，TS 能第一时间把相关代码全标红</strong>，你就不需要靠“全局搜索 + 祈祷”。</p>
<h3 data-id="heading-20">2）统一成“多表单聚合”的流程</h3>
<p>很多真实页面不是只有一个子表单，而是：</p>
<blockquote>
<p>顶层页面 → N 个子块（基础信息、自评、报价、附件……）<br/>
最后统一点一个「提交」，要校验所有子块，组合所有 payload。</p>
</blockquote>
<p>在现有基础上，可以设计一个“多表单聚合器”，伪代码例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">collectAllPayloads</span>(<span class="hljs-params">vm, configList</span>) {
  <span class="hljs-keyword">const</span> allPayload = {};

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> cfg <span class="hljs-keyword">of</span> configList) {
    <span class="hljs-keyword">const</span> { refName, mountPoint } = cfg;
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(vm, refName);
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span> };

    <span class="hljs-comment">// mountPoint 决定这块 payload 挂在最终对象的哪里</span>
    allPayload[mountPoint] = res.<span class="hljs-property">payload</span>;
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: allPayload };
}
</code></pre>
<p>调用时：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">collectAllPayloads</span>(<span class="hljs-variable language_">this</span>, [
  { <span class="hljs-attr">refName</span>: <span class="hljs-string">'baseForm'</span>, <span class="hljs-attr">mountPoint</span>: <span class="hljs-string">'baseInfo'</span> },
  { <span class="hljs-attr">refName</span>: <span class="hljs-string">'reviewForm'</span>, <span class="hljs-attr">mountPoint</span>: <span class="hljs-string">'review'</span> },
  { <span class="hljs-attr">refName</span>: <span class="hljs-string">'priceForm'</span>, <span class="hljs-attr">mountPoint</span>: <span class="hljs-string">'price'</span> },
]);

<span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;
<span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
</code></pre>
<p>这时：</p>
<ul>
<li><code>getPayload</code> 是<strong>单个表单的能力</strong>；</li>
<li><code>collectAllPayloads</code> 是<strong>多表单聚合的能力</strong>；</li>
<li>再配合 Builder，你就有了一条从“字段级 → 模块级 → 表单级 → 全页级”的构建链路。</li>
</ul>
<h3 data-id="heading-21">3）把“校验 + 构建”做成可插拔中间件</h3>
<p>现在，<code>getPayload</code> 里，校验逻辑顺序是写死的：</p>
<blockquote>
<p>校验 → 错误提示 → 构建 payload</p>
</blockquote>
<p>如果业务越来越复杂，可以考虑做成类似“中间件管线”的模式，比如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pipeline = [
  validateFormStep,
  extraAsyncCheckStep,
  normalizeDataStep,
  buildPayloadStep,
];

<span class="hljs-title function_">runPipeline</span>(vm, refName, pipeline);
</code></pre>
<p>每个 step 接收 context（比如 <code>{ vm, form, payload }</code>），按顺序处理。<br/>
这样你可以：</p>
<ul>
<li>在某些表单插入额外风控校验；</li>
<li>在某些表单前面加数据归一化逻辑；</li>
<li>保持主流程一致但允许个性化“插片”。</li>
</ul>
<p>这就已经非常接近「前端领域里自己的 mini-framework」了。</p>
<h3 data-id="heading-22">4）跨框架 / 跨项目复用</h3>
<p>你现在的设计，其实已经很容易跨栈：</p>
<ul>
<li>ref 概念：React 可以用 <code>useRef</code> + <code>forwardRef</code> 来模拟；</li>
<li>validate：绝大多数表单库都有类似 API；</li>
<li>payload 构造：和框架无关，本身就是纯函数/Builder。</li>
</ul>
<p>如果你有多个项目（Vue2/Vue3/React 混合），理论上可以：</p>
<ul>
<li>把“构建规则”和“校验规则”抽到一个独立 npm 包；</li>
<li>每个项目只写一层很薄的“外壳”，适配自己的 ref/组件体系。</li>
</ul>
<p>这就是从“一个项目里的抽象”，升级成“多项目共享的领域包”。</p>
<hr/>
<p>你现在这整套，从最开始那段：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>?.<span class="hljs-title function_">validate</span>();
  <span class="hljs-keyword">if</span> (!res || !res.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(res?.<span class="hljs-property">message</span> || <span class="hljs-string">'请完善自评信息'</span>);
  }
}
<span class="hljs-keyword">const</span> payload = { ... };
</code></pre>
<p>一路演进到：</p>
<ul>
<li>通用 <code>getPayload</code></li>
<li>配置化 <code>formPayloadMap</code></li>
<li>按需引入 <code>PayloadBuilder</code> 做复杂构建</li>
<li>再往外是多表单聚合、类型约束、流水线、跨项目复用</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 dmesg 查看内核的实时日志]]></title>    <link>https://juejin.cn/post/7572002432451002377</link>    <guid>https://juejin.cn/post/7572002432451002377</guid>    <pubDate>2025-11-13T11:13:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432451002377" data-draft-id="7572021695294128178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 dmesg 查看内核的实时日志"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-13T11:13:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 dmesg 查看内核的实时日志
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:13:13.000Z" title="Thu Nov 13 2025 11:13:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 dmesg 查看内核的实时日志</h3>
<pre><code class="hljs language-c" lang="c">root@uos:~<span class="hljs-meta"># dmesg -wH</span>
[<span class="hljs-number">11</span>月<span class="hljs-number">10</span> <span class="hljs-number">14</span>:<span class="hljs-number">59</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">1</span>][HISI_DRM_HEAPS D]:do_alloc_memory: need alloc size=<span class="hljs-number">0x3000</span>, now pool size=<span class="hljs-number">0x1a60000</span>
[  +<span class="hljs-number">0.000000</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">2</span>][HISI_DRM_HEAPS D]:do_alloc_memory: alloc success, now pool size=<span class="hljs-number">0x1a60000</span>
[  +<span class="hljs-number">0.000031</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">3</span>][DPU_DRM D]:hisi_drm_alloc_buf: alloc drm bufsuccess, size=<span class="hljs-number">0x3000</span>
[  +<span class="hljs-number">0.000854</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">4</span>][DPU_DRM D]:hisi_drm_gem_check_flags: heap id = <span class="hljs-number">0</span>, attrs = <span class="hljs-number">5</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 journalctl 查看系统的实时日志]]></title>    <link>https://juejin.cn/post/7572012699628044315</link>    <guid>https://juejin.cn/post/7572012699628044315</guid>    <pubDate>2025-11-13T11:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572012699628044315" data-draft-id="7572021695294144562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 journalctl 查看系统的实时日志"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-13T11:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 journalctl 查看系统的实时日志
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:15:24.000Z" title="Thu Nov 13 2025 11:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 journalctl 查看系统的实时日志</h3>
<pre><code class="hljs language-c" lang="c">root@uos:~<span class="hljs-meta"># journalctl -f</span>
-- Logs begin at Mon <span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-03</span> <span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">06</span> CST. --
<span class="hljs-number">11</span>月 <span class="hljs-number">10</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">09</span> uos kernel: [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">5</span>][HISI_DRM_HEAPS D]:do_alloc_memory: alloc success, now pool size=<span class="hljs-number">0x2450000</span>
<span class="hljs-number">11</span>月 <span class="hljs-number">10</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">09</span> uos kernel: [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">6</span>][DPU_DRM D]:hisi_drm_alloc_buf: alloc drm bufsuccess, size=<span class="hljs-number">0x3000</span>
<span class="hljs-number">11</span>月 <span class="hljs-number">10</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">09</span> uos kernel: [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">7</span>][DPU_DRM D]:hisi_drm_gem_check_flags: heap id = <span class="hljs-number">0</span>, attrs = <span class="hljs-number">5</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战]]></title>    <link>https://juejin.cn/post/7571815997068329000</link>    <guid>https://juejin.cn/post/7571815997068329000</guid>    <pubDate>2025-11-13T11:22:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068329000" data-draft-id="7534551428461527074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T11:22:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:22:33.000Z" title="Thu Nov 13 2025 11:22:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战</h2>
<blockquote>
<p>告别臃肿监控系统，1核1GB内存打造企业级基础设施监控平台</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa9f9d4b34d64998a93e4b43234254a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763637752&amp;x-signature=6YlPbcKwz9EymaOr6QEOYT3kEUY%3D" alt="Checkmate监控仪表盘示例" loading="lazy"/><br/>
（Checkmate现代化的监控界面展示）</p>
<h3 data-id="heading-1">引言：当传统监控工具成为运维的负担</h3>
<p>凌晨3点，刺耳的告警声划破寂静——不是业务故障，而是<strong>监控系统自身崩溃</strong>。这是许多运维团队的真实噩梦。传统监控方案如Zabbix、Nagios面临<strong>三大痛点</strong>：资源消耗巨大（单节点常需8GB+内存）、配置复杂（学习曲线陡峭）、扩展困难（集群部署复杂）。而<strong>Checkmate</strong>作为开源监控领域的新星，凭借<strong>轻量化架构（1核1GB即可运行）+ 零配置自动发现 + Prometheus生态兼容</strong>的三重优势，正在GitHub掀起风暴。本文将带你从核心原理到企业实战，全面掌握这款现代监控利器。</p>
<hr/>
<h3 data-id="heading-2">一、Checkmate核心优势：重新定义基础设施监控</h3>
<h4 data-id="heading-3">1. 轻量化架构设计（与传统方案对比）</h4>



































<table><thead><tr><th><strong>指标</strong></th><th>Zabbix</th><th>Prometheus</th><th><strong>Checkmate</strong></th></tr></thead><tbody><tr><td>内存占用</td><td>4GB+</td><td>2GB+</td><td><strong>&lt;512MB</strong></td></tr><tr><td>启动速度</td><td>90秒+</td><td>30秒</td><td><strong>&lt;5秒</strong></td></tr><tr><td>配置复杂度</td><td>高（Web+配置文件）</td><td>中（YAML文件）</td><td><strong>零配置自动发现</strong></td></tr><tr><td>部署方式</td><td>复杂</td><td>中等</td><td><strong>单二进制文件</strong></td></tr></tbody></table>
<h4 data-id="heading-4">2. 智能发现引擎</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[网络扫描] --&gt; B(自动识别设备类型)
    B --&gt; C{设备类型}
    C --&gt;|Linux服务器| D[采集CPU/内存/磁盘]
    C --&gt;|网络设备| E[采集SNMP指标]
    C --&gt;|K8s集群| F[发现Pod/Node]
    D --&gt; G[生成监控面板]
    E --&gt; G
    F --&gt; G
</code></pre>
<ul>
<li><strong>跨协议支持</strong>：SSH、SNMP、WMI、IPMI一网打尽</li>
<li><strong>拓扑自动绘制</strong>：实时生成网络设备连接关系图</li>
<li><strong>无代理监控</strong>：90%指标通过标准协议获取，无需安装客户端</li>
</ul>
<h4 data-id="heading-5">3. 告警智能降噪</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 智能告警聚合算法示例</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">deduplicate_alerts</span>(<span class="hljs-params">alerts</span>):
    <span class="hljs-comment"># 基于指纹的告警分组</span>
    grouped = group_by(alerts, <span class="hljs-keyword">lambda</span> a: a.fingerprint)
    
    <span class="hljs-comment"># 时间窗口聚合（5分钟内相同告警合并）</span>
    <span class="hljs-keyword">for</span> group <span class="hljs-keyword">in</span> grouped:
        <span class="hljs-keyword">if</span> time_range(group) &lt; <span class="hljs-number">5</span>*<span class="hljs-number">60</span>:
            send_alert(summarize(group))  <span class="hljs-comment"># 发送聚合通知</span>
</code></pre>
<h4 data-id="heading-6">4. 开放生态系统</h4>
<ul>
<li><strong>PromQL兼容</strong>：直接使用Prometheus查询语法</li>
<li><strong>Grafana原生支持</strong>：作为数据源无缝接入</li>
<li><strong>Webhook集成</strong>：告警推送至钉钉/企业微信/Slack</li>
<li><strong>API驱动</strong>：完整RESTful接口支持自动化运维</li>
</ul>
<hr/>
<h3 data-id="heading-7">二、十分钟极速部署：全场景安装指南</h3>
<h4 data-id="heading-8">1. Docker单机部署（开发测试）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建持久化目录</span>
<span class="hljs-built_in">mkdir</span> -p /data/checkmate/{config,data}

<span class="hljs-comment"># 启动容器</span>
docker run -d --name checkmate \
  -p 8080:8080 \
  -v /data/checkmate/config:/etc/checkmate \
  -v /data/checkmate/data:/var/lib/checkmate \
  checkmate/checkmate:latest
</code></pre>
<p>访问 <code>http://localhost:8080</code> 使用默认账号 <code>admin/checkmate</code></p>
<h4 data-id="heading-9">2. Kubernetes集群部署（生产推荐）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># checkmate-deployment.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">checkmate</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">checkmate</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">checkmate/checkmate:2.4.0</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/checkmate</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">CONFIG_PATH</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"/etc/checkmate/config.yaml"</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 配置自动发现</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">checkmate-config</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">config.yaml:</span> <span class="hljs-string">|
    discovery:
      cidr: 10.0.0.0/16
      protocols: [ssh, snmp]
    alerting:
      receivers:
        - name: ops-team
          type: webhook
          url: "https://oapi.dingtalk.com/robot/send?access_token=xxx"
</span></code></pre>
<h4 data-id="heading-10">3. 裸机二进制部署（边缘场景）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载最新版 (Linux amd64)</span>
wget https://github.com/checkmate-dev/checkmate/releases/latest/checkmate-linux-amd64

<span class="hljs-comment"># 设置为可执行文件</span>
<span class="hljs-built_in">chmod</span> +x checkmate-linux-amd64

<span class="hljs-comment"># 创建配置文件</span>
<span class="hljs-built_in">cat</span> &gt; checkmate.yaml &lt;&lt;<span class="hljs-string">EOF
discovery:
  cidr: 192.168.1.0/24
  snmp_community: public
EOF</span>

<span class="hljs-comment"># 启动服务</span>
./checkmate-linux-amd64 --config checkmate.yaml
</code></pre>
<hr/>
<h3 data-id="heading-11">三、企业级实战：三大场景深度优化</h3>
<h4 data-id="heading-12">案例1：电商大促资源保障体系</h4>
<p><strong>挑战</strong>：</p>
<ul>
<li>黑五期间200+服务器资源监控</li>
<li>秒级发现CPU过载/磁盘爆满</li>
</ul>
<p><strong>Checkmate方案</strong>：</p>
<ol>
<li><strong>动态基线告警</strong>：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 基于历史数据的动态阈值</span>
<span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighCPU</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">cpu_usage</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">(avg_over_time(cpu_usage[7d])</span> <span class="hljs-string">+</span> <span class="hljs-number">2</span><span class="hljs-string">*stddev_over_time(cpu_usage[7d]))</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
</code></pre>
</li>
<li><strong>资源拓扑视图</strong>：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d62c12ab44469bb361beb8f29c25b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763637752&amp;x-signature=iTNZqmbt%2F4s%2F7kki8O367LCtvlE%3D" alt="资源拓扑图" loading="lazy"/><br/>
（自动生成的服务器资源关联图）</li>
<li><strong>效果</strong>：
<ul>
<li>提前30分钟预测3台服务器过载</li>
<li>自动扩容避免200万美元损失</li>
</ul>
</li>
</ol>
<h4 data-id="heading-13">案例2：金融行业合规监控</h4>
<p><strong>需求</strong>：</p>
<ul>
<li>满足等保2.0对网络设备的监控要求</li>
<li>审计日志保留180天</li>
</ul>
<p><strong>实施路径</strong>：</p>
<ol>
<li><strong>网络设备发现</strong>：
<pre><code class="hljs language-bash" lang="bash">discovery:
  cidr: 10.1.0.0/16
  protocols: [snmp]
  snmp_communities: 
    - <span class="hljs-string">"finance@2024"</span> <span class="hljs-comment"># 加密Community</span>
</code></pre>
</li>
<li><strong>合规报表生成</strong>：
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">/* 审计日志查询示例 */</span>
<span class="hljs-keyword">SELECT</span> device_ip, check_item, <span class="hljs-keyword">result</span> 
<span class="hljs-keyword">FROM</span> audit_logs 
<span class="hljs-keyword">WHERE</span> <span class="hljs-type">timestamp</span> <span class="hljs-operator">&gt;</span> now() <span class="hljs-operator">-</span> <span class="hljs-type">interval</span> <span class="hljs-string">'180 days'</span>;
</code></pre>
</li>
<li><strong>安全加固</strong>：
<ul>
<li>TLS双向认证</li>
<li>基于RBAC的权限控制</li>
</ul>
</li>
</ol>
<h4 data-id="heading-14">案例3：智能制造工厂监控</h4>
<p><strong>场景</strong>：</p>
<ul>
<li>50+工业PLC设备</li>
<li>5个分散厂区</li>
</ul>
<p><strong>创新方案</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[厂区1] --&gt;|OPC UA| B(边缘Checkmate节点)
    C[厂区2] --&gt;|Modbus| B
    B --&gt; D[中心监控平台]
    D --&gt; E[大屏可视化]
</code></pre>
<ul>
<li><strong>边缘计算</strong>：树莓派运行Checkmate（内存&lt;300MB）</li>
<li><strong>协议转换</strong>：工业协议转Prometheus指标</li>
<li><strong>效果</strong>：<br/>
设备故障发现时间从<strong>8小时缩短至15分钟</strong></li>
</ul>
<hr/>
<h3 data-id="heading-15">四、最佳实践：效能最大化配置</h3>
<h4 data-id="heading-16">1. 监控项优化配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config.yaml 关键配置</span>
<span class="hljs-attr">metrics:</span>
  <span class="hljs-comment"># Linux服务器</span>
  <span class="hljs-attr">linux:</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">15s</span>
    <span class="hljs-attr">items:</span> [<span class="hljs-string">cpu</span>, <span class="hljs-string">memory</span>, <span class="hljs-string">disk</span>, <span class="hljs-string">network</span>]
  
  <span class="hljs-comment"># 网络设备</span>
  <span class="hljs-attr">snmp:</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
    <span class="hljs-attr">oids:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>  <span class="hljs-comment"># 系统运行时间</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span> <span class="hljs-comment"># 入站流量</span>
  
  <span class="hljs-comment"># 自定义脚本</span>
  <span class="hljs-attr">custom_script:</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">"/scripts/check_application.sh"</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">1m</span>
</code></pre>
<h4 data-id="heading-17">2. 告警分级策略</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">alerting:</span>
  <span class="hljs-attr">routes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> 
        <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
      <span class="hljs-attr">receiver:</span> <span class="hljs-string">'ops-pager'</span>
      
    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> 
        <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
      <span class="hljs-attr">receiver:</span> <span class="hljs-string">'ops-slack'</span>
  
  <span class="hljs-attr">templates:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">application_alert</span>
      <span class="hljs-attr">body:</span> <span class="hljs-string">|
        [{{ .Status | toUpper }}] {{ .AlertName }}
        {{ range .Annotations.SortedPairs }}{{ .Name }}: {{ .Value }}
        {{ end }}
</span></code></pre>
<h4 data-id="heading-18">3. 性能调优参数</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 高负载环境启动参数</span>
./checkmate \
  --max-routines=500 \     <span class="hljs-comment"># 最大并发协程数</span>
  --tsdb-retention=30d \   <span class="hljs-comment"># 数据保留周期</span>
  --query-timeout=10s      <span class="hljs-comment"># 查询超时设置</span>
</code></pre>
<hr/>
<h3 data-id="heading-19">五、与传统方案对比：为什么选择Checkmate？</h3>



































<table><thead><tr><th><strong>场景</strong></th><th>Zabbix</th><th>Prometheus+Alertmanager</th><th><strong>Checkmate</strong></th></tr></thead><tbody><tr><td><strong>资源受限环境</strong></td><td>难以运行</td><td>需要多组件</td><td>✅ 单节点运行</td></tr><tr><td><strong>配置复杂度</strong></td><td>高（学习曲线陡）</td><td>中（需配采集器）</td><td>✅ 自动发现零配置</td></tr><tr><td><strong>扩展性</strong></td><td>垂直扩展</td><td>水平扩展复杂</td><td>✅ 原生集群支持</td></tr><tr><td><strong>维护成本</strong></td><td>高（专职运维）</td><td>中</td><td>✅ 无人值守</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-20">六、未来演进：AI驱动的智能运维</h3>
<p>Checkmate 3.0路线图：</p>
<ol>
<li><strong>异常预测引擎</strong>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LSTM时序预测伪代码</span>
model = LSTM().train(historical_metrics)
anomaly_score = model.predict(current_values)
<span class="hljs-keyword">if</span> anomaly_score &gt; threshold:
    trigger_alert(<span class="hljs-string">"预测故障: 磁盘将在4小时内写满"</span>)
</code></pre>
</li>
<li><strong>根因分析系统</strong>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
  A[MySQL慢查询] --&gt; B(关联分析)
  B --&gt; C[发现磁盘IO延迟]
  C --&gt; D[定位RAID卡故障]
</code></pre>
</li>
<li><strong>自然语言交互</strong>
<blockquote>
<p>用户：“为什么订单服务延迟升高？”<br/>
Checkmate：“检测到数据库主节点CPU使用率95%，建议扩容”</p>
</blockquote>
</li>
</ol>
<hr/>
<h3 data-id="heading-21">结语：监控系统的新范式</h3>
<p>Checkmate用<strong>极简主义解决复杂问题</strong>的理念，诠释了现代运维工具的真谛——它不追求功能的大而全，而是聚焦在<strong>自动化发现、轻量高效、智能分析</strong>的核心价值上。正如某互联网公司CTO所言：“<strong>当我们把监控系统内存从32GB降到1GB时，才真正体会到技术选型的价值</strong>”。</p>
<p><strong>立即体验</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d -p 8080:8080 checkmate/checkmate
</code></pre>
<p><strong>资源获取</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcheckmate-dev%2Fcheckmate" target="_blank" title="https://github.com/checkmate-dev/checkmate" ref="nofollow noopener noreferrer">GitHub项目主页</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheckmate.dev%2Fdocs%2Fenterprise" target="_blank" title="https://checkmate.dev/docs/enterprise" ref="nofollow noopener noreferrer">企业部署白皮书</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheckmate.dev%2Fconfig-builder" target="_blank" title="https://checkmate.dev/config-builder" ref="nofollow noopener noreferrer">监控配置生成器</a></li>
</ul>
<p><strong>讨论话题</strong>：<br/>
👉 你在监控系统使用中遇到的最大痛点是什么？<br/>
👉 最期待Checkmate新增哪些智能特性？</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OkHttp网络框架设计]]></title>    <link>https://juejin.cn/post/7571815997068345384</link>    <guid>https://juejin.cn/post/7571815997068345384</guid>    <pubDate>2025-11-13T11:25:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068345384" data-draft-id="7571768210716409871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OkHttp网络框架设计"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-13T11:25:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="杨充"/> <meta itemprop="url" content="https://juejin.cn/user/1978776659695784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OkHttp网络框架设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1978776659695784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    杨充
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:25:11.000Z" title="Thu Nov 13 2025 11:25:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OkHttp网络框架设计</h2>
<h5 data-id="heading-1">目录介绍</h5>
<ul>
<li>01.整体概述介绍
<ul>
<li>1.1 概述介绍</li>
<li>1.2 核心特性说明</li>
<li>1.3 技术架构概览</li>
<li>1.4 问题思考</li>
</ul>
</li>
<li>02.核心架构设计
<ul>
<li>2.1 整体架构设计</li>
<li>2.2 整体设计思路</li>
<li>2.3 核心组件关系图</li>
</ul>
</li>
<li>03.核心组件详解
<ul>
<li>3.1 OkHttpClient</li>
<li>3.2 Request请求封装</li>
<li>3.3 Call请求执行接口</li>
<li>3.4 Dispatcher调度器</li>
<li>3.5 拦截器机制</li>
<li>3.6 Response返回</li>
</ul>
</li>
<li>04.核心流程分析
<ul>
<li>4.1 请求执行流程</li>
<li>4.2 连接管理流程</li>
<li>4.3 缓存处理流程</li>
</ul>
</li>
<li>05.关键技术特性
<ul>
<li>5.1 连接池管理</li>
<li>5.2 HTTP/2支持</li>
<li>5.3 缓存机制设计</li>
<li>5.4 安全特性设计</li>
<li>5.5 SSL/TLS流程</li>
</ul>
</li>
<li>06.性能优化策略
<ul>
<li>6.1 连接复用</li>
<li>6.2 请求合并</li>
<li>6.3 压缩传输</li>
<li>6.4 内存管理</li>
</ul>
</li>
<li>07.使用示例说明
<ul>
<li>7.1 基本使用</li>
<li>7.2 高级配置</li>
<li>7.3 统计请求耗时</li>
</ul>
</li>
<li>08.最佳实践
<ul>
<li>8.1 客户端复用</li>
<li>8.2 请求取消</li>
<li>8.3 错误处理</li>
</ul>
</li>
<li>09.架构优势
<ul>
<li>9.1 设计模式应用</li>
<li>9.2 SOLID原则体现</li>
<li>9.3 性能优势</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">01.整体概述介绍</h3>
<h4 data-id="heading-3">1.1 概述介绍</h4>
<p>OkHttp是一个高效的HTTP客户端库，专为Android和Java应用程序设计。基于OkHttpLib模块的源码分析，详细阐述了OkHttp的架构设计、核心组件、工作流程和技术特性。避免陷入代码细节，着重理解设计思想！</p>
<h4 data-id="heading-4">1.2 核心特性说明</h4>
<ul>
<li><strong>高效的HTTP/2支持</strong>：完整支持HTTP/2协议，包括连接复用、服务器推送等特性</li>
<li><strong>连接池管理</strong>：自动管理连接池，减少连接建立的开销</li>
<li><strong>透明的GZIP压缩</strong>：自动处理响应压缩，减少网络传输量</li>
<li><strong>响应缓存</strong>：支持HTTP缓存，避免重复请求</li>
<li><strong>请求/响应拦截</strong>：灵活的拦截器机制，支持请求和响应的定制化处理</li>
<li><strong>故障恢复</strong>：自动重试机制，提高网络请求的可靠性</li>
</ul>
<h4 data-id="heading-5">1.3 技术架构概览</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[应用层] --&gt; B[OkHttpClient]
    B --&gt; C[Request Builder]
    B --&gt; D[Call Factory]
    D --&gt; E[RealCall]
    E --&gt; F[Dispatcher]
    F --&gt; G[拦截器链]
    G --&gt; H[网络层]
    
    subgraph "拦截器链"
        I[应用拦截器]
        J[重试拦截器]
        K[桥接拦截器]
        L[缓存拦截器]
        M[连接拦截器]
        N[网络拦截器]
        O[服务器调用拦截器]
    end
    
    G --&gt; I
    I --&gt; J
    J --&gt; K
    K --&gt; L
    L --&gt; M
    M --&gt; N
    N --&gt; O
</code></pre>
<h4 data-id="heading-6">1.4 问题思考</h4>
<ul>
<li>OkHttp设计：OkHttp整体设计思路是什么样的？request和respond分别如何设计？如何设计call请求操作？</li>
<li>OkHttp同步异步：如何设计同步和异步请求？同步操作做了什么？异步操作如何处理逻辑？</li>
<li>OkHttp拦截器：拦截器是如何设计的？为什么需要拦截器？拦截器如何处理拦截，和向下分发逻辑？如何做重试机制的设计？</li>
<li>OkHttp缓存：如何设计缓存？什么情况下会用到网络缓存？缓存拦截器的核心思想是什么？</li>
<li>OkHttp分发器：同步和异步请求的Dispatcher是如何调度的？设计的巧妙之处是什么？</li>
<li>OkHttp线程池：使用了什么线程池？是如何管理线程任务？跟普通线程池使用有何区别？</li>
</ul>
<h3 data-id="heading-7">02.核心架构设计</h3>
<h4 data-id="heading-8">2.1 整体架构设计</h4>
<p>OkHttp采用分层架构设计，主要包括以下几个层次：</p>
<ol>
<li><strong>应用接口层</strong>：提供简洁的API接口，包括OkHttpClient、Request、Response等</li>
<li><strong>调度管理层</strong>：Dispatcher负责请求的调度和线程池管理</li>
<li><strong>拦截器链层</strong>：责任链模式实现的拦截器机制</li>
<li><strong>连接管理层</strong>：ConnectionPool管理HTTP连接的复用</li>
<li><strong>网络传输层</strong>：底层的Socket连接和数据传输</li>
</ol>
<h4 data-id="heading-9">2.2 整体设计思路</h4>
<p>网络请求到响应大概流程图如下所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a03f661a0294b1693e804639ca02227~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2o5YWF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763637911&amp;x-signature=CUOeO9WdYpqlmWf3uboLitviqTM%3D" alt="image" loading="lazy"/></p>
<p>整体设计思路大概如下所示：</p>
<ul>
<li>第一步：创建OkHttpClient对象，由于创建这个对象十分复杂，因此采用builder设计模式构造</li>
<li>第二步：包装Request请求体对象，主要是存放url，header，get请求，post请求等等属性</li>
<li>第三步：通过newCall(request)去创建一个call请求</li>
<li>第四步：开始执行同步execute或者enqueue请求，这里会使用到线程池</li>
<li>第五步：添加各种拦截器，缓存拦截器，</li>
<li>第六步：处理缓存拦截，数据复用的技术逻辑</li>
<li>第七步：创建连接请求的操作，给服务端发送请求</li>
<li>第八步：获取返回response数据，这里主要是处理code和body数据</li>
</ul>
<h4 data-id="heading-10">2.3 核心组件关系图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class OkHttpClient {
        +Dispatcher dispatcher
        +List~Interceptor~ interceptors
        +ConnectionPool connectionPool
        +Cache cache
        +newCall(Request) Call
    }
    
    class Request {
        +HttpUrl url
        +String method
        +Headers headers
        +RequestBody body
    }
    
    class Call {
        &lt;&lt;interface&gt;&gt;
        +execute() Response
        +enqueue(Callback) void
        +cancel() void
    }
    
    class RealCall {
        +OkHttpClient client
        +Request originalRequest
        +execute() Response
        +enqueue(Callback) void
    }
    
    class Dispatcher {
        +ExecutorService executorService
        +Deque~AsyncCall~ readyAsyncCalls
        +Deque~AsyncCall~ runningAsyncCalls
        +Deque~RealCall~ runningSyncCalls
    }
    
    class Interceptor {
        &lt;&lt;interface&gt;&gt;
        +intercept(Chain) Response
    }
    
    OkHttpClient --&gt; Request : creates
    OkHttpClient --&gt; Call : newCall()
    Call &lt;|-- RealCall : implements
    OkHttpClient --&gt; Dispatcher : uses
    RealCall --&gt; Interceptor : uses
</code></pre>
<h3 data-id="heading-11">03.核心组件详解</h3>
<h4 data-id="heading-12">3.1 OkHttpClient</h4>
<p>OkHttpClient是整个框架的入口点，采用建造者模式进行配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OkHttpClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span>, Call.Factory, WebSocket.Factory {
    <span class="hljs-keyword">final</span> Dispatcher dispatcher;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> Proxy proxy;
    <span class="hljs-keyword">final</span> List&lt;Protocol&gt; protocols;
    <span class="hljs-keyword">final</span> List&lt;ConnectionSpec&gt; connectionSpecs;
    <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; interceptors;
    <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; networkInterceptors;
    <span class="hljs-keyword">final</span> EventListener.Factory eventListenerFactory;
    <span class="hljs-keyword">final</span> ProxySelector proxySelector;
    <span class="hljs-keyword">final</span> CookieJar cookieJar;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> Cache cache;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> InternalCache internalCache;
    <span class="hljs-keyword">final</span> SocketFactory socketFactory;
    <span class="hljs-keyword">final</span> SSLSocketFactory sslSocketFactory;
    <span class="hljs-keyword">final</span> ConnectionPool connectionPool;
    <span class="hljs-comment">// ... 更多配置项</span>
}
</code></pre>
<p>创建OkHttpClient对象，主要是用于Api网络请求的对象。类似于初始化网络请求，可以设置超时时间，日志打印拦截器，代理，ssl校验，域名校验等等。</p>
<p><strong>主要职责</strong>：</p>
<ul>
<li>管理全局配置（超时、代理、SSL等）</li>
<li>创建Call对象</li>
<li>管理拦截器链</li>
<li>管理连接池和缓存</li>
</ul>
<h5 data-id="heading-13">3.1.1 创建流程架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始创建OkHttpClient] --&gt; B{使用方式}
    
    B --&gt;|默认构造| C[new OkHttpClient]
    B --&gt;|Builder模式| D[new OkHttpClient.Builder]
    
    C --&gt; E[使用默认配置]
    D --&gt; F[配置各种参数]
    
    E --&gt; G[创建默认组件]
    F --&gt; H[验证配置参数]
    
    G --&gt; I[初始化Dispatcher]
    H --&gt; I
    
    I --&gt; J[初始化ConnectionPool]
    J --&gt; K[初始化SSL配置]
    K --&gt; L[初始化拦截器链]
    L --&gt; M[初始化缓存配置]
    M --&gt; N[初始化超时配置]
    N --&gt; O[初始化事件监听器]
    O --&gt; P[创建OkHttpClient实例]
    
    P --&gt; Q[客户端就绪]
    
    style C fill:#e3f2fd
    style D fill:#f3e5f5
    style G fill:#e8f5e8
    style H fill:#fff3e0
    style Q fill:#c8e6c9
</code></pre>
<h5 data-id="heading-14">3.1.2 Builder模式原理</h5>
<p>OkHttpClient采用Builder模式的主要原因：</p>
<ol>
<li><strong>参数众多</strong>：OkHttpClient有30+个配置参数</li>
<li><strong>可选配置</strong>：大部分参数都有合理的默认值</li>
<li><strong>不可变性</strong>：创建后的OkHttpClient实例不可修改</li>
<li><strong>链式调用</strong>：提供流畅的API体验</li>
<li><strong>参数验证</strong>：在build()时统一验证参数合法性</li>
</ol>
<h5 data-id="heading-15">3.1.3 Builder配置流程图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant Builder as OkHttpClient.Builder
    participant Validator as 参数验证器
    participant Factory as 组件工厂
    participant Client as OkHttpClient
    
    App-&gt;&gt;Builder: new Builder()
    Builder-&gt;&gt;Builder: 初始化默认配置
    
    loop 配置各种参数
        App-&gt;&gt;Builder: 设置配置项
        Builder-&gt;&gt;Builder: 存储配置值
    end
    
    App-&gt;&gt;Builder: build()
    Builder-&gt;&gt;Validator: 验证配置参数
    alt 参数无效
        Validator--&gt;&gt;Builder: 抛出异常
        Builder--&gt;&gt;App: 配置异常
    else 参数有效
        Validator--&gt;&gt;Builder: 验证通过
        Builder-&gt;&gt;Factory: 创建组件实例
        Factory--&gt;&gt;Builder: 返回组件
        Builder-&gt;&gt;Client: new OkHttpClient(builder)
        Client-&gt;&gt;Client: 复制Builder配置
        Client--&gt;&gt;Builder: OkHttpClient实例
        Builder--&gt;&gt;App: 返回客户端
    end
</code></pre>
<h5 data-id="heading-16">3.1.4 超时配置关系图</h5>
<p>在创建对象时，连接超时，读取超时，写入超时，完整请求超时，都可以灵活配置。那么这块是如何设计的呢？</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[超时配置] --&gt; B[callTimeout]
    A --&gt; C[connectTimeout]
    A --&gt; D[readTimeout]
    A --&gt; E[writeTimeout]
    A --&gt; F[pingInterval]
    
    B --&gt; G[整个请求的总超时时间]
    C --&gt; H[TCP连接建立超时]
    D --&gt; I[从服务器读取数据超时]
    E --&gt; J[向服务器写入数据超时]
    F --&gt; K[HTTP/2连接保活间隔]
    
    G --&gt; L[包含连接、读写、重定向等所有时间]
    H --&gt; M[默认10秒]
    I --&gt; N[默认10秒]
    J --&gt; O[默认10秒]
    K --&gt; P[默认0-不发送ping]
    
    style A fill:#e3f2fd
    style B fill:#ffebee
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#f3e5f5
    style F fill:#e1f5fe
</code></pre>
<h4 data-id="heading-17">3.2 Request请求封装</h4>
<p>主要是封装一个Request请求体。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
        .url(url)
        .addHeader(<span class="hljs-string">"cookie"</span>,<span class="hljs-string">"yangchong"</span>)
        .get()
        .build();
</code></pre>
<p>Request类封装了HTTP请求的所有信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Request</span> {
    <span class="hljs-keyword">final</span> HttpUrl url;
    <span class="hljs-keyword">final</span> String method;
    <span class="hljs-keyword">final</span> Headers headers;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> RequestBody body;
    <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; tags;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
        <span class="hljs-meta">@Nullable</span> HttpUrl url;
        String method;
        Headers.Builder headers;
        <span class="hljs-meta">@Nullable</span> RequestBody body;
        Map&lt;Class&lt;?&gt;, Object&gt; tags = Collections.emptyMap();
    }
}
</code></pre>
<p>Request包括Headers和RequestBody，而RequestBody是abstract的，他的子类是有FormBody(表单提交的)和MultipartBody(文件上传)，分别对应了两种不同的MIME类型。</p>
<pre><code class="hljs language-text" lang="text">FormBody ："application/x-www-form-urlencoded"
MultipartBody："multipart/"+xxx.
</code></pre>
<p><strong>核心特性</strong>：</p>
<ul>
<li>不可变对象设计，线程安全</li>
<li>建造者模式构建</li>
<li>支持多种HTTP方法（GET、POST、PUT、DELETE等）</li>
<li>灵活的Header管理</li>
</ul>
<h4 data-id="heading-18">3.3 Call请求执行接口</h4>
<p>如何设计Call请求基于接口开发，设计了Call接口，里面主要做同步请求execute，异步请求enqueue，取消请求cancel等等。</p>
<p>Call类详解：有道词典翻译该类注释：调用是准备执行的请求。call可以取消。由于此对象表示单个请求/响应对(流)，因此不能执行两次。</p>
<p>主要是HTTP请求任务封装</p>
<ul>
<li>可以说我们能用到的操纵基本上都定义在这个接口里面了，可以通过Call对象来操作请求，同步请求execute，异步请求enqueue。</li>
<li>而Call接口内部提供了Factory工厂方法模式(将对象的创建延迟到工厂类的子类去进行，从而实现动态配置)。</li>
</ul>
<p>Call接口定义了请求执行的标准：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Call</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cloneable</span> {
    Request <span class="hljs-title function_">request</span><span class="hljs-params">()</span>;
    Response <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueue</span><span class="hljs-params">(Callback responseCallback)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExecuted</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCanceled</span><span class="hljs-params">()</span>;
    Timeout <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span>;
    Call <span class="hljs-title function_">clone</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>RealCall实现</strong>：</p>
<ul>
<li>同步执行：<code>execute()</code>方法直接在当前线程执行</li>
<li>异步执行：<code>enqueue()</code>方法提交到线程池执行</li>
<li>请求取消：支持请求的取消操作</li>
</ul>
<h5 data-id="heading-19">3.3.1 核心方法对比</h5>



































<table><thead><tr><th>特性</th><th>execute()</th><th>enqueue()</th></tr></thead><tbody><tr><td>执行方式</td><td>同步阻塞</td><td>异步非阻塞</td></tr><tr><td>线程模型</td><td>当前线程执行</td><td>线程池执行</td></tr><tr><td>返回方式</td><td>直接返回Response</td><td>通过Callback回调</td></tr><tr><td>异常处理</td><td>抛出IOException</td><td>通过Callback.onFailure</td></tr><tr><td>调度管理</td><td>简单记录</td><td>复杂的队列调度</td></tr></tbody></table>
<h5 data-id="heading-20">3.3.2 执行流程架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[应用调用] --&gt; B{选择执行方式}
    B --&gt;|同步| C[call.execute]
    B --&gt;|异步| D[call.enqueue]
    
    C --&gt; E[Dispatcher.executed]
    D --&gt; F[Dispatcher.enqueue]
    
    E --&gt; G[getResponseWithInterceptorChain]
    F --&gt; H[AsyncCall入队]
    H --&gt; I[promoteAndExecute]
    I --&gt; J[线程池执行AsyncCall]
    J --&gt; K[AsyncCall.execute]
    K --&gt; G
    
    G --&gt; L[拦截器链处理]
    L --&gt; M[网络请求]
    M --&gt; N[Response返回]
    
    N --&gt; O{执行方式}
    O --&gt;|同步| P[直接返回Response]
    O --&gt;|异步| Q[Callback.onResponse]
    
    style C fill:#e1f5fe
    style D fill:#f3e5f5
    style G fill:#fff3e0
    style L fill:#e8f5e8
</code></pre>
<h5 data-id="heading-21">3.3.3 Execute执行时序图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant RealCall as RealCall
    participant Transmitter as Transmitter
    participant Dispatcher as Dispatcher
    participant Chain as InterceptorChain
    participant Network as 网络层
    
    App-&gt;&gt;RealCall: execute()
    
    Note over RealCall: 1. 检查执行状态
    RealCall-&gt;&gt;RealCall: synchronized检查executed
    alt 已执行
        RealCall--&gt;&gt;App: IllegalStateException
    end
    RealCall-&gt;&gt;RealCall: executed = true
    
    Note over RealCall: 2. 超时和生命周期管理
    RealCall-&gt;&gt;Transmitter: timeoutEnter()
    RealCall-&gt;&gt;Transmitter: callStart()
    
    Note over RealCall: 3. 调度器管理
    RealCall-&gt;&gt;Dispatcher: executed(this)
    Note over Dispatcher: 添加到runningSyncCalls队列
    
    Note over RealCall: 4. 执行请求
    RealCall-&gt;&gt;Chain: getResponseWithInterceptorChain()
    Chain-&gt;&gt;Network: 网络请求处理
    Network--&gt;&gt;Chain: Response
    Chain--&gt;&gt;RealCall: Response
    
    Note over RealCall: 5. 清理工作
    RealCall-&gt;&gt;Dispatcher: finished(this)
    Note over Dispatcher: 从runningSyncCalls移除
    
    RealCall--&gt;&gt;App: Response
</code></pre>
<h5 data-id="heading-22">3.3.4 Enqueue执行时序图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant RealCall as RealCall
    participant Dispatcher as Dispatcher
    participant AsyncCall as AsyncCall
    participant ThreadPool as 线程池
    participant Chain as InterceptorChain
    participant Callback as Callback
    
    App-&gt;&gt;RealCall: enqueue(callback)
    
    Note over RealCall: 1. 状态检查和设置
    RealCall-&gt;&gt;RealCall: synchronized检查executed
    RealCall-&gt;&gt;RealCall: executed = true
    
    Note over RealCall: 2. 创建AsyncCall
    RealCall-&gt;&gt;AsyncCall: new AsyncCall(callback)
    RealCall-&gt;&gt;Dispatcher: enqueue(asyncCall)
    
    Note over Dispatcher: 3. 调度逻辑
    Dispatcher-&gt;&gt;Dispatcher: 添加到readyAsyncCalls
    Dispatcher-&gt;&gt;Dispatcher: promoteAndExecute()
    
    alt 可以立即执行
        Dispatcher-&gt;&gt;Dispatcher: 移动到runningAsyncCalls
        Dispatcher-&gt;&gt;AsyncCall: executeOn(executorService)
        AsyncCall-&gt;&gt;ThreadPool: execute(this)
        
        Note over ThreadPool: 4. 异步执行
        ThreadPool-&gt;&gt;AsyncCall: run()
        AsyncCall-&gt;&gt;AsyncCall: execute()
        AsyncCall-&gt;&gt;Chain: getResponseWithInterceptorChain()
        Chain--&gt;&gt;AsyncCall: Response
        
        Note over AsyncCall: 5. 回调处理
        AsyncCall-&gt;&gt;Callback: onResponse(call, response)
        AsyncCall-&gt;&gt;Dispatcher: finished(this)
    else 需要等待
        Note over Dispatcher: 保持在readyAsyncCalls队列中
    end
    
    RealCall--&gt;&gt;App: void (立即返回)
</code></pre>
<h4 data-id="heading-23">3.4 Dispatcher调度器</h4>
<p>网络请求肯定涉及多线程，如何处理大量任务？采用Dispatcher作为调度，与线程池配合实现了高并发，低阻塞的的运行。针对请求任务，采用Deque作为集合，按照入队的顺序先进先出。</p>
<p>Dispatcher负责管理请求的执行调度：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dispatcher</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxRequests</span> <span class="hljs-operator">=</span> <span class="hljs-number">64</span>;  <span class="hljs-comment">// 最大并发请求数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxRequestsPerHost</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;  <span class="hljs-comment">// 单主机最大并发数</span>
    
    <span class="hljs-comment">// 等待执行的异步请求队列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
    <span class="hljs-comment">// 正在执行的异步请求队列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
    <span class="hljs-comment">// 正在执行的同步请求队列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
}
</code></pre>
<p><strong>调度策略</strong>：</p>
<ul>
<li>最大并发请求数限制（默认64个）</li>
<li>单主机最大并发数限制（默认5个）</li>
<li>使用双端队列管理等待和运行中的请求</li>
<li>自动的线程池管理</li>
</ul>
<h5 data-id="heading-24">3.4.1 Dispatcher架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Dispatcher] --&gt; B[ExecutorService]
    A --&gt; C[readyAsyncCalls]
    A --&gt; D[runningAsyncCalls]
    A --&gt; E[runningSyncCalls]
    
    B --&gt; F[ThreadPoolExecutor]
    F --&gt; G[核心线程数: 0]
    F --&gt; H[最大线程数: Integer.MAX_VALUE]
    F --&gt; I[空闲时间: 60秒]
    F --&gt; J[队列: SynchronousQueue]
    
    C --&gt; K[等待执行的异步请求]
    D --&gt; L[正在执行的异步请求]
    E --&gt; M[正在执行的同步请求]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style F fill:#e8f5e8
</code></pre>
<h5 data-id="heading-25">3.4.2 异步调度架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Dispatcher异步调度架构"
        A[Dispatcher] --&gt; B[ExecutorService]
        A --&gt; C[readyAsyncCalls]
        A --&gt; D[runningAsyncCalls]
        A --&gt; E[runningSyncCalls]
        
        B --&gt; F[ThreadPoolExecutor]
        F --&gt; G[核心线程池]
        F --&gt; H[最大线程数]
        F --&gt; I[队列管理]
        
        subgraph "调度策略"
            J[最大并发请求]
            K[单主机最大请求]
            L[空闲回调]
        end
        
        subgraph "请求队列"
            C --&gt; M[等待队列]
            D --&gt; N[执行队列]
            E --&gt; O[同步队列]
        end
    end
</code></pre>
<h5 data-id="heading-26">3.4.3 调度策略流程图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[AsyncCall入队] --&gt; B[添加到readyAsyncCalls]
    B --&gt; C[调用promoteAndExecute]
    C --&gt; D{检查执行条件}
    
    D --&gt; E{总请求数 &lt; maxRequests?}
    E --&gt;|否| F[保持在ready队列]
    E --&gt;|是| G{主机请求数 &lt; maxRequestsPerHost?}
    
    G --&gt;|否| H[继续检查下一个]
    G --&gt;|是| I[移动到running队列]
    
    I --&gt; J[callsPerHost计数+1]
    J --&gt; K[提交到线程池执行]
    K --&gt; L[AsyncCall.execute]
    
    L --&gt; M[执行网络请求]
    M --&gt; N[请求完成]
    N --&gt; O[调用finished方法]
    O --&gt; P[callsPerHost计数-1]
    P --&gt; Q[从running队列移除]
    Q --&gt; R[再次调用promoteAndExecute]
    R --&gt; S[尝试执行ready队列中的请求]
    
    H --&gt; T{还有更多请求?}
    T --&gt;|是| D
    T --&gt;|否| U[结束本轮调度]
    
    F --&gt; U
    S --&gt; U
</code></pre>
<h4 data-id="heading-27">3.5 拦截器机制</h4>
<p>OKHttp有两种调用方式，一种是阻塞的同步请求，一种是异步的非阻塞的请求。</p>
<p>但是无论同步还是异步都会调用下RealCall的 getResponseWithInterceptorChain方法来完成请求，同时将返回数据或者状态通过Callback来完成。</p>
<blockquote>
<p>设计拦截器的核心原理</p>
</blockquote>
<p>Interceptor 负责拦截和分发。先来看看含义：观察，修改以及可能短路的请求输出和响应请求的回来。通常情况下拦截器用来添加，移除或者转换请求或者回应的头部信息。</p>
<p>拦截器，就像水管一样，把一节一节的水管(拦截器)连起来，形成一个回路。实际上client到server也是如此，通过一个又一个的interceptor串起来，然后把数据发送到服务器，又能接受返回的数据，每一个拦截器(水管)都有自己的作用，分别处理不同东西，比如消毒，净化，去杂质，就像一层层过滤网一样。</p>
<blockquote>
<p>接口是如何设计的</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Interceptor</span> {
   <span class="hljs-comment">//负责拦截</span>
  Response <span class="hljs-title function_">intercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException;
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Chain</span> {
     <span class="hljs-comment">//负责分发、前行</span>
    Response <span class="hljs-title function_">proceed</span><span class="hljs-params">(Request request)</span> <span class="hljs-keyword">throws</span> IOException;
  }
}
</code></pre>
<h5 data-id="heading-28">3.5.1 拦截器时序图</h5>
<p>OkHttp的拦截器采用责任链模式，每个拦截器负责特定的功能：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant Client as OkHttpClient
    participant RealCall as RealCall
    participant Chain as InterceptorChain
    participant AppInt as 应用拦截器
    participant RetryInt as 重试拦截器
    participant BridgeInt as 桥接拦截器
    participant CacheInt as 缓存拦截器
    participant ConnInt as 连接拦截器
    participant NetInt as 网络拦截器
    participant CallInt as 调用服务器拦截器
    
    App-&gt;&gt;Client: newCall(request)
    Client-&gt;&gt;RealCall: create
    App-&gt;&gt;RealCall: execute()
    RealCall-&gt;&gt;Chain: proceed(request)
    Chain-&gt;&gt;AppInt: intercept(chain)
    AppInt-&gt;&gt;RetryInt: chain.proceed()
    RetryInt-&gt;&gt;BridgeInt: chain.proceed()
    BridgeInt-&gt;&gt;CacheInt: chain.proceed()
    CacheInt-&gt;&gt;ConnInt: chain.proceed()
    ConnInt-&gt;&gt;NetInt: chain.proceed()
    NetInt-&gt;&gt;CallInt: chain.proceed()
    CallInt--&gt;&gt;NetInt: response
    NetInt--&gt;&gt;ConnInt: response
    ConnInt--&gt;&gt;CacheInt: response
    CacheInt--&gt;&gt;BridgeInt: response
    BridgeInt--&gt;&gt;RetryInt: response
    RetryInt--&gt;&gt;AppInt: response
    AppInt--&gt;&gt;Chain: response
    Chain--&gt;&gt;RealCall: response
    RealCall--&gt;&gt;App: response
</code></pre>
<h5 data-id="heading-29">3.5.2 拦截器类关系图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class Interceptor {
        &lt;&lt;interface&gt;&gt;
        +intercept(Chain) Response
    }
    
    class Chain {
        &lt;&lt;interface&gt;&gt;
        +request() Request
        +proceed(Request) Response
        +connection() Connection
        +call() Call
    }
    
    class RealInterceptorChain {
        -List~Interceptor~ interceptors
        -Transmitter transmitter
        -Exchange exchange
        -int index
        -Request request
        +proceed(Request) Response
        +proceed(Request, Transmitter, Exchange) Response
    }
    
    class RetryAndFollowUpInterceptor {
        -OkHttpClient client
        -int MAX_FOLLOW_UPS
        +intercept(Chain) Response
        -recover(IOException, Transmitter, boolean, Request) boolean
        -followUpRequest(Response, Route) Request
    }
    
    class BridgeInterceptor {
        -CookieJar cookieJar
        +intercept(Chain) Response
        -cookieHeader(List~Cookie~) String
    }
    
    class CacheInterceptor {
        -InternalCache cache
        +intercept(Chain) Response
        -cacheCandidate(Request) Response
        -strategy(Request, Response) CacheStrategy
    }
    
    class ConnectInterceptor {
        -OkHttpClient client
        +intercept(Chain) Response
    }
    
    class CallServerInterceptor {
        -boolean forWebSocket
        +intercept(Chain) Response
    }
    
    Interceptor &lt;|-- RetryAndFollowUpInterceptor
    Interceptor &lt;|-- BridgeInterceptor
    Interceptor &lt;|-- CacheInterceptor
    Interceptor &lt;|-- ConnectInterceptor
    Interceptor &lt;|-- CallServerInterceptor
    Chain &lt;|-- RealInterceptorChain
    RealInterceptorChain --&gt; Interceptor : uses
</code></pre>
<h5 data-id="heading-30">3.5.3 内置拦截器详解</h5>
<ol>
<li><strong>应用拦截器（Application Interceptors）</strong></li>
</ol>
<ul>
<li>用户自定义的拦截器</li>
<li>在请求发送前和响应接收后执行</li>
<li>可以修改请求和响应</li>
</ul>
<ol start="2">
<li><strong>重试和重定向拦截器（RetryAndFollowUpInterceptor）</strong></li>
</ol>
<ul>
<li>处理请求失败重试</li>
<li>处理HTTP重定向</li>
<li>管理连接的获取和释放</li>
</ul>
<ol start="3">
<li><strong>桥接拦截器（BridgeInterceptor）</strong></li>
</ol>
<ul>
<li>将用户请求转换为网络请求</li>
<li>添加必要的HTTP头（Content-Type、Content-Length等）</li>
<li>处理Cookie</li>
<li>处理GZIP压缩</li>
</ul>
<ol start="4">
<li><strong>缓存拦截器（CacheInterceptor）</strong></li>
</ol>
<ul>
<li>实现HTTP缓存策略</li>
<li>处理缓存的读取和写入</li>
<li>支持强制缓存和协商缓存</li>
</ul>
<ol start="5">
<li><strong>连接拦截器（ConnectInterceptor）</strong></li>
</ol>
<ul>
<li>建立与服务器的连接</li>
<li>管理连接池</li>
<li>处理HTTP/2连接复用</li>
</ul>
<ol start="6">
<li><strong>网络拦截器（Network Interceptors）</strong></li>
</ol>
<ul>
<li>用户自定义的网络级拦截器</li>
<li>在实际网络请求前后执行</li>
</ul>
<ol start="7">
<li><strong>调用服务器拦截器（CallServerInterceptor）</strong></li>
</ol>
<ul>
<li>实际的网络IO操作</li>
<li>发送请求数据</li>
<li>读取响应数据</li>
</ul>
<h5 data-id="heading-31">3.5.4 重定向拦截器</h5>
<p>核心功能</p>
<ul>
<li><strong>异常恢复</strong>：处理网络异常和连接失败</li>
<li><strong>重定向处理</strong>：自动处理HTTP重定向响应</li>
<li><strong>重试逻辑</strong>：根据策略决定是否重试请求</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[接收请求] --&gt; B[准备连接]
    B --&gt; C{是否被取消?}
    C --&gt;|是| D[抛出IOException]
    C --&gt;|否| E[执行下一个拦截器]
    
    E --&gt; F{是否发生异常?}
    F --&gt;|是| G[调用recover方法]
    F --&gt;|否| H[检查响应状态]
    
    G --&gt; I{是否可恢复?}
    I --&gt;|是| J[继续重试]
    I --&gt;|否| K[抛出异常]
    
    H --&gt; L[调用followUpRequest]
    L --&gt; M{需要重定向?}
    M --&gt;|否| N[返回响应]
    M --&gt;|是| O{重定向次数超限?}
    
    O --&gt;|是| P[抛出ProtocolException]
    O --&gt;|否| Q[更新请求]
    Q --&gt; R[关闭当前响应]
    R --&gt; J
    
    J --&gt; B
    
    style G fill:#ffebee
    style I fill:#fff3e0
    style M fill:#e8f5e8
    style O fill:#fce4ec
</code></pre>
<h5 data-id="heading-32">3.5.6 缓存拦截器</h5>
<p>核心功能</p>
<ul>
<li><strong>缓存策略</strong>：根据HTTP缓存规范决定缓存行为</li>
<li><strong>缓存读取</strong>：从缓存中读取有效的响应</li>
<li><strong>缓存写入</strong>：将可缓存的响应写入缓存</li>
<li><strong>条件请求</strong>：发送If-None-Match、If-Modified-Since等条件请求</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[接收请求] --&gt; B[从缓存获取候选响应]
    B --&gt; C[计算缓存策略]
    C --&gt; D{网络请求为null?}
    
    D --&gt;|是| E{缓存响应为null?}
    D --&gt;|否| F{缓存响应为null?}
    
    E --&gt;|是| G[返回504错误]
    E --&gt;|否| H[返回缓存响应]
    
    F --&gt;|是| I[执行网络请求]
    F --&gt;|否| J[执行条件网络请求]
    
    I --&gt; K[获取网络响应]
    J --&gt; L[获取网络响应]
    
    K --&gt; M{响应可缓存?}
    L --&gt; N{响应状态码?}
    
    N --&gt;|304| O[更新缓存响应]
    N --&gt;|其他| P[使用网络响应]
    
    O --&gt; Q[返回更新后的缓存响应]
    P --&gt; R{响应可缓存?}
    
    M --&gt;|是| S[写入缓存]
    M --&gt;|否| T[返回网络响应]
    
    R --&gt;|是| U[写入缓存]
    R --&gt;|否| V[返回网络响应]
    
    S --&gt; T
    U --&gt; V
    
    style D fill:#e3f2fd
    style E fill:#f3e5f5
    style F fill:#e8f5e8
    style M fill:#fff3e0
    style N fill:#fce4ec
    style R fill:#e0f2f1
</code></pre>
<h5 data-id="heading-33">3.5.7 网络请求拦截器</h5>
<p>CallServerInterceptor（网络请求拦截器）</p>
<ul>
<li><strong>请求发送</strong>：将HTTP请求发送到服务器</li>
<li><strong>响应接收</strong>：接收服务器的HTTP响应</li>
<li><strong>流控制</strong>：管理请求和响应的数据流</li>
<li><strong>协议处理</strong>：处理HTTP/1.1和HTTP/2的具体协议细节</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Chain as RealInterceptorChain
    participant CallServer as CallServerInterceptor
    participant Exchange as Exchange
    participant Codec as ExchangeCodec
    participant Connection as RealConnection
    participant Server as 服务器
    
    Chain-&gt;&gt;CallServer: intercept(chain)
    CallServer-&gt;&gt;Exchange: writeRequestHeaders(request)
    Exchange-&gt;&gt;Codec: writeRequestHeaders(request)
    Codec-&gt;&gt;Connection: 发送请求头
    Connection-&gt;&gt;Server: HTTP请求头
    
    alt 有请求体
        CallServer-&gt;&gt;Exchange: createRequestBody(request)
        CallServer-&gt;&gt;CallServer: 写入请求体数据
        CallServer-&gt;&gt;Exchange: finishRequest()
        Exchange-&gt;&gt;Codec: finishRequest()
        Codec-&gt;&gt;Connection: 发送请求体
        Connection-&gt;&gt;Server: HTTP请求体
    end
    
    CallServer-&gt;&gt;Exchange: readResponseHeaders()
    Exchange-&gt;&gt;Codec: readResponseHeaders()
    Codec-&gt;&gt;Connection: 读取响应头
    Connection-&gt;&gt;Server: 请求响应头
    Server--&gt;&gt;Connection: HTTP响应头
    Connection--&gt;&gt;Codec: 响应头数据
    Codec--&gt;&gt;Exchange: 解析后的响应头
    Exchange--&gt;&gt;CallServer: Response.Builder
    
    alt 有响应体
        CallServer-&gt;&gt;Exchange: openResponseBody(response)
        Exchange-&gt;&gt;Codec: openResponseBodySource(response)
        Note over CallServer: 创建响应体Source
    end
    
    CallServer--&gt;&gt;Chain: 完整的Response对象
</code></pre>
<h5 data-id="heading-34">3.5.8 拦截器链状态管理</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; Created: new RealInterceptorChain()
    Created --&gt; Executing: proceed()调用
    Executing --&gt; NextInterceptor: index++, 创建新链
    NextInterceptor --&gt; Executing: interceptor.intercept()
    Executing --&gt; Completed: 返回Response
    Executing --&gt; Error: 异常发生
    Error --&gt; [*]
    Completed --&gt; [*]
    
    note right of NextInterceptor
        每次proceed()调用都会：
        1. index + 1
        2. 创建新的RealInterceptorChain
        3. 传递给下一个拦截器
    end note
</code></pre>
<h4 data-id="heading-35">3.6 Response返回</h4>
<p>Response核心职责</p>
<ul>
<li><strong>响应封装</strong>：统一封装HTTP响应的所有信息</li>
<li><strong>流式处理</strong>：支持大文件的流式读取和处理</li>
<li><strong>内存管理</strong>：优化内存使用，避免大响应体的内存溢出</li>
<li><strong>协议适配</strong>：支持HTTP/1.1和HTTP/2协议的响应处理</li>
<li><strong>缓存集成</strong>：与缓存系统无缝集成</li>
</ul>
<h5 data-id="heading-36">3.6.1 类层次结构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class Response {
        -Request request
        -Protocol protocol
        -int code
        -String message
        -Headers headers
        -ResponseBody body
        -Response networkResponse
        -Response cacheResponse
        -Response priorResponse
        -Handshake handshake
        -long sentRequestAtMillis
        -long receivedResponseAtMillis
        +Builder newBuilder()
        +boolean isSuccessful()
        +boolean isRedirect()
        +String header(String)
        +List~String~ headers(String)
        +ResponseBody body()
        +void close()
    }
    
    class ResponseBody {
        &lt;&lt;abstract&gt;&gt;
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
        +String string()
        +byte[] bytes()
        +InputStream byteStream()
        +Reader charStream()
        +void close()
    }
    
    class RealResponseBody {
        -String contentTypeString
        -long contentLength
        -BufferedSource source
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
    }
    
    class Headers {
        -String[] namesAndValues
        +String get(String)
        +List~String~ values(String)
        +Set~String~ names()
        +int size()
        +String name(int)
        +String value(int)
        +Builder newBuilder()
    }
    
    class Builder {
        -Request request
        -Protocol protocol
        -int code
        -String message
        -Headers.Builder headers
        -ResponseBody body
        +Builder request(Request)
        +Builder protocol(Protocol)
        +Builder code(int)
        +Builder message(String)
        +Builder header(String, String)
        +Builder headers(Headers)
        +Builder body(ResponseBody)
        +Response build()
    }
    
    Response --&gt; ResponseBody : contains
    Response --&gt; Headers : contains
    Response --&gt; Builder : creates
    ResponseBody &lt;|-- RealResponseBody : implements
    Response -- Builder : inner class
</code></pre>
<h5 data-id="heading-37">3.6.2 创建流程架构图</h5>
<p>Response创建流程架构图</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[服务器响应] --&gt; B[ExchangeCodec读取]
    B --&gt; C{协议类型}
    
    C --&gt;|HTTP/1.1| D[Http1ExchangeCodec]
    C --&gt;|HTTP/2| E[Http2ExchangeCodec]
    
    D --&gt; F[解析状态行]
    E --&gt; G[解析HTTP/2帧]
    
    F --&gt; H[解析响应头]
    G --&gt; H
    
    H --&gt; I[创建Response.Builder]
    I --&gt; J[设置基本信息]
    J --&gt; K[设置响应头]
    K --&gt; L[创建ResponseBody]
    L --&gt; M[构建Response对象]
    
    M --&gt; N[拦截器处理]
    N --&gt; O[返回给应用层]
    
    style D fill:#e3f2fd
    style E fill:#f3e5f5
    style I fill:#e8f5e8
    style L fill:#fff3e0
    style N fill:#fce4ec
</code></pre>
<h5 data-id="heading-38">3.6.3 状态行解析流程图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[读取状态行] --&gt; B[StatusLine.parse]
    B --&gt; C{解析成功?}
    C --&gt;|否| D[抛出ProtocolException]
    C --&gt;|是| E[提取协议版本]
    E --&gt; F[提取状态码]
    F --&gt; G[提取状态消息]
    G --&gt; H[创建Response.Builder]
    H --&gt; I[设置protocol]
    I --&gt; J[设置code]
    J --&gt; K[设置message]
    K --&gt; L{状态码检查}
    L --&gt;|100 Continue| M{期望Continue?}
    L --&gt;|其他| N[读取响应头]
    M --&gt;|是| O[返回null]
    M --&gt;|否| P[返回Builder]
    N --&gt; Q[返回完整Builder]
    
    style C fill:#fff3e0
    style L fill:#e3f2fd
    style M fill:#f3e5f5
</code></pre>
<h5 data-id="heading-39">3.6.4 Headers解析流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Codec as ExchangeCodec
    participant Reader as Source/BufferedSource
    participant Headers as Headers.Builder
    participant Parser as HeaderParser
    
    Codec-&gt;&gt;Reader: readHeaderLine()
    loop 读取每一行
        Reader--&gt;&gt;Codec: 响应头行
        alt 空行(响应头结束)
            Codec-&gt;&gt;Codec: break
        else 正常响应头
            Codec-&gt;&gt;Parser: 解析头部名称和值
            Parser--&gt;&gt;Codec: name, value
            Codec-&gt;&gt;Headers: addLenient(name, value)
        else 多行头部(折叠)
            Codec-&gt;&gt;Parser: 处理折叠行
            Parser--&gt;&gt;Codec: 合并后的值
            Codec-&gt;&gt;Headers: 更新头部值
        end
    end
    Headers--&gt;&gt;Codec: Headers对象
</code></pre>
<h5 data-id="heading-40">3.6.5 ResponseBody架构设计</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class ResponseBody {
        &lt;&lt;abstract&gt;&gt;
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
        +String string()
        +byte[] bytes()
        +InputStream byteStream()
        +Reader charStream()
        +void close()
        +create(MediaType, String)$ ResponseBody
        +create(MediaType, byte[])$ ResponseBody
        +create(MediaType, long, BufferedSource)$ ResponseBody
    }
    
    class RealResponseBody {
        -String contentTypeString
        -long contentLength
        -BufferedSource source
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
    }
    
    class CacheWritingResponseBody {
        -ResponseBody delegate
        -CacheRequest cacheRequest
        -BufferedSink cacheBody
        -Source cacheWritingSource
        +long contentLength()
        +BufferedSource source()
    }
    
    class GzipResponseBody {
        -ResponseBody responseBody
        -GzipSource gzipSource
        +long contentLength()
        +BufferedSource source()
    }
    
    ResponseBody &lt;|-- RealResponseBody
    ResponseBody &lt;|-- CacheWritingResponseBody
    ResponseBody &lt;|-- GzipResponseBody
    CacheWritingResponseBody --&gt; ResponseBody : delegates to
    GzipResponseBody --&gt; ResponseBody : wraps
</code></pre>
<h5 data-id="heading-41">3.6.6 ResponseBody数据读取</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[ResponseBody数据读取] --&gt; B{读取方式选择}
    
    B --&gt;|小数据| C[string方法]
    B --&gt;|二进制数据| D[bytes方法]
    B --&gt;|流式读取| E[source方法]
    B --&gt;|InputStream| F[byteStream方法]
    B --&gt;|字符流| G[charStream方法]
    
    C --&gt; H[一次性读取到内存]
    D --&gt; I[一次性读取到字节数组]
    E --&gt; J[BufferedSource流式读取]
    F --&gt; K[InputStream包装]
    G --&gt; L[Reader字符流]
    
    H --&gt; M{数据大小}
    I --&gt; M
    M --&gt;|小于1MB| N[适合]
    M --&gt;|大于1MB| O[可能OOM]
    
    J --&gt; P[内存友好]
    K --&gt; P
    L --&gt; P
    
    style C fill:#ffebee
    style D fill:#ffebee
    style E fill:#e8f5e8
    style F fill:#e8f5e8
    style G fill:#e8f5e8
    style O fill:#ffcdd2
    style P fill:#c8e6c9
</code></pre>
<h5 data-id="heading-42">3.6.7 Response生命周期</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant Call as RealCall
    participant Chain as InterceptorChain
    participant Exchange as Exchange
    participant Codec as ExchangeCodec
    participant Response as Response
    participant Body as ResponseBody
    
    App-&gt;&gt;Call: execute() / enqueue()
    Call-&gt;&gt;Chain: getResponseWithInterceptorChain()
    Chain-&gt;&gt;Exchange: 拦截器链处理
    Exchange-&gt;&gt;Codec: readResponseHeaders()
    Codec--&gt;&gt;Exchange: Response.Builder
    Exchange-&gt;&gt;Exchange: openResponseBody()
    Exchange-&gt;&gt;Body: 创建ResponseBody
    Body--&gt;&gt;Exchange: ResponseBody实例
    Exchange-&gt;&gt;Response: Builder.body().build()
    Response--&gt;&gt;Chain: 完整Response
    Chain--&gt;&gt;Call: Response
    Call--&gt;&gt;App: Response
    
    Note over App: 应用处理Response
    App-&gt;&gt;Body: string() / bytes() / source()
    Body--&gt;&gt;App: 响应数据
    App-&gt;&gt;Response: close()
    Response-&gt;&gt;Body: close()
    Body-&gt;&gt;Codec: 关闭底层连接
</code></pre>
<h5 data-id="heading-43">3.6.8 响应数据处理</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[响应数据处理] --&gt; B{数据大小评估}
    B --&gt;|小于64KB| C[直接内存读取]
    B --&gt;|64KB-1MB| D[分块读取]
    B --&gt;|大于1MB| E[流式处理]
    
    C --&gt; F[string/bytes方法]
    D --&gt; G[BufferedSource分块]
    E --&gt; H[InputStream/Reader]
    
    F --&gt; I[一次性分配内存]
    G --&gt; J[固定大小缓冲区]
    H --&gt; K[按需分配]
    
    I --&gt; L{内存充足?}
    L --&gt;|是| M[正常处理]
    L --&gt;|否| N[OutOfMemoryError]
    
    J --&gt; O[内存可控]
    K --&gt; O
    
    style N fill:#ffcdd2
    style O fill:#c8e6c9
    style M fill:#e8f5e8
</code></pre>
<h5 data-id="heading-44">3.6.9 Response错误处理</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[Response处理] --&gt; B{状态码检查}
    B --&gt;|2xx| C[成功响应]
    B --&gt;|3xx| D[重定向处理]
    B --&gt;|4xx| E[客户端错误]
    B --&gt;|5xx| F[服务器错误]
    
    C --&gt; G[正常处理ResponseBody]
    D --&gt; H[RetryAndFollowUpInterceptor处理]
    E --&gt; I[应用层错误处理]
    F --&gt; J[可能重试]
    
    G --&gt; K{ResponseBody读取}
    K --&gt;|成功| L[返回数据]
    K --&gt;|IO异常| M[连接错误处理]
    K --&gt;|协议异常| N[协议错误处理]
    
    H --&gt; O[自动重定向]
    I --&gt; P[返回错误Response]
    J --&gt; Q[重试或失败]
    
    M --&gt; R[关闭连接]
    N --&gt; R
    R --&gt; S[抛出异常]
    
    style E fill:#fff3e0
    style F fill:#ffebee
    style M fill:#ffcdd2
    style N fill:#ffcdd2
</code></pre>
<h5 data-id="heading-45">3.6.10 Response缓存机制</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用
    participant Cache as CacheInterceptor
    participant DiskCache as DiskLruCache
    participant Network as 网络层
    participant Response as Response
    
    App-&gt;&gt;Cache: 请求
    Cache-&gt;&gt;DiskCache: 查找缓存
    alt 缓存命中且有效
        DiskCache--&gt;&gt;Cache: 缓存Response
        Cache-&gt;&gt;Response: 创建缓存Response
        Response--&gt;&gt;App: 返回缓存数据
    else 缓存过期或不存在
        Cache-&gt;&gt;Network: 网络请求
        Network--&gt;&gt;Cache: 网络Response
        Cache-&gt;&gt;DiskCache: 存储Response
        Cache-&gt;&gt;Response: 包装为缓存写入Response
        Response--&gt;&gt;App: 返回网络数据
        Note over Response: 读取时同时写入缓存
    end
</code></pre>
<h3 data-id="heading-46">04.核心流程分析</h3>
<h4 data-id="heading-47">4.1 请求执行流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[创建OkHttpClient] --&gt; B[构建Request]
    B --&gt; C[调用newCall创建Call]
    C --&gt; D{同步还是异步?}
    
    D --&gt;|同步| E[call.execute]
    D --&gt;|异步| F[call.enqueue]
    
    E --&gt; G[Dispatcher调度]
    F --&gt; H[加入异步队列]
    H --&gt; I[线程池执行]
    I --&gt; G
    
    G --&gt; J[构建拦截器链]
    J --&gt; K[依次执行拦截器]
    K --&gt; L[发送网络请求]
    L --&gt; M[接收响应]
    M --&gt; N[拦截器链处理响应]
    N --&gt; O[返回Response]
    
    O --&gt; P{异步?}
    P --&gt;|是| Q[回调Callback]
    P --&gt;|否| R[直接返回]
</code></pre>
<h4 data-id="heading-48">4.2 连接管理流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Call as RealCall
    participant ConnInt as ConnectInterceptor
    participant Pool as ConnectionPool
    participant Conn as RealConnection
    participant Socket as Socket
    
    Call-&gt;&gt;ConnInt: intercept()
    ConnInt-&gt;&gt;Pool: get(address)
    
    alt 连接池中有可用连接
        Pool--&gt;&gt;ConnInt: 返回现有连接
    else 需要创建新连接
        ConnInt-&gt;&gt;Conn: create new
        Conn-&gt;&gt;Socket: connect()
        Socket--&gt;&gt;Conn: connected
        Conn--&gt;&gt;Pool: put(connection)
        Pool--&gt;&gt;ConnInt: 返回新连接
    end
    
    ConnInt-&gt;&gt;Call: proceed with connection
</code></pre>
<h4 data-id="heading-49">4.3 缓存处理流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[请求到达缓存拦截器] --&gt; B{缓存是否存在?}
    
    B --&gt;|否| C[继续网络请求]
    B --&gt;|是| D{缓存是否有效?}
    
    D --&gt;|有效| E[返回缓存响应]
    D --&gt;|需要验证| F[添加条件请求头]
    D --&gt;|过期| C
    
    F --&gt; G[发送条件请求]
    G --&gt; H{服务器响应}
    
    H --&gt;|304 Not Modified| I[返回缓存内容]
    H --&gt;|200 OK| J[更新缓存并返回新内容]
    
    C --&gt; K[网络请求]
    K --&gt; L{响应可缓存?}
    L --&gt;|是| M[存储到缓存]
    L --&gt;|否| N[直接返回响应]
    M --&gt; N
</code></pre>
<h3 data-id="heading-50">05.关键技术特性</h3>
<h4 data-id="heading-51">5.1 连接池管理</h4>
<p>OkHttp使用连接池来复用HTTP连接，提高性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
        <span class="hljs-number">0</span>, Integer.MAX_VALUE, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;(), 
        Util.threadFactory(<span class="hljs-string">"OkHttp ConnectionPool"</span>, <span class="hljs-literal">true</span>)
    );
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RealConnectionPool delegate;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConnectionPool</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConnectionPool</span><span class="hljs-params">(<span class="hljs-type">int</span> maxIdleConnections, <span class="hljs-type">long</span> keepAliveDuration, TimeUnit timeUnit)</span> {
        <span class="hljs-built_in">this</span>.delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealConnectionPool</span>(taskRunner, maxIdleConnections, keepAliveDuration, timeUnit);
    }
}
</code></pre>
<p><strong>连接池特性</strong>：</p>
<ul>
<li>默认最大空闲连接数：5个</li>
<li>默认连接保活时间：5分钟</li>
<li>自动清理过期连接</li>
<li>支持HTTP/1.1和HTTP/2连接复用</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[ConnectionPool创建] --&gt; B[设置最大空闲连接数: 5]
    B --&gt; C[设置连接保活时间: 5分钟]
    C --&gt; D[创建RealConnectionPool]
    D --&gt; E[启动清理线程池]
    
    E --&gt; F[连接使用流程]
    F --&gt; G{需要新连接?}
    G --&gt;|是| H[创建新连接]
    G --&gt;|否| I[复用现有连接]
    
    H --&gt; J[连接加入池中]
    I --&gt; K[更新连接使用时间]
    J --&gt; L[连接使用完毕]
    K --&gt; L
    
    L --&gt; M[连接变为空闲状态]
    M --&gt; N[清理线程检查]
    N --&gt; O{连接过期?}
    O --&gt;|是| P[移除并关闭连接]
    O --&gt;|否| Q[保持连接]
    
    P --&gt; R[连接池维护完成]
    Q --&gt; R
    
    style A fill:#e3f2fd
    style D fill:#f3e5f5
    style G fill:#fff3e0
    style O fill:#ffebee
</code></pre>
<h4 data-id="heading-52">5.2 HTTP/2支持</h4>
<p>OkHttp完整支持HTTP/2协议：</p>
<ul>
<li><strong>多路复用</strong>：单个连接上并发处理多个请求</li>
<li><strong>服务器推送</strong>：服务器主动推送资源</li>
<li><strong>头部压缩</strong>：HPACK算法压缩HTTP头部</li>
<li><strong>流量控制</strong>：精确控制数据传输速率</li>
</ul>
<h5 data-id="heading-53">5.2.1 HTTP/2连接架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "HTTP/2多路复用架构"
        A[Http2Connection] --&gt; B[Http2Writer]
        A --&gt; C[Http2Reader]
        A --&gt; D[Settings]
        A --&gt; E[流管理器]
        
        E --&gt; F[Http2Stream 1]
        E --&gt; G[Http2Stream 2]
        E --&gt; H[Http2Stream N]
        
        subgraph "流控制"
            I[连接级流控]
            J[流级流控]
            K[窗口更新]
        end
        
        subgraph "帧处理"
            L[DATA帧]
            M[HEADERS帧]
            N[SETTINGS帧]
            O[WINDOW_UPDATE帧]
            P[PING帧]
        end
        
        F --&gt; I
        G --&gt; I
        H --&gt; I
        
        F --&gt; J
        G --&gt; J
        H --&gt; J
    end
</code></pre>
<h4 data-id="heading-54">5.3 缓存机制设计</h4>
<p>实现完整的HTTP缓存策略：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interceptor</span> {
    <span class="hljs-meta">@Override</span> 
    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">intercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Response</span> <span class="hljs-variable">cacheCandidate</span> <span class="hljs-operator">=</span> cache != <span class="hljs-literal">null</span> ? cache.get(chain.request()) : <span class="hljs-literal">null</span>;
        
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">CacheStrategy</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheStrategy</span>.Factory(now, chain.request(), cacheCandidate).get();
        <span class="hljs-type">Request</span> <span class="hljs-variable">networkRequest</span> <span class="hljs-operator">=</span> strategy.networkRequest;
        <span class="hljs-type">Response</span> <span class="hljs-variable">cacheResponse</span> <span class="hljs-operator">=</span> strategy.cacheResponse;
        
        <span class="hljs-comment">// 缓存策略处理逻辑</span>
        <span class="hljs-keyword">if</span> (networkRequest == <span class="hljs-literal">null</span> &amp;&amp; cacheResponse == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>.Builder()
                .request(chain.request())
                .protocol(Protocol.HTTP_1_1)
                .code(<span class="hljs-number">504</span>)
                .message(<span class="hljs-string">"Unsatisfiable Request (only-if-cached)"</span>)
                .build();
        }
        
        <span class="hljs-keyword">if</span> (networkRequest == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> cacheResponse.newBuilder()
                .cacheResponse(stripBody(cacheResponse))
                .build();
        }
        
        <span class="hljs-comment">// 继续网络请求...</span>
    }
}
</code></pre>
<h5 data-id="heading-55">5.3.1 缓存架构设计</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp缓存架构"
        A[OkHttpClient] --&gt; B[CacheInterceptor]
        B --&gt; C[CacheStrategy]
        C --&gt; D[Cache]
        D --&gt; E[DiskLruCache]
        
        F[Request] --&gt; G[CacheControl]
        H[Response] --&gt; I[Headers]
        I --&gt; J[CacheControl]
        
        B --&gt; K[InternalCache]
        K --&gt; L[CacheRequest]
        K --&gt; M[Response缓存]
        
        subgraph "缓存决策"
            C --&gt; N[网络请求]
            C --&gt; O[缓存响应]
            C --&gt; P[条件请求]
        end
        
        subgraph "存储层"
            E --&gt; Q[Journal文件]
            E --&gt; R[Entry文件]
            E --&gt; S[Snapshot]
        end
    end
</code></pre>
<h5 data-id="heading-56">5.3.2 缓存核心组件</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class Cache {
        -DiskLruCache cache
        -InternalCache internalCache
        +get(Request) Response
        +put(Response) CacheRequest
        +remove(Request)
        +urls() Iterator
        +size() long
        +maxSize() long
    }
    
    class CacheInterceptor {
        -InternalCache cache
        +intercept(Chain) Response
        -cacheWritingResponse(CacheRequest, Response) Response
    }
    
    class CacheStrategy {
        +Factory factory
        +networkRequest Request
        +cacheResponse Response
        +get() CacheStrategy
    }
    
    class DiskLruCache {
        -File directory
        -long maxSize
        -Map&lt;String, Entry&gt; lruEntries
        +get(String) Snapshot
        +edit(String) Editor
        +remove(String) boolean
    }
    
    class CacheControl {
        -boolean noCache
        -boolean noStore
        -int maxAgeSeconds
        -int maxStaleSeconds
        -int minFreshSeconds
        +parse(Headers) CacheControl
    }
    
    Cache --&gt; DiskLruCache
    Cache --&gt; InternalCache
    CacheInterceptor --&gt; Cache
    CacheInterceptor --&gt; CacheStrategy
    CacheStrategy --&gt; CacheControl
</code></pre>
<h5 data-id="heading-57">5.3.3 缓存决策流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[接收请求] --&gt; B{检查缓存}
    B --&gt;|无缓存| C[发起网络请求]
    B --&gt;|有缓存| D{缓存是否新鲜}
    
    D --&gt;|新鲜| E[返回缓存响应]
    D --&gt;|过期| F{是否允许过期缓存}
    
    F --&gt;|允许| G{检查max-stale}
    F --&gt;|不允许| H{支持条件请求}
    
    G --&gt;|在允许范围内| E
    G --&gt;|超出范围| H
    
    H --&gt;|支持| I[发起条件请求]
    H --&gt;|不支持| C
    
    I --&gt; J{服务器响应}
    J --&gt;|304 Not Modified| K[更新缓存元数据]
    J --&gt;|200 OK| L[更新缓存内容]
    
    K --&gt; E
    L --&gt; M[返回新响应]
    C --&gt; N{响应可缓存}
    N --&gt;|可缓存| O[存储到缓存]
    N --&gt;|不可缓存| M
    O --&gt; M
</code></pre>
<h5 data-id="heading-58">5.3.4 磁盘缓存设计</h5>
<p>DiskLruCache是OkHttp缓存的核心存储引擎，采用LRU（Least Recently Used）算法：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "DiskLruCache架构"
        A[DiskLruCache] --&gt; B[Journal文件]
        A --&gt; C[Entry映射]
        A --&gt; D[Executor线程池]
        
        B --&gt; E[操作日志]
        E --&gt; F[CLEAN记录]
        E --&gt; G[DIRTY记录]
        E --&gt; H[REMOVE记录]
        E --&gt; I[READ记录]
        
        C --&gt; J[Entry对象]
        J --&gt; K[文件索引]
        J --&gt; L[长度信息]
        J --&gt; M[访问时间]
        
        subgraph "文件存储"
            N[缓存目录]
            N --&gt; O[journal文件]
            N --&gt; P[journal.tmp]
            N --&gt; Q[journal.bkp]
            N --&gt; R[entry.0文件]
            N --&gt; S[entry.1文件]
        end
    end
</code></pre>
<h5 data-id="heading-59">5.3.5 缓存拦截器思想</h5>
<p>CacheInterceptor核心流程</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant I as CacheInterceptor
    participant C as Cache
    participant D as DiskLruCache
    participant F as FileSystem
    
    I-&gt;&gt;C: put(response)
    C-&gt;&gt;C: 计算缓存键
    C-&gt;&gt;D: edit(key)
    D-&gt;&gt;D: 创建Editor
    D-&gt;&gt;F: 创建临时文件
    F--&gt;&gt;D: 文件句柄
    D--&gt;&gt;C: Editor对象
    C-&gt;&gt;C: 创建CacheRequest
    C--&gt;&gt;I: CacheRequest
    
    Note over I: 写入响应数据
    I-&gt;&gt;I: cacheWritingResponse()
    I-&gt;&gt;I: 包装ResponseBody
    
    Note over I: 数据流写入
    loop 读取网络响应
        I-&gt;&gt;I: 读取数据块
        I-&gt;&gt;C: 写入缓存
        I-&gt;&gt;I: 写入客户端
    end
    
    I-&gt;&gt;C: 完成写入
    C-&gt;&gt;D: editor.commit()
    D-&gt;&gt;F: 重命名临时文件
    D-&gt;&gt;D: 更新Journal
    D--&gt;&gt;C: 成功
    C--&gt;&gt;I: 完成
</code></pre>
<h4 data-id="heading-60">5.4 安全特性设计</h4>
<p>在安全性方面采用了多层防护策略，涵盖传输层安全(TLS)、证书验证、主机名校验、数据完整性保护等多个维度。</p>
<ul>
<li><strong>TLS支持</strong>：支持TLS 1.2和1.3</li>
<li><strong>证书锁定</strong>：Certificate Pinning防止中间人攻击</li>
<li><strong>主机名验证</strong>：严格的主机名验证</li>
<li><strong>协议降级保护</strong>：防止协议降级攻击</li>
</ul>
<h5 data-id="heading-61">5.4.1 安全组件架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[OkHttpClient] --&gt; B[SSL/TLS配置]
    A --&gt; C[证书验证]
    A --&gt; D[主机名校验]
    A --&gt; E[连接安全]
    
    B --&gt; F[SSLSocketFactory]
    B --&gt; G[X509TrustManager]
    B --&gt; H[ConnectionSpec]
    B --&gt; I[TlsVersion]
    B --&gt; J[CipherSuite]
    
    C --&gt; K[CertificatePinner]
    C --&gt; L[CertificateChainCleaner]
    C --&gt; M[TrustRootIndex]
    
    D --&gt; N[OkHostnameVerifier]
    D --&gt; O[HostnameVerifier]
    
    E --&gt; P[RealConnection]
    E --&gt; Q[Handshake]
    E --&gt; R[Protocol协商]
    
    F --&gt; S[平台SSL实现]
    G --&gt; T[证书信任链]
    K --&gt; U[证书固定]
    L --&gt; V[证书链清理]
    N --&gt; W[主机名匹配]
    P --&gt; X[TLS握手]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#fce4ec
</code></pre>
<h5 data-id="heading-62">5.4.2 安全数据流图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用程序
    participant Client as OkHttpClient
    participant Conn as RealConnection
    participant SSL as SSLSocket
    participant Server as 服务器
    
    App-&gt;&gt;Client: 创建HTTPS请求
    Client-&gt;&gt;Conn: 建立连接
    Conn-&gt;&gt;SSL: 创建SSL连接
    
    Note over SSL,Server: TLS握手过程
    SSL-&gt;&gt;Server: ClientHello
    Server-&gt;&gt;SSL: ServerHello + Certificate
    
    SSL-&gt;&gt;SSL: 证书链验证
    SSL-&gt;&gt;SSL: 主机名验证
    SSL-&gt;&gt;SSL: 证书固定检查
    
    alt 验证成功
        SSL-&gt;&gt;Server: ClientKeyExchange
        Server-&gt;&gt;SSL: Finished
        SSL-&gt;&gt;Conn: 安全连接建立
        Conn-&gt;&gt;Client: 连接就绪
        Client-&gt;&gt;App: 可以发送请求
    else 验证失败
        SSL-&gt;&gt;Conn: 验证失败
        Conn-&gt;&gt;Client: 连接异常
        Client-&gt;&gt;App: 抛出安全异常
    end
</code></pre>
<h5 data-id="heading-63">5.4.3 证书验证机制</h5>
<p>OkHttp使用CertificateChainCleaner来清理和验证证书链：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CertificateChainCleaner</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;Certificate&gt; <span class="hljs-title function_">clean</span><span class="hljs-params">(List&lt;Certificate&gt; chain, String hostname)</span>
      <span class="hljs-keyword">throws</span> SSLPeerUnverifiedException;

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CertificateChainCleaner <span class="hljs-title function_">get</span><span class="hljs-params">(X509TrustManager trustManager)</span> {
    <span class="hljs-keyword">return</span> Platform.get().buildCertificateChainCleaner(trustManager);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CertificateChainCleaner <span class="hljs-title function_">get</span><span class="hljs-params">(X509TrustManager trustManager, TrustRootIndex trustRootIndex)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicCertificateChainCleaner</span>(trustRootIndex);
  }
}
</code></pre>
<p>证书链验证流程</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as OkHttpClient
    participant Cleaner as CertificateChainCleaner
    participant Trust as TrustManager
    participant Root as TrustRootIndex
    
    Client-&gt;&gt;Cleaner: clean(certificateChain, hostname)
    Cleaner-&gt;&gt;Cleaner: 构建完整证书链
    
    loop 对每个证书
        Cleaner-&gt;&gt;Root: findByIssuerAndSignature(cert)
        Root--&gt;&gt;Cleaner: 返回匹配的根证书
    end
    
    Cleaner-&gt;&gt;Trust: checkServerTrusted(chain, authType)
    
    alt 验证成功
        Trust--&gt;&gt;Cleaner: 验证通过
        Cleaner--&gt;&gt;Client: 返回清理后的证书链
    else 验证失败
        Trust--&gt;&gt;Cleaner: 抛出异常
        Cleaner--&gt;&gt;Client: 证书验证失败
    end
</code></pre>
<h5 data-id="heading-64">5.4.4 主机名验证</h5>
<p>OkHostnameVerifier实现，OkHttp实现了符合RFC 2818标准的主机名验证器</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始主机名验证] --&gt; B{输入是IP地址?}
    B --&gt;|是| C[IP地址验证]
    B --&gt;|否| D[域名验证]
    
    C --&gt; E[获取证书SAN中的IP地址]
    E --&gt; F{IP地址匹配?}
    F --&gt;|是| G[验证成功]
    F --&gt;|否| H[验证失败]
    
    D --&gt; I[获取证书SAN中的DNS名称]
    I --&gt; J[遍历每个DNS名称]
    J --&gt; K{是通配符模式?}
    
    K --&gt;|否| L[精确匹配]
    K --&gt;|是| M[通配符验证]
    
    L --&gt; N{完全匹配?}
    N --&gt;|是| G
    N --&gt;|否| O{还有更多DNS名称?}
    
    M --&gt; P[检查通配符规则]
    P --&gt; Q{通配符匹配?}
    Q --&gt;|是| G
    Q --&gt;|否| O
    
    O --&gt;|是| J
    O --&gt;|否| H
    
    style G fill:#c8e6c9
    style H fill:#ffcdd2
</code></pre>
<h5 data-id="heading-65">5.4.5 中间人攻击防护</h5>
<p>OkHttp通过多层防护机制防止中间人攻击：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[中间人攻击防护] --&gt; B[证书验证]
    A --&gt; C[证书固定]
    A --&gt; D[主机名验证]
    A --&gt; E[HSTS支持]
    A --&gt; F[证书透明度]
    
    B --&gt; G[证书链完整性检查]
    B --&gt; H[证书有效期验证]
    B --&gt; I[证书撤销检查]
    
    C --&gt; J[公钥固定]
    C --&gt; K[证书指纹固定]
    C --&gt; L[CA固定]
    
    D --&gt; M[SAN验证]
    D --&gt; N[通配符规则检查]
    D --&gt; O[IP地址验证]
    
    E --&gt; P[强制HTTPS重定向]
    E --&gt; Q[HSTS预加载]
    
    F --&gt; R[SCT验证]
    F --&gt; S[CT日志检查]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#fce4ec
    style F fill:#e0f2f1
</code></pre>
<h4 data-id="heading-66">5.5 SSL/TLS流程</h4>
<p>SSL配置层次图</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[SSL/TLS配置] --&gt; B[SocketFactory]
    A --&gt; C[SSLSocketFactory]
    A --&gt; D[X509TrustManager]
    A --&gt; E[HostnameVerifier]
    A --&gt; F[CertificatePinner]
    A --&gt; G[ConnectionSpec]
    
    B --&gt; H[普通Socket创建]
    C --&gt; I[SSL Socket创建]
    D --&gt; J[证书信任验证]
    E --&gt; K[主机名验证]
    F --&gt; L[证书固定验证]
    G --&gt; M[连接规范配置]
    
    I --&gt; N[TLS握手]
    J --&gt; N
    K --&gt; N
    L --&gt; N
    M --&gt; N
    
    N --&gt; O[安全连接建立]
    
    style A fill:#e3f2fd
    style N fill:#f3e5f5
    style O fill:#c8e6c9
</code></pre>
<h5 data-id="heading-67">5.5.1 TLS版本支持</h5>
<p>OkHttp支持多个TLS版本，并提供了灵活的配置机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TlsVersion</span> {
  TLS_1_3(<span class="hljs-string">"TLSv1.3"</span>), <span class="hljs-comment">// jdk11+, android10+</span>
  TLS_1_2(<span class="hljs-string">"TLSv1.2"</span>), <span class="hljs-comment">// jdk7+, android16+</span>
  TLS_1_1(<span class="hljs-string">"TLSv1.1"</span>), <span class="hljs-comment">// jdk7+, android16+</span>
  TLS_1_0(<span class="hljs-string">"TLSv1.0"</span>), <span class="hljs-comment">// jdk7+, android16+</span>
  SSL_3_0(<span class="hljs-string">"SSLv3"</span>);   <span class="hljs-comment">// jdk6+, android9+</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TlsVersion[] DEFAULT = {
    TLS_1_3, TLS_1_2, TLS_1_1, TLS_1_0
  };
}
</code></pre>
<h5 data-id="heading-68">5.5.2 TLS版本策略</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始TLS协商] --&gt; B{服务器支持TLS 1.3?}
    B --&gt;|是| C[使用TLS 1.3]
    B --&gt;|否| D{服务器支持TLS 1.2?}
    D --&gt;|是| E[使用TLS 1.2]
    D --&gt;|否| F{服务器支持TLS 1.1?}
    F --&gt;|是| G[使用TLS 1.1]
    F --&gt;|否| H{服务器支持TLS 1.0?}
    H --&gt;|是| I[使用TLS 1.0]
    H --&gt;|否| J[连接失败]
    
    C --&gt; K[建立安全连接]
    E --&gt; K
    G --&gt; K
    I --&gt; K
    
    style C fill:#c8e6c9
    style E fill:#dcedc8
    style G fill:#f0f4c3
    style I fill:#fff9c4
    style J fill:#ffcdd2
</code></pre>
<h5 data-id="heading-69">5.5.3 TLS握手过程</h5>
<p>RealConnection负责建立安全的TLS连接：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as OkHttpClient
    participant Conn as RealConnection
    participant SSL as SSLSocket
    participant Server as 服务器
    participant Verifier as HostnameVerifier
    participant Pinner as CertificatePinner
    
    Client-&gt;&gt;Conn: connectTls()
    Conn-&gt;&gt;SSL: createSocket()
    Conn-&gt;&gt;SSL: 配置连接规范
    Conn-&gt;&gt;SSL: startHandshake()
    
    Note over SSL,Server: TLS握手协商
    SSL-&gt;&gt;Server: ClientHello
    Server-&gt;&gt;SSL: ServerHello + Certificate + ServerHelloDone
    SSL-&gt;&gt;Server: ClientKeyExchange + ChangeCipherSpec + Finished
    Server-&gt;&gt;SSL: ChangeCipherSpec + Finished
    
    SSL-&gt;&gt;Conn: 握手完成
    Conn-&gt;&gt;Conn: 获取握手信息
    
    Conn-&gt;&gt;Verifier: verify(hostname, session)
    alt 主机名验证成功
        Verifier--&gt;&gt;Conn: true
        Conn-&gt;&gt;Pinner: check(hostname, certificates)
        alt 证书固定验证成功
            Pinner--&gt;&gt;Conn: 验证通过
            Conn-&gt;&gt;Conn: 选择应用层协议
            Conn--&gt;&gt;Client: 安全连接建立成功
        else 证书固定验证失败
            Pinner--&gt;&gt;Conn: SSLPeerUnverifiedException
            Conn--&gt;&gt;Client: 连接失败
        end
    else 主机名验证失败
        Verifier--&gt;&gt;Conn: false
        Conn--&gt;&gt;Client: SSLPeerUnverifiedException
    end
</code></pre>
<h3 data-id="heading-70">06.性能优化策略</h3>
<h4 data-id="heading-71">6.1 连接复用</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[请求1] --&gt; B[连接池]
    C[请求2] --&gt; B
    D[请求3] --&gt; B
    B --&gt; E[复用连接1]
    B --&gt; F[复用连接2]
    E --&gt; G[服务器]
    F --&gt; G
</code></pre>
<h5 data-id="heading-72">6.1.1 连接复用架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp连接复用架构"
        A[OkHttpClient] --&gt; B[ConnectionPool]
        B --&gt; C[RealConnectionPool]
        C --&gt; D[RealConnection]
        
        E[Request] --&gt; F[RealCall]
        F --&gt; G[ExchangeFinder]
        G --&gt; H[RouteSelector]
        
        G --&gt; I[Exchange]
        I --&gt; D
        
        subgraph "连接管理"
            C --&gt; J[连接清理任务]
            C --&gt; K[连接复用逻辑]
            C --&gt; L[连接池统计]
        end
        
        subgraph "路由选择"
            H --&gt; M[Route]
            H --&gt; N[Proxy]
            H --&gt; O[InetSocketAddress]
        end
        
        subgraph "协议支持"
            D --&gt; P[HTTP/1.1]
            D --&gt; Q[HTTP/2]
            D --&gt; R[HTTPS/TLS]
        end
    end
</code></pre>
<h4 data-id="heading-73">6.2 请求合并</h4>
<p>对于相同的请求，OkHttp会自动合并，避免重复请求。</p>
<h4 data-id="heading-74">6.3 压缩传输</h4>
<ul>
<li>自动GZIP压缩响应体</li>
<li>支持Brotli压缩算法</li>
<li>透明的压缩/解压缩处理</li>
</ul>
<h4 data-id="heading-75">6.4 内存管理</h4>
<ul>
<li>使用Okio进行高效的IO操作</li>
<li>智能的缓冲区管理</li>
<li>及时释放不需要的资源</li>
</ul>
<h5 data-id="heading-76">6.4.1 内存管理架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp内存管理架构"
        A[内存管理] --&gt; B[对象池化]
        A --&gt; C[缓冲区管理]
        A --&gt; D[流复用]
        
        B --&gt; E[连接池复用]
        B --&gt; F[请求对象复用]
        B --&gt; G[响应对象复用]
        
        C --&gt; H[Okio Buffer]
        C --&gt; I[Segment池]
        C --&gt; J[ByteString缓存]
        
        D --&gt; K[InputStream复用]
        D --&gt; L[OutputStream复用]
        D --&gt; M[Socket流复用]
        
        subgraph "垃圾回收优化"
            N[弱引用使用]
            O[及时资源释放]
            P[循环引用避免]
        end
        
        subgraph "内存监控"
            Q[内存使用统计]
            R[泄漏检测]
            S[性能指标]
        end
    end
</code></pre>
<h5 data-id="heading-77">6.4.2 IO操作架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp IO架构"
        A[应用层] --&gt; B[OkHttp API]
        B --&gt; C[Interceptor Chain]
        C --&gt; D[Network Layer]
        
        D --&gt; E[Okio]
        E --&gt; F[BufferedSource]
        E --&gt; G[BufferedSink]
        
        F --&gt; H[Source]
        G --&gt; I[Sink]
        
        H --&gt; J[Socket InputStream]
        I --&gt; K[Socket OutputStream]
        
        subgraph "缓冲优化"
            L[Segment Buffer]
            M[零拷贝操作]
            N[批量读写]
        end
        
        subgraph "压缩优化"
            O[GZip压缩]
            P[Deflate压缩]
            Q[Brotli压缩]
        end
        
        F --&gt; L
        G --&gt; L
        C --&gt; O
        C --&gt; P
    end
</code></pre>
<h3 data-id="heading-78">07.使用示例说明</h3>
<h4 data-id="heading-79">7.1 基本使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建客户端</span>
<span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    .connectTimeout(<span class="hljs-number">10</span>, TimeUnit.SECONDS)
    .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
    .writeTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
    .build();

<span class="hljs-comment">// 构建请求</span>
<span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
    .url(<span class="hljs-string">"https://api.example.com/data"</span>)
    .header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer token"</span>)
    .build();

<span class="hljs-comment">// 同步执行</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.newCall(request).execute()) {
    <span class="hljs-keyword">if</span> (response.isSuccessful()) {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> response.body().string();
        <span class="hljs-comment">// 处理响应数据</span>
    }
}

<span class="hljs-comment">// 异步执行</span>
client.newCall(request).enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {
        <span class="hljs-comment">// 处理失败</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (response.isSuccessful()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> response.body().string();
            <span class="hljs-comment">// 处理响应数据</span>
        }
    }
});
</code></pre>
<h4 data-id="heading-80">7.2 高级配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    <span class="hljs-comment">// 连接池配置</span>
    .connectionPool(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionPool</span>(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES))
    <span class="hljs-comment">// 缓存配置</span>
    .cache(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>(cacheDir, <span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)) <span class="hljs-comment">// 50MB缓存</span>
    <span class="hljs-comment">// 拦截器</span>
    .addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingInterceptor</span>())
    .addNetworkInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkInterceptor</span>())
    <span class="hljs-comment">// 重试配置</span>
    .retryOnConnectionFailure(<span class="hljs-literal">true</span>)
    <span class="hljs-comment">// 代理配置</span>
    .proxy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(Proxy.Type.HTTP, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">"proxy.example.com"</span>, <span class="hljs-number">8080</span>)))
    <span class="hljs-comment">// SSL配置</span>
    .sslSocketFactory(sslSocketFactory, trustManager)
    .hostnameVerifier(hostnameVerifier)
    .build();
</code></pre>
<h4 data-id="heading-81">7.3 统计请求耗时</h4>
<p>OkHttp如何进行各个请求环节的耗时统计呢？</p>
<ul>
<li>OkHttp 版本提供了EventListener接口，可以让调用者接收一系列网络请求过程中的事件，例如DNS解析、TSL/SSL连接、Response接收等。</li>
<li>通过继承此接口，调用者可以监视整个应用中网络请求次数、流量大小、耗时(比如dns解析时间，请求时间，响应时间等等)情况。</li>
</ul>
<p>如何消耗记录时间</p>
<ul>
<li>在OkHttp库中有一个EventListener类。该类是网络事件的侦听器。扩展这个类以监视应用程序的HTTP调用的数量、大小和持续时间。</li>
<li>所有启动/连接/获取事件最终将接收到匹配的结束/释放事件，要么成功(非空参数)，要么失败(非空可抛出)。</li>
<li>比如，可以在开始链接记录时间；dns开始，结束等方法解析记录时间，可以计算dns的解析时间。</li>
<li>比如，可以在开始请求记录时间，记录connectStart，connectEnd等方法时间，则可以计算出connect连接时间。</li>
</ul>
<p>OkHttp性能监控架构</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp性能监控架构"
        A[EventListener] --&gt; B[连接事件]
        A --&gt; C[DNS事件]
        A --&gt; D[请求事件]
        A --&gt; E[响应事件]
        
        B --&gt; F[连接开始]
        B --&gt; G[连接结束]
        B --&gt; H[连接获取]
        B --&gt; I[连接释放]
        
        C --&gt; J[DNS开始]
        C --&gt; K[DNS结束]
        
        D --&gt; L[请求开始]
        D --&gt; M[请求头发送]
        D --&gt; N[请求体发送]
        
        E --&gt; O[响应头接收]
        E --&gt; P[响应体接收]
        E --&gt; Q[响应结束]
        
        subgraph "指标收集"
            R[连接池统计]
            S[请求延迟]
            T[吞吐量统计]
            U[错误率统计]
        end
        
        subgraph "性能分析"
            V[热点分析]
            W[瓶颈识别]
            X[优化建议]
        end
    end
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCVSharp：ArUco 标记检测与透视变换]]></title>    <link>https://juejin.cn/post/7572002432451133449</link>    <guid>https://juejin.cn/post/7572002432451133449</guid>    <pubDate>2025-11-13T11:56:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432451133449" data-draft-id="7572016447804997658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCVSharp：ArUco 标记检测与透视变换"/> <meta itemprop="keywords" content="OpenCV"/> <meta itemprop="datePublished" content="2025-11-13T11:56:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCVSharp：ArUco 标记检测与透视变换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:56:06.000Z" title="Thu Nov 13 2025 11:56:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>对于.NET开发者而言，入门OpenCV的一个很舒适的方式就是先去使用OpenCVSharp，它是 OpenCV 的 .NET 封装，而且作者还开源了一个示例库，可以通过示例库进行入门学习。</p>
<p>OpenCVSharp仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshimat%2Fopencvsharp" target="_blank" title="https://github.com/shimat/opencvsharp" ref="nofollow noopener noreferrer">github.com/shimat/open…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764d56beb7e0422e960e33f83ca92311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=yGHYOVqAGHx%2B%2BGI90pQtvt7rV0I%3D" alt="" loading="lazy"/></p>
<p>opencvsharp_samples仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshimat%2Fopencvsharp_samples" target="_blank" title="https://github.com/shimat/opencvsharp_samples" ref="nofollow noopener noreferrer">github.com/shimat/open…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a422e53880d49f2813f4cd1916f03ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=5meWdCHK8OxTDnEkwvmP%2FgrGmN4%3D" alt="" loading="lazy"/></p>
<p>作者提供了几十个可以直接运行的示例代码，一开始可以先大概运行一下这些示例，看一下用这个库可以实现哪些功能。</p>
<p>入门第一步就是先学会用，那些视觉算法的原理可以先不懂，大概了解一下就够了，等后面真的需要你深入了解的时候再去了解也不迟，现在深入理解原理容易让小白放弃，刚开始入门我们就当一名踏踏实实的“掉包侠”。</p>
<h2 data-id="heading-1">Aruco 标记检测与透视变换</h2>
<p>第一个例子是关于Aruco 标记检测和透视变换的。</p>
<p>第一步先运行起来，看一下实现了什么效果？</p>
<p>首先原图是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb3ef77a81024fa3aa30c3393e5532d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=9lxTW1XjHwiJgvp7%2F1GRZ5dGtxQ%3D" alt="" loading="lazy"/></p>
<p>注意到上面有4个有点奇怪的四边形。</p>
<p>然后识别这几个四边形的区域：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fdd7418cf604d56873941817e9cd7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=GIIk2LbK4mCB6nA9VCnHnRulaQA%3D" alt="" loading="lazy"/></p>
<p>然后再进行一下透视变换：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90b07701104849269dc6b403928f35cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=4aB8az51kvJpcD3zdpvs5Ss80xM%3D" alt="" loading="lazy"/></p>
<p>刚刚看到的这些四边形就是Aruco标记，它是拿来干嘛的呢？我的简单理解就是拿来标记用的，一个经典的应用就是替换相框中的图片。</p>
<p>OpenCVSharp好像还没有提供生成Aruco标记的功能，但是已经有了识别的功能，让我们看看这个效果是如何实现的吧！！</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// The locations of the markers in the image at FilePath.Image.Aruco.</span>
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> upperLeftMarkerId = <span class="hljs-number">160</span>;
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> upperRightMarkerId = <span class="hljs-number">268</span>;
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> lowerRightMarkerId = <span class="hljs-number">176</span>;
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> lowerLeftMarkerId = <span class="hljs-number">168</span>;

 <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> src = Cv2.ImRead(ImagePath);

 <span class="hljs-keyword">var</span> detectorParameters = <span class="hljs-keyword">new</span> DetectorParameters();
 detectorParameters.CornerRefinementMethod = CornerRefineMethod.Subpix;
 detectorParameters.CornerRefinementWinSize = <span class="hljs-number">9</span>;

 <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> dictionary = CvAruco.GetPredefinedDictionary(PredefinedDictionaryName.Dict4X4_1000);

 CvAruco.DetectMarkers(src, dictionary, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> corners, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> ids, detectorParameters, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> rejectedPoints);
</code></pre>
<p>每个Aruco标记都有一个确定的ID，然后根据路径读取图片。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> detectorParameters = <span class="hljs-keyword">new</span> DetectorParameters();
detectorParameters.CornerRefinementMethod = CornerRefineMethod.Subpix;
detectorParameters.CornerRefinementWinSize = <span class="hljs-number">9</span>;
</code></pre>
<p>进行检测器参数配置：</p>
<p>DetectorParameters: 创建ArUco检测器的参数对象，用于控制标记检测的精度和行为</p>
<p>CornerRefinementMethod.Subpix: 设置角点细化方法为子像素级别，提高角点检测精度</p>
<p>CornerRefinementWinSize = 9: 设置角点细化窗口大小为9x9像素，用于角点周围的子像素级优化</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> dictionary = CvAruco.GetPredefinedDictionary(PredefinedDictionaryName.Dict4X4_1000);
</code></pre>
<p>进行字典配置：</p>
<p>CvAruco.GetPredefinedDictionary: 获取OpenCV预定义的ArUco标记字典</p>
<p>PredefinedDictionaryName.Dict4X4_1000: 选择4x4位编码、包含1000个不同标记的字典类型</p>
<pre><code class="hljs language-csharp" lang="csharp">CvAruco.DetectMarkers(src, dictionary, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> corners, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> ids, detectorParameters, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> rejectedPoints);
</code></pre>
<p>这就在进行ArUco标记检测了，主要知道一下参数是什么意思就行了。</p>
<p>src - 输入图像，包含要检测ArUco标记的源图像</p>
<p>dictionary - 标记字典，预定义的ArUco标记字典（前面配置的Dict4X4_1000）</p>
<p>corners - 检测到的标记角点（输出参数），每个标记的4个角点坐标，按顺时针顺序存储（从左上角开始）</p>
<p>ids - 检测到的标记ID（输出参数），每个检测到的标记对应的ID编号</p>
<p>detectorParameters - 检测参数，前面配置的检测器参数（包含角点细化等设置）</p>
<p>rejectedPoints - 被拒绝的候选标记（输出参数），检测过程中被识别为候选但最终被拒绝的标记角点</p>
<p>自己再稍微打断点加深一下印象：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f90611ba6c184b4f977a027b38ca9a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=3na4ByE%2BvaHbaFFBgAQlnKksapw%3D" alt="" loading="lazy"/></p>
<p>确实是，每一项都有四个点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fffe9d62a06c4fe2a7bb7a14214dec44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=UXa3HRvuMQUyU012PZ2%2FTJN251U%3D" alt="" loading="lazy"/></p>
<p>检测出了ArUco标记的ID。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c8774b6ab24fb3814b6bc550f868d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=v%2FPvZep4gQHPDtwG975UXMPEfAk%3D" alt="" loading="lazy"/></p>
<p>确实有一组被拒绝的候选标记。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> detectedMarkers = src.Clone();
CvAruco.DrawDetectedMarkers(detectedMarkers, corners, ids, Scalar.Crimson);
</code></pre>
<p>在图像上绘制区域与ID。</p>
<pre><code class="hljs language-csharp" lang="csharp">            <span class="hljs-comment">// Find the index of the four markers in the ids array. We'll use this same index into the</span>
            <span class="hljs-comment">// corners array to find the corners of each marker.</span>
            <span class="hljs-keyword">var</span> upperLeftCornerIndex = Array.FindIndex(ids, id =&gt; id == upperLeftMarkerId);
            <span class="hljs-keyword">var</span> upperRightCornerIndex = Array.FindIndex(ids, id =&gt; id == upperRightMarkerId);
            <span class="hljs-keyword">var</span> lowerRightCornerIndex = Array.FindIndex(ids, id =&gt; id == lowerRightMarkerId);
            <span class="hljs-keyword">var</span> lowerLeftCornerIndex = Array.FindIndex(ids, id =&gt; id == lowerLeftMarkerId);

            <span class="hljs-comment">// Make sure we found all four markers.</span>
            <span class="hljs-keyword">if</span> (upperLeftCornerIndex &lt; <span class="hljs-number">0</span> || upperRightCornerIndex &lt; <span class="hljs-number">0</span>
                 || lowerRightCornerIndex &lt; <span class="hljs-number">0</span> || lowerLeftCornerIndex &lt; <span class="hljs-number">0</span>)
            {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// Marker corners are stored clockwise beginning with the upper-left corner.</span>
            <span class="hljs-comment">// Get the first (upper-left) corner of the upper-left marker.</span>
            <span class="hljs-keyword">var</span> upperLeftPixel = corners[upperLeftCornerIndex][<span class="hljs-number">0</span>];
            <span class="hljs-comment">// Get the second (upper-right) corner of the upper-right marker.</span>
            <span class="hljs-keyword">var</span> upperRightPixel = corners[upperRightCornerIndex][<span class="hljs-number">1</span>];
            <span class="hljs-comment">// Get the third (lower-right) corner of the lower-right marker.</span>
            <span class="hljs-keyword">var</span> lowerRightPixel = corners[lowerRightCornerIndex][<span class="hljs-number">2</span>];
            <span class="hljs-comment">// Get the fourth (lower-left) corner of the lower-left marker.</span>
            <span class="hljs-keyword">var</span> lowerLeftPixel = corners[lowerLeftCornerIndex][<span class="hljs-number">3</span>];

            <span class="hljs-comment">// Create coordinates for passing to GetPerspectiveTransform</span>
            <span class="hljs-keyword">var</span> sourceCoordinates = <span class="hljs-keyword">new</span> List&lt;Point2f&gt;
            {
                upperLeftPixel, upperRightPixel, lowerRightPixel, lowerLeftPixel
            };
</code></pre>
<p>就是确保都找到了这些ID，然后确定了一个区域，就是这么一个区域：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a4728ca1d0044b5a6b93ba49a8fb14c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=uNN3TxvUDTGMjxJAVpTGMyJvLRQ%3D" alt="" loading="lazy"/></p>
<p>这个区域由第一个ArUco标记的左上角点、第二个右上角点、第三个左下角点与第四个右下角点组成。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> destinationCoordinates = <span class="hljs-keyword">new</span> List&lt;Point2f&gt;
{
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>),
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>),
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">0</span>, <span class="hljs-number">1024</span>),
};

</code></pre>
<p>首先进行目标坐标定义，定义了变换后的标准矩形区域，创建一个1024×1024像素的正方形。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> transform = Cv2.GetPerspectiveTransform(sourceCoordinates, destinationCoordinates);
</code></pre>
<p>然后进行计算透视变换矩阵：</p>
<p>sourceCoordinates: 从检测到的4个ArUco标记角点提取的源坐标</p>
<p>destinationCoordinates: 目标标准矩形坐标</p>
<p>返回值: 3×3的透视变换矩阵，用于将源四边形映射到目标矩形</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> normalizedImage = <span class="hljs-keyword">new</span> Mat();
Cv2.WarpPerspective(src, normalizedImage, transform, <span class="hljs-keyword">new</span> Size(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>));
</code></pre>
<p>应用透视变换:</p>
<p>src: 原始输入图像</p>
<p>normalizedImage: 输出的标准化图像</p>
<p>transform: 透视变换矩阵</p>
<p>new Size(1024, 1024): 输出图像尺寸</p>
<p>这样就得到了最后的那张图片。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React：使用Tailwind CSS、Streamdown与Ant Design X]]></title>    <link>https://juejin.cn/post/7572021695294242866</link>    <guid>https://juejin.cn/post/7572021695294242866</guid>    <pubDate>2025-11-13T11:57:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695294242866" data-draft-id="7572016447805014042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React：使用Tailwind CSS、Streamdown与Ant Design X"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-11-13T11:57:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React：使用Tailwind CSS、Streamdown与Ant Design X
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:57:54.000Z" title="Thu Nov 13 2025 11:57:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用Tailwind CSS</h2>
<p><span>Tailwind CSS 简介是“用于快速用户界面开发的原子化 CSS 框架。”</span></p>
<p>Tailwind CSS 是一个功能优先的实用优先（utility-first）CSS框架，它通过提供大量原子化的工具类（utility classes），让开发者直接在HTML中构建自定义设计，而无需编写传统的CSS。与传统框架如Bootstrap不同，Tailwind不提供预设的UI组件，而是专注于底层样式，如flex、pt-4（padding-top: 1rem）、text-center等，这些类名直接对应CSS属性，使得样式声明高度语义化且可预测。其核心优势在于解决了“自定义CSS命名混乱”和“维护复杂”的问题，同时通过配置文件（如tailwind.config.js）支持主题定制、响应式设计（如md:text-lg）和状态变体（如hover:bg-blue-500），灵活适配各种项目需求。</p>
<p>先通过官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2Fdocs%2Finstallation%2Fusing-vite%25E5%25B0%2586Tailwind" target="_blank" title="https://tailwindcss.com/docs/installation/using-vite%E5%B0%86Tailwind" ref="nofollow noopener noreferrer">tailwindcss.com/docs/instal…</a> CSS 作为 Vite 插件进行安装。</p>
<p>之前是把样式都交给AI写了，但是发现AI喜欢每个组件对应一个样式，这样子不方便后续维护，既然都交给AI了那么还不如直接让AI用Tailwind CSS。经过实测发现AI写Tailwind CSS的水平还是很强的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/715230bd834640dcafa8080158c6129e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=xhwGFyfnz7KxqThMd6rEFuW8SIU%3D" alt="" loading="lazy"/></p>
<p>静态页面交给AI写用Tailwind CSS用的已经很好了。</p>
<h2 data-id="heading-1">使用Ant Desgin X</h2>
<p><span>@ant-design/x 是一个专注于 React 生态的先进 AI 组件库，旨在简化与人工智能集成的开发过程。</span></p>
<p>该库包括高度定制化的 AI 组件，允许开发者轻松地将对话 AI 集成到他们的应用中。除了丰富的 UI 组件，@ant-design/x 还提供了一揽子 API 解决方案，支持开发者通过令牌认证直接接入现有 AI 服务，无缝衔接与 AI 的对话和交互。无论是建立智能聊天应用、提升用户交互体验还是加快 AI 能力的集成，@ant-design/x 都是 React 开发者进入 AI 世界的理想伙伴。</p>
<p>官方仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fx" target="_blank" title="https://github.com/ant-design/x" ref="nofollow noopener noreferrer">github.com/ant-design/…</a></p>
<p>官方文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.ant.design%2Fcomponents%2Foverview-cn" target="_blank" title="https://x.ant.design/components/overview-cn" ref="nofollow noopener noreferrer">x.ant.design/components/…</a></p>
<p>这个组件比较新直接让AI来写是不太行的，需要自己看下文档，不过文档已经提供了比较详细的示例代码了，自己看懂之后，复制粘贴一下交给AI，当做AI的上下文，写起来估计问题也不大。</p>
<p>目前使用Ant Desgin X做了一个简单的AI聊天界面了，自己用AI写的组件的质量跟大厂写的肯定是不能比的，既然大厂都做的这么好了，直接用大厂做好的轮子就行了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ef39e731c164e73bccb83b9943fc836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=eG%2FBcbDaKWqfIXZlaNx%2FyBt4tk4%3D" alt="" loading="lazy"/></p>
<p>AI对Ant Design这个组件库很熟练，使用这个组件库的Menu + React Router代替了之前写的自定义样式 + React Router。</p>
<p>使用Ant Design做了一个模型配置页面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22ae6c19ed3b4234b89eed37f57da975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=DHd5dlCOma%2FyI7tlDG3u9cXRHtg%3D" alt="" loading="lazy"/></p>
<p>个人感觉让AI用知名组件库来写比纯让AI自己写还是好多了。</p>
<h2 data-id="heading-2">使用Streamdown</h2>
<p>这个也是一个新东西直接让AI来写是不太行的，需要自己先看下仓库介绍。</p>
<p><span>Streamdown的简介是“react-markdown 的即插即用替代品，专为 AI 驱动的流式传输而设计。”</span></p>
<p>官方仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fstreamdown" target="_blank" title="https://github.com/vercel/streamdown" ref="nofollow noopener noreferrer">github.com/vercel/stre…</a></p>
<p>用起来在流式传输方面确实比之前使用的react-markdown效果要好一点。</p>
<p>渲染代码效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10057528c82743d9a757aa298c63b63d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=zd93AetezjwAv%2BMx3yaxanMEPw0%3D" alt="" loading="lazy"/></p>
<p>渲染表格效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb77ebbead6640868b379691b1244364~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=0FbyPGb1zXpqCQvn2bmbZjJ66OI%3D" alt="" loading="lazy"/></p>
<p>渲染mermaid图效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4803f2354af49508a86129fff9432c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=ZtkPxXbIh9XZz89Rii%2BCT%2BLfwXc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">遇到的问题</h2>
<p>被一个SSE传输导致前端总是没有换行的一个问题困扰最久。</p>
<p>之前的效果是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5818cc2dded54c4d87d388c274f112a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=ZdoAfUOC7Oq1PbMMvOW%2BqbZodV4%3D" alt="" loading="lazy"/></p>
<p>总是只有一行，我能发现应该是后端传过来的换行符没有被正常解析导致的，但是叫AI改了很久还是没有很好地解决，自己上网查了一下，果然发现有很多人都遇到过这个问题。</p>
<p>一个很不错的解决方案就是进行转义，因为SSE传输有他自己的格式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f93fd17862242cf8fbd1637da5e3ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=%2FWhv3xzdUFoj6VnlgSFM6z8hME8%3D" alt="" loading="lazy"/></p>
<p>前端在处理的时候一般喜欢将所有\n都去掉，就导致了AI回复就只有一段话。</p>
<p>可以在后端将AI回复中的\n转义为一个占位符，这里用的是&lt;|newline|&gt;，然后在前端再将这个占位符转化为\n即可。</p>
<p>后端处理：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55c64a5878a54727b34a31cad9762ee0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=oNTZQA23vI5aZC7SJfdF876bfTg%3D" alt="" loading="lazy"/></p>
<p>前端处理：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5297269817004ce98ff60d2d37e0de03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=R9Ai2IHEePjVkSE1pY0GqYXGwow%3D" alt="" loading="lazy"/></p>
<p>这样AI回复就不会就只有一段内容了，AI回复中带有的换行能正常保留了。</p>
<h2 data-id="heading-4">一些学到的知识点</h2>
<p><strong>解构写法</strong></p>
<p>这种写法：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Sidebar</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">SidebarProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ collapsed = <span class="hljs-literal">false</span> }</span>) =&gt;</span> {}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea9b3445bc984b4bb89c1051c965a155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=0P9hLOVXQtaiwuHjF6wQsiIqQhY%3D" alt="" loading="lazy"/></p>
<p>类型安全：TypeScript 确保组件接收正确的 props 类型</p>
<p>简洁性：解构和默认值在一行完成</p>
<p>可读性：直接看到组件需要哪些 props</p>
<p>自文档化：类型定义作为组件的"文档"</p>
<p><strong>React.useEffect的使用</strong></p>
<p>useEffect 是 React 中最重要的钩子之一，它让你能够在函数组件中执行副作用操作。</p>
<p>副作用（Side Effects）：指组件渲染之外的操作，如：</p>
<p>数据获取（API调用）</p>
<p>订阅（定时器、事件监听）</p>
<p>手动修改DOM</p>
<p>localStorage操作</p>
<p><strong>React.useMemo的使用</strong></p>
<p>useMemo 是 React 提供的性能优化钩子，用于记忆化计算结果，避免在每次渲染时重复执行昂贵的计算。</p>
<p><strong>localStorage的使用</strong></p>
<p>localStorage 是 Web 浏览器提供的一种客户端存储机制，允许网站在用户浏览器中持久化存储数据。</p>
<p>基本概念
localStorage 是 Window 对象的属性，提供了键值对存储功能，数据没有过期时间，除非用户手动清除或通过代码删除。</p>
<p>特点</p>
<p>持久性存储：数据在浏览器关闭后仍然保留</p>
<p>同源策略：只能访问同一域名下的数据</p>
<p>字符串存储：所有数据都以字符串形式存储</p>
<p>同步操作：读写操作是同步的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Microsoft Agent Framework/C#：了解Workflows的几种不同模式]]></title>    <link>https://juejin.cn/post/7572021695294275634</link>    <guid>https://juejin.cn/post/7572021695294275634</guid>    <pubDate>2025-11-13T12:02:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695294275634" data-draft-id="7572002432451149833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Microsoft Agent Framework/C#：了解Workflows的几种不同模式"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T12:02:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Microsoft Agent Framework/C#：了解Workflows的几种不同模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:02:13.000Z" title="Thu Nov 13 2025 12:02:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近有空的时候在学习Microsoft Agent Framework，在这个框架中目前Workflows分为了Sequential、Concurrent、Handoffs以及Groupchat四种模式，今天让我们来了解一下这四种不同的模式。</p>
<p>首先需要以下两个包：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c805c085bac8450ba458d51ad3198cb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=D7rgcaSgF4uD52kGK45rvK5KZN8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">Sequential 模式</h2>
<p>在开始介绍之前，先看下它的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12377eeb621549ee8e24734d2288dead~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=39xT%2FmnWbApLZtVWHveAUQeJ1k0%3D" alt="" loading="lazy"/></p>
<p>首先需要先构建一个IChatClient：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">var</span> apiKey = Environment.GetEnvironmentVariable(<span class="hljs-string">"OPENAI_API_KEY"</span>) ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">"未设置环境变量：OPENAI_API_KEY"</span>);
 <span class="hljs-comment">//var model = Environment.GetEnvironmentVariable("OPENAI_MODEL") ?? "gpt-4o-mini";</span>
 <span class="hljs-keyword">var</span> model = <span class="hljs-string">"moonshotai/Kimi-K2-Instruct-0905"</span>;
 <span class="hljs-keyword">var</span> baseUrl = Environment.GetEnvironmentVariable(<span class="hljs-string">"OPENAI_BASEURL"</span>) ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">"未设置环境变量：OPENAI_BASEURL"</span>);
         
 ApiKeyCredential apiKeyCredential = <span class="hljs-keyword">new</span> ApiKeyCredential(apiKey);

 OpenAIClientOptions openAIClientOptions = <span class="hljs-keyword">new</span> OpenAIClientOptions();
 openAIClientOptions.Endpoint = <span class="hljs-keyword">new</span> Uri(baseUrl);

 <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> OpenAIClient(apiKeyCredential, openAIClientOptions).GetChatClient(model).AsIChatClient();
</code></pre>
<p>现在通过这个函数方便构建不同的翻译代理：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span>为指定目标语言创建翻译代理。<span class="hljs-doctag">&lt;/summary&gt;</span></span>
 <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ChatClientAgent <span class="hljs-title">GetTranslationAgent</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> targetLanguage, IChatClient chatClient</span>)</span> =&gt;
     <span class="hljs-keyword">new</span>(chatClient,
         <span class="hljs-string">$"你是一个翻译助手，只使用<span class="hljs-subst">{targetLanguage}</span>回应。对于任何输入，"</span> +
         <span class="hljs-string">$"首先输出输入语言的名称，然后将输入翻译成<span class="hljs-subst">{targetLanguage}</span>。"</span>);
</code></pre>
<p>构建顺序工作流：</p>
<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-comment">// 创建顺序工作流</span>
  <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.BuildSequential(
      <span class="hljs-function"><span class="hljs-keyword">from</span> lang <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-built_in">string</span>[]</span>)["French", "Spanish", "English"] 
      <span class="hljs-keyword">select</span> <span class="hljs-title">GetTranslationAgent</span>(<span class="hljs-params">lang, client</span>)
  )</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5b2ebc9f0dc45f09a6305a6950ac856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=5snQMOp%2FeZ2YD1INhgkM2C2Z8B0%3D" alt="" loading="lazy"/></p>
<p>参数就是一组AIAgent，然后工作流会将这些AIAgent按顺序组合起来。</p>
<p>运行这个工作流：</p>
<pre><code class="hljs language-csharp" lang="csharp">  List&lt;ChatMessage&gt; messages = [<span class="hljs-keyword">new</span>(ChatRole.User, InputText)];
  <span class="hljs-keyword">await</span> RunWorkflowAsync(workflow, messages);
  
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;ChatMessage&gt;&gt; RunWorkflowAsync(Workflow workflow, List&lt;ChatMessage&gt; messages)
{
    <span class="hljs-built_in">string</span>? lastExecutorId = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">await</span> <span class="hljs-keyword">using</span> StreamingRun run = <span class="hljs-keyword">await</span> InProcessExecution.StreamAsync(workflow, messages);
    <span class="hljs-keyword">await</span> run.TrySendMessageAsync(<span class="hljs-keyword">new</span> TurnToken(emitEvents: <span class="hljs-literal">true</span>));
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (WorkflowEvent evt <span class="hljs-keyword">in</span> run.WatchStreamAsync())
    {
        <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">is</span> AgentRunUpdateEvent e)
        {
            <span class="hljs-keyword">if</span> (e.ExecutorId != lastExecutorId)
            {
                OutputText += <span class="hljs-string">"\n"</span>;
                lastExecutorId = e.ExecutorId;

                OutputText += <span class="hljs-string">$"<span class="hljs-subst">{e.ExecutorId}</span>：\n"</span>;
            }

            OutputText += e.Update.Text;
            <span class="hljs-keyword">if</span> (e.Update.Contents.OfType&lt;FunctionCallContent&gt;().FirstOrDefault() <span class="hljs-keyword">is</span> FunctionCallContent call)
            {
               OutputText += <span class="hljs-string">"\n"</span>;
               OutputText += <span class="hljs-string">$"[调用函数 '<span class="hljs-subst">{call.Name}</span>'，参数: <span class="hljs-subst">{JsonSerializer.Serialize(call.Arguments)}</span>]"</span>;
            }
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">is</span> WorkflowOutputEvent output)
        {
            OutputText += <span class="hljs-string">"\n\n工作流完成！"</span>;
            <span class="hljs-keyword">return</span> output.As&lt;List&lt;ChatMessage&gt;&gt;()!;
        }
    }

    <span class="hljs-keyword">return</span> [];
}
</code></pre>
<p>与直觉不一样的地方是只有在传入TurnToken的时候才会开始运行：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">await</span> run.TrySendMessageAsync(<span class="hljs-keyword">new</span> TurnToken(emitEvents: <span class="hljs-literal">true</span>));
</code></pre>
<p>然后通过WorkflowEvent来进行不同操作。</p>
<p>这个例子看最后的输入就是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da50d6c3067e4c29a66badd15b631745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=dHmRQGGQIUTRjkAxHmoAezsMGTs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">Concurrent 模式</h2>
<p>还是先来看下效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ada191422f8484d986a8d780fcc2d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=cuDZw3tIYA0nlzHtWqFf6yczRM8%3D" alt="" loading="lazy"/></p>
<p>Concurrent就是并发工作流，对同一个输入，不同的AI Agent同时响应。</p>
<p>看一下怎么构建：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 创建并发工作流</span>
 <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.BuildConcurrent(
     <span class="hljs-function"><span class="hljs-keyword">from</span> lang <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-built_in">string</span>[]</span>)["French", "Spanish", "English"] 
     <span class="hljs-keyword">select</span> <span class="hljs-title">GetTranslationAgent</span>(<span class="hljs-params">lang, client</span>)
 )</span>;
</code></pre>
<h2 data-id="heading-3">Handoffs 模式</h2>
<p>Handoffs就是交接模式，跟之前的不太一样，首先我们先创建3个不同的AI Agent：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 创建专门的代理</span>
ChatClientAgent historyTutor = <span class="hljs-keyword">new</span>(client,
    <span class="hljs-string">"你提供历史查询方面的帮助。清晰地解释重要事件和背景。只回应历史相关内容。"</span>,
    <span class="hljs-string">"history_tutor"</span>,
    <span class="hljs-string">"历史问题的专业代理"</span>);

ChatClientAgent mathTutor = <span class="hljs-keyword">new</span>(client,
    <span class="hljs-string">"你提供数学问题方面的帮助。在每一步解释你的推理过程并包含示例。只回应数学相关内容。"</span>,
    <span class="hljs-string">"math_tutor"</span>,
    <span class="hljs-string">"数学问题的专业代理"</span>);

ChatClientAgent triageAgent = <span class="hljs-keyword">new</span>(client,
    <span class="hljs-string">"你根据用户的作业问题确定使用哪个代理。总是将任务交接给另一个代理。"</span>,
    <span class="hljs-string">"triage_agent"</span>,
    <span class="hljs-string">"将消息路由到适当的专业代理"</span>);
</code></pre>
<p>看下如何构建：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 创建交接工作流</span>
 <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.CreateHandoffBuilderWith(triageAgent)
     .WithHandoffs(triageAgent, [mathTutor, historyTutor])
     .WithHandoffs([mathTutor, historyTutor], triageAgent)
     .Build();
</code></pre>
<p>来看下效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca85601410a45ed84294a7d9d25241a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=PSkkA9DTeJ7PN%2FKLGiTnr45zJ%2Bs%3D" alt="" loading="lazy"/></p>
<p>这次会到这个地方：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/411959a80af04a2a922880a0c3d99378~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=1m9fLpWKj3AZMfiteOVozxHG3Ik%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1d23954f8df42fd8f6a31376bcc288c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=cWhAdXp2tqxRifeDCktWkylXjgY%3D" alt="" loading="lazy"/></p>
<p>内部有一个FunctionCall交接给了对应的代理。</p>
<p>看一下最终的结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/743a409ecbee4d8f9912ae45b6201c93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=9oXlovby1yIJKk67tGO3dAwSgdQ%3D" alt="" loading="lazy"/></p>
<p>再问一个数学相关的问题看看效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e1e83094cf24370bfbd516f5d6203d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=OWyvl7hz9z7A%2FLa9Sv8DpyXynsc%3D" alt="" loading="lazy"/></p>
<p>看一下最终的结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0806b5a43c88438fb8e33e7f404563ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=3%2FdPt%2BFxFzAXOjunqHXLQ8l6w6c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">Groupchat 模式</h2>
<p>Groupchat模式就是开启一个AI群聊，我拿辩论举个例子。</p>
<pre><code class="hljs language-csharp" lang="csharp"> ChatClientAgent chatClientAgent1 = <span class="hljs-keyword">new</span>(client, <span class="hljs-string">"你是辩论正方"</span>);
 ChatClientAgent chatClientAgent2 = <span class="hljs-keyword">new</span>(client, <span class="hljs-string">"你是辩论反方"</span>);
 
  <span class="hljs-comment">// 创建群聊工作流</span>
 <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.CreateGroupChatBuilderWith(agents =&gt; <span class="hljs-keyword">new</span> RoundRobinGroupChatManager(agents) { MaximumIterationCount = <span class="hljs-number">5</span> })
     .AddParticipants([chatClientAgent1, chatClientAgent2])
     .Build();
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3857827e1de4697b640bc84f887bbb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=M%2BSwBd%2BQL4FAlMl1K8MAI2icSFA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a98ec5634ef4db9ab2733f9b7d0da0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=sXusfynZtRL6Zcd6PPQLjpBF2PM%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WPF/C#：使用Stylet中的IWindowManager用于显示等待窗体、对话框与消息框]]></title>    <link>https://juejin.cn/post/7572016447805030426</link>    <guid>https://juejin.cn/post/7572016447805030426</guid>    <pubDate>2025-11-13T12:03:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447805030426" data-draft-id="7572021695294292018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WPF/C#：使用Stylet中的IWindowManager用于显示等待窗体、对话框与消息框"/> <meta itemprop="keywords" content="C#"/> <meta itemprop="datePublished" content="2025-11-13T12:03:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WPF/C#：使用Stylet中的IWindowManager用于显示等待窗体、对话框与消息框
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:03:14.000Z" title="Thu Nov 13 2025 12:03:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><strong>显示等待框意义</strong></p>
<p>在创建WPF应用的时候，如果我们要执行一个耗时的操作，那么给用户显示一个等待窗体是很常见的需求，通过显示一个等待窗体让用户明白运行的这个软件并没有崩溃，能有效消除用户的焦虑与不确定性，同时能极大提升用户体验，展示软件的专业性和品质，将无聊的等待转化为可预期的、安心的过程。</p>
<p><strong>显示对话框意义</strong></p>
<p>对话框能有效地捕获用户焦点。作为模态窗口，它会强制用户必须完成当前任务（如确认、输入信息或做出选择），之后才能继续操作主窗口。这保证了关键业务流程（如保存文件前的确认）的完整性，防止用户误操作。其次，对话框是信息收集与展示的专用容器。它将特定任务（如设置、登录、详情查看）的UI元素和逻辑封装起来，使主窗口界面保持简洁，同时提升了代码的模块化和可维护性。</p>
<p><strong>显示信息框意义</strong></p>
<p>信息框的核心价值在于即时性与强制性。对于操作成功、失败或出现警告等重要反馈，它能立刻捕获用户注意力，通过模态显示确保用户看到并处理该信息，避免了关键提示被忽略。其次，它为用户提供了快速决策的途径。除了纯信息展示，信息框可附带“是/否”、“确定/取消”等按钮，让用户在不离开当前上下文的情况下，就能对简单询问做出迅速回应，如确认删除操作。</p>
<h2 data-id="heading-1">Stylet介绍</h2>
<p>Stylet是一个轻量级、高性能的MVVM框架，专为WPF设计。它摆脱了传统MVVM的样板代码，通过基于约定的特性，使得View和ViewModel的自动关联、依赖注入等变得极其简单。开发者几乎无需配置即可快速上手，其内置的功能如IConductor屏幕管理和事件聚合器，能优雅地处理复杂的应用程序导航与模块间通信。Stylet的目标是让开发者专注于业务逻辑本身，而非繁琐的框架配置，从而显著提升WPF应用的开发效率与代码质量。</p>
<p>本文通过使用Stylet内置的IWindowManager可以很容易实现这个需求。</p>
<h2 data-id="heading-2">显示等待框</h2>
<p>要显示等待窗体那么必须先做一个等待窗体。</p>
<p>创建一个WaitingView.xaml：</p>
<pre><code class="hljs language-csharp" lang="csharp">&lt;Window x:Class=<span class="hljs-string">"Rouyan.Pages.View.WaitingView"</span>
        xmlns=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
        xmlns:x=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span>
        xmlns:d=<span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span>
        xmlns:mc=<span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
        xmlns:materialDesign=<span class="hljs-string">"http://materialdesigninxaml.net/winfx/xaml/themes"</span>
        xmlns:local=<span class="hljs-string">"clr-namespace:Rouyan.Pages.View"</span>
        mc:Ignorable=<span class="hljs-string">"d"</span>
        Title=<span class="hljs-string">"WaitingWindow"</span> 
        Height=<span class="hljs-string">"200"</span> 
        Width=<span class="hljs-string">"350"</span>
        WindowStyle=<span class="hljs-string">"ToolWindow"</span>
        WindowStartupLocation=<span class="hljs-string">"CenterScreen"</span>
        ResizeMode=<span class="hljs-string">"NoResize"</span>
        Topmost=<span class="hljs-string">"True"</span>&gt;
    &lt;Grid&gt;
        &lt;Grid.RowDefinitions&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"Auto"</span>/&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"Auto"</span>/&gt;
        &lt;/Grid.RowDefinitions&gt;
        
        &lt;Border Grid.Row=<span class="hljs-string">"0"</span>
                Background=<span class="hljs-string">"{DynamicResource PrimaryHueMidBrush}"</span>
                Padding=<span class="hljs-string">"16 8"</span>&gt;
            &lt;TextBlock HorizontalAlignment=<span class="hljs-string">"Center"</span>
                       Text=<span class="hljs-string">"{Binding Text}"</span>
                       FontSize=<span class="hljs-string">"16"</span>/&gt;
        &lt;/Border&gt;
        
        &lt;!-- 进度条区域 --&gt;
        &lt;StackPanel Grid.Row=<span class="hljs-string">"1"</span>
                    Orientation=<span class="hljs-string">"Vertical"</span>
                    HorizontalAlignment=<span class="hljs-string">"Center"</span>
                    VerticalAlignment=<span class="hljs-string">"Center"</span>
                    Margin=<span class="hljs-string">"20"</span>&gt;
            
            &lt;ProgressBar Style=<span class="hljs-string">"{StaticResource MaterialDesignCircularProgressBar}"</span>
                         Foreground=<span class="hljs-string">"{DynamicResource SecondaryHueMidBrush}"</span>
                         Width=<span class="hljs-string">"60"</span>
                         Height=<span class="hljs-string">"60"</span>
                         IsIndeterminate=<span class="hljs-string">"True"</span>/&gt;
                
            &lt;TextBlock Text=<span class="hljs-string">"请稍候..."</span>
                       FontSize=<span class="hljs-string">"14"</span>
                       HorizontalAlignment=<span class="hljs-string">"Center"</span>
                       Foreground=<span class="hljs-string">"{DynamicResource MaterialDesignBody}"</span>
                       Margin=<span class="hljs-string">"0,10,0,0"</span>/&gt;
                
        &lt;/StackPanel&gt;
    &lt;/Grid&gt;
&lt;/Window&gt;
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c27516bb2234eb787213717a7607265~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=IZ4MV5cey3inIixTcB6tYGfpirs%3D" alt="" loading="lazy"/></p>
<p>分为两行，上面一行用于显示要显示的信息，下面一行用于显示ProgressBar与"请稍候..."的组合。</p>
<p>现在再来创建对应的ViewModel：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WaitingViewModel</span> : <span class="hljs-title">Screen</span>
 {      
     <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Text { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-string">"处理中..."</span>;

 }
</code></pre>
<p>显示这个等待窗体，比如当我们运行一个耗时任务的时候，可以先显示这个等待窗体给用户：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 显示等待窗体          </span>
 waitingVm = _container.Get&lt;WaitingViewModel&gt;();
 waitingVm.Text = <span class="hljs-string">"正在分析请求，请稍候..."</span>;
 _windowManager.ShowWindow(waitingVm);
</code></pre>
<p>显示等待窗体主要使用了Stylet中自带的一个组件IWindowManager，我们可以在构造函数中进行依赖注入：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IContainer _container;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IWindowManager _windowManager;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TerminalAgentViewModel</span>(<span class="hljs-params">IContainer container,IWindowManager windowManager</span>)</span>
{
    _container = container;
    _windowManager = windowManager;
}
</code></pre>
<p>由于等待窗体是一个Window，因此需要使用IWindowManager的ShowWindow方法。</p>
<p>Stylet会帮我们将所有View与ViewModel都以瞬态的形式注入依赖注入容器中了，因此可以不用自己在这里new一个viewmodel而是可以直接从容器中取一个出来：</p>
<pre><code class="hljs language-csharp" lang="csharp"> waitingVm = _container.Get&lt;WaitingViewModel&gt;();
</code></pre>
<p><span>IWindowManager的ShowWindow方法的使用，反直觉的一点是传入的不是这个窗体，而是这个窗体对应的ViewModel，Stylet会根据这个ViewModel自动找到对应的View，这也体现了Stylet中ViewModel First的思想。</span></p>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e867c51c8d4a4941965cc7f6b77b1a3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=4GTbvRiDzOuEIj%2BV4groL4hTl94%3D" alt="" loading="lazy"/></p>
<p>这时候可能会有一个疑问就是那么怎么关闭这个窗体呢？</p>
<p>如果是获取对应的Window，我们调用close方法就可以了，现在获取的是对应的ViewModel该如何关闭这个窗体呢？</p>
<p>Stylet已经考虑到了这一个，只要这样写就可以关闭这个窗体：</p>
<pre><code class="hljs language-csharp" lang="csharp"> waitingVm.RequestClose();
</code></pre>
<h2 data-id="heading-3">显示对话框</h2>
<p>使用Stylet中的IWindowManager显示对话框同样也很简单。</p>
<p>首先创建一个HumanApprovalDialogView：</p>
<pre><code class="hljs language-csharp" lang="csharp">&lt;Window x:Class=<span class="hljs-string">"Rouyan.Pages.View.HumanApprovalDialogView"</span>
        xmlns=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
        xmlns:x=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span>
        xmlns:d=<span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span>
        xmlns:mc=<span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
        xmlns:s=<span class="hljs-string">"https://github.com/canton7/Stylet"</span>
        mc:Ignorable=<span class="hljs-string">"d"</span>
        Title=<span class="hljs-string">"{Binding Title}"</span>
        Height=<span class="hljs-string">"200"</span>
        Width=<span class="hljs-string">"420"</span>
        WindowStartupLocation=<span class="hljs-string">"CenterOwner"</span>
        ResizeMode=<span class="hljs-string">"NoResize"</span>
        Topmost=<span class="hljs-string">"True"</span>&gt;
    &lt;Window.InputBindings&gt;
        &lt;KeyBinding Command=<span class="hljs-string">"{s:Action Approve}"</span> Key=<span class="hljs-string">"Y"</span>/&gt;
        &lt;KeyBinding Command=<span class="hljs-string">"{s:Action Reject}"</span> Key=<span class="hljs-string">"N"</span>/&gt;
    &lt;/Window.InputBindings&gt;
    &lt;Grid Margin=<span class="hljs-string">"16"</span>&gt;
        &lt;Grid.RowDefinitions&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"*"</span>/&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"Auto"</span>/&gt;
        &lt;/Grid.RowDefinitions&gt;

        &lt;!-- 顶部消息行 --&gt;
        &lt;ScrollViewer Grid.Row=<span class="hljs-string">"0"</span> VerticalScrollBarVisibility=<span class="hljs-string">"Auto"</span>&gt;
            &lt;TextBlock Text=<span class="hljs-string">"{Binding Message}"</span>
                       TextWrapping=<span class="hljs-string">"Wrap"</span>
                       FontSize=<span class="hljs-string">"14"</span>/&gt;
        &lt;/ScrollViewer&gt;

        &lt;!-- 底部按钮行：左侧同意，右侧拒绝 --&gt;
        &lt;Grid Grid.Row=<span class="hljs-string">"1"</span> Margin=<span class="hljs-string">"0,16,0,0"</span>&gt;
            &lt;Grid.ColumnDefinitions&gt;
                &lt;ColumnDefinition Width=<span class="hljs-string">"*"</span>/&gt;
                &lt;ColumnDefinition Width=<span class="hljs-string">"*"</span>/&gt;
            &lt;/Grid.ColumnDefinitions&gt;

            &lt;Button Grid.Column=<span class="hljs-string">"0"</span>
                    Content=<span class="hljs-string">"同意(Y)"</span>
                    Width=<span class="hljs-string">"100"</span>
                    Height=<span class="hljs-string">"30"</span>
                    HorizontalAlignment=<span class="hljs-string">"Left"</span>
                    IsDefault=<span class="hljs-string">"True"</span>
                    Command=<span class="hljs-string">"{s:Action Approve}"</span>/&gt;

            &lt;Button Grid.Column=<span class="hljs-string">"1"</span>
                    Content=<span class="hljs-string">"拒绝(N)"</span>
                    Width=<span class="hljs-string">"100"</span>
                    Height=<span class="hljs-string">"30"</span>
                    HorizontalAlignment=<span class="hljs-string">"Right"</span>
                    IsCancel=<span class="hljs-string">"True"</span>
                    Command=<span class="hljs-string">"{s:Action Reject}"</span>/&gt;
        &lt;/Grid&gt;
    &lt;/Grid&gt;
&lt;/Window&gt;
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2dbfb2b8e314631905181ab04cbc258~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=FUuT%2BzJiXe9kismTg721tvsDfQI%3D" alt="" loading="lazy"/></p>
<p>创建对应的ViewModel：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HumanApprovalDialogViewModel</span> : <span class="hljs-title">Screen</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HumanApprovalDialogViewModel</span>()</span>
    {
        Title = <span class="hljs-string">"执行审批"</span>;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> _title = <span class="hljs-built_in">string</span>.Empty;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Title
    {
        <span class="hljs-keyword">get</span> =&gt; _title;
        <span class="hljs-keyword">set</span> =&gt; SetAndNotify(<span class="hljs-keyword">ref</span> _title, <span class="hljs-keyword">value</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> _message = <span class="hljs-built_in">string</span>.Empty;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Message
    {
        <span class="hljs-keyword">get</span> =&gt; _message;
        <span class="hljs-keyword">set</span> =&gt; SetAndNotify(<span class="hljs-keyword">ref</span> _message, <span class="hljs-keyword">value</span>);
    }

    <span class="hljs-comment">// Approve the action</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Approve</span>()</span>
    {
        RequestClose(<span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">// Reject the action</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reject</span>()</span>
    {
        RequestClose(<span class="hljs-literal">false</span>);
    }
}
</code></pre>
<p>使用方式与ShowWindow也很相似：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> dialogVm = <span class="hljs-keyword">new</span> HumanApprovalDialogViewModel
{
    Title = <span class="hljs-string">"函数调用审批"</span>,
    Message = <span class="hljs-string">$"是否同意这个操作？"</span>
};

<span class="hljs-built_in">bool</span>? result = _windowManager.ShowDialog(dialogVm);
</code></pre>
<p>最大的区别就是模态与非模态。</p>
<p>模态：
当一个模态窗口（如对话框）出现时，它会独占用户的操作焦点。在用户完成该窗口的任务（例如点击“确定”或“取消”）并关闭它之前，无法与应用程序的其他任何窗口进行交互。程序流程也会在此处暂停，等待窗口关闭后返回结果。这就像一个强制性的“选择题”，你必须回答才能继续。常见场景包括文件保存、确认删除等需要用户明确决策的流程。</p>
<p>非模态：
非模态窗口则像一个开放的助手。它显示后，用户可以随时在它和应用程序的其他窗口之间自由切换，无需关闭它。程序也会继续执行，不会被窗口的开启或关闭打断。这就像一个可以随时查阅的“便签”或“计算器”。它常用于工具箱、属性面板或辅助信息窗口，让用户在主任务进行时能方便地获取额外功能或信息。</p>
<p><span>简言之就是模态就是会阻塞程序运行，要你明确给一个反馈，非模态不会阻塞程序的运行，就单纯显示一个窗体。</span></p>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03fc72263d3e43a9b4673a8359d76a11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=0jHbZSFwQyJfw%2F4cn%2FjbLg%2BJzCM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c36686ddbd4a9b8815bdb6587605a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=Hj6w1ORs8EaMoieZ%2Ftg9vmOU4LY%3D" alt="" loading="lazy"/></p>
<p>同意就返回true，拒绝或者关闭窗体就返回false。</p>
<h2 data-id="heading-4">显示信息框</h2>
<p>我们可以发现IWindowManager除了有ShowWindow与ShowDialog方法外还有一个ShowMessage方法，现在来看下这个方法的使用吧！！</p>
<p>1、基本用法 - 只显示消息</p>
<pre><code class="hljs language-csharp" lang="csharp">_windowManager.ShowMessageBox(<span class="hljs-string">"你好"</span>);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c669b5cd5242bb9a16d1d996df4a49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=AKGjMjtb6NhNPPR%2BormWK%2BB9DZU%3D" alt="" loading="lazy"/></p>
<p>2、带标题的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp">_windowManager.ShowMessageBox(<span class="hljs-string">"操作完成"</span>, <span class="hljs-string">"提示"</span>);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee8a2ad8e84e41fba8d09a6b771b5b35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=jbANp6fTQ3QJdgUkG%2BTzPI5%2BV3E%3D" alt="" loading="lazy"/></p>
<p>3、带确认和取消按钮的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">var</span> result1 = _windowManager.ShowMessageBox(<span class="hljs-string">"确定要删除这个文件吗？"</span>, <span class="hljs-string">"确认删除"</span>,
     MessageBoxButton.OKCancel, MessageBoxImage.Question);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73cc3bd4a9664e1ca709f0eb9fa75acf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=jwHDIYoASBNFYhXTjVbUVxeR8EI%3D" alt="" loading="lazy"/></p>
<p>4、带是/否/取消按钮和警告图标的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> result2 = _windowManager.ShowMessageBox(<span class="hljs-string">"文件已修改，是否保存？"</span>, <span class="hljs-string">"保存确认"</span>,
    MessageBoxButton.YesNoCancel, MessageBoxImage.Warning);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b25b7572907d4a0a93b7c189109bb028~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=LOrE14q6ddNZkQQiM%2BCV%2BFWIe58%3D" alt="" loading="lazy"/></p>
<p>5、带自定义按钮标签的消息框 (使用YesNoCancel按钮以展示更多选项)</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> customButtons = <span class="hljs-keyword">new</span> Dictionary&lt;MessageBoxResult, <span class="hljs-built_in">string</span>&gt;
{
    { MessageBoxResult.Yes, <span class="hljs-string">"继续"</span> },
    { MessageBoxResult.No, <span class="hljs-string">"停止"</span> },
    { MessageBoxResult.Cancel, <span class="hljs-string">"取消"</span> }
};
<span class="hljs-keyword">var</span> result3 = _windowManager.ShowMessageBox(<span class="hljs-string">"检测到潜在风险，是否继续操作？"</span>, <span class="hljs-string">"安全警告"</span>,
    MessageBoxButton.YesNoCancel, MessageBoxImage.Exclamation, MessageBoxResult.No, MessageBoxResult.Cancel, customButtons);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f654cf2a8404a61b1e94d0b06738ffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=pc%2F6uklVZRA8GRxMJZFfv54odGA%3D" alt="" loading="lazy"/></p>
<p>6、带文本对齐和流方向的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp">_windowManager.ShowMessageBox(<span class="hljs-string">"这是一个从右到左显示的消息框文本"</span>, <span class="hljs-string">"RTL示例"</span>,
    MessageBoxButton.OK, MessageBoxImage.Information, MessageBoxResult.None, MessageBoxResult.None,
    <span class="hljs-literal">null</span>, FlowDirection.RightToLeft, TextAlignment.Center);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90c051e6b0ec479d9001f7546a17c390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=QXx3T8GvdX64oOoaR5HLJl2nE4Q%3D" alt="" loading="lazy"/></p>
<p>7、完整参数示例</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">var</span> fullResult = _windowManager.ShowMessageBox(
     <span class="hljs-string">"这是一个完整的消息框示例，包含了所有参数的使用"</span>,
     <span class="hljs-string">"完整示例"</span>,
     MessageBoxButton.OKCancel,
     MessageBoxImage.Information,
     MessageBoxResult.OK,
     MessageBoxResult.Cancel,
     <span class="hljs-literal">null</span>,
     FlowDirection.LeftToRight,
     TextAlignment.Left);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/597b553aec334191b1168ba4c13ba031~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=N1HB%2FXiekgl9LgLuIVUAY6JnWpo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">最后</h2>
<p>本文梳理了Stylet中IWindowManager的用法，分别是ShowWindow、ShowDialog与ShowMessageBox希望对你有所帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？]]></title>    <link>https://juejin.cn/post/7571372478803820559</link>    <guid>https://juejin.cn/post/7571372478803820559</guid>    <pubDate>2025-11-12T02:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803820559" data-draft-id="7571280402964922403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-11-12T02:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:06:17.000Z" title="Wed Nov 12 2025 02:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：代丽 货拉拉/技术中心/质量保障部/履约组</p>
</blockquote>
<p>当一个数据平台的工具量突破3000+、日均调用超50万次，是该庆祝规模化的胜利，还是警惕效率的陷阱？</p>
<p>货拉拉数据工厂就曾站在这样的十字路口——依托高效的"协议编程"架构，我们实现了工具的爆发式增长，却也迎来了用户最真实的抱怨："工具太多选不出""串流程要记半天""新手上手太费劲"。</p>
<p>于是，一场从"平台化"到"AI智能化"的跃迁就此启动。今天，我们就聊聊这场转型背后的痛点、方案与收获。</p>
<h2 data-id="heading-0">一、3k+工具的甜蜜烦恼：高效架构下的使用困局</h2>
<p>在聊转型前，必须先说说支撑我们走到今天的核心底气——"协议编程"架构，简单来说就是：</p>
<blockquote>
<p>工具开发者只需写Java工具类（遵循统一规范），平台通过自研解析引擎自动提取功能描述、输入输出参数等元信息，前端再自动生成可视化界面。</p>
</blockquote>
<p>这个模式的威力有多强？开发者不用管前端交互、权限控制这些"杂事"，专注业务逻辑就行，<strong>工具开发成本直接降低60%以上</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4dbf418904fce8705fb9f3cca9d7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=CwN1EYRKuEZUhzLPIf5V%2FU6YhOw%3D" alt="" loading="lazy"/></p>
<p>靠着这套打法，数据工厂迅速成为内部造数的核心基础设施：工具总量突破3k+，日均调用超50万次。但规模上去了，新问题也找上门了，集中在两个核心痛点：</p>
<h3 data-id="heading-1">1. 工具太多，选得发愁</h3>
<p>为了鼓励提效，我们采用"全局核心工具+业务线自定义工具"的运营策略，这就导致很多功能相似的工具并存。比如"账号信息查询"这个简单场景，平台上就有3个主流版本：</p>
<ul>
<li>账号中台：通用版（支持全账户类型）</li>
<li>司机业务线：专属版（仅支持司机账户）</li>
<li>用户业务线：专属版（仅支持用户账户）</li>
</ul>
<p>实际使用中，70%的用户会优先选本业务线工具，导致通用工具复用率不足30%；更糟的是，新用户得花<strong>3分钟对比测试</strong>才能找到合适的工具，提升了使用门槛。</p>
<h3 data-id="heading-2">2. 步骤太繁，操作耗时</h3>
<p>我们的工具大多是"原子化"的，一个工具只干一件事。但真实业务场景往往需要多工具串联，比如"下单并给指定司机流转至完单"这个高频操作，用户得手动走三步：</p>
<ol>
<li>用"获取司机信息"工具查车型</li>
<li>用"下单"工具完成创建</li>
<li>用"订单流转"工具更新状态</li>
</ol>
<p>整个流程平均要5分钟，中间还要手动记结果、切工具，不仅麻烦，还容易出错。</p>
<h2 data-id="heading-3">二、升级目标：让造数像"说话"一样简单</h2>
<p>针对这些痛点，我们明确了AI升级的核心方向：<strong>打造一个能理解自然语言、自主调度工具的智能体（Agent）</strong> ，彻底改变用户与数据工厂的交互方式。</p>
<p>具体来说，就是要实现三个核心能力，让用户从"工具操作者"变成"需求提出者"：</p>
<ul>
<li><strong>精准懂需求</strong>：不用记工具名，用日常话描述需求就行（比如"查一下司机张三的账号信息并履约完单"）</li>
<li><strong>智能配工具</strong>：系统自动选最优工具，多步骤场景自动串联，不用手动组合</li>
<li><strong>自动跑流程</strong>：参数传递、工具调用、结果整合全自动化，直接给最终结果</li>
</ul>
<p>我们的愿景很直接： <strong>"所想即所得，所造皆能成"</strong> 。初期目标更是明确：造数效率提升50%以上，新用户上手时间缩短到1分钟内。</p>
<h2 data-id="heading-4">三、技术方案：AI+数据工厂的三重协同落地</h2>
<h3 data-id="heading-5">3.1 技术决策：从理论最优到落地可行</h3>
<p>智能体的核心技术选型，我们围绕业务特性做了多轮评估。常见的与LLM结合方案有三种：RAG（检索增强生成）、MCP（执行引擎）和Fine-tuning（模型微调）。</p>
<p>从理论上看，Fine-tuning似乎是最优解——数据工厂覆盖货运、小拉出行、国际化等全业务线，沉淀了大量特有领域知识，微调能让模型深度融合这些知识，减少上下文输入量，提升稳定性。</p>
<p>但早期简易尝试后，我们发现了实际障碍：微调需要大量标注数据，且对算法团队的技术能力要求极高，同时持续迭代的成本也难以承受。综合落地难度与效果反馈，我们最终确定了 <strong>“LLM+RAG+MCP”的协同路径</strong>，兼顾效果、成本与落地效率。</p>
<h3 data-id="heading-6">3.2 技术方案：三大模块构筑智能体能力</h3>
<p>我们将智能体拆解为“大脑（LLM）-知识库（RAG）-手脚（MCP）”三个核心模块，分别负责“理解决策”“知识储备”“执行落地”，形成完整工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1f66e63fa8b4a7daaa8ba3779f0d252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=zN%2BsUd4%2BP4VMhzj13z0lz3lz0os%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.2.1 LLM：智能体的“决策大脑”</h4>
<p>LLM是智能体的核心决策层，使用到LLM的共有6处，出于成本与调优效果做了如下组合与配置（精选3个展示）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d498042d0c40f291357121e167093d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=FrB3C63EgMES2AmvEf6YYtYT4MU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.2.2 RAG：智能体的“知识储备库”</h4>
<p>LLM 具备强大的通用能力，但对我们内部 3000 + 工具的具体信息 “一无所知”。若直接输入全量工具信息，会导致上下文过载。因此，我们通过 RAG 技术构建 “精准检索 - 高效赋能” 的知识库体系，助力智能体精准 “认知” 所需工具。</p>
<p>实践中，我们选用 bge_base_zh_1.5 作为 Embedding 模型，以适配中文语义理解场景；同时，为提升检索的精度与全面性，搭建了双层知识库筛选策略，并将其与固定原子工具列表组合，最终形成 toolList给到LLM使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f53877a952443b8546e0d3c8ae4a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=iqw4Ihwf3tHrg38zrItumGLOBvw%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>全量工具详情知识库</strong>：数据直接同步平台工具数据库，细分为“线上”“线下”两个子库——线上库对应生产环境工具，线下库对应测试环境工具，避免智能体误调用测试工具影响线上业务，保障执行安全性。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97aa3aebd49240b4ad3ff99c42da5aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=6e%2BriJkIPo57AXC09Ie8kq%2BZi2M%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li><strong>自然语言与工具映射知识库</strong>：人工维护多语义映射关系，解决“用户表述≠工具描述”的匹配难题。比如“下单”“开单”“创建订单”等不同说法，均映射到同一工具，大幅提升模糊需求的匹配准确率。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10109254d5fb4aa3ba78f23fe5e012c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=jZll3THBqBe2PxPi4hfBGz7%2FMPA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.2.3 MCP：智能体的“执行手脚”</h4>
<p>工具组合方案确定后，就需要MCP（执行引擎）负责“落地执行”，核心解决“按序执行、参数传递、失败处理、结果解析”四大问题，让智能体“会用”工具。</p>
<p>此处tool仅有一个，功能是单个工具运行，其执行逻辑依赖于prompt，prompt大纲设计：</p>
<ul>
<li><strong>核心任务定位</strong>：按工具序列依次执行，保障前序结果向后续传递，失败自动重试；提取执行结果并匹配用户诉求，用自然语言呈现。</li>
<li><strong>核心执行规则</strong>： - 顺序执行：严格遵循工具列表顺序，前序工具执行成功是后序执行的前提； - 参数关联：动态参数从历史执行结果中自动提取，固定参数保持预设值不变； - 失败处理：执行失败触发重试机制（默认3次），重试失败则终止流程并记录失败状态与原因。</li>
<li><strong>结果解析规范</strong>：根据执行状态码（如ret值）判断成败；成功则筛选核心信息分点呈现，失败则明确标注状态码、失败环节及可能原因，便于用户排查。</li>
</ul>
<h2 data-id="heading-10">四、阶段性成果：上线三月，效率与口碑双丰收</h2>
<p>今年8月AI智能体正式上线，作为内部工具的智能化升级尝试，经过一段时间的推广与迭代，在核心效率指标与用户口碑方面已取得显著成效，验证了升级方向的可行性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be704eafbb134285b0a6eb90522d2dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=W1ynp356ITusJ312zFBXhobXtWI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">4.1 核心数据：用户渗透良好，效率提升显著</h3>
<p>上线至今，智能体的用户接纳度逐步提升，核心效率指标达到预期目标：</p>
<ul>
<li><strong>用户渗透</strong>：累计吸引500+内部用户使用，涵盖测试、产品、开发等关键技术岗位；</li>
<li><strong>调用表现</strong>：当前支持工具100+，累计调用次数3k+，受限于部分用户使用习惯尚未完全转变和支持工具数量有限，但高频用户的周均调用频次达10次，使用粘性较高；</li>
<li><strong>效率提升</strong>：核心业务场景的造数效率提升效果明显，以“下单并流转至完单”为例，操作时间从原有的5分钟缩短至1.5分钟左右，效率提升70%；</li>
<li><strong>使用门槛</strong>：新用户上手适应时间从原有的3分钟压缩至1分钟内，自然语言交互方式有效降低了工具使用的学习成本；</li>
</ul>
<h3 data-id="heading-12">4.2 用户反馈：跨岗位认可，痛点解决明确</h3>
<p>尽管当前使用规模仍在拓展，但智能体精准解决了用户的核心痛点，获得了实际使用者的广泛认可，积累了不少正面反馈：</p>
<ul>
<li><strong>研发岗位</strong>：“这个太牛了，不用去数据工厂找工具了，研发联调的时候很受用”——某开发反馈；</li>
<li><strong>产岗位</strong>：“说实话，有AI*数据工厂，产品验收轻松多了”——某产品反馈；</li>
<li><strong>测试岗位</strong>：“太好用了，测试经常要批量造数，和它说，它可以一次完成，原来我还得在页面点多次”——某测试反馈。</li>
</ul>
<h3 data-id="heading-13">4.3 成果价值：验证方向，沉淀经验</h3>
<p>此次阶段性成果的核心价值，不仅在于效率数据的提升，更在于验证了“AI+数据工厂”模式的可行性：一方面，通过智能化手段解决了平台规模化后的核心痛点，为后续推广积累了真实使用案例；另一方面，基于用户反馈沉淀了模型调优、交互设计的经验，为进一步提升调用频次、扩大使用范围奠定了基础。</p>
<h2 data-id="heading-14">五、未来规划：在迭代中持续精进</h2>
<p>AI智能体的初步落地验证了方向的可行性，但在实际应用中，我们也发现了需要持续优化的核心痛点。基于当前反馈，后续将聚焦问题解决与能力升级，稳步推进智能化深化。</p>
<h3 data-id="heading-15">5.1 现存核心痛点</h3>
<p>结合用户使用数据与反馈收集，目前主要存在两类待解决的问题，也是后续优化的方向：</p>
<ul>
<li><strong>表述习惯差异导致的适配问题</strong>：不同岗位、不同使用经验的用户，对同一业务场景的表述存在差异。以“小b下单”场景为例，用户可能表述为“小b下单”“货运下单”“APP创建小b订单”等多种形式。尽管当前通过持续丰富RAG知识库已实现问题可控，但知识库更新存在一定后置性，未能从源头减少歧义。</li>
<li><strong>LLM</strong> <strong>上下文过载与幻觉问题</strong>：数据工厂工具覆盖货拉拉货运、小拉出行、国际化等全业务线，为保障LLM对业务场景的理解精度，需在上下文中外挂大量业务知识与工具信息，导致上下文内容过载。这一问题直接引发LLM幻觉现象频发（如工具选错、生成逻辑有误的执行序列等），单纯通过精简上下文内容已难以有效缓解。</li>
</ul>
<h3 data-id="heading-16">5.2 后续优化路径</h3>
<p>针对上述痛点，我们制定了明确的分阶段优化计划，兼顾短期问题解决与长期能力提升：</p>
<h4 data-id="heading-17">1. 前置化引导，降低表述歧义</h4>
<p>为解决表述差异问题，后续将从“后置知识库补充”转向“前置输入引导”。计划在交互界面增加场景化引导模块：基于历史调用数据梳理高频业务场景（如订单创建、账号查询、状态流转等），为每个场景配置标准化话术模板与关键词提示。用户输入时，系统可根据初步语义识别推荐对应场景模板，用户仅需补充关键参数即可完成需求提交，从源头降低歧义表述概率。</p>
<h4 data-id="heading-18"><strong>2. 职责拆分 + 场景固化，从架构层面降低幻觉概率</strong></h4>
<p>针对上下文过载引发的幻觉问题，采用 “现有平台交互改造 + 智能体职责拆分” 双轮驱动策略，具体如下：</p>
<ul>
<li><strong>现有平台交互改造</strong>：将现有平台执行底层升级为智能体执行模式，前端除了结果展示采用智能体输出效果，其他不变。该方式既能适配用户现有使用习惯，又能规避 LLM 动态组装工具带来的幻觉风险。</li>
<li><strong>智能体职责拆分</strong>：当前智能体核心决策依赖 “工具组装” 单一 LLM，导致其同时承载业务知识存储、工具匹配判断、执行序列生成等多重职责。后续将核心职责拆分为 “业务知识解析”“工具匹配筛选”“执行序列生成” 三个独立模块，通过 “轻量化 LLM + 专用 RAG 知识库” 协同实现（如专用 RAG 承载业务知识、独立 LLM 负责工具匹配）。此举可显著降低单个模型的上下文负载，从架构层面减少幻觉发生概率。</li>
</ul>
<h4 data-id="heading-19">3. 长期技术探索：微调路径持续验证</h4>
<p>尽管初期因数据、成本等因素放弃了Fine-tuning方案，但随着业务数据的积累与技术成本的优化，我们将持续小范围验证微调可行性。计划选取高频业务场景（如订单全链路相关工具），构建专属微调数据集，探索“基础模型+场景微调”的混合模式，进一步提升模型对特定场景的理解精度与决策稳定性。</p>
<h3 data-id="heading-20">5.3 转型感悟：AI落地是场长期修行</h3>
<p>在智能体落地过程中，我们深刻体会到：LLM的强大之处在于其泛化能力，但相较于传统工程代码的强可控性，它更像一个“需要持续调教的伙伴”。AI赋能并非一蹴而就，而是循序渐进的迭代过程——既要接受初期的不完美，通过实际场景反馈持续调优；也要保持对新技术的敏感度，及时将成熟的技术方案融入现有体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！]]></title>    <link>https://juejin.cn/post/7571402480967368740</link>    <guid>https://juejin.cn/post/7571402480967368740</guid>    <pubDate>2025-11-12T06:49:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571402480967368740" data-draft-id="7564718467829465088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！"/> <meta itemprop="keywords" content="后端,Java,MyBatis"/> <meta itemprop="datePublished" content="2025-11-12T06:49:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T06:49:38.000Z" title="Wed Nov 12 2025 06:49:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是大华。这篇文章介绍<code>MyBatis-Plus</code>！</p>
<p><strong>什么是 MyBatis-Plus？</strong></p>
<p>简单来说，<code>MyBatis-Plus</code>是<code>MyBatis</code>的增强工具，在MyBatis的基础上只做增强不做改变，<strong>既能够简化开发，又能够提高效率</strong>！</p>
<p>我们就从最简单的开始吧！只需要几行代码就能搞定常见的 CRUD 操作。</p>
<p>如果你是新手，可以能快速的学习<code>MyBatis-Plus</code>，如果你是有经验的开发，也可以巩固一下相关的内容。</p>
<h3 data-id="heading-0">1. 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在 pom.xml 中添加以下依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis-Plus Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 数据库驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Lombok 简化实体类开发 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># 替换成你的数据库信息</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/mybatis_plus_demo?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

<span class="hljs-comment"># MyBatis-Plus 配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-comment"># 打印 SQL 日志，方便调试</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启驼峰命名自动转换</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-comment"># 逻辑删除配置</span>
      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span>  <span class="hljs-comment"># 全局逻辑删除的实体字段名</span>
      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span>        <span class="hljs-comment"># 逻辑已删除值(默认为 1)</span>
      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span>    <span class="hljs-comment"># 逻辑未删除值(默认为 0)</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>               <span class="hljs-comment"># 主键ID自增</span>
</code></pre>
<h3 data-id="heading-2">3. 实体类设计</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.*;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("user")</span>  <span class="hljs-comment">// 指定对应的数据库表名</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-comment">/**
     * 用户ID - 主键
     * <span class="hljs-doctag">@TableId</span> 注解表示这是主键
     * value = "id" 表示对应数据库字段名
     * type = IdType.AUTO 表示主键自增
     */</span>
    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-comment">/**
     * 用户名
     * 如果字段名与数据库列名一致（驼峰转下划线），可以省略 <span class="hljs-doctag">@TableField</span>
     */</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 年龄
     */</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">/**
     * 邮箱
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 创建时间
     * <span class="hljs-doctag">@TableField</span> 配置填充策略
     */</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    
    <span class="hljs-comment">/**
     * 更新时间
     * 插入和更新时都自动填充
     */</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
    
    <span class="hljs-comment">/**
     * 逻辑删除字段
     * 0-未删除 1-已删除
     */</span>
    <span class="hljs-meta">@TableLogic</span>
    <span class="hljs-keyword">private</span> Integer deleted;
}
</code></pre>
<h3 data-id="heading-3">4. Mapper 接口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;

<span class="hljs-comment">/**
 * UserMapper 接口
 * 继承 BaseMapper 就自动拥有了 CRUD 方法
 * 
 * 注意：BaseMapper&lt;User&gt; 中的 User 是实体类类型
 */</span>
<span class="hljs-meta">@Mapper</span>  <span class="hljs-comment">// 一定要加上 @Mapper 注解，Spring 才能扫描到</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; {
    <span class="hljs-comment">// 不需要写任何方法，基本的 CRUD 都已经有了！</span>
    
    <span class="hljs-comment">/**
     * 如果需要自定义SQL，可以这样写
     */</span>
    <span class="hljs-comment">// @Select("SELECT * FROM user WHERE age &gt; #{minAge}")</span>
    <span class="hljs-comment">// List&lt;User&gt; selectUsersByMinAge(@Param("minAge") Integer minAge);</span>
}
</code></pre>
<h3 data-id="heading-4">5. 服务层实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-comment">/**
 * UserService 实现类
 * 
 * 继承 ServiceImpl 就自动拥有了更多的 CRUD 方法
 * 参数说明：
 * - UserMapper：你的 Mapper 接口
 * - User：你的实体类
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; {
    <span class="hljs-comment">// 可以在这里添加自定义的业务方法</span>
    
    <span class="hljs-comment">/**
     * 自定义方法：根据用户名查询用户
     */</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 使用 MP 的查询构造器</span>
        <span class="hljs-keyword">return</span> lambdaQuery()
                .eq(User::getUsername, username)  <span class="hljs-comment">// username = ?</span>
                .one();  <span class="hljs-comment">// 查询一条记录</span>
    }
    
    <span class="hljs-comment">/**
     * 自定义方法：根据邮箱后缀查询用户
     */</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsersByEmailSuffix</span><span class="hljs-params">(String emailSuffix)</span> {
        <span class="hljs-keyword">return</span> lambdaQuery()
                .likeRight(User::getEmail, emailSuffix)  <span class="hljs-comment">// email like 'emailSuffix%'</span>
                .list();
    }
}
</code></pre>
<h3 data-id="heading-5">6. 新增操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 新增用户
     */</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-comment">// 方法1：使用 save 方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.save(user);
        
        <span class="hljs-keyword">if</span> (success) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"新增用户成功，用户ID："</span> + user.getId();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"新增用户失败"</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 批量新增用户
     */</span>
    <span class="hljs-meta">@PostMapping("/batch")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;User&gt; users)</span> {
        <span class="hljs-comment">// 批量插入，每次插入100条</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.saveBatch(users, <span class="hljs-number">100</span>);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"批量新增成功"</span> : <span class="hljs-string">"批量新增失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 新增或更新用户（存在则更新，不存在则新增）
     */</span>
    <span class="hljs-meta">@PostMapping("/save-or-update")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">saveOrUpdateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.saveOrUpdate(user);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"操作成功"</span> : <span class="hljs-string">"操作失败"</span>;
    }
}
</code></pre>
<h3 data-id="heading-6">7. 查询操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 查询相关操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID查询用户
     */</span>
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> userService.getById(id);
    }
    
    <span class="hljs-comment">/**
     * 查询所有用户
     */</span>
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.list();
    }
    
    <span class="hljs-comment">/**
     * 条件查询：查询年龄大于18的用户
     */</span>
    <span class="hljs-meta">@GetMapping("/adults")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAdultUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .gt(User::getAge, <span class="hljs-number">18</span>)        <span class="hljs-comment">// age &gt; 18</span>
                .list();
    }
    
    <span class="hljs-comment">/**
     * 复杂条件查询：年龄在18-60之间，并且用户名包含"张"
     */</span>
    <span class="hljs-meta">@GetMapping("/complex")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getComplexUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .between(User::getAge, <span class="hljs-number">18</span>, <span class="hljs-number">60</span>)           <span class="hljs-comment">// age between 18 and 60</span>
                .like(User::getUsername, <span class="hljs-string">"张"</span>)           <span class="hljs-comment">// username like '%张%'</span>
                .orderByDesc(User::getAge)               <span class="hljs-comment">// 按年龄降序</span>
                .list();
    }
    
    <span class="hljs-comment">/**
     * 分页查询
     */</span>
    <span class="hljs-meta">@GetMapping("/page")</span>
    <span class="hljs-keyword">public</span> Page&lt;User&gt; <span class="hljs-title function_">getUserPage</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> Integer current,
            <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> Integer size)</span> {
        
        <span class="hljs-comment">// 创建分页对象</span>
        Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size);
        
        <span class="hljs-comment">// 执行分页查询</span>
        <span class="hljs-keyword">return</span> userService.page(page);
    }
    
    <span class="hljs-comment">/**
     * 带条件的分页查询
     */</span>
    <span class="hljs-meta">@GetMapping("/page-with-condition")</span>
    <span class="hljs-keyword">public</span> Page&lt;User&gt; <span class="hljs-title function_">getUserPageWithCondition</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> Integer current,
            <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> Integer size,
            <span class="hljs-meta">@RequestParam(required = false)</span> String keyword)</span> {
        
        Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size);
        
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .like(StringUtils.isNotBlank(keyword), User::getUsername, keyword)
                .page(page);
    }
}
</code></pre>
<h3 data-id="heading-7">8. 更新操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 更新操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID更新用户
     */</span>
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-keyword">if</span> (user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"用户ID不能为空"</span>;
        }
        
        <span class="hljs-comment">// 方法1：根据ID更新所有字段</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.updateById(user);
        
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"更新成功"</span> : <span class="hljs-string">"更新失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 条件更新：将所有年龄小于18的用户年龄设置为18
     */</span>
    <span class="hljs-meta">@PutMapping("/fix-age")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fixAge</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.lambdaUpdate()
                .lt(User::getAge, <span class="hljs-number">18</span>)        <span class="hljs-comment">// age &lt; 18</span>
                .set(User::getAge, <span class="hljs-number">18</span>)       <span class="hljs-comment">// 设置 age = 18</span>
                .update();
        
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"年龄修复成功"</span> : <span class="hljs-string">"年龄修复失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 部分字段更新
     */</span>
    <span class="hljs-meta">@PatchMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">partialUpdateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, 
                                   <span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; updates)</span> {
        <span class="hljs-comment">// 移除不能更新的字段</span>
        updates.remove(<span class="hljs-string">"id"</span>);
        updates.remove(<span class="hljs-string">"createTime"</span>);
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.updateById(id, updates);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"部分更新成功"</span> : <span class="hljs-string">"部分更新失败"</span>;
    }
}
</code></pre>
<h3 data-id="heading-8">9. 删除操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 删除操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID删除用户（逻辑删除）
     */</span>
    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 逻辑删除，实际上执行的是 update 操作，将 deleted 字段设置为 1</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.removeById(id);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"删除成功"</span> : <span class="hljs-string">"删除失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 批量删除
     */</span>
    <span class="hljs-meta">@DeleteMapping("/batch")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">batchDeleteUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;Long&gt; ids)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.removeByIds(ids);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"批量删除成功"</span> : <span class="hljs-string">"批量删除失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 条件删除：删除所有年龄大于100的用户
     */</span>
    <span class="hljs-meta">@DeleteMapping("/old")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteOldUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.lambdaUpdate()
                .gt(User::getAge, <span class="hljs-number">100</span>)       <span class="hljs-comment">// age &gt; 100</span>
                .remove();
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"删除老年用户成功"</span> : <span class="hljs-string">"删除失败"</span>;
    }
}
</code></pre>
<h2 data-id="heading-9">高级特性</h2>
<h3 data-id="heading-10">10. 自动填充功能</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自动填充处理器
 * 用于自动填充 createTime 和 updateTime
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    
    <span class="hljs-comment">/**
     * 插入时自动填充
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 填充创建时间</span>
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, LocalDateTime.class, LocalDateTime.now());
        <span class="hljs-comment">// 填充更新时间</span>
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
    }
    
    <span class="hljs-comment">/**
     * 更新时自动填充
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 更新时只填充更新时间</span>
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
    }
}
</code></pre>
<h3 data-id="heading-11">11. 分页插件配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * MyBatis-Plus 配置类
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.yourpackage.mapper")</span>  <span class="hljs-comment">// 指定Mapper接口的扫描路径</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-comment">/**
     * 分页插件配置
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        
        <span class="hljs-comment">// 分页插件</span>
        <span class="hljs-type">PaginationInnerInterceptor</span> <span class="hljs-variable">paginationInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL);
        paginationInterceptor.setMaxLimit(<span class="hljs-number">1000L</span>);  <span class="hljs-comment">// 设置最大单页限制数量</span>
        paginationInterceptor.setOverflow(<span class="hljs-literal">true</span>);   <span class="hljs-comment">// 超出最大页数后回到第一页</span>
        
        interceptor.addInnerInterceptor(paginationInterceptor);
        
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<h3 data-id="heading-12">12. 乐观锁插件配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 MybatisPlusConfig 中添加乐观锁插件</span>
<span class="hljs-comment">/**
 * 乐观锁插件配置
 */</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OptimisticLockerInnerInterceptor <span class="hljs-title function_">optimisticLockerInnerInterceptor</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInnerInterceptor</span>();
}

<span class="hljs-comment">// 实体类中配置乐观锁字段</span>
<span class="hljs-meta">@Version</span>
<span class="hljs-keyword">private</span> Integer version;
</code></pre>
<h3 data-id="heading-13">13. 谨慎使用场景</h3>
<p><strong>1. 超复杂 SQL 场景</strong></p>
<ul>
<li>涉及大量复杂联表查询</li>
<li>需要高度优化的自定义 SQL</li>
<li>复杂的存储过程调用</li>
</ul>
<p><strong>2. 性能要求极高的场景</strong></p>
<ul>
<li>高并发写入场景</li>
<li>需要精细控制 SQL 执行的场景</li>
</ul>
<p><strong>3. 遗留系统改造</strong></p>
<ul>
<li>已有复杂 MyBatis 配置的项目</li>
<li>数据库设计不符合 MP 规范</li>
</ul>
<h3 data-id="heading-14">14. 不推荐使用场景</h3>
<p><strong>1. JPA 生态重度依赖项目</strong></p>
<ul>
<li>已经深度使用 Spring Data JPA</li>
<li>需要 JPA 的级联操作等特性</li>
</ul>
<p><strong>2. 非关系型数据库</strong></p>
<ul>
<li>MongoDB、Redis 等 NoSQL 数据库</li>
<li>图数据库等特殊存储</li>
</ul>
<h2 data-id="heading-15">最佳实践建议</h2>
<h3 data-id="heading-16">15. 实体类设计规范</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础实体类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
    
    <span class="hljs-meta">@TableLogic</span>
    <span class="hljs-keyword">private</span> Integer deleted;
}

<span class="hljs-comment">// 业务实体类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@TableName("sys_user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseEntity</span> {
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">// 数据库字段名与实体类字段名不一致时使用</span>
    <span class="hljs-meta">@TableField("phone_number")</span>
    <span class="hljs-keyword">private</span> String phoneNumber;
    
    <span class="hljs-comment">// 不映射到数据库的字段</span>
    <span class="hljs-meta">@TableField(exist = false)</span>
    <span class="hljs-keyword">private</span> String temporaryCode;
}
</code></pre>
<h3 data-id="heading-17">16. 服务层封装建议</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 好的服务层封装</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; {
    
    <span class="hljs-comment">/**
     * 业务方法：用户注册
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">register</span><span class="hljs-params">(UserRegisterDTO registerDTO)</span> {
        <span class="hljs-comment">// 1. 校验用户名是否已存在</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> lambdaQuery()
                .eq(User::getUsername, registerDTO.getUsername())
                .exists();
        <span class="hljs-keyword">if</span> (exists) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户名已存在"</span>);
        }
        
        <span class="hljs-comment">// 2. DTO 转 Entity</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        BeanUtils.copyProperties(registerDTO, user);
        
        <span class="hljs-comment">// 3. 保存用户</span>
        <span class="hljs-keyword">return</span> save(user);
    }
    
    <span class="hljs-comment">/**
     * 安全的更新方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">safeUpdate</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不能为空"</span>);
        }
        
        <span class="hljs-comment">// 只更新非空字段</span>
        <span class="hljs-keyword">return</span> lambdaUpdate()
                .eq(User::getId, user.getId())
                .set(user.getUsername() != <span class="hljs-literal">null</span>, User::getUsername, user.getUsername())
                .set(user.getAge() != <span class="hljs-literal">null</span>, User::getAge, user.getAge())
                .set(user.getEmail() != <span class="hljs-literal">null</span>, User::getEmail, user.getEmail())
                .update();
    }
}
</code></pre>
<h3 data-id="heading-18">17. 异常处理建议</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 全局异常处理
 */</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 处理业务异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Result&lt;?&gt;&gt; handleBusinessException(BusinessException e) {
        log.error(<span class="hljs-string">"业务异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(Result.error(e.getMessage()));
    }
    
    <span class="hljs-comment">/**
     * 处理数据异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(DataAccessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Result&lt;?&gt;&gt; handleDataAccessException(DataAccessException e) {
        log.error(<span class="hljs-string">"数据访问异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(Result.error(<span class="hljs-string">"数据操作失败"</span>));
    }
}

<span class="hljs-comment">/**
 * 统一返回结果
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> Integer code;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> T data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">200</span>);
        result.setMessage(<span class="hljs-string">"成功"</span>);
        result.setData(data);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(String message)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">500</span>);
        result.setMessage(message);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p><strong>工具是为人服务的</strong>，选择适合自己项目的技术栈才是最重要的。MyBatis-Plus 在大多数业务场景下都能显著提升开发效率，值得大家深入学习和使用。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-20">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy-GJ26kl0-yT6hE3fy2KjQ" target="_blank" title="https://mp.weixin.qq.com/s/y-GJ26kl0-yT6hE3fy2KjQ" ref="nofollow noopener noreferrer">《MySQL 为什么不推荐用雪花ID 和 UUID 做主键？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1Th3DuMqYpt4Xg5hEywIww" target="_blank" title="https://mp.weixin.qq.com/s/1Th3DuMqYpt4Xg5hEywIww" ref="nofollow noopener noreferrer">《用html写了个超好用的网页主题切换插件》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FaGLep07rnMQdQLyDHBer8Q" target="_blank" title="https://mp.weixin.qq.com/s/aGLep07rnMQdQLyDHBer8Q" ref="nofollow noopener noreferrer">《还在用 WebSocket 做实时通信？SSE 可能更简单》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角]]></title>    <link>https://juejin.cn/post/7571338749198303282</link>    <guid>https://juejin.cn/post/7571338749198303282</guid>    <pubDate>2025-11-12T00:54:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749198303282" data-draft-id="7571295102851317786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-11-12T00:54:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:54:04.000Z" title="Wed Nov 12 2025 00:54:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>现在的世界是越来越魔幻，早就超出了常人的理解范畴。</p>
<p>我最近老刷淘宝，昨天不知哪来的兴致，没什么特定缘由，纯粹好奇当下的相关生态，便鬼使神差在搜索栏敲了 “DeepSeek”。翻了没两下，一家店的标题瞬间抓住了他的眼球 ——“无需部署、打开即用，全程不卡顿”，售价才 10 块钱，付款人数却已经破了 1000。</p>
<p>盯着页面琢磨了半天，越想越纳闷：不用买家本地部署，还能保证立刻响应，这到底是什么神仙操作？</p>
<p>要知道，DeepSeek 的热度虽已过去半年，但直到现在，偶尔还是能见到这玩意儿的身影，甚至可能让人猛地想起当初被它支配的日子。</p>
<p>于是点进去了，这数据还确实挺好的，DeepSeek的需求还是旺。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a209f806f0154bbfb32cc2d7dd9ba25d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=NDkVqg8rQo16YNI0ERxxdKa7dxk%3D" alt="图片" loading="lazy"/></p>
<p>按捺不住满心的好奇，我干脆直接下了单、付了款。</p>
<h2 data-id="heading-1">收到货后</h2>
<p>可等卖家发来所谓的 “产品”，当场就懵了 —— 那瞬间的冲击感，让差点以为自己不小心闯进了平行宇宙，满脑子都是 “这到底是啥？！”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75f2ae0dc9264087a0122291675f78e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=%2F8SGW97Z2fXHFZZDTt6Goa5g9jk%3D" alt="图片" loading="lazy"/></p>
<p>我第一反应直接懵了：这难道是遇到活菩萨了？居然自己部署了 DeepSeek，还开了公网供大家免费似的用？这算力得有多足啊？</p>
<p>有这资源，哥们儿直接去卖算力不比这 10 块钱一单赚得多？</p>
<p>可等定睛一看，瞬间愣住了 —— 这网址怎么这么眼熟？再仔细瞅了瞅，好家伙，居然是<a href="https://link.juejin.cn?target=https%3A%2F%2Fn.cn%2F" target="_blank" title="https://n.cn/" ref="nofollow noopener noreferrer">n.cn</a>？！</p>
<p>**这不是...360的纳米搜索？？？<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a77e83579646e5ba19dc849c5b140d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=HfC4lQjs6JD4y7vk1f7AIloJDp4%3D" alt="图片" loading="lazy"/></p>
<p>我点开另一个网址。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88340c9955a44ceca2e324c3e127abdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=r5wsvrq1SIP9YD7QqPsvQwC3Hxo%3D" alt="图片" loading="lazy"/></p>
<p>我一时间无语凝噎，我的大脑宕机了整整10秒钟。我想到了这个事情比较抽象，但是，我没想到能抽象到这种地步。因为，反差感极强，我本来会以为，哥们就卖链接，肯定不少差评，但，事情不太一样了起来。这个评论区，几乎全是好评。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71ec1059d5084f5b85b83a2b5a766179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=j4nNOmXv0cCHDdZ1720j%2BbM%2Femo%3D" alt="图片" loading="lazy"/></p>
<p>甚至有300个88VIP的好评。我一条一条的看了下去，我感觉，这个世界在我的脑中，好像更魔幻，更立体了。有用户留言说，确实不卡，输出的代码很规范。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133b1ffd54194746ba0cd58f44f05fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=MmMvPL9DXnEpNCY3MM1ARye3wIY%3D" alt="图片" loading="lazy"/></p>
<p>“可以啊，是免费的r1，跟描述一致，性价比很高，不用买会员了也。”
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c99efd8b8b49968351e3a7fa2096e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=TqbzdKi0xiRUWGwq%2FJt7oOqx2NU%3D" alt="图片" loading="lazy"/></p>
<p>**不用买会员了。我不知道你们是什么感受，我突然鼻子一酸。我看到的，忽然是一个个非常活生生、立体形象的人。</p>
<p>或许对于这些Ta们来说：白天在公司，他得忍着老板的 PUA 强撑着干活，连反驳的底气都没有 —— 这份薪资微薄的工作，是他在四五线小城唯一的糊口依靠。</p>
<p>晚上回到十几平米的出租屋，狭小的空间里塞满了不甘。他太想改变命运了，太怕一辈子困在原地，所以总琢磨着学门新本事，抓住点什么。</p>
<p>AI、大模型、席卷时代的技术革命，这些词像针一样扎着他的心。他知道这是翻身的机会，可每一次听说，都伴随着深深的恐慌 —— 怕自己追不上这股浪潮，怕被时代彻底抛弃。</p>
<p>可真要迈出脚步，才发现前路全是望不到头的坎：官网得靠 “魔法上网” 才能访问，他摸不着门道；会员订阅几十上百块一个月，抵得上他好几天的饭钱，根本舍不得花；那些部署教程里的术语，像天书一样晦涩，硬生生把他挡在门外，连入门的缝隙都不给留。</p>
<p>好不容易扒到 DeepSeek 和 ChatGPT 的官网，他咬碎了牙才掏出不便宜的会员费，以为终于摸到了门槛。可实际用起来，却满是失望 —— 不仅卡顿得让人抓狂，历史记录里还莫名冒出不属于自己的内容，钱花得冤枉又憋屈。</p>
<p>一次次尝试，一次次被现实打回原形。他就像个被遗弃在站台外的人，眼睁睁看着时代的列车呼啸而过，自己却连上车的资格都没有。那种求而不得的无力感，沉甸甸压在胸口，让他喘不过气。</p>
<p>直到那天在淘宝刷到那个 9.9 元的商品，<code>“无需部署”“打开即用”“立刻响应” </code>这几个字，像黑夜里的一束光，瞬间照亮了他的渴望。</p>
<p>他反复看了好几遍商品页面，纠结了很久 —— 兜里的钱每一分都要算计，他怕这又是一场骗局，怕最后连这两顿拼好饭的钱都打了水漂。可对改变的渴望，终究压过了所有顾虑。</p>
<p>下单后，他攥着手机等回复，收到可直接点开的链接时，手指都带着点颤抖。怀着忐忑点进去，居然真的能用，还异常流畅。</p>
<p>那一刻，他紧绷的肩膀突然垮了下来，长长舒了一口气，眼眶甚至有点发热。他觉得自己终于花最少的钱，攥住了那张三寸见方的、通往新世界的船票。</p>
<p><strong>满心欢喜地跑到评论区，他认认真真打下 “性价比很高，不用买会员了”，字里行间全是满足。他甚至偷偷窃喜，觉得自己占了天大的便宜，用 9.9 元就撬动了原本遥不可及的生产力工具。</strong></p>
<p>他把这个链接小心翼翼收进浏览器书签，像珍藏一件稀世珍宝。这是他在残酷生活里，拼尽全力才抓住的小小捷径，是支撑他继续往前走的一点希望。</p>
<p>可他不知道，这份被他视若珍宝的 “机会”，本就明晃晃摊在阳光下，对所有人免费开放。他只是恰好站在了信息的阴影里，没见过那片触手可及的光明，只能靠着这点 “微光”，笨拙又执着地追赶着时代的脚步。</p>
<p><strong>AI的发展，永不止步。</strong> <code>愿所有人都能跟上时代的洪流</code>，用自己信息差打出一片新的天地！</p>
<h3 data-id="heading-2">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 3.38 版本发布了，看看有哪些新特性]]></title>    <link>https://juejin.cn/post/7572010680896274472</link>    <guid>https://juejin.cn/post/7572010680896274472</guid>    <pubDate>2025-11-13T10:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896274472" data-draft-id="7571815997068001320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 3.38 版本发布了，看看有哪些新特性"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-13T10:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个写不完程序的猿"/> <meta itemprop="url" content="https://juejin.cn/user/4055446188735672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 3.38 版本发布了，看看有哪些新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4055446188735672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个写不完程序的猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:06:17.000Z" title="Thu Nov 13 2025 10:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">介绍</h2>
<p>欢迎回到我们定期发布的季度版本 Flutter 3.38。本次更新旨在通过点简写和 Widget 预览的更新来提升您的开发效率并优化开发者体验。感谢社区的贡献，本次版本共包含来自 145 位贡献者的 825 次提交，其中 37 位是首次贡献者。让我们深入了解一下本次版本更新的内容。</p>
<h2 data-id="heading-1">Dot shorthands</h2>
<p>编写更简洁的 Dart 代码！我们很高兴地宣布 Dart 的一项新特性——<strong>点简写</strong>！简写允许您省略 Dart 可以推断的类型，从而减少样板代码。</p>
<p>例如，你可以使用简写<code>.start</code>来代替<code>MainAxisAlignment.start</code>。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 使用简写</span>
<span class="hljs-selector-tag">Column</span> ( 
  <span class="hljs-attribute">mainAxisAlignment </span>: .start, 
  <span class="hljs-attribute">crossAxisAlignment </span>: .center, 
  <span class="hljs-attribute">children </span>: [ <span class="hljs-comment">/* ... */</span> ], 
), 

<span class="hljs-comment">// 不使用简写</span>
<span class="hljs-selector-tag">Column</span> ( 
  <span class="hljs-attribute">mainAxisAlignment </span>: MainAxisAlignment.start, 
  <span class="hljs-attribute">crossAxisAlignment </span>: CrossAxisAlignment.center, 
  <span class="hljs-attribute">children </span>: [ <span class="hljs-comment">/* … */</span> ], 
),
</code></pre>
<p>这同样适用于命名构造函数！你可以<code>.all</code>这样写<code>EdgeInsets.all</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino">填充（
  填充：.全部（<span class="hljs-number">8.0</span>），
  子元素：文本（<span class="hljs-string">'Hello world'</span>），
），
</code></pre>
<p>Dart 3.10 和 Flutter 3.38 默认启用此功能。更多信息，请查看dart.dev 上的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdart.dev%2Flanguage%2Fdot-shorthands" target="_blank" title="https://dart.dev/language/dot-shorthands" ref="nofollow noopener noreferrer">dot 简写页面。您还可以在</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dart.dev%2Fea8b952b6088" target="_blank" title="https://blog.dart.dev/ea8b952b6088" ref="nofollow noopener noreferrer">Dart 3.10 发布博</a>文中了解更多相关内容（例如 Dart hooks！）。</p>
<h2 data-id="heading-2">web</h2>
<h3 data-id="heading-3">Web 开发配置文件</h3>
<p>该<code>flutter run</code>命令现在支持 Web 设置配置文件。您可以在<code>web_dev_config.yaml</code>项目根目录的文件中指定主机、端口、证书和标头信息。将该文件检入，以便团队中的每个人都能使用相同的设置进行调试。有关更多信息，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fweb-dev-config-file" target="_blank" title="https://docs.flutter.dev/platform-integration/web/web-dev-config-file" ref="nofollow noopener noreferrer">“设置 Web 开发配置文件”</a>。</p>
<h3 data-id="heading-4">Web 开发代理设置</h3>
<p>除了现有的命令行参数外，Web 开发配置文件还支持新的代理设置。代理设置允许将对已配置路径的请求转发到另一台服务器。这使得开发能够连接到同一主机上动态端点的 Web 客户端变得更加容易。</p>
<p>有关代理设置的详细信息，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fweb-dev-config-file" target="_blank" title="https://docs.flutter.dev/platform-integration/web/web-dev-config-file" ref="nofollow noopener noreferrer">设置 Web 开发配置文件</a>。</p>
<h3 data-id="heading-5">扩展了对网页热重载的支持</h3>
<p>现在，当您在浏览器中打开 Flutter 应用的链接并运行该应用时，状态热重载功能默认启用<code>-d web-server</code>。即使同时连接多个浏览器，此功能也能正常工作。</p>
<p>与之前一样<code>-d chrome</code>，此功能可以使用标志暂时禁用<code>--no-web-experimental-hot-reload</code>。禁用此功能的功能将在未来的版本中移除，因此，如果您在开发流程中遇到问题，请使用 Dart 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdart-lang%2Fsdk%2Fissues%2Fnew%3Ftemplate%3D5_web_hot_reload.yml" target="_blank" title="https://github.com/dart-lang/sdk/issues/new?template=5_web_hot_reload.yml" ref="nofollow noopener noreferrer">Web 热重载问题模板</a>提交错误报告。更多信息，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fbuilding%23hot-reload-web" target="_blank" title="https://docs.flutter.dev/platform-integration/web/building#hot-reload-web" ref="nofollow noopener noreferrer">Web 热重载文档</a>。</p>
<h2 data-id="heading-6">框架</h2>
<p>此版本包含框架中的许多强大的新功能和改进，使开发人员能够对高级 UI、导航和平台交互进行更精细的控制。</p>
<p>现在，开发者在使用 <code>Overlay.of</code> 创建弹出窗口、对话框和其他浮动 UI 元素时拥有了更大的控制权<code>OverlayPortal</code>。现在可以<code>Overlay</code>使用 <code>Overlay.of</code> 在组件树的任何上级组件中渲染子组件<code>OverlayPortal.overlayChildLayoutBuilder</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174239" target="_blank" title="https://github.com/flutter/flutter/pull/174239" ref="nofollow noopener noreferrer">#174239</a>），从而更轻松地显示应用范围的通知或其他需要突破父组件布局限制的 UI。底层 <code>Overlay.of</code> 方法也得到了增强，变得更加健壮高效（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174315" target="_blank" title="https://github.com/flutter/flutter/pull/174315" ref="nofollow noopener noreferrer">#174315</a>）。</p>
<p>为了提供更现代化的 Android 导航体验，预测性返回路径过渡效果现已默认启用<code>MaterialApp</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173860" target="_blank" title="https://github.com/flutter/flutter/pull/173860" ref="nofollow noopener noreferrer">#173860</a>）。当用户执行返回手势时，当前路径会以动画形式消失，同时用户会看到主屏幕的预览。此外，默认页面过渡效果也已更新，以<code>FadeForwardsPageTransitionsBuilder</code>反映<code>ZoomPageTransitionsBuilder</code>原生应用的行为。</p>
<p>此次版本更新还深化了桌面集成。在 Windows 系统上，开发者现在可以访问已连接显示器的列表，并查询每个显示器的详细属性，例如分辨率、刷新率和物理尺寸（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F164460" target="_blank" title="https://github.com/flutter/flutter/pull/164460" ref="nofollow noopener noreferrer">#164460</a>）。这使得创建具有复杂窗口管理功能的应用程序成为可能。</p>
<p>最后，框架本身的容错性也得到了提升。组件生命周期回调中发生的错误（例如 <code>get_errors( </code>didUpdateWidget<code>)</code>）现在能够得到更优雅的处理，从而避免在元素树中引发级联故障（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173148" target="_blank" title="https://github.com/flutter/flutter/pull/173148" ref="nofollow noopener noreferrer">#173148</a>）。此外，<code>get_errors()</code> 也正确实现了相等性判断，确保相同的提供程序得到相同的处理，<code>ResizeImage</code>从而使图像缓存和比较更加可预测（ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172643" target="_blank" title="https://github.com/flutter/flutter/pull/172643" ref="nofollow noopener noreferrer">#172643</a>）。<code>ResizeImage</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172643" target="_blank" title="https://github.com/flutter/flutter/pull/172643" ref="nofollow noopener noreferrer"/></p>
<p>在网页上，UI 的优化仍在继续，修复了<code>RSuperellipse</code>当圆角半径大于小部件本身时出现的渲染错误（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172254" target="_blank" title="https://github.com/flutter/flutter/pull/172254" ref="nofollow noopener noreferrer">#172254</a>），现在，这种情况将被处理，以按预期生成药丸形状。</p>
<p>对于国际用户而言，检测浏览器首选语言环境的功能现在更加强大。引擎现在使用标准<code>Intl.Locale</code>Web API 来解析浏览器语言，取代了之前手动且较为脆弱的实现方式（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172964" target="_blank" title="https://github.com/flutter/flutter/pull/172964" ref="nofollow noopener noreferrer">#172964</a>）。这一改进带来了更可靠的语言环境检测，并为全球用户提供了更佳的体验。</p>
<p>一个特定于 Android 系统的漏洞（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171973" target="_blank" title="https://github.com/flutter/flutter/pull/171973" ref="nofollow noopener noreferrer">#171973</a>）已修复，该漏洞主要影响配备硬件键盘的三星设备。此前，用户与文本框交互后<code>TextField</code>，Android 输入法编辑器 (IME) 可能会卡在“过期”状态。这会导致 IME 错误地拦截“回车”或“空格”键的按下，从而阻止非文本控件（例如文本框<code>Checkbox</code>或<code>Radio</code>按钮）接收到事件。此修​​复程序确保<code>InputMethodManager</code>在文本连接关闭时正确重置 IME，清除其“过期”状态，并恢复用户可预期的硬件键盘交互。</p>
<h3 data-id="heading-7">材料和库比蒂诺更新</h3>
<p>Material 和 Cupertino 库持续发展，专注于 API 的一致性和优化的用户体验。此次版本更新带来了重要的 API 迁移、全新的组件功能以及诸多改进，让构建美观实用的用户界面变得更加轻松。</p>
<p>基于已弃用的旧版本<code>MaterialState</code>，本次版本继续推进内部向更统一的版本的迁移。这提供了一种一致且富有表现力的方式来定义控件在不同交互状态（例如按下、悬停或禁用）下<code>WidgetState</code>的外观，并且无需对现有应用进行任何更改。此次迁移已应用于多种控件及其主题，包括<code>IconButton</code>、、和（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173893" target="_blank" title="https://github.com/flutter/flutter/pull/173893" ref="nofollow noopener noreferrer">#173893</a>）。新的 API 还增强了功能和灵活性；例如，现在包含一个属性（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F169821" target="_blank" title="https://github.com/flutter/flutter/pull/169821" ref="nofollow noopener noreferrer">#169821</a>），允许以编程方式控制其视觉状态，从而为更自定义和交互式的设计打开了大门。<code>ElevatedButton``Checkbox``Switch</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173893" target="_blank" title="https://github.com/flutter/flutter/pull/173893" ref="nofollow noopener noreferrer"/><code>IconButton``statesController</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F169821" target="_blank" title="https://github.com/flutter/flutter/pull/169821" ref="nofollow noopener noreferrer"/></p>
<p>此次版本更新还引入了几个新特性和便捷的 API。<code>Badge.count</code>构造函数现在包含一个<code>maxCount</code>参数（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171054" target="_blank" title="https://github.com/flutter/flutter/pull/171054" ref="nofollow noopener noreferrer">#171054</a>），可以轻松限制显示的数量（例如，显示“99+”而不是“100”）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc36e56f6e7e457eb1916f4886662e16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=AIY9Kg%2BHsadiaQhvm3JyzoOwcyg%3D" alt="" loading="lazy"/></p>
<p>为了实现更精细的手势控制，该<code>InkWell</code>小部件现在具有<code>onLongPressUp</code>回调功能（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173221" target="_blank" title="https://github.com/flutter/flutter/pull/173221" ref="nofollow noopener noreferrer">#173221</a>），可用于触发仅在用户抬起手指时才应完成的操作。</p>
<p>Cupertino 库也在不断努力提升其 iOS 兼容性。<code>CupertinoSlidingSegmentedControl</code>新增了一个<code>isMomentary</code>属性（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F164262" target="_blank" title="https://github.com/flutter/flutter/pull/164262" ref="nofollow noopener noreferrer">#164262</a>），允许控件在不保持选中状态的情况下触发操作。为了更好地匹配原生 iOS 的行为，该控件<code>CupertinoSheet</code>在完全展开状态下向上拖动时，现在会呈现微妙的“拉伸”效果（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F168547" target="_blank" title="https://github.com/flutter/flutter/pull/168547" ref="nofollow noopener noreferrer">#168547</a>）。</p>
<p>最后，本次版本更新包含多项改进，优化了核心组件的行为。亮点包括修复了<code>DropdownMenuFormField</code>表单重置时正确清除文本字段的问题（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174937" target="_blank" title="https://github.com/flutter/flutter/pull/174937" ref="nofollow noopener noreferrer">#174937</a>），以及更新了组件以<code>SegmentedButton</code>改进焦点处理（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173953" target="_blank" title="https://github.com/flutter/flutter/pull/173953" ref="nofollow noopener noreferrer">#173953</a>）并确保其边框能够正确反映组件的状态（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172754" target="_blank" title="https://github.com/flutter/flutter/pull/172754" ref="nofollow noopener noreferrer">#172754</a>）。</p>
<h3 data-id="heading-8">解耦 Material and Cupertino</h3>
<p>我们一直在进行大量的规划工作，旨在将 Material 和 Cupertino 库与框架解耦。以下列表包含了围绕近期发布的一些设计文档展开的讨论。</p>
<p><strong>改进 flutter/packages 的发布流程，解耦后将包含 Material 和 Cupertino。</strong></p>
<ul>
<li>状态：已决定</li>
<li>思路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fu%2F1%2Fd%2F18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY%2Fedit" target="_blank" title="https://docs.google.com/document/u/1/d/18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY/edit" ref="nofollow noopener noreferrer">第一方软件包发布策略</a></li>
<li>决定：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s/edit?tab=t.0" ref="nofollow noopener noreferrer">批量发布单页说明（公开共享）</a></li>
</ul>
<p><strong>颜色和点阵速记</strong></p>
<ul>
<li>状态：已决定</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ%2Fedit%3Ftab%3Dt.0%23heading%3Dh.pub7jnop54q0" target="_blank" title="https://docs.google.com/document/d/1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ/edit?tab=t.0#heading=h.pub7jnop54q0" ref="nofollow noopener noreferrer">Flutter 基础配色方案（公开分享）</a></li>
</ul>
<p><strong>解耦测试</strong></p>
<ul>
<li>状态：进行中</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs/edit?tab=t.0" ref="nofollow noopener noreferrer">解耦框架测试（公开共享）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F177028" target="_blank" title="https://github.com/flutter/flutter/issues/177028" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></li>
</ul>
<p><strong>文本</strong></p>
<ul>
<li>状态：讨论中</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY/edit?tab=t.0" ref="nofollow noopener noreferrer">Flutter 将设计与文本解耦（公开分享）</a></li>
</ul>
<h3 data-id="heading-9">滚动：更稳健、更可预测的条形滚动</h3>
<p>此版本带来了一系列修复，使得构建复杂的滚动布局（尤其是使用<code>SliverMainAxisGroup</code>和的布局<code>SliverCrossAxisGroup</code>）更加稳健和可预测。</p>
<p>使用这些组件将多个 Sliver 分组的开发者会发现，手势处理现在更加可靠。现在可以正确计算这些组内 Sliver 的点击和其他指针事件的命中测试，确保用户交互按预期运行（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174265" target="_blank" title="https://github.com/flutter/flutter/pull/174265" ref="nofollow noopener noreferrer">#174265</a>）。</p>
<p>其他几项修复也使得滚动行为更加准确<code>SliverMainAxisGroup</code>。使用固定标题时过度滚动的问题已得到解决（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173349" target="_blank" title="https://github.com/flutter/flutter/pull/173349" ref="nofollow noopener noreferrer">#173349</a>），调用<code>showOnScreen</code>显示小片段现在可以正常工作（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171339" target="_blank" title="https://github.com/flutter/flutter/pull/171339" ref="nofollow noopener noreferrer">#171339</a>），并且内部滚动偏移计算更加精确（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174369" target="_blank" title="https://github.com/flutter/flutter/pull/174369" ref="nofollow noopener noreferrer">#174369</a>）。</p>
<p>对于构建自定义滚动视图的开发者来说，新的<code>SliverGrid.list</code>构造函数（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173925" target="_blank" title="https://github.com/flutter/flutter/pull/173925" ref="nofollow noopener noreferrer">#173925</a>）提供了一种更简洁的方式，可以从简单的子列表创建网格。</p>
<p>此次更新还改进了复杂布局中键盘和方向键用户的焦点导航体验。在具有不同滚动轴的嵌套滚动视图（例如水平轮播图的垂直列表）中，方向性焦点导航现在更加可预测，防止焦点在不同部分之间意外跳转（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172875" target="_blank" title="https://github.com/flutter/flutter/pull/172875" ref="nofollow noopener noreferrer">#172875</a>）。</p>
<h3 data-id="heading-10">无障碍设计：为所有用户提供更具包容性的体验</h3>
<p>确保所有用户都能访问应用程序是 Flutter 框架的基石。此次版本更新延续了这一承诺，赋予开发者更多程序控制权，改善了国际用户的体验，并优化了核心组件的可访问性。</p>
<p>对于构建复杂应用程序的开发者而言，此版本引入了在 iOS 上默认启用辅助功能的功能<code>WidgetsFlutterBinding.instance.ensureSemantics</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174163" target="_blank" title="https://github.com/flutter/flutter/pull/174163" ref="nofollow noopener noreferrer">#174163</a><code>debugDumpSemanticsTree</code> ）。此外，由于新增了文本输入验证结果信息，有助于更快地诊断问题（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174677" target="_blank" title="https://github.com/flutter/flutter/pull/174677" ref="nofollow noopener noreferrer">#174677</a> ），因此调试辅助功能问题也变得更加容易。</p>
<p>为了增强基于 Sliver 的滚动视图的辅助功能，我们新增了一个<code>SliverSemantics</code>组件（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F167300" target="_blank" title="https://github.com/flutter/flutter/pull/167300" ref="nofollow noopener noreferrer">#167300</a>）。与现有组件类似，开发者可以在滚动视图中<code>Semantics</code>使用该组件，为 Sliver 树的各个部分添加特定的语义信息。这对于标注标题、分配语义角色以及为屏幕阅读器添加描述性标签尤为有用，从而为用户提供更易于理解和访问的体验。<code>SliverSemantics``CustomScrollView</code></p>
<p>最后，核心组件的辅助功能持续改进。<code>CupertinoExpansionTile</code>现在默认情况下可访问（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174480" target="_blank" title="https://github.com/flutter/flutter/pull/174480" ref="nofollow noopener noreferrer">#174480</a>），并且该<code>AutoComplete</code>组件现在会向用户播报搜索结果的状态（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173480" target="_blank" title="https://github.com/flutter/flutter/pull/173480" ref="nofollow noopener noreferrer">#173480</a>）。其他改进，例如增大触摸目标<code>TimePicker</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F170060" target="_blank" title="https://github.com/flutter/flutter/pull/170060" ref="nofollow noopener noreferrer">#170060</a>），也有助于提供更便捷的开箱即用体验。</p>
<h2 data-id="heading-11">iOS</h2>
<p>我们很高兴地确认，Flutter 完全支持最新的平台版本：iOS 26、Xcode 26 和 macOS 26，这些版本均于 9 月发布。这确保您可以立即在 Apple 最新的操作系统和工具上开始开发和测试您的应用。</p>
<p>您可能已经注意到，Flutter 最新版本为 iOS 开发者带来了显著的体验提升，解决了用户长期以来的一个痛点：在物理设备上运行 Flutter 应用时，Xcode 应用必须自动启动<code>flutter run</code>。我们引入了一种新的部署方式，使用 Xcode 26 命令行工具 <code>npm run </code>devicectl<code>dev</code> 来进行应用的安装、启动和调试。这种方式无需在部署过程中调用 Xcode 应用，大多数情况下完全依赖于命令行 Xcode 构建工具。如果您遇到任何问题，可以使用 <code>npm run dev</code> 禁用此部署方式<code>flutter config --no-enable-lldb-debugging</code>，并请<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/flutter/flutter/issues/new/choose" ref="nofollow noopener noreferrer">提交 issue</a>告知我们！</p>
<p>此前，此功能依赖于 Xcode 自动化，但在 Xcode 26 中变得不稳定且容易出错，尤其是在连续运行命令时。如果您现在正在为最新的 Apple 版本进行开发，我们强烈建议您将 Flutter 版本更新到 3.38 或更高版本。</p>
<h3 data-id="heading-12">UIScene 生命周期迁移</h3>
<p>Flutter 3.38 包含了对苹果强制要求的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ftechnotes%2Ftn3187-migrating-to-the-uikit-scene-based-life-cycle" target="_blank" title="https://developer.apple.com/documentation/technotes/tn3187-migrating-to-the-uikit-scene-based-life-cycle" ref="nofollow noopener noreferrer">UIScene 生命周期</a>的重要支持。这是继苹果在 WWDC25 上宣布“在 iOS 26 之后的版本中，任何使用最新 SDK 构建的 UIKit 应用都必须使用 UIScene 生命周期，否则将无法启动”之后的一项关键且积极的更新。</p>
<p>为确保您的 iOS Flutter 应用程序在未来的 iOS 版本上保持兼容性并成功启动，需要进行迁移。</p>
<p><strong>迁移 Flutter 应用程序</strong></p>
<p>所有现有的 iOS Flutter 应用都必须迁移到新的生命周期。您可以通过两种方式完成此迁移：</p>
<ol>
<li>手动迁移：请按照 Flutter<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-flutter-apps" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-flutter-apps" ref="nofollow noopener noreferrer">网站</a>上提供的手动迁移说明进行操作。</li>
<li>自动迁移（实验性功能）：启用此实验性功能可自动处理迁移。此功能将在未来的版本中默认启用。运行以下命令：</li>
</ol>
<p><code>flutter config --enable-uiscene-migration</code></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fplans%3Fsource%3Dupgrade_membership---post_li_non_moc_upsell--3f7b258f7228---------------------------------------" target="_blank" title="https://medium.com/plans?source=upgrade_membership---post_li_non_moc_upsell--3f7b258f7228---------------------------------------" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d130648ca14f57b12f161cbe22a35b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=hLwCNkBRffP8UU%2BRs0bp8Vt4SWs%3D" alt="成为会员" loading="lazy"/></a></p>
<p><strong>迁移 Flutter 插件</strong></p>
<p>依赖应用程序生命周期事件的 Flutter 插件必须更新为使用 UIScene 生命周期事件。插件开发者应参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-flutter-plugins" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-flutter-plugins" ref="nofollow noopener noreferrer">迁移指南</a>。未迁移的插件将在未来的版本中显示警告。</p>
<p><strong>迁移嵌入式 Flutter（可选）</strong></p>
<p>对于将 Flutter 嵌入原生宿主应用程序的项目，迁移是可选的，但强烈建议进行。使用“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-adding-flutter-to-existing-app-add-to-app" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-adding-flutter-to-existing-app-add-to-app" ref="nofollow noopener noreferrer">添加到应用程序迁移指南”</a>采用 Flutter 新的 UIScene API ，可以为您的插件启用场景生命周期事件，从而确保与 Flutter 生态系统的兼容性。</p>
<h2 data-id="heading-13">安卓</h2>
<h3 data-id="heading-14">16KB页面大小兼容性</h3>
<p>升级到 Flutter 3.38 是满足<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fpractices%2Fpage-sizes" target="_blank" title="https://developer.android.com/guide/practices/page-sizes" ref="nofollow noopener noreferrer">Google Play 16 KB 页面大小兼容性要求</a>的必要准备。从<a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid-developers.googleblog.com%2F2025%2F05%2Fprepare-play-apps-for-devices-with-16kb-page-size.html" target="_blank" title="https://android-developers.googleblog.com/2025/05/prepare-play-apps-for-devices-with-16kb-page-size.html" ref="nofollow noopener noreferrer">2025 年 11 月 1 日</a>起，面向 Android 15 及更高版本的应用必须支持 16 KB 页面。此项变更可确保您的应用在高内存设备上正常运行，并带来性能提升，例如启动速度提升高达 30%。Flutter 3.38 将默认的 Android ndkVersion 更新为 NDK r28，这是原生代码实现 16 KB 页面大小支持的最低要求。</p>
<h3 data-id="heading-15">内存修复</h3>
<p>Flutter 3.38<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F173770" target="_blank" title="https://github.com/flutter/flutter/issues/173770" ref="nofollow noopener noreferrer">修复了</a>一个影响所有 Android 平台 Flutter 应用的严重内存泄漏问题。该问题（在 3.29.0 版本中引入）发生在 Activity 在退出时被销毁的情况下，无论是开发者设置中配置的销毁方式，还是由于内存不足而被系统强制终止的 Activity。</p>
<h3 data-id="heading-16">Android 依赖项更新</h3>
<p>为您的应用找到合适的 Android 依赖项版本组合通常是一项挑战，这些依赖项包括 Gradle、Android Gradle 插件 (AGP)、Kotlin Gradle 插件 (KGP)、Java 等。对于 Flutter 3.38 版本，我们在持续集成 (CI) 环境中测试并确认了以下 Android 依赖项版本组合的兼容性：</p>
<ul>
<li><strong>Java 17</strong>：Flutter 3.38 中 Android 开发的最低版本要求。</li>
<li><strong>KGP 2.2.20</strong>：该工具<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fgradle-configure-project.html%23apply-the-plugin" target="_blank" title="https://kotlinlang.org/docs/gradle-configure-project.html#apply-the-plugin" ref="nofollow noopener noreferrer">支持的最高Kotlin Gradle 插件版本。</a></li>
<li><strong>AGP 8.11.1</strong>：最新的 Android Gradle 插件版本，与 KGP 2.2.20<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fgradle-configure-project.html%23apply-the-plugin" target="_blank" title="https://kotlinlang.org/docs/gradle-configure-project.html#apply-the-plugin" ref="nofollow noopener noreferrer">兼容。</a></li>
<li><strong>Gradle 8.14</strong>：此版本与所选的 Java、KGP 和 AGP 版本兼容。请注意，AGP 8.11.1 的最低版本要求为 Gradle 8.13。</li>
</ul>
<p>为了确保您的应用能够在不同的 Flutter 版本之间无缝运行，我们强烈建议您在构建文件中使用 Flutter SDK 提供的 API 级别变量。此版本配置的值如下：</p>
<ul>
<li><code>flutter.compileSdkVersion</code>（API 36）</li>
<li><code>flutter.targetSdkVersion</code>（API 36）</li>
<li><code>flutter.minSdkVersion</code>（API 24）或更高</li>
</ul>
<h2 data-id="heading-17">引擎</h2>
<h3 data-id="heading-18">性能叠加层</h3>
<p>性能叠加层已重构，效率更高，在 Skia 和 Impeller 后端上的渲​​染时间均有所缩短。这意味着您可以以更少的开销获得更准确的性能数据。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176364" target="_blank" title="https://github.com/flutter/flutter/pull/176364" ref="nofollow noopener noreferrer">#176364</a>）</p>
<h3 data-id="heading-19"><strong>Vulkan 和 OpenGL ES</strong></h3>
<p>对 Vulkan 和 OpenGL ES 后端的诸多修复和改进提高了在更广泛设备上的稳定性和性能。这包括更好地处理管线缓存（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176322" target="_blank" title="https://github.com/flutter/flutter/pull/176322" ref="nofollow noopener noreferrer">#176322</a>）、栅栏等待器（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173085" target="_blank" title="https://github.com/flutter/flutter/pull/173085" ref="nofollow noopener noreferrer">#173085</a>）和图像布局过渡（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173884" target="_blank" title="https://github.com/flutter/flutter/pull/173884" ref="nofollow noopener noreferrer">#173884</a>）。</p>
<h3 data-id="heading-20"><strong>渲染器统一</strong></h3>
<p>CanvasKit 和 Skwasm 渲染器的统一工作仍在继续。本次版本更新包含大量重构，以在两者之间共享更多代码，这将带来更一致的用户体验，并加快未来的开发速度（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174588" target="_blank" title="https://github.com/flutter/flutter/pull/174588" ref="nofollow noopener noreferrer">#174588</a>）。</p>
<h3 data-id="heading-21">线程合并</h3>
<p>iOS 和 Android 系统中已移除选择退出线程合并的功能。欲了解更多信息，请观看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DmiW7vCmQwnw" target="_blank" title="https://www.youtube.com/watch?v=miW7vCmQwnw" ref="nofollow noopener noreferrer">精彩的线程合并</a>视频。</p>
<h2 data-id="heading-22">开发者工具和集成开发环境</h2>
<h3 data-id="heading-23">实验性小部件预览 — 更新</h3>
<p>Flutter 3.35 引入了 Widget Previews（组件预览），这是一项实验性功能，旨在收集社区的早期反馈。Flutter 3.38 版本对 Widget Previews 进行了重大改进，包括：</p>
<ul>
<li><strong>IDE 集成</strong>：我们的 VSCode 和 IntelliJ/Android Studio 插件均已更新，初步支持 Widget 预览。现在，您可以直接在 IDE 中查看预览，从而获得更流畅的开发体验。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eddd9325a394e5abc299424e8482928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=xfueeJ5rK3Rqbb3w5tpXhWW6rbg%3D" alt="" loading="lazy"/></p>
<p><em>VSCode 中嵌入了小部件预览。</em></p>
<p>在集成开发环境 (IDE) 中使用时，控件预览环境默认配置为根据当前选定的源文件筛选显示的预览：</p>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5523ec1be60e4007882e555de4dfec75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=1Tkpqux%2BBqbL1BzaaGM0GWdk1KA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>小部件预览环境主题和控件改进</strong>：小部件预览环境现在支持浅色和深色模式，以及自定义 IDE 配色方案，以匹配您的开发环境。小部件预览环境中的控件也进行了调整，以减少占用空间，从而为渲染预览腾出更多空间。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81af1c5cbc2144c9b758ba4d9111c12d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=7VtppMMTLvx0%2FW8GyEq23oz9qLQ%3D" alt="" loading="lazy"/></p>
<p><em>为小部件预览环境提供自定义主题支持。</em></p>
<ul>
<li><strong>预览可扩展性</strong>：预览注解类不再标记为 final，现在可以扩展以创建自定义预览注解，从而减少常见预览类型的样板代码。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a887ce18185646bda685fc093e14c702~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=c3rdsqe%2Fe33VUb5Ef%2F8SekvnXNA%3D" alt="" loading="lazy"/></p>
<p><em>自定义注解示例</em><code>BrightnessPreview</code> <em>。</em></p>
<ul>
<li><strong>多预览支持</strong>：新增的<code>MultiPreview</code>基类允许从单个自定义注释创建多个预览变体。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71472db634af4b63af1710fe1ab1d720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=4hpx%2BTpAupZ7lNoEpgI7XLPOehA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>预览组</strong>：类中的新分组参数<code>Preview</code>允许对相关的预览进行分组。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db78dfe644d94c439cf4b617d44b6df5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=xHQKUC6laoqz16%2FDUA7xgfy%2FVrM%3D" alt="" loading="lazy"/></p>
<p><em>预览组中多个“亮度”预览的示例。</em></p>
<ul>
<li><strong>放宽了对 @Preview 注解参数的限制</strong>：现在支持将私有常量作为<code>Preview</code>注解的参数。函数参数（例如 wrapper 和 theme）仍然需要具有公开的、静态可访问的名称。</li>
</ul>
<p>小部件预览功能目前仍处于实验阶段，您的反馈对塑造其未来至关重要。API 和用户体验尚不稳定，我们会根据您的反馈不断改进。</p>
<p>根据早期反馈，我们计划进行更多改进以提升组件预览体验，包括：</p>
<ol>
<li><strong>Flutter DevTools Widget Inspector 支持</strong>：Widget Inspector 正在更新，以支持在 widget 预览环境中检查预览效果。我们计划将检查器直接嵌入到 widget 预览器中，使其无论您处于何种开发环境都能轻松访问。</li>
<li><strong>IDE中的多项目支持</strong>：目前，组件预览器仅支持显示单个项目或Pub工作区内的预览。我们正在积极研究如何支持在IDE会话中包含多个Flutter项目的方案（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F173550" target="_blank" title="https://github.com/flutter/flutter/issues/173550" ref="nofollow noopener noreferrer">问题#173550</a>）。</li>
<li><strong>提升启动性能</strong>：我们正在研究提升启动性能的机会，以缩短初始启动时间，包括：</li>
</ol>
<ul>
<li>首次运行后启动预编译的组件预览环境</li>
<li>并行化预览检测逻辑以更好地处理大型项目</li>
</ul>
<p>首先，请查看文档，然后告诉我们您的想法！</p>
<ul>
<li><strong>阅读文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Ftools%2Fwidget-previewer" target="_blank" title="https://docs.flutter.dev/tools/widget-previewer" ref="nofollow noopener noreferrer">Flutter Widget 预览（实验性功能）入门指南</a></li>
<li><strong>提供反馈：在</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/flutter/flutter/issues/new/choose" ref="nofollow noopener noreferrer">Flutter GitHub 存储库</a>中提交问题和功能请求。</li>
<li><strong>了解更多</strong>：如需深入了解技术细节，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fflutter.dev%2Fgo%2Fwidget-previews-architecture" target="_blank" title="https://flutter.dev/go/widget-previews-architecture" ref="nofollow noopener noreferrer">Flutter Widget Previews 架构文档</a>。</li>
</ul>
<p><em><strong>重要提示</strong></em> <em>：已知 Widget Previewer 在执行某些操作后可能会崩溃或停止更新</em><code>flutter pub get</code> <em>。如果遇到此问题，请</em><code>flutter pub get</code><em>在项目中运行相关命令并重启 IDE。</em> <em>详情请参阅</em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F178317" target="_blank" title="https://github.com/flutter/flutter/issues/178317" ref="nofollow noopener noreferrer"> <em>#178317 。</em></a>**</p>
<h3 data-id="heading-24">开发者工具更新</h3>
<p>Flutter 3.38 修复了 2025 年 DevTools 用户调查中用户指出的一些主要痛点，包括：</p>
<p><strong>网络面板改进</strong></p>
<ul>
<li>使用户更容易了解面板何时正在记录网络流量。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9495" target="_blank" title="https://github.com/flutter/devtools/pull/9495" ref="nofollow noopener noreferrer">#9495</a>）</li>
<li>修复了复制粘贴网络请求相关的问题。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9472" target="_blank" title="https://github.com/flutter/devtools/pull/9472" ref="nofollow noopener noreferrer">#9472</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9482" target="_blank" title="https://github.com/flutter/devtools/pull/9482" ref="nofollow noopener noreferrer">#9482</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9485" target="_blank" title="https://github.com/flutter/devtools/pull/9485" ref="nofollow noopener noreferrer">#9485</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter-intellij%2Fpull%2F8588" target="_blank" title="https://github.com/flutter/flutter-intellij/pull/8588" ref="nofollow noopener noreferrer">#8588</a>）</li>
</ul>
<p><strong>Flutter Inspector 修复</strong></p>
<ul>
<li>修复了选择控件时有时会打开底层框架源代码而不是用户源代码的错误。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176530" target="_blank" title="https://github.com/flutter/flutter/pull/176530" ref="nofollow noopener noreferrer">#176530</a>）</li>
<li>修复了偶尔会导致无法与检查器面板顶部按钮进行交互的错误。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9327" target="_blank" title="https://github.com/flutter/devtools/pull/9327" ref="nofollow noopener noreferrer">#9327</a>）</li>
</ul>
<h2 data-id="heading-25">弃用和重大变更</h2>
<p>作为 Flutter 框架现代化和改进工作的一部分，本次版本更新包含了几个重要的弃用项和重大变更。</p>
<p>关键的构建和工具变更可能会影响自定义构建脚本。Flutter <code>version</code>SDK 根目录下的文件已被移除，取而代之的是位于 [<code>flutter.version.json</code>此处应填写路径] 的新文件<code>bin/cache</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172793" target="_blank" title="https://github.com/flutter/flutter/pull/172793" ref="nofollow noopener noreferrer">#172793</a>）。此外，该<code>AssetManifest.json</code>文件不再默认生成（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172594" target="_blank" title="https://github.com/flutter/flutter/pull/172594" ref="nofollow noopener noreferrer">#172594</a>）。</p>
<p>其他显著变化包括：</p>
<ul>
<li>为了使行为更可预测，包含操作的 SnackBar 将不再自动关闭（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173084" target="_blank" title="https://github.com/flutter/flutter/pull/173084" ref="nofollow noopener noreferrer">#173084</a>）。</li>
<li>构造函数<code>OverlayPortal.targetsRootOverlay</code>已被弃用，取而代之的是更灵活的<code>OverlayPortal</code>（<code>overlayLocation: OverlayChildLocation.rootOverlay</code>）。</li>
<li>的几个属性<code>CupertinoDynamicColor</code>，例如<code>withAlpha</code>和<code>withOpacity</code>，现在已被弃用，取而代之的是标准<code>Color</code>方法（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171160" target="_blank" title="https://github.com/flutter/flutter/pull/171160" ref="nofollow noopener noreferrer">#171160</a>）。</li>
<li>Flutter 3.38 要求 Android 的最低 Java 版本为 17，与<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gradle.org%2Fcurrent%2Fuserguide%2Fcompatibility.html" target="_blank" title="https://docs.gradle.org/current/userguide/compatibility.html" ref="nofollow noopener noreferrer">Gradle 8.14</a>（2025 年 7 月发布）的最低要求一致。</li>
</ul>
<p>有关这些变更和其他变更的更多详细信息和迁移指南，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes" target="_blank" title="https://docs.flutter.dev/release/breaking-changes" ref="nofollow noopener noreferrer">重大变更页面</a>。</p>
<h2 data-id="heading-26">结尾</h2>
<p>Flutter 3.38 改动还是挺多的， 要升级的还得等等看看，避免在生产环境使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ajax 数据请求详解与实战]]></title>    <link>https://juejin.cn/post/7572021695293980722</link>    <guid>https://juejin.cn/post/7572021695293980722</guid>    <pubDate>2025-11-13T10:10:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695293980722" data-draft-id="7572016447804555290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ajax 数据请求详解与实战"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-13T10:10:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="T___T"/> <meta itemprop="url" content="https://juejin.cn/user/1599155645973066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ajax 数据请求详解与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1599155645973066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    T___T
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:10:29.000Z" title="Thu Nov 13 2025 10:10:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，<strong>网页与服务器的数据交互</strong>已经成为核心功能之一。<br/>
而支撑这一功能的技术之一，正是 <strong>Ajax（Asynchronous JavaScript and XML）</strong> 。<br/>
今天我们就来系统了解一下 Ajax 的工作原理、请求流程以及一个完整的示例。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 Ajax？</h2>
<p><strong>Ajax</strong> 全称是 <strong>异步 JavaScript 和 XML</strong>，<br/>
中文意思是“异步的 JavaScript 与 XML”。</p>
<p>虽然名字里有 XML，但如今开发中我们更多使用 <strong>JSON</strong> 格式来传输数据。<br/>
它最大的特点是：<strong>在不刷新页面的情况下与服务器通信，动态更新网页内容。</strong></p>
<hr/>
<h2 data-id="heading-1">二、Ajax 的基本工作流程</h2>
<p>Ajax 的实现依赖浏览器内置的一个对象：<code>XMLHttpRequest</code>（简称 XHR）。<br/>
通过这个对象，我们可以主动发起 HTTP 请求并接收响应。</p>
<p>流程如下：</p>
<ol>
<li>
<p><strong>创建请求对象</strong></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>配置请求信息</strong></p>
<pre><code class="hljs language-python" lang="python">xhr.<span class="hljs-built_in">open</span>(method, url, <span class="hljs-keyword">async</span>);
</code></pre>
<ul>
<li><code>method</code>：请求方式（如 <code>GET</code>、<code>POST</code>）</li>
<li><code>url</code>：目标接口地址</li>
<li><code>async</code>：是否异步（<code>true</code> 为异步，<code>false</code> 为同步）</li>
</ul>
</li>
<li>
<p><strong>发送请求</strong></p>
<pre><code class="hljs language-ini" lang="ini">xhr.send()<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>监听请求状态变化</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">xhr.onreadystatechange</span> = function() {
    if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
        const <span class="hljs-attr">data</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;</span>
        console.log(data)<span class="hljs-comment">;</span>
    }
}<span class="hljs-comment">;</span>
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">三、readyState 状态说明</h2>
<p>在 Ajax 请求过程中，<code>readyState</code> 表示请求的不同阶段：</p>



































<table><thead><tr><th>状态码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>初始化</td><td>请求未初始化</td></tr><tr><td>1</td><td>打开</td><td>已调用 <code>open()</code>，还未发送</td></tr><tr><td>2</td><td>发送</td><td>已发送请求，接收到响应头</td></tr><tr><td>3</td><td>接收</td><td>正在接收服务器数据</td></tr><tr><td>4</td><td>完成</td><td>请求完成，已接收到全部响应数据</td></tr></tbody></table>
<p>同时要注意：</p>
<ul>
<li><code>xhr.status</code> 表示 HTTP 响应状态（例如 <code>200</code> 表示成功）。</li>
<li><code>xhr.responseText</code> 是服务器返回的字符串数据。</li>
</ul>
<hr/>
<h2 data-id="heading-3">四、实战示例：请求 GitHub 数据</h2>
<p>下面是一个完整的 Ajax 请求示例，用来获取 GitHub 上某组织的成员数据：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Ajax 数据请求<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"members"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 1. 创建 XMLHttpRequest 对象</span>
        <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

        <span class="hljs-comment">// 2. 打开请求 (异步)</span>
        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 3. 监听状态变化</span>
        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
                <span class="hljs-comment">// 4. 解析 JSON 数据</span>
                <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

                <span class="hljs-comment">// 5. 渲染到页面</span>
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members'</span>).<span class="hljs-property">innerHTML</span> =
                    data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
            }
        };

        <span class="hljs-comment">// 6. 发送请求</span>
        xhr.<span class="hljs-title function_">send</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>执行后，浏览器会在控制台打印出返回的数据，同时在网页中显示成员列表。</p>
<hr/>
<h2 data-id="heading-4">五、同步与异步的区别</h2>
<ul>
<li><strong>同步请求（async = false）</strong> ：<br/>
浏览器会等待服务器响应后再执行后续代码，页面会“卡住”。</li>
<li><strong>异步请求（async = true）</strong> ：<br/>
浏览器不会等待，能继续执行后续代码，响应回来后再触发回调函数。<br/>
—— 这正是 Ajax 的核心优势所在。</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、现代替代方案：Fetch 与 Axios</h2>
<p>如今，在实际开发中，我们更常用以下方式：</p>
<ul>
<li><strong>Fetch API</strong>：更简洁现代的异步请求方式。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; console.log(data))
  .catch(<span class="hljs-attr">err</span> =&gt; console.error(err))<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">🧩 七、小结</h2>





























<table><thead><tr><th>要点</th><th>内容</th></tr></thead><tbody><tr><td>Ajax 全称</td><td>异步 JavaScript 和 XML</td></tr><tr><td>核心对象</td><td>XMLHttpRequest</td></tr><tr><td>关键方法</td><td><code>open()</code>、<code>send()</code>、<code>onreadystatechange</code></td></tr><tr><td>常用属性</td><td><code>readyState</code>、<code>status</code>、<code>responseText</code></td></tr><tr><td>主要用途</td><td>实现网页的动态数据加载，不刷新页面即可更新内容</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">✅ 结语</h3>
<p>Ajax 是前端与服务器通信的基础技术之一。<br/>
理解其底层原理不仅能帮助你更好地使用 <code>fetch</code>，<br/>
更能让你彻底理解<strong>浏览器异步通信机制</strong>的本质。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新MCP规范解读，看这篇就够了！]]></title>    <link>https://juejin.cn/post/7571456639477006346</link>    <guid>https://juejin.cn/post/7571456639477006346</guid>    <pubDate>2025-11-12T07:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571456639477006346" data-draft-id="7571416207972499506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新MCP规范解读，看这篇就够了！"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-12T07:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新MCP规范解读，看这篇就够了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:59:53.000Z" title="Wed Nov 12 2025 07:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP是什么? 为什么需要它?</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67c9ad979a2434989229286027f7185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539193&amp;x-signature=AvWJDuUolC0sslAql0%2FE8bjN4jg%3D" alt="" loading="lazy"/><br/>
想象一下，你正在开发一个 AI 编程助手，它需要:</p>
<ul>
<li>读取和修改项目文件</li>
<li>查询数据库Schema</li>
<li>搜索代码仓库</li>
<li>执行Git操作</li>
</ul>
<p>传统做法是为每个数据源写一套专用代码，不同团队重复造轮子。<strong>Model Context Protocol(MCP)</strong> 就是为了解决这个问题而生的开放标准协议。</p>
<p><strong>通俗理解</strong>: MCP就像是「AI应用的USB接口标准」。就像USB让不同设备都能接入电脑一样，MCP让不同的数据源和工具都能以统一方式接入AI应用。</p>
<p><strong>实际案例</strong>: 在Claude Desktop中，你可以配置多个官方MCP服务器:</p>
<ul>
<li><strong>Filesystem服务器</strong>: 安全地读写本地文件，有权限控制</li>
<li><strong>SQLite服务器</strong>: 查询和分析SQLite数据库，自动生成SQL</li>
<li><strong>GitHub服务器</strong>: 搜索仓库、创建Issue、管理PR</li>
</ul>
<p>你的AI应用只需实现一个MCP客户端，就能连接所有服务器，无需为每个服务器写专用代码。</p>
<h2 data-id="heading-1">二、架构设计： 三个角色的分工</h2>
<p>MCP采用<strong>宿主-客户端-服务器</strong>三层架构，就像一家公司的组织结构:</p>
<p><strong>宿主(Host)</strong> = 总经理</p>
<ul>
<li>管理所有客户端</li>
<li>控制安全策略和权限</li>
<li>负责AI模型的调用</li>
</ul>
<p><strong>客户端(Client)</strong> = 部门经理</p>
<ul>
<li>客户端负责连接服务器</li>
<li>负责双方的沟通协调</li>
<li>转发消息和通知</li>
</ul>
<p><strong>服务器(Server)</strong> = 业务专员</p>
<ul>
<li>提供具体功能(资源、工具、提示模板)</li>
<li>可以是本地程序或远程服务</li>
<li>不知道其他服务器的存在</li>
</ul>
<h2 data-id="heading-2">三、协议约定：统一规范与个性化扩展</h2>
<p><strong>每个MCP服务器提供的工具、资源都不一样，但它们都遵循相同的MCP协议规范。</strong></p>
<h3 data-id="heading-3">3.1 协议的分层设计</h3>
<p>MCP采用 <strong>基础协议 + 功能扩展</strong> 的设计，就像HTTP协议一样:</p>
<p><strong>核心层(所有实现必须支持)</strong> :</p>
<ul>
<li>JSON-RPC 2.0消息格式</li>
<li>初始化握手流程(initialize/initialized)</li>
<li>基本错误处理</li>
</ul>
<p><strong>功能层(按需选择)</strong> :</p>
<ul>
<li>Resources、Prompts、Tools(服务器端)</li>
<li>Roots、Sampling、Elicitation(客户端)</li>
</ul>
<p><strong>这样设计的好处</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">统一的基础协议 → 保证互操作性
<span class="hljs-bullet">     +</span>
灵活的功能选择 → 满足不同场景需求
<span class="hljs-code">     ↓
既标准化又可扩展
</span></code></pre>
<h3 data-id="heading-4">3.2 协议约定的过程</h3>
<p><strong>步骤1: 基础协议是固定的</strong><br/>
所有MCP服务器和客户端都遵循相同的JSON-RPC 2.0格式:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 请求格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 必须是2.0</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 唯一标识</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"方法名"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 要调用的方法</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 参数对象</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 响应格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 对应请求的ID</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 成功结果</span>
  <span class="hljs-comment">// 或 "error": {...}    // 错误信息</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 能力在初始化时协商</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端发起初始化</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 我支持LLM采样</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>           <span class="hljs-comment">// 我支持根目录</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyClient"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 我提供工具</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>       <span class="hljs-comment">// 我提供资源</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLiteServer"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>协商完成后，双方都知道对方支持什么功能，<strong>只使用交集部分</strong>。</p>
<p><strong>步骤3: 方法名称是标准化的</strong><br/>
MCP规范定义了标准方法名:</p>








































<table><thead><tr><th>功能</th><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td>列出资源</td><td><code>resources/list</code></td><td>固定方法名</td></tr><tr><td>读取资源</td><td><code>resources/read</code></td><td>固定方法名</td></tr><tr><td>列出工具</td><td><code>tools/list</code></td><td>固定方法名</td></tr><tr><td>调用工具</td><td><code>tools/call</code></td><td>固定方法名</td></tr><tr><td>列出提示</td><td><code>prompts/list</code></td><td>固定方法名</td></tr><tr><td>获取提示</td><td><code>prompts/get</code></td><td>固定方法名</td></tr></tbody></table>
<p><strong>步骤4: 具体内容是个性化的</strong><br/>
虽然方法名固定，但每个服务器返回的<strong>具体数据</strong>不同:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// SQLite服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行SQL查询"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list_tables"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"列出所有表"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// Filesystem服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"读取文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"write_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"写入文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search_files"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"搜索文件"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">3.3 协议发现机制</h3>
<p>客户端如何知道服务器有哪些工具?</p>
<p><strong>第一步：列举</strong></p>
<pre><code class="hljs language-css" lang="css">客户端 → 服务器: {"method": <span class="hljs-string">"tools/list"</span>}
服务器 → 客户端: {
  "tools": [
    {
      "name": <span class="hljs-string">"query"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
      <span class="hljs-string">"inputSchema"</span>: {           // JSON Schema定义输入格式
        "type": <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
          "sql": {"type": <span class="hljs-string">"string"</span>}
        }
      }
    }
  ]
}
</code></pre>
<p><strong>第二步：调用</strong></p>
<pre><code class="hljs language-json" lang="json">客户端 → 服务器<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 使用第一步获得的工具名</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"sql"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SELECT * FROM users"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点</strong>:通过JSON Schema，客户端知道如何正确调用工具，无需硬编码。</p>
<h2 data-id="heading-6">四、协议基础：如何通信?</h2>
<p>MCP基于JSON-RPC 2.0构建，这是一个成熟的远程过程调用协议。理解这一层对掌握MCP至关重要。</p>
<h3 data-id="heading-7">4.1 JSON-RPC 2.0基础</h3>
<p><strong>消息类型</strong></p>
<p>MCP中有三种基本消息类型。<br/>
<strong>1. 请求(Request)</strong> - 期待响应</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,           <span class="hljs-regexp">//</span> 协议版本,必须是<span class="hljs-string">"2.0"</span>
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,                     <span class="hljs-regexp">//</span> 请求唯一标识(字符串或数字)
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>,     <span class="hljs-regexp">//</span> 要调用的方法名
  <span class="hljs-string">"params"</span>: {                  <span class="hljs-regexp">//</span> 可选的参数对象
    <span class="hljs-string">"cursor"</span>: <span class="hljs-string">"page2"</span>
  }
}
</code></pre>
<p><strong>2. 响应(Response)</strong> - 对请求的回复</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 成功响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                     <span class="hljs-comment">// 必须与请求的id相同</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 成功结果</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行查询"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 错误响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 错误对象</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-32602</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 错误码(整数)</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"参数无效"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 错误描述</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 可选的额外信息</span>
      <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cursor"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式错误"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 通知(Notification)</strong> - 单向消息,无需响应</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/resources/updated"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 通知方法名</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                                   <span class="hljs-comment">// 通知参数</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/data.json"</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// 注意:没有id字段</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>标准错误码</strong></p>
<p>MCP使用JSON-RPC 2.0的标准错误码:</p>








































<table><thead><tr><th>错误码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>-32700</td><td>Parse error</td><td>JSON解析错误</td></tr><tr><td>-32600</td><td>Invalid Request</td><td>无效的请求格式</td></tr><tr><td>-32601</td><td>Method not found</td><td>方法不存在</td></tr><tr><td>-32602</td><td>Invalid params</td><td>参数无效</td></tr><tr><td>-32603</td><td>Internal error</td><td>服务器内部错误</td></tr><tr><td>-32002</td><td>Resource not found</td><td>资源未找到(MCP扩展)</td></tr></tbody></table>
<h3 data-id="heading-8">4.2 能力协商详解</h3>
<p>能力协商是MCP连接建立的第一步，决定了整个会话中可用的功能。</p>
<p><strong>初始化流程详解</strong></p>
<p><strong>阶段1: 客户端发起初始化</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 客户端支持的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 客户端能力声明</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持根目录</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持根目录变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 支持LLM采样</span>
      <span class="hljs-attr">"elicitation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 支持用户询问</span>
      <span class="hljs-attr">"experimental"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                <span class="hljs-comment">// 实验性功能</span>
        <span class="hljs-attr">"customFeature"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>            <span class="hljs-comment">// 自定义功能</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 客户端信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyAIApp"</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 程序名(必填)</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 版本号(必填)</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的AI应用"</span>             <span class="hljs-comment">// 显示名称(可选)</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段2: 服务器响应能力</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 服务器选择的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 服务器能力声明</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 支持资源</span>
        <span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 支持资源订阅</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持资源列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持工具</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                     <span class="hljs-comment">// 支持提示模板</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>           <span class="hljs-comment">// 不支持列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"logging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>                    <span class="hljs-comment">// 支持日志输出</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 服务器信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite-mcp-server"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.1.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLite MCP服务器"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"instructions"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"此服务器提供SQLite数据库访问能力"</span>  <span class="hljs-comment">// 可选的使用说明</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段3: 客户端确认就绪</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/initialized"</span>  <span class="hljs-comment">// 无id,这是通知</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>协议版本协商规则</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">客户端请求版本: <span class="hljs-string">"2024-11-05"</span>
         ↓
    服务器支持?
    ↙        ↘
  支持        不支持
   ↓            ↓
返回相同版本  返回服务器支持的最新版本
   ↓            ↓
协商成功    客户端检查是否支持
              ↙        ↘
           支持        不支持
            ↓            ↓
         协商成功     断开连接
</code></pre>
<p><strong>实际示例</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 场景1: 版本匹配</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  ✅ 成功

<span class="hljs-comment">// 场景2: 服务器版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-06-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果不支持则断开

<span class="hljs-comment">// 场景3: 客户端版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-01-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果支持则降级使用
</code></pre>
<p><strong>能力交集计算</strong></p>
<p>初始化后,双方只能使用<strong>共同支持的能力</strong>:</p>
<pre><code class="hljs language-css" lang="css">客户端能力: {roots, sampling, elicitation}
服务器能力: {resources, tools, prompts}
         ↓
   可用功能集合
   ├─ 客户端 → 服务器: resources, tools, prompts
   └─ 服务器 → 客户端: roots, sampling, elicitation
</code></pre>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 客户端代码示例</span>
<span class="hljs-keyword">if</span> server_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"tools"</span>):
    <span class="hljs-meta"># 服务器支持工具,可以调用</span>
    tools = <span class="hljs-keyword">await</span> session.list_tools()
<span class="hljs-keyword">else</span>:
    <span class="hljs-meta"># 服务器不支持工具,跳过</span>
    print(<span class="hljs-string">"服务器不提供工具功能"</span>)

<span class="hljs-keyword">if</span> client_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sampling"</span>):
    <span class="hljs-meta"># 客户端支持采样,服务器可以请求</span>
    <span class="hljs-meta"># (服务器端会检查这个能力)</span>
    pass
</code></pre>
<h3 data-id="heading-9">4.3 连接生命周期深入</h3>
<p><strong>完整的消息时序图</strong></p>
<pre><code class="hljs language-scss" lang="scss">客户端                                            服务器
  │                                              │
  │  <span class="hljs-number">1</span>. initialize (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">2</span>. initialize (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">3</span>. initialized (通知)                        │ 
  ├──────────────────────────────────────&gt;│
  │                                              │
  │═══════════ 正常操作阶段 ════════════        │
  │                                              │
  │  <span class="hljs-number">4</span>. tools/list (请求)                         │
  ├──────────────────────────────────────&gt;│
  │                                              │
  │  <span class="hljs-number">5</span>. tools/list (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {tools: [...]}                           │
  │                                              │
  │  <span class="hljs-number">6</span>. tools/call (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {name: <span class="hljs-string">"query"</span>, arguments: {...}}        │
  │                                              │
  │  <span class="hljs-number">7</span>. notifications/progress (通知)             │
  │&lt;──────────────────────────────────────┤
  │     {progress: <span class="hljs-number">50</span>, total: <span class="hljs-number">100</span>}               │
  │                                              │
  │  <span class="hljs-number">8</span>. tools/call (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {<span class="hljs-attribute">content</span>: [...]}                         │
  │                                              │
  │  <span class="hljs-number">9</span>. notifications/resources/updated          │
  │&lt;──────────────────────────────────────┤
  │     {uri: <span class="hljs-string">"file://..."</span>}                      │
  │                                              │
  │═══════════ 关闭阶段 ═══════════           │
  │                                              │
  │  <span class="hljs-number">10</span>. 关闭stdin                               │
  ├─────────────X                             │
  │                                             │
  │                                          服务器退出
</code></pre>
<p><strong>初始化前的限制</strong></p>
<p>在<code>initialized</code>通知发送前:</p>
<p><strong>客户端只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>请求</li>
<li>✅ <code>ping</code>请求(用于保活)</li>
<li>❌ 其他任何请求</li>
</ul>
<p><strong>服务器只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>响应</li>
<li>✅ <code>ping</code>请求</li>
<li>✅ <code>logging</code>通知(日志)</li>
<li>❌ 其他任何消息</li>
</ul>
<p><strong>违反限制的后果</strong>:</p>
<pre><code class="hljs language-css" lang="css">// 客户端在初始化前调用tools/list
请求: {"method": <span class="hljs-string">"tools/list"</span>}
响应: {
  "error": {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32600</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"会话未初始化"</span>
  }
}
</code></pre>
<p><strong>超时和重试机制</strong></p>
<p><strong>请求超时</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># 设置30秒超时</span>
<span class="hljs-keyword">try</span>:
    result = <span class="hljs-keyword">await</span> asyncio.wait_for(
        session.call_tool(<span class="hljs-string">"slow_operation"</span>, {}),
        timeout=<span class="hljs-number">30.0</span>
    )
<span class="hljs-keyword">except</span> asyncio.TimeoutError:
    <span class="hljs-comment"># 发送取消通知</span>
    <span class="hljs-keyword">await</span> session.send_notification(
        <span class="hljs-string">"notifications/cancelled"</span>,
        {<span class="hljs-string">"requestId"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"reason"</span>: <span class="hljs-string">"超时"</span>}
    )
</code></pre>
<p><strong>进度通知重置超时</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 当收到进度通知时,可以重置超时计时器</span>
<span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># 基础超时</span>
<span class="hljs-attr">max_timeout</span> = <span class="hljs-number">300</span>  <span class="hljs-comment"># 最大超时(5分钟)</span>

while True:
    try:
        <span class="hljs-attr">msg</span> = await wait_for_message(timeout)
        if <span class="hljs-attr">msg.method</span> == <span class="hljs-string">"notifications/progress"</span>:
            <span class="hljs-comment"># 收到进度,重置超时</span>
            <span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>
    except TimeoutError:
        <span class="hljs-comment"># 超时处理</span>
        break
</code></pre>
<h3 data-id="heading-10">4.4 传输方式对比</h3>
<p><strong>stdio传输详解</strong></p>
<p><strong>优点</strong>:</p>
<ul>
<li>✅ 简单直接,适合本地开发</li>
<li>✅ 进程隔离,安全性好</li>
<li>✅ 自动管理生命周期</li>
<li>✅ 无需网络配置</li>
</ul>
<p><strong>缺点</strong>:</p>
<ul>
<li>❌ 只能本地使用</li>
<li>❌ 不支持多客户端</li>
<li>❌ 调试相对困难</li>
</ul>
<p><strong>消息格式</strong>:</p>
<pre><code class="hljs">消息1\n
消息2\n
消息3\n
</code></pre>
<p>每个JSON对象占一行,以<code>\n</code>分隔。</p>
<p><strong>HTTP传输详解</strong></p>
<p><strong>架构</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────┐         HTTP POST         ┌─────────┐
│         ├──────────────────────────&gt;│         │
│ 客户端  │  请求/通知/响应(JSON-RPC) │ 服务器  │
│         │&lt;──────────────────────────┤         │
└─────────┘     HTTP 响应/SSE流       └─────────┘
             (application/json 或
              text/event-stream)
</code></pre>
<p><strong>发送消息(POST)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash">POST /mcp HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Accept: application/json, text/event-stream
Mcp-Session-Id: abc123

{<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:1,<span class="hljs-string">"method"</span>:<span class="hljs-string">"tools/list"</span>}
</code></pre>
<p><strong>立即响应(JSON)</strong> :</p>
<pre><code class="hljs language-css" lang="css">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Content</span>-Type: application/json

{"jsonrpc":<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{"tools":[...]}}
</code></pre>
<p><strong>流式响应(SSE)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
Content-Type: <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123

<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">25</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">2</span>  
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">50</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">3</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{<span class="hljs-string">"content"</span>:[...]}}
</code></pre>
<p><strong>接收服务器消息(GET)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">GET</span> /mcp HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">Host:</span> localhost:<span class="hljs-number">8080</span>
<span class="hljs-symbol">Accept:</span> <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123
Last-<span class="hljs-keyword">Event</span>-ID: <span class="hljs-number">42</span>
</code></pre>
<p><strong>会话管理</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端设置会话ID</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/mcp"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_mcp</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"initialize"</span>:
        session_id = generate_session_id()
        <span class="hljs-keyword">return</span> Response(
            content=json.dumps(result),
            headers={<span class="hljs-string">"Mcp-Session-Id"</span>: session_id}
        )

<span class="hljs-comment"># 客户端后续请求携带会话ID</span>
<span class="hljs-meta">@client.request</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">method, params</span>):
    headers = {}
    <span class="hljs-keyword">if</span> self.session_id:
        headers[<span class="hljs-string">"Mcp-Session-Id"</span>] = self.session_id
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> http.post(
        <span class="hljs-string">"/mcp"</span>,
        json={<span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>, <span class="hljs-string">"method"</span>: method, <span class="hljs-string">"params"</span>: params},
        headers=headers
    )
</code></pre>
<p><strong>断线重连</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_sse</span>(<span class="hljs-params">last_event_id=<span class="hljs-literal">None</span></span>):
    headers = {<span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/event-stream"</span>}
    <span class="hljs-keyword">if</span> last_event_id:
        headers[<span class="hljs-string">"Last-Event-ID"</span>] = last_event_id
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.stream(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/mcp"</span>, headers=headers) <span class="hljs-keyword">as</span> stream:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> stream.aiter_lines():
            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">"id:"</span>):
                last_event_id = line[<span class="hljs-number">3</span>:].strip()
            <span class="hljs-keyword">elif</span> line.startswith(<span class="hljs-string">"data:"</span>):
                data = json.loads(line[<span class="hljs-number">5</span>:])
                <span class="hljs-keyword">yield</span> data, last_event_id
</code></pre>
<h3 data-id="heading-11">4.5 实际通信示例</h3>
<p>让我们看一个完整的SQLite查询场景:</p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-number">1</span>. 列出工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>
}

服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"result"</span>: {
    "tools": [
      {
        "name": <span class="hljs-string">"query"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
        <span class="hljs-string">"inputSchema"</span>: {
          "type": <span class="hljs-string">"object"</span>,
          <span class="hljs-string">"properties"</span>: {
            "sql": {"type": <span class="hljs-string">"string"</span>}
          },
          "required": [<span class="hljs-string">"sql"</span>]
        }
      }
    ]
  }
}

// <span class="hljs-number">2</span>. 调用查询工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/call"</span>,
  <span class="hljs-string">"params"</span>: {
    "name": <span class="hljs-string">"query"</span>,
    <span class="hljs-string">"arguments"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>
    },
    "_meta": {
      "progressToken": <span class="hljs-string">"query-123"</span>  // 请求进度通知
    }
  }
}

// <span class="hljs-number">3</span>. 服务器发送进度(异步通知)
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"notifications/progress"</span>,
  <span class="hljs-string">"params"</span>: {
    "progressToken": <span class="hljs-string">"query-123"</span>,
    <span class="hljs-string">"progress"</span>: <span class="hljs-number">50</span>,
    <span class="hljs-string">"total"</span>: <span class="hljs-number">100</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"正在扫描users表..."</span>
  }
}

// <span class="hljs-number">4</span>. 返回查询结果
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    "<span class="hljs-attribute">content</span>": [
      {
        "type": <span class="hljs-string">"text"</span>,
        <span class="hljs-string">"text"</span>: <span class="hljs-string">"查询结果: 1,234个活跃用户"</span>
      }
    ],
    "isError": false
  }
}

// <span class="hljs-number">5</span>. 如果查询出错
服务器 → 客户端(错误情况):
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"error"</span>: {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32603</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"SQL语法错误"</span>,
    <span class="hljs-string">"data"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>,
      <span class="hljs-string">"error"</span>: <span class="hljs-string">"near "</span>WHERE<span class="hljs-string">": syntax error"</span>,
      <span class="hljs-string">"position"</span>: <span class="hljs-number">35</span>
    }
  }
}
</code></pre>
<p>这就是MCP通信的完整过程!通过JSON-RPC 2.0，客户端和服务器可以进行结构化、类型安全的通信。</p>
<h2 data-id="heading-12">五、服务器能力：三种核心功能</h2>
<p>MCP服务器可以提供三种功能。</p>
<h3 data-id="heading-13">5.1 Resources(资源)：应用决定用什么</h3>
<p><strong>资源就是数据</strong>，比如文件内容、数据库记录、API响应。</p>
<p><strong>谁控制</strong>: 应用程序决定把哪些资源提供给AI</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出所有可用资源</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 读取某个资源</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/read"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/main.py"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>资源URI示例</strong>:</p>
<ul>
<li><code>file:///project/src/main.py</code> - 文件</li>
<li><code>db://schema/users</code> - 数据库表结构</li>
<li><code>git://commits/main</code> - Git提交历史</li>
<li><code>https://api.example.com/data</code> - Web API</li>
</ul>
<p><strong>订阅变更</strong>: 可以订阅资源,当它变化时自动收到通知。</p>
<p><strong>实际案例</strong>: Filesystem服务器暴露资源</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///Users/alice/project/src/main.py"</span>,  <span class="hljs-comment">// Python源文件</span>
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"main.py"</span>,                                  <span class="hljs-comment">// 文件名</span>
  <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,                        <span class="hljs-comment">// 文件类型</span>
  <span class="hljs-string">"text"</span>: <span class="hljs-string">"import os<span class="hljs-subst">\n</span>def main()..."</span>                  <span class="hljs-comment">// 文件内容</span>
}
</code></pre>
<p>客户端AI可以读取这个资源，理解代码结构后提供重构建议或生成测试。</p>
<h3 data-id="heading-14">5.2 Prompts(提示模板)：用户选择用什么</h3>
<p><strong>什么是Prompt?</strong></p>
<p>Prompt就像是「对话模板」或「快捷指令」，把常用的复杂指令预设好，用户一键调用。用生活中的例子类比，就像微信的「快捷回复」或IDE中的「代码片段(Snippet)」。</p>
<p><strong>为什么需要Prompt?</strong><br/>
场景1:没有Prompt时</p>
<pre><code class="hljs language-markdown" lang="markdown">用户每次都要输入:
"请分析这个Git仓库最近一周的提交,统计:
<span class="hljs-bullet">1.</span> 总提交次数
<span class="hljs-bullet">2.</span> 每个作者的贡献
<span class="hljs-bullet">3.</span> 修改的主要文件
<span class="hljs-bullet">4.</span> 是否有破坏性变更
请用表格格式输出"
</code></pre>
<p>场景2:有Prompt后</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户只需:</span>
1. 点击 <span class="hljs-string">"/analyze-commits"</span> 命令
2. 选择分支 <span class="hljs-string">"main"</span>
3. AI自动执行完整分析
</code></pre>
<p><strong>Prompt的数据结构</strong></p>
<p><strong>定义一个Prompt</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// Prompt的唯一标识</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"提交历史分析"</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 用户界面显示的名称</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析Git提交并生成报告"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 功能说明</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                          <span class="hljs-comment">// 需要的参数列表</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 参数名</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"要分析的分支名"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 参数说明</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>                    <span class="hljs-comment">// 是否必填</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// 时间范围</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"起始日期(如:7 days ago)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>                   <span class="hljs-comment">// 可选参数</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"author"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 作者过滤</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"只看某个作者的提交"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际使用示例</strong></p>
<p><strong>步骤1: 列出所有可用的Prompt</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端请求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prompts/list"</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"📊 提交历史分析"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析指定分支的提交历史,生成统计报告"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"review_code"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🔍 代码审查"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对代码进行质量审查和改进建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file_path"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"focus"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explain_error"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🐛 错误诊断"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"解释错误信息并提供修复建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error_message"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 用户在界面上看到这些选项</strong></p>
<pre><code class="hljs language-bash" lang="bash">━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  可用命令:
  
  📊 /analyze-commits
     分析指定分支的提交历史
     
  🔍 /review-code  
     对代码进行质量审查
     
  🐛 /explain-error
     解释错误信息并修复
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>步骤3: 用户选择并填写参数</strong></p>
<pre><code class="hljs language-ini" lang="ini">用户输入: /analyze-commits

系统弹窗:
┌─────────────────────────┐
│ 提交历史分析            │
├─────────────────────────┤
│ 分支名 *: <span class="hljs-section">[main      ]</span> │
│ 时间范围: <span class="hljs-section">[7 days ago]</span> │
│ 作者:     <span class="hljs-section">[          ]</span> │
│                         │
│      <span class="hljs-section">[取消]</span>  <span class="hljs-section">[确定]</span>     │
└─────────────────────────┘
</code></pre>
<p><strong>步骤4: 获取完整的Prompt内容</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 客户端请求</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"prompts/get"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"analyze_commits"</span>,       <span class="hljs-comment">// 使用哪个模板</span>
    <span class="hljs-string">"arguments"</span>: {                    <span class="hljs-comment">// 用户填写的参数</span>
      <span class="hljs-string">"branch"</span>: <span class="hljs-string">"main"</span>,
      <span class="hljs-string">"since"</span>: <span class="hljs-string">"7 days ago"</span>
    }
  }
}

<span class="hljs-comment">// 服务器响应 - 返回完整的对话消息</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"分析main分支最近7天的提交"</span>,
    <span class="hljs-string">"messages"</span>: [                     <span class="hljs-comment">// 发送给AI的完整对话</span>
      {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,               <span class="hljs-comment">// 用户角色</span>
        <span class="hljs-string">"content"</span>: {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-string">"text"</span>: <span class="hljs-string">"请分析main分支在过去7天的Git提交历史。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>需要统计:<span class="hljs-subst">\n</span>1. 总提交次数<span class="hljs-subst">\n</span>2. 每个作者的贡献次数和代码行数<span class="hljs-subst">\n</span>3. 主要修改的文件列表<span class="hljs-subst">\n</span>4. 是否包含breaking changes<span class="hljs-subst">\n</span>5. 提交消息的规范性<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>请用表格格式输出结果,并在最后给出改进建议。"</span>
        }
      }
    ]
  }
}
</code></pre>
<p><strong>步骤5: 客户端将消息发送给AI</strong></p>
<pre><code class="hljs language-bash" lang="bash">用户看到AI正在分析...

AI返回:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 main分支提交分析报告(最近7天)

总提交次数: 23

作者贡献统计:
┌────────────┬────────┬──────────┐
│ 作者       │ 提交数 │ 代码行数  │
├────────────┼────────┼──────────┤
│ Alice      │   12   │  +543/-89│
│ Bob        │    8   │  +234/-45│
│ Charlie    │    3   │  +123/-12│
└────────────┴────────┴──────────┘

主要修改文件:
- src/api/users.py (8次修改)
- src/models/user.py (5次修改)
- tests/test_user.py (4次修改)

Breaking Changes: 无

提交规范性: 良好 (91%符合Conventional Commits)

改进建议:
1. 建议增加单元测试覆盖率
2. 部分提交消息过于简短
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>Prompt的内容类型</strong></p>
<p>Prompt消息中可以包含多种内容:<br/>
<strong>1. 纯文本</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请审查这段代码..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>2. 嵌入图片</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"base64-encoded-image-data"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 图片数据</span>
    <span class="hljs-attr">"mimeType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image/png"</span>                  <span class="hljs-comment">// 图片类型</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 嵌入资源</strong>(引用MCP资源)</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"resource"</span>,
    <span class="hljs-string">"resource"</span>: {
      <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///project/src/user.py"</span>,  <span class="hljs-comment">// 资源URI</span>
      <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,
      <span class="hljs-string">"text"</span>: <span class="hljs-string">"class User:<span class="hljs-subst">\n</span>    def __init__..."</span>  <span class="hljs-comment">// 资源内容</span>
    }
  }
}
</code></pre>
<p><strong>4. 多轮对话</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我想优化这段代码"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// AI的回复</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供代码内容"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resource"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 用户提供代码</span>
        <span class="hljs-attr">"resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Prompt vs Tool vs Resource 对比</strong></p>
<pre><code class="hljs language-scss" lang="scss">特性          Prompt              Tool                Resource
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
控制者        用户主动选择         AI自动决定           应用程序控制

触发方式      用户点击命令         AI判断需要调用       应用自动附加
              /analyze                              或用户选择
              
返回内容      对话消息            执行结果             数据内容
              (给AI的指令)        (函数返回值)         (上下文信息)
              
典型用途      工作流模板          执行操作             提供背景信息
              快捷指令            查询数据             文件内容
              
示例          代码审查模板        执行SQL查询          项目README
              错误诊断向导        发送邮件             数据库Schema
              
用户感知      ✅ 明显             ❓ 可能不知道         ❓ 透明的
              (用户点击)          (AI决定)            (自动加载)
</code></pre>
<p>Prompt是预设的对话模板，通过参数化实现灵活应用，提升用户体验，并能与MCP其他能力组合形成完整工作流。</p>
<p><strong>代码实现示例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端:注册Prompt</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_commits"</span>,
            title=<span class="hljs-string">"📊 提交历史分析"</span>,
            description=<span class="hljs-string">"分析Git提交历史并生成统计报告"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"branch"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"分支名"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>},
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"since"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"时间范围"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">False</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_commits"</span>:
        branch = arguments[<span class="hljs-string">"branch"</span>]
        since = arguments.get(<span class="hljs-string">"since"</span>, <span class="hljs-string">"7 days ago"</span>)
        
        <span class="hljs-comment"># 构建完整的提示消息</span>
        prompt_text = <span class="hljs-string">f"""
请分析<span class="hljs-subst">{branch}</span>分支在<span class="hljs-subst">{since}</span>的Git提交历史。

需要统计:
1. 总提交次数
2. 每个作者的贡献
3. 主要修改的文件
4. 是否有breaking changes

请用表格格式输出。
        """</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: prompt_text}
                }
            ]
        }

<span class="hljs-comment"># 客户端:使用Prompt</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">use_prompt</span>(<span class="hljs-params">session, prompt_name, arguments</span>):
    <span class="hljs-comment"># 获取Prompt内容</span>
    prompt = <span class="hljs-keyword">await</span> session.get_prompt(
        name=prompt_name,
        arguments=arguments
    )
    
    <span class="hljs-comment"># 将消息发送给AI</span>
    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> prompt.messages:
        ai_response = <span class="hljs-keyword">await</span> send_to_ai(message)
        <span class="hljs-built_in">print</span>(ai_response)
</code></pre>
<h3 data-id="heading-15">5.3 Tools(工具)：AI 自己决定用什么</h3>
<p><strong>Tool就是可执行的函数</strong>，比如查询数据库、调用API、写文件。</p>
<p><strong>谁控制</strong>：AI模型根据对话内容自己决定调用哪个工具</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出可用工具</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// AI调用工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回结果</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京天气:晴,温度22°C"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"isError"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">5.4 其他功能</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fcompletion" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/completion" ref="nofollow noopener noreferrer"><strong>补全</strong></a></p>
<p>MCP提供标准化的参数自动补全功能，支持为提示和资源URI提供上下文相关的建议，实现类似IDE的交互体验。服务器通过声明<code>completions</code>能力，支持对<code>ref/prompt</code>和<code>ref/resource</code>两种引用类型的补全，每次最多返回100个按相关性排序的建议值，并可通过<code>completion/complete</code>请求获取补全结果。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Flogging" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/logging" ref="nofollow noopener noreferrer"><strong>日志</strong></a></p>
<p>MCP提供结构化日志消息传递机制，允许服务器向客户端发送包含严重性级别、可选记录器名称和任意JSON可序列化数据的日志通知。服务器需声明<code>logging</code>能力，支持遵循RFC 5424标准的日志级别（从debug到emergency），客户端可通过<code>logging/setLevel</code>请求配置最低日志级别，服务器通过<code>notifications/message</code>通知发送日志消息。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fpagination" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/pagination" ref="nofollow noopener noreferrer"><strong>分页</strong></a></p>
<p>MCP支持对可能返回大量结果集的列表操作进行分页处理，使用基于不透明游标的分页模型而非数字页码。服务器在响应中包含当前页结果和可选的<code>nextCursor</code>字段（表示更多结果存在），客户端可通过在请求中包含游标继续分页。支持分页的操作包括<code>resources/list</code>、<code>resources/templates/list</code>、<code>prompts/list</code>和<code>tools/list</code>，客户端必须将游标视为不透明令牌。</p>
<h2 data-id="heading-17">六、客户端能力：反向请求</h2>
<p>客户端不仅接收服务器的数据，也可以提供能力给服务器使用:</p>
<h3 data-id="heading-18">6.1 Sampling(采样)：服务器请求客户端调用AI</h3>
<p><strong>场景</strong>: 服务器在处理任务时，需要AI帮忙分析中间结果。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sampling/createMessage"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这个数据正常吗?"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"modelPreferences"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"hints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-3-sonnet"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 建议用的模型</span>
      <span class="hljs-attr">"intelligencePriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 要求智能程度</span>
      <span class="hljs-attr">"speedPriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span>                     <span class="hljs-comment">// 速度要求</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际案例</strong>:Filesystem服务器在搜索大量文件时,请求AI判断哪些文件最相关。</p>
<h3 data-id="heading-19">6.2 Roots(目录)：告诉服务器工作范围</h3>
<p><strong>场景</strong>: 让服务器知道可以访问哪些目录。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"roots/list"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///home/user/project"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的项目"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>服务器知道只能在这个目录里操作，保护其他文件安全。</p>
<h3 data-id="heading-20">6.3 Elicitation(引导)：服务器向用户询问信息</h3>
<p><strong>场景</strong>: 服务器需要用户提供额外信息才能继续。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elicitation/create"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供您的GitHub用户名"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestedSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>用户响应</strong>:</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"accept"</span>,  <span class="hljs-regexp">//</span> 或<span class="hljs-string">"decline"</span>拒绝, <span class="hljs-string">"cancel"</span>取消
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"username"</span>: <span class="hljs-string">"octocat"</span>
  }
}
</code></pre>
<p><strong>实际案例</strong>: Git服务器需要知道提交信息格式，弹窗问用户:"请选择提交规范:Conventional Commits/Angular/Custom?"</p>
<h2 data-id="heading-21">七、完整实战：从零构建天气查询MCP</h2>
<p>下面让我们从头到尾构建一个完整的MCP系统，包含服务器和客户端。</p>
<h3 data-id="heading-22">7.1 需求分析</h3>
<p><strong>目标</strong>: 构建一个天气查询MCP服务器,提供:</p>
<ul>
<li><strong>资源</strong>: 城市列表</li>
<li><strong>工具</strong>: 查询天气、获取预报</li>
<li><strong>提示</strong>: 天气分析模板</li>
</ul>
<h3 data-id="heading-23">7.2 服务器实现(Python)</h3>
<p><strong>第一步: 安装MCP SDK</strong></p>
<pre><code class="hljs">pip install mcp
</code></pre>
<p><strong>第二步: 创建服务器 (weather_server.py)</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> Server
<span class="hljs-keyword">from</span> mcp.types <span class="hljs-keyword">import</span> Resource, Tool, Prompt, TextContent
<span class="hljs-keyword">import</span> mcp.server.stdio
<span class="hljs-keyword">import</span> httpx

<span class="hljs-comment"># 创建MCP服务器实例</span>
server = Server(<span class="hljs-string">"weather-server"</span>)

<span class="hljs-comment"># 1. 定义资源:支持的城市列表</span>
<span class="hljs-meta">@server.list_resources()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_resources</span>():
    <span class="hljs-string">"""返回可用的资源列表"""</span>
    <span class="hljs-keyword">return</span> [
        Resource(
            uri=<span class="hljs-string">"weather://cities"</span>,
            name=<span class="hljs-string">"支持的城市列表"</span>,
            mimeType=<span class="hljs-string">"application/json"</span>,
            description=<span class="hljs-string">"查询天气支持的所有城市"</span>
        )
    ]

<span class="hljs-meta">@server.read_resource()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">uri: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""读取具体资源内容"""</span>
    <span class="hljs-keyword">if</span> uri == <span class="hljs-string">"weather://cities"</span>:
        cities = [<span class="hljs-string">"北京"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"广州"</span>, <span class="hljs-string">"深圳"</span>, <span class="hljs-string">"杭州"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"contents"</span>: [{
                <span class="hljs-string">"uri"</span>: uri,
                <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"application/json"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-built_in">str</span>(cities)
            }]
        }

<span class="hljs-comment"># 2. 定义工具:天气查询</span>
<span class="hljs-meta">@server.list_tools()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tools</span>():
    <span class="hljs-string">"""返回可用的工具列表"""</span>
    <span class="hljs-keyword">return</span> [
        Tool(
            name=<span class="hljs-string">"get_current_weather"</span>,
            description=<span class="hljs-string">"获取指定城市的当前天气"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                        <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称,如'北京'"</span>
                    }
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        ),
        Tool(
            name=<span class="hljs-string">"get_forecast"</span>,
            description=<span class="hljs-string">"获取未来3天天气预报"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>},
                    <span class="hljs-string">"days"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"预报天数(1-3)"</span>, <span class="hljs-string">"default"</span>: <span class="hljs-number">3</span>}
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        )
    ]

<span class="hljs-meta">@server.call_tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""执行工具调用"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"get_current_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-comment"># 实际项目中这里调用真实的天气API</span>
        <span class="hljs-comment"># 示例:使用模拟数据</span>
        weather_data = {
            <span class="hljs-string">"city"</span>: city,
            <span class="hljs-string">"temperature"</span>: <span class="hljs-number">22</span>,
            <span class="hljs-string">"condition"</span>: <span class="hljs-string">"晴"</span>,
            <span class="hljs-string">"humidity"</span>: <span class="hljs-number">45</span>
        }
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气:\n温度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'temperature'</span>]}</span>°C\n天气: <span class="hljs-subst">{weather_data[<span class="hljs-string">'condition'</span>]}</span>\n湿度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'humidity'</span>]}</span>%"</span>
            }]
        }
    
    <span class="hljs-keyword">elif</span> name == <span class="hljs-string">"get_forecast"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        days = arguments.get(<span class="hljs-string">"days"</span>, <span class="hljs-number">3</span>)
        <span class="hljs-comment"># 模拟预报数据</span>
        forecast = <span class="hljs-string">f"<span class="hljs-subst">{city}</span>未来<span class="hljs-subst">{days}</span>天预报:\n第1天: 晴,20-25°C\n第2天: 多云,18-23°C\n第3天: 小雨,16-20°C"</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: forecast}]
        }

<span class="hljs-comment"># 3. 定义提示模板:天气分析</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-string">"""返回可用的提示模板"""</span>
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_weather"</span>,
            description=<span class="hljs-string">"分析天气趋势并给出建议"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"city"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""获取提示模板内容"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">f"请分析<span class="hljs-subst">{city}</span>的天气情况,并给出出行建议。包括:\n1. 温度是否适宜\n2. 是否需要带伞\n3. 穿衣建议"</span>
                    }
                }
            ]
        }

<span class="hljs-comment"># 启动服务器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 使用stdio传输(本地)</span>
    mcp.server.stdio.run_stdio_server(server)
</code></pre>
<h3 data-id="heading-24">7.3 配置服务器(Claude Desktop)</h3>
<p>创建配置文件 <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"weather"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/to/weather_server.py"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">7.4 客户端实现(Python)</h3>
<p>如果要自己实现客户端:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> ClientSession
<span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 连接到服务器</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_client(
        command=<span class="hljs-string">"python"</span>,
        args=[<span class="hljs-string">"/path/to/weather_server.py"</span>]
    ) <span class="hljs-keyword">as</span> (read, write):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(read, write) <span class="hljs-keyword">as</span> session:
            
            <span class="hljs-comment"># 1. 初始化连接</span>
            <span class="hljs-keyword">await</span> session.initialize()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 连接成功!"</span>)
            
            <span class="hljs-comment"># 2. 列出可用资源</span>
            resources = <span class="hljs-keyword">await</span> session.list_resources()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📁 可用资源: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources.resources)}</span>"</span>)
            <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> resources.resources:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{r.name}</span>: <span class="hljs-subst">{r.uri}</span>"</span>)
            
            <span class="hljs-comment"># 3. 读取城市列表资源</span>
            cities_resource = <span class="hljs-keyword">await</span> session.read_resource(
                uri=<span class="hljs-string">"weather://cities"</span>
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌍 城市列表: <span class="hljs-subst">{cities_resource.contents[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 4. 列出可用工具</span>
            tools = <span class="hljs-keyword">await</span> session.list_tools()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 可用工具: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tools.tools)}</span>"</span>)
            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools.tools:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{t.name}</span>: <span class="hljs-subst">{t.description}</span>"</span>)
            
            <span class="hljs-comment"># 5. 调用工具查询天气</span>
            result = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_current_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌤️  查询结果:\n<span class="hljs-subst">{result.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 6. 获取预报</span>
            forecast = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_forecast"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"上海"</span>, <span class="hljs-string">"days"</span>: <span class="hljs-number">3</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📅 天气预报:\n<span class="hljs-subst">{forecast.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 7. 列出提示模板</span>
            prompts = <span class="hljs-keyword">await</span> session.list_prompts()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💡 提示模板: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(prompts.prompts)}</span>"</span>)
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> prompts.prompts:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{p.name}</span>: <span class="hljs-subst">{p.description}</span>"</span>)
            
            <span class="hljs-comment"># 8. 获取提示内容</span>
            prompt = <span class="hljs-keyword">await</span> session.get_prompt(
                name=<span class="hljs-string">"analyze_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"广州"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📝 生成的提示:\n<span class="hljs-subst">{prompt.messages[<span class="hljs-number">0</span>][<span class="hljs-string">'content'</span>][<span class="hljs-string">'text'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h3 data-id="heading-26">7.5 运行效果</h3>
<pre><code class="hljs language-makefile" lang="makefile">$ python weather_client.py

✅ 连接成功!

📁 可用资源: 1
  - 支持的城市列表: weather://cities

🌍 城市列表: ['北京', '上海', '广州', '深圳', '杭州']

🔧 可用工具: 2
  - get_current_weather: 获取指定城市的当前天气
  - get_forecast: 获取未来3天天气预报

🌤️  查询结果:
<span class="hljs-section">北京当前天气:</span>
<span class="hljs-section">温度: 22°C</span>
<span class="hljs-section">天气: 晴</span>
<span class="hljs-section">湿度: 45%</span>

📅 天气预报:
<span class="hljs-section">上海未来3天预报:</span>
<span class="hljs-section">第1天: 晴,20-25°C</span>
<span class="hljs-section">第2天: 多云,18-23°C</span>
<span class="hljs-section">第3天: 小雨,16-20°C</span>

💡 提示模板: 1
  - analyze_weather: 分析天气趋势并给出建议

📝 生成的提示:
<span class="hljs-section">请分析广州的天气情况,并给出出行建议。包括:</span>
1. 温度是否适宜
2. 是否需要带伞
3. 穿衣建议
</code></pre>
<h2 data-id="heading-27">八、其他部分：MCP基础协议的另一半</h2>
<h3 data-id="heading-28">8.1 授权（Authorization）</h3>
<p>MCP授权规范定义了基于HTTP传输的安全授权机制，使MCP客户端能够代表资源所有者向受限制的MCP服务器发出请求。该规范基于OAuth 2.1及相关标准，实现了授权服务器发现、动态客户端注册和访问令牌管理。例如，客户端通过<code>resource</code>参数明确指定目标MCP服务器（如<code>https://mcp.example.com</code>），服务器则验证令牌是否专门为其颁发，确保令牌不会被误用于其他服务，从而防止"令牌传递"安全漏洞。</p>
<h3 data-id="heading-29">8.2 取消（Cancellation）</h3>
<p>MCP取消机制允许通过通知消息中止正在进行的请求，任何一方都可以发送<code>notifications/cancelled</code>通知来终止先前发出的请求。例如，当用户取消长时间运行的操作时，客户端可以发送包含请求ID和可选原因的取消通知，接收方应停止处理、释放资源且不发送响应。该机制考虑了网络延迟导致的竞态条件，允许接收方在请求已完成或无法取消时忽略通知，同时建议双方记录取消原因以便调试。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/cancelled"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户取消"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-30">8.3 Ping机制</h3>
<p>MCP提供了可选的ping机制，允许任何一方验证对方是否仍然响应且连接存活。该机制通过简单的请求/响应模式实现，例如客户端发送<code>{"jsonrpc":"2.0","id":"123","method":"ping"}</code>，服务器必须立即响应<code>{"jsonrpc":"2.0","id":"123","result":{}}</code>。如果在合理超时时间内未收到响应，发送方可以将连接视为陈旧并终止连接或尝试重新连接。实现应定期发送ping以检测连接健康状况，但应避免过度ping以减少网络开销。</p>
<h3 data-id="heading-31">8.4 进度跟踪（Progress）</h3>
<p>MCP支持通过通知消息对长时间运行的操作进行可选的进度跟踪。请求方可以在请求元数据中包含唯一的<code>progressToken</code>（如字符串"task123"）来接收进度更新，接收方则可以发送包含进度值、可选总值和消息的<code>notifications/progress</code>通知。例如，文件上传操作可以发送<code>{"progress":50,"total":100,"message":"正在上传文件..."}</code>来指示完成百分比。进度值必须随每个通知递增，双方应实现速率限制以防止消息泛滥，并在操作完成后停止发送进度通知。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/progress"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"progressToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"task123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"progress"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 当前进度</span>
    <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 总量</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在上传文件..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-32">九、安全实践：必须重视</h2>
<h3 data-id="heading-33">9.1 核心原则</h3>
<p><strong>1. 用户同意优先</strong></p>
<ul>
<li>所有数据访问必须经用户明确同意</li>
<li>所有工具调用前必须让用户确认</li>
</ul>
<p><strong>2. 数据隐私保护</strong></p>
<ul>
<li>服务器只能看到必要的信息</li>
<li>完整对话历史保留在宿主,不发给服务器</li>
</ul>
<p><strong>3. 工具安全</strong></p>
<ul>
<li>工具代表代码执行,必须谨慎</li>
<li>显示工具要做什么,让用户批准</li>
</ul>
<p><strong>4. 输入验证</strong></p>
<ul>
<li>服务器必须验证所有输入</li>
<li>客户端必须验证工具返回的结果</li>
</ul>
<h3 data-id="heading-34">9.2 实际建议</h3>
<p><strong>服务器开发者</strong>:</p>
<ul>
<li>验证所有输入参数</li>
<li>实现访问控制和速率限制</li>
<li>记录操作日志供审计</li>
</ul>
<p><strong>客户端开发者</strong>:</p>
<ul>
<li>显示清晰的权限请求界面</li>
<li>在调用工具前展示参数</li>
<li>实现工具调用超时机制</li>
</ul>
<h2 data-id="heading-35">十、MCP生态：谁开发客户端?</h2>
<p><strong>关键认知</strong>: 在MCP生态中，<strong>客户端通常不是由下游开发者开发的</strong>，而是<strong>内置在AI应用平台中</strong>。</p>
<pre><code class="hljs language-css" lang="css">  开发者开发MCP服务器
       ↓
  配置到AI平台(Claude/<span class="hljs-attribute">Cursor</span>等)
       ↓
  AI平台内置的MCP客户端自动连接
</code></pre>
<p>对于软件开发者来说，在MCP生态中的位置如下。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">角色定位:</span>
┌─────────────────────────────────────────┐
│ AI平台开发者(Anthropic, Cursor等)       │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP客户端SDK                    │
│  ✅ 集成到自己的AI应用中                │
│  ✅ 提供配置界面                        │
│  ✅ 管理MCP服务器生命周期               │
│  ✅ 处理AI与MCP的交互逻辑               │
└─────────────────────────────────────────┘
                 ↓ 提供平台
┌─────────────────────────────────────────┐
│ MCP服务器开发者(你、我、社区)           │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP服务器                       │
│  ✅ 实现Resources/Tools/Prompts        │
│  ✅ 编写使用文档                        │
│  ✅ 发布到npm/PyPI                      │
│  ❌ 不需要开发客户端                    │
│  ❌ 不需要关心AI如何调用                │
└─────────────────────────────────────────┘
                 ↓ 使用服务
┌─────────────────────────────────────────┐
│ 最终用户(开发者、分析师等)               │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 安装需要的MCP服务器                 │
│  ✅ 配置到AI平台                        │
│  ✅ 使用AI完成任务                      │
│  ❌ 不需要写代码                        │
└─────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-36">后记</h2>
<p>MCP 让 AI 应用开发变得更简单、更安全、更强大。它不是银弹，但为构建可靠的AI系统提供了坚实基础。<strong>本文全部内容基于提示编写，欢迎交流讨论！</strong></p>
<h2 data-id="heading-37">参考文献</h2>
<ol>
<li>MCP官方规范: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18" ref="nofollow noopener noreferrer">modelcontextprotocol.io/specificati…</a></li>
<li>JSON-RPC 2.0: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsonrpc.org%2F" target="_blank" title="https://www.jsonrpc.org/" ref="nofollow noopener noreferrer">www.jsonrpc.org/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析]]></title>    <link>https://juejin.cn/post/7571829879827628051</link>    <guid>https://juejin.cn/post/7571829879827628051</guid>    <pubDate>2025-11-13T10:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571829879827628051" data-draft-id="7572004684178669622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析"/> <meta itemprop="keywords" content="人工智能,开源"/> <meta itemprop="datePublished" content="2025-11-13T10:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:20:37.000Z" title="Thu Nov 13 2025 10:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>通过 OpenAI 兼容的 API 接口使用该工具的【本地部署教程】请点击以下链接：</strong></p>
<p><a href="https://juejin.cn/post/7569789282429255722" target="_blank" title="https://juejin.cn/post/7569789282429255722">告别繁琐文档处理！PaddleOCR-VL-vLLM-OpenAI-API本地部署教程：精准解析文本/表格/公式 - 掘金</a></p>
<p><strong>模型一键部署及使用方法请进入“算家云”官网</strong></p>
<h2 data-id="heading-0">概述</h2>
<p>PaddleOCR-VL 是一个基于视觉语言模型的多功能图像识别工具，支持 OCR 文字识别、表格识别、公式识别和图表识别等功能。本文档介绍如何通过 OpenAI 兼容的 API 接口使用该模型。</p>
<p><strong>功能验证状态</strong>: 所有四种任务类型已通过完整测试，功能稳定可用（测试时间：2025-11-07）</p>
<h2 data-id="heading-1">API 配置信息</h2>
<ul>
<li><strong>API 端点</strong>: <code>http://xn-b.suanjiayun.com:51849/v1/</code>  <strong>(实例对外开放端口)</strong></li>
<li><strong>模型名称</strong>: <code>PaddleOCR-VL</code></li>
<li><strong>API Key</strong>: <code>EMPTY</code>（无需真实密钥）</li>
<li><strong>最大上下文长度</strong>: 4096 tokens</li>
<li><strong>超时设置</strong>: 建议 3600 秒</li>
<li><strong>平均响应时间</strong>: 3-5 秒</li>
</ul>
<h2 data-id="heading-2">环境准备</h2>
<h3 data-id="heading-3">1. 安装依赖</h3>
<pre><code class="hljs">pip install openai
</code></pre>
<h3 data-id="heading-4">2. 基础配置</h3>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">"EMPTY"</span>,
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
    <span class="hljs-attr">timeout</span>=<span class="hljs-number">3600</span>
)
</code></pre>
<h2 data-id="heading-5">支持的任务类型</h2>
<h3 data-id="heading-6">1. OCR 文字识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"OCR:"</code></li>
<li><strong>功能</strong>: 识别图像中的文字内容</li>
<li><strong>输出格式</strong>: 纯文本，保持原有布局结构</li>
<li><strong>适用场景</strong>: 文档扫描、票据识别、标牌识别等</li>
<li><strong>测试结果</strong>: 准确识别文字和数字，布局保持良好</li>
</ul>
<p><strong>示例输出</strong>:</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-built_in">CINNAMON</span> SUGAR
<span class="hljs-number">1</span> x <span class="hljs-number">17</span>,<span class="hljs-number">000</span>
<span class="hljs-number">17</span>,<span class="hljs-number">000</span>
SUB TOTAL
<span class="hljs-number">17</span>,<span class="hljs-number">000</span>
</code></pre>
<h3 data-id="heading-7">2. 表格识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Table Recognition:"</code></li>
<li><strong>功能</strong>: 识别和解析表格结构及内容</li>
<li><strong>输出格式</strong>: 结构化标记语言（<code>&lt;fcel&gt;</code>, <code>&lt;lcel&gt;</code>, <code>&lt;ecel&gt;</code>, <code>&lt;nl&gt;</code>）</li>
<li><strong>适用场景</strong>: 财务报表、数据表格、统计表等</li>
<li><strong>测试结果</strong>: 能够准确识别表格行列结构</li>
</ul>
<p><strong>标记说明</strong>:</p>
<ul>
<li><code>&lt;fcel&gt;</code>: 第一列单元格</li>
<li><code>&lt;lcel&gt;</code>: 最后一列单元格</li>
<li><code>&lt;ecel&gt;</code>: 空单元格</li>
<li><code>&lt;nl&gt;</code>: 新行</li>
</ul>
<h3 data-id="heading-8">3. 公式识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Formula Recognition:"</code></li>
<li><strong>功能</strong>: 识别数学公式和科学公式</li>
<li><strong>输出格式</strong>: 格式化对齐的文本，保持数字对齐</li>
<li><strong>适用场景</strong>: 学术论文、教材、科研文档等</li>
<li><strong>测试结果</strong>: 能识别运算符，保持格式对齐</li>
</ul>
<h3 data-id="heading-9">4. 图表识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Chart Recognition:"</code></li>
<li><strong>功能</strong>: 识别图表类型和数据内容</li>
<li><strong>输出格式</strong>: 表格化数据（Category | Value 格式）</li>
<li><strong>适用场景</strong>: 数据可视化图表、统计图形等</li>
<li><strong>测试结果</strong>: 自动结构化数据，便于后续处理</li>
</ul>
<p><strong>示例输出</strong>:</p>
<pre><code class="hljs language-objectivec" lang="objectivec">Category | Value
<span class="hljs-built_in">CINNAMON</span> SUGAR | <span class="hljs-number">17000</span>
SUB TOTAL | <span class="hljs-number">17000</span>
GRAND TOTAL | <span class="hljs-number">17000</span>
</code></pre>
<h2 data-id="heading-10">使用示例</h2>
<h3 data-id="heading-11">快速开始 - 基础 OCR 识别</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># 初始化客户端</span>
client = OpenAI(
    api_key=<span class="hljs-string">"EMPTY"</span>,
    base_url=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
    timeout=<span class="hljs-number">3600</span>
)

<span class="hljs-comment"># 定义任务类型</span>
TASKS = {
    <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
    <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
    <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
    <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
}

<span class="hljs-comment"># 构建请求消息</span>
messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"你的图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"ocr"</span>]  <span class="hljs-comment"># 选择任务类型</span>
            }
        ]
    }
]

<span class="hljs-comment"># 发送请求</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在处理图像..."</span>)
    response = client.chat.completions.create(
        model=<span class="hljs-string">"PaddleOCR-VL"</span>,
        messages=messages,
        temperature=<span class="hljs-number">0.0</span>,
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 识别成功!"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📝 识别结果:\n<span class="hljs-subst">{response.choices[<span class="hljs-number">0</span>].message.content}</span>"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 识别失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-12">不同任务类型示例</h3>
<h4 data-id="heading-13">表格识别示例</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 表格识别 - 返回结构化标记</span>
<span class="hljs-attr">messages</span> = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"包含表格的图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"table"</span>]
            }
        ]
    }
]

<span class="hljs-attr">response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
)
<span class="hljs-comment"># 输出示例: &lt;fcel&gt;内容&lt;fcel&gt;内容&lt;nl&gt;...</span>
</code></pre>
<h4 data-id="heading-14">图表识别示例</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 图表识别 - 返回表格化数据</span>
<span class="hljs-attr">messages</span> = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"图表图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"chart"</span>]
            }
        ]
    }
]

<span class="hljs-attr">response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
)
<span class="hljs-comment"># 输出示例: Category | Value\n项目名 | 数值</span>
</code></pre>
<h2 data-id="heading-15">图片输入方式</h2>
<h3 data-id="heading-16">1. 网络图片 URL</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"image_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://example.com/image.jpg"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">2. Base64 编码图片</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">def</span> <span class="hljs-title function_">encode_image</span>(<span class="hljs-params">image_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
        <span class="hljs-keyword">return</span> base64.b64encode(image_file.read()).decode(<span class="hljs-string">'utf-8'</span>)

base64_image = encode_image(<span class="hljs-string">"path/to/your/image.jpg"</span>)

<span class="hljs-string">"image_url"</span>: {
    <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
}
</code></pre>
<h2 data-id="heading-18">完整功能类 - 生产就绪版本</h2>
<p>基于实际测试结果，以下是经过验证的完整功能类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaddleOCRVL</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.client = OpenAI(
            api_key=<span class="hljs-string">"EMPTY"</span>,
            base_url=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
            timeout=<span class="hljs-number">3600</span>
        )
        self.tasks = {
            <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
            <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
            <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
            <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
        }
        self.output_formats = {
            <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"纯文本格式"</span>,
            <span class="hljs-string">"table"</span>: <span class="hljs-string">"结构化标记语言"</span>,
            <span class="hljs-string">"formula"</span>: <span class="hljs-string">"格式化对齐文本"</span>,
            <span class="hljs-string">"chart"</span>: <span class="hljs-string">"表格化数据"</span>
        }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recognize</span>(<span class="hljs-params">self, image_url, task_type=<span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""
        图像识别主函数 - 已通过完整测试验证

        Args:
            image_url (str): 图片URL或本地路径
            task_type (str): 任务类型 ('ocr', 'table', 'formula', 'chart')
            verbose (bool): 是否显示详细处理信息

        Returns:
            dict: 包含识别结果和元信息的字典
        """</span>
        <span class="hljs-keyword">if</span> task_type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.tasks:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持的任务类型: <span class="hljs-subst">{task_type}</span>. 支持的类型: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(self.tasks.keys())}</span>"</span>)

        <span class="hljs-keyword">if</span> verbose:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 开始 <span class="hljs-subst">{task_type.upper()}</span> 识别..."</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📊 预期输出格式: <span class="hljs-subst">{self.output_formats[task_type]}</span>"</span>)

        <span class="hljs-comment"># 处理本地图片</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_url.startswith((<span class="hljs-string">'http://'</span>, <span class="hljs-string">'https://'</span>)):
            image_url = self._encode_local_image(image_url)

        messages = [
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                        <span class="hljs-string">"image_url"</span>: {<span class="hljs-string">"url"</span>: image_url}
                    },
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: self.tasks[task_type]
                    }
                ]
            }
        ]

        <span class="hljs-keyword">try</span>:
            start_time = time.time()
            response = self.client.chat.completions.create(
                model=<span class="hljs-string">"PaddleOCR-VL"</span>,
                messages=messages,
                temperature=<span class="hljs-number">0.0</span>,
            )
            end_time = time.time()
            processing_time = end_time - start_time

            result = {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"content"</span>: response.choices[<span class="hljs-number">0</span>].message.content,
                <span class="hljs-string">"task_type"</span>: task_type,
                <span class="hljs-string">"processing_time"</span>: <span class="hljs-built_in">round</span>(processing_time, <span class="hljs-number">2</span>),
                <span class="hljs-string">"output_format"</span>: self.output_formats[task_type]
            }

            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 识别成功! 耗时: <span class="hljs-subst">{processing_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)

            <span class="hljs-keyword">return</span> result

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            error_result = {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e),
                <span class="hljs-string">"task_type"</span>: task_type,
                <span class="hljs-string">"processing_time"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"output_format"</span>: <span class="hljs-literal">None</span>
            }

            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 识别失败: <span class="hljs-subst">{e}</span>"</span>)

            <span class="hljs-keyword">return</span> error_result

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_recognize</span>(<span class="hljs-params">self, image_urls, task_type=<span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""批量识别功能"""</span>
        results = []
        <span class="hljs-keyword">for</span> i, url <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(image_urls):
            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n处理第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(image_urls)}</span> 张图片..."</span>)
            result = self.recognize(url, task_type, verbose)
            results.append(result)
            time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 避免请求过于频繁</span>
        <span class="hljs-keyword">return</span> results

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_encode_local_image</span>(<span class="hljs-params">self, image_path</span>):
        <span class="hljs-string">"""编码本地图片为 base64"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
                base64_image = base64.b64encode(image_file.read()).decode(<span class="hljs-string">'utf-8'</span>)
                <span class="hljs-comment"># 根据文件扩展名确定MIME类型</span>
                <span class="hljs-keyword">if</span> image_path.lower().endswith(<span class="hljs-string">'.png'</span>):
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"data:image/png;base64,<span class="hljs-subst">{base64_image}</span>"</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"无法读取图片文件: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 使用示例 - 基于实际测试验证</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    ocr = PaddleOCRVL()

    <span class="hljs-comment"># 测试用的收据图片URL</span>
    test_image = <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>

    <span class="hljs-comment"># OCR 识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"OCR 结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)

    <span class="hljs-comment"># 表格识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"table"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"表格识别结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)

    <span class="hljs-comment"># 图表识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"chart"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"图表识别结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)
</code></pre>
<h2 data-id="heading-19">性能特点（基于实际测试）</h2>
<h3 data-id="heading-20">✅ 已验证的性能指标</h3>
<ul>
<li><strong>响应时间</strong>: 3-5 秒（所有任务类型）</li>
<li><strong>成功率</strong>: 100%（基于测试样本）</li>
<li><strong>API 稳定性</strong>: 连续测试无异常</li>
<li><strong>识别准确率</strong>: 文字和数字识别准确</li>
</ul>
<h3 data-id="heading-21">📊 输出格式对比</h3>




































<table><thead><tr><th>任务类型</th><th>输出格式</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td>OCR</td><td>纯文本</td><td>保持原布局</td><td>文档扫描、文字提取</td></tr><tr><td>Table</td><td>标记语言</td><td>结构化标记</td><td>表格数据解析</td></tr><tr><td>Formula</td><td>对齐文本</td><td>格式化显示</td><td>公式文档处理</td></tr><tr><td>Chart</td><td>表格数据</td><td>Category</td><td>Value</td><td>数据分析处理</td></tr></tbody></table>
<h2 data-id="heading-22">注意事项</h2>
<h3 data-id="heading-23">🔧 技术要求</h3>
<ol>
<li><strong>网络连接</strong>: 确保能够访问 API 端点 <code>http://xn-b.suanjiayun.com:51849/v1/</code></li>
<li><strong>图片格式</strong>: 支持常见图片格式（JPG、PNG、GIF 等）</li>
<li><strong>图片大小</strong>: 建议图片不超过 10MB</li>
<li><strong>超时设置</strong>: 建议设置 3600 秒超时（实际处理时间 3-5 秒）</li>
<li><strong>错误处理</strong>: 始终使用 try-except 处理可能的网络或 API 错误</li>
</ol>
<h3 data-id="heading-24">💡 最佳实践</h3>
<ol>
<li><strong>图片质量</strong>: 使用高清晰度图片获得最佳识别效果</li>
<li><strong>任务选择</strong>: 根据实际需求选择合适的任务类型</li>
<li><strong>结果处理</strong>: 不同任务类型返回不同格式，需要相应的后处理逻辑</li>
<li><strong>批量处理</strong>: 在请求间添加适当延迟（建议 1-2 秒）</li>
</ol>
<h2 data-id="heading-25">常见问题</h2>
<h3 data-id="heading-26">Q: 如何提高识别准确率？</h3>
<p>A:</p>
<ul>
<li>确保图片清晰度足够</li>
<li>避免图片过度压缩</li>
<li>选择合适的任务类型</li>
<li>根据测试结果，当前识别准确率已经很高</li>
</ul>
<h3 data-id="heading-27">Q: 支持批量处理吗？</h3>
<p>A: 支持，可以使用提供的 <code>batch_recognize</code> 方法，或循环调用单张处理</p>
<h3 data-id="heading-28">Q: 如何处理不同的输出格式？</h3>
<p>A:</p>
<ul>
<li><strong>OCR</strong>: 直接使用文本内容</li>
<li><strong>Table</strong>: 需要解析 <code>&lt;fcel&gt;</code>, <code>&lt;nl&gt;</code> 等标记</li>
<li><strong>Chart</strong>: 可以直接按 <code>|</code> 分割处理表格数据</li>
</ul>
<h3 data-id="heading-29">Q: API 响应时间如何？</h3>
<p>A: 根据测试结果，所有任务类型的响应时间都在 3-5 秒内</p>
<h3 data-id="heading-30">Q: 如何处理识别错误？</h3>
<p>A: 检查网络连接、图片格式和 API 端点配置。使用提供的错误处理机制</p>
<h2 data-id="heading-31">功能验证测试</h2>
<h3 data-id="heading-32">🧪 测试用例</h3>
<p>为了验证文档中的所有功能，可以运行以下测试代码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 快速功能验证测试</span>
from openai import OpenAI

def quick_test():
    <span class="hljs-attr">client</span> = OpenAI(
        <span class="hljs-attr">api_key</span>=<span class="hljs-string">"EMPTY"</span>,
        <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
        <span class="hljs-attr">timeout</span>=<span class="hljs-number">3600</span>
    )

    <span class="hljs-attr">test_image</span> = <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>
    <span class="hljs-attr">tasks</span> = [<span class="hljs-string">"OCR:"</span>, <span class="hljs-string">"Table Recognition:"</span>, <span class="hljs-string">"Formula Recognition:"</span>, <span class="hljs-string">"Chart Recognition:"</span>]

    print("🚀 开始功能验证测试...")

    for i, task in enumerate(tasks):
        print(f"\n测试 {i+1}/4: {task}")
        try:
            <span class="hljs-attr">messages</span> = [{
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {<span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>, <span class="hljs-string">"image_url"</span>: {<span class="hljs-string">"url"</span>: test_image}},
                    {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: task}
                ]
            }]

            <span class="hljs-attr">response</span> = client.chat.completions.create(
                <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
                <span class="hljs-attr">messages</span>=messages,
                <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
            )
            print(f"✅ {task} 测试通过")
        except Exception as e:
            print(f"❌ {task} 测试失败: {e}")

    print("\n🎉 测试完成!")

if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    quick_test()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器之内置四大多线程API]]></title>    <link>https://juejin.cn/post/7571477608393572352</link>    <guid>https://juejin.cn/post/7571477608393572352</guid>    <pubDate>2025-11-12T09:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571477608393572352" data-draft-id="7571641339687895040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器之内置四大多线程API"/> <meta itemprop="keywords" content="前端,JavaScript,浏览器"/> <meta itemprop="datePublished" content="2025-11-12T09:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器之内置四大多线程API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:01:00.000Z" title="Wed Nov 12 2025 09:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">一、为什么 Web Worker 能实现 “多线程”？</h3>
<p>浏览器的 JS 引擎（如 V8）本身是单线程的，但浏览器是多进程 / 多线程架构。Web Worker 的本质是 <strong>浏览器为 JS 提供的 “额外线程池”</strong> ，核心原理：</p>
<ol>
<li><strong>线程隔离</strong>：Worker 线程与主线程是完全隔离的内存空间（不共享堆内存），通过 “消息队列” 通信（数据传输基于结构化克隆算法，深拷贝）。</li>
<li><strong>阻塞无关性</strong>：Worker 线程的阻塞（如死循环）不会影响主线程，但会导致自身无法响应消息。</li>
<li><strong>资源限制</strong>：浏览器对 Worker 数量有上限（通常同源下不超过 20 个），且单个 Worker 占用的内存有限制（避免滥用系统资源）。</li>
</ol>
<p><strong>关键区别</strong>：与 Node.js 的 <code>child_process</code> 不同，Web Worker 无法共享内存（需通过 <code>SharedArrayBuffer</code> 实现有限共享，见下文），且受浏览器安全策略（如跨域限制）约束。</p>
<p><strong>总结：</strong>
webwork是通过js的方式唤起浏览器的内置api使用，辅助前端计算的一种方式，就像fetch、ajaix那样唤起浏览器的接口查询一样。</p>
<h3 data-id="heading-1">多线程四大API</h3>
<p>Web Worker 是前端 “多线程” 的基础规范，但浏览器针对不同场景设计了 <strong>4 种独立的 Worker 类型</strong>—— 它们共享 “线程隔离” 的核心思想（避免阻塞主线程），但定位、能力、使用场景完全不同，均为 W3C 标准定义的原生 API（无需第三方库），底层由浏览器独立实现（无依赖关系）。</p>
<h4 data-id="heading-2">浏览器 4 种核心 Worker 类型对比表</h4>



































<table><thead><tr><th>Worker 类型</th><th>核心定位</th><th>底层依赖</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Web Worker</strong></td><td>主线程的 “计算助手”，处理耗时计算</td><td>浏览器线程池</td><td>大数据排序、加密解密、复杂算法计算</td></tr><tr><td><strong>Shared Worker</strong></td><td>多页面共享的 “后台协调者”，跨页面通信</td><td>浏览器共享线程</td><td>多标签页登录状态同步、跨页数据协同</td></tr><tr><td><strong>Service Worker</strong></td><td>页面离线的 “代理服务器”，拦截请求 + 缓存</td><td>浏览器后台线程</td><td>离线应用、请求拦截优化、浏览器推送通知</td></tr><tr><td><strong>Worklet</strong></td><td>渲染管线的 “实时处理器”，介入渲染流程</td><td>浏览器渲染线程</td><td>CSS 物理动画、音频降噪、Canvas 渲染优化</td></tr></tbody></table>
<h3 data-id="heading-3">二、分类</h3>
<h4 data-id="heading-4">1. Web Worker（计算型：解决主线程阻塞）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>独立于主线程的 “计算线程”，仅与创建它的主线程通信（一对一）；</li>
</ul>

<ul>
<li>生命周期与页面绑定（页面关闭则 Worker 销毁）；</li>
</ul>

<ul>
<li>不阻塞 UI，专门处理耗时计算（避免页面卡顿）。</li>
</ul>
<p><strong>示例：10 万条数据排序</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：发起计算请求，接收结果</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">Worker</span>) {
  <span class="hljs-comment">// 1. 创建 Worker 实例</span>
  <span class="hljs-keyword">const</span> sortWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'sort-worker.js'</span>);
  
  <span class="hljs-comment">// 2. 生成 10 万条随机大数据（模拟复杂计算场景）</span>
  <span class="hljs-keyword">const</span> bigData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100000</span>);
  
  <span class="hljs-comment">// 3. 发送数据给 Worker，触发计算</span>
  sortWorker.<span class="hljs-title function_">postMessage</span>(bigData);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：已发送数据，等待排序结果...'</span>);
  
  <span class="hljs-comment">// 4. 接收 Worker 返回的计算结果</span>
  sortWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：排序完成，前 10 条数据：'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>));
    sortWorker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 计算完成，销毁 Worker（避免内存泄漏）</span>
  };
  
  <span class="hljs-comment">// 5. 监听 Worker 错误（如代码报错）</span>
  sortWorker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker 错误：<span class="hljs-subst">${err.message}</span>（行号：<span class="hljs-subst">${err.lineno}</span>）`</span>);
    sortWorker.<span class="hljs-title function_">terminate</span>();
  };
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'当前浏览器不支持 Web Worker'</span>);
}
<span class="hljs-comment">// Worker 线程（sort-worker.js）：执行耗时计算</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> data = e.<span class="hljs-property">data</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker 线程：开始排序 10 万条数据...'</span>);
  
  <span class="hljs-comment">// 耗时计算（示例用内置排序，实际可替换为快排、归并等复杂算法）</span>
  <span class="hljs-keyword">const</span> sortedData = data.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);
  
  <span class="hljs-comment">// 向主线程返回结果</span>
  self.<span class="hljs-title function_">postMessage</span>(sortedData);
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// Worker 主动关闭，释放资源</span>
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>主线程可正常处理用户交互（点击、滚动），排序在后台线程执行，页面无卡顿；计算完成后自动销毁 Worker，无内存泄漏。</p>
<h4 data-id="heading-5">2. Shared Worker（协同型：多页面数据同步）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>同源多页面可共享同一个 Worker 实例（突破 “单页面私有” 限制）；</li>
</ul>

<ul>
<li>通过 port（通信端口）实现多页面与 Worker 的双向通信；</li>
</ul>

<ul>
<li>适合跨页面状态同步（无需重复请求接口）。</li>
</ul>
<p><strong>示例：多标签页登录状态同步</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程 - 页面 A（login.html）：登录后同步状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-comment">// 1. 创建 Shared Worker 实例</span>
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  <span class="hljs-comment">// 2. 激活通信端口（必须调用 start()）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 3. 模拟登录按钮点击，发送登录状态给 Worker</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'login-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> userInfo = { <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>, <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span> };
    sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN'</span>, <span class="hljs-attr">data</span>: userInfo });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A：已发送登录状态'</span>);
  });
  
  <span class="hljs-comment">// 4. 接收 Worker 广播的消息（如其他页面同步的状态）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A 收到消息：'</span>, e.<span class="hljs-property">data</span>);
  };
}
<span class="hljs-comment">// 主线程 - 页面 B（index.html）：实时获取登录状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 1. 向 Worker 请求当前登录状态</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'QUERY_STATUS'</span> });
  
  <span class="hljs-comment">// 2. 接收状态（页面 A 登录后，页面 B 实时更新）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'LOGIN_STATUS'</span>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">textContent</span> = e.<span class="hljs-property">data</span>.<span class="hljs-property">isLogin</span> 
        ? <span class="hljs-string">`已登录：<span class="hljs-subst">${e.data.username}</span>`</span> 
        : <span class="hljs-string">'未登录'</span>;
    }
  };
}
<span class="hljs-comment">// Shared Worker 线程（sync-worker.js）：维护全局状态，广播消息</span>
<span class="hljs-keyword">const</span> connections = []; <span class="hljs-comment">// 存储所有连接的页面端口</span>
<span class="hljs-keyword">let</span> globalState = { <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">''</span> }; <span class="hljs-comment">// 全局共享状态</span>
<span class="hljs-comment">// 监听页面连接（新页面打开时触发）</span>
self.<span class="hljs-property">onconnect</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
  connections.<span class="hljs-title function_">push</span>(port); <span class="hljs-comment">// 记录新连接的页面</span>
  port.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 处理页面发送的消息</span>
  port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-keyword">switch</span> (msg.<span class="hljs-property">data</span>.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'LOGIN'</span>:
        <span class="hljs-comment">// 更新全局状态</span>
        globalState = msg.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;
        <span class="hljs-comment">// 广播给所有连接的页面（同步状态到页面 A、B...）</span>
        connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">postMessage</span>({ 
          <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, 
          ...globalState 
        }));
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'QUERY_STATUS'</span>:
        <span class="hljs-comment">// 单独响应某个页面的状态查询</span>
        port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, ...globalState });
        <span class="hljs-keyword">break</span>;
    }
  };
  
  <span class="hljs-comment">// 页面关闭时，移除端口（避免内存泄漏）</span>
  port.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> index = connections.<span class="hljs-title function_">indexOf</span>(port);
    <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) connections.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
  };
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>页面 A 点击 “登录” 后，页面 B 无需刷新，实时显示 “已登录：admin”；多标签页共享同一登录状态，无需重复调用登录接口。</p>
<h4 data-id="heading-6">3. Service Worker（网络型：离线缓存 + 请求拦截）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>完全独立于页面，运行在浏览器后台（页面关闭后仍可活动）；</li>
</ul>

<ul>
<li>拦截所有网络请求，可自定义缓存策略（实现离线访问）；</li>
</ul>

<ul>
<li>生命周期包含 “安装→激活→运行”，需手动管理缓存版本。</li>
</ul>
<p><strong>示例：离线缓存静态资源 + API 请求</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：注册 Service Worker，触发离线逻辑</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 注册 Service Worker（脚本需在根目录，确保作用域覆盖所有页面）</span>
      <span class="hljs-keyword">const</span> registration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功，作用域：'</span>, registration.<span class="hljs-property">scope</span>);
      
      <span class="hljs-comment">// 2. 测试离线请求（首次联网缓存，后续断网可访问）</span>
      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API 请求结果：'</span>, data);
      });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Service Worker 注册失败：'</span>, err);
    }
  });
}
<span class="hljs-comment">// Service Worker 线程（sw.js）：缓存+请求拦截逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'offline-cache-v1'</span>; <span class="hljs-comment">// 缓存版本（更新时修改版本号）</span>
<span class="hljs-comment">// 需要缓存的资源列表（静态资源+API接口）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_ASSETS</span> = [
  <span class="hljs-string">'/'</span>, 
  <span class="hljs-string">'/index.html'</span>,
  <span class="hljs-string">'/styles.css'</span>,
  <span class="hljs-string">'/api/data'</span> <span class="hljs-comment">// 需缓存的 API 接口</span>
];
<span class="hljs-comment">// 1. 安装阶段：缓存静态资源（仅首次注册/版本更新时触发）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 等待缓存完成后，再进入激活阶段</span>
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(<span class="hljs-variable constant_">CACHE_ASSETS</span>)) <span class="hljs-comment">// 批量缓存资源</span>
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">skipWaiting</span>()) <span class="hljs-comment">// 跳过等待，立即激活新 Worker（替换旧版本）</span>
  );
});
<span class="hljs-comment">// 2. 激活阶段：清理旧缓存（避免缓存膨胀）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cacheNames</span> =&gt;</span> {
      <span class="hljs-comment">// 删除非当前版本的缓存</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        cacheNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> caches.<span class="hljs-title function_">delete</span>(name))
      );
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>()) <span class="hljs-comment">// 强制所有打开的页面使用新 Worker</span>
  );
});
<span class="hljs-comment">// 3. 拦截请求：优先从缓存返回，无缓存则请求网络</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 仅拦截同源的 GET 请求（避免跨域资源和非幂等请求）</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; event.<span class="hljs-property">request</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">'same-origin'</span>) {
    event.<span class="hljs-title function_">respondWith</span>(
      caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cachedResponse</span> =&gt;</span> {
          <span class="hljs-comment">// 缓存命中：直接返回缓存资源</span>
          <span class="hljs-keyword">if</span> (cachedResponse) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从缓存返回：'</span>, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
            <span class="hljs-keyword">return</span> cachedResponse;
          }
          <span class="hljs-comment">// 缓存未命中：发起网络请求，并缓存新结果</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
            caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
              cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, networkResponse.<span class="hljs-title function_">clone</span>()); <span class="hljs-comment">// 缓存新请求</span>
            });
            <span class="hljs-keyword">return</span> networkResponse;
          });
        })
    );
  }
});
</code></pre>
<p><strong>运行效果</strong>：</p>
<ul>
<li>首次联网时，自动缓存 index.html、styles.css 和 /api/data；</li>
</ul>

<ul>
<li>断网后刷新页面，仍能正常加载页面和 API 数据（从缓存读取）；</li>
</ul>

<ul>
<li>缓存版本更新时，自动清理旧缓存，避免资源冗余。</li>
</ul>
<h4 data-id="heading-7">4. Worklet（实时型：介入渲染流程）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>嵌入浏览器渲染管线（如 CSS 引擎线程、音频线程），低延迟（&lt;1ms）；</li>
</ul>

<ul>
<li>直接干预渲染过程（动画、绘制、音频处理），弥补 Web Worker 通信延迟的缺陷；</li>
</ul>

<ul>
<li>细分类型：CSSWorklet（动画）、AudioWorklet（音频）、PaintWorklet（绘制）。</li>
</ul>
<p><strong>示例：CSSWorklet 实现物理弹性动画</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主线程（main.js）：注册 Worklet，关联动画</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 注册自定义 Worklet（加载动画逻辑脚本）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'bounce-worklet.js'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'CSSWorklet 注册失败：'</span>, err);
  }
}
<span class="hljs-comment">// HTML 结构：动画元素</span>
<span class="hljs-comment">/*
&lt;div class="box"&gt;弹性动画方块&lt;/div&gt;
*/</span>
<span class="hljs-comment">// CSS 样式：绑定 Worklet 动画</span>
<span class="hljs-comment">/*
.box {
  width: 100px;
  height: 100px;
  background: red;
  /* 使用 Worklet 定义的动画（名称与 Worklet 中注册一致） */</span>
  <span class="hljs-attr">animation</span>: bounce 2s infinite;
}
<span class="hljs-comment">/* 定义动画进度（from→to 对应 Worklet 中的 0→1） */</span>
<span class="hljs-meta">@keyframes</span> bounce {
  <span class="hljs-keyword">from</span> { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(<span class="hljs-number">0</span>); }
  to { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(300px); }
}
*/
<span class="hljs-comment">// CSSWorklet 线程（bounce-worklet.js）：自定义动画逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BounceWorklet</span> {
  <span class="hljs-comment">// 每一帧的计算（嵌入渲染管线，实时执行）</span>
  <span class="hljs-title function_">process</span>(<span class="hljs-params">inputs, outputs, parameters</span>) {
    <span class="hljs-keyword">const</span> [t] = inputs; <span class="hljs-comment">// 动画进度（0~1，from→to）</span>
    <span class="hljs-keyword">const</span> [output] = outputs; <span class="hljs-comment">// 输出结果（最终的 CSS 样式值）</span>
    
    <span class="hljs-comment">// 物理弹性公式（模拟重力+反弹效果，非匀速动画）</span>
    <span class="hljs-keyword">const</span> bounce = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(t * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(-t * <span class="hljs-number">0.5</span>);
    <span class="hljs-comment">// 输出 transform 样式（控制方块位置）</span>
    output.<span class="hljs-property">value</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${<span class="hljs-number">300</span> * (<span class="hljs-number">1</span> - bounce)}</span>px)`</span>;
  }
}
<span class="hljs-comment">// 注册 Worklet 动画（名称需与 CSS 中的 @keyframes 名称一致）</span>
<span class="hljs-title function_">registerAnimator</span>(<span class="hljs-string">'bounce'</span>, <span class="hljs-title class_">BounceWorklet</span>);
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>红色方块以 “物理弹性轨迹” 上下运动（类似小球落地反弹），动画流畅无卡顿；Worklet 运行在渲染线程，延迟极低，避免 Web Worker 通信导致的动画掉帧。</p>
<h3 data-id="heading-8">三、混合使用：多 Worker 协同解决复杂场景</h3>
<h4 data-id="heading-9">场景需求：离线数据分析 Dashboard</h4>
<p>需要同时满足 4 个核心需求：</p>
<ol>
<li>离线访问（断网后仍可查看历史数据）；</li>
</ol>

<ol start="2">
<li>多标签页同步分析结果（无需重复解析）；</li>
</ol>

<ol start="3">
<li>后台解析 10 万条 CSV 数据（不阻塞页面）；</li>
</ol>

<ol start="4">
<li>实时渲染流畅图表（动画无掉帧）。</li>
</ol>
<h4 data-id="heading-10">完整实现代码（整合 4 种 Worker）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（dashboard.js）：整合所有 Worker，协调流程</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 第一步：注册 Service Worker（离线缓存）</span>
      <span class="hljs-keyword">const</span> swRegistration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功'</span>);
      <span class="hljs-comment">// 2. 第二步：创建 Shared Worker（多页面同步）</span>
      <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
      sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
      <span class="hljs-comment">// 3. 第三步：创建 Web Worker（CSV 数据解析）</span>
      <span class="hljs-keyword">const</span> csvWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'csv-worker.js'</span>);
      <span class="hljs-comment">// 4. 第四步：注册 CSSWorklet（图表动画优化）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'chart-worklet.js'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
      }
      <span class="hljs-comment">// 5. 页面元素：文件上传、图表容器、状态文本</span>
      <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'file-upload'</span>);
      <span class="hljs-keyword">const</span> chartContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chart-container'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
      <span class="hljs-comment">// 6. 监听文件上传：触发 CSV 解析</span>
      fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (file &amp;&amp; file.<span class="hljs-property">name</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.csv'</span>)) {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'正在解析 CSV 文件...'</span>;
          csvWorker.<span class="hljs-title function_">postMessage</span>(file); <span class="hljs-comment">// 发送文件给 Web Worker</span>
        } <span class="hljs-keyword">else</span> {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'请上传 CSV 格式文件！'</span>;
        }
      });
      <span class="hljs-comment">// 7. 接收 Web Worker 解析结果：渲染+同步+缓存</span>
      csvWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> analysisResult = e.<span class="hljs-property">data</span>; <span class="hljs-comment">// 解析结果（数据数组+统计信息）</span>
        
        <span class="hljs-comment">// 7.1 渲染图表（用 CSSWorklet 优化动画）</span>
        <span class="hljs-title function_">renderChart</span>(analysisResult, chartContainer);
        
        <span class="hljs-comment">// 7.2 同步结果到其他标签页（通过 Shared Worker）</span>
        sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'ANALYSIS_RESULT'</span>,
          <span class="hljs-attr">data</span>: analysisResult
        });
        
        <span class="hljs-comment">// 7.3 缓存结果到 Service Worker（支持离线访问）</span>
        <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>) {
          navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'CACHE_RESULT'</span>,
            <span class="hljs-attr">key</span>: <span class="hljs-string">'last-csv-analysis'</span>,
            <span class="hljs-attr">data</span>: analysisResult
          });
        }
        
        <span class="hljs-comment">// 7.4 更新状态文本</span>
        statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">`解析完成：共 <span class="hljs-subst">${analysisResult.totalCount}</span> 条&lt;/doubaocanvas&gt;
</span></code></pre>
<h3 data-id="heading-11">四、关于self</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 1. 来源：Worker 线程的内置全局对象，浏览器自动注入，无需定义</span>
<span class="hljs-comment">// 2. 作用：等同于主线程的 window，是 Worker 线程访问自身能力的入口</span>
<span class="hljs-comment">// 3. 隔离性：不同 Worker 的 self 是独立实例，互不干扰（如 Web Worker 的 self ≠ Service Worker 的 self）</span>
<span class="hljs-comment">// 4. 核心能力：接收/发送消息（onmessage/postMessage）、管理生命周期（close）、调用 Worker 专属 API</span>
</code></pre>
<h5 data-id="heading-12">Worker 中 self 的简单代码示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Worker 线程（calc-worker.js）</span>
<span class="hljs-comment">// self 指向当前 Web Worker 实例，仅用于计算相关逻辑</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { num1, num2 } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> sum = num1 + num2; <span class="hljs-comment">// 简单计算：两数相加</span>
  self.<span class="hljs-title function_">postMessage</span>(sum); <span class="hljs-comment">// 用 self 向主线程返回结果</span>
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 用 self 主动关闭 Worker，释放资源</span>
};
<span class="hljs-comment">// 主线程（main.js）- 配合使用</span>
<span class="hljs-keyword">const</span> calcWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'calc-worker.js'</span>);
calcWorker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">num1</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">num2</span>: <span class="hljs-number">20</span> }); <span class="hljs-comment">// 发数据给 Worker</span>
calcWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算结果：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// 输出 30</span>
};
</code></pre>
<h5 data-id="heading-13">注意：</h5>
<pre><code class="hljs language-lua" lang="lua">// 注意 <span class="hljs-number">1</span>：Worker 中不能用 window，必须用 <span class="hljs-built_in">self</span>（因 Worker 无窗口概念）
// 注意 <span class="hljs-number">2</span>：<span class="hljs-built_in">self</span> 无法访问 DOM（如 document、body），仅能处理非 UI 逻辑
// 注意 <span class="hljs-number">3</span>：简单场景可省略 <span class="hljs-built_in">self</span>（如 onmessage = () =&gt; {} 等同于 <span class="hljs-built_in">self</span>.onmessage = () =&gt; {}），但复杂场景建议保留，增强可读性
</code></pre>
<h3 data-id="heading-14">五、生产环境使用的平衡点</h3>
<h4 data-id="heading-15">1. 错误处理与健壮性</h4>
<ul>
<li>
<p>Worker 内部错误不会冒泡到主线程，需单独监听：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程</span>
worker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker错误：<span class="hljs-subst">${err.message}</span>`</span>);
  worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 出错后销毁Worker，避免内存泄漏</span>
};

<span class="hljs-comment">// Worker线程</span>
self.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ERROR'</span>, <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> });
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 主动关闭</span>
};
</code></pre>
</li>
<li>
<p>网络错误：Worker 脚本加载失败（404）时，主线程会触发 <code>error</code> 事件，需捕获并降级处理。</p>
</li>
</ul>
<h4 data-id="heading-16">2. 内存管理与资源回收</h4>
<ul>
<li>避免创建过多 Worker：每个 Worker 都是独立线程，占用内存和 CPU，建议通过 “Worker 池” 复用（如用 <code>p-queue</code> 管理 Worker 实例）。</li>
<li>及时销毁无用 Worker：<code>worker.terminate()</code>（主线程主动销毁，立即终止）或 <code>self.close()</code>（Worker 主动关闭，清理后终止）。</li>
<li>警惕内存泄漏：Worker 中若持有 <code>setInterval</code>、未关闭的 <code>fetch</code> 请求等，即使调用 <code>terminate</code> 也可能导致内存泄漏，需先清理资源。</li>
</ul>
<h4 data-id="heading-17">3. 跨域与安全策略</h4>
<ul>
<li>Worker 脚本必须与主线程同源（协议、域名、端口一致），若需加载跨域脚本，需通过 <code>importScripts</code> 加载且服务器允许跨域（<code>Access-Control-Allow-Origin</code>）。</li>
<li>禁止访问 <code>file://</code> 协议下的脚本（浏览器安全限制），本地开发需用 <code>http-server</code> 启动服务。</li>
<li>敏感操作限制：Worker 中无法使用 <code>localStorage</code>（部分浏览器支持，但规范不推荐），建议用 <code>IndexedDB</code> 存储大量数据（异步 API，不阻塞）。</li>
</ul>
<h4 data-id="heading-18">4. 兼容性处理与降级方案</h4>
<ul>
<li>
<p>浏览器支持：IE 完全不支持，Edge 12+、Chrome 4+、Firefox 3.5+ 支持基本特性，<code>SharedArrayBuffer</code> 和 <code>SharedWorker</code> 兼容性较差。</p>
</li>
<li>
<p>降级逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">if (window.Worker) {
  <span class="hljs-comment">// 使用Worker</span>
} else {
  <span class="hljs-comment">// 降级到主线程执行（给用户提示“当前浏览器可能卡顿”）</span>
  <span class="hljs-built_in">heavyTask</span>();
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-19">六、性能陷阱</h3>
<ol>
<li>
<p><strong>过度使用 Worker 导致性能反降</strong>小数据计算（如几毫秒可完成的操作）用 Worker 反而会增加通信开销（序列化 + 消息传递），建议仅对 <strong>执行时间 &gt; 50ms</strong> 的任务使用 Worker。</p>
</li>
<li>
<p><strong>频繁通信导致主线程阻塞</strong>若 Worker 与主线程高频次 <code>postMessage</code>（如每秒 hundreds 次），序列化数据会占用主线程资源，导致卡顿。解决方案：</p>
<ul>
<li>批量发送数据（累计一定量后再通信）；</li>
<li>用 <code>SharedArrayBuffer</code> 减少序列化开销。</li>
</ul>
</li>
<li>
<p><strong>Worker 中滥用同步 API</strong>Worker 虽然不阻塞 UI，但内部的同步操作（如 <code>XMLHttpRequest</code> 的同步请求、大量同步循环）会阻塞自身线程，导致无法响应消息。建议优先使用异步 API（<code>fetch</code>、<code>setImmediate</code>）。</p>
</li>
<li>
<p><strong>忽略线程优先级</strong>浏览器会给 Worker 分配较低的线程优先级，若需 “近实时” 处理（如游戏帧计算），可能出现延迟。此时可考虑 <code>requestIdleCallback</code> 结合 Worker，利用主线程空闲时间处理。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！]]></title>    <link>https://juejin.cn/post/7571355146770481194</link>    <guid>https://juejin.cn/post/7571355146770481194</guid>    <pubDate>2025-11-12T01:04:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355146770481194" data-draft-id="7559205383505526823" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！"/> <meta itemprop="keywords" content="Bun,Node.js,测试"/> <meta itemprop="datePublished" content="2025-11-12T01:04:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Legend80s"/> <meta itemprop="url" content="https://juejin.cn/user/2568105753839790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568105753839790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Legend80s
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:04:05.000Z" title="Wed Nov 12 2025 01:04:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>假设我们的组件或函数内使用了 <code>setInterval</code> (<code>setTimeout</code> 同理)，如果不对其进行任何操作，“傻傻等待”的话，一个单元测试可能就要耗费几秒钟才能完成，甚至还可能超时。</p>
<p>老牌的 jest 或新的 vitest 以及 node:test 原生都支持“时间快进”。但是 bun:test（v1.2.23 2025-10-10）尚未支持 <code>jest/vi.advanceTimersByTime</code>，将报错：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 快进1秒，触发1次 setInterval 回调</span>
<span class="hljs-number">37</span> |   vi.<span class="hljs-title function_">advanceTimersByTime</span>(<span class="hljs-number">1000</span>)
          ^
<span class="hljs-title class_">TypeError</span>: vi.<span class="hljs-property">advanceTimersByTime</span> is not a <span class="hljs-keyword">function</span>. (<span class="hljs-title class_">In</span> <span class="hljs-string">'vi.advanceTimersByTime(1000)'</span>, <span class="hljs-string">'vi.advanceTimersByTime'</span> is <span class="hljs-literal">undefined</span>)
</code></pre>
<p>难道只能“坐以待毙”？不，我们还有一种workaround。就是通过重写或者说 mock 全局 <code>setInterval / setTimeout</code>。</p>
<p>效果一睹为快：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8a359406d474f0095f2cf286b556703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVnZW5kODBz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514245&amp;x-signature=BZpvpHv%2BJ5VZzyimXgBh%2FDk9A0M%3D" alt="成功将耗时从 2s+ 优化到 300ms+，是其 1/8" loading="lazy"/></p>
<h2 data-id="heading-0">解决办法：重写 <code>setInterval</code></h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src\DeepThinkButton\demo\advanced.test.tsx:</span>
<span class="hljs-keyword">import</span> { afterEach, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>

<span class="hljs-comment">// 1. 保存原始的 setInterval</span>
<span class="hljs-keyword">const</span> originalSetInterval = globalThis.<span class="hljs-property">setInterval</span>

<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在每个测试开始前启用假定时器</span>
  <span class="hljs-comment">// @ts-expect-error</span>
  globalThis.<span class="hljs-property">setInterval</span> = <span class="hljs-function">(<span class="hljs-params">callback, delay</span>) =&gt;</span> {
    <span class="hljs-comment">// console.log('callback, delay:', { callback, delay })</span>

    <span class="hljs-keyword">if</span> (callback.<span class="hljs-property">name</span> === <span class="hljs-string">'deepThinkButtonInterval'</span>) {
      <span class="hljs-comment">// 返回一个原始 ID，并且内部调用原始函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">callback</span>()
      }, <span class="hljs-number">0</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(callback, delay)
    }
  }
})

<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在每个测试结束后恢复真定时器</span>
  globalThis.<span class="hljs-property">setInterval</span> = originalSetInterval
})
</code></pre>
<h3 data-id="heading-1">使用</h3>
<p>假设我们有如下待测试代码，测试深度思考功能：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 逐个字符显示，当完整内容显示后停止</span>
timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepThinkButtonInterval</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">setThinkContent</span>(<span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (text.<span class="hljs-property">length</span> &lt; <span class="hljs-variable constant_">THINK_CONTENT</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 每次输出 N 个字符</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">THINK_CONTENT</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, text.<span class="hljs-property">length</span> + <span class="hljs-number">2</span>)
    }

    <span class="hljs-built_in">clearInterval</span>(timer)
    <span class="hljs-title function_">setThinkingStatus</span>(<span class="hljs-string">'Completed'</span>)
    <span class="hljs-title function_">setThinkingStopTime</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())
    <span class="hljs-keyword">return</span> text
  })
}, <span class="hljs-number">20</span>)
</code></pre>
<p>执行</p>
<pre><code class="hljs language-ts" lang="ts">❯ bun test src/<span class="hljs-title class_">DeepThinkButton</span>/
</code></pre>
<p>正常情况耗时 2s+：</p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">2563.</span>00ms]
</code></pre>
<p>第一步修改待测试代码：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- timer = setInterval(() =&gt; {</span>
<span class="hljs-addition">+ timer = setInterval(function deepThinkButtonInterval() {</span>
</code></pre>
<p>也就是匿名函数改成具名函数，方便我们针对性 mock。</p>
<p>当我们给单测添加上述 mock 后，<strong>耗时减少到 1s+</strong>：</p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">1344.</span>00ms]
</code></pre>
<p>但其实我们还可以加速，即在一个 interval 回调中多次运行函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src\DeepThinkButton\demo\advanced.test.tsx:</span>
<span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 运行 6 次</span>
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
  }, <span class="hljs-number">0</span>)
</code></pre>
<p>可以看到又从 <strong>1s+ 优化到了 300ms+ ⚡️ ！</strong></p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">328.</span>00ms]
</code></pre>
<p>成功将耗时从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>s</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">2s+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">s</span><span class="mord">+</span></span></span></span></span> 优化到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>300</mn><mi>m</mi><mi>s</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">300ms+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">300</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord">+</span></span></span></span></span>，是其 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mn>8</mn></mrow><annotation encoding="application/x-tex">1/8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1/8</span></span></span></span></span>！</p>
<h2 data-id="heading-2">重构</h2>
<p>目前只有一个 test case 还好，如果多个 case 需要则要避免违背 DRY 原则，所以接下来我们封装成函数。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// tests/utils.ts</span>
<span class="hljs-keyword">import</span> { afterEach, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">advanceInterval</span>(<span class="hljs-params">
  callbackName: <span class="hljs-built_in">string</span>,
  { ms = <span class="hljs-number">0</span>, batchCalledCount = <span class="hljs-number">1</span> }: { ms?: <span class="hljs-built_in">number</span>; batchCalledCount?: <span class="hljs-built_in">number</span> } = {},
</span>) {
  <span class="hljs-comment">// 1. 保存原始的 setInterval</span>
  <span class="hljs-keyword">const</span> originalSetInterval = globalThis.<span class="hljs-property">setInterval</span>

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在每个测试开始前启用假定时器</span>
    <span class="hljs-comment">// @ts-expect-error</span>
    globalThis.<span class="hljs-property">setInterval</span> = <span class="hljs-function">(<span class="hljs-params">callback, delay</span>) =&gt;</span> {
      <span class="hljs-comment">// 返回一个模拟的ID，或者调用原始函数</span>
      <span class="hljs-keyword">if</span> (callback.<span class="hljs-property">name</span> === callbackName) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; batchCalledCount; i++) {
            <span class="hljs-title function_">callback</span>()
          }
        }, ms)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(callback, delay)
      }
    }
  })

  <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在每个测试结束后恢复真定时器</span>
    globalThis.<span class="hljs-property">setInterval</span> = originalSetInterval
  })
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-diff" lang="diff">// src/DeepThinkButton/demo/advanced.test.tsx
import React from 'react'
import { test, expect } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'

import Demo from './advanced'
import { advanceInterval } from '@/tests/rtl'

<span class="hljs-addition">+ advanceInterval('deepThinkButtonInterval', { batchCalledCount: 6 })</span>

test('自定义 icon、按钮尺寸，以及思考内容折叠后效果', async () =&gt; {
  ...
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践]]></title>    <link>https://juejin.cn/post/7571379089991483446</link>    <guid>https://juejin.cn/post/7571379089991483446</guid>    <pubDate>2025-11-12T02:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089991483446" data-draft-id="7571334572769771563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践"/> <meta itemprop="keywords" content="前端,HTML,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T02:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:49:48.000Z" title="Wed Nov 12 2025 02:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 <strong>学习目标</strong>：系统掌握HTML常用属性与全局属性的语义与行为，理解布尔/枚举属性的差异、跨源与安全相关属性的正确配置，并形成可落地的兼容性与可访问性最佳实践</p>
<p>📊 <strong>难度等级</strong>：初级-中级<br/>
🏷️ <strong>技术标签</strong>：<code>#HTML</code> <code>#属性</code> <code>#全局属性</code> <code>#布尔属性</code> <code>#data-*</code> <code>#ARIA</code> <code>#兼容性</code><br/>
⏱️ <strong>阅读时间</strong>：约9分钟</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🌟 引言</h2>
<p>HTML 的属性（attribute）决定了元素的语义、行为和表现。看似简单的 <code>disabled</code>、<code>contenteditable</code>、<code>hidden</code> 或 <code>data-*</code>，在不同的上下文与浏览器实现中却有不少差异：布尔属性是否需要写值？枚举属性有哪些合法取值？<code>crossorigin</code> 与 <code>integrity</code> 如何协同保障资源安全？这些问题若处理不当，会带来可访问性、性能甚至安全风险。</p>
<p>在日常的前端开发中，你是否遇到过这样的困扰：</p>
<ul>
<li>布尔属性写成 <code>disabled="false"</code> 仍然生效，导致交互异常；</li>
<li>滥用 <code>contenteditable</code> 造成键盘可访问性退化；</li>
<li>外链脚本未配置 SRI 与 CORS，被安全策略拦截或错误不透明；</li>
<li>图片懒加载与解码策略混用，出现首屏闪烁与布局抖动；</li>
</ul>
<p>今天分享 7 个「属性行为与最佳实践」核心技巧，帮你在开发中少踩坑、写出更稳妥的页面。</p>
<hr/>
<h2 data-id="heading-1">💡 核心技巧详解</h2>
<blockquote>
<p>📝 使用说明：本文选择 7 个最常用、最易混淆的属性主题进行讲解，每节均含场景、常见误区、推荐方案与要点。</p>
</blockquote>
<h3 data-id="heading-2">1. 全局属性速查：语义清晰、行为可控</h3>
<h4 data-id="heading-3">🔍 应用场景</h4>
<p>需要为元素添加标识与语义、调整方向与可编辑性、控制显示与拖拽能力等通用行为。</p>
<p>常见的全局属性包括：<code>id</code>、<code>class</code>、<code>title</code>、<code>lang</code>、<code>dir</code>、<code>hidden</code>、<code>draggable</code>、<code>contenteditable</code>。</p>
<h4 data-id="heading-4">❌ 常见问题</h4>
<ul>
<li>滥用 <code>id</code> 导致页面内唯一性被破坏；</li>
<li><code>dir</code>/<code>lang</code> 未设置，RTL/LTR 文本方向或语言识别错误；</li>
<li>非必要场景启用 <code>contenteditable</code>，可访问性与输入法体验变差；</li>
<li>用 <code>hidden</code> 替代逻辑卸载，产生无意义的可聚焦元素。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：任意启用 contenteditable 与隐身元素可聚焦问题 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">hidden</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑卡片"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：仅在明确编辑场景启用 contenteditable；按需设置语言与方向 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"profile"</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"ltr"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"用户资料"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__title"</span>&gt;</span>资料<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__desc"</span>&gt;</span>可编辑区域仅限下面的备注。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑备注"</span>&gt;</span>在此添加备注...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 安全启用/关闭可编辑区域
 * <span class="hljs-doctag">@description</span> 根据布尔开关控制元素的 contenteditable 与可聚焦性
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">enable</span> - 是否启用可编辑
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleEditable</span> = (<span class="hljs-params">el, enable</span>) =&gt; {
  <span class="hljs-comment">// 仅在需要时才启用，避免全局滥用</span>
  el.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'contenteditable'</span>, enable ? <span class="hljs-string">'true'</span> : <span class="hljs-string">'false'</span>);
  el.<span class="hljs-property">tabIndex</span> = enable ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; <span class="hljs-comment">// 控制键盘可访问性</span>
};
</code></pre>
<h4 data-id="heading-6">💡 核心要点</h4>
<ul>
<li><code>id</code> 必须全页面唯一；</li>
<li>为文档或区域设置正确的 <code>lang</code> 与 <code>dir</code>；</li>
<li><code>hidden</code> 会将元素从可访问性树中移除（但仍在 DOM），用于暂时隐藏而非卸载；</li>
<li><code>contenteditable</code> 仅用于编辑场景，注意键盘与焦点管理。</li>
</ul>
<h4 data-id="heading-7">🎯 实际应用</h4>
<p>在富文本组件中，仅对编辑容器启用 <code>contenteditable</code>，同时结合 <code>aria-label</code> 与键盘导航提示改善可访问性。</p>
<hr/>
<h3 data-id="heading-8">2. 布尔属性行为：存在即为真，值会被忽略</h3>
<h4 data-id="heading-9">🔍 应用场景</h4>
<p>控制交互状态，如禁用、自动聚焦、必填、隐藏等：<code>disabled</code>、<code>autofocus</code>、<code>required</code>、<code>hidden</code>、<code>checked</code>。</p>
<h4 data-id="heading-10">❌ 常见问题</h4>
<ul>
<li>写成 <code>disabled="false"</code> 仍然是禁用；</li>
<li>将布尔属性赋为字符串，误以为可关闭行为；</li>
<li>误用 <code>autofocus</code> 影响无障碍体验（页面初始焦点跳跃）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：disabled="false" 仍然禁用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">"false"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：通过属性存在性表达布尔含义；JS 控制用 property 更直观 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submitBtn"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 切换布尔属性：存在即为真
 * <span class="hljs-doctag">@description</span> 使用 property 控制更直观，避免字符串赋值歧义
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLButtonElement</span>} <span class="hljs-variable">btn</span> - 目标按钮
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">disabled</span> - 是否禁用
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setDisabled</span> = (<span class="hljs-params">btn, disabled</span>) =&gt; {
  btn.<span class="hljs-property">disabled</span> = disabled; <span class="hljs-comment">// 使用 property 代替 setAttribute('disabled', 'false')</span>
};

<span class="hljs-comment">/**
 * 初始化页面焦点
 * <span class="hljs-doctag">@description</span> 谨慎使用 autofocus，优先在脚本中设定初始焦点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">target</span> - 需要获得焦点的元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initFocus</span> = (<span class="hljs-params">target</span>) =&gt; {
  target.<span class="hljs-title function_">focus</span>(); <span class="hljs-comment">// 统一在脚本中管理初始焦点</span>
};
</code></pre>
<h4 data-id="heading-12">💡 核心要点</h4>
<ul>
<li>布尔属性仅凭「存在」即可生效，属性值通常被忽略；</li>
<li>在 JS 中优先使用 property（如 <code>el.disabled = true</code>），更直观也更兼容；</li>
<li>避免在初始加载阶段使用 <code>autofocus</code> 影响读屏与键盘用户。</li>
</ul>
<h4 data-id="heading-13">🎯 实际应用</h4>
<p>表单组件库中统一封装 <code>disabled</code> 控制逻辑，所有按钮与输入框采用 property 控制，避免属性字符串误用。</p>
<hr/>
<h3 data-id="heading-14">3. 枚举属性：合法取值与默认行为</h3>
<h4 data-id="heading-15">🔍 应用场景</h4>
<p>控制策略选择或行为方式：<code>loading</code>（img：<code>auto</code>/<code>lazy</code>/<code>eager</code>）、<code>decoding</code>（img：<code>sync</code>/<code>async</code>/<code>auto</code>）、<code>crossorigin</code>（<code>anonymous</code>/<code>use-credentials</code>）、<code>autocomplete</code>（多枚举值）。</p>
<h4 data-id="heading-16">❌ 常见问题</h4>
<ul>
<li>写入不合法取值被忽略，导致行为回退到默认；</li>
<li>不了解默认值，造成性能或兼容性问题（如图片解码抖动）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：不合法取值将被忽略，退回默认行为 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"fast"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"quick"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-17">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 合法取值：lazy 与 async 可配合减少首屏抖动 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"async"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 规范化枚举属性取值
 * <span class="hljs-doctag">@description</span> 保证属性在合法集合内，否则回退到安全默认
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">name</span> - 枚举属性名
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">allowed</span> - 合法取值集合
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">value</span> - 待设置的值
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setEnumAttr</span> = (<span class="hljs-params">el, name, allowed, value</span>) =&gt; {
  <span class="hljs-keyword">const</span> v = allowed.<span class="hljs-title function_">includes</span>(value) ? value : allowed[<span class="hljs-number">0</span>];
  el.<span class="hljs-title function_">setAttribute</span>(name, v);
};
</code></pre>
<h4 data-id="heading-18">💡 核心要点</h4>
<ul>
<li>明确每个枚举属性的合法取值集合与默认值；</li>
<li>图片建议 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少阻塞与抖动；</li>
<li>跨源枚举值仅限 <code>anonymous</code> 与 <code>use-credentials</code>，影响资源请求与错误可见性。</li>
</ul>
<h4 data-id="heading-19">🎯 实际应用</h4>
<p>资源管理组件统一通过枚举校验函数设置 <code>loading</code>/<code>decoding</code>，确保配置合法与表现稳定。</p>
<hr/>
<h3 data-id="heading-20">4. 数据属性 data-* 与 dataset：结构化携带业务数据</h3>
<h4 data-id="heading-21">🔍 应用场景</h4>
<p>在不污染语义的前提下，为元素附加结构化元数据，配合脚本读取与更新。</p>
<h4 data-id="heading-22">❌ 常见问题</h4>
<ul>
<li>将业务状态塞进 <code>class</code>/<code>id</code>，难以维护；</li>
<li>用 <code>innerHTML</code> 拼字符串读取数据，易遭XSS风险。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：用 class/id 存业务状态，耦合样式与脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"order_1234"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-23">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：使用 data-* 描述元数据，脚本通过 dataset 读取/更新 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"orderBtn"</span> <span class="hljs-attr">data-order-id</span>=<span class="hljs-string">"1234"</span> <span class="hljs-attr">data-state</span>=<span class="hljs-string">"processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 读取并更新 dataset
 * <span class="hljs-doctag">@description</span> 通过 dataset 读取/写入 data-*，保持结构化与安全
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">{orderId:string,state:string</span>}}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useDataset</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> { orderId, state } = el.<span class="hljs-property">dataset</span>;
  <span class="hljs-comment">// 更新状态为已完成</span>
  el.<span class="hljs-property">dataset</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'done'</span>;
  <span class="hljs-keyword">return</span> { orderId, state };
};
</code></pre>
<h4 data-id="heading-24">💡 核心要点</h4>
<ul>
<li><code>data-*</code> 值始终是字符串；复杂数据请用 JSON 并在脚本中解析；</li>
<li>读取使用 <code>el.dataset.xxx</code>（自动将 <code>data-xxx</code> 转驼峰）；</li>
<li>避免将视觉样式与业务状态耦合在 <code>class</code>/<code>id</code>。</li>
</ul>
<h4 data-id="heading-25">🎯 实际应用</h4>
<p>在列表项中用 <code>data-id</code>/<code>data-type</code> 附加元数据，事件委托时通过 <code>dataset</code> 精确识别目标项。</p>
<hr/>
<h3 data-id="heading-26">5. 表单属性最佳实践：可用性与安全</h3>
<h4 data-id="heading-27">🔍 应用场景</h4>
<p>文件选择与拍照、自动完成功能、输入合法性：<code>accept</code>、<code>capture</code>、<code>autocomplete</code>、<code>required</code> 等。</p>
<h4 data-id="heading-28">❌ 常见问题</h4>
<ul>
<li><code>accept</code> 写错 MIME/扩展名，导致系统选择器无法过滤；</li>
<li><code>capture</code> 盲目开启，移动端直接拉起摄像头影响体验；</li>
<li><code>autocomplete</code> 未按枚举值配置，自动填充失败或扰民。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：accept 写错扩展名或缺少 MIME --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpg"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-29">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：精确的 MIME 或扩展名；按需配置 capture 与 autocomplete --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpeg,image/png"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cameraInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span> <span class="hljs-attr">capture</span>=<span class="hljs-string">"environment"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">autocomplete</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">required</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验文件选择类型
 * <span class="hljs-doctag">@description</span> 检查文件扩展名是否符合 accept 策略
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} <span class="hljs-variable">file</span> - 用户选择的文件
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否通过校验
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validateFileType</span> = (<span class="hljs-params">file</span>) =&gt; {
  <span class="hljs-keyword">const</span> ok = <span class="hljs-regexp">/(jpe?g|png)$/i</span>.<span class="hljs-title function_">test</span>(file.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-30">💡 核心要点</h4>
<ul>
<li><code>accept</code> 建议使用 MIME 类型（更通用）+ 扩展名兜底；</li>
<li>移动端谨慎使用 <code>capture</code>，为用户保留从相册选择的路径；</li>
<li><code>autocomplete</code> 使用标准枚举取值提升可用性与安全（如 <code>email</code>、<code>username</code>、<code>current-password</code>）。</li>
</ul>
<h4 data-id="heading-31">🎯 实际应用</h4>
<p>上传组件在客户端先做轻量类型校验，失败时不触发网络请求，减少后端压力与无效流量。</p>
<hr/>
<h3 data-id="heading-32">6. 跨源与安全属性：<code>crossorigin</code>、<code>integrity</code>、<code>referrerpolicy</code></h3>
<h4 data-id="heading-33">🔍 应用场景</h4>
<p>外链脚本/样式/图片资源的安全与错误透明化，CDN 资源加载。</p>
<h4 data-id="heading-34">❌ 常见问题</h4>
<ul>
<li>使用 SRI（<code>integrity</code>）却未设置匹配的 CORS（<code>crossorigin</code>），导致校验失败或错误不可见；</li>
<li>未配置 <code>referrerpolicy</code>，敏感页面泄露来源信息。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：SRI 未配合 CORS，可能导致资源校验失败或错误信息被隐藏 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span> <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-35">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ SRI + CORS 协同；可按需设置 referrerpolicy --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span>
  <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
  <span class="hljs-attr">referrerpolicy</span>=<span class="hljs-string">"no-referrer"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验跨源配置是否完整
 * <span class="hljs-doctag">@description</span> 简单检查元素是否同时具备 integrity 与合适的 crossorigin
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLScriptElement</span>} <span class="hljs-variable">el</span> - 外链脚本元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否满足基本安全配置
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkCrossOriginSafety</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> hasSRI = !!el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'integrity'</span>);
  <span class="hljs-keyword">const</span> co = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'crossorigin'</span>);
  <span class="hljs-keyword">const</span> ok = hasSRI &amp;&amp; (co === <span class="hljs-string">'anonymous'</span> || co === <span class="hljs-string">'use-credentials'</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-36">💡 核心要点</h4>
<ul>
<li>SRI 要与 <code>crossorigin</code> 协同；</li>
<li><code>referrerpolicy</code> 根据场景合理配置（如下载页可用 <code>no-referrer</code>）；</li>
<li>了解错误可见性：跨源脚本在无 CORS 时错误堆栈受限。</li>
</ul>
<h4 data-id="heading-37">🎯 实际应用</h4>
<p>CDN 资源统一模板化：所有外链脚本/样式自动附加 <code>integrity</code> 与 <code>crossorigin</code>，并提供策略位可配置 <code>referrerpolicy</code>。</p>
<hr/>
<h3 data-id="heading-38">7. 可访问性与 ARIA：属性与角色的协同</h3>
<h4 data-id="heading-39">🔍 应用场景</h4>
<p>自定义组件（如伪按钮、可折叠区域）需要通过 <code>role</code> 与 <code>aria-*</code> 提升语义与可操作性。</p>
<h4 data-id="heading-40">❌ 常见问题</h4>
<ul>
<li>仅靠 <code>div</code> + 点击事件充当按钮，键盘用户无法操作；</li>
<li>误用 <code>aria-*</code> 与原生属性冲突（如对 <code>&lt;button&gt;</code> 重复声明 <code>role="button"</code>）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：无键盘可访问性与语义缺失 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"doLike()"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-41">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 使用 role 与 aria-* 改善语义与交互；同时处理键盘事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"点赞"</span> <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 为伪按钮添加键盘可访问性
 * <span class="hljs-doctag">@description</span> 处理 Enter/Space 键以触发点击行为
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 伪按钮元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">() =&gt; void</span>} <span class="hljs-variable">onActive</span> - 激活时的回调
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">enhancePseudoButton</span> = (<span class="hljs-params">el, onActive</span>) =&gt; {
  el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> k = e.<span class="hljs-property">key</span>;
    <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'Enter'</span> || k === <span class="hljs-string">' '</span>) {
      e.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-title function_">onActive</span>();
    }
  });
};
</code></pre>
<h4 data-id="heading-42">💡 核心要点</h4>
<ul>
<li>原生控件优先（<code>&lt;button&gt;</code>、<code>&lt;a&gt;</code> 等）；若必须自定义，再使用 <code>role</code> 与 <code>aria-*</code>；</li>
<li>始终为可交互元素提供键盘等效操作；</li>
<li>避免与原生属性冲突的冗余 <code>role</code> 声明。</li>
</ul>
<h4 data-id="heading-43">🎯 实际应用</h4>
<p>在卡片组件的可折叠区域使用 <code>aria-expanded</code> 与键盘事件，保证读屏与键盘用户体验一致。</p>
<hr/>
<h2 data-id="heading-44">📊 技巧对比总结</h2>





















































<table><thead><tr><th>技巧</th><th>使用场景</th><th>优势</th><th>注意事项</th></tr></thead><tbody><tr><td>全局属性速查</td><td>元素语义与行为</td><td>统一管理 <code>lang/dir</code> 与编辑性</td><td>慎用 <code>contenteditable</code> 与 <code>hidden</code></td></tr><tr><td>布尔属性行为</td><td>交互禁用/焦点</td><td>property 控制直观兼容</td><td>避免 <code>autofocus</code> 影响可访问性</td></tr><tr><td>枚举属性</td><td>资源加载与策略</td><td>明确合法取值与默认值</td><td><code>crossorigin</code> 仅两种取值</td></tr><tr><td>data-* 与 dataset</td><td>携带元数据</td><td>结构化与安全</td><td>值为字符串，复杂用 JSON</td></tr><tr><td>表单属性</td><td>文件与自动填充</td><td>可用性与安全</td><td>谨慎 <code>capture</code>，精确 <code>accept</code></td></tr><tr><td>跨源与安全</td><td>外链资源</td><td>SRI + CORS 协同</td><td>错误可见性受跨源影响</td></tr><tr><td>ARIA 可访问性</td><td>自定义组件</td><td>语义与键盘可用性</td><td>避免与原生属性冲突</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-45">🎯 实战应用建议</h2>
<h3 data-id="heading-46">最佳实践</h3>
<ol>
<li>全局启用文档 <code>lang</code> 与合理的 <code>dir</code> 配置，国际化场景更稳。</li>
<li>统一封装布尔属性控制，全部走 property（<code>el.disabled = true</code>）。</li>
<li>图片使用 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少首屏阻塞与抖动。</li>
<li>业务元数据统一使用 <code>data-*</code>，避免与样式耦合。</li>
<li>表单的 <code>accept/capture/autocomplete</code> 按枚举规范配置，兼顾体验与安全。</li>
<li>外链资源模板化 SRI + CORS，必要时加 <code>referrerpolicy</code>，保障安全与隐私。</li>
</ol>
<h3 data-id="heading-47">性能考虑</h3>
<ul>
<li>图片与媒体优先使用懒加载与异步解码；</li>
<li>减少不必要的可编辑区域与聚焦跳转；</li>
<li>外链资源开启校验与跨源配置，降低失败成本并提升错误可见性。</li>
</ul>
<hr/>
<h2 data-id="heading-48">💡 总结</h2>
<p>这 7 个属性主题覆盖了日常开发中最常见且最易混淆的行为。掌握它们能让你的页面：</p>
<ol>
<li>更语义化、可访问；</li>
<li>更可控、少踩坑；</li>
<li>更安全、可观测；</li>
<li>更稳定、高性能。</li>
</ol>
<hr/>
<h2 data-id="heading-49">🔗 相关资源</h2>
<ul>
<li>MDN: HTML attribute reference — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FAttributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Global attributes — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FGlobal_attributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: ARIA roles, states and properties — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAccessibility%2FARIA" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Subresource Integrity (SRI) — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FSubresource_Integrity" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 今日收获：理解了布尔与枚举属性的差异、data-* 的安全用法与跨源安全配置的关键点，能够在项目中落地更稳妥的属性策略。</p>
</blockquote>
<p><strong>如果这篇文章对你有帮助，欢迎点赞、收藏和分享！有任何问题也欢迎在评论区讨论。</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制]]></title>    <link>https://juejin.cn/post/7571351275976605747</link>    <guid>https://juejin.cn/post/7571351275976605747</guid>    <pubDate>2025-11-12T00:21:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571351275976605747" data-draft-id="7571352754896437274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制"/> <meta itemprop="keywords" content="后端,Python,IPython"/> <meta itemprop="datePublished" content="2025-11-12T00:21:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:21:57.000Z" title="Wed Nov 12 2025 00:21:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在进行网页爬取时，如果频繁访问同一网站，极有可能被网站识别为爬虫，从而封禁 IP 或要求验证码验证。
为了保证爬虫稳定、高效运行，我们需要了解并掌握 <strong>防封机制与代理使用方法</strong>。</p>
</blockquote>
<p>本章将介绍 Python 爬虫中常用的防封策略、代理原理及实战应用技巧。</p>
<hr/>
<h2 data-id="heading-0">一、为什么会被封</h2>
<p>网站封禁爬虫主要是为了防止资源滥用与服务器过载。常见的封禁手段包括：</p>
<ol>
<li><strong>IP 封禁</strong>：短时间内请求频繁，直接拉黑访问 IP。</li>
<li><strong>User-Agent 检测</strong>：识别请求头中是否包含浏览器标识。</li>
<li><strong>Referer 检查</strong>：判断请求是否来自正常页面跳转。</li>
<li><strong>Cookie 校验</strong>：验证登录状态或访问来源。</li>
<li><strong>请求频率限制</strong>：同一用户短时间内过多请求触发反爬。</li>
</ol>
<p>要应对这些情况，我们可以从 <strong>“伪装自己”</strong> 和 <strong>“多IP访问”</strong> 两个方向入手。</p>
<hr/>
<h2 data-id="heading-1">二、请求伪装：模拟真实用户访问</h2>
<h3 data-id="heading-2">1. 设置请求头</h3>
<p><code>requests</code> 支持通过 <code>headers</code> 参数自定义请求头。
常见做法是添加浏览器信息，让服务器认为请求来自正常用户。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"https://example.com"</span>
headers = {
    <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span>
                  <span class="hljs-string">"AppleWebKit/537.36 (KHTML, like Gecko) "</span>
                  <span class="hljs-string">"Chrome/122.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Referer"</span>: <span class="hljs-string">"https://www.google.com"</span>,
}
response = requests.get(url, headers=headers)
<span class="hljs-built_in">print</span>(response.status_code)
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 随机切换 User-Agent</h3>
<p>为了避免单一 User-Agent 被识别为爬虫，可以在请求中随机切换浏览器标识。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> random

user_agents = [
    <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/123.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) Firefox/124.0"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Linux; Android 10) Mobile Safari/537.36"</span>,
]

headers = {<span class="hljs-string">"User-Agent"</span>: random.choice(user_agents)}
</code></pre>
<p>每次访问时随机选择一个头部，能有效减少被识别风险。</p>
<hr/>
<h3 data-id="heading-4">3. 添加延时与随机等待</h3>
<p>频繁访问网站最容易触发风控。
合理的做法是添加访问间隔，并随机化等待时间：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random

time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment"># 等待1~3秒</span>
</code></pre>
<p>这样能让访问节奏更像人类操作。</p>
<hr/>
<h2 data-id="heading-5">三、使用代理服务器（Proxy）</h2>
<p>当 IP 被封时，使用代理服务器可以切换出口 IP，从而继续访问。</p>
<p>代理服务器会代替你访问目标网站，然后将结果返回。
Python 中可以通过 <code>requests</code> 轻松使用代理。</p>
<hr/>
<h3 data-id="heading-6">1. 设置代理参数</h3>
<pre><code class="hljs language-python" lang="python">proxies = {
    <span class="hljs-string">"http"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"https"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
}

response = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxies, timeout=<span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(response.text)
</code></pre>
<p>如果代理有效，返回的 IP 将与本机不同。</p>
<hr/>
<h3 data-id="heading-7">2. 使用代理池（Proxy Pool）</h3>
<p>手动设置代理不方便，可以使用 <strong>代理池</strong> 自动随机选取可用代理。</p>
<p>简单示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> time

proxies_list = [
    <span class="hljs-string">"http://111.22.33.44:8080"</span>,
    <span class="hljs-string">"http://222.11.55.66:8888"</span>,
    <span class="hljs-string">"http://77.88.99.100:3128"</span>,
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_random_proxy</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    proxy = get_random_proxy()
    <span class="hljs-keyword">try</span>:
        res = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxy, timeout=<span class="hljs-number">5</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"使用代理 <span class="hljs-subst">{proxy[<span class="hljs-string">'http'</span>]}</span> -&gt; <span class="hljs-subst">{res.json()}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"代理失效："</span>, e)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 购买或搭建代理池</h3>
<p>免费代理常常不稳定，建议：</p>
<ul>
<li>使用付费代理服务（如芝麻代理、快代理等）。</li>
<li>自行搭建代理池服务，结合 Redis 存储和自动检测可用 IP。</li>
</ul>
<p>一个简单的代理池架构：</p>
<pre><code class="hljs">爬虫程序 → 请求代理池接口 → 返回可用代理 → 访问目标网站
代理池后台 → 定期检测代理可用性 → 清理无效IP
</code></pre>
<hr/>
<h2 data-id="heading-9">四、Cookie 与会话保持</h2>
<p>某些网站需要登录才能访问数据，这时需要处理 <strong>Cookie</strong>。
可以使用 <code>requests.Session()</code> 自动保持会话状态。</p>
<pre><code class="hljs language-python" lang="python">session = requests.Session()
login_url = <span class="hljs-string">"https://example.com/login"</span>
payload = {<span class="hljs-string">"username"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>: <span class="hljs-string">"pass"</span>}
session.post(login_url, data=payload)

<span class="hljs-comment"># 登录成功后继续访问页面</span>
resp = session.get(<span class="hljs-string">"https://example.com/user/profile"</span>)
<span class="hljs-built_in">print</span>(resp.text)
</code></pre>
<p><code>Session</code> 会自动保存登录后的 Cookie 信息，避免每次请求重新认证。</p>
<hr/>
<h2 data-id="heading-10">五、验证码与高级防爬</h2>
<p>有的网站会要求输入验证码或 JavaScript 加密验证请求。
常见应对思路包括：</p>
<ol>
<li><strong>人工辅助识别</strong>：遇到验证码暂停爬取，手动输入。</li>
<li><strong>OCR 识别验证码</strong>：通过 <code>pytesseract</code> 识别简单图片验证码。</li>
<li><strong>模拟浏览器行为</strong>：使用 <code>selenium</code> 或 <code>playwright</code> 执行网页中的 JS 逻辑。</li>
</ol>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver

driver = webdriver.Chrome()
driver.get(<span class="hljs-string">"https://example.com"</span>)
<span class="hljs-built_in">print</span>(driver.title)
driver.quit()
</code></pre>
<p>这种方式能绕过大部分基于 JS 渲染或验证的防爬机制。</p>
<hr/>
<h2 data-id="heading-11">六、异常与重试机制</h2>
<p>网络请求容易超时或失败，建议添加异常重试机制。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_request</span>(<span class="hljs-params">url, retries=<span class="hljs-number">3</span></span>):
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(retries):
        <span class="hljs-keyword">try</span>:
            res = requests.get(url, timeout=<span class="hljs-number">10</span>)
            <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">200</span>:
                <span class="hljs-keyword">return</span> res.text
        <span class="hljs-keyword">except</span> requests.RequestException:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 次请求失败，重试中..."</span>)
            time.sleep(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">七、综合实战示例</h2>
<p>综合以上技巧，我们可以实现一个稳定、抗封的爬虫：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests, random, time

headers_list = [
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Chrome/122.0.0.0"</span>},
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Firefox/124.0"</span>},
]
proxies_list = [
    <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"http://222.111.55.66:8888"</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">url</span>):
    headers = random.choice(headers_list)
    proxy = {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, headers=headers, proxies=proxy, timeout=<span class="hljs-number">10</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问成功："</span>, response.status_code, <span class="hljs-string">"IP："</span>, proxy)
        <span class="hljs-keyword">return</span> response.text
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问失败："</span>, e)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    html = fetch(<span class="hljs-string">"https://httpbin.org/ip"</span>)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))
</code></pre>
<hr/>
<h2 data-id="heading-13">八、总结</h2>

































<table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td><strong>请求伪装</strong></td><td>设置随机 User-Agent、Referer 等头信息</td></tr><tr><td><strong>请求间隔控制</strong></td><td>使用随机延时，模拟真实用户行为</td></tr><tr><td><strong>代理机制</strong></td><td>通过代理IP切换访问来源</td></tr><tr><td><strong>会话保持</strong></td><td>使用 Session 管理登录状态</td></tr><tr><td><strong>异常重试</strong></td><td>防止临时网络错误导致程序中断</td></tr><tr><td><strong>浏览器模拟</strong></td><td>处理验证码或动态渲染内容</td></tr></tbody></table>
<hr/>
<p>通过合理运用这些防封策略与代理机制，你的 Python 爬虫将更稳定、更高效、更接近真实用户访问行为，为后续数据采集与分析奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 useState 到 URLState：前端状态管理的另一种思路]]></title>    <link>https://juejin.cn/post/7571306072423628842</link>    <guid>https://juejin.cn/post/7571306072423628842</guid>    <pubDate>2025-11-12T01:09:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072423628842" data-draft-id="7571306072423612458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 useState 到 URLState：前端状态管理的另一种思路"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2025-11-12T01:09:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宇余"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453424542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 useState 到 URLState：前端状态管理的另一种思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453424542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宇余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:09:56.000Z" title="Wed Nov 12 2025 01:09:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 开发中，<code>useState</code> 是我们最常用的状态管理工具之一。它轻量、直观，能满足大多数组件级状态管理需求。但在某些场景下，比如列表筛选、分页、多页面共享状态时，单纯使用 <code>useState</code> 会遇到状态丢失、刷新页面重置等问题。这时候，<strong>URLState</strong> 或许是一个更优雅的解决方案。</p>
<h2 data-id="heading-0">一、useState 的「痛点」场景</h2>
<p>先来看一个常见的业务场景：实现一个带筛选功能的商品列表页，包含「价格区间」「分类」「排序方式」三个筛选条件。用 <code>useState</code> 实现的代码可能是这样的：</p>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 筛选状态</span>
  <span class="hljs-keyword">const</span> [priceRange, setPriceRange] = <span class="hljs-title function_">useState</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>]);
  <span class="hljs-keyword">const</span> [category, setCategory] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'all'</span>);
  <span class="hljs-keyword">const</span> [sortBy, setSortBy] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'price-asc'</span>);

  <span class="hljs-comment">// 筛选逻辑...</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FilterPanel</span> 
        <span class="hljs-attr">priceRange</span>=<span class="hljs-string">{priceRange}</span>
        <span class="hljs-attr">onPriceRangeChange</span>=<span class="hljs-string">{setPriceRange}</span>
        <span class="hljs-attr">category</span>=<span class="hljs-string">{category}</span>
        <span class="hljs-attr">onCategoryChange</span>=<span class="hljs-string">{setCategory}</span>
        <span class="hljs-attr">sortBy</span>=<span class="hljs-string">{sortBy}</span>
        <span class="hljs-attr">onSortByChange</span>=<span class="hljs-string">{setSortBy}</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductGrid</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这段代码看似没问题，但存在三个明显痛点：</p>
<ul>
<li>
<p><strong>页面刷新状态丢失</strong>：用户筛选后刷新页面，所有筛选条件会重置为初始值，体验极差。</p>
</li>
<li>
<p><strong>状态无法共享</strong>：如果需要在其他页面（比如商品详情页）回退到筛选后的列表，无法携带筛选状态。</p>
</li>
<li>
<p><strong>无法书签/分享</strong>：用户想把筛选后的结果分享给同事，复制链接过去是未筛选的初始状态。</p>
</li>
</ul>
<h2 data-id="heading-1">二、什么是 URLState？为什么要用它？</h2>
<p><strong>URLState</strong> 是将应用状态存储在 URL 查询参数（Query String）中的状态管理方式。比如上面的筛选场景，使用 URLState 后，URL 可能变成这样：</p>
<pre><code class="hljs language-Plain" lang="Plain">
https://example.com/products?price=0-1000&amp;category=electronics&amp;sort=price-asc
</code></pre>
<p>这种方式的核心优势在于：</p>
<ul>
<li>
<p>「刷新不丢状态」：URL 是浏览器的持久化载体，刷新页面参数不会消失。</p>
</li>
<li>
<p>「天然可共享」：复制 URL 即可分享当前状态，支持书签保存。</p>
</li>
<li>
<p>「跨页传参简单」：不同页面间通过 URL 即可传递状态，无需依赖全局状态库。</p>
</li>
<li>
<p>「可回溯」：浏览器的前进/后退按钮能直接回溯状态变更历史。</p>
</li>
</ul>
<h2 data-id="heading-2">三、实现 URLState：自定义 useURLState Hook</h2>
<p>其实 URLState 的实现并不复杂，核心是通过 <code>URLSearchParams</code> 操作查询参数，并结合 React 的状态更新机制。下面我们封装一个通用的 <code>useURLState</code> Hook。</p>
<h3 data-id="heading-3">3.1 核心逻辑拆解</h3>
<ol>
<li>
<p>从 URL 中解析初始状态：通过 <code>new URLSearchParams(window.location.search)</code> 获取查询参数。</p>
</li>
<li>
<p>定义状态更新函数：修改状态时，同步更新 URL（使用 <code>history.pushState</code> 避免页面刷新）。</p>
</li>
<li>
<p>监听 URL 变化：当用户通过前进/后退按钮切换历史记录时，同步更新组件状态。</p>
</li>
</ol>
<h3 data-id="heading-4">3.2 完整实现代码</h3>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useState, useEffect, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useURLState</span>(<span class="hljs-params">initialState = {}</span>) {
  <span class="hljs-comment">// 从 URL 解析状态</span>
  <span class="hljs-keyword">const</span> parseURLState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
    <span class="hljs-keyword">const</span> state = {};
    
    <span class="hljs-comment">// 遍历初始状态，从 URL 中提取对应参数</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(initialState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, defaultValue]</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = searchParams.<span class="hljs-title function_">get</span>(key);
      <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
        state[key] = defaultValue;
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 处理不同类型的默认值（数字、布尔、数组等）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defaultValue === <span class="hljs-string">'number'</span>) {
        state[key] = <span class="hljs-title class_">Number</span>(value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defaultValue === <span class="hljs-string">'boolean'</span>) {
        state[key] = value === <span class="hljs-string">'true'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(defaultValue)) {
        state[key] = value.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>);
      } <span class="hljs-keyword">else</span> {
        state[key] = value;
      }
    });
    
    <span class="hljs-keyword">return</span> state;
  }, [initialState]);

  <span class="hljs-comment">// 初始化状态：从 URL 解析或使用初始值</span>
  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(<span class="hljs-title function_">parseURLState</span>());

  <span class="hljs-comment">// 当 URL 变化时（前进/后退），同步更新状态</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePopState</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setState</span>(<span class="hljs-title function_">parseURLState</span>());
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'popstate'</span>, handlePopState);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'popstate'</span>, handlePopState);
  }, [parseURLState]);

  <span class="hljs-comment">// 更新状态并同步到 URL</span>
  <span class="hljs-keyword">const</span> setURLState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">newState</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
    <span class="hljs-keyword">const</span> nextState = { ...state, ...newState };
    
    <span class="hljs-comment">// 遍历新状态，更新到 searchParams</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(nextState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (value === initialState[key]) {
        <span class="hljs-comment">// 如果值等于初始值，移除该参数（保持 URL 简洁）</span>
        searchParams.<span class="hljs-title function_">delete</span>(key);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 数组类型用 "-" 拼接</span>
        <span class="hljs-keyword">const</span> paramValue = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value) ? value.<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>) : <span class="hljs-title class_">String</span>(value);
        searchParams.<span class="hljs-title function_">set</span>(key, paramValue);
      }
    });
    
    <span class="hljs-comment">// 更新 URL（pushState 不会刷新页面）</span>
    <span class="hljs-keyword">const</span> searchString = searchParams.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> newUrl = searchString ? <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.location.pathname}</span>?<span class="hljs-subst">${searchString}</span>`</span> : <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>;
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newUrl);
    
    <span class="hljs-comment">// 更新组件状态</span>
    <span class="hljs-title function_">setState</span>(nextState);
  }, [state, initialState]);

  <span class="hljs-keyword">return</span> [state, setURLState];
}
</code></pre>
<h2 data-id="heading-5">四、实战：用 URLState 重构商品列表页</h2>
<p>有了 <code>useURLState</code>，我们可以轻松重构之前的商品列表页，解决 <code>useState</code> 带来的痛点：</p>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useURLState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useURLState'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用 useURLState 替代 useState，初始状态和之前一致</span>
  <span class="hljs-keyword">const</span> [state, setURLState] = <span class="hljs-title function_">useURLState</span>({
    <span class="hljs-attr">priceRange</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>], <span class="hljs-comment">// 数组类型</span>
    <span class="hljs-attr">category</span>: <span class="hljs-string">'all'</span>,       <span class="hljs-comment">// 字符串类型</span>
    <span class="hljs-attr">sortBy</span>: <span class="hljs-string">'price-asc'</span>    <span class="hljs-comment">// 字符串类型</span>
  });

  <span class="hljs-keyword">const</span> { priceRange, category, sortBy } = state;

  <span class="hljs-comment">// 筛选条件变更时，调用 setURLState 更新</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePriceChange</span> = (<span class="hljs-params">newRange</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">priceRange</span>: newRange });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCategoryChange</span> = (<span class="hljs-params">newCategory</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">category</span>: newCategory });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSortChange</span> = (<span class="hljs-params">newSort</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">sortBy</span>: newSort });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FilterPanel</span> 
        <span class="hljs-attr">priceRange</span>=<span class="hljs-string">{priceRange}</span>
        <span class="hljs-attr">onPriceRangeChange</span>=<span class="hljs-string">{handlePriceChange}</span>
        <span class="hljs-attr">category</span>=<span class="hljs-string">{category}</span>
        <span class="hljs-attr">onCategoryChange</span>=<span class="hljs-string">{handleCategoryChange}</span>
        <span class="hljs-attr">sortBy</span>=<span class="hljs-string">{sortBy}</span>
        <span class="hljs-attr">onSortByChange</span>=<span class="hljs-string">{handleSortChange}</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductGrid</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>此时，用户筛选商品后，URL 会自动更新为：</p>
<pre><code class="hljs language-Plain" lang="Plain">
https://example.com/products?priceRange=0-2000&amp;category=electronics&amp;sortBy=price-desc
</code></pre>
<p>刷新页面、复制链接分享、后退到上一个筛选状态，都能完美生效！</p>
<h2 data-id="heading-6">五、URLState 的适用场景与注意事项</h2>
<h3 data-id="heading-7">5.1 适用场景</h3>
<ul>
<li>
<p>列表筛选、分页、排序等「可分享」的状态。</p>
</li>
<li>
<p>多步骤表单（如注册流程）的进度状态。</p>
</li>
<li>
<p>单页应用中的「页面级」状态（如标签页切换）。</p>
</li>
</ul>
<h3 data-id="heading-8">5.2 注意事项</h3>
<ul>
<li>
<p><strong>不要存储敏感信息</strong>：URL 参数会暴露在地址栏、浏览器历史、服务器日志中，密码、token 等敏感信息绝对不能用 URLState。</p>
</li>
<li>
<p><strong>参数不宜过多/过长</strong>：浏览器对 URL 长度有上限（通常 2KB-8KB），复杂状态建议用全局状态库（如 Redux）。</p>
</li>
<li>
<p><strong>处理特殊类型数据</strong>：对于对象等复杂类型，需要先序列化（如 JSON.stringify），但会增加 URL 长度，需谨慎使用。</p>
</li>
</ul>
<h2 data-id="heading-9">六、总结</h2>
<p><code>useState</code> 是 React 状态管理的基石，但在「状态持久化」「可分享」场景下存在局限。URLState 作为一种轻量级的补充方案，通过 URL 查询参数实现状态的持久化和共享，无需引入复杂的状态管理库，就能解决很多实际业务问题。</p>
<p>当然，URLState 不是银弹，它和 <code>useState</code>、全局状态库是互补关系。在合适的场景选择合适的工具，才是高效开发的关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 10 分钟吃透 CSS position 定位！从底层原理到避坑实战，搞定所有布局难题]]></title>    <link>https://juejin.cn/post/7571285984089686068</link>    <guid>https://juejin.cn/post/7571285984089686068</guid>    <pubDate>2025-11-11T17:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984089686068" data-draft-id="7571344319701942312" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 10 分钟吃透 CSS position 定位！从底层原理到避坑实战，搞定所有布局难题"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-11T17:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 10 分钟吃透 CSS position 定位！从底层原理到避坑实战，搞定所有布局难题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T17:17:20.000Z" title="Tue Nov 11 2025 17:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，布局是核心技能之一，而<code>position</code>属性更是布局的 “灵魂”—— 它决定了元素在页面中的位置关系，是实现复杂布局、悬浮组件、固定导航等效果的关键。很多开发者入门时会混淆<code>absolute</code>和<code>fixed</code>，踩坑<code>sticky</code>不生效的问题，本质上是没吃透其底层原理。本文结合 5 个实战案例，从文档流本质出发，全面解析<code>position</code>的 5 种属性用法，帮你彻底掌握这个 CSS 基础核心知识点。</p>
<h2 data-id="heading-0">一、先搞懂：文档流是什么？</h2>
<p>要理解<code>position</code>，必须先明确 “文档流” 的概念 —— 这是 HTML 元素默认的布局规则，就像现实中排队一样，元素按照代码顺序依次排列。</p>
<p>块级元素（如<code>div</code>、<code>p</code>）默认垂直排列，每个元素独占一行，自上而下依次分布；行内元素（如<code>span</code>、<code>a</code>）则水平排列，从左到右紧密排布，直到一行放不下才换行。这种 “自上而下、从左到右” 的自然布局方式，就是文档流。</p>
<p>而<code>position</code>属性的核心作用，就是打破或遵循这个默认规则，改变元素的定位方式。其中，<strong>是否脱离文档流</strong>是区分不同定位属性的关键：脱离文档流的元素会 “跳出” 排队队伍，不再占用原来的位置，其他元素会忽略它重新排列；不脱离的元素则仍在队伍中，只是在原位置上进行微调。</p>
<h2 data-id="heading-1">二、逐个击破：5 种 position 属性的底层逻辑</h2>
<h3 data-id="heading-2">1. static：默认定位（无定位）</h3>
<p><code>static</code>是<code>position</code>的默认值，所有元素在未设置定位时，都遵循<code>static</code>规则 —— 按照文档流正常排列，不受<code>top</code>、<code>left</code>、<code>right</code>、<code>bottom</code>属性影响。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>完全遵循文档流，不脱离</li>
<li>无法通过<code>top</code>/<code>left</code>等属性调整位置</li>
<li>可用于取消已设置的定位（如示例 5 中，5 秒后将<code>absolute</code>改为<code>static</code>）</li>
</ul>
<p><strong>实战示例</strong>（示例 5 初始状态）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 初始定位 */</span>
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
<span class="hljs-comment">/* 5秒后取消定位，恢复static默认状态 */</span>
setTimeout(() =&gt; {
  oParent<span class="hljs-selector-class">.style</span><span class="hljs-selector-class">.position</span> = 'static';
}, <span class="hljs-number">5000</span>);
</code></pre>
<p>当<code>position</code>改为<code>static</code>后，<code>left</code>和<code>top</code>失效，元素回到文档流的原始位置。</p>
<hr/>
<h3 data-id="heading-3">2. relative：相对定位（不脱离文档流）</h3>
<p><code>relative</code>是 “相对” 于自身在文档流中的原始位置进行定位，这是它最核心的特征。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>不脱离文档流，原始位置仍被占用（后面元素不会补位）</li>
<li>通过<code>top</code>/<code>left</code>/<code>right</code>/<code>bottom</code>调整位置，参考点是自身默认位置</li>
<li>常作为<code>absolute</code>的 “定位容器”（子绝父相）</li>
</ul>
<p><strong>实战示例</strong>（示例 1）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">background</span>: pink;
  <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 相对定位 */</span>
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: skyblue;
}
</code></pre>
<p>这里<code>.parent</code>会相对于自己的默认位置（左上角）向右移动 100px、向下移动 100px，而它原来的位置仍被占用，<code>.box</code>元素会按照文档流在它后面正常排列，不会向前补位。</p>
<hr/>
<h3 data-id="heading-4">3. absolute：绝对定位（完全脱离文档流）</h3>
<p><code>absolute</code>是最常用的定位属性之一，元素会完全脱离文档流，相当于 “跳出” 排队队伍，不再占用任何空间。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>完全脱离文档流，原始位置被释放（后面元素会补位）</li>
<li>定位参考点是 “最近的已定位祖先元素”（<code>position</code>不为<code>static</code>）</li>
<li>若没有已定位祖先，则参考<code>body</code>（浏览器视口）</li>
<li>必须配合<code>top</code>/<code>left</code>等属性使用，否则定位无效</li>
</ul>
<p><strong>实战示例</strong>（示例 2）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">550px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">background</span>: pink;
  <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 定位容器 */</span>
}
<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: skyblue;
  <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 绝对定位 */</span>
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于.parent右侧偏移100px */</span>
}
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background</span>: green;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>); <span class="hljs-comment">/* 水平垂直居中 */</span>
}
</code></pre>
<p>示例中<code>.parent</code>设置<code>relative</code>作为定位容器，<code>.child</code>和<code>.box</code>的<code>absolute</code>定位都以<code>.parent</code>为参考。其中<code>.box</code>通过<code>left:50%</code>+<code>top:50%</code>+<code>transform:translate(-50%,-50%)</code>实现了相对于父容器的完美居中，这是<code>absolute</code>的经典用法。</p>
<hr/>
<h3 data-id="heading-5">4. fixed：固定定位（完全脱离文档流）</h3>
<p><code>fixed</code>的核心是 “固定于浏览器视口”，无论页面如何滚动，元素位置始终不变。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>完全脱离文档流，不占用原始位置</li>
<li>定位参考点是浏览器视口（可视区域）</li>
<li>不受祖先元素定位影响（即使父元素有<code>relative</code>，仍参考视口）</li>
<li>常用来实现固定导航、悬浮按钮、弹窗等</li>
</ul>
<p><strong>实战示例</strong>（示例 3）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: blue;
  <span class="hljs-attribute">position</span>: fixed; <span class="hljs-comment">/* 固定定位 */</span>
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 相对于视口右下角偏移100px */</span>
}
<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; <span class="hljs-comment">/* 让页面可滚动 */</span>
}
</code></pre>
<p>即使页面滚动，<code>.child</code>始终固定在视口右下角 100px 的位置。需要注意的是，<code>fixed</code>元素会跟随浏览器窗口移动，不会被父容器的<code>overflow</code>属性影响（除非父容器有<code>transform</code>属性，这是常见坑点）。</p>
<hr/>
<h3 data-id="heading-6">5. sticky：粘性定位（动态切换定位方式）</h3>
<p><code>sticky</code>是 “相对定位” 和 “固定定位” 的结合体，堪称布局神器，常用于导航栏滚动吸顶效果。</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>未达到滚动阈值时，表现为<code>relative</code>（遵循文档流）</li>
<li>达到滚动阈值时，自动切换为<code>fixed</code>（固定于视口）</li>
<li>不脱离文档流，原始位置仍被占用（切换为<code>fixed</code>后也不会让后面元素补位）</li>
<li>必须配合<code>top</code>/<code>left</code>等属性设置阈值，否则无效</li>
</ul>
<p><strong>实战示例</strong>（示例 4）：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background</span>: green;
  <span class="hljs-attribute">position</span>: sticky; <span class="hljs-comment">/* 粘性定位 */</span>
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 滚动阈值：距离视口顶部100px时固定 */</span>
}
<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>; <span class="hljs-comment">/* 可滚动页面 */</span>
}
</code></pre>
<p>当页面滚动时，<code>.box</code>在未到达视口顶部 100px 前，会跟随文档流正常滚动；一旦距离顶部小于 100px，就会固定在顶部 100px 的位置，直到滚动到父元素底部，又会恢复<code>relative</code>状态。</p>
<h2 data-id="heading-7">三、关键区别：5 种定位属性核心对比</h2>









































<table><thead><tr><th>定位属性</th><th>是否脱离文档流</th><th>定位参考点</th><th>核心用途</th></tr></thead><tbody><tr><td>static</td><td>否（默认）</td><td>无</td><td>取消定位、默认布局</td></tr><tr><td>relative</td><td>否</td><td>自身默认位置</td><td>微调位置、作为 absolute 容器</td></tr><tr><td>absolute</td><td>是</td><td>最近已定位祖先 /body</td><td>精准定位、弹窗、居中</td></tr><tr><td>fixed</td><td>是</td><td>浏览器视口</td><td>固定导航、悬浮组件</td></tr><tr><td>sticky</td><td>否（动态切换）</td><td>文档流 / 视口</td><td>滚动吸顶、粘性导航</td></tr></tbody></table>
<h2 data-id="heading-8">四、实战避坑：这些问题一定要注意</h2>
<ol>
<li><strong><code>absolute</code>无法定位？</strong> 检查父元素是否有<code>position: relative/absolute/fixed/sticky</code>，若没有则参考<code>body</code>，可能因父元素未设置高度导致定位异常。</li>
<li><strong><code>sticky</code>不生效？</strong> 确保满足三个条件：设置了<code>top</code>/<code>left</code>等阈值、父元素没有<code>overflow: hidden</code>、元素在文档流中（没有脱离文档流的祖先）。</li>
<li><strong><code>fixed</code>被父元素 “困住”？</strong> 若父元素有<code>transform</code>属性（如<code>transform: translate(0)</code>），<code>fixed</code>会以该父元素为参考，而非视口，需避免这种嵌套。</li>
<li><strong>脱离文档流的影响？</strong> <code>absolute</code>和<code>fixed</code>会脱离文档流，可能导致页面布局塌陷，需提前预留空间或用其他元素补位。</li>
</ol>
<h2 data-id="heading-9">五、总结：定位属性的选择逻辑</h2>
<ol>
<li>只需微调元素位置，不影响其他布局 → <code>relative</code></li>
<li>需精准定位，且不占原始空间 → <code>absolute</code>（配合<code>relative</code>容器）</li>
<li>需固定在视口，不受滚动影响 → <code>fixed</code></li>
<li>需滚动吸顶 / 吸底效果 → <code>sticky</code></li>
<li>恢复默认布局或取消定位 → <code>static</code></li>
</ol>
<p><code>position</code>属性看似简单，实则是 CSS 布局的底层逻辑体现。掌握它们的核心区别和使用场景，能让你在实现复杂布局时游刃有余。建议结合本文的示例代码，亲自在浏览器中调试，观察元素位置变化，加深对文档流和定位规则的理解。</p>
<h2 data-id="heading-10">最后</h2>
<p>如果你在使用<code>position</code>时遇到过特殊坑点，或者有更巧妙的用法，欢迎在评论区分享～ 也可以点赞收藏，下次遇到定位问题直接翻这篇指南！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MoonBit 再获美国知名科技媒体关注：The New Stack 推出 MoonBit Wasm 组件教程]]></title>    <link>https://juejin.cn/post/7572002432450920457</link>    <guid>https://juejin.cn/post/7572002432450920457</guid>    <pubDate>2025-11-13T10:29:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432450920457" data-draft-id="7572016447804719130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MoonBit 再获美国知名科技媒体关注：The New Stack 推出 MoonBit Wasm 组件教程"/> <meta itemprop="keywords" content="WebAssembly,Web Components,编程语言"/> <meta itemprop="datePublished" content="2025-11-13T10:29:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoonBit"/> <meta itemprop="url" content="https://juejin.cn/user/3609050528885565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MoonBit 再获美国知名科技媒体关注：The New Stack 推出 MoonBit Wasm 组件教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609050528885565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoonBit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:29:03.000Z" title="Thu Nov 13 2025 10:29:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">三次登上美国知名技术媒体！MoonBit 又因 WebAssembly 组件模型引发关注！</h2>
<blockquote>
<p>在海外技术社区的持续关注下，MoonBit 又一次登上了美国知名开发者媒体 The New Stack。这是 TNS 第三次报道 MoonBit。本篇文章以 “如何用 MoonBit 构建 WebAssembly Components” 为主题，从工具链、接口定义到 Wasm 文件生成，对 MoonBit 的技术能力做了详细的解读:<a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fhow-to-build-webassembly-components-with-the-moonbit-language%2F" target="_blank" title="https://thenewstack.io/how-to-build-webassembly-components-with-the-moonbit-language/" ref="nofollow noopener noreferrer">thenewstack.io/how-to-buil…</a>
）</p>
</blockquote>
<p>以下为原文翻译</p>
<p>MoonBit 是一门现代化语言，也是一套工作流，旨在构建高效的 WebAssembly 项目；它同样可以编译到 JavaScript。我上一次关注 MoonBit 是在 2024 年 6 月，因此这次我想看看它在 Wasm 使用方面是否有所进展。（顺带一提：如果您仍然对WebAssembly的意义感到陌生，你不是一个人。）</p>
<p>现在，MoonBit 也可以在 WebAssembly 的组件模型运行（Web Component Model），我们稍后将对此进行探讨。我们将实现这一点，然后检查它是否有效。本文中只打算实现一个简单的加法方法。</p>
<h3 data-id="heading-1">MoonBit 语言快速回顾</h3>
<p>在开始之前，先快速回顾一下 MoonBit 语言。</p>
<p>当然，从 Hello World 开始：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_hello</span>() <span class="hljs-punctuation">-&gt;</span> Unit { 
 <span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"Hello, world!"</span>) 
}
</code></pre>
<p>唯一稍微让人意外的是 <code>Unit</code> ，但它其实只是 MoonBit 中等价于 <code>void</code> 的一类对象。</p>
<p>这是另一个例子：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">add3</span>(x : Int, y : Int, z : Int) <span class="hljs-punctuation">-&gt;</span> Int { 
 x + y + z 
}
</code></pre>
<p>这是一个“top level”；需要注意的是，MoonBit 必须显式声明类型。如果你想更深入了解这门语言，可以查看官方教程。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fen%2Flatest%2Flanguage%2Findex.html" target="_blank" title="https://docs.moonbitlang.com/en/latest/language/index.html" ref="nofollow noopener noreferrer">官方教程</a></p>
<hr/>
<h3 data-id="heading-2">WebAssembly 组件模型集成</h3>
<p>我们关注的是 WebAssembly 的集成。MoonBit 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcomponent-model.bytecodealliance.org%2F" target="_blank" title="https://component-model.bytecodealliance.org/" ref="nofollow noopener noreferrer">WebAssembly 组件模型</a> 协同工作，这减轻了实现基本功能时的痛苦。组件模型通常是语言项目的下一阶段，因为它们固定了接口、契约以及数据类型。</p>
<p>逻辑上，一个组件是可以包含核心模块和/或其他子组件的结构。组件使用 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">WebAssembly Interface Types（WIT）</a>来描述其中模块和子组件的接口。如果这听起来过于学术化，不用担心，它在实际生产工具链中完全能正常工作。本文的内容主要基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fzh-cn%2Flatest%2Ftoolchain%2Fwasm%2Fcomponent-model-tutorial.html" target="_blank" title="https://docs.moonbitlang.com/zh-cn/latest/toolchain/wasm/component-model-tutorial.html" ref="nofollow noopener noreferrer">MoonBit 的 WebAssembly 组件文档</a>。</p>
<h3 data-id="heading-3">安装构建组件需要的工具链</h3>
<p>在继续之前，我们需要 <code>wit-bindgen</code> CLI 工具，它用于生成兼容 WIT 的绑定文件；这个工具是基于 Rust 的，所以你需要安装 Cargo。只要安装 Rust 就能获得 Cargo：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwit-bindgen" target="_blank" title="https://github.com/bytecodealliance/wit-bindgen" ref="nofollow noopener noreferrer">Wit-bindgen</a></p>
<pre><code class="hljs language-Bash" lang="Bash">curl https://sh.rustup.rs -sSf | sh
</code></pre>
<p>（如果你使用 Homebrew 安装过 Rust，你可能需要确认是否让 rustup 来管理对 Rust 的更新。我之前没更新好导致了更多的问题，所以我建议卸载 brew 安装的版本。）</p>
<p>在此之前，你可以先输入 <code>cargo</code> 以确认你是否已经正确安装：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16906bdec1594c74aa1cbd7c56a49e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=fygtnRa2De5uOjAKvKcEQAypE%2B8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>虽然版本有点旧，但还能用。现在安装绑定工具：</p>
<pre><code class="hljs language-Bash" lang="Bash">cargo install wit-bindgen-cli
</code></pre>
<p>你可能会收到提示，要求你把 cargo 的 bin 目录加入 PATH。我是在 MacBook 上安装，因此直接把它加入了 PATH。</p>
<p>然后安装用于组件的 Wasm 工具：</p>
<pre><code class="hljs language-Bash" lang="Bash">cargo install wasm-tools
</code></pre>
<p>接着安装 MoonBit 本体：</p>
<pre><code class="hljs language-Bash" lang="Bash">curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
</code></pre>
<p>安装完成后，你需要运行一个新的 shell 或执行：</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
<p>现在你就可以运行 Rust 开发的项目组织工具 <code>moon</code> 了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80aa69d68b8941afa6ad10791e10291d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=CWennkspv8%2FvlPUUog1Le%2Beia5U%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这下我们就把 Moon 的整套工具都准备齐了。</p>
<h3 data-id="heading-4">使用 WIT 文件定义程序</h3>
<p>在编写 MoonBit 代码之前，我们需要先创建一个 WIT 文件，用来声明我们将在 WebAssembly 组件世界中使用的接口。</p>
<p>创建 <code>wit/world.wit</code> 文件：</p>
<pre><code class="hljs language-rust" lang="rust">package docs:adder@<span class="hljs-number">0.1</span>.<span class="hljs-number">0</span>; 

interface add { 
  add: <span class="hljs-title function_ invoke__">func</span>(x: <span class="hljs-type">u32</span>, y: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span>; 
} 
world adder { 
  export add; 
}
</code></pre>
<p>这段 WIT 声明了一个版本为 <code>0.1.0</code> 的 <code>docs:adder</code> 包，并定义了名为 <code>add</code> 的接口，其中包含一个接收和返回 <code>u32</code> 的函数（在 MoonBit 中对应 UInt）。WIT 中的 <code>world</code> 是一个容器，用来放置所有组件需要的部分，这里只有一个 add 接口。</p>
<p>UInt :<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fen%2Flatest%2Flanguage%2Ffundamentals.html%23number" target="_blank" title="https://docs.moonbitlang.com/en/latest/language/fundamentals.html#number" ref="nofollow noopener noreferrer">docs.moonbitlang.com/en/latest/l…</a></p>
<p>现在我们为 WIT 生成 MoonBit 结构：</p>
<pre><code class="hljs language-rust" lang="rust">wit-bindgen moonbit wit/world.wit --out-dir . \
    --derive-eq \
    --derive-show \
    --derive-error
</code></pre>
<p>生成后你应该会看到生成的 <code>.mbt</code> 文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d535d3166aaa4e6cb44627dfb54d21ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=3jVjbK2273B5yqqpFVBW4x7cH0c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>您可能已经猜到 <code>.mbt</code> 后缀是 MoonBit 文件。但当然我们还没有真正写 MoonBit 代码。如果现在尝试构建 Wasm 目标，会收到大量警告。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/802dfdd571674cc3a3bda3adcc2df7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=lIWJ8NDGLqVCfXYDEi5r%2FuLBb64%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>查看生成的 stub，你会发现其中没有实际实现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d8d553307049ef9fa217e8a0cdf89a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=Amp4j%2BSZ7VCIECeBZu8O1MEmr14%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>简单来说，stub 里并没有真正的实现，只是接口定义。即使使用我们上面最小的 MoonBit 教程，我们仍然可以轻松完成它：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b26a340ab8f48ab963551c4eb148c88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=1ZWSVW6rc7slXK%2B7CxQCM8%2FGNPI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>主配置文件 <code>gen/moon.pkg.json</code> 会包含相关路径信息。</p>
<h3 data-id="heading-5">构建 WebAssembly 模块与组件</h3>
<p>现在我们来构建主 WebAssembly 模块：</p>
<pre><code class="hljs language-rust" lang="rust">moon build --target wasm
</code></pre>
<p>构建后会生成新的 <code>target</code> 目录，其中包含 Wasm 文件。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e31007b9db949b29b43061bf301abb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=01JYpFbHLi%2FpBUtWsHi09xypNNU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>检查一下 <code>gen.wasm</code> 是否有效：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cdccb01f3b44fbb92cb3965d6b574bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=1uqnusZTTekEiLfh%2FQw2UWkuCD4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>很好，它是合法的 WebAssembly。现在我们需要在组件模型中正确地封装它：</p>
<pre><code class="hljs language-rust" lang="rust">wasm-tools component embed wit target/wasm/release/build/gen/gen.wasm \
  --encoding utf16 \
  --output adder.wasm
</code></pre>
<p>然后执行：</p>
<pre><code class="hljs language-bash" lang="bash">wasm-tools component new adder.wasm --output adder.component.wasm
</code></pre>
<p>此时生成的文件已不同于普通的 Wasm 模块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf9cb02f54544fb295ad899ee4e5b6d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=CX9Tb6pb5xIWJhBKcpOBAidYWVM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以使用 Wasmtime 来验证是否成功：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa083bc02ebe4eb3b9bc6c745bd959fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=0hyLJI8ONFwa2qsOVOncHgNRccw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>如果 Wasmtime 报错，可以从这里安装最新版本：</p>
<pre><code class="hljs language-Bash" lang="Bash">curl https://wasmtime.dev/install.sh -sSf | bash
</code></pre>
<p>你也可以使用更复杂的宿主程序来进一步验证 <code>.wasm</code> 是否正常运行。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moonbitlang.com%2Fzh-cn%2Flatest%2Ftoolchain%2Fwasm%2Fcomponent-model-tutorial.html%23using-the-example-host" target="_blank" title="https://docs.moonbitlang.com/zh-cn/latest/toolchain/wasm/component-model-tutorial.html#using-the-example-host" ref="nofollow noopener noreferrer">docs.moonbitlang.com/zh-cn/lates…</a></p>
<h3 data-id="heading-6">总结</h3>
<p>我本来是想看看 MoonBit 的进展，结果却发现了 WebAssembly 组件模型。这就是开发者的旅程——总有一座更高的山。</p>
<p>在未来的某个阶段，MoonBit 需要在对组件模型的直接支持方面投入更多工作；否则，这种偏学术化的复杂度将使 Wasm 始终难以获得更广泛的采用（或使其更趋近于 Rust 的生态）。然而，这种模式与其他基于 stub 的模型颇为相似——尽管以 WSDL 作为类比并非最恰当——但在成熟的工具链中，它们依然能够良好运作，即便是由LLM驱动的工具链亦是如此。</p>
<h2 data-id="heading-7">MoonBit 被收录入《Top Programming Languages of Late 2025》！</h2>
<p>在 MysticMatrix 发布的
《Top Programming Languages of Late 2025》
一文中，MoonBit 与 Mojo、Rust 一同被列为 2025 年度值得关注的新兴语言之一。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d580fb24b6441cb9683da3a366edf7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634543&amp;x-signature=aRqW4UeIwB59TCw2lbCtVj%2F45Ac%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>非常感谢社区的支持，我们会继续提升编译器与工具链，为大家带来更好的开发体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“多余的”回车：从IDE的自动换行窥见软件工程的规范与协作]]></title>    <link>https://juejin.cn/post/7571815997068083240</link>    <guid>https://juejin.cn/post/7571815997068083240</guid>    <pubDate>2025-11-13T10:31:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068083240" data-draft-id="7572020278386688034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“多余的”回车：从IDE的自动换行窥见软件工程的规范与协作"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T10:31:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “多余的”回车：从IDE的自动换行窥见软件工程的规范与协作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:31:24.000Z" title="Thu Nov 13 2025 10:31:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>个人名片
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38e29b9b3168402984eb27e55d2e954b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634684&amp;x-signature=57YenSbKlw8jgRJQSV55uKR7JoI%3D" alt="在这里插入图片描述" loading="lazy"/>
🎓作者简介：java领域优质创作者
🌐个人主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/weixin_44976692?type=blog" ref="nofollow noopener noreferrer">码农阿豪</a>
📞工作室：新空间代码工作室（提供各种软件服务)
💌个人邮箱：[<a href="https://link.juejin.cn?target=mailto%3A2435024119%40qq.com" target="_blank" title="mailto:2435024119@qq.com" ref="nofollow noopener noreferrer">2435024119@qq.com</a>]
📱个人微信：15279484656
🌐个人导航网站：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.forff.top" target="_blank" title="http://www.forff.top" ref="nofollow noopener noreferrer">www.forff.top</a>
💡座右铭：总有人要赢。为什么不能是我呢？</p>
</blockquote>
<ul>
<li>专栏导航：</li>
</ul>
<blockquote>
<p>码农阿豪系列专栏导航
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12053689.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12053689.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">面试专栏</a>：收集了java相关高频面试题，面试实战总结🍻🎉🖥️
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12561762.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12561762.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">Spring5系列专栏</a>：整理了Spring5重要知识点与实战演练，有案例可直接使用🚀🔧💻
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12580216.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12580216.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">Redis专栏</a>：Redis从零到一学习分享，经验总结，案例实战💐📝💡
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_44976692%2Fcategory_12533392.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/weixin_44976692/category_12533392.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">全栈系列专栏</a>：海纳百川有容乃大，可能你想要的东西里面都有🤸🌱🚀</p>
</blockquote>
<p>@<a href="https://link.juejin.cn?target=%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">TOC</a></p>
<h2 data-id="heading-0">“多余的”回车：从IDE的自动换行窥见软件工程的规范与协作</h2>
<h3 data-id="heading-1">引言：一个令人困惑的“Bug”</h3>
<p>作为一名开发者，你一定对集成开发环境无比熟悉。然而，某些时候，它们的一些“自作主张”的行为会让我们感到困惑。比如，下面这个场景你是否觉得眼熟：</p>
<ol>
<li>你在IntelliJ IDEA中编写代码，文件最后一行是<code>}</code>，光标紧跟在它后面。</li>
<li>你专注地写完了所有逻辑，没有在最后按回车键。</li>
<li>当你切换到浏览器查看文档，或是点开另一个聊天窗口之后...</li>
<li>...再切回IDEA，奇怪的事情发生了：光标竟然跑到了下一行！文件末尾莫名其妙地多了一个空行？</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6fbc62e951845be88756900f238ccb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634684&amp;x-signature=keWuzO9MxQxDD43ZYJUFpSLRc7Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>初遇此景，你可能会嘀咕：“我没按回车啊？难道是IDE出Bug了？” 或者怀疑自己不小心碰到了什么键。</p>
<p>请放心，这不是Bug。这背后，隐藏着一个贯穿了计算机发展史、涉及操作系统差异、版本控制哲学以及软件工程最佳实践的“古老”故事。本文将深入剖析这一现象，揭示其原理，并论证为何这个看似微不足道的细节，在现代软件开发中至关重要。</p>
<h3 data-id="heading-2">第一章：追根溯源——文本文件的“行”与“尾”</h3>
<p>要理解这个现象，我们首先需要回到计算机的早期时代，理解一个最基本的概念：文本文件中的“一行”是如何定义的？</p>
<h4 data-id="heading-3">1.1 换行符的“南北战争”</h4>
<p>在计算机世界里，纯文本文件由字符序列组成。但有一个问题：如何表示一行的结束？不幸的是，历史上出现了两大阵营，给出了不同的答案：</p>
<ul>
<li>CR+LF (Carriage Return + Line Feed, <code>\r\n</code>): 源于早期的电传打字机。<code>CR</code> 将打印头移回行首，<code>LF</code> 将纸张向上移动一行。微软的DOS和后来的Windows系统继承了这一传统，将其作为行结束标志。</li>
<li>LF (Line Feed, <code>\n</code>): Unix和类Unix系统（包括Linux, macOS）则采用了更简洁的<code>LF</code>作为行结束符。</li>
</ul>
<p>这就导致了在Windows上创建的文本文件，在Unix系统下打开时，可能会看到每行结尾多了个<code>^M</code>字符（即CR），反之亦然。</p>
<h4 data-id="heading-4">1.2 POSIX标准与“最后一行”的哲学</h4>
<p>POSIX标准为Unix-like系统定义了一系列规范，其中明确要求：</p>
<blockquote>
<p>[3.206 Line] A sequence of zero or more non-  characters plus a terminating  character.</p>
</blockquote>
<p>翻译过来就是：一行是由零个或多个非换行字符，加上一个终止的换行字符所构成的序列。</p>
<p>这意味着什么？它意味着在一个符合标准的文本文件中，每一行都必须以换行符结束，包括最后一行。</p>
<p>这听起来可能有点反直觉。一个文件末尾的换行符，并不代表一个“空行”。一个“空行”实际上是一个仅包含换行符的行。而文件末尾的换行符，其真正含义是：“这是本文件的最后一个行结束标志”。它标志着一个完整、终结的文件结构。</p>
<p>举例说明：</p>
<p>假设文件内容为 <code>Hello</code>，没有尾随换行符。
在遵循标准的工具看来，这个文件是“不完整”的——它的一行没有结束。</p>
<p>而内容为 <code>Hello\n</code> 的文件，才是格式正确的。</p>
<h3 data-id="heading-5">第二章：现代IDE的“贴心”守护者</h3>
<p>理解了历史背景和标准，我们再回到现代的IntelliJ IDEA（以及其他主流IDE/编辑器，如VS Code, Sublime Text等）。</p>
<h4 data-id="heading-6">2.1 那个关键的配置项</h4>
<p>IDEA中有一个默认开启的设置，它就是造成文章开头那个“奇怪现象”的“元凶”。</p>
<ul>
<li>路径： <code>File -&gt; Settings -&gt; Editor -&gt; General</code> (Windows/Linux) 或 <code>IntelliJ IDEA -&gt; Preferences -&gt; Editor -&gt; General</code> (macOS)</li>
<li>选项： <code>Ensure every saved file ends with a line feed</code> (或类似表述，如 <code>On Save: Ensure line feed at file end</code>)
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb60c07aa59490c885ada97c20d7574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634684&amp;x-signature=dLpO9jqkGAHU1JZoHNtdXWaxmv0%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<p>当这个选项被勾选时，IDEA会在你保存文件或触发自动保存（例如失去焦点、切换标签页）时，自动检查文件末尾是否有一个换行符。如果没有，它会静默地为你添加一个。</p>
<p>所以，整个流程是这样的：</p>
<ol>
<li>你编码时：内存中的文件内容没有尾随换行符。</li>
<li>你切换窗口：IDEA触发自动保存机制。</li>
<li>保存前检查：IDEA发现文件末尾缺少换行符。</li>
<li>自动修正：IDEA追加一个<code>LF</code>（<code>\n</code>）字符到文件末尾。</li>
<li>你切回IDEA：因为文件末尾现在有了一个换行符，光标自然就位于了这个“新的一行”的开头。你看到的，就是光标“自动”换行了。</li>
</ol>
<h4 data-id="heading-7">2.2 代码示例：眼见为实</h4>
<p>我们可以通过命令行工具来直观地验证这一行为。</p>
<p>首先，创建一个没有尾随换行符的文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 echo -n 来抑制默认添加的换行符</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"public class Test {}"</span> &gt; no_newline.java
</code></pre>
<p>使用 <code>hexdump</code> 或 <code>od</code> 查看其二进制内容：</p>
<pre><code class="hljs language-bash" lang="bash">hexdump -C no_newline.java
</code></pre>
<p>输出会类似于：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-number">00000000</span>  <span class="hljs-number">70</span> <span class="hljs-number">75</span> <span class="hljs-number">62</span> 6c <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">20</span> <span class="hljs-number">63</span>  6c <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">54</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span>  |<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tes</span>|
<span class="hljs-number">00000010</span>  <span class="hljs-number">74</span> <span class="hljs-number">20</span> 7b <span class="hljs-number">7d</span>                                       |t {}.|
<span class="hljs-number">00000014</span>
</code></pre>
<p>注意，最后一位是 <code>7d</code> (<code>}</code>)，后面没有 <code>0a</code> （<code>\n</code>）。</p>
<p>现在，用IDEA打开这个文件，什么都不做，直接切换窗口再切回来，然后保存。或者，在命令行下，我们用 <code>echo</code> 正常地创建一个文件来模拟：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"public class Test {}"</span> &gt; with_newline.java
hexdump -C with_newline.java
</code></pre>
<p>输出会类似于：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-number">00000000</span>  <span class="hljs-number">70</span> <span class="hljs-number">75</span> <span class="hljs-number">62</span> 6c <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">20</span> <span class="hljs-number">63</span>  6c <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">54</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span>  |<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tes</span>|
<span class="hljs-number">00000010</span>  <span class="hljs-number">74</span> <span class="hljs-number">20</span> 7b <span class="hljs-number">7d</span> 0a                                    |t {}.|
<span class="hljs-number">00000015</span>
</code></pre>
<p>看，最后一位是 <code>0a</code> (<code>\n</code>)！这就是IDEA自动为我们添加的。</p>
<h3 data-id="heading-8">第三章：为何要“多此一举”？——尾随换行符的现代意义</h3>
<p>如果仅仅是遵循一个几十年前的标准，理由或许还不够充分。这个规范在今天强大的生命力，主要源于它对现代开发流程，特别是协作和工具链的深远影响。</p>
<h4 data-id="heading-9">3.1 版本控制的“宁静”</h4>
<p>这是最重要、最实际的原因。以Git为例。</p>
<p>假设开发者A在开启尾随换行符规范的IDE上工作，他创建了一个文件。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 文件: Foo.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"Hello"</span>); <span class="hljs-comment">// 末尾有不可见的 \n</span>
    }
} <span class="hljs-comment">// 末尾也有不可见的 \n</span>
</code></pre>
<p>而开发者B使用一个不添加尾随换行符的编辑器，他修改了最后一行，并提交。</p>
<pre><code class="hljs language-java" lang="java">} <span class="hljs-comment">// 末尾没有不可见的 \n</span>
</code></pre>
<p>当B尝试推送他的代码时，Git会怎么做？Git会认为文件最后一行被修改了！<code>diff</code> 输出会是这样：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-}</span>
\ No newline at end of file
<span class="hljs-addition">+}</span>
</code></pre>
<p>看到了吗？Git 专门有一行提示 <code>\ No newline at end of file</code>。这对于文件的实际内容来说，是一个无关紧要的更改，但它却污染了提交历史。在代码审查时，你需要去判断这个改动究竟是真的逻辑修改，还是仅仅是格式变动。</p>
<p>如果整个团队都统一在文件末尾添加换行符，这种“噪音”提交就可以完全避免。</p>
<h4 data-id="heading-10">3.2 命令行工具的“预期”</h4>
<p>Unix世界的大量命令行工具都是基于“行”来处理文本的，它们默认每一行都以换行符结束。</p>
<ul>
<li>
<p><code>cat</code> 命令： 将两个文件连接时，如果第一个文件没有尾随换行符，第二个文件的第一行会紧挨着它。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># file1.txt 内容为 "Hello" (无\n)， file2.txt 内容为 "World\n"</span>
<span class="hljs-built_in">cat</span> file1.txt file2.txt
<span class="hljs-comment"># 输出： HelloWorld</span>
<span class="hljs-comment"># 而非预期的：</span>
<span class="hljs-comment"># Hello</span>
<span class="hljs-comment"># World</span>
</code></pre>
</li>
<li>
<p><code>wc -l</code> 命令： 用于统计行数。对于没有尾随换行符的文件，它统计的结果可能会少一行，因为最后一行不被认为是一行“完整的行”。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Hello"</span> &gt; file.txt
<span class="hljs-built_in">wc</span> -l file.txt
<span class="hljs-comment"># 输出 0</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Hello"</span> &gt; file.txt
<span class="hljs-built_in">wc</span> -l file.txt
<span class="hljs-comment"># 输出 1</span>
</code></pre>
</li>
<li>
<p>脚本和解析器： 某些Shell脚本或数据解析器在读取流时，如果最后一行没有换行符，可能会报错或无法正确处理最后一条数据。</p>
</li>
</ul>
<p>统一尾随换行符，确保了你的代码和文本文件能够在整个Unix工具链中流畅运行。</p>
<h4 data-id="heading-11">3.3 代码规范与可读性</h4>
<p>从视觉上看，让光标停留在文件内容的最后，而不是一个新行，对于某些开发者来说可能显得“未完成”。尾随换行符使得在终端下用 <code>cat</code> 或 <code>tail</code> 查看文件时，提示符 <code>$</code> 能出现在一个新行上，而不是紧跟在文件内容后面，这提升了可读性。</p>
<p>更重要的是，它强制了一种一致性。软件工程的一大挑战就是管理复杂性，而统一的代码风格（包括这种看不见的格式）是降低复杂性的有效手段。</p>
<h3 data-id="heading-12">第四章：跨越编辑器的共识</h3>
<p>IDEA并非个例。事实上，这已经成为现代编辑器的共识：</p>
<ul>
<li>Visual Studio Code: 状态栏右下角会显示 <code>LF</code> 或 <code>CRLF</code>，点击它可以更改。同时，它也有 <code>files.insertFinalNewline</code> 设置项，效果相同。</li>
<li>Sublime Text: 可通过 <code>"ensure_newline_at_eof_on_save": true</code> 配置。</li>
<li>Vim: 可以通过 <code>:set eol</code> 和 <code>:set fixeol</code> 配置。</li>
<li>Git: 甚至本身也参与了管理，通过 <code>core.autocrlf</code> 配置项，可以在提交和检出时自动转换换行符，其中也包括了对尾随换行符的处理。</li>
</ul>
<p>这些工具的共同努力，正在逐步消除因平台和编辑器差异带来的格式问题。</p>
<h3 data-id="heading-13">结论：拥抱规范，专注创新</h3>
<p>文章开头那个看似奇怪的“光标跳动”，不再是IDE的一个无厘头行为，而是其作为一款专业工具，在背后默默践行软件工程最佳实践的体现。它是一位严格的代码规范守护者，通过自动化的方式，帮助我们：</p>
<ol>
<li>遵循历史标准，保证文件的正确性。</li>
<li>消除版本控制噪音，让提交历史更清晰，聚焦于真正的代码逻辑变更。</li>
<li>确保与强大命令行工具链的兼容性，避免脚本和工具运行时出现意外错误。</li>
<li>促进团队协作的统一性，减少因环境差异导致的无效沟通和调试。</li>
</ol>
<p>所以，下次当你看到光标自动跳到新的一行时，你可以会心一笑。这不是一个需要被修复的Bug，而是一个值得赞赏的Feature。我们的建议是：保持你的IDE默认设置，接受并理解这份“贴心”。</p>
<p>在软件开发中，正是这些对细节的严谨对待，才构建起了庞大而稳定的数字世界的基础。让我们将精力从纠结这些格式问题上解放出来，去专注于创造更有价值的创新和逻辑吧。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[李飞飞「世界模型」正式开放，人人可用！ Pro 版首月仅 7 元]]></title>    <link>https://juejin.cn/post/7572012699627880475</link>    <guid>https://juejin.cn/post/7572012699627880475</guid>    <pubDate>2025-11-13T10:28:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572012699627880475" data-draft-id="7572130072262901806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="李飞飞「世界模型」正式开放，人人可用！ Pro 版首月仅 7 元"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-13T10:28:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            李飞飞「世界模型」正式开放，人人可用！ Pro 版首月仅 7 元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:28:50.000Z" title="Thu Nov 13 2025 10:28:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19cd4beb6f464b9289a130cbf1b926d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=k2N7Y92R%2FVjMvrDvqAcE642Gzxk%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】只用一张图，一句话，就能创造出随便乱逛的 3D 世界——李飞飞这次不是在讲故事，而是真的给你「造梦神器」。今天起，全球上线，人人可用。」</strong></h5>
<p>李飞飞的「创世神器」今天终于正式上线了！人人可用。</p>
<p>这个由 WorldLabs 推出，名为 Marble 的网站，用世界模型可以生成瑰丽梦幻的「想象世界」～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2755b929348c4d0cb1287f7fb3d27d5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=X1NXnPN9d5Z13%2BhDjYNKmMGuDV4%3D" alt="" loading="lazy"/></p>
<p>体验网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarble.worldlabs.ai%2F" target="_blank" title="https://marble.worldlabs.ai/" ref="nofollow noopener noreferrer">marble.worldlabs.ai/</a></p>
<p>这波属实是李飞飞自己联动自己了，前两天她的一篇万字长文火爆硅谷，定义 AI 的下一个十年是「空间智能」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06f36afe44324cd69d0e8b0143097077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=q27zQ0UAVUpK8ST419UCrJY4WFs%3D" alt="" loading="lazy"/></p>
<p>文章中，她为真正具备空间智能的「世界模型」所需达成的目标勾勒了一个框架。</p>
<p>而今天这个「世界」正式面向全世界发布。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a44650cdd9042b1bb8358e77e977354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=Rlo9tRn1VY2qNJ3jOh0h%2BKJIUkk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c5fab7286b54d2ebfd64aaa134c9f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=2nkeviuepdmnDdZllYjVxrccnkQ%3D" alt="" loading="lazy"/></p>
<p>看一下官方视频的效果。</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>World Labs 最新官方宣传视频</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e625a9794c2464887304c97ca8cfda3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=DxIIDryHwqNmXLgFzu6qLNUmPRU%3D" alt="" loading="lazy"/></p>
<p><strong>「Marble：世界模型」</strong></p>
<p>人类对世界的感知本质上是多模态的：我们调动所有感官来理解周遭环境。</p>
<p>通过整合视觉、听觉、触觉与语言，我们构建起对外部世界的心理模型；这些不同表征方式相互协作、彼此增强，使我们能够理解世界并在其中采取行动。</p>
<p>世界模型应当以类似方式运作。它们需要具备大规模多模态能力，能够将各种可用输入信号提升为完整的三维世界，并随着新信息的出现持续迭代更新对世界的认知。</p>
<p>Marble 是开创先河的新一代世界模型，正朝着这一愿景大步迈进。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3408fd1d58a947e0b36ebb0ed4b4dcca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=B0%2Blq7hcZGwe87mDuvI7VN%2FNliY%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f94b1002e07246ac855ffd3c0383fe2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=M%2FMPKks0bfUdNGDYCgo9XQAlGsU%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「文本与图像世界」</strong></p>
<p>首先，Marble 能够仅凭一张图片或简短文字提示创建完整的 3D 世界。这是最简单便捷的造物方式。</p>
<p>Marble 可生成涵盖多种场景类型与艺术风格的世界。</p>
<p>图像提示使得将 Marble 与其他 AI 工具结合变得轻而易举。可以使用喜爱的图像生成模型创建图像，随后将其导入 Marble，即可将其提升为完整的 3D 世界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3467d62d0c14e68b403699131af23ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=ZSLG9%2BeoSEhKs7a9INgdDnjrSIY%3D" alt="" loading="lazy"/></p>
<p>文本和图像提示直观且强大，但在创意控制方面存在局限：Marble 必须自行构建输入文本或图像提示中未包含的世界细节。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1bd9353cef949e49741c2136acdf17c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=SUcM2ISBiXpHZJxJA8XskPpgRco%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「多图像和视频到世界模型」</strong></p>
<p>实现更具创意控制的世界构建，一种简便方法是采用多图像提示技术。</p>
<p>Marble 能够接收针对世界不同部分的多样化提示图像，并将它们无缝融合成统一的 3D 世界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27286b252de44fd89bd6507ed1d731af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=ET7Hi6bsXQFmjiAFzYuo1UDUbQ4%3D" alt="" loading="lazy"/></p>
<p>多图像提示能以更高精度创造世界。</p>
<p>这带来了一种全新的世界生成工作流程。可以使用喜爱的图像生成工具分别迭代输入视角，而 Marble 会将其提升为完整的三维世界，同时为输入视角之间添加无缝过渡效果。</p>
<p>Marble 可以输入几张照片或一段从不同角度描绘现实世界位置的短视频，它会将这些素材组合起来，生成包含现实空间元素的 3D 世界。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be3d0df0d7234f8d92b844b295dc25f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=BGJnSQKXZLJo7oJvrjX1ALNPs%2FU%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「世界编辑」</strong></p>
<p>对许多用户而言，创作过程具有高度迭代性。生成世界往往只是创意旅程的起点。当看到生成的 3D 世界时，通常会激发更多修改或完善它的灵感。</p>
<p>Marble 内置了 AI 原生世界编辑工具。编辑可以细微而局部：移除物体、修饰区域；也可以更加彻底：替换</p>
<p>物体、改变视觉风格，或重构世界的大部分结构。这为世界创建过程带来了全新层次的精细控制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3cf3999961c4045bfc82bca3af936f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=JlYD3FyVXWEI6LjEaAVW%2FFkjJCM%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55b08542376b4f4cafb8dbc33303483d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=7LKCSk4G1%2FH8AEfZ6iSOt7dDXHo%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「Chisel：在三维世界中雕琢天地」</strong></p>
<p>Chisel 和世界编辑还不太一样，有点像一根魔法棒。</p>
<p>Marble 的多模态输入与编辑功能赋予对生成世界的强大掌控力。</p>
<p>但有时，要将脑海中的构想精确呈现，仍需对场景布局或物体的精确尺寸位置进行更精细的调控。</p>
<p>针对这些场景，推出 Chisel——一款原生 AI 工具，可直接在三维空间中雕琢 Marble 世界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10680ecd20fc4a40a4483777a7666d6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=v5QYNfkR0kQcI1uqIvS1dwwerj4%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c300ba2c87754232b40f9cc696703656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=lpc0k0PtdC0%2FQjPocC3fmSaeKO4%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「将世界导出为 3D 或者视频格式」</strong></p>
<p>使用 Marble 创建世界后，有多种导出选项以便将其整合到下游项目中。</p>
<p>高斯溅射点是 Marble 世界最高保真度的呈现方式。它将 3D 场景表示为大量半透明粒子集合。</p>
<p>可以通过与 THREE.js 集成的开源跨平台渲染器 Spark，在浏览器中实时渲染高斯溅射点。</p>
<p>Marble 世界亦可导出为三角网格模型。</p>
<p>系统能够同时生成用于粗略物理模拟的低精度碰撞体网格，以及尽可能匹配高斯溅射点视觉精度的高质量网格。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee94e6cad3541dba11c8dff5a02a37f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=FUg3e9HJ%2BK9XSd3Aoz6LbT%2B%2BHIc%3D" alt="" loading="lazy"/></p>
<p>通过网格格式导出世界，可使其与众多行业标准工具实现无缝协作。</p>
<p>Marble 世界以完整 3D 形式存在，但有时视频才是分享世界的最佳方式。</p>
<p>可以使用 Marble 将生成的世界渲染成视频，通过像素级精准的相机控制，让每个镜头都如您想象般完美构图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f0366c039b4c19a71929e26c686e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=oKsZowoBaBhAc7QCtKyHxLpDd5o%3D" alt="" loading="lazy"/></p>
<p>Marble 是一款先进的生成式世界模型。</p>
<p>但只是我们迈向空间智能征途中的一步。</p>
<p>未来，交互性将成为一个关键机遇。</p>
<p>未来的世界模型将让人类与智能体都能以全新方式与生成世界互动，从而在仿真、机器人技术及其他领域解锁更多应用场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d1dbbd333294512bbdeb93b92107597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=9LdBOBtMTBcsVo9a7WUsSOO%2Fsas%3D" alt="" loading="lazy"/></p>
<p><strong>「空间智能是 AI 的下一个前沿」</strong></p>
<p>李飞飞在她的万字长文中结尾写下的感慨是对这波 AI 浪潮、智能、人类和机器命运最好的总结：</p>
<p>过去十年见证了 AI 成为一种全球现象，以及技术、经济乃至地缘政治的转折点。</p>
<p>但作为一名研究者、教育者，如今又是一名创业者，最能激励我的，仍然是图灵 75 年前提出的那个问题背后的精神。</p>
<p>我依然怀有他那份好奇与惊叹。</p>
<p>正是这种感觉，每天都激励着我迎接空间智能的挑战。</p>
<p>历史上第一次，我们有望构建出与物理世界如此协调的机器，以至于在我们面临的最严峻挑战中，可以将它们视为真正的伙伴。</p>
<p>无论是加速我们对实验室中疾病的理解，彻底改变我们讲述故事的方式，还是在我们因疾病、受伤或年老而最脆弱的时刻给予支持，我们都正处在一项新技术的风口浪尖，这项技术将提升我们最珍视的生活的方方面面。</p>
<p>这是一个更深刻、更丰富、更强大的生活愿景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c93abff73d2241aebea754f0c5138ae8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=qwQo1zhUCs02xphe4%2BpZIoj2sDo%3D" alt="" loading="lazy"/></p>
<p>在大自然与远古动物身上释放出第一缕空间智能的近五亿年后，我们有幸成为可能很快就能赋予机器同样能力的这一代技术专家中的一员——并有幸利用这些能力为世界各地的人们谋福祉。</p>
<p>我们关于真正智能机器的梦想，没有空间智能是不完整的。</p>
<p>这项探索，就是指引我的北极星。</p>
<p>我邀请你与我同行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/531a911ce7284fc4a4bd4587440dd6e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=gdOmSAlhWgL4PR%2FlWaKSL02wK4c%3D" alt="" loading="lazy"/></p>
<p><strong>「One More Thing」</strong></p>
<p>Marble 定价方面，目前共有 3 个档位，最高一个月 95 美元，可以最多生成 75 个世界。</p>
<p>免费版本只能上传图片，可以生成 4 个世界。</p>
<p>现在 Pro 版本，首月只需 1 美元！标准版本依然还是业界最普遍的一个月 20 美元。</p>
<p>你认为这个价格合理吗？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f9cfbe255e541a3aaf159c000b509e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=eTrRvOXCHQf8stF%2BABiSI83YZ%2F0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e77ec5fa5dc40f98d167fec9ff725e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634530&amp;x-signature=0%2FYXAJPreqznE1ic5HFHTYNbubQ%3D" alt="" loading="lazy"/></p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.worldlabs.ai%2Fblog%2Fmarble-world-model" target="_blank" title="https://www.worldlabs.ai/blog/marble-world-model" ref="nofollow noopener noreferrer">www.worldlabs.ai/blog/marble…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT-5.1 凌晨突袭，奥特曼听劝！全网呼唤的人味回来了]]></title>    <link>https://juejin.cn/post/7572002432450936841</link>    <guid>https://juejin.cn/post/7572002432450936841</guid>    <pubDate>2025-11-13T10:30:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432450936841" data-draft-id="7572016447804735514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT-5.1 凌晨突袭，奥特曼听劝！全网呼唤的人味回来了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T10:30:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT-5.1 凌晨突袭，奥特曼听劝！全网呼唤的人味回来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:30:46.000Z" title="Thu Nov 13 2025 10:30:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d66f6be0b7440799afa97c8ba012f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=DFSUUi7yT%2FEI89ngWS1D2chHFGM%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】今天，OpenAI GPT-5.1「全家桶」突然登场，Instant 和 Thinking 王炸组合同步上线。这一次，模型情商智商双核升级，不仅更聪明，而且聊天更有人味了。」</strong></h5>
<p>没有直播，OpenAI 一早放大招，让所有人猝不及防。</p>
<p>就在刚刚，GPT-5.1 正式发布，GPT-5 系列重大升级版登场！</p>
<p>一共有三个版本，目前已经上线了前两个：</p>
<p>· GPT-5.1 Instant ：最常用的模型，语气更亲切、更智能，更善于遵循指令。</p>
<p>· GPT-5.1 Thinking ：先进的推理模型，更易于理解，处理简单任务速度更快，处理复杂任务更具持久力。</p>
<p>· GPT-5.1 Pro：即将上线</p>
<p>奥特曼激动表示，GPT-5.1 升级给力，尤其是指令遵循和自适应思考的改进。</p>
<p>当然，整体的智力和沟通风格，提升也很显著。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c82b2307b434181a457945e5a3a3f72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=XfBj4T8fJdnInfUjWeLTy7VU5V8%3D" alt="" loading="lazy"/></p>
<p>还记得 8 月初，GPT‑5 正式诞生，虽在全方位性能提升，但变得没有人味，更加冷淡。</p>
<p>一时间，全网喊话集体讨回 GPT-4o、o3 等模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f9fade43daa45f385d32a8e9726d064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=7EPazkdWnDCqzC%2B2DPSUeoyUrHA%3D" alt="" loading="lazy"/></p>
<p>许多人的真实反馈 OpenAI 听进去了——「一个优秀的 AI 不仅要聪明，还得会唠嗑才行」。</p>
<p>如今，两个月的迭代，OpenAI 把让所有人最想要的 GPT-5.1 带来了。</p>
<p>正如科学副总裁 Kevin Weil 所言，GPT-5.1 是 OpenAI 迄今为止推出的最完美的组合，<strong>「智商与情商双双在线」</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a9a578b0af14dc1a0c30b8596645445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=SMG0nf%2FOelUnO6BqNd4BwC35%2BeQ%3D" alt="" loading="lazy"/></p>
<p>值得一提的是，GPT-5.1 Instant 还要比 4o 的情商智商更强。</p>
<p>OpenAI 研究科学家 Aidan McLaughlin 称——</p>
<p>它是首个使用思维链（CoT），引入了「自适应推理」的模型，速度和 GPT-5 Instant 一样快。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c74136c8364e8bb996ae37199b46bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=c4vTkhKPxBrEzudt9JynOittYZ4%3D" alt="" loading="lazy"/></p>
<p>不仅如此，每个人还可以轻松地塑造 ChatGPT 的语气。</p>
<p>毕竟，每个人对聊天风格偏好不尽相同，甚至在不同对话中也会变化——因此通过「控制选项」，就可以轻松拿捏 ChatGPT 说话的调调，让其更对胃口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3806b18b51641d09a9564983a558418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=iMjGhRCg087Cp4xzj71IE9gX4dc%3D" alt="" loading="lazy"/></p>
<p>从专业可靠（Professional）、亲和友善（Friendly），到直言不讳（Candid）、天马行空（Quirky），再到吐槽达人（Cynical）、高效务实（Efficient）、技术宅（Nerdy），都能任意挑选**。**</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77776e7dc0af4b12b79f74a367946f38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=rml3hOW4J8QRmvDe%2B0lfphZd%2FUg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4085557412ad455fba0c51ad025f290a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=B2lkWBUWM1bxothoJVipBvBtoow%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3570d4258274041bf589c5438bc270b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=azzIMdwXaztyiHBdK9wZtIUsruk%3D" alt="" loading="lazy"/></p>
<p><strong>「GPT-5.1：更智能、更健谈」</strong></p>
<p>这次升级后的 GPT-5.1，在智力和沟通上，得到了大幅升级。</p>
<p>你会注意到的是，GPT-5.1 的所有回答在感觉上都更智能，语气也更自然。</p>
<p>其中，GPT-5.1 Auto 将继续为每个查询自动选择最适合的模型，因此在大多数情况下，你完全无需手动选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db20d4a970ae487ea8b454fbad732c10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=G%2BxPOyvX84nvKA%2Fp%2FsuNY9yAYFg%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/838a303318ea4fec863fb2743da6e700~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=2aE1CGp7yf5namNhnqC5GNH4cUE%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「GPT-5.1 Instant」</strong></p>
<p>GPT-5.1 Instant 是 ChatGPT 使用最广的模型，现在它的默认语气将会更显亲切和健谈。</p>
<p>根据早期测试，它常常会出其不意地展现出俏皮的一面，同时回答依然清晰实用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c15cf3403f49465e8d157dc5db4dfb87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=qCSnEN4ojvFFkA3hGay6SKGhgkI%3D" alt="" loading="lazy"/></p>
<p>I'm feeling stressed and could use some relaxation tips</p>
<p>我感到有压力，需要一些放松的建议</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123babdb719c4e21b1c96de56a6d3d87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=%2FFkk5qwq%2F%2BrH%2Fn7PV3nKRtnhMvc%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51adf017cb9d43a685d56520d60f4007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=JqRYXyKkOmW2%2BIN14yPuC29zU0Y%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Instant（上下滑动查看）</p>
<p>除此之外，OpenAI 还改进了指令遵循能力，使模型能更可靠地回答你实际提出的问题。</p>
<p>Always respond with six words</p>
<p>始终用六个词回答</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/098c0e5d430642039ab0861d0e9250d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=UzPRhvKBZICaBYCa6IUgbcBdFR4%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df27f362cd504e448c67bee83b0ce354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=2ky%2Bvq5lqCO2Tn8cxQdVqNpjnKU%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Instant（上下滑动查看）</p>
<p>值得一提的是，GPT-5.1 Instant 首次引入了「自适应推理」能力，能够自主决定在回应更具挑战性的问题前是否需要深入思考，从而在保持快速响应的同时，产出更周全、更准确的答案。</p>
<p>这一点在 AIME 2025 和 Codeforces 等数学与编程评测中的显著进步得到了体现。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf446265f87a4730be17ca14506fa155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=pWGYjIyAUh2498FyUuMUO%2BOOK7E%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「GPT-5.1 Thinking」</strong></p>
<p>与此同时，升级后的 GPT-5.1 Thinking 也会在日常使用中更高效、更易于理解。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc2075486daa4a29b50c8635fa635dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=qjumqRKg35mvw7EV5AuaN275m3g%3D" alt="" loading="lazy"/></p>
<p>现在，它能更精确地根据问题调整思考时间——在复杂问题上投入更多时间，而在简单问题上则响应更快。</p>
<p>在实际使用中，这意味着对于困难的请求，你将获得更详尽的答案；对于简单的请求，等待时间则会更短。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eeb4cd56a76409288ad382370a5a5b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=O161aWnkzQXjjZALjadzRPgCoPM%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Thinking 的回复也更加清晰，减少了专业术语和晦涩词汇的使用。</p>
<p>这使 OpenAI 最强大的模型变得更平易近人、更易于理解，尤其是在处理复杂工作任务和解释技术概念时。</p>
<p>explain BABIP and wRC+</p>
<p>解释 BABIP 和 wRC+</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cface1605a944c3be318f39f9e6e416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=UejcuVMIuwpRggU3cD%2BimOb26zw%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0db9864b2b748b0bd527a153ab4dfea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=bBS0BhSXORXC1Ry6SQSLFCb4OcM%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Thinking（上下滑动查看）</p>
<p>GPT-5.1 Thinking 的默认语气也更加亲切，更富同理心。</p>
<p>Ugh I spilled coffee all over myself before my meeting do you think everyone thought I was an idiot :(</p>
<p>呃，我在会议前把咖啡洒满了自己，你觉得大家会不会都认为我是个白痴 :(</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/699cde126f8149378ac36687f3da011c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=e3QC36Qn0r8tPdev4fPL3bIEKeU%3D" alt="" loading="lazy"/></p>
<p>GPT-5（上下滑动查看）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1780691f573b466eb0abb6784fbf4c83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=kUz%2FNfbeuhC6nIuvf1UyBtzEgAU%3D" alt="" loading="lazy"/></p>
<p>GPT-5.1 Thinking（上下滑动查看）</p>
<p>关于命名的一点说明：</p>
<p>本次更新名为 GPT-5.1，旨在反映其重大改进，同时表明它仍属于 GPT-5 这一代。未来对 GPT-5 的迭代升级将遵循相同的模式。</p>
<p>同在今天，OpenAI 还发布了 GPT-5.1 系统卡，更多内容可参阅 PDF。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa2f8bc3cd3b4f019710e4b08c0834cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=6FfMR1CvhkmjYcF2gJysfjVuY98%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.openai.com%2Fpdf%2F4173ec8d-1229-47db-96de-06d87147e07e%2F5_1_system_card.pdf" target="_blank" title="https://cdn.openai.com/pdf/4173ec8d-1229-47db-96de-06d87147e07e/5_1_system_card.pdf" ref="nofollow noopener noreferrer">cdn.openai.com/pdf/4173ec8…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bf613e42bfc4e32a2499b7de67e6adf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=BuWt5gW8C3x9gdy6wPKXEq3s%2BNc%3D" alt="" loading="lazy"/></p>
<p><strong>「让 ChatGPT 成为独一无二的你」</strong></p>
<p>除了 GPT-5.1 重大升级，想要自定义 ChatGPT 的语气和风格，如今变得更加简单。</p>
<p>毕竟，众人胃口难调，每个人都有自己偏好的聊天方式和风格。</p>
<p>OpenAI 的目标就是，所有人可以轻松搞定设置，让 ChatGPT 用自己最舒服的语气交流。</p>
<p>今年早些时候，OpenAI 添加了预设选项来调整 ChatGPT 的回复语气。</p>
<p>今天，这些选项正在优化，可以更好地反映人们使用 ChatGPT 的最常见方式。</p>
<ul>
<li><strong>「默认」****（</strong>「<strong>「Default」</strong>」<strong>）</strong>「、<strong>「亲和友善」****（****Friendly）」</strong>（原「倾听者」）和**高效务实（Efficient）（**原「机械」）风格将获得更新</li>
<li>同时新增了**「专业可靠（Professional）」**、<strong>直言不讳（Candid）</strong>「和」**天马行空（Quirky）**风格。</li>
<li><strong>吐槽达人（Cynical）</strong>「和」**技术宅（Nerdy）**风格则保持不变。</li>
</ul>
<p>这些选项旨在匹配 OpenAI 观察到的用户自然引导模型的方式，让人们能快速直观地选择一个感觉最对味的「个性」。</p>
<p>这些个性化设置适用于所有模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/337dfaf4a19049eba839f8afbbc186d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=TpUcsnQlgioS2uyZpomChIxLWV0%3D" alt="" loading="lazy"/></p>
<p>左：GPT-5.1；右：GPT-5</p>
<p>除了这些预设，对于希望更精细地控制 ChatGPT 回应方式的用户，OpenAI 还在试验一项新功能：</p>
<p>直接从个性化设置中调整 ChatGPT 的具体特征——包括其回复的简洁度、亲切度或易读性（是否便于快速浏览），以及使用表情符号的频率 。</p>
<p>当 ChatGPT 在对话中，注意到你偏爱某种特定语气或风格时，它还会主动提议更新这些偏好，而无需手动进入设置。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eb70261048f4dc0ba37e8900c5cbdb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=2L5%2BPanAte6Ipxu%2BZI%2FMjIZP4uo%3D" alt="" loading="lazy"/></p>
<p>与此同时，可以随时调整或移除这些偏好。</p>
<p>更新后的风格和语气选项，将于今日起陆续推出。微调特定特征的功能将作为一项实验，从本周晚些时候开始向部分用户逐步开放。</p>
<p>这两项功能，都将在后续不断得到完善。</p>
<p>此外，更新后的 GPT-5.1 也更善于遵循「自定义指令」，让你对语气和行为有更精确的控制。</p>
<p>目前，在个性化设置中更新后，会立即在所有聊天中生效，包括正在进行的对话，从而确保体验的一致性。</p>
<p>还需要注意一点是，对基础风格、语气或自定义指令的更改仅适用于新开启的对话。</p>
<p>总而言之，GPT-5.1 重大更新和新的自定义选项，是 OpenAI 迈向一个更懂你、更智能、更健谈、更能适应个人偏好的 ChatGPT 的重要一步。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/205ea063d0dd472f89c18d7fb547a59c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634646&amp;x-signature=9RVkSAAci8GFp88Hn88PUZTpuJc%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「即日可用」</strong></p>
<p>今日起，GPT-5.1 Instant 和 Thinking 将率先向付费用户（Pro、Plus、Go、Business）陆续推出，随后向免费及未登录用户开放。</p>
<p>本周晚些时候，这两款模型也会登陆 API。其中，GPT-5.1 Thinking 将会以「GPT-5.1」的名称发布，而 GPT-5.1 Instant 则是「gpt-5.1-chat-latest」，两者均具备自适应推理能力。</p>
<p>未来三个月里，GPT-5（Instant 和 Thinking）将继续在 ChatGPT 的「旧模型」下拉菜单中为付费用户提供，以便用户按照自己的节奏进行比较和适应。</p>
<p>值得一提的是，OpenAI 确实从上一次全系下架所有旧模型惹怒网友，吸取了惨痛的教训。</p>
<p>它们表示，未来当 OpenAI 推出新的 ChatGPT 模型时，策略是给予用户充足的空间来评估变化并分享反馈，从在平稳过渡的同时，持续创新前沿模型。模型的淘汰周期将会提前明确地通知。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fgpt-5-1%2F" target="_blank" title="https://openai.com/index/gpt-5-1/" ref="nofollow noopener noreferrer">openai.com/index/gpt-5…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FOpenAI%2Fstatus%2F1988714373058351213%3Fs%3D20" target="_blank" title="https://x.com/OpenAI/status/1988714373058351213?s=20" ref="nofollow noopener noreferrer">x.com/OpenAI/stat…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文带你剖析 Promise.then all 实现原理，状态机、发布订阅模式完美实现异步编程]]></title>    <link>https://juejin.cn/post/7571815997068165160</link>    <guid>https://juejin.cn/post/7571815997068165160</guid>    <pubDate>2025-11-13T10:44:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068165160" data-draft-id="7572010680896421928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文带你剖析 Promise.then all 实现原理，状态机、发布订阅模式完美实现异步编程"/> <meta itemprop="keywords" content="JavaScript,设计模式"/> <meta itemprop="datePublished" content="2025-11-13T10:44:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="依米_"/> <meta itemprop="url" content="https://juejin.cn/user/1354189312111303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文带你剖析 Promise.then all 实现原理，状态机、发布订阅模式完美实现异步编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1354189312111303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    依米_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:44:35.000Z" title="Thu Nov 13 2025 10:44:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文带你剖析 Promise 实现原理，状态机、发布订阅模式完美实现异步编程</h2>
<blockquote>
<p>注：本文代码为仿promise原理简写的代码，非源码。</p>
</blockquote>
<h3 data-id="heading-1">1. 概述</h3>
<p>本文档详细解析了基于 ES6 Class 实现的 Promise，包括其核心原理、状态管理机制、异步处理流程以及各种方法的实现细节。通过深入理解 Promise 的内部实现，帮助你更好地掌握异步编程范式。</p>
<h3 data-id="heading-2">2. Promise 核心原理</h3>
<h4 data-id="heading-3">2.1 状态机设计</h4>
<p>Promise 采用状态机模式，具有三种互斥状态：</p>
<ul>
<li><strong>pending</strong>: 初始状态，既未完成也未拒绝</li>
<li><strong>fulfilled/resolved</strong>: 操作成功完成</li>
<li><strong>rejected</strong>: 操作失败</li>
</ul>
<p>核心特性：<strong>状态一旦改变，就不会再变</strong>，这是 Promise 可靠性的基础。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态定义与初始化</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params">executeFn</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>      <span class="hljs-comment">// 初始状态为 pending</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>       <span class="hljs-comment">// 存储成功结果</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>      <span class="hljs-comment">// 存储失败原因</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = [] <span class="hljs-comment">// 成功回调队列</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [] <span class="hljs-comment">// 失败回调队列</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-4">2.2 发布-订阅模式</h4>
<p>Promise 内部采用发布-订阅模式处理异步回调：</p>
<ul>
<li>在 pending 状态时，通过 then/catch 方法注册的回调会被存储在回调队列中</li>
<li>当 Promise 状态改变时，会遍历执行对应队列中的所有回调(constructor中通过resolve或reject函数触发回调)</li>
</ul>
<p>这解决了异步操作和回调注册的时序问题，确保即使回调在状态变更前注册，也能在状态变更后得到执行。</p>
<h3 data-id="heading-5">3. 核心实现详解</h3>
<h4 data-id="heading-6">3.1 构造函数实现 💖</h4>
<p>构造函数接收一个 executeFn 函数，立即执行该函数并传入 resolve 和 reject 两个函数作为参数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">constructor</span>(<span class="hljs-params">executeFn</span>) {
  <span class="hljs-comment">// 初始化状态和数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = []
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = []
  
  <span class="hljs-comment">// 使用箭头函数定义 resolve/reject，确保 this 指向 Promise 实例</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
      <span class="hljs-comment">// 发布成功事件，执行所有成功回调</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
    }
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'rejected'</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason
      <span class="hljs-comment">// 发布失败事件，执行所有失败回调</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>))
    }
  }
  
  <span class="hljs-comment">// 捕获 executeFn 执行过程中的异常</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">executeFn</span>(resolve, reject)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">reject</span>(error)
  }
}
</code></pre>
<h4 data-id="heading-7">3.2 then 方法实现💖</h4>
<p><code>then</code> 方法是 Promise 规范（Promise/A+）的核心，它是 Promise 能够实现异步操作链式调用的关键机制，被誉为 JavaScript 异步编程的革命性突破。其重要性体现在：</p>
<ul>
<li><strong>彻底解决回调地狱问题</strong>：通过链式调用替代嵌套回调，使异步代码可读性大幅提升</li>
<li><strong>统一异步操作接口</strong>：为所有异步操作提供了标准化的处理方式</li>
<li><strong>错误传播机制</strong>：实现了错误在链式调用中的自动传递，无需每层都添加错误处理</li>
<li><strong>状态隔离与数据传递</strong>：保证了异步操作结果的正确传递和状态的严格隔离</li>
<li><strong>异步操作编排</strong>：支持复杂异步操作流程的构建和组合</li>
</ul>
<p><strong>核心要点：</strong></p>
<ol>
<li>
<p><strong>值穿透机制（参数校验与默认处理）</strong></p>
<ul>
<li>当 <code>onFulfilled</code> 或 <code>onRejected</code> 不是函数时（初始化为函数），Promise 规范要求实现「值穿透」</li>
<li>成功状态的值穿透：<code>value =&gt; value</code> - 确保成功的值能够继续在链中传递</li>
<li>失败状态的值穿透：<code>reason =&gt; { throw reason }</code> - 确保错误能够继续在链中传播</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>这一机制使得可以在链式调用中间跳过某些处理步骤而不中断链式调用</p>
<blockquote>
<p>当 then 方法不传递回调函数时，会使用默认函数将值传递给下一个 then 方法，实现值的穿透。</p>
</blockquote>
</li>
</ul>
<ol start="2">
<li>
<p><strong>链式调用实现（Promise 链）</strong></p>
<ul>
<li>每次调用 <code>then</code> 方法都返回一个全新的 Promise 实例（<code>promise2</code>）</li>
<li>这是链式调用的基础，保证了每个 <code>then</code> 操作都在独立的 Promise 上下文中执行</li>
</ul>
</li>
</ol>
<ul>
<li>新 Promise 的状态由回调函数的执行结果决定，实现了状态的隔离和转换</li>
</ul>
<ol start="3">
<li>
<p><strong>状态驱动的行为模式---状态机</strong></p>
<ul>
<li><strong>根据当前 Promise 的状态</strong>（pending/fulfilled/rejected）<strong>采取不同的处理策略</strong></li>
<li>已完成状态（fulfilled/rejected）：立即异步执行对应回调</li>
<li>进行中状态（pending）：将回调函数存储到对应队列中等待执行</li>
<li>这体现了状态模式的设计思想，行为随状态而变化</li>
</ul>
</li>
<li>
<p><strong>异步执行保证</strong></p>
<ul>
<li>使用 <code>setTimeout(fn, 0)</code> 模拟微任务，确保回调函数异步执行</li>
<li>这符合 Promise/A+ 规范要求，保证了回调执行的时序一致性</li>
<li>避免了同步执行可能导致的状态不一致和执行顺序问题</li>
</ul>
</li>
<li>
<p><strong>结果处理与值传递</strong></p>
<ul>
<li>通过 <code>resolvePromise</code> 辅助函数处理回调返回值，支持：
<ul>
<li>返回 Promise 对象：等待该 Promise 解决并采用其结果</li>
<li>返回普通值：直接将该值作为下一个 Promise 的成功值</li>
<li>抛出异常：将异常作为下一个 Promise 的失败原因</li>
</ul>
</li>
<li>这一设计实现了值在异步链中的自然传递和转换</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) {
  <span class="hljs-comment">// 参数校验，支持值穿透.当 `onFulfilled` 或 `onRejected` 不是函数时,使用箭头函数将其转为函数。实现值穿透</span>
  onFulfilled = <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">'function'</span> ? onFulfilled : <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value
  onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">'function'</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> { <span class="hljs-keyword">throw</span> reason }

  <span class="hljs-comment">// 返回新的 Promise 以支持链式调用</span>
  <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 成功状态处理</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
      <span class="hljs-comment">// 异步执行回调</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 使用了值穿透，这里才能直接使用onFulfilled(this.value)，否则就异常了</span>
          <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>) 
          <span class="hljs-comment">// 处理回调返回值</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-title function_">reject</span>(error)
        }
      }, <span class="hljs-number">0</span>)
    }

    <span class="hljs-comment">// 失败状态处理</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'rejected'</span>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-title function_">reject</span>(error)
        }
      }, <span class="hljs-number">0</span>)
    }

    <span class="hljs-comment">// pending 状态处理 - 存储回调</span>
    <span class="hljs-comment">// 订阅过程（注册回调）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>)
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error)
          }
        }, <span class="hljs-number">0</span>)
      })

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>)
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error)
          }
        }, <span class="hljs-number">0</span>)
      })
    }
  })

  <span class="hljs-keyword">return</span> promise2
}
</code></pre>
<h4 data-id="heading-8">3.3 resolvePromise 辅助函数--处理 <code>then</code> 方法回调函数的返回值💖</h4>
<p><strong>核心作用与重要性</strong></p>
<p><code>resolvePromise</code> 是 Promise 实现中最为复杂和核心的辅助函数，它是 Promise/A+ 规范中实现 "Promise Resolution Procedure"（Promise 解决过程）的关键。这个函数负责<strong>处理 <code>then</code> 方法回调函数的返回值</strong>，并<strong>根据返回值类型决定如何处理下一个 Promise 的状态转换，是实现链式调用和值传递的核心机制</strong>。</p>
<p><strong>参数说明</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
</code></pre>
<ul>
<li><code>promise2</code>: <code>then</code> 方法返回的新 Promise 实例</li>
<li><code>x</code>: <code>then</code> 方法回调函数的返回值（onFulfilled 或 onRejected 的返回值）</li>
<li><code>resolve</code>: promise2 的 resolve 函数，用于将 promise2 状态改为 fulfilled</li>
<li><code>reject</code>: promise2 的 reject 函数，用于将 promise2 状态改为 rejected</li>
</ul>
<p><strong>详细要点：</strong></p>
<ol>
<li>
<p><strong>循环引用检测</strong></p>
<ul>
<li>当 <code>x</code> 与 <code>promise2</code> 是同一个对象时，会导致无限循环</li>
<li>通过 <code>if (promise2 === x)</code> 判断避免这种情况，并抛出类型错误</li>
<li>这是 Promise/A+ 规范强制要求的安全机制</li>
</ul>
</li>
<li>
<p><strong>状态凝固保障</strong></p>
<ul>
<li>使用 <code>called</code> 标志变量确保 <code>resolve</code> 或 <code>reject</code> 只能被调用一次</li>
<li>这符合 Promise 的核心特性：状态一旦改变就不能再变</li>
<li>在所有可能调用 <code>resolve</code>/<code>reject</code> 的地方都检查 <code>called</code> 标志</li>
</ul>
</li>
<li>
<p><strong>Promise 类型处理</strong></p>
<ul>
<li>当 <code>x</code> 是 Promise 实例时，需要等待其状态变化</li>
<li>递归调用 <code>x.then()</code>，将结果继续通过 <code>resolvePromise</code> 处理</li>
<li>确保 Promise 链能够正确等待异步操作完成</li>
</ul>
</li>
<li>
<p><strong>thenable 对象兼容</strong></p>
<ul>
<li>"thenable" 对象是指具有 <code>then</code> 方法的对象或函数</li>
<li>通过动态获取 <code>x.then</code> 属性并检查其是否为函数来识别 thenable 对象</li>
<li>使用 <code>then.call(x, ...)</code> 调用 then 方法，确保上下文正确绑定</li>
<li>这是 Promise 能够兼容其他 Promise 实现的关键</li>
</ul>
</li>
<li>
<p><strong>异常处理机制</strong></p>
<ul>
<li>使用 try-catch 捕获访问 <code>x.then</code> 属性或调用 then 方法时可能发生的异常</li>
<li>任何异常都将导致 promise2 被拒绝，错误作为拒绝原因</li>
<li>异常处理也受到 <code>called</code> 标志的保护，确保只被处理一次</li>
</ul>
</li>
<li>
<p><strong>原始值直接传递</strong></p>
<ul>
<li>当 <code>x</code> 不是对象或函数时（原始值），直接调用 <code>resolve(x)</code></li>
<li>这确保了普通值能够正确地传递到下一个 Promise</li>
</ul>
</li>
</ol>
<p><strong>代码执行流程</strong></p>
<p>resolvePromise 的执行流程体现了 Promise/A+ 规范的严格要求：</p>
<ol>
<li>首先检查循环引用 → 2. 初始化 called 标志 → 3. 根据 x 的类型分三种情况处理：
<ul>
<li>Promise 实例 → 等待其状态变化并递归处理</li>
<li>对象/函数 → 检查是否为 thenable 并相应处理</li>
<li>原始值 → 直接 resolve</li>
</ul>
</li>
</ol>
<p><strong>为什么需要这个复杂的函数？</strong></p>
<p>resolvePromise 函数解决了 JavaScript 异步编程中的几个关键问题：</p>
<ul>
<li><strong>统一的异步接口</strong>：无论返回什么类型的值，都能按照统一规则处理</li>
<li><strong>跨 Promise 实现兼容</strong>：通过 thenable 机制支持不同的 Promise 实现</li>
<li><strong>防止状态不一致</strong>：通过 called 标志确保状态只变更一次</li>
<li><strong>避免死循环</strong>：通过循环引用检测确保程序安全</li>
<li><strong>正确的值传递</strong>：在异步链中确保值能够正确地从一个 Promise 传递到下一个</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise2, x, resolve, reject</span>) {
  <span class="hljs-comment">// 处理循环引用 1.循环引用检测：当 `x` 与 `promise2` 是同一个对象时，会导致无限循环</span>
  <span class="hljs-keyword">if</span> (promise2 === x) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Chaining cycle detected for promise'</span>))
  }

  <span class="hljs-comment">// 防止多次调用 2.状态凝固保障：状态一旦改变就不能再变；确保 `resolve` 或 `reject` 只能被调用一次</span>
  <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>

  <span class="hljs-comment">// 处理 x 是 Promise 的情况 3.Promise 类型处理：当 `x` 是 Promise 实例时，需要等待其状态变化。</span>
  <span class="hljs-keyword">if</span> (x <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) {
    <span class="hljs-comment">//递归调用 `x.then()`，将结果继续通过 `resolvePromise` 处理</span>
    x.<span class="hljs-title function_">then</span>(
      <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, value, resolve, reject),
      <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">reject</span>(reason)
    )
  }
    
  <span class="hljs-comment">// 4.thenable 对象兼容："thenable" 对象是指具有 `then` 方法的对象或函数</span>
  <span class="hljs-comment">// 处理 x 是对象或函数的情况（可能是 thenable）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'function'</span>)) {
    <span class="hljs-comment">// 5.异常处理机制：使用 try-catch 捕获访问 `x.then` 属性或调用 then 方法时可能发生的异常</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 动态获取 `x.then` 属性并检查其是否为函数来识别 thenable 对象</span>
      <span class="hljs-keyword">const</span> then = x.<span class="hljs-property">then</span>
      <span class="hljs-comment">// 判断是否为 thenable 对象</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">'function'</span>) {
        <span class="hljs-comment">// 使用 `then.call(x, ...)` 调用 then 方法，确保上下文正确绑定</span>
        <span class="hljs-comment">// 这是处理 thenable 对象的核心逻辑</span>
        then.<span class="hljs-title function_">call</span>(
          x,  <span class="hljs-comment">// 确保 then 方法内部的 this 指向 x 对象</span>
          
          <span class="hljs-comment">// 成功回调函数 - 当 thenable 对象被成功解析时执行</span>
          <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
            <span class="hljs-comment">// 状态凝固检查：如果已经调用过 resolve/reject，则直接返回</span>
            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
            <span class="hljs-comment">// 标记为已调用，防止重复调用</span>
            called = <span class="hljs-literal">true</span>
            <span class="hljs-comment">// 递归调用 resolvePromise 处理 thenable 对象返回的 value</span>
            <span class="hljs-comment">// 这是实现链式调用和值传递的关键步骤</span>
            <span class="hljs-comment">// 例如：当 value 本身也是 Promise 或 thenable 时，会继续递归处理</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, value, resolve, reject)
          },
          
          <span class="hljs-comment">// 失败回调函数 - 当 thenable 对象被拒绝时执行</span>
          <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
            <span class="hljs-comment">// 状态凝固检查</span>
            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
            <span class="hljs-comment">// 标记为已调用</span>
            called = <span class="hljs-literal">true</span>
            <span class="hljs-comment">// 直接拒绝 promise2，并将错误原因传递下去</span>
            <span class="hljs-title function_">reject</span>(reason)
          }
        )
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 普通对象，直接 resolve</span>
        <span class="hljs-title function_">resolve</span>(x)
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>
      called = <span class="hljs-literal">true</span>
      <span class="hljs-title function_">reject</span>(error) <span class="hljs-comment">// 错误作为拒绝原因</span>
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 原始值，直接 resolve 6.原始值直接传递</span>
    <span class="hljs-title function_">resolve</span>(x)
  }
}
</code></pre>
<blockquote>
<h3 data-id="heading-9">JavaScript中的 call 方法详解</h3>
<p><code>call</code>方法是JavaScript中函数对象的一个内置方法，它允许你调用一个函数并明确指定函数内部的<code>this</code>值。这在Promise实现中非常重要，特别是处理thenable对象时。</p>
<h4 data-id="heading-10">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span>.<span class="hljs-title function_">call</span>(thisArg, arg1, arg2, ...)
</code></pre>
<h4 data-id="heading-11">主要作用</h4>
<ol>
<li><strong>改变函数内部的<code>this</code>指向</strong>
<ul>
<li>第一个参数<code>thisArg</code>就是函数执行时<code>this</code>的指向</li>
<li>后续参数作为函数的参数传入</li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">为什么需要 call 方法？</h4>
<p>在JavaScript中，<strong>函数内部的<code>this</code>指向通常由调用方式决定，而不是定义方式</strong>。<code>call</code>方法提供了一种显式控制<code>this</code>指向的机制，这在很多场景下非常有用，尤其是在处理对象方法借用、回调函数、类继承等情况时。</p>
<h4 data-id="heading-13">Promise实现中的应用</h4>
<p>在Promise实现中，<code>call</code>方法主要用于处理thenable对象：</p>
<pre><code class="hljs language-javascript" lang="javascript">then.<span class="hljs-title function_">call</span>(
  x,  <span class="hljs-comment">// 确保 then 方法内部的 this 指向 x 对象</span>
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> { <span class="hljs-comment">/* 成功回调 */</span> },
  <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> { <span class="hljs-comment">/* 失败回调 */</span> }
)
</code></pre>
<p><strong>这里为什么要用call？</strong></p>
<ul>
<li>thenable对象是指具有<code>then</code>方法的对象</li>
<li>我们<strong>需要调用这个对象的<code>then</code>方法，但同时要确保这个方法内部的<code>this</code>正确指向该对象本身</strong></li>
<li>如果直接写<code>x.then(...)</code>，在正常情况下<code>this</code>也会指向x，但使用<code>call</code>方法是更明确、更安全的做法，特别是在某些特殊情况下（如函数被赋值给变量后调用）</li>
</ul>
<h4 data-id="heading-14">简单例子说明</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个对象</span>
<span class="hljs-keyword">const</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">greeting</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${greeting}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>!`</span>);
  }
};

<span class="hljs-comment">// 正常调用 - this指向person</span>
person.<span class="hljs-title function_">greet</span>(<span class="hljs-string">'Hello'</span>);  <span class="hljs-comment">// 输出: "Hello, John!"</span>

<span class="hljs-comment">// 使用call改变this指向</span>
<span class="hljs-keyword">const</span> anotherPerson = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Jane'</span> };
person.<span class="hljs-property">greet</span>.<span class="hljs-title function_">call</span>(anotherPerson, <span class="hljs-string">'Hi'</span>);  <span class="hljs-comment">// 输出: "Hi, Jane!"</span>
</code></pre>
<h4 data-id="heading-15">与Promise thenable处理的关系</h4>
<p>在Promise的<code>resolvePromise</code>函数中：</p>
<ol>
<li>我们检测到一个对象有<code>then</code>方法</li>
<li>我们需要调用这个<code>then</code>方法，但必须确保它在正确的<code>this</code>上下文中执行</li>
<li>使用<code>then.call(x, onFulfilled, onRejected)</code>确保了：
<ul>
<li><code>then</code>方法被调用</li>
<li><code>then</code>方法内部的<code>this</code>指向x对象</li>
<li>我们传入了成功和失败的回调函数</li>
</ul>
</li>
</ol>
<p>这种方式是Promise/A+规范要求的标准做法，确保了不同Promise实现之间的兼容性和正确的上下文绑定。</p>
</blockquote>
<h3 data-id="heading-16">4. Promise 扩展方法实现</h3>
<h4 data-id="heading-17">4.1 错误处理方法</h4>
<h5 data-id="heading-18">catch 方法</h5>
<p>专门用于捕获 Promise 链中的错误，<strong>本质是 then 方法的语法糖</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">catch</span>(onRejected) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected)
}
</code></pre>
<h5 data-id="heading-19">finally 方法</h5>
<p><strong>无论 Promise 成功或失败都会执行的回调，不接收参数也不影响原 Promise 的结果</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">finally</span>(<span class="hljs-params">callback</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">callback</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> value),
    <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">callback</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> reason })
  )
}
</code></pre>
<h4 data-id="heading-20">4.2 静态方法</h4>
<h5 data-id="heading-21">resolve 方法</h5>
<p>返回一个已成功的 Promise，如果参数本身是 Promise 则直接返回：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) {
    <span class="hljs-keyword">return</span> value
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(value))
}
</code></pre>
<h5 data-id="heading-22">reject 方法</h5>
<p>返回一个已失败的 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span>(<span class="hljs-params">reason</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(reason))
}
</code></pre>
<h5 data-id="heading-23">all 方法💖</h5>
<p>等待所有 Promise 都成功，返回包含所有结果的数组；<strong>任一 Promise 失败则整体失败</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> result = []
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Argument must be an array'</span>))
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>([])
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
        <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
          result[index] = value
          count++
          <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
            <span class="hljs-title function_">resolve</span>(result)
          }
        },
        <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">reject</span>(reason)
      )
    })
  })
}
</code></pre>
<h5 data-id="heading-24">race 方法</h5>
<p><strong>返回第一个完成的 Promise 的结果（无论成功或失败）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">race</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Argument must be an array'</span>))
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">promise</span> =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
        <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(value),
        <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">reject</span>(reason)
      )
    })
  })
}
</code></pre>
<h3 data-id="heading-25">5.constructor中的resolve函数和外部的static resolve方法有何区别？</h3>
<p>在Promise实现中，constructor中的resolve函数和外部的static resolve方法有以下几个关键区别：</p>
<h4 data-id="heading-26">5.1. 定义位置与类型</h4>
<ul>
<li><strong>constructor中的resolve</strong>：是在Promise构造函数内部定义的局部函数，作为参数传递给executor函数，使用箭头函数定义以确保this指向Promise实例。</li>
<li><strong>static resolve方法</strong>：是Promise类的静态方法，通过<code>MyPromise.resolve()</code>直接调用，不属于任何实例。</li>
</ul>
<h4 data-id="heading-27">5.2. 主要作用</h4>
<ul>
<li>
<p><strong>constructor中的resolve</strong>：</p>
<ul>
<li>负责将Promise实例的状态从pending转变为fulfilled</li>
<li>设置成功值(value)并触发所有注册的成功回调函数</li>
<li>是Promise内部状态转换的核心机制</li>
</ul>
</li>
<li>
<p><strong>static resolve方法</strong>：</p>
<ul>
<li>作为Promise的工具方法，用于快速创建一个已成功状态的Promise实例</li>
<li>提供Promise包装功能，将任意值转换为Promise</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">5.3. 调用方式</h4>
<ul>
<li>
<p><strong>constructor中的resolve</strong>：</p>
<ul>
<li>由executor函数内部调用，通常是异步操作完成后</li>
<li>例如：<code>new MyPromise((resolve, reject) =&gt; { setTimeout(() =&gt; resolve(1), 1000); })</code></li>
</ul>
</li>
<li>
<p><strong>static resolve方法</strong>：</p>
<ul>
<li>直接通过类名调用，作为工厂方法使用</li>
<li>例如：<code>MyPromise.resolve(1)</code> 或 <code>MyPromise.resolve(promiseInstance)</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-29">5.4. 处理逻辑</h4>
<ul>
<li>
<p><strong>constructor中的resolve</strong>：</p>
<ul>
<li>检查当前状态是否为pending，确保状态只能变更一次</li>
<li>更新状态为fulfilled并存储成功值</li>
<li>异步执行所有已注册的成功回调</li>
</ul>
</li>
<li>
<p><strong>static resolve方法</strong>：</p>
<ul>
<li>检查传入值是否已经是Promise实例，如果是则直接返回</li>
<li>否则创建并返回一个新的已成功状态的Promise实例</li>
</ul>
</li>
</ul>
<h4 data-id="heading-30">5.5. 代码实现对比</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// constructor中的resolve（局部函数）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
  }
}

<span class="hljs-comment">// static resolve方法（类静态方法）</span>
<span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyPromise</span>) {
    <span class="hljs-keyword">return</span> value
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(value))
}
</code></pre>
<p>总结来说，constructor中的resolve是Promise内部状态管理的核心机制，负责状态转换和回调触发；而static resolve则是一个便捷的工具方法，用于创建已解决状态的Promise实例，实现值的Promise化包装。</p>
<h3 data-id="heading-31">6. 上述代码优化建议</h3>
<h4 data-id="heading-32">6.1 微任务模拟改进then 方法中 setTimeout</h4>
<p>当前实现使用 <code>setTimeout</code> 模拟异步执行，但实际的 Promise 使用微任务队列。在浏览器环境中，可以使用 <code>MutationObserver</code> 或 <code>MessageChannel</code> 更好地模拟微任务：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 微任务队列实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">microTask</span> = (<span class="hljs-params">fn</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> queueMicrotask === <span class="hljs-string">'function'</span>) {
    <span class="hljs-title function_">queueMicrotask</span>(fn);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MutationObserver</span> === <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(fn);
    <span class="hljs-keyword">const</span> textNode = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>);
    observer.<span class="hljs-title function_">observe</span>(textNode, { <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span> });
    textNode.<span class="hljs-property">data</span> = <span class="hljs-string">'1'</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">setTimeout</span>(fn, <span class="hljs-number">0</span>);
  }
};

<span class="hljs-comment">// 然后在 then 方法中使用 microTask 替代 setTimeout</span>
</code></pre>
<h4 data-id="heading-33">6.2 增强静态方法</h4>
<p>可以扩展更多实用的静态方法，如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// allSettled 方法 - 等待所有 Promise 完成，不关心成功或失败</span>
<span class="hljs-keyword">static</span> <span class="hljs-title function_">allSettled</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> results = [];
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>([]);
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>([]);
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise)
        .<span class="hljs-title function_">then</span>(
          <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
            results[index] = { <span class="hljs-attr">status</span>: <span class="hljs-string">'fulfilled'</span>, value };
            count++;
            <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
              <span class="hljs-title function_">resolve</span>(results);
            }
          },
          <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
            results[index] = { <span class="hljs-attr">status</span>: <span class="hljs-string">'rejected'</span>, reason };
            count++;
            <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
              <span class="hljs-title function_">resolve</span>(results);
            }
          }
        );
    });
  });
}

<span class="hljs-comment">// any 方法 - 返回第一个成功的 Promise</span>
<span class="hljs-keyword">static</span> <span class="hljs-title function_">any</span>(<span class="hljs-params">promises</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> errors = [];
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Argument must be an array'</span>));
    }

    <span class="hljs-keyword">if</span> (promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AggregateError</span>([], <span class="hljs-string">'All promises were rejected'</span>));
    }

    promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
      <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(promise)
        .<span class="hljs-title function_">then</span>(resolve)
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
          errors[index] = error;
          count++;
          <span class="hljs-keyword">if</span> (count === promises.<span class="hljs-property">length</span>) {
            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AggregateError</span>(errors, <span class="hljs-string">'All promises were rejected'</span>));
          }
        });
    });
  });
}
</code></pre>
<h3 data-id="heading-34">7. 输入输出示例</h3>
<h4 data-id="heading-35">基本用法示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建并使用 Promise</span>
<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'成功了！'</span>);
    <span class="hljs-comment">// reject('失败了！');</span>
  }, <span class="hljs-number">1000</span>);
});

promise.<span class="hljs-title function_">then</span>(
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功:'</span>, value); <span class="hljs-comment">// 输出: 成功: 成功了！</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'链式调用'</span>;
  }
).<span class="hljs-title function_">then</span>(
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'链式调用结果:'</span>, value); <span class="hljs-comment">// 输出: 链式调用结果: 链式调用</span>
  }
).<span class="hljs-keyword">catch</span>(
  <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'失败:'</span>, reason);
  }
);
</code></pre>
<h4 data-id="heading-36">静态方法使用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Promise.all 示例</span>
<span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>), <span class="hljs-number">100</span>)),
  <span class="hljs-number">3</span>
]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'all结果:'</span>, values); <span class="hljs-comment">// 输出: all结果: [1, 2, 3]</span>
});

<span class="hljs-comment">// Promise.race 示例</span>
<span class="hljs-title class_">MyPromise</span>.<span class="hljs-title function_">race</span>([
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>), <span class="hljs-number">100</span>)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>), <span class="hljs-number">50</span>))
]).<span class="hljs-title function_">then</span>(
  <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'race成功:'</span>, value),
  <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'race失败:'</span>, reason) <span class="hljs-comment">// 输出: race失败: 2</span>
);
</code></pre>
<h3 data-id="heading-37">8. 总结</h3>
<p>本文详细解析了 Promise 的实现原理，包括状态机设计、发布-订阅模式、异步执行机制以及各种方法的实现细节。通过深入理解这些核心概念，开发者可以更好地掌握异步编程范式，编写更加健壮和高效的异步代码。</p>
<p>Promise 的实现体现了优秀的设计模式应用，特别是状态机和发布-订阅模式的结合，解决了传统回调地狱问题，提供了更加优雅和可维护的异步编程解决方案。</p>
<h3 data-id="heading-38">思考1：状态机模式是什么？怎么在Promise中实现</h3>
<h4 data-id="heading-39">状态机模式的定义</h4>
<p>状态机模式是一种<strong>行为设计模式</strong>，它<strong>允许对象在内部状态改变时改变其行为</strong>。对象看起来好像修改了它的类，因为<strong>它的行为随着状态的变化而变化</strong>。在软件设计中，状态机模式特别适用于<strong>描述对象在其生命周期内可能经历的状态转换</strong>，以及这些状态转换所触发的行为。</p>
<p>在<strong>经典的设计模式分类</strong>中，我们通常不会直接使用"状态机模式"这个术语，而是使用 <strong>状态模式</strong>（State Pattern） 。状态机是一个更广泛的概念，而状态模式是实现状态机的一种面向对象设计模式。</p>
<p>总结</p>
<ul>
<li>状态模式（State Pattern） ：GoF正式定义的设计模式，属于23种经典设计模式之一。</li>
<li>状态机模式 ：更<strong>侧重于实现有限状态机概念的模式</strong>，在<strong>工程实践</strong>中的常用称呼。</li>
<li>Promise的实现同时符合状态模式的设计原则和状态机的核心概念，所以可以说它使用了状态模式（在设计模式术语中）或状态机模式（在工程实践术语中）。</li>
</ul>
<p>这就是为什么你可能在不同的资料中看到不同的称呼，但它们描述的是同一个核心设计思想。</p>
<h4 data-id="heading-40">Promise中的状态机实现</h4>
<p>在<code>promise-implementation-docs.md</code>文档中，Promise通过以下方式实现了状态机模式：</p>
<h5 data-id="heading-41">1. 状态定义</h5>
<p>Promise具有三种互斥的状态：</p>
<ul>
<li><strong>pending</strong>: 初始状态，既未完成也未拒绝</li>
<li><strong>fulfilled/resolved</strong>: 操作成功完成</li>
<li><strong>rejected</strong>: 操作失败</li>
</ul>
<h5 data-id="heading-42">2. 状态的不可变性</h5>
<p>核心特性是：<strong>状态一旦改变，就不会再变</strong>。这是Promise可靠性的基础，确保了异步操作的结果一旦确定就不会被覆盖。</p>
<h5 data-id="heading-43">3. 状态实现代码</h5>
<p>在构造函数中初始化状态和相关数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">constructor</span>(<span class="hljs-params">executeFn</span>) {
  <span class="hljs-comment">// 初始化状态和数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'pending'</span>      <span class="hljs-comment">// 初始状态为 pending</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>       <span class="hljs-comment">// 存储成功结果</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>      <span class="hljs-comment">// 存储失败原因</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = [] <span class="hljs-comment">// 成功回调队列</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [] <span class="hljs-comment">// 失败回调队列</span>
  
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h5 data-id="heading-44">4. 状态转换机制</h5>
<p>通过<code>resolve</code>和<code>reject</code>函数实现状态转换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    <span class="hljs-comment">// 发布成功事件，执行所有成功回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'rejected'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason
    <span class="hljs-comment">// 发布失败事件，执行所有失败回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>))
  }
}
</code></pre>
<h4 data-id="heading-45">状态机模式在Promise中的核心机制</h4>
<ol>
<li>
<p><strong>状态检查</strong>: 在转换状态前，会检查当前状态是否为<code>pending</code>，只有处于<code>pending</code>状态的Promise才能转换为<code>fulfilled</code>或<code>rejected</code>状态。</p>
</li>
<li>
<p><strong>状态与数据关联</strong>: 状态转换时，会同时存储相关的数据（成功值<code>value</code>或失败原因<code>reason</code>）。</p>
</li>
<li>
<p><strong>状态驱动行为</strong>: 状态的变化会触发相应的行为，例如执行存储在回调队列中的函数。</p>
</li>
<li>
<p><strong>互斥性</strong>: 三种状态是互斥的，任何时刻Promise只能处于其中一种状态。</p>
</li>
<li>
<p><strong>单向转换</strong>: 状态转换是单向的，只能从<code>pending</code>转换到<code>fulfilled</code>或<code>rejected</code>，一旦完成转换就不能再改变。</p>
</li>
</ol>
<p>这种状态机设计使Promise能够可靠地表示异步操作的最终结果，无论是成功还是失败，并确保异步操作的结果一旦确定就不会被覆盖，为JavaScript异步编程提供了可靠的基础。</p>
<h3 data-id="heading-46">思考2：promise中如何实现发布-订阅模式的</h3>
<p>在<code>MyPromise</code>实现中，发布-订阅模式主要体现在以下几个关键部分：</p>
<h4 data-id="heading-47">1. 事件中心（constructor中定义订阅列表）</h4>
<p>在Promise构造函数中定义了两个数组作为<strong>订阅者列表</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储Promise成功状态下需要执行的回调函数数组</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = []
<span class="hljs-comment">// 存储Promise失败状态下需要执行的回调函数数组</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = []
</code></pre>
<p>这两个数组就是发布-订阅模式中的<strong>事件中心</strong>，用于存储所有注册的回调函数。</p>
<h4 data-id="heading-48">2. 订阅过程（<code>then</code>方法中注册回调）</h4>
<p>当Promise处于pending状态时，通过<code>then</code>方法注册的回调会被添加到对应的数组中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pending状态处理 - 存储回调</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">reject</span>(error)
      }
    }, <span class="hljs-number">0</span>)
  })

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">reject</span>(error)
      }
    }, <span class="hljs-number">0</span>)
  })
}
</code></pre>
<p>这部分代码实现了<strong>订阅</strong>功能，将回调函数添加到相应的事件队列中。</p>
<h4 data-id="heading-49">3. 发布过程（constructor中通过resolve或reject函数触发回调）</h4>
<p>当Promise状态发生变更时（通过resolve或reject函数），会遍历对应的回调数组并执行所有订阅的回调：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'fulfilled'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
    <span class="hljs-comment">// 发布成功事件，执行所有注册的成功回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'rejected'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason
    <span class="hljs-comment">// 发布失败事件，执行所有注册的失败回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>))
  }
}
</code></pre>
<h4 data-id="heading-50">发布-订阅模式的核心体现</h4>
<ol>
<li><strong>解耦性</strong>：Promise的状态变更（发布者）和回调执行（订阅者）完全解耦</li>
<li><strong>时序无关性</strong>：无论回调是在Promise状态变更前还是变更后注册，都能正确执行</li>
<li><strong>多订阅支持</strong>：允许多个回调订阅同一个Promise的状态变更</li>
<li><strong>异步协调</strong>：有效解决了异步操作和回调执行的时序问题</li>
</ol>
<p>通过这种发布-订阅模式，Promise巧妙地解决了JavaScript异步编程中的回调地狱问题，使代码更加清晰和可维护。</p>
<h5 data-id="heading-51">小朋友，你是否有很多❓</h5>
<p>解耦性是什么意思❓怎么做到的时序无关性❓怎么支持的多订阅❓异步协调是then方法中的setTimeout，怎么解决的时序问题❓</p>
<p>发布-订阅模式四个核心特性的具体体现：</p>
<h5 data-id="heading-52">1. 解耦性</h5>
<p>解耦性指的是Promise的<strong>状态status</strong>变更机制（发布者）和<strong>回调函数(onResolvedCallbacks、onRejectedCallbacks)<strong>执行（订阅者）<strong>完全分离</strong>，彼此之间</strong>不直接依赖</strong>。</p>
<p><strong>具体体现：</strong></p>
<ul>
<li>在<code>constructor</code>中定义了状态管理和回调数组，这是发布者的核心部分</li>
<li><code>resolve</code>和<code>reject</code>函数负责状态变更和发布事件（执行回调）</li>
<li><code>then</code>方法负责<strong>注册回调函数</strong>（pendding）到订阅列表中</li>
<li>发布者（状态变更逻辑）不需要知道具体有哪些订阅者（回调函数）</li>
<li>订阅者（回调函数）也不需要知道状态何时会变更</li>
</ul>
<h5 data-id="heading-53">2. 时序无关性</h5>
<p>时序无关性确保无论回调是在<strong>Promise状态变更前还是变更后注册，都能正确执行</strong>。</p>
<p><strong>具体实现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在then方法中</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
  <span class="hljs-comment">// 状态未变更时：存储回调到队列</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 回调逻辑 */</span> })
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
  <span class="hljs-comment">// 状态已变更时：直接执行回调</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 回调逻辑 */</span> }, <span class="hljs-number">0</span>)
}
</code></pre>
<ul>
<li>当Promise已经是fulfilled或rejected状态时，调用then方法会立即异步执行对应回调</li>
<li>当Promise还是pending状态时，<strong>回调会被存储在数组中，等待状态变更后执行</strong></li>
<li>这样<strong>无论回调注册和状态变更的顺序如何，都能保证回调正确执行</strong></li>
</ul>
<h5 data-id="heading-54">3. 多订阅支持</h5>
<p><strong>多订阅</strong>支持允许<strong>多个回调函数</strong>订阅同<strong>一个Promise的状态</strong>变更。</p>
<p><strong>具体实现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在constructor中使用数组存储回调</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = []
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = []

<span class="hljs-comment">// resolve函数中执行所有注册的回调</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))
</code></pre>
<ul>
<li>使用数组存储回调函数，而不是单一函数</li>
<li>每个Promise实例可以<strong>多次调用then方法</strong>，<strong>每次调用都会将回调添加到数组中</strong></li>
<li>状态变更时，<strong>所有注册的回调会按添加顺序依次执行</strong></li>
<li>这使得多个独立的操作可以基于同一个Promise的结果进行联动</li>
</ul>
<h5 data-id="heading-55">4. 异步协调</h5>
<p>异步协调<strong>通过setTimeout确保回调异步执行，解决了异步操作和回调执行的时序问题</strong>。</p>
<p><strong>具体实现：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在then方法的三种状态处理中都使用了setTimeout</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">reject</span>(error)
  }
}, <span class="hljs-number">0</span>)
</code></pre>
<ul>
<li>使用setTimeout模拟微任务，确保回调在当前执行栈清空后执行</li>
<li>无论Promise状态是同步还是异步变更，回调总是异步执行</li>
<li>解决了回调地狱问题，提供了清晰的异步操作流程控制</li>
<li>确保即使在同步操作完成后，回调也会按预期顺序异步执行</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# vue2 使用 cesium 展示 TLE 星历数据]]></title>    <link>https://juejin.cn/post/7571815997068197928</link>    <guid>https://juejin.cn/post/7571815997068197928</guid>    <pubDate>2025-11-13T10:47:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068197928" data-draft-id="7572020278386769954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# vue2 使用 cesium 展示 TLE 星历数据"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T10:47:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叫我AddV"/> <meta itemprop="url" content="https://juejin.cn/user/4860749051150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # vue2 使用 cesium 展示 TLE 星历数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4860749051150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叫我AddV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:47:54.000Z" title="Thu Nov 13 2025 10:47:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue2 使用 cesium 展示 TLE 星历数据</h2>
<blockquote>
<p>为啥突然写这么一篇文章呢，是因为我现在对 cesium 也是了解一些，在做一个项目的时候用到了，发现里面的东西还很多，稍微说一下。</p>
</blockquote>
<h3 data-id="heading-1">环境准备</h3>
<h4 data-id="heading-2">1. cesium包</h4>
<p>项目中需要引入 <code>cesium</code> 包，我不是使用 <code>npm</code> 安装的，我是直接在官网下载的 <code>cesium 包</code>。下载完成后把包放进项目中使用的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80457a1e887047058f8acc3b053d070a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=ZJmy8ET3vsRp3xRrAeauNPzsenU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然后引入的话，只需要在 index.html 中引入一下就可以了。</p>
<p>在 <code>&lt;head&gt;</code> 标签里面放：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"./Cesium/Widgets/widgets.css"</span>&gt;</span>
</code></pre>
<p>在 <code>&lt;body&gt;</code> 标签最后面放：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./Cesium/Cesium.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>然后就完事了。cesium 也算引入成功了。</p>
<p>如果不放心的话，可以运行起 <code>vue</code> 项目，在控制台输入命令查看一下引入的 <code>Cesium</code> 版本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Cesium</span>.<span class="hljs-property">VERSION</span>);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e9c07e3235a4de99465ade78bfc32b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=EBSPGsdCJBPzUL5WXCi8VT34mDE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-3">2. satellite.js</h4>
<p>这个的话我就是使用 <code>npm</code> 安装的了，我安装的 <code>5.0</code> 版本以上的，最好是<code>5</code>这个版本往上，不要装<code>4</code>，API可能会有差异。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab54b02e801f48ffaa574fa7523e01c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=rWoh4OrThM3C3w7toDIq3gSDGVg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-4">3. 其他</h4>
<p>其他的话就是 <code>moment</code>，用来转换时间啥的，这个直接安装就行，想用就用，不想用就用 <code>Date()</code> 转，都可以。</p>
<h3 data-id="heading-5">Cesium 开发</h3>
<p>首先我们创建一个 <code>TCesium.js</code> 文件，用来编写 Cesium 相关的代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aee20f57802649dba543a0edaadd3947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=rzwPUYTHrHb7FL4WAiK4wnqYfsc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>当然，案例嘛，我文件随便创建了，但是正经开发的话需要做好目录规划。</p>
<h4 data-id="heading-6">初始化蓝星（地球）</h4>
<p>首先我也不知道为啥把地球叫蓝星，很多人把地球称作蓝星，我也就这样叫吧。</p>
<h5 data-id="heading-7">1. 创建 TCesium 类</h5>
<p>首先创建一个TCesium 类，在构造函数里面初始化蓝星。我尽可能把注释写的详细一些</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TCesium</span> {

  dom = <span class="hljs-literal">null</span>,  <span class="hljs-comment">// dom节点对象</span>
  scene = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 当前场景</span>
  viewer = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 当前地图对象</span>
  trackEntities = {} <span class="hljs-comment">// 卫星对象</span>
  totalTime = <span class="hljs-number">24</span>*<span class="hljs-number">60</span>*<span class="hljs-number">60</span>   <span class="hljs-comment">// 仿真总时长，默认一天， 单位秒</span>
  timeInterval = <span class="hljs-number">60</span>  <span class="hljs-comment">// 采样间隔，单位秒</span>
  satelliteDataSource = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 卫星数据源</span>

	<span class="hljs-comment">// 接收一个dom，就是用来渲染蓝星的Dom</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">dom</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dom</span> = dom;  <span class="hljs-comment">// 把穿进的dom节点赋值给全局</span>
    <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">'这个地方需要填写自己在官网申请的Token值'</span>;   <span class="hljs-comment">// 设置 Token，需要从官网自己申请</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Viewer</span>(dom, {
      <span class="hljs-attr">homeButton</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 显示主页按钮</span>
      <span class="hljs-attr">sceneModePicker</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 是否显示切换2D/3D按钮</span>
      <span class="hljs-attr">baseLayerPicker</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 图层切换按钮</span>
      <span class="hljs-attr">animation</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 动画，需要开启</span>
      <span class="hljs-attr">infoBox</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 信息框显示</span>
      <span class="hljs-attr">selectionIndicator</span>: <span class="hljs-literal">false</span>, 
      <span class="hljs-attr">geocoder</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">timeline</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 时间轴，要开启的啊</span>
      <span class="hljs-attr">fullscreenButton</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">shouldAnimate</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">navigationHelpButton</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">terrainProvider</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">CesiumTerrainProvider</span>({   <span class="hljs-comment">// 基础地形数据</span>
        <span class="hljs-attr">url</span>: <span class="hljs-string">'https://www.supermapol.com/realspace/services/3D-stk_terrain/rest/realspace/datas/info/data/path'</span>,
        <span class="hljs-attr">requestVertexNormals</span>: <span class="hljs-literal">true</span>
      }),
    })
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">postProcessStages</span>.<span class="hljs-property">fxaa</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">true</span>   <span class="hljs-comment">// 开启抗锯齿优化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">sun</span>.<span class="hljs-property">show</span> = <span class="hljs-literal">false</span>;   <span class="hljs-comment">// 不显示太阳</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">moon</span>.<span class="hljs-property">show</span> = <span class="hljs-literal">false</span>;   <span class="hljs-comment">// 不显示月亮</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">skyBox</span>.<span class="hljs-property">show</span> = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 不显示星空</span>
  }
}
</code></pre>
<p>然后蓝星初始化完成了就，我们需要在使用蓝星的组件编写一下基础结构引入一下就可以了。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ed-earth-model"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"earthModel"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"earthModel"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TCesium</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./TCesium"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Home"</span>,

  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">cesium</span>: <span class="hljs-literal">null</span>
    }
  },

  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initMap</span>();  <span class="hljs-comment">// 初始化地图</span>
    })
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">initMap</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cesium</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cesium</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCesium</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">earthModel</span>);
      }
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.app</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-class">.ed-earth-model</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>编写完上面的代码就可以看到蓝星初始化完成了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/313b16840b9442a9ae215bd83f7bbd39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=bmmWu21e9McdpNLxAVtkZeF1CA4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>非常好！完美~</p>
<h5 data-id="heading-8">2. 初始化数据</h5>
<p>我们写一个方法用来初始化数据，加载TLE星历数据的话，我们可以从网上找一些星历数据，或者客户提供星历数据，他们提供的星历数据一般是这个格式的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8d6724c90844d298f0ef41453f19578~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=st8l5Ew772SY65C2NSIDHv%2BtXQE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>每个卫星的星历包含<code>三行</code>，然后如果有多个的话就往下排，这个星历文件就是简单的 <code>txt</code> 文件。</p>
<p>然后我们需要把这个星历文件转换成JSON对象的形式，就像下面：</p>
<pre><code class="hljs language-josn" lang="josn">{
  "name": "STARLINK-2589",
  "tle1": "1 48371U 21038U   25270.54822457  .00018630  00000+0  12665-2 0  9999",
  "tle2": "2 48371  53.0562   3.9906 0001373 107.0633 253.0506 15.06394038242577"
},
</code></pre>
<p>这个可以写个<code>JS函数</code>进行转换，我写了，但是我不想浪费时间贴了，这个不是重点，到时候你们需要的话直接自己写一个就行了。</p>
<p>星历数据自己去找就行，我上面的都不一定准确了，可以去网站上去复制，很多网站可以查看全球登记在册的卫星，都可以复制星历数据，要保证星历数据的准确性哈，出一点问题都不行，星历数据有了的话，然后我们就可以在地球展示轨道了。</p>
<p>但是有一点需要说一下，就是这个星历啊，他是有<code>时效性</code>的，一般时效性就是7天到14天左右，太久了的话不是不能用，而是不准确了，卫星的位置可能天差地别了。</p>
<h5 data-id="heading-9">3. 卫星仿真</h5>
<p>首先仿真这个就是看卫星在某一时间的运行轨迹嘛，我们写一个方法，然后来处理这个逻辑。</p>
<p>首先仿真时间可以是<code>自定义仿真时间</code>，也可以是<code>使用当前时间</code>开始仿真。</p>
<p>比如根据提供的星历数据，看一下 <code>2025-10-10 12:00:00</code>  到 <code>2025-10-10 15:00:00</code> 这三个小时的卫星轨迹。或者是看一下现在时间到未来两个小时内的卫星运行轨迹。</p>
<p><strong>准备数据</strong></p>
<p>我先贴代码，然后一点一点解释哈：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-title function_">addTle</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> tleData = [   <span class="hljs-comment">// 星历数据</span>
      {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"STARLINK-2589"</span>,
        <span class="hljs-string">"tle1"</span>: <span class="hljs-string">"1 48371U 21038U   25270.54822457  .00018630  00000+0  12665-2 0  9999"</span>,
        <span class="hljs-string">"tle2"</span>: <span class="hljs-string">"2 48371  53.0562   3.9906 0001373 107.0633 253.0506 15.06394038242577"</span>
      }
    ]
    <span class="hljs-keyword">let</span> startTime = <span class="hljs-string">"2025-11-11 08:00:00"</span>;  <span class="hljs-comment">// 东八区时间，也就是北京时间</span>
    <span class="hljs-keyword">let</span> endTime = <span class="hljs-string">"2025-11-11 12:00:00"</span>;  <span class="hljs-comment">// 东八区时间，也就是北京时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTleFile</span>(tleData, <span class="hljs-literal">true</span>, startTime, endTime);  <span class="hljs-comment">// 调用加载TLE数据的函数</span>
  }
</code></pre>
<p>这个函数就是准备了一下星历数据，当然我这里写死了，到时候项目肯定后端返回了。</p>
<p>然后创建了<code>startTime</code>  和 <code>endTime</code> ，表示仿真这个时间段的卫星轨迹。</p>
<p>然后就是去走<code>loadTleFile()</code>函数。</p>
<p><strong>加载TLE数据函数</strong></p>
<p>我先写代码：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 加载星历文件，实现卫星轨迹显示</span>
  <span class="hljs-title function_">loadTleFile</span>(<span class="hljs-params">tleData, showPath = <span class="hljs-literal">false</span>, startTime = <span class="hljs-literal">null</span>, endTime = <span class="hljs-literal">null</span></span>) {
    <span class="hljs-keyword">let</span> start = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">let</span> stop = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">if</span> (startTime &amp;&amp; endTime) { <span class="hljs-comment">// 假设提供了开始时间和结束时间</span>
      start = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(startTime));
      stop = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(endTime));
    } <span class="hljs-keyword">else</span> {  <span class="hljs-comment">// 如果没有传时间默认从系统当前时间往后一天的仿真时间</span>
      start = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromIso8601</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>());
      stop = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">secondsDifference</span>(stop, start);  <span class="hljs-comment">// 计算开始时间和结束时间的时间差 单位秒</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">startTime</span> = start.<span class="hljs-title function_">clone</span>() <span class="hljs-comment">// 给cesium时间轴设置开始的时间，也就是上边的东八区时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">stopTime</span> = stop.<span class="hljs-title function_">clone</span>() <span class="hljs-comment">// 设置cesium时间轴设置结束的时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">currentTime</span> = start.<span class="hljs-title function_">clone</span>() <span class="hljs-comment">// 设置cesium时间轴设置当前的时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">clockRange</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ClockRange</span>.<span class="hljs-property">LOOP_STOP</span> <span class="hljs-comment">// 时间结束了，再继续重复来一遍</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">multiplier</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 时间轴倍速，1是正常速度，2是两倍速，0.5是半速</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">clock</span>.<span class="hljs-property">clockStep</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ClockStep</span>.<span class="hljs-property">SYSTEM_CLOCK_MULTIPLIER</span> <span class="hljs-comment">// 时间轴步长，SYSTEM_CLOCK_MULTIPLIER是根据系统时间步长来更新时间轴，其他选项还有TICK_DEPENDENT和SYSTEM_CLOCK</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">timeline</span>.<span class="hljs-title function_">updateFromClock</span>();  <span class="hljs-comment">// 强制更新时间轴</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">timeline</span>.<span class="hljs-title function_">zoomTo</span>(start.<span class="hljs-title function_">clone</span>(), stop.<span class="hljs-title function_">clone</span>());  <span class="hljs-comment">// 设置时间轴显示区间</span>

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>) {  <span class="hljs-comment">// 判断卫星数据源是不是空（可以不用，视情况而定，写一下是知道可以这样用）</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">CustomDataSource</span>(<span class="hljs-string">'satellite'</span>)  <span class="hljs-comment">// 是空则创建一个数据源</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewer</span>.<span class="hljs-property">dataSources</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>)  <span class="hljs-comment">// 把数据源添加到viewer，后期卫星全部添加到卫星数据源</span>
    }
    <span class="hljs-comment">// 分批处理卫星数据，避免一次性处理所有卫星导致页面卡住</span>
    <span class="hljs-keyword">let</span> sss = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(tleData))
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_loadSatellitesInBatches</span>(sss, start, stop, <span class="hljs-number">10</span>, showPath) <span class="hljs-comment">// 每批加载10个卫星</span>
  }
</code></pre>
<p>首先<code>loadTleFile()</code>函数接收四个参数，分别是<code>星历数据列表</code>、<code>是否显示卫星轨迹线</code>、<code>仿真开始北京时间</code>、<code>仿真结束北京时间</code>。</p>
<p>里面主要做了啥呢？主要就是<code>设置时间轴</code>，让<code>Cesium</code>界面上的时间轴显示成我们设置的<code>仿真时间段</code>。</p>
<p>这里有一问题需要特别注意一下哈，那就是时间问题。我们传入的<code>开始时间和结束时间是北京时间</code>，也就是<code>东八区</code>的时间。但是！Cesium时间轴设置的时间需要是<code>UTC时间</code>。</p>
<p><code>UTC 时间</code>（Coordinated Universal Time，<code>协调世界时</code>）是全球通用的标准时间，被世界各地用作时间基准，其核心特点是统一、无时区偏移、基于原子时和地球自转校准。</p>
<p>所以说我们设置时间轴的时候需要<code>把北京时间转换成UTC时间</code>。</p>
<p>我们使用了<code>beijingTimeToDate()</code>函数：</p>
<pre><code class="hljs language-js" lang="js">      start = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(startTime));
      stop = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">fromDate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">beijingTimeToDate</span>(endTime));
</code></pre>
<p><code>beijingTimeToDate()</code>函数可以把北京时间字符串转成Date类型的对象，然后通过<code>Cesium.JulianDate.fromDate()</code>函数可以转成UTC时间。</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 北京时间字符串转换为Date对象</span>
  <span class="hljs-title function_">beijingTimeToDate</span>(<span class="hljs-params">beijingTimeString</span>) {
    <span class="hljs-keyword">const</span> isoString = beijingTimeString.<span class="hljs-title function_">replace</span>(<span class="hljs-string">' '</span>, <span class="hljs-string">'T'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(isoString);
  }
</code></pre>
<p>解释一下，其实<code>北京时间和UTC时间</code>就<code>差了八小时</code>，也就是说<code>北京时间比UTC时间多八小时</code>。比如<code>北京时间2025-11-11 08:00:00</code> 对应的<code>UTC时间就是 2025-11-11 00:00:00</code>。</p>
<p>在后面就是设置时间轴了，更新时间轴，这样的话，我们时间轴就设置成功了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d90c92999b441aba7f4deb7f1d7f1bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=d3niq0IzQfPEcVdpNcBbYX42Cy0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>设置成功就调用了 <code>_loadSatellitesInBatches()</code> 函数分批处理星历数据了。</p>
<h5 data-id="heading-10">_loadSatellitesInBatches()函数 分批处理星历数据</h5>
<p>贴这个函数完整代码，后面解释：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 分批加载卫星数据 </span>
  <span class="hljs-title function_">_loadSatellitesInBatches</span>(<span class="hljs-params">satellites, start, stop, batchSize, showPath</span>) {
    <span class="hljs-keyword">const</span> batches = [];
    <span class="hljs-comment">// 将卫星数据分成多个批次</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; satellites.<span class="hljs-property">length</span>; i += batchSize) {
      batches.<span class="hljs-title function_">push</span>(satellites.<span class="hljs-title function_">slice</span>(i, i + batchSize));
    }
    <span class="hljs-comment">// 递归处理每个批次</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">processBatch</span> = (<span class="hljs-params">batchIndex</span>) =&gt; {
      <span class="hljs-keyword">if</span> (batchIndex &gt;= batches.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 所有批次处理完毕</span>
      }
      <span class="hljs-comment">// 处理当前批次</span>
      <span class="hljs-keyword">const</span> currentBatch = batches[batchIndex];
      currentBatch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">satellite</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_addSatelliteEntity</span>(satellite, start, stop, showPath);
      });
      <span class="hljs-comment">// 在下一帧处理下一批次，避免阻塞主线程</span>
      <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">processBatch</span>(batchIndex + <span class="hljs-number">1</span>);
      });
    };
    <span class="hljs-comment">// 开始处理第一批</span>
    <span class="hljs-title function_">processBatch</span>(<span class="hljs-number">0</span>);
  }
</code></pre>
<p>为啥要分批处理哈，其实单纯案例的话不需要，分批是怕卫星星历很多，比如上百颗卫星，或者是上千颗卫星，最好分批。</p>
<p>因为后面需要对每颗卫星的星历进行处理，获取每颗卫星不同时间段的位置，比如1000颗卫星，每颗卫星取1000个位置，这个遍历时间是有点儿久的，如果不分批的话，Cesium展示的进程会被卡死，页面整个操作不了了，但是案例就一颗卫星，不需要分批，但是做分批处理是没坏处的，有备无患。</p>
<p><code>_loadSatellitesInBatches()</code>函数接收五个参数，分别是<code>星历列表</code>、<code>开始UTC时间</code>、<code>结束UTC时间</code>、<code>每批个数</code>、<code>是否显示轨迹线</code>。</p>
<p>这个函数没啥好说的，看看就懂，跟Cesium没啥关系，就是分批加载，一帧加载十颗卫星。</p>
<p>每一帧遍历这一批次的卫星星历，执行一个<code>this._addsatelliteEntity(satellite, start, stop, showPath);</code> 函数，这个函数才是真正的处理星历的函数。</p>
<h5 data-id="heading-11">_addSatelliteEntity 处理星历函数</h5>
<p>首先还是贴代码：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 添加单个卫星实体</span>
  <span class="hljs-title function_">_addSatelliteEntity</span>(<span class="hljs-params">satellite, start, stop, showPath</span>) {
    <span class="hljs-comment">// 创建临时对象存储当前卫星信息，避免修改this对象</span>
    <span class="hljs-keyword">const</span> satelliteInfo = {
      <span class="hljs-attr">name</span>: satellite.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">tleLine1</span>: satellite.<span class="hljs-property">tle1</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">tleLine2</span>: satellite.<span class="hljs-property">tle2</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">satrec</span>: <span class="hljs-title function_">twoline2satrec</span>(satellite.<span class="hljs-property">tle1</span>.<span class="hljs-title function_">trim</span>(), satellite.<span class="hljs-property">tle2</span>.<span class="hljs-title function_">trim</span>()),
      <span class="hljs-attr">leadTime</span>: <span class="hljs-built_in">parseInt</span>(<span class="hljs-number">24</span> * <span class="hljs-number">3600</span> / satellite.<span class="hljs-property">tle2</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">52</span>, <span class="hljs-number">64</span>))
    };

    <span class="hljs-comment">// 创建卫星实体</span>
    <span class="hljs-keyword">let</span> cesiumSateEntity = {
      <span class="hljs-attr">id</span>: satellite.<span class="hljs-property">noradId</span> || satellite.<span class="hljs-property">name</span>,  <span class="hljs-comment">// 设置卫星对象的ID</span>
      <span class="hljs-attr">name</span>: satellite.<span class="hljs-property">name</span>, <span class="hljs-comment">// 设置卫星的名称</span>
      <span class="hljs-attr">description</span>: satellite.<span class="hljs-property">name</span>,  <span class="hljs-comment">// 设置描述</span>
      <span class="hljs-comment">// 使用专用函数计算位置，传入卫星信息</span>
      <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getSatellitePositionProperty</span>(start, satelliteInfo),
      <span class="hljs-attr">point</span>: {  <span class="hljs-comment">// 卫星用点表示</span>
        <span class="hljs-attr">pixelSize</span>: <span class="hljs-number">10</span>,  <span class="hljs-comment">// 卫星点十个像素</span>
        <span class="hljs-attr">color</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">WHITE</span>,  <span class="hljs-comment">// 卫星点是白色的</span>
      },
      <span class="hljs-attr">path</span>: {  <span class="hljs-comment">// 卫星轨迹线设置</span>
        <span class="hljs-attr">width</span>: <span class="hljs-number">0.5</span>,   <span class="hljs-comment">// 轨迹线的宽度，单位是像素</span>
        <span class="hljs-attr">leadTime</span>: satelliteInfo.<span class="hljs-property">leadTime</span>,  <span class="hljs-comment">//  轨迹线 “前瞻时间”，即显示卫星从当前时间开始，未来一段时间内的预测轨迹长度，这里设置的就是卫星运行一圈的时间，也就是显示未来一圈的轨迹</span>
        <span class="hljs-attr">trailTime</span>: <span class="hljs-number">0</span>,  <span class="hljs-comment">// 轨迹线 “回溯时间”，即显示卫星从过去一段时间到当前时间的轨迹长度，设置为 0 表示不显示卫星过去的轨迹，只展示未来的预测轨迹</span>
        <span class="hljs-attr">material</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">YELLOW</span>,  <span class="hljs-comment">// 线是黄色的</span>
        <span class="hljs-attr">show</span>: showPath === <span class="hljs-literal">true</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认隐藏轨迹</span>
        <span class="hljs-attr">clampToGround</span>: <span class="hljs-literal">false</span>  <span class="hljs-comment">// 轨迹线是否 “贴地”，卫星在天上飞，轨迹就不要贴地了哈</span>
      },
      <span class="hljs-attr">label</span>: {  <span class="hljs-comment">// 卫星的label展示配置</span>
        <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 是否显示</span>
        <span class="hljs-attr">text</span>: satellite.<span class="hljs-property">name</span>,  <span class="hljs-comment">// 显示的内容</span>
        <span class="hljs-attr">font</span>: <span class="hljs-string">'12px sans-serif'</span>,   <span class="hljs-comment">// 字体设置</span>
        <span class="hljs-attr">fillColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">WHITE</span>,   <span class="hljs-comment">// 填充颜色白色</span>
        <span class="hljs-attr">outlineColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-property">BLACK</span>,  <span class="hljs-comment">// 边框颜色黑色</span>
        <span class="hljs-attr">outlineWidth</span>: <span class="hljs-number">2</span>,  <span class="hljs-comment">// 边框宽度2像素</span>
        <span class="hljs-attr">pixelOffset</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian2</span>(<span class="hljs-number">0</span>, <span class="hljs-number">15</span>),  <span class="hljs-comment">// 偏移量</span>
      }
    };
    <span class="hljs-comment">// 添加卫星实体</span>
    <span class="hljs-keyword">let</span> satelliteEntity = <span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Entity</span>(cesiumSateEntity));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackEntities</span>[satelliteEntity.<span class="hljs-property">id</span>] = satelliteEntity;
  }
</code></pre>
<p>首先这个函数接收四个参数：<code>单颗卫星星历数据</code>、<code>仿真开始UTC时间</code>、<code>仿真结束UTC时间</code>、<code>是否显示卫星轨迹线</code>。</p>
<p>函数第一步是对卫星 TLE 数据的结构化封装：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a378b82107f04b76b57ac0ece70c6f12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=OZLgkD8OeNzPcTutwxp5J6QjmjI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>因为传进来的<code>satellite</code>其实就是单个卫星数据，就是这个：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92ddf144feef4d61bfc3f8fae35f7d75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=i3u28ggCluKI4RvgtFPGnw%2BqOuE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>所以<code>satelliteInfo</code> 前三个值不解释了。</p>
<p>然后第三个字段，<code>satrec: twoline2satrec(satellite.tle1.trim(), satellite.tle2.trim())</code> 是通过 <code>twoline2satrec</code> 方法（通常来自 satellite.js 库）解析 TLE 数据后得到的 <code>卫星轨道模型对象（satrec）</code>。<code>satrec</code> 包含了 <code>SGP4 轨道</code>计算所需的所有参数（如半长轴、倾角、历元时间等），是后续调用 <code>propagate</code> 方法计算卫星实时位置（<code>ECI 坐标</code>）的核心输入。</p>
<p><code>twoline2satrec</code>  方法是<code>satellite.js</code> 库里面的，需要在顶部引入一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { twoline2satrec, propagate, gstime, eciToGeodetic, degreesLong } <span class="hljs-keyword">from</span> <span class="hljs-string">'satellite.js'</span>
</code></pre>
<p>这几个都是后面用到的，全写上吧。</p>
<p>第四个字段，<code>leadTime: parseInt(24 * 3600 / satellite.tle2.slice(52, 64))</code>  用来计算卫星的轨道周期，单位是秒，表示卫星绕地球一周所需的时间。</p>
<p>这个<code>satelliteInfo</code> 对象解释完了，后面可能用到里面的字段，注意知道每个字段的含义就行。</p>
<p>在后面就是创建一个卫星实体<code>cesiumSateEntity</code>，代码注释的很清楚了，再就是把卫星实体对象添加到卫星数据源里面，其中添加到卫星数据源之后会返回这个卫星实体对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 将卫星添加到卫星数据源</span>
<span class="hljs-keyword">let</span> satelliteEntity = <span class="hljs-variable language_">this</span>.<span class="hljs-property">satelliteDataSource</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Entity</span>(cesiumSateEntity));
</code></pre>
<p>他会返回一个<code>satelliteEntity </code>，你可以通过修改satelliteEntity 的内容，页面上的卫星状态也会跟着改变，比如颜色、是否显示轨迹、是否可见啥的，也可以获取他的信息，比如经度、纬度啥的。所以后边在对象里面存储了一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">trackEntities</span>[satelliteEntity.<span class="hljs-property">id</span>] = satelliteEntity; <span class="hljs-comment">// 存储卫星实体</span>
</code></pre>
<p>主要说的是啥呢！是创建卫星实体对象的时候设置位置调用了一个专用的计算函数：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 使用专用函数计算位置，传入卫星信息</span>
  <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getSatellitePositionProperty</span>(start, satelliteInfo),
</code></pre>
<p>调用的<code>_getSatellitePositionProperty</code>函数才是关键，他用来计算这个卫星在这个仿真时间段的位置信息！</p>
<h5 data-id="heading-12">卫星位置计算</h5>
<p>还是哈，先贴代码：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 为单个卫星计算位置属性</span>
  <span class="hljs-title function_">_getSatellitePositionProperty</span>(<span class="hljs-params">start, satelliteInfo</span>) {
    <span class="hljs-keyword">const</span> positionProperty = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">SampledPositionProperty</span>();  <span class="hljs-comment">// 位置属性</span>
    <span class="hljs-keyword">const</span> baseTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">toDate</span>(start).<span class="hljs-title function_">getTime</span>();  <span class="hljs-comment">// 开始时间的时间戳</span>
    <span class="hljs-comment">// 这样可以在保持轨迹连续性的同时大幅提高性能</span>
    <span class="hljs-keyword">const</span> sampleInterval = <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeInterval</span>; <span class="hljs-comment">// timeInterval 秒钟一个采样点（秒）</span>
    <span class="hljs-keyword">const</span> totalSamples = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> / sampleInterval); <span class="hljs-comment">// 计算采样点数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalSamples; i++) {  <span class="hljs-comment">// 遍历每个采样点</span>
      <span class="hljs-keyword">const</span> currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseTime + i * sampleInterval * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 采样时间</span>
      <span class="hljs-keyword">const</span> sateCoord = <span class="hljs-title function_">propagate</span>(satelliteInfo.<span class="hljs-property">satrec</span>, currentTime).<span class="hljs-property">position</span>;  <span class="hljs-comment">// 计算当前时间的位置</span>
      <span class="hljs-keyword">if</span> (!sateCoord?.<span class="hljs-property">x</span> || !sateCoord?.<span class="hljs-property">y</span> || !sateCoord?.<span class="hljs-property">z</span>) {  <span class="hljs-comment">// 如果计算出的位置为空，则跳过</span>
        <span class="hljs-keyword">continue</span>
      }
      <span class="hljs-keyword">let</span> gsmt = <span class="hljs-title function_">gstime</span>(currentTime)  <span class="hljs-comment">// 计算当前时间的 GST 时间</span>
      <span class="hljs-keyword">let</span> efgd = <span class="hljs-title function_">eciToGeodetic</span>(sateCoord, gsmt)  <span class="hljs-comment">//  将 ECI 坐标转换为大地坐标</span>
      <span class="hljs-keyword">let</span> lon = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">longitude</span>)  <span class="hljs-comment">// 将大地坐标转换为度</span>
      <span class="hljs-keyword">let</span> lat = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">latitude</span>)  <span class="hljs-comment">//  将大地坐标转换为度</span>
      <span class="hljs-keyword">let</span> height = efgd.<span class="hljs-property">height</span>  <span class="hljs-comment">//  高度</span>
      <span class="hljs-keyword">let</span> stkWorldPoint = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(lon, lat, height * <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 将大地坐标转换为 STK 世界坐标</span>
      <span class="hljs-keyword">const</span> cesiumTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, i * sampleInterval, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
      positionProperty.<span class="hljs-title function_">addSample</span>(cesiumTime, stkWorldPoint);
    }
    <span class="hljs-keyword">return</span> positionProperty;
  }
</code></pre>
<p>这个函数 <code>_getSatellitePositionProperty</code> 是用于在 <code>Cesium</code> 中生成<code>单个卫星的时间序列位置属性</code>（SampledPositionProperty），核心功能是通过轨道计算获取卫星在一段时间内的连续位置，并将其转换为 Cesium 可识别的坐标格式，最终用于绘制卫星轨迹或动态展示卫星运动。</p>
<p>整体逻辑是：函数从指定的起始时间 <code>start</code> 开始，按固定时间间隔采样，计算卫星在每个采样时刻的空间位置，将这些 <code>“时间 - 位置” 对</code>整合为 SampledPositionProperty 对象（Cesium 中用于描述随时间变化的位置的专用属性），供<code>卫星实体绑定轨迹或动态更新位置</code>使用。</p>
<p>对这个函数重点解释一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> positionProperty = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">SampledPositionProperty</span>();  <span class="hljs-comment">// 位置属性</span>
</code></pre>
<p>这行代码是用来<code>初始化位置属性</code>，创建 <code>SampledPositionProperty</code> 实例，用于存储 <code>“时间点 - 位置”</code> 的映射关系，是 Cesium 中描述动态位置的核心对象（支持插值计算，使轨迹平滑）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> baseTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">toDate</span>(start).<span class="hljs-title function_">getTime</span>();  <span class="hljs-comment">// 开始时间的时间戳</span>
</code></pre>
<p>baseTime 是用来做基准时间的。就是仿真开始时间，这里转换成了时间戳。将 Cesium 的 JulianDate 格式起始时间（start）转换为 JavaScript 时间戳（毫秒级），方便后续计算采样时间。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sampleInterval = <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeInterval</span>; <span class="hljs-comment">// timeInterval 秒钟一个采样点（秒）</span>
<span class="hljs-keyword">const</span> totalSamples = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> / sampleInterval); <span class="hljs-comment">// 计算采样点数</span>
</code></pre>
<p>上面这两行主要用来<code>设置采样参数</code>。 <code>sampleInterval</code>是每次采样的时间间隔（单位：秒），控制轨迹的精度（间隔越小，轨迹越精细，但性能消耗越高）；<code>totalSamples</code>是根据总时长（this.totalTime）和间隔计算需要的采样点数量，确保覆盖整个时间段。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalSamples; i++) { ... }
</code></pre>
<p><code>for循环</code>的话，就是为了遍历每个采样点，计算对应时间的卫星位置。</p>
<p>然后是<code>for循环</code>里面的逻辑：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseTime + i * sampleInterval * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 采样时间</span>
<span class="hljs-keyword">const</span> sateCoord = <span class="hljs-title function_">propagate</span>(satelliteInfo.<span class="hljs-property">satrec</span>, currentTime).<span class="hljs-property">position</span>;  <span class="hljs-comment">// 计算当前时间的位置</span>
</code></pre>
<p>currentTime  这个是啥呢，就是获取<code>第 i 个采样点的时间</code>，即：<code>基准时间 + 第 i 个取样点 * 取样间隔时间(s) * 1000</code>，也就是基于起始时间戳，累加 <code>i * 采样间隔</code>（毫秒），得到当前采样点的 <code>UTC 时间</code>（Date 对象）。</p>
<p><code>sateCoord</code> 是调用 <code>propagate</code> 方法，根据卫星的 <code>satrec</code> 轨道模型和当前时间，计算卫星在<code>惯性坐标系（ECI） 中的位置</code>（x, y, z，单位通常为千米）。</p>
<p>可以理解通过这两行代码，最后获得了这个<code>在某个时间点</code>下，该卫星在<code>惯性坐标</code>系下的位置信息。</p>
<p>继续：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (!sateCoord?.<span class="hljs-property">x</span> || !sateCoord?.<span class="hljs-property">y</span> || !sateCoord?.<span class="hljs-property">z</span>) {  <span class="hljs-comment">// 如果计算出的位置为空，则跳过</span>
  <span class="hljs-keyword">continue</span>
}
</code></pre>
<p>上面这个判断是为了过滤无效位置，若轨道计算失败（返回 NaN 或 undefined），跳过当前采样点，避免错误数据影响轨迹。</p>
<p>再往下就是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> gsmt = <span class="hljs-title function_">gstime</span>(currentTime); <span class="hljs-comment">// 计算当前时间的格林尼治恒星时（GST）</span>
<span class="hljs-keyword">let</span> efgd = <span class="hljs-title function_">eciToGeodetic</span>(sateCoord, gsmt); <span class="hljs-comment">// ECI 转大地坐标</span>
</code></pre>
<p><code>gstime(currentTime)</code>是用来计算当前时间的格林尼治恒星时（用于 ECI 到地固坐标的转换，消除地球自转影响）。
<code>eciToGeodetic</code>是将惯性系（ECI）坐标转换为大地坐标（经度、纬度、高度，基于 WGS84 椭球），即<code>卫星在地面观测者眼中的位置</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> lon = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">longitude</span>); <span class="hljs-comment">// 经度（弧度→度）</span>
<span class="hljs-keyword">let</span> lat = <span class="hljs-title function_">degreesLong</span>(efgd.<span class="hljs-property">latitude</span>);  <span class="hljs-comment">// 纬度（弧度→度）</span>
<span class="hljs-keyword">let</span> height = efgd.<span class="hljs-property">height</span>;              <span class="hljs-comment">// 高度（千米）</span>
</code></pre>
<p>上面是将<code>大地坐标单位转换</code>，将<code>经纬度从弧度转换为度</code>（Cesium 常用单位），保留高度值（后续需转换为米）。</p>
<p>再往下是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> stkWorldPoint = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(lon, lat, height * <span class="hljs-number">1000</span>);
</code></pre>
<p>讲位置信息转换为 Cesium 世界坐标。<code>Cesium.Cartesian3.fromDegrees</code>作用是将经纬度（度）和高度（米，因此 ×1000 转换千米→米）转换为 Cesium 的<code>地固坐标系</code>（ECEF） 坐标（Cartesian3 对象），即三维世界中的位置。</p>
<p>最后了：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cesiumTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, i * sampleInterval, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
positionProperty.<span class="hljs-title function_">addSample</span>(cesiumTime, stkWorldPoint);
</code></pre>
<p>绑定时间与位置，计算当前<code>采样点对应的 Cesium 时间</code>（JulianDate 格式），将 <code>“时间 - 位置” 对</code>添加到 <code>positionProperty</code> 中，完成一个采样点的记录。</p>
<p>最终返回包含所有采样点的 <code>SampledPositionProperty</code> 对象，<code>可直接绑定到 Cesium 的卫星实体（Entity）上，用于动态展示卫星轨迹和位置</code>。</p>
<p>所以这个函数是卫星轨迹可视化的核心逻辑，通过 <code>“时间采样→轨道计算→坐标转换→绑定属性”</code> 的流程，将卫星的轨道参数（TLE）转换为 Cesium 可渲染的动态位置数据。</p>
<p>然后就可以看一下页面效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6a801aa43ee44ffbbfa69a8280861c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=ZARLXaZRG%2Bgjg014nwjAvzI0IgE%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1d8676ea90f4496a4fede4a90a6e147~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=Cjgi1JyXoX%2BVSqu5WqJOI5aTDkc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以看到卫星轨迹线已经加载出来了。</p>
<p>然后我们用第三方软件加载一下这个星历，看一下效果是不是一样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a63d17469e14dc181a969f2ad2b0a39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=TGfb%2FkJO3yR%2BQTjS27UexbHyAlw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以看到我们绘制的轨迹线和第三方软件绘制的是一样的。这就完成了！</p>
<h5 data-id="heading-13">注意</h5>
<p>有一点需要注意。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f084c50505c4fc0bc8a1a931a042e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=C%2FjHodv3nRTXIaXradIt%2BA8F2q4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>就是我们看<code>3D</code>的效果，卫星轨迹线为什么转完一圈之后首尾<code>没有闭合</code>啊？感觉像是轨迹线跑偏了一样，他理论上围着地球绕圈，不应该是个正圆吗？为什么还是“丝带”状缠起来了？我看别人做的是正圆。</p>
<p>这是一个很好的问题！</p>
<p>因为我们在<code>_getSatellitePositionProperty</code>函数中，计算卫星采样位置的时候，最后转换成了<code>地固坐标系（ECEF）</code>。而之前那些正圆，可以实现首尾相连的使用的是<code>惯性坐标系（ECI）</code></p>
<p>看之前我们写的代码可以看出来，我们拿到<code>惯性坐标</code>后转成了<code>地固坐标</code>。</p>
<h5 data-id="heading-14">那么 惯性坐标 和 地固坐标 的区别是什么？</h5>
<p><code>惯性坐标（ECI）</code>和<code>地固坐标</code>都是用来描述卫星、航天器等空间物体位置的两种核心坐标系，核心<code>区别在于是否随地球自转</code>，适用场景也因此不同。</p>
<p><strong>惯性坐标</strong>：地面上的固定点（如北京）的坐标会随地球自转而持续变化（每天绕 Z 轴旋转一圈）；卫星的坐标变化仅由其自身轨道运动导致（如近地卫星沿椭圆轨道运动）。</p>
<p><strong>地固坐标</strong>：地面上的固定点（如北京）的坐标始终不变；卫星的坐标变化是其轨道运动与地球自转的 “<code>叠加效果</code>”（如卫星从西向东运动，同时地球也在自转）。</p>
<p><strong>ECI 是 “宇宙视角”：不随地球转，适合分析卫星的绝对轨道运动；
ECEF 是 “地球视角”：随地球转，适合描述物体相对于地面的位置。</strong></p>
<p>那这样的话什么时候使用<code>惯性坐标</code>，什么时候使用<code>地固坐标</code>呢？</p>
<p><code>惯性坐标适用于</code>：卫星<code>轨道力学分析</code>、<code>轨道设计</code>、<code>航天器导航</code>（需计算<code>绝对运动</code>）。卫星轨道预测（如用 TLE 计算 ECI 坐标）、星际航行轨道规划、天体力学仿真。</p>
<p><code>固地坐标适用于</code>：<code>地面观测</code>、<code>通信链路分析</code>、地图匹配（需描述<code>相对地球表面的位置</code>）。卫星地面覆盖范围计算、地面站与卫星的方位角 / 仰角计算、GPS 等导航系统定位。</p>
<h5 data-id="heading-15">获取惯性坐标位置展示</h5>
<p>那上面写了<code>固地坐标</code>展示的方式，下面写一下<code>惯性坐标</code>展示的方法，其实很简单，只需要修改<code>_getSatellitePositionProperty</code>函数：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 为单个卫星计算位置属性</span>
  <span class="hljs-title function_">_getSatellitePositionProperty</span>(<span class="hljs-params">start, satelliteInfo</span>) {
    <span class="hljs-keyword">const</span> positionProperty = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">SampledPositionProperty</span>();  <span class="hljs-comment">// 位置属性</span>
    <span class="hljs-keyword">const</span> baseTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">toDate</span>(start).<span class="hljs-title function_">getTime</span>();  <span class="hljs-comment">// 开始时间的时间戳</span>
    <span class="hljs-comment">// 这样可以在保持轨迹连续性的同时大幅提高性能</span>
    <span class="hljs-keyword">const</span> sampleInterval = <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeInterval</span>;  <span class="hljs-comment">// 采样时间间隔（秒）</span>
    <span class="hljs-keyword">const</span> totalSamples = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">totalTime</span> / sampleInterval); <span class="hljs-comment">// 计算采样点数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalSamples; i++) {  <span class="hljs-comment">// 遍历每个采样点</span>
      <span class="hljs-keyword">const</span> currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseTime + i * sampleInterval * <span class="hljs-number">1000</span>);  <span class="hljs-comment">// 采样时间</span>
      <span class="hljs-keyword">const</span> sateCoord = <span class="hljs-title function_">propagate</span>(satelliteInfo.<span class="hljs-property">satrec</span>, currentTime).<span class="hljs-property">position</span>;  <span class="hljs-comment">// 计算当前时间的位置</span>
      <span class="hljs-keyword">if</span> (!sateCoord?.<span class="hljs-property">x</span> || !sateCoord?.<span class="hljs-property">y</span> || !sateCoord?.<span class="hljs-property">z</span>) {  <span class="hljs-comment">// 如果计算出的位置为空，则跳过</span>
        <span class="hljs-keyword">continue</span>
      }
      <span class="hljs-keyword">const</span> cesiumTime = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">JulianDate</span>.<span class="hljs-title function_">addSeconds</span>(start, i * sampleInterval, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">JulianDate</span>());
      <span class="hljs-keyword">const</span> cesiumPosition = {
        <span class="hljs-attr">x</span>: sateCoord.<span class="hljs-property">x</span> * <span class="hljs-number">1000</span>,
        <span class="hljs-attr">y</span>: sateCoord.<span class="hljs-property">y</span> * <span class="hljs-number">1000</span>,
        <span class="hljs-attr">z</span>: sateCoord.<span class="hljs-property">z</span> * <span class="hljs-number">1000</span>
      }
      positionProperty.<span class="hljs-title function_">addSample</span>(cesiumTime, cesiumPosition);
    }
    <span class="hljs-keyword">return</span> positionProperty;
  }
</code></pre>
<p>这就可以了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/610f5ce6290d4992a15e2841517d461f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=Kl0vye78GKPTB7qIY6w56kOgR14%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d63343ab9d7346ed8acfa49226b8f06a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763635674&amp;x-signature=sTKVWh7QU8ztqSYt8CzgMSGA4p8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这就是首尾相连的正圆了。</p>
<h3 data-id="heading-16">再说一点哈</h3>
<p>很多人可能觉得这个方式绘制星历太麻烦了，性能还不好，然后使用czml不是更好吗？我想说的是，在实际开发中会遇到各种离谱的事情，让人不得不放弃一些东西，毕竟选择的实现方式还是以实际开发后出结果为准，加油吧各位！希望对大家有用！</p>
<p>好了今天就先到这儿！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[边际成本趋近于零：如何让AI智能体"说得清、讲得明"]]></title>    <link>https://juejin.cn/post/7571815573933572159</link>    <guid>https://juejin.cn/post/7571815573933572159</guid>    <pubDate>2025-11-13T11:01:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815573933572159" data-draft-id="7571972751528640548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="边际成本趋近于零：如何让AI智能体&quot;说得清、讲得明&quot;"/> <meta itemprop="keywords" content="架构,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T11:01:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            边际成本趋近于零：如何让AI智能体"说得清、讲得明"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:01:52.000Z" title="Thu Nov 13 2025 11:01:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>人工智能的世界正以前所未有的速度向前疾驰。其中最令人瞩目的进展之一，是「生成式 AI 智能体」（Generative AI agents）的出现。</p>
<p>这些新一代的智能体，不再仅仅是生成文本、图像或代码的工具，而是能自主决策、独立行动的系统。它们正在扩展 AI 的边界，重新定义机器能做的事情。</p>
<p>本文将带你走进生成式智能体的世界，讨论它们的核心理念、实际应用，以及它们所带来的独特价值。当然，我们也无法忽视它们面临的种种挑战。</p>
<p>不过，在深入细节之前，我们先要打好基础。只有理解这些先进系统背后的基本原理，才能真正看懂它们如何改变产业格局，并开辟出新的可能性。</p>
<h2 data-id="heading-0"><strong>生成式人工智能的基本原理</strong></h2>
<h3 data-id="heading-1"><strong>生成模型</strong></h3>
<p>生成模型是人工智能“创造”能力的核心。常见的生成模型包括对抗生成网络（GAN）、变分自编码器（VAE），以及自回归模型（如 PixelRNN）。</p>
<p>要想真正理解生成式人工智能，就必须先理解这些模型。它们决定了一台机器能否像人一样去“想象”事物、生成内容。只有掌握了这套机制，我们才能构建出真正有用的生成式智能体（Generative AI Agent），让它们在不同任务中表现出创造性。</p>
<h3 data-id="heading-2"><strong>GPT 的出现</strong></h3>
<p>在理解了生成模型的基本概念之后，我们可以进一步看看最具影响力的一类模型——<strong>预训练生成式变换模型</strong>（Generative Pre-trained Transformer），简称<strong>GPT</strong>。</p>
<p>GPT 由 OpenAI 提出，它是一种能够根据提示自动生成自然语言文本的模型。简单说，你给它一句话，它就能续写一段像人写的内容。</p>
<p>这种模型如今被广泛应用在内容创作、客户服务等场景中。更有趣的是，GPT 还能“定制”——你可以为它设定具体行动、连接 API，让它去处理电子邮件、管理电商事务等。</p>
<p>从更高的层面看，GPT 不仅是一个语言模型，更是通往下一代智能系统的地基。基于它，我们可以构建出更复杂的“生成式智能体”：它们不仅能写字，还能做事——自主地完成任务、执行逻辑，成为广义上的“助手型智能”。</p>
<h2 data-id="heading-3">生成式人工智能的演进</h2>
<p>生成式人工智能这几年的变化，可以说是一部技术快速迭代的缩影。它从最初的文本生成，发展到如今能够自主执行任务的智能体，背后是持续的研究推动和技术创新。</p>
<p>早期的模型，比如 GPT-2，只是让我们第一次看到机器可以“写”出自然语言的可能性。</p>
<p>到了 GPT-3，这种能力被大幅提升。模型规模更大，理解语境的能力更强，生成的语言也更连贯，几乎可以在多数场景中模拟人的表达。</p>
<p>今天，生成式 AI 的最新阶段，是**自主智能体（Autonomous Agents）**的出现。它们不再只输出内容，而是能在一定范围内自主行动——规划、决策、执行，甚至与其他系统协作。</p>
<p>这意味着，AI 不仅能“说”，还开始“做”。它正在渗透到各个行业，帮助企业自动化复杂流程，提高效率，重塑生产方式。</p>
<p>如果说早期的生成模型只是“语言工具”，那么现在的智能体，更像是有一定目标意识的“数字劳动力”。未来，它们可能会成为数字世界的基础设施。</p>
<h2 data-id="heading-4"><strong>什么是生成式 AI 智能体？</strong></h2>
<p>我们先来理解一下「生成式 AI 智能体」这个概念。</p>
<p>它是一类比传统 AI 模型更高级的系统，把像 GPT 这样的生成式模型能力，与自主决策和执行功能结合在一起。简单来说，它不仅能“生成内容”，还可以“自主行动”。</p>
<p>生成式 AI 智能体能做的事情相当广泛，比如分析数据、制定决策、执行特定任务等。与以往只能输出文本或图像的生成模型不同，它具备完整的任务规划与执行能力：能自己设定目标、监控输出结果，并根据新的信息调整行动。这种独立运行的能力，让它在很多领域都非常有价值。</p>
<p>更具体一点，生成式 AI 智能体的特点在于：</p>
<p>它不只是生成输出，而是能基于输出进一步行动。它可以自动分析数据，做出判断，并根据分析结果采取下一步操作。</p>
<p>这种从「生成」到「执行」的一体化设计，使它能够完成复杂的工作流程——从最初的数据处理，到最后的任务落地，都能独立完成。</p>
<p>当生成能力与自主行动结合，生成式 AI 智能体就不仅仅是一种技术工具，而是一类具有潜在“智能协作者”特征的系统。它有望改变多个行业的工作方式——无论是医疗、金融，还是客户服务，都能因此变得更高效、更精准，也更具创造力。</p>
<p>理解这样的智能体，意味着理解下一代人工智能的方向——如何让机器不仅能“思考”，还能“行动”；不仅能“输出”，还能“完成”。这正是未来 AI 应用的关键所在。</p>
<h3 data-id="heading-5">提示生成与执行框架</h3>
<p>在打造高效 AI Agent 的过程中，能否妥善生成并执行 Prompt 至关重要。所谓提示生成与执行框架（Prompt Generation and Execution Framework），就是为此提供一条完整的工作流程：如何构建 Prompt、如何处理异常、以及如何通过反馈回路实现持续改进。它确保了 AI Agent 能够精准理解用户输入，并给出可靠回应。</p>
<p><strong>这个框架的主要步骤包括：</strong></p>
<ol>
<li>分析之前阶段的输出，明确当前所需信息。</li>
<li>按照既定格式构建 Prompt，确保逻辑清晰。</li>
<li>最终确定可执行的 Prompt，并投入执行。</li>
</ol>
<p>通过这套流程，AI Agent 能够在用户指定的指令下自主完成各类任务。从需求分析到最终执行，每一步都紧密衔接，让 AI 能不断学习、优化与成长。</p>
<h2 data-id="heading-6">生成式 AI 智能体是如何运作的？</h2>
<p>生成式 AI 智能体，是一种能够<strong>自主完成复杂任务</strong>的智能系统。它将「生成模型」（Generative Models）与「多智能体框架」（Multi-Agent Framework）结合在一起，从接收任务到产出结果，全过程几乎无需人工干预。</p>
<p>在执行过程中，它不仅能适应新的信息，还能根据用户的反馈不断修正输出。</p>
<p>可以把它想象成一个小型团队：有人负责计划、有人分析数据、有人检验结果，而背后都有一个“经理”在统筹全局。整个系统协同运行，形成自洽的智能工作流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b9c39974d9145ab8b14a9cc68a1f3e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763636511&amp;x-signature=pzNL5Y3zknyFkhquhoyW52nfd3Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">1、用户输入（User Prompt）</h3>
<p>一切从用户的一句话开始。</p>
<p>用户以自然语言提出需求，比如生成一份报告、分析某组数据，或者执行某个动作。</p>
<h3 data-id="heading-8">2、任务理解与执行（Interpretation &amp; Execution）</h3>
<p>AI 系统首先“理解”这条指令，然后制定一份完整的工作方案。</p>
<p>在这个过程中，有一个「经理智能体」（Manager Agent）负责协调全局，它会把任务拆解成多个子任务，分派给不同的「专家智能体」。</p>
<p>这些专家智能体通常包括：</p>
<ul>
<li><strong>分析智能体（Analyst Agent）</strong> ：从多种数据源收集、整理并分析信息；</li>
<li><strong>检验智能体（Checker Agent）</strong> ：负责核实数据的准确性，校对中间结果；</li>
<li><strong>规划智能体（Planner Agent）</strong> ：协调各个部分的流程，确保工作方向一致。</li>
</ul>
<p>这些 Agent 可以访问内部数据库或外部系统，取数、分析、整合，一步步构建完整的结果。</p>
<p>不同的智能体之间会交互信息，互相补充，确保整体协作顺畅无误。</p>
<h3 data-id="heading-9">3、初稿生成与共享（Draft Output Sharing）</h3>
<p>当所有子任务完成后，经理智能体会整合成果，生成初稿。</p>
<p>这个初稿是依据现有信息完成的“第一次尝试”，随后会提交给用户审阅。</p>
<h3 data-id="heading-10">4、反馈与迭代（Feedback &amp; Iteration）</h3>
<p>用户查看初稿，提出修改意见或新的需求。</p>
<p>系统再据此迭代更新，优化输出内容。</p>
<p>如此循环往复，直到结果满足用户预期。</p>
<p>这套循环机制，使得生成式 AI 智能体能在反馈中不断自我改进，越做越准、越做越好。</p>
<h2 data-id="heading-11"><strong>生成式 AI 智能体的应用</strong></h2>
<p>生成式 AI 的出现，使得“智能体”（Agent）这一概念正在迅速落地。不同于传统的自动化工具，AI 智能体更像是一个能够理解目标、主动行动、持续改进的“数字同事”。以下是它们在各个领域的典型应用场景。</p>
<h3 data-id="heading-12"><strong>1、客户服务</strong></h3>
<p>AI 智能体可以独立处理客户咨询，实现即时响应与自动化问题解决。</p>
<p>它的好处显而易见：既能减轻人工负担，又能提升客户体验。对企业而言，这意味着服务效率的提升；对用户而言，这意味着更迅速的帮助和更稳定的体验。</p>
<h3 data-id="heading-13"><strong>2、制造业</strong></h3>
<p>在数字化工厂中，AI 调度智能体可以模拟不同的生产场景，评估各种排产方案的成本、速度与交付稳定性。</p>
<p>通过这种方式，系统能自动找到兼顾效率与成本的最佳路径，实现生产线的动态优化：既能按时交付，又能减少切换损耗。</p>
<p>它不只是“反应式”的调度助理，更是一个能主动优化的运营伙伴。</p>
<h3 data-id="heading-14"><strong>3、内容生产与管理</strong></h3>
<p>在内容行业，AI 智能体已经成为新的创作伙伴。</p>
<p>它们可以生成文字、图片、视频内容，也能管理社交媒体账号，观察趋势数据，撰写吸引人的帖子，并自动安排发布时间。</p>
<p>过去需要整支团队完成的任务，如今一个智能体就能胜任。这让内容创作真正具备了“规模化”的可能。</p>
<h3 data-id="heading-15"><strong>4、医疗健康</strong></h3>
<p>在医疗领域，AI 智能体正从辅助医生的工具，逐渐演变为“数字医疗助手”。</p>
<p>它可以分析患者数据，辅助诊断病情，甚至根据个体差异制定个性化治疗方案。</p>
<p>更重要的是，它能提前识别潜在风险，给出预防性建议，从“治病”走向“防病”。</p>
<h3 data-id="heading-16"><strong>5、金融服务</strong></h3>
<p>在金融行业，AI 智能体被用于风险控制、欺诈检测与自动化交易。</p>
<p>它们能在实时数据流中识别异常模式，评估潜在风险，并执行决策。</p>
<p>相较传统模型，智能体的优势不仅在于速度，更在于“洞察”——通过持续学习，它们能不断优化投资策略，提升资产回报。</p>
<h2 data-id="heading-17"><strong>生成式 AI 智能体的优势</strong></h2>
<h3 data-id="heading-18"><strong>1、效率与生产力</strong></h3>
<p>生成式 AI 的最大价值在于“解放人力”。</p>
<p>那些重复、琐碎又耗时的流程，AI 可以自动完成，让人类有更多精力专注于策略、创造与决策。</p>
<p>结果是：组织的效率提升了，生产力也显著提高。无论是制造、金融还是服务业，几乎都能从中受益。</p>
<h3 data-id="heading-19"><strong>2、可扩展性</strong></h3>
<p>AI 智能体可以同时处理多项任务，并在工作量增加时保持运转，而无需相应增加人力和成本。</p>
<p>这种“边际成本趋近于零”的特性，使大型企业在扩张时具备了前所未有的灵活性。</p>
<p>过去扩张靠人，现在扩张靠算力。</p>
<h3 data-id="heading-20"><strong>3、准确与一致</strong></h3>
<p>人与人工作状态不同，而 AI 的表现却稳定且可重复。</p>
<p>在金融、医疗等高风险领域，AI 的高准确性与一致性尤为重要。</p>
<p>一个不会疲劳、不会分心、不会出错的“助手”，能极大提高决策的可靠性。</p>
<h3 data-id="heading-21"><strong>4、实时决策</strong></h3>
<p>AI 的强项在于“快速洞察”。</p>
<p>它能在海量数据流中实时分析并作出判断，从而支持即时决策。</p>
<p>在环境多变、竞争激烈的场景下——比如股市交易、供应链管理——这种即时响应能力往往就是成败关键。</p>
<h2 data-id="heading-22"><strong>生成式 AI 面临的挑战与风险</strong></h2>
<p>生成式 AI 的前景令人兴奋，但越是强大的技术，越需要谨慎使用。</p>
<p>它带来的问题，也必须正面面对。</p>
<h3 data-id="heading-23"><strong>1、数据隐私与安全</strong></h3>
<p>AI 智能体往往需要处理敏感数据。如何保护隐私、防止泄露，是第一要务。</p>
<p>企业必须建立完善的安全体系，确保数据不被滥用或非法访问。</p>
<p>一旦出现漏洞，后果不仅是技术问题，更是信任危机。</p>
<h3 data-id="heading-24"><strong>2、偏见与公平</strong></h3>
<p>AI 学习的是人类数据，而人类的数据本身就包含偏见。</p>
<p>如果不加纠正，AI 可能会“忠实”地放大这些偏差。</p>
<p>要让 AI 公平，就意味着在算法层面不断地校正与监督，确保不同群体都能被平等对待。</p>
<h3 data-id="heading-25"><strong>3、可解释性与透明度</strong></h3>
<p>很多 AI 系统像一个黑箱，连开发者有时也难以解释为什么它会做出某个决定。</p>
<p>要让社会信任 AI，我们需要更高的透明度。</p>
<p>简单来说，AI 必须“说得清、讲得明”，否则就难以承担关键领域的责任。</p>
<h2 data-id="heading-26"><strong>未来展望</strong></h2>
<p>生成式 AI 智能体的未来值得期待。</p>
<p>研究仍在快速推进，企业也不断加大投入，希望在新一轮智能化浪潮中占据优势。</p>
<p>正如**BCG（波士顿咨询集团）**在《GPT 只是开始，自治智能体正在到来》一文中指出的：</p>
<p>在未来几年，能够独立执行复杂任务的自治智能体将走向主流。</p>
<p>对企业来说，接下来的关键是<strong>提前布局</strong>：</p>
<ul>
<li>制定清晰的转型路线图，</li>
<li>投资基础设施与数字人才，</li>
<li>为自动化与智能化的融合做好准备。</li>
</ul>
<p>这场变革不会一夜之间发生，但正在悄然加速。</p>
<p>谁能理解趋势、拥抱技术，谁就能在下一轮竞争中占得先机。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果]]></title>    <link>https://juejin.cn/post/7571768210715820047</link>    <guid>https://juejin.cn/post/7571768210715820047</guid>    <pubDate>2025-11-13T09:15:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715820047" data-draft-id="7571815997067640872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果"/> <meta itemprop="keywords" content="前端,Webpack,rollup.js"/> <meta itemprop="datePublished" content="2025-11-13T09:15:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack 与 Rollup 中 Tree-shaking 的实现原理与效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:15:22.000Z" title="Thu Nov 13 2025 09:15:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Tree-shaking 是现代前端构建工具中用于消除死代码（未被使用的代码）的重要优化手段，核心原理是利用 ES6 模块的静态特性（<code>import</code>/<code>export</code>）分析代码依赖，剔除未被引用的导出内容。</p>
<h3 data-id="heading-0">一、Tree-shaking 核心前提</h3>
<p>Tree-shaking 仅对 <strong>ES6 模块（ESM）</strong>  有效，因为 ESM 具有以下静态特性：</p>
<ul>
<li>模块依赖关系在编译时确定（而非运行时）。</li>
<li><code>import</code>/<code>export</code> 语句只能出现在模块顶层，无法动态修改。</li>
</ul>
<p>CommonJS 模块（<code>require</code>/<code>module.exports</code>）因依赖关系动态化，无法被 Tree-shaking 优化。</p>
<h3 data-id="heading-1">二、Rollup 中的 Tree-shaking</h3>
<p>Rollup 是专注于 ES 模块打包的工具，Tree-shaking 是其原生核心功能，实现简洁且高效。</p>
<h4 data-id="heading-2">1. 实现原理</h4>
<p>Rollup 通过以下步骤实现 Tree-shaking：</p>
<ol>
<li><strong>依赖解析</strong>：遍历模块的 <code>import</code>/<code>export</code> 语句，构建模块依赖图。</li>
<li><strong>标记未使用代码</strong>：从入口模块出发，追踪所有被引用的导出（<code>export</code>），未被引用的导出被标记为 “死代码”。</li>
<li><strong>删除死代码</strong>：在打包阶段直接剔除标记的死代码，不生成冗余内容。</li>
</ol>
<p>Rollup 对代码的静态分析更彻底，且默认输出未被混淆的代码，因此 Tree-shaking 效果直观可见。</p>
<h4 data-id="heading-3">2. 代码示例与效果</h4>
<h5 data-id="heading-4">源文件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js（ES 模块）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">minus</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b; <span class="hljs-comment">// 未被使用的函数</span>

<span class="hljs-comment">// index.js（入口文件）</span>
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 仅使用 add</span>
</code></pre>
<h5 data-id="heading-5">Rollup 配置（<code>rollup.config.js</code>）</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  input: <span class="hljs-string">'src/index.js'</span>,
  output: {
    file: <span class="hljs-string">'dist/bundle.js'</span>,
    format: <span class="hljs-string">'es'</span> <span class="hljs-comment">// 输出 ES 模块（保留 import/export，便于观察）</span>
  }
};
</code></pre>
<h5 data-id="heading-6">打包结果（<code>dist/bundle.js</code>）</h5>
<pre><code class="hljs language-css" lang="css">const add = (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) =&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>;
console<span class="hljs-selector-class">.log</span>(add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<ul>
<li><strong>效果</strong>：未被使用的 <code>minus</code> 函数被完全剔除，输出代码简洁。</li>
</ul>
<h3 data-id="heading-7">三、Webpack 中的 Tree-shaking</h3>
<p>Webpack 从 v2 开始支持 Tree-shaking，但实现逻辑更复杂，受多种因素影响（如模式、压缩工具等）。</p>
<h4 data-id="heading-8">1. 实现原理</h4>
<p>Webpack 的 Tree-shaking 分为三个阶段：</p>
<ol>
<li>
<p><strong>标记阶段</strong>：</p>
<ul>
<li>解析 ES 模块的 <code>import</code>/<code>export</code>，通过 <code>ModuleConcatenationPlugin</code> 分析模块依赖。</li>
<li>对未被引用的导出标记为 <code>/* unused harmony export xxx */</code>（仅标记，不删除）。</li>
</ul>
</li>
<li>
<p><strong>删除阶段</strong>：</p>
<ul>
<li>依赖 <strong>压缩工具（如 Terser）</strong>  剔除标记的死代码。</li>
<li>仅在 <code>production</code> 模式下默认启用（开发模式为保留代码不删除）。</li>
</ul>
</li>
<li>
<p><strong>副作用处理</strong>：</p>
<ul>
<li>通过 <code>package.json</code> 的 <code>sideEffects</code> 字段标记模块是否有副作用（如全局变量修改、DOM 操作），避免误删有副作用的代码。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">2. 代码示例与效果</h4>
<h5 data-id="heading-10">源文件（同 Rollup 示例）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">minus</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b; <span class="hljs-comment">// 未被使用</span>

<span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<h5 data-id="heading-11">Webpack 配置（<code>webpack.config.js</code>）</h5>
<pre><code class="hljs language-css" lang="css">module<span class="hljs-selector-class">.exports</span> = {
  entry: <span class="hljs-string">'./src/index.js'</span>,
  output: {
    filename: <span class="hljs-string">'bundle.js'</span>,
    path: path.<span class="hljs-built_in">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>)
  },
  mode: <span class="hljs-string">'production'</span> // 必须为 production 模式才会删除死代码
};
</code></pre>
<h5 data-id="heading-12">打包结果（<code>dist/bundle.js</code>，简化后）</h5>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// add(1,2) 被直接计算，minus 完全删除</span>
</code></pre>
<ul>
<li><strong>效果</strong>：未被使用的 <code>minus</code> 被剔除，且 <code>add</code> 函数因逻辑简单被进一步优化（直接计算结果）。</li>
</ul>
<h4 data-id="heading-13">3. 关键配置：<code>sideEffects</code></h4>
<p>如果模块存在副作用（如修改全局变量），需在 <code>package.json</code> 中声明，避免被误删：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"./src/polyfill.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 有副作用的模块</span>
    <span class="hljs-string">"*.css"</span> <span class="hljs-comment">// CSS 文件通常有副作用（插入样式）</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>sideEffects: false</code>：表示所有模块均无副作用，可安全删除未引用代码。</li>
</ul>
<h3 data-id="heading-14">四、核心差异对比</h3>



































<table><thead><tr><th>特性</th><th>Rollup</th><th>Webpack</th></tr></thead><tbody><tr><td><strong>分析能力</strong></td><td>原生支持 ESM 静态分析，更彻底</td><td>需依赖插件（<code>ModuleConcatenationPlugin</code>），分析逻辑较复杂</td></tr><tr><td><strong>删除死代码时机</strong></td><td>打包阶段直接删除</td><td>依赖压缩工具（Terser）在优化阶段删除</td></tr><tr><td><strong>开发模式效果</strong></td><td>即使开发模式也会删除死代码</td><td>仅 <code>production</code> 模式删除（开发模式保留用于调试）</td></tr><tr><td><strong>输出可读性</strong></td><td>输出代码接近源码，Tree-shaking 效果直观</td><td>输出代码经压缩混淆，效果需反推</td></tr><tr><td><strong>适用场景</strong></td><td>库文件打包（如工具库、组件库）</td><td>应用程序打包（依赖复杂、需处理多种模块类型）</td></tr></tbody></table>
<h3 data-id="heading-15">五、总结</h3>
<ul>
<li><strong>Rollup</strong>：Tree-shaking 实现简洁高效，输出代码干净，适合库文件打包（如 React、Vue 等）。</li>
<li><strong>Webpack</strong>：Tree-shaking 需配合压缩工具和模式配置，功能更全面（支持多种模块类型、复杂依赖），适合应用程序打包。</li>
</ul>
<h3 data-id="heading-16">六、直观点</h3>
<ul>
<li>整个过程就像 “清理房间”：先摸清房间里的物品（依赖解析）→ 标记没用的垃圾（标记死代码）→ 直接扔掉垃圾（删除死代码）；</li>
<li>对比 Webpack ：Rollup 是 “边打包边扔垃圾”，Webpack 是 “先标记垃圾，最后找清洁工（Terser）扔”，所以 Rollup 的产物更直观看到剔除效果。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-4]]></title>    <link>https://juejin.cn/post/7571678674144854026</link>    <guid>https://juejin.cn/post/7571678674144854026</guid>    <pubDate>2025-11-12T12:47:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678674144854026" data-draft-id="7571088527678275610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-4"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-12T12:47:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T12:47:15.000Z" title="Wed Nov 12 2025 12:47:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 最激动人心的部分——<strong>协程</strong>和<strong>现代异步编程</strong>。这将彻底改变你处理并发和异步任务的方式。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 协程：重新定义异步编程</strong></h3>
<h4 data-id="heading-1"><strong>二十二、协程基础：轻量级线程</strong></h4>
<p>协程是 Kotlin 用于异步编程的解决方案，比线程更轻量、更高效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"主线程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    
    <span class="hljs-comment">// 启动一个协程</span>
    GlobalScope.launch {
        println(<span class="hljs-string">"协程开始: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 非阻塞延迟</span>
        println(<span class="hljs-string">"协程结束: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    }
    
    println(<span class="hljs-string">"主线程继续执行: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    Thread.sleep(<span class="hljs-number">2000L</span>) <span class="hljs-comment">// 阻塞主线程，等待协程完成</span>
    println(<span class="hljs-string">"主线程结束"</span>)
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 主线程开始: main</span>
<span class="hljs-comment">// 主线程继续执行: main</span>
<span class="hljs-comment">// 协程开始: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 协程结束: DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// 主线程结束</span>
</code></pre>
<p><strong>关键概念：</strong></p>
<ul>
<li><code>launch</code>: 启动一个不返回结果的协程</li>
<li><code>delay()</code>: 非阻塞的挂起函数</li>
<li>协程运行在后台线程池，不会阻塞主线程</li>
</ul>
<h4 data-id="heading-2"><strong>二十三、挂起函数：异步操作的基石</strong></h4>
<p>挂起函数是协程的核心，用 <code>suspend</code>关键字标记。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserData</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1000L</span>) <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的数据"</span>
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: String {
    delay(<span class="hljs-number">1500L</span>) <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 的帖子"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> userData = fetchUserData(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> userPosts = fetchUserPosts(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"顺序执行耗时: <span class="hljs-subst">${time}</span>ms"</span>)
}
</code></pre>
<h4 data-id="heading-3"><strong>二十四、异步并发：同时执行多个任务</strong></h4>
<p>使用 <code>async</code>和 <code>await</code>实现并发操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-comment">// 同时启动两个异步任务</span>
        <span class="hljs-keyword">val</span> userDataDeferred = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPostsDeferred = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-comment">// 等待两个任务都完成</span>
        <span class="hljs-keyword">val</span> userData = userDataDeferred.await()
        <span class="hljs-keyword">val</span> userPosts = userPostsDeferred.await()
        
        println(<span class="hljs-string">"<span class="hljs-variable">$userData</span>, <span class="hljs-variable">$userPosts</span>"</span>)
    }
    println(<span class="hljs-string">"并发执行耗时: <span class="hljs-subst">${time}</span>ms"</span>) <span class="hljs-comment">// 时间接近最长任务的时间</span>
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 用户 1 的数据, 用户 1 的帖子</span>
<span class="hljs-comment">// 并发执行耗时: 1506ms (而不是 1000 + 1500 = 2500ms)</span>
</code></pre>
<h4 data-id="heading-4"><strong>二十五、协程上下文与调度器</strong></h4>
<p>控制协程在哪个线程上运行。</p>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 在不同调度器上启动协程</span>
    launch { <span class="hljs-comment">// 继承父协程的上下文</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Unconfined) { <span class="hljs-comment">// 不受限制，在第一个挂起点之前运行在调用者线程</span>
        <span class="hljs-built_in">println</span>("不受限制: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.Default) { <span class="hljs-comment">// CPU 密集型任务</span>
        <span class="hljs-built_in">println</span>("默认调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(Dispatchers.IO) { <span class="hljs-comment">// I/O 密集型任务</span>
        <span class="hljs-built_in">println</span>("IO 调度器: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
    
    <span class="hljs-built_in">launch</span>(newSingleThreadContext("MyThread")) { <span class="hljs-comment">// 专用线程</span>
        <span class="hljs-built_in">println</span>("专用线程: ${Thread.currentThread()<span class="hljs-selector-class">.name</span>}")
    }
}
</code></pre>
<h4 data-id="heading-5"><strong>二十六、结构化并发：避免资源泄漏</strong></h4>
<p>使用 <code>coroutineScope</code>实现结构化并发。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 结构化并发：所有子协程完成后，父协程才完成</span>
    <span class="hljs-keyword">val</span> result = coroutineScope {
        <span class="hljs-keyword">val</span> userData = async { fetchUserData(<span class="hljs-number">1</span>) }
        <span class="hljs-keyword">val</span> userPosts = async { fetchUserPosts(<span class="hljs-number">1</span>) }
        
        <span class="hljs-string">"结果: <span class="hljs-subst">${userData.await()}</span> + <span class="hljs-subst">${userPosts.await()}</span>"</span>
    }
    println(result)
}

<span class="hljs-comment">// 处理异常的结构化并发</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataSafely</span><span class="hljs-params">()</span></span>: Result&lt;String&gt; = coroutineScope {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = async { 
            delay(<span class="hljs-number">500L</span>)
            <span class="hljs-keyword">if</span> (System.currentTimeMillis() % <span class="hljs-number">2</span> == <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"模拟错误"</span>)
            }
            <span class="hljs-string">"获取的数据"</span>
        }.await()
        Result.success(<span class="hljs-keyword">data</span>)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        Result.failure(e)
    }
}
</code></pre>
<h4 data-id="heading-6"><strong>二十七、流（Flow）：异步数据流</strong></h4>
<p>Flow 是 Kotlin 的响应式流处理，类似 RxJava。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*

<span class="hljs-comment">// 创建流</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"流开始"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟异步工作</span>
        emit(i) <span class="hljs-comment">// 发射值</span>
    }
}

<span class="hljs-comment">// 流的中间操作</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processNumbers</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
        emit(i)
    }
}.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> } <span class="hljs-comment">// 过滤偶数</span>
 .map { <span class="hljs-string">"数字: <span class="hljs-variable">$it</span>"</span> }    <span class="hljs-comment">// 转换</span>
 .onEach { println(<span class="hljs-string">"处理: <span class="hljs-variable">$it</span>"</span>) } <span class="hljs-comment">// 副作用</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 收集流</span>
    simpleFlow().collect { value -&gt; 
        println(<span class="hljs-string">"收集到: <span class="hljs-variable">$value</span>"</span>) 
    }
    
    println(<span class="hljs-string">"--- 带中间操作的流 ---"</span>)
    processNumbers().collect { println(<span class="hljs-string">"最终结果: <span class="hljs-variable">$it</span>"</span>) }
}
</code></pre>
<h4 data-id="heading-7"><strong>二十八、通道（Channel）：协程间通信</strong></h4>
<p>Channel 用于协程之间的通信。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> channel = Channel&lt;String&gt;()
    
    <span class="hljs-comment">// 生产者协程</span>
    launch {
        <span class="hljs-keyword">val</span> users = listOf(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>)
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> users) {
            channel.send(user) <span class="hljs-comment">// 发送数据</span>
            delay(<span class="hljs-number">100L</span>)
        }
        channel.close() <span class="hljs-comment">// 关闭通道</span>
    }
    
    <span class="hljs-comment">// 消费者协程</span>
    launch {
        <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> channel) { <span class="hljs-comment">// 接收数据</span>
            println(<span class="hljs-string">"收到用户: <span class="hljs-variable">$user</span>"</span>)
        }
        println(<span class="hljs-string">"通道已关闭"</span>)
    }
}
</code></pre>
<h4 data-id="heading-8"><strong>二十九、实战：构建完整的异步应用</strong></h4>
<p>让我们构建一个完整的用户信息获取系统。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*
<span class="hljs-keyword">import</span> kotlin.system.measureTimeMillis

<span class="hljs-comment">// 数据类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Post</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> userId: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> title: String, <span class="hljs-keyword">val</span> content: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> user: User, <span class="hljs-keyword">val</span> posts: List&lt;Post&gt;, <span class="hljs-keyword">val</span> friends: List&lt;User&gt;)

<span class="hljs-comment">// 模拟远程数据源</span>
<span class="hljs-keyword">object</span> UserRepository {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: User {
        delay(<span class="hljs-number">500L</span>) <span class="hljs-comment">// 模拟网络延迟</span>
        <span class="hljs-keyword">return</span> User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>)
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserPosts</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;Post&gt; {
        delay(<span class="hljs-number">300L</span>)
        <span class="hljs-keyword">return</span> listOf(
            Post(<span class="hljs-number">1</span>, userId, <span class="hljs-string">"标题1"</span>, <span class="hljs-string">"内容1"</span>),
            Post(<span class="hljs-number">2</span>, userId, <span class="hljs-string">"标题2"</span>, <span class="hljs-string">"内容2"</span>)
        )
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserFriends</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: List&lt;User&gt; {
        delay(<span class="hljs-number">400L</span>)
        <span class="hljs-keyword">return</span> listOf(
            User(userId + <span class="hljs-number">1</span>, <span class="hljs-string">"朋友1"</span>, <span class="hljs-string">"friend1@example.com"</span>),
            User(userId + <span class="hljs-number">2</span>, <span class="hljs-string">"朋友2"</span>, <span class="hljs-string">"friend2@example.com"</span>)
        )
    }
}

<span class="hljs-comment">// 业务逻辑层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: UserProfile = coroutineScope {
        <span class="hljs-keyword">val</span> userDeferred = async { UserRepository.getUser(userId) }
        <span class="hljs-keyword">val</span> postsDeferred = async { UserRepository.getUserPosts(userId) }
        <span class="hljs-keyword">val</span> friendsDeferred = async { UserRepository.getUserFriends(userId) }
        
        UserProfile(
            user = userDeferred.await(),
            posts = postsDeferred.await(),
            friends = friendsDeferred.await()
        )
    }
    
    <span class="hljs-comment">// 使用 Flow 实现实时更新</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProfileStream</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;UserProfile&gt; = flow {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">val</span> profile = getUserProfile(userId)
            emit(profile)
            delay(<span class="hljs-number">5000L</span>) <span class="hljs-comment">// 每5秒更新一次</span>
        }
    }
}

<span class="hljs-comment">// UI 层（模拟）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userService = UserService()
    
    println(<span class="hljs-string">"=== 获取用户资料 ==="</span>)
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        <span class="hljs-keyword">val</span> profile = userService.getUserProfile(<span class="hljs-number">1</span>)
        println(<span class="hljs-string">"用户: <span class="hljs-subst">${profile.user.name}</span>"</span>)
        println(<span class="hljs-string">"帖子数量: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        println(<span class="hljs-string">"好友数量: <span class="hljs-subst">${profile.friends.size}</span>"</span>)
    }
    println(<span class="hljs-string">"耗时: <span class="hljs-subst">${time}</span>ms"</span>)
    
    println(<span class="hljs-string">"\n=== 实时数据流 ==="</span>)
    <span class="hljs-comment">// 模拟实时数据流（只收集3次）</span>
    userService.getUserProfileStream(<span class="hljs-number">1</span>)
        .take(<span class="hljs-number">3</span>) <span class="hljs-comment">// 只取3个值</span>
        .collect { profile -&gt;
            println(<span class="hljs-string">"实时更新: <span class="hljs-subst">${profile.user.name}</span> - 帖子: <span class="hljs-subst">${profile.posts.size}</span>"</span>)
        }
}
</code></pre>
<h4 data-id="heading-9"><strong>三十、异常处理与超时控制</strong></h4>
<pre><code class="hljs language-scss" lang="scss">import kotlinx<span class="hljs-selector-class">.coroutines</span>.*

fun <span class="hljs-selector-tag">main</span>() = runBlocking {
    <span class="hljs-comment">// 1. 基本的异常处理</span>
    val job = launch {
        try {
            <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
            throw <span class="hljs-built_in">RuntimeException</span>("测试异常")
        } catch (e: Exception) {
            <span class="hljs-built_in">println</span>("捕获异常: ${e.message}")
        }
    }
    job<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 2. 协程异常处理器</span>
    val handler = CoroutineExceptionHandler { _, exception -&gt;
        <span class="hljs-built_in">println</span>("协程异常处理器捕获: ${exception.message}")
    }
    
    val job2 = <span class="hljs-built_in">launch</span>(handler) {
        throw <span class="hljs-built_in">RuntimeException</span>("被处理器捕获的异常")
    }
    job2<span class="hljs-selector-class">.join</span>()
    
    <span class="hljs-comment">// 3. 超时控制</span>
    try {
        <span class="hljs-built_in">withTimeout</span>(<span class="hljs-number">1300</span>L) {
            repeat(<span class="hljs-number">1000</span>) { <span class="hljs-selector-tag">i</span> -&gt;
                <span class="hljs-built_in">println</span>("任务 $i")
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>L)
            }
        }
    } catch (e: TimeoutCancellationException) {
        <span class="hljs-built_in">println</span>("任务超时")
    }
    
    <span class="hljs-comment">// 4. 超时返回默认值</span>
    val result = <span class="hljs-built_in">withTimeoutOrNull</span>(<span class="hljs-number">1300</span>L) {
        <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>L)
        "成功结果"
    } ?: <span class="hljs-string">"超时默认值"</span>
    
    <span class="hljs-built_in">println</span>(<span class="hljs-string">"结果: $result"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>三十一、高级模式：生产者-消费者模式</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">produceUsers</span><span class="hljs-params">()</span></span> = produce {
    <span class="hljs-keyword">var</span> id = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        send(User(id, <span class="hljs-string">"用户<span class="hljs-variable">$id</span>"</span>, <span class="hljs-string">"user<span class="hljs-variable">$id</span>@example.com"</span>))
        delay(<span class="hljs-number">200L</span>)
        id++
        <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">5</span>) <span class="hljs-keyword">break</span> <span class="hljs-comment">// 只生产5个用户</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">processUser</span><span class="hljs-params">(userChannel: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> = produce {
    <span class="hljs-keyword">for</span> (user <span class="hljs-keyword">in</span> userChannel) {
        delay(<span class="hljs-number">100L</span>) <span class="hljs-comment">// 模拟处理时间</span>
        send(<span class="hljs-string">"已处理: <span class="hljs-subst">${user.name}</span>"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> userProducer = produceUsers()
    <span class="hljs-keyword">val</span> processor = processUser(userProducer)
    
    <span class="hljs-comment">// 消费处理结果</span>
    <span class="hljs-keyword">for</span> (result <span class="hljs-keyword">in</span> processor) {
        println(result)
    }
    
    println(<span class="hljs-string">"处理完成"</span>)
}
</code></pre>
<h4 data-id="heading-11"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 协程的核心概念！接下来可以探索：</p>
<ol>
<li><strong>Flow 高级操作</strong>：<code>combine</code>、<code>zip</code>、<code>flatMapLatest</code>等操作符</li>
<li><strong>状态管理</strong>：使用 <code>StateFlow</code>和 <code>SharedFlow</code></li>
<li><strong>测试协程</strong>：使用 <code>TestCoroutineDispatcher</code>和 <code>runTest</code></li>
<li><strong>Android 上的协程</strong>：与 ViewModel、Lifecycle 集成</li>
<li><strong>服务端协程</strong>：Ktor 框架的使用</li>
</ol>
<p>协程是 Kotlin 生态中最强大的特性之一，它将彻底改变你处理异步编程的方式。尝试在实际项目中使用这些模式，你会发现代码变得更加简洁和易于维护！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 10：08. 基于Nuxt开发博客项目-关于我页面开发]]></title>    <link>https://juejin.cn/post/7572004684178358326</link>    <guid>https://juejin.cn/post/7572004684178358326</guid>    <pubDate>2025-11-13T09:17:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572004684178358326" data-draft-id="7571808096936919081" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 10：08. 基于Nuxt开发博客项目-关于我页面开发"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-13T09:17:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 10：08. 基于Nuxt开发博客项目-关于我页面开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:17:38.000Z" title="Thu Nov 13 2025 09:17:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5056bca77be34136a2fa1fc117528418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=3Rcu7m98lM6FTqD0mK3menEz0oA%3D" alt="PixPin_2025-11-13_17-12-30.gif" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>在个人博客项目中，"关于我"页面是访客了解博主的重要窗口。一个设计合理、内容丰富的关于我页面不仅能展示个人专业能力，还能增加博客的亲和力和可信度。当然你可以完全 <code>DIY</code> 这个模块，或者也可以参考我的设计，这个页面主要包含信息卡片、个人简介、技术栈、工作经历和教育经历等模块。</p>
<p>这个是我的示例站点，在这里可以看到我目前的进度，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.csyblog.cn%2F" target="_blank" title="https://www.csyblog.cn/" ref="nofollow noopener noreferrer">www.csyblog.cn/</a></p>
<h2 data-id="heading-1">二、信息卡片</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d36b17996cce434fa3af663b698900fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=FENXJuLz3jt3xYRRfX1CSyDFcEs%3D" alt="image.png" loading="lazy"/></p>
<p>实现思路很简单，就是一些基础的布局和细节样式调整，如果实现比较手生，通过咨询<code>AI</code>也很容易完成。</p>
<p>这个模块主要是展示博主头像、基本信息和社交链接。</p>
<blockquote>
<p>如果需要源码可以通过这里的联系方式联系我，我会给你当前最新的代码。因为还不够完善，所以暂时不开源。</p>
</blockquote>
<h2 data-id="heading-2">三、个人简介</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177893abcc8549cf8c00da86f20c07df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=TnlHkfb4UpHnOtoeRUm3t8vI2I8%3D" alt="image.png" loading="lazy"/></p>
<p>这里其实就是个简短的自我介绍。</p>
<h2 data-id="heading-3">四、技术栈</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e65a44d240c944739749a71d20a2f85a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=enG9KRkB2gS4UA%2FSzzmDlH%2F4Lmw%3D" alt="image.png" loading="lazy"/></p>
<p>这个模块主要作用就是，展示一下自己的技术栈，知道的，了解的一股脑往上堆就好了。</p>
<h2 data-id="heading-4">五、工作经历&amp;教育经历</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f871f56eaad54111b2150b359a1d9081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=dH5LBIZ9RPWUs2%2BFn8wPRQp59Es%3D" alt="image.png" loading="lazy"/></p>
<p>这里我建议要么就别写，要写就写真实的，这是人与人最基本的信任，没必要打肿脸充胖子，杜撰一些华丽的履历出来，到时候经不起考验，也是搬石头砸自己的脚。</p>
<h2 data-id="heading-5">六、首页修改</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440ef09935ca4f03b523022b808bd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630277&amp;x-signature=s7Nwv4rg3GjjrDRQKz6kR2Dvte4%3D" alt="PixPin_2025-11-13_17-06-07.gif" loading="lazy"/></p>
<p>因为关于我页面我写了工作经验与教育背景，这和我之前首页展示的有重复，所以我找了个炫酷的标签云组件放这里。</p>
<h2 data-id="heading-6">七、总结</h2>
<p>这个页面比较简单，但是要从0到1做出来，还是花了我不少时间的。找图标，调样式，痛并快乐着。</p>
<p>下面我们就要进入真正的重头戏了，博客模块的开发。</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang 构建网络漏洞扫描器]]></title>    <link>https://juejin.cn/post/7571753301899182120</link>    <guid>https://juejin.cn/post/7571753301899182120</guid>    <pubDate>2025-11-13T08:47:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571753301899182120" data-draft-id="7571815997067558952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang 构建网络漏洞扫描器"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-13T08:47:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俞凡"/> <meta itemprop="url" content="https://juejin.cn/user/290747765274222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang 构建网络漏洞扫描器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290747765274222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俞凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:47:46.000Z" title="Thu Nov 13 2025 08:47:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>本文完整介绍了如何基于 Golang 从零开始开发一个完善的网络漏洞扫描器。原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Fbuilding-a-network-vulnerability-scanner-with-go" title="https://www.sitepoint.com/building-a-network-vulnerability-scanner-with-go" target="_blank" ref="nofollow noopener noreferrer">Building a Network Vulnerability Scanner with Go</a></em></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf49b7179b94dbeb43509caad6fd7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763628466&amp;x-signature=EzA9Y%2FliENriQ%2FqWo58Exa%2FmHtc%3D" alt="" loading="lazy"/></p>
<p>本文将用 Go 语言创建一个简单且相当可靠的网络漏洞扫描器。Go 语言非常适合网络编程，它在设计时就考虑到了并发性，并且拥有出色的标准库。</p>
<h2 data-id="heading-0">1. 项目设置</h2>
<h5 data-id="heading-1">创建漏洞扫描器</h5>
<p>我们想要开发一个简单的命令行工具，该工具能够扫描主机网络、查找开放端口、识别运行的服务并发现潜在漏洞。这个扫描器一开始会非常简单，但随着逐步添加功能，其能力会不断增强。</p>
<p>首先，我们将创建一个新的 Go 项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> goscan
<span class="hljs-built_in">cd</span> goscan
go mod init github.com/yourusername/goscan
</code></pre>
<p>这将为项目初始化新的Go模块，帮助我们管理依赖项。</p>
<h5 data-id="heading-2">配置包和环境</h5>
<p>扫描器将利用若干 Go 包：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"strconv"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"GoScan - Network Vulnerability Scanner"</span>)
}
</code></pre>
<p>这只是初始设置，但对于初始功能来说，已经足够了，我们会根据需要添加更多导入内容。像 <code>net</code> 这样的标准库包将负责处理大部分网络相关操作，而 <code>sync</code> 则会负责并发处理等。</p>
<h5 data-id="heading-3">网络扫描的伦理考量与风险</h5>
<p>在开始实现之前，首先需要探讨一下与网络扫描相关的伦理问题。在许多地区，未经授权的网络扫描是违法的，会被视为发动网络攻击的一种手段。因此，必须始终遵守以下规则：</p>
<ul>
<li><strong>许可</strong>：仅对拥有所有权或已获得明确许可进行扫描的临时网络和系统进行扫描。</li>
<li><strong>范围</strong>：为扫描设定明确的范围，并不要超出该范围。</li>
<li><strong>时间</strong>：不要进行可能导致服务中断或引发安全警报的过度扫描。</li>
<li><strong>披露</strong>：如果发现漏洞，请负责任的将其报告给相应的系统所有者。</li>
<li><strong>法律合规</strong>：了解并遵守有关网络扫描的当地法律。</li>
</ul>
<p>扫描工具的不当使用可能会导致法律诉讼、系统损坏或意外服务中断。我们的扫描器将包含诸如速率限制等防护措施，但最终责任在于用户以合乎道德的方式使用。</p>
<h2 data-id="heading-4">2. 简单端口扫描器</h2>
<p>漏洞评估基于端口扫描。每个开放端口所提供的潜在易受攻击的服务信息正是我们所要查找的内容。现在，让我们用 Go 语言编写一个简单的端口扫描器。</p>
<h5 data-id="heading-5">低级端口扫描实现</h5>
<p>端口扫描：尝试与目标主机上的每一个可能的端口建立连接。如果连接成功，则该端口是开放的；如果连接失败，则该端口是关闭的或被过滤的。对于此功能，Go 的 <code>net</code> 包已经为我们提供了支持。</p>
<p>那么，这就是我们所设计的一种简单的端口扫描器的示例：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> <span class="hljs-type">bool</span> {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    conn.Close()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span> <span class="hljs-comment">// Change this to your target</span>
    timeout := time.Second * <span class="hljs-number">2</span>
    
    fmt.Printf(<span class="hljs-string">"Scanning host: %s\n"</span>, host)
    
    <span class="hljs-comment">// Scan ports 1-1024 (well-known ports)</span>
    <span class="hljs-keyword">for</span> port := <span class="hljs-number">1</span>; port &lt;= <span class="hljs-number">1024</span>; port++ {
        <span class="hljs-keyword">if</span> scanPort(host, port, timeout) {
            fmt.Printf(<span class="hljs-string">"Port %d is open\n"</span>, port)
        }
    }
    
    fmt.Println(<span class="hljs-string">"Scan complete"</span>)
}
</code></pre>
<h5 data-id="heading-6">使用 <code>net</code> 包</h5>
<p>上述代码使用了 Go 语言的 <code>net</code> 包，该包提供了网络输入/输出接口及相关函数。那么，主要的组成部分都有哪些呢？</p>
<ul>
<li><strong>net.DialTimeout</strong>：此功能会尝试在设定的超时时间内连接到 TCP 网络地址。如果连接成功，会返回连接信息以及任何可能出现的错误。</li>
<li><strong>连接处理</strong>：如果连接过程顺利，我们便知道该连接已打开，并会立即关闭该连接以释放资源。</li>
<li><strong>超时参数</strong>：设定超时时间，以避免在任何被过滤的开放端口上陷入僵局。两秒是一个不错的初始值，但可根据网络状况进行调整。</li>
</ul>
<h5 data-id="heading-7">对首次扫描进行测试</h5>
<p>现在，我们在本地主机上运行简单扫描器，那里可能有一些服务正在运行。</p>
<ul>
<li>将代码保存到名为 <code>main.go</code> 的文件中</li>
<li>用 <code>go run main.go</code> 命令运行</li>
</ul>
<p>这将显示哪些本地端口是开放的。在普通开发机器上，可能会有 80（HTTP）端口、443（HTTPS）端口，或者根据运行的服务不同，还有其他任意数量的数据库端口正在使用。</p>
<p>以下是一些可能得到的示例输出：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Scanning host: localhost
Port <span class="hljs-number">22</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Port <span class="hljs-number">80</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Port <span class="hljs-number">443</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">open</span>
Scan complete
</code></pre>
<p>使用这种基本的扫描器是可以的，但也有不少明显的缺点：</p>
<ul>
<li><strong>速度</strong>：由于是按顺序扫描端口，所以速度极其缓慢。</li>
<li><strong>信息</strong>：只是告诉我们某个端口是否开放，没有服务信息。</li>
<li><strong>覆盖范围有限</strong>：只扫描前 1024 个端口。</li>
</ul>
<p>这些限制使得难以在实际应用中使用扫描器。</p>
<h2 data-id="heading-8">3. 从这里开始改进：多线程扫描</h2>
<h5 data-id="heading-9">为何最初的版本运行缓慢</h5>
<p>第一个端口扫描器能够正常工作，但其运行速度极其缓慢，几乎无法实际使用。问题在于其采用顺序扫描方法 —— 一次扫描一个端口。当一台主机有很多关闭/过滤的端口时，会在每个端口上等待连接超时，然后再转移到下一个端口，这造成了极大的时间浪费。</p>
<p>为了展示这个问题，我们来看看基本扫描器的运行时间：</p>
<ul>
<li>对于扫描前 1024 个端口的情况，如果设置 2 秒的超时时间，最长时间将达 2048 秒（超过 34 分钟）。</li>
<li>但即便对那些已关闭的端口的连接也会立即失败，这种方法由于网络延迟的原因也是效率低下。</li>
</ul>
<p>这种逐个端口进行的扫描方式是任何真正的漏洞扫描工具的瓶颈。</p>
<h5 data-id="heading-10">添加线程支持</h5>
<p>Go 语言在利用协程和通道实现并发方面表现尤为出色。因此，我们利用这些特性尝试同时扫描多个端口，从而显著提高性能。</p>
<p>现在让我们来创建多线程端口扫描器：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> Result <span class="hljs-keyword">struct</span> {
    Port  <span class="hljs-type">int</span>
    State <span class="hljs-type">bool</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> Result {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> Result{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    <span class="hljs-keyword">return</span> Result{Port: port, State: <span class="hljs-literal">true</span>}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []Result {
    <span class="hljs-keyword">var</span> results []Result
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    <span class="hljs-comment">// Create a buffered channel to collect results</span>
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, end-start+<span class="hljs-number">1</span>)
    
    <span class="hljs-comment">// Create a semaphore to limit concurrent goroutines</span>
    <span class="hljs-comment">// This prevents us from opening too many connections at once</span>
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>) <span class="hljs-comment">// Limit to 100 concurrent scans</span>
    
    <span class="hljs-comment">// Launch goroutines for each port</span>
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            <span class="hljs-comment">// Acquire semaphore</span>
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }() <span class="hljs-comment">// Release semaphore</span>
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-comment">// Close channel when all goroutines complete</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-comment">// Collect results from channel</span>
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span> <span class="hljs-comment">// Change this to your target</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Millisecond * <span class="hljs-number">500</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"Port %d is open\n"</span>, result.Port)
    }
}
</code></pre>
<h5 data-id="heading-11">多线程结果</h5>
<p>现在，我们来看看改进后扫描器的性能提升以及并发机制：</p>
<ul>
<li><strong>协程</strong>：为了使扫描过程高效，我们会为需要扫描的每个端口启动一个协程，这样当我们检查一个端口时，就可以同时检查其他端口。</li>
<li><strong>等待组</strong>：同步的等待组  当我们启动协程时，希望等待它们完成。等待组有助于跟踪所有正在运行的协程，并等待它们完成。</li>
<li><strong>结果通道</strong>：我们为所有协程的结果创建了一个缓冲通道。</li>
<li><strong>信号量模式</strong>：使用信号量来限制并行进行的扫描数量,通过通道来实现,防止我们因打开过多连接而使目标系统甚至自身机器不堪重负。</li>
<li><strong>缩短超时时间</strong>：由于以并行方式运行许多此类扫描，所以使用较短的超时时间。</li>
</ul>
<p>性能差距很大。因此，当我们实现这个功能时，可以在几分钟内扫描 1024 个端口，而且肯定不会超过半小时。</p>
<p>示例输出：</p>
<pre><code class="hljs language-python" lang="python">Scanning localhost <span class="hljs-keyword">from</span> port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed <span class="hljs-keyword">in</span> <span class="hljs-number">3.2</span>s
Found <span class="hljs-number">3</span> <span class="hljs-built_in">open</span> ports:
Port <span class="hljs-number">22</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
Port <span class="hljs-number">80</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
Port <span class="hljs-number">443</span> <span class="hljs-keyword">is</span> <span class="hljs-built_in">open</span>
</code></pre>
<p>这种多线程方法对于较大的端口范围和多个主机来说具有极好的扩展性。信号量模式确保即便要扫描上千个端口，也不会耗尽系统资源。</p>
<h2 data-id="heading-12">4. 添加服务检测</h2>
<p>既然已经有了一个快速、高效的端口扫描器，接下来的步骤就是了解那些开放端口上运行的是哪些服务。这通常被称为“服务指纹识别”或“标志抓取”，是一个连接到开放端口并检查返回数据的过程。</p>
<h5 data-id="heading-13">服务旗标抓取（Banner Grabbing）实现</h5>
<p>服务旗标抓取指的是当我们打开服务并读取发送给我们的响应（即旗标信息）时的操作。因此，这是一种很好的确认服务是否运行的方法，许多服务都会在旗标中标识自身信息。</p>
<p>我们在扫描器中加入抓取旗标的功能：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port     <span class="hljs-type">int</span>
    State    <span class="hljs-type">bool</span>
    Service  <span class="hljs-type">string</span>
    Banner   <span class="hljs-type">string</span>
    Version  <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    
    <span class="hljs-comment">// Some services need a trigger to send data</span>
    <span class="hljs-comment">// Send a simple HTTP request for web services</span>
    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\n\r\n"</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// For other services, just wait for the banner</span>
        <span class="hljs-comment">// Some services may require specific triggers</span>
    }
    
    <span class="hljs-comment">// Read the response</span>
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    <span class="hljs-comment">// Try to identify service from common ports</span>
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-comment">// SSH version detection</span>
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-comment">// HTTP server detection</span>
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-comment">// Try to find server info in format "Server: Apache/2.4.29"</span>
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:    port,
        State:   <span class="hljs-literal">true</span>,
        Service: service,
        Banner:  banner,
        Version: version,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Millisecond * <span class="hljs-number">800</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION\tBANNER"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------\t------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        bannerPreview := <span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Banner) &gt; <span class="hljs-number">30</span> {
            bannerPreview = result.Banner[:<span class="hljs-number">30</span>] + <span class="hljs-string">"..."</span>
        } <span class="hljs-keyword">else</span> {
            bannerPreview = result.Banner
        }
        
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version, 
            bannerPreview)
    }
}
</code></pre>
<h5 data-id="heading-14">识别正在运行的服务</h5>
<p>两种主要的服务检测策略：</p>
<ul>
<li><strong>基于端口识别</strong>：通过映射到公共端口号（例如，端口 80 是 HTTP），对服务有一个可能的猜测。</li>
<li><strong>旗标分析</strong>：获取旗标文本并查找服务标识符和版本信息。</li>
</ul>
<p>第一个函数 <code>grabBanner</code> 旨在从服务中获取第一个响应。有些服务（如 HTTP）要求发送请求并接收回复，为此我们会添加特定案例来处理这种情况。</p>
<h5 data-id="heading-15">基本版本检测</h5>
<p>版本检测对于漏洞的识别至关重要。在可能的情况下，扫描器会解析服务旗标以获取版本信息：</p>
<ul>
<li><strong>SSH</strong>：通常会以 <code>SSH-2.0-OpenSSH_7.4</code> 这样的形式提供版本信息。</li>
<li><strong>HTTP 服务器</strong>：通常会在响应头中（如 <code>Server: Apache/2.4.29</code>）返回其版本信息。</li>
<li><strong>数据库服务器</strong>：可能会在其欢迎消息中披露版本信息。</li>
</ul>
<p>现在，对于每个开放端口，输出都会返回更多信息：</p>
<pre><code class="hljs language-sql" lang="sql">Scanning localhost <span class="hljs-keyword">from</span> port <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">1024</span>
Scan completed <span class="hljs-keyword">in</span> <span class="hljs-number">5.4</span>s
Found <span class="hljs-number">3</span> <span class="hljs-keyword">open</span> ports:

PORT    SERVICE VERSION BANNER
<span class="hljs-comment">----    ------- ------- ------</span>
<span class="hljs-number">22</span>      SSH     <span class="hljs-number">2.0</span>     SSH<span class="hljs-number">-2.0</span><span class="hljs-operator">-</span>OpenSSH_8<span class="hljs-number">.4</span>p1 Ubuntu<span class="hljs-number">-6</span>
<span class="hljs-number">80</span>      HTTP    Apache<span class="hljs-operator">/</span><span class="hljs-number">2.4</span><span class="hljs-number">.41</span> Server: Apache<span class="hljs-operator">/</span><span class="hljs-number">2.4</span><span class="hljs-number">.41</span> (Ubuntu)
<span class="hljs-number">443</span>     HTTPS   <span class="hljs-literal">Unknown</span> Connection closed <span class="hljs-keyword">by</span> foreign...
</code></pre>
<p>这种增强后的信息对于漏洞评估而言要具有更高的价值。</p>
<h2 data-id="heading-16">5. 漏洞检测实现</h2>
<p>既然能列出正在运行的服务及其版本，接下来我们将实现针对漏洞的检测。我们对服务信息进行分析，并与已知漏洞进行对比。</p>
<h5 data-id="heading-17">编写简单的漏洞测试</h5>
<p>我们将根据常见服务和版本，基于已知漏洞构建数据库。为了简便起见，我们将创建一个嵌入代码的漏洞数据库，但在实际场景中，扫描器很可能会查询外部漏洞数据库（如 CVE 或 NVD）。</p>
<p>现在进一步完善代码，使其能够检测出漏洞：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port          <span class="hljs-type">int</span>
    State         <span class="hljs-type">bool</span>
    Service       <span class="hljs-type">string</span>
    Banner        <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service     <span class="hljs-type">string</span>
    Version     <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    {
        Service: <span class="hljs-string">"SSH"</span>,
        Version: <span class="hljs-string">"OpenSSH_7.4"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2017-15906"</span>,
            Description: <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.29"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2019-0211"</span>,
            Description: <span class="hljs-string">"Apache HTTP Server 2.4.17 to 2.4.38 - Local privilege escalation through mod_prefork and mod_http2"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2019-0211"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.41"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-9490"</span>,
            Description: <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"MySQL"</span>,
        Version: <span class="hljs-string">"5.7"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-2922"</span>,
            Description: <span class="hljs-string">"Vulnerability in MySQL Server allows unauthorized users to obtain sensitive information"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-2922"</span>,
        },
    },
    <span class="hljs-comment">// Add more known vulnerabilities here</span>
}

<span class="hljs-comment">// checkVulnerabilities checks if a service/version combination has known vulnerabilities</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkVulnerabilities</span><span class="hljs-params">(service, version <span class="hljs-type">string</span>)</span></span> []Vulnerability {
    <span class="hljs-keyword">var</span> vulnerabilities []Vulnerability
    
    <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> vulnerabilityDB {
        <span class="hljs-comment">// Simple matching - in a real scanner, this would be more sophisticated</span>
        <span class="hljs-keyword">if</span> vuln.Service == service &amp;&amp; strings.Contains(version, vuln.Version) {
            vulnerabilities = <span class="hljs-built_in">append</span>(vulnerabilities, vuln.Vulnerability)
        }
    }
    
    <span class="hljs-keyword">return</span> vulnerabilities
}

<span class="hljs-comment">// grabBanner attempts to read the banner from an open port</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    

    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\nHost: %s\r\n\r\n"</span>, host)
    } <span class="hljs-keyword">else</span> {

    }
    
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    vulnerabilities := checkVulnerabilities(service, version)
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:           port,
        State:          <span class="hljs-literal">true</span>,
        Service:        service,
        Banner:         banner,
        Version:        version,
        Vulnerabilities: vulnerabilities,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Second * <span class="hljs-number">1</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Println(<span class="hljs-string">"  Vulnerabilities:"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Printf(<span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Printf(<span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port          <span class="hljs-type">int</span>
    State         <span class="hljs-type">bool</span>
    Service       <span class="hljs-type">string</span>
    Banner        <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service     <span class="hljs-type">string</span>
    Version     <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    {
        Service: <span class="hljs-string">"SSH"</span>,
        Version: <span class="hljs-string">"OpenSSH_7.4"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2017-15906"</span>,
            Description: <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.29"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2019-0211"</span>,
            Description: <span class="hljs-string">"Apache HTTP Server 2.4.17 to 2.4.38 - Local privilege escalation through mod_prefork and mod_http2"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2019-0211"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"HTTP"</span>,
        Version: <span class="hljs-string">"Apache/2.4.41"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-9490"</span>,
            Description: <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span>,
            Severity:    <span class="hljs-string">"High"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>,
        },
    },
    {
        Service: <span class="hljs-string">"MySQL"</span>,
        Version: <span class="hljs-string">"5.7"</span>,
        Vulnerability: Vulnerability{
            ID:          <span class="hljs-string">"CVE-2020-2922"</span>,
            Description: <span class="hljs-string">"Vulnerability in MySQL Server allows unauthorized users to obtain sensitive information"</span>,
            Severity:    <span class="hljs-string">"Medium"</span>,
            Reference:   <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-2922"</span>,
        },
    },
    <span class="hljs-comment">// Add more known vulnerabilities here</span>
}

<span class="hljs-comment">// checkVulnerabilities checks if a service/version combination has known vulnerabilities</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkVulnerabilities</span><span class="hljs-params">(service, version <span class="hljs-type">string</span>)</span></span> []Vulnerability {
    <span class="hljs-keyword">var</span> vulnerabilities []Vulnerability
    
    <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> vulnerabilityDB {
        <span class="hljs-comment">// Simple matching - in a real scanner, this would be more sophisticated</span>
        <span class="hljs-keyword">if</span> vuln.Service == service &amp;&amp; strings.Contains(version, vuln.Version) {
            vulnerabilities = <span class="hljs-built_in">append</span>(vulnerabilities, vuln.Vulnerability)
        }
    }
    
    <span class="hljs-keyword">return</span> vulnerabilities
}

<span class="hljs-comment">// grabBanner attempts to read the banner from an open port</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">grabBanner</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    <span class="hljs-keyword">defer</span> conn.Close()
    
    conn.SetReadDeadline(time.Now().Add(timeout))
    

    <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> || port == <span class="hljs-number">443</span> || port == <span class="hljs-number">8080</span> || port == <span class="hljs-number">8443</span> {
        fmt.Fprintf(conn, <span class="hljs-string">"HEAD / HTTP/1.0\r\nHost: %s\r\n\r\n"</span>, host)
    } <span class="hljs-keyword">else</span> {

    }
    
    reader := bufio.NewReader(conn)
    banner, err := reader.ReadString(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, err
    }
    
    <span class="hljs-keyword">return</span> strings.TrimSpace(banner), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">identifyService</span><span class="hljs-params">(port <span class="hljs-type">int</span>, banner <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    commonPorts := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
        <span class="hljs-number">21</span>:    <span class="hljs-string">"FTP"</span>,
        <span class="hljs-number">22</span>:    <span class="hljs-string">"SSH"</span>,
        <span class="hljs-number">23</span>:    <span class="hljs-string">"Telnet"</span>,
        <span class="hljs-number">25</span>:    <span class="hljs-string">"SMTP"</span>,
        <span class="hljs-number">53</span>:    <span class="hljs-string">"DNS"</span>,
        <span class="hljs-number">80</span>:    <span class="hljs-string">"HTTP"</span>,
        <span class="hljs-number">110</span>:   <span class="hljs-string">"POP3"</span>,
        <span class="hljs-number">143</span>:   <span class="hljs-string">"IMAP"</span>,
        <span class="hljs-number">443</span>:   <span class="hljs-string">"HTTPS"</span>,
        <span class="hljs-number">3306</span>:  <span class="hljs-string">"MySQL"</span>,
        <span class="hljs-number">5432</span>:  <span class="hljs-string">"PostgreSQL"</span>,
        <span class="hljs-number">6379</span>:  <span class="hljs-string">"Redis"</span>,
        <span class="hljs-number">8080</span>:  <span class="hljs-string">"HTTP-Proxy"</span>,
        <span class="hljs-number">27017</span>: <span class="hljs-string">"MongoDB"</span>,
    }
    
    service := <span class="hljs-string">"Unknown"</span>
    <span class="hljs-keyword">if</span> s, exists := commonPorts[port]; exists {
        service = s
    }
    
    version := <span class="hljs-string">"Unknown"</span>
    
    lowerBanner := strings.ToLower(banner)
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"ssh"</span>) {
        service = <span class="hljs-string">"SSH"</span>
        parts := strings.Split(banner, <span class="hljs-string">" "</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
            version = parts[<span class="hljs-number">1</span>]
        }
    }
    
    <span class="hljs-keyword">if</span> strings.Contains(lowerBanner, <span class="hljs-string">"http"</span>) || strings.Contains(lowerBanner, <span class="hljs-string">"apache"</span>) || 
       strings.Contains(lowerBanner, <span class="hljs-string">"nginx"</span>) {
        <span class="hljs-keyword">if</span> port == <span class="hljs-number">443</span> {
            service = <span class="hljs-string">"HTTPS"</span>
        } <span class="hljs-keyword">else</span> {
            service = <span class="hljs-string">"HTTP"</span>
        }
        
        <span class="hljs-keyword">if</span> strings.Contains(banner, <span class="hljs-string">"Server:"</span>) {
            parts := strings.Split(banner, <span class="hljs-string">"Server:"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span> {
                version = strings.TrimSpace(parts[<span class="hljs-number">1</span>])
            }
        }
    }
    
    <span class="hljs-keyword">return</span> service, version
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPort</span><span class="hljs-params">(host <span class="hljs-type">string</span>, port <span class="hljs-type">int</span>, timeout time.Duration)</span></span> ScanResult {
    target := fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, host, port)
    conn, err := net.DialTimeout(<span class="hljs-string">"tcp"</span>, target, timeout)
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> ScanResult{Port: port, State: <span class="hljs-literal">false</span>}
    }
    
    conn.Close()
    
    banner, err := grabBanner(host, port, timeout)
    
    service := <span class="hljs-string">"Unknown"</span>
    version := <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; banner != <span class="hljs-string">""</span> {
        service, version = identifyService(port, banner)
    }
    
    vulnerabilities := checkVulnerabilities(service, version)
    
    <span class="hljs-keyword">return</span> ScanResult{
        Port:           port,
        State:          <span class="hljs-literal">true</span>,
        Service:        service,
        Banner:         banner,
        Version:        version,
        Vulnerabilities: vulnerabilities,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scanPorts</span><span class="hljs-params">(host <span class="hljs-type">string</span>, start, end <span class="hljs-type">int</span>, timeout time.Duration)</span></span> []ScanResult {
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, end-start+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">for</span> port := start; port &lt;= end; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(host, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    <span class="hljs-keyword">return</span> results
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    host := <span class="hljs-string">"localhost"</span>
    startPort := <span class="hljs-number">1</span>
    endPort := <span class="hljs-number">1024</span>
    timeout := time.Second * <span class="hljs-number">1</span> 
    
    fmt.Printf(<span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, host, startPort, endPort)
    startTime := time.Now()
    
    results := scanPorts(host, startPort, endPort, timeout)
    
    elapsed := time.Since(startTime)
    
    fmt.Printf(<span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Printf(<span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    fmt.Println(<span class="hljs-string">"PORT\tSERVICE\tVERSION"</span>)
    fmt.Println(<span class="hljs-string">"----\t-------\t-------"</span>)
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Printf(<span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Println(<span class="hljs-string">"  Vulnerabilities:"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Printf(<span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Printf(<span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-18">基于版本的漏洞匹配</h5>
<p>针对漏洞检测我们用简单版本匹配方法：</p>
<ul>
<li><strong>直接匹配</strong>：将服务类型和版本与漏洞数据库进行匹配。</li>
<li><strong>部分匹配</strong>：对于漏洞版本的匹配，我们会对版本字符串进行限制性检查，这样即使版本字符串包含额外信息，也能识别出存在漏洞的系统。</li>
</ul>
<p>在实际的扫描器中，匹配会更为复杂，会考虑到以下因素：</p>
<ul>
<li>版本范围（即版本 2.4.0 至 2.4.38 受影响）</li>
<li>特定配置的漏洞</li>
<li>操作系统特定的问题</li>
<li>更细致的版本比较</li>
</ul>
<h5 data-id="heading-19">报告发现的情况</h5>
<p>报告结果是漏洞检测流程中的最后一步，需要以简洁且具有可操作性的格式进行。扫描器现在：</p>
<ul>
<li>列出所有开放端口及其服务及版本信息</li>
<li>对于每个存在漏洞的服务，会显示：
<ul>
<li>漏洞标识（例如，CVE 编号）</li>
<li>漏洞描述</li>
<li>严重程度评级</li>
<li>更多信息的参考链接</li>
</ul>
</li>
</ul>
<p>示例输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">Scanning localhost from port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed in <span class="hljs-number">6.2</span>s
Found <span class="hljs-number">3</span> open ports:

PORT    SERVICE VERSION
----    ------- -------
<span class="hljs-number">22</span>      SSH     OpenSSH_7<span class="hljs-number">.4</span>p1
  Vulnerabilities:
    [Medium] CVE<span class="hljs-number">-2017</span><span class="hljs-number">-15906</span> - The process_open function in sftp-server.c in OpenSSH before <span class="hljs-number">7.6</span> does <span class="hljs-keyword">not</span> properly prevent write operations in read-only mode
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2017-15906</span>

<span class="hljs-number">80</span>      HTTP    Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span>
  Vulnerabilities:
    [High] CVE<span class="hljs-number">-2020</span><span class="hljs-number">-9490</span> - A specially crafted value <span class="hljs-keyword">for</span> the <span class="hljs-string">'Cache-Digest'</span> header can cause a heap overflow in Apache HTTP <span class="hljs-built_in">Server</span> <span class="hljs-number">2.4</span><span class="hljs-number">.0</span><span class="hljs-number">-2.4</span><span class="hljs-number">.41</span>
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2020-9490</span>

<span class="hljs-number">443</span>     HTTPS   Unknown
</code></pre>
<p>这份详尽的漏洞数据能够帮助网络安全专家迅速找出并排序出需要解决的安全问题。</p>
<h2 data-id="heading-20">最后完善与使用方法</h2>
<p>现在已经有了一个具备服务检测和漏洞匹配功能的基本漏洞扫描器；我们对其进行完善，以便在实际应用中更具实用性。</p>
<h6 data-id="heading-21">命令行参数</h6>
<p>扫描器可以通过命令行标志进行配置，这些标志能够设定目标、端口范围以及扫描选项。使用 Go 的 <code>flag</code> 包进行配置非常简单。</p>
<p>添加命令行参数：</p>
<pre><code class="hljs language-golang" lang="golang"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bufio"</span>
    <span class="hljs-string">"encoding/json"</span>
    <span class="hljs-string">"flag"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">type</span> ScanResult <span class="hljs-keyword">struct</span> {
    Port            <span class="hljs-type">int</span>
    State           <span class="hljs-type">bool</span>
    Service         <span class="hljs-type">string</span>
    Banner          <span class="hljs-type">string</span>
    Version         <span class="hljs-type">string</span>
    Vulnerabilities []Vulnerability
}

<span class="hljs-keyword">type</span> Vulnerability <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">string</span>
    Description <span class="hljs-type">string</span>
    Severity    <span class="hljs-type">string</span>
    Reference   <span class="hljs-type">string</span>
}

<span class="hljs-keyword">var</span> vulnerabilityDB = []<span class="hljs-keyword">struct</span> {
    Service       <span class="hljs-type">string</span>
    Version       <span class="hljs-type">string</span>
    Vulnerability Vulnerability
}{
    <span class="hljs-comment">// ... (same as before)</span>
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    hostPtr := flag.String(<span class="hljs-string">"host"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"Target host to scan (required)"</span>)
    startPortPtr := flag.Int(<span class="hljs-string">"start"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"Starting port number"</span>)
    endPortPtr := flag.Int(<span class="hljs-string">"end"</span>, <span class="hljs-number">1024</span>, <span class="hljs-string">"Ending port number"</span>)
    timeoutPtr := flag.Int(<span class="hljs-string">"timeout"</span>, <span class="hljs-number">1000</span>, <span class="hljs-string">"Timeout in milliseconds"</span>)
    concurrencyPtr := flag.Int(<span class="hljs-string">"concurrency"</span>, <span class="hljs-number">100</span>, <span class="hljs-string">"Number of concurrent scans"</span>)
    formatPtr := flag.String(<span class="hljs-string">"format"</span>, <span class="hljs-string">"text"</span>, <span class="hljs-string">"Output format: text, json, or csv"</span>)
    verbosePtr := flag.Bool(<span class="hljs-string">"verbose"</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">"Show verbose output including banners"</span>)
    outputFilePtr := flag.String(<span class="hljs-string">"output"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"Output file (default is stdout)"</span>)
    
    flag.Parse()
    
    <span class="hljs-keyword">if</span> *hostPtr == <span class="hljs-string">""</span> {
        fmt.Println(<span class="hljs-string">"Error: host is required"</span>)
        flag.Usage()
        os.Exit(<span class="hljs-number">1</span>)
    }
    
    <span class="hljs-keyword">if</span> *startPortPtr &lt; <span class="hljs-number">1</span> || *startPortPtr &gt; <span class="hljs-number">65535</span> {
        fmt.Println(<span class="hljs-string">"Error: starting port must be between 1 and 65535"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    <span class="hljs-keyword">if</span> *endPortPtr &lt; <span class="hljs-number">1</span> || *endPortPtr &gt; <span class="hljs-number">65535</span> {
        fmt.Println(<span class="hljs-string">"Error: ending port must be between 1 and 65535"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    <span class="hljs-keyword">if</span> *startPortPtr &gt; *endPortPtr {
        fmt.Println(<span class="hljs-string">"Error: starting port must be less than or equal to ending port"</span>)
        os.Exit(<span class="hljs-number">1</span>)
    }
    
    timeout := time.Duration(*timeoutPtr) * time.Millisecond
    
    <span class="hljs-keyword">var</span> outputFile *os.File
    <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
    
    <span class="hljs-keyword">if</span> *outputFilePtr != <span class="hljs-string">""</span> {
        outputFile, err = os.Create(*outputFilePtr)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            fmt.Printf(<span class="hljs-string">"Error creating output file: %v\n"</span>, err)
            os.Exit(<span class="hljs-number">1</span>)
        }
        <span class="hljs-keyword">defer</span> outputFile.Close()
    } <span class="hljs-keyword">else</span> {
        outputFile = os.Stdout
    }
    
    fmt.Fprintf(outputFile, <span class="hljs-string">"Scanning %s from port %d to %d\n"</span>, *hostPtr, *startPortPtr, *endPortPtr)
    startTime := time.Now()
    
    <span class="hljs-keyword">var</span> results []ScanResult
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    
    resultChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ScanResult, *endPortPtr-*startPortPtr+<span class="hljs-number">1</span>)
    
    semaphore := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, *concurrencyPtr)
    
    <span class="hljs-keyword">for</span> port := *startPortPtr; port &lt;= *endPortPtr; port++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            
            semaphore &lt;- <span class="hljs-keyword">struct</span>{}{}
            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> { &lt;-semaphore }()
            
            result := scanPort(*hostPtr, p, timeout)
            resultChan &lt;- result
        }(port)
    }
    
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        wg.Wait()
        <span class="hljs-built_in">close</span>(resultChan)
    }()
    
    <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> resultChan {
        <span class="hljs-keyword">if</span> result.State {
            results = <span class="hljs-built_in">append</span>(results, result)
        }
    }
    
    elapsed := time.Since(startTime)
    
    <span class="hljs-keyword">switch</span> *formatPtr {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"json"</span>:
        outputJSON(outputFile, results, elapsed)
    <span class="hljs-keyword">case</span> <span class="hljs-string">"csv"</span>:
        outputCSV(outputFile, results, elapsed, *verbosePtr)
    <span class="hljs-keyword">default</span>:
        outputText(outputFile, results, elapsed, *verbosePtr)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputText</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration, verbose <span class="hljs-type">bool</span>)</span></span> {
    fmt.Fprintf(w, <span class="hljs-string">"\nScan completed in %s\n"</span>, elapsed)
    fmt.Fprintf(w, <span class="hljs-string">"Found %d open ports:\n\n"</span>, <span class="hljs-built_in">len</span>(results))
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(results) == <span class="hljs-number">0</span> {
        fmt.Fprintf(w, <span class="hljs-string">"No open ports found.\n"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    fmt.Fprintf(w, <span class="hljs-string">"PORT\tSERVICE\tVERSION\n"</span>)
    fmt.Fprintf(w, <span class="hljs-string">"----\t-------\t-------\n"</span>)
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        fmt.Fprintf(w, <span class="hljs-string">"%d\t%s\t%s\n"</span>, 
            result.Port, 
            result.Service, 
            result.Version)
        
        <span class="hljs-keyword">if</span> verbose {
            fmt.Fprintf(w, <span class="hljs-string">"  Banner: %s\n"</span>, result.Banner)
        }
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) &gt; <span class="hljs-number">0</span> {
            fmt.Fprintf(w, <span class="hljs-string">"  Vulnerabilities:\n"</span>)
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Fprintf(w, <span class="hljs-string">"    [%s] %s - %s\n"</span>, 
                    vuln.Severity, 
                    vuln.ID, 
                    vuln.Description)
                fmt.Fprintf(w, <span class="hljs-string">"    Reference: %s\n\n"</span>, vuln.Reference)
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputJSON</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration)</span></span> {
    output := <span class="hljs-keyword">struct</span> {
        ScanTime   <span class="hljs-type">string</span>       <span class="hljs-string">`json:"scan_time"`</span>
        ElapsedTime <span class="hljs-type">string</span>       <span class="hljs-string">`json:"elapsed_time"`</span>
        TotalPorts <span class="hljs-type">int</span>          <span class="hljs-string">`json:"total_ports"`</span>
        OpenPorts  <span class="hljs-type">int</span>          <span class="hljs-string">`json:"open_ports"`</span>
        Results    []ScanResult <span class="hljs-string">`json:"results"`</span>
    }{
        ScanTime:    time.Now().Format(time.RFC3339),
        ElapsedTime: elapsed.String(),
        TotalPorts:  <span class="hljs-number">0</span>, 
        OpenPorts:   <span class="hljs-built_in">len</span>(results),
        Results:     results,
    }
    
    encoder := json.NewEncoder(w)
    encoder.SetIndent(<span class="hljs-string">""</span>, <span class="hljs-string">"  "</span>)
    encoder.Encode(output)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">outputCSV</span><span class="hljs-params">(w *os.File, results []ScanResult, elapsed time.Duration, verbose <span class="hljs-type">bool</span>)</span></span> {
    fmt.Fprintf(w, <span class="hljs-string">"Port,Service,Version,Vulnerability ID,Severity,Description\n"</span>)
    
    <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results {
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result.Vulnerabilities) == <span class="hljs-number">0</span> {
            fmt.Fprintf(w, <span class="hljs-string">"%d,%s,%s,,,\n"</span>, 
                result.Port, 
                escapeCSV(result.Service), 
                escapeCSV(result.Version))
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span> _, vuln := <span class="hljs-keyword">range</span> result.Vulnerabilities {
                fmt.Fprintf(w, <span class="hljs-string">"%d,%s,%s,%s,%s,%s\n"</span>, 
                    result.Port, 
                    escapeCSV(result.Service), 
                    escapeCSV(result.Version),
                    escapeCSV(vuln.ID),
                    escapeCSV(vuln.Severity),
                    escapeCSV(vuln.Description))
            }
        }
    }
    
    fmt.Fprintf(w, <span class="hljs-string">"\n# Scan completed in %s, found %d open ports\n"</span>, 
        elapsed, <span class="hljs-built_in">len</span>(results))
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">escapeCSV</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">if</span> strings.Contains(s, <span class="hljs-string">","</span>) || strings.Contains(s, <span class="hljs-string">"\""</span>) || strings.Contains(s, <span class="hljs-string">"\n"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\""</span> + strings.ReplaceAll(s, <span class="hljs-string">"\""</span>, <span class="hljs-string">"\"\""</span>) + <span class="hljs-string">"\""</span>
    }
    <span class="hljs-keyword">return</span> s
}
</code></pre>
<h6 data-id="heading-22">输出格式</h6>
<p>扫描器现在可以输出三种格式：</p>
<ul>
<li><strong>文本</strong>：易于阅读，易于编写，非常适合交互使用。</li>
<li><strong>JSON</strong>：结构化输出，适用于机器处理以及与其他工具的集成。</li>
<li><strong>CSV</strong>：电子表格兼容的格式，用于分析和报告。</li>
</ul>
<p>输出文本还会提供更多信息，例如如果设置了详细模式，则会提供原始旗标信息，对于调试或深入分析也非常方便。</p>
<h6 data-id="heading-23">示例用法及结果</h6>
<p>如果打算将扫描器用于不同场合，以下是一些可能的选择：</p>
<p><strong>单个主机的基本扫描：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com
</code></pre>
<p><strong>扫描指定端口范围：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">$ go run main.go -host example.com -start <span class="hljs-number">80</span> -end <span class="hljs-number">443</span>
</code></pre>
<p><strong>增加超时和详细信息：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com -verbose -timeout <span class="hljs-number">2000</span>
</code></pre>
<p><strong>以更高的并发性扫描以获得更快的结果：</strong></p>
<pre><code class="hljs language-go" lang="go">$ <span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span> -host example.com -concurrency <span class="hljs-number">200</span>
</code></pre>
<p>示例文本输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">Scanning example.com from port <span class="hljs-number">1</span> to <span class="hljs-number">1024</span>
Scan completed in <span class="hljs-number">12.6</span>s
Found <span class="hljs-number">3</span> open ports:

PORT    SERVICE VERSION
----    ------- -------
<span class="hljs-number">22</span>      SSH     OpenSSH_7<span class="hljs-number">.4</span>p1
  Vulnerabilities:
    [Medium] CVE<span class="hljs-number">-2017</span><span class="hljs-number">-15906</span> - The process_open function in sftp-server.c in OpenSSH before <span class="hljs-number">7.6</span> does <span class="hljs-keyword">not</span> properly prevent write operations in read-only mode
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2017-15906</span>

<span class="hljs-number">80</span>      HTTP    Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.41</span>
  Vulnerabilities:
    [High] CVE<span class="hljs-number">-2020</span><span class="hljs-number">-9490</span> - A specially crafted value <span class="hljs-keyword">for</span> the <span class="hljs-string">'Cache-Digest'</span> header can cause a heap overflow in Apache HTTP <span class="hljs-built_in">Server</span> <span class="hljs-number">2.4</span><span class="hljs-number">.0</span><span class="hljs-number">-2.4</span><span class="hljs-number">.41</span>
    Reference: https:<span class="hljs-comment">//nvd.nist.gov/vuln/detail/CVE-2020-9490</span>

<span class="hljs-number">443</span>     HTTPS   nginx/<span class="hljs-number">1.18</span><span class="hljs-number">.0</span>：
</code></pre>
<p>JSON 输出示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scan_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-03-18T14:30:00Z"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"elapsed_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12.6s"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_ports"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"open_ports"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"results"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SSH"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SSH-2.0-OpenSSH_7.4p1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"OpenSSH_7.4p1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CVE-2017-15906"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"The process_open function in sftp-server.c in OpenSSH before 7.6 does not properly prevent write operations in read-only mode"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Severity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Medium"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Reference"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2017-15906"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">80</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP/1.1 200 OK\r\nServer: Apache/2.4.41"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Apache/2.4.41"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"ID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CVE-2020-9490"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A specially crafted value for the 'Cache-Digest' header can cause a heap overflow in Apache HTTP Server 2.4.0-2.4.41"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Severity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"High"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Reference"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://nvd.nist.gov/vuln/detail/CVE-2020-9490"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">443</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"State"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTPS"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Banner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HTTP/1.1 200 OK\r\nServer: nginx/1.18.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nginx/1.18.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Vulnerabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>我们用 Go 语言构建了一个强大的网络漏洞扫描器，这表明该语言非常适合用于安全工具。扫描器能迅速打开端口，识别端口上运行的服务，并判断是否存在已知漏洞。</p>
<p>扫描器提供了有关网络上运行的服务的有用信息，包括多线程、服务指纹识别以及多种输出格式。</p>
<p>请记住，像扫描器这样的工具只能在符合道德和法律规范的条件下使用，并且需要获得对目标系统的扫描授权。如果操作得当，定期进行漏洞扫描是良好安全态势的重要组成部分，能够帮助保护系统免受威胁。</p>
<p>可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frezmoss%2Fnetwork-vulnerability-scanner" title="https://github.com/rezmoss/network-vulnerability-scanner" target="_blank" ref="nofollow noopener noreferrer">GitHub</a> 上找到该项目的完整源代码。</p>
<hr/>
<blockquote>
<p>你好，我是俞凡，在Motorola做过研发，现在在Mavenir做技术工作，对通信、网络、后端架构、云原生、DevOps、CICD、区块链、AI等技术始终保持着浓厚的兴趣，平时喜欢阅读、思考，相信持续学习、终身成长，欢迎一起交流学习。为了方便大家以后能第一时间看到文章，请朋友们关注公众号"DeepNoMind"，并设个星标吧，如果能一键三连(转发、点赞、在看)，则能给我带来更多的支持和动力，激励我持续写下去，和大家共同成长进步！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React DevTools 组件名乱码？揭秘从开发到生产的代码变形记]]></title>    <link>https://juejin.cn/post/7571678763781652514</link>    <guid>https://juejin.cn/post/7571678763781652514</guid>    <pubDate>2025-11-12T14:34:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571678763781652514" data-draft-id="7571672422689488948" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React DevTools 组件名乱码？揭秘从开发到生产的代码变形记"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-12T14:34:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React DevTools 组件名乱码？揭秘从开发到生产的代码变形记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:34:55.000Z" title="Wed Nov 12 2025 14:34:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React DevTools 组件名乱码？聊聊代码压缩这件事</h2>
<p>线上打开 React DevTools，打开一看，组件树全是 <code>C0</code>、<code>$r</code>、<code>pv</code> 这种不可读的字符。</p>
<p>开发环境明明好好的，叫 <code>NavigationProvider</code>、<code>DialogPortal</code>，怎么到线上就全变了？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23fcd0708f5641e494aca20e819a15d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763562895&amp;x-signature=9AyhGROp8t67XkehvUG1el%2BeKjw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">问题出在哪</h3>
<p>简单说：<strong>生产构建时，代码被压缩了，函数名被改成了短字符。</strong></p>
<p>React DevTools 依赖函数名来显示组件名。函数名变了，显示的自然也就变了。</p>
<h4 data-id="heading-2">开发环境 vs 生产环境</h4>
<p><strong>开发环境</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>React DevTools 显示：<code>NavigationProvider</code> ✅</p>
<p><strong>生产环境</strong>（压缩后）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>React DevTools 显示：<code>pv</code> ❌</p>
<h3 data-id="heading-3">从开发到生产：代码都经历了什么</h3>
<p>要理解为什么会被压缩，先要知道我们写的代码是怎么变成用户访问的线上代码的。</p>
<h4 data-id="heading-4">开发模式：原汁原味</h4>
<p>用脚手架（Create React App、Vite）开发时，启动的是<strong>开发服务器</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
<span class="hljs-comment"># 或</span>
npm start
</code></pre>
<p>这时候：</p>
<ul>
<li>代码实时编译，但<strong>不压缩</strong></li>
<li>保留完整的变量名、函数名</li>
<li>包含 Source Maps（方便调试）</li>
<li>有热更新（Hot Module Replacement）</li>
</ul>
<p>浏览器加载的代码长这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// http://localhost:3000/src/App.jsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>清清楚楚，React DevTools 自然能读到 <code>NavigationProvider</code>。</p>
<h4 data-id="heading-5">生产构建：全面优化</h4>
<p>准备部署上线时，要执行构建命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm run build
</code></pre>
<p>这一步会调用打包工具（Webpack、Vite、Rollup），做一系列优化：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[源代码&lt;br/&gt;多个 .jsx 文件] --&gt; B[编译&lt;br/&gt;JSX → JS]
    B --&gt; C[打包&lt;br/&gt;合并成少数文件]
    C --&gt; D[Tree Shaking&lt;br/&gt;删除未使用代码]
    D --&gt; E[压缩&lt;br/&gt;Minification]
    E --&gt; F[生产代码&lt;br/&gt;dist/main.abc123.js]
</code></pre>
<h5 data-id="heading-6">1. 编译（Transpilation）</h5>
<p>Babel 把 JSX 和现代 JS 语法转成浏览器能理解的代码。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
&lt;<span class="hljs-title class_">Provider</span>&gt;{children}&lt;/<span class="hljs-title class_">Provider</span>&gt;

<span class="hljs-comment">// 编译后</span>
<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">Provider</span>, <span class="hljs-literal">null</span>, children)
</code></pre>
<h5 data-id="heading-7">2. 打包（Bundling）</h5>
<p>把几十上百个文件合并成几个文件。</p>
<pre><code class="hljs language-css" lang="css">开发环境：
├── App<span class="hljs-selector-class">.jsx</span>
├── components/
│   ├── Navigation<span class="hljs-selector-class">.jsx</span>
│   ├── <span class="hljs-selector-tag">Header</span><span class="hljs-selector-class">.jsx</span>
│   └── <span class="hljs-selector-tag">Footer</span><span class="hljs-selector-class">.jsx</span>
└── utils/
    └── helpers<span class="hljs-selector-class">.js</span>

生产环境：
└── dist/
    └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.abc123</span><span class="hljs-selector-class">.js</span>  ← 全部合并
</code></pre>
<h5 data-id="heading-8">3. Tree Shaking</h5>
<p>删除没用到的代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unusedFunction</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }  <span class="hljs-comment">// 这个没被 import</span>

<span class="hljs-comment">// 打包后：unusedFunction 被删除</span>
</code></pre>
<h5 data-id="heading-9">4. 压缩（Minification）</h5>
<p><strong>这就是导致组件名乱码的关键步骤。</strong></p>
<p>压缩器（Terser、esbuild）把代码体积压到最小：</p>
<ul>
<li>删除空格、换行、注释</li>
<li>缩短变量名和函数名</li>
<li>简化代码逻辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,<span class="hljs-literal">null</span>,e)}
</code></pre>
<h4 data-id="heading-10">为什么生产环境要这么做</h4>
<p><strong>一个字：快。</strong></p>
<p>用户访问网站时：</p>
<ol>
<li>浏览器从服务器下载 JS 文件</li>
<li>解析代码</li>
<li>执行代码</li>
</ol>
<p><strong>如果不压缩</strong>：</p>
<ul>
<li>一个中型 React 应用，原始代码可能 2-3 MB</li>
<li>在 3G 网络下，下载要 20-30 秒</li>
<li>用户看到白屏，早跑了</li>
</ul>
<p><strong>压缩后</strong>：</p>
<ul>
<li>代码体积降到 500-800 KB</li>
<li>Gzip 压缩后可能只有 200 KB</li>
<li>下载时间缩短到 3-5 秒</li>
</ul>
<p>体积差异这么大，主要因为：</p>
<ul>
<li><strong>空格和换行</strong>：原始代码为了可读性，大量使用缩进和换行（占 20-30%）</li>
<li><strong>变量名和函数名</strong>：<code>NavigationProvider</code> → <code>pv</code> 这种压缩（占 30-40%）</li>
<li><strong>注释</strong>：开发时的注释在生产环境完全删除（占 5-10%）</li>
<li><strong>未使用的代码</strong>：Tree Shaking 删除（占 10-20%）</li>
</ul>
<p>所以，<strong>压缩是生产环境的必备步骤</strong>，不是可选项。</p>
<h4 data-id="heading-11">压缩在哪个阶段</h4>
<p>在 Webpack 或 Vite 的配置中，压缩是最后一步：</p>
<p><strong>Webpack 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,  <span class="hljs-comment">// 自动启用压缩</span>

    <span class="hljs-attr">optimization</span>: {
        <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启压缩</span>
        <span class="hljs-attr">minimizer</span>: [
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(),  <span class="hljs-comment">// 使用 Terser 压缩</span>
        ],
    },
};
</code></pre>
<p><strong>Vite 配置</strong>（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">build</span>: {
        <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,  <span class="hljs-comment">// 使用 Terser 压缩（默认是 esbuild）</span>
    },
};
</code></pre>
<p>当你执行 <code>npm run build</code>，打包工具会：</p>
<ol>
<li>编译所有源文件</li>
<li>合并成几个大文件</li>
<li><strong>最后调用压缩器处理</strong></li>
<li>输出到 <code>dist/</code> 目录</li>
</ol>
<p>压缩是<strong>构建流程的最后一步</strong>，产出的就是上线的代码。</p>
<h4 data-id="heading-12">开发和生产的环境区别</h4>













































<table><thead><tr><th>特性</th><th>开发环境</th><th>生产环境</th></tr></thead><tbody><tr><td>命令</td><td><code>npm run dev</code></td><td><code>npm run build</code></td></tr><tr><td>代码压缩</td><td>❌</td><td>✅</td></tr><tr><td>变量名</td><td><code>NavigationProvider</code></td><td><code>pv</code></td></tr><tr><td>文件体积</td><td>2-3 MB</td><td>500-800 KB</td></tr><tr><td>Source Maps</td><td>✅ 完整</td><td>❌ 或隐藏</td></tr><tr><td>调试体验</td><td>轻松</td><td>困难</td></tr><tr><td>加载速度</td><td>慢（本地不care）</td><td>快（关键指标）</td></tr></tbody></table>
<p>现在明白了：<strong>开发时你写的清晰代码，到用户那里已经面目全非</strong>。</p>
<p>而组件名乱码，就是这个"面目全非"的副作用。</p>
<h3 data-id="heading-13">为什么要压缩函数名</h3>
<p>理解了背景，再看具体的压缩逻辑就清楚了。</p>
<p><strong>减小文件体积，加快加载速度。</strong></p>
<p>压缩器做的事：</p>
<ol>
<li><strong>删除空格和换行</strong></li>
<li><strong>缩短变量名</strong>：<code>userName</code> → <code>u</code></li>
<li><strong>缩短函数名</strong>：<code>NavigationProvider</code> → <code>pv</code></li>
<li><strong>简化代码结构</strong></li>
</ol>
<p>看个真实例子：</p>
<p><strong>压缩前</strong>（15 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; {
        <span class="hljs-title function_">setLocation</span>(path);
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>压缩后</strong>（4 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Context</span>.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>体积直接砍掉 70%。</p>
<p>其中 <code>NavigationProvider</code> → <code>pv</code> 就省了 17 个字符。整个项目几百个函数，加起来就是几十 KB 的差异。</p>
<h3 data-id="heading-14">压缩过程详解</h3>
<p>压缩不是简单的文本替换，而是经过多个阶段的代码转换。</p>
<h4 data-id="heading-15">完整的构建流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[源代码 JSX] --&gt; B[Babel 转译]
    B --&gt; C[打包合并]
    C --&gt; D[Terser 压缩]
    D --&gt; E[生产代码]
</code></pre>
<ol>
<li><strong>Babel 转译</strong>：把 JSX 转成标准 JavaScript</li>
<li><strong>打包合并</strong>：多个文件合成一个文件</li>
<li><strong>Terser 压缩</strong>：真正的压缩发生在这一步</li>
<li><strong>输出</strong>：最终的生产代码</li>
</ol>
<p>重点看第三步，压缩器内部其实也分好几个阶段。</p>
<h4 data-id="heading-16">Terser 的压缩阶段</h4>
<h5 data-id="heading-17">阶段 1：解析（Parse）</h5>
<p>把代码转成抽象语法树（AST）。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 转成 AST（简化版）</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"Identifier"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"NavigationProvider"</span> },
    <span class="hljs-attr">params</span>: [
        {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"ObjectPattern"</span>,
            <span class="hljs-attr">properties</span>: [{ <span class="hljs-attr">key</span>: <span class="hljs-string">"children"</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"children"</span> }]
        }
    ],
    <span class="hljs-attr">body</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"ReturnStatement"</span>,
        <span class="hljs-attr">argument</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"JSXElement"</span>, ... }
    }
}
</code></pre>
<p>AST 就是代码的树状结构表示，方便后续分析和修改。</p>
<h5 data-id="heading-18">阶段 2：分析（Analyze）</h5>
<p><strong>2.1 作用域分析</strong></p>
<p>找出哪些变量名可以改，哪些不能改。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// 局部变量，可以改</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-variable language_">window</span>.<span class="hljs-property">NavigationProvider</span> = <span class="hljs-title class_">NavigationProvider</span>;  <span class="hljs-comment">// 全局引用，不能改</span>
</code></pre>
<p>规则：</p>
<ul>
<li><strong>可以改</strong>：函数内部的局部变量、函数名（如果没被外部引用）</li>
<li><strong>不能改</strong>：全局变量、对象属性名、被 <code>eval()</code> 使用的变量</li>
</ul>
<p><strong>2.2 引用计数</strong></p>
<p>统计每个标识符出现了多少次，决定是否值得压缩。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider 出现 1 次</span>
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);          <span class="hljs-comment">// location 出现 1 次</span>
    <span class="hljs-keyword">const</span> currentLocation = location;        <span class="hljs-comment">// location 出现 2 次</span>
    <span class="hljs-keyword">return</span> currentLocation;                  <span class="hljs-comment">// currentLocation 出现 1 次</span>
}
</code></pre>
<p>如果一个变量只用了 1 次，改成短名称可能不划算（比如 <code>location</code> → <code>a</code> 只省 7 个字符）。</p>
<p><strong>2.3 依赖分析</strong></p>
<p>找出变量之间的依赖关系，避免命名冲突。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> b = <span class="hljs-number">2</span>;  <span class="hljs-comment">// b 可以重命名为 a，因为不在同一作用域</span>
        <span class="hljs-keyword">return</span> b;
    }
    <span class="hljs-keyword">return</span> a;
}
</code></pre>
<h5 data-id="heading-19">阶段 3：转换（Transform）</h5>
<p>这是真正做压缩的阶段，分多个步骤。</p>
<p><strong>3.1 删除死代码（Dead Code Elimination）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEBUG</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">DEBUG</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'debug'</span>);  <span class="hljs-comment">// 这段永远不会执行</span>
    }
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p><strong>3.2 常量折叠（Constant Folding）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_COUNT</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOUBLED</span> = <span class="hljs-variable constant_">MAX_COUNT</span> * <span class="hljs-number">2</span>;
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-variable constant_">DOUBLED</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">20</span>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>直接算出结果，减少运行时计算。</p>
<p><strong>3.3 表达式简化</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">if</span> (isActive === <span class="hljs-literal">true</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 压缩后</span>
<span class="hljs-keyword">if</span> (isActive) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p><strong>3.4 变量名压缩（Mangle）</strong></p>
<p>这是我们关心的重点。</p>
<p>压缩器遍历 AST，按照一定规则替换标识符：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第一轮：函数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children }</span>) {  <span class="hljs-comment">// NavigationProvider → pv</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第二轮：参数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {  <span class="hljs-comment">// children → e</span>
    <span class="hljs-keyword">const</span> [location, setLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">path</span>) =&gt; <span class="hljs-title function_">setLocation</span>(path);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location</span>, <span class="hljs-attr">navigate</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 第三轮：局部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">{ children: e }</span>) {
    <span class="hljs-keyword">const</span> [t, n] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);  <span class="hljs-comment">// location → t, setLocation → n</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">r</span> = (<span class="hljs-params">o</span>) =&gt; <span class="hljs-title function_">n</span>(o);         <span class="hljs-comment">// navigate → r, path → o</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">location:</span> <span class="hljs-attr">t</span>, <span class="hljs-attr">navigate:</span> <span class="hljs-attr">r</span> }}&gt;</span>{e}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
}
</code></pre>
<p>注意：<strong>对象属性名不会改</strong>（<code>location:</code>、<code>navigate:</code> 保持原样），因为这些是对外的接口。</p>
<p><strong>3.5 作用域提升（Scope Hoisting）</strong></p>
<p>把多个模块合并到一个作用域，减少闭包和函数调用。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 压缩前（两个文件）</span>
<span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">date</span>) { <span class="hljs-keyword">return</span> date.<span class="hljs-title function_">toString</span>(); }

<span class="hljs-comment">// app.js</span>
<span class="hljs-keyword">import</span> { formatDate } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));

<span class="hljs-comment">// 压缩后（合并）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">b</span>) { <span class="hljs-keyword">return</span> b.<span class="hljs-title function_">toString</span>(); }
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">a</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
</code></pre>
<h5 data-id="heading-20">阶段 4：生成（Generate）</h5>
<p>把修改后的 AST 转回代码字符串。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// AST 转回代码</span>
{
    <span class="hljs-attr">type</span>: <span class="hljs-string">"FunctionDeclaration"</span>,
    <span class="hljs-attr">id</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"pv"</span> },  <span class="hljs-comment">// 已被修改</span>
    <span class="hljs-attr">params</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">"e"</span> }],
    <span class="hljs-attr">body</span>: { ... }
}

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pv</span>(<span class="hljs-params">e</span>){<span class="hljs-keyword">const</span>[t,n]=<span class="hljs-title function_">useState</span>(<span class="hljs-string">"/"</span>);<span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title class_">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:t,<span class="hljs-attr">navigate</span>:<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-title function_">n</span>(r)},<span class="hljs-attr">children</span>:e})}
</code></pre>
<p>同时删除所有空格、换行、注释。</p>
<h4 data-id="heading-21">命名规则详解</h4>
<p>压缩器分配短名称时的优先级：</p>
<h5 data-id="heading-22">1. 单字母（52 个）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>, c, ..., z
<span class="hljs-selector-tag">A</span>, <span class="hljs-selector-tag">B</span>, C, ..., Z
</code></pre>
<p>最常用的标识符会优先分配这些。</p>
<h5 data-id="heading-23">2. 美元符号和下划线（104 个）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, ..., <span class="hljs-variable">$Z</span>
_a, _b, ..., _Z
</code></pre>
<p>单字母用完就加前缀。</p>
<h5 data-id="heading-24">3. 两个字母（2704 个）</h5>
<pre><code class="hljs">aa, ab, ac, ..., ZZ
</code></pre>
<p>再不够就用两个字母组合。</p>
<h5 data-id="heading-25">4. 特殊组合</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$,</span> _, <span class="hljs-variable">$$</span>, <span class="hljs-variable">$_</span>, ...
</code></pre>
<p>然后是各种特殊字符组合。</p>
<p>所以你看到的 <code>pv</code>、<code>$r</code>、<code>Jt</code> 都是按照这个顺序分配的。</p>
<h4 data-id="heading-26">真实例子对比</h4>
<p>拿一段完整的代码看看每个阶段的变化：</p>
<p><strong>原始代码</strong>（150 行，5 KB）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NavigationContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">NavigationContext.Provider</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>经过 Babel</strong>（转 JSX）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NavigationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [currentLocation, setCurrentLocation] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigate</span> = (<span class="hljs-params">newPath</span>) =&gt; {
        <span class="hljs-keyword">if</span> (newPath !== currentLocation) {
            <span class="hljs-title function_">setCurrentLocation</span>(newPath);
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newPath);
        }
    };

    <span class="hljs-keyword">const</span> value = {
        <span class="hljs-attr">location</span>: currentLocation,
        <span class="hljs-attr">navigate</span>: navigate
    };

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
        <span class="hljs-title class_">NavigationContext</span>.<span class="hljs-property">Provider</span>,
        { <span class="hljs-attr">value</span>: value },
        children
    );
}
</code></pre>
<p><strong>经过 Terser 分析</strong>（内部记录）：</p>
<pre><code class="hljs language-diff" lang="diff">作用域分析：
<span class="hljs-deletion">- NavigationContext: 全局导出，不能改</span>
<span class="hljs-deletion">- NavigationProvider: 全局导出，不能改</span>
<span class="hljs-deletion">- children: 函数参数，可以改 → e</span>
<span class="hljs-deletion">- currentLocation: 局部变量，可以改 → t</span>
<span class="hljs-deletion">- setCurrentLocation: 局部变量，可以改 → n</span>
<span class="hljs-deletion">- navigate: 局部变量，可以改 → r</span>
<span class="hljs-deletion">- newPath: 函数参数，可以改 → o</span>
<span class="hljs-deletion">- value: 局部变量，可以改 → a（但会被内联优化掉）</span>
</code></pre>
<p><strong>经过 Terser 压缩</strong>（最终产物，1.5 KB）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span>{useState <span class="hljs-keyword">as</span> t}<span class="hljs-keyword">from</span><span class="hljs-string">"react"</span>;<span class="hljs-keyword">const</span> n=<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationProvider</span>(<span class="hljs-params">{children:e}</span>){<span class="hljs-keyword">const</span>[r,o]=<span class="hljs-title function_">t</span>(<span class="hljs-string">"/"</span>),c=<span class="hljs-function"><span class="hljs-params">i</span>=&gt;</span>{i!==r&amp;&amp;(<span class="hljs-title function_">o</span>(i),<span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({},<span class="hljs-string">""</span>,i))};<span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(n.<span class="hljs-property">Provider</span>,{<span class="hljs-attr">value</span>:{<span class="hljs-attr">location</span>:r,<span class="hljs-attr">navigate</span>:c}},e)}
</code></pre>
<p><strong>体积对比</strong>：</p>
<ul>
<li>原始代码：5 KB</li>
<li>Babel 转译后：5.2 KB（JSX 转换略有增加）</li>
<li>Terser 压缩后：1.5 KB（减少 70%）</li>
</ul>
<p>关键变化：</p>
<ol>
<li>删除所有空格和换行：<code>5KB → 4KB</code></li>
<li>变量名压缩：<code>4KB → 2KB</code></li>
<li>表达式简化和内联：<code>2KB → 1.5KB</code></li>
</ol>
<h4 data-id="heading-27">为什么这么激进</h4>
<p>现代 Web 应用动辄几百个组件，上千个函数。</p>
<p>如果不压缩函数名和变量名：</p>
<ul>
<li>平均每个函数名 15 字符</li>
<li>1000 个函数 = 15KB 仅用于命名</li>
<li>加上变量名，总共可能 50KB+</li>
</ul>
<p>50KB 在 3G 网络下，多加载 3-5 秒。</p>
<p>所以压缩器默认非常激进，能压缩的全压缩。</p>
<h3 data-id="heading-28">背后的原理</h3>
<h4 data-id="heading-29">函数名是怎么被替换的</h4>
<p>压缩器内部维护一个映射表：</p>
<pre><code class="hljs language-bash" lang="bash">原始名称 → 压缩后名称
NavigationProvider → pv
LocationProvider → <span class="hljs-variable">$r</span>
DialogPortal → Jt
Link → vv
</code></pre>
<p>规则很简单：</p>
<ol>
<li>按出现顺序分配短名称</li>
<li>优先用单字母（a-z, A-Z）</li>
<li>单字母用完就用两个字母（aa, ab, ...）</li>
<li>加上特殊字符（$, _）增加组合数</li>
</ol>
<p>所以你会看到 <code>a</code>、<code>$r</code>、<code>pv</code>、<code>Jt</code> 这种看起来毫无规律的名称。</p>
<h4 data-id="heading-30">React DevTools 怎么知道组件名</h4>
<p>React DevTools 获取组件名的逻辑：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[读取组件] --&gt; B{有 displayName?}
    B --&gt;|有| C[显示 displayName]
    B --&gt;|没有| D{有函数名?}
    D --&gt;|有| E[显示函数名]
    D --&gt;|没有| F[显示 Anonymous]
</code></pre>
<p>优先级：<code>displayName</code> &gt; <code>函数名</code> &gt; <code>"Anonymous"</code></p>
<p>开发环境：</p>
<ul>
<li>函数名完整保留 → DevTools 读到 <code>NavigationProvider</code></li>
</ul>
<p>生产环境：</p>
<ul>
<li>函数名被压缩成 <code>pv</code> → DevTools 只能读到 <code>pv</code></li>
<li>没设置 <code>displayName</code> → 没有备用方案</li>
</ul>
<p>所以就出现了开头那张图的情况。</p>
<h3 data-id="heading-31">为什么不是所有组件都乱码</h3>
<p>你可能注意到，有些组件名还是正常的，比如 <code>Link</code>、<code>Menu</code>、<code>Dialog</code>。</p>
<p>原因有三种：</p>
<h4 data-id="heading-32">1. 组件设置了 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
<span class="hljs-title class_">MyComponent</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'MyComponent'</span>;
</code></pre>
<p>压缩器不会改 <code>displayName</code>（它是字符串，不是标识符）。</p>
<h4 data-id="heading-33">2. 组件来自第三方库</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dialog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material'</span>;
</code></pre>
<p>第三方库通常会设置 <code>displayName</code>，或者配置了保留函数名的构建选项。</p>
<h4 data-id="heading-34">3. 名称太短，碰巧没变</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Link</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>如果原本就叫 <code>Link</code>，压缩后可能还是 <code>Link</code>（4 个字符，不一定值得压缩）。</p>
<p>但这纯靠运气，不能依赖。</p>
<h3 data-id="heading-35">怎么解决</h3>
<p>核心思路就两个方向：</p>
<h4 data-id="heading-36">1. 告诉压缩器：别改函数名</h4>
<p>Webpack/Vite 配置中，设置 Terser 选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">terserOptions</span>: {
    <span class="hljs-attr">keep_fnames</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 保留函数名</span>
}
</code></pre>
<p>代价：包体积增加 5-10%。</p>
<h4 data-id="heading-37">2. 手动给组件加 displayName</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">NavigationProvider</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>;
};

<span class="hljs-title class_">NavigationProvider</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'Navigation.Provider'</span>;
</code></pre>
<p>好处：精确控制，体积影响小。
代价：要手动维护。</p>
<h3 data-id="heading-38">该不该解决</h3>
<p><strong>内部系统/管理后台</strong>：</p>
<ul>
<li>调试需求高，体积不敏感</li>
<li>建议保留函数名，调试体验直接拉满</li>
</ul>
<p><strong>面向用户的产品</strong>：</p>
<ul>
<li>体积影响加载速度，调试主要在开发环境</li>
<li>不用管，或者只给核心组件加 displayName</li>
</ul>
<p><strong>开源组件库</strong>：</p>
<ul>
<li>用户调试需要清晰的组件名</li>
<li>建议加 displayName，或构建时保留函数名</li>
</ul>
<p>大多数情况，这不是个必须解决的问题。线上调试本来就该在 staging 环境（保留函数名），生产环境靠日志和监控。</p>
<h3 data-id="heading-39">相关资料</h3>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fterser.org%2Fdocs%2Foptions%2F" target="_blank" title="https://terser.org/docs/options/" ref="nofollow noopener noreferrer">Terser 文档</a></strong> - 了解 <code>keep_fnames</code> 等配置</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Freact-developer-tools%23why-is-my-component-called-_c" target="_blank" title="https://react.dev/learn/react-developer-tools#why-is-my-component-called-_c" ref="nofollow noopener noreferrer">React 官方：为什么我的组件叫 <code>_c</code>？</a></strong> - React 文档的解释</li>
</ol>
<hr/>
<p>搞清楚原理就好办了。遇到这种情况，知道是代码压缩导致的，而不是 React 或 DevTools 的 bug。</p>
<p>要不要解决，看具体需求。大部分时候，不用管。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java内存泄漏问题排查和JVM调优]]></title>    <link>https://juejin.cn/post/7572016447804309530</link>    <guid>https://juejin.cn/post/7572016447804309530</guid>    <pubDate>2025-11-13T09:07:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447804309530" data-draft-id="7571840220703932462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java内存泄漏问题排查和JVM调优"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-13T09:07:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="海边捡石子"/> <meta itemprop="url" content="https://juejin.cn/user/2335828265144488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java内存泄漏问题排查和JVM调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2335828265144488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    海边捡石子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:07:34.000Z" title="Thu Nov 13 2025 09:07:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java语言本身支持垃圾自动回收，在日常编程中我们几乎没有关注过对象回收的问题。解决内存泄漏可能停留在八股文上。今天分享一次项目中内存泄漏的排查流程到最终解决。</p>
<h2 data-id="heading-0">java自带了强大的命令行工具</h2>





























<table><thead><tr><th>工具</th><th>核心功能</th><th>主要应用场景</th><th>关键命令/示例</th></tr></thead><tbody><tr><td>**<code>jcmd</code>**​</td><td><strong>多功能诊断</strong>：一个强大的“瑞士军刀”，可执行丰富的诊断命令，涵盖JVM状态查询、内存、线程、GC控制等。</td><td><strong>综合诊断与运维</strong>：获取完整JVM信息（参数、属性）、动态控制（触发GC、开启JFR）、生成线程/堆转储。</td><td><code>jcmd &lt;pid&gt; VM.flags</code>（查看JVM参数） <code>jcmd &lt;pid&gt; Thread.print</code>（生成线程转储） <code>jcmd &lt;pid&gt; GC.heap_dump</code>（生成堆转储）</td></tr><tr><td>**<code>jmap</code>**​</td><td><strong>堆内存分析</strong>：专用于Java堆内存（Heap Memory）的直方图统计和堆转储（Heap Dump）文件生成。</td><td><strong>深度内存分析</strong>：排查内存泄漏、分析堆内对象分布、生成堆转储文件供MAT等工具深度分析。</td><td><code>jmap -histo:live &lt;pid&gt;</code>（存活对象直方图） <code>jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;</code>（生成堆转储）</td></tr><tr><td>**<code>jstat</code>**​</td><td><strong>JVM统计监控</strong>：持续监控JVM各种运行时指标，特别是垃圾回收（GC）相关数据和类加载信息。</td><td><strong>实时性能监控</strong>：监控GC行为（频率、耗时）、各内存区使用率、类加载/卸载情况，用于性能调优。</td><td><code>jstat -gcutil &lt;pid&gt; &lt;interval&gt; &lt;count&gt;</code>（GC情况摘要） <code>jstat -gc &lt;pid&gt; 1000 5</code>（GC详情，每秒1次共5次）</td></tr></tbody></table>
<h2 data-id="heading-1">Java垃圾回收算法</h2>
<p>Java垃圾回收算法，分代垃圾回收算法</p>
<ul>
<li>新生代：复制算法</li>
<li>老年代：标记-清除算法和标记-整理算法</li>
</ul>
<h2 data-id="heading-2">排查思路</h2>
<p>在解决问题的时候，先了解下我们项目JVM参数信息.</p>
<pre><code class="hljs language-js" lang="js">jcmd &lt;pid&gt; <span class="hljs-variable constant_">VM</span>.<span class="hljs-property">flags</span>
-<span class="hljs-attr">XX</span>:<span class="hljs-title class_">CICompilerCount</span>=<span class="hljs-number">15</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">InitialHeapSize</span>=<span class="hljs-number">1031798784</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MaxHeapSize</span>=<span class="hljs-number">16489906176</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MaxNewSize</span>=<span class="hljs-number">5496635392</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">MinHeapDeltaBytes</span>=<span class="hljs-number">524288</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">NewSize</span>=<span class="hljs-number">343932928</span> -<span class="hljs-attr">XX</span>:<span class="hljs-title class_">OldSize</span>=<span class="hljs-number">687865856</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseCompressedClassPointers</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseCompressedOops</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseFastUnorderedTimeStamps</span> -<span class="hljs-attr">XX</span>:+<span class="hljs-title class_">UseParallelGC</span>
</code></pre>
<h3 data-id="heading-3">第一种情况：</h3>
<p>项目运行在linux服务器上，进行压测，内存以肉眼可见的速度上升。
使用top命令查看进程占用内存情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e250f8b1505a49a49810f612f3d92c9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rW36L655o2h55-z5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629654&amp;x-signature=%2FJ4wiiHRmvzt6DxAYpOWoPWq4Zc%3D" alt="image.png" loading="lazy"/>
这里主要关注下<strong>RES</strong>
进程当前实际使用的、未被换出到交换空间（swap out）的<strong>物理内存</strong>。包含堆内存、非堆内存、堆外内存等。如果RES值持续上升，堆内存保持稳定，说明堆外内存在上升。</p>
<p>这个时候开始考虑使用jmap获取堆转存储。分析那些对象产生的泄漏。</p>
<h3 data-id="heading-4">常见的内存泄漏，</h3>
<p>HashMap 、队列、线程池、websocket等资源没有正确的释放，另外一种是我们的程序调用了native方法，但没有释放资源。</p>
<p>发现泄漏后，最直接的办法生成jvm对象快照。生成<strong>堆转储</strong>文件，</p>
<h3 data-id="heading-5">内存分析工具</h3>
<p><strong>MAT（Memory Analyzer Tool）</strong> ：最常用的堆分析工具，支持自动检测泄漏嫌疑人（Leak Suspects）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1572a88c2cef490da539753a84cf3faa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rW36L655o2h55-z5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629654&amp;x-signature=1OtTQoTTSvKkemUrH5oeiqaNbWc%3D" alt="image.png" loading="lazy"/>
泄漏嫌疑直接能看到使用websocket相关操作导致的</p>
<h5 data-id="heading-6">关键分析步骤：</h5>
<ol>
<li>
<p><strong>识别 “可疑大对象”</strong> ：</p>
<ul>
<li>在 MAT 中查看 “Histogram”（直方图），按 “Retained Heap”（对象被回收后可释放的内存）排序，找出占用内存前几名的类（如某业务 POJO、集合类）。</li>
<li>关注 “Shallow Heap”（对象本身大小）小但 “Retained Heap” 大的对象（通常是集合，持有大量子对象引用）。</li>
</ul>
</li>
<li>
<p><strong>追溯引用链（支配树 / 引用树）</strong> ：</p>
<ul>
<li>对可疑对象右键选择 “Merge Shortest Paths to GC Roots”（排除弱引用 / 软引用等可被 GC 自动回收的引用类型），查看谁在 “强引用” 该对象。</li>
<li>核心是找到 “根对象”（如静态变量、线程对象、类加载器），这些对象不会被 GC 回收，若其引用链中包含本应释放的对象，则导致泄漏。</li>
</ul>
<p>例：若发现大量<code>User</code>对象被<code>HashMap</code>持有，且<code>HashMap</code>是<code>UserCache</code>类的静态变量，而<code>UserCache</code>未设置过期清理逻辑，则可定位为 “静态缓存未释放” 导致的泄漏。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结]]></title>    <link>https://juejin.cn/post/7572021695293571122</link>    <guid>https://juejin.cn/post/7572021695293571122</guid>    <pubDate>2025-11-13T08:53:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695293571122" data-draft-id="7571726099689062419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结"/> <meta itemprop="keywords" content="MongoDB"/> <meta itemprop="datePublished" content="2025-11-13T08:53:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WangHappy"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows搭建MongoDB(5)：Mongosh操作数据库常用命令总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WangHappy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:53:47.000Z" title="Thu Nov 13 2025 08:53:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>大家好，我是WangHappy，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于<code>前端进阶全栈的常用技术</code> 和 <code>基本入门操作</code>。 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注）。</p>
<hr/>
<p>在前端转型全栈的过程中，我们多数情况下使用 node.js 来开发服务端，而 node.js 里操作MongoDB数据库最常用的库是 mongoose，所以 mongosh 在实际开发中的使用频率并不是很高，多用于测试或查看数据库状态等场景。</p>
<p>本章只讲述 Mongosh 一些常用命令，例如：数据库基本的增、删、改、查（CRUD）和状态信息获取等操作，能够满足我们日常开发使用即可。</p>
<h3 data-id="heading-1">1.连接数据库</h3>
<p><strong>1.1 本地连接数据库</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">mongosh --dbpath <span class="hljs-string">"path/data"</span>
</code></pre>
<p><strong>1.2 远程连接数据库</strong></p>
<pre><code class="hljs language-xml" lang="xml">mongosh "mongodb://<span class="hljs-tag">&lt;<span class="hljs-name">hostname</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>"
</code></pre>
<p>举例：<code>mongosh "mongodb://192.168.0.0:27017"</code></p>
<p><strong>1.3 远程连接数据库并使用用户名密码验证</strong></p>
<pre><code class="hljs language-xml" lang="xml">mongosh "mongodb://<span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>@<span class="hljs-tag">&lt;<span class="hljs-name">hostname</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>"
</code></pre>
<p>举例：<code>mongosh "mongodb://admin:admin123@192.168.0.0:27017"</code></p>
<h3 data-id="heading-2">2.查看数据库状态</h3>
<p><strong>2.1 查看当前使用的数据库</strong></p>
<pre><code class="hljs">db
</code></pre>
<ul>
<li><strong>切换数据库</strong></li>
</ul>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">use</span> &lt;database_name&gt;
</code></pre>
<p>举例：<code>use admin</code></p>
<p>如果切换的数据库名称当前不存在，则会在 <code>insert</code> 插入数据时自动创建</p>
<blockquote>
<p>注意：是插入数据时创建，而不是使用 <code>use</code> 切换时创建。</p>
</blockquote>
<p><strong>2.2 列出MongoDB实例下所有的数据库</strong></p>
<p><code>show databases</code> 可以查看目前所有的数据库，也可以使用简写 <code>show dbs</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">show</span> databases
</code></pre>
<p><strong>2.3 列出当前数据库下所有集合</strong></p>
<p>理论上每个数据库下都可以包含一个或多个集合，它有点类似于我们传统关系型数据库中的 <code>表</code> 的概念。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">show</span> collections
</code></pre>
<p><strong>2.4 退出 mongosh</strong></p>
<p>使用 <code>exit</code> 可以直接退出mongosh数据库连接，也可以使用 <code>ctrl + c</code> 快捷键来退出</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">exit</span>
</code></pre>
<h3 data-id="heading-3">3.数据库的增删改查</h3>
<p><strong>3.1 插入数据</strong></p>
<p>使用 <code>insertOne</code> 插入一条数据，使用 <code>insertMany</code> 插入多条数据，代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 插入一条数据</span>
db.user.<span class="hljs-title function_ invoke__">insertOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Mike"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> })

<span class="hljs-comment">// 插入多条数据</span>
db.user.<span class="hljs-title function_ invoke__">insertMany</span>([{ <span class="hljs-attr">name</span>: <span class="hljs-string">"Marry"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }, { <span class="hljs-attr">name</span>: <span class="hljs-string">"Kerry"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">35</span> }])
</code></pre>
<p><strong>3.2 删除数据</strong></p>
<p>使用 <code>deleteOne</code> 删除单个文档，使用 <code>deleteMany</code> 删除多个文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 删除单个文档</span>
db.user.<span class="hljs-title function_ invoke__">deleteOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> })

<span class="hljs-comment">// 删除年龄30岁以下的数据</span>
db.user.<span class="hljs-title function_ invoke__">deleteMany</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$lt</span>: <span class="hljs-number">30</span> } })
</code></pre>
<p><strong>3.3 更新数据</strong></p>
<p>使用 <code>updateOne</code> 更新单个文档，使用 <code>updateMany</code> 更新多个文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 更新单个文档</span>
db.user.<span class="hljs-title function_ invoke__">updateOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> }, { <span class="hljs-variable">$set</span>: { <span class="hljs-attr">age</span>: <span class="hljs-number">31</span> } })

<span class="hljs-comment">// 更新多个文档</span>
db.user.<span class="hljs-title function_ invoke__">updateMany</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$lt</span>: <span class="hljs-number">30</span> } }, { <span class="hljs-variable">$set</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"young"</span> } })
</code></pre>
<p><strong>3.4 查询数据</strong></p>
<p>使用 <code>find</code> 查询集合中所有数据</p>
<pre><code class="hljs language-lua" lang="lua">db.user.<span class="hljs-built_in">find</span>()
</code></pre>
<p>查询某个条件的文档</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 查询30岁以下的数据</span>
db.user.<span class="hljs-title function_ invoke__">find</span>({ <span class="hljs-attr">age</span>: { <span class="hljs-variable">$gte</span>: <span class="hljs-number">30</span> } })
</code></pre>
<p><strong>3.5 创建索引</strong></p>
<p>为某个字段创建索引</p>
<pre><code class="hljs language-css" lang="css">db<span class="hljs-selector-class">.user</span><span class="hljs-selector-class">.createIndex</span>({ name: <span class="hljs-number">1</span> })
</code></pre>
<p><strong>3.6 查看当前集合下的所有索引</strong></p>
<pre><code class="hljs language-scss" lang="scss">db<span class="hljs-selector-class">.users</span><span class="hljs-selector-class">.getIndexes</span>()
</code></pre>
<p>执行上述代码通常会返回两个索引，<code>_id</code> 和 <code>name</code></p>
<p><code>_id</code> 索引：是自动创建，用于确保每条数据的唯一性。</p>
<p><code>name</code> 索引：自定义索引，方便对指定字段的查询操作，例如 <code>name: 1</code> 表示按升序排列，如果改为 <code>name: -1</code> 表示降序。</p>
<h3 data-id="heading-4">4.其它命令</h3>

















<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>version()</td><td>查看当前使用 <code>mongosh</code> 的版本</td></tr><tr><td>help</td><td>查看 <code>mongosh</code> 的帮助信息, 查看某个命令的帮助信息，<code>&lt;name&gt;.help()</code>, 例如：db.help()</td></tr></tbody></table>
<h3 data-id="heading-5">写在最后</h3>
<hr/>
<p>本章整理了 <code>mongosh</code> 中一些常用命令，方便大家在日常使用中参考。虽然 <code>mongosh</code> 功能强大，但像 <strong>聚合查询</strong>等更贴近业务场景的功能，我通常会通过 <code>mongoose</code> 来实现。接下来，我将继续编写关于 <code>node.js + mongoose</code> 的使用教程，并与大家分享更多实践经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android http网络请求的那些事儿]]></title>    <link>https://juejin.cn/post/7572132100326441010</link>    <guid>https://juejin.cn/post/7572132100326441010</guid>    <pubDate>2025-11-13T08:59:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132100326441010" data-draft-id="7572016447804080154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android http网络请求的那些事儿"/> <meta itemprop="keywords" content="OKHttp,HTTP"/> <meta itemprop="datePublished" content="2025-11-13T08:59:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天花板之恋"/> <meta itemprop="url" content="https://juejin.cn/user/2027980375463565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android http网络请求的那些事儿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2027980375463565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天花板之恋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:59:51.000Z" title="Thu Nov 13 2025 08:59:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.http协议</h3>
<p>http协议通常是基于<code>TCP/IT</code>协议之上的应用层协议，http默认端口是<code>80</code>，https默认端口是<code>443</code>。</p>
<p>http协议是无状态的协议，基于请求/响应的模型，先有请求，再有响应。</p>
<p>http请求报文包括：请求行、请求头、请求体</p>
<p>http响应报文包括：响应行、响应头、响应体</p>
<h3 data-id="heading-1">2.http请求报文结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1061d774eb6442d860799c0d7ffd8d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=0vzUkq1wpQuA8XbiHtxi4XcDFXc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>请求行</strong>：
主要包括请求方式以及请求目标的<code>URL</code>
例如：<em>POST /chapter17/user.html HTTP/1.1</em></p>
<p><code>POST</code>代表请求方式， <code>/chapter17/user.html</code>表示请求的URL</p>
</li>
<li>
<p><strong>请求头</strong>：
包含一些key-value值，主要包括Cookie值、请求体的数据类型、请求体的数据长度等例如：</p>
<p>Content-Type: application/x-www-form-urlencoded</p>
<p>Content-Length: 37</p>
<p>Cookie: token_pass=92595c118b66417c395eb125e12c3438</p>
</li>
<li>
<p><strong>请求体</strong>：
具体的数据，比如登陆时候的用户名和密码：
username=gandalf&amp;password=19920930yus</p>
</li>
</ul>
<h3 data-id="heading-2">3.http不同请求方式</h3>
<p>请求方式有多种，常见的有<code>GET</code>、<code>POST</code>和<code>HEAD</code></p>
<ul>
<li>
<p><strong>GET请求</strong>：
GET请求没有请求体，会把参数直接加在URL后面，不安全，并且有长度限制。
但请求简单，是HTTP请求中使用最多的方式。</p>
</li>
<li>
<p><strong>POST请求</strong>：
请求的参数在请求头内，较安全，且数据大小没有限制，适合提交较大的表单数据。</p>
</li>
<li>
<p><strong>HEAD请求</strong>：
跟GET相似，只是服务器只会返回响应头，通常只为了查询某个页面的状态。</p>
</li>
</ul>
<h3 data-id="heading-3">4.http响应报文结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71acc7d6843640139ef47c383ba9ac62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=pkD6QZdS8M1WokSvDtdmnevwSYA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>响应行</strong>：
主要包含状态码</p>
<p>1xx:指示信息，表示请求已接收，继续处理</p>
<p>2xx:成功，表示请求已被成功接受</p>
<p>3xx:重定向</p>
<p>4xx:客户端错误</p>
<p>5xx:服务器端错误</p>
</li>
<li>
<p><strong>响应头</strong>：
包含多个<code>key-value</code>对，主要包括：<code>Content-Type</code>响应正文的类型（MIME类型）、Set-Cookie 于会话状态相关的<code>Cookie</code>技术</p>
</li>
<li>
<p><strong>响应体</strong>：
数据内容，常用的如<code>json</code>纯文本内容、图片数据等</p>
</li>
</ul>
<h3 data-id="heading-4">5.https协议</h3>
<p>由于<code>http</code>是明文传输，信息容易被篡改和窃取，所以增加了<code>https</code>协议。</p>
<p>https协议是在http协议的基础上，对报文做了对称加密的处理，并且加密密钥只会在客户端和服务端保存，保证了信息的安全。</p>
<p>https协议的前提，是需要有一个公正权威的机构，叫<code>CA</code>机构，它内部维护了一套非对称加密的<code>公钥P</code>和<code>私钥P'</code>，公钥P会发布出来，浏览器会内置这个公钥。</p>
<p>一个网站如果要使用https协议，需要先在CA申请数字证书。</p>
<h3 data-id="heading-5">6.https协议加密过程</h3>
<p>前置条件完毕，接下来看具体的步骤：</p>
<ol>
<li>首先网站有一对<code>公钥P1</code>和<code>私钥P1’</code>，然后把包含网站公钥P1、域名等信息的数据Data提供给CA机构。</li>
<li>CA对Data做<code>Hash</code>算法得到一段<code>散列码H</code>；用P'对H做加密得到数字<code>签名S</code>；把S和Data数据打包一起就是数字证书，给到网站。</li>
<li>客户端和服务端建立http连接之后，服务端会把数字证书发给客户端。客户端会得到数字签名S和原始数据Data，然后使用CA的公钥P对S解密得到<code>散列码H</code>。</li>
<li>客户端会对Data做同样的hash算法得到<code>散列码H'</code>，判断H'和H是否相等，如果相等，则表示<code>公钥P1</code>是可信的。</li>
<li>客户端会针对此次对话随机生成一个对称加密密钥<code>SK</code>，并使用P1对SK信息做加密，传递给服务器。</li>
<li>服务器在收到客户端数据后，使用自己的私钥P1'做解码，获取到了本次的SK，并开始做加密通信。</li>
</ol>
<p>流程图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79d62b7b541547e49296152044c889be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6Iqx5p2_5LmL5oGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763629190&amp;x-signature=ho94erorHsoj7cYkbMIwBz5M7Fc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>关键点补充</strong>：
CA的存在是为了保证客户端判断来自服务器公钥的可靠性。
前期非对称加密的一系列动作，是为了保证最后对称加密的密钥不能被第三方获取。
最后通信数据使用对称加密（<code>AES）</code>，是因为非对称加密很耗性能，而对称加密效率更高。</li>
</ul>
<h3 data-id="heading-6">7.Cookie</h3>
<p>由于<code>http/https</code>是没有状态的协议，整个过程是请求/应答模式，而有些数据的请求是需要有状态的，比如：
请求收藏列表数据，那么肯定是需要先登陆才行，否则就会提示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{<span class="hljs-string">"errorCode"</span>:-<span class="hljs-number">1001</span>,<span class="hljs-string">"errorMsg"</span>:<span class="hljs-string">"请先登录！"</span>}
</code></pre>
<p>因此引入了<code>Cookie</code>技术。</p>
<p>首先服务端会在响应头中带有<code>Set-Cookie </code>字段的数据，当客户端解析到这样的响应头数据时，就可以把这些数据保存在本地。</p>
<p>当客户端下次要发起请求的时候，就可以把这些Cookie写入到请求头中，这样服务端就可以清楚状态并返回正确的数据了。</p>
<p>比如我们登陆了WanAndroid账号之后，服务端返回的响应报文头包含：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Set-Cookie: JSESSIONID=354B46332F155D0823934D17025C01CB; Path=/; Secure; HttpOnly
Set-Cookie: loginUserName=gandalf; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: token_pass=92595c118b66417c395eb125e12c3438; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: loginUserName_wanandroid_com=gandalf; Domain=wanandroid.com; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
Set-Cookie: token_pass_wanandroid_com=92595c118b66417c395eb125e12c3438; Domain=wanandroid.com; Expires=Fri, <span class="hljs-number">12</span>-Dec-<span class="hljs-number">2025</span> <span class="hljs-number">07</span>:<span class="hljs-number">00</span>:<span class="hljs-number">21</span> GMT; Path=/
</code></pre>
<p>当我们请求收藏数据的时候，就需要把以上的Cookie信息带上，这样就会获取到收藏列表数据了，否则就会提示“请先登录！”。</p>
<h3 data-id="heading-7">8.OkHttp</h3>
<p>Android使用http网络协议的利器，它负责处理<code>HTTP/1.1</code>、<code>HTTP/2</code>、<code>SPDY</code>的请求和响应，可以理解为一个装备精良的“快递员”。</p>
<p>OkHttp 负责处理所有网络通信的底层脏活累活：</p>
<ul>
<li>通过连接池 <code>ConnectionPool</code>，高效地复用 <code>TCP </code>连接；</li>
<li><code>socket</code>自动选择最好路线，并支持自动重连；</li>
<li>拥有队列线程池，轻松写并发，支持同步和异步两种请求方式；</li>
<li>拥有强大的拦截器机制（<code>interceptors</code>），可以轻松修改请求报文和响应报文，比如统一修改请求头、日志记录、加解密、Cookie缓存等。</li>
</ul>
<h3 data-id="heading-8">9.OkHttp的执行流程</h3>
<ol>
<li>首先需要构造一个<code>OkHttpClient</code>客户端，并且在客户端配置相关的拦截器和监听器，以便扩展自定义的操作。</li>
<li>构建<code>Request</code>请求类，包含<code>URL</code>、<code>Post</code>参数等信息。</li>
<li>然后通过OkHttpClient客户端去构建一个<code>Call</code>类型的对象，代表一次请求。Call有两个方法，一个方法是<code>execute（）</code>，表示同步执行请求；
另一个方法是<code>enqueue（）</code>，表示把请求加入队列，实际会进入到Dispatcher的<code>runningAsyncCalls</code>这样的一个队列，并等待异步执行。</li>
<li>不管是同步执行还是异步执行，在执行的时候，都会先构建一个拦截器链（<code>RealInterceptorChain</code>），它会add很多默认的或者我们自定义的拦截器。</li>
<li>一个拦截器执行完之后，会调用下一个拦截器，直到调用到最后一个<code>CallServiceInterceptor</code>并返回一个<code>Response</code>。</li>
</ol>
<h3 data-id="heading-9">10.OkHttp使用示例</h3>
<p>只使用OkHttp的情况下，如果我们要发起一次登陆请求，则代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 创建客户端</span>
<span class="hljs-keyword">val</span> client = OkHttpClient()

<span class="hljs-comment">// 2. 手动构建请求 (URL, 请求头, 请求体)</span>
<span class="hljs-keyword">val</span> requestBody = FormBody.Builder()
    .add(<span class="hljs-string">"username"</span>, <span class="hljs-string">"gandalf"</span>)
    .add(<span class="hljs-string">"password"</span>, <span class="hljs-string">"1234567"</span>)
    .build()

<span class="hljs-keyword">val</span> request = Request.Builder()
    .url(<span class="hljs-string">"https://api.example.com/login"</span>)
    .post(requestBody)
    .build()


<span class="hljs-comment">// 3. 发起异步请求，并手动处理回调</span>
client.newCall(request).enqueue(<span class="hljs-keyword">object</span> : Callback {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
        <span class="hljs-comment">// 处理网络失败</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
        <span class="hljs-comment">// 在子线程中</span>
        <span class="hljs-keyword">val</span> responseBodyString = response.body?.string()
        <span class="hljs-comment">// 4. 手动解析 JSON 字符串</span>
        <span class="hljs-keyword">val</span> user = Gson().fromJson(responseBodyString, User::<span class="hljs-keyword">class</span>.java)
        <span class="hljs-comment">// 5. 手动切换回主线程更新 UI</span>
    }
})
</code></pre>
<p>这里创建的OkHttpClient客户端是最简单的方式，如果想要添加其他配置项，比如<code>Cookie</code>的操作、<code>http日志</code>打印操作等，就需要在这里做配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> intercepter = HttpLoggingInterceptor().apply {
        level = HttpLoggingInterceptor.Level.BODY
    }

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> okhttpClient = OkHttpClient.Builder()
        .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)   <span class="hljs-comment">// 读超时时间</span>
        .writeTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)  <span class="hljs-comment">// 写超时时间</span>
        .connectTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS) <span class="hljs-comment">//连接超时时间</span>
        .addInterceptor(intercepter)  <span class="hljs-comment">// 添加日志打印的拦截器</span>
	.cookieJar(MyCookieJar()) <span class="hljs-comment">//添加Cookie操作</span>
        .build()
</code></pre>
<p>这里实现了CookieJar接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCookieJar</span> : <span class="hljs-type">CookieJar</span> {
    <span class="hljs-comment">//Http发送请求前回调，Request中设置Cookie</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadForRequest</span><span class="hljs-params">(url: <span class="hljs-type">HttpUrl</span>)</span></span>: List&lt;Cookie&gt; {
        <span class="hljs-keyword">val</span> cookieList = mutableListOf&lt;Cookie&gt;()
        CookieManager.getInstance().getCookie(url.host)?.let {
            <span class="hljs-keyword">if</span> (it.isNotEmpty()) {
                <span class="hljs-keyword">val</span> cookies = it.split(<span class="hljs-string">";"</span>.toRegex())
                <span class="hljs-keyword">for</span> (cookie <span class="hljs-keyword">in</span> cookies) {
                    Cookie.parse(url, cookie)?.apply {
                        cookieList.add(<span class="hljs-keyword">this</span>)
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> cookieList
    }


    <span class="hljs-comment">//Http请求结束，Response中有Cookie时候回调，并在回调中实现Cookie的保存</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveFromResponse</span><span class="hljs-params">(
        url: <span class="hljs-type">HttpUrl</span>,
        cookies: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Cookie</span>&gt;
    )</span></span> {
        <span class="hljs-keyword">val</span> cookieManager = CookieManager.getInstance()
        cookieManager.setAcceptCookie(<span class="hljs-literal">true</span>)
        <span class="hljs-keyword">for</span> (cookie <span class="hljs-keyword">in</span> cookies) {
            cookieManager.setCookie(url.toString(), cookie.toString())
        }
        cookieManager.flush()
    }
}
</code></pre>
<h3 data-id="heading-10">11. Retrofit</h3>
<p><code>Retrofit</code>是一种更高层级的封装，它让开发者更容易去描述“做什么”。而它自己会把这些业务层的逻辑转换成OkHttp能够识别的指令，具体“怎么做”的事情，就交给OkHttp去完成。</p>
<p>Retrofit的优势有如下几点：</p>
<ol>
<li><strong>API接口化</strong>：使用简单的Interface接口来定义一组业务关系API。</li>
<li><strong>注解驱动</strong>：通过 <code>@GET``````@POST</code>, <code>@Path</code>, <code>@Query</code>, <code>@Body </code>等注解，你可以清晰地描述每个请求的 URL、HTTP 方法、参数和请求体</li>
<li><strong>序列化/反序列化</strong>：通过可自由配置的转换器（<code>Converter</code>），如<code>retrofit2:converter-gson</code>，自动将 对象转换成请求体JSON，以及将响应体JSON自动转换成定义好的数据模型对象（Data Class）。</li>
<li><strong>适配协程</strong>：能将标准的网络调用无缝集成到协程框架中</li>
</ol>
<p>基本使用方式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 在接口中声明 API</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiService</span> {
    <span class="hljs-meta">@POST(<span class="hljs-string">"login"</span>)</span>
    <span class="hljs-meta">@FormUrlEncoded</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-meta">@Field(<span class="hljs-string">"username"</span>)</span> username: <span class="hljs-type">String</span>)</span></span>: User
}

<span class="hljs-comment">// 2. 创建 Retrofit 实例 (它内部会持有并使用一个 OkHttpClient)</span>
<span class="hljs-keyword">val</span> retrofit = Retrofit.Builder()
    .baseUrl(<span class="hljs-string">"https://api.example.com/"</span>)
    .client(myOkHttpClient) <span class="hljs-comment">// 把 OkHttp 引擎装进去</span>
    .addConverterFactory(GsonConverterFactory.create())
    .build()

<span class="hljs-keyword">val</span> apiService = retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)

<span class="hljs-comment">// 3. 在协程中像调用本地方法一样调用 API</span>
viewModelScope.launch {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> user = apiService.login(<span class="hljs-string">"test"</span>)  <span class="hljs-comment">// 直接得到 User 对象，不用关心 JSON 解析和线程切换</span>
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// 统一处理所有错误</span>
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么要使用 .asStateFlow() 而不是直接赋值？]]></title>    <link>https://juejin.cn/post/7572132100326539314</link>    <guid>https://juejin.cn/post/7572132100326539314</guid>    <pubDate>2025-11-13T09:18:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572132100326539314" data-draft-id="7572130072262524974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么要使用 .asStateFlow() 而不是直接赋值？"/> <meta itemprop="keywords" content="Kotlin"/> <meta itemprop="datePublished" content="2025-11-13T09:18:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="默契之行"/> <meta itemprop="url" content="https://juejin.cn/user/3825956197501854"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么要使用 .asStateFlow() 而不是直接赋值？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956197501854/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    默契之行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:18:34.000Z" title="Thu Nov 13 2025 09:18:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>记录开发过程中疑问，如果说的不对，欢迎提出修改</p>
<p>这里我使用了两个<code>MutableStateFlow</code>和两个<code>StateFlow</code>做说明，其中strList是由<code>_strList.asStateFlow()</code>赋值，而<code>str2List</code>由<code>_strList</code>直接赋值。这两种在代码运行都能正常运行，这也是为什么我对此有疑问，从而做下笔记梳理</p>
</blockquote>
<h3 data-id="heading-0">示例代码及运行结果</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _strList = MutableStateFlow&lt;List&lt;String&gt;&gt;(listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>))
<span class="hljs-keyword">val</span> strList: StateFlow&lt;List&lt;String&gt;&gt; = _strList.asStateFlow()

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _str2List = MutableStateFlow&lt;List&lt;String&gt;&gt;(listOf(<span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>))
<span class="hljs-keyword">val</span> str2List: StateFlow&lt;List&lt;String&gt;&gt; = _str2List

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testAsStateFlow</span><span class="hljs-params">()</span></span> = runTest {
    launch {
        strList.collect { println(<span class="hljs-string">"strList 收到新值: <span class="hljs-variable">$it</span>"</span>) }
    }
    launch {
        delay(<span class="hljs-number">500</span>) 
        (strList <span class="hljs-keyword">as</span>? MutableStateFlow)?.value = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>)
    }
    launch {
        str2List.collect { println(<span class="hljs-string">"str2List 收到新值: <span class="hljs-variable">$it</span>"</span>) }
    }
    launch {
        delay(<span class="hljs-number">500</span>)
        (str2List <span class="hljs-keyword">as</span>? MutableStateFlow)?.value = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>)
    }
}
</code></pre>
<p>下面是运行结果，可以看出通过.<code>asStateFlow</code>() 赋值的<code>strList</code> 无法直接通过<code>asStateFlow</code>转换从而修改参数,而<code>str2List</code>却可以</p>
<p><strong>strList 收到新值: [A, B, C]</strong></p>
<p><strong>str2List 收到新值: [X, Y, Z]</strong></p>
<p><strong>str2List 收到新值: [A, X, Y, Z]</strong></p>
<h3 data-id="heading-1">1. 什么是 <code>MutableStateFlow</code> 和 <code>StateFlow</code>？</h3>
<ul>
<li><code>MutableStateFlow</code> 是一种可变的状态流，它允许我们通过 <code>value</code> 属性修改流中的状态。</li>
<li><code>StateFlow</code> 是一种不可变的状态流，它只暴露给外部读取状态的能力，而不能修改状态。</li>
</ul>
<p>通常，在封装状态时，我们将 <code>MutableStateFlow</code> 定义为私有属性（例如 <code>_strList</code>），而将其暴露为不可变的 <code>StateFlow</code>（例如 <code>strList</code>），这样外部代码只能读取状态，而无法修改它。</p>
<h3 data-id="heading-2">2. 为什么不建议直接赋值？</h3>
<p>在上述代码中，如果直接将 <code>_strList</code> 或 <code>_str2List</code> 作为 <code>StateFlow</code> 来暴露，会导致外部代码可以通过强制转换或直接访问 <code>_strList</code> 或 <code>_str2List</code> 来修改其值。这样可能会破坏状态的不可变性，导致不可预测的副作用或状态变更。</p>
<p>例如，在以下代码中，尝试直接修改 <code>strList</code> 的值：</p>
<pre><code class="hljs language-ini" lang="ini">(strList as? MutableStateFlow)?.<span class="hljs-attr">value</span> = listOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>)
</code></pre>
<p>虽然 <code>strList</code> 是 <code>StateFlow</code> 类型，它不能直接修改，但通过强制转换为 <code>MutableStateFlow</code> 类型，代码可以绕过不可变性并直接修改 <code>value</code> 属性。这违背了状态不可变性的设计原则，容易导致不可控的状态更改。</p>
<h3 data-id="heading-3">3. <code>asStateFlow</code> 的作用</h3>
<p>使用 <code>asStateFlow()</code> 方法可以将 <code>MutableStateFlow</code> 转换为不可变的 <code>StateFlow</code>。这样，外部代码只能读取状态，而无法修改它。通过这种方式，我们可以确保状态的不可变性并防止外部代码直接更改状态。</p>
<pre><code class="hljs language-swift" lang="swift">val strList: <span class="hljs-type">StateFlow</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;&gt; <span class="hljs-operator">=</span> _strList.asStateFlow()
</code></pre>
<p>这样，外部代码只能使用 <code>strList.collect { ... }</code> 来收集状态的变化，而不能修改 <code>strList</code> 的值。这使得状态管理更加安全和可控。</p>
<h3 data-id="heading-4">4. 总结</h3>
<ul>
<li><code>MutableStateFlow</code> 提供了修改状态的能力，而 <code>StateFlow</code> 只允许读取状态。</li>
<li>使用 <code>asStateFlow()</code> 可以将 <code>MutableStateFlow</code> 转换为不可变的 <code>StateFlow</code>，从而保护状态不被外部代码直接修改。</li>
<li>通过这种方式，我们可以确保状态的不可变性，减少副作用，使代码更加健壮和可维护。</li>
</ul>
<h3 data-id="heading-5">5.延伸问题：为什么要使用 <code>asSharedFlow</code>？</h3>
<p>类似于 <code>StateFlow</code>，<code>SharedFlow</code> 也有可变和不可变的版本。<code>MutableSharedFlow</code> 允许外部代码通过 <code>emit()</code> 向流中发送事件，而 <code>SharedFlow</code> 则是一个只读流，只能被外部代码订阅和收集，不能直接修改流中的内容。</p>
<p>为了确保流的不可变性，应该使用 <code>asSharedFlow()</code> 方法将 <code>MutableSharedFlow</code> 转换为不可变的 <code>SharedFlow</code>。这样，外部代码只能订阅事件流，而不能通过 <code>emit()</code> 向流中发送事件，避免了意外修改流内容的副作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用awesome-digital-human-live2d创建属于自己的数字人]]></title>    <link>https://juejin.cn/post/7572016447804325914</link>    <guid>https://juejin.cn/post/7572016447804325914</guid>    <pubDate>2025-11-13T09:16:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447804325914" data-draft-id="7571892340878458918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用awesome-digital-human-live2d创建属于自己的数字人"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T09:16:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="suzumiyahr"/> <meta itemprop="url" content="https://juejin.cn/user/248966809390851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用awesome-digital-human-live2d创建属于自己的数字人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/248966809390851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    suzumiyahr
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:16:11.000Z" title="Thu Nov 13 2025 09:16:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.AWESOME-DIGITAL-HUMAN是什么</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FGitHub_Trending%2Faw%2Fawesome-digital-human-live2d%2Fblob%2Fmain%2FREADME.md" target="_blank" title="https://gitcode.com/GitHub_Trending/aw/awesome-digital-human-live2d/blob/main/README.md" ref="nofollow noopener noreferrer">AWESOME-DIGITAL-HUMAN</a>是一款国产开源的数字人框架</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e332a04e0bbf4bdc95ab3334522e1ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=UkUYHJnR%2BGxUm%2FeAlDgMVtcftgE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2.准备工作</h2>
<p>下载源码 git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwan-h%2Fawesome-digital-human-live2d.git" target="_blank" title="https://github.com/wan-h/awesome-digital-human-live2d.git" ref="nofollow noopener noreferrer">github.com/wan-h/aweso…</a>
项目目录如下：</p>
<pre><code class="hljs language-." lang=".">├── config.yaml                  # 全局配置文件
├── agents                       # agent 配置文件目录
└── engines                      # 引擎配置文件目录
    ├── asr                      # 语音识别引擎配置文件目录
    ├── llm                      # 大模型引擎配置文件目录
    └── tts                      # 文字转语音引擎配置目录
</code></pre>
<p>容器部署：docker-compose up --build -d
创建一个千问智能体，以备后用
开通腾讯tts服务，以备后用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a88dd46cfdf5468298433442db1d779a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=sXrmdQcHIu2THVOE%2BJKZ%2FVgIr1I%3D" alt="image.png" loading="lazy"/></p>
<p>打开8880端口，发现项目已经成功启动了，可以修改很多配置，比如人物的模型，背景，声音，可以使用的agent等等</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2375991d638c4ec093a2d36b87aa6af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=mmJHGwRIn1pKth4sDWaSl5MyZT0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">2.项目修改</h2>
<p>修改configs\engines\tts\tencentAPI.yaml文件的相关配置，选择我们喜欢的语音</p>
<pre><code class="hljs language-NAME:" lang="NAME:">VERSION: "v0.0.1"
DESC: "接入腾讯服务"
META: {
  official: "",
  configuration: "https://console.cloud.tencent.com/tts",
  tips: "",
  fee: ""
}
PARAMETERS: [
  {
    name: "secret_id",
    description: "tencent secret_id.",
    type: "string",
    required: false,
    choices: [],
    default: "腾讯tts的  secret_id"
  },
  {
    name: "secret_key",
    description: "tencent secret_key.",
    type: "string",
    required: false,
    choices: [],
    default: "腾讯tts的 secret_key"
  },
  {
    name: "voice",
    description: "Voice for TTS.",
    type: "string",
    required: false,
    choices: [],
    default: "爱小璟"
  },
  {
    name: "volume",
    description: "Set volume, default +0%.",
    type: "float",
    required: false,
    range: [-10, 10],
    default: 0.0
  },
  {
    name: "speed",
    description: "Set speed, default +0%.",
    type: "float",
    required: false,
    range: [-2, 6],
    default: 0.0
  }
]
</code></pre>
<p>打开config_template.yaml文件，可以发现目前是不支持通义千问的，首先增加对千问的支持</p>
<pre><code class="hljs language-COMMON:" lang="COMMON:">  NAME: "Awesome-Digital-Human"
  VERSION: "v3.0.0"
  LOG_LEVEL: "DEBUG"
SERVER:
  IP: "0.0.0.0"
  PORT: 8880
  WORKSPACE_PATH: "./outputs"
  ENGINES:
    ASR: 
      SUPPORT_LIST: [ "difyAPI.yaml", "cozeAPI.yaml", "tencentAPI.yaml", "funasrStreamingAPI.yaml"]
      DEFAULT: "difyAPI.yaml"
    TTS: 
      SUPPORT_LIST: [ "edgeAPI.yaml", "tencentAPI.yaml", "difyAPI.yaml", "cozeAPI.yaml" ]
      DEFAULT: "tencentAPI.yaml"
    LLM:
      SUPPORT_LIST: []
      DEFAULT: ""
  AGENTS:
    SUPPORT_LIST: [ "repeaterAgent.yaml", "openaiAPI.yaml", "difyAgent.yaml", "fastgptAgent.yaml", "cozeAgent.yaml"]
    DEFAULT: "repeaterAgent.yaml"
</code></pre>
<p>在SUPPORT_LIST里增加qwenAgent.yaml 并设置为默认。
在configs agent目录里增加一个qwenAgent.yaml文件</p>
<pre><code class="hljs language-NAME:" lang="NAME:">VERSION: "v0.0.1"
DESC: "接入通义千问智能体（DashScope Application）"
META: {
  official: "https://bailian.console.aliyun.com/",
  configuration: "需在百炼平台创建应用并获取 App ID",
  tips: "支持多轮对话、流式输出、自动会话管理。提示词和知识库已在智能体后台配置。",
  fee: "按 DashScope 定价计费"
}
# 暴露给前端的参数选项以及默认值
PARAMETERS: [
  {
    name: "api_key",
    description: "DashScope API Key（通义千问密钥）",
    type: "string",
    required: true,
    choices: [],
    default: "你的sk"
  },
  {
    name: "app_id",
    description: "通义千问智能体 App ID（在百炼平台创建）",
    type: "string",
    required: true,
    choices: [],
    default: "你的appId"
  }
]
</code></pre>
<p>在digitalHuman\agent\core下创建qwenAgent.py文件，千问支持保存短期对话和长期对话，短期对话使用session_id或者拼接message列表均可，根据文档，在这两个字段同时存在里阿里会采用message列表的模式，此时session_id字段会失效 我们使用session_id的形式，在用户首次对话时创建session_id并传递给前端，当进行后续对话时再由前端返回，长期记忆根据用户创建memory_id存表，然后在对话中携带参数即可</p>
<pre><code class="hljs language-#" lang="#">
from ..builder import AGENTS
from ..agentBase import BaseAgent
import os
import json
from urllib.parse import urlencode
from digitalHuman.protocol import *
from digitalHuman.utils import httpxAsyncClient, logger

__all__ = ["QwenAgent"]


@AGENTS.register("Qwen")
class QwenAgent(BaseAgent):
    async def run(
        self,
        input: TextMessage,
        streaming: bool,
        **kwargs
    ):
        try:
            if not streaming:
                raise KeyError("Tongyi Agent only supports streaming mode")

            # 获取 API 参数
            api_key = kwargs.get("api_key") or os.getenv("DASHSCOPE_API_KEY")
            app_id = kwargs.get("app_id") or os.getenv("DASHSCOPE_APP_ID")
            session_id = (kwargs.get("conversation_id") or kwargs.get("session_id") or "").strip()
            memory_id  = kwargs.get("mid") or ""
            messages = kwargs.get("messages", [])

            if not api_key:
                raise ValueError(
                    "Missing 'api_key': please provide it in parameters "
                    "or set DASHSCOPE_API_KEY environment variable."
                )
            if not app_id:
                raise ValueError(
                    "Missing 'app_id': please provide it in parameters "
                    "or set DASHSCOPE_APP_ID environment variable."
                )

            prompt = input.data.strip()

            #模式判断：messages 优先级高于 session_id
            use_custom_messages = bool(messages)

            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json",
                "X-DashScope-SSE": "enable"
            }

            payload = {
                "input": {},
                "parameters": {
                    "incremental_output": True
                },
                "stream": True
            }

            url = f"https://dashscope.aliyuncs.com/api/v1/apps/{app_id}/completion"
            if memory_id :
                payload["input"]["memory_id"] = memory_id 
            if use_custom_messages:
                #自定义上下文模式
                logger.info("[QwenAgent] Using custom 'messages' mode. session_id will be ignored.")
                for msg in messages:
                    if not isinstance(msg, dict) or "role" not in msg or "content" not in msg:
                        raise ValueError("Each message must be a dict with 'role' and 'content'")
                final_messages = messages.copy()
                if prompt:
                    final_messages.append({"role": "user", "content": prompt})
                payload["input"]["messages"] = final_messages
            else:
                #标准多轮对话模式
                if not prompt:
                    raise ValueError("Prompt is required when not using 'messages'.")
                logger.info(f"[QwenAgent] Using standard mode with session_id: '{session_id or '(new)'}'")
                payload["input"]["prompt"] = prompt
                if session_id:
                    url += "?" + urlencode({"session_id": session_id})
                    payload["input"]["session_id"] = session_id

            logger.info(f"[QwenAgent] Request URL: {url}")
            logger.info(f"[QwenAgent] Payload: {payload}")

            # 发起请求
            async with httpxAsyncClient.stream("POST", url, headers=headers, json=payload) as response:
                logger.info(f"[QwenAgent] Response status: {response.status_code}")
                if response.status_code != 200:
                    error_text = await response.aread()
                    try:
                        err_json = json.loads(error_text)
                        msg = err_json.get("message", error_text.decode())
                    except Exception:
                        msg = error_text.decode()
                    error_msg = f"HTTP {response.status_code}: {msg}"
                    logger.error(f"[QwenAgent] Request failed: {error_msg}")
                    yield eventStreamError(error_msg)
                    return

                got_conversation_id = False
                async for chunk in response.aiter_lines():
                    line = chunk.strip()
                    if not line or line == ":":
                        continue

                    if line.startswith("data:"):
                        data_str = line[5:].strip()
                        if data_str == "[DONE]":
                            break

                        try:
                            data = json.loads(data_str)
                        except json.JSONDecodeError as e:
                            logger.warning(f"[QwenAgent] JSON decode error: {e}, raw: {data_str}")
                            continue

                        logger.debug(f"[QwenAgent] SSE data received: {data}")

                        # 提取 conversation_id（仅在标准模式下）
                        if not got_conversation_id and not use_custom_messages:
                            cid = data.get("output", {}).get("session_id")
                            if cid:
                                if not session_id or cid != session_id:
                                    logger.info(f"[QwenAgent] New conversation_id received: {cid}")
                                    yield eventStreamConversationId(cid)
                                got_conversation_id = True

                        # 提取文本
                        text = data.get("output", {}).get("text", "")
                        if text:
                            yield eventStreamText(text)

            yield eventStreamDone()

        except Exception as e:
            logger.error(f"[QwenAgent] Exception: {e}", exc_info=True)
            yield eventStreamError(str(e))
</code></pre>
<p>阿里创建长期记忆体sdk:</p>
<pre><code class="hljs language-@staticmethod" lang="@staticmethod">    def create_client() -&gt; bailian20231229Client:
        """
        使用凭据初始化账号Client
        @return: Client
        @throws Exception
        """
        # 工程代码建议使用更安全的无AK方式，凭据配置方式请参见：https://help.aliyun.com/document_detail/378659.html。
        credential = CredentialClient()
        config = open_api_models.Config(
            credential=credential
        )
        # Endpoint 请参考 https://api.aliyun.com/product/bailian
        config.endpoint = f'bailian.cn-beijing.aliyuncs.com'
        return bailian20231229Client(config)

    @staticmethod
    async def main_async(
        args: List[str],
    ) -&gt; None:
        client = Sample.create_client()
        create_memory_node_request = bailian_20231229_models.CreateMemoryNodeRequest()
        runtime = util_models.RuntimeOptions()
        headers = {}
        try:
            # 复制代码运行请自行打印 API 的返回值
            await client.create_memory_node_with_options_async('', '', create_memory_node_request, headers, runtime)
        except Exception as error:
            # 此处仅做打印展示，请谨慎对待异常处理，在工程项目中切勿直接忽略异常。
</code></pre>
<p>需要注意incremental_output需要修改为True,否则流式输出的情况下数据会有重复。
在流式输出的情况下，如果每次返回都请求tts，会导致断句不自然甚至一字一顿的情况，比如 我 喜欢 吃这样，调整前端相关的逻辑代码，着重修改web\app(products)\sentio\hooks\chat.ts文件，主要修改逻辑就是把每次流式输出推送tts改为拼接完成后，根据标点断句分批推送tts，同时控制文字和语音的分段同时显示，使嘴型，声音和文字更加自然同步。</p>
<pre><code class="hljs language-import" lang="import">import { 
    useChatRecordStore, 
    useSentioAgentStore, 
    useSentioTtsStore,
    useSentioBasicStore,
} from "@/lib/store/sentio";
import { useTranslations } from 'next-intl';
import { CHAT_ROLE, EventResponse, STREAMING_EVENT_TYPE } from "@/lib/protocol";
import { Live2dManager } from '@/lib/live2d/live2dManager';
import { base64ToArrayBuffer, ttsTextPreprocess } from '@/lib/func';
import { convertMp3ArrayBufferToWavArrayBuffer } from "@/lib/utils/audio";
import {
    api_tts_infer,
    api_agent_stream,
} from '@/lib/api/server';
import { addToast } from "@heroui/react";
import { SENTIO_RECODER_MIN_TIME, SENTIO_RECODER_MAX_TIME } from "@/lib/constants";

export function useAudioTimer() {
    const t = useTranslations('Products.sentio');
    const startTime = useRef(new Date());
    const toast = (message: string) =&gt; {
        addToast({
            title: message,
            color: "warning",
        });
    };
    const startAudioTimer = () =&gt; {
        startTime.current = new Date();
    };
    const stopAudioTimer = (): boolean =&gt; {
        const duration = new Date().getTime() - startTime.current.getTime();
        if (duration &lt; SENTIO_RECODER_MIN_TIME) {
            toast(`${t('recordingTime')} &lt; ${SENTIO_RECODER_MIN_TIME}`);
        } else if (duration &gt; SENTIO_RECODER_MAX_TIME) {
            toast(`${t('recordingTime')} &gt; ${SENTIO_RECODER_MAX_TIME}`);
        } else {
            return true;
        }
        return false;
    };
    return { startAudioTimer, stopAudioTimer };
}

//获取 mid
function getMidFromUrl(): string | null {
    if (typeof window === 'undefined') return null;
    const params = new URLSearchParams(window.location.search);
    return params.get('mid');
}

export function useChatWithAgent() {
    const [chatting, setChatting] = useState(false);
    const { engine: agentEngine, settings: agentSettings } = useSentioAgentStore();
    const { engine: ttsEngine, settings: ttsSettings } = useSentioTtsStore();
    const { sound } = useSentioBasicStore();

    const { addChatRecord, updateLastRecord } = useChatRecordStore();
    const controller = useRef&lt;AbortController | null&gt;(null);
    const conversationId = useRef&lt;string&gt;("");
    const messageId = useRef&lt;string&gt;("");

    // 原始流式文本缓存（用于断句）
    const fullRawText = useRef&lt;string&gt;("");
    const pendingText = useRef&lt;string&gt;("");
    const lastTextUpdateTime = useRef&lt;number&gt;(0);

    // 已显示的文本（仅包含已 TTS 的内容）
    const displayedContent = useRef&lt;string&gt;("");
    const agentThinkRef = useRef&lt;string&gt;("");

    //TTS 串行队列，保证顺序
    const ttsQueue = useRef&lt;Array&lt;{ text: string }&gt;&gt;([]);
    const isProcessingTts = useRef&lt;boolean&gt;(false);

    //从 URL 获取 mid（只在初始化时读一次）
    const mid = useRef&lt;string | null&gt;(getMidFromUrl());

    const abort = () =&gt; {
        setChatting(false);
        Live2dManager.getInstance().stopAudio();
        if (controller.current) {
            controller.current.abort("abort");
            controller.current = null;
        }
        fullRawText.current = "";
        pendingText.current = "";
        displayedContent.current = "";
        lastTextUpdateTime.current = 0;
        agentThinkRef.current = "";
        ttsQueue.current = []; // 清空队列
        isProcessingTts.current = false;
    };

    const updateDisplayedContent = (newSentence: string) =&gt; {
        displayedContent.current += newSentence;
        updateLastRecord({
            role: CHAT_ROLE.AI,
            think: agentThinkRef.current,
            content: displayedContent.current
        });
    };

    //串行处理 TTS 队列
    const processNextTtsInQueue = () =&gt; {
        if (isProcessingTts.current || ttsQueue.current.length === 0 || !controller.current) {
            return;
        }

        isProcessingTts.current = true;
        const { text } = ttsQueue.current.shift()!;

        const processedText = ttsTextPreprocess(text);
        if (!processedText) {
            updateDisplayedContent(text);
            isProcessingTts.current = false;
            processNextTtsInQueue();
            return;
        }

        api_tts_infer(
            ttsEngine,
            ttsSettings,
            processedText,
            controller.current.signal
        ).then((ttsResult) =&gt; {
            if (ttsResult &amp;&amp; controller.current) {
                const audioData = base64ToArrayBuffer(ttsResult);
                convertMp3ArrayBufferToWavArrayBuffer(audioData)
                    .then((buffer) =&gt; {
                        if (controller.current) {
                            updateDisplayedContent(text);
                            Live2dManager.getInstance().pushAudioQueue(buffer);
                        }
                    })
                    .catch((err) =&gt; {
                        console.warn("Audio conversion failed:", err);
                        updateDisplayedContent(text);
                    })
                    .finally(() =&gt; {
                        isProcessingTts.current = false;
                        processNextTtsInQueue();
                    });
            } else {
                updateDisplayedContent(text);
                isProcessingTts.current = false;
                processNextTtsInQueue();
            }
        }).catch((err) =&gt; {
            console.warn("TTS failed for text:", text, err);
            updateDisplayedContent(text);
            isProcessingTts.current = false;
            processNextTtsInQueue();
        });
    };

    //入队函数（替代原来的 processTextForTTS）
    const enqueueTts = (text: string) =&gt; {
        if (!controller.current) return;

        const processedText = ttsTextPreprocess(text);
        if (!processedText) {
            // 无效文本立即显示
            updateDisplayedContent(text);
            return;
        }

        if (!sound) {
            // 无声模式直接显示
            updateDisplayedContent(text);
            return;
        }

        // 有声模式：入队等待串行处理
        ttsQueue.current.push({ text });
        processNextTtsInQueue();
    };

    //按标点断句并及时入队
    const tryProcessPendingText = () =&gt; {
        if (!pendingText.current.trim()) return;

        const now = Date.now();
        const timeSinceLastUpdate = now - lastTextUpdateTime.current;
        const charCount = pendingText.current.length;

        // 定义句子结束符（注意：必须包含中文和英文标点）
        const sentenceEndingsRegex = /[。！？!?.;；\n,，、…～]/g;
        const endings = pendingText.current.match(sentenceEndingsRegex) || [];
        const parts = pendingText.current.split(sentenceEndingsRegex);

        const completeSentences: string[] = [];
        let remaining = "";

        // 重组：除最后一个 part 外，其余都可组成完整句子
        for (let i = 0; i &lt; parts.length - 1; i++) {
            let sentence = parts[i];
            if (i &lt; endings.length) {
                sentence += endings[i]; // 把标点加回去
            }
            if (sentence.trim()) {
                completeSentences.push(sentence);
            }
        }

        // 最后一个 part 是未完成的片段（除非原文本以标点结尾）
        const lastPart = parts[parts.length - 1] || "";
        const endsWithPunctuation = sentenceEndingsRegex.test(pendingText.current.slice(-1));
        
        if (endsWithPunctuation) {
            // 如果原文本以标点结尾，则最后一部分也完整
            if (lastPart.trim()) {
                completeSentences.push(lastPart + (endings[endings.length - 1] || ''));
            }
            remaining = "";
        } else {
            // 否则保留为 pending
            remaining = lastPart;
        }

        // 是否强制 flush 剩余内容？
        const shouldFlushRemaining =
            charCount &gt;= 60 ||
            timeSinceLastUpdate &gt; 1500;

        if (shouldFlushRemaining &amp;&amp; remaining.trim()) {
            completeSentences.push(remaining);
            remaining = "";
        }

        // 处理所有完整句子
        completeSentences.forEach(sentence =&gt; {
            if (sentence.trim()) {
                enqueueTts(sentence);
            }
        });

        // 更新 pendingText
        pendingText.current = remaining;
    };

    const chatWithAgent = (
        message: string, 
        postProcess?: (conversation_id: string, message_id: string, think: string, content: string) =&gt; void
    ) =&gt; {
        addChatRecord({ role: CHAT_ROLE.HUMAN, think: "", content: message });
        addChatRecord({ role: CHAT_ROLE.AI, think: "", content: "" });

        controller.current = new AbortController();
        setChatting(true);
        fullRawText.current = "";
        pendingText.current = "";
        displayedContent.current = "";
        lastTextUpdateTime.current = 0;
        agentThinkRef.current = "";
        ttsQueue.current = [];
        isProcessingTts.current = false;

        const agentCallback = (response: EventResponse) =&gt; {
            const { event, data } = response;
            switch (event) {
                case STREAMING_EVENT_TYPE.CONVERSATION_ID:
                    conversationId.current = data;
                    break;
                case STREAMING_EVENT_TYPE.MESSAGE_ID:
                    messageId.current = data;
                    break;
                case STREAMING_EVENT_TYPE.THINK:
                    agentThinkRef.current += data;
                    updateLastRecord({
                        role: CHAT_ROLE.AI,
                        think: agentThinkRef.current,
                        content: displayedContent.current
                    });
                    break;
                case STREAMING_EVENT_TYPE.TEXT:
                    fullRawText.current += data;
                    pendingText.current += data;
                    lastTextUpdateTime.current = Date.now();

                    if (sound) {
                        tryProcessPendingText();
                    } else {
                        displayedContent.current += data;
                        updateLastRecord({
                            role: CHAT_ROLE.AI,
                            think: agentThinkRef.current,
                            content: displayedContent.current
                        });
                    }
                    break;
                case STREAMING_EVENT_TYPE.ERROR:
                    addToast({ title: data, color: "danger" });
                    break;
                case STREAMING_EVENT_TYPE.TASK:
                case STREAMING_EVENT_TYPE.DONE:
                    if (postProcess) {
                        postProcess(conversationId.current, messageId.current, agentThinkRef.current, fullRawText.current);
                    }

                    // 流结束，处理剩余文本
                    if (sound &amp;&amp; pendingText.current.trim()) {
                        enqueueTts(pendingText.current);
                        pendingText.current = "";
                    }

                    setChatting(false);
                    break;
                default:
                    break;
            }
        };

        const agentErrorCallback = (error: Error) =&gt; {
            setChatting(false);
        };

        //调用 api_agent_stream 时传入 mid
        api_agent_stream(
            agentEngine,
            agentSettings,
            message,
            conversationId.current,
            controller.current.signal,
            agentCallback,
            agentErrorCallback,
            mid.current
        );
    };

    const chat = (
        message: string,
        postProcess?: (conversation_id: string, message_id: string, think: string, content: string) =&gt; void
    ) =&gt; {
        abort();
        chatWithAgent(message, postProcess);
    };

    useEffect(() =&gt; {
        conversationId.current = "";
        return () =&gt; {
            abort();
        };
    }, [agentEngine, agentSettings]);

    return { chat, abort, chatting, conversationId, mid: mid.current };
}
</code></pre>
<p>到这里感觉完事大吉了，但是查看长期记忆列表居然没有数据，这是什么情况？经过多次实现发现自动写入记忆片段只有推理模式才能成功，但是开启推理模式等待时间过长，不适合数字人这种需要及时交互的场景，那么有没有解决的方法呢？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ae70ec85eb4569af5dc3f43bf9b5d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=u1Ggiind3VEByUVaIFUw6TlTiMs%3D" alt="image.png" loading="lazy"/>
我们可以使用阿里提供的另一个接口，主动创建记忆片段。
修改qwenAgent.py文件，具体逻辑就是在千问返回信息后，异步通过接口判断当前返回的内容是否需要抽取保存到记忆中，如果需要的话通过相关sdk进行保存</p>
<pre><code class="hljs language-#" lang="#">
from ..builder import AGENTS
from ..agentBase import BaseAgent
import os
import json
import asyncio
import re
from urllib.parse import urlencode
from digitalHuman.protocol import *
from digitalHuman.utils import httpxAsyncClient, logger

# DashScope SDK 导入
try:
    from alibabacloud_bailian20231229.client import Client as bailian20231229Client
    from alibabacloud_credentials.client import Client as CredentialClient
    from alibabacloud_tea_openapi import models as open_api_models
    from alibabacloud_bailian20231229 import models as bailian_20231229_models
    from alibabacloud_tea_util import models as util_models
    from alibabacloud_credentials.models import Config as CredentialConfig
    SDK_AVAILABLE = True
except ImportError:
    logger.warning("DashScope SDK not available, memory writing disabled")
    SDK_AVAILABLE = False

__all__ = ["QwenAgent"]


@AGENTS.register("Qwen")
class QwenAgent(BaseAgent):
    
    def __init__(self, config=None, engine_type=None):
        """初始化 QwenAgent，兼容父类构造函数"""
        super().__init__(config, engine_type)
        self._sdk_client = None
        if SDK_AVAILABLE:
            self._init_sdk_client()
    
    def _init_sdk_client(self):
        """初始化 DashScope SDK 客户端 - 从环境变量读取 AK/SK"""
        try:
            access_key_id = os.getenv("DASHSCOPE_ACCESS_KEY_ID")
            access_key_secret = os.getenv("DASHSCOPE_ACCESS_KEY_SECRET")
            
            if not access_key_id or not access_key_secret:
                logger.error("DASHSCOPE_ACCESS_KEY_ID or DASHSCOPE_ACCESS_KEY_SECRET not set in environment variables")
                return
            
            credential_config = CredentialConfig(
                type='access_key',
                access_key_id=access_key_id,
                access_key_secret=access_key_secret
            )
            credential = CredentialClient(credential_config)
            
            config = open_api_models.Config(credential=credential)
            config.endpoint = 'bailian.cn-beijing.aliyuncs.com'
            self._sdk_client = bailian20231229Client(config)
            logger.info("DashScope SDK client initialized successfully")
        except Exception as e:
            logger.error(f"Failed to initialize SDK client: {e}")
            self._sdk_client = None
    
    #判断是否需要抽取记忆
    def _should_extract_memory(self, text: str) -&gt; bool:
        """轻量判断：是否可能包含可记忆信息"""
        if not text.strip():
            return False
        triggers = [
            "叫", "名字", "姓名",  # 基本信息
            "喜欢", "爱吃", "爱喝", "讨厌", "不吃", "过敏",  # 饮食
            "兴趣", "爱好", "擅长", "迷上", "喜欢玩",  # 兴趣
            "性格", "活泼", "内向", "安静", "调皮",  # 性格
            "年级", "学校", "班级",  # 基本信息
            "进步", "退步", "成绩", "考得", "学习", "作业"  # 学习（趋势）
        ]
        return any(trigger in text for trigger in triggers)
    
    # qwen-max 抽取结构化记忆
    async def _extract_memory_with_qwen_max(self, text: str, api_key: str, child_name: str = "") -&gt; dict:
        prompt = f"""
# 角色
你是一个严格的信息抽取系统，不是对话助手。你的唯一任务是从家长原话中提取结构化信息。

# 规则
1. 禁止任何解释、问候、反问、建议
2. 禁止输出 JSON 以外的任何字符（包括换行、空格、Markdown）
3. 如果没有可提取信息，必须输出：{{}}
4. 字段值必须是简洁的中文短语，不要完整句子

# 字段定义
- basic_info: "姓名，性别，年级"（如"李明，男，三年级"）
- diet_preference: "饮食偏好"（如"喜欢吃西瓜"）
- interests: "兴趣爱好"（如"喜欢画画"）
- personality: "性格特点"（如"性格活泼"）
- academic_trend: "学习趋势"（如"数学有进步"）

# 家长原话
{text}

# 你的输出（纯 JSON，无任何其他内容）：
"""
        
        try:
            resp = await httpxAsyncClient.post(
                "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",
                headers={"Authorization": f"Bearer {api_key}"},
                json={
                    "model": "qwen-max",
                    "input": {"prompt": prompt.strip()},
                    "parameters": {
                        "max_tokens": 200,
                        "temperature": 0.01,
                        "stop": ["\n", "。", "！", "？", "："]
                    }
                },
                timeout=10.0
            )
            if resp.status_code == 200:
                data = resp.json()
                raw_text = data.get("output", {}).get("text", "").strip()
                logger.debug(f"[MemoryExtract] Raw output: '{raw_text}'")
                
                # 尝试解析 JSON
                try:
                    return json.loads(raw_text)
                except:
                    # 尝试提取 {...}
                    match = re.search(r'\{[^{}]*\}', raw_text)
                    if match:
                        try:
                            return json.loads(match.group())
                        except:
                            pass
                if raw_text == "{}":
                    return {}
                    
                logger.warning(f"[MemoryExtract] Failed to parse: {raw_text[:100]}")
                
        except Exception as e:
            logger.error(f"[MemoryExtract] Error: {e}", exc_info=True)
        
        return {}

    #使用 SDK 写入 DashScope Memory
    async def _write_memory_node_with_sdk(self, app_id: str, memory_id: str, content: str):
        if not SDK_AVAILABLE or self._sdk_client is None:
            logger.warning("[MemoryWrite] SDK not available, skipping write")
            return
            
        if not app_id or not memory_id or not content.strip():
            logger.warning("[MemoryWrite] Skip empty app_id, memory_id or content")
            return
        
        try:
            logger.info(f"[MemoryWrite] Attempting to write via SDK - app_id: '{app_id}', memory_id: '{memory_id}', content: '{content}'")
            
            create_memory_node_request = bailian_20231229_models.CreateMemoryNodeRequest(
                content=content
            )
            runtime = util_models.RuntimeOptions()
            headers = {}
            space_id = os.getenv("DASHSCOPE_SPACE_ID")
            response = await self._sdk_client.create_memory_node_with_options_async(
                space_id, 
                memory_id, 
                create_memory_node_request, 
                headers, 
                runtime
            )
            
            logger.info(f"[MemoryWrite] SDK SUCCESS - MemoryNode ID: {response.body.memory_node_id}")
            
        except Exception as e:
            logger.error(f"[MemoryWrite] SDK EXCEPTION: {e}")

    #后台记忆更新任务
    async def _background_memory_update(self, user_input: str, app_id: str, memory_id: str, api_key: str):
        await asyncio.sleep(0.5)
        
        child_name = ""
        extracted = await self._extract_memory_with_qwen_max(user_input, api_key, child_name)
        logger.info(f"[Memory] Extracted result: {extracted}")
        
        for key, value in extracted.items():
            if value:
                pure_content = value
                logger.info(f"[Memory] Writing pure content: {pure_content}")
                await self._write_memory_node_with_sdk(app_id, memory_id, pure_content)

    async def run(
        self,
        input: TextMessage,
        streaming: bool,
        **kwargs
    ):
        try:
            if not streaming:
                raise KeyError("Tongyi Agent only supports streaming mode")

            # 获取 API 参数（从环境变量或参数）
            api_key = kwargs.get("api_key") or os.getenv("DASHSCOPE_API_KEY")
            app_id = kwargs.get("app_id") or os.getenv("DASHSCOPE_APP_ID")
            session_id = (kwargs.get("conversation_id") or kwargs.get("session_id") or "").strip()
            memory_id = kwargs.get("mid") or ""
            messages = kwargs.get("messages", [])

            if not api_key:
                raise ValueError(
                    "Missing 'api_key': please provide it in parameters "
                    "or set DASHSCOPE_API_KEY environment variable."
                )
            if not app_id:
                raise ValueError(
                    "Missing 'app_id': please provide it in parameters "
                    "or set DASHSCOPE_APP_ID environment variable."
                )

            prompt = input.data.strip()

            #模式判断：messages 优先级高于 session_id
            use_custom_messages = bool(messages)

            headers = {
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json",
                "X-DashScope-SSE": "enable"
            }

            payload = {
                "input": {},
                "parameters": {
                    "incremental_output": True
                },
                "stream": True
            }

            url = f"https://dashscope.aliyuncs.com/api/v1/apps/{app_id}/completion"
            if memory_id:
                payload["input"]["memory_id"] = memory_id 
            if use_custom_messages:
                logger.info("[QwenAgent] Using custom 'messages' mode. session_id will be ignored.")
                for msg in messages:
                    if not isinstance(msg, dict) or "role" not in msg or "content" not in msg:
                        raise ValueError("Each message must be a dict with 'role' and 'content'")
                final_messages = messages.copy()
                if prompt:
                    final_messages.append({"role": "user", "content": prompt})
                payload["input"]["messages"] = final_messages
            else:
                if not prompt:
                    raise ValueError("Prompt is required when not using 'messages'.")
                logger.info(f"[QwenAgent] Using standard mode with session_id: '{session_id or '(new)'}'")
                payload["input"]["prompt"] = prompt
                if session_id:
                    url += "?" + urlencode({"session_id": session_id})
                    payload["input"]["session_id"] = session_id

            logger.info(f"[QwenAgent] Request URL: {url}")
            logger.info(f"[QwenAgent] Payload: {payload}")

            #异步触发记忆抽取
            if memory_id and self._should_extract_memory(prompt):
                logger.info("[Memory] Triggering async memory extraction...")
                asyncio.create_task(
                    self._background_memory_update(prompt, app_id, memory_id, api_key)
                )

            #发起主请求（保持原有逻辑不变）
            async with httpxAsyncClient.stream("POST", url, headers=headers, json=payload) as response:
                logger.info(f"[QwenAgent] Response status: {response.status_code}")
                if response.status_code != 200:
                    error_text = await response.aread()
                    try:
                        err_json = json.loads(error_text)
                        msg = err_json.get("message", error_text.decode())
                    except Exception:
                        msg = error_text.decode()
                    error_msg = f"HTTP {response.status_code}: {msg}"
                    logger.error(f"[QwenAgent] Request failed: {error_msg}")
                    yield eventStreamError(error_msg)
                    return

                got_conversation_id = False
                async for chunk in response.aiter_lines():
                    line = chunk.strip()
                    if not line or line == ":":
                        continue

                    if line.startswith("data:"):
                        data_str = line[5:].strip()
                        if data_str == "[DONE]":
                            break

                        try:
                            data = json.loads(data_str)
                        except json.JSONDecodeError as e:
                            logger.warning(f"[QwenAgent] JSON decode error: {e}, raw: {data_str}")
                            continue

                        logger.debug(f"[QwenAgent] SSE data received: {data}")

                        if not got_conversation_id and not use_custom_messages:
                            cid = data.get("output", {}).get("session_id")
                            if cid:
                                if not session_id or cid != session_id:
                                    logger.info(f"[QwenAgent] New conversation_id received: {cid}")
                                    yield eventStreamConversationId(cid)
                                got_conversation_id = True

                        text = data.get("output", {}).get("text", "")
                        if text:
                            yield eventStreamText(text)

            yield eventStreamDone()

        except Exception as e:
            logger.error(f"[QwenAgent] Exception: {e}", exc_info=True)
            yield eventStreamError(str(e))

</code></pre>
<p>这样一个支持语音输出输入，长短期记忆的live2d数字人就完成了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74fdfc11e4524aeabe726993464f097c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=BPnLaTMbC0lnWRT8XyUICLzL3hg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1a8a2948e24dad8528704014278769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3V6dW1peWFocg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630592&amp;x-signature=Ct9gxAtDQ91hP2Vvs2G3VbBE2rk%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows安装Claude Code全流程]]></title>    <link>https://juejin.cn/post/7571808096936722473</link>    <guid>https://juejin.cn/post/7571808096936722473</guid>    <pubDate>2025-11-13T08:54:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096936722473" data-draft-id="7571972751528099876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows安装Claude Code全流程"/> <meta itemprop="keywords" content="Windows,Linux,Claude"/> <meta itemprop="datePublished" content="2025-11-13T08:54:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="撒币使我快乐"/> <meta itemprop="url" content="https://juejin.cn/user/1556564197509527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows安装Claude Code全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564197509527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    撒币使我快乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T08:54:57.000Z" title="Thu Nov 13 2025 08:54:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这里不赘述账号申请，很多网上很多资料了。在 Windows 系统上使用 Claude Code，主要有两种官方推荐的路径：一种是利用 Windows 自带的 Linux 子系统（WSL），另一种是尝试通过 PowerShell 直接安装。此外，你也可以选择将其功能集成到 VS Code 编辑器中使用。这里我们使用第一种，因为这是目前最稳定、被广泛验证的方式。</p>
<ol>
<li><strong>启用并安装 WSL</strong>：
<ul>
<li>以<strong>管理员身份</strong>打开 PowerShell。</li>
<li>依次执行以下命令：
<pre><code class="hljs language-powershell" lang="powershell">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre>
</li>
<li><strong>重启电脑</strong>使更改生效。</li>
<li>重启后，再次以管理员身份打开 PowerShell，执行 <code>wsl --install</code> 来安装默认的 Linux 发行版（通常是 Ubuntu）。过程中你需要设置一个 Linux 系统的用户名和密码。<br/>
如果这一步提示了如下报错，即使这个链接能通过浏览器打开，也需要处理网络问题<br/>
<em>无法从“<a href="https://link.juejin.cn?target=https%3A%2F%2Fraw.githubusercontent.com%2Fmicrosoft%2FWSL%2Fmaster%2Fdistributions%2FDistributionInfo.json%25E2%2580%259D" target="_blank" title="https://raw.githubusercontent.com/microsoft/WSL/master/distributions/DistributionInfo.json%E2%80%9D" ref="nofollow noopener noreferrer">raw.githubusercontent.com/microsoft/W…</a> 提取列表分发。无法解析服务器的名称或地址<br/>
错误代码: Wsl/InstallDistro/WININET_E_NAME_NOT_RESOLVED</em></li>
</ul>
</li>
<li><strong>处理网络问题方法</strong>
<ol>
<li><strong>诊断DNS解析问题</strong></li>
</ol>
<ul>
<li>
<p>按Win + R输入cmd回车打开命令行工具，执行 <code>ping raw.githubusercontent.com</code> 获取IP地址（如 <code>185.199.110.133</code>）</p>
</li>
</ul>
<ol start="2">
<li><strong>修改Hosts文件</strong></li>
</ol>
<ul>
<li>
<p>使用IDE（需管理员权限）编辑 <code>C:\Windows\System32\drivers\etc\hosts</code></p>
</li>
<li>
<p>添加行：<code>185.199.110.133 raw.githubusercontent.com</code></p>
</li>
</ul>
<ol start="3">
<li><strong>刷新DNS缓存</strong></li>
</ol>
<ul>
<li>
<p>在PowerShell中执行：<code>ipconfig /flushdns</code></p>
</li>
</ul>
<ol start="4">
<li><strong>重新执行<code>wsl --install</code></strong></li>
</ol>
<ul>
<li>执行命令并设置WSL用户名和密码</li>
</ul>
</li>
<li><strong>在 WSL 中安装 Node.js</strong>：
<ul>
<li>从开始菜单打开你安装的 Linux 发行版（如 Ubuntu）。</li>
<li>首先更新系统包并安装 Node.js（如果未安装）：
<pre><code class="hljs language-bash" lang="bash">sudo apt update &amp;&amp; sudo apt upgrade -y
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
</code></pre>
</li>
<li>验证Node.js安装，执行：<code>node --version</code> （成功输出：<code>20.19.5</code>）</li>
</ul>
</li>
<li><strong>安装Claude Code</strong>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
</li>
<li>将ANTHROPIC_AUTH_TOKEN和ANTHROPIC_BASE_URL写入~/.zshrc<br/>
在Ubuntu中，使用vim命令修改~/.zshrc
<pre><code class="hljs language-bash" lang="bash">vim ~/.zshrc
</code></pre>
将如下内容写入~/.zshrc，注意将xxxx替换为自己的ANTHROPIC_AUTH_TOKEN，将ANTHROPIC_BASE_URL替换为自己的ANTHROPIC_BASE_URL
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Claude Code 环境变量</span>
<span class="hljs-built_in">export</span> ANTHROPIC_AUTH_TOKEN=xxxx
<span class="hljs-built_in">export</span> ANTHROPIC_BASE_URL=xxx
</code></pre>
立即重新加载并执行当前用户的 .zshrc 配置文件，后续如果遇到需要输入<code>/login</code>登录的场景可以执行一下完成登录
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
</li>
<li>使用Claude Code<br/>
在Ubuntu中，输入<code>claude code</code>即可启动</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[零代码+三维仿真！实现自然灾害的可视化模拟与精准预警]]></title>    <link>https://juejin.cn/post/7571768210715869199</link>    <guid>https://juejin.cn/post/7571768210715869199</guid>    <pubDate>2025-11-13T09:27:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715869199" data-draft-id="7572010680896094248" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="零代码+三维仿真！实现自然灾害的可视化模拟与精准预警"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T09:27:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            零代码+三维仿真！实现自然灾害的可视化模拟与精准预警
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:27:17.000Z" title="Thu Nov 13 2025 09:27:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从“被动应对”到“主动预警”的蜕变</h2>
<p>传统防灾预警高度<strong>依赖专业人员经验与繁琐的数据分析</strong>，既耗时耗力，又因灾害状态瞬息万变易错过最佳预警窗口。</p>
<p>园测信科自研的**【RiskInsight平台】<strong>构建</strong>【综合风险预警模型】<strong>和</strong>【灾害链动力学模型】<strong>两大模块，围绕滑坡泥石流、洪水、森林火灾、边坡崩塌等多个灾种，提供基于真实地理环境的灾害分析，将冰冷的监测数字转换成直观生动的</strong>三维仿真场景**，并且可以按照现实情况实时推演，推动防灾减灾工作的<strong>普及化和高效化</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06339f1be579409883ca37b66e43e818~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=308%2FbePYPBjVK2JiSnOCA2SehJg%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-1">01 支持多灾种可视化的综合评价模型</h3>
<p>内置**【滑坡泥石流、溃决洪水、流域洪水、城市洪涝、边坡塌陷、森林火灾】等灾害综合评价模型，**利用GIS空间分析能力，实现实时数据驱动下的模型运行，以及在地图上的可视化模拟，从而降低决策理解门槛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ec90003a8704e81bc7d13ebbda6d746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=zAkCqc8cbMmMfLwUjMilTsIJnmM%3D" alt="动图封面" loading="lazy"/></p>
<ul>
<li>
<p>集成**多个综合评价模型，**提供多灾种科学分析支撑。</p>
</li>
<li>
<p><strong>实时数据驱动</strong>专业模型，灾害评估结果更贴近实际。</p>
</li>
<li>
<p>基于<strong>真实三维地理环境</strong>，<strong>直观展示模型分析结果</strong>，反映灾害发生概率，<strong>降低决策理解门槛</strong>。</p>
</li>
</ul>
<h3 data-id="heading-2">02 基于真实地理环境的动力学模型仿真模拟</h3>
<p>内置通用的**【滑坡泥石流、溃决洪水、流域洪水、城市洪涝、边坡塌陷、森林火灾】等灾害链动力学仿真分析模型**，接入真实的地理数据，可实现在三维场景中模拟灾害的演进过程（如溃决洪水的扩散过程）；</p>
<p>同时<strong>支持调整参数来对比</strong>：不同气象条件下房屋、道路、人员等承载体的受灾情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67295dcb1b534ebb821f911a00954e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=3XT6qs84%2BbuLjY9hMEhMU4rPJT4%3D" alt="动图封面" loading="lazy"/></p>
<ul>
<li>
<p>内置多种灾害的动力学模型,支持<strong>实时修改模型参数</strong>，快速生成模拟场景。</p>
</li>
<li>
<p>基于真实DEM数据，<strong>可视化模拟</strong>灾害演进过程。</p>
</li>
<li>
<p>可叠加建筑物、道路、人口分布数据，<strong>动态统计</strong>灾害对关键设施的影响范围。</p>
</li>
</ul>
<h2 data-id="heading-3">零代码让精准预警触手可及</h2>
<p>灾害风险预警模型是平台的核心，面对不同的地理环境，需要业务专家据实际情况，对<strong>模型中的大量参数进行调试以获得最优的监控方案</strong>，在以往的调试过程中，需要由防灾专家与开发者多次沟通才能完成，一旦地理环境发生变化，又需要重复上述的调试过程，这样的模式不仅效率低下，更让真正懂防灾业务的人员被隔绝在技术门槛之外！</p>
<p>作为<strong>业内首个自然灾害监测预警零代码开发平台</strong>，RiskInsight通过直观的图形界面和简单的交互操作，<strong>无需编写复杂的代码就可以完成预警模型的参数调整</strong>，对开发的依赖大大降低！并且，在地理环境不断演变的情况下，<strong>可以及时地调整与验证，生成最优的监控方案。</strong></p>
<h3 data-id="heading-4">01 方式一：框选范围分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9176c3d1366b47059faa93687b7587ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=00tGBLqRtdAkDXd1erogE6QTybs%3D" alt="动图封面" loading="lazy"/></p>
<p><em>#该方式支持用户直接在地图上划定分析范围，操作更简便。</em></p>
<h3 data-id="heading-5">02 方式二：上传数据分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9b09b5cef4470984d0fe056a1ed4c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=ai3jhm9CGQQDZTT9pIzTSidozlw%3D" alt="动图封面" loading="lazy"/></p>
<p><em>#该方式需用户自行制作数据上传，分析结果更精确。</em></p>
<h3 data-id="heading-6">03 运行模型</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45dcffa96a694a5bb1b40afcfdab0956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=frPmnr0hm6Q28eSVhl9Dj%2BjeMOA%3D" alt="动图封面" loading="lazy"/></p>
<h2 data-id="heading-7">仿真分析案例</h2>
<h3 data-id="heading-8">● 流域洪水</h3>
<p>本模型主要用于模拟流域或区域尺度的<strong>地表水与地下水动态过程</strong>，尤其在水文循环模拟、洪水预报、干旱评估及气候变化对水资源的影响研究中应用广泛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/076374998bb14bd39732a8ee32f9b7ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=rEp84O%2FFoEq6Q8NOHgv%2FNbKI0hc%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35bf1f4f08dc42c4adf3dde8123cb8f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=xuva08%2F49LnnIdeKCtMYH6YMjt4%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-9">● 滑坡泥石流</h3>
<p>本模型是一款专注于泥石流（岩屑流、山洪泥石流）动力学模拟的专业软件工具，主要用于分析<strong>泥石流的启动、运动过程、堆积范围及对周边设施的影响</strong>，广泛应用于山地灾害风险评估、防灾减灾规划及工程防护设计领域。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9d4c142155246d8ac8c8a33e6fe470e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=MmWd7EMhN8D7p5Bp%2BTTfpudT91w%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c6ac206815a4ae395ffdb960f58203f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=WhyzR7dugTxFeHp4oVc53WGcBdI%3D" alt="动图封面" loading="lazy"/></p>
<h3 data-id="heading-10">● 森林火灾</h3>
<p>本模型是野火行为研究的经典工具之一。其核心目标是通过量化火源热释放、燃料特性、气象条件及地形对火蔓延的影响，<strong>预测火线（Firefront）的推进速度与方向</strong>，为火灾防控、风险评估及应急决策提供科学依据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc11419693d84deda32e756a35992b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=vGnlZzDZOWV9GfwsZ8C%2FqjC98UQ%3D" alt="动图封面" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4e94ccca40442dbbf10bb32cdcaa4f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763630837&amp;x-signature=tPrFfWe1pXyKbYseYMcXHfu1n6k%3D" alt="动图封面" loading="lazy"/></p>
<p>在后续的文章中，将为大家分享上述模型功能的开发思路，以及在开发过程中所遇到的问题和解决方案，敬请期待~</p>
<p>了解更多，请至<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fwww.mapmost.com%2F%2523%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//www.mapmost.com/%23/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 原生应用开发实战营·京沪双城回顾 & PPT 下载]]></title>    <link>https://juejin.cn/post/7571768210715934735</link>    <guid>https://juejin.cn/post/7571768210715934735</guid>    <pubDate>2025-11-13T09:33:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571768210715934735" data-draft-id="7571751593206415412" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 原生应用开发实战营·京沪双城回顾 &amp; PPT 下载"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-13T09:33:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 原生应用开发实战营·京沪双城回顾 &amp; PPT 下载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T09:33:53.000Z" title="Thu Nov 13 2025 09:33:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：盈楹&amp;望宸</p>
<p>近日，阿里云 AI 原生应用开发实战营 · 北京站&amp;上海站圆满落幕。继深圳、杭州、成都等城市之后，这两场活动吸引了 250+ 名技术从业者深度参与。</p>
<p>活动聚焦 AI Agent 领域的前沿技术与落地实践，深度分享 AI Agent 架构趋势和演进、AI 开放平台、AI 应用运行时、AI 应用托管、大模型可观测 &amp; AIOps、异步化的 Agent 事件驱动等热门技术议题，并设置了动手实操环节。</p>
<p>关注「阿里云云原生」公众号，后台回复：1111</p>
<p>免费获得北京站&amp;上海站讲师 PPT 合辑</p>
<h2 data-id="heading-0">精彩回顾丨北京站</h2>
<h3 data-id="heading-1">议题一：构建 AI 原生应用的 11 个关键要素丨王晨(望宸)阿里云智能云原生高级技术运营专家</h3>
<p>深度分享了 AI 云原生应用架构新范式，已从数字化范式演进为智能化范式，基于模型、Agent 驱动，以数据为中心，整合工具链，形成 AI 原生应用架构。AI 原生应用将具备意识、自主性、确定性、一致性。企业可以找到核心提效场景，通过 AI 原生应用架构，构建高质量数据壁垒，借助大模型大势快速迭代，同时，让数据可沉淀，行业数据可演进，评估数据可量化，反馈数据可持续。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee88b0b0a6074071869b18bf455768f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=S1QT9rzfyHKem9zlhlFm9bkPgzA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">议题二：从传统应用到 AI 应用的一站式托管丨赵庆杰(卢令)阿里云智能云原生高级技术专家</h3>
<p>首先分享了传统应用运维的‘简、稳、省’优化之道，迈向智能运维时代，SAE 智能助手的核心引擎从基础问答到故障诊断，AI 能力重构云原生运维流程。企业可借助函数计算 AgentRun、AgentRun 网关、AgentRun 可观测的产品能力，跨越 Agent 生产力鸿沟，构建智能体核心基础设施，全面打通 AI 应用落地最后一公里，加速 AI 创新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d73ad708643e4a44ab24eba6be630f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=U0Hzzf6fHgORfWjlrrLulMMZrkU%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">议题三：Higress AI 开放平台：构建企业私有化 MCP/Agent 市场的实践丨刘帅(友瑾) Higress Maintainer</h3>
<p>从传统网关迈向 AI 网关，Higress 流量网关、API 网关、大模型代理、MCP 代理能力打造了 AI 网关新范式。深入分享了 Higress x HiMarket 核心原理，企业可以通过 Higress x HiMarket，实现 MCP Server 集中化治理，API 货币化等，快速构建企业级 AI 市场，同时也分享了 Higress x HiMarket 未来规划，欢迎更多用户了解 Higress x HiMarket 项目 roadmap，参与开源贡献。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0be556e1797b47a5863d8ae718d67663~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=WGa0HG2O%2FUe25hS%2B80lTTLZdgCk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">议题四：大模型驱动的可观测与 AIOps 新范式丨温希道(朴象)阿里云智能云原生高级技术专家</h3>
<p>大模型时代带来全新的应用形态和运维模式，面临数据和认知两大难题，可观测数据平台借助统一接入、加工、存储能力，以及通用算子×可观测数据算子，来降低海量数据的分析难度，轻松驾驭驾驭海量、异构、实时的可观测数据。此外，通过引入统一模型（UModel），基于统一模型（UModel）重构可观测数据，打破通用大模型与运维领域知识的鸿沟，打造大模型驱动的可观测与 AIOps 新范式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ba97d150474df59c64aee5bfb0d772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=THbTNJunT%2F%2BouUBNpwRLfcQUPCQ%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">议题五：Apache RocketMQ x AI：面向异步化 Agent 的事件驱动架构丨周礼(不铭)阿里云智能云原生高级技术专家</h3>
<p>AI 进入 Agentic AI 阶段，AgenticAI 应用将成为主流方向，讲师分享了实现异步化 Multi-Agent 的关键点，以及基于 Apache RocketMQ 的 Multi-Agent 架构。通过语义化的 Topic 以及 LiteTopic 两个方案，可以解决通信意图不透明、调度逻辑静态固化、响应路径缺失等问题。现场详细介绍了带语义的 Topic 路由、LiteTopic 在 AI 场景中的应用及实现方案、分级消费策略等产品核心竞争力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de32351ebfa142b394f1dbc8d8d216e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=ndESvBKj6yI1ivi2273aPQeJDpg%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">议题六：动手实操环节：AIOps 故障定位挑战赛丨温希道(朴象)阿里云智能云原生高级技术专家</h3>
<p>云计算、AIGC 与数字经济的共同推动，带来软件系统数量与复杂度的持续攀升，AIOps 已成为应对这一趋势、保障智能化与可持续发展的关键方向。2025 AI 原生编程挑战赛聚焦 AIOps 故障定位领域，欢迎选手打造智能运维 Agent，让天下没有难查的故障。现场讲师详细介绍了赛题、解题思路，并带领用户现场动手实操，互动交流热烈。欢迎大家报名参赛！<a href="https://link.juejin.cn?target=https%3A%2F%2Ftianchi.aliyun.com%2Fcompetition%2Fentrance%2F532387%3Faccounttraceid%3De0ba51491d54404cae1237b6ae6c3be6hqky" target="_blank" title="https://tianchi.aliyun.com/competition/entrance/532387?accounttraceid=e0ba51491d54404cae1237b6ae6c3be6hqky" ref="nofollow noopener noreferrer">tianchi.aliyun.com/competition…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/badbf4acfcf7435990d5d3344d1e952c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=b2oNLamIW56TTHJSL6wGcuJ7zKQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f763f7cc1384aedb4b3d95656c54f48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=RUcqCKSrQVx8hwwCdsVt%2BfjATZo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">现场精彩瞬间</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eb1606b88aa4acbba0fbf8f83deb27e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=MwOp8fMSXJil5PkZhrqWT9jyCe8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e3b600c4085426193ec2e261f9b693e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=SCbDU5ECVLuRfvj%2BqI83EnNoJ%2Bk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e761368c5b4ae49819ab3233c84777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=jjU9ag%2FykUT6%2FZdx962JJi0jWK4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0204555ecdd43b8b8c54f4104db6dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=HpUvkINEH8yB4LMWgb76iXsiA5c%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">精彩回顾丨上海站</h2>
<h3 data-id="heading-9">议题一：AI 原生应用架构趋势与实践丨肖京(亦盏) 阿里云智能云原生高级技术专家</h3>
<p>当前大模型已迈过技术拐点，Agentic AI 进入规模化落地阶段。AI 原生应用以模型为基础、Agent 为驱动、数据为中心，推动系统从“机器执行”向“机器思考+执行”演进。框架选型需平衡 Agentic 自主性与业务确定性，Agent 面临开发效率、业务效果，以及稳定、性能、成本、安全的挑战。实践上建议构建以数据为核心的 Agent 平台，结合 MCP/A2A 标准与 Serverless 架构，通过 AI 网关、消息队列、可观测等提升安全性、稳定性与可维护性，实现智能化人机协作新范式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8319c97c1d8f48268c58ddd89db27ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=0vR93%2BUMmjo%2BC6WYj%2F3wJ8ek2Aw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10">议题二：Serverless AI 应用运行时：从函数计算到函数智能丨史明伟(世如)阿里云智能云原生高级技术专家</h3>
<p>随着大语言模型与 AI Agent 快速发展，阿里云函数计算（FC）通过持续架构演进，从“无状态、极致弹性、按需付费” 到 “会话管理、安全隔离、忙闲计费”，成为构建 AI 应用原生架构核心载体。依托于函数计算 FC 毫秒级弹性，原生架构 3AZ 容灾高可用，会话隔离，多语言运行时，CPU/GPU 异构算力等 Serverless Infra 核心优势，够建 FunctionAI 开发平台，提供模型托管（FunModel）、AIGC 生图（FunArt）、智能体开发（AgentRun）和工具/MCP 开发能力，结合魔搭、百炼生态、电商和教育等场景落地经验，助力企业高效构建可扩展的 AI 应用体系。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dd702ced41d43fda9b2426d6cbbb43c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=ohWoDoCOT%2BNfuDEyNu7vkEIiGjE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-11">议题三：MCP 网关的企业级最佳实践丨张添翼(澄潭)阿里云智能云原生技术专家</h3>
<p>随着大模型与 AI Agent 广泛应用，模型上下文协议（MCP）成为连接 AI 与外部服务的关键。阿里云 AI 网关（Higress 企业版）通过“基础连接—进阶优化—大规模治理”三阶段演进，支持 REST-to-MCP 转换、统一代理与协议卸载，实现异构服务无缝接入；并通过认证控制、最小权限管理保障安全；在大规模场景下，提供虚拟服务组装、语义化检索与智能工具精选，缓解 LLM 上下文压力，提升调用准确率与系统性能，助力企业构建高效、安全、可扩展的 AI 集成体系。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679de0298d864312af0cd4712c6b11bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=BqaBOFHZ%2Bq%2F%2F6YNj7F7uXJTSJ84%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12">议题四：可见、可管、可控：阿里云 AI 应用可观测能力建设丨曹炜怿(顾思)阿里云智能云原生解决方案架构师</h3>
<p>阿里云大模型可观测方案通过“全栈监控-链路诊断-结果评估”三阶段演进，构建 AI 应用全生命周期观测体系。基于 Prometheus+ARMS+SLS 技术栈，实现模型性能分析、GPU 资源监控、Token 成本追踪等全栈指标采集；通过 OpenTelemetry 协议支持 LLM 调用链路追踪（TTFT/TPOT 分析）及 RAG 混合检索优化；创新 LLM-as-Judge 评估框架，内置 10+ 语义检测模板（合规/幻觉/相关性），结合向量索引与自定义评估，降低 AI 应用调试成本 50%。方案已在 vLLM 引擎优化、Token 黑洞定位等场景验证，助力企业实现推理效率和资源利用率的大幅提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a7d56337bbb4f3799d4aec94a03cb48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=JA0ZSCKpdKj%2FLGtjdFsbC9Dd1co%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">议题五：Apache RocketMQ for AI：全面拥抱企业级 AI 应用，引领 AI MQ 新时代丨杨文婷(文婷)阿里云智能云原生产品专家</h3>
<p>阿里云 Apache RocketMQ 推出面向 AI 应用的全新 LiteTopic 模型，支持百万级轻量主题，具备自动生命周期管理、排他消费与顺序消息能力，有效解决 AI 场景中的异步通信、流量治理与定速消费难题。该模型在 Multi-Agent 通信、分布式会话管理与算力调度中发挥关键作用，保障高并发、低延迟与系统可扩展性。RocketMQ 正战略升级为专为 AI 时代打造的 AIMQ，集成主流AI框架，并计划将 LiteTopic 开源，致力于构建企业级 AI 异步通信基础设施。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9badf6e36f514412b1c7c7124551f1ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=9Hzckh0nvq9euuIl1F1dUV8OWPo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-14">议题六：动手实操环节：AIOps 故障定位挑战赛丨刘进步(石季) 阿里云智能云原生算法专家</h3>
<p>2025 年云原生编程挑战赛聚焦智能运维（AIOps）发展，应对云计算与 AIGC 浪潮下系统复杂度提升带来的故障定位难、运维成本高等挑战。大赛倡导融合可观测数据、开源标准与大模型技术，推动运维智能化。参赛者可通过云监控 2.0“看”根因、SPL 脚本“算”根因，或构建大模型 Agent 实现智能诊断，比赛提供完整脚手架与教程，覆盖从入门到高阶的智能运维演进路径，助力打造高效运维解决方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28333d2d8fea4041b3573b9317e5c182~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=Uy1kZ9vfJyqX%2FTTliSCUF2ZOTkc%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-15">现场精彩瞬间</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f905fdcdb645d9b180379ef0797723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=9QkJjH1dmtkvkvdLZUQzi%2BHKGZA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8acb674ddf134b6d95ae65ac7b194534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=s%2FHgoeOyMBardRwO8YrA5220p98%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/525fbe56fd824d1fbfa4be714fdd98f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=0GqS5uauJhC%2Bc7t5%2Frjs5MwYb0I%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bad049b076a4df2a51313673a56a09a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=aWPe8oP0wPx2JTnpj9G4W5FOar4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11227628027d4275929d32e8fc98cfc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=oojIlgdjNmcXG9QCRKiEe%2BgivyU%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1266e3a18ae454aaac07be8dad1b020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=X9mJbqqCT15UCMsrdf2Gqj4%2B21A%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c63261aadc4f4eaeafbe8010f72ba2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763631233&amp;x-signature=teiP2HCpq4cDsy7A1zg83lbRa40%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>