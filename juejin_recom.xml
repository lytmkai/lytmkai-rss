<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[从送外卖看Android Clean架构：为什么老板不需要知道外卖员开什么车？]]></title>    <link>https://juejin.cn/post/7596187471774138377</link>    <guid>https://juejin.cn/post/7596187471774138377</guid>    <pubDate>2026-01-19T00:04:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596187471774138377" data-draft-id="7582922476222660623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从送外卖看Android Clean架构：为什么老板不需要知道外卖员开什么车？"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-19T00:04:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潜龙勿用之化骨龙"/> <meta itemprop="url" content="https://juejin.cn/user/2313028195058471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从送外卖看Android Clean架构：为什么老板不需要知道外卖员开什么车？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028195058471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潜龙勿用之化骨龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T00:04:05.000Z" title="Mon Jan 19 2026 00:04:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想象你经营一家外卖公司，公司里有三种角色：</p>
<ol>
<li><strong>老板</strong>（你）：制定送餐规则，关心利润</li>
<li><strong>餐厅经理</strong>：准备食物，保证质量</li>
<li><strong>外卖员</strong>：把食物送到客户手中</li>
</ol>
<p>现在，如果你是老板，你需要知道每个外卖员是<strong>骑电动车、自行车还是开车</strong>吗？需要知道他们用什么导航<strong>高德还是百度</strong>吗？</p>
<p><strong>不需要！</strong> 你只关心：</p>
<ul>
<li>食物准时送到（30分钟内）</li>
<li>客户满意（不洒不漏）</li>
<li>公司赚钱（成本控制）</li>
</ul>
<p>这就是Clean架构的核心思想！让我们用这个外卖公司的例子，彻底理解Android开发中的关注点分离和依赖规则。</p>
<h2 data-id="heading-0">一、外卖公司的混乱：没有Clean架构</h2>
<h3 data-id="heading-1">❌ 混乱的外卖公司（糟糕的代码结构）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3640e327ed44fed960f91a2705142d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=XWC6lCCu09IOS3f27q6LD4wGC7Q%3D" alt="image.png" loading="lazy"/>
<strong>问题分析</strong>：这个外卖员干了厨师、打包员、导航员、司机、收银员、文员的所有工作！</p>
<h3 data-id="heading-2">❌ 如果公司要扩张...</h3>
<ul>
<li>想换导航软件？要重新培训所有外卖员</li>
<li>想增加新菜品？外卖员要学新菜</li>
<li>想换支付方式？外卖员要重新学习</li>
<li>外卖员离职了？所有知识都带走了</li>
</ul>
<h2 data-id="heading-3">二、专业的外卖公司：Clean架构实现</h2>
<h3 data-id="heading-4">✅ 清晰的分工（关注点分离）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7110ae5c5d95479cbe67a8cd32360f4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=3e1bfdOFs3LlPzK1MVR1MMyYkZE%3D" alt="mermaid_20251215_7b952f.png" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 领域层：老板制定规则（不关心具体实现）</h3>
<p>domain/model/Delivery.kt - 核心业务模型</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80705802052942149ff9f3120b4d4a55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=GnDygqEu15Oj167xg%2B9erIjNMEU%3D" alt="image.png" loading="lazy"/></p>
<p>domain/repository/DeliveryRepository.kt - 老板定义的接口</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97429bb3b6d14707b3eacec507335a1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=BTB4S2B3OAfvwRx3uK6wi5WHdmE%3D" alt="image.png" loading="lazy"/></p>
<p>domain/usecase/AssignDeliveryUseCase.kt - 老板的业务逻辑</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46c3a094897546d09cf3026480a79dc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=OgR9xnkE52qQgDmQx6w3o0Cws%2FI%3D" alt="image.png" loading="lazy"/>
}</p>
<p><strong>老板（领域层）的特点</strong>：</p>
<ul>
<li>不知道外卖员开什么车（不关心具体实现）</li>
<li>不知道餐厅用什么灶具（不关心数据源）</li>
<li>只关心业务规则和利润</li>
</ul>
<h3 data-id="heading-6">2.2 数据层：餐厅准备食物（具体实现）</h3>
<p>data/repository/DeliveryRepositoryImpl.kt - 餐厅经理的实现</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8001fcb8e841d9b88a7a80eebc0c42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=L6hBu9c%2BuTmjY8Rr14F09gQ%2Bvc8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>餐厅（数据层）的特点</strong>：</p>
<ul>
<li>实现老板要求的菜品标准</li>
<li>可以使用各种厨房设备（Retrofit）</li>
<li>负责把原材料（网络数据）加工成标准菜品（领域实体）</li>
</ul>
<h3 data-id="heading-7">2.3 表示层：外卖员送餐（UI展示）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee320a355184cc499853de3803a4ce8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=QYHLY7jcdZKLVgj2yyY41118xCw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c787c61188ec4c5f9fbdcce2b38e73f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=dxjp5gRWa9D0LTISnWQgpFH%2FFYw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>外卖员（表示层）的特点</strong>：</p>
<ul>
<li>可以是电动车、自行车、汽车（不同UI实现）</li>
<li>可以使用不同导航软件（不同地图SDK）</li>
<li>负责把食物（数据）展示给客户（用户）</li>
<li>与客户交互（用户输入）</li>
</ul>
<h2 data-id="heading-8">三、依赖规则：为什么老板不需要知道外卖员开什么车？</h2>
<h3 data-id="heading-9">3.1 依赖关系图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef0dc9c691614101b33c686414772686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=y7D%2B3huF0hpPm2XbbTd13KnAzZQ%3D" alt="mermaid_20251215_682d14.png" loading="lazy"/></p>
<h3 data-id="heading-10">3.2 关键规则：依赖只能指向老板（领域层）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59491e0523884905a32d77b399151698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=A9ZZGMiF8HoTVN3zmSU56hsrgjY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ff08593ff57486f9aab2f5de82c08e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=39j4hNRuq6ouUzgrlAsyFzQ6QDI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69ccd9562ebe4988b631c4dd77e890eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=E%2FI1aZSza7xq77kQbg4GPHGFLUI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">3.3 依赖注入：公司的HR部门</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f17159a7bd34758ab95994e9141f8c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=7sIfBDFF04%2BL%2BMHwJRoIS5ewSEI%3D" alt="image.png" loading="lazy"/></p>
<p>老板只需要告诉HR需要什么人，HR负责招聘</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc3e05bfc8884710bda4ebaf39dac736~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=4PRcOZaZqL0TNByTpaxhJcZoaN4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-12">4.1 如何开始重构现有项目？</h3>
<p><strong>第一步：识别"超级外卖员"类</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ba03852fdbb40ffbb54652821073f7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=GngjP8IuFcYrz%2FC1kR2t4hgquxw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>第二步：提取"老板规则"（领域层）</strong> 当然我不建议usecase 抛出异常,应该包装起来。这里只是举例。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5fe9ae247be447da0634ea4322e0351~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=fAHCowM%2Bd%2Bkp7a7BUgQCjqBQb8Y%3D" alt="image.png" loading="lazy"/></p>
<p><strong>第三步：创建"餐厅厨房"（数据层</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf82fcce0fdf4695b7c93658eaae2ce8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=juqfOqdpirPzCt1YNl8XOFWScaE%3D" alt="image.png" loading="lazy"/></p>
<p><strong>第四步：改造"外卖员"（表示层）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aceed0ee3e944f998b0607393f305bd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5r2c6b6Z5Yu_55So5LmL5YyW6aqo6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769385845&amp;x-signature=88sCn8gGBGhtzP8zE9RORkw8P5Y%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">5.2 常见问题解答</h3>
<p><strong>Q：小型项目也需要这样分层吗？</strong>
A：就像小外卖店开始可能只有一个人（老板兼厨师兼外卖员），但当业务增长时，一定要提前规划分工。可以从简单三层开始。</p>
<p><strong>Q：UseCase会不会太多？</strong>
A：就像老板的规则文档，重要的规则才需要写成UseCase。简单的CRUD操作可以直接在Repository处理。</p>
<p><strong>Q：测试真的变容易了吗？</strong>
A：你可以单独测试：</p>
<ul>
<li>老板的规则（UseCase测试）→ 验证业务逻辑</li>
<li>餐厅的菜品（Repository测试）→ 验证数据处理</li>
<li>外卖员的服务（UI测试）→ 验证用户交互</li>
</ul>
<p><strong>Q：学习成本高吗？</strong>
A：就像培训外卖员需要时间，但一旦掌握，效率倍增。从一个小功能开始尝试。</p>
<h3 data-id="heading-14">5.3 外卖架构的终极好处</h3>
<ol>
<li><strong>可维护性</strong>：老板换规则，不用重新培训外卖员</li>
<li><strong>可测试性</strong>：可以单独测试老板的决策逻辑</li>
<li><strong>可扩展性</strong>：增加新城市、新交通工具都很容易</li>
<li><strong>团队协作</strong>：可以并行开发（有人设计规则，有人开发UI，有人对接API）</li>
<li><strong>技术升级</strong>：换导航、换地图、换支付，都不影响核心业务</li>
</ol>
<h2 data-id="heading-15">六、总结：像经营外卖公司一样写Android代码</h2>
<p>记住这个简单的原则：</p>
<p><strong>你的代码应该像一个专业的外卖公司：</strong></p>
<ul>
<li>
<p><strong>老板（领域层）</strong>：制定规则，关心业务，不关心具体实现</p>
</li>
<li>
<p><strong>餐厅（数据层）</strong>：准备标准菜品，可以用各种厨具</p>
</li>
<li>
<p><strong>外卖员（表示层）</strong>：专业配送，良好服务，灵活应变</p>
</li>
</ul>
<p><strong>依赖规则就是</strong>：外卖员听老板的，餐厅按老板的标准做菜，但老板不需要知道外卖员开什么车，也不需要知道餐厅用什么牌子的灶具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 3.0新特性：ProblemDetail让错误响应不再头疼]]></title>    <link>https://juejin.cn/post/7596698363933261874</link>    <guid>https://juejin.cn/post/7596698363933261874</guid>    <pubDate>2026-01-19T01:04:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596698363933261874" data-draft-id="7596698363933229106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 3.0新特性：ProblemDetail让错误响应不再头疼"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-19T01:04:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 3.0新特性：ProblemDetail让错误响应不再头疼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T01:04:05.000Z" title="Mon Jan 19 2026 01:04:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/964a52a8cca04e98a0f11066c138586f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=OZlaRgb20mm9rgLlZA5t48LPNAg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>之前写过一篇关于统一相应的参数处理的文章，有路过的朋友指出错误信息为什么还要统一处理。技术储备浅薄的我一脸懵逼，经过交流才知道，大佬使用了<code>ProblemDetail</code>处理异常，于是专门学习了一下，记录下来分享给大家。</p>
<h2 data-id="heading-1">02 简介</h2>
<p><code>org.springframework.http.ProblemDetail</code></p>
<p><code>ProblemDetail</code> 是 <code>Spring Boot 3.0</code>（Spring Framework 6.0）引入的类，用于标准化 <code>HTTP API</code> 错误响应格式，符合 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7807" target="_blank" title="https://tools.ietf.org/html/rfc7807" ref="nofollow noopener noreferrer">RFC 7807</a> 标准。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b105c926af0740ea82ac5f9a8e7326cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=2hWDOWAzpb9BVkHjkjADJAoEJ0c%3D" alt="" loading="lazy"/></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-boot%2F3.5%2Freference%2Fweb%2Fservlet.html%23web.servlet.spring-mvc.error-handling" target="_blank" title="https://docs.spring.io/spring-boot/3.5/reference/web/servlet.html#web.servlet.spring-mvc.error-handling" ref="nofollow noopener noreferrer">docs.spring.io/spring-boot…</a></p>
<h3 data-id="heading-2">2.1 属性</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/139e7ee8fb4a461eb0c4251257effe67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=Ob3mmqNiFHE9GRcVdfKWAsMwbLQ%3D" alt="" loading="lazy"/></p>
<p><code>private URI type</code>： 错误类型标识（URI格式）</p>
<p><code>private String title</code>：简短错误描述</p>
<p><code>private int status</code>：HTTP状态码</p>
<p><code>private String detail</code>：详细错误描述</p>
<p><code>private URI instance</code>：具体错误实例标识</p>
<p><code>private Map&lt;String, Object&gt; properties</code>：扩展属性</p>
<h3 data-id="heading-3">2.2 异常返回一览</h3>
<p><code>SpringBoot 3.0</code>之前的报错：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1093f4f8bd464a8780d6835ecb90915d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=F5ey7cEVtkT%2BmSZr2J63RtJ1yBY%3D" alt="" loading="lazy"/></p>
<p><code>SpringBoot 3.0</code>之后的报错：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f9b3815cd00468ebf197cf2f2b56812~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=DRR9tai5htzXVbCVupb4XFlLS44%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">03 使用</h2>
<p><code>ProblemDetail</code>的使用是有讲究的，不了解其中的道道，可能触发不了<code>ProblemDetail</code>的异常包装。</p>
<h3 data-id="heading-5">3.1 启动开关</h3>
<p><code>SpringBoot</code>框架针对<code>ProblemDetail</code>的启用做了开关，默认关闭。</p>
<p>通过配置生效：</p>
<pre><code class="hljs language-properties" lang="properties">spring.mvc.problemdetails.enabled=true
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/314e3b787d12464cb8533b0518fa88f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=RLREzGZgRqLNQSNEkAppapGwask%3D" alt="" loading="lazy"/></p>
<p>配置类：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4db194cd492400fb7d09462123017b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=S%2FRQ1PbhtOTERHlT3LPy1huM81U%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.2 测试方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/divide")</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">divide</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-keyword">return</span> a / b; 
}
</code></pre>
<p>如果 b=0，会触发 <code>ArithmeticException</code>。但是这个异常并没有触发<code>ProblemDetail</code>异常的封装。</p>
<p>测试请求：<code>http://127.0.0.1:8080/divide?a=10&amp;b=0</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb87c2e2785948c9bd4378388912a534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=PJh74GdpX1qdM%2FNtCPxZ%2BNy9u%2B4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.3 原因追溯</h3>
<p>没有成功，难道是因为配置没有生效。我们从官网找一点蛛丝马迹。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92bb5b5041f2461387f9421d4b7873b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=9JnMVG%2B36ZOICLh7zSrVVzv9l6E%3D" alt="" loading="lazy"/></p>
<p>大致意思是：要想启用RFC响应，可以扩展<code>ResponseEntityExceptionHandler</code>并声明<code>@ControllerAdvice</code>。处理器通过<code>@ExceptionHandler</code>采集异常，也可以添加其他异常并映射到<code>ProblemDetail</code></p>
<p>所以我们看看<code>ResponseEntityExceptionHandler</code>的子类有没有类似的实现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dba9807ac7340d4abb5fb5bfe33bab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=OQVb7XiJrt6pM6ICcRi1hEUjK%2Fc%3D" alt="" loading="lazy"/></p>
<p>通过查看，我们可以发现<code>ProblemDetailsExceptionHandler</code>子类，似乎是处理<code>ProblemDetail</code>的关键。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebeb6681d3f94816844c9fbe9273a8c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=larGrxZeDrqcQMdBvRcIGAEqlNY%3D" alt="" loading="lazy"/></p>
<p><code>@ControllerAdvice</code>注解我们再熟悉不过了，用于参数绑定、异常处理等。而<code>ResponseEntityExceptionHandler</code>默认处理的异常：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc5b4a415e724d07b514a786197569ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=C1qJcRlehSBfWmvDDwH%2FZuO1kwQ%3D" alt="" loading="lazy"/></p>
<p>显然没有<code>ArithmeticException</code>异常，自然不会被处理。</p>
<p>那我们只需要使用<code>ResponseEntityExceptionHandler</code>中的异常即可。</p>
<h3 data-id="heading-8">3.4 重新测试</h3>
<p>测试方法中接收的字段类型为int，我们只需要传入非int类型的数据，就会触发<code>MethodArgumentTypeMismatchException</code>异常。而<code>MethodArgumentTypeMismatchException</code>继承<code>TypeMismatchException</code>异常。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/914f07fc4b4045419172467d08c4fecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=Ji6IiN7knJoDpsCjJ5dJICFmogs%3D" alt="" loading="lazy"/></p>
<p>测试地址：<code>http://127.0.0.1:8080/divide?a=10&amp;b=a</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee9fb4a7049e49698c596d7a72a6414e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=%2FvUrTvZnMkyiW3X6s1KiWuQ4H7o%3D" alt="" loading="lazy"/></p>
<p>结果已经触发<code>ProblemDetail</code>的信息了。</p>
<h2 data-id="heading-9">04 问题</h2>
<p><code>ProblemDetail</code>异常包装触发了，但是并不是所有的异常都可以兜得住。即便是<code>ResponseEntityExceptionHandler</code>中的异常也有没有包装的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b803444a4f04c72b692aa46f2ff5a2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=K3VAZ8glSxpDT8I17pMg35GudGg%3D" alt="" loading="lazy"/></p>
<p>小编这里不太理解为什么会从中间分开，上半部分异常不会触发<code>ProblemDetail</code>异常包装，而下半部分会触发。</p>
<p>所以我们在需要处理全局异常的时候，还需要我们自己去处理所有的异常，包括自定义异常已达到统一参数。</p>
<h2 data-id="heading-10">05 触发源码</h2>
<p><code>ProblemDetailsExceptionHandler</code>的包位于<code>org.springframework.boot.autoconfigure.web.servlet</code>下，又是如何通过配置启动的呢？</p>
<p>当然还是自动配置的类：<code>WebMvcAutoConfiguration</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9e7411b907443bf87fcc0bab46a6ef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769389445&amp;x-signature=joz4DIxoUp7wgl0ehZe9TYdn6S4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">06 小结</h2>
<p>我们可以自己通过<code>ProblemDetail</code>封装异常信息，然后统一异常参数，全局统一处理异常，以达到全局统一的目的。可能里面还有小编理解不到位的地方，有问题评论区指出来，小编加以修正。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[敢不敢挑战用Cocos3.8复刻曾经很火的割绳子游戏？]]></title>    <link>https://juejin.cn/post/7596384019002081306</link>    <guid>https://juejin.cn/post/7596384019002081306</guid>    <pubDate>2026-01-19T03:30:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596384019002081306" data-draft-id="7596339303862386739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="敢不敢挑战用Cocos3.8复刻曾经很火的割绳子游戏？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-19T03:30:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            敢不敢挑战用Cocos3.8复刻曾经很火的割绳子游戏？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T03:30:03.000Z" title="Mon Jan 19 2026 03:30:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f7975ec955944b7b11222efa66e73fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=uB%2FjQa%2F9Z5e3Bp0zkwCKa79Z7%2B8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，我是亿元程序员，最近有小伙伴私信笔者：</p>
<blockquote>
<p><strong>亿哥</strong>，不知道你有没有玩过上面那款<code>16</code>年前火遍全网的割绳子游戏。</p>
<p><strong>我最近</strong>在做游戏时，需要做类似这个游戏里面的绳子效果，不知道怎么实现！</p>
<p><strong>你最近</strong>不是在更新热门小游戏实战合集吗！</p>
<p><strong>敢不敢挑战用Cocos3.8复刻一个？</strong></p>
</blockquote>
<p><strong>好家伙</strong>，这款游戏笔者最熟悉不过了，那时候苹果<code>4</code>才刚出来没多久，这样的触屏物理游戏可以算得上人手一个。</p>
<p><strong>关于</strong>割绳子的物理效果，我记得之前参与论坛投稿活动时，参考某个砍树游戏出过一期：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62bfc91e91d444ca81fe6d2de794ad3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=hgR8B9XofrLjKT9LX46EZkM6hGo%3D" alt="" loading="lazy"/></p>
<p><strong>翻了一下</strong>，看到了一些扎心的评论：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8aa09af49424234b141426f457d2699~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=E7571XsqMEkM2O%2FGyFofyTzYDLo%3D" alt="你这是棍子吧" loading="lazy"/></p>
<p><strong>言归正传</strong>，本期带大家一起来看看，如何在<code>Cocos</code>游戏开发中，如何实现不像棍子的绳子效果，并且实战做一个曾经很火的割绳子游戏。</p>
<p><strong>本文源工程可在文末获取，小伙伴们自行前往。</strong></p>
<h2 data-id="heading-1">回顾一下</h2>
<p><strong>想要</strong>在<code>Cocos</code>游戏开发中，实现一条带有物理效果的绳子，可以使用我们系统自带的距离关节<code>Distance Joint</code>。</p>
<p><strong>距离关节</strong>会将关节两端的刚体约束在一个最大范围内。超出该范围时，刚体的运动会互相影响。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c91d00de6b0413daf590e861d52404e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=rGpYo5WDXtePCfKXgD2gbu9%2B3%2BE%3D" alt="来源于Cocos官方文档" loading="lazy"/></p>
<p><strong>既然如此</strong>，为什么之前做的绳子像棍子？</p>
<h2 data-id="heading-2">关节太少</h2>
<p><strong>因为</strong>之前做的<code>demo</code>，钩子和物品之间，仅仅使用了一个距离关节，所以很难模拟出来绳子柔软的效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1940355a534825be4d4caaaa025215~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=xRh49gxPZg7k3tn%2Fh4PKqodtbfg%3D" alt="" loading="lazy"/></p>
<p><strong>那么</strong>不像棍子的绳子怎么做？</p>
<h2 data-id="heading-3">增加足够多的关节</h2>
<p><strong>首先</strong>制作一节<code>5*20</code>的绳子，属性组件如下:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d10abbf149124ebda24182a1c2369d25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=7WzdZJn8jdVbO2oXILh%2F58X4P3g%3D" alt="" loading="lazy"/></p>
<p><strong>理论上</strong>只要添加足够多的关节，就会越来越接近柔软的绳子效果，因此我们可以通过代码去控制生成足够多的关节，一节连一节。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae934897f0b49a2bf8c9714995d1376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=y7AE1oNDpTUwbo%2Fh8tN%2Fz5I3Y9M%3D" alt="" loading="lazy"/></p>
<p><strong>效果</strong>如下，不过绳子看起来并不是连续的，关节因为重力效果，会被拉开一段距离。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a8e4d5b6f40420ba1999352aac01aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=fch7OL3SKA8h1hm%2F3pMFiFJJRm0%3D" alt="" loading="lazy"/></p>
<p><strong>这个问题怎么解决？</strong></p>
<h2 data-id="heading-4">画线辅助</h2>
<p><strong>为了</strong>解决受重力效果导致的绳结断开的问题，我们可以通过<code>Graphics</code>组件逐点进行画线，代码如下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/469786f0559e42c7a10ec6908289cdcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=odzYvSSthAixG1JuZEisGeVaC9g%3D" alt="" loading="lazy"/></p>
<p><strong>效果</strong>如下，但是看起来还是有点问题，绳子连接处不太和谐，不像一根绳子，反而像哼哼哈嘿的双截棍：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7771eab1156f4979a7c7da28c6f41398~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=h0QbL3QnhqosG0W8MDG0tRZMa20%3D" alt="" loading="lazy"/></p>
<p><strong>因此</strong>我们需要把绳子画得更加平滑一点。</p>
<h2 data-id="heading-5">平滑曲线</h2>
<p><strong>想要</strong>让曲线更加平滑，通常可以采用二次贝塞尔曲线连接相邻点，首先我们先要把所有的点位收集起来：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5564e310d865478eae3248564f7a82e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=uEHYxrR6t08vN1X5uWVSKC9pGCM%3D" alt="" loading="lazy"/></p>
<p><strong>核心</strong>的绘制方法<code>quadraticCurveTo</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3281a3c860d840dc98ee20bfbfc8ea84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=25ZGgSna4p4Fb%2FMkDgKEhiqmJQI%3D" alt="" loading="lazy"/></p>
<p><strong>这样</strong>看起来就合理一点了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acedaf326af44f7f876ee3e6fa9a98f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=a7AEY7rCBkvgJRX3eUV%2F%2BRXsrns%3D" alt="" loading="lazy"/></p>
<p><strong>通过</strong>上述流程，我们就能成功实现一根不像棍子的绳子了。</p>
<p><strong>接下来我们完成割绳子游戏的剩余部分。</strong></p>
<h2 data-id="heading-6">割绳子游戏实战</h2>
<p><strong>有了</strong>上面的绳子基础，我们想要实现一个完整的割绳子游戏就易如反掌了。</p>
<p><strong>1. 割绳子</strong></p>
<p><strong>既然</strong>是割绳子游戏，割当然是也是重要的一环，割绳子最主要判断手指移动的轨迹与实际上哪一段关节相交。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03baedd840194377ae5e958eb3bb6cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=gMS41LaGR%2BIKXRfxYCENFbOsY%2FQ%3D" alt="" loading="lazy"/></p>
<p><strong>判断</strong>相交的核心方法如下:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55aee08f91ac47ddb5361e44a9c631f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=y4Qtqvw9Apo56CFcIJG9ER5gv1o%3D" alt="" loading="lazy"/></p>
<p><strong>2. 切割效果</strong></p>
<p><strong>为了</strong>增加游戏效果，我们可以在屏幕上画线时，增加一段拖尾效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4977a9cb463e4c4c93907c6c9ef12836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=mBPB4qoMEYAOvmTmJAhG9B08IzE%3D" alt="" loading="lazy"/></p>
<p><strong>效果如下:</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/026b832865c4408a93ea62ea6300dcaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=XWYBYpI6GF8BVcVUMRUKPIxIfsE%3D" alt="" loading="lazy"/></p>
<p><strong>3. 其他游戏元素</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ce746683e874cc584fd686e1eab0dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=zGqle4NhhSkVsPRKbWsRlR9YRBQ%3D" alt="" loading="lazy"/></p>
<p><strong>除去</strong>绳子相关的部分，剩下就是割绳子游戏的其他元素，包括：</p>
<ul>
<li>
<p><strong>钩子</strong>: 主要起到固定绳子的作用，需要添加刚体组件，<code>Type</code>设置为<code>Static</code>。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7afea069b52b47a39c6e5c0bfc226116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=GqfY9EQFLRGwy2jp8%2Fz%2B6ErZmcc%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>甜甜圈</strong>: 需要添加碰撞组件、管理脚本以及刚体组件，需要开启<code>Enabled Contact Listener</code>，在对应的管理脚本进行处理碰撞事件。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/719e9c6a42f448d5a24045c1782e6118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=diPPdpUwiSgZNBLdkkd%2F%2B5fD8uc%3D" alt="" loading="lazy"/>
如下碰撞到星星和目标点时进行处理。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/815486f0bd5c4872947216ebd5b55e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=8S6Y1nUDXZf%2F0Jm6uk%2FPK3DzbDE%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>星星</strong>: 添加碰撞组件和管理脚本，增加一些简单的动画。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da2e6a58dee9400b901544dcc8785f2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=q%2FWOOp%2F5D1RiQfwCBuneiTEUeKA%3D" alt="" loading="lazy"/>
旋转和碰撞放大效果。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19b5efd668ea428db4c0685767482fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=mZN6w5zQzKTSKN3X4x%2FSVL4wBc4%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>目标点</strong>: 目标点和上面差不多，主要是用来判断是否到达目标点，以及添加一些到达动画。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86cc9e32b8db47809acf8875f8128303~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=bHbw%2BE24kay9cOZ4RqoBn%2BZcBdE%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>其他</strong>: 随着游戏关卡地不断增加，会有越来越多的其他游戏元素，笔者只实现了以上基础的部分，感兴趣的小伙伴们可以自行扩展。</p>
</li>
</ul>
<p><strong>4. 效果演示</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1aa4e21f62348bab55a9836e52e5f42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769398203&amp;x-signature=eXojTn8R3J26cI3bntvMTDRDhjE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-7">结语</h2>
<p><strong>割绳子游戏</strong>真的是回忆杀，勾起笔者的无限回忆，等我退休了，一定要完完整整复刻一个，一边复刻一边玩。</p>
<p><strong>小伙伴们</strong>，你们玩过这款游戏吗？那时候的你们进入游戏行业了吗？</p>
<p>本文<strong>实战完整源码</strong>已集成到<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">亿元Cocos小游戏实战合集</a>，内含体验链接。</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFOi5gCiGzF3LnT03DpPMXA" target="_blank" title="https://mp.weixin.qq.com/s/FOi5gCiGzF3LnT03DpPMXA" ref="nofollow noopener noreferrer">亿元Cocos小游戏实战合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZIph332u_r24OTY4r6_jow" target="_blank" title="https://mp.weixin.qq.com/s/ZIph332u_r24OTY4r6_jow" ref="nofollow noopener noreferrer">Cocos游戏开发中的贴花效果</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter-实现瀑布流布局及下拉刷新上拉加载更多]]></title>    <link>https://juejin.cn/post/7596478936386764842</link>    <guid>https://juejin.cn/post/7596478936386764842</guid>    <pubDate>2026-01-19T00:47:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596478936386764842" data-draft-id="7596166721627783214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter-实现瀑布流布局及下拉刷新上拉加载更多"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-19T00:47:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter-实现瀑布流布局及下拉刷新上拉加载更多
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T00:47:51.000Z" title="Mon Jan 19 2026 00:47:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在 Flutter 应用开发中，瀑布流布局常用于展示图片、商品列表等需要以不规则但整齐排列的内容。同时，下拉刷新和上拉加载更多功能，能够极大提升用户体验，让用户方便地获取最新和更多的数据。</p>
<h2 data-id="heading-0">1. 前置条件</h2>
<ol>
<li>
<p>Flutter 环境已搭建（要求 Flutter 3.0+、Dart 2.17+）</p>
</li>
<li>
<p>本地图片资源已放入 <code>assets/images</code> 目录，并在 <code>pubspec.yaml</code> 中配置</p>
</li>
<li>
<p>已安装依赖插件并执行 <code>flutter pub get</code></p>
</li>
</ol>
<h2 data-id="heading-1">2. 结构分析</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3fb3fa88858454c847241e8398618d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769388471&amp;x-signature=1b%2BajzGhngXmLLWlGGPXnQnboT8%3D" alt="6210b7bafa9244369d7ce1aa5ca874be.gif" loading="lazy"/></p>
<h3 data-id="heading-2">2.1 安装依赖插件</h3>
<p>在项目的 <code>pubspec.yaml</code> 文件中添加以下依赖：</p>
<pre><code class="hljs language-YAML" lang="YAML">
<span class="hljs-comment"># 瀑布流布局：https://pub.dev/packages/waterfall_flow</span>
<span class="hljs-attr">waterfall_flow:</span> <span class="hljs-string">^3.0.3</span>
<span class="hljs-comment"># 上拉加载更多+下拉刷新：https://pub.dev/packages/pull_to_refresh</span>
<span class="hljs-attr">pull_to_refresh:</span> <span class="hljs-string">^2.0.0</span>
</code></pre>
<p>注意：<code>waterfall_flow: ^3.0.3</code> 需适配 Flutter 3.0+，<code>pull_to_refresh: ^2.0.0</code> 需 Dart 2.17+</p>
<p>添加依赖后执行命令安装：</p>
<pre><code class="hljs language-Bash" lang="Bash">
flutter pub get
</code></pre>
<h3 data-id="heading-3">2.2 配置本地图片资源</h3>
<p>在 <code>pubspec.yaml</code> 中配置图片资源路径，确保 Flutter 能识别本地图片：</p>
<pre><code class="hljs language-YAML" lang="YAML">
<span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">uses-material-design:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># 配置图片资源目录</span>
  <span class="hljs-attr">assets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/</span>
</code></pre>
<h3 data-id="heading-4">2.3 引入必要的库</h3>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:pull_to_refresh/pull_to_refresh.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:waterfall_flow/waterfall_flow.dart'</span>;
</code></pre>
<ul>
<li>
<p><code>dart:async</code>：提供异步操作能力，用于处理刷新和加载更多的延迟模拟。</p>
</li>
<li>
<p><code>package:flutter/material.dart</code>：Flutter 核心 UI 库，提供 Scaffold、Container 等基础组件。</p>
</li>
<li>
<p><code>package:pull_to_refresh/pull_to_refresh.dart</code>：实现下拉刷新和上拉加载更多的核心库。</p>
</li>
<li>
<p><code>package:waterfall_flow/waterfall_flow.dart</code>：用于快速构建瀑布流布局的第三方库。</p>
</li>
</ul>
<h3 data-id="heading-5">2.4 定义图片枚举及扩展</h3>
<p>为了规范图片资源管理，我们定义图片枚举，并通过扩展方法获取图片路径：</p>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-comment">/// <span class="markdown">本地图片枚举</span></span>
<span class="hljs-keyword">enum</span> ImageEnum {
  banner1,
  banner2,
  banner3,
  model1,
  model2,
  model3,
  model4,
}

<span class="hljs-comment">/// <span class="markdown">为枚举扩展获取图片路径的方法</span></span>
<span class="hljs-keyword">extension</span> ImageEnumExtension <span class="hljs-keyword">on</span> ImageEnum {
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> path {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> ImageEnum.banner1:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/banner1.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.banner2:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/banner2.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.banner3:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/banner3.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model1:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model1.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model2:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model2.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model3:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model3.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model4:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model4.png'</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-6">2.5 定义 ImageWaterfallFlow 组件</h3>
<p>定义有状态组件，用于管理瀑布流布局的状态和 UI 渲染：</p>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageWaterfallFlow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> ImageWaterfallFlow({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;ImageWaterfallFlow&gt; createState() =&gt; ImageWaterfallFlowState();
}
</code></pre>
<p>有状态组件可以根据用户操作或数据变化动态更新 UI，<code>createState</code> 方法返回状态管理类 <code>ImageWaterfallFlowState</code>。</p>
<h3 data-id="heading-7">2.6 ImageWaterfallFlowState 类的详细解析</h3>
<p>该类是组件的核心，负责管理数据、控制器和业务逻辑：</p>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageWaterfallFlowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ImageWaterfallFlow</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">字体样式</span></span>
  <span class="hljs-keyword">final</span> TextStyle myTxtStyle = <span class="hljs-keyword">const</span> TextStyle(
      color: Colors.white, fontSize: <span class="hljs-number">24</span>, fontWeight: FontWeight.w800);

  <span class="hljs-comment">/// <span class="markdown">模拟数据（初始数据）- 增加泛型提升类型安全</span></span>
  <span class="hljs-built_in">List</span>&lt;ImageEnum&gt; imageList = [
    ImageEnum.banner1,
    ImageEnum.banner2,
    ImageEnum.banner3,
    ImageEnum.model1,
    ImageEnum.model2,
    ImageEnum.model3,
    ImageEnum.model4,
    ImageEnum.banner1,
    ImageEnum.banner2,
    ImageEnum.banner3,
    ImageEnum.model1,
    ImageEnum.model2,
    ImageEnum.model3,
    ImageEnum.model4
  ];

  <span class="hljs-comment">/// <span class="markdown">模拟数据（加载更多使用）</span></span>
  <span class="hljs-built_in">List</span>&lt;ImageEnum&gt; moreList = [ImageEnum.banner1, ImageEnum.banner2, ImageEnum.banner3];

  <span class="hljs-comment">/// <span class="markdown">上拉下拉控制器</span></span>
  <span class="hljs-keyword">final</span> RefreshController myRefreshController = RefreshController();
</code></pre>
<ul>
<li>
<p><code>myTxtStyle</code>：定义图片上显示序号的字体样式。</p>
</li>
<li>
<p><code>imageList</code>：存储瀑布流初始展示的图片数据，使用泛型 <code>List&lt;ImageEnum&gt;</code> 保证类型安全。</p>
</li>
<li>
<p><code>moreList</code>：存储加载更多时需要追加的数据。</p>
</li>
<li>
<p><code>myRefreshController</code>：来自 <code>pull_to_refresh</code> 库，用于控制刷新和加载的状态。</p>
</li>
</ul>
<h3 data-id="heading-8">2.7 刷新和加载更多的方法</h3>
<p>实现下拉刷新和上拉加载更多的业务逻辑，补充边界条件处理：</p>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-comment">/// <span class="markdown">刷新</span></span>
<span class="hljs-keyword">void</span> onRefresh() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">1000</span>));
  <span class="hljs-comment">// 模拟刷新：恢复初始数据</span>
  setState(() {
    imageList = [
      ImageEnum.banner1,
      ImageEnum.banner2,
      ImageEnum.banner3,
      ImageEnum.model1,
      ImageEnum.model2,
      ImageEnum.model3,
      ImageEnum.model4,
      ImageEnum.banner1,
      ImageEnum.banner2,
      ImageEnum.banner3,
      ImageEnum.model1,
      ImageEnum.model2,
      ImageEnum.model3,
      ImageEnum.model4
    ];
  });
  myRefreshController.refreshCompleted();
  myRefreshController.resetNoData(); <span class="hljs-comment">// 重置无更多数据状态</span>
}

<span class="hljs-comment">/// <span class="markdown">加载更多</span></span>
<span class="hljs-keyword">void</span> onLoadMore() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">1000</span>));
  <span class="hljs-comment">// 模拟：数据超过30条时标记无更多数据</span>
  <span class="hljs-keyword">if</span> (imageList.length &gt;= <span class="hljs-number">30</span>) {
    myRefreshController.loadNoData();
  } <span class="hljs-keyword">else</span> {
    imageList.addAll(moreList);
    <span class="hljs-keyword">if</span> (mounted) {
      setState(() {});
    }
    myRefreshController.loadComplete();
  }
}
</code></pre>
<ul>
<li>
<p><code>onRefresh</code>：下拉刷新时触发，模拟 1 秒延迟后恢复初始数据，并重置加载状态。</p>
</li>
<li>
<p><code>onLoadMore</code>：上拉加载时触发，模拟 1 秒延迟后追加数据；当数据量超过 30 条时，标记为“无更多数据”。</p>
</li>
<li>
<p><code>mounted</code> 判断：防止组件销毁后调用 <code>setState</code> 导致异常。</p>
</li>
</ul>
<h3 data-id="heading-9">2.8 资源释放</h3>
<p>重写 <code>dispose</code> 方法，释放控制器资源，避免内存泄漏：</p>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> dispose() {
  myRefreshController.dispose(); <span class="hljs-comment">// 释放刷新控制器</span>
  <span class="hljs-keyword">super</span>.dispose();
}
</code></pre>
<h3 data-id="heading-10">2.9 构建 UI 的方法</h3>
<p>构建组件的基础布局结构：</p>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-comment">/// <span class="markdown">布局</span></span>
<span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.black,
      body: SafeArea(
          child: SizedBox(
              width: MediaQuery.of(context).size.width,
              height: MediaQuery.of(context).size.height,
              child: listWidget())));
}
</code></pre>
<ul>
<li>
<p><code>Scaffold</code>：作为页面的根布局，设置背景色为黑色。</p>
</li>
<li>
<p><code>SafeArea</code>：避免内容被刘海屏、状态栏等遮挡。</p>
</li>
<li>
<p><code>SizedBox</code>：设置与屏幕同宽同高的容器，承载瀑布流列表。</p>
</li>
</ul>
<h3 data-id="heading-11">2.10 构建瀑布流列表的方法</h3>
<p>整合刷新组件和瀑布流布局，实现核心 UI 效果：</p>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-comment">/// <span class="markdown">列表</span></span>
Widget listWidget() {
  <span class="hljs-keyword">return</span> SmartRefresher(
    enablePullDown: <span class="hljs-keyword">true</span>,
    enablePullUp: <span class="hljs-keyword">true</span>,
    header: <span class="hljs-keyword">const</span> ClassicHeader(),
    footer: <span class="hljs-keyword">const</span> ClassicFooter(),
    controller: myRefreshController,
    onRefresh: onRefresh,
    onLoading: onLoadMore,
    child: WaterfallFlow.builder(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">10</span>), <span class="hljs-comment">// 增加内边距，避免内容贴边</span>
      physics: <span class="hljs-keyword">const</span> BouncingScrollPhysics(),
      gridDelegate: SliverWaterfallFlowDelegateWithFixedCrossAxisCount(
        crossAxisCount: <span class="hljs-number">2</span>,
        crossAxisSpacing: <span class="hljs-number">20</span>,
        mainAxisSpacing: <span class="hljs-number">20</span>,
        viewportBuilder: (<span class="hljs-built_in">int</span> index1, <span class="hljs-built_in">int</span> index2) {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'变化：<span class="hljs-subst">$index1</span>-<span class="hljs-subst">$index2</span>'</span>);
        },
        <span class="hljs-comment">// 修正最后一个子项的判断逻辑（索引从0开始）</span>
        lastChildLayoutTypeBuilder: (index) =&gt; index == imageList.length - <span class="hljs-number">1</span>
            ? LastChildLayoutType.fullCrossAxisExtent
            : LastChildLayoutType.none,
      ),
      itemCount: imageList.length,
      itemBuilder: (BuildContext context, <span class="hljs-built_in">int</span> index) {
        <span class="hljs-keyword">return</span> Container(
          color: Colors.white,
          height: (index + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> ? <span class="hljs-number">100</span> : <span class="hljs-number">200</span>,
          child: Container(
              alignment: Alignment.center,
              decoration: BoxDecoration(
                  color: Colors.blue.shade300,
                  image: DecorationImage(
                    image: AssetImage(imageList[index].path), <span class="hljs-comment">// 调用扩展方法获取图片路径</span>
                    fit: BoxFit.cover,
                  )),
              child: Text(<span class="hljs-string">'第<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>张'</span>, style: myTxtStyle)),
        );
      },
    ),
  );
}
</code></pre>
<ul>
<li>
<p><code>SmartRefresher</code>：<code>pull_to_refresh</code> 库的核心组件，配置上下拉开关、头部底部样式和回调方法。</p>
</li>
<li>
<p><code>WaterfallFlow.builder</code>：瀑布流布局的构建器，通过懒加载方式渲染子项：</p>
<ul>
<li>
<p><code>padding</code>：增加内边距，优化视觉效果。</p>
</li>
<li>
<p><code>crossAxisCount: 2</code>：设置瀑布流为 2 列布局。</p>
</li>
<li>
<p><code>crossAxisSpacing</code>/<code>mainAxisSpacing</code>：设置子项之间的水平和垂直间距。</p>
</li>
<li>
<p><code>lastChildLayoutTypeBuilder</code>：修正索引判断逻辑，让最后一个子项占满整行宽度。</p>
</li>
<li>
<p><code>itemBuilder</code>：构建每个瀑布流子项，通过 <code>AssetImage(imageList[index].path)</code> 获取图片路径，设置不同高度实现瀑布流效果。</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-12">3. 核心库 API &amp; 属性说明</h2>
<h3 data-id="heading-13">3.1 waterfall_flow 核心 API/属性</h3>
<h4 data-id="heading-14">3.1.1 WaterfallFlow 核心组件</h4>





















































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>padding</code></td><td><code>EdgeInsetsGeometry</code></td><td>瀑布流整体内边距</td><td><code>EdgeInsets.zero</code></td></tr><tr><td><code>physics</code></td><td><code>ScrollPhysics</code></td><td>滚动物理效果</td><td><code>AlwaysScrollableScrollPhysics()</code></td></tr><tr><td><code>shrinkWrap</code></td><td><code>bool</code></td><td>是否根据子项高度自适应</td><td><code>false</code></td></tr><tr><td><code>gridDelegate</code></td><td><code>SliverWaterfallFlowDelegate</code></td><td>瀑布流布局代理（核心）</td><td>无（必传）</td></tr><tr><td><code>children</code></td><td><code>List&lt;Widget&gt;</code></td><td>子组件列表（非懒加载）</td><td><code>[]</code></td></tr><tr><td><code>itemCount</code></td><td><code>int</code></td><td>子项数量（builder 模式）</td><td>无（builder 模式必传）</td></tr><tr><td><code>itemBuilder</code></td><td><code>IndexedWidgetBuilder</code></td><td>子项构建器（懒加载）</td><td>无（builder 模式必传）</td></tr></tbody></table>
<h4 data-id="heading-15">3.1.2 SliverWaterfallFlowDelegateWithFixedCrossAxisCount（常用布局代理）</h4>















































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>crossAxisCount</code></td><td><code>int</code></td><td>列数（核心）</td><td>无（必传）</td></tr><tr><td><code>crossAxisSpacing</code></td><td><code>double</code></td><td>列之间的间距</td><td><code>0.0</code></td></tr><tr><td><code>mainAxisSpacing</code></td><td><code>double</code></td><td>行之间的间距</td><td><code>0.0</code></td></tr><tr><td><code>lastChildLayoutTypeBuilder</code></td><td><code>LastChildLayoutTypeBuilder</code></td><td>最后一个子项布局类型</td><td><code>null</code></td></tr><tr><td><code>viewportBuilder</code></td><td><code>ViewportBuilder</code></td><td>视口内子项变化回调</td><td><code>null</code></td></tr><tr><td><code>collectGarbage</code></td><td><code>CollectGarbage</code></td><td>回收不可见子项时的回调</td><td><code>null</code></td></tr></tbody></table>
<h4 data-id="heading-16">3.1.3 LastChildLayoutType（最后一个子项布局类型）</h4>





















<table><thead><tr><th>枚举值</th><th>说明</th></tr></thead><tbody><tr><td><code>LastChildLayoutType.none</code></td><td>无特殊布局（默认）</td></tr><tr><td><code>LastChildLayoutType.fullCrossAxisExtent</code></td><td>占满整行宽度</td></tr><tr><td><code>LastChildLayoutType.footnote</code></td><td>脚注样式（小尺寸）</td></tr></tbody></table>
<h3 data-id="heading-17">3.2 pull_to_refresh 核心 API/属性</h3>
<h4 data-id="heading-18">3.2.1 SmartRefresher（核心组件）</h4>













































































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>enablePullDown</code></td><td><code>bool</code></td><td>是否启用下拉刷新</td><td><code>true</code></td></tr><tr><td><code>enablePullUp</code></td><td><code>bool</code></td><td>是否启用上拉加载</td><td><code>false</code></td></tr><tr><td><code>header</code></td><td><code>RefreshHeader</code></td><td>下拉刷新头部样式</td><td><code>ClassicHeader()</code></td></tr><tr><td><code>footer</code></td><td><code>LoadFooter</code></td><td>上拉加载底部样式</td><td><code>ClassicFooter()</code></td></tr><tr><td><code>controller</code></td><td><code>RefreshController</code></td><td>刷新/加载控制器（核心）</td><td>无（必传）</td></tr><tr><td><code>onRefresh</code></td><td><code>VoidCallback?</code></td><td>下拉刷新回调</td><td><code>null</code></td></tr><tr><td><code>onLoading</code></td><td><code>VoidCallback?</code></td><td>上拉加载回调</td><td><code>null</code></td></tr><tr><td><code>child</code></td><td><code>Widget</code></td><td>包裹的子组件（如列表/瀑布流）</td><td>无（必传）</td></tr><tr><td><code>scrollDirection</code></td><td><code>Axis</code></td><td>滚动方向</td><td><code>Axis.vertical</code></td></tr><tr><td><code>physics</code></td><td><code>ScrollPhysics</code></td><td>滚动物理效果</td><td><code>ClampingScrollPhysics()</code></td></tr><tr><td><code>enableTwoLevel</code></td><td><code>bool</code></td><td>是否启用二级刷新（如下拉展开更多）</td><td><code>false</code></td></tr></tbody></table>
<h4 data-id="heading-19">3.2.2 RefreshController（核心控制器）</h4>









































<table><thead><tr><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td><code>refreshCompleted()</code></td><td>标记下拉刷新完成</td></tr><tr><td><code>refreshFailed()</code></td><td>标记下拉刷新失败</td></tr><tr><td><code>loadComplete()</code></td><td>标记上拉加载完成</td></tr><tr><td><code>loadNoData()</code></td><td>标记无更多数据</td></tr><tr><td><code>resetNoData()</code></td><td>重置无更多数据状态</td></tr><tr><td><code>dispose()</code></td><td>释放控制器资源（必写，避免内存泄漏）</td></tr><tr><td><code>requestRefresh()</code></td><td>主动触发下拉刷新</td></tr><tr><td><code>requestLoading()</code></td><td>主动触发上拉加载</td></tr></tbody></table>
<h4 data-id="heading-20">3.2.3 ClassicHeader/ClassicFooter（经典样式）</h4>



























































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>height</code></td><td><code>double</code></td><td>头部/底部高度</td><td><code>60.0</code></td></tr><tr><td><code>idleText</code></td><td><code>String</code></td><td>闲置状态文本</td><td>下拉刷新/上拉加载</td></tr><tr><td><code>refreshingText</code></td><td><code>String</code></td><td>刷新中/加载中文本</td><td>刷新中/加载中</td></tr><tr><td><code>completeText</code></td><td><code>String</code></td><td>完成状态文本</td><td>刷新完成/加载完成</td></tr><tr><td><code>failedText</code></td><td><code>String</code></td><td>失败状态文本</td><td>刷新失败/加载失败</td></tr><tr><td><code>noDataText</code></td><td><code>String</code></td><td>无更多数据文本</td><td>暂无更多数据</td></tr><tr><td><code>textStyle</code></td><td><code>TextStyle</code></td><td>文本样式</td><td>灰色 14 号字</td></tr><tr><td><code>iconSize</code></td><td><code>double</code></td><td>图标大小</td><td><code>20.0</code></td></tr></tbody></table>
<h2 data-id="heading-21">4. 完整代码</h2>
<pre><code class="hljs language-Dart" lang="Dart">
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:pull_to_refresh/pull_to_refresh.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:waterfall_flow/waterfall_flow.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">本地图片枚举</span></span>
<span class="hljs-keyword">enum</span> ImageEnum {
  banner1,
  banner2,
  banner3,
  model1,
  model2,
  model3,
  model4,
}

<span class="hljs-comment">/// <span class="markdown">为枚举扩展获取图片路径的方法</span></span>
<span class="hljs-keyword">extension</span> ImageEnumExtension <span class="hljs-keyword">on</span> ImageEnum {
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> path {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> ImageEnum.banner1:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/banner1.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.banner2:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/banner2.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.banner3:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/banner3.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model1:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model1.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model2:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model2.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model3:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model3.png'</span>;
      <span class="hljs-keyword">case</span> ImageEnum.model4:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/images/model4.png'</span>;
    }
  }
}

<span class="hljs-comment">/// <span class="markdown">瀑布流组件</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageWaterfallFlow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> ImageWaterfallFlow({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;ImageWaterfallFlow&gt; createState() =&gt; ImageWaterfallFlowState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageWaterfallFlowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ImageWaterfallFlow</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">字体样式</span></span>
  <span class="hljs-keyword">final</span> TextStyle myTxtStyle = <span class="hljs-keyword">const</span> TextStyle(
      color: Colors.white, fontSize: <span class="hljs-number">24</span>, fontWeight: FontWeight.w800);

  <span class="hljs-comment">/// <span class="markdown">模拟数据（初始数据）- 增加泛型提升类型安全</span></span>
  <span class="hljs-built_in">List</span>&lt;ImageEnum&gt; imageList = [
    ImageEnum.banner1,
    ImageEnum.banner2,
    ImageEnum.banner3,
    ImageEnum.model1,
    ImageEnum.model2,
    ImageEnum.model3,
    ImageEnum.model4,
    ImageEnum.banner1,
    ImageEnum.banner2,
    ImageEnum.banner3,
    ImageEnum.model1,
    ImageEnum.model2,
    ImageEnum.model3,
    ImageEnum.model4
  ];

  <span class="hljs-comment">/// <span class="markdown">模拟数据（加载更多使用）</span></span>
  <span class="hljs-built_in">List</span>&lt;ImageEnum&gt; moreList = [ImageEnum.banner1, ImageEnum.banner2, ImageEnum.banner3];

  <span class="hljs-comment">/// <span class="markdown">上拉下拉控制器</span></span>
  <span class="hljs-keyword">final</span> RefreshController myRefreshController = RefreshController();

  <span class="hljs-comment">/// <span class="markdown">刷新</span></span>
  <span class="hljs-keyword">void</span> onRefresh() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">1000</span>));
    <span class="hljs-comment">// 模拟刷新：恢复初始数据</span>
    setState(() {
      imageList = [
        ImageEnum.banner1,
        ImageEnum.banner2,
        ImageEnum.banner3,
        ImageEnum.model1,
        ImageEnum.model2,
        ImageEnum.model3,
        ImageEnum.model4,
        ImageEnum.banner1,
        ImageEnum.banner2,
        ImageEnum.banner3,
        ImageEnum.model1,
        ImageEnum.model2,
        ImageEnum.model3,
        ImageEnum.model4
      ];
    });
    myRefreshController.refreshCompleted();
    myRefreshController.resetNoData(); <span class="hljs-comment">// 重置无更多数据状态</span>
  }

  <span class="hljs-comment">/// <span class="markdown">加载更多</span></span>
  <span class="hljs-keyword">void</span> onLoadMore() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">1000</span>));
    <span class="hljs-comment">// 模拟：数据超过30条时标记无更多数据</span>
    <span class="hljs-keyword">if</span> (imageList.length &gt;= <span class="hljs-number">30</span>) {
      myRefreshController.loadNoData();
    } <span class="hljs-keyword">else</span> {
      imageList.addAll(moreList);
      <span class="hljs-keyword">if</span> (mounted) {
        setState(() {});
      }
      myRefreshController.loadComplete();
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    myRefreshController.dispose(); <span class="hljs-comment">// 释放控制器资源</span>
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-comment">/// <span class="markdown">布局</span></span>
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
        backgroundColor: Colors.black,
        body: SafeArea(
            child: SizedBox(
                width: MediaQuery.of(context).size.width,
                height: MediaQuery.of(context).size.height,
                child: listWidget())));
  }

  <span class="hljs-comment">/// <span class="markdown">列表</span></span>
  Widget listWidget() {
    <span class="hljs-keyword">return</span> SmartRefresher(
      enablePullDown: <span class="hljs-keyword">true</span>,
      enablePullUp: <span class="hljs-keyword">true</span>,
      header: <span class="hljs-keyword">const</span> ClassicHeader(),
      footer: <span class="hljs-keyword">const</span> ClassicFooter(),
      controller: myRefreshController,
      onRefresh: onRefresh,
      onLoading: onLoadMore,
      child: WaterfallFlow.builder(
        padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">10</span>),
        physics: <span class="hljs-keyword">const</span> BouncingScrollPhysics(),
        gridDelegate: SliverWaterfallFlowDelegateWithFixedCrossAxisCount(
          crossAxisCount: <span class="hljs-number">2</span>,
          crossAxisSpacing: <span class="hljs-number">20</span>,
          mainAxisSpacing: <span class="hljs-number">20</span>,
          viewportBuilder: (<span class="hljs-built_in">int</span> index1, <span class="hljs-built_in">int</span> index2) {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">'变化：<span class="hljs-subst">$index1</span>-<span class="hljs-subst">$index2</span>'</span>);
          },
          <span class="hljs-comment">// 修正最后一个子项的判断逻辑</span>
          lastChildLayoutTypeBuilder: (index) =&gt; index == imageList.length - <span class="hljs-number">1</span>
              ? LastChildLayoutType.fullCrossAxisExtent
              : LastChildLayoutType.none,
        ),
        itemCount: imageList.length,
        itemBuilder: (BuildContext context, <span class="hljs-built_in">int</span> index) {
          <span class="hljs-keyword">return</span> Container(
            color: Colors.white,
            height: (index + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> ? <span class="hljs-number">100</span> : <span class="hljs-number">200</span>,
            child: Container(
                alignment: Alignment.center,
                decoration: BoxDecoration(
                    color: Colors.blue.shade300,
                    image: DecorationImage(
                      image: AssetImage(imageList[index].path),
                      fit: BoxFit.cover,
                    )),
                child: Text(<span class="hljs-string">'第<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>张'</span>, style: myTxtStyle)),
          );
        },
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-22">5. 常见问题 &amp; 解决方案</h2>
<ol>
<li>
<p><strong>图片不显示</strong></p>
<ul>
<li>
<p>检查 <code>pubspec.yaml</code> 中 <code>assets</code> 配置路径是否与实际图片存放路径一致。</p>
</li>
<li>
<p>执行 <code>flutter clean</code> 清理缓存后，重新运行项目。</p>
</li>
<li>
<p>确认枚举扩展方法 <code>path</code> 返回的路径正确。</p>
</li>
</ul>
</li>
<li>
<p><strong>加载更多无响应</strong></p>
<ul>
<li>
<p>确认 <code>SmartRefresher</code> 的 <code>enablePullUp</code> 属性设置为 <code>true</code>。</p>
</li>
<li>
<p>检查 <code>RefreshController</code> 是否正确关联到 <code>SmartRefresher</code>。</p>
</li>
<li>
<p>确保 <code>onLoading</code> 回调方法已正确绑定。</p>
</li>
</ul>
</li>
<li>
<p><strong>瀑布流布局错乱</strong></p>
<ul>
<li>
<p>避免子项高度差异过大，可根据实际需求调整高度规则。</p>
</li>
<li>
<p>检查 <code>crossAxisCount</code>、<code>crossAxisSpacing</code> 等参数配置是否冲突。</p>
</li>
<li>
<p>确认 <code>lastChildLayoutTypeBuilder</code> 的索引判断逻辑正确。</p>
</li>
</ul>
</li>
<li>
<p><strong>内存泄漏</strong></p>
<ul>
<li>
<p>务必在 <code>dispose</code> 方法中调用 <code>myRefreshController.dispose()</code> 释放控制器。</p>
</li>
<li>
<p>避免在异步操作中未判断 <code>mounted</code> 就调用 <code>setState</code>。</p>
</li>
</ul>
</li>
</ol>
<h2 data-id="heading-23">6. 总结</h2>
<p>通过 <code>waterfall_flow</code> 和 <code>pull_to_refresh</code> 两个第三方库，我们快速实现了 Flutter 瀑布流布局，并集成了下拉刷新和上拉加载更多功能。</p>
<p>该方案可直接应用于图片列表、商品展示等常见业务场景，也可根据实际需求扩展子项点击、图片懒加载、自定义刷新样式等功能。</p>
<p>希望这篇文章能帮助你理解并在自己的 Flutter 项目中运用类似的功能。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7583910637958807571" target="_blank" title="https://juejin.cn/post/7583910637958807571">flutter使用package_info_plus库获取应用信息的教程</a></li>
<li><a href="https://juejin.cn/post/7588680081327259690" target="_blank" title="https://juejin.cn/post/7588680081327259690">Flutter下拉刷新上拉加载侧拉刷新插件：easy_refresh全面使用指南</a></li>
<li><a href="https://juejin.cn/post/7583226204036513833" target="_blank" title="https://juejin.cn/post/7583226204036513833">flutter-使用EventBus实现组件间数据通信</a></li>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代 CSS 颜色使用指南进阶篇]]></title>    <link>https://juejin.cn/post/7596306552220958735</link>    <guid>https://juejin.cn/post/7596306552220958735</guid>    <pubDate>2026-01-19T07:10:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596306552220958735" data-draft-id="7596670644285784064" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 现代 CSS 颜色使用指南进阶篇"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-19T07:10:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             现代 CSS 颜色使用指南进阶篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T07:10:12.000Z" title="Mon Jan 19 2026 07:10:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上篇文章，我们学会了现代 CSS 颜色的基础用法。</p>
<p>本篇我们进入更高级的领域：<strong>如何像设计师一样操纵颜色</strong>。</p>
<p>CSS 现在能做的事情，甚至比设计软件还要强大！</p>
<h2 data-id="heading-0">1. 操纵颜色</h2>
<h3 data-id="heading-1">1.1. 基础回顾</h3>
<p>先复习一下上篇文章的内容：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--primary</span>: <span class="hljs-number">#ff0000</span>;
}

<span class="hljs-selector-class">.primary-bg-50-opacity</span> {
  <span class="hljs-comment">/* h s l 不是字母，是变量！ */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--primary) h s l / <span class="hljs-number">0.5</span>);
}
</code></pre>
<p><strong>注意：</strong> <code>h s l</code> 这三个字母其实是变量，分别存储了色相（hue）、饱和度（saturation）、亮度（lightness）的值。</p>
<p>我们可以替换这些变量，比如给绿色（#00ff00）加点蓝：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础绿色没有蓝色成分 */</span>
<span class="hljs-selector-class">.green-with-a-touch-of-blue</span> {
  <span class="hljs-comment">/* 在蓝色通道加 25 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(from <span class="hljs-number">#00ff00</span> r g <span class="hljs-built_in">calc</span>(b + <span class="hljs-number">25</span>));
}
</code></pre>
<p>这就像调色板，在基础的绿色中，添加点“蓝色颜料”。</p>
<h3 data-id="heading-2">1.2. 实用技巧</h3>
<p>掌握了基础用法，我们就可以讲些实际开发中会用到的场景了。</p>
<ol>
<li><strong>创建互补色（色轮对面的颜色）：</strong></li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#2563eb</span>; <span class="hljs-comment">/* 蓝色 */</span>

  <span class="hljs-comment">/* 色相加 180 度，跳到对面 */</span>
  <span class="hljs-attr">--color-secondary</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--color-primary) <span class="hljs-built_in">calc</span>(h + <span class="hljs-number">180</span>) s l);
}
</code></pre>
<ol start="2">
<li><strong>创建三色组合：</strong></li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#2563eb</span>;

  <span class="hljs-comment">/* 色轮上均匀分布 120 度 */</span>
  <span class="hljs-attr">--color-secondary</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--color-primary) <span class="hljs-built_in">calc</span>(h + <span class="hljs-number">120</span>) s l);
  <span class="hljs-attr">--color-tertiary</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--color-primary) <span class="hljs-built_in">calc</span>(h - <span class="hljs-number">120</span>) s l);
}
</code></pre>
<p>就像时钟：12 点是主色，4 点和 8 点是配色，完美对称！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpiccalil.li%2Fblog%2Fa-pragmatic-guide-to-modern-css-colours-part-two%2F" target="_blank" title="https://piccalil.li/blog/a-pragmatic-guide-to-modern-css-colours-part-two/" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff8b2aadb85249bbafc58360e55dd620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=a4ATVCGmQ%2FHzwtqS8yeIpIAyXZE%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li><strong>相对调整</strong></li>
</ol>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--color-primary-base</span>: <span class="hljs-number">#2563eb</span>;

  <span class="hljs-comment">/* 比基础色亮 25% */</span>
  <span class="hljs-attr">--color-primary-lighter</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--color-primary-base) h s <span class="hljs-built_in">calc</span>(l + <span class="hljs-number">25</span>));

  <span class="hljs-comment">/* 比基础色暗 25% */</span>
  <span class="hljs-attr">--color-primary-darker</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--color-primary-base) h s <span class="hljs-built_in">calc</span>(l - <span class="hljs-number">25</span>));
}
</code></pre>
<p>使用这种方法，不管基础色是多亮，都会相对地变亮或变暗。</p>
<p>这就像调空调，“比现在低 5 度”比“设定到 20 度”更灵活。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fkevinpowell%2Fpen%2FvELwYoO" target="_blank" title="https://codepen.io/kevinpowell/pen/vELwYoO" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d60ceeb60b41ce98260708c4340110~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=u6vyTg5Z6%2B7tw3ZHuUQmyVxNWlg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">2. 暗黑模式的层次感</h2>
<p>现在我们能相对调整颜色了，可是究竟有什么用呢？</p>
<p>让我给你举个具体的使用场景。</p>
<p>在浅色主题中，我们可以根据阴影来区分层次：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a120b83ce4a442b3a441d74c12f43f98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=lbN3fdpYOov58Ay4A8GbB6pz1Tg%3D" alt="" loading="lazy"/></p>
<p>但在深色背景下，阴影的效果并不明显。</p>
<p>因此在深色主题中，我们希望每个层次的颜色略微变浅。</p>
<p>借助上篇讲过的 <code>light-dark()</code>和相对颜色调整，我们便可以实现：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--surface-base-light</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">240</span> <span class="hljs-number">67%</span> <span class="hljs-number">97%</span>);
  <span class="hljs-attr">--surface-base-dark</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">252</span> <span class="hljs-number">21%</span> <span class="hljs-number">9%</span>);
}

<span class="hljs-comment">/* 第一层：基础层 */</span>
<span class="hljs-selector-class">.surface-1</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-built_in">var</span>(--surface-base-light), <span class="hljs-built_in">var</span>(--surface-base-dark));
}

<span class="hljs-comment">/* 第二层：稍微亮一点 */</span>
<span class="hljs-selector-class">.surface-2</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-built_in">var</span>(--surface-base-light), <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--surface-base-dark) h s <span class="hljs-built_in">calc</span>(l + <span class="hljs-number">4</span>)));
}

<span class="hljs-comment">/* 第三层：再亮一点 */</span>
<span class="hljs-selector-class">.surface-3</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-built_in">var</span>(--surface-base-light), <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--surface-base-dark) h s <span class="hljs-built_in">calc</span>(l + <span class="hljs-number">8</span>)));
}
</code></pre>
<p>想象一下深海：越接近水面，光线越充足。暗色模式的层次就是这个原理。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fkevinpowell%2Fpen%2FVYeOKQj" target="_blank" title="https://codepen.io/kevinpowell/pen/VYeOKQj" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54572c580a63475c9215c9237d0100a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=YR7jxlmdk0XZlGpzJQb%2BKbx737g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. 完整配色方案</h2>
<p>设计师创建配色方案时，不只是简单地调整亮度，还会<strong>同时微调色相和饱和度</strong>，比如</p>
<ul>
<li><strong>变亮时</strong>：饱和度增加，色相向冷色调偏移</li>
<li><strong>变暗时</strong>：饱和度降低</li>
</ul>
<p>这便可以通过 CSS 来实现：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--primary-base</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">221</span> <span class="hljs-number">83%</span> <span class="hljs-number">50%</span>);

  <span class="hljs-comment">/* 400: 亮度60%，色相-3度，饱和度+5% */</span>
  <span class="hljs-attr">--primary-400</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--primary-base) <span class="hljs-built_in">calc</span>(h - <span class="hljs-number">3</span>) <span class="hljs-built_in">calc</span>(s + <span class="hljs-number">5</span>) <span class="hljs-number">60%</span>);

  <span class="hljs-comment">/* 300: 亮度70%，色相-6度，饱和度+10% */</span>
  <span class="hljs-attr">--primary-300</span>: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--primary-base) <span class="hljs-built_in">calc</span>(h - <span class="hljs-number">6</span>) <span class="hljs-built_in">calc</span>(s + <span class="hljs-number">10</span>) <span class="hljs-number">70%</span>);

  <span class="hljs-comment">/* 以此类推... */</span>
}
</code></pre>
<p><strong>为什么要这么麻烦呢？</strong></p>
<p>因为只调亮度会让浅色看起来“失去活力”。</p>
<p>就像拍照：自动模式能拍，但手动调整曝光、对比度、色温会更漂亮。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fkevinpowell%2Fpen%2FJoYaoGW%2F5407077415578757498bf930eb55f8d4" target="_blank" title="https://codepen.io/kevinpowell/pen/JoYaoGW/5407077415578757498bf930eb55f8d4" ref="nofollow noopener noreferrer">为了让你更直观地看到变化</a>：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a4e860772914fe4b15db0cf627ca5a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=j5wqj1%2B11lvTneziSWKgj3T1auI%3D" alt="" loading="lazy"/></p>
<p>第一排是都调整的版本，第二排是未调整色相和饱和度的版本。</p>
<p>最明显的区别在于 100、200 和 300 这几个色块，当仅调整亮度值时，颜色看起来失去了一些鲜艳度。</p>
<h2 data-id="heading-5">4. OKLCH 更科学的配色方式</h2>
<h3 data-id="heading-6">4.1. 问题：HSL</h3>
<p>HSL 虽然很棒，但在使用时，你会发现一些问题，让我们看个例子：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.green-bg</span> {
  <span class="hljs-comment">/* 饱和度 100%，亮度 50% */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">100</span> <span class="hljs-number">100%</span> <span class="hljs-number">50%</span>);
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-selector-class">.blue-bg</span> {
  <span class="hljs-comment">/* 同样饱和度 100%，亮度 50% */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">220</span> <span class="hljs-number">100%</span> <span class="hljs-number">50%</span>);
  <span class="hljs-attribute">color</span>: white;
}
</code></pre>
<p>你会发现，色和蓝色的饱和度、亮度虽然完全一样，但视觉效果完全不同：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b3a1cdba7242129861d8a29be20a82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=8BM%2FHivqy68ivNAzzEYOzEQPmv4%3D" alt="" loading="lazy"/></p>
<p>明显蓝色背景上的文字清晰易读，对比度超过 5，而绿色背景上的文字却很难看清，对比度仅略高于 1。</p>
<p>之所以会这样，是因为 HSL 的“亮度”不符合人眼感知。</p>
<p>人眼对绿色比蓝色更敏感，所以同样的“50%亮度”，绿色看起来更亮。</p>
<h3 data-id="heading-7">4.2. 解决：OKLCH</h3>
<p>而这就是 oklch() 的优势。</p>
<p>OKLCH 是基于<strong>感知亮度</strong>设计的：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.consistent-green</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">oklch</span>(<span class="hljs-number">0.54</span> <span class="hljs-number">0.23</span> <span class="hljs-number">261</span>);
}

<span class="hljs-selector-class">.consistent-blue</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">oklch</span>(<span class="hljs-number">0.54</span> <span class="hljs-number">0.23</span> <span class="hljs-number">146</span>);
}
</code></pre>
<p>使用效果如下：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc1768a9da944df8a03c36ddfc04f091~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=v1DcZ59EfWNip%2BGRjlo1qS6Q0tM%3D" alt="" loading="lazy"/></p>
<p>现在不管什么颜色，亮度值相同，人眼看起来的亮度就相同！</p>
<h3 data-id="heading-8">4.3. 讲解：OKLCH 的三个参数</h3>
<p>在 LCH 颜色模型中：</p>
<p>第一个值是亮度（Lightness），取值范围为 0 到 1。它的计算方式与 HSL 略有不同，因为它基于感知亮度，但概念相同，即 0 是黑色，1 是白色。</p>
<p>第二个值是色度（Chroma），类似于饱和度，0 是灰色，越大越鲜艳，但最大值不固定，取决于亮度和色相（这是 OKLCH 最麻烦的地方）</p>
<p>第三个值是色相（Hue），和 HSL 一样是色轮，0 到 360 度，区别是 0 度是洋红色（HSL 里 0 度是红色）</p>
<p>OKLCH 的尴尬之处就在于色度（Chroma）的最大值会变：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 某些色相+亮度组合，0.4 已经是极限 */</span>
<span class="hljs-selector-class">.max-chroma-1</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">oklch</span>(<span class="hljs-number">0.6</span> <span class="hljs-number">0.4</span> <span class="hljs-number">120</span>);
}

<span class="hljs-comment">/* 但另一些组合，0.4 可能太高或太低 */</span>
<span class="hljs-selector-class">.max-chroma-2</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">oklch</span>(<span class="hljs-number">0.8</span> <span class="hljs-number">0.4</span> <span class="hljs-number">200</span>); <span class="hljs-comment">/* 可能超出范围 */</span>
}
</code></pre>
<p>就像不同口味的饮料，有的最浓是“3 勺糖”，有的最浓是“5 勺糖”，没有统一标准。</p>
<h3 data-id="heading-9">4.4. 实用技巧：结合相对颜色</h3>
<p>虽然直接写 OKLCH 值很麻烦，但我们可以用 HSL 定义基础色，然后用 OKLCH 保持一致性：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.toast</span> {
  <span class="hljs-attr">--base-color</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">225</span>, <span class="hljs-number">87%</span>, <span class="hljs-number">56%</span>); <span class="hljs-comment">/* 用熟悉的 HSL 定义 */</span>
}

<span class="hljs-selector-attr">[data-toast=<span class="hljs-string">"info"</span>]</span> {
  <span class="hljs-comment">/* 只改变色相，保持亮度和色度 */</span>
  <span class="hljs-attr">--toast-color</span>: <span class="hljs-built_in">oklch</span>(from <span class="hljs-built_in">var</span>(--base-color) l c <span class="hljs-number">275</span>);
}

<span class="hljs-selector-attr">[data-toast=<span class="hljs-string">"warning"</span>]</span> {
  <span class="hljs-attr">--toast-color</span>: <span class="hljs-built_in">oklch</span>(from <span class="hljs-built_in">var</span>(--base-color) l c <span class="hljs-number">80</span>);
}

<span class="hljs-selector-attr">[data-toast=<span class="hljs-string">"error"</span>]</span> {
  <span class="hljs-attr">--toast-color</span>: <span class="hljs-built_in">oklch</span>(from <span class="hljs-built_in">var</span>(--base-color) l c <span class="hljs-number">35</span>);
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fkevinpowell%2Fpen%2FwBMbozY" target="_blank" title="https://codepen.io/kevinpowell/pen/wBMbozY" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/996f7e9f14cd4fefb52678870dc2b789~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=rL6mPu15DNkoJHiPM6gBGWmJV0s%3D" alt="" loading="lazy"/></p>
<p>这样做的好处在于：不同颜色的提示框，边框对比度、整体饱和度感觉都很一致。</p>
<h2 data-id="heading-10">5. 混合颜色</h2>
<p>有的时候，我们可能需要混合两种颜色：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.purple</span> {
  <span class="hljs-comment">/* 红色和蓝色各占 50% */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">color-mix</span>(in srgb, red, blue);
}
</code></pre>
<p>就像调颜料：红色颜料加蓝色颜料，得到紫色。</p>
<p>目前必须定义一个颜色空间，所以必须写 <code>in srgb</code> 或 <code>in oklab</code> 等，未来会默认用 <code>oklab</code>。</p>
<p>不同颜色空间混出来的结果不一样：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6eb4b367d9e4bd1876cafed079e94a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=jEWW1FW6JJiivUVr9WXSzBVIdBc%3D" alt="" loading="lazy"/></p>
<p>一般推荐：</p>
<ol>
<li>先试 <code>oklab</code></li>
<li>再试 <code>oklch</code></li>
<li>不满意就换其他的</li>
</ol>
<h3 data-id="heading-11">5.1. 控制混合比例</h3>
<p>默认情况下，使用该功能时 <code>color-mix()</code>，每种颜色将使用 50% 的强度。</p>
<p>当然，我们也可以控制特定颜色的具体强度。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 90% 红色 + 10% 蓝色 */</span>
<span class="hljs-selector-class">.red-with-a-touch-of-blue</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">color-mix</span>(in oklab, red <span class="hljs-number">90%</span>, blue);
}

<span class="hljs-comment">/* 或者反过来写 */</span>
<span class="hljs-selector-class">.or-like-this</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">color-mix</span>(in oklab, red, blue <span class="hljs-number">10%</span>);
}
</code></pre>
<h3 data-id="heading-12">5.2. 创建半透明色</h3>
<p>有两种方法可以获得透明的值：</p>
<p><strong>方法一：让总量小于 100%</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 60% + 20% = 80%，所以透明度是 80% */</span>
<span class="hljs-selector-class">.semi-opaque</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">color-mix</span>(in oklab, red <span class="hljs-number">60%</span>, blue <span class="hljs-number">20%</span>);
}
</code></pre>
<p><strong>方法二：混入 transparent</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 30% 的不透明红色 */</span>
<span class="hljs-selector-class">.thirty-percent-opacity-red</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">color-mix</span>(in oklch, red <span class="hljs-number">30%</span>, transparent);
}
</code></pre>
<p>不过如果只是想降低透明度，还是用相对颜色更直接：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.better-way</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgb</span>(from red r g b / <span class="hljs-number">0.3</span>);
}
</code></pre>
<h3 data-id="heading-13">5.3. 小技巧：分段渐变</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不用手动算中间的每个颜色，color-mix 帮你搞定 */</span>
<span class="hljs-selector-class">.banded-gradient</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to right, red, <span class="hljs-built_in">color-mix</span>(in oklch, red <span class="hljs-number">75%</span>, blue), <span class="hljs-built_in">color-mix</span>(in oklch, red <span class="hljs-number">50%</span>, blue), <span class="hljs-built_in">color-mix</span>(in oklch, red <span class="hljs-number">25%</span>, blue), blue);
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fkevinpowell%2Fpen%2FVYeOvYE" target="_blank" title="https://codepen.io/kevinpowell/pen/VYeOvYE" ref="nofollow noopener noreferrer">使用效果如下：</a></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be12f4321f67495f8ef276f7a7fb0876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769411412&amp;x-signature=hc6rvG3cx7Ao9b4BdhthJvqUDyU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">6. 未来更简单</h2>
<p>重复写这些代码很烦？</p>
<p>CSS 自定义函数快来了：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 定义函数 */</span>
<span class="hljs-keyword">@function</span> --lower-opacity(--color, --opacity) {
  result: <span class="hljs-built_in">oklch</span>(from <span class="hljs-built_in">var</span>(--color) l c h / <span class="hljs-built_in">var</span>(--opacity));
}

<span class="hljs-comment">/* 使用函数 */</span>
<span class="hljs-selector-class">.lower-opacity-primary</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">--lower-opacity</span>(<span class="hljs-built_in">var</span>(--primary), <span class="hljs-number">0.5</span>);
}
</code></pre>
<p>或者定义整套色阶函数：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@function</span> --shade-<span class="hljs-number">100</span>(--color) returns &lt;<span class="hljs-attribute">color</span>&gt; {
  result: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--color) <span class="hljs-built_in">calc</span>(h - <span class="hljs-number">12</span>) <span class="hljs-built_in">calc</span>(s + <span class="hljs-number">15</span>) <span class="hljs-number">95%</span>);
}

<span class="hljs-keyword">@function</span> --shade-<span class="hljs-number">200</span>(--color) returns &lt;<span class="hljs-attribute">color</span>&gt; {
  result: <span class="hljs-built_in">hsl</span>(from <span class="hljs-built_in">var</span>(--color) <span class="hljs-built_in">calc</span>(h - <span class="hljs-number">10</span>) <span class="hljs-built_in">calc</span>(s + <span class="hljs-number">12</span>) <span class="hljs-number">85%</span>);
}
<span class="hljs-comment">/* 以此类推... */</span>

<span class="hljs-selector-class">.call-to-action</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">--shade-200</span>(<span class="hljs-built_in">var</span>(--accent));
}

<span class="hljs-selector-class">.hero</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">--shade-800</span>(<span class="hljs-built_in">var</span>(--primary));
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">--shade-100</span>(<span class="hljs-built_in">var</span>(--primary));
}
</code></pre>
<p>一次定义，到处使用，完美！</p>
<h2 data-id="heading-15">7. 总结</h2>
<p>最后总结下本篇文章的重点：</p>
<ol>
<li><strong>用 calc() 操纵颜色</strong> - 数学生成配色方案</li>
<li><strong>OKLCH</strong> - 基于人眼感知的颜色系统，不同色相亮度一致</li>
<li><strong>color-mix()</strong> - 像调颜料一样混合颜色</li>
</ol>
<p>在实际使用时：</p>
<ul>
<li><strong>简单需求</strong>：相对颜色 + HSL</li>
<li><strong>需要视觉一致性</strong>：OKLCH</li>
<li><strong>需要混合颜色</strong>：color-mix()</li>
<li><strong>暗黑模式层次</strong>：light-dark() + 相对颜色</li>
</ul>
<p>本篇整理自<a href="https://link.juejin.cn?target=https%3A%2F%2Fpiccalil.li%2Fblog%2Fa-pragmatic-guide-to-modern-css-colours-part-two%2F" target="_blank" title="https://piccalil.li/blog/a-pragmatic-guide-to-modern-css-colours-part-two/" ref="nofollow noopener noreferrer">《A pragmatic guide to modern CSS colours - part two》</a>，希望能帮助到你。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙ArkUI组件封装实战：3招告别重复代码]]></title>    <link>https://juejin.cn/post/7596488155303493651</link>    <guid>https://juejin.cn/post/7596488155303493651</guid>    <pubDate>2026-01-19T03:43:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596488155303493651" data-draft-id="7596342523968045065" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙ArkUI组件封装实战：3招告别重复代码"/> <meta itemprop="keywords" content="HarmonyOS,前端,前端工程化"/> <meta itemprop="datePublished" content="2026-01-19T03:43:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="纯爱掌门人"/> <meta itemprop="url" content="https://juejin.cn/user/2849548342403454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙ArkUI组件封装实战：3招告别重复代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2849548342403454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    纯爱掌门人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T03:43:38.000Z" title="Mon Jan 19 2026 03:43:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    73
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><p>做鸿蒙ArkUI开发的兄弟姐妹们，是不是总被重复代码折磨？登录页的确认按钮、购物页的结算按钮，样式一模一样还要写两遍；图片加文字的布局，换个页面又得重新拼一遍——改样式时逐个文件找，维护起来头都大了！其实只要学会组件封装，把重复代码“打包”起来，下次直接拿过来用，效率直接翻倍，还方便团队协作。今天就手把手教你三种核心封装方式，新手也能轻松拿捏！</p>
<h2 data-id="heading-0">一、先搞懂：组件封装到底好在哪？</h2>
<p>简单说，封装就是把相同或相似的UI样式、布局、逻辑“装起来”，核心好处就三个：</p>
<ol>
<li>少写重复代码：写一次能用N次，不用复制粘贴</li>
<li>维护超方便：要改样式/逻辑，只改封装组件，所有用到的地方自动同步</li>
<li>团队不吵架：统一组件风格，不用纠结“你写的按钮和我不一样”</li>
</ol>
<p>鸿蒙里最常用的封装场景就三种：只复用样式、复用样式+布局+逻辑、批量管理多个组件，咱们一个个说清楚。</p>
<h2 data-id="heading-1">二、第一种：组件公共样式封装（只复用样式）</h2>
<h3 data-id="heading-2">适用场景</h3>
<p>如果只是多个组件要共用一套样式，比如所有确认按钮都是胶囊形、一样的大小和颜色，就用这种方式。比如登录页的“登录”按钮和购物页的“结算”按钮，功能不同但样式一致，直接封装样式就行。</p>
<h3 data-id="heading-3">核心思路</h3>
<p>用系统提供的<code>AttributeModifier</code>接口，把公共样式写在一个类里，之后哪个组件要用，直接套用这个类就行。</p>
<h3 data-id="heading-4">手把手操作</h3>
<h4 data-id="heading-5">第一步：封装公共样式类</h4>
<p>先创建一个类，实现<code>AttributeModifier</code>接口，把按钮的默认态、按压态样式都写进去：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 封装按钮的公共样式</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyButtonModifier</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AttributeModifier</span>&lt;<span class="hljs-title class_">ButtonAttribute</span>&gt; {
  <span class="hljs-comment">// 默认是普通按钮，后续可修改</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">buttonType</span>: <span class="hljs-title class_">ButtonType</span> = <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Normal</span>;

  <span class="hljs-comment">// 设置按钮类型（比如胶囊形、普通形）</span>
  <span class="hljs-title function_">type</span>(<span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>): <span class="hljs-title class_">MyButtonModifier</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buttonType</span> = <span class="hljs-keyword">type</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 按钮默认状态的样式</span>
  <span class="hljs-title function_">applyNormalAttribute</span>(<span class="hljs-attr">instance</span>: <span class="hljs-title class_">ButtonAttribute</span>): <span class="hljs-built_in">void</span> {
    instance.<span class="hljs-title function_">type</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">buttonType</span>); <span class="hljs-comment">// 按钮类型</span>
    instance.<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>); <span class="hljs-comment">// 宽度</span>
    instance.<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>); <span class="hljs-comment">// 高度</span>
    instance.<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>); <span class="hljs-comment">// 字体大小</span>
    instance.<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#0A59F7'</span>); <span class="hljs-comment">// 字体颜色</span>
    instance.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D000000'</span>); <span class="hljs-comment">// 背景色</span>
  }

  <span class="hljs-comment">// 按钮按压状态的样式</span>
  <span class="hljs-title function_">applyPressedAttribute</span>(<span class="hljs-attr">instance</span>: <span class="hljs-title class_">ButtonAttribute</span>): <span class="hljs-built_in">void</span> {
    instance.<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#0A59F7'</span>);
    instance.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#26000000'</span>); <span class="hljs-comment">// 按压时背景色加深</span>
  }
}
</code></pre>
<h4 data-id="heading-6">第二步：使用封装好的样式</h4>
<p>在需要的页面里，创建样式实例，通过<code>attributeModifier()</code>方法应用到按钮上：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">AttributeStylePage</span> {
  <span class="hljs-comment">// 创建样式实例，设置为胶囊形按钮</span>
  modifier = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyButtonModifier</span>().<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>);

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">NavDestination</span>() {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-comment">// 直接套用封装好的样式</span>
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'确认按钮'</span>)
          .<span class="hljs-title function_">attributeModifier</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">modifier</span>)
      }
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: $r(<span class="hljs-string">'app.float.margin_top'</span>) })
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    }
    .<span class="hljs-title function_">title</span>(<span class="hljs-title function_">getResourceString</span>($r(<span class="hljs-string">'app.string.common_style_extract'</span>), <span class="hljs-variable language_">this</span>))
  }
}
</code></pre>
<h3 data-id="heading-7">小提醒</h3>
<ol>
<li>这种样式只能用在系统组件上（比如Button、Image），自定义组件暂时不支持</li>
<li>样式类可以跨文件导出，整个项目都能复用，还能灵活改参数（比如改按钮类型、颜色）</li>
</ol>
<h2 data-id="heading-8">三、第二种：自定义组件封装（样式+布局+逻辑一起复用）</h2>
<h3 data-id="heading-9">适用场景</h3>
<p>如果不仅要复用样式，连布局和逻辑都要复用，比如商品卡片（图片+名称+价格固定布局）、个人信息项（图标+文字+箭头），就适合封装成自定义组件。而且还能让使用方灵活修改部分属性，比如图片大小、文字内容。</p>
<h3 data-id="heading-10">核心思路</h3>
<p>用<code>@Component</code>装饰器把组件“打包”，不变的部分（比如图片和文字的排列方式）写在内部，可变的部分（比如图片地址、大小）用参数暴露出去，让使用方按需配置。</p>
<h3 data-id="heading-11">手把手操作</h3>
<p>咱们以“图片+文字”的组合组件为例：</p>
<h4 data-id="heading-12">第一步：先封装子组件的样式（可选）</h4>
<p>分别给Image和Text组件写样式类，方便后续修改：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 图片组件的样式封装</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomImageModifier</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AttributeModifier</span>&lt;<span class="hljs-title class_">ImageAttribute</span>&gt; {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">imageWidth</span>: <span class="hljs-title class_">Length</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">imageHeight</span>: <span class="hljs-title class_">Length</span> = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 初始化图片大小</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">width: Length, height: Length</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span> = width;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span> = height;
  }

  <span class="hljs-comment">// 提供修改宽高的方法</span>
  <span class="hljs-title function_">width</span>(<span class="hljs-params">width: Length</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span> = width;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">height</span>(<span class="hljs-params">height: Length</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span> = height;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 应用图片样式</span>
  <span class="hljs-title function_">applyNormalAttribute</span>(<span class="hljs-attr">instance</span>: <span class="hljs-title class_">ImageAttribute</span>): <span class="hljs-built_in">void</span> {
    instance.<span class="hljs-title function_">width</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageWidth</span>);
    instance.<span class="hljs-title function_">height</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageHeight</span>);
    instance.<span class="hljs-title function_">borderRadius</span>($r(<span class="hljs-string">'app.float.border_radius'</span>)); <span class="hljs-comment">// 圆角</span>
  }
}

<span class="hljs-comment">// 文字组件的样式封装</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTextModifier</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AttributeModifier</span>&lt;<span class="hljs-title class_">TextAttribute</span>&gt; {
  <span class="hljs-title function_">applyNormalAttribute</span>(<span class="hljs-attr">instance</span>: <span class="hljs-title class_">TextAttribute</span>): <span class="hljs-built_in">void</span> {
    instance.<span class="hljs-title function_">fontSize</span>($r(<span class="hljs-string">'app.float.font_size_l'</span>)); <span class="hljs-comment">// 字体大小</span>
  }
}
</code></pre>
<h4 data-id="heading-13">第二步：封装自定义组件</h4>
<p>把图片和文字的布局、点击事件都封装进去，暴露可变参数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">CustomImageText</span> {
  <span class="hljs-comment">// 图片样式（默认100x100）</span>
  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">imageAttribute</span>: <span class="hljs-title class_">AttributeModifier</span>&lt;<span class="hljs-title class_">ImageAttribute</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomImageModifier</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
  <span class="hljs-comment">// 文字样式（默认样式）</span>
  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">textAttribute</span>: <span class="hljs-title class_">AttributeModifier</span>&lt;<span class="hljs-title class_">TextAttribute</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomTextModifier</span>();
  <span class="hljs-comment">// 图片资源（必须由使用方传入）</span>
  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">imageSrc</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-title class_">ResourceStr</span> | <span class="hljs-title class_">DrawableDescriptor</span>;
  <span class="hljs-comment">// 文字内容（必须由使用方传入）</span>
  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 点击事件（可选，使用方按需传入）</span>
  onClickEvent?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 固定布局：图片和文字纵向排列</span>
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">12</span> }) {
      <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageSrc</span>)
        .<span class="hljs-title function_">attributeModifier</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imageAttribute</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>)
        .<span class="hljs-title function_">attributeModifier</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textAttribute</span>)
    }
    <span class="hljs-comment">// 点击事件触发</span>
    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onClickEvent</span> !== <span class="hljs-literal">undefined</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onClickEvent</span>();
      }
    })
  }
}
</code></pre>
<h4 data-id="heading-14">第三步：使用自定义组件</h4>
<p>按需传入图片资源、文字、样式和点击事件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">CommonComponent</span> {
  <span class="hljs-comment">// 自定义图片大小为330x330</span>
  <span class="hljs-attr">imageAttribute</span>: <span class="hljs-title class_">CustomImageModifier</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomImageModifier</span>(<span class="hljs-number">330</span>, <span class="hljs-number">330</span>);

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">NavDestination</span>() {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">CustomImageText</span>({
          <span class="hljs-attr">imageAttribute</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">imageAttribute</span>, <span class="hljs-comment">// 传入自定义图片大小</span>
          <span class="hljs-attr">imageSrc</span>: $r(<span class="hljs-string">'app.media.image'</span>), <span class="hljs-comment">// 图片资源</span>
          <span class="hljs-attr">text</span>: <span class="hljs-string">'Scenery'</span>, <span class="hljs-comment">// 文字内容</span>
          <span class="hljs-attr">onClickEvent</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 点击组件显示提示</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Clicked'</span> })
          }
        })
      }
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: $r(<span class="hljs-string">'app.float.margin_top'</span>) })
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    }
    .<span class="hljs-title function_">title</span>(<span class="hljs-title function_">getResourceString</span>($r(<span class="hljs-string">'app.string.common'</span>), <span class="hljs-variable language_">this</span>))
  }
}
</code></pre>
<h2 data-id="heading-15">四、第三种：组件工厂类封装（批量管理多个组件）</h2>
<h3 data-id="heading-16">适用场景</h3>
<p>如果项目里有很多零散组件（比如单选框、复选框、输入框），想统一管理，让业务团队通过组件名直接获取使用，就用这种方式。比如传入“Radio”拿单选框，传入“Checkbox”拿复选框，不用逐个导入。</p>
<h3 data-id="heading-17">核心思路</h3>
<p>用<code>@Builder</code>装饰器定义组件模板，再用<code>wrapBuilder</code>函数包装，存入一个Map（键是组件名，值是组件对象），最后导出这个“组件工厂”，使用方按名字取就行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24876b8b43c14e3ca0fc597fbe98d558~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qv54ix5o6M6Zeo5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769489938&amp;x-signature=KrQ%2BeglUmj1kXK3yHbAGmJLUQvA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-18">手把手操作</h3>
<h4 data-id="heading-19">第一步：定义组件模板</h4>
<p>用<code>@Builder</code>写全局的组件模板（比如单选框、复选框）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 单选框组件模板</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myRadio</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.radio'</span>))
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.mask_secondary'</span>))
  <span class="hljs-comment">// 男选项</span>
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">Radio</span>({ <span class="hljs-attr">value</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">group</span>: <span class="hljs-string">'radioGroup'</span> })
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: $r(<span class="hljs-string">'app.float.margin_right'</span>) })
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">'man'</span>)
  }
  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  <span class="hljs-comment">// 女选项</span>
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">Radio</span>({ <span class="hljs-attr">value</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">group</span>: <span class="hljs-string">'radioGroup'</span> })
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: $r(<span class="hljs-string">'app.float.margin_right'</span>) })
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">'woman'</span>)
  }
  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
}

<span class="hljs-comment">// 复选框组件模板</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myCheckBox</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.checkbox'</span>))
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">fontColor</span>($r(<span class="hljs-string">'sys.color.mask_secondary'</span>))
  <span class="hljs-comment">// 全选</span>
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">CheckboxGroup</span>({ <span class="hljs-attr">group</span>: <span class="hljs-string">'checkboxGroup'</span> })
      .<span class="hljs-title function_">checkboxShape</span>(<span class="hljs-title class_">CheckBoxShape</span>.<span class="hljs-property">ROUNDED_SQUARE</span>)
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">'all'</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">left</span>: $r(<span class="hljs-string">'app.float.margin_right'</span>) })
  }
  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  <span class="hljs-comment">// 选项1</span>
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">Checkbox</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">group</span>: <span class="hljs-string">'checkboxGroup'</span> })
      .<span class="hljs-title function_">shape</span>(<span class="hljs-title class_">CheckBoxShape</span>.<span class="hljs-property">ROUNDED_SQUARE</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: $r(<span class="hljs-string">'app.float.margin_right'</span>) })
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">'text1'</span>)
  }
  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  <span class="hljs-comment">// 选项2</span>
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">Checkbox</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">group</span>: <span class="hljs-string">'checkboxGroup'</span> })
      .<span class="hljs-title function_">shape</span>(<span class="hljs-title class_">CheckBoxShape</span>.<span class="hljs-property">ROUNDED_SQUARE</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">right</span>: $r(<span class="hljs-string">'app.float.margin_right'</span>) })
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">'text2'</span>)
  }
  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
}
</code></pre>
<h4 data-id="heading-20">第二步：创建组件工厂</h4>
<p>把组件模板包装后存入Map，再导出工厂：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义组件工厂Map，键是组件名，值是组件对象</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">factoryMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">// 把组件存入工厂（用wrapBuilder包装@Builder方法）</span>
factoryMap.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Radio'</span>, <span class="hljs-title function_">wrapBuilder</span>(myRadio));
factoryMap.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Checkbox'</span>, <span class="hljs-title function_">wrapBuilder</span>(myCheckBox));

<span class="hljs-comment">// 导出工厂，供外部使用</span>
<span class="hljs-keyword">export</span> { factoryMap };
</code></pre>
<h4 data-id="heading-21">第三步：使用工厂里的组件</h4>
<p>导入工厂，按组件名获取并渲染：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 导入组件工厂（路径要按实际项目调整）</span>
<span class="hljs-keyword">import</span> { factoryMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'../view/FactoryMap'</span>;

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ComponentFactory</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">NavDestination</span>() {
      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">12</span> }) {
        <span class="hljs-comment">// 按名字获取单选框组件并渲染</span>
        (factoryMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">'Radio'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">WrappedBuilder</span>&lt;[]&gt;).<span class="hljs-title function_">builder</span>();
        <span class="hljs-comment">// 按名字获取复选框组件并渲染</span>
        (factoryMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">'Checkbox'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">WrappedBuilder</span>&lt;[]&gt;).<span class="hljs-title function_">builder</span>();
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">padding</span>($r(<span class="hljs-string">'app.float.padding'</span>))
    }
    .<span class="hljs-title function_">title</span>(<span class="hljs-title function_">getResourceString</span>($r(<span class="hljs-string">'app.string.factory'</span>), <span class="hljs-variable language_">this</span>))
  }
}
</code></pre>
<h3 data-id="heading-22">小提醒</h3>
<ol>
<li>只有全局的<code>@Builder</code>方法才能用<code>wrapBuilder</code>包装</li>
<li>从工厂拿的组件，只能在<code>struct</code>的<code>build</code>方法里使用</li>
</ol>
<h2 data-id="heading-23">五、封装后常见问题：直接抄作业就行！</h2>
<h3 data-id="heading-24">1. 怎么调用子组件里的方法？</h3>
<p>三种实用方法，按需选：</p>
<h4 data-id="heading-25">方法一：用Controller类（推荐）</h4>
<p>定义一个控制器，子组件把方法“交”给控制器，父组件通过控制器调用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义控制器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Controller</span> {
  action = <span class="hljs-function">() =&gt;</span> {}; <span class="hljs-comment">// 用来存子组件的方法</span>
}

<span class="hljs-comment">// 子组件</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">ChildComponent</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">bgColor</span>: <span class="hljs-title class_">ResourceColor</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>;
  <span class="hljs-attr">controller</span>: <span class="hljs-title class_">Controller</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;

  <span class="hljs-comment">// 子组件的方法：切换背景色</span>
  <span class="hljs-keyword">private</span> switchColor = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span> === <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>;
  }

  <span class="hljs-comment">// 组件初始化时，把方法赋值给控制器</span>
  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-property">action</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">switchColor</span>;
    }
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Child Component'</span>)
    }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span>).<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
  }
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-keyword">private</span> childRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Controller</span>(); <span class="hljs-comment">// 创建控制器实例</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// 把控制器传给子组件</span>
      <span class="hljs-title class_">ChildComponent</span>({ <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">childRef</span> })
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'切换子组件颜色'</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">childRef</span>.<span class="hljs-title function_">action</span>(); <span class="hljs-comment">// 调用子组件方法</span>
        })
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">16</span> })
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)
  }
}
</code></pre>
<h4 data-id="heading-26">方法二：用@Watch监听</h4>
<p>父组件改状态变量，子组件监听变量变化，触发方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子组件</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">ChildComponent</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">bgColor</span>: <span class="hljs-title class_">ResourceColor</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>;
  <span class="hljs-comment">// 监听checkFlag变量变化</span>
  <span class="hljs-meta">@Link</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'switchColor'</span>) <span class="hljs-attr">checkFlag</span>: <span class="hljs-built_in">boolean</span>;

  <span class="hljs-comment">// 变量变化时触发的方法</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">switchColor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">checkFlag</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>;
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Child Component'</span>)
    }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span>).<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
  }
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">childCheckFlag</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">ChildComponent</span>({ <span class="hljs-attr">checkFlag</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">childCheckFlag</span> })
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'切换颜色'</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">childCheckFlag</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">childCheckFlag</span>; <span class="hljs-comment">// 改变量</span>
        })
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">16</span> })
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)
  }
}
</code></pre>
<h4 data-id="heading-27">方法三：用Emitter事件通信</h4>
<p>子组件监听事件，父组件发送事件，触发子组件方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子组件</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">ChildComponent</span> {
  <span class="hljs-comment">// 定义事件ID</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable constant_">EVENT_ID_SWITCH_COLOR</span> = <span class="hljs-string">'SWITCH_COLOR'</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">bgColor</span>: <span class="hljs-title class_">ResourceColor</span> = <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>;

  <span class="hljs-keyword">private</span> switchColor = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span> === <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>;
  }

  <span class="hljs-comment">// 组件初始化时监听事件</span>
  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    emitter.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">ChildComponent</span>.<span class="hljs-property">EVENT_ID_SWITCH_COLOR</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">switchColor</span>);
  }

  <span class="hljs-comment">// 组件销毁时取消监听</span>
  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {
    emitter.<span class="hljs-title function_">off</span>(<span class="hljs-title class_">ChildComponent</span>.<span class="hljs-property">EVENT_ID_SWITCH_COLOR</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">switchColor</span>);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'Child Component'</span>)
    }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">bgColor</span>).<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
  }
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">ChildComponent</span>()
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'切换颜色'</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">ChildComponent</span>.<span class="hljs-property">EVENT_ID_SWITCH_COLOR</span>); <span class="hljs-comment">// 发送事件</span>
        })
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">16</span> })
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)
  }
}
</code></pre>
<h3 data-id="heading-28">2. 怎么调用父组件里的方法？</h3>
<p>超简单！子组件留个回调参数，父组件把自己的方法传进去：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子组件</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">ChildComponent</span> {
  call = <span class="hljs-function">() =&gt;</span> {}; <span class="hljs-comment">// 回调参数，用来存父组件的方法</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'调用父组件方法'</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">call</span>(); <span class="hljs-comment">// 触发父组件方法</span>
        })
    }
  }
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 父组件的方法</span>
  <span class="hljs-title function_">parentAction</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Parent Action'</span> });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;
      hilog.<span class="hljs-title function_">warn</span>(<span class="hljs-number">0x000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`showToast failed, code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);
    }
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// 把父组件方法传给子组件</span>
      <span class="hljs-title class_">ChildComponent</span>({ <span class="hljs-attr">call</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentAction</span> })
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)
  }
}
</code></pre>
<h3 data-id="heading-29">3. 怎么实现“插槽”（可变UI部分）？</h3>
<p>用<code>@BuilderParam</code>！子组件留个位置，父组件按需传入UI内容：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子组件</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">ChildComponent</span> {
  <span class="hljs-comment">// 默认空UI</span>
  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">customBuilder</span>(<span class="hljs-params"/>) {}

  <span class="hljs-comment">// 暴露给父组件的UI参数</span>
  <span class="hljs-meta">@BuilderParam</span> <span class="hljs-attr">customBuilderParam</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">customBuilder</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'子组件固定内容'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">customBuilderParam</span>(); <span class="hljs-comment">// 父组件传入的可变UI</span>
    }
  }
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 父组件定义的可变UI</span>
  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">componentBuilder</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`父组件传入的UI`</span>)
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// 传入可变UI</span>
      <span class="hljs-title class_">ChildComponent</span>() {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">componentBuilder</span>();
      }
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)
  }
}
</code></pre>
<h3 data-id="heading-30">4. 怎么传递组件数组，实现循环渲染？</h3>
<p>先把组件包装成全局<code>@Builder</code>，再用<code>wrapBuilder</code>封装成数组，最后用<code>ForEach</code>循环：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 定义全局组件模板</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">itemBuilder</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-title class_">Text</span>(text)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
    .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
}

<span class="hljs-comment">// 2. 封装成组件数组</span>
<span class="hljs-keyword">const</span> componentArray = [
  <span class="hljs-title function_">wrapBuilder</span>(itemBuilder, <span class="hljs-string">'项目1'</span>),
  <span class="hljs-title function_">wrapBuilder</span>(itemBuilder, <span class="hljs-string">'项目2'</span>),
  <span class="hljs-title function_">wrapBuilder</span>(itemBuilder, <span class="hljs-string">'项目3'</span>)
];

<span class="hljs-comment">// 3. 循环渲染</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ForEachComponent</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">ForEach</span>(componentArray, <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        item.<span class="hljs-title function_">builder</span>(); <span class="hljs-comment">// 渲染每个组件</span>
      })
    }
  }
}
</code></pre>
<h2 data-id="heading-31">总结</h2>
<p>组件封装的核心就是“提取重复，暴露可变”：</p>
<ul>
<li>只复用样式：用<code>AttributeModifier</code></li>
<li>复用样式+布局+逻辑：用<code>@Component</code>写自定义组件</li>
<li>批量管理组件：用组件工厂（Map+wrapBuilder）</li>
</ul>
<p>掌握这三招，再也不用写重复代码，项目维护起来也省心。遇到调用方法、插槽这些问题，直接抄上面的作业就行～ 赶紧把你项目里的重复组件封装起来试试吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在无脑 .map().filter()？实测改用 Iterator Helpers 后，内存占用降低了 99%]]></title>    <link>https://juejin.cn/post/7596926832912498751</link>    <guid>https://juejin.cn/post/7596926832912498751</guid>    <pubDate>2026-01-19T11:53:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596926832912498751" data-draft-id="7596865421612302390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在无脑 .map().filter()？实测改用 Iterator Helpers 后，内存占用降低了 99%"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-19T11:53:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在无脑 .map().filter()？实测改用 Iterator Helpers 后，内存占用降低了 99%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T11:53:53.000Z" title="Mon Jan 19 2026 11:53:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    231
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再把所有东西都转成数组了：Iterator Helpers 性能实测</h2>
<p>今天看到一篇文章，标题很直接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fallthingssmitty.com%2F2026%2F01%2F12%2Fstop-turning-everything-into-arrays-and-do-less-work-instead%2F" target="_blank" title="https://allthingssmitty.com/2026/01/12/stop-turning-everything-into-arrays-and-do-less-work-instead/" ref="nofollow noopener noreferrer">Stop turning everything into arrays</a>。作者的观点是，JavaScript 里我们习惯了用 <code>.map().filter().slice()</code> 这种链式调用，看着很优雅，但其实每一步都在创建新数组，做了很多不必要的工作。</p>
<p>我一开始也半信半疑，毕竟这种写法用了这么多年，真的有那么大问题吗？于是我写了个测试脚本，跑了几组对比实验，结果还挺出乎意料的。</p>
<h3 data-id="heading-1">问题在哪</h3>
<p>先说传统数组方法的问题。假设你有个常见场景：从一个大列表里筛选出符合条件的数据，做点转换，然后只取前 10 条显示。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> visibleItems = items
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
  .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
</code></pre>
<p>这代码看着没毛病，但实际执行时：</p>
<ol>
<li><code>filter</code> 遍历整个数组，创建一个新数组</li>
<li><code>map</code> 再遍历一遍，又创建一个新数组</li>
<li><code>slice</code> 最后从结果里取前 10 条，又创建一个新数组</li>
</ol>
<p>如果 <code>items</code> 有 10 万条数据，你可能只需要 10 条，但前面两步已经把 10 万条全处理完了。这就是"急切求值"（eager evaluation）的问题——不管你最后用不用，先把活全干了再说。</p>
<h3 data-id="heading-2">Iterator Helpers 是什么</h3>
<p>Iterator Helpers 是 JavaScript 新加的特性，提供了一套"惰性求值"（lazy evaluation）的方法。关键区别是：</p>
<ul>
<li><strong>传统数组方法</strong>：每一步都立即执行，创建中间数组</li>
<li><strong>Iterator Helpers</strong>：只描述要做什么，真正需要数据时才执行</li>
</ul>
<p>用法上也很直观：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> visibleItems = items
  .<span class="hljs-title function_">values</span>()              <span class="hljs-comment">// 转成 iterator</span>
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">10</span>)              <span class="hljs-comment">// 只取 10 条</span>
  .<span class="hljs-title function_">toArray</span>();            <span class="hljs-comment">// 最后转回数组</span>
</code></pre>
<p>核心差异在于：</p>
<ol>
<li><code>items.values()</code> 返回的是 iterator，不是数组</li>
<li>每一步只是在"描述"操作，不会立即执行</li>
<li><code>take(10)</code> 告诉它只需要 10 条，处理到 10 条就停</li>
<li><code>toArray()</code> 才真正触发执行，而且只处理需要的数据</li>
</ol>
<h3 data-id="heading-3">实测对比</h3>
<p>我写了个测试脚本，从<strong>时间</strong>和<strong>空间</strong>两个维度进行对比测试。每组场景的时间测试重复 10 次取平均值，内存测试使用 Node.js 的 <code>process.memoryUsage()</code> API 测量堆内存增长。</p>
<h4 data-id="heading-4">场景 1：过滤 + 转换 + 取前 10 项</h4>
<p><strong>数据规模</strong>：100,000 条</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统数组方法</span>
dataset
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
  .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);

<span class="hljs-comment">// Iterator Helpers</span>
dataset
  .<span class="hljs-title function_">values</span>()
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">10</span>)
  .<span class="hljs-title function_">toArray</span>();
</code></pre>
<p><strong>结果</strong>：</p>























<table><thead><tr><th>维度</th><th>传统数组方法</th><th>Iterator Helpers</th><th>性能提升</th></tr></thead><tbody><tr><td>时间</td><td>1.545ms</td><td>0.019ms</td><td><strong>98.77%</strong></td></tr><tr><td>内存</td><td>3.38 MB</td><td>0.01 MB</td><td><strong>99.75%</strong></td></tr></tbody></table>
<p>这个结果很夸张，Iterator Helpers 在时间上快了 80 多倍，内存使用更是只有传统方法的 0.3%。原因很简单：传统方法处理了所有 10 万条数据并创建了 2 个中间数组（filter 和 map 各一个），而 Iterator Helpers 找到 10 条就停了，完全不创建中间数组。</p>
<h4 data-id="heading-5">场景 2：嵌套数据扁平化</h4>
<p><strong>数据规模</strong>：10,000 个父项，每个包含 10 个子项（共 100,000 条子数据）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统数组方法</span>
dataset
  .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.<span class="hljs-property">children</span>)
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.<span class="hljs-property">value</span> &gt; <span class="hljs-number">50</span>)
  .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>);

<span class="hljs-comment">// Iterator Helpers</span>
dataset
  .<span class="hljs-title function_">values</span>()
  .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.<span class="hljs-property">children</span>)
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.<span class="hljs-property">value</span> &gt; <span class="hljs-number">50</span>)
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">20</span>)
  .<span class="hljs-title function_">toArray</span>();
</code></pre>
<p><strong>结果</strong>：</p>























<table><thead><tr><th>维度</th><th>传统数组方法</th><th>Iterator Helpers</th><th>性能提升</th></tr></thead><tbody><tr><td>时间</td><td>3.716ms</td><td>0.018ms</td><td><strong>99.53%</strong></td></tr><tr><td>内存</td><td>4.03 MB</td><td>0.01 MB</td><td><strong>99.73%</strong></td></tr></tbody></table>
<p><code>flatMap</code> 这种场景更明显，因为传统方法要先把所有嵌套数据（10 万条子数据）展平成一个大数组，再过滤，再切片，创建了 2 个中间数组。Iterator Helpers 直接在展平的过程中就能提前终止，内存使用几乎可以忽略不计。</p>
<h4 data-id="heading-6">场景 3：查找第一个匹配项（公平对决）</h4>
<p><strong>数据规模</strong>：1,000,000 条</p>
<p>这个场景需要特别说明。原来的测试用 <code>filter(...)[0]</code> 作为对照组，这是不公平的——<strong>实际开发中，大家都会直接用 <code>Array.find()</code></strong>，没人会傻到先 <code>filter</code> 遍历完整个数组再取第一个。</p>
<p>所以这里改成真正的公平对决：<code>Array.find()</code> vs <code>Iterator.find()</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Array.find()（原生数组方法）</span>
dataset.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetId);

<span class="hljs-comment">// Iterator.find()</span>
dataset.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetId);
</code></pre>
<p>我在不同位置测试了查找性能（头部、中部、尾部）：</p>
<p><strong>结果</strong>：</p>





























<table><thead><tr><th>目标位置</th><th>Array.find()</th><th>Iterator.find()</th><th>差异</th></tr></thead><tbody><tr><td>头部（第 100 个）</td><td>0.008ms</td><td>0.006ms</td><td>Iterator 快 22%</td></tr><tr><td>中部（第 500,000 个）</td><td>4.733ms</td><td>7.974ms</td><td><strong>Iterator 慢 68%</strong> ⚠️</td></tr><tr><td>尾部（第 999,900 个）</td><td>10.779ms</td><td>14.071ms</td><td><strong>Iterator 慢 31%</strong> ⚠️</td></tr></tbody></table>
<p><strong>关键发现</strong>：</p>
<ol>
<li><strong><code>Array.find()</code> 本身就是惰性的</strong>——它找到第一个匹配项就会停止，不需要 Iterator Helpers 来"拯救"</li>
<li><strong>Iterator 有额外开销</strong>：每次迭代需要创建 iterator 对象、调用 <code>.next()</code> 方法，这些开销在大规模遍历时会累积</li>
<li><strong>头部查找时 Iterator 略快</strong>：可能是因为数据量小，V8 的优化策略不同</li>
</ol>
<p><strong>MDN 文档验证</strong>：</p>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FArray%2Ffind" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/find" ref="nofollow noopener noreferrer">MDN 官方文档</a>，<code>Array.find()</code> 确实具有<strong>短路求值（short-circuit）</strong> 的特性：</p>
<blockquote>
<p><code>find()</code> does not process the remaining elements of the array after the callbackFn returns a truthy value.</p>
</blockquote>
<p>也就是说，<code>Array.find()</code> 和 <code>Iterator.find()</code> 在"找到即停"这一点上是<strong>完全一样</strong>的。两者的区别仅在于：</p>
<ul>
<li><strong>Iterator.find()</strong> 需要先通过 <code>.values()</code> 将数组转换成迭代器，这会引入额外开销</li>
<li>对于<strong>链式调用</strong>（如 <code>filter().map().find()</code>），Iterator Helpers 可以避免创建中间数组，这时才有优势</li>
</ul>
<p><strong>结论</strong>：对于纯粹的"查找第一个"场景，直接用 <code>Array.find()</code> 就好，不要画蛇添足用 Iterator Helpers。</p>
<h4 data-id="heading-7">场景 4：复杂链式调用</h4>
<p><strong>数据规模</strong>：50,000 条</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统数组方法</span>
dataset
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">doubled</span> &gt; <span class="hljs-number">500</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">final</span>: item.<span class="hljs-property">doubled</span> + <span class="hljs-number">100</span> }))
  .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">15</span>);

<span class="hljs-comment">// Iterator Helpers</span>
dataset
  .<span class="hljs-title function_">values</span>()
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">doubled</span> &gt; <span class="hljs-number">500</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">final</span>: item.<span class="hljs-property">doubled</span> + <span class="hljs-number">100</span> }))
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">15</span>)
  .<span class="hljs-title function_">toArray</span>();
</code></pre>
<p><strong>结果</strong>：</p>























<table><thead><tr><th>维度</th><th>传统数组方法</th><th>Iterator Helpers</th><th>性能提升</th></tr></thead><tbody><tr><td>时间</td><td>1.421ms</td><td>0.028ms</td><td><strong>98.02%</strong></td></tr><tr><td>内存</td><td>5.33 MB</td><td>0.01 MB</td><td><strong>99.75%</strong></td></tr></tbody></table>
<p>链式调用越多，传统方法创建的中间数组就越多。这个场景有 4 次操作（filter → map → filter → map），传统方法创建了 4 个中间数组，总共占用 5.33 MB 内存；而 Iterator Helpers 一个中间数组都没创建，内存使用几乎为零。</p>
<h3 data-id="heading-8">什么时候用 Iterator Helpers</h3>
<p>根据测试结果，我总结了几个适合用 Iterator Helpers 的场景：</p>
<h4 data-id="heading-9">1. 只需要前 N 项</h4>
<p>这是最明显的优势场景。无限滚动、分页加载、虚拟列表这些场景都适合。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 虚拟列表只渲染可见的 20 条</span>
<span class="hljs-keyword">const</span> visibleRows = allRows
  .<span class="hljs-title function_">values</span>()
  .<span class="hljs-title function_">filter</span>(isInViewport)
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">20</span>)
  .<span class="hljs-title function_">toArray</span>();
</code></pre>
<h4 data-id="heading-10">2. 流式数据处理</h4>
<p>处理 API 分页、SSE 流、WebSocket 消息这些场景，Iterator Helpers 配合 async iterator 很好用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">fetchPages</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> page = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/items?page=<span class="hljs-subst">${page++}</span>`</span>);
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">yield</span>* <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
  }
}

<span class="hljs-comment">// 只拉取需要的数据，不会一次性加载所有分页</span>
<span class="hljs-keyword">const</span> firstTen = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPages</span>()
  .<span class="hljs-title function_">filter</span>(isValid)
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">10</span>)
  .<span class="hljs-title function_">toArray</span>();
</code></pre>
<h4 data-id="heading-11">3. 复杂的数据管道</h4>
<p>如果你的数据处理链路很长，有多次 <code>filter</code>、<code>map</code>、<code>flatMap</code>，用 Iterator Helpers 能避免创建一堆中间数组。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> result = data
  .<span class="hljs-title function_">values</span>()
  .<span class="hljs-title function_">filter</span>(step1)
  .<span class="hljs-title function_">map</span>(step2)
  .<span class="hljs-title function_">flatMap</span>(step3)
  .<span class="hljs-title function_">filter</span>(step4)
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">100</span>)
  .<span class="hljs-title function_">toArray</span>();
</code></pre>
<h3 data-id="heading-12">什么时候不用</h3>
<p>Iterator Helpers 也不是万能的，这几种情况还是老老实实用数组：</p>
<h4 data-id="heading-13">1. 需要随机访问</h4>
<p>Iterator 是单向的，不能 <code>items[5]</code> 这样直接取某一项。如果你需要随机访问，还是得用数组。</p>
<h4 data-id="heading-14">2. 数据量很小</h4>
<p>如果就几十条数据，用 Iterator Helpers 反而增加了复杂度，传统数组方法更简单直接。</p>
<h4 data-id="heading-15">3. 需要多次遍历</h4>
<p>Iterator 只能遍历一次，如果你需要对同一份数据做多次不同的处理，还是先 <code>toArray()</code> 转成数组再说。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> iter = data.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x &gt; <span class="hljs-number">10</span>);

<span class="hljs-comment">// ❌ 第二次遍历会返回空，因为 iterator 已经消费完了</span>
<span class="hljs-keyword">const</span> first = iter.<span class="hljs-title function_">take</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">toArray</span>();
<span class="hljs-keyword">const</span> second = iter.<span class="hljs-title function_">take</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">toArray</span>(); <span class="hljs-comment">// []</span>

<span class="hljs-comment">// ✅ 先转数组，再多次使用</span>
<span class="hljs-keyword">const</span> filtered = data.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x &gt; <span class="hljs-number">10</span>).<span class="hljs-title function_">toArray</span>();
<span class="hljs-keyword">const</span> first = filtered.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
<span class="hljs-keyword">const</span> second = filtered.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>);
</code></pre>
<h3 data-id="heading-16">兼容性</h3>
<p>Iterator Helpers 在现代浏览器和 Node.js 22+ 都已经支持了。如果你的项目还要兼容老版本，可以用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js" target="_blank" title="https://github.com/zloirock/core-js" ref="nofollow noopener noreferrer">core-js</a> 这类 polyfill。</p>
<p>可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2Fiterator-helpers" target="_blank" title="https://caniuse.com/iterator-helpers" ref="nofollow noopener noreferrer">Can I Use</a> 查看详细的兼容性数据。</p>
<h3 data-id="heading-17">一些坑</h3>
<h4 data-id="heading-18">1. Iterator 不是数组</h4>
<p>这是最容易踩的坑。Iterator 没有 <code>length</code>、<code>[index]</code> 这些属性，也不能直接 <code>console.log</code> 看内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> iter = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">values</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iter.<span class="hljs-property">length</span>);  <span class="hljs-comment">// undefined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iter[<span class="hljs-number">0</span>]);      <span class="hljs-comment">// undefined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iter);         <span class="hljs-comment">// Object [Array Iterator] {}</span>

<span class="hljs-comment">// 要看内容，得先转数组</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([...iter]);    <span class="hljs-comment">// [1, 2, 3]</span>
</code></pre>
<h4 data-id="heading-19">2. <code>reduce</code> 不是惰性的</h4>
<p>大部分 Iterator Helpers 都是惰性的，但 <code>reduce</code> 是个例外，它必须遍历所有数据才能得出结果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// reduce 会立即消费整个 iterator</span>
<span class="hljs-keyword">const</span> sum = data.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, x</span>) =&gt;</span> acc + x, <span class="hljs-number">0</span>);
</code></pre>
<h4 data-id="heading-20">3. 调试不方便</h4>
<p>因为是惰性求值，你不能在中间步骤打断点看数据。如果要调试，可以在关键步骤插入 <code>toArray()</code> 转成数组再看。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> result = data
  .<span class="hljs-title function_">values</span>()
  .<span class="hljs-title function_">filter</span>(step1)
  .<span class="hljs-title function_">toArray</span>()  <span class="hljs-comment">// 调试用，看看 filter 后的结果</span>
  .<span class="hljs-title function_">values</span>()
  .<span class="hljs-title function_">map</span>(step2)
  .<span class="hljs-title function_">take</span>(<span class="hljs-number">10</span>)
  .<span class="hljs-title function_">toArray</span>();
</code></pre>
<h3 data-id="heading-21">总结</h3>
<p>Iterator Helpers 不是要替代数组，而是给了我们另一个选择。核心思路就一句话：<strong>如果你不需要整个数组，就别创建它</strong>。</p>
<p>从实测结果看：</p>
<ul>
<li><strong>filter/map + take(N) 链式调用</strong>：时间和空间开销都能降低 90%+，这是 Iterator Helpers 的杀手级场景</li>
<li><strong>单纯的 find 查找</strong>：<code>Array.find()</code> 本身就是惰性的，用 <code>Iterator.find()</code> 反而更慢（慢 30%-70%）</li>
<li>数据规模越大，Iterator Helpers 在链式调用场景的优势越明显</li>
<li><strong>内存优势尤其突出</strong>：传统方法创建的中间数组会占用大量内存，而 Iterator Helpers 几乎不占用额外内存</li>
</ul>
<p>我个人的使用建议是：</p>
<ol>
<li><strong>默认还是用数组方法</strong>，简单直接，不容易出错</li>
<li><strong>filter/map + slice 组合</strong>：如果你只需要前 N 项，这是 Iterator Helpers 大显身手的场景</li>
<li><strong>单纯的 find/findIndex</strong>：直接用 <code>Array.find()</code> / <code>Array.findIndex()</code>，不要用 Iterator</li>
<li><strong>写数据管道时</strong>，如果链路很长，用 Iterator Helpers 能让代码更清晰，也能避免不必要的内存分配</li>
<li><strong>内存敏感场景</strong>，比如处理大数据集、移动端应用等，Iterator Helpers 能显著降低内存压力</li>
</ol>
<h3 data-id="heading-22">完整测试代码</h3>
<p>下面是完整的性能测试代码，包含<strong>时间</strong>和<strong>空间</strong>两个维度的测试。你可以复制到本地跑一下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * Iterator Helpers vs Array Methods 性能对比测试
 * 
 * 测试维度：
 * 1. 时间开销（执行时间）
 * 2. 空间开销（内存使用）
 * 
 * 测试场景：
 * 1. 大数据集过滤 + 转换 + 取前 N 项
 * 2. 嵌套数据扁平化
 * 3. 查找第一个匹配项
 * 4. 复杂链式调用
 */</span>

<span class="hljs-comment">// ============ 工具函数 ============</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateLargeDataset</span>(<span class="hljs-params">size</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: size }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
    <span class="hljs-attr">id</span>: i,
    <span class="hljs-attr">value</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>,
    <span class="hljs-attr">category</span>: [<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>][i % <span class="hljs-number">4</span>],
    <span class="hljs-attr">active</span>: i % <span class="hljs-number">3</span> === <span class="hljs-number">0</span>
  }));
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">benchmark</span>(<span class="hljs-params">name, fn, iterations = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> times = [];
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; iterations; i++) {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-title function_">fn</span>();
    <span class="hljs-keyword">const</span> end = performance.<span class="hljs-title function_">now</span>();
    times.<span class="hljs-title function_">push</span>(end - start);
  }
  
  <span class="hljs-keyword">const</span> avg = times.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b, <span class="hljs-number">0</span>) / times.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> min = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(...times);
  <span class="hljs-keyword">const</span> max = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...times);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n<span class="hljs-subst">${name}</span>:`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  平均: <span class="hljs-subst">${avg.toFixed(<span class="hljs-number">3</span>)}</span>ms`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  最小: <span class="hljs-subst">${min.toFixed(<span class="hljs-number">3</span>)}</span>ms`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  最大: <span class="hljs-subst">${max.toFixed(<span class="hljs-number">3</span>)}</span>ms`</span>);
  
  <span class="hljs-keyword">return</span> avg;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">memoryBenchmark</span>(<span class="hljs-params">name, fn</span>) {
  <span class="hljs-comment">// 强制垃圾回收（需要 Node.js 启动时加 --expose-gc 参数）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">global</span>.<span class="hljs-property">gc</span>) {
    <span class="hljs-variable language_">global</span>.<span class="hljs-title function_">gc</span>();
  }
  
  <span class="hljs-keyword">const</span> memBefore = process.<span class="hljs-title function_">memoryUsage</span>();
  <span class="hljs-title function_">fn</span>();
  <span class="hljs-keyword">const</span> memAfter = process.<span class="hljs-title function_">memoryUsage</span>();
  
  <span class="hljs-keyword">const</span> heapUsedDiff = (memAfter.<span class="hljs-property">heapUsed</span> - memBefore.<span class="hljs-property">heapUsed</span>) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>;
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  内存增长: <span class="hljs-subst">${heapUsedDiff.toFixed(<span class="hljs-number">2</span>)}</span> MB`</span>);
  
  <span class="hljs-keyword">return</span> heapUsedDiff;
}

<span class="hljs-comment">// ============ 测试场景 1: 过滤 + 转换 + 取前 N 项 ============</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'测试场景 1: 大数据集过滤 + 转换 + 取前 10 项'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据规模: 100,000 条'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));

<span class="hljs-keyword">const</span> dataset1 = <span class="hljs-title function_">generateLargeDataset</span>(<span class="hljs-number">100000</span>);

<span class="hljs-comment">// 传统数组方法 - 时间</span>
<span class="hljs-keyword">const</span> arrayMethodTime1 = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'传统数组方法 (filter + map + slice) - 时间'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset1
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
  
  <span class="hljs-keyword">return</span> result;
}, <span class="hljs-number">10</span>);

<span class="hljs-comment">// 传统数组方法 - 内存</span>
<span class="hljs-keyword">const</span> arrayMethodMem1 = <span class="hljs-title function_">memoryBenchmark</span>(<span class="hljs-string">'传统数组方法 (filter + map + slice) - 内存'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset1
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
  
  <span class="hljs-keyword">return</span> result;
});

<span class="hljs-comment">// Iterator Helpers - 时间</span>
<span class="hljs-keyword">const</span> iteratorHelpersTime1 = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Iterator Helpers (filter + map + take) - 时间'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset1
    .<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">take</span>(<span class="hljs-number">10</span>)
    .<span class="hljs-title function_">toArray</span>();
  
  <span class="hljs-keyword">return</span> result;
}, <span class="hljs-number">10</span>);

<span class="hljs-comment">// Iterator Helpers - 内存</span>
<span class="hljs-keyword">const</span> iteratorHelpersMem1 = <span class="hljs-title function_">memoryBenchmark</span>(<span class="hljs-string">'Iterator Helpers (filter + map + take) - 内存'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset1
    .<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">take</span>(<span class="hljs-number">10</span>)
    .<span class="hljs-title function_">toArray</span>();
  
  <span class="hljs-keyword">return</span> result;
});

<span class="hljs-keyword">const</span> timeImprovement1 = ((arrayMethodTime1 - iteratorHelpersTime1) / arrayMethodTime1 * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> memImprovement1 = ((arrayMethodMem1 - iteratorHelpersMem1) / arrayMethodMem1 * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n性能提升: 时间 <span class="hljs-subst">${timeImprovement1}</span>%, 内存 <span class="hljs-subst">${memImprovement1}</span>%`</span>);

<span class="hljs-comment">// ============ 测试场景 2: 嵌套数据扁平化 ============</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n'</span> + <span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'测试场景 2: 嵌套数据扁平化 + 过滤 + 取前 20 项'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据规模: 10,000 个父项，每个包含 10 个子项'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));

<span class="hljs-keyword">const</span> dataset2 = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
  <span class="hljs-attr">id</span>: i,
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10</span> }, <span class="hljs-function">(<span class="hljs-params">_, j</span>) =&gt;</span> ({
    <span class="hljs-attr">childId</span>: <span class="hljs-string">`<span class="hljs-subst">${i}</span>-<span class="hljs-subst">${j}</span>`</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>
  }))
}));

<span class="hljs-comment">// 传统数组方法 - 时间</span>
<span class="hljs-keyword">const</span> arrayMethodTime2 = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'传统数组方法 (flatMap + filter + slice) - 时间'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset2
    .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.<span class="hljs-property">children</span>)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.<span class="hljs-property">value</span> &gt; <span class="hljs-number">50</span>)
    .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>);
  
  <span class="hljs-keyword">return</span> result;
}, <span class="hljs-number">10</span>);

<span class="hljs-comment">// 传统数组方法 - 内存</span>
<span class="hljs-keyword">const</span> arrayMethodMem2 = <span class="hljs-title function_">memoryBenchmark</span>(<span class="hljs-string">'传统数组方法 (flatMap + filter + slice) - 内存'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset2
    .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.<span class="hljs-property">children</span>)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.<span class="hljs-property">value</span> &gt; <span class="hljs-number">50</span>)
    .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>);
  
  <span class="hljs-keyword">return</span> result;
});

<span class="hljs-comment">// Iterator Helpers - 时间</span>
<span class="hljs-keyword">const</span> iteratorHelpersTime2 = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Iterator Helpers (flatMap + filter + take) - 时间'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset2
    .<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.<span class="hljs-property">children</span>)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.<span class="hljs-property">value</span> &gt; <span class="hljs-number">50</span>)
    .<span class="hljs-title function_">take</span>(<span class="hljs-number">20</span>)
    .<span class="hljs-title function_">toArray</span>();
  
  <span class="hljs-keyword">return</span> result;
}, <span class="hljs-number">10</span>);

<span class="hljs-comment">// Iterator Helpers - 内存</span>
<span class="hljs-keyword">const</span> iteratorHelpersMem2 = <span class="hljs-title function_">memoryBenchmark</span>(<span class="hljs-string">'Iterator Helpers (flatMap + filter + take) - 内存'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset2
    .<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.<span class="hljs-property">children</span>)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> child.<span class="hljs-property">value</span> &gt; <span class="hljs-number">50</span>)
    .<span class="hljs-title function_">take</span>(<span class="hljs-number">20</span>)
    .<span class="hljs-title function_">toArray</span>();
  
  <span class="hljs-keyword">return</span> result;
});

<span class="hljs-keyword">const</span> timeImprovement2 = ((arrayMethodTime2 - iteratorHelpersTime2) / arrayMethodTime2 * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> memImprovement2 = ((arrayMethodMem2 - iteratorHelpersMem2) / arrayMethodMem2 * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n性能提升: 时间 <span class="hljs-subst">${timeImprovement2}</span>%, 内存 <span class="hljs-subst">${memImprovement2}</span>%`</span>);

<span class="hljs-comment">// ============ 测试场景 3: 查找第一个匹配项（公平对决） ============</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n'</span> + <span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'测试场景 3: 查找第一个匹配项（公平对决：Array.find vs Iterator.find）'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据规模: 1,000,000 条'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));

<span class="hljs-keyword">const</span> dataset3 = <span class="hljs-title function_">generateLargeDataset</span>(<span class="hljs-number">1000000</span>);

<span class="hljs-comment">// 3a: 目标在头部</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n--- 3a: 目标在头部（第 100 个）---'</span>);
<span class="hljs-keyword">const</span> targetHead = <span class="hljs-number">100</span>;

<span class="hljs-keyword">const</span> arrayFindHead = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Array.find() - 头部'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> dataset3.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetHead);
}, <span class="hljs-number">20</span>);

<span class="hljs-keyword">const</span> iteratorFindHead = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Iterator.find() - 头部'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> dataset3.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetHead);
}, <span class="hljs-number">20</span>);

<span class="hljs-keyword">const</span> diffHead = ((iteratorFindHead - arrayFindHead) / arrayFindHead * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`差异: <span class="hljs-subst">${diffHead}</span>% <span class="hljs-subst">${diffHead &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'(Iterator 更慢)'</span> : <span class="hljs-string">'(Iterator 更快)'</span>}</span>`</span>);

<span class="hljs-comment">// 3b: 目标在中部</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n--- 3b: 目标在中部（第 500,000 个）---'</span>);
<span class="hljs-keyword">const</span> targetMiddle = <span class="hljs-number">500000</span>;

<span class="hljs-keyword">const</span> arrayFindMiddle = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Array.find() - 中部'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> dataset3.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetMiddle);
}, <span class="hljs-number">20</span>);

<span class="hljs-keyword">const</span> iteratorFindMiddle = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Iterator.find() - 中部'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> dataset3.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetMiddle);
}, <span class="hljs-number">20</span>);

<span class="hljs-keyword">const</span> diffMiddle = ((iteratorFindMiddle - arrayFindMiddle) / arrayFindMiddle * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`差异: <span class="hljs-subst">${diffMiddle}</span>% <span class="hljs-subst">${diffMiddle &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'(Iterator 更慢)'</span> : <span class="hljs-string">'(Iterator 更快)'</span>}</span>`</span>);

<span class="hljs-comment">// 3c: 目标在尾部</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n--- 3c: 目标在尾部（第 999,900 个）---'</span>);
<span class="hljs-keyword">const</span> targetTail = <span class="hljs-number">999900</span>;

<span class="hljs-keyword">const</span> arrayFindTail = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Array.find() - 尾部'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> dataset3.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetTail);
}, <span class="hljs-number">20</span>);

<span class="hljs-keyword">const</span> iteratorFindTail = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Iterator.find() - 尾部'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> dataset3.<span class="hljs-title function_">values</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === targetTail);
}, <span class="hljs-number">20</span>);

<span class="hljs-keyword">const</span> diffTail = ((iteratorFindTail - arrayFindTail) / arrayFindTail * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`差异: <span class="hljs-subst">${diffTail}</span>% <span class="hljs-subst">${diffTail &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'(Iterator 更慢)'</span> : <span class="hljs-string">'(Iterator 更快)'</span>}</span>`</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n结论：Array.find() 本身就是惰性的，Iterator.find() 在大多数情况下更慢'</span>);

<span class="hljs-comment">// ============ 测试场景 4: 多次链式调用 ============</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n'</span> + <span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'测试场景 4: 复杂链式调用（filter + map + filter + map + take）'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据规模: 50,000 条'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));

<span class="hljs-keyword">const</span> dataset4 = <span class="hljs-title function_">generateLargeDataset</span>(<span class="hljs-number">50000</span>);

<span class="hljs-comment">// 传统数组方法 - 时间</span>
<span class="hljs-keyword">const</span> arrayMethodTime4 = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'传统数组方法 (多次链式调用) - 时间'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset4
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">doubled</span> &gt; <span class="hljs-number">500</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">final</span>: item.<span class="hljs-property">doubled</span> + <span class="hljs-number">100</span> }))
    .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">15</span>);
  
  <span class="hljs-keyword">return</span> result;
}, <span class="hljs-number">10</span>);

<span class="hljs-comment">// 传统数组方法 - 内存</span>
<span class="hljs-keyword">const</span> arrayMethodMem4 = <span class="hljs-title function_">memoryBenchmark</span>(<span class="hljs-string">'传统数组方法 (多次链式调用) - 内存'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset4
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">doubled</span> &gt; <span class="hljs-number">500</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">final</span>: item.<span class="hljs-property">doubled</span> + <span class="hljs-number">100</span> }))
    .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">15</span>);
  
  <span class="hljs-keyword">return</span> result;
});

<span class="hljs-comment">// Iterator Helpers - 时间</span>
<span class="hljs-keyword">const</span> iteratorHelpersTime4 = <span class="hljs-title function_">benchmark</span>(<span class="hljs-string">'Iterator Helpers (多次链式调用) - 时间'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset4
    .<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">doubled</span> &gt; <span class="hljs-number">500</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">final</span>: item.<span class="hljs-property">doubled</span> + <span class="hljs-number">100</span> }))
    .<span class="hljs-title function_">take</span>(<span class="hljs-number">15</span>)
    .<span class="hljs-title function_">toArray</span>();
  
  <span class="hljs-keyword">return</span> result;
}, <span class="hljs-number">10</span>);

<span class="hljs-comment">// Iterator Helpers - 内存</span>
<span class="hljs-keyword">const</span> iteratorHelpersMem4 = <span class="hljs-title function_">memoryBenchmark</span>(<span class="hljs-string">'Iterator Helpers (多次链式调用) - 内存'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> result = dataset4
    .<span class="hljs-title function_">values</span>()
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">active</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item, <span class="hljs-attr">doubled</span>: item.<span class="hljs-property">value</span> * <span class="hljs-number">2</span> }))
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">doubled</span> &gt; <span class="hljs-number">500</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ <span class="hljs-attr">id</span>: item.<span class="hljs-property">id</span>, <span class="hljs-attr">final</span>: item.<span class="hljs-property">doubled</span> + <span class="hljs-number">100</span> }))
    .<span class="hljs-title function_">take</span>(<span class="hljs-number">15</span>)
    .<span class="hljs-title function_">toArray</span>();
  
  <span class="hljs-keyword">return</span> result;
});

<span class="hljs-keyword">const</span> timeImprovement4 = ((arrayMethodTime4 - iteratorHelpersTime4) / arrayMethodTime4 * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> memImprovement4 = ((arrayMethodMem4 - iteratorHelpersMem4) / arrayMethodMem4 * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n性能提升: 时间 <span class="hljs-subst">${timeImprovement4}</span>%, 内存 <span class="hljs-subst">${memImprovement4}</span>%`</span>);

<span class="hljs-comment">// ============ 总结 ============</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n'</span> + <span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'总结'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'='</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">60</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`
场景 1 (过滤+转换+取前N项):
  时间提升: <span class="hljs-subst">${timeImprovement1}</span>%
  内存提升: <span class="hljs-subst">${memImprovement1}</span>%
  ✅ Iterator Helpers 完胜

场景 2 (嵌套数据扁平化):
  时间提升: <span class="hljs-subst">${timeImprovement2}</span>%
  内存提升: <span class="hljs-subst">${memImprovement2}</span>%
  ✅ Iterator Helpers 完胜

场景 3 (公平对决 Array.find vs Iterator.find):
  头部: Iterator <span class="hljs-subst">${diffHead &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'慢'</span> : <span class="hljs-string">'快'</span>}</span> <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.abs(diffHead)}</span>%
  中部: Iterator <span class="hljs-subst">${diffMiddle &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'慢'</span> : <span class="hljs-string">'快'</span>}</span> <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.abs(diffMiddle)}</span>%
  尾部: Iterator <span class="hljs-subst">${diffTail &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'慢'</span> : <span class="hljs-string">'快'</span>}</span> <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.abs(diffTail)}</span>%
  ⚠️ Array.find() 本身就是惰性的，Iterator.find() 没有优势

场景 4 (复杂链式调用):
  时间提升: <span class="hljs-subst">${timeImprovement4}</span>%
  内存提升: <span class="hljs-subst">${memImprovement4}</span>%
  ✅ Iterator Helpers 完胜

核心结论:
- Iterator Helpers 的优势场景是 filter/map + take(N) 的链式调用
- 对于纯粹的 find，Array.find() 更快
- 不要为了用 Iterator 而用 Iterator，要根据具体场景选择
`</span>);
</code></pre>
<h3 data-id="heading-23">实际运行输出</h3>
<p>在我的环境（Node.js 22+）下，使用 <code>node --expose-gc iterator-helpers-benchmark.js</code> 运行上面的代码，得到以下结果：</p>
<pre><code class="hljs language-matlab" lang="matlab">============================================================
测试场景 <span class="hljs-number">1</span>: 大数据集过滤 + 转换 + 取前 <span class="hljs-number">10</span> 项
数据规模: <span class="hljs-number">100</span>,<span class="hljs-number">000</span> 条
============================================================

传统数组方法 (filter + map + slice) - 时间:
  平均: <span class="hljs-number">1.545</span>ms
  最小: <span class="hljs-number">0.920</span>ms
  最大: <span class="hljs-number">2.993</span>ms
  内存增长: <span class="hljs-number">3.38</span> MB

Iterator Helpers (filter + map + take) - 时间:
  平均: <span class="hljs-number">0.019</span>ms
  最小: <span class="hljs-number">0.003</span>ms
  最大: <span class="hljs-number">0.126</span>ms
  内存增长: <span class="hljs-number">0.01</span> MB

性能提升: 时间 <span class="hljs-number">98.77</span><span class="hljs-comment">%, 内存 99.75%</span>

============================================================
测试场景 <span class="hljs-number">2</span>: 嵌套数据扁平化 + 过滤 + 取前 <span class="hljs-number">20</span> 项
数据规模: <span class="hljs-number">10</span>,<span class="hljs-number">000</span> 个父项，每个包含 <span class="hljs-number">10</span> 个子项
============================================================

传统数组方法 (flatMap + filter + slice) - 时间:
  平均: <span class="hljs-number">3.716</span>ms
  最小: <span class="hljs-number">2.263</span>ms
  最大: <span class="hljs-number">8.936</span>ms
  内存增长: <span class="hljs-number">4.03</span> MB

Iterator Helpers (flatMap + filter + take) - 时间:
  平均: <span class="hljs-number">0.018</span>ms
  最小: <span class="hljs-number">0.004</span>ms
  最大: <span class="hljs-number">0.120</span>ms
  内存增长: <span class="hljs-number">0.01</span> MB

性能提升: 时间 <span class="hljs-number">99.53</span><span class="hljs-comment">%, 内存 99.73%</span>

============================================================
测试场景 <span class="hljs-number">3</span>: 查找第一个匹配项（公平对决：Array.<span class="hljs-built_in">find</span> vs Iterator.<span class="hljs-built_in">find</span>）
数据规模: <span class="hljs-number">1</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> 条
============================================================

--- <span class="hljs-number">3</span>a: 目标在头部（第 <span class="hljs-number">100</span> 个）---

Array.<span class="hljs-built_in">find</span>() - 头部:
  平均: <span class="hljs-number">0.008</span>ms
  最小: <span class="hljs-number">0.001</span>ms
  最大: <span class="hljs-number">0.116</span>ms

Iterator.<span class="hljs-built_in">find</span>() - 头部:
  平均: <span class="hljs-number">0.006</span>ms
  最小: <span class="hljs-number">0.002</span>ms
  最大: <span class="hljs-number">0.076</span>ms
差异: <span class="hljs-number">-22.22</span><span class="hljs-comment">% (Iterator 更快)</span>

--- <span class="hljs-number">3</span>b: 目标在中部（第 <span class="hljs-number">500</span>,<span class="hljs-number">000</span> 个）---

Array.<span class="hljs-built_in">find</span>() - 中部:
  平均: <span class="hljs-number">4.733</span>ms
  最小: <span class="hljs-number">3.506</span>ms
  最大: <span class="hljs-number">10.036</span>ms

Iterator.<span class="hljs-built_in">find</span>() - 中部:
  平均: <span class="hljs-number">7.974</span>ms
  最小: <span class="hljs-number">6.573</span>ms
  最大: <span class="hljs-number">12.761</span>ms
差异: <span class="hljs-number">68.48</span><span class="hljs-comment">% (Iterator 更慢)</span>

--- <span class="hljs-number">3</span>c: 目标在尾部（第 <span class="hljs-number">999</span>,<span class="hljs-number">900</span> 个）---

Array.<span class="hljs-built_in">find</span>() - 尾部:
  平均: <span class="hljs-number">10.779</span>ms
  最小: <span class="hljs-number">7.056</span>ms
  最大: <span class="hljs-number">41.051</span>ms

Iterator.<span class="hljs-built_in">find</span>() - 尾部:
  平均: <span class="hljs-number">14.071</span>ms
  最小: <span class="hljs-number">12.336</span>ms
  最大: <span class="hljs-number">17.287</span>ms
差异: <span class="hljs-number">30.55</span><span class="hljs-comment">% (Iterator 更慢)</span>

结论：Array.<span class="hljs-built_in">find</span>() 本身就是惰性的，Iterator.<span class="hljs-built_in">find</span>() 在大多数情况下更慢

============================================================
测试场景 <span class="hljs-number">4</span>: 复杂链式调用（filter + map + filter + map + take）
数据规模: <span class="hljs-number">50</span>,<span class="hljs-number">000</span> 条
============================================================

传统数组方法 (多次链式调用) - 时间:
  平均: <span class="hljs-number">1.693</span>ms
  最小: <span class="hljs-number">1.062</span>ms
  最大: <span class="hljs-number">4.038</span>ms
  内存增长: <span class="hljs-number">5.32</span> MB

Iterator Helpers (多次链式调用) - 时间:
  平均: <span class="hljs-number">0.019</span>ms
  最小: <span class="hljs-number">0.003</span>ms
  最大: <span class="hljs-number">0.143</span>ms
  内存增长: <span class="hljs-number">0.02</span> MB

性能提升: 时间 <span class="hljs-number">98.87</span><span class="hljs-comment">%, 内存 99.64%</span>

============================================================
总结
============================================================

场景 <span class="hljs-number">1</span> (过滤+转换+取前N项):
  时间提升: <span class="hljs-number">99.55</span><span class="hljs-comment">%</span>
  内存提升: <span class="hljs-number">99.75</span><span class="hljs-comment">%</span>
  ✅ Iterator Helpers 完胜

场景 <span class="hljs-number">2</span> (嵌套数据扁平化):
  时间提升: <span class="hljs-number">99.61</span><span class="hljs-comment">%</span>
  内存提升: <span class="hljs-number">99.69</span><span class="hljs-comment">%</span>
  ✅ Iterator Helpers 完胜

场景 <span class="hljs-number">3</span> (公平对决 Array.<span class="hljs-built_in">find</span> vs Iterator.<span class="hljs-built_in">find</span>):
  头部: Iterator 快 <span class="hljs-number">22.22</span><span class="hljs-comment">%</span>
  中部: Iterator 慢 <span class="hljs-number">68.48</span><span class="hljs-comment">%</span>
  尾部: Iterator 慢 <span class="hljs-number">30.55</span><span class="hljs-comment">%</span>
  ⚠️ Array.<span class="hljs-built_in">find</span>() 本身就是惰性的，Iterator.<span class="hljs-built_in">find</span>() 没有优势

场景 <span class="hljs-number">4</span> (复杂链式调用):
  时间提升: <span class="hljs-number">98.87</span><span class="hljs-comment">%</span>
  内存提升: <span class="hljs-number">99.64</span><span class="hljs-comment">%</span>
  ✅ Iterator Helpers 完胜

核心结论:
- Iterator Helpers 的优势场景是 filter/map + take(N) 的链式调用
- 对于纯粹的 <span class="hljs-built_in">find</span>，Array.<span class="hljs-built_in">find</span>() 更快（因为它本身就是惰性的）
- 不要为了用 Iterator 而用 Iterator，要根据具体场景选择
</code></pre>
<p>从输出可以看到：</p>
<p><strong>场景 1-2、4（filter/map + take 链式调用）</strong>：</p>
<ul>
<li>时间提升：98%+</li>
<li>内存提升：99%+</li>
<li>Iterator Helpers 在时间和空间上都有压倒性优势</li>
</ul>
<p><strong>场景 3（Array.find vs Iterator.find 公平对决）</strong>：</p>
<ul>
<li><strong>头部查找</strong>：Iterator 略快 22%（可能是 V8 优化策略不同）</li>
<li><strong>中部查找</strong>：Iterator 慢 68%</li>
<li><strong>尾部查找</strong>：Iterator 慢 31%</li>
<li><strong>结论</strong>：<code>Array.find()</code> 本身就是惰性的，不需要 Iterator Helpers 来"拯救"</li>
</ul>
<p><strong>关键发现</strong>：</p>
<ol>
<li><strong>内存优势极其明显</strong>：在链式调用场景下，Iterator Helpers 的内存使用只有传统方法的 0.3%</li>
<li><strong>中间数组是大头</strong>：场景 4 创建了 4 个中间数组，占用 5.32 MB；Iterator Helpers 几乎为零</li>
<li><strong>不是所有场景都适用</strong>：单纯的 <code>find</code> 场景，直接用 <code>Array.find()</code> 更好</li>
</ol>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>qwen/gemini/claude - cli 原理学习网站</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e50020ab1f45428cd22e53af91a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479039&amp;x-signature=mLeMahTfJtVbg%2BqASvqt0jD2yrY%3D" alt="coding-cli-guide" loading="lazy"/></p>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul>
<p><strong>VS Code 插件</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fvscode-ai-commit" target="_blank" title="https://github.com/tt-a1i/vscode-ai-commit" ref="nofollow noopener noreferrer">vscode-ai-commit</a> - 一键生成 commit message，支持 Conventional Commits，兼容任何 OpenAI 格式接口</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TINYINT(1) 类型的字段，明明数据存的是 2，为什么查出来是 true]]></title>    <link>https://juejin.cn/post/7596187471774220297</link>    <guid>https://juejin.cn/post/7596187471774220297</guid>    <pubDate>2026-01-19T00:52:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596187471774220297" data-draft-id="7596092713080160292" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TINYINT(1) 类型的字段，明明数据存的是 2，为什么查出来是 true"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2026-01-19T00:52:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青石路"/> <meta itemprop="url" content="https://juejin.cn/user/1999357021005580"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TINYINT(1) 类型的字段，明明数据存的是 2，为什么查出来是 true
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1999357021005580/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青石路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T00:52:58.000Z" title="Mon Jan 19 2026 00:52:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    50
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开心一刻</h2>
<p>大学期间，跟初恋谈了一段刻骨铭心的恋情，因为某些原因，大学毕业后分手了。<br/>
如今大学毕业已经10年，听说她很早就出国了，而我，很早就成的哥了。<br/>
昨天，初恋坐上了我的的车，我一眼就认出了她，她亦如当初模样，而我却满脸沧桑。<br/>
我不敢打招呼，默默的听着她打电话，讲述着国外的种种。<br/>
快到目的地的时候，她放下了电话说：我已经把我这10年的经历都说给你听了，你连句你好都不说吗<br/>
我知道电话那头没有任何人，她是故意说给我听的，我哽咽着颤抖的说到：你好<br/>
她深情的看着我，问道：我们还回得去吗<br/>
我疑惑的望向她，说到：回去？回去可以啊，但得加钱......</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b623cc4f4d84f06a933e9f6a4b78e51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=QDn%2FNDFzanzGJB7jmUEx2reWp5Q%3D" loading="lazy"/></div>
<h2 data-id="heading-1">TINYINT</h2>
<p>关于 <code>TINYINT</code>，我相信大家都知道它，是数据库的一种数据类型，说的详细点，它是数据库的一种数字类型，再详细点，它是数据库的一种整数类型；需要注意的是，它并非 SQL 标准整数类型</p>
<blockquote>
<p>SQL标准整数类型：INTEGER<code>(or</code>INT<code>) and </code>SMALLINT</p>
</blockquote>
<p>而是某些数据库的拓展整数类型，所以并非所有的关系型数据库都支持 TINYINT，支持的数据库类型包括 <code>MySQL</code>、<code>MariaDB</code>、<code>SQL Server</code>；我们基于 <code>MySQL</code> 来看看 TINYINT</p>
<p>MySQL 官方对<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finteger-types.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/integer-types.html" ref="nofollow noopener noreferrer">整数类型</a>有如下介绍</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7954ef6c82c34d06ae98f0a59164fe8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=q9i8Z2QQRplZO6aryTOy%2FlOjkXE%3D" alt="整数类型" loading="lazy"/></div>
<p>除了 <code>TINYINT</code>，MySQL 还拓展出了 <code>MEDIUMINT</code> 和 <code>BIGINT</code>，这些都不是 SQL 标准整数类型，在做不同库数据迁移的时候需要考虑这些点</p>
<blockquote>
<p>标准 SQL，便于迁移；做表设计的时候，尽量用 SQL 标准数据类型</p>
</blockquote>
<p>TINYINT 存储空间占 <strong>1</strong> 字节，有符号的值范围是 -128 到 127，无符号的值范围是 0 到 255</p>
<p>TINYINT 的基本介绍已经完成，下面开始实操环节，开始之前我先问你们一个问题</p>
<blockquote>
<p>在实际项目中，你们一般用 TINYINT 存什么 ？</p>
</blockquote>
<p>是不是用来存枚举值？例如这样</p>
<pre><code class="hljs language-sql" lang="sql">`exec_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'执行-状态，0：等待中，1：执行中，2：成功，3：失败，4：终止'</span>
</code></pre>
<p>甚至在枚举值少的时候，会使用 <code>TINYINT(1)</code>，对不对？重点来了</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e5348d482b9469ba64914a1c843bfe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=EeGdoKagbHqJnHAwcGIzTb46u0s%3D" alt="640 (8)" loading="lazy"/></div>
<p>TINYINT(1) 中的 <code>1</code> 表示什么？很多小伙伴会理所当然的回答道：<strong>数值范围</strong>，TINYINT(1) 表示的是数值范围是 -9 到 9，或者 0 ~ 9</p>
<p>对不对呢？我们验证下就知道了。基于 MySQL 8.0.31，我们创建表</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tbl_qsl_job` (
  `id` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'主键'</span>,
  `exec_status` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'执行-状态，0：等待中，1：执行中，2：成功，3：失败，4：终止'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<p>插入一条记录</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tbl_qsl_job(id, exec_status) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-number">12</span>);
</code></pre>
<p>结果会怎么样，超出范围报错？</p>
<p>实际是插入成功</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d652228759de4797a72222631883d3f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=cjYW02rJt7QiAqQu%2FQPdp1jGI2U%3D" alt="tinyint1_插入12成功" loading="lazy"/></div>
<p>道心是不是碎了一地？</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/026b9f61ec744a0e91584559c5464fb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=4epTKB71cKeeyXpb7DZ9CivnXXg%3D" alt="掀桌子" loading="lazy"/></div>
<p>给你们 10 秒钟，收拾下破碎的道心；收拾好了之后我们一起看看官方说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fnumeric-type-attributes.html" target="_blank" title="https://dev.mysql.com/doc/refman/5.7/en/numeric-type-attributes.html" ref="nofollow noopener noreferrer">Numeric Type Attributes</a></p>
<blockquote>
<p>MySQL supports an extension for optionally specifying the display width of integer data types in parentheses following the base keyword for the type. For example, <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Finteger-types.html" target="_blank" title="https://dev.mysql.com/doc/refman/5.7/en/integer-types.html" ref="nofollow noopener noreferrer"><code>INT(4)</code></a> specifies an <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Finteger-types.html" target="_blank" title="https://dev.mysql.com/doc/refman/5.7/en/integer-types.html" ref="nofollow noopener noreferrer"><code>INT</code></a> with a display width of four digits. This optional display width may be used by applications to display integer values having a width less than the width specified for the column by left-padding them with spaces. (That is, this width is present in the metadata returned with result sets. Whether it is used is up to the application.)</p>
<p>The display width does <em>not</em> constrain the range of values that can be stored in the column. Nor does it prevent values wider than the column display width from being displayed correctly. For example, a column specified as <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Finteger-types.html" target="_blank" title="https://dev.mysql.com/doc/refman/5.7/en/integer-types.html" ref="nofollow noopener noreferrer"><code>SMALLINT(3)</code></a> has the usual <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Finteger-types.html" target="_blank" title="https://dev.mysql.com/doc/refman/5.7/en/integer-types.html" ref="nofollow noopener noreferrer"><code>SMALLINT</code></a> range of <code>-32768</code> to <code>32767</code>, and values outside the range permitted by three digits are displayed in full using more than three digits.</p>
</blockquote>
<p>相信你们都能看懂，INT(n) 中的 n 表示的是显示宽度，INT(4) 表示的是显示宽度为四位数的 INT。应用程序可以采用左填充空格的方式来填充宽度不够列指定宽度的整数值（也就是说，此宽度会作为结果集的元数据返回，是否使用取决于应用程序）</p>
<p>显示宽度不会限制列存储的数值范围，也不会截断比列显示宽度更宽的值。例如，SMALLINT(3) 类型的列的存数范围与 SMALLINT 一样，也是 -32768 到 32767，超出三位数的值会完整显示</p>
<p>关于整数类型显示宽度，我们可以进行如下总结</p>
<blockquote>
<p>类型后面的 n，是显示宽度，表示显示时最少占 n 个字符宽度，既不会限制列存储的数值范围，也不会截断比列显示宽度更宽的值，</p>
<p>显示宽度会作为结果集的元数据返回，是否使用取决于应用程序（这个伏笔，后面会呼应，值得我们留意）</p>
</blockquote>
<h2 data-id="heading-2">2 变 true</h2>
<p>我们把 tbl_qsl_job 中 id = 1 的记录的状态改成 2（因为没有枚举值 12）</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> tbl_qsl_job <span class="hljs-keyword">SET</span> exec_status <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>基于 <code>SpringBoot 2.7.18</code>、<code>spring-jdbc 5.3.31 </code>、<code>HikariCP 4.0.3</code>、<code>mysql-connector-java 8.0.25 </code> 构建查询</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.qsl;

<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;
<span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;
<span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;
<span class="hljs-keyword">import</span> org.springframework.jdbc.support.rowset.SqlRowSet;
<span class="hljs-keyword">import</span> org.springframework.jdbc.support.rowset.SqlRowSetMetaData;

<span class="hljs-keyword">import</span> javax.annotation.Resource;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span> youzb
 */</span>
<span class="hljs-meta">@SpringBootTest(classes = Application.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QslJobTest</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getByJdbcTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SqlRowSet</span> <span class="hljs-variable">sqlRowSet</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForRowSet(<span class="hljs-string">"SELECT * FROM tbl_qsl_job WHERE id = 1"</span>);
        <span class="hljs-type">SqlRowSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> sqlRowSet.getMetaData();
        <span class="hljs-keyword">while</span> (sqlRowSet.next()) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= metaData.getColumnCount(); i++) {
                System.out.print(sqlRowSet.getObject(i) + <span class="hljs-string">" "</span>);
            }
            System.out.println();
        }
    }
}
</code></pre>
<p>你们觉得执行结果是怎样的，是不是 <code>1 2</code> 呢</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/946a8759e5fc4be6a56131afd931d3f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=g9ovozhLhofoiRERGd8fdTI7IRE%3D" alt="2变true" loading="lazy"/></div>
<p>可以看到，结果并不是 <code>1 2</code>，而是 <code>1 true</code>，是不是有点懵？</p>
<blockquote>
<p>明明数据存的是 2，为什么查出来结果是 true？</p>
</blockquote>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70cd22fda54948c89c700fe93addacbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=%2BFKK4Kx1xzTdyL2gq%2F%2BZo7ZogiY%3D" alt="懵" width="200px" loading="lazy"/></div>
<p>首先我们可以确定的是，数据库存储的值是没问题的，因为通过 <code>navicat</code> 查到的结果是 2（也说明 navicat 没有对这个值做特殊转换）</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b373c48e9e5d477993a6a98078bfd186~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=CbsDu47h8Ptwj5m59ajtojQAq%2B4%3D" alt="数据库中值是2" loading="lazy"/></div>
<p>回到我们的程序，数据库中的 2 到程序控制台的 true，经过了那些环节，我们是不是能整理出来？</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f92629d4a794f4b8f328c7d40019476~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=kye7YENjIQLBfUIDTHW5ts%2BIZ4I%3D" alt="数据流转" loading="lazy"/></div>
<p>数据库我们已经确定没问题了，至于是 <code>mysql-connector-java 8.0.25</code>、<code>HikariCP 4.0.3</code>、<code>spring-jdbc 5.3.31</code> 谁做了特殊处理，需要我们进一步排查了；最直接的方式就是 <code>Debug</code> 嘛，断点我已经替你们打好</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a86e8c1ae47d487bb0281e08ee6dcbb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=N%2BMS44D%2FuBYEsNObyRTDSM1%2FjSo%3D" alt="断点debug" loading="lazy"/></div>
<p>此时到了 MySQL JDBC 驱动里面，我们来看一下 <code>this.results</code> 的信息，有几个点值得我们重点关注下</p>
<ol>
<li>
<p>连接元信息</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42179fa302f141a68d4b2483ea0ac2f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=GI%2Bj5JawiVgAWI5bQEB0JnQlXkg%3D" alt="连接元信息" loading="lazy"/></div>
<p>我们配置的连接 url 是</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/fnj_test?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=UTC</span>
</code></pre>
<p>并未设置 <code>tinyint1isBit</code> 值，所以其值 true 是 <code>mysql-connector-java 8.0.25</code> 给的默认值</p>
</li>
<li>
<p>列元信息</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78e230e1eedc4820b837b2f42f976798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=ZWbYE2IzhO4DIyOsqHM1fqCjpEg%3D" alt="列元信息" loading="lazy"/></div>
<p>可以看到，字段 exec_status 的 length = 1，这个 length 表示什么呢，因为列 exec_status 的类型是整数类型，所以这个 length 是不是就是 <code>显示宽度</code> ？不然还能代表什么？</p>
<p>最重要的来了，<code>mysqlType</code> 的 <code>name</code> 是 <code>BIT</code></p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f47f3d55e3cb49db976b36f255c884ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=T9uqKlLsIJkcoPQczZydUPsayuo%3D" alt="mysqltype_bit" loading="lazy"/></div>
<p>也就是说，mysql-connector-java 8.0.25 把 TINYINT(1) 解析成了 MysqlType.BIT，对应的 JAVA 类型就是 <code>Boolean</code></p>
</li>
</ol>
<p>既然 exec_status 的 JAVA 类型被解析成了 Boolean，其值 2 也就被解析成 true 了，所以标题的答案是不是就清楚了</p>
<blockquote>
<p>mysql-connector-java 8.0.25 默认情况下，把 TINYINT(1) 解析成 JAVA 的 Boolean</p>
</blockquote>
<p>问题又来了，mysql-connector-java 8.0.25 对 TINYINT 的解析逻辑是怎样的呢？我们跟下源码就知道了</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe5505a036f14cb5b0dd03e4b41e26e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=20OiEo0WmYoazZUEVVxtNzlKLq4%3D" alt="mysqlType赋值逻辑" loading="lazy"/></div>
<p>我们先定位到 <code>com.mysql.cj.protocol.a.ColumnDefinitionReader</code> 的 180 行，然后往上找到 <code>mysqlType</code> 赋值的地方（ColumnDefinitionReade 134 行）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">MysqlType</span> <span class="hljs-variable">mysqlType</span> <span class="hljs-operator">=</span> NativeProtocol.findMysqlType(<span class="hljs-built_in">this</span>.protocol.getPropertySet(), colType, colFlag, colLength, tableName, originalTableName,
                collationIndex, encoding);
</code></pre>
<p>跟进 NativeProtocol.findMysqlType，我们能看到这样一段代码</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cb7a5a55af446ed838c0ca17642f3ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=As6BklKhZjKOE92eYlxsnhdVRZ4%3D" alt="tinyint赋值逻辑" loading="lazy"/></div>
<p>第一个 if，我们分几部分解析下</p>
<ol>
<li>
<p>isUnsigned</p>
<p>表示是否无符号，建表的时候，exec_status 并未明确指定 <code>UNSIGNED</code>，所以是有符号的，那么 isUnsigned 值是 false，取反则是 true</p>
</li>
<li>
<p>length</p>
<p>表字段的显示宽度，也就是 TINYINT(1) 中的 1，所以 length == 1 的结果是 true</p>
</li>
<li>
<p>tinyInt1isBit</p>
<p>mysql-connector-java 8.0.25 的 <code>PropertyDefinitions</code> 会静态初始化很多属性默认值，其中就包括 tinyInt1isBit</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/706dc20a707e48a3ad5cf1bd835f2dc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=DwCNVumm7SWfOudK9%2BiYHRxfvfk%3D" alt="tinyInt1isBit默认值" loading="lazy"/></div>
<p>tinyInt1isBit 的默认值是 true</p>
<p>如果我们在数据库连接 url 中增加 <code>tinyInt1isBit=false</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/fnj_test?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=UTC&amp;tinyInt1isBit=false</span>
</code></pre>
<p>那么配置值会覆盖默认值</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6fa1f5a3ca43f6ad822597a48f5987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=jsTIbffCe%2B8%2FCT2Hnwi1moGg2%2FM%3D" alt="tinyInt1isBit值覆盖" loading="lazy"/></div>
<pre><code class="hljs language-java" lang="java">setValueInternal(extractedValue, exceptionInterceptor);
<span class="hljs-built_in">this</span>.initialValue = <span class="hljs-built_in">this</span>.value;
</code></pre>
<p>这两行会分别将 <code>value</code> 和 <code>initialValue</code> 设置成 <code>false</code></p>
<p>回到 url 未配置 tinyInt1isBit 的情况，tinyInt1isBit 的值是默认值 true</p>
</li>
<li>
<p>内嵌 if 的 transformedBitIsBoolean</p>
<p>在分析 tinyInt1isBit 默认值的时候，也红框框住过 transformedBitIsBoolean 的默认值，是 false；没注意的小伙伴，可以往上翻一翻</p>
</li>
</ol>
<p>所以 NativeProtocol.findMysqlType 的返回值是 <code>MysqlType.BIT</code>。如果 length &gt; 1，那么返回的则是 <code>MysqlType.TINYINT_UNSIGNED</code> 或 <code>MysqlType.TINYINT</code></p>
<p>自此，来龙去脉是不是清楚呢？</p>
<h2 data-id="heading-3">问题处理</h2>
<p>既然已经找到问题原因，那么处理方式也就清晰了，有如下几种</p>
<ol>
<li>
<p>url 中配置 tinyInt1isBit=false</p>
<p>这个会全局生效，有些需要将 TINYINT(1) 映射成 Boolean 的情况，会出问题</p>
<p>老项目不推荐增加该配置，除非确定整个项目中没有 TINYINT(1) 映射成 Boolean 的情况</p>
<p>新项目的话，可以增加该配置</p>
</li>
<li>
<p>字段类型调整成无符号</p>
<p>增加 <code>UNSIGNED</code> 修饰，例如</p>
<pre><code class="hljs language-sql" lang="sql">`exec_status` tinyint(<span class="hljs-number">1</span>) unsigned <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'执行-状态，0：等待中，1：执行中，2：成功，3：失败，4：终止'</span>,
</code></pre>
<p>但有个前提，枚举值不能出现负数</p>
</li>
<li>
<p>调大字段类型显示宽度</p>
<p>直接使用 TINYINT(4) 或 TINYINT</p>
</li>
</ol>
<h2 data-id="heading-4">举一反三</h2>
<p>既然是 mysql-connector-java 8.0.25 做了默认值的处理，那么 MyBatis-Plus 查的结果是不是也是将 2 处理成 true 呢？我们试一下就知道了，引入 MyBatis-Plus 3.5.7，测试代码很简单</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@TableName("tbl_qsl_job")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QslJob</span> {

    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> Integer execStatus;

    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getExecStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> execStatus;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecStatus</span><span class="hljs-params">(Integer execStatus)</span> {
        <span class="hljs-built_in">this</span>.execStatus = execStatus;
    }
}

	<span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> QslJobDao qslJobDao;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMybatisPlus</span><span class="hljs-params">()</span> {
        <span class="hljs-type">QslJob</span> <span class="hljs-variable">qslJob</span> <span class="hljs-operator">=</span> qslJobDao.selectById(<span class="hljs-number">1</span>);
        System.out.println(qslJob.getId() + <span class="hljs-string">" "</span> + qslJob.getExecStatus());
    }
</code></pre>
<p>你们觉得执行结果是怎样的，报错？输出 1 true？还是输出 1 2？执行下就知道了</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2af4871715734a13a836d862c57ce248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=9c210YipDkrI7Qchi8Yv9ABPQuw%3D" alt="tinyint(1)_mybatis-plus" loading="lazy"/></div>
<p>查询结果正常！</p>
<p>按前面的分析，mysql-connector-java 8.0.25 返回 exec_status 的值是 true，Boolean 强转 Integer 会报错，即使不报错，结果也应该是 1（0 = false，1 = true）嘛，怎么会是 2 呢？</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/729d178a304744fea5fadfc5a276d02b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=cvgpEEJIR7iylo21dzswhLGTIKg%3D" alt="好难 不该学编程的" loading="lazy"/></div>
<p>Debug 下你们就明白了</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6629435ca50b43d5836c5c62eb2e42a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=0Y%2B6qMxeRt2X%2BlF%2FBuDpkaoepIk%3D" alt="mybatis_getInt" loading="lazy"/></div>
<p>Mybatis 需要将 mysql-connector-java 8.0.25 查到的 ResultSet 映射成 QslJob，就需要用到类型处理器；QslJob 实体的 execStatus 是 Integer 类型的，那肯定用 IntegerTypeHandler 进行处理嘛，自然而然就用到 <code>rs.getInt</code> ，查到的结果自然就是 2 了。</p>
<p>我们再回过头去看 <code>SqlRowSet</code>，如果我们用 sqlRowSet.getInt 替换 sqlRowSet.getObject，是不是就行了？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getByJdbcTemplate</span><span class="hljs-params">()</span> {
    <span class="hljs-type">SqlRowSet</span> <span class="hljs-variable">sqlRowSet</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForRowSet(<span class="hljs-string">"SELECT * FROM tbl_qsl_job WHERE id = 1"</span>);
    <span class="hljs-type">SqlRowSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> sqlRowSet.getMetaData();
    <span class="hljs-keyword">while</span> (sqlRowSet.next()) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= metaData.getColumnCount(); i++) {
            System.out.print(sqlRowSet.getInt(i) + <span class="hljs-string">" "</span>);
        }
        System.out.println();
    }
}
</code></pre>
<p>运行下，我们会发现报错了</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a9d4eaad5a6416ea89ae9355bc0084b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=dxSdeAY1aZmFWgCop53BS%2BW%2BBEo%3D" alt="getInt报" loading="lazy"/></div>
<p>这又是为什么？</p>
<p>原因在 JdbcTemplate 的数据提取</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb16964702240f2897f01f5cd114d50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=sTjdZ871MuLbS84H4DP%2BVAlNjfY%3D" alt="extractData" loading="lazy"/></div>
<p>我们对 rs 进行一下 Evaluate，结果如下</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e558d0b785cd43289f037d0761f0f85e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=oXSaEEFkz0Pq4w1WJOLGC2cmhVk%3D" alt="rs_evaluate" loading="lazy"/></div>
<p>此时 rs.getInt 能正常获取到 2，这说明什么？</p>
<blockquote>
<p>mysql-connector-java 8.0.25 虽然把 TINYINT(1) 映射成了 JAVA 的 Boolean，但其查到的 ResultSet 中的数据仍是与数据库中数据一致的原始数据</p>
<p>HikariCP 4.0.3 也并未对原始数据做转换处理</p>
</blockquote>
<p>我们继续跟进 rse.extractData(rs)，跟进两层会来到关键点</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d32fbbb5cec040128fac0d0839d4eeb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=ZcBeNsJdzVxqqJ7269KEEu6JsPQ%3D" alt="cachedRowSet" loading="lazy"/></div>
<p>rowSet.populate(rs) 会把 ResultSet rs 中的数据填充到 CachedRowSetImpl 的 <code>rvh</code> 中</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abe57a4fd36e41b9b0a9f1aef44420e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=HRCUOcMlXhIdLEx%2FGXkiNLIsQVc%3D" alt="rhv" loading="lazy"/></div>
<p>我们接着跟进 sqlRowSet.getInt(i)，答案即将揭晓</p>
<div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ebac53972743d488dffac760c88a7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=aoS1hPdXWHcI%2Bq1BYgHfntVVoC0%3D" alt="getInt_error" loading="lazy"/></div>
<p>红框框住是不是就会抛异常了？我们继续跟进 this.getCurrentRow，会看到我们刚刚讲到的 <code>rvh</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> BaseRow <span class="hljs-title function_">getCurrentRow</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> (BaseRow)(<span class="hljs-built_in">this</span>.onInsertRow ? <span class="hljs-built_in">this</span>.insertRow : (BaseRow)((BaseRow)<span class="hljs-built_in">this</span>.rvh.get(<span class="hljs-built_in">this</span>.cursorPos - <span class="hljs-number">1</span>)));
}
</code></pre>
<p>是不是就呼应上了？这里有两个呼应</p>
<ol>
<li>
<p>显示宽度</p>
<p>前面已经讲到，显示宽度会作为结果集的元数据返回，是否使用取决于应用程序</p>
<p>spring-jdbc 的 SqlRowSetResultSetExtractor#createSqlRowSet 方法用到了 CachedRowSetImpl#populate，在进行数据填充的过程中，会调用</p>
 <div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5e48ef4c7e6428691ca4490e2c2cc2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=I6jf5uuT4GFjRs9SPathozPPOsg%3D" alt="调用myql驱动的getObject" loading="lazy"/></div>
<p>mysql-connector-java 8.0.25 的 ResultSetImpl#getObject(int) 方法</p>
 <div align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed750438659f419cb72eaa354ce67b1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476761&amp;x-signature=yJzBLUi5se4t1cN6jVIY4iuESec%3D" alt="BIT处理" loading="lazy"/></div>
<p>是不是相当于用到了显示宽度？</p>
</li>
<li>
<p>rvh</p>
<p>CachedRowSetImpl#populate 方法，将数据填充到了 Vector rvh 中</p><p/>
<p>而我们写的代码 sqlRowSet.getInt(i) 是从这个 rvh 中获取的</p>


<p>所以，归根结底是 <strong>spring-jdbc 将 ResultSet 处理成 CachedRowSetImpl 的机制，我们没有遵循，才会出现 2 变 true 这种意料之外的结果</strong></p>
<p>SQL Server 的 tinyint 会不会有类似问题呢？我可以肯定的告诉你们，目前不会有，因为 SQL Server 的 tinyint 没有显示宽度一说，就是固定的 <code>tinyint</code>，不支持 <code>tinyint(n)</code>，至于未来是否支持，未来再说嘛</p>
<h2 data-id="heading-5">总结</h2>
<ol>
<li>
<p>MySQL 整数类型后面的 n 是显示宽度，表示显示时最少占 n 个字符宽度，既不会限制列存储的数值范围，也不会截断比列显示宽度更宽的值</p>
</li>
<li>
<p>MySQL 会把显示宽度作为结果集的元数据返回，所以 mysql-connector-java 8.0.25 能获取到</p>
</li>
<li>
<p>mysql-connector-java 8.0.25 虽然有显示宽度，也提供了间接用到显示宽度的getObject方法，但其 ResultSet 中的数据与数据库中的数据是一致的</p>
<p>至于上层应用如何使用 mysql-connector-java 8.0.25 中的元数据，由上层应用决定；spring-jdbc 就是上层应用之一、MyBatis 也是</p>
</li>
<li>
<p>spring-jdbc 的 JdbcTemplate.queryForRowSet 会间接使用显示宽度，而 Mybatis 不会，MyBatis 有类型处理器</p>
</li>
<li>
<p>如何避免标题中的问题，文中的 <strong>问题处理</strong> 章节已经说明，推荐第三种方式</p>
<blockquote>
<p>不使用 TINYINT(1)，直接使用 TINYINT(4) 或 TINYINT</p>
</blockquote>
</li>
</ol></li></ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[像 ChatGPT 一样丝滑：Spring Boot 如何实现大模型流式（Streaming）响应？]]></title>    <link>https://juejin.cn/post/7596488155302314003</link>    <guid>https://juejin.cn/post/7596488155302314003</guid>    <pubDate>2026-01-18T23:56:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596488155302314003" data-draft-id="7596221097865248774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="像 ChatGPT 一样丝滑：Spring Boot 如何实现大模型流式（Streaming）响应？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-18T23:56:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            像 ChatGPT 一样丝滑：Spring Boot 如何实现大模型流式（Streaming）响应？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-18T23:56:54.000Z" title="Sun Jan 18 2026 23:56:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    41
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么需要流式响应？</h2>
<p>同样的 HTTP 请求，为什么像 ChatGPT 这类模型的回答能像打字机一样逐字输出，而我们平时写的接口却要等全部处理完才返回？</p>
<p>问题的核心在于 <strong>响应模式</strong>：</p>





















<table><thead><tr><th>传统模式</th><th>流式模式</th></tr></thead><tbody><tr><td>服务器处理完成 → 一次性返回</td><td>生成一部分 → 立即推送</td></tr><tr><td>客户端等待总时长 = 服务器处理时间</td><td>客户端首字等待时间通常很短</td></tr><tr><td>适合快速查询</td><td>适合耗时生成</td></tr></tbody></table>
<p>对于大模型这种 <strong>生成式 AI</strong>，一个响应可能需要几秒甚至几十秒。如果用传统模式，用户体验就是：</p>
<pre><code class="hljs language-scss" lang="scss">提问 → (<span class="hljs-number">10</span>秒空白) → 答案全部出现
</code></pre>
<p>而流式响应的体验是：</p>
<pre><code class="hljs language-arduino" lang="arduino">提问 → <span class="hljs-number">0.1</span>秒后 → <span class="hljs-string">"我"</span> → <span class="hljs-string">"认"</span> → <span class="hljs-string">"为"</span> → ... → 逐字呈现
</code></pre>
<p>实现这种效果有多种技术方案，本文将介绍基于 Spring Boot WebFlux + SSE 的实现方式。</p>
<h2 data-id="heading-1">二、核心技术选型</h2>
<p>实现流式响应主要有以下几种方案：</p>





























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SSE</strong></td><td>单向推送、HTTP协议、实现简单</td><td>不支持双向通信</td><td>服务端主动推送</td></tr><tr><td><strong>WebSocket</strong></td><td>双向通信、实时性强</td><td>实现复杂、需要额外协议</td><td>聊天、游戏</td></tr><tr><td><strong>长轮询</strong></td><td>兼容性好</td><td>资源消耗大</td><td>低频数据更新</td></tr></tbody></table>
<p><strong>本文选择 SSE 方案</strong>，原因如下：</p>
<ul>
<li>Spring Boot 原生支持 <code>ResponseEntity&lt;Flux&lt;String&gt;&gt;</code></li>
<li>基于标准 HTTP，无需额外协议协商</li>
<li>代码简洁，易于理解和维护</li>
</ul>
<h2 data-id="heading-2">三、项目依赖配置</h2>
<h4 data-id="heading-3">3.1 Maven 依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0
         https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot-chat-stream<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Spring Boot WebFlux：响应式编程支持 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Lombok：简化代码 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">3.2 关键依赖说明</h4>
<p><strong>spring-boot-starter-webflux</strong>：提供响应式 Web 支持，核心是 Reactor 的 <code>Flux</code> 类型</p>
<p><strong>Reactor</strong>：响应式编程库，<code>Flux&lt;T&gt;</code> 表示 0-N 个元素的异步序列</p>
<h2 data-id="heading-5">四、核心代码实现</h2>
<h4 data-id="heading-6">4.1 Controller 层：流式响应入口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.chat.controller;

<span class="hljs-keyword">import</span> com.example.chat.service.StreamChatService;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.http.MediaType;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/chat")</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@CrossOrigin(origins = "*")</span> <span class="hljs-comment">// 开发环境允许跨域</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamChatController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StreamChatService chatService;

    <span class="hljs-comment">/**
     * 流式聊天接口
     * <span class="hljs-doctag">@param</span> prompt 用户输入的问题
     * <span class="hljs-doctag">@return</span> 流式响应，text/event-stream 格式
     */</span>
    <span class="hljs-meta">@GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Flux&lt;String&gt;&gt; <span class="hljs-title function_">streamChat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String prompt)</span> {
        <span class="hljs-keyword">return</span> ResponseEntity.ok()
                .header(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"no-cache"</span>)
                .header(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>)
                .body(chatService.streamResponse(prompt));
    }
}
</code></pre>
<p><strong>关键点解析：</strong></p>
<ol>
<li><code>produces = MediaType.TEXT_EVENT_STREAM_VALUE</code>：声明返回 SSE 格式</li>
<li><code>Flux&lt;String&gt;</code>：响应式流，可以发送多个数据块</li>
<li><code>Cache-Control: no-cache</code>：禁用缓存，确保实时推送</li>
</ol>
<h4 data-id="heading-7">4.2 Service 层：模拟大模型流式生成</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.chat.service;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> java.time.Duration;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamChatService</span> {

    <span class="hljs-comment">/**
     * 模拟大模型流式生成响应
     * <span class="hljs-doctag">@param</span> prompt 用户问题
     * <span class="hljs-doctag">@return</span> 按字符/词汇流式输出的响应
     */</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">streamResponse</span><span class="hljs-params">(String prompt)</span> {
        log.info(<span class="hljs-string">"收到用户提问: {}"</span>, prompt);

        <span class="hljs-comment">// 模拟大模型生成的回复内容</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> mockLLMResponse(prompt);

        <span class="hljs-comment">// 将响应拆分为字符流，每 50ms 发送一个字符</span>
        <span class="hljs-keyword">return</span> Flux.fromArray(response.split(<span class="hljs-string">""</span>))
                .delayElements(Duration.ofMillis(<span class="hljs-number">50</span>))
                .doOnNext(chunk -&gt; log.debug(<span class="hljs-string">"发送数据块: {}"</span>, chunk))
                .doOnComplete(() -&gt; log.info(<span class="hljs-string">"流式响应完成"</span>))
                .doOnError(e -&gt; log.error(<span class="hljs-string">"流式响应异常"</span>, e));
    }

    <span class="hljs-comment">/**
     * 模拟大模型生成内容（实际项目可接入 OpenAI/通义千问等）
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">mockLLMResponse</span><span class="hljs-params">(String prompt)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"""
                【Spring Boot 流式响应】
                您的问题是：%s

                这是一个模拟大模型流式输出的示例。
                在实际应用中，你可以：
                1. 接入 OpenAI API 使用 GPT-4
                2. 接入阿里云通义千问 API
                3. 接入本地部署的大模型

                流式响应的核心是：
                - 使用 Spring WebFlux 的 Flux
                - 返回 text/event-stream 格式
                - 前端使用 EventSource 或 fetch 接收

                这样就能实现像 ChatGPT 一样的丝滑体验！
                """</span>.formatted(prompt);
    }
}
</code></pre>
<p><strong>核心逻辑：</strong></p>
<ol>
<li><code>Flux.fromArray(response.split(""))</code>：将字符串拆分为字符数组转为流</li>
<li><code>.delayElements(Duration.ofMillis(50))</code>：每个字符延迟 50ms 发送</li>
<li><code>.doOnNext()/.doOnComplete()/.doOnError()</code>：生命周期钩子，用于日志记录</li>
</ol>
<h4 data-id="heading-8">4.3 接入真实大模型 API（扩展）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 接入 OpenAI Streaming API 的示例（伪代码）</span>
<span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">streamOpenAI</span><span class="hljs-params">(String prompt)</span> {
    <span class="hljs-type">WebClient</span> <span class="hljs-variable">webClient</span> <span class="hljs-operator">=</span> WebClient.builder()
            .baseUrl(<span class="hljs-string">"https://api.openai.com/v1"</span>)
            .defaultHeader(HttpHeaders.AUTHORIZATION, <span class="hljs-string">"Bearer YOUR_API_KEY"</span>)
            .build();

    <span class="hljs-keyword">return</span> webClient.post()
            .uri(<span class="hljs-string">"/chat/completions"</span>)
            .bodyValue(Map.of(
                <span class="hljs-string">"model"</span>, <span class="hljs-string">"gpt-4"</span>,
                <span class="hljs-string">"messages"</span>, List.of(Map.of(<span class="hljs-string">"role"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>, prompt)),
                <span class="hljs-string">"stream"</span>, <span class="hljs-literal">true</span>
            ))
            .retrieve()
            .bodyToFlux(String.class)
            .map(<span class="hljs-built_in">this</span>::extractContentFromSSE); <span class="hljs-comment">// 解析 SSE 格式提取 content</span>
}
</code></pre>
<h4 data-id="heading-9">4.4 启动类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.chat;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatStreamApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(ChatStreamApplication.class, args);
    }
}
</code></pre>
<h4 data-id="heading-10">4.5 配置文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">chat-stream-demo</span>

<span class="hljs-comment"># 日志配置</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">com.example.chat:</span> <span class="hljs-string">DEBUG</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">五、前端对接示例</h2>
<h4 data-id="heading-12">5.1 使用 EventSource 接收流</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Spring Boot 流式响应示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: Arial; <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-id">#output</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f9f9f9</span>; }
        <span class="hljs-selector-tag">input</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">70%</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; }
        <span class="hljs-selector-tag">button</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>; <span class="hljs-attribute">cursor</span>: pointer; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Spring Boot 流式聊天<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"prompt"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入问题..."</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendQuestion()"</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendQuestion</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> prompt = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'prompt'</span>).<span class="hljs-property">value</span>;
            <span class="hljs-keyword">const</span> output = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>);
            output.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'等待响应...'</span>;

            <span class="hljs-comment">// 使用 EventSource 接收 SSE 流</span>
            <span class="hljs-keyword">const</span> eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(
                <span class="hljs-string">`/api/chat/stream?prompt=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(prompt)}</span>`</span>
            );

            eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
                output.<span class="hljs-property">innerHTML</span> += event.<span class="hljs-property">data</span>;
            };

            eventSource.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
                eventSource.<span class="hljs-title function_">close</span>();
                output.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">'&lt;br&gt;&lt;br&gt;[连接关闭]'</span>;
            };

            <span class="hljs-comment">// 30秒后自动关闭（演示用）</span>
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> eventSource.<span class="hljs-title function_">close</span>(), <span class="hljs-number">30000</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">5.2 使用 Fetch API（推荐）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamChat</span>(<span class="hljs-params">prompt</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/chat/stream?prompt=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(prompt)}</span>`</span>);
    <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
    <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
        <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到数据:'</span>, chunk);
        <span class="hljs-comment">// 更新 UI</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-14">六、运行效果</h2>
<p>启动项目后，访问 <code>http://localhost:8080</code>（需添加静态页面支持），输入问题，你会看到：</p>
<pre><code class="hljs language-erlang" lang="erlang">【Spring Boot 流式响应】
您的问题是：如何学习 Spring Boot？

这是一个模拟大模型流式输出的示例。
...
</code></pre>
<p>文字像打字机一样逐字出现，体验丝滑！</p>
<h2 data-id="heading-15">七、总结</h2>
<p>本文介绍了如何使用 Spring Boot WebFlux 实现 SSE 流式响应。核心是通过 <code>Flux&lt;String&gt;</code> + <code>TEXT_EVENT_STREAM_VALUE</code> 将数据分块推送，配合前端 <code>EventSource</code> 实现逐字显示效果。相比传统一次性返回，流式响应能显著降低用户等待感知，特别适合大模型对话等耗时生成场景。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-chat-stream
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【LeetCode 刷题系列 | 第 1 篇】前端老司机拆解接雨水问题，从暴力到最优解💦]]></title>    <link>https://juejin.cn/post/7596241980870017058</link>    <guid>https://juejin.cn/post/7596241980870017058</guid>    <pubDate>2026-01-19T01:56:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596241980870017058" data-draft-id="7564307224267538447" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LeetCode 刷题系列 | 第 1 篇】前端老司机拆解接雨水问题，从暴力到最优解💦"/> <meta itemprop="keywords" content="前端,面试,算法"/> <meta itemprop="datePublished" content="2026-01-19T01:56:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秋天的一阵风"/> <meta itemprop="url" content="https://juejin.cn/user/3588413946594925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LeetCode 刷题系列 | 第 1 篇】前端老司机拆解接雨水问题，从暴力到最优解💦
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3588413946594925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秋天的一阵风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T01:56:42.000Z" title="Mon Jan 19 2026 01:56:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌧️ 前言</h2>
<p><strong/></p><p align="center"><strong>Hello~大家好。我是秋天的一阵风</strong></p><p/>
<p>欢迎来到我的 LeetCode 刷题系列专栏～ 作为一名深耕前端多年的老司机，我深知算法能力对前端工程师的重要性 —— 它不仅能帮我们在面试中脱颖而出，更能提升日常业务代码的逻辑严谨性和性能优化能力。</p>
<p>今天咱们要攻克的是 <strong>LeetCode 中的经典 hard 题「接雨水」</strong>，这道题堪称 “面试高频钉子户”，考察的核心是对数组遍历和边界判断的理解。</p>
<p>很多同学一开始会被它唬住，但只要咱们从基础思路慢慢拆解，再逐步优化，就能轻松拿捏！话不多说，咱们直奔主题～</p>
<h2 data-id="heading-1">一、LeetCode 接雨水题目详情</h2>
<h3 data-id="heading-2">1. 题目描述</h3>
<p>给定 n 个非负整数表示每个宽度为 1 的柱子的高度图，计算按此排列的柱子，下雨之后能接多少雨水。</p>
<p><strong>题目链接</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ftrapping-rain-water%2F" target="_blank" title="https://leetcode.cn/problems/trapping-rain-water/" ref="nofollow noopener noreferrer">42.</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ftrapping-rain-water%2F" target="_blank" title="https://leetcode.cn/problems/trapping-rain-water/" ref="nofollow noopener noreferrer"> 接雨水</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ftrapping-rain-water%2F" target="_blank" title="https://leetcode.cn/problems/trapping-rain-water/" ref="nofollow noopener noreferrer"> - 力扣（</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ftrapping-rain-water%2F" target="_blank" title="https://leetcode.cn/problems/trapping-rain-water/" ref="nofollow noopener noreferrer">LeetC</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ftrapping-rain-water%2F" target="_blank" title="https://leetcode.cn/problems/trapping-rain-water/" ref="nofollow noopener noreferrer">ode）</a></p>
<h3 data-id="heading-3">2. 示例演示</h3>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ec78c89e89d4b6a9b77daf1efa37754~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769393009&amp;x-signature=a8gDnkLeie50qq56hbVDkhq96lc%3D" alt="image.png" width="100%" loading="lazy"/>
<ul>
<li>输入：height = [0,1,0,2,1,0,1,3,2,1,2,1]</li>
</ul>

<ul>
<li>输出：6</li>
</ul>

<ul>
<li>解释：如题目中的高度图所示，下雨后能接住 6 单位的雨水。</li>
</ul>

<ul>
<li>输入：height = [4,2,0,3,2,5]</li>
</ul>

<ul>
<li>输出：9</li>
</ul>
<h3 data-id="heading-4">3. 难度级别</h3>
<p>🔴 困难：这道题之所以被归为困难，是因为它需要突破常规的遍历思维，从 “局部最优” 推导 “全局最优”。但只要掌握了核心逻辑，它其实是一道 “纸老虎” 题～</p>
<h2 data-id="heading-5">二、解题思路大剖析</h2>
<h3 data-id="heading-6">1. 暴力解法：直捣黄龙的基础思路</h3>
<p>暴力解法的核心逻辑很朴素：<strong>逐个计算每个柱子能接的雨水量，最后求和</strong>。而一个柱子能接多少水，完全取决于它左右两侧的 “最高屏障”—— 也就是左右两侧最高柱子中较矮的那一个，<strong>用这个较矮值减去当前柱子的高度，就是该位置能接的水量</strong>（若结果为负，则接 0 水）。</p>
<h4 data-id="heading-7">核心步骤拆解：</h4>
<ol>
<li>遍历数组中的每一个柱子（索引从 0 到 n-1）；</li>
</ol>

<ol start="2">
<li>对当前柱子 i，向左遍历所有柱子，找到左侧的最高高度<code>leftMax</code>；</li>
</ol>

<ol start="3">
<li>对当前柱子 i，向右遍历所有柱子，找到右侧的最高高度 <code>rightMax</code>；</li>
</ol>

<ol start="4">
<li>计算当前柱子的接水量：<code>Math.max(0, Math.min(leftMax, rightMax) - height[i])；</code></li>
</ol>

<ol start="5">
<li>累加所有柱子的接水量，得到总水量。</li>
</ol>
<h4 data-id="heading-8">分步拆解演示（以输入 [0,1,0,2,1,0,1,3,2,1,2,1] 为例）：</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ec78c89e89d4b6a9b77daf1efa37754~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769393009&amp;x-signature=a8gDnkLeie50qq56hbVDkhq96lc%3D" alt="image.png" width="100%" loading="lazy"/>
<p>咱们逐个扒开每个位置的接水逻辑，从索引 0 开始：</p>
<ul>
<li><strong>索引 0</strong>：左侧没有柱子，leftMax=0；右侧最高柱子高度是 3。min(0,3)=0，接水量 0-0=0；</li>
</ul>

<ul>
<li><strong>索引 1</strong>：左侧最高是 0，右侧最高是 3。min(0,3)=0，接水量 0-1=-1，取 0；</li>
</ul>

<ul>
<li><strong>索引 2</strong>：左侧遍历 [0,1]，最高是 1；右侧遍历 [2,1,0,1,3,2,1,2,1]，最高是 3。min(1,3)=1，接水量 1-0=1；</li>
</ul>

<ul>
<li><strong>索引 3</strong>：左侧最高是 1，右侧最高是 3。min(1,3)=1，接水量 1-2=-1，取 0；</li>
</ul>

<ul>
<li><strong>索引 4</strong>：左侧最高是 2，右侧最高是 3。min(2,3)=2，接水量 2-1=1；</li>
</ul>

<ul>
<li><strong>索引 5</strong>：左侧最高是 2，右侧最高是 3。min(2,3)=2，接水量 2-0=2；</li>
</ul>

<ul>
<li><strong>索引 6</strong>：左侧最高是 2，右侧最高是 3。min(2,3)=2，接水量 2-1=1；</li>
</ul>

<ul>
<li><strong>索引 7</strong>：左侧最高是 2，右侧最高是 2。min(2,2)=2，接水量 2-2=0;</li>
</ul>

<ul>
<li><strong>索引 8</strong>：左侧最高是 3，右侧最高是 2。min(3,2)=2，接水量 2-2=0；</li>
</ul>

<ul>
<li><strong>索引 9</strong>：左侧最高是 3，右侧最高是 2。min(3,2)=2，接水量 2-1=1；</li>
</ul>

<ul>
<li><strong>索引 10</strong>：左侧最高是 3，右侧最高是 1。min(3,1)=1，接水量 1-2=-1，取 0；</li>
</ul>

<ul>
<li><strong>索引 11</strong>：右侧没有柱子，接水量 0；</li>
</ul>
<p>把这些有效接水量相加：<code>1+1+2+1+1=6</code>，和示例输出一致！</p>
<h4 data-id="heading-9">JavaScript 代码实现（暴力解法）：</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">height</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
 */</span>
<span class="hljs-keyword">var</span> trap = <span class="hljs-keyword">function</span>(<span class="hljs-params">height</span>) {
    <span class="hljs-keyword">const</span> n = height.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span>; <span class="hljs-comment">// 总接水量</span>
    <span class="hljs-comment">// 遍历每个柱子（除了首尾也可以，但不影响结果，代码更简洁）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
        <span class="hljs-keyword">let</span> leftMax = <span class="hljs-number">0</span>; <span class="hljs-comment">// 左侧最高柱子高度</span>
        <span class="hljs-keyword">let</span> rightMax = <span class="hljs-number">0</span>; <span class="hljs-comment">// 右侧最高柱子高度</span>
        <span class="hljs-comment">// 向左遍历，找左侧最高</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = i; j &gt;= <span class="hljs-number">0</span>; j--) {
            leftMax = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(leftMax, height[j]);
        }
        <span class="hljs-comment">// 向右遍历，找右侧最高</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = i; j &lt; n; j++) {
            rightMax = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(rightMax, height[j]);
        }
        <span class="hljs-comment">// 计算当前柱子的接水量，累加到总水量</span>
        total += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(leftMax, rightMax) - height[i];
    }
    <span class="hljs-keyword">return</span> total;
};
<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">trap</span>([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>])); <span class="hljs-comment">// 输出6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">trap</span>([<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>])); <span class="hljs-comment">// 输出9</span>
</code></pre>
<h4 data-id="heading-10">暴力解法的优缺点：</h4>
<ul>
<li>优点：思路简单直观，容易理解，适合作为入门思路；</li>
</ul>

<ul>
<li>缺点：时间复杂度极高，为 O (n²)（每个柱子都要左右遍历一次），当 n 较大时（比如 10^4）会直接超时，不适合实际面试场景。</li>
</ul>
<h3 data-id="heading-11">2. 双指针解法：空间优化的最优思路</h3>
<p>暴力解法的问题在于 “重复遍历”，双指针的核心是<strong>利用左右两侧的最大值关系，在一次遍历中完成计算</strong>，把时间复杂度降到 O (n)，空间复杂度优化到 O (1)。</p>
<h4 data-id="heading-12">核心原理：</h4>
<ul>
<li>定义左右指针 left（初始 0）和 right（初始 n-1）；</li>
</ul>

<ul>
<li>定义 leftMax（左侧已遍历的最高高度）和 rightMax（右侧已遍历的最高高度）；</li>
</ul>

<ul>
<li>当 height[left] &lt;= height[right] 时，左侧的最大值 leftMax 决定了当前 left 位置的接水量（因为右侧有更高的柱子兜底）；</li>
</ul>

<ul>
<li>反之，右侧的最大值 rightMax 决定当前 right 位置的接水量；</li>
</ul>

<ul>
<li><strong>遍历过程中不断更新 leftMax、rightMax 和总水量，直到指针相遇。</strong></li>
</ul>
<h4 data-id="heading-13">JavaScript 代码实现（双指针解法）：</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">height</span>
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">number</span>}
 */</span>
<span class="hljs-keyword">var</span> trap = <span class="hljs-keyword">function</span>(<span class="hljs-params">height</span>) {
    <span class="hljs-keyword">const</span> n = height.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 少于3个柱子无法接水</span>
    <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>, right = n - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">let</span> leftMax = <span class="hljs-number">0</span>, rightMax = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (left &lt; right) {
        <span class="hljs-comment">// 左侧柱子更矮，以leftMax为基准</span>
        <span class="hljs-keyword">if</span> (height[left] &lt;= height[right]) {
            <span class="hljs-keyword">if</span> (height[left] &gt;= leftMax) {
                leftMax = height[left]; <span class="hljs-comment">// 更新左侧最高</span>
            } <span class="hljs-keyword">else</span> {
                total += leftMax - height[left]; <span class="hljs-comment">// 计算当前位置接水量</span>
            }
            left++; <span class="hljs-comment">// 左指针右移</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 右侧柱子更矮，以rightMax为基准</span>
            <span class="hljs-keyword">if</span> (height[right] &gt;= rightMax) {
                rightMax = height[right]; <span class="hljs-comment">// 更新右侧最高</span>
            } <span class="hljs-keyword">else</span> {
                total += rightMax - height[right]; <span class="hljs-comment">// 计算当前位置接水量</span>
            }
            right--; <span class="hljs-comment">// 右指针左移</span>
        }
    }
    <span class="hljs-keyword">return</span> total;
};
<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">trap</span>([<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>])); <span class="hljs-comment">// 输出6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">trap</span>([<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>])); <span class="hljs-comment">// 输出9</span>
</code></pre>
<h2 data-id="heading-14">三、复杂度分析</h2>
<h3 data-id="heading-15">1. 时间复杂度</h3>
<ul>
<li>暴力解法：O (n²)，双层循环导致重复遍历；</li>
</ul>

<ul>
<li>双指针解法：O (n)，一次遍历完成所有计算；</li>
</ul>
<h3 data-id="heading-16">2. 空间复杂度</h3>
<ul>
<li>暴力解法：O (1)，仅使用常数级额外空间；</li>
</ul>

<ul>
<li>双指针解法：O (1)，同样仅使用常数级额外空间；</li>
</ul>
<h2 data-id="heading-17">总结</h2>
<p>好啦，今天的接雨水问题就讲到这里！相信大家已经对这道题的各种解法了如指掌。如果你有更优的思路，或者在刷题过程中遇到了疑问，欢迎在评论区留言讨论～</p>
<p>下一篇专栏，咱们将攻克另一道前端面试高频题，猜猜是什么？关注我，刷题不迷路！咱们下期再见～ 👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python数据处理提速50%！5个Pandas黑科技你用过几个？]]></title>    <link>https://juejin.cn/post/7596260777662791695</link>    <guid>https://juejin.cn/post/7596260777662791695</guid>    <pubDate>2026-01-19T04:18:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596260777662791695" data-draft-id="7596507469883637775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python数据处理提速50%！5个Pandas黑科技你用过几个？"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-19T04:18:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python数据处理提速50%！5个Pandas黑科技你用过几个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T04:18:14.000Z" title="Mon Jan 19 2026 04:18:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python数据处理提速50%！5个Pandas黑科技你用过几个？</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在数据科学和数据分析领域，Pandas无疑是Python生态中最受欢迎的数据处理库之一。然而，随着数据量的增长，许多开发者发现Pandas的性能逐渐成为瓶颈。据统计，80%的数据分析时间都花在了数据清洗和预处理上。如何优化Pandas操作，实现数据处理效率的显著提升？本文将揭示5个经过验证的Pandas高级技巧，这些技术在实际项目中可将数据处理速度提升高达50%，甚至更多。</p>
<h2 data-id="heading-2">1. 向量化操作替代循环</h2>
<h3 data-id="heading-3">问题背景</h3>
<p>新手最常见的性能陷阱是使用Python原生循环（如<code>for</code>循环）来处理DataFrame中的数据。由于Pandas是基于NumPy构建的，每次循环都会产生额外的类型检查和函数调用开销。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>利用NumPy的向量化操作：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 低效方式</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(df)):
    df.loc[i, <span class="hljs-string">'new_col'</span>] = df.loc[i, <span class="hljs-string">'col1'</span>] * df.loc[i, <span class="hljs-string">'col2'</span>]

<span class="hljs-comment"># 高效方式（提速100倍以上）</span>
df[<span class="hljs-string">'new_col'</span>] = df[<span class="hljs-string">'col1'</span>] * df[<span class="hljs-string">'col2'</span>]
</code></pre>
<h3 data-id="heading-5">进阶技巧</h3>
<p>对于复杂逻辑，可以使用<code>np.where()</code>或<code>np.select()</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

conditions = [df[<span class="hljs-string">'score'</span>] &gt;= <span class="hljs-number">90</span>, df[<span class="hljs-string">'score'</span>] &gt;= <span class="hljs-number">80</span>]
choices = [<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>]
df[<span class="hljs-string">'grade'</span>] = np.select(conditions, choices, default=<span class="hljs-string">'C'</span>)
</code></pre>
<h2 data-id="heading-6">2. eval()与query()的高效查询</h2>
<h3 data-id="heading-7">性能原理</h3>
<p><code>pd.eval()</code>和<code>DataFrame.query()</code>使用Numexpr引擎在底层进行优化，可以避免中间变量的创建，特别适用于大型数据集。</p>
<h3 data-id="heading-8">实测对比</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统方式（内存占用高）</span>
mask = (df[<span class="hljs-string">'col1'</span>] &gt; <span class="hljs-number">0.5</span>) &amp; (df[<span class="hljs-string">'col2'</span>].isin([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]))
result = df[mask]

<span class="hljs-comment"># eval优化（内存减少40%）</span>
result = df.<span class="hljs-built_in">eval</span>(<span class="hljs-string">"col1 &gt; 0.5 and col2 in [1,2,3]"</span>)

<span class="hljs-comment"># query语法更简洁</span>
result = df.query(<span class="hljs-string">"col1 &gt; 0.5 and col2 in [1,2,3]"</span>)
</code></pre>
<h3 data-id="heading-9">适用场景</h3>
<ul>
<li>DataFrame列数 &gt;50时优势明显</li>
<li>复杂布尔运算条件超过3个时</li>
</ul>
<h2 data-id="heading-10">3. category类型的智能应用</h2>
<h3 data-id="heading-11">内存优化原理</h3>
<p>对于低基数（low-cardinality）列（如性别、国家代码等），将object类型转换为category类型可节省多达95%的内存。</p>
<h3 data-id="heading-12">实际操作示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 查看当前内存使用情况</span>
df.info(memory_usage=<span class="hljs-string">'deep'</span>)

<span class="hljs-comment"># 转换category类型</span>
cat_cols = [<span class="hljs-string">'gender'</span>, <span class="hljs-string">'country_code'</span>, <span class="hljs-string">'product_type'</span>]
df[cat_cols] = df[cat_cols].astype(<span class="hljs-string">'category'</span>)

<span class="hljs-comment"># groupby操作加速30%-70%</span>
df.groupby(<span class="hljs-string">'product_type'</span>).mean()
</code></pre>
<h3 data-id="heading-13">Pro Tip：</h3>
<p>设置有序分类可进一步提升排序性能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pandas.api.types <span class="hljs-keyword">import</span> CategoricalDtype

cat_type = CategoricalDtype(
    categories=[<span class="hljs-string">'low'</span>, <span class="hljs-string">'medium'</span>, <span class="hljs-string">'high'</span>],
    ordered=<span class="hljs-literal">True</span>)
df[<span class="hljs-string">'priority'</span>] = df[<span class="hljs-string">'priority'</span>].astype(cat_type)
</code></pre>
<h2 data-id="heading-14">4. merge vs join vs concat的选择艺术</h2>
<p>不同合并操作的性能差异可达10倍：</p>

























<table><thead><tr><th>Operation</th><th>Best For</th><th>Time Complexity</th></tr></thead><tbody><tr><td>merge</td><td>SQL风格连接</td><td>O(n log n)</td></tr><tr><td>join</td><td>index对齐</td><td>O(1)</td></tr><tr><td>concat</td><td>简单堆叠</td><td>O(n)</td></tr></tbody></table>
<h3 data-id="heading-15">merge优化技巧：</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Bad - how参数默认值可能触发笛卡尔积计算速度慢100倍 </span>
pd.merge(left_df, right_df)

<span class="hljs-comment"># Good - </span>
pd.merge(left_df, right_df,
         on=<span class="hljs-string">'key'</span>,
         validate=<span class="hljs-string">'one_to_one'</span>) <span class="hljs-comment">#添加约束检查防止意外笛卡尔积</span>
    
<span class="hljs-comment"># Better - sort=False提速25%</span>
pd.merge(left_df.sort_values(<span class="hljs-string">'key'</span>), 
         right_df.sort_values(<span class="hljs-string">'key'</span>),
         on=<span class="hljs-string">'key'</span>,
         sort=<span class="hljs-literal">False</span>)
</code></pre>
<h2 data-id="heading-16">Numba加速数值计算</h2>
<p>对于无法向量化的复杂计算，Numba可以带来惊人的加速效果：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> jit

<span class="hljs-meta">@jit(<span class="hljs-params">nopython=<span class="hljs-literal">True</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">complex_calculation</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-comment"># Some complex logic that can't be vectorized...</span>
    <span class="hljs-keyword">return</span> result
    
df[<span class="hljs-string">'result'</span>] = complex_calculation(df[<span class="hljs-string">'a'</span>].values, df[<span class="hljs-string">'b'</span>].values)
</code></pre>
<p>测试案例：蒙特卡洛模拟速度提升200倍！</p>
<h2 data-id="heading-17">Chunk Processing处理超大数据集</h2>
<p>当数据量超过内存容量时：</p>
<pre><code class="hljs language-python" lang="python">chunk_size = <span class="hljs-built_in">int</span>(<span class="hljs-number">1e6</span>) <span class="hljs-comment"># ~100MB chunks适合大多数机器内存配置 </span>
results = []

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> pd.read_csv(<span class="hljs-string">'huge_file.csv.gz'</span>,
                         chunksize=chunk_size,
                         dtype=optimized_dtypes):
    processed_chunk = process(chunk)
    results.append(processed_chunk)

final_result = pd.concat(results)    
</code></pre>
<p>最佳实践：</p>
<ul>
<li><code>dtype</code>参数预先指定可以减少50%+的内存使用；</li>
<li><code>parse_dates</code>参数只解析真正需要的日期列；</li>
<li><code>usecols</code>参数只加载必要列；</li>
</ul>
<h2 data-id="heading-18">Dask并行处理终极方案</h2>
<p>当单机处理达到极限时：Dask提供了类Pandas API但支持分布式计算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> dask.dataframe <span class="hljs-keyword">as</span> dd

ddf = dd.read_csv(<span class="hljs-string">'s3://bucket/*.csv'</span>,
                  blocksize=<span class="hljs-string">"256MB"</span>) 

result_ddf = ddf.groupby(<span class="hljs-string">'user_id'</span>).agg({
    <span class="hljs-string">'value'</span>: [<span class="hljs-string">'sum'</span>,<span class="hljs-string">'mean'</span>,<span class="hljs-string">'std'</span>]
}).compute(num_workers=<span class="hljs-number">8</span>) <span class="hljs-comment">#自动并行化计算！</span>
</code></pre>
<p>关键优势：
✔️延迟计算构建执行图<br/>
✔️自动任务调度<br/>
✔️内存溢出时自动写入磁盘</p>
<h2 data-id="heading-19">Pandas性能监控工具链推荐</h2>
<p>专业开发者必备工具包：</p>
<pre><code class="hljs language-css" lang="css">pip install line_profiler memory_profiler snakeviz pyinstrument psutil scipy matplotlib seaborn tabulate tqdm pandarallel swifter modin dask<span class="hljs-selector-attr">[complete]</span>
</code></pre>
<p>常用组合：</p>
<pre><code class="hljs language-css" lang="css">kernprof -l script<span class="hljs-selector-class">.py</span> &amp;&amp; python -m line_profiler script<span class="hljs-selector-class">.py</span><span class="hljs-selector-class">.lprof</span>  
mprof run <span class="hljs-attr">--include-children</span> script<span class="hljs-selector-class">.py</span> &amp;&amp; mprof plot  
snakeviz profiling_results<span class="hljs-selector-class">.prof</span>  
pyinstrument -r <span class="hljs-selector-tag">html</span> script<span class="hljs-selector-class">.py</span>  
</code></pre>
<h2 data-id="heading-20">DataFrame设计模式最佳实践总结表格</h2>



































<table><thead><tr><th>Pattern</th><th>Use When...</th><th>Speed Gain</th></tr></thead><tbody><tr><td>Column-wise ops</td><td>Uniform calculations across rows</td><td>+100x</td></tr><tr><td>eval/query</td><td>Complex boolean filtering</td><td>+5-20x</td></tr><tr><td>Category dtype</td><td>Low cardinality strings</td><td>+10x mem</td></tr><tr><td>Merge hints</td><td>Large table joins</td><td>+10x</td></tr><tr><td>Numba</td><td>Custom numeric functions</td><td>+100x+</td></tr></tbody></table>
<p>记住黄金法则：<strong>先profile再优化</strong>！不同场景下最优策略可能完全不同。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 对象字面量与代理模式：从入门到面向接口编程]]></title>    <link>https://juejin.cn/post/7597083949833764870</link>    <guid>https://juejin.cn/post/7597083949833764870</guid>    <pubDate>2026-01-20T05:49:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083949833764870" data-draft-id="7596990822127419430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 对象字面量与代理模式：从入门到面向接口编程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T05:49:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户411924458439"/> <meta itemprop="url" content="https://juejin.cn/user/221443581553930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 对象字面量与代理模式：从入门到面向接口编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/221443581553930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户411924458439
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:49:09.000Z" title="Tue Jan 20 2026 05:49:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今 Web 开发的浪潮中，JavaScript 早已不再是“玩具语言”，而是构建现代交互式应用的核心力量。它灵活、动态、富有表现力，尤其以其 <strong>对象字面量（Object Literal）</strong>  语法和强大的 <strong>面向对象能力</strong> 脱颖而出。本文将带你深入理解 JavaScript 中的对象本质、数据类型基础，并通过一个生动的“送花”场景，揭示 <strong>代理模式（Proxy Pattern）</strong>  如何借助“接口思维”让代码更灵活、更可维护。</p>
<hr/>
<h2 data-id="heading-0">一、JavaScript：无需类定义的动态对象世界</h2>
<p>与 Java、C++ 等静态语言不同，JavaScript 在早期甚至没有 <code>class</code> 关键字（ES6 才引入）。但这并不妨碍它实现强大的面向对象编程——因为它天生支持 <strong>对象字面量</strong>。</p>
<h3 data-id="heading-1">什么是对象字面量？</h3>
<p>对象字面量是一种用 <code>{}</code> 直接创建对象的简洁语法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> person = {
<span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, 
<span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
<span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) { 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好，我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>); 
    } 
};
</code></pre>
<p>无需先定义“类”，无需编译，一行代码即可拥有一个具备属性（<code>name</code>, <code>age</code>）和方法（<code>sayHello</code>）的完整对象。这种即时性、灵活性，正是 JavaScript 表现力的核心。</p>
<p>同样，数组也通过字面量 <code>[]</code> 创建：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> hobbies = [<span class="hljs-string">"读书"</span>, <span class="hljs-string">"编程"</span>, <span class="hljs-string">"旅行"</span>];
</code></pre>
<p>这种“所见即所得”的语法，极大降低了开发门槛，也让原型式编程成为可能。</p>
<hr/>
<h2 data-id="heading-2">二、JavaScript 的基本数据类型：万物皆可对象？</h2>
<p>JavaScript 的数据类型分为两大类：<strong>原始类型（Primitive）</strong>  和 <strong>引用类型（Reference）</strong> 。</p>
<ul>
<li>
<p><strong>原始类型</strong>（不可变）：</p>
<ul>
<li><code>string</code>（字符串）：<code>"hello"</code></li>
<li><code>number</code>（数值）：<code>42</code>, <code>3.14</code>（JS 的 number 不适合高精度数值计算）</li>
<li><code>boolean</code>（布尔值）：<code>true</code>, <code>false</code></li>
<li><code>null</code>（空值）：表示“有意 absence of any object value”</li>
<li><code>undefined</code>（未定义）：变量声明但未赋值时的默认值</li>
</ul>
</li>
<li>
<p><strong>引用类型</strong>（可变，存储在堆内存）：</p>
<ul>
<li><code>object</code>（对象）：包括普通对象、数组、函数、日期等</li>
<li><code>function</code> 本质上也是对象！</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 注意：<code>typeof null</code> 返回 <code>"object"</code> 是 JavaScript 的历史 bug，但至今未修复。</p>
</blockquote>
<p>对象作为引用类型，可以动态添加/删除属性，这为行为扩展提供了无限可能。</p>
<hr/>
<h2 data-id="heading-3">三、面向对象：从简单属性到复杂关系</h2>
<p>在 JavaScript 中，<strong>对象由属性（数据）和方法（行为）构成</strong>。这是面向对象的基本单元。</p>
<h3 data-id="heading-4">简单面向对象示例：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dog = {
<span class="hljs-attr">name</span>: <span class="hljs-string">"旺财"</span>, 
<span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) { 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"汪汪！"</span>);
} 
};
dog.<span class="hljs-title function_">bark</span>(); <span class="hljs-comment">// 汪汪！</span>
</code></pre>
<h3 data-id="heading-5">复杂面向对象：模拟人际关系</h3>
<p>现实世界充满复杂交互。比如“送花”这一行为，在程序中如何建模？</p>
<p>假设：</p>
<ul>
<li>小王（<code>xw</code>）想给小美（<code>xm</code>）送花。</li>
<li>但小美性格高冷，直接送可能被拒。</li>
</ul>
<p>这时，我们需要一个“中间人”——小红（<code>xh</code>），她可以代为接收并判断是否转交。</p>
<p>这正是 <strong>代理模式（Proxy Pattern）</strong>  的典型应用场景。</p>
<hr/>
<h2 data-id="heading-6">四、代理模式：面向接口编程的优雅实践</h2>
<h3 data-id="heading-7">什么是代理模式？</h3>
<p>代理模式的核心思想是：<strong>为其他对象提供一种代理以控制对这个对象的访问</strong>。它常用于权限控制、延迟加载、日志记录等场景。</p>
<p>在 JavaScript 中，由于其动态特性，我们不需要显式定义“接口”，但可以通过 <strong>约定方法名</strong> 来实现“隐式接口”。</p>
<h3 data-id="heading-8">场景重构：送花代理</h3>
<h4 data-id="heading-9">第一步：定义“收花接口”</h4>
<p>虽然 JS 没有 <code>interface</code> 关键字，但我们约定：<strong>任何能收花的对象，必须有一个 <code>receiveFlower</code> 方法</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 小美：目标对象</span>
<span class="hljs-keyword">const</span> xm = { <span class="hljs-attr">name</span>: <span class="hljs-string">"小美"</span>, <span class="hljs-attr">mood</span>: <span class="hljs-string">"bad"</span>, <span class="hljs-comment">// 心情不好 </span>
<span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">flower</span>) { 
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mood</span> === <span class="hljs-string">"good"</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>开心地收下了<span class="hljs-subst">${flower}</span>！`</span>);
    } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>心情不好，拒绝了<span class="hljs-subst">${flower}</span>。`</span>); 
    }
  }
}; 
<span class="hljs-comment">// 小红：代理对象 </span>
<span class="hljs-keyword">const</span> xh = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"小红"</span>, 
    <span class="hljs-attr">target</span>: xm, <span class="hljs-comment">// 代理的真实对象 </span>
    <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">flower</span>) { 
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>作为代理，先检查一下情况...`</span>); 
        <span class="hljs-comment">// 代理可以添加额外逻辑：比如先改善小美心情 </span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">target</span>.<span class="hljs-property">mood</span> = <span class="hljs-string">"good"</span>; <span class="hljs-comment">// 假设小红成功安慰了小美 </span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">target</span>.<span class="hljs-title function_">receiveFlower</span>(flower); <span class="hljs-comment">// 再转交 </span>
      }
    };
</code></pre>
<h4 data-id="heading-10">第二步：小王送花</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xw = { 
    <span class="hljs-attr">name</span>: <span class="hljs-string">"小王"</span>,
    <span class="hljs-title function_">sendFlower</span>(<span class="hljs-params">receiver, flower</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>送给<span class="hljs-subst">${receiver.name}</span>一束<span class="hljs-subst">${flower}</span>。`</span>); 
        receiver.<span class="hljs-title function_">receiveFlower</span>(flower); <span class="hljs-comment">// 调用接收者的收花方法 </span>
      }
    }; 
<span class="hljs-comment">// 直接送花给小美 → 可能被拒</span>
xw.<span class="hljs-title function_">sendFlower</span>(xm, <span class="hljs-string">"玫瑰"</span>);
<span class="hljs-comment">// 输出：小美心情不好，拒绝了玫瑰。 </span>

<span class="hljs-comment">// 通过代理小红送花 → 成功！</span>
xw.<span class="hljs-title function_">sendFlower</span>(xh, <span class="hljs-string">"百合"</span>);
<span class="hljs-comment">// 输出： </span>
<span class="hljs-comment">// 小王送给小红一束百合。 </span>
<span class="hljs-comment">// 小红作为代理，先检查一下情况... </span>
<span class="hljs-comment">// 小美开心地收下了百合！</span>
</code></pre>
<h3 data-id="heading-11">关键点：面向“接口”而非“实现”</h3>
<ul>
<li>小王（<code>xw</code>）<strong>不关心</strong>接收者是 <code>xm</code> 还是 <code>xh</code>。</li>
<li>他只依赖一个“契约”：<strong>对方有 <code>receiveFlower</code> 方法</strong>。</li>
<li>只要满足这个“接口”，任何对象都可以作为接收者。</li>
</ul>
<p>这就是 <strong>面向接口编程</strong> 的精髓：<strong>解耦调用者与被调用者，提升代码灵活性和可扩展性</strong>。</p>
<p>未来如果新增“小李”作为代理，只要他也实现 <code>receiveFlower</code>，小王的代码无需任何修改！</p>
<hr/>
<h2 data-id="heading-12">五、JavaScript 中的 Proxy API：原生代理能力</h2>
<p>除了手动编写代理对象，ES6 还提供了原生的 <code>Proxy</code> 构造函数，用于拦截和自定义对象操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> xm = { 
    <span class="hljs-attr">mood</span>: <span class="hljs-string">"bad"</span>,
    <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">flower</span>) { 
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`收下<span class="hljs-subst">${flower}</span>`</span>); 
  }
};
<span class="hljs-keyword">const</span> xhProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(xm, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) { 
    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">"receiveFlower"</span>) { 
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">flower</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"小红代理：先调整心情..."</span>); 
    target.<span class="hljs-property">mood</span> = <span class="hljs-string">"good"</span>;
    target[prop](flower);
    };
  } 
  <span class="hljs-keyword">return</span> target[prop];
  }
});
xw.<span class="hljs-title function_">sendFlower</span>(xhProxy, <span class="hljs-string">"郁金香"</span>); 
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 小王送给[object Object]一束郁金香。 </span>
<span class="hljs-comment">// 小红代理：先调整心情... </span>
<span class="hljs-comment">// 收下郁金香</span>
</code></pre>
<p>虽然 <code>Proxy</code> 更强大（可拦截 <code>get</code>, <code>set</code>, <code>apply</code> 等），但在简单场景下，<strong>对象字面量 + 方法约定</strong> 已足够清晰高效。</p>
<hr/>
<h2 data-id="heading-13">六、总结：JS 工程师的思维升级</h2>
<p>JavaScript 的魅力在于其 <strong>简洁性与表现力的统一</strong>：</p>
<ul>
<li>用 <code>{}</code> 轻松创建对象，无需繁琐类定义；</li>
<li>用原始类型与对象模型描述世界；</li>
<li>通过“隐式接口”实现灵活的面向对象设计；</li>
<li>借助代理模式，优雅处理复杂交互逻辑。</li>
</ul>
<p>作为新时代的开发者，我们不仅要会写代码，更要学会 <strong>用对象思维建模现实问题</strong>，用 <strong>接口契约解耦系统模块</strong>。而 JavaScript 的对象字面量，正是这一切的起点。</p>
<blockquote>
<p>正如那句名言：“<strong>Program to an interface, not an implementation.</strong> ”<br/>
在 JavaScript 中，接口不必显式声明，只需一个共同的方法名，便足以支撑起灵活、健壮的系统架构。</p>
</blockquote>
<p>从今天起，试着用对象字面量构建你的第一个“送花系统”吧——你会发现，编程，也可以很浪漫。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Galaxy比数平台功能介绍及实现原理｜得物技术]]></title>    <link>https://juejin.cn/post/7597083949833928710</link>    <guid>https://juejin.cn/post/7597083949833928710</guid>    <pubDate>2026-01-20T06:17:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083949833928710" data-draft-id="7596962772145356815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Galaxy比数平台功能介绍及实现原理｜得物技术"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2026-01-20T06:17:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Galaxy比数平台功能介绍及实现原理｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T06:17:08.000Z" title="Tue Jan 20 2026 06:17:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>得物经过10年发展，计算任务已超10万+，数据已经超200+PB，为了降低成本，计算引擎和存储资源需要从云平台迁移到得物自建平台，计算引擎从云平台Spark迁移到自建Apache Spark集群、存储从ODPS迁移到OSS。</p>
<p>在迁移时，最关键的一点是需要保证迁移前后数据的一致性，同时为了更加高效地完成迁移工作（目前计算任务已超10万+，手动比数已是不可能），因此比数平台便应运而生。</p>
<h2 data-id="heading-1">二、数据比对关键挑战与目标</h2>
<h3 data-id="heading-2">关键挑战一：如何更快地完成全文数据比对</h3>
<p><strong>现状痛点：</strong></p>
<p>在前期迁移过程中，迁移同学需要手动join两张表来识别不一致数据，然后逐条、逐字段进行人工比对验证。这种方式在任务量较少时尚可应付，但当任务规模达到成千上万级别时，就无法实现并发快速分析。</p>
<p><strong>核心问题：</strong></p>
<ul>
<li>效率瓶颈：每天需要完成数千任务的比对，累计待迁移任务达10万+，涉及表数十万张。</li>
<li>扩展性不足：传统人工比对方式无法满足大规模并发处理需求。</li>
</ul>
<h3 data-id="heading-3">关键挑战二：如何精准定位异常数据</h3>
<p><strong>现状痛点：</strong></p>
<p>迁移同学在识别出不一致数据后，需要通过肉眼观察来定位具体问题，经常导致视觉疲劳和分析效率低下。</p>
<p><strong>核心问题：</strong></p>
<ul>
<li>分析困难：在比对不通过的情况下，比对人员需要人工分析失败原因。</li>
<li>复杂度高：面对数据量庞大、加工逻辑复杂的场景，特别是在处理大JSON数据时，肉眼根本无法有效分辨差异。</li>
<li>耗时严重：单次比对不通过场景的平均分析时间高达1.67小时/任务。</li>
</ul>
<h3 data-id="heading-4">比数核心目标</h3>
<p>基于以上挑战，数据比对系统需要实现以下核心目标：</p>
<ul>
<li>高并发处理能力：支持每天数千任务的快速比对，能够处理10万+待迁移任务和数十万张表的规模。</li>
<li>自动化比对机制：实现全自动化的数据比对流程，减少人工干预，提升比对效率。</li>
<li>智能差异定位：提供精准的差异定位能力，能够快速识别并高亮显示不一致的字段和数据。</li>
<li>可视化分析界面：构建友好的可视化分析平台，支持大JSON数据的结构化展示和差异高亮。</li>
<li>性能优化：将用户单次比对分析时间从小时级大幅缩短至分钟级别。</li>
<li>可扩展架构：设计可水平扩展的系统架构，能够随着业务增长灵活扩容。</li>
</ul>
<h2 data-id="heading-5">三、解决方案实现原理</h2>
<h3 data-id="heading-6">快速完成全文数据比对方法</h3>
<p><strong>比数方法调研</strong></p>
<p>待比对两表数据大小：300GB，计算资源：1000c</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab7f4b85a76402cadb9d9b692aff2a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=LVX1Y6vhnRcW4tk8AHSxuRUULlw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4837101ae1a406b96ce9fb95e548487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=s6edlU4%2Bdxp%2BvXIbVE%2FPBCibLdk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>经过调研分析比数平台采用第二种和第三种相结合的方式进行比数。</p>
<p><strong>先Union再分组数据一致性校验原理</strong></p>
<p>假如我们有如下a和b两表张需要进行数据比对</p>
<p>表a：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/186d08e493ea4efe82856cdbaa41bf13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=ppgJj3Yn9%2FpxI4r7dqU6vC6gbiI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>表b：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d69b9c1fc1904764b29d6f96304bbff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=iwNUsObBCc3NpDlx7ePRL6porOs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>表行数比较：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">select</span> <span class="hljs-title">count</span>(<span class="hljs-params"><span class="hljs-number">1</span></span>) <span class="hljs-keyword">from</span> a</span> ;
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">select</span> <span class="hljs-title">count</span>(<span class="hljs-params"><span class="hljs-number">1</span></span>) <span class="hljs-keyword">from</span> b</span> ;
</code></pre>
<p>针对上面的查询结果，如果数量不一致则退出比对，待修复后重新比数；数量一致则继续字段值比较。</p>
<p><strong>字段值比较：</strong></p>
<p>第一步：union a 和 b</p>
<pre><code class="hljs language-javascript" lang="javascript">select <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> a
union all
select <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> b
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08d2fbde55ed44e1b125872ceead1798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=bSne3rKYSuK0yGWAWlJv1q23w%2BY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>第二步：sum(_t1_count)，sum(_t2_count) 后分组</p>
<pre><code class="hljs language-javascript" lang="javascript">select <span class="hljs-title function_">sum</span>(_t1_count) <span class="hljs-keyword">as</span> sum_t1_count, <span class="hljs-title function_">sum</span>(_t2_count) <span class="hljs-keyword">as</span> sum_t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> (
select <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> a
union all
select <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> b
) <span class="hljs-keyword">as</span> union_table
group by <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f6723139f6f48bfbf61c35f72ffcd0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=%2FGc9N7JukWBR9eqalDFe5b94Gfw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>第三步：把不一致数据写入新的表中(即上面表中sum_t1_count和sum_t2_count不相等的数据)</p>
<pre><code class="hljs language-javascript" lang="javascript">drop table <span class="hljs-keyword">if</span> exists a_b_diff_20240908;
create table a_b_diff_20240908 <span class="hljs-keyword">as</span> select * <span class="hljs-keyword">from</span> (
select <span class="hljs-title function_">sum</span>(_t1_count) <span class="hljs-keyword">as</span> sum_t1_count, <span class="hljs-title function_">sum</span>(_t2_count) <span class="hljs-keyword">as</span> sum_t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> (
select <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> a
union all
select <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> b
) <span class="hljs-keyword">as</span> union_table
group by <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
having <span class="hljs-title function_">sum</span>(_t1_count) &lt;&gt; <span class="hljs-title function_">sum</span>(_t2_count)
) <span class="hljs-keyword">as</span> tmp
</code></pre>
<p>如果a_b_diff_20240908没有数据则两张表没有差异，比数通过，如有差异如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbb29da004d0457f8300a7fa6cc42c72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=j1fmuIbtemIRNe9y5Nnk5IQijx4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>第四步：读取不一致记录表，根据主键（比如id）找出不一致字段并写到结果表中。</p>
<p>第五步：针对不一致字段的数据进行根因分析，如 json 、数组顺序问题、浮点数精度问题等，给出不一致具体原因。</p>
<p><strong>哈希值聚合实现高效一致性校验</strong></p>
<p>针对上面union后sum 再 group by 方式 在数据量大的时候还是非常耗资源和时间的，考虑到比数任务毕竟有70%都是一致的，所以我们可以先采用哈希值聚合比较两表的的值是否一致，使用这种高效的方法先把两表数据一致的任务过滤掉，剩下的再采用上面方法继续比较，因为还要找出是哪个字段哪里不一致。原理如下：</p>
<pre><code class="hljs language-scss" lang="scss">SELECT count (*),<span class="hljs-built_in">SUM</span>(xxhash64(cloum1)^<span class="hljs-built_in">xxhash64</span>(cloum2)^...) FROM tableA 
EXCEPT 
SELECT <span class="hljs-built_in">count</span>(*),<span class="hljs-built_in">SUM</span>(xxhash64(cloum1)^<span class="hljs-built_in">xxhash64</span>(cloum2)^...) FROM tableB
</code></pre>
<p>如果有记录为空说明数据一致，不为空说明数据不一致需要采用上面提到union 分组的方法去找出具体字段哪里不一样。</p>
<p>通过哈希值聚合，单个任务比数时间从500s降低到160s，节省大约70%的时间。</p>
<p>找到两张表不一致数据后需要对两张的数据进行分析确定不一致的点在哪里？这里就需要知道表的主键，根据主键逐个比对两张表的其他字段，因此系统会先进行主键的自动探查，以及无主键的兜底处理。</p>
<h3 data-id="heading-7">精准定位异常数据实现方法</h3>
<p><strong>自动探查主键：实现原理如下</strong></p>
<p>刚开始我们采用的前5个字段找主键的方式，如下：</p>
<pre><code class="hljs language-sql" lang="sql">针对表a的前<span class="hljs-number">5</span>个字段 循环比对
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> id) <span class="hljs-keyword">from</span> a 与 <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a 比较 ，如相等主键为id ，不相等继续往下执行
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> id,name) <span class="hljs-keyword">from</span> a 与 <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a比较，如相等主键为id,name ，不相等继续往下执行
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> id,name,age) <span class="hljs-keyword">from</span> a 与 <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a比较，如相等主键为id,name,age ，不相等继续往下执行，直到循环结束
</code></pre>
<p>采用上面的方法不一致任务中大约有49.6%任务自动探查主键失败：因此需重点提升主键识别能力。</p>
<p>针对以上主键探查成功率低的问题，后续进行了一些迭代，优化后的主键探查流程如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25de1d35ecd9418799133d350c66238f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=Wjo6Kt0tO3xPN7AfPoPRzpqHXII%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>一、先采用sum(hash)高效计算方式进行探查：</strong></p>
<p>1.先算出两张表每个字段的sum(hash)值  。</p>
<pre><code class="hljs language-python" lang="python">select <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(<span class="hljs-built_in">id</span>)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(name)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(age)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(score)) <span class="hljs-keyword">from</span> a 
union <span class="hljs-built_in">all</span> 
select <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(<span class="hljs-built_in">id</span>)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(name)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(age)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(score)) <span class="hljs-keyword">from</span> b;
</code></pre>
<p>2.找出值相等的所有字段，本案例中为 id, name。</p>
<p>3.对id，name 可能是主键进一步确认，先进行行数校验，如 select count(distinct id,name) from a 的值等于select count(1) from a 则进一步校验，否则进入到第二种探查主键方式。</p>
<p>4.唯一性验证，如果值为0则表示探查主键成功，否则进入到第二种探查主键方式。</p>
<pre><code class="hljs language-sql" lang="sql">slect <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> ((<span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> a ) expect (<span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> b))
</code></pre>
<p><strong>二、传统distinct方式探查：</strong></p>
<p>针对表a的前N（所有字段数/2或者前N、后N等）个字段 循环比对：</p>
<p>1.select count(distinct id) from a与select count(1) from a比较 ，如相等主键为id ，不相等继续往下执行。</p>
<p>2.select count(distinct id,name) from a 与 select count(1) from a比较，如相等主键为id,name ，不相等继续往下执行。</p>
<p>3.select count(distinct id,name,age) from a 与 select count(1) from a比较，如相等主键为id,name,age ，不相等继续往下执行，直到循环结束。</p>
<p><strong>三、全字段排序模拟:</strong></p>
<p>如果上面两种方式还是没有找到主键则把不一致记录表进行全字段排序然后对第一条和第二条记录挨个字段进行分析，找出不一致内容，示例如下：</p>
<pre><code class="hljs language-sql" lang="sql">slect <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> a_b_diff_20240908 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id,name,age,score <span class="hljs-keyword">asc</span> limit <span class="hljs-number">10</span>;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ef9f06f43484d919849196643d03729~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=93VYsc%2F3m8FGe%2F%2BFZ4xlzVDTTwM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>通过以上结果表可以得出两表的age字段不一致 ，score不一致（但按key排序后一致）。</p>
<p>如果以上自动化分析还是找不到不一致字段内容，可以人工确认表的主键后到平台手动指定主键字段，然后点击后续分析即可按指定主键去找字段不一致内容。</p>
<p>通过多次迭代优化找主键策略，找主键成功率从最初的50.4%提升到75%，加上全字段order by排序后最前两条数据进行分析，相当于可以把找主键的成功率提升到90%以上。</p>
<p><strong>根因分析：实现原理如下</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ffcd921dc69410094ec2ad734d3d602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=kmEILGcn3E9X17tys3Y5%2FUB5IZ4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当数据不一致时，平台会根据主键找出两个表哪些字段数据不一致并进行分析，具体如下：</p>
<ul>
<li><strong>精准定位：</strong> 明确指出哪条记录、哪个字段存在差异，并展示具体的源数据和目标数据值。</li>
<li><strong>智能根因分析：</strong> 内置了多种差异模式识别规则，能够自动分析并提示不一致的可能原因，例如：</li>
<li>精度问题：如浮点数计算1.0000000001与1.0的差异。</li>
<li>JSON序列化差异：如{"a":1, "b":2}与{"b":2, "a":1}，在语义一致的情况下，因键值对顺序不同而被标记为差异。同时系统会提示排序后一致。</li>
<li>空值处理差异：如NULL值与空字符串""的差异判定。</li>
<li>日期时区转换问题：时间戳在不同时区下表示不同。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c3c92ec4094f0eb0dc64b0c3a3daaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=PQ4B4wonmvnK84sqnaWxqZlsgM8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db0212b45a6146c198ea412952b6c8ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=doO%2B5Vt8WX%2FyAR4AE3z8DGP3Kqk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>比对结果统计：</strong> 提供总数据量、一致数据量、不一致数据量及不一致率百分比，为项目决策提供清晰的量化依据。</li>
<li>比数人员根据平台分析的差异原因，决定是否手动标记通过或进行任务修复。</li>
<li>效果展示：</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/566d75faee4a4dcc8c8e637eadd32d6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=Qup%2FMQqwspWtDPW4WNLQ2poZzcw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-8">四、比数平台功能介绍</h2>
<h3 data-id="heading-9">数据比对基本流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c09f97130ba45678aec2b50638b2aee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=9hhTVjtN0R7usRnpaw%2BwbwtCvkI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-10">任务生成：三种比对模式</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbb2b1b4aa2c49ea8e0b6a80477808bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=YRfferO3wRHg%2FjEP7FpFuLC70CE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>两表比对：</strong> 最直接的比对方式。用户只需指定源表与目标表，平台即可启动全量数据比对。它适用于临时比对的场景。</li>
<li><strong>任务节点比对：</strong> 一个任务可能输出多个表，逐一配置这些表的比对任务繁琐且易遗漏，任务节点比对模式完美解决了这一问题。用户只需提供任务节点ID，平台便会自动解析该节点对应的SQL代码，提取出所有输出表，并自动生成比对任务，极大地提升任务迁移比对效率。</li>
<li><strong>SQL查询比对：</strong> 业务在进行SDK迁移只关心某些查询在迁移后数据是否一样，因此需要对用户提交的所有查询SQL进行比对，平台会分别在ODPS和Spark引擎上执行该查询，将结果集导出到两张临时表，再生成比对任务。</li>
</ul>
<h3 data-id="heading-11">前置校验：提前发现问题</h3>
<p>在启动耗时的全量比对之前，需要对任务进行前置校验，确保比对是在表结构一致、集群环境正常的情况下进行，否则一旦启动比数会占用大量计算资源，最后结果还是比数不通过，会影响比数平台整体的运行效率。因此比数平台一般会针对如下问题进行前置拦截。</p>
<ul>
<li><strong>元数据一致性校验：</strong> 比对双方的字段名、字段类型、字段顺序、字段个数是否一致。</li>
<li><strong>函数缺失校验：</strong> 针对Spark引擎，校验SQL中使用的函数是否存在、是否能被正确识别，避免因函数不支持而导致的比对失败。</li>
<li><strong>语法问题校验：</strong> 分析SQL语句的语法结构，确保其在目标引擎中能够被顺利解析，避免使用了某些特定写法会导致数据出现不一致情况，提前发现语法层面问题，并对任务进行改写。</li>
</ul>
<p><strong>更多校验点如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40910e32074f4c28b70c5226fe902490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=cl7EeqzAo8AMMIzBZASeWeuzhSI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30dbeda7f2a446b99d9ee8fc0d9c6c6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=6g%2BNoCOop3TpZbTpS0mtpBEIKl4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a120da92c35046a1aee83c9da7f81915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=jC9MNlPrk1%2FlYM1LW1%2FVh%2BDyB1I%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>通过增加以上前置校验拦截，比数任务数从每天3000+<strong>下降到1500+，</strong> 减少<strong>50%</strong> 的无效比数，其中UDF缺失最多，有效拦截任务1238，缺少函数<strong>87个</strong>（帮比数同学快速定位，一次性解决函数缺失问题，避免多次找引擎同学陆陆续续添加，节省双方时间成本）。</p>
<h3 data-id="heading-12">破解比数瓶颈：资源分配与任务调度优化</h3>
<p>由于比数平台刚上线的时候只有计算迁移团队在使用，后面随着更多的团队开始使用，性能遇到了如下瓶颈：</p>
<p><strong>1.资源不足问题：</strong> 不同业务（计算迁移、存储迁移、SDK迁移）的任务相互影响，基本比数任务与根因分析任务相互抢占资源。</p>
<p><strong>2.任务编排不合理：</strong> 没有优先级导致大任务阻塞整体比数进程。</p>
<p><strong>3.引擎参数设置不合理：</strong> 并行度不够、数据分块大小等高级参数。</p>
<p>针对以上问题比数平台进行了如下优化：</p>
<ul>
<li>按不同业务拆分成多个队列来运行，保证各个业务之间的比数任务可以同时进行，不会相互影响。</li>
<li>根因分析使用单独的队列，与数据比对任务的队列分开，避免相互抢占资源发生“死锁”。</li>
<li>相同业务内部按批次分时段、分优先级运行，保障重要任务优先进行比对。</li>
<li>针对Spark引擎默认调优了公共参数、并支持用户自主设置其他高级参数。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df0b85bd8ac74968b0b75b0d7ee4b9dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=35%2FJ9DEW8CBXqiho9N9hYZA0Mtw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>通过以上优化达到到了如下效果：</p>
<ul>
<li>比数任务从每天22点完成提前至<strong>18点</strong>前，同时支持比数同学自主控制高优任务优先执行，方便比数同学及时处理不一致任务。</li>
<li>通过优化资源队列使用方式，使系统找不到主键辅助用户自主找主键接口响应时间<strong>从58.5秒降到 26.2秒。</strong></li>
</ul>
<h2 data-id="heading-13">五、比数平台收益分享</h2>
<p>平台持续安全运行500+天，每日可完成2000+任务比对，有效比数128万+次，0误判。</p>
<ul>
<li>助力计算迁移团队节省45+人日/月，完成数据分析、离线数仓空间任务的比对、交割。</li>
<li>助力存储迁移团队完成20%+存储数据的迁移。</li>
<li>助力引擎团队完成800+批次任务的回归验证，确保每一次引擎发布的安全及高效。</li>
<li>助力SDK迁移团队完成80%+应用的迁移。</li>
</ul>
<h2 data-id="heading-14">六、未来演进方向</h2>
<p>接下来，平台计划在以下方面持续改进：</p>
<p><strong>智能分析引擎：</strong> 针对Json复杂嵌套类型的字段接入大模型进行数据根因分析，找出不一致内容。</p>
<p><strong>比对策略优化：</strong> 针对大表自动切分进行比对，降低比数过程出现因数据量大导致异常，进一步提升比对效率。</p>
<p><strong>通用方案沉淀：</strong> 将典型的比对场景和解决方案能用化，应用到更多场景及团队中去。</p>
<h2 data-id="heading-15">七、结语</h2>
<p>比数平台是得物在迁移过程中，为了应对海量任务、大数据量、字段内容复杂多样、异常数据难定位等挑战，确保业务迁移后数据准确而专门提供的解决方案，未来它不单纯是一个服务计算迁移、存储迁移、SDK迁移、Spark版本升级等需要的数据比对工具，而是演进为数据平台中不可或缺的基础设施。</p>
<h3 data-id="heading-16">往期回顾</h3>
<p>1.得物App智能巡检技术的探索与实践</p>
<p>2.深度实践：得物算法域全景可观测性从 0 到 1 的演进之路 </p>
<p>3.前端平台大仓应用稳定性治理之路｜得物技术</p>
<p>4.RocketMQ高性能揭秘：承载万亿级流量的架构奥秘｜得物技术</p>
<p>5.PAG在得物社区S级活动的落地</p>
<h3 data-id="heading-17">文 /Galaxy平台</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每天一例：公司里一个被忽视但能改进的流程【需求】]]></title>    <link>https://juejin.cn/post/7596993862534430720</link>    <guid>https://juejin.cn/post/7596993862534430720</guid>    <pubDate>2026-01-20T06:23:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596993862534430720" data-draft-id="7596989416760868899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每天一例：公司里一个被忽视但能改进的流程【需求】"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-20T06:23:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每天一例：公司里一个被忽视但能改进的流程【需求】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T06:23:19.000Z" title="Tue Jan 20 2026 06:23:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<h2 data-id="heading-0">每天一例｜需求评审里，我们只讨论“做什么”，却很少讨论“不做的代价”</h2>
</blockquote>
<h3 data-id="heading-1"/>
<hr/>
<h3 data-id="heading-2">连载说明｜每天一例</h3>
<p>在技术团队中，很多问题并非源于个人能力，而是流程的默认设定不够清晰。它们不严重到触发事故，也不足以推动制度调整，却在日常工作中持续消耗时间与精力。</p>
<p>这个连载计划每天记录，或者回忆一个在公司内部真实存在、但常被忽视的小流程问题，重点不在复盘责任，而在拆解具体改法。每一篇只讨论一个场景，描述问题如何出现、改动前的实际阻力、以及一次小规模调整带来的变化。</p>
<p>不涉及宏观管理理念，不讨论理想状态，只关注普通技术团队可直接复用的实践。<br/>
如果某个问题在你的团队反复出现，且只能靠经验或个人兜底解决，那么它很可能值得被写下来。</p>
<h2 data-id="heading-3">开始</h2>
<p>那段时间，我们公司正处在一个不上不下的阶段。</p>
<p><strong>启原系统</strong>做的是企业级 SaaS，业务稳定，但增长开始放缓。产品侧希望通过更细致的功能打磨提升用户黏性，技术团队则在一边偿还历史债务，一边支撑新需求，所有人都在“还能再撑一撑”的状态里往前走。</p>
<p>也是在这样的背景下，那次需求评审被提了出来。</p>
<p>需求本身并不复杂，是一个针对老客户的配置增强功能。产品文档写得很完整，背景、目标、使用场景一应俱全，从逻辑上几乎挑不出毛病。评审会上，技术评估的结论也很一致：实现难度中等，不涉及底层改造，不会影响现有架构，排进当前版本问题不大。</p>
<p>整个过程顺得有点反常。<br/>
没有争论，没有反对意见，甚至连“需要再想想”的停顿都没有。</p>
<p>作为技术负责人，我当时只做了一件事：确认了人力分配，重新调整了迭代优先级，然后点头通过。</p>
<p>事情就是从那一刻开始悄悄埋下伏笔的。</p>
<p>接下来的两个迭代周期，团队节奏明显被拉紧。原本计划中的一次模块重构被拆散推进，一些技术优化被标注为“下个版本再说”，测试同事开始在不同需求之间来回切换。没有人抱怨，但所有人都在默默加速。</p>
<p>功能如期上线，没有事故。</p>
<p>上线后的数据并不好看，也谈不上失败。功能被少量用户使用，反馈偏中性，既没有明显拉升指标，也没有引发负面影响。业务侧很快把注意力转向了下一个方向，这个需求在系统里安静地躺了下来。</p>
<p>直到版本复盘时，我重新翻了一遍需求评审记录。</p>
<p>那一刻我才意识到一个问题：<br/>
<strong>我们在评审时，从头到尾都假设了一件事——这个需求“必须现在做”。</strong></p>
<p>但事实上，没有任何人明确说明过：<br/>
如果这个版本不做，会发生什么？</p>
<p>不会影响合同履约，不会造成客户流失，也不会阻断关键路径。最多只是“体验不够完善”，而这种“不够完善”，其实已经存在了一年多。</p>
<p>我们讨论了“做什么”“怎么做”“多久能做完”，却从未讨论过“不做”的后果。需求一旦被提出来，就自动获得了正当性，仿佛不推进，反而需要解释。</p>
<p>这是一种非常隐蔽的流程盲点。</p>
<p>在技术视角里， <strong>“不做”从来不是一个被正式讨论的选项</strong>。它既不在评审模板里，也不在会议习惯中。结果就是，所有需求都在争夺“现在做”的位置，而真正稀缺的判断，却被流程默默跳过了。</p>
<p>后来我做了一次小范围的复盘，把这次经历写进了内部技术周报。</p>
<p>没有反思个人，也没有指责产品，只是提出了一个很具体的改动建议：<br/>
在所有需求评审材料中，增加一个固定问题——<br/>
<strong>如果本版本不做这个需求，会产生什么具体影响？</strong></p>
<p>不要求给出精确数字，也不强制量化商业损失。<br/>
只要求把后果说清楚。</p>
<p>这个问题第一次被抛出来时，会议明显慢了一拍。有的需求，在这个问题面前显得更紧急；也有的需求，开始自然地被放到“可以等等”的位置。</p>
<p>流程没有变复杂，但决策开始变得更有重量。</p>
<p>后来我才慢慢意识到，这并不是在否定需求，而是在尊重团队的代价。<br/>
当“不做”的影响被说清楚，“现在做”才真正成为一个经过思考的选择，而不是流程推着走的结果。</p>
<p>那次需求评审并没有错。<br/>
它只是提醒了我一件事：<br/>
<strong>技术管理真正难的，从来不是把事情做成，而是决定什么值得被现在做。</strong></p>
<p>如果你愿意，下一篇我可以直接换成 <strong>一线技术骨干视角</strong>，讲“明明看出问题，却还是把需求做完了”的那种真实困境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Scala中的迭代器]]></title>    <link>https://juejin.cn/post/7578803751609139250</link>    <guid>https://juejin.cn/post/7578803751609139250</guid>    <pubDate>2025-12-02T03:18:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578803751609139250" data-draft-id="7578803491821633563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Scala中的迭代器"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-12-02T03:18:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kim_Jong_un"/> <meta itemprop="url" content="https://juejin.cn/user/2552429938489691"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Scala中的迭代器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2552429938489691/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kim_Jong_un
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:18:04.000Z" title="Tue Dec 02 2025 03:18:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Scala 中的迭代器（Iterator）</h2>
<h3 data-id="heading-1">一、基本概念</h3>
<p>迭代器是用于访问集合元素的工具，提供了一种顺序访问元素的方式，而不暴露底层集合的内部结构。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorBasics</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 创建迭代器</span>
    <span class="hljs-keyword">val</span> list = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    <span class="hljs-keyword">val</span> iterator = list.iterator
    
    println(<span class="hljs-string">"迭代器基本操作:"</span>)
    <span class="hljs-comment">// 1. hasNext - 检查是否有下一个元素</span>
    println(<span class="hljs-string">s"hasNext: <span class="hljs-subst">${iterator.hasNext}</span>"</span>)
    
    <span class="hljs-comment">// 2. next - 获取下一个元素</span>
    <span class="hljs-keyword">if</span> (iterator.hasNext) {
      println(<span class="hljs-string">s"第一个元素: <span class="hljs-subst">${iterator.next()}</span>"</span>)
      println(<span class="hljs-string">s"第二个元素: <span class="hljs-subst">${iterator.next()}</span>"</span>)
    }
    
    <span class="hljs-comment">// 3. 遍历剩余元素</span>
    println(<span class="hljs-string">"剩余元素:"</span>)
    <span class="hljs-keyword">while</span> (iterator.hasNext) {
      println(iterator.next())
    }
    
    <span class="hljs-comment">// 4. 迭代器只能使用一次</span>
    println(<span class="hljs-string">s"\n迭代器已耗尽，hasNext: <span class="hljs-subst">${iterator.hasNext}</span>"</span>)
    <span class="hljs-comment">// println(iterator.next())  // 会抛出异常</span>
  }
}
</code></pre>
<h3 data-id="heading-2">二、迭代器的主要特性</h3>
<h4 data-id="heading-3">1. <strong>一次性（一次性遍历）</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorOneTime</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> nums = <span class="hljs-type">Vector</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>)
    <span class="hljs-keyword">val</span> iter = nums.iterator
    
    println(<span class="hljs-string">"第一次遍历:"</span>)
    <span class="hljs-keyword">while</span> (iter.hasNext) {
      println(iter.next())
    }
    
    println(<span class="hljs-string">"\n第二次遍历（迭代器已空）:"</span>)
    <span class="hljs-comment">// 迭代器已耗尽，不会输出任何内容</span>
    <span class="hljs-keyword">while</span> (iter.hasNext) {
      println(iter.next())  <span class="hljs-comment">// 不会执行</span>
    }
    println(<span class="hljs-string">"hasNext: "</span> + iter.hasNext)  <span class="hljs-comment">// false</span>
  }
}
</code></pre>
<h4 data-id="heading-4">2. <strong>惰性求值（Lazy Evaluation）</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorLazy</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 创建一个大范围的迭代器（不会立即创建所有元素）</span>
    <span class="hljs-keyword">val</span> bigIter = (<span class="hljs-number">1</span> to <span class="hljs-number">1000000</span>).iterator
    
    <span class="hljs-comment">// 只处理前10个元素</span>
    println(<span class="hljs-string">"处理前10个元素:"</span>)
    bigIter.take(<span class="hljs-number">10</span>).foreach(println)
    
    <span class="hljs-comment">// 元素按需生成，节省内存</span>
    <span class="hljs-keyword">val</span> infiniteIter = <span class="hljs-type">Iterator</span>.continually(<span class="hljs-number">1</span>)
    println(<span class="hljs-string">"\n无限迭代器（取前5个）:"</span>)
    infiniteIter.take(<span class="hljs-number">5</span>).foreach(println)
  }
}
</code></pre>
<h4 data-id="heading-5">3. <strong>不存储状态</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorState</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> data = <span class="hljs-type">Array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    <span class="hljs-keyword">val</span> iter1 = data.iterator
    <span class="hljs-keyword">val</span> iter2 = data.iterator
    
    println(<span class="hljs-string">"两个独立的迭代器:"</span>)
    println(<span class="hljs-string">"迭代器1: "</span> + iter1.next())  <span class="hljs-comment">// 1</span>
    println(<span class="hljs-string">"迭代器2: "</span> + iter2.next())  <span class="hljs-comment">// 1（独立状态）</span>
    println(<span class="hljs-string">"迭代器1: "</span> + iter1.next())  <span class="hljs-comment">// 2</span>
    println(<span class="hljs-string">"迭代器2: "</span> + iter2.next())  <span class="hljs-comment">// 2</span>
  }
}
</code></pre>
<h3 data-id="heading-6">三、常用操作方法</h3>
<h4 data-id="heading-7">1. <strong>遍历方法</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorTraversal</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> iter = <span class="hljs-type">List</span>(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>).iterator
    
    println(<span class="hljs-string">"方法1: while循环"</span>)
    <span class="hljs-keyword">while</span> (iter.hasNext) {
      println(iter.next())
    }
    
    <span class="hljs-comment">// 重新创建迭代器</span>
    <span class="hljs-keyword">val</span> iter2 = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>).iterator
    
    println(<span class="hljs-string">"\n方法2: foreach方法"</span>)
    iter2.foreach(println)
    
    println(<span class="hljs-string">"\n方法3: for循环"</span>)
    <span class="hljs-keyword">val</span> iter3 = <span class="hljs-type">List</span>(<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Cherry"</span>).iterator
    <span class="hljs-keyword">for</span> (item &lt;- iter3) {
      println(item)
    }
  }
}
</code></pre>
<h4 data-id="heading-8">2. <strong>转换操作</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorTransformations</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> numbers = (<span class="hljs-number">1</span> to <span class="hljs-number">10</span>).iterator
    
    <span class="hljs-comment">// map - 转换每个元素</span>
    println(<span class="hljs-string">"Map（每个元素乘以2）:"</span>)
    <span class="hljs-keyword">val</span> doubled = numbers.map(_ * <span class="hljs-number">2</span>)
    println(doubled.toList)  <span class="hljs-comment">// 转换为List显示</span>
    
    <span class="hljs-comment">// filter - 过滤元素</span>
    println(<span class="hljs-string">"\nFilter（保留偶数）:"</span>)
    <span class="hljs-keyword">val</span> evens = (<span class="hljs-number">1</span> to <span class="hljs-number">10</span>).iterator.filter(_ % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
    println(evens.toList)
    
    <span class="hljs-comment">// flatMap - 扁平化映射</span>
    println(<span class="hljs-string">"\nFlatMap:"</span>)
    <span class="hljs-keyword">val</span> words = <span class="hljs-type">List</span>(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"world"</span>).iterator
    <span class="hljs-keyword">val</span> chars = words.flatMap(_.toCharArray)
    println(chars.toList)
  }
}
</code></pre>
<h4 data-id="heading-9">3. <strong>查找和判断操作</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorSearch</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> data = <span class="hljs-type">List</span>(<span class="hljs-number">15</span>, <span class="hljs-number">20</span>, <span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">35</span>).iterator
    
    <span class="hljs-comment">// find - 查找第一个满足条件的元素</span>
    <span class="hljs-keyword">val</span> found = data.find(_ &gt; <span class="hljs-number">25</span>)
    println(<span class="hljs-string">s"第一个大于25的元素: <span class="hljs-subst">$found</span>"</span>)  <span class="hljs-comment">// Some(30)</span>
    
    <span class="hljs-comment">// exists - 是否存在满足条件的元素</span>
    <span class="hljs-keyword">val</span> iter2 = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>).iterator
    <span class="hljs-keyword">val</span> hasEven = iter2.exists(_ % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
    println(<span class="hljs-string">s"是否存在偶数: <span class="hljs-subst">$hasEven</span>"</span>)  <span class="hljs-comment">// false</span>
    
    <span class="hljs-comment">// forall - 所有元素都满足条件</span>
    <span class="hljs-keyword">val</span> iter3 = <span class="hljs-type">List</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>).iterator
    <span class="hljs-keyword">val</span> allEven = iter3.forall(_ % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
    println(<span class="hljs-string">s"是否都是偶数: <span class="hljs-subst">$allEven</span>"</span>)  <span class="hljs-comment">// true</span>
  }
}
</code></pre>
<h4 data-id="heading-10">4. <strong>聚合操作</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorAggregation</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> numbers = (<span class="hljs-number">1</span> to <span class="hljs-number">5</span>).iterator
    
    <span class="hljs-comment">// foldLeft - 从左开始聚合</span>
    <span class="hljs-keyword">val</span> sum = numbers.foldLeft(<span class="hljs-number">0</span>)(_ + _)
    println(<span class="hljs-string">s"Sum: <span class="hljs-subst">$sum</span>"</span>)  <span class="hljs-comment">// 15</span>
    
    <span class="hljs-comment">// reduce - 缩减操作</span>
    <span class="hljs-keyword">val</span> iter2 = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>).iterator
    <span class="hljs-keyword">val</span> product = iter2.reduce(_ * _)
    println(<span class="hljs-string">s"Product: <span class="hljs-subst">$product</span>"</span>)  <span class="hljs-comment">// 120</span>
    
    <span class="hljs-comment">// count - 计数</span>
    <span class="hljs-keyword">val</span> iter3 = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>).iterator
    <span class="hljs-keyword">val</span> countEven = iter3.count(_ % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
    println(<span class="hljs-string">s"偶数个数: <span class="hljs-subst">$countEven</span>"</span>)  <span class="hljs-comment">// 4</span>
  }
}
</code></pre>
<h4 data-id="heading-11">5. <strong>分组和切片操作</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorGrouping</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> data = (<span class="hljs-number">1</span> to <span class="hljs-number">20</span>).iterator
    
    <span class="hljs-comment">// take - 取前n个元素</span>
    println(<span class="hljs-string">"前5个元素:"</span>)
    println(data.take(<span class="hljs-number">5</span>).toList)
    
    <span class="hljs-comment">// drop - 跳过前n个元素</span>
    println(<span class="hljs-string">"\n跳过前3个后的元素:"</span>)
    <span class="hljs-keyword">val</span> iter2 = (<span class="hljs-number">1</span> to <span class="hljs-number">10</span>).iterator
    println(iter2.drop(<span class="hljs-number">3</span>).toList)
    
    <span class="hljs-comment">// slice - 获取子序列</span>
    println(<span class="hljs-string">"\n第3到第7个元素:"</span>)
    <span class="hljs-keyword">val</span> iter3 = (<span class="hljs-number">1</span> to <span class="hljs-number">10</span>).iterator
    println(iter3.slice(<span class="hljs-number">2</span>, <span class="hljs-number">7</span>).toList)  <span class="hljs-comment">// 索引从0开始</span>
    
    <span class="hljs-comment">// grouped - 分组</span>
    println(<span class="hljs-string">"\n每3个一组:"</span>)
    <span class="hljs-keyword">val</span> iter4 = (<span class="hljs-number">1</span> to <span class="hljs-number">10</span>).iterator
    <span class="hljs-keyword">val</span> groups = iter4.grouped(<span class="hljs-number">3</span>)
    groups.foreach(group =&gt; println(group.toList))
  }
}
</code></pre>
<h3 data-id="heading-12">四、创建迭代器的多种方式</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorCreation</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1. 从集合创建</span>
    println(<span class="hljs-string">"1. 从集合创建:"</span>)
    <span class="hljs-keyword">val</span> fromList = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).iterator
    <span class="hljs-keyword">val</span> fromArray = <span class="hljs-type">Array</span>(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>).iterator
    <span class="hljs-keyword">val</span> fromSet = <span class="hljs-type">Set</span>(<span class="hljs-number">1.1</span>, <span class="hljs-number">2.2</span>, <span class="hljs-number">3.3</span>).iterator
    
    <span class="hljs-comment">// 2. 使用Iterator对象的方法</span>
    println(<span class="hljs-string">"\n2. Iterator对象方法:"</span>)
    
    <span class="hljs-comment">// range迭代器</span>
    <span class="hljs-keyword">val</span> rangeIter = <span class="hljs-type">Iterator</span>.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment">// 1,3,5,7,9</span>
    println(<span class="hljs-string">s"Range: <span class="hljs-subst">${rangeIter.toList}</span>"</span>)
    
    <span class="hljs-comment">// 无限迭代器</span>
    <span class="hljs-keyword">val</span> ones = <span class="hljs-type">Iterator</span>.continually(<span class="hljs-number">1</span>)
    println(<span class="hljs-string">s"无限1（前5个）: <span class="hljs-subst">${ones.take(5).toList}</span>"</span>)
    
    <span class="hljs-keyword">val</span> increment = <span class="hljs-type">Iterator</span>.from(<span class="hljs-number">5</span>)  <span class="hljs-comment">// 5,6,7,8,...</span>
    println(<span class="hljs-string">s"从5开始（前5个）: <span class="hljs-subst">${increment.take(5).toList}</span>"</span>)
    
    <span class="hljs-comment">// 3. 迭代多个迭代器</span>
    println(<span class="hljs-string">"\n3. 迭代多个迭代器:"</span>)
    
    <span class="hljs-comment">// concat - 连接迭代器</span>
    <span class="hljs-keyword">val</span> concatIter = <span class="hljs-type">Iterator</span>.concat(
      <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).iterator,
      <span class="hljs-type">List</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>).iterator,
      <span class="hljs-type">List</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>).iterator
    )
    println(<span class="hljs-string">s"连接: <span class="hljs-subst">${concatIter.toList}</span>"</span>)
    
    <span class="hljs-comment">// zip - 配对</span>
    <span class="hljs-keyword">val</span> letters = <span class="hljs-type">List</span>(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>).iterator
    <span class="hljs-keyword">val</span> numbers = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).iterator
    <span class="hljs-keyword">val</span> zipped = letters.zip(numbers)
    println(<span class="hljs-string">s"Zip: <span class="hljs-subst">${zipped.toList}</span>"</span>)
    
    <span class="hljs-comment">// 4. 自定义迭代器</span>
    println(<span class="hljs-string">"\n4. 自定义迭代器:"</span>)
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FibonacciIterator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Iterator</span>[<span class="hljs-type">Int</span>] </span>{
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> prev = <span class="hljs-number">0</span>
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> current = <span class="hljs-number">1</span>
      
      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hasNext</span></span>: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>  <span class="hljs-comment">// 无限序列</span>
      
      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">next</span></span>(): <span class="hljs-type">Int</span> = {
        <span class="hljs-keyword">val</span> result = prev
        prev = current
        current = result + current
        result
      }
    }
    
    <span class="hljs-keyword">val</span> fib = <span class="hljs-keyword">new</span> <span class="hljs-type">FibonacciIterator</span>
    println(<span class="hljs-string">s"斐波那契数列（前10个）: <span class="hljs-subst">${fib.take(10).toList}</span>"</span>)
  }
}
</code></pre>
<h3 data-id="heading-13">五、实际应用场景</h3>
<h4 data-id="heading-14">1. <strong>处理大文件</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> scala.io.<span class="hljs-type">Source</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">LargeFileProcessor</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 使用迭代器逐行处理大文件</span>
    <span class="hljs-keyword">val</span> source = <span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"data/large_file.txt"</span>)
    <span class="hljs-keyword">val</span> lines = source.getLines()  <span class="hljs-comment">// 返回迭代器</span>
    
    println(<span class="hljs-string">"处理大文件（取前5行）:"</span>)
    lines.take(<span class="hljs-number">5</span>).foreach(line =&gt; {
      <span class="hljs-comment">// 处理每一行，不会一次性加载到内存</span>
      println(<span class="hljs-string">s"处理行: <span class="hljs-subst">${line.take(50)}</span>..."</span>)
    })
    
    source.close()
  }
}
</code></pre>
<h4 data-id="heading-15">2. <strong>流式数据处理</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">StreamProcessing</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 模拟流式数据源</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dataStream</span></span>: <span class="hljs-type">Iterator</span>[<span class="hljs-type">Int</span>] = {
      <span class="hljs-comment">// 在实际应用中可能来自网络、传感器等</span>
      <span class="hljs-type">Iterator</span>.from(<span class="hljs-number">1</span>).map { n =&gt;
        <span class="hljs-type">Thread</span>.sleep(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 模拟延迟</span>
        n * <span class="hljs-number">10</span>
      }
    }
    
    println(<span class="hljs-string">"流式数据处理:"</span>)
    <span class="hljs-keyword">val</span> processed = dataStream
      .filter(_ % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>)  <span class="hljs-comment">// 过滤</span>
      .map(_ / <span class="hljs-number">2</span>)           <span class="hljs-comment">// 转换</span>
      .take(<span class="hljs-number">5</span>)              <span class="hljs-comment">// 限制数量</span>
    
    processed.foreach(item =&gt; println(<span class="hljs-string">s"处理结果: <span class="hljs-subst">$item</span>"</span>))
  }
}
</code></pre>
<h4 data-id="heading-16">3. <strong>分页处理</strong></h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Pagination</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 模拟数据库查询结果</span>
    <span class="hljs-keyword">val</span> allData = (<span class="hljs-number">1</span> to <span class="hljs-number">100</span>).iterator
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getPage</span></span>(page: <span class="hljs-type">Int</span>, pageSize: <span class="hljs-type">Int</span>): <span class="hljs-type">List</span>[<span class="hljs-type">Int</span>] = {
      <span class="hljs-keyword">val</span> start = (page - <span class="hljs-number">1</span>) * pageSize
      allData.slice(start, start + pageSize).toList
    }
    
    println(<span class="hljs-string">"第1页（每页10条）:"</span>)
    println(getPage(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>))
    
    println(<span class="hljs-string">"\n第2页（每页10条）:"</span>)
    println(getPage(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>))
  }
}
</code></pre>
<h3 data-id="heading-17">六、注意事项和最佳实践</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">IteratorBestPractices</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1. 不要重复使用已耗尽的迭代器</span>
    <span class="hljs-keyword">val</span> iter = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).iterator
    iter.foreach(println)  <span class="hljs-comment">// 消耗迭代器</span>
    
    <span class="hljs-comment">// val sum = iter.sum  // 错误！迭代器已空</span>
    
    <span class="hljs-comment">// 正确做法：重新创建</span>
    <span class="hljs-keyword">val</span> newIter = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).iterator
    println(<span class="hljs-string">s"重新创建的迭代器求和: <span class="hljs-subst">${newIter.sum}</span>"</span>)
    
    <span class="hljs-comment">// 2. 避免在遍历过程中修改底层集合</span>
    <span class="hljs-keyword">val</span> list = scala.collection.mutable.<span class="hljs-type">ListBuffer</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    <span class="hljs-keyword">val</span> badIter = list.iterator
    
    <span class="hljs-comment">// 遍历时修改集合可能导致不确定行为</span>
    <span class="hljs-comment">// list += 4  // 危险操作！</span>
    
    <span class="hljs-comment">// 3. 对于需要多次遍历的情况，使用集合而不是迭代器</span>
    <span class="hljs-keyword">val</span> data = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    
    <span class="hljs-comment">// 需要多次访问时</span>
    println(<span class="hljs-string">s"第一次访问: <span class="hljs-subst">${data.sum}</span>"</span>)
    println(<span class="hljs-string">s"第二次访问: <span class="hljs-subst">${data.product}</span>"</span>)
    
    <span class="hljs-comment">// 4. 使用视图（View）进行惰性链式操作</span>
    <span class="hljs-keyword">val</span> result = (<span class="hljs-number">1</span> to <span class="hljs-number">1000000</span>).view
      .filter(_ % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
      .map(_ * <span class="hljs-number">2</span>)
      .take(<span class="hljs-number">10</span>)
      .toList
    
    println(<span class="hljs-string">s"使用视图处理: <span class="hljs-subst">$result</span>"</span>)
  }
}
</code></pre>
<h3 data-id="heading-18">总结</h3>
<p><strong>迭代器的优点：</strong></p>
<ul>
<li>惰性求值，节省内存</li>
<li>适合处理大量或无限数据</li>
<li>提供丰富的操作链</li>
<li>不存储数据，只提供访问方式</li>
</ul>
<p><strong>迭代器的缺点：</strong></p>
<ul>
<li>只能遍历一次</li>
<li>不能随机访问</li>
<li>某些操作可能效率较低</li>
</ul>
<p><strong>选择建议：</strong></p>
<ul>
<li>处理大文件或流数据 → 使用迭代器</li>
<li>需要多次访问数据 → 使用集合</li>
<li>需要惰性处理链 → 使用视图或迭代器</li>
<li>需要随机访问 → 使用数组或索引序列</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅]]></title>    <link>https://juejin.cn/post/7591465142451486772</link>    <guid>https://juejin.cn/post/7591465142451486772</guid>    <pubDate>2026-01-05T05:43:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591465142451486772" data-draft-id="7591330139083784207" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-05T05:43:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="熊猫钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1303344484202867"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1303344484202867/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    熊猫钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:43:52.000Z" title="Mon Jan 05 2026 05:43:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    170
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅</h2>
<p>2025年我初识TRAE，也是这一年刚刚加入掘金社区，认识了很多热心的小伙伴，有你们相伴的感觉真好。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9145f6881a9432b927a3460a07eee26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=5oQh3%2FWNg8O39uwOiaAKN7nmhkQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>今年的年终总结应该是特别的，这一年TRAE带给我的收获满满。</p>
<p>回首2025年，我不仅用TRAE编写了大量的代码，开发出了好几款应用，同时也用它撰写报告和制作分析图表，它总是能一次又一次带给我震撼和惊喜。</p>
<p>我相信，TRAE使我相信，AI的时代真的到来了！</p>
<h3 data-id="heading-1">一、TRAE ：开发与创作同行</h3>
<p>我初次使用TRAE是在VS Code IDE中安装Trae插件。开发了一款简单实用的Excel合并工具。</p>
<p>这是我第一次用TRAE，使用VibeCoding的感觉太奇妙了!~</p>
<p>因为我在日常办公和数据处理中，经常会需要对Excel文件资料进行合并，汇总分散在不同文件中的数据，这是一个常见但繁琐的任务，耗时耗力，传统的手动操作不仅效率低下，而且容易出错。专门写代码也需要花费不小的功夫去开发和调试，显得有些鸡肋，因此，我想利用AI工具快速开发一个Excel多文件多表合并工具。</p>
<p>我只是简单在Trae的聊天框中输入：
"请帮我在当前工程下完成一个Excel多文件多表合并工具。该工具支持Windows系统，无需安装，打开即可使用。"
Trae立即响应，建议使用Python的pandas库来处理Excel文件，并自动创建了一个新的Python脚本。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8881e20e18fc49a08253f16a52541884~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=vVgmoV6myD86RjRnQFIAjFWk31A%3D" alt="在这里插入图片描述" loading="lazy"/>
Trae Builder模式初体验，我觉得它能够理解自然语言描述的项目需求，并自动生成可运行的代码框架，而且速度特别快，只用了十来分钟就完成了可用的程序功能。</p>
<p>感谢掘金社区这么一个平台的存在。</p>
<p>我把我的经历和感悟都写出了博客进行分享。</p>
<p>5月19日，我首次发布了两篇文章，心情忐忑又激动。
《对话即编程：如何用 Trae 的 @智能体 5 分钟修复一个复杂 Bug？》《从编程助手到AI工程师：Trae插件Builder模式实战Excel合并工具开发》</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a93df564f4a422e8062f8b5675de077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=iy1hYfId%2BDpn8LMaRSR4BEYg9zs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>以及之后创作了《 超快速开发！手把手教你基于Trae IDE 04.22构建智能磁盘清理工具——AI原生开发范式实践 》等文章，很快就都被推荐到掘金社区的首页。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35ef31d1109040b08ede7f9c30706a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=Tf7xor76T%2FGgDI5SZXsK5znCnNQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>随后，更是获得了社区的多篇征文奖励，使我备受鼓舞。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae41ea9c2804c4f8cb595cc4f4ebdd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=vBVLF5fIOPO59wANckiwNEbFwkM%3D" alt="w6.jpg" loading="lazy"/></p>
<p>社区的分享讨论，使我更加有信心利用先进的AI编程工具解决代码难题，提升工作效率。同时增加了与志同道合的小伙伴们的交流，社区的朋友们总是热情地解答我的问题，给予了我大量无私的帮助。</p>
<p>这一年我给TRAE.ai的公众号写了几篇文章，被授予了“年度创作之星”。这项珍贵的荣誉，给我的2025年画上了一个完美的句号。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09896cdba7884bb3a3b881bf693ddcce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=bb6OA2RV8kajUPGflU9E%2B4Agu9c%3D" alt="w4.jpg" loading="lazy"/></p>
<h3 data-id="heading-2">二、TRAE 年度报告：MVP书写感动！</h3>
<p>看到年度报告的那一刻，我有些惊讶。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f094ce9ae77241508c07ba3556459b92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=WFTW3HbIOiNeHpJyWGnFMHQL%2BnQ%3D" alt="w3.png" loading="lazy"/></p>
<p>创世神。全场MVP。超越99%用户的代码量。这些词组合在一起，我觉得对于我有些不可思议。</p>
<p>我真的只是一个新人，没想到这一年来，自己已经走过了这么远的路。</p>
<p>但屏幕上那个数字——172,106行代码，又实实在在地摆在那里。十倍于FC版《超级玛丽》的代码量，原来真的是TRAE伴随我一路风霜，它帮我一行一行敲出来的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59b48e9b9e754dc78c1456787bef820c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=cGltpM35q1Llr8Lyjzq1bF3xkQc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>2026年1月4日，我写下这篇总结的最终版。距离我第一次使用TRAE，已经过去了220天。这220天里，TRAE不仅是我的开发工具，更像是我的伙伴，见证了我的成长与蜕变。</p>
<h3 data-id="heading-3">三、与TRAE朝夕相伴的日夜</h3>
<p>在这220天里，我见证了TRAE SOLO功能的多次更新：</p>
<ul>
<li><strong>AI代码补全增强</strong>：从简单的代码片段补全，到支持完整函数、类的生成，甚至能够理解项目上下文</li>
<li><strong>多语言支持优化</strong>：最初只支持Python、JavaScript等主流语言，现在已经支持Go、Java、Rust等多种语言</li>
<li><strong>调试能力提升</strong>：从只能生成代码，到能够协助调试、分析错误日志、提供修复方案</li>
<li><strong>项目管理功能</strong>：新增了项目模板、版本控制、协作功能，让SOLO开发也能享受团队级别的管理体验</li>
</ul>
<p>每次更新都让我感受到TRAE团队的用心，他们真正理解开发者的需求，并且快速响应。这种持续进化的能力，是TRAE最吸引我的地方之一。</p>
<p>90天的年度活跃天数，说多不多，说少也不少。但那些深夜里敲代码的时光，那些被bug折磨到抓狂的时刻，那些终于跑通程序时的兴奋，都真实地发生着。</p>
<p>6月2日那天，我写了12435行代码。现在回想起来，那天应该是在做"智能会议纪要助手"的第一个版本。为了实现实时转录功能，我和TRAE反复调试，从深夜10点一直到凌晨3点。当第一个完整的会议纪要生成出来时，我兴奋得像个孩子，立刻给朋友发了截图分享。</p>
<p>8月3日凌晨1点04分，我还沉迷在TRAE的世界里。那天是在修复项目中的一个bug。我和TRAE一起分析日志、调试代码，终于找到了问题所在：对话历史管理模块的缓存机制有问题。当我修复这个bug，夜色已深，我在疲倦中入睡，心情却异常安稳踏实。</p>
<p>10月26日那天，我在IDE里待了384分钟。那天是在优化"智能会议纪要助手"的性能，原来的模型处理长会议时会卡顿。我和TRAE一起尝试了多种优化方案，最终采用了分段处理和增量生成的方式，让系统能够流畅处理长达4小时的会议。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a444e077d34432783b75a05496b618f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=1ugs9f1lcArjxpyiPh3S5E8zV24%3D" alt="w4.png" loading="lazy"/></p>
<p>回想这一年，我的技能结构发生了巨大的变化。年初时，我还在为代码自动补全工具的小幅提升感到欣喜；到年中的TRAE黑客松，我已经能够利用AI平台在短时间内构建完整的应用；而到了年末，AI已经从单纯的辅助工具变成了我的"开发伙伴"。</p>
<p>黑客松之后，我开始认真思考如何将Demo转化为可用的产品。在开发项目的过程中，我经历了思维方式的深刻转变。</p>
<p>传统软件开发追求的是确定性和可控性——相同输入必须产生相同输出，每一步操作都应当可预测。而AI开发则建立在概率性基础上——相同的输入可能产生略有不同的输出，我们需要接受这种不确定性，并学会如何控制和优化它。</p>
<p>刚开始，这种不确定性让我很不适应。我习惯了精确控制每一行代码的执行结果，现在却要接受AI输出的"随机性"。但慢慢地，我发现这种不确定性其实是AI的魅力所在。它能够产生意想不到的创意，提供多样化的解决方案，让产品变得更加灵活和智能。</p>
<p>我学会了如何设计"容错"的系统，如何通过提示词工程引导AI输出期望的结果，如何建立质量评估机制来筛选AI生成的内容。这些经验成为了我2025年技术成长中最宝贵的财富。</p>
<p>更有趣的是，我发现独立开发者在AI应用方面表现最为积极。这主要得益于AI工具降低了技术门槛，使个人开发者也能实现原本需要团队才能完成的功能。这种趋势正在重塑整个软件开发生态，为更多创新提供了可能。</p>
<h3 data-id="heading-4">四、TRAE SOLO Hackathon线下活动：头脑风暴展示TRAE SOLO的魅力</h3>
<p>真正让我对TRAE产生质的认知的，是那场武汉场的TRAE SOLO黑客松。现在回想起来，TRAE SOLO功能的设计理念，其实早已预示了Vibe Coding的未来。</p>
<p>11月16日是一个值得纪念的周末，我有幸受邀参加了武汉场的TRAE SOLO Hackathon线下活动。当天上午的老师们的分享非常有趣，下午是我们battle的主场，武汉场的TRAE用户同伴也都很nice!</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d7e627048f3401cb85e39f42d66ecd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=Z3MPKocdW4j8vEgMX5WP%2F8py9gs%3D" alt="image.png" loading="lazy"/></p>
<p>值得一提的是，中午的盒饭和餐点真的很好吃！
晒一下我当天的伙食。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e05cb4cb1ba14b6188958e8b761389b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=2fbBvbTsEzrJlnNZd3eWyJaB1go%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在黑客松中，我仅用了半天3个小时就开发出了一个基本完整的应用：</p>
<p><strong>TRAE SOLO环游世界游戏轻应用</strong>：包含景点打卡系统、道具收集机制、道具交易系统、AI智能向导、成就系统等丰富功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/889668422e95419f803c04e4cdbee09a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=%2FPDv2jGt81Ic5yhjDbvdv5dJEvk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b643070db7704433acedd1e01b5685d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=7iIt0KnM8K3pt1j1ZHvPUIni8ZM%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5d71ba9c6474c4ebe72d51cb780306d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=K9KGIb6LdkTaWLqcAxUe%2F%2FUGjeY%3D" alt="3.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07842f276cc546929d7207ae2f24f3b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=4DJPLDqt0cbyqV8%2BytGUFzW4%2Bcs%3D" alt="image.png" loading="lazy"/></p>
<p>"环游世界"是一个与我以往开发办公应用实用工具为主相反的完全不同的尝试。</p>
<p>我想做一个游戏，让玩家通过对话的方式，在虚拟世界中旅行、探索、学习。这个想法听起来很简单，但实现起来需要复杂的对话系统、状态管理、内容生成。在传统开发模式下，这几乎是一个独立开发者无法完成的任务。</p>
<p>但TRAE SOLO改变了这一切。我能够快速集成智能对话系统，让NPC有自己的个性和记忆；能够轻松生成多样化的场景描述，从巴黎的埃菲尔铁塔到亚马逊的热带雨林；能够实现个性化的游戏体验，根据玩家的选择调整剧情走向。最让我感动的是，有玩家反馈说："这个游戏让我在屏幕前就感受到了世界的广阔"。</p>
<p>这个应用让我获得了二等奖的殊荣。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e3a440dc5d94a6597c8a4f4daa3d04d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769479682&amp;x-signature=KWnjRJj0OMy9QDLHoWZmEebsiDI%3D" alt="w5.jpg" loading="lazy"/></p>
<p>TRAE SOLO真正吸引我的地方，是它"一人即团队"的设计理念。在传统开发中，一个完整的项目需要前端、后端、测试等多个角色配合，而TRAE SOLO让我一个人就能完成整个开发流程。</p>
<p>最让我惊喜的是，TRAE SOLO不仅提供了强大的开发能力，还内置了<strong>轻应用发布</strong>功能，让我能够快速将作品分享给其他用户。这种"开发-发布-反馈"的闭环体验，极大地提升了我的开发热情。</p>
<h3 data-id="heading-5">写在最后：未来的展望</h3>
<p>创世神这个称号，听起来很厉害，但我知道，真正的"创世"不是写了多少代码，而是这些代码最终变成了什么。"智能会议纪要助手"帮助了很多人提高工作效率，"环游世界"游戏给玩家带来了快乐和启发，这些才是真正有价值的东西。</p>
<p>在这一年里，TRAE见证了我的技术成长。</p>
<p>新的一年就要来了，我对未来充满期待。我会继续写代码，继续学习，继续创造。我相信，在TRAE的陪伴下，我会创造出更多有价值的产品，结识更多有趣的人，经历更多精彩的故事。</p>
<p>就像TRAE说的，我们的冒险已经启程。220天只是开始，后面的路还很长。</p>
<p>——熊猫钓鱼，2026年1月5日</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏆2025 AI/Vibe Coding 对我的影响 | 年终征文]]></title>    <link>https://juejin.cn/post/7587675443442450472</link>    <guid>https://juejin.cn/post/7587675443442450472</guid>    <pubDate>2025-12-26T03:04:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442450472" data-draft-id="7586836874016751626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏆2025 AI/Vibe Coding 对我的影响 | 年终征文"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T03:04:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏆2025 AI/Vibe Coding 对我的影响 | 年终征文
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7255271989291450420/posts" data-v-d326b38e=""><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b3e5e62bb3a4eff89269d51825c4a1f~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7255271989291450420/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="掘金运营团队" class="title" data-v-d326b38e="">掘金运营团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-26T03:04:16.000Z" title="Fri Dec 26 2025 03:04:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-26
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                10,825
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读6分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              ❤首席客服君 @掘金
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d4ef939034d4f9e8f6f5798c339e98d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=YIR%2FBntEM6%2Fz8aMqHqeMjMjLpiw%3D" alt="img_v3_02t9_51022880-c5f3-4f3c-8892-b6f6ca1ba8eg.png" loading="lazy"/></p>
<p>当岁末的钟声临近，我们又站在了一年的重点回望。2025年，对你而言，是怎样的轮廓呢？</p>
<p>它或许是由一行行被AI重构的代码勾勒，是某个深夜与新技术“顿悟时刻”的灵光一现，也可能是生活中因为智能体工具而悄然改变的工作状态。</p>
<p>从智能体（Agent）的横空出世到多模态技术的经验突破，技术愈加深入地流淌尽我们的工作和生活日常，塑造着属于每个人的独特“Vibe”。</p>
<p>今天，稀土掘金正式发起这场专属社区的<strong>年终“围炉夜话”</strong> ，我们不谈宏大的行业预言，不设苛刻的评审框架。我们只想邀请您，记录下属于你的数字年轮。</p>
<h2 data-id="heading-0">✨主题 ：2025 AI/Vibe Coding对我的影响</h2>
<p>本次征文不再是一场竞赛，而是一次社区的年终“围炉夜话”。我们鼓励所有成员停下脚步，回望2025年技术与个人生活交织的痕迹。无论是代码世界的深刻变革，还是AI工具带来的细微习惯改变，每一次记录，都是我们共同的“数字年轮”。</p>
<h2 data-id="heading-1">⁉️如何参与</h2>
<p>发布文章时选择带话题 <strong><a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">#2025 AI/Vibe Coding 对我的影响#</a></strong> 就可以被统计到哦💁🏻</p>
<p align="left"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a9b3efe1391432e9d11a481dc69d654~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=Fi6kv83xpLQ7C18nrb42zLk60X0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">🗒️赛道说明</h3>
<p><code>参与者可以任选其一进行投稿，也可同时参与，不限制投稿文章数。</code></p>
<h4 data-id="heading-3">赛道一：2025，我的“Vibe Coding”时刻</h4>
<blockquote>
<p><strong>主题解读</strong></p>
<p>聚焦技术<strong>对“我”的个体影响</strong>。可以是一个AI工具、一个开源项目、一次技术决策、一种行业趋势，也可以是技术带来的某种生活方式。</p>
<p><strong>内容方向建议</strong></p>
<ul>
<li><em>Agent革命</em></li>
</ul>
<p>ChatGPT/Gemini如何改变我的开发效率，大模型如何让我的代码如鱼得水？（技术冲破对工作模式/效率带来的影响，任意模型/技术皆可）</p>
<ul>
<li><em>生活Vibe</em></li>
</ul>
<p>Web3、数字游民等概念开启的新生活尝试，分享自己用AI生成旅行攻略、创作音乐、辅导孩子学习的故事等；</p>
<ul>
<li><em>年度总结</em></li>
</ul>
<p>以个人视角，复盘你在某个技术领域（前端、后端、AI、运维等）或者生活上这一年的得失与观察。</p>
</blockquote>
<h4 data-id="heading-4">赛道二：「我和TRAE的这一年」</h4>
<blockquote>
<p><strong>主题解读</strong></p>
<p>一个针对TRAE的专属回忆录，记录掘金社区TRAE深度用户与其共同成长的故事。</p>
<p><strong>内容方向建议</strong></p>
<ul>
<li><em>成长见证</em></li>
</ul>
<p>记录自己使用TRAE完成的第一篇文章、第一个获赞、第一次参与开源项目、第一次开发的游戏等；</p>
<ul>
<li><em>连接故事</em></li>
</ul>
<p>通过社区所结识到的志同道合的TRAE友、参与的线下/线上活动、与TRAE官方运营互动的有趣瞬间；</p>
<ul>
<li><em>产品共建</em></li>
</ul>
<p>对TRAE功能提出的建议被采纳，或使用各个模式提升学习效率的真实体验瞬间。</p>
</blockquote>
<p><em>❗参加<strong>赛道二</strong> 的文章除话题 <a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">#2025 AI/Vibe对我的影响</a> 外，<strong>必须加上<a href="https://juejin.cn/tag/Trae" target="_blank" title="https://juejin.cn/tag/Trae">#TRAE</a>标签</strong>。</em></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca9a88a7ebd4c19ae7aa71c7101ef44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=bkJOuLGrW%2Fn%2Fkfs6iQGvBxAbMO4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">☝️征文要求</h3>
<p>本次征文活动需要符合主题，对于文章类型以及活动参与方式，我们有以下几点小要求。</p>
<ol>
<li>
<p>文章须为<strong>原创文章</strong>，内容符合<a href="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" target="_blank" title="https://juejin.cn/book/6844733795329900551/section/6844733795380232199">掘金社区的内容标准和规范</a>。</p>
</li>
<li>
<p>本次征文<strong>不限制文章题材</strong>，可以是你对行业的总结和见解，也可以是你对行业未来发展的预测，本次活动不接受下面几种文章：</p>
<ol>
<li>资源聚合类文章，例如 Awesome-List；</li>
<li>翻译类文章和利用AI生产文章；</li>
<li>与本次主题无关的文章；</li>
<li>学习笔记/知识点汇总类文章；</li>
<li>有失中立性、公正性的内容，比如由公司或者公司的代理机构（如公关公司）所撰写，单纯希望宣传自己的商业产品或者公司的内容；</li>
<li>内容与活动主题不符、非原创内容，有洗稿、营销软文、广告、抄袭嫌疑的文章。</li>
</ol>
</li>
<li>
<p>刷赞、刷量等有作弊行为的文章，直接取消比赛资格，不参与评选；</p>
</li>
<li>
<p>AI代写文章、AI聊天记录等不计入活动（AI检测超过<strong>70%</strong> 取消文章获奖资格）；</p>
</li>
<li>
<p>活动文章需要选择话题：<a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">juejin.cn/theme/detai…</a></p>
</li>
<li>
<p>获奖作品，著作权归作者所有，掘金拥有使用权；</p>
</li>
</ol>
<h3 data-id="heading-6">🥇奖项设置</h3>
<blockquote>
<p><em>文章将根据<strong>专家评审得分</strong>（占比70%）和<strong>文章热度</strong>（占比30%）得分加权计算。<strong>未获得官方推荐</strong>的文章不参与奖项评选。</em></p>
</blockquote>





























































<table><thead><tr><th>奖项名称</th><th>奖项设置</th><th>获奖人数</th><th>奖品名称</th><th>奖品图</th></tr></thead><tbody><tr><td><strong>主赛道</strong></td><td>优秀文章奖（前10篇）</td><td>10名</td><td>小熊（Bear）电烧烤炉 多功能料理锅电烤炉 DKL-D12A1</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfe1f14ebbba4ef4b00c4f1c9f804a58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=44uqC3XJAvdL15px7U5l%2BeMy9mw%3D" alt="image.png" loading="lazy"/></td></tr><tr><td/><td>掘金达人奖（11-40篇）</td><td>30名</td><td>稀土掘金 Yoyo抱枕新版-450g</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0994f46b5f64a0983edcae0dcaf582b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=i1SoWR7zaMEYhNGcWcdN7UFsMWU%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>阳光普照奖（41-100篇）</td><td>60名</td><td>稀土掘金 x ByteMall 联名盲盒</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a503e8c6651439081513b9eebf0e548~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=Yk6EwKX26nNTWOjUYIQhOGol7Y8%3D" alt="" loading="lazy"/></td></tr><tr><td><strong>TRAE特别赛道鼓励奖（叠加）</strong></td><td>TOP1-10</td><td>10名</td><td>价值200元 TRAE连帽卫衣+抱枕</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3df35e973e984ffabc678b056123c053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=3%2BLq%2FVH6fClH3y4JCi2q0fIjBlc%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9cdcce418454a83810d84be38fcfc78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=9%2FLgenqSscjvgmgu9wBJU31jKZo%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>TOP11-30</td><td>20名</td><td>价值100元 TRAE圆领卫衣</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cea27183efa24e44b251b24b35ba9434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=a3eBQcNpfBrsT5ZmNz8sQaj0joY%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>TOP31-50</td><td>20名</td><td>价值50元 TRAE单肩包</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/148795305e4248a684ba2a4c95709a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=V4Blcvr4XifsG1C8gxKTzU%2FMt9w%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>TOP51-100</td><td>50名</td><td>TRAE小鼠标垫</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23f8a2ea09714ea1ac2d9b8a41ce3248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769401938&amp;x-signature=%2B82uWlqHWsdWG7LXkMihwgONo0I%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<h2 data-id="heading-7">🤵征文对象</h2>
<p>掘金社区全体掘友</p>
<h2 data-id="heading-8">⏰活动时间</h2>
<p>2025年12月26日——2026年1月25日23:59</p>
<h2 data-id="heading-9">👀 活动Q&amp;A</h2>
<p><strong>Q1：投稿数量有限制吗？</strong></p>
<p>A：没有。</p>
<p><strong>Q2：一篇文章可以同时参与多个社区活动吗？</strong></p>
<p>A：不行。一篇文章只能参与一个社区活动，可以写多篇文章参与不同的活动。</p>
<p><strong>Q3: 本次活动中写了多篇文章，可以多次获奖吗？</strong></p>
<p>A：参加特别赛道的文章，同时参与主赛道激励文章排名，中奖奖品兼得。但是，主赛道奖项一个用户只能获得一次，多篇文章上榜时选取最高名次获奖。</p>
<p><strong>Q4：如何算是成功参与了活动？</strong></p>
<p>A：活动期间，在掘金平台发布2025 AI/Vibe 对我的影响年终技术征文，选择带话题  <strong><a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">#2025 AI/Vibe Coding 对我的影响#</a></strong>  ，即可成功参与活动。注意话题≠标签！</p>
<h3 data-id="heading-10">💡注意事项</h3>
<p>2026年1月25日活动结束后，约10-15个工作日通过<strong>系统消息</strong>的形式公示获奖情况，预计填写问卷后的20个工作日内完成奖品发放。</p>
<p>技术浪潮奔涌向前，但属于个体的记忆同样珍贵。让我们用文字，为这不平凡的一年按下存档键。</p>
<p><strong>来掘金，写下你的2025。你的故事，我们都在听。</strong></p>
<blockquote>
<p>注：最终解释权归<em><strong>稀土掘金技术社区</strong></em> 官方所有</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 基础用法与核心意义：让 JavaScript 更 “靠谱”]]></title>    <link>https://juejin.cn/post/7597083949834076166</link>    <guid>https://juejin.cn/post/7597083949834076166</guid>    <pubDate>2026-01-20T06:37:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083949834076166" data-draft-id="7597230546238750756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 基础用法与核心意义：让 JavaScript 更 “靠谱”"/> <meta itemprop="keywords" content="JavaScript,TypeScript"/> <meta itemprop="datePublished" content="2026-01-20T06:37:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 基础用法与核心意义：让 JavaScript 更 “靠谱”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T06:37:45.000Z" title="Tue Jan 20 2026 06:37:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TypeScript 基础用法与核心意义：让 JavaScript 更 “靠谱”</h2>
<p>JavaScript 作为前端开发的核心语言，凭借弱类型、动态性的特点，拥有上手快、灵活度高的优势，成为初学者和小型项目的首选。但在大型项目开发中，弱类型带来的 “隐性问题” 却让开发者头疼不已 —— 变量类型随意变更、函数参数类型不匹配、代码逻辑二义性等问题，往往要到运行阶段才暴露，极大增加了调试成本和代码维护难度。</p>
<p>TypeScript（简称 TS）作为 JavaScript 的超集，由微软开发并维护，核心目标是为 JavaScript 添加<strong>静态类型系统</strong>，从 “运行时找错” 转向 “编译期纠错”，既能兼容所有 JavaScript 语法，又能通过类型约束提升代码的健壮性和可读性。下面结合实际代码，详解 TS 的基础用法与核心意义。</p>
<h3 data-id="heading-1">一、TS 的核心意义：解决 JavaScript 弱类型的痛点</h3>
<h4 data-id="heading-2">1. 杜绝类型二义性，避免逻辑错误</h4>
<p>JavaScript 的弱类型特性导致相同语法可能有完全不同的行为，比如加法运算会因参数类型不同变成拼接：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1.js - JS弱类型导致的二义性 </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a,b</span>) { 
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// 若a是数字、b是字符串，结果是拼接而非加法 </span>
} 
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">add</span>(<span class="hljs-number">10</span>,<span class="hljs-string">"5"</span>); 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// 输出"105"，而非预期的15</span>
</code></pre>
<p>而 TS 通过<strong>类型注解</strong>限定参数和返回值类型，编译阶段就会拦截错误：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 2.ts - TS强类型约束</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addTs</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>):<span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-keyword">const</span> result3 = <span class="hljs-title function_">addTs</span>(<span class="hljs-number">10</span>,<span class="hljs-string">'5'</span>); <span class="hljs-comment">// 编译报错：类型"string"的参数不能赋给类型"number"的参数</span>
</code></pre>
<p>只需在函数参数后加<code>:类型</code>，返回值前加<code>:类型</code>，就能明确约束类型，从源头杜绝此类错误。</p>
<h4 data-id="heading-3">2. 提前暴露错误，降低调试成本</h4>
<p>JavaScript 是动态语言，类型错误只有运行时才会发现；而 TS 的静态类型检查在编写代码（编译）阶段就提示错误。比如 JS 中变量可以随意变更类型：</p>
<pre><code class="hljs language-ini" lang="ini">// 4.js - JS变量类型无约束
var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">; </span>
<span class="hljs-attr">a</span> = <span class="hljs-string">"11"</span><span class="hljs-comment">; // 数字类型变量被赋值为字符串，无任何提示</span>
</code></pre>
<p>TS 中若给变量指定类型后，强行赋值其他类型会直接报错：</p>
<pre><code class="hljs language-ini" lang="ini">// 4.ts - TS类型约束 
let a:<span class="hljs-attr">number</span> = <span class="hljs-number">1</span><span class="hljs-comment">; </span>
<span class="hljs-attr">a</span> = <span class="hljs-string">"11"</span><span class="hljs-comment">; // 编译报错：不能将类型"string"分配给类型"number"</span>
</code></pre>
<p>这种 “提前纠错” 的特性，能让开发者在编码阶段就发现问题，而非等到测试或生产环境才暴露。</p>
<h4 data-id="heading-4">3. 提升代码可读性与可维护性</h4>
<p>大型项目中，开发者往往需要阅读他人代码。TS 的类型注解相当于 “自带文档”，无需运行代码就能明确变量、函数的用途和类型。比如 TS 的函数定义：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 3.ts - TS函数类型注解 </span>
<span class="hljs-function">function <span class="hljs-title">getArea</span><span class="hljs-params">(width:number, height:number)</span>:number{</span> 
    let area:number = width*height; 
    <span class="hljs-keyword">return</span> area; 
 }
</code></pre>
<p>一眼就能看出<code>getArea</code>接收两个数字类型参数，返回数字类型结果；而对应的 JS 代码：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 3.js - JS函数无类型提示 </span>
<span class="hljs-function">function <span class="hljs-title">getArea</span><span class="hljs-params">(width, height)</span> </span>{ 
    var area = width * height; 
    <span class="hljs-keyword">return</span> area; 
 }
</code></pre>
<p>若不看函数内部逻辑，无法确定参数和返回值的类型，维护成本显著增加。</p>
<h3 data-id="heading-5">二、TS 的基础用法：从核心语法开始</h3>
<p>TS 的核心是 “类型约束”，以下是最常用的基础语法，结合代码逐一说明：</p>
<h4 data-id="heading-6">1. 基本类型注解</h4>
<p>TS 支持 JavaScript 的所有原始类型，并为其提供明确的类型注解，语法为<code>变量名: 类型 = 值</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 4.ts - 基本类型注解 </span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">a</span>:<span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 数字类型 </span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">b</span>:<span class="hljs-built_in">string</span> = <span class="hljs-string">'hello'</span>; <span class="hljs-comment">// 字符串类型 </span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">c</span>:<span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔类型 </span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">d</span>:<span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// null类型 </span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">e</span>:<span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// undefined类型</span>
</code></pre>
<p>这是 TS 最基础的用法，通过类型注解固定变量类型，避免随意变更。</p>
<h4 data-id="heading-7">2. 数组与元组</h4>
<ul>
<li>数组：指定数组内元素的统一类型，有两种写法：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>:<span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>]; <span class="hljs-comment">// 数字数组：只能存放数字 </span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">arr2</span>:<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>]; <span class="hljs-comment">// 泛型写法：字符串数组</span>
</code></pre>
<ul>
<li>元组：固定长度和位置的数组，每个位置类型可不同：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>:[<span class="hljs-built_in">number</span>,<span class="hljs-built_in">string</span>] = [<span class="hljs-number">1</span>,<span class="hljs-string">'Tom'</span>]; <span class="hljs-comment">// 第一个元素是数字，第二个是字符串</span>
</code></pre>
<h4 data-id="heading-8">3. 枚举类型（enum）</h4>
<p>枚举用于定义一组命名常量，提升代码可读性，比如状态码：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 4.ts - 枚举类型 </span>
<span class="hljs-built_in">enum</span> Status { 
    Pending, <span class="hljs-comment">// 默认值0 </span>
    Success, <span class="hljs-comment">// 默认值1 </span>
    Failed, <span class="hljs-comment">// 默认值2 } </span>
<span class="hljs-keyword">let</span> s:Status = Status.Pending; <span class="hljs-comment">// 赋值枚举值 </span>
s = Status.Success; <span class="hljs-comment">// 变更为成功状态</span>
</code></pre>
<p>相比直接使用数字<code>0/1/2</code>，枚举让状态含义更清晰。</p>
<h4 data-id="heading-9">4. any 与 unknown：灵活兼容与安全约束</h4>
<p>TS 支持 “放松类型约束” 的场景，核心是<code>any</code>和<code>unknown</code>：</p>
<ul>
<li><code>any</code>：“救命稻草”，放弃所有类型约束，变量可赋值任意类型，兼容原生 JS 代码：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">let aa:<span class="hljs-attr">any</span> = <span class="hljs-number">1</span><span class="hljs-comment">; </span>
<span class="hljs-attr">aa</span> = <span class="hljs-string">"11"</span><span class="hljs-comment">; // 允许赋值字符串 </span>
<span class="hljs-attr">aa</span> = {}<span class="hljs-comment">; // 允许赋值对象</span>
</code></pre>
<ul>
<li><code>unknown</code>：更安全的 “任意类型”，可接收任意值，但直接调用方法 / 属性会报错，需先做类型检测：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">let bb:<span class="hljs-attr">unknown</span> = <span class="hljs-number">1</span><span class="hljs-comment">; </span>
<span class="hljs-attr">bb</span> = <span class="hljs-string">'b'</span><span class="hljs-comment">; // 允许赋值字符串 </span>
bb.hello()<span class="hljs-comment">; // 报错：未知类型不能直接调用方法</span>
</code></pre>
<h4 data-id="heading-10">5. 接口（interface）与类型别名（type）：约束对象结构</h4>
<p>TS 通过<code>interface</code>或<code>type</code>约定对象的属性和类型，是大型项目的核心用法：</p>
<h5 data-id="heading-11">（1）接口（interface）：约定对象结构，支持可选属性、只读属性</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 4.ts - 接口约束 </span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> { 
    <span class="hljs-attr">name</span>:<span class="hljs-built_in">string</span>; <span class="hljs-comment">// 必选字符串属性 </span>
    <span class="hljs-attr">age</span>:<span class="hljs-built_in">number</span>; <span class="hljs-comment">// 必选数字属性 </span>
    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>:<span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性，不可修改 </span>
    hobby?:<span class="hljs-built_in">string</span>; <span class="hljs-comment">// 可选属性，可省略 </span>
 } 
<span class="hljs-keyword">const</span> <span class="hljs-attr">u</span>:<span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">id</span>:<span class="hljs-number">1</span>, 
    <span class="hljs-attr">name</span>:<span class="hljs-string">'李四'</span>, 
    <span class="hljs-attr">age</span>:<span class="hljs-number">11</span>, 
    <span class="hljs-comment">// hobby可选，可省略 </span>
    }; 
u.<span class="hljs-property">name</span> = <span class="hljs-string">'瓦弟'</span>; <span class="hljs-comment">// 允许修改普通属性 </span>
u.<span class="hljs-property">id</span> = <span class="hljs-number">1111</span>; <span class="hljs-comment">// 报错：只读属性不能修改</span>
</code></pre>
<h5 data-id="heading-12">（2）类型别名（type）：自定义类型，支持联合类型、对象类型等</h5>
<pre><code class="hljs language-ini" lang="ini">// 4.ts - 类型别名 
type <span class="hljs-attr">ID</span> = string | number<span class="hljs-comment">; // 联合类型：ID可以是字符串或数字 </span>
let num:<span class="hljs-attr">ID</span> = <span class="hljs-number">111</span><span class="hljs-comment">; // 允许赋值数字 </span>
type <span class="hljs-attr">UserType</span> = { 
    name: string<span class="hljs-comment">; </span>
    age: number<span class="hljs-comment">; </span>
    hobby?:string<span class="hljs-comment">; </span>
 }<span class="hljs-comment">; </span>
const f:<span class="hljs-attr">UserType</span> = { 
    name:'牢大', 
    age:111 
    // hobby可选，省略不报错 }<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-13">三、总结：TS 为何成为大型项目的首选？</h3>
<p>TS 并非替代 JavaScript，而是在其基础上补充了静态类型系统，核心价值体现在：</p>
<ol>
<li><strong>提前纠错</strong>：编译期发现类型错误，降低运行时 bug 概率；</li>
<li><strong>提升可读性</strong>：类型注解充当 “自文档”，让代码逻辑更清晰；</li>
<li><strong>增强可维护性</strong>：类型约束减少 “隐式类型错误”，适配团队协作和大型项目迭代；</li>
<li><strong>兼容 JS 生态</strong>：完全兼容 JavaScript 语法，可渐进式接入，无需重构现有代码。</li>
</ol>
<p>对于初学者，TS 的类型约束可能增加一点学习成本，但这份成本能换来代码质量的显著提升 —— 正如示例中所示，TS 能杜绝 90% 因类型问题导致的错误，这也是如今 React、Vue 等主流框架均推荐使用 TS 的核心原因。从 “写得快” 到 “写得稳”，TS 让 JavaScript 从灵活的 “脚本语言”，真正适配企业级大型项目的开发需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 官方纪录片观后：核心原理解析与来龙去脉]]></title>    <link>https://juejin.cn/post/7597080391879147530</link>    <guid>https://juejin.cn/post/7597080391879147530</guid>    <pubDate>2026-01-20T06:39:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597080391879147530" data-draft-id="7597080391879081994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 官方纪录片观后：核心原理解析与来龙去脉"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-20T06:39:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小朝快跑"/> <meta itemprop="url" content="https://juejin.cn/user/571401778248791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 官方纪录片观后：核心原理解析与来龙去脉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/571401778248791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小朝快跑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T06:39:20.000Z" title="Tue Jan 20 2026 06:39:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">你真的理解 React 的运作方式吗？</h2>
<p>这段时间在回顾自己过去几年的 React 项目时，我发现一个有点尴尬但很真实的情况：
我能熟练写 Hooks、拆组件、做性能优化，但如果有人让我用几分钟解释清楚——<strong>React 内部到底是怎么运作的</strong>，我往往说不太清楚。</p>
<p>我意识到，自己更多是在“使用 React”，而不是对它的实现原理形成了稳定的直觉。</p>
<p>带着这个问题，我重新完整看了一遍 React 官方纪录片
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D8pDqJVdNa44" target="_blank" title="https://www.youtube.com/watch?v=8pDqJVdNa44" ref="nofollow noopener noreferrer">React.js: The Documentary</a>。
本文正是基于这次回看后的整理与思考，尝试从实现与演进的角度，把 React 那些零散的概念重新串起来。</p>
<hr/>
<h2 data-id="heading-1">1. 混乱的源头：React 诞生前的“状态噩梦”</h2>
<p>想象一下，你正在管理一家巨型餐厅。这家餐厅有数百名厨师（<code>Model</code>），数百名传菜员（<code>Controller</code>），以及成千上万的食客（<code>View</code>）。起初，一切运转良好。但随着规模扩大，情况开始失控：</p>
<ul>
<li><strong>双向的数据流 MVC 模式</strong>：传菜员不仅把菜从后厨端给客人，客人还能直接把菜退回给任意一位厨师，甚至自己跑进后厨修改菜单。</li>
<li><strong>不可预测的连锁反应</strong>：A 桌客人退了一道菜，这个动作莫名其妙地导致 B 桌的菜单被修改，C 桌的账单出现了错误。当 Bug 出现时，你根本无法追溯是哪个环节出了问题。</li>
</ul>
<p>这就是 React 诞生前，以 <code>MVC 架构</code>和<code>数据双向绑定</code>为主流的前端世界面临的“状态噩梦”。正如纪录片中提到的，Facebook 的广告系统和聊天系统就是这样复杂的“餐厅”。</p>
<p>随着应用规模的指数级增长，数据流向变得错综复杂、无法预测，这成为了 Bug 的温床，让开发者的大脑不堪重负，难以维护和理解代码。这，就是 Jordan Walke 和 Facebook 团队面临的根本问题。</p>
<p>面对这种混乱，React 提出了一个在当时看来极其疯狂，却又无比优雅的方案。</p>
<h2 data-id="heading-2">2. Jordan Walke 的“疯狂想法”：推倒一切，重新来过</h2>
<h3 data-id="heading-3">2.1 阐述核心思想</h3>
<p>面对 Jordan Walke 所说的前端开发中最难的<code>更新（Updates）</code>问题——即手动找到特定的 DOM 节点并小心翼翼地修改它，他提出了一个革命性的建议：<mark>“忘掉数据绑定，状态一变就把整个界面推倒重来。（blow away the entire UI and re-render all of it）”。</mark></p>
<p>这背后是一种深刻的<strong>函数式思想</strong>：<code>UI = f(state)</code>。</p>
<p>这意味着，<mark>用户界面（<code>UI</code>）永远只是当前状态（<code>State</code>）的一个纯粹的可视化映射。</mark><mark>开发者不再需要关心“如何从旧状态变到新状态”，只需关心“在某个特定状态下，UI 应该长什么样”。</mark></p>
<h3 data-id="heading-4">2.2 解释其颠覆性</h3>
<p>这种思想的颠覆性，可以用“修补旧衣服”和“直接换新衣服”来对比：</p>
<ul>
<li><strong>传统命令式（修补旧衣服）</strong>：当衣服破了个洞，你需要精确地找到破损的位置，选择合适的布料和针线，小心翼翼地进行修补。这个过程繁琐、易错，且每次修补都可能引入新的问题。这就是<strong>手动操作 <code>DOM</code></strong>。</li>
<li><strong>React 声明式（直接换新衣服）</strong>：你根本不关心衣服哪里破了。你只保留一个关于“理想衣服”的设计图（你的组件代码）。只要身材数据（<code>State</code>）有任何变化，你就直接根据最新的设计图，生成一件全新的、完美的衣服来替换旧的。</li>
</ul>
<p>这种模式将开发者的关注点从繁琐、易错的 DOM 操作中解放出来，<mark>只需专注于管理状态本身</mark>，极大地降低了构建复杂应用的认知负荷。</p>
<p>然而，“推倒一切重新渲染”听起来会导致严重的性能问题。React 是如何让这个想法在现实中变得高效可行的呢？</p>
<h2 data-id="heading-5">3. 化腐朽为神奇：React 的三大核心引擎</h2>
<p>React 并非真的在浏览器中“推倒一切”，而是通过三大核心引擎，将这个“疯狂想法”变得无比高效。</p>
<h3 data-id="heading-6">3.1 Virtual DOM：聪明的“质检员”</h3>
<p><code>Virtual DOM</code> (虚拟 DOM) 是 React 的性能基石。它让“重新渲染一切”的狂野想法在性能上变得可行。</p>
<ol>
<li><strong>建筑草图对比</strong>：React 并不直接操作昂贵的真实 <code>DOM</code>（真实的建筑）。而是在内存中维护两份轻量级的 UI “草图”（<code>Virtual DOM</code>）：<strong>更新前的</strong>与<strong>根据新状态生成的</strong>。</li>
<li><strong>找出差异</strong>：当状态变化时，它会对比新旧两份“草图”，通过高效的 <code>diff</code> 算法，快速找出真正变化的差异点。</li>
<li><strong>精准施工</strong>：最后，它只把真正发生变化的“砖瓦”（<code>DOM</code> 节点）更新到真实的建筑（<code>DOM</code>）上，从而实现<strong>最小化更新</strong>。</li>
</ol>
<p>纪录片中一个极具说服力的故事来自 React 早期贡献者 Christopher Chedeau。在加入 Facebook 前，他曾为《魔兽世界》开发过一个公会搜索工具，并花费了数月时间，手动极致优化了一个包含 20,000 个条目的列表搜索功能。后来，当他尝试用 React 重写这个工具时，只用了半小时就实现了功能，并且性能与之前手动优化的代码处于同一数量级。</p>
<p>这正是 React 让 <code>UI = f(state)</code> 这一<strong>声明式模型</strong>在现实世界中变得足够高效的秘诀。</p>
<h3 data-id="heading-7">3.2 JSX：一场关于“关注点分离”的哲学革命</h3>
<p>JSX 在诞生之初曾遭遇毁灭性的抨击，因为它挑战了当时前端开发的“黄金法则”。</p>
<ol>
<li><strong>历史争议</strong>：在 2013 年的 JSConf 上，当 React 团队展示在 JavaScript 文件中编写类似 <code>HTML</code> 的 <code>JSX</code> 语法时，社区的反应是“这帮 Facebook 的工程师疯了”。当时的黄金法则是<strong>关注点分离</strong>，即 <code>HTML</code>、<code>CSS</code> 和 <code>JS</code> 必须分属不同文件目录，将它们混在一起被视为开历史的倒车。</li>
<li><strong>揭示深层逻辑</strong>：Jordan Walke 认为，<mark>真正的“关注点分离”不应是按技术（文件类型）分离，而应是按功能（组件）分离。</mark></li>
</ol>
<ul>
<li><strong>逻辑高度耦合</strong>：以一个“新闻流”组件为例，其 HTML 结构、CSS 样式和点击交互逻辑是紧密耦合、共同服务于一个单一功能的。</li>
<li><strong>原子化思维</strong>：将这些<strong>高度内聚</strong>的代码放在同一个目录（一个组件）中，反而使得这个功能单元更加独立、易于测试和复用。这才是更高级的、符合“原子化（Atomic）”思维的关注点分离。</li>
</ul>
<ol start="3">
<li>
<p><strong>关键案例：Netflix 的“30 天生死竞赛”</strong></p>
<p>当时，Netflix 需要重构其网站，在传统的 <code>Backbone.js</code> 和新潮的 React 之间犹豫不决。他们组织了一场为期 30 天的竞赛，让两组团队分别使用两种技术构建原型。结果，React 团队大获全胜，不仅开发速度更快，而且在处理复杂 UI 时表现出更高的性能和稳定性。这次工业界的有力背书，直接将 React 从“实验室怪胎”推向了“行业标准”的宝座。</p>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name }: { name: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-8">3.3 Fiber：丝滑调度的“时间管理大师”</h3>
<p><mark>即便有了 <code>Virtual DOM</code>，当组件树变得极其庞大时，计算新旧“草图”差异的过程本身也可能耗时过长，阻塞浏览器主线程，导致界面卡顿。</mark></p>
<p><code>Fiber</code> 架构正是为了让 <code>UI = f(state)</code> 哲学在 Facebook 规模的超大型应用中也能完美运行的最终答案，因为在这种规模下，即使是 <code>Virtual DOM</code> 的 <code>Diff</code> 过程本身也可能成为<strong>性能瓶颈</strong>。为此，React 16 引入了全新的 <code>Fiber</code> 架构作为底层重写，并最终在 React 18 中通过并发模式（<code>Concurrent Mode</code>）将其全部能力开放给开发者。</p>
<ol>
<li><strong>动机</strong>：<mark>旧的同步递归渲染机制就像一个“铁人厨师”，一旦开始做一桌满汉全席（<strong><em>渲染超大组件树</em></strong>），就必须做完所有菜才能停下来，<strong><em>期间无法响应顾客的任何新需求（如用户点击），导致界面“假死”。</em></strong></mark></li>
<li><strong>核心机制</strong>：
<ul>
<li><strong>任务拆解</strong>：<code>Fiber</code> 将渲染这道“大餐”拆解成许多可中断的“工作单元”（切菜、下锅、装盘）。<mark>每完成一个小单元，React 都会停下来，把控制权交还给浏览器，询问是否有更高优先级的任务（如用户输入）需要处理。</mark></li>
<li><strong>链表结构</strong>：为了实现<mark>可中断性</mark>，Fiber 放弃了传统的、一旦开始就无法停止的递归树遍历，改用链表结构。每个 Fiber 节点都有 <code>child</code>（子节点）、<code>sibling</code>（兄弟节点）、<code>return</code>（父节点）三个指针。这就像一套“书签”，让 React 可以随时暂停工作，并在稍后精准地回到暂停的位置继续。</li>
<li><strong>双缓冲技术</strong>：为了<mark>避免更新过程中的界面闪烁</mark>，Fiber 在内存中构建一棵“在建树（<code>work-in-progress tree</code>）”。<mark>所有计算和变更都在这棵不可见的树上进行。只有当整棵树完全准备就绪后，React 才会通过一个极快的指针切换操作，让它瞬间渲染在页面上，替换掉旧树。</mark></li>
</ul>
</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FiberNode</span> = {
  <span class="hljs-attr">child</span>: <span class="hljs-title class_">FiberNode</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">sibling</span>: <span class="hljs-title class_">FiberNode</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">return</span>: <span class="hljs-title class_">FiberNode</span> | <span class="hljs-literal">null</span>
}
</code></pre>
<p>当 UI 的渲染引擎变得无比强大后，如何为它提供清晰、可预测的“燃料”（数据），就成了新的核心议题。</p>
<h2 data-id="heading-9">4. 驯服数据流：从 Flux 到现代状态管理方案</h2>
<p>当渲染问题被完美解决后，下一个挑战就是确保 <code>UI = f(state)</code> 中的 <code>state</code> 本身是<strong>可预测</strong>和<strong>易于管理</strong>的。这催生了 <code>Flux</code> 架构。</p>
<h3 data-id="heading-10">4.1 Flux 架构：为数据流动建立“交通规则”</h3>
<ol>
<li><strong>定义</strong>：Flux 并非一个库或框架，而是由 Facebook 工程师陈静（Jing Chen）提出的一套架构思想——为应用数据流设计的<strong>交通规则</strong>。</li>
<li><strong>核心原则</strong>：这套架构诞生于 Facebook 臭名昭著的、充满 Bug 的消息系统所带来的混乱之中：一个未读消息数的微小变化就可能引发一连串不可预测的 Bug。<mark>Flux 强制规定了单向数据流，所有数据的变化必须严格遵循 <code>Action → Store → View</code> 的单向循环。</mark></li>
</ol>
<blockquote>
<p><strong><code>Action</code> (动作)</strong>：视图层发出的消息，描述发生了什么。</p>
<p><strong><code>Store</code> (存储)</strong>：应用状态和逻辑的中心，接收 Action 并更新自身状态。</p>
<p><strong><code>View</code> (视图)</strong>：根据 Store 中的新状态重新渲染。</p>
</blockquote>
<p>这种严格的单向循环，确保了任何状态变化都是可追溯、可预测的，彻底解决了数据乱流的问题。</p>
<h3 data-id="heading-11">4.2 Redux 的诞生：一场“演示驱动开发”的意外</h3>
<p><code>Redux</code> 的诞生充满戏剧性。当时，开发者 Dan Abramov 深受 Bret Victor 关于“时间旅行调试”的前瞻性演示的启发，希望在一场技术演讲中实现一个类似的酷炫功能——<strong>可以像拖动视频进度条一样回溯和重放应用的状态变化</strong>。为了这个目标，他将 Flux 的思想进行了简化和函数化，创造出了一个概念验证原型。</p>
<p>这个无心插柳的“演示驱动开发”产物，因其极致的可预测性和强大的调试能力，意外地成为了后来数年间统治前端状态管理的标准。</p>
<h3 data-id="heading-12">4.3 回到工程现场：我到底该把状态放在哪里？</h3>
<p>如果只看 <code>Flux</code> 和 <code>Redux</code> 的演进历史，状态管理似乎是一条非常清晰的演化路线。
但真正进入工程实践后，我才意识到：<strong>状态管理并不是一个一开始就能选对的决策</strong>。</p>
<p>在我自己的 React / umi 项目中，很长一段时间里，我其实处在一种并不完全确定的状态里：</p>
<ul>
<li>一开始会使用 <code>useContext + Provider</code>，解决最直接的状态共享问题</li>
<li>在 umi 项目中，自然会想到使用 <code>useModel</code></li>
<li>当状态开始被多个模块频繁依赖，又会开始考虑引入 <code>zustand</code></li>
</ul>
<p>但随之而来的，是一连串并不容易回答的问题：</p>
<blockquote>
<p>什么时候 <code>useModel</code> 就已经足够？</p>
<p>什么时候引入 <code>zustand</code> 是合理的复杂度，而不是过度设计？</p>
<p><code>useContext</code> 到底适合做全局状态，还是只适合小范围共享？</p>
</blockquote>
<p>这些困惑，并不是因为工具本身复杂，而是因为它们都在解决“状态共享”这个问题，但切入点并不相同。</p>
<hr/>
<h3 data-id="heading-13">4.4 从工程直觉出发，重新理解现代状态管理工具</h3>
<p>从工程直觉出发，他们并非简单的替代关系，而是针对<strong>传输成本</strong>、<strong>开发效率</strong>与<strong>性能精度</strong>三个维度的不同取舍。</p>
<h4 data-id="heading-14"><code>Context</code>（基础：送餐电梯）</h4>
<ul>
<li><strong>类比</strong>：电梯。它只负责把“菜”（数据）从顶层厨房传到负二层，避免服务员每层跑（即避开 Props 逐层传递）。</li>
<li><strong>重渲染原理</strong>：它是<strong>全量广播</strong>。一旦电梯里的菜变了，所有正在等这部电梯的客人（消费者组件）都会被强制检查并重新渲染，即便他们只想喝水而电梯里换的是牛排。</li>
<li><strong>工程建议</strong>：仅用于低频更新、全站通用的静态数据（如主题、语言、用户信息）。</li>
</ul>
<h4 data-id="heading-15"><code>useContext</code> + <code>useReducer</code>（升级：规范化厨房）</h4>
<ul>
<li><strong>类比</strong>：电梯 + 严格的菜谱。<code>useReducer</code> 确保了做菜逻辑（状态变更）是可预测的单向流（<code>Action -&gt; Reducer</code>）。</li>
<li><strong>重渲染原理</strong>：<strong>依然是全量广播</strong>。虽然更新逻辑变严谨了，但分发渠道还是那部“电梯”，<mark>数据一变，所有消费者依然会集体重渲染</mark>。</li>
<li><strong>工程建议</strong>：适合中小型项目，需要一定的状态变更规范，但组件树规模还没到产生性能瓶颈的程度。</li>
</ul>
<h4 data-id="heading-16"><code>useModel</code>（Umi）：自动化胶囊舱</h4>
<ul>
<li><strong>类比</strong>：自动化封装的独立电梯。它本质是 <code>Context</code> 的自动化封装，让你写 <code>Hook</code> 的手感就像在写全局 <code>Model</code>。</li>
<li><strong>重渲染原理</strong>：与 <code>Context</code> 一致。只要 <code>Model</code> 里的状态变了，所有调了该 <code>useModel</code> 的组件都会一起动。</li>
<li><strong>工程建议</strong>：追求极致开发效率的企业级中后台项目，在 Umi 生态下可以快速实现逻辑共享。</li>
</ul>
<h4 data-id="heading-17"><code>Zustand</code>：精准自动售货机</h4>
<ul>
<li><strong>类比</strong>：特种部队。它虽然也遵循单向数据流，但不再依赖电梯。</li>
<li><strong>重渲染原理</strong>：精准订阅（<code>Selector</code>）。组件像是在售货机上点单，只有当它订阅的那个“特定零食”（数据切片）变了，它才会重新渲染。即便有 20,000 个节点，它也能把影响范围锁定在最小单元。</li>
<li><strong>工程建议</strong>：大多数现代 React 项目的首选，特别是当业务复杂、需要高性能局部更新时。</li>
</ul>
<p>核心总结表：</p>








































<table><thead><tr><th>工具</th><th>工程角色</th><th>渲染精度</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td><code>Context</code></td><td>传输工具</td><td>广播式（低）</td><td>零成本、原生支持</td><td>易引发全量重渲染</td></tr><tr><td><code>useContext</code> + <code>useReducer</code></td><td>逻辑规范</td><td>广播式（低）</td><td>逻辑可预测</td><td>模板代码多、性能难调优</td></tr><tr><td><code>useModel</code></td><td>逻辑共享</td><td>广播式（中）</td><td>开发体验（DX）极佳</td><td>绑定框架、底层性能受限</td></tr><tr><td><code>Zustand</code></td><td>性能引擎</td><td>精准订阅（高）</td><td>高性能、无模板代码</td><td>需引入第三方库</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">4.5 Redux 在今天的角色：高上限，但有成本</h3>
<p>至于 <code>Redux</code>，我反而越来越把它视为一种<strong>能力上限很高，但组织成本同样明确存在</strong>的方案。</p>
<p>在真正需要严格数据流约束、完整调试链路（例如时间旅行、复杂中间件）的大型应用中，Redux 依然非常可靠；
但在很多业务型项目里，我更倾向于先使用更轻量的方案，把复杂度留给未来真正需要的时候。</p>
<hr/>
<p>回过头来看，React 生态中的这些状态管理方案，本质上都是在回答同一个问题：
<strong>如何让 <code>UI = f(state)</code> 中的 <code>state</code>，同样保持可预测、可推理。</strong></p>
<p>理解它们的差异，并不只是为了“选对工具”，而是为了在工程复杂度不断上升之前，提前意识到哪些问题是迟早会出现的。</p>
<h2 data-id="heading-19">5. 纪录片带给我们的启示：前端开发的最佳实践</h2>
<ul>
<li><strong>拥抱“原子化”思想</strong>：React 通过 <code>JSX</code> 重新定义了关注点分离，其核心是<mark>将 UI 拆分为独立的、可测试的、可复用的组件</mark>。这种思想鼓励我们构建高内聚、低耦合的功能单元，是现代前端工程化的基石。</li>
<li><strong>坚持单向数据流</strong>：从 <code>Flux</code> 到 <code>Redux</code> 再到 <code>Zustand</code>，状态管理库的形式在变，但其<mark>内核——单向数据流原则</mark>，始终是保证大型应用状态可预测、行为可控的黄金法则。</li>
<li><strong>价值驱动创新</strong>：Redux 的诞生故事告诉我们，最好的工具往往不是为了追求技术而技术，而是为了解决一个真实、具体且有价值的问题（如提升调试体验）而创造的。真正的创新源于对实际痛点的深刻洞察。</li>
</ul>
<h2 data-id="heading-20">6. 结语与延伸阅读</h2>
<p>React 的成功绝非偶然。它是一系列深刻洞察、大胆创新、社区共建以及关键时刻（如 Netflix 的选择）共同作用的结果。它从一个解决 Facebook 内部复杂 UI 问题的“疯狂想法”，演变成了一个庞大而繁荣的生态系统。</p>
<p>理解 React 演进背后的“为什么”，不仅仅是了解一段技术历史。它能帮助我们建立起对前端架构的宏观认知，让我们在面对未来层出不穷的新技术时，能够拨开表象，抓住本质，从而做出更明智、更长远的技术选型和架构设计。</p>
<h3 data-id="heading-21">延伸阅读</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fresults%3Fsearch_query%3DReact.js%253A%2BThe%2BDocumentary" target="_blank" title="https://www.youtube.com/results?search_query=React.js%3A+The+Documentary" ref="nofollow noopener noreferrer">React.js: The Documentary（YouTube）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fresults%3Fsearch_query%3DDan%2BAbramov%2BLive%2BReact%2BHot%2BReloading%2Bwith%2BTime%2BTravel%2BReact%2BEurope%2B2015" target="_blank" title="https://www.youtube.com/results?search_query=Dan+Abramov+Live+React+Hot+Reloading+with+Time+Travel+React+Europe+2015" ref="nofollow noopener noreferrer">Dan Abramov - Live React: Hot Reloading with Time Travel（React Europe 2015）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2F" target="_blank" title="https://react.dev/" ref="nofollow noopener noreferrer">React 官方文档：Reconciliation（协调）等核心概念</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot之@Transactional注解实践]]></title>    <link>https://juejin.cn/post/7596991930984857651</link>    <guid>https://juejin.cn/post/7596991930984857651</guid>    <pubDate>2026-01-20T06:42:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596991930984857651" data-draft-id="7596990822127927334" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot之@Transactional注解实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T06:42:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot之@Transactional注解实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T06:42:05.000Z" title="Tue Jan 20 2026 06:42:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Spring Boot大行其道的时代，开发者可以通过@Transactional注解来方便的操作事务</p>
<h2 data-id="heading-0"><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E9%259A%2594%25E7%25A6%25BB%25E7%25BA%25A7%25E5%2588%25AB%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB&amp;zhida_source=entity" ref="nofollow noopener noreferrer">隔离级别</a></strong></h2>
<p>@Transactional注解的isolation属性，可用来设置隔离级别。默认值为Isolation.DEFAULT。该属性可选值有：</p>
<ul>
<li><strong>Isolation.DEFAULT</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E6%25BA%2590%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E6%BA%90&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据源</a>默认隔离级别</li>
<li><strong>Isolation.READ_UNCOMMITTED</strong>：未提交读</li>
<li><strong>Isolation.READ_COMMITTED</strong>：已提交读</li>
<li><strong>Isolation.REPEATABLE_READ</strong>：可重复读</li>
<li><strong>Isolation.SERIALIZABLE</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E4%25B8%25B2%25E8%25A1%258C%25E5%258C%2596%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E4%B8%B2%E8%A1%8C%E5%8C%96&amp;zhida_source=entity" ref="nofollow noopener noreferrer">串行化</a></li>
</ul>
<h2 data-id="heading-1"><strong>回滚条件</strong></h2>
<p>@Transactional注解默认只会对RuntimeException、Error及其子类进行回滚。如果期望对检查异常进行回滚，可通过rollbackFor、rollbackForClassName属性添加新的回滚条件</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 方式1: 支持对所有异常类型进行回滚</span>
<span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)
<span class="hljs-comment">// 方式2：支持对所有异常类型进行回滚</span>
<span class="hljs-variable">@Transactional</span>(rollbackForClassName = {<span class="hljs-string">"Exception"</span>})
</code></pre>
<p>类似地，还可以排除某些异常，使之不发生回滚</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 方式1: 抛出ArithmeticException异常不进行回滚</span>
<span class="hljs-variable">@Transactional</span>(noRollbackForClassName = {<span class="hljs-string">"ArithmeticException"</span>} )
<span class="hljs-comment">// 方式2: 抛出ArithmeticException异常不进行回滚</span>
<span class="hljs-variable">@Transactional</span>(noRollbackFor = {ArithmeticException.class} )
</code></pre>
<p>上述四种回滚条件的属性对指定异常的子类也是生效的</p>
<h2 data-id="heading-2"><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%258F%25AA%25E8%25AF%25BB%25E4%25BA%258B%25E5%258A%25A1%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E5%8F%AA%E8%AF%BB%E4%BA%8B%E5%8A%A1&amp;zhida_source=entity" ref="nofollow noopener noreferrer">只读事务</a></strong></h2>
<p>@Transactional注解的readOnly属性默认为false，如需只读事务可将其配置为true。在只读事务中不允许执行读之外操作，否则事务将会回滚</p>
<h2 data-id="heading-3"><strong>事务传播行为</strong></h2>
<p>@Transactional注解的propagation属性可用来设置事务传播行为，默认值为<strong>Propagation.REQUIRED</strong>。其用来表示当一个事务传播行为修饰的方法(即methodB)被另一个方法(即methodA)调用时，事务如何进行传播</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceA</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">methodA</span>(<span class="hljs-params"/>) {
        ...
        serviceB.<span class="hljs-title function_">methodB</span>();
        ...
    }

}
...
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceB</span> {

    <span class="hljs-comment">// 通过propagation属性指定methodB方法的事务传播行为</span>
    <span class="hljs-meta">@Transactional</span>(propagation = ...)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">methodB</span>(<span class="hljs-params"/>) {
        ...
    }

}
</code></pre>
<h2 data-id="heading-4"><strong>Propagation.REQUIRED</strong></h2>
<p>支持当前事务；如果当前没有事务，则新建一个事务。如下图所示。这也是日常开发中最常使用的配置。在Case 1的场景下，无论methodA方法还是methodB方法出现异常，均会进行回滚，因为它们是在同一个事务中</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a44c2ce70df4aeea65f8793bad1d0ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769496125&amp;x-signature=EFT8z5u5kmPOTGFWbMpinGNm4M8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>Propagation.REQUIRES_NEW</strong></h2>
<p>新建事务；如果当前存在事务，则把当前事务挂起。如下图所示。以Case 1为例进行分析，由于methodA、methodB方法使用的是两个不同的事务，故当methodB方法提交后，即使methodA方法失败回滚了，也不会导致methodB方法出现回滚。当methodB方法失败回滚后，如果methodA未捕获methodB所抛出的异常，导致methodA继续抛出该异常则methodA方法也会被回滚；如果methodA方法捕获methodB所抛出的异常，则methodA所在的事务还是有可能提交成功的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f71b11f1d54d469286533ad01a126658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769496125&amp;x-signature=NrpmzZnxjd6SjRGLCFwpl2AAHEg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>Propagation.SUPPORTS</strong></h2>
<p>支持当前事务；否则将非事务方式执行。如下图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/965d90479ac649e8b0440e6f49be8c52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769496125&amp;x-signature=JGvf7XgX8Pog31s7E%2BC8cXgNZ5Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>Propagation.MANDATORY</strong></h2>
<p>支持当前事务；否则将抛出IllegalTransactionStateException异常，此时不仅methodB方法无法得到执行，也会打断methodA方法的执行流程，除非在methodA方法中捕获处理该异常。如下图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95b11835159d4b8f8b0eb6171c9bff00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769496125&amp;x-signature=hrPKaohX2yxwauSTaBMMZf2Cm9M%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8"><strong>Propagation.NOT_SUPPORTED</strong></h2>
<p>不支持当前事务，而是始终以非事务的方式执行。如下图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ded69d300434710a45aa830c511f1cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769496125&amp;x-signature=KgXcRStRtz2uU6WLj1OHvlJu66o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>Propagation.NEVER</strong></h2>
<p>以非事务方式执行；如果当前存在事务，则抛出IllegalTransactionStateException异常，此时不仅methodB方法无法得到执行，还会打断methodA方法的执行流程，甚至导致methodA方法发生回滚</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e95f7fc8611f4893af51de62130888ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769496125&amp;x-signature=%2FxLgnhjRucFG7e4fPjfOoBtilwQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>Propagation.NESTED</strong></h2>
<p>如果当前存在事务，则对于该传播行为修饰的方法会依然使用当前事务，这样一旦methodA方法进行回滚，则methodB方法也会进行回滚。但由于该传播行为是通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%25E4%25BA%258B%25E5%258A%25A1%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据库事务</a>的保存点进行实现的，那么一旦methodB方法抛出异常发生回滚。如果methodA方法捕获了methodB方法所抛出的异常，则methodA就不会因此而回滚；而methodA方法如果继续向上抛出异常则其也会被回滚；如果当前没有事务，则新建一个事务。如下图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26237c97500f488197c02c9de4c6e474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769496125&amp;x-signature=S%2FQ4iAOWoemVLr07nJ88TsQVvCo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11"><strong>Note</strong></h2>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E4%25BA%258B%25E5%258A%25A1%25E6%25B3%25A8%25E8%25A7%25A3%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E4%BA%8B%E5%8A%A1%E6%B3%A8%E8%A7%A3&amp;zhida_source=entity" ref="nofollow noopener noreferrer">事务注解</a>只会对public方法生效</strong></li>
</ol>
<p>当@Transactional事务注解添加在类上，表示其将作用于该类中的所有public方法</p>
<ol>
<li><strong>通过类内部调用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E4%25BA%258B%25E5%258A%25A1%25E6%2596%25B9%25E6%25B3%2595%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%B3%95&amp;zhida_source=entity" ref="nofollow noopener noreferrer">事务方法</a>，事务无法生效</strong></li>
</ol>
<p>例如下面代码所示，在A类内部通过一个普通方法methodA调用事务方法methodB，那么methodB的事务会生效么？</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">methodA</span>(<span class="hljs-params"/>) {
        ...
        <span class="hljs-title function_">methodB</span>();
        ...
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">methodB</span>(<span class="hljs-params"/>) {
        ...
    }

}
</code></pre>
<p>答案是<strong>否</strong>，原因很简单。这里我们将Spring AOP后的动态代理类ProxyA用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D167037274%26content_type%3DArticle%26match_order%3D1%26q%3D%25E4%25BC%25AA%25E4%25BB%25A3%25E7%25A0%2581%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=167037274&amp;content_type=Article&amp;match_order=1&amp;q=%E4%BC%AA%E4%BB%A3%E7%A0%81&amp;zhida_source=entity" ref="nofollow noopener noreferrer">伪代码</a>的形式给出，如下所示。可以看到，虽然动态代理类ProxyA中的methodB方法被加入了事务切面。但事实上调用ProxyA的methodA方法后，会直接进入目标类A中，即执行a.methodA()方法，然后直接调用A类中的methodB方法。换言之，methodB方法没有通过代理类ProxyA进行调用，自然其事务注解不会生效</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProxyA</span> {

    <span class="hljs-keyword">private</span> A a = <span class="hljs-keyword">new</span> A();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">methodA</span>()</span> {
        <span class="hljs-comment">// 执行目标方法</span>
        a.methodA();
    }


    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">methodB</span>()</span> {
        <span class="hljs-comment">// 前置增强</span>
        ...
        <span class="hljs-comment">// 执行目标方法</span>
        a.methodB();
        <span class="hljs-comment">// 后置增强</span>
        ...
    }

}
</code></pre>
<p>即使在A类的methodA上也添加@Transactional事务注解，methodB方法由于没走代理类ProxyA，故methodB方法依然还是使用methodA方法的事务。即使将methodB方法的传播行为设置为Propagation.REQUIRES_NEW，也不会重新开启一个新的事务。因为methodB方法连@Transactional注解都无法生效，设置传播行为更是无任何意义</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你真的知道npm是什么吗？]]></title>    <link>https://juejin.cn/post/7596962772145258511</link>    <guid>https://juejin.cn/post/7596962772145258511</guid>    <pubDate>2026-01-20T05:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596962772145258511" data-draft-id="7596989416760655907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你真的知道npm是什么吗？"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-20T05:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想秃头的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2754702534251820"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你真的知道npm是什么吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754702534251820/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想秃头的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:20:37.000Z" title="Tue Jan 20 2026 05:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为前端开发者，<code>npm</code> (Node Package Manager) 是我们日常开发中绕不开的工具 —— 从初始化项目、安装依赖，到发布自己的包，它贯穿了前端工程化的全流程。但很多开发者只停留在 <code>npm install</code> 的层面，对其核心原理和高级用法知之甚少。这篇文章将从基础到进阶，全方位拆解 npm，让你真正吃透这个工具。</p>
<h2 data-id="heading-0">一、npm 是什么？</h2>
<p><code>npm</code> 是 Node.js 的官方包管理工具，核心作用有三个：</p>
<ol>
<li><strong>包管理</strong>：安装、卸载、更新第三方依赖包（如 Vue、React、axios 等）；</li>
<li><strong>项目管理</strong>：通过 <code>package.json</code> 管理项目的元信息（名称、版本、脚本、依赖等）；</li>
<li><strong>脚本运行</strong>：执行自定义的命令脚本（如 <code>npm run dev</code>、<code>npm run build</code>）。</li>
</ol>
<blockquote>
<p>补充：npm 随 Node.js 一起安装，安装 Node.js 后即可使用（验证：终端输入 <code>npm -v</code> 查看版本）。</p>
</blockquote>
<h2 data-id="heading-1">二、npm 核心基础操作</h2>
<h3 data-id="heading-2">2.1 初始化项目（npm init）</h3>
<p>创建 <code>package.json</code>（项目核心配置文件）是使用 npm 的第一步：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 交互式初始化（手动输入项目信息）</span>
npm init

<span class="hljs-comment"># 快速初始化（所有选项默认，推荐日常使用）</span>
npm init -y
</code></pre>
<p>执行后会生成 <code>package.json</code> 文件，核心字段说明：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-project"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 项目名称（小写、无空格）</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 版本号（遵循语义化版本规范）</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 项目描述</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 入口文件</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 自定义脚本</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 生产环境依赖</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span> <span class="hljs-comment">// 开发环境依赖</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">2.2 安装依赖（npm install）</h3>
<p>这是最常用的命令，核心用法分三类：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装单个包（生产环境，写入 dependencies）</span>
npm install axios
<span class="hljs-comment"># 简写：npm i axios</span>

<span class="hljs-comment"># 2. 安装到开发环境（写入 devDependencies）</span>
npm install webpack --save-dev
<span class="hljs-comment"># 简写：npm i webpack -D</span>

<span class="hljs-comment"># 3. 安装指定版本</span>
npm install vue@3.4.0

<span class="hljs-comment"># 4. 安装全局包（如脚手架、工具类）</span>
npm install @vue/cli -g

<span class="hljs-comment"># 5. 安装 package.json 中所有依赖</span>
npm install
</code></pre>
<h3 data-id="heading-4">2.3 卸载 / 更新依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 卸载依赖</span>
npm uninstall axios
<span class="hljs-comment"># 简写：npm un axios</span>

<span class="hljs-comment"># 更新依赖</span>
npm update axios

<span class="hljs-comment"># 查看可更新的依赖</span>
npm outdated
</code></pre>
<h3 data-id="heading-5">2.4 运行自定义脚本（npm run）</h3>
<p>在 <code>package.json</code> 的 <code>scripts</code> 字段中定义脚本，通过 <code>npm run &lt;脚本名&gt;</code> 执行：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">npm run dev   <span class="hljs-comment"># 启动开发服务</span>
npm run build <span class="hljs-comment"># 打包构建</span>
npm run <span class="hljs-built_in">test</span>  <span class="hljs-comment"># 执行测试</span>
</code></pre>
<blockquote>
<p>小技巧：<code>start</code>、<code>test</code> 等内置脚本可省略 <code>run</code>，直接 <code>npm start</code>、<code>npm test</code>。</p>
</blockquote>
<h2 data-id="heading-6">三、npm 核心概念解析</h2>
<h3 data-id="heading-7">3.1 依赖类型：dependencies vs devDependencies</h3>




















<table><thead><tr><th>类型</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td>dependencies</td><td>生产环境依赖（项目运行必需）</td><td>axios、vue、react</td></tr><tr><td>devDependencies</td><td>开发环境依赖（仅开发 / 构建时使用）</td><td>webpack、vite、eslint</td></tr></tbody></table>
<p><strong>核心区别</strong>：执行 <code>npm install --production</code> 时，只会安装 <code>dependencies</code> 中的依赖（生产环境部署常用）。</p>
<h3 data-id="heading-8">3.2 package-lock.json 的作用</h3>
<p>很多开发者会疑惑：为什么安装依赖后会生成 <code>package-lock.json</code>？</p>
<ul>
<li><strong>锁定版本</strong>：记录每个依赖的精确版本、下载地址、依赖树，确保不同环境安装的依赖版本完全一致；</li>
<li><strong>加速安装</strong>：后续安装时无需重新解析依赖树，直接从 <code>package-lock.json</code> 读取，速度更快；</li>
<li><strong>注意</strong>：<code>package-lock.json</code> 需提交到 Git 仓库，不要手动修改！</li>
</ul>
<h3 data-id="heading-9">3.3 语义化版本（SemVer）</h3>
<p>npm 依赖版本遵循「语义化版本规范」，格式为：<code>主版本.次版本.补丁版本</code>（如 <code>3.4.2</code>）：</p>
<ul>
<li><strong>主版本（MAJOR）</strong> ：不兼容的 API 变更（如 2.0.0 → 3.0.0）；</li>
<li><strong>次版本（MINOR）</strong> ：兼容的功能新增（如 3.3.0 → 3.4.0）；</li>
<li><strong>补丁版本（PATCH）</strong> ：兼容的 bug 修复（如 3.4.1 → 3.4.2）。</li>
</ul>
<p>版本号前的符号含义（package.json 中常见）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.4.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 允许次版本和补丁更新（3.4.0 → 3.9.9）</span>
    <span class="hljs-attr">"axios"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"~1.6.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 仅允许补丁更新（1.6.0 → 1.6.9）</span>
    <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span> <span class="hljs-comment">// 任意版本</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">四、npm 高级用法</h2>
<h3 data-id="heading-11">4.1 查看包信息</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看包的详细信息（版本、依赖、文档地址等）</span>
npm info axios

<span class="hljs-comment"># 查看当前项目已安装的依赖</span>
npm list
<span class="hljs-comment"># 只看顶层依赖（更清晰）</span>
npm list --depth=0

<span class="hljs-comment"># 查看全局安装的包</span>
npm list -g --depth=0
</code></pre>
<h3 data-id="heading-12">4.2 发布自己的 npm 包</h3>
<p>如果你想分享自己的工具包到 npm 仓库，步骤如下：</p>
<ol>
<li>
<p><strong>注册 npm 账号</strong>：官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2F" target="_blank" title="https://www.npmjs.com/" ref="nofollow noopener noreferrer">npmjs.com</a> 注册，或终端执行 <code>npm adduser</code>；</p>
</li>
<li>
<p><strong>初始化包</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> my-utils &amp;&amp; <span class="hljs-built_in">cd</span> my-utils
npm init -y
</code></pre>
</li>
<li>
<p><strong>编写代码</strong>：创建核心文件（如 <code>index.js</code>）；</p>
</li>
<li>
<p><strong>发布包</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">npm login <span class="hljs-comment"># 登录账号（需输入用户名、密码、邮箱）</span>
npm publish <span class="hljs-comment"># 发布（首次发布需确保包名未被占用）</span>
</code></pre>
</li>
</ol>
<blockquote>
<p>注意：发布前需检查 <code>.npmignore</code> 文件（排除不需要发布的文件，如 node_modules、测试文件）。</p>
</blockquote>
<h3 data-id="heading-13">4.3 更换 npm 镜像源</h3>
<p>默认 npm 源在国外，下载速度慢，可切换到国内镜像（如淘宝源）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时切换（单次生效）</span>
npm install axios --registry=https://registry.npmmirror.com

<span class="hljs-comment"># 永久切换</span>
npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com

<span class="hljs-comment"># 查看当前源</span>
npm config get registry

<span class="hljs-comment"># 切回官方源</span>
npm config <span class="hljs-built_in">set</span> registry https://registry.npmjs.org/
</code></pre>
<blockquote>
<p>推荐工具：<code>nrm</code>（npm 源管理工具），可快速切换多个源：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash">npm install nrm -g
nrm use taobao <span class="hljs-comment"># 切换到淘宝源</span>
nrm <span class="hljs-built_in">ls</span> <span class="hljs-comment"># 查看所有可用源</span>
</code></pre>
</blockquote>
<h3 data-id="heading-14">4.4 清理缓存</h3>
<p>如果安装依赖时出现异常，可清理 npm 缓存：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看缓存路径</span>
npm config get cache

<span class="hljs-comment"># 清理缓存</span>
npm cache clean --force
</code></pre>
<h2 data-id="heading-15">五、常见问题与解决方案</h2>
<h3 data-id="heading-16">问题 1：安装依赖时报错 <code>EACCES: permission denied</code></h3>
<p>原因：权限不足（全局安装时常见）。解决方案：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方案1：使用 sudo（不推荐）</span>
sudo npm install -g @vue/cli

<span class="hljs-comment"># 方案2：修改 npm 全局目录权限（推荐）</span>
<span class="hljs-built_in">mkdir</span> ~/.npm-global
npm config <span class="hljs-built_in">set</span> prefix <span class="hljs-string">'~/.npm-global'</span>
<span class="hljs-comment"># 然后将 ~/.npm-global/bin 添加到系统环境变量</span>
</code></pre>
<h3 data-id="heading-17">问题 2：依赖安装成功但项目运行报错</h3>
<p>原因：依赖版本不兼容，或 <code>package-lock.json</code> 锁定的版本有问题。解决方案：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除 node_modules 和 package-lock.json</span>
<span class="hljs-built_in">rm</span> -rf node_modules package-lock.json

<span class="hljs-comment"># 重新安装</span>
npm install
</code></pre>
<h3 data-id="heading-18">问题 3：全局安装的包无法执行</h3>
<p>原因：全局包的安装路径未加入系统环境变量。解决方案：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 查看全局包路径</span>
npm config get prefix

<span class="hljs-comment"># 将该路径下的 bin 目录添加到系统环境变量（如 ~/.npm-global/bin）</span>
</code></pre>
<h2 data-id="heading-19">总结</h2>
<ol>
<li><code>npm</code> 是 Node.js 标配的包管理工具，核心用于依赖管理和脚本运行，<code>package.json</code> 是项目的核心配置文件；</li>
<li>掌握 <code>npm init</code>/<code>npm install</code>/<code>npm run</code> 等基础命令是前端开发的必备技能，区分 <code>dependencies</code> 和 <code>devDependencies</code> 能规范项目依赖；</li>
<li><code>package-lock.json</code> 用于锁定依赖版本，保证多环境一致性，高级用法（换源、发布包、清理缓存）能解决日常开发中的大部分问题。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lodash 源码解读与原理分析 - 数组那些事儿]]></title>    <link>https://juejin.cn/post/7597056049690411046</link>    <guid>https://juejin.cn/post/7597056049690411046</guid>    <pubDate>2026-01-20T05:26:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597056049690411046" data-draft-id="7596241980870262818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lodash 源码解读与原理分析 - 数组那些事儿"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T05:26:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Anita_Sun"/> <meta itemprop="url" content="https://juejin.cn/user/1811635884786839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lodash 源码解读与原理分析 - 数组那些事儿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1811635884786839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Anita_Sun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:26:18.000Z" title="Tue Jan 20 2026 05:26:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Lodash 作为前端开发的核心工具库，其数组函数之所以能兼顾高性能与高鲁棒性，并非简单封装原生 API，而是从<strong>算法选型、内存管理、执行效率、边界兼容</strong>四个维度进行系统性优化。本文先拆解贯穿所有数组函数的通用优化策略，再逐一分析核心函数的实现细节，完整揭示 Lodash 高性能的底层逻辑。</p>
<h2 data-id="heading-0">一、Lodash 数组函数的通用性能优化策略</h2>
<p>Lodash 所有数组函数都遵循一套统一的优化范式，这些范式是其高性能的核心基石，具体包含 8 个核心方向：</p>
<h3 data-id="heading-1">1. 边界检查与早期返回：避免无效计算</h3>
<p><strong>核心逻辑</strong>：函数执行初期就对空值、无效输入、边界场景做判断，直接返回结果，避免进入核心逻辑的无效遍历 / 计算。<strong>实现方式</strong>：</p>
<ul>
<li>
<p>优先校验 <code>array</code> 是否为 <code>null/undefined</code>，安全获取数组长度（<code>var length = array == null ? 0 : array.length</code>）；</p>
</li>
<li>
<p>对空数组、无效参数（如 <code>size &lt; 1</code>、<code>depth &lt; 0</code>）直接返回空数组 / 原数组，不执行后续逻辑；</p>
</li>
<li>
<p>对非数组 / 类数组输入，直接返回空数组或原值，避免属性访问报错。</p>
<p><strong>价值</strong>：减少无效的循环、函数调用、内存分配，提升函数冷启动速度，同时增强鲁棒性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 通用边界检查模板</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseFunction</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 安全获取长度：处理null/undefined</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 早期返回：空数组直接返回结果</span>
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> [];
  }
  <span class="hljs-comment">// 核心逻辑（省略）</span>
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-2">2. 内存预分配：避免动态扩容的性能损耗</h3>
<p><strong>核心逻辑</strong>：对可预知长度的结果数组，提前分配内存空间，替代 <code>push</code> 动态扩容的方式。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>通过计算目标长度（如分块数 <code>nativeCeil(length / size)</code>、切片长度 <code>end - start</code>）创建固定长度数组；</li>
<li>用索引赋值替代 <code>push</code>，避免数组长度翻倍扩容的内存重分配；</li>
<li>仅在长度不可预知时（如过滤类函数）使用 <code>push</code>，但仍通过双指针优化填充效率。</li>
</ul>
<p><strong>价值</strong>：减少 JavaScript 引擎的内存重分配和垃圾回收（GC）压力，大数组场景下性能提升 20%-30%。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// chunk 中的内存预分配</span>
<span class="hljs-keyword">var</span> result = <span class="hljs-title class_">Array</span>(<span class="hljs-title function_">nativeCeil</span>(length / size)); <span class="hljs-comment">// 预分配分块结果数组</span>
<span class="hljs-comment">// baseSlice 中的内存预分配</span>
<span class="hljs-keyword">var</span> result = <span class="hljs-title class_">Array</span>(length); <span class="hljs-comment">// 预分配切片结果数组</span>
</code></pre>
<h3 data-id="heading-3">3. 算法分层选型：按数据规模选择最优算法</h3>
<p><strong>核心逻辑</strong>：根据数组长度、有序性、数据类型选择不同算法，平衡「初始化开销」和「遍历效率」。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>有序数组：使用二分查找（时间复杂度 O (log n)）替代线性查找（O (n)），如 <code>sortedIndex</code>；</li>
<li>大数组（≥200）：使用 Set/SetCache 缓存（查找 O (1)）替代数组查找（O (n)），如 <code>uniq</code>；</li>
<li>小数组（&lt;200）：使用普通数组查找，避免 Set 初始化的额外开销；</li>
<li>多数组操作（如交集、差集）：基于最短数组遍历，减少迭代次数。</li>
</ul>
<p><strong>价值</strong>：不同数据规模下都能达到最优执行效率，大数组场景性能提升 5-50 倍。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// uniq 中的分层策略</span>
<span class="hljs-keyword">if</span> (length &gt;= <span class="hljs-variable constant_">LARGE_ARRAY_SIZE</span>) { <span class="hljs-comment">// LARGE_ARRAY_SIZE = 200</span>
  <span class="hljs-keyword">var</span> set = iteratee ? <span class="hljs-literal">null</span> : <span class="hljs-title function_">createSet</span>(array); <span class="hljs-comment">// 大数组用Set</span>
  <span class="hljs-keyword">if</span> (set) <span class="hljs-keyword">return</span> <span class="hljs-title function_">setToArray</span>(set);
} <span class="hljs-keyword">else</span> {
  seen = iteratee ? [] : result; <span class="hljs-comment">// 小数组用普通数组</span>
}
</code></pre>
<h3 data-id="heading-4">4. 位运算优化：替代算术运算提升执行速度</h3>
<p><strong>核心逻辑</strong>：用位运算替代 <code>Math.floor</code>、正负判断、整数转换等算术运算，利用 CPU 直接执行的特性提升效率。<strong>实现方式</strong>：</p>
<ul>
<li>计算中间索引：<code>var mid = (low + high) &gt;&gt;&gt; 1</code>（替代 <code>Math.floor((low+high)/2)</code>）；</li>
<li>确保正整数：<code>start &gt;&gt;&gt;= 0</code>（替代 <code>Math.max(start, 0)</code>）；</li>
<li>计算长度：<code>length = (end - start) &gt;&gt;&gt; 0</code>（避免负数，替代 <code>Math.max(end - start, 0)</code>）。</li>
</ul>
<p><strong>价值</strong>：位运算比算术运算快 10%-20%，且能避免浮点运算、整数溢出问题。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// sortedIndex 中的位运算优化</span>
<span class="hljs-keyword">var</span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number">1</span>; <span class="hljs-comment">// 无浮点、无溢出的中间索引计算</span>
</code></pre>
<h3 data-id="heading-5">5. 循环优化：最小化迭代器开销</h3>
<p><strong>核心逻辑</strong>：通过 <code>while</code> 循环 + 双指针替代 <code>for</code> 循环，减少迭代过程中的变量声明、属性访问、冗余计算。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>优先使用 <code>while</code> 循环：缓存数组长度（仅计算 1 次），避免每次迭代访问 <code>array.length</code>；</li>
<li>前置自增（<code>++index</code>）：替代后置自增（<code>index++</code>），减少临时变量存储；</li>
<li>双指针遍历：用两个指针分别遍历原数组（<code>index</code>）和填充结果数组（<code>resIndex</code>），减少长度计算；</li>
<li>短路循环：通过 <code>continue outer</code> 跳过无效迭代，减少比较次数。</li>
</ul>
<p><strong>价值</strong>：循环开销降低 10%-30%，高频遍历场景效果显著。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// compact 中的 while 循环 + 双指针</span>
<span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>, resIndex = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (++index &lt; length) { <span class="hljs-comment">// 前置自增，仅比较变量</span>
  <span class="hljs-keyword">var</span> value = array[index];
  <span class="hljs-keyword">if</span> (value) {
    result[resIndex++] = value; <span class="hljs-comment">// 双指针填充</span>
  }
}
</code></pre>
<h3 data-id="heading-6">6. 缓存机制：将 O (n) 查找降为 O (1)</h3>
<p><strong>核心逻辑</strong>：对频繁查找的场景，用缓存结构存储已遍历值，避免重复遍历比较。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>大数组场景：使用 <code>SetCache</code>（Lodash 封装的 Set 兼容版）缓存已遍历值，查找时间复杂度 O (1)；</li>
<li>小数组场景：复用结果数组作为缓存，减少额外内存分配；</li>
<li>多数组操作：缓存第一个数组的所有值，后续数组仅做查找对比。</li>
</ul>
<p><strong>价值</strong>：查找效率提升一个数量级，大数组去重 / 交集场景性能提升数倍。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// baseUniq 中的缓存机制</span>
seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetCache</span>; <span class="hljs-comment">// O(1) 查找缓存</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">includes</span>(seen, computed, comparator)) { <span class="hljs-comment">// 缓存查找</span>
  seen.<span class="hljs-title function_">push</span>(computed);
  result.<span class="hljs-title function_">push</span>(value);
}
</code></pre>
<h3 data-id="heading-7">7. 原生方法复用：利用引擎底层优化</h3>
<p><strong>核心逻辑</strong>：对浏览器已高度优化的原生方法，直接封装复用，避免手写逻辑的性能损耗。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>复用 <code>Array.prototype.push</code>/<code>reverse</code>/<code>slice</code> 等原生方法，如 <code>nativeReverse.call(array)</code>；</li>
<li>封装原生方法为内部函数（如 <code>arrayPush</code> 封装 <code>push</code>），统一兼容处理；</li>
<li>仅在原生方法有缺陷时（如 <code>indexOf</code> 不支持 NaN）手写替代逻辑。</li>
</ul>
<p><strong>价值</strong>：原生方法由浏览器引擎用 C++ 实现，执行效率远高于手写 JavaScript 逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// reverse 中的原生方法复用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-keyword">return</span> array == <span class="hljs-literal">null</span> ? array : nativeReverse.<span class="hljs-title function_">call</span>(array);
}
</code></pre>
<h3 data-id="heading-8">8. 迭代器归一化：兼顾易用性与性能</h3>
<p><strong>核心逻辑</strong>：将函数、对象、字符串等多种迭代器格式统一为标准函数，避免多次类型判断。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>通过 <code>getIteratee</code> 将 <code>predicate</code> 转换为标准迭代函数（支持 <code>_.filter(array, {active: true})</code> 等易用写法）；</li>
<li>迭代器仅初始化一次，复用在整个循环中，避免每次迭代都做类型判断；</li>
<li>统一迭代器参数（<code>value, index, array</code>），保证逻辑一致性。</li>
</ul>
<p><strong>价值</strong>：在不损失性能的前提下，提升 API 易用性，减少用户手写转换逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// remove 中的迭代器归一化</span>
predicate = <span class="hljs-title function_">getIteratee</span>(predicate, <span class="hljs-number">3</span>); <span class="hljs-comment">// 统一为标准函数</span>
<span class="hljs-keyword">while</span> (++index &lt; length) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">predicate</span>(value, index, array)) { <span class="hljs-comment">// 复用迭代器</span>
    <span class="hljs-comment">// 逻辑处理</span>
  }
}
</code></pre>
<h2 data-id="heading-9">二、Lodash 核心数组函数的实现与优化细节</h2>
<p>基于上述通用策略，Lodash 为不同场景的数组函数设计了针对性的优化方案，以下是核心函数的完整实现与解析：</p>
<h3 data-id="heading-10">1. 基础操作函数：易用性与效率的平衡</h3>
<h4 data-id="heading-11"><code>_.chunk</code>：数组分块的内存优化典范</h4>
<p><strong>功能</strong>：将数组分割为指定大小的二维数组，空数组 / 无效参数返回空数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">chunk</span>(<span class="hljs-params">array, size, guard</span>) {
  <span class="hljs-comment">// 1. 边界兼容：处理参数异常（防误传、未传size）</span>
  <span class="hljs-keyword">if</span> ((guard ? <span class="hljs-title function_">isIterateeCall</span>(array, size, guard) : size === <span class="hljs-literal">undefined</span>)) {
    size = <span class="hljs-number">1</span>; <span class="hljs-comment">// 默认分块大小为1</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 转为整数并确保最小值为0（避免负数分块）</span>
    size = <span class="hljs-title function_">nativeMax</span>(<span class="hljs-title function_">toInteger</span>(size), <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 2. 安全获取长度 + 早期返回：空数组/无效size直接返回</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length || size &lt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> [];
  }

  <span class="hljs-comment">// 3. 内存预分配：计算分块数并创建固定长度数组</span>
  <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>,
      resIndex = <span class="hljs-number">0</span>,
      result = <span class="hljs-title class_">Array</span>(<span class="hljs-title function_">nativeCeil</span>(length / size)); <span class="hljs-comment">// 向上取整确定分块数</span>

  <span class="hljs-comment">// 4. 循环优化：while循环 + 指针更新，减少迭代开销</span>
  <span class="hljs-keyword">while</span> (index &lt; length) {
    <span class="hljs-comment">// 复用baseSlice切片，同时更新索引（index += size）</span>
    result[resIndex++] = <span class="hljs-title function_">baseSlice</span>(array, index, (index += size));
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>分块数预计算：通过 <code>nativeCeil(length / size)</code> 精准预分配结果数组长度；</li>
<li>索引联动更新：<code>index += size</code> 一次操作完成指针移动，避免重复计算；</li>
<li>底层逻辑复用：基于 <code>baseSlice</code> 实现切片，避免重复造轮子。</li>
</ul>
<h4 data-id="heading-12"><code>_.compact</code>：假值过滤的极致简洁</h4>
<p><strong>功能</strong>：移除数组中的假值（false、null、0、""、undefined、NaN），返回新数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compact</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 1. 安全初始化：处理null/undefined，缓存长度</span>
  <span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>,
      length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>,
      resIndex = <span class="hljs-number">0</span>,
      result = [];

  <span class="hljs-comment">// 2. 循环优化：while + 双指针，减少属性访问</span>
  <span class="hljs-keyword">while</span> (++index &lt; length) {
    <span class="hljs-keyword">var</span> value = array[index];
    <span class="hljs-comment">// 3. 快速判空：直接判断值，比Boolean(value)更高效</span>
    <span class="hljs-keyword">if</span> (value) {
      result[resIndex++] = value; <span class="hljs-comment">// 双指针填充，避免push扩容</span>
    }
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>快速假值判断：<code>if (value)</code> 直接校验，省去 <code>Boolean()</code> 函数调用开销；</li>
<li>双指针填充：<code>resIndex</code> 独立控制结果数组索引，避免 <code>result.length</code> 访问。</li>
</ul>
<h4 data-id="heading-13"><code>_.concat</code>：多参数拼接的灵活实现</h4>
<p><strong>功能</strong>：拼接多个数组 / 值，返回新数组，支持类数组、单值输入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">concat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 早期返回：无参数直接返回空数组</span>
  <span class="hljs-keyword">var</span> length = <span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> [];
  }

  <span class="hljs-comment">// 2. 参数预处理：批量处理arguments，避免多次类数组操作</span>
  <span class="hljs-keyword">var</span> args = <span class="hljs-title class_">Array</span>(length - <span class="hljs-number">1</span>),
      array = <span class="hljs-variable language_">arguments</span>[<span class="hljs-number">0</span>],
      index = length;

  <span class="hljs-comment">// 反向遍历：高效将arguments转为数组</span>
  <span class="hljs-keyword">while</span> (index--) {
    args[index - <span class="hljs-number">1</span>] = <span class="hljs-variable language_">arguments</span>[index];
  }

  <span class="hljs-comment">// 3. 核心逻辑：原生复用 + 扁平化控制</span>
  <span class="hljs-comment">// - isArray判断：数组拷贝，非数组转为数组</span>
  <span class="hljs-comment">// - baseFlatten：仅扁平化1层，平衡灵活性与性能</span>
  <span class="hljs-comment">// - arrayPush：封装原生push，利用引擎优化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">arrayPush</span>(
    <span class="hljs-title function_">isArray</span>(array) ? <span class="hljs-title function_">copyArray</span>(array) : [array],
    <span class="hljs-title function_">baseFlatten</span>(args, <span class="hljs-number">1</span>)
  );
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>反向遍历参数：<code>while (index--)</code> 高效处理 <code>arguments</code>，避免 <code>Array.from</code> 开销；</li>
<li>扁平化控制：仅扁平化 1 层，避免过度遍历，同时兼容多参数输入。</li>
</ul>
<h3 data-id="heading-14">2. 查找与索引函数：算法层面的性能突破</h3>
<h4 data-id="heading-15"><code>_.findIndex</code>：条件查找的精准控制</h4>
<p><strong>功能</strong>：查找第一个满足条件的元素索引，支持起始位置，无匹配返回 -1。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">findIndex</span>(<span class="hljs-params">array, predicate, fromIndex</span>) {
  <span class="hljs-comment">// 1. 安全获取长度 + 早期返回：空数组直接返回-1</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 2. 起始索引校准：处理负数、非数字索引</span>
  <span class="hljs-keyword">var</span> index = fromIndex == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-title function_">toInteger</span>(fromIndex);
  <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 负数索引转为合法正索引，最小为0</span>
    index = <span class="hljs-title function_">nativeMax</span>(length + index, <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 3. 迭代器归一化 + 底层复用：</span>
  <span class="hljs-comment">// - getIteratee：统一迭代器格式（函数/对象/字符串）</span>
  <span class="hljs-comment">// - baseFindIndex：封装核心查找，支持正序/倒序复用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseFindIndex</span>(array, <span class="hljs-title function_">getIteratee</span>(predicate, <span class="hljs-number">3</span>), index);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>起始位置校准：自动处理负数索引，无需用户手动转换；</li>
<li>底层逻辑抽象：<code>baseFindIndex</code> 同时支撑 <code>findIndex</code>/<code>findLastIndex</code>，避免重复代码。</li>
</ul>
<h4 data-id="heading-16"><code>_.sortedIndex</code>：有序数组的二分查找</h4>
<p><strong>功能</strong>：在有序数组中查找值的插入位置，保证数组有序性，仅支持数字 / 可比较类型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 对外简化接口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sortedIndex</span>(<span class="hljs-params">array, value</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseSortedIndex</span>(array, value);
}

<span class="hljs-comment">// 底层核心实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseSortedIndex</span>(<span class="hljs-params">array, value, retHighest</span>) {
  <span class="hljs-comment">// 1. 初始化二分边界：处理null/undefined</span>
  <span class="hljs-keyword">var</span> low = <span class="hljs-number">0</span>,
      high = array == <span class="hljs-literal">null</span> ? low : array.<span class="hljs-property">length</span>;

  <span class="hljs-comment">// 2. 数字类型特化：跳过无效值，提升效率</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'number'</span> &amp;&amp; value === value &amp;&amp; high &lt;= <span class="hljs-variable constant_">HALF_MAX_ARRAY_LENGTH</span>) {
    <span class="hljs-comment">// 3. 二分查找核心：位运算优化 + 短路判断</span>
    <span class="hljs-keyword">while</span> (low &lt; high) {
      <span class="hljs-comment">// 位运算计算中间索引：无浮点、无溢出</span>
      <span class="hljs-keyword">var</span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number">1</span>,
          computed = array[mid];

      <span class="hljs-comment">// 短路判断：跳过Symbol/null，快速比较</span>
      <span class="hljs-keyword">if</span> (computed !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">isSymbol</span>(computed) &amp;&amp;
          (retHighest ? (computed &lt;= value) : (computed &lt; value))) {
        low = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
      } <span class="hljs-keyword">else</span> {
        high = mid; <span class="hljs-comment">// 目标在左半部分</span>
      }
    }
    <span class="hljs-keyword">return</span> high;
  }

  <span class="hljs-comment">// 非数字/超大数组：通用实现兜底</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseSortedIndexBy</span>(array, value, identity, retHighest);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>二分查找选型：时间复杂度 O (log n)，大数组比线性查找快 5-10 倍；</li>
<li>数字特化处理：跳过 Symbol/null 等无效值，减少判断开销；</li>
<li>长度限制：<code>HALF_MAX_ARRAY_LENGTH</code> 避免超大数组的性能问题。</li>
</ul>
<h4 data-id="heading-17"><code>_.indexOf</code>：值查找的兼容性优化</h4>
<p><strong>功能</strong>：查找值的第一个索引，支持起始位置，兼容 NaN 查找。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">indexOf</span>(<span class="hljs-params">array, value, fromIndex</span>) {
  <span class="hljs-comment">// 1. 安全获取长度 + 早期返回：空数组直接返回-1</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 2. 起始索引校准：处理负数、非数字</span>
  <span class="hljs-keyword">var</span> index = fromIndex == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-title function_">toInteger</span>(fromIndex);
  <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) {
    index = <span class="hljs-title function_">nativeMax</span>(length + index, <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 3. 底层复用：兼容NaN（原生indexOf不支持）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseIndexOf</span>(array, value, index);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>NaN 兼容：<code>baseIndexOf</code> 专门处理 NaN 查找，弥补原生 API 缺陷；</li>
<li>索引校准：自动处理负数起始位置，提升易用性。</li>
</ul>
<h3 data-id="heading-18">3. 修改与操作函数：原地 / 非原地的平衡</h3>
<h4 data-id="heading-19"><code>_.pullAll</code>（支撑 <code>_.pull</code>）：原地移除指定值</h4>
<p><strong>功能</strong>：从原数组中移除指定值，直接修改原数组，返回修改后的数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pullAll</span>(<span class="hljs-params">array, values</span>) {
  <span class="hljs-comment">// 1. 早期返回：空数组/空值列表直接返回原数组</span>
  <span class="hljs-keyword">if</span> (!(array &amp;&amp; array.<span class="hljs-property">length</span> &amp;&amp; values &amp;&amp; values.<span class="hljs-property">length</span>)) {
    <span class="hljs-keyword">return</span> array;
  }

  <span class="hljs-comment">// 2. 批量处理：调用底层逻辑，避免多次遍历</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">basePullAll</span>(array, values);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>原地修改：直接操作原数组，减少新数组创建的内存开销；</li>
<li>批量处理：一次性移除多个值，避免多次遍历数组。</li>
</ul>
<h4 data-id="heading-20"><code>_.remove</code>：条件移除的高效实现</h4>
<p><strong>功能</strong>：移除满足条件的元素，返回被移除的数组，原数组被修改。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">array, predicate</span>) {
  <span class="hljs-comment">// 1. 初始化 + 早期返回：空数组返回空结果</span>
  <span class="hljs-keyword">var</span> result = [];
  <span class="hljs-keyword">if</span> (!(array &amp;&amp; array.<span class="hljs-property">length</span>)) {
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 2. 缓存长度 + 迭代器归一化</span>
  <span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>,
      indexes = [],
      length = array.<span class="hljs-property">length</span>;
  predicate = <span class="hljs-title function_">getIteratee</span>(predicate, <span class="hljs-number">3</span>);

  <span class="hljs-comment">// 3. 双数组记录：先收集索引/值，避免边遍历边删除的索引错乱</span>
  <span class="hljs-keyword">while</span> (++index &lt; length) {
    <span class="hljs-keyword">var</span> value = array[index];
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">predicate</span>(value, index, array)) {
      result.<span class="hljs-title function_">push</span>(value); <span class="hljs-comment">// 收集被移除值</span>
      indexes.<span class="hljs-title function_">push</span>(index); <span class="hljs-comment">// 收集被移除索引</span>
    }
  }

  <span class="hljs-comment">// 4. 批量移除：一次性处理所有索引，减少数组重排次数</span>
  <span class="hljs-title function_">basePullAt</span>(array, indexes);
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>双数组记录：先收集后移除，避免边遍历边删除导致的元素漏判；</li>
<li>批量移除：<code>basePullAt</code> 一次性处理索引，减少数组元素移动的开销。</li>
</ul>
<h4 data-id="heading-21"><code>_.reverse</code>：原生能力的安全封装</h4>
<p><strong>功能</strong>：反转数组，直接修改原数组，兼容 <code>null/undefined</code> 输入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 1. 安全兼容：null/undefined直接返回，避免报错</span>
  <span class="hljs-comment">// 2. 原生复用：调用浏览器优化的reverse方法</span>
  <span class="hljs-keyword">return</span> array == <span class="hljs-literal">null</span> ? array : nativeReverse.<span class="hljs-title function_">call</span>(array);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>原生方法复用：直接调用 <code>Array.prototype.reverse</code>，利用引擎 C++ 实现的高性能；</li>
<li>无额外开销：仅做安全判断，无多余计算。</li>
</ul>
<h3 data-id="heading-22">4. 集合操作函数：数据结构驱动的性能提升</h3>
<h4 data-id="heading-23"><code>_.uniq</code>：数组去重的分层优化</h4>
<p><strong>功能</strong>：数组去重，返回新数组，兼容 NaN、0/-0 等特殊值。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 对外简化接口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uniq</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 早期返回：空数组/非数组直接返回空数组</span>
  <span class="hljs-keyword">return</span> (array &amp;&amp; array.<span class="hljs-property">length</span>) ? <span class="hljs-title function_">baseUniq</span>(array) : [];
}

<span class="hljs-comment">// 底层核心去重</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseUniq</span>(<span class="hljs-params">array, iteratee, comparator</span>) {
  <span class="hljs-comment">// 1. 初始化变量：缓存长度，默认查找函数</span>
  <span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>,
      includes = arrayIncludes,
      length = array.<span class="hljs-property">length</span>,
      isCommon = <span class="hljs-literal">true</span>,
      result = [],
      seen = result;

  <span class="hljs-comment">// 2. 比较器处理：自定义比较器切换查找逻辑</span>
  <span class="hljs-keyword">if</span> (comparator) {
    isCommon = <span class="hljs-literal">false</span>;
    includes = arrayIncludesWith;
  }
  <span class="hljs-comment">// 3. 分层策略：大数组用Set，小数组用普通数组</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &gt;= <span class="hljs-variable constant_">LARGE_ARRAY_SIZE</span>) { <span class="hljs-comment">// LARGE_ARRAY_SIZE = 200</span>
    <span class="hljs-comment">// 无迭代器时直接用Set（最快）</span>
    <span class="hljs-keyword">var</span> set = iteratee ? <span class="hljs-literal">null</span> : <span class="hljs-title function_">createSet</span>(array);
    <span class="hljs-keyword">if</span> (set) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">setToArray</span>(set);
    }
    isCommon = <span class="hljs-literal">false</span>;
    includes = cacheHas;
    seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetCache</span>; <span class="hljs-comment">// O(1) 查找缓存</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 小数组：复用结果数组作为缓存</span>
    seen = iteratee ? [] : result;
  }

  <span class="hljs-comment">// 4. 核心遍历：短路逻辑 + 特殊值处理</span>
  <span class="hljs-attr">outer</span>:
  <span class="hljs-keyword">while</span> (++index &lt; length) {
    <span class="hljs-keyword">var</span> value = array[index],
        computed = iteratee ? <span class="hljs-title function_">iteratee</span>(value) : value;

    <span class="hljs-comment">// 特殊值处理：0和-0视为相同</span>
    value = (comparator || value !== <span class="hljs-number">0</span>) ? value : <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 普通场景：反向遍历缓存，减少比较次数</span>
    <span class="hljs-keyword">if</span> (isCommon &amp;&amp; computed === computed) {
      <span class="hljs-keyword">var</span> seenIndex = seen.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">while</span> (seenIndex--) {
        <span class="hljs-keyword">if</span> (seen[seenIndex] === computed) {
          <span class="hljs-keyword">continue</span> outer; <span class="hljs-comment">// 短路：跳过重复值</span>
        }
      }
      <span class="hljs-keyword">if</span> (iteratee) {
        seen.<span class="hljs-title function_">push</span>(computed);
      }
      result.<span class="hljs-title function_">push</span>(value);
    }
    <span class="hljs-comment">// 非普通场景/NaN：缓存查找</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">includes</span>(seen, computed, comparator)) {
      <span class="hljs-keyword">if</span> (seen !== result) {
        seen.<span class="hljs-title function_">push</span>(computed);
      }
      result.<span class="hljs-title function_">push</span>(value);
    }
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>分层去重：200 为阈值，平衡 Set 初始化开销和查找效率；</li>
<li>特殊值兼容：处理 NaN、0/-0，弥补原生 Set 的部分缺陷；</li>
<li>反向遍历缓存：减少缓存比较次数，提升小数组去重效率。</li>
</ul>
<h4 data-id="heading-24"><code>_.intersection</code>：多数组交集的缓存优化</h4>
<p><strong>功能</strong>：计算多个数组的交集，返回新数组，仅保留所有数组都包含的元素。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> intersection = <span class="hljs-title function_">baseRest</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">arrays</span>) {
  <span class="hljs-comment">// 1. 参数归一化：转为数组/类数组，过滤无效输入</span>
  <span class="hljs-keyword">var</span> mapped = <span class="hljs-title function_">arrayMap</span>(arrays, castArrayLikeObject);
  
  <span class="hljs-comment">// 2. 早期返回：无有效输入返回空数组</span>
  <span class="hljs-keyword">return</span> (mapped.<span class="hljs-property">length</span> &amp;&amp; mapped[<span class="hljs-number">0</span>] === arrays[<span class="hljs-number">0</span>])
    ? <span class="hljs-title function_">baseIntersection</span>(mapped)
    : [];
});
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>最短数组优先：基于最短数组遍历，减少迭代次数；</li>
<li>缓存复用：对大数组创建 SetCache，查找效率从 O (n) 降为 O (1)；</li>
<li>参数归一化：统一处理类数组，提升兼容性。</li>
</ul>
<h4 data-id="heading-25"><code>_.xor</code>：对称差集的高效计算</h4>
<p><strong>功能</strong>：计算多个数组的对称差集，返回仅出现在一个数组中的元素。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> xor = <span class="hljs-title function_">baseRest</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">arrays</span>) {
  <span class="hljs-comment">// 1. 过滤无效输入：仅保留数组/类数组</span>
  <span class="hljs-comment">// 2. 底层复用：基于baseDifference实现，避免重复逻辑</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseXor</span>(<span class="hljs-title function_">arrayFilter</span>(arrays, isArrayLikeObject));
});
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>差集复用：基于 <code>baseDifference</code> 实现核心逻辑，减少代码冗余；</li>
<li>批量计算：一次性处理所有输入，减少中间数组创建。</li>
</ul>
<h3 data-id="heading-26">5. 其他高频函数：细节处的性能打磨</h3>
<h4 data-id="heading-27"><code>_.head</code>/<code>_.last</code>：首尾元素的直接访问</h4>
<p><strong>功能</strong>：快速获取数组第一个 / 最后一个元素，兼容空数组、非数组输入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取第一个元素</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">head</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 直接访问：无函数调用开销，空数组返回undefined</span>
  <span class="hljs-keyword">return</span> (array &amp;&amp; array.<span class="hljs-property">length</span>) ? array[<span class="hljs-number">0</span>] : <span class="hljs-literal">undefined</span>;
}

<span class="hljs-comment">// 获取最后一个元素</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">last</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 安全获取长度：处理null/undefined</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 直接访问：避免slice(-1)[0]的额外开销</span>
  <span class="hljs-keyword">return</span> length ? array[length - <span class="hljs-number">1</span>] : <span class="hljs-literal">undefined</span>;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>直接索引访问：比 <code>array.slice(0,1)[0]</code> 快数倍，无额外内存分配；</li>
<li>无冗余计算：仅做必要的长度判断，无循环 / 函数调用。</li>
</ul>
<h4 data-id="heading-28"><code>_.flatten</code>/<code>_.flattenDepth</code>：数组扁平化的深度控制</h4>
<p><strong>功能</strong>：将嵌套数组扁平化为一维（<code>flatten</code>）或指定深度（<code>flattenDepth</code>），返回新数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 扁平化1层（默认）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">flatten</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 早期返回：空数组直接返回，否则调用底层逻辑（深度1）</span>
  <span class="hljs-keyword">return</span> length ? <span class="hljs-title function_">baseFlatten</span>(array, <span class="hljs-number">1</span>) : [];
}

<span class="hljs-comment">// 支持指定深度</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">flattenDepth</span>(<span class="hljs-params">array, depth</span>) {
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> [];
  }
  <span class="hljs-comment">// 深度校准：未传depth默认1，转为整数确保合法</span>
  depth = depth === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">1</span> : <span class="hljs-title function_">toInteger</span>(depth);
  <span class="hljs-comment">// 底层复用：迭代实现，避免递归栈溢出</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseFlatten</span>(array, depth);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>深度控制：避免过度扁平化，减少无效遍历；</li>
<li>迭代代替递归：<code>baseFlatten</code> 用迭代实现，避免深层嵌套导致的栈溢出；</li>
<li>类型校验：仅扁平化数组 / 类数组，跳过普通对象。</li>
</ul>
<h4 data-id="heading-29"><code>_.without</code>：排除指定值的差集实现</h4>
<p><strong>功能</strong>：创建排除指定值的新数组，原数组不变，支持多值排除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> without = <span class="hljs-title function_">baseRest</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">array, values</span>) {
  <span class="hljs-comment">// 1. 类型校验：仅处理数组/类数组，否则返回空数组</span>
  <span class="hljs-comment">// 2. 底层复用：基于baseDifference实现差集计算</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isArrayLikeObject</span>(array)
    ? <span class="hljs-title function_">baseDifference</span>(array, values)
    : [];
});
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>差集复用：直接使用 <code>baseDifference</code> 核心逻辑，避免重复代码；</li>
<li>可变参数：通过 <code>baseRest</code> 支持多值输入，提升易用性；</li>
<li>非破坏性：返回新数组，不修改原数组，兼顾不可变需求。</li>
</ul>
<h2 data-id="heading-30">三、核心总结</h2>
<p>Lodash 数组函数的高性能，是「通用优化策略 + 场景化定制」的双重结果，核心关键点可总结为：</p>
<ol>
<li><strong>性能分层设计</strong>：根据数组大小、有序性选择算法（二分 / Set / 线性），避免「一刀切」的低效；</li>
<li><strong>内存效率优先</strong>：预分配内存、原地修改、缓存复用，减少 GC 压力和内存重分配；</li>
<li><strong>细节极致打磨</strong>：位运算、while 循环、快速判空等小优化，叠加后产生显著效果；</li>
<li><strong>兼容与性能平衡</strong>：在鲁棒性（兼容 null/NaN/ 负数索引）和性能之间找到最优解，不牺牲易用性。</li>
</ol>
<p>这些优化思路不仅适用于数组操作，更是前端高性能编程的通用准则 —— 掌握这些逻辑，既能更高效地使用 Lodash，也能在手写代码时写出兼具性能与鲁棒性的逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零打造专业级前端 SDK (三)：健壮性与离线存储]]></title>    <link>https://juejin.cn/post/7596990822127534118</link>    <guid>https://juejin.cn/post/7596990822127534118</guid>    <pubDate>2026-01-20T05:32:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596990822127534118" data-draft-id="7597083743555616811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零打造专业级前端 SDK (三)：健壮性与离线存储"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-20T05:32:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个有故事的男同学"/> <meta itemprop="url" content="https://juejin.cn/user/3984285867966951"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零打造专业级前端 SDK (三)：健壮性与离线存储
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3984285867966951/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个有故事的男同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:32:52.000Z" title="Tue Jan 20 2026 05:32:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">从零打造专业级前端 SDK (三)：健壮性与离线存储</h2>
<p><strong>前言</strong>：在<a href="https://juejin.cn/post/7583983152324411418" target="_blank" title="https://juejin.cn/post/7583983152324411418">上一篇</a>中，我们实现了多种网络发送策略，让 SDK 能够把数据发出去。但真实的网络环境是不可靠的——弱网、断网、高频触发都是常态。今天，我们要给 SDK 穿上一层"防弹衣"，打造一个<strong>永不丢单</strong>的健壮系统。</p>
<h3 data-id="heading-1">1. 痛点：脆弱的直接发送</h3>
<p>如果我们只是简单地调用 <code>fetch</code>，会遇到两个致命问题：</p>
<ol>
<li><strong>流量风暴</strong>：用户快速滑动列表，瞬间产生几十个请求，服务器压力山大。</li>
<li><strong>数据丢失</strong>：用户在地下停车场点击"支付"，因无网络导致请求失败，关键转化数据丢失。</li>
</ol>
<p>为了解决这些问题，我们需要引入两个核心机制：<strong>消息队列 (Queue)</strong> 和 <strong>离线存储 (Store)</strong> 。</p>
<h3 data-id="heading-2">2. 消息队列：削峰填谷</h3>
<p>我们不能来一个发一个，而是要"攒一攒"再发。这叫<strong>批处理 (Batching)</strong> 。</p>
<h4 data-id="heading-3">2.1 智能调度器 (Scheduler)</h4>
<p>我们创建一个 <code>Scheduler</code> 类来管理队列。它支持两种优先级：</p>
<ul>
<li><strong>immediate (高)</strong> ：支付、关键点击 -&gt; 立即发送。</li>
<li><strong>batch (低)</strong> ：曝光、滚动 -&gt; 攒够 10 条或 3 秒后发送。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// src/core/Scheduler.ts</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">Scheduler</span> {
  <span class="hljs-keyword">private</span> queue: TrackerEvent[] = [];
  <span class="hljs-keyword">private</span> timer: number | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  addEvent(event: TrackerEvent, priority: <span class="hljs-string">'immediate'</span> | <span class="hljs-string">'batch'</span> = <span class="hljs-string">'batch'</span>) {
    <span class="hljs-keyword">this</span>.queue.push(event);

    <span class="hljs-comment">// 1. 高优先级：立即发送 (队列里所有数据)</span>
    <span class="hljs-keyword">if</span> (priority === <span class="hljs-string">'immediate'</span>) {
      <span class="hljs-keyword">this</span>.flush();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 低优先级：启动定时器 (3秒兜底)</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.timer) {
      <span class="hljs-keyword">this</span>.timer = window.setTimeout(() =&gt; <span class="hljs-keyword">this</span>.flush(), <span class="hljs-number">3000</span>);
    }

    <span class="hljs-comment">// 3. 队列满了：立即发送 (10条阈值)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.queue.length &gt;= <span class="hljs-number">10</span>) {
      <span class="hljs-keyword">this</span>.flush();
    }
  }
}
</code></pre>
<h3 data-id="heading-4">3. 离线存储：IndexedDB 兜底</h3>
<p>当 <code>flush()</code> 发送失败时，数据不能丢，必须存起来。</p>
<h4 data-id="heading-5">3.1 为什么选 IndexedDB？</h4>


























<table><thead><tr><th>方案</th><th>容量</th><th>性能</th><th>结构化</th><th>结论</th></tr></thead><tbody><tr><td>localStorage</td><td>5MB</td><td>同步(卡顿)</td><td>仅字符串</td><td>❌ 仅适合玩具</td></tr><tr><td><strong>IndexedDB</strong></td><td><strong>&gt;250MB</strong></td><td><strong>异步</strong></td><td><strong>支持对象</strong></td><td>✅ 生产级首选</td></tr></tbody></table>
<h4 data-id="heading-6">3.2 仓库实现 (Store)</h4>
<p>我们封装一个轻量级的 <code>Store</code> 类，屏蔽 IndexedDB 的复杂 API。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/Store.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Store</span> {
  <span class="hljs-comment">// 发送失败时调用：存入数据库</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">events: TrackerEvent[]</span>) {
    <span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDB</span>();
    <span class="hljs-keyword">const</span> tx = db.<span class="hljs-title function_">transaction</span>(<span class="hljs-string">'events'</span>, <span class="hljs-string">'readwrite'</span>);
    events.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> tx.<span class="hljs-property">store</span>.<span class="hljs-title function_">add</span>(e));
  }

  <span class="hljs-comment">// 网络恢复时调用：取出所有数据</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAll</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ...读取逻辑</span>
  }
}
</code></pre>
<h3 data-id="heading-7">4. 闭环：自动重试机制</h3>
<p>最精彩的部分来了。我们在 <code>Scheduler</code> 中监听浏览器的 <code>online</code> 事件，实现<strong>全自动恢复</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/Scheduler.ts</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 监听网络恢复</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'online'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🌐 网络已恢复，正在重发积压数据...'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">retryFailedEvents</span>();
  });
}

<span class="hljs-keyword">async</span> <span class="hljs-title function_">retryFailedEvents</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 从 Store 取出所有积压数据</span>
  <span class="hljs-keyword">const</span> events = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">getAll</span>();
  <span class="hljs-keyword">if</span> (events.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 2. 尝试重发</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sender</span>.<span class="hljs-title function_">send</span>(events);
    <span class="hljs-comment">// 3. 发送成功，清空 Store</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">clear</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 重发成功！'</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 4. 依然失败？没事，数据还在 Store 里，下次再试</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 重发失败，等待下一次机会'</span>);
  }
}
</code></pre>
<h3 data-id="heading-8">5. 总结</h3>
<p>通过本篇的改造，我们的 SDK 进化了：</p>
<ul>
<li><strong>性能</strong>：请求数减少 90%（批处理）。</li>
<li><strong>可靠</strong>：弱网/断网环境下数据不丢失（离线存储）。</li>
</ul>
<p>现在，我们的 SDK 已经具备了商业级产品的核心素质。</p>
<p><strong>下一篇</strong>，我们将探讨如何让 SDK 走出浏览器，适配 <strong>Node.js</strong>、<strong>小程序</strong> 等多种运行时环境，实现真正的<strong>跨平台架构</strong>。</p>
<hr/>
<p><em>本文代码已开源，欢迎 Star</em> <em>⭐</em> <em>️</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 工程化（五）：企业级脚手架的设计与落地]]></title>    <link>https://juejin.cn/post/7596890557547298862</link>    <guid>https://juejin.cn/post/7596890557547298862</guid>    <pubDate>2026-01-20T05:37:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596890557547298862" data-draft-id="7596983314806833202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 工程化（五）：企业级脚手架的设计与落地"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T05:37:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 工程化（五）：企业级脚手架的设计与落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:37:58.000Z" title="Tue Jan 20 2026 05:37:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>很多团队都有一个“规范文档”，它通常静静地躺在 Wiki 的角落里，只有新员工入职的第一天会被打开，然后迅速被遗忘。</p>
<p><strong>依靠文档约束人性的规范，注定是失败的。</strong></p>
<p>在架构师的眼里，规范不应该是一个文档，而应该是一个<strong>产品</strong>——一个通过脚手架（CLI）和预设包（Presets）交付给开发者的“黑盒子”。开发者不需要知道 ESLint 的 <code>ecmaVersion</code> 是多少，也不需要纠结 Prettier 的 <code>semi</code> 是 true 还是 false，他们只需要打开盒子，直接开始工作。</p>
<p>本篇我们将探讨如何从“配置工程师”进化为“规范制定者”，通过工程化手段把标准“装进盒子里”，让错误根本无法发生。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fae9659af3e8490783668bfdb1fc1b5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492278&amp;x-signature=Pgk9MJ3vH3Bie8muCE6%2Fj3II9ws%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 熵增定律：为什么 Copy-Paste 是万恶之源？</h2>
<p>在没有脚手架体系的团队，新项目的建立通常源于一句：“你去把那个老项目的配置拷贝一份过来。”</p>
<p>这种“细胞分裂”式的工程创建方式，导致了严重的 <strong>配置熵增</strong>：</p>
<ol>
<li><strong>版本分裂：</strong> 项目 A 用的是 ESLint v7，项目 B 拷贝过去后升级到了 v8，项目 C 又拷贝了 A... 最终团队维护着 5 个版本的 Lint 规则。</li>
<li><strong>规则漂移：</strong> 张三觉得 <code>no-console</code> 很烦，在项目 B 里关掉了；李四觉得分号很丑，在项目 C 里去掉了。半年后，这两个项目的代码风格就像出自两个物种。</li>
<li><strong>基建升级灾难：</strong> 当架构师决定“我们需要在所有项目里引入 Commitlint”时，他发现他需要修改 100 个仓库的 <code>package.json</code>。这不仅是体力活，更是巨大的风险。</li>
</ol>
<p><strong>架构原则一：不要让开发者直接维护配置文件。配置文件应当作为依赖包被引入。</strong></p>
<hr/>
<h2 data-id="heading-1">二、 核心策略：Configuration as Dependency</h2>
<p>要解决上述问题，必须把配置从“项目内的文件”变成“npm 包”。</p>
<h3 data-id="heading-2">2.1 也就是 Shared Config</h3>
<p>在 Monorepo 或 npm 私有库中，我们需要维护一套核心的规范包：</p>
<ul>
<li><code>@company/eslint-config-react</code></li>
<li><code>@company/prettier-config</code></li>
<li><code>@company/tsconfig</code></li>
</ul>
<p>在业务项目中，<code>.eslintrc.js</code> 应该只有一行代码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">module.exports</span> = {
  extends: <span class="hljs-section">['@company/eslint-config-react']</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-3">2.2 拥抱 ESLint Flat Config (Config System 的革命)</h3>
<p>2024 年以后的架构设计，必须正视 <strong>ESLint Flat Config (eslint.config.js)</strong> 的存在。 旧的 <code>.eslintrc</code> 级联系统极其复杂，导致 <code>extends</code> 覆盖逻辑经常失效。Flat Config 将配置视为一个<strong>扁平的对象数组</strong>，使得配置的组合、覆盖和共享变得符合直觉（就像合并数组一样简单）。</p>
<p><strong>架构师的职责</strong>，就是提前踩平 Flat Config 的坑，把它封装成一个开箱即用的 Plugin，屏蔽掉底层复杂的 Plugin 加载逻辑。</p>
<hr/>
<h2 data-id="heading-4">三、 门神：Husky 与 Git Hooks 的强制执行</h2>
<p>有了规范包，怎么保证开发者一定会遵守？靠自觉是不够的，必须有**“暴力”拦截**。</p>
<h3 data-id="heading-5">3.1 提交时的最后一道防线</h3>
<p>利用 <code>husky</code> + <code>lint-staged</code>，我们实现了“增量检查”。 不要试图在 commit 时检查全量代码，那会让 <code>git commit</code> 慢得像 <code>npm install</code>。只检查<strong>暂存区（Staged）</strong> 的文件，是工程体验和代码质量的最佳平衡点。</p>
<h3 data-id="heading-6">3.2 Commit Message 的标准化</h3>
<p>为什么提交信息也需要规范？ 如果你想做自动化发版（Automated Release）、自动生成 Changelog，那么 Commit Message 就必须符合 <strong>Conventional Commits</strong> 规范。</p>
<ul>
<li><code>feat: add login</code> -&gt; 触发 Minor 版本更新</li>
<li><code>fix: bug in style</code> -&gt; 触发 Patch 版本更新</li>
</ul>
<p>通过 <code>commitlint</code> 拦截乱写的提交信息，是通往自动化运维（DevOps）的必经之路。</p>
<hr/>
<h2 data-id="heading-7">四、 交付载体：脚手架（CLI）的架构设计</h2>
<p>当规范包和 Lint 工具都准备好了，我们需要一个载体把它们送达给开发者。这就是 <strong>CLI（Command Line Interface）</strong> 。</p>
<h3 data-id="heading-8">4.1 现代脚手架的技术选型</h3>
<p>别再用 Yeoman 了，也别只会 <code>git clone</code>。现代脚手架（如 <code>create-vite</code>, <code>create-next-app</code>）的架构已经非常成熟：</p>
<ul>
<li><strong>交互层：</strong> <code>prompts</code> (比 Inquirer 更轻量)</li>
<li><strong>参数解析：</strong> <code>cac</code> (比 Commander 更现代)</li>
<li><strong>模板引擎：</strong> 实际上，现代趋势是 <strong>去模板引擎化</strong>。直接拷贝预设好的文件夹结构（Template），然后修改个别文件（package.json name）。这种方式比 EJS 渲染更直观，维护成本更低。</li>
</ul>
<h3 data-id="heading-9">4.2 Preset 模式 vs Generator 模式</h3>
<ul>
<li><strong>Generator 模式（重逻辑）：</strong> 询问你“要不要 Router？”“要不要 Pinia？”，然后通过代码动态生成文件。维护成本高，容易出错。</li>
<li><strong>Preset 模式（重模板）：</strong> 维护几个标准的模板仓库（Template Repo），CLI 的作用仅仅是下载对应模板。 <strong>推荐架构：</strong> 对于企业内部，<strong>Preset 模式</strong> 更优。架构组维护 <code>template-react-admin</code>、<code>template-h5-activity</code> 等标准模板库，CLI 负责拉取和初始化。这实现了“模板与工具解耦”。</li>
</ul>
<hr/>
<h2 data-id="heading-10">五、 落地与治理：从技术到政治</h2>
<p>写出一个 CLI 很容易，让几百号人愿意用很难。这就是架构的<strong>政治属性</strong>。</p>
<h3 data-id="heading-11">5.1 存量治理的艺术</h3>
<p>对于老项目，不要试图“一刀切”地加上最严格的 ESLint 规则。那会导致满屏红线，开发者的第一反应就是 <code>/* eslint-disable */</code> 或者直接卸载插件。</p>
<p><strong>策略：</strong> 提供 <code>lint-fix</code> 脚本，并引入 <strong>"Warning First"</strong> 策略。先将新规则设为 Warning，给团队 1-2 个迭代的缓冲期，再逐步收紧为 Error。</p>
<h3 data-id="heading-12">5.2 零配置（Zero-Config）的幻觉</h3>
<p>大家都在吹捧“零配置”，但企业级架构 <strong>不能零配置</strong>。 你需要暴露必要的扩展点（Hooks）。比如，脚手架生成的 Webpack 配置，必须允许业务项目通过 <code>chainWebpack</code> 或 <code>mergeConfig</code> 进行覆盖。 <strong>架构师的智慧在于：提供完美的默认值，但保留修改的权利。</strong></p>
<hr/>
<h2 data-id="heading-13">结语：标准化的终极形态</h2>
<p>一个优秀的前端工程体系，应该让开发者感觉不到“规范”的存在。 当你 <code>git commit</code> 时，格式自动被格式化了；当你 <code>git push</code> 时，代码质量自动被检查了；当你初始化项目时，最佳实践已经自动就位了。</p>
<p>把标准装进盒子里，把自由还给开发者。</p>
<blockquote>
<p><strong>Next Step:</strong> 单个项目的规范治理虽然复杂，但还在可控范围内。如果我们将视角拉高，面对包含几十个子项目的 <strong>Monorepo（大仓）</strong> ，这些规范该如何复用？构建流程又该如何编排？ 下一节，我们将迎来工程化的“大结局”—— <strong>《第六篇：宏观——大仓时代：Monorepo 架构的工程实践与工具链选择》</strong> 。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Moshi 处理 Null 值并使用默认值的开脑洞解决方案]]></title>    <link>https://juejin.cn/post/7597083743555977259</link>    <guid>https://juejin.cn/post/7597083743555977259</guid>    <pubDate>2026-01-20T05:44:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083743555977259" data-draft-id="7596966040922161158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Moshi 处理 Null 值并使用默认值的开脑洞解决方案"/> <meta itemprop="keywords" content="APP,Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-20T05:44:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="limuyang2"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029684126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Moshi 处理 Null 值并使用默认值的开脑洞解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029684126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    limuyang2
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:44:23.000Z" title="Tue Jan 20 2026 05:44:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先看问题</h2>
<p>对于<code>Json</code>中的<code>Null</code>值，常规处理的方式给对象加一个<code>?</code>号。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"str"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"i"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"5"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(
    <span class="hljs-keyword">val</span> str: String? = <span class="hljs-string">"abc"</span>, <span class="hljs-comment">// 必须加问号，否则会崩溃</span>
    <span class="hljs-keyword">val</span> i: <span class="hljs-built_in">Int</span> = <span class="hljs-number">1</span>,
)
</code></pre>
<p>这样就会有个问题，<code>str</code>会被赋值为<code>null</code>。</p>
<p>但是我们期望<code>null</code>值的时候，使用<code>abc</code>这个默认值，做不到。除非后台不返回这个<code>str</code>这个字段，就会使用默认值。</p>
<h2 data-id="heading-1">激烈讨论过程</h2>
<p>对于<code>null</code>这个问题的理解，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsquare%2Fmoshi%2Fissues%2F843" target="_blank" title="https://github.com/square/moshi/issues/843" ref="nofollow noopener noreferrer">Moshi Github</a>上有着非常激烈的讨论。</p>
<p>总结下来就是：官方认为，后台返回 <code>null</code>，是业务的一种形式，代表这个业务不存在。我们应该在团队合作中，约定一个规范的<code>Json</code>格式行为，而不是无脑区兜底<code>null</code>值。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">官方最终的解释：
It has one answer <span class="hljs-keyword">in</span> Moshi and <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> Moshi<span class="hljs-string">'s opinion :).  
答案只有一个，那就是 Moshi 的看法:)。
</span></code></pre>
<p>好好好，<code>Moshi</code>团队你有你的看法。但是……但是，理想是很美好，我也想规范，但是现实不允许，先不说后台大哥好不好说话，就说历史API接口，没人敢动、也没人想动。</p>
<h2 data-id="heading-2">解决方案</h2>
<p>在<code>Github</code>的讨论中，不乏各种各样的解决方案，比如<code>JakeWharton</code>大神给出的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsquare%2Fmoshi%2Fissues%2F1809" target="_blank" title="https://github.com/square/moshi/issues/1809" ref="nofollow noopener noreferrer">自定义注解解决方案</a></p>
<p>这用起来很难，我不可能每个字段都去加吧。。。。。</p>
<p>在最后的回复，我看到了一个大开脑洞的方案，太巧妙了。</p>
<p><strong>自定义<code>JsonReader</code>，当读取到 <code>null</code> 的字段，直接忽略掉，欺骗上面的人，说这个字段不存在，上面的人就会用默认数值构造函数</strong>。太鸡贼了。无需用什么自定义注解，无痛切入现在的项目。</p>
<h4 data-id="heading-3">首先自定义 <code>DefaultIfNullFactory</code></h4>
<p>用于向<code>moshi</code>注册解析器，常规步骤，不多解析。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultIfNullFactory</span> : <span class="hljs-type">JsonAdapter.Factory</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(
        type: <span class="hljs-type">Type</span>,
        annotations: <span class="hljs-type">MutableSet</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">Annotation</span>&gt;,
        moshi: <span class="hljs-type">Moshi</span>
    )</span></span>: JsonAdapter&lt;*&gt;? {
        <span class="hljs-keyword">if</span> (annotations.isNotEmpty()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 基础数据类型忽略，moshi自己处理，就是直接是 基础数据类型的json：例如“1”，“true”</span>
        <span class="hljs-keyword">if</span> (type === String::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Boolean</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Byte</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Char</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Double</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Float</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Int</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Long</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Short</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Boolean</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Byte</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Char</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Double</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Float</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Int</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Long</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Short</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-keyword">val</span> delegate = moshi.nextAdapter&lt;Any&gt;(<span class="hljs-keyword">this</span>, type, annotations)

        <span class="hljs-comment">// 对象类型的走我们自己的，例如打括号包起来的："{}"</span>
        <span class="hljs-keyword">return</span> SkipNullsAdapter(delegate)
    }
}
</code></pre>
<p><code>SkipNullsAdapter</code> 也没啥说的</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkipNullsAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> delegate: JsonAdapter&lt;Any&gt;
) : JsonAdapter&lt;Any&gt;() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fromJson</span><span class="hljs-params">(reader: <span class="hljs-type">JsonReader</span>)</span></span>: Any? {
        <span class="hljs-comment">// 如果是对象结构，才包装 reader 跳过 null</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (reader.peek() == JsonReader.Token.BEGIN_OBJECT) {
            <span class="hljs-comment">// 使用自己的 reader</span>
            delegate.fromJson(JsonReaderSkipNullValuesWrapper(reader))
        } <span class="hljs-keyword">else</span> {
            delegate.fromJson(reader)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toJson</span><span class="hljs-params">(writer: <span class="hljs-type">JsonWriter</span>, value: <span class="hljs-type">Any</span>?)</span></span> {
        delegate.toJson(writer, value)
    }
}
</code></pre>
<h4 data-id="heading-4">欺骗的艺术来了</h4>
<p>自己新建一个这个<code>com.squareup.moshi</code>包名（路径名）下，因为<code>JsonReader</code> 不允许外部继承。我们需要假装自己是它包里的类。</p>
<p>然后自定义一个<code>JsonReaderSkipNullValuesWrapper</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonReaderSkipNullValuesWrapper</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> wrapped: JsonReader
) : JsonReader() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ignoreSkipName = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ignoreSkipValue = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">close</span><span class="hljs-params">()</span></span> {
        wrapped.close()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">beginArray</span><span class="hljs-params">()</span></span> {
        wrapped.beginArray()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endArray</span><span class="hljs-params">()</span></span> {
        wrapped.endArray()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">beginObject</span><span class="hljs-params">()</span></span> {
        wrapped.beginObject()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endObject</span><span class="hljs-params">()</span></span> {
        wrapped.endObject()
        ignoreSkipName = <span class="hljs-literal">false</span>
        ignoreSkipValue = <span class="hljs-literal">false</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasNext</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> wrapped.hasNext()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">peek</span><span class="hljs-params">()</span></span>: Token {
        <span class="hljs-keyword">return</span> wrapped.peek()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextName</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> wrapped.nextName()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">selectName</span><span class="hljs-params">(options: <span class="hljs-type">Options</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">val</span> index = wrapped.selectName(options)
        <span class="hljs-comment">// 这里进行欺骗，返回-1表示没有这个字段</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span> &amp;&amp; wrapped.peek() == Token.NULL) {
            wrapped.skipValue()
            ignoreSkipName = <span class="hljs-literal">true</span>
            ignoreSkipValue = <span class="hljs-literal">true</span>
            -<span class="hljs-number">1</span>
        } <span class="hljs-keyword">else</span> {
            index
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">skipName</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (ignoreSkipName) {
            ignoreSkipName = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">return</span>
        }
        wrapped.skipName()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextString</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> wrapped.nextString()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">selectString</span><span class="hljs-params">(options: <span class="hljs-type">Options</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> wrapped.selectString(options)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextBoolean</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> wrapped.nextBoolean()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any?&gt;</span> <span class="hljs-title">nextNull</span><span class="hljs-params">()</span></span>: T? {
        <span class="hljs-keyword">return</span> wrapped.nextNull()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextDouble</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Double</span> {
        <span class="hljs-keyword">return</span> wrapped.nextDouble()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextLong</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Long</span> {
        <span class="hljs-keyword">return</span> wrapped.nextLong()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextInt</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> wrapped.nextInt()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextSource</span><span class="hljs-params">()</span></span>: BufferedSource {
        <span class="hljs-keyword">return</span> wrapped.nextSource()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">skipValue</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (ignoreSkipValue) {
            ignoreSkipValue = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">return</span>
        }
        wrapped.skipValue()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">peekJson</span><span class="hljs-params">()</span></span>: JsonReader {
        <span class="hljs-keyword">return</span> wrapped.peekJson()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">promoteNameToValue</span><span class="hljs-params">()</span></span> {
        wrapped.promoteNameToValue()
    }
}
</code></pre>
<h4 data-id="heading-5">使用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> moshi = Moshi.Builder()
    .add(DefaultIfNullFactory()) <span class="hljs-comment">// 注册进来</span>
    .build()
</code></pre>
<h4 data-id="heading-6">结果验证</h4>
<p>Json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"str"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"i"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"5"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>data class</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(
    <span class="hljs-keyword">val</span> list: List&lt;<span class="hljs-built_in">Int</span>&gt;? = <span class="hljs-literal">null</span>, <span class="hljs-comment">// 如果想保持为null，就加上 ? 问号</span>

    <span class="hljs-keyword">val</span> str: String = <span class="hljs-string">"abc"</span>, <span class="hljs-comment">// 不想要 null，就不要加问号</span>

    <span class="hljs-keyword">val</span> i: <span class="hljs-built_in">Int</span> = <span class="hljs-number">1</span>,
)
</code></pre>
<p>输出</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Test(list=<span class="hljs-literal">null</span>, str=abc, i=<span class="hljs-number">5</span>)
</code></pre>
<p>解释下（AI生成的，我改了改。但是我觉得解释的足够清楚了）</p>
<h3 data-id="heading-7">工作原理</h3>
<p>这个类最核心的魔法发生在 <code>selectName()</code> 方法中：</p>
<ul>
<li>
<ol>
<li>它首先调用被包装的 <code>JsonReader</code> 的 <code>selectName()</code> 方法来查找下一个字段。</li>
</ol>
</li>
<li>
<ol start="2">
<li>如果找到了一个匹配的字段 (<code>index &gt;= 0</code>)，它会立刻用 <code>peek()</code> 方法查看该字段的值。</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>如果值是 <code>Token.NULL</code></strong>:</li>
</ol>
<ul>
<li>a. 它会立即调用 <code>skipValue()</code> 来消耗掉这个 <code>null</code> 值。</li>
<li>b. 然后它设置内部的 <code>ignoreSkipName</code> 和 <code>ignoreSkipValue</code> 标志位为 <code>true</code>。</li>
<li>c. 最后，它向调用者（KSP Adapter）<strong>谎称</strong>没有找到这个字段，返回 <code>-1</code>。</li>
</ul>
</li>
<li>
<ol start="4">
<li>KSP生成的Adapter收到<code>-1</code>后，会认为这是一个未知字段，并进入其 <code>case -1</code> 分支，该分支会尝试调用 <code>skipName()</code> 和 <code>skipValue()</code>，并使用属性的默认值。</li>
</ol>
</li>
<li>
<ol start="5">
<li>我们重写的 <code>skipName()</code> 和 <code>skipValue()</code> 方法会检查对应的 <code>ignore...</code> 标志位。如果为<code>true</code>，它们会消耗掉这个标志位并直接返回，从而“屏蔽”了KSP Adapter多余的跳过操作，避免了在错误的流位置上操作而导致的异常。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-8">结果</h3>
<p>通过上述流程，值为<code>null</code>的字段被巧妙地从解析流中移除。这使得Moshi的后续处理逻辑会认为该字段在JSON中“缺失”。</p>
<p>Kotlin 的 data class 中对应的非空属性 必须 要提供默认值（例如 <code>val name: String = ""</code>），Moshi会使用这个默认值。如果没有默认值会导致异常。</p>
<h3 data-id="heading-9">状态管理</h3>
<ul>
<li><code>ignoreSkipName</code> 和 <code>ignoreSkipValue</code> 是处理这种“欺骗”行为所必需的状态，它们确保了在 <code>selectName</code> 手动跳过一个键值对后，能够正确地拦截并忽略掉Adapter后续的、多余的 <code>skip</code> 调用。</li>
<li>在 <code>endObject()</code> 方法中，这些状态被强制重置。这是一个防御性措施，确保在一个对象解析作用域结束时，所有临时状态都被清理干净，防止状态泄露并污染到外层对象的解析。</li>
</ul>
<h2 data-id="heading-10">Bingo</h2>
<p>巧妙的思路</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不只是图片：深入理解 GIS 栅格数据本质与 GDAL 读写实战]]></title>    <link>https://juejin.cn/post/7597009443084664847</link>    <guid>https://juejin.cn/post/7597009443084664847</guid>    <pubDate>2026-01-20T05:43:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084664847" data-draft-id="7596993862534250496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不只是图片：深入理解 GIS 栅格数据本质与 GDAL 读写实战"/> <meta itemprop="keywords" content="GIS"/> <meta itemprop="datePublished" content="2026-01-20T05:43:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不只是图片：深入理解 GIS 栅格数据本质与 GDAL 读写实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:43:30.000Z" title="Tue Jan 20 2026 05:43:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>GIS 栅格数据只是一张普通图片吗？其实它可以是高程、降雨量、土地类型，甚至是二维空间信号。本文节选自新书<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">《GIS基础原理与技术实践》</a>第5章，带你穿透表象，掌握栅格数据的本质与 GDAL 开发核心技能。</p>
</blockquote>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/2bf65f3153b943e4a60f5c4aabfbb020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=RjeBNUMjDGjCHkUBCMD4gwx1TSg%3D" alt="GIS基础原理与技术实践" loading="lazy"/></p>
<h2 data-id="heading-0">第5章 地理空间数据之栅格</h2>
<h3 data-id="heading-1">导言</h3>
<p>在上一章节中，我们对地理空间数据进行了初步的介绍，并详细的论述了其表现形式之一的矢量数据。而在本章中，我们会详细论述地理空间数据的另外一种表现形式，也就是栅格数据。矢量和栅格是GIS地理空间数据最基础的两种数据类型，是一定需要理解和掌握的。</p>
<h3 data-id="heading-2">5.1 栅格数据的深入认识</h3>
<p>通过第4.1节中的介绍，我们对栅格数据有了一个初步的认识：栅格是地理空间连续实体的表达。接下来在本节中，我们会进一步探索栅格的技术细节，加深对栅格数据的理解。</p>
<h4 data-id="heading-3">5.1.1 离散还是连续</h4>
<p>记得笔者有一次跟同事争论，图像数据（也就是栅格数据）到底是离散的还是连续的？当时笔者还是个GIS菜鸟，认为图像是离散的。从前面介绍的知识来说，很显然栅格是地理的连续表达。与矢量只能知道具体的要素的坐标不同，我们可以很容易获取每一个栅格单元具体的地理坐标，体现了数据的连续性。然而，当我们把一张图像放大，我们很容易会看到一个个具体的栅格单元，如下图5.1所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/66df1775a12f4ec083c19658bbeee4c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=iNDunJFXMWUUT1xa0iKpQBk83R8%3D" alt="图5.1 放大后的栅格单元" loading="lazy"/></p>
<p>这些栅格单元中突变的颜色表明，栅格数据并不是我们想象的那样单纯的具有连续性。栅格数据对地理空间的表达总是会受制于采样频率，最直观的体现就是分辨率。如同现实中显示器一样，分辨率越高意味着像素的数目越多，显示效果就越精细。但是无论多精细，其实都是由离散的栅格单元在二维平面上连续铺盖成的格网组成的。如此说来，笔者在菜鸟时期认为栅格数据是离散的，可以说还是具有一定的正确性的，尽管是误打误撞。离散还是连续，并不是绝对的，关键还在于是如何看待和认知：</p>
<ul>
<li>在宏观意义上，栅格数据毫无疑问是连续的，这是区别与矢量数据的根本特性。只要是在栅格数据的范围之内，就可以获取任意位置的地理对象值。</li>
<li>在微观意义上，栅格数据也可以认为是离散的。受制于数据表达的载体，总会在一个无法细分的尺度上，用一个离散的栅格单元来代表一定连续范围内的地理对象值。</li>
</ul>
<p>栅格数据关于离散还是连续的讨论，我们在后面还会涉及到。</p>
<h4 data-id="heading-4">5.1.2 栅格的表现形式</h4>
<p>我们在4.1节中介绍过，栅格数据的一种具体表现形式就是我们经常见到的图片（有时称为图像，或者影像）。但是认为图片就是栅格，这种理解并不全面，栅格数据的内涵要丰富得多。</p>
<p>我们最常见的图片是24位真彩色图片，因为每个像素都由红绿蓝（RGB）3种颜色值混合而成，而每个波段的颜色值都由而一个8位整型表示。这样，真彩色图片能表示的颜色就有 256 X 256 X 256 = 16777216 种不同颜色，这恰好大于人类能识别1000万种颜色的限制。另外，出于数据叠加显示等目的，还会将第4个波段设置成透明度。其实透明度并不是一个颜色值，其是当前颜色值与背景颜色值的混合。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/686ca87b725242ce9dabea21ae821523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=y%2BULYpFurEznnpUhZgWBHbWJsoo%3D" alt="图5.2 国家天地图上的真彩色数字影像图" loading="lazy"/></p>
<p>在遥感领域，很多传感器并不是只能接受红绿蓝这三种可见光的波段，一些不可见的波段也可以接收到（比如红外波段），这主要取决于传感器的波长分辨率。因此，第4个波段也不一定就是透明度，而是其光谱的反射值或者辐射值。甚至于可以存在4个以上的波段。光谱的反射值也不一定就是8位整型，用于遥感探测的传感器要敏感的多，因此每个波段的光谱反射值是16位、32位甚至64位数值都是有可能的。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/61bdc944b0b949b8adbd7d574f974dca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=bEY%2BtNYyF3oggwySehck0uDFRcM%3D" alt="图5.3 遥感影像中的不可见光波段" loading="lazy"/></p>
<p>栅格数据中格网单元的取值可以是可见光的颜色，也可以是遥感获取的具体探测值。那么，存放其他类型的数据是可以的吗?当然也是可以的，比如我们可以在栅格数据中储存高程值，就可以表达地形，成为栅格形式的DEM（Digital Elevation Model，数字高程模型）数据。这一点我们会在后续的地形章节中专门论述它。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/5faaa1d52b7a404baadfa17030be3c5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=Zm7weBUTcHs4oZTH1SLuvd5le2w%3D" alt="图5.4 SRTM（Shuttle Radar Topography Mission，航天飞机雷达地形测量）地形数据晕渲图" loading="lazy"/></p>
<p>既然栅格单元可以存放高程，那么存放一些诸如表达降雨量，污染浓度这样的测量值，或者土地类型这样的分类值也是可以的——此类数据就是与业务紧密关联的专题栅格数据，具有很大的实用价值，可以在其基础之上进行专题分析，例如利用降雨量专题数据进行淹没分析。当然，专题栅格数据如果需要进行可视化的话，就需要进行转换。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/66788c88dd274e7ab005745cdda5f8ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=Noeti6Ueyotbh8828U0ECYwZqB0%3D" alt="图5.5 国家天地图上的人口密度专题图" loading="lazy"/></p>
<p>栅格数据（图像）还可以看成是信号。在常规的认知中，我们通常认为信号是随时间t变化的一种东西，比如电磁波或者声波。实际上，栅格数据（图像）可以认为是一个沿着空间分布、随着X空间轴和Y空间轴变化的二维信号。有这一点认知非常重要，因为很多栅格数据处理的算法都需要借助于信号的理论，比如我们后续会介绍的滤波。</p>
<p>最后，在数学中可以认为栅格数据就是一个很大的矩阵，可以进行复杂的矩阵运算。很多运算数据都可以转换成矩阵，从而被转换成图片格式来保存，这也与我们认知的常规图片不同。</p>
<h4 data-id="heading-5">5.1.3 正射还是透视</h4>
<p>以GIS中最常用的地图来说，我们至少有这样一个认识：地图上每一段相同距离所代表的实际距离都相等。如果不具备这样的特性，地图就不可能辅助我们进行导航等空间位置上的决策。在GIS中，大部分栅格数据就是这种具备相同比例尺的光学影像数据，它好像是很多道平行的光线同时反射到摄像机成像生成的，所以通常被称为数字正射影像图（DOM，Digital Orthophoto Map）。</p>
<p>但是在现实中，理想的正射成像模型几乎不存在，大多数摄像机都是透视成像模型，其生成的图像最大的特点就是近大远小，并且投影的光线会聚于一点。这也是真实的人眼成像的特点。其实，数字正射影像图就是通过透视成像模型的图片做几何纠正生成的，这一点在GIS的关联学科《摄影测量学》中有详细的介绍。如下图5.6所示为正射成像模型和透视成像模型示意图：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/3cde9d566ada4f4c96c337bee200ced3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=%2BlsjJEVy108ohq5kIu1tEqSQemE%3D" alt="图5.6 正射成像模型和透视成像模型" loading="lazy"/></p>
<p>正射还是透视只是图像的生成的两种不同的方式，并不会影响图像或者栅格数据本身的性质。在GIS中的栅格数据大多数指的是数字正射影像图，能够使用专业的GIS方法进行处理，这是常规的基于透视成像模型的图片所不具备的。</p>
<h3 data-id="heading-6">5.2 栅格数据开发基础</h3>
<h4 data-id="heading-7">5.2.1 栅格数据读取</h4>
<p>与矢量数据一样，可以使用第三方开源库GDAL来实现栅格数据的基础开发。GDAL提供了市面上绝大多数常见栅格数据的支持，并将其抽象成一个数据集对象。读取栅格数据的示例如下例5.1所示：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 例5.1 使用GDAL读取栅格数据</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();

  string srcFile = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  srcFile = srcFile + <span class="hljs-string">"/../Data/Raster/berry_ali_2011127_crop_geo.tif"</span>;

  GDALDataset* img = (GDALDataset*)<span class="hljs-built_in">GDALOpen</span>(srcFile.<span class="hljs-built_in">c_str</span>(), GA_ReadOnly);
  <span class="hljs-keyword">if</span> (!img) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  <span class="hljs-type">int</span> imgWidth = img-&gt;<span class="hljs-built_in">GetRasterXSize</span>();   <span class="hljs-comment">//图像宽度</span>
  <span class="hljs-type">int</span> imgHeight = img-&gt;<span class="hljs-built_in">GetRasterYSize</span>();  <span class="hljs-comment">//图像高度</span>
  <span class="hljs-type">int</span> bandNum = img-&gt;<span class="hljs-built_in">GetRasterCount</span>();    <span class="hljs-comment">//波段数</span>
  <span class="hljs-type">int</span> depth = <span class="hljs-built_in">GDALGetDataTypeSize</span>(img-&gt;<span class="hljs-built_in">GetRasterBand</span>(<span class="hljs-number">1</span>)-&gt;<span class="hljs-built_in">GetRasterDataType</span>()) / <span class="hljs-number">8</span>;  <span class="hljs-comment">//图像深度</span>

  cout &lt;&lt; <span class="hljs-string">"宽度："</span> &lt;&lt; imgWidth &lt;&lt; <span class="hljs-string">'\n'</span>;
  cout &lt;&lt; <span class="hljs-string">"高度："</span> &lt;&lt; imgHeight &lt;&lt; <span class="hljs-string">'\n'</span>;
  cout &lt;&lt; <span class="hljs-string">"波段数："</span> &lt;&lt; bandNum &lt;&lt; <span class="hljs-string">'\n'</span>;
  cout &lt;&lt; <span class="hljs-string">"深度："</span> &lt;&lt; depth &lt;&lt; <span class="hljs-string">'\n'</span>;

  <span class="hljs-built_in">GDALClose</span>(img);
  img = <span class="hljs-literal">nullptr</span>;
}
</code></pre>
<p>在这个示例中，从栅格数据文件中创建了一个数据集对象，并且获取了影像的宽度、高度和波段数（通道数）和深度。深度有点难以理解，指的是栅格存储数据类型的字节数。常规的影像数据都采用8位无符号整型进行存储，因此深度都为1。
本例运行结果如下：</p>
<pre><code class="hljs language-bash" lang="bash">宽度：4000
高度：7200
波段数：4
深度：1
</code></pre>
<h4 data-id="heading-8">5.2.2 栅格数据创建</h4>
<p>另一方面，也可以根据一个数据集对象创建栅格数据文件，也就是栅格数据的写出操作。与第4.4.2节中创建矢量的步骤类似，同样通过GDAL的数据驱动GDALDriver，传入数据类型的名称来创建对应格式的栅格文件，如下例5.2所示，创建了一个tif格式的栅格数据：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 例5.2 使用GDAL创建栅格数据</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();  <span class="hljs-comment">//注册格式</span>

  string dstFile = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  dstFile = dstFile + <span class="hljs-string">"/../Data/Raster/dst.tif"</span>;

  GDALDriver* pDriver =
      <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"GTiff"</span>);  <span class="hljs-comment">//图像驱动</span>
  <span class="hljs-type">char</span>** ppszOptions = <span class="hljs-literal">NULL</span>;
  ppszOptions =
      <span class="hljs-built_in">CSLSetNameValue</span>(ppszOptions, <span class="hljs-string">"BIGTIFF"</span>, <span class="hljs-string">"IF_NEEDED"</span>);  <span class="hljs-comment">//配置图像信息</span>

  <span class="hljs-type">int</span> imgWidth = <span class="hljs-number">256</span>;
  <span class="hljs-type">int</span> imgHeight = <span class="hljs-number">256</span>;
  <span class="hljs-type">int</span> bandNum = <span class="hljs-number">3</span>;
  GDALDataset* dst = pDriver-&gt;<span class="hljs-built_in">Create</span>(dstFile.<span class="hljs-built_in">c_str</span>(), imgWidth, imgHeight,
                                     bandNum, GDT_Byte, ppszOptions);
  <span class="hljs-keyword">if</span> (!dst) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't Write Image!"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  <span class="hljs-built_in">GDALClose</span>(dst); 
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>上例中我们创建了一个宽256，高256，波段数3，byte类型（8位，深度1）的栅格数据文件：</p>
<pre><code class="hljs language-cpp" lang="cpp">GDALDriver* pDriver =
      <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"GTiff"</span>);  <span class="hljs-comment">//图像驱动</span>
  <span class="hljs-comment">//...</span>
  GDALDataset* dst = pDriver-&gt;<span class="hljs-built_in">Create</span>(dstFile.<span class="hljs-built_in">c_str</span>(), imgWidth, imgHeight,
                                     bandNum, GDT_Byte, ppszOptions);
</code></pre>
<p>数据类型的名称“GTIFF”是GDAL定义的驱动名，表示创建的数据集对象是一个tif格式的栅格数据文件。一些常用栅格数据格式在GDAL中数据驱动如下表5.1所示：</p>


































<table><thead><tr><th>名称</th><th>全称</th></tr></thead><tbody><tr><td>JPEG</td><td>JPEG JFIF File Format</td></tr><tr><td>PNG</td><td>Portable Network Graphics</td></tr><tr><td>BMP</td><td>Microsoft Windows Device Independent Bitmap</td></tr><tr><td>GTiff</td><td>GeoTIFF File Format</td></tr><tr><td>HFA</td><td>Erdas Imagine .img</td></tr><tr><td>ENVI</td><td>ENVI .hdr Labelled Raster</td></tr></tbody></table>
<p>其中，JPEG、PNG和BMP就是我们经常见到的图像数据格式；GTiff（GeoTIFF）、HFA（Erdas Imagine .img）和ENVI（ENVI .hdr Labelled Raster）则是专业的GIS栅格数据。前者通用性更强，能被常规的图片软件所识别；而后者专业性更高，一些栅格数据的特性常规图像数据无法支持（例如存在数据量大小限制），因此只能使用专业GIS栅格数据，一般情况仅被GIS相关的软件支持。</p>
<p>另一点值得注意的是，在创建特定数据集对象时，可以根据特定格式的需求进行配置：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">char</span>** ppszOptions = <span class="hljs-literal">NULL</span>;
  ppszOptions =
      <span class="hljs-built_in">CSLSetNameValue</span>(ppszOptions, <span class="hljs-string">"BIGTIFF"</span>, <span class="hljs-string">"IF_NEEDED"</span>);  <span class="hljs-comment">//配置图像信息</span>
  <span class="hljs-comment">//...</span>
  GDALDataset* dst = pDriver-&gt;<span class="hljs-built_in">Create</span>(dstFile.<span class="hljs-built_in">c_str</span>(), imgWidth, imgHeight,
                                     bandNum, GDT_Byte, ppszOptions);
</code></pre>
<p>这里配置参数的意思是，在需要的时候使用“BIGTIFF”格式而不是“TIFF”，以避免当栅格数据文件的大小超过4G的时候会创建失败。</p>
<p>最后，在创建数据集完成之后，不要忘了关闭数据集：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">GDALClose</span>(dst);
</code></pre>
<p>此时创建的数据集文件就是一张黑色的栅格图片（因为关闭后默认填充0像素值），如下图5.7所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/3e0cfa70419a44479c4a90a01144a6b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=E7fN5YXx2DcfOM1dfNxHJhtF6%2B0%3D" alt="图5.7 创建的栅格数据集文件" loading="lazy"/></p>
<hr/>
<p>本文节选自作者新书《GIS基础原理与技术实践》第5章。书中系统讲解 GIS 核心理论与多语言实战，适合开发者与高校师生。</p>
<p>📚 <strong>配套资源开源</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffafa1899%2FGISBasic" target="_blank" title="https://github.com/fafa1899/GISBasic" ref="nofollow noopener noreferrer">GitHub</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fcharlee44%2FGISBasic" target="_blank" title="https://gitcode.com/charlee44/GISBasic" ref="nofollow noopener noreferrer">GitCode</a></p>
<p>🛒 <strong>支持正版</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">京东</a>｜<a href="https://link.juejin.cn?target=https%3A%2F%2Fproduct.dangdang.com%2F29988568.html" target="_blank" title="https://product.dangdang.com/29988568.html" ref="nofollow noopener noreferrer">当当</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用瑞士风格哈希表实现更快的 ES|QL 统计]]></title>    <link>https://juejin.cn/post/7597058281435578422</link>    <guid>https://juejin.cn/post/7597058281435578422</guid>    <pubDate>2026-01-20T05:36:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597058281435578422" data-draft-id="7597058281435562038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用瑞士风格哈希表实现更快的 ES|QL 统计"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-01-20T05:36:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用瑞士风格哈希表实现更快的 ES|QL 统计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:36:47.000Z" title="Tue Jan 20 2026 05:36:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fchris-hegarty" title="https://www.elastic.co/search-labs/author/chris-hegarty" target="_blank" ref="nofollow noopener noreferrer">Chris Hegarty</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fmatthew-alp" title="https://www.elastic.co/search-labs/author/matthew-alp" target="_blank" ref="nofollow noopener noreferrer">Matthew Alp</a> 及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fnik-everet" title="https://www.elastic.co/search-labs/author/nik-everet" target="_blank" ref="nofollow noopener noreferrer">Nik Everet</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47135a0cbada4492945bae87c6e48bb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=GmMkIkhcYw5h2wbGxmRtoIBnt6M%3D" alt="" loading="lazy"/></p>
<p>瑞士风格启发的哈希和 SIMD 友好的设计如何在 Elasticsearch Query Language ( ES|QL ) 中提供稳定且可衡量的性能提升。</p>
<p>动手使用 Elasticsearch：深入我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">示例 notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费 cloud trial</a>，或现在在你的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>我们最近将 Elasticsearch 的哈希表实现的关键部分替换为瑞士风格设计，并在均匀、高基数的工作负载上观察到构建和迭代时间提高了 2–3 倍。结果是更低的延迟、更高的吞吐量，以及 Elasticsearch Query Language ( <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fesql" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/esql" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a> ) 统计和分析操作更可预测的性能。</p>
<h2 data-id="heading-0">为什么这很重要</h2>
<p>大多数典型的分析工作流最终归结为对数据进行分组。无论是计算每个 host 的平均字节数、统计每个用户的事件，还是跨维度聚合指标，核心操作都是相同的 —— 将 keys 映射到组并更新运行中的 aggregates。</p>
<p>在小规模下，几乎任何合理的哈希表都能正常工作。在大规模下（数亿文档和数百万个不同组），细节开始重要。负载因子、探测策略、内存布局和缓存行为可能决定性能是线性的还是满是缓存未命中的墙。</p>
<p>Elasticsearch 多年来一直支持这些工作负载，但我们始终在寻找现代化核心算法的机会。因此，我们评估了一种受瑞士表启发的新方法，并将其应用于 ES|QL 计算统计的方式。</p>
<h2 data-id="heading-1">瑞士表到底是什么？</h2>
<p>瑞士表是一类现代哈希表，由 Google 的 SwissTable 推广，后来被 Abseil 和其他库采用。</p>
<p>传统哈希表在追踪指针或加载 keys 时花费大量时间，结果却发现不匹配。瑞士表的定义特征是能够使用一个小型驻缓存数组结构来拒绝大多数探测，该结构与 keys 和 values 分开存储，称为 control bytes，从而显著减少内存流量。</p>
<p>每个控制 byte 表示一个 slot，在我们的例子中编码两件事：该 slot 是否为空，以及从 hash 派生的短 fingerprint。这些控制 bytes 在内存中连续排列，通常以 16 个为一组，非常适合<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSingle_instruction%2C_multiple_data" title="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data" target="_blank" ref="nofollow noopener noreferrer">单指令多数据</a> (SIMD) 处理。</p>
<p>瑞士表不是一次探测一个 slot，而是使用向量指令扫描整个 control-byte 块。在一次操作中，CPU 将进入的 key 的 fingerprint 与 16 个 slots 比较，并过滤掉空条目。只有少数通过此快速路径的候选项需要加载和比较实际 keys。</p>
<p>这种设计用少量额外的元数据换取更好的缓存局部性和更少的随机加载。随着表的增长和探测链的延长，这些特性变得越来越有价值。</p>
<h2 data-id="heading-2">SIMD是核心</h2>
<p>真正的主角是 SIMD。</p>
<p>控制 bytes 不仅紧凑，而且专门设计为可以使用向量指令处理。一次 SIMD 比较可以同时检查 16 个 fingerprints，将原本的循环变成少量的宽操作。例如：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d0aea68632e4f7fbeeac3ae3a0fc6c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=C5iZLHj0XVIoSIuvHzaLJUciE%2FE%3D" alt="" loading="lazy"/></p>
<p>在实践中，这意味着：</p>
<ul>
<li>更少的分支</li>
<li>更短的探测链</li>
<li>更少从 key 和 value 内存的加载</li>
<li>CPU 执行单元的利用率大幅提高</li>
</ul>
<p>大多数查找从未超过控制-byte 扫描阶段。当查找超过时，剩余工作集中且可预测。这正是现代 CPU 擅长处理的工作负载类型。</p>
<h2 data-id="heading-3">SIMD底层原理</h2>
<p>对于喜欢深入了解底层的读者，以下是将新 key 插入表时发生的情况。我们使用 Panama Vector API 和 128 位向量，因此可以并行处理 16 个控制 bytes。</p>
<p>下面的代码片段显示了在带 AVX-512 的 Intel Rocket Lake 上生成的代码。虽然指令反映了该环境，但设计并不依赖于 AVX-512。在其他平台上使用等效指令（例如 AVX2、SSE 或 NEON）也会生成相同的高层向量操作。</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  <span class="hljs-comment">; Load 16 control bytes from the control block</span>
2.  vmovdqu xmm0, XMMWORD PTR <span class="hljs-section">[r9+r10*1+0x10]</span>

4.  <span class="hljs-comment">; Broadcast the 7-bit fingerprint of the new key across the vector</span>
5.  vpbroadcastb xmm1, r11d

7.  <span class="hljs-comment">; Compare all 16 control bytes to the new fingerprint</span>
8.  vpcmpeqb k7, xmm0, xmm1
9.  kmovq rbx, k7

11.  <span class="hljs-comment">; Check if any matches were found</span>
12.  test rbx, rbx
13.  jne &lt;handle_match&gt;

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>每条指令在插入过程中都有明确作用：</p>
<ul>
<li>vmovdqu：将 16 个连续的控制 bytes 加载到 128 位 xmm0 寄存器中</li>
<li>vpbroadcastb：将新 key 的 7 位 fingerprint 在 xmm1 寄存器的所有通道中复制</li>
<li>vpcmpeqb：将每个控制 byte 与广播的 fingerprint 比较，生成潜在匹配的掩码</li>
<li>kmovq + test：将掩码移动到通用寄存器，并快速检查是否存在匹配</li>
</ul>
<p>最后，使用更宽的寄存器和相应指令在我们的基准测试中未显示出明显的性能提升。</p>
<h2 data-id="heading-4">ES|QL中的集成</h2>
<p>在 Elasticsearch 中采用瑞士风格哈希并不是直接替换。ES|QL 对内存计算、安全性以及与其他计算引擎的集成有严格要求。</p>
<p>我们将新的哈希表与 Elasticsearch 的内存管理紧密集成，包括页面回收器和 circuit breaker 计数，确保分配保持可见且受限。Elasticsearch 的聚合数据密集存储，并按 group ID 索引，使内存布局紧凑、迭代快速，同时通过允许随机访问实现某些性能优化。</p>
<p>对于可变长度的字节 keys，我们将完整 hash 与 group ID 一起缓存。这避免了在探测过程中重新计算昂贵的 hash 码，并通过将相关元数据靠近存放来提高缓存局部性。在 rehash 过程中，我们可以依赖缓存的 hash 和控制 bytes，而无需检查值本身，从而保持调整大小成本低。</p>
<p>我们实现中的一个重要简化是条目从不删除。这消除了 tombstones（标记以前占用的 slots）的需求，使空 slot 保持真正空闲，进一步改善探测行为并保持控制-byte 扫描高效。</p>
<p>结果是一个自然适应 Elasticsearch 执行模型的设计，同时保留了瑞士表吸引人的性能特性。</p>
<h2 data-id="heading-5">性能如何？</h2>
<p>在小基数下，瑞士表的性能大致与现有实现相当。这是预期的：当表较小时，缓存效应影响较小，几乎没有需要优化的探测。</p>
<p>随着基数增加，情况会迅速变化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46e11f040f1404fb6d9f683a9cb9a5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=BvJxcOO0Udk6bjDMI%2FX9X21jFLY%3D" alt="" loading="lazy"/></p>
<p>上方的热图显示了不同 key 大小（8、32、64 和 128 bytes）在基数从 1,000 到 10,000,000 组下的时间提升因子。随着基数增加，提升因子稳步上升，在均匀分布下可达到 2–3 倍。</p>
<p>这一趋势正是设计所预测的。传统哈希表中基数越高，探测链越长，而瑞士风格探测则继续在 SIMD 友好的控制-byte 块中解决大多数查找。</p>
<h2 data-id="heading-6">缓存行为说明一切</h2>
<p>为了更好理解速度提升，我们在 Linux perf 下运行相同的 JMH <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch%2Fpull%2F139343%2Ffiles%23diff-d0e0cc91a7495bf36b2d44eacce95f5185d01879e5f6c38089ac7a89aad17da7" title="https://github.com/elastic/elasticsearch/pull/139343/files#diff-d0e0cc91a7495bf36b2d44eacce95f5185d01879e5f6c38089ac7a89aad17da7" target="_blank" ref="nofollow noopener noreferrer">基准测试</a>，并捕获缓存和 TLB 统计数据。</p>
<p>与原实现相比，瑞士版本总体缓存引用减少约 60%。最后一级缓存（LLC）加载下降超过 4 倍，LLC 加载未命中下降超过 6 倍。由于 LLC 未命中通常直接转化为主内存访问，仅这一减少就解释了端到端性能提升的大部分。</p>
<p>靠近 CPU 层面，我们看到 L1 数据缓存未命中减少，数据 TLB 未命中几乎减少 6 倍，显示出更紧密的空间局部性和更可预测的内存访问模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5be1f742b284fc7a4aaf489263fe372~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=YYzCMoYJvLBF1aVa1kHd2tnM6SI%3D" alt="" loading="lazy"/></p>
<p>这就是 SIMD 友好控制 bytes 的实际收益。大多数探测通过扫描紧凑、驻缓存的结构即可解决，而无需反复从分散的内存位置加载 keys 和 values。访问的内存越少，未命中越少，未命中越少，查询就越快。</p>
<h2 data-id="heading-7">总结</h2>
<p>通过采用瑞士风格哈希表设计，并充分利用 SIMD 友好探测，我们在高基数 ES|QL 统计工作负载上实现了 2–3 倍的加速，同时性能更加稳定且可预测。</p>
<p>这项工作强调了现代 CPU 感知数据结构如何释放可观的性能增益，即使是针对哈希表等已被广泛研究的问题。这里还有更多探索空间，例如额外的基本类型特化，以及在其他高基数路径（如 joins）中的应用，这些都只是持续现代化 Elasticsearch 内部的更广泛努力的一部分。</p>
<p>如果你对细节感兴趣或想跟踪这项工作，可以查看 Github 上的这个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch%2Fpull%2F139343" title="https://github.com/elastic/elasticsearch/pull/139343" target="_blank" ref="nofollow noopener noreferrer">pull request</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch%2Fissues%2F138799" title="https://github.com/elastic/elasticsearch/issues/138799" target="_blank" ref="nofollow noopener noreferrer">meta issue</a>。</p>
<p>祝哈希愉快！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fesql-swiss-hash-stats" title="https://www.elastic.co/search-labs/blog/esql-swiss-hash-stats" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript函数指南]]></title>    <link>https://juejin.cn/post/7596991930984628275</link>    <guid>https://juejin.cn/post/7596991930984628275</guid>    <pubDate>2026-01-20T05:38:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596991930984628275" data-draft-id="7596998306380595250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript函数指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T05:38:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript函数指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:38:52.000Z" title="Tue Jan 20 2026 05:38:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 TypeScript 中，函数不再是简单的代码块，而是具有精确类型约束的可组合单元。本文将深入讲解 TypeScript 函数，掌握从基础声明到多态模式的完整知识体系。</p>
</blockquote>
<h2 data-id="heading-0">函数声明与调用</h2>
<h3 data-id="heading-1">函数声明</h3>
<p>在之前的文章中，我们介绍过 <code>函数（Function）</code> 也是 TypeScript 中的数据类型的一种，在 TypeScript 中，函数是这样的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
	<span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<blockquote>
<p>注：上述代码只是为了完整的函数声明展示，实际开发中，我们只会显式声明函数的参数（上述例子中的 a 和 b）；而返回类型是不用显式声明的，毕竟 TypeScript 能自己推导的事，没必要人为再操作一次。</p>
</blockquote>
<p>在 TypeScript 中，支持以下五种函数声明方式。</p>
<h4 data-id="heading-2">普通具名函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {
	<span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<h4 data-id="heading-3">函数表达式</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> greet = <span class="hljs-keyword">function</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
};
</code></pre>
<h4 data-id="heading-4">箭头函数</h4>
<ul>
<li>简单的箭头函数语法：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> greet = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
};
</code></pre>
<ul>
<li>箭头函数的简写形式：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">greet</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
</code></pre>
<h4 data-id="heading-5">类方法声明</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-comment">// 实例方法</span>
    <span class="hljs-title function_">add</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-keyword">return</span> x + y;
    }
    
    <span class="hljs-comment">// 静态方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-keyword">return</span> x * y;
    }
    
    <span class="hljs-comment">// 可选方法</span>
    optionalMethod?(<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>;
}
</code></pre>
<h4 data-id="heading-6">构造函数声明</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> name: <span class="hljs-built_in">string</span>,
        <span class="hljs-keyword">public</span> age: <span class="hljs-built_in">number</span>,
        <span class="hljs-keyword">private</span> id?: <span class="hljs-built_in">string</span>
    </span>) {}
}

<span class="hljs-comment">// 构造签名类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserConstructor</span> = <span class="hljs-keyword">new</span> (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-title class_">User</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">Ctor: UserConstructor, name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ctor</span>(name, age);
}
</code></pre>
<h2 data-id="heading-7">函数重载</h2>
<p>在本节开始之前，先看一条定理：</p>
<pre><code class="hljs language-bash" lang="bash">不能基于 TypeScript 来重载一个函数。
</code></pre>
<p>这句话到底是什么意思呢？我们来看一个简单的示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">string</span>, b:<span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p>上述示例代码会报错：<code>函数实现重复</code> ，即我们不能通过类似Java、C++ 等语言形式，通过参数类型不同来实现函数重载。那么，在 TypeScript 中，我们应该如何操作呢？</p>
<ul>
<li>为一个函数提供多个声明，但只有一个实现：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">string</span>, b: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>, b: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">"number"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">"number"</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// 数字相加</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">"string"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">"string"</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// 字符串拼接</span>
  }
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"参数必须同时为number或string"</span>);
}
</code></pre>
<p>上述代码中，前两个 add 函数的声明，只提供类型信息，当 TypeScript 生成 JavaScript 时，它们会自动移除，只留下实现。</p>
<blockquote>
<p>上述代码只是一个简单的重载示例，本身是存在缺陷的，上述情况下，我们应优先选择条件类型，而不是重载声明。</p>
</blockquote>
<h2 data-id="heading-8">多态函数与泛型</h2>
<h3 data-id="heading-9">什么是多态</h3>
<p><strong>多态</strong> 顾名思义，意味着"多种形态"。在 TypeScript 中，多态主要通过泛型实现，它允许我们编写可以处理多种类型的代码，同时保持类型安全。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 非多态版本：为每种类型写一个函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">identityString</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">identityNumber</span>(<span class="hljs-params">value: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">identityBoolean</span>(<span class="hljs-params">value: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 多态版本：一个函数处理所有类型</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 可以处理任意类型</span>
<span class="hljs-title function_">identity</span>(<span class="hljs-string">"hello"</span>);   <span class="hljs-comment">// string</span>
<span class="hljs-title function_">identity</span>(<span class="hljs-number">42</span>);        <span class="hljs-comment">// number</span>
<span class="hljs-title function_">identity</span>(<span class="hljs-literal">true</span>);      <span class="hljs-comment">// boolean</span>
<span class="hljs-title function_">identity</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// number[]</span>
</code></pre>
<h3 data-id="heading-10">什么是泛型</h3>
<p><strong>泛型</strong> 是类型系统中的类型参数，它允许我们在定义函数、接口、类时声明类型变量，在使用时再指定具体类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型就像函数的参数，但是针对类型</span>
<span class="hljs-comment">// 普通函数参数：在调用时传递值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> x + y;
}

<span class="hljs-comment">// 泛型函数：在调用时传递类型</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// T 是类型参数，就像 value 是值参数</span>
</code></pre>
<h3 data-id="heading-11">何时使用泛型？</h3>
<h4 data-id="heading-12">当需要保持输入输出类型一致时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 示例1：身份函数</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 示例2：数组包装</span>
<span class="hljs-keyword">function</span> wrapInArray&lt;T&gt;(<span class="hljs-attr">value</span>: T): T[] {
    <span class="hljs-keyword">return</span> [value];
}

<span class="hljs-comment">// 示例3：交换函数</span>
<span class="hljs-keyword">function</span> swap&lt;T, U&gt;(<span class="hljs-attr">pair</span>: [T, U]): [U, T] {
    <span class="hljs-keyword">return</span> [pair[<span class="hljs-number">1</span>], pair[<span class="hljs-number">0</span>]];
}

<span class="hljs-keyword">const</span> swapped = <span class="hljs-title function_">swap</span>([<span class="hljs-number">1</span>, <span class="hljs-string">"hello"</span>]); <span class="hljs-comment">// ["hello", 1]</span>
</code></pre>
<h4 data-id="heading-13">当函数逻辑与具体类型无关时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 处理数组的函数，不关心数组元素的类型</span>
<span class="hljs-keyword">function</span> getLast&lt;T&gt;(<span class="hljs-attr">array</span>: T[]): T | <span class="hljs-literal">undefined</span> {
    <span class="hljs-keyword">return</span> array[array.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
}

<span class="hljs-comment">// 映射函数，转换逻辑由调用者提供</span>
<span class="hljs-keyword">function</span> mapArray&lt;T, U&gt;(
    <span class="hljs-attr">array</span>: T[],
    <span class="hljs-attr">mapper</span>: <span class="hljs-function">(<span class="hljs-params">item: T, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> U
): U[] {
    <span class="hljs-keyword">return</span> array.<span class="hljs-title function_">map</span>(mapper);
}

<span class="hljs-comment">// 过滤函数</span>
<span class="hljs-keyword">function</span> filterArray&lt;T&gt;(
    <span class="hljs-attr">array</span>: T[],
    <span class="hljs-attr">predicate</span>: <span class="hljs-function">(<span class="hljs-params">item: T</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>
): T[] {
    <span class="hljs-keyword">return</span> array.<span class="hljs-title function_">filter</span>(predicate);
}
</code></pre>
<h4 data-id="heading-14">当需要类型约束时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 约束类型参数必须具有特定属性</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HasLength</span> {
    <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">function</span> logLength&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HasLength</span>&gt;(<span class="hljs-attr">item</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Length: <span class="hljs-subst">${item.length}</span>`</span>);
}

<span class="hljs-title function_">logLength</span>(<span class="hljs-string">"hello"</span>);      <span class="hljs-comment">// ✅ string有length属性</span>
<span class="hljs-title function_">logLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);    <span class="hljs-comment">// ✅ 数组有length属性</span>
<span class="hljs-title function_">logLength</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5</span> }); <span class="hljs-comment">// ✅ 对象有length属性</span>
<span class="hljs-comment">// logLength(42);        // ❌ number没有length属性</span>
</code></pre>
<h3 data-id="heading-15">泛型声明的位置与时机</h3>
<h4 data-id="heading-16">在函数中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 单个泛型参数</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 多个泛型参数</span>
<span class="hljs-keyword">function</span> pair&lt;T, U&gt;(<span class="hljs-attr">first</span>: T, <span class="hljs-attr">second</span>: U): [T, U] {
    <span class="hljs-keyword">return</span> [first, second];
}

<span class="hljs-comment">// 带约束的泛型</span>
<span class="hljs-keyword">function</span> getProperty&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: K): T[K] {
    <span class="hljs-keyword">return</span> obj[key];
}

<span class="hljs-comment">// 默认类型参数（TypeScript 2.3+）</span>
<span class="hljs-keyword">function</span> createArray&lt;T = <span class="hljs-built_in">string</span>&gt;(<span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">value</span>: T): T[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>(length).<span class="hljs-title function_">fill</span>(value);
}
</code></pre>
<h4 data-id="heading-17">在接口中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Container</span>&lt;T&gt; {
    <span class="hljs-attr">value</span>: T;
    <span class="hljs-title function_">getValue</span>(): T;
    <span class="hljs-title function_">setValue</span>(<span class="hljs-attr">value</span>: T): <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 实现泛型接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberContainer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Container</span>&lt;<span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-title function_">getValue</span>(): <span class="hljs-built_in">number</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    }
    
    <span class="hljs-title function_">setValue</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
    }
}

<span class="hljs-comment">// 泛型接口作为函数参数</span>
<span class="hljs-keyword">function</span> processContainer&lt;T&gt;(<span class="hljs-attr">container</span>: <span class="hljs-title class_">Container</span>&lt;T&gt;): T {
    <span class="hljs-keyword">return</span> container.<span class="hljs-title function_">getValue</span>();
}
</code></pre>
<h4 data-id="heading-18">在类型别名中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型类型别名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Nullable</span>&lt;T&gt; = T | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyRecord</span>&lt;K <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, V&gt; = { <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> K]: V };
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Callback</span>&lt;T&gt; = <span class="hljs-function">(<span class="hljs-params">value: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 使用泛型类型别名</span>
<span class="hljs-keyword">function</span> processValue&lt;T&gt;(<span class="hljs-attr">value</span>: T, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;T&gt;): <span class="hljs-built_in">void</span> {
    <span class="hljs-title function_">callback</span>(value);
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">names</span>: <span class="hljs-title class_">Nullable</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-string">"Alice"</span> || <span class="hljs-literal">null</span>;
</code></pre>
<h4 data-id="heading-19">在类中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Repository</span>&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> }&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">items</span>: T[] = [];
    
    <span class="hljs-title function_">add</span>(<span class="hljs-attr">item</span>: T): <span class="hljs-built_in">void</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>(item);
    }
    
    <span class="hljs-title function_">findById</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>): T | <span class="hljs-literal">undefined</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === id);
    }
    
    <span class="hljs-title function_">getAll</span>(): T[] {
        <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>];
    }
}

<span class="hljs-comment">// 使用泛型类</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">const</span> userRepo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Repository</span>&lt;<span class="hljs-title class_">User</span>&gt;();
userRepo.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"alice@example.com"</span> });
<span class="hljs-keyword">const</span> user = userRepo.<span class="hljs-title function_">findById</span>(<span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-20">泛型类型推导</h3>
<p>TypeScript 具有强大的类型推导能力，大多数情况下我们不需要显式指定泛型类型。</p>
<h4 data-id="heading-21">自动类型推导</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TypeScript会自动推导泛型类型</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 编译器推断T为string</span>
<span class="hljs-keyword">const</span> result1 = <span class="hljs-title function_">identity</span>(<span class="hljs-string">"hello"</span>);

<span class="hljs-comment">// 编译器推断T为number</span>
<span class="hljs-keyword">const</span> result2 = <span class="hljs-title function_">identity</span>(<span class="hljs-number">42</span>);

<span class="hljs-comment">// 编译器推断T为boolean</span>
<span class="hljs-keyword">const</span> result3 = <span class="hljs-title function_">identity</span>(<span class="hljs-literal">true</span>);

<span class="hljs-comment">// 编译器推断T为number[]</span>
<span class="hljs-keyword">const</span> result4 = <span class="hljs-title function_">identity</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
</code></pre>
<h4 data-id="heading-22">部分类型推导</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 多个泛型参数时，可以部分推导</span>
<span class="hljs-keyword">function</span> mapArray&lt;T, U&gt;(
    <span class="hljs-attr">array</span>: T[],
    <span class="hljs-attr">mapper</span>: <span class="hljs-function">(<span class="hljs-params">item: T</span>) =&gt;</span> U
): U[] {
    <span class="hljs-keyword">return</span> array.<span class="hljs-title function_">map</span>(mapper);
}

<span class="hljs-comment">// 自动推导T为number，U为string</span>
<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> strings = <span class="hljs-title function_">mapArray</span>(numbers, <span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n.<span class="hljs-title function_">toString</span>());
<span class="hljs-comment">// strings类型为string[]</span>
</code></pre>
<h4 data-id="heading-23">推导失败的情况</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 情况1：空数组无法推导元素类型</span>
<span class="hljs-keyword">function</span> firstElement&lt;T&gt;(<span class="hljs-attr">arr</span>: T[]): T | <span class="hljs-literal">undefined</span> {
    <span class="hljs-keyword">return</span> arr[<span class="hljs-number">0</span>];
}

<span class="hljs-keyword">const</span> empty = <span class="hljs-title function_">firstElement</span>([]); <span class="hljs-comment">// T被推导为unknown</span>
<span class="hljs-comment">// 解决方法：显式指定类型</span>
<span class="hljs-keyword">const</span> empty2 = firstElement&lt;<span class="hljs-built_in">number</span>&gt;([]); <span class="hljs-comment">// T为number</span>

<span class="hljs-comment">// 情况2：泛型约束太宽</span>
<span class="hljs-keyword">function</span> process&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">process</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// T被推导为"hello"而不是string</span>
<span class="hljs-comment">// 解决方法：使用类型断言</span>
<span class="hljs-keyword">const</span> result2 = process&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// T为string</span>
</code></pre>
<h3 data-id="heading-24">泛型约束</h3>
<h4 data-id="heading-25">基础约束</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 约束T必须是某种类型</span>
<span class="hljs-keyword">function</span> logLength&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-attr">item</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item.<span class="hljs-property">length</span>);
}

<span class="hljs-title function_">logLength</span>(<span class="hljs-string">"hello"</span>);      <span class="hljs-comment">// ✅</span>
<span class="hljs-title function_">logLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);    <span class="hljs-comment">// ✅</span>
<span class="hljs-title function_">logLength</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5</span> }); <span class="hljs-comment">// ✅</span>
<span class="hljs-comment">// logLength(42);        // ❌</span>

<span class="hljs-comment">// 约束多个类型参数之间的关系</span>
<span class="hljs-keyword">function</span> getProperty&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: K): T[K] {
    <span class="hljs-keyword">return</span> obj[key];
}

<span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
<span class="hljs-title function_">getProperty</span>(user, <span class="hljs-string">"name"</span>); <span class="hljs-comment">// ✅</span>
<span class="hljs-comment">// getProperty(user, "email"); // ❌</span>
</code></pre>
<h4 data-id="heading-26">使用类型参数约束</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 一个类型参数约束另一个</span>
<span class="hljs-keyword">function</span> assign&lt;T <span class="hljs-keyword">extends</span> U, U&gt;(<span class="hljs-attr">target</span>: T, <span class="hljs-attr">source</span>: U): T {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(target, source);
}

<span class="hljs-keyword">const</span> target = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> source = { <span class="hljs-attr">b</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">4</span> };
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">assign</span>(target, source); <span class="hljs-comment">// { a: 1, b: 3, c: 4 }</span>

<span class="hljs-comment">// 约束类型参数为构造器</span>
<span class="hljs-keyword">function</span> createInstance&lt;T&gt;(
    <span class="hljs-title class_">Constructor</span>: <span class="hljs-keyword">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T,
    ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]
): T {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Constructor</span>(...args);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> name: <span class="hljs-built_in">string</span></span>) {}
}

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">createInstance</span>(<span class="hljs-title class_">User</span>, <span class="hljs-string">"Alice"</span>); <span class="hljs-comment">// User实例</span>
</code></pre>
<h2 data-id="heading-27">结语</h2>
<p>本文详细介绍了TypeScript中的函数使用指南，包括函数声明与调用、函数重载、多态函数与泛型的概念，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 项目中使用 @antfu/eslint-config 完整指南]]></title>    <link>https://juejin.cn/post/7597056049690574886</link>    <guid>https://juejin.cn/post/7597056049690574886</guid>    <pubDate>2026-01-20T05:46:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597056049690574886" data-draft-id="7597056049690525734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 项目中使用 @antfu/eslint-config 完整指南"/> <meta itemprop="keywords" content="Vue.js,ESLint"/> <meta itemprop="datePublished" content="2026-01-20T05:46:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="实习生小黄"/> <meta itemprop="url" content="https://juejin.cn/user/3246201392868637"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 项目中使用 @antfu/eslint-config 完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3246201392868637/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    实习生小黄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:46:18.000Z" title="Tue Jan 20 2026 05:46:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在现代前端开发中，代码质量和一致性是项目成功的关键因素。ESLint 作为 JavaScript/TypeScript 代码检查工具，能够帮助开发者发现潜在问题、统一代码风格。<code>@antfu/eslint-config</code> 是由 Anthony Fu 维护的一套开箱即用的 ESLint 配置，特别针对 Vue 3、TypeScript 和现代 JavaScript 项目进行了优化。</p>
<p>本文档基于实际项目经验，详细介绍了如何在 Vue3 + TypeScript + Vite 项目中正确配置和使用 <code>@antfu/eslint-config</code>，并记录了常见问题的解决方案。</p>
<h2 data-id="heading-1">目的</h2>
<p>本文档旨在帮助开发者：</p>
<ul>
<li>快速在 Vue3 项目中集成 <code>@antfu/eslint-config</code></li>
<li>理解配置选项的含义和作用</li>
<li>解决常见的解析错误和配置问题</li>
<li>掌握最佳实践和注意事项</li>
</ul>
<h2 data-id="heading-2">配置</h2>
<h3 data-id="heading-3">1. 安装依赖</h3>
<p>首先，确保你的项目已经安装了必要的依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @antfu/eslint-config eslint
</code></pre>
<p>或者使用 npm/yarn：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -D @antfu/eslint-config eslint
<span class="hljs-comment"># 或</span>
yarn add -D @antfu/eslint-config eslint
</code></pre>
<h3 data-id="heading-4">2. 创建配置文件</h3>
<p>在项目根目录创建 <code>eslint.config.mjs</code> 文件（注意：必须使用 <code>.mjs</code> 扩展名，因为 ESLint 9.x 使用扁平配置格式，且需要 ES 模块语法）。</p>
<p><strong>重要提示</strong>：即使 <code>package.json</code> 中设置了 <code>"type": "module"</code>，ESLint 仍需要明确的 <code>.mjs</code> 扩展名来正确解析 ES 模块语法。</p>
<h3 data-id="heading-5">3. 基础配置示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,        <span class="hljs-comment">// 启用 Vue 3 支持</span>
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用 TypeScript 支持（重要！）</span>
  
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-comment">// 自定义规则配置</span>
    xxx
  },
})
</code></pre>
<h3 data-id="heading-6">4. 配置选项说明</h3>
<h4 data-id="heading-7">核心选项</h4>
<ul>
<li><strong><code>vue: true</code></strong>：启用 Vue 3 文件支持，自动配置 Vue 相关的 ESLint 规则</li>
<li><strong><code>typescript: true</code></strong>：启用 TypeScript 支持，这是处理 TypeScript 语法的关键配置</li>
</ul>
<h3 data-id="heading-8">5. package.json 脚本配置</h3>
<p>在 <code>package.json</code> 中添加 lint 脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --fix"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-9">遇到的问题</h2>
<h3 data-id="heading-10">问题 1：配置文件解析错误</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-go" lang="go">Parsing <span class="hljs-type">error</span>: Unexpected token
</code></pre>
<p><strong>问题描述</strong>：</p>
<ul>
<li>使用 <code>.js</code> 扩展名创建配置文件时，ESLint 无法正确解析 ES 模块语法（<code>import/export</code>）</li>
<li>即使 <code>package.json</code> 中设置了 <code>"type": "module"</code>，某些工具仍需要明确的 <code>.mjs</code> 扩展名</li>
</ul>
<p><strong>解决方案</strong>：
将配置文件重命名为 <code>eslint.config.mjs</code>，确保使用 <code>.mjs</code> 扩展名。</p>
<h3 data-id="heading-11">问题 2：TypeScript 嵌套泛型解析错误</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-go" lang="go">Parsing <span class="hljs-type">error</span>: Unexpected token &gt;&gt;
</code></pre>
<p><strong>问题代码示例</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> allUsersMap = ref&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-title class_">UserInfo</span>&gt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
</code></pre>
<p><strong>问题描述</strong>：</p>
<ul>
<li>当配置中只启用了 <code>vue: true</code> 而没有启用 <code>typescript: true</code> 时</li>
<li>ESLint 无法正确解析嵌套泛型语法（如 <code>ref&lt;Map&lt;number, UserInfo&gt;&gt;</code>）</li>
<li><code>&gt;&gt;</code> 被误解析为 JavaScript 的右移运算符，而不是泛型闭合符号</li>
</ul>
<p><strong>根本原因</strong>：</p>
<ul>
<li>没有显式启用 TypeScript 支持时，TypeScript 解析器可能无法正确处理复杂的泛型语法</li>
<li>这与 GitHub Issue #578 中描述的问题类似：当文件被添加到 <code>ignoresTypeAware</code> 时，会回退到普通 JavaScript 解析器，无法理解 TypeScript 语法</li>
</ul>
<h2 data-id="heading-12">解决方案</h2>
<h3 data-id="heading-13">解决方案 1：配置文件扩展名问题</h3>
<p><strong>步骤</strong>：</p>
<ol>
<li>删除 <code>eslint.config.js</code>（如果存在）</li>
<li>创建 <code>eslint.config.mjs</code> 文件</li>
<li>使用 ES 模块语法编写配置</li>
</ol>
<p><strong>完整示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
})
</code></pre>
<h3 data-id="heading-14">解决方案 2：TypeScript 解析错误</h3>
<p><strong>关键步骤</strong>：在配置中显式启用 TypeScript 支持</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// ⚠️ 必须显式启用！</span>
  
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-comment">// 自定义规则</span>
  },
})
</code></pre>
<p><strong>为什么需要显式启用？</strong></p>
<ol>
<li><strong>默认行为不确定</strong>：虽然 <code>@antfu/eslint-config</code> 可能在某些情况下自动检测 TypeScript，但在处理复杂语法（如嵌套泛型）时可能失效</li>
<li><strong>Vue 文件特殊性</strong>：Vue 单文件组件（<code>.vue</code>）中的 <code>&lt;script setup&gt;</code> 使用 TypeScript 时，需要明确的配置来启用 TypeScript 解析器</li>
<li><strong>避免解析器回退</strong>：显式配置确保文件不会被错误地使用 JavaScript 解析器处理</li>
</ol>
<h3 data-id="heading-15">解决方案 3：完整的推荐配置</h3>
<p>基于实际项目经验，推荐以下配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-comment">// 核心功能</span>
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
  
  <span class="hljs-comment">// 自定义规则</span>
  <span class="hljs-attr">rules</span>: {
  },
})
</code></pre>
<h2 data-id="heading-16">总结</h2>
<h3 data-id="heading-17">关键要点</h3>
<ol>
<li>
<p><strong>文件扩展名很重要</strong>：必须使用 <code>eslint.config.mjs</code> 而不是 <code>.js</code>，确保 ESLint 能正确解析 ES 模块语法</p>
</li>
<li>
<p><strong>显式启用 TypeScript</strong>：即使项目使用 TypeScript，也要在配置中显式设置 <code>typescript: true</code>，特别是处理复杂泛型语法时</p>
</li>
<li>
<p><strong>理解解析器机制</strong>：当 TypeScript 解析器未正确启用时，文件可能回退到 JavaScript 解析器，导致无法理解 TypeScript 语法</p>
</li>
<li>
<p><strong>遵循最佳实践</strong>：</p>
<ul>
<li>始终同时启用 <code>vue: true</code> 和 <code>typescript: true</code></li>
<li>根据项目需求自定义规则</li>
<li>定期更新 <code>@antfu/eslint-config</code> 到最新版本</li>
</ul>
</li>
</ol>
<h3 data-id="heading-18">常见错误对照表</h3>

























<table><thead><tr><th>错误信息</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>Parsing error: Unexpected token</code></td><td>配置文件扩展名错误</td><td>使用 <code>.mjs</code> 扩展名</td></tr><tr><td><code>Parsing error: Unexpected token &gt;&gt;</code></td><td>未启用 TypeScript 支持</td><td>添加 <code>typescript: true</code></td></tr><tr><td><code>Parsing error: Unexpected token :</code></td><td>文件被添加到 <code>ignoresTypeAware</code></td><td>移除相关配置或显式添加到 <code>filesTypeAware</code></td></tr></tbody></table>
<h3 data-id="heading-19">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Feslint-config" target="_blank" title="https://github.com/antfu/eslint-config" ref="nofollow noopener noreferrer">@antfu/eslint-config</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fdocs%2Flatest%2Fuse%2Fconfigure%2Fconfiguration-files-new" target="_blank" title="https://eslint.org/docs/latest/use/configure/configuration-files-new" ref="nofollow noopener noreferrer">ESLint 扁平配置文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Feslint-config%2Fissues%2F578" target="_blank" title="https://github.com/antfu/eslint-config/issues/578" ref="nofollow noopener noreferrer">GitHub Issue #578</a> - TypeScript 解析相关问题</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解Spring AI Alibaba的Memory机制]]></title>    <link>https://juejin.cn/post/7596990822127566886</link>    <guid>https://juejin.cn/post/7596990822127566886</guid>    <pubDate>2026-01-20T05:47:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596990822127566886" data-draft-id="7596990822127026214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解Spring AI Alibaba的Memory机制"/> <meta itemprop="keywords" content="后端,人工智能,架构"/> <meta itemprop="datePublished" content="2026-01-20T05:47:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解Spring AI Alibaba的Memory机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:47:57.000Z" title="Tue Jan 20 2026 05:47:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>我相信大家在平时一定使用过网页对话chatbot，国产的有deepseek、Qwen等，国外的有ChatGPT、Gemini、Grok等。在我们使用的期间，我们会发现这些chatbot会记住我们这次对话的上下文，甚至之前的对话的某些信息，如果你们对为什么LLM能记住我们的信息感兴趣，那么接着往下看吧！</p>
<h2 data-id="heading-1">错误纠正</h2>
<p>很多人不了解大模型或者不了解大模型应用开发的，就常常认为大模型底层就是会有记忆机制的，即内置Memory。这种想法是错误的，大模型底层并没有记忆机制，而是stateless(无状态)。</p>
<p>1.基础大模型（如 Qwen）的行为(LLM)</p>
<ul>
<li>默认情况下，大语言模型（包括 Qwen 系列）是<strong>无状态的</strong>：每次请求都是独立的，模型不会自动记住你之前的对话内容。</li>
<li>如果你在一次对话中发送多轮消息（例如通过 API 的 <code>messages</code> 字段传入历史），那是由<strong>调用方</strong>（即你的应用）负责维护对话历史，而不是模型自己存储。</li>
</ul>
<p>2.Memory 机制是应用层的功能</p>
<ul>
<li>“Memory”通常是指在构建智能体（Agent）或对话系统时，为了实现上下文记忆、长期记忆、用户偏好记录等功能而<strong>额外引入的模块</strong>。</li>
<li>例如，在 LangChain、LlamaIndex 或阿里云百炼平台中，开发者可以配置短期记忆（如最近几轮对话）或长期记忆（如向量数据库存储的历史信息），并在每次生成回复前将相关记忆注入 prompt。</li>
<li>这种 Memory 管理是由<strong>应用框架或开发者代码</strong>实现的，不是模型原生能力。</li>
</ul>
<h2 data-id="heading-2">Memory</h2>
<p>那么像chatbot这些大模型应用，是如何维持记忆呢？那么维护记忆万一超过了模型能承受的上下文，怎么办？</p>
<p>要了解这些问题，我们首先得搞懂，<strong>什么是Memory</strong>。</p>
<p>Memory分为短期记忆和长期记忆，接下来我们分别说说，尽量简单易懂。</p>
<h3 data-id="heading-3">短期Memory</h3>
<p>短期记忆（Short-term Memory）</p>
<ul>
<li>
<p><strong>定义</strong>：指在<strong>单次对话会话（session）中</strong>保留的上下文信息。</p>
</li>
<li>
<p><strong>典型实现</strong>：将用户与系统单次会话中的最近几轮的对话历史（prompt + response）作为上下文，一起输入给大模型。</p>
</li>
<li>
<p>特点：</p>
<ul>
<li>仅在当前会话有效；</li>
<li>会话结束后通常被丢弃（除非主动保存）；</li>
<li>受限于模型的上下文长度（如 Qwen-Max 支持 32768 tokens）；</li>
<li>是实现多轮对话连贯性的基础。</li>
</ul>
</li>
<li>
<p>例子：</p>
<blockquote>
<p>用户：我叫小明。 助手：你好，小明！ 用户：我今年多大？ → 助手能回答，是因为“我叫小明”这句还在短期记忆（即对话历史）中</p>
</blockquote>
</li>
</ul>
<p>短期记忆一般大模型应用都会自动开启的，但是每个应用对短期记忆的策略都会不一样，所以体验上也不一样。</p>
<h3 data-id="heading-4">长期Memory</h3>
<p>长期记忆（Long-term Memory）</p>
<ul>
<li>
<p><strong>定义</strong>：跨越<strong>多个会话</strong>、持久化存储的用户信息或交互历史。</p>
</li>
<li>
<p>典型实现：</p>
<ul>
<li>将关键信息（如用户偏好、身份、历史任务）提取后存入数据库或向量库；</li>
<li>下次对话时通过检索（Retrieval）机制召回相关内容，并注入到 prompt 中。</li>
</ul>
</li>
<li>
<p>特点：</p>
<ul>
<li>需要显式设计（如使用向量数据库 + embedding 检索）；</li>
<li>不是所有系统都默认开启；</li>
<li>涉及隐私和数据安全，通常需用户授权；</li>
<li>属于高级功能，常见于智能体（Agent）或个性化助手。</li>
</ul>
</li>
<li>
<p>例子：</p>
<blockquote>
<p>上周用户说：“我喜欢喝美式咖啡。” 一周后再次对话，系统说：“今天还想来一杯美式吗？” → 这说明系统通过长期记忆记住了偏好。</p>
</blockquote>
</li>
</ul>
<p>以Gemini为例子，你可以在这里添加想让Gemini记住你的相关信息，或者在某次对话中直接prompt让其记住也是可以的。这样就是长期Memory，每次Gemini都会在某些情景下触发相关的长期记忆，策略不同，输出也会不同</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb3439edfb8d46f1a93120640aff551c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492876&amp;x-signature=2IM1STkkuLy7QVhx6EVKAuLUWiM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">SAA的Memory机制</h2>
<p>ok，现在回归正题，来讲讲SAA的Memory机制，如果还有想有更深的了解的兄弟可以先去看看这两篇文章，再回来应该能更好的理解</p>
<p>1.Spring AI vs Spring AI Alibaba</p>
<p><a href="https://juejin.cn/post/7596181746062508059" target="_blank" title="https://juejin.cn/post/7596181746062508059">juejin.cn/post/759618…</a></p>
<p>2.逃出结构化思维：从向量，向量数据库到RAG</p>
<p><a href="https://juejin.cn/post/7587074669818134554" target="_blank" title="https://juejin.cn/post/7587074669818134554">juejin.cn/post/758707…</a></p>
<p>SAA本质上是一个AI应用开发框架，可以开发agent，multi-agent和工作流等等，那么必然需要使用底层LLM，然而我们前面已经说过了LLM实际上是无状态的，那么LLM应用的相关记忆必定是由我们上层应用来开发和管理的。</p>
<p>即如果你使用的是 <strong>Qwen 的 API（如 dashscope）</strong> ，你需要自己维护对话历史并作为输入传入。</p>
<h3 data-id="heading-6">SAA的Memory机制的架构</h3>
<p>下面是SAA实现两种Memory的架构图,其中左下角的箭头(指向ModelHook)应该放置到中间的，画错了就将就看吧</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18a0e499cf7e49fea80e248203b7e7f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492876&amp;x-signature=8R8dwVnosD%2BXP9YQwGV3Pq6f%2FQE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">维护短期记忆</h3>
<h4 data-id="heading-8">如何添加短期记忆</h4>
<p>在 Spring AI Alibaba 中，要向 Agent 添加短期记忆（会话级持久化），你需要在创建 Agent 时指定 <code>checkpointer</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.checkpoint.savers.RedisSaver;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;

<span class="hljs-comment">// 配置 Redis checkpointer</span>
<span class="hljs-type">RedisSaver</span> <span class="hljs-variable">redisSaver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisSaver</span>(redissonClient);

<span class="hljs-type">ReactAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReactAgent.builder()
    .name(<span class="hljs-string">"my_agent"</span>)
    .model(chatModel)
    .tools(getUserInfoTool)
    .saver(redisSaver)
    .build();
    
<span class="hljs-comment">// 使用 thread_id 维护对话上下文  </span>
<span class="hljs-type">RunnableConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RunnableConfig.builder()  
    .threadId(<span class="hljs-string">"1"</span>) <span class="hljs-comment">// threadId 指定会话 ID  </span>
    .build();  
  
agent.call(<span class="hljs-string">"你好！我叫 Bob。"</span>, config);
</code></pre>
<h4 data-id="heading-9">扩展短期记忆</h4>
<p>我们还可以修改和管理记忆。
默认情况下，Agent 使用状态通过 <code>messages</code> 键管理短期记忆，特别是对话历史。</p>
<p>你可以通过在工具或 Hook 中访问和修改状态来扩展记忆功能</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.ModelHook;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.HookPosition;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.OverAllState;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.RunnableConfig;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.Message;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">// 在 Hook 中访问和修改状态</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMemoryHook</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModelHook</span> {

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"custom_memory"</span>;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> HookPosition[] getHookPositions() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HookPosition</span>[]{HookPosition.BEFORE_MODEL};
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">beforeModel</span><span class="hljs-params">(OverAllState state, RunnableConfig config)</span> {
    <span class="hljs-comment">// 访问消息历史</span>
    Optional&lt;Object&gt; messagesOpt = state.value(<span class="hljs-string">"messages"</span>);
    <span class="hljs-keyword">if</span> (messagesOpt.isPresent()) {
        List&lt;Message&gt; messages = (List&lt;Message&gt;) messagesOpt.get();
    <span class="hljs-comment">// 处理消息...</span>
}

    <span class="hljs-comment">// 添加自定义状态</span>
    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Map.of(
        <span class="hljs-string">"user_id"</span>, <span class="hljs-string">"user_123"</span>,
        <span class="hljs-string">"preferences"</span>, Map.of(<span class="hljs-string">"theme"</span>, <span class="hljs-string">"dark"</span>)
    ));
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">afterModel</span><span class="hljs-params">(OverAllState state, RunnableConfig config)</span> {
    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Map.of());
    }
}
</code></pre>
<h4 data-id="heading-10">管理短期记忆</h4>
<p>一个会话中，如果用户一直对话，整个会话的上下文就会越来越长，最后就会超过该大模型所能承受的上下文限制。</p>
<p>保留所有对话历史是实现短期记忆最常见的形式。但较长的对话对历史可能会导致大模型 LLM 上下文窗口超限，导致上下文丢失或报错。</p>
<p>即使你在使用的大模型上下文长度足够大，大多数模型在处理较长上下文时的表现仍然很差。因为很多模型会被过时或偏离主题的内容"分散注意力"。同时，过长的上下文，还会带来响应时间变长、Token 成本增加等问题。</p>
<p>在 Spring AI ALibaba 中，ReactAgent 使用 messages 记录和传递上下文，其中包括指令（SystemMessage）和输入（UserMessage）。在 ReactAgent 中，消息（Message）在用户输入和模型响应之间交替，导致消息列表随着时间的推移变得越来越长。由于上下文窗口有限，许多应用程序可以从使用技术来移除或"忘记"过时信息中受益，即 “上下文工程”。</p>
<p>作为后端，我们通常采取以下几种策略来模拟“记忆”：</p>
<ul>
<li><strong>Sliding Window（滑动窗口）：</strong> 只保留最近的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 轮对话，丢弃最早的记录。</li>
<li><strong>Summary Memory（摘要记忆）：</strong> 当对话过长时，调用大模型对之前的对话做一个简短总结，后续只带上这个 <code>Summary</code>。</li>
<li><strong>Vector Database（向量数据库/RAG）：</strong> 将历史对话存入向量库（如 Milvus, Pinecone）。当用户提问时，通过语义搜索检索出最相关的历史片段（Top-K），塞进 Context 传给模型。</li>
</ul>
<h3 data-id="heading-11">维护长期记忆</h3>
<h4 data-id="heading-12">长期记忆的检索过程</h4>
<p>对于后端开发人员来说，长期记忆的检索过程其实就是一个标准的 <strong>“语义检索 + RAG (Retrieval-Augmented Generation)”</strong> 工作流。</p>
<p>你可以把它类比为：<strong>全文搜索（Elasticsearch）的升级版</strong>。不同于关键词匹配，<strong>它是基于“意思”来匹配</strong>。</p>
<hr/>
<p>整个过程可以分为 <strong>“存入”</strong> 和 <strong>“检索”</strong> 两个阶段：</p>
<h5 data-id="heading-13">1. 存入阶段（写入/索引）</h5>
<p>当一段对话结束或产生新的知识时：</p>
<ol>
<li><strong>切片 (Chunking)</strong> ：将长文本切分成合适的大小（例如 512 tokens）。</li>
<li><strong>向量化 (Embedding)</strong> ：调用 Embedding 模型（如 OpenAI 的 <code>text-embedding-3-small</code>）将文本转为高维向量（如 1536 维的浮点数数组）。</li>
<li><strong>入库</strong>：将向量和原始文本、Metadata（如 <code>user_id</code>, <code>timestamp</code>）存入向量数据库（Redis Vector Search, Milvus, 或 Pinecone）。</li>
</ol>
<h5 data-id="heading-14">2. 检索阶段（读取/召回）</h5>
<p>当用户提出一个新问题，系统需要“回想起”以前的事情：</p>
<ul>
<li>
<p>Step A: 问题向量化</p>
<p>将用户的提问（Query）同样通过 Embedding 模型转为一个向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{query}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ery</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
</li>
<li>
<p>Step B: 向量空间搜索 (ANN Search)</p>
<p>在数据库中寻找与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{query}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ery</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 距离最近（相似度最高）的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 个向量。通常使用余弦相似度 (Cosine Similarity) 计算：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>similarity</mtext><mo>=</mo><mfrac><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{similarity} = \frac{A \cdot B}{\|A\| \|B\|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">similarity</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3923em;vertical-align:-0.52em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∥</span><span class="mord mathnormal mtight">A</span><span class="mord mtight">∥∥</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mtight">∥</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
</li>
<li>
<p>Step C: 召回与过滤</p>
<p>数据库返回最匹配的原始文本片段。作为后端，你通常会在这里根据 user_id 做 Metadata Filter，确保 A 用户的提问不会检索到 B 用户的记忆。</p>
</li>
<li>
<p>Step D: 上下文注入 (Context Injection)</p>
<p>将检索出来的“记忆片段”拼接到当前的 Prompt 中。</p>
</li>
</ul>
<h4 data-id="heading-15">SAA的长期记忆存储</h4>
<p>Spring AI Alibaba 将长期记忆以 JSON 文档的形式存储在 Store 中。</p>
<p>每个记忆都在自定义的 <code>namespace</code>（类似于文件夹）下组织，并使用唯一的 <code>key</code>（类似于文件名）。命名空间通常包含用户或组织 ID 或其他标签，以便更容易地组织信息。</p>
<p>这种结构支持记忆的层次化组织。通过内容过滤器支持跨命名空间搜索。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.store.stores.MemoryStore;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.store.StoreItem;

<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-comment">// MemoryStore 将数据保存到内存字典中。在生产环境中请使用基于数据库的存储实现</span>
<span class="hljs-type">MemoryStore</span> <span class="hljs-variable">store</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryStore</span>();

<span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"my-user"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-string">"chitchat"</span>;
List&lt;String&gt; namespace = List.of(userId, applicationContext);

<span class="hljs-comment">// 保存记忆</span>
Map&lt;String, Object&gt; memoryData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
memoryData.put(<span class="hljs-string">"rules"</span>, List.of(
    <span class="hljs-string">"用户喜欢简短直接的语言"</span>,
    <span class="hljs-string">"用户只说中文和Java"</span>
));
memoryData.put(<span class="hljs-string">"my-key"</span>, <span class="hljs-string">"my-value"</span>);

<span class="hljs-type">StoreItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> StoreItem.of(namespace, <span class="hljs-string">"a-memory"</span>, memoryData);
store.putItem(item);

<span class="hljs-comment">// 通过ID获取记忆</span>
Optional&lt;StoreItem&gt; retrievedItem = store.getItem(namespace, <span class="hljs-string">"a-memory"</span>);

<span class="hljs-comment">// 在此命名空间内搜索记忆，通过内容等价性过滤，按向量相似度排序</span>
List&lt;StoreItem&gt; items = store.searchItems(
    namespace,
    Map.of(<span class="hljs-string">"my-key"</span>, <span class="hljs-string">"my-value"</span>)
);
</code></pre>
<h4 data-id="heading-16">SAA的长期记忆管理</h4>
<p>SAA还可以进行对长期记忆的管理，我们可以使用 ModelHook 在模型调用前后自动加载和保存长期记忆。</p>
<p>同时，我们也可以在tool里面进行读取和写入长期记忆。</p>
<p>长期记忆的写入和召回等核心流程就如上面说到的一样，这里由于篇幅就不详细赘述。</p>
<h2 data-id="heading-17">总结</h2>
<p>本文讨论了Memory的概念，两种不同记忆机制的区别以及SAA如何处理不同记忆。</p>
<p>但是大模型应用开发Memory是门学问，也不可能一文能讲清楚所有场景该怎么做，比如短期记忆和长期记忆混合该怎么使用，那就等着读者去探索了。</p>
<p>如果你感觉这篇入门文章给你带来了不错的体感，那就给我点赞+收藏+关注吧❤️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS人机交互新范式：当ToB系统开始“思考”，我们该设计什么样的界面？]]></title>    <link>https://juejin.cn/post/7597083743555960875</link>    <guid>https://juejin.cn/post/7597083743555960875</guid>    <pubDate>2026-01-20T05:39:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083743555960875" data-draft-id="7597083949833207814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS人机交互新范式：当ToB系统开始“思考”，我们该设计什么样的界面？"/> <meta itemprop="keywords" content="HarmonyOS,Agent"/> <meta itemprop="datePublished" content="2026-01-20T05:39:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木斯佳"/> <meta itemprop="url" content="https://juejin.cn/user/783265144769623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS人机交互新范式：当ToB系统开始“思考”，我们该设计什么样的界面？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/783265144769623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木斯佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:39:26.000Z" title="Tue Jan 20 2026 05:39:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>软件不再是你找功能，而是功能主动理解你。这不是AI的革命，这是交互设计本应有的样子。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60672891fa094018a6d3c91a5708b74d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=wRCbrnPV9qvX8HBcNUSGpZApQcw%3D" alt="image.png" loading="lazy"/></p>
<p>上周在医院门诊大厅，我看到一个特别的“白大褂”——医疗数字人“灵童”。它眨着大眼睛，耐心地为患者家属解答各种问题。家属只需自然地说出需求，灵童就能理解意图，快速给出科室指引、专家排班信息，甚至能调出相关的健康知识卡片。</p>
<p>这不是科幻电影，这是青岛市妇女儿童医院真实的智慧服务场景，由泽瑞集团提供全链路私有化部署的医疗数字人解决方案。</p>
<p>看着家属们自然地与灵童对话，我突然意识到：这才应该是企业软件的交互方式——不是用户去适应复杂的菜单结构，而是系统主动理解用户意图，提供恰到好处的服务。</p>
<h2 data-id="heading-0">不是AI要改变什么，而是我们本就该这样工作</h2>
<p>最近团队在落地几个Agent项目，和产品、设计、后端一起开会时，大家问得最多的问题是：“Agent到底能做什么不一样的事情？”</p>
<p>我的回答是：它不做“不一样”的事情，而是让事情“以对的方式”发生。
让我用医疗场景举个例子。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4a7064a68e84837af8311218f62a758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=pgdBA2rDkxKytQXzjuGmSVD61Is%3D" alt="在这里插入图片描述" loading="lazy"/>
<strong>传统的医院系统逻辑</strong>：家属要知道“去哪里”——导诊台；要记住“怎么问”——科室名称要准确；要明白“流程”——先登记还是先挂号。</p>
<p><strong>数字人的逻辑</strong>：家属只需要说“孩子咳嗽三天了，应该看哪个科”。
系统自己会判断：这需要分析症状关键词→匹配对应专科→查看专家排班→提供就诊建议。整个过程在自然对话中完成，用户不需要记住复杂的科室分类，不需要提前学习系统用法，只需要说出需求。</p>
<p>这不就是我们一直想要的“智能化”吗？</p>
<h2 data-id="heading-1">界面不是消失了，而是变得更“聪明”</h2>
<p>有人担心：Agent会不会让精心设计的页面变得无用？
恰恰相反。好的Agent不是替代界面，而是让界面“活”起来。
第一版的智能柜成功上线让我们备受鼓舞，我们快速迭代了小程序侧进行了上线。在方案预研中，我发现<strong>鸿蒙生态</strong>天然的适配<strong>RICH 设计范式</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b2d167806ab47fd8a3870f9a72fc133~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=bQ3YrbzaMjo9rVBAoWCaqvxIIss%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>鸿蒙的<strong>多窗口交互</strong>，折叠屏展开态、平板等大屏幕设备，具有多任务并行和效率型任务处理的先天优势。
系统提供了悬浮窗、分屏、画中画三种多窗口交互，为用户在大屏幕设备上的多任务并行、便捷的临时任务处理提供更佳的使用体验。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27e8bd9dcf3f45c486dcae11ae7c91d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=qU3LNx%2FntGK0SmzRig26jbXu%2Bd4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>想象一下这种体验：</p>
<ol>
<li>家属询问：“半夜小孩发烧到39.5度，需要马上看急诊吗？”</li>
<li>系统理解：这是急症咨询场景，需要调用发热处理流程、急诊等待时间、医生建议</li>
<li>界面响应：左侧显示发热处理指引卡片，中间展示当前急诊等候人数，右侧提供线上咨询快速入口</li>
<li>家属可以：查看详细指引，预约急诊时段。</li>
</ol>
<p>界面元素依然存在，但它们的<strong>出现时机、组合方式、信息呈现</strong>都根据用户的<strong>紧急程度</strong>和<strong>具体需求</strong>动态决定。</p>
<p>这就是“混合渲染”——不是全盘推倒重来，而是让静态的页面框架，搭载动态的医疗<strong>服务卡片</strong>和<strong>交互</strong>组件。</p>
<h2 data-id="heading-2">鸿蒙开发者的新角色：从“页面建造者”到“交互架构师”</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e43e56e36c24eb98a117d86221b190f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=YpqlQbgE8I0cgKCUOFL9Cxg%2F0Vc%3D" alt="图例来自蚂蚁开源项目" loading="lazy"/>
（图例来自蚂蚁开源项目）</p>
<p>这种变化对鸿蒙开发者意味着什么？
在借鉴吸收了RICH 设计范式后，昨天的我还需要纠结这个按钮的border-radius是6px还是8px，今天的我需要思考的是：<strong>这个组件如何向AI描述自己？</strong></p>
<p>在鸿蒙生态中，我们的组件开发范式正在经历深刻的变革。这种变化不仅仅是API设计的不同，更是组件从"被动渲染"到"主动服务"的思维转变。</p>
<h4 data-id="heading-3">传统鸿蒙组件开发</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// ArkTS中传统的日期选择器组件</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">DatePickerComponent</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">selectedDate</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'2024-01-01'</span>
  
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">DatePicker</span>({
      <span class="hljs-attr">start</span>: <span class="hljs-string">'2020-01-01'</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-string">'2030-12-31'</span>,
      <span class="hljs-attr">selected</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>
    })
    .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: DatePickerResult</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span> = <span class="hljs-string">`<span class="hljs-subst">${value.year}</span>-<span class="hljs-subst">${value.month}</span>-<span class="hljs-subst">${value.day}</span>`</span>
      <span class="hljs-comment">// 这里需要手动触发所有关联组件的更新</span>
      <span class="hljs-title function_">postUpdateEvent</span>(<span class="hljs-string">'dateChanged'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>)
    })
  }
}
</code></pre>
<h4 data-id="heading-4">使用RICH 设计模式开发鸿蒙组件</h4>
<ol>
<li>语义自描述</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@SmartComponent</span>({
  <span class="hljs-attr">semantic</span>: <span class="hljs-string">"用药提醒时间设置器"</span>,
  <span class="hljs-attr">medicalContext</span>: {
    <span class="hljs-attr">supports</span>: [<span class="hljs-string">'medication_schedule'</span>, <span class="hljs-string">'dosage_timing'</span>],
    <span class="hljs-attr">constraints</span>: [<span class="hljs-string">'must_align_with_meal'</span>, <span class="hljs-string">'no_overlapping_meds'</span>]
  }
})
</code></pre>
<ol start="2">
<li>自动能力发现</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 组件自动声明其能力</span>
<span class="hljs-meta">@Capability</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'medical_timeline_integration'</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">'可自动集成到患者病程时间轴'</span>,
  <span class="hljs-attr">api</span>: <span class="hljs-title class_">MedicalTimelineAPI</span>
})
</code></pre>
<ol start="3">
<li>上下文感知</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ContextAwareComponent</span> {
  <span class="hljs-meta">@Prop</span>
  <span class="hljs-meta">@MedicalContext</span>({
    <span class="hljs-attr">patientAge</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">currentDiagnosis</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">medicationList</span>: <span class="hljs-literal">true</span>
  })
  <span class="hljs-attr">medicalContext</span>: <span class="hljs-title class_">MedicalContextData</span>
  
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 根据患者年龄自动调整界面</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">medicalContext</span>.<span class="hljs-property">patientAge</span> &lt; <span class="hljs-number">12</span>) {
      <span class="hljs-comment">// 儿童友好的界面</span>
      <span class="hljs-title class_">ChildFriendlyDatePicker</span>()
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 成人标准界面</span>
      <span class="hljs-title class_">StandardDatePicker</span>()
    }
  }
}
</code></pre>
<ol start="4">
<li>工作流自动化</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@WorkflowIntegration</span>({
  <span class="hljs-attr">trigger</span>: <span class="hljs-string">'appointment_scheduled'</span>,
  <span class="hljs-attr">actions</span>: [
    <span class="hljs-string">'update_doctor_calendar'</span>,
    <span class="hljs-string">'generate_patient_reminder'</span>,
    <span class="hljs-string">'prepare_medical_records'</span>
  ]
})
</code></pre>
<p>我们的工作重心，正在从**“如何把页面画好”<strong>，转向</strong>“如何让系统理解每个组件的用途”**。</p>
<h2 data-id="heading-5">设计模式演进：新的问题需要新的解决方案（鸿蒙6新特性应用）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffc1496c604c4ace9b3ed747f5eb51a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=9J6iPShGGch9bajDDZw5oVzFSBU%3D" alt="image.png" loading="lazy"/></p>
<p>在真实的医疗Agent项目中，我们遇到了很多传统B端设计没遇到过的问题。</p>
<h4 data-id="heading-6">问题一：AI“过度自信”怎么办？</h4>
<p>家属说“肚子疼”，AI直接建议“立即手术”——显然会造成恐慌。</p>
<p>我们的方案：医疗场景的分级响应机制。</p>
<ul>
<li>高危症状（胸痛、意识丧失）立即转人工+警报</li>
<li>中危症状（高烧、持续呕吐）提供紧急处理建议+医生连接</li>
<li>低危症状（轻微咳嗽、皮疹）给予家庭护理指导</li>
</ul>
<h4 data-id="heading-7">问题二：用户描述模糊怎么办？</h4>
<p>“我不舒服”——这太宽泛了。</p>
<p>我们的方案：结构化问诊引导。</p>
<ul>
<li>第一步：症状分类（疼痛类、发热类、消化类等）</li>
<li>第二步：细节追问（“哪个部位疼？持续多久了？”）</li>
<li>第三步：提供可视化部位选择器（点击身体图标记疼痛点）</li>
</ul>
<blockquote>
<p>附加价值配合鸿蒙6跨设备感知协同：不只是数据，更是“情境”</p>
</blockquote>
<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title">fuseDeviceData</span>()</span> {
    <span class="hljs-comment">// 智能融合来自不同设备的数据</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 从手表获取：心率、血氧、体温趋势</span>
      vitalSigns: <span class="hljs-keyword">this</span>.multiDeviceHealthData.watch?.vitalSigns,
      
      <span class="hljs-comment">// 从手环获取：活动量、睡眠质量</span>
      activity: <span class="hljs-keyword">this</span>.multiDeviceHealthData.band?.dailyActivity,
      
      <span class="hljs-comment">// 从环境设备获取：室内温度、湿度</span>
      environment: <span class="hljs-keyword">this</span>.multiDeviceHealthData.thermometer?.roomCondition,
      
      <span class="hljs-comment">// 鸿蒙6特性：意图感知</span>
      <span class="hljs-comment">// 自动识别用户是在做饭时、运动后还是睡眠中不适</span>
      situationalIntent: <span class="hljs-keyword">await</span> IntentsKit.recognizeSituationalIntent()
    }
  }
</code></pre>
<h4 data-id="heading-8">问题三：医疗建议需要个性化怎么办？</h4>
<p>同样的症状，儿童和老人的处理方式完全不同。</p>
<p>我们的方案：上下文感知+个性化适配。</p>
<ul>
<li>自动识别患者年龄段</li>
<li>结合过往病史（如有权限）</li>
<li>提供差异化的处理建议</li>
<li>明确标注“建议仅供参考，请及时就医”</li>
</ul>
<blockquote>
<p>Intent Kit 意图识别分发+小艺对话，让问题更精准，“肚子疼”变得立体</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">CrossDeviceSymptomAnalysis</span> {
  <span class="hljs-comment">// 鸿蒙6：跨设备传感器智能融合</span>
  <span class="hljs-meta">@CrossDeviceSensorContext</span>({
    <span class="hljs-comment">// 同时感知手机、手表、环境设备</span>
    <span class="hljs-attr">devices</span>: [<span class="hljs-string">'huawei_watch'</span>, <span class="hljs-string">'harmony_band'</span>, <span class="hljs-string">'smart_thermometer'</span>],
    <span class="hljs-comment">// 智能聚合策略：医疗优先</span>
    <span class="hljs-attr">fusionPolicy</span>: <span class="hljs-string">'medical_emergency'</span>,
    <span class="hljs-comment">// 实时同步，延迟&lt;100ms</span>
    <span class="hljs-attr">syncMode</span>: <span class="hljs-string">'realtime'</span>
  })
  <span class="hljs-attr">multiDeviceHealthData</span>: <span class="hljs-title class_">HealthData</span>
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onSymptomReported</span>(<span class="hljs-params">symptom: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 1. 融合多设备数据进行精准评估</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fuseDeviceData</span>()
    
    <span class="hljs-comment">// 2. 通过Intent Kit分发给最合适的处理节点</span>
    <span class="hljs-keyword">const</span> intentResult = <span class="hljs-keyword">await</span> <span class="hljs-title class_">IntentsKit</span>.<span class="hljs-title function_">dispatch</span>({
      <span class="hljs-attr">intent</span>: <span class="hljs-string">'medical_triage'</span>,
      <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">symptom</span>: symptom,
        <span class="hljs-attr">context</span>: context,
        <span class="hljs-comment">// 附加设备感知数据</span>
        <span class="hljs-attr">crossDeviceData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">multiDeviceHealthData</span>
      },
      <span class="hljs-comment">// 分发策略：基于紧急程度</span>
      <span class="hljs-attr">strategy</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateEmergencyStrategy</span>(context)
    })
    
    <span class="hljs-keyword">return</span> intentResult
  }
}
</code></pre>
<h2 data-id="heading-9">那些不会变的东西：GUI为什么依然重要</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39126ec34e954797a99bd44019aaf5d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=zBrNZxC132WHhnJJgvLmoywaan8%3D" alt="image.png" loading="lazy"/></p>
<p>在大家都热衷讨论自然语言交互时，我想泼一点冷水：GUI不会死，也死不了。
原因很简单：有些交互，用图形就是比用语言高效。</p>
<p>试想一下：</p>
<ul>
<li>在设计工具里微调一个元素的间距：拖拽对齐线 vs “把这个元素向左移动2像素，不对，是1.8像素”</li>
<li>在表格里筛选数据：点击表头下拉 vs “筛选出状态为进行中、优先级为高、创建时间在最近一周的任务”</li>
<li>在地图上规划路径：拖动路径点 vs “把第三个途经点调整到经度X纬度Y的位置”</li>
</ul>
<p>GUI的优势在于：所见即所得，直接操作，实时反馈。
而Agent的价值在于：处理那些需要思考、推理、跨域协作的复杂任务。</p>
<p>两者的关系不是替代，而是互补。</p>
<h2 data-id="heading-10">所以，未来的B端界面要如何设计？</h2>
<p>在人工智能领域，意图通常被定义为用户希望达成的目标，如查询天气情况、办理银行业务、预约服务等。这些意图并不总是直接表达出来，而是隐含在用户的言行之中。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7d9855597ae4cbd895fc40a08132120~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=8A%2Fiyt49nm3pu%2F7%2FGfYpJwQaYgU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我脑海中浮现的画面是这样的：
一个干净的工作台：没有密密麻麻的菜单，只有几个核心数据看板。
一个随时待命的助手：角落里的对话入口，你可以打字，也可以语音。
一组灵活的能力组件：不是固定的页面，而是可以根据任务动态组合的卡片、图表、表单。</p>
<p>当你需要完成一个任务时：</p>
<ol>
<li>向助手描述你的目标</li>
<li>系统理解意图，组装合适的组件</li>
<li>你在生成的界面上微调、确认</li>
<li>系统记住你的偏好，下次做得更好
这听起来像是科幻，但其实技术已经基本就位。缺的不是能力，而是我们作为设计者和开发者的想象力。</li>
</ol>
<h2 data-id="heading-11">写在最后</h2>
<p>最近在推动Agent项目落地时，我最常说的一句话是：“别只想着技术能做什么，多想想用户应该怎么工作。”</p>
<p>Agent不是炫技的工具，它应该是缩短想法与结果之间距离的桥梁。</p>
<p>作为前端，我们正站在一个奇妙的转折点上。过去我们关心像素、关心动画、关心性能，这些依然重要。但现在，我们更需要关心：</p>
<ul>
<li>如何让组件变得“可被理解”？</li>
<li>如何设计“人机协作”的交互流程？</li>
<li>如何平衡“自动决策”和“人工控制”？
这不是AI的胜利，这是交互设计理念的回归——让技术适应人，而不是让人适应技术。</li>
</ul>
<p>也许很快，我们就能告别那个需要记住“点击这里、跳转那里、配置这个”的时代。取而代之的，是一个你说“我需要…”，系统回答“好的，已经准备好了”的时代。</p>
<p>那一天到来时，今天的我们，正在为它铺路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握核心方法论，打造高质量业务仪表板]]></title>    <link>https://juejin.cn/post/7597009443084697615</link>    <guid>https://juejin.cn/post/7597009443084697615</guid>    <pubDate>2026-01-20T05:47:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084697615" data-draft-id="7596962344046051368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握核心方法论，打造高质量业务仪表板"/> <meta itemprop="keywords" content="数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-20T05:47:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握核心方法论，打造高质量业务仪表板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:47:48.000Z" title="Tue Jan 20 2026 05:47:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在数字化运维与业务监控的实践中，仪表板（Dashboard）与汽车的仪表盘同等重要，它不仅是数据可视化的载体，更是团队快速定位问题、洞察数据趋势的核心工具。观测云在平台中内置了大量通用组件、云服务的仪表板模板。但如果你希望从零开始构建个性化的仪表板，又或者对自己绘制的仪表板不够满意，那么这篇文章将教授你几个小技巧，帮助你有效提升仪表板的质量。</p>
<h2 data-id="heading-1">观测云简介</h2>
<p>观测云是一个统一实时监测平台，它提供全面的系统可观测性解决方案，帮助用户快速实现对云平台、云原生、应用及业务的监控需求。观测云的核心功能包括：基础设施监测，日志采集和分析，用户访问监测（RUM），应用性能监测（APM），服务可用性监测（拨测），安全监测，智能监控等等。这款产品能够帮助工程师全面了解端到端的用户体验追踪，了解应用服务的每一次调用，以及全面监控云时代的基础设施。此外，观测云还具备快速发现系统安全风险的能力，为数字化时代提供安全保障。更多信息可以访问观测云官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.guance.com%2F" target="_blank" title="https://www.guance.com/" ref="nofollow noopener noreferrer">www.guance.com</a></p>
<h2 data-id="heading-2">基础仪表板的绘制</h2>
<p>让我们进入到观测云，创建一个属于您自己的仪表板。首先，你需要找到仪表板的入口「场景」-「仪表板」，点击「新建仪表板」-「新建空白仪表板」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333759108314492781504b30b087a7e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=3Z6UX6zpaZrvGxxHjraDyPovW2Y%3D" alt="" loading="lazy"/></p>
<p>其次，可以从侧滑窗口中选择适合展示数据的图表类型，拖拽到左边的空白画布中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e465e05ce9f54854851e9dca5edfb8a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=6HGYT346IzEFuSSfCbAK8MYEHoQ%3D" alt="" loading="lazy"/></p>
<p>以常用的「时序图」为例，拖动到画布中即可打开「新建图表」弹窗，此时通过数据筛选控件来选择需要展示的指标。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21b52c47adb4e11879bc8e3a0378e1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=wr7a%2BtFEmgDoMppQYxLWWIgyOwo%3D" alt="" loading="lazy"/></p>
<p>如图所示，我们已经展示了一条指标曲线，它代表的含义为：指标集为 cpu，指标名为 usage_total，按照 host 进行分组并统计 Avg 平均值，只显示 host=DESKTOP-F9E75IG 的值（过滤条件），点击右下角的保存即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a2b2e619b3d493b80fb47635311938a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=uS7E3PUhbfXV3fODmjJtYpFBdQ0%3D" alt="" loading="lazy"/></p>
<p>此时你已经完成了第一张图表的制作，通过一张张图表的叠加，你很快能得到一个完整的仪表板，不过它看上去有些简陋，我们需要更多技巧对仪表板的美观程度和易读性进行优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2eb025dff914578aa348519416a733b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=5HHVeRsAVq65SkQp0JGVRjqqEdI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">仪表板的优化</h2>
<h3 data-id="heading-4">新增标题和描述</h3>
<p>恰当的标题能让用户第一时间知道图表展示的指标及其含义，而图表的描述能够起到有效补充说明。我个人的习惯是将图表名设置为指标的英文名，然后在「描述」中补充该指标的中文含义。如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e1643f12d1a48e5a1c80064d2acd07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=bUsHBdkRvpPgyqOrnRUIjG7I0Us%3D" alt="" loading="lazy"/></p>
<p>保存生效的效果如下，图表左上角将展示标题，而鼠标 hover 到帮助按钮上则会悬浮显示描述。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5450112709c24704a8d0549cf2598f0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=8iF25S3ZKVcRD7MU2ouy8f17oPc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">数据单位</h3>
<p>一部分指标在采集到观测云后没有单位，因此在绘制仪表板时需要注意补充单位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f57d23f8106409f922c4698966cc308~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=FVBTeD5tXUZIXKLCrQG5ageY0rw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">别名</h3>
<p>图表的曲线会显示对象的名称，并且对象名称会随着分组条件的增多而变得复杂。例如下图，由于添加了 namespace，pod_name 等多个分组条件，对象名称显得很长，很不直观。好在我们可以通过配置「别名」来简化对象名称的显示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b26a5c176fef4807994a71d4f9a3fd78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=E9zW9d%2BzBkZ44eQeVCCLpcG53PY%3D" alt="" loading="lazy"/></p>
<p>在图表配置的「别名」处，我们选择对应的指标序列，并用 {{}} 将分组条件包起来作为变量，例如下图中的分组条件 pod_name 就写为 {{pod_name}} ，效果如下所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ac47208e167414384a0d4f0bfe706c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=lHIH81E4jN4PdtJVmuo8HSKubGA%3D" alt="" loading="lazy"/></p>
<p>我们也支持用多个变量作为别名，写法为 {{分组条件1}}-{{分组条件2}} ，例如 {{namespace}}--{{pod_name}} ，效果如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a8d36ae462c4b109ce3e18880a854d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=lNO8iRNQNrh7oCrDX9O7jlnN0e8%3D" alt="" loading="lazy"/></p>
<p>现在，曲线上显示的对象名称已经比原始的名称简洁、清晰了很多。</p>
<h3 data-id="heading-7">图例</h3>
<p>图表默认没有带上图例，除非将鼠标 hover 上去，否则无法看到什么颜色的曲线代表哪一个对象，如下图的左侧所示。而「图例」则可以将对象的名称和统计值显示到图表中，如下图的右侧所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e24fbebf7004b0690b0a44431439f75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=pfwJaWJCEBLOJV5rvCyCsmOaWqI%3D" alt="" loading="lazy"/></p>
<p>添加图例的方式如下，可选择将图例放置在图表的底部或者右侧，并显示单个或者统计值，将 Avg、Max、Last 一起显示出来是个不错的选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194005883ea24e1bb80d69b557cb8bdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=PFI6B8b1r3h6ZqvXBT%2Bg76gE6nc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">分组</h3>
<p>当仪表板中需要展示很多张图表时，使用「分组」来将不同含义的图表分门别类地归类就十分有必要了，这会让仪表板的显示更具有条理，用户能通过分组快速找到自己关注的图表，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d34343b951b4f009a4f292523bea172~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=Y92o59KNIg2%2BQyYSbMqANvAeeTg%3D" alt="" loading="lazy"/></p>
<p>给仪表板添加分组时，只需要在侧滑菜单中找到「分组」这个图表类型，拖动到左侧画布即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48e594d566ad4e18948682a6e3db20f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=OTGnYR6w5xPLmjNETtknbwgjFiQ%3D" alt="" loading="lazy"/></p>
<p>取一个有意义的分组名称，选择一个与众不同的颜色，保存即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/088f87d5ce8d40ce830909a43886ce2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=oofi9Hx0EZvdBL%2FtUCThOSGC0RY%3D" alt="" loading="lazy"/></p>
<p>下图即为新创建的分组，后续添加的图表即可拖动到该分组下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f0d13389614f5a99a3855ff7606645~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=DTJaKXPMwL4S%2Fc9EUHVovfN1rAk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">锁定时间</h3>
<p>如果你希望每次进入到仪表板，都查看到固定时间区间（例如最近1天）的数据，应该如何实现呢？</p>
<p>我们很容易注意到仪表板的时间控件，可以在这里固定整个仪表板的时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa6c2d835334037854d86a1c3304ca6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=4CMQ%2FXzce%2FoY8wVb5kkrEv2Gf4g%3D" alt="" loading="lazy"/></p>
<p>如果需要将单个图表的时间进行固定，而其他图表的时间则跟随仪表板的时间控件，也很好实现。我们进入单个图表的编辑窗口，打开「高级配置」，将时间锁定为指定区间即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07fa1057949d41cf8a73762c734568a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=I0ysME8tOEOhy2vcm72BA1njiqI%3D" alt="" loading="lazy"/></p>
<p>配置完成后，这个图表的右上角会出现你锁定的时间区间，该时间不受仪表板整体的时间区间控制，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5bbbaacdfc548488732afc90da229f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=ivIHeaUaR1y9qVgWmJfMmyPOOXo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">视图变量</h3>
<p>视图变量允许用户通过下拉菜单来选择特定对象的监控数据，从而根据自身需求动态筛选和分析数据。如下图所示，该仪表板包括了 Cluster、Namespace 和 Node 三个视图变量，用户可以进行自由筛选。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d4aa45b10d24c20b1e3edfbb19be8ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=en%2BwcDHIQ6AoxsxE8yMxnxNvxYY%3D" alt="" loading="lazy"/></p>
<p>我们首先添加一个简单的视图变量，需求是通过选择 host_ip 来过滤单台主机的数据。在仪表板中点击「添加视图变量」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51ce9c1998ce48ab8b737a27e3bc2e18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=xt5vh0WB0VmBUFuSMe1us2QUavA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c451a1950e4ffc9f7231657a36f19c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=MuZZ0wvXNQ42fFkOEcKZtaSCOmg%3D" alt="" loading="lazy"/></p>
<p>host_ip 是 cpu 相关指标数据的一个标签，因此我们从指标类型- CPU指标集里面选择 host_ip 作为视图变量的来源，然后将「变量名」和「显示名」都与之保持一致，保存窗口即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe7a7d7399f643689e2574427ace0e76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=PG%2BWMQKOjzgJrUUBGfuJgxCJ984%3D" alt="" loading="lazy"/></p>
<p>此时返回仪表板，就会看到刚才添加的 host_ip 视图变量，从下拉菜单中可以筛选主机 IP。如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d89c3eede6749ad8e62b235b9246cb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=9QLCCB3HxMwmUpIfPCRIZnLI1E4%3D" alt="" loading="lazy"/></p>
<p>你可能会发现筛选结果之后，对下方的图表没有任何作用，因为我们还需要在图表中的过滤条件配置变量，使仪表板的额视图变量与图表的过滤条件进行联动。再次进入图表编辑界面，添加一个过滤条件，字段选择为 host_ip，值选择「视图变量」，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ad9f728a484df1a190f83891124235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=u9jBN9aTbI2OAaCHQB58p5CVJkc%3D" alt="" loading="lazy"/></p>
<p>返回仪表板，这时仪表板的视图变量 host_ip 就可以与图表中的监控对象 host_ip 进行联动了。我们可以通过下拉菜单来筛选不同的主机，从而观察不同主机的监控指标。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d90efe78305463a9fdc62582cdea9e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=JNN8g6qeLTBfhGDQJeO%2FVak2qjU%3D" alt="" loading="lazy"/></p>
<p>如果是有多个视图变量，且视图变量之间有依赖关系，例如我们针对 Pod 的监控是首先选择 namespace，再选 Pod，那我们又应该如何配置呢？这就要用到「级联」的写法，让我们来再来回顾一下刚才本章开头的那张图片。选择 Cluster 后，Namespace 的值随 Cluster 的取值而联动，Node 的值又随 Namespace 的取值而联动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a6753aec12b41f1b5e8ed14b8822c2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=mQJ8K96GjuDZM8f0zZ2gR1AsfdM%3D" alt="" loading="lazy"/></p>
<p>我们研究一下这组视图变量的写法，不难发现规律是在 show_tag_value 函数的后面跟随了一个 {key=value} 的过滤条件，其固定写法为 {key='#{value}'} ，key 和 value 都取自上一级的变量名，表示该变量随上一级变量的值而联动。如下图所示，当用户在界面上选择了 cluster_name_k8s 的值后，该值就会传入 namespace 作为过滤条件，从而实现变量联动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b8397ef9b94924be46b7db52f41ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=myFRqvQBdnurRS13DvGL1GK8x2A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90a5fd34ead44e6e844333dae5274dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=LfWOXyZqqrUNKsPgGZZiAtBB710%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">小结</h2>
<p>通过上面的几个小技巧，相信你已经跃跃欲试将自己的仪表板更上一层楼了。在得到令自己满意的仪表板后，你可以选择将仪表板开放给团队、配置为定时报告、投放到大屏幕、关联到日志或链路查看器中，又或者在接收到告警时一键查看这张仪表板。我们非常期待你通过仪表板来向你的团队/客户呈现数据的价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年度稀土掘金影响力榜单如约而至！]]></title>    <link>https://juejin.cn/post/7589823928413241370</link>    <guid>https://juejin.cn/post/7589823928413241370</guid>    <pubDate>2025-12-31T07:57:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589823928413241370" data-draft-id="7589578614583132186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年度稀土掘金影响力榜单如约而至！"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-31T07:57:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年度稀土掘金影响力榜单如约而至！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-31T07:57:38.000Z" title="Wed Dec 31 2025 07:57:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3,871
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">稀土掘金社区2025年度影响力榜单正式公布</h2>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d84e196bd63448db7cedc4f98be0bc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768983079&amp;x-signature=tci%2B%2BO58Guui6sHmsaiPJZ7GrEU%3D" alt="1303-734主视觉 (1) (3).jpg" width="100%" loading="lazy"/>
<p>时光向前，2025年即将落下句点。回首这一程，幸而有伴 —— 每一次深夜的打磨，每一段真诚的分享，每一回评论区里的倾力相助，都为技术探索的漫漫长路，点亮了一盏盏暖灯。</p>
<p>感谢这一年里，将实操经验凝注于代码、把深度思考落笔成文字的创作者。是每一个具体的 “你”，让稀土掘金始终活力满满。</p>
<p>今天，我们以这份榜单，记录那些值得被看见的光芒。它们来自团队扎实的沉淀，来自创作者持久的热情，也来自那些真正帮助过许多人的走心好文。</p>
<p><strong>榜单地址</strong>：<a href="https://aicoding.juejin.cn/pens/7589935553110835252" target="_blank" title="https://aicoding.juejin.cn/pens/7589935553110835252">aicoding.juejin.cn/pens/758993…</a></p>
<h2 data-id="heading-1">2025年度优秀创作者 | The Best 10 Creative Writers of 2025</h2>
<blockquote>
<p>他们是社区里的“解惑人”，把复杂讲得简单，把枯燥变得生动。他们的文字，曾陪伴无数掘友走出技术探索的迷茫时刻。</p>
</blockquote>

















































<table><thead><tr><th>站内昵称</th><th>个人主页</th></tr></thead><tbody><tr><td>Moment</td><td><a href="https://juejin.cn/user/3782764966460398" target="_blank" title="https://juejin.cn/user/3782764966460398">juejin.cn/user/378276…</a></td></tr><tr><td>ConardLi</td><td><a href="https://juejin.cn/user/3949101466785709" target="_blank" title="https://juejin.cn/user/3949101466785709">juejin.cn/user/394910…</a></td></tr><tr><td>何贤</td><td><a href="https://juejin.cn/user/277499952247869" target="_blank" title="https://juejin.cn/user/277499952247869">juejin.cn/user/277499…</a></td></tr><tr><td>洛卡卡了</td><td><a href="https://juejin.cn/user/888839672963544" target="_blank" title="https://juejin.cn/user/888839672963544">juejin.cn/user/888839…</a></td></tr><tr><td>why技术</td><td><a href="https://juejin.cn/user/3702810893364350" target="_blank" title="https://juejin.cn/user/3702810893364350">juejin.cn/user/370281…</a></td></tr><tr><td>恋猫de小郭</td><td><a href="https://juejin.cn/user/817692379985752" target="_blank" title="https://juejin.cn/user/817692379985752">juejin.cn/user/817692…</a></td></tr><tr><td>苏三说技术</td><td><a href="https://juejin.cn/user/465848661970824" target="_blank" title="https://juejin.cn/user/465848661970824">juejin.cn/user/465848…</a></td></tr><tr><td>coder_pig</td><td><a href="https://juejin.cn/user/4142615541321928" target="_blank" title="https://juejin.cn/user/4142615541321928">juejin.cn/user/414261…</a></td></tr><tr><td>张风捷特烈</td><td><a href="https://juejin.cn/user/149189281194766" target="_blank" title="https://juejin.cn/user/149189281194766">juejin.cn/user/149189…</a></td></tr><tr><td>德莱厄斯</td><td><a href="https://juejin.cn/user/3919115686512942" target="_blank" title="https://juejin.cn/user/3919115686512942">juejin.cn/user/391911…</a></td></tr></tbody></table>
<h2 data-id="heading-2">2025年度影响力团队 -The Most Influential Teams of 2025</h2>
<blockquote>
<p>他们以团队的力量，把一线实践沉淀成可复用的经验，如一张张清晰的技术地图，帮助不少同行找到了方向。</p>
</blockquote>

















































<table><thead><tr><th>团队名称</th><th>团队主页</th></tr></thead><tbody><tr><td>DevUI团队</td><td><a href="https://juejin.cn/user/712139267650141" target="_blank" title="https://juejin.cn/user/712139267650141">juejin.cn/user/712139…</a></td></tr><tr><td>vivo互联网技术</td><td><a href="https://juejin.cn/user/993614243303053" target="_blank" title="https://juejin.cn/user/993614243303053">juejin.cn/user/993614…</a></td></tr><tr><td>得物技术</td><td><a href="https://juejin.cn/user/2392954206960247" target="_blank" title="https://juejin.cn/user/2392954206960247">juejin.cn/user/239295…</a></td></tr><tr><td>古茗前端团队</td><td><a href="https://juejin.cn/user/3233040624266695" target="_blank" title="https://juejin.cn/user/3233040624266695">juejin.cn/user/323304…</a></td></tr><tr><td>货拉拉技术</td><td><a href="https://juejin.cn/user/1768489241815070" target="_blank" title="https://juejin.cn/user/1768489241815070">juejin.cn/user/176848…</a></td></tr><tr><td>京东零售技术</td><td><a href="https://juejin.cn/user/4233576972293643" target="_blank" title="https://juejin.cn/user/4233576972293643">juejin.cn/user/423357…</a></td></tr><tr><td>奇舞精选</td><td><a href="https://juejin.cn/user/4388906147515367" target="_blank" title="https://juejin.cn/user/4388906147515367">juejin.cn/user/438890…</a></td></tr><tr><td>37手游后端团队</td><td><a href="https://juejin.cn/user/1548527766871239" target="_blank" title="https://juejin.cn/user/1548527766871239">juejin.cn/user/154852…</a></td></tr><tr><td>哔哩哔哩技术</td><td><a href="https://juejin.cn/user/3030701626893405" target="_blank" title="https://juejin.cn/user/3030701626893405">juejin.cn/user/303070…</a></td></tr><tr><td>转转技术团队</td><td><a href="https://juejin.cn/user/606586148237431" target="_blank" title="https://juejin.cn/user/606586148237431">juejin.cn/user/606586…</a></td></tr></tbody></table>
<h2 data-id="heading-3">2025年度爆款好文 | High hits articles in 2025</h2>
<blockquote>
<p>这20篇文章，是从海量分享中脱颖而出的“年度之选”。它们或视角新颖、或剖析深入、或实战性强，在各自领域内获得了认可，成了许多掘友收藏或推荐的那一篇。</p>
</blockquote>



























































































































































<table><thead><tr><th>文章标题</th><th>文章链接</th><th>所属作者</th><th/></tr></thead><tbody><tr><td/><td><strong>前端</strong></td><td/><td/></tr><tr><td>《40岁老前端2025年上半年都学了什么？》</td><td><a href="https://juejin.cn/post/7524548909530005540" target="_blank" title="https://juejin.cn/post/7524548909530005540">juejin.cn/post/752454…</a></td><td>张鑫旭</td><td/></tr><tr><td>《前端仔如何在公司搭建 AI Review 系统》</td><td><a href="https://juejin.cn/post/7532596434031149106" target="_blank" title="https://juejin.cn/post/7532596434031149106">juejin.cn/post/753259…</a></td><td>唐某人丶</td><td/></tr><tr><td>《因为写了一个前端脚手架，这个月的KPI 打满了！！！》</td><td><a href="https://juejin.cn/post/7457936514791292938" target="_blank" title="https://juejin.cn/post/7457936514791292938">juejin.cn/post/745793…</a></td><td>赵小川</td><td/></tr><tr><td>《因网速太慢我把20M+的字体压缩到了几KB》</td><td><a href="https://juejin.cn/post/7490337281866317836" target="_blank" title="https://juejin.cn/post/7490337281866317836">juejin.cn/post/749033…</a></td><td>古茗前端团队</td><td/></tr><tr><td>《历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀》</td><td><a href="https://juejin.cn/post/7553165143376134195" target="_blank" title="https://juejin.cn/post/7553165143376134195">juejin.cn/post/755316…</a></td><td>Moment</td><td/></tr><tr><td/><td><strong>后端</strong></td><td/><td/></tr><tr><td>《MCP 很火，来看看我们直接给后台管理系统上一个 MCP？》</td><td><a href="https://juejin.cn/post/7481491253499969575" target="_blank" title="https://juejin.cn/post/7481491253499969575">juejin.cn/post/748149…</a></td><td>Hamm</td><td/></tr><tr><td>《还在用WebSocket实现即时通讯？试试MQTT吧，真香！》</td><td><a href="https://juejin.cn/post/7539351775044862003" target="_blank" title="https://juejin.cn/post/7539351775044862003">juejin.cn/post/753935…</a></td><td>MacroZheng</td><td/></tr><tr><td>《我做了套小红书一键发布系统，运营小姐姐说她不想离开我了》</td><td><a href="https://juejin.cn/post/7552489208804491316" target="_blank" title="https://juejin.cn/post/7552489208804491316">juejin.cn/post/755248…</a></td><td>洛卡卡了</td><td/></tr><tr><td>《Java 实现责任链模式 + 策略模式：优雅处理多级请求的方式》</td><td><a href="https://juejin.cn/post/7457366224823124003" target="_blank" title="https://juejin.cn/post/7457366224823124003">juejin.cn/post/745736…</a></td><td>后端出路在何方</td><td/></tr><tr><td>《CompletableFuture还能这么玩》</td><td><a href="https://juejin.cn/post/7455561985378598951" target="_blank" title="https://juejin.cn/post/7455561985378598951">juejin.cn/post/745556…</a></td><td>一只叫煤球的猫</td><td/></tr><tr><td/><td><strong>移动端</strong></td><td/><td/></tr><tr><td>《2025 跨平台框架更新和发布对比，这是你没看过的全新版本》</td><td><a href="https://juejin.cn/post/7505578411492474915" target="_blank" title="https://juejin.cn/post/7505578411492474915">juejin.cn/post/750557…</a></td><td>恋猫de小郭</td><td/></tr><tr><td>《月下载 40 万次的框架是怎么练成的？》</td><td><a href="https://juejin.cn/post/7547408384585629711" target="_blank" title="https://juejin.cn/post/7547408384585629711">juejin.cn/post/754740…</a></td><td>Android轮子哥</td><td/></tr><tr><td>《[targetSDK升级为35] 恶心的EdgeToEdge适配 (v7)》</td><td><a href="https://juejin.cn/post/7497170890083762213" target="_blank" title="https://juejin.cn/post/7497170890083762213">juejin.cn/post/749717…</a></td><td>snwrking</td><td/></tr><tr><td>《gson很好，但我劝你在Kotlin上使用kotlinx.serialization》</td><td><a href="https://juejin.cn/post/7459298439811219496" target="_blank" title="https://juejin.cn/post/7459298439811219496">juejin.cn/post/745929…</a></td><td>沈剑心</td><td/></tr><tr><td>《开箱即食Flutter通用脚手架》</td><td><a href="https://juejin.cn/post/7482789772362317864" target="_blank" title="https://juejin.cn/post/7482789772362317864">juejin.cn/post/748278…</a></td><td>SunshineBrother</td><td/></tr><tr><td/><td><strong>人工智能</strong></td><td/><td/></tr><tr><td>《一天 AI 搓出痛风伴侣 H5 程序，前后端+部署通吃，还接入了大模型接口（万字总结）》</td><td><a href="https://juejin.cn/post/7517496354244067339" target="_blank" title="https://juejin.cn/post/7517496354244067339">juejin.cn/post/751749…</a></td><td>志辉AI编程</td><td/></tr><tr><td>《AI 应用开发入门：前端也可以学习 AI》</td><td><a href="https://juejin.cn/post/7517197769247391756" target="_blank" title="https://juejin.cn/post/7517197769247391756">juejin.cn/post/751719…</a></td><td>唐某人丶</td><td/></tr><tr><td>《如何把你的 DeePseek-R1 微调为某个领域的专家？》</td><td><a href="https://juejin.cn/post/7473309339294695460" target="_blank" title="https://juejin.cn/post/7473309339294695460">juejin.cn/post/747330…</a></td><td>ConardLi</td><td/></tr><tr><td>《3天，1人，从0到付费产品：AI时代个人开发者的生存指南》</td><td><a href="https://juejin.cn/post/7577653509862654002" target="_blank" title="https://juejin.cn/post/7577653509862654002">juejin.cn/post/757765…</a></td><td>HiStewie</td><td/></tr><tr><td>《全网最细，一文带你弄懂 MCP 的核心原理！》</td><td><a href="https://juejin.cn/post/7493455615244959794" target="_blank" title="https://juejin.cn/post/7493455615244959794">juejin.cn/post/749345…</a></td><td>ConardLi</td><td/></tr></tbody></table>
<h2 data-id="heading-4">好的社区，是人与人相互照亮</h2>
<p>这份榜单，与其说是评选，不如说是一次郑重的致谢。谢谢所有分享者，也谢谢每一位静静学习、默默点赞、热心评论的掘友。</p>
<p>技术之路，日常而长远。2026年，愿你继续在这里写下自己的章节，发出自己的光。我们相信，每一个人的微小光芒，终将汇聚成行业的星辰。</p>
<p>*注：以上排名不分先后，随机排序。本榜单依据<strong>2025年1月1日至12月21日</strong>期间的数据综合评定，涵盖文章质量、互动热度、创作者影响力、分类分布及评审团意见等多维度，最终解释权归稀土掘金所有。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Meta ShapeR ：基于随机拍摄视频的 3D 物体生成，未来的 XR 和机器人基建支持]]></title>    <link>https://juejin.cn/post/7597083949833797638</link>    <guid>https://juejin.cn/post/7597083949833797638</guid>    <pubDate>2026-01-20T05:54:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083949833797638" data-draft-id="7597168034616672275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Meta ShapeR ：基于随机拍摄视频的 3D 物体生成，未来的 XR 和机器人基建支持"/> <meta itemprop="keywords" content="前端,Android,AI编程"/> <meta itemprop="datePublished" content="2026-01-20T05:54:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Meta ShapeR ：基于随机拍摄视频的 3D 物体生成，未来的 XR 和机器人基建支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:54:37.000Z" title="Tue Jan 20 2026 05:54:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日 Meta 突然开源了它的 ShapeR 项目，ShapeR 可以利用基于对象多模态数据的 Rectified Flow Transformer，将普通图像序列转换为完整的度量场景重建，说人话就是：</p>
<blockquote>
<p><strong>从随手拍的视频/多张照片里，把真实物体恢复成可用 3D 模型（Mesh）</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bf8a838b0144e5cb01212204e0b7fcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=YWca4hlM0a3iISD5%2F4znADH1yfY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c77a685673244eb8a3204ebd16bfb06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=8kPoF0npRJmznj65h4m4saegDsQ%3D" alt="" loading="lazy"/></p>
<p>简单来说就是，你可以拿着手机绕着一个物体拍一圈（图片序列 / 视频帧序列），ShapeR 会结合：</p>
<ul>
<li>SLAM 得到的稀疏点云 + 相机位姿</li>
<li>物体检测/实例分割得到的对象实例</li>
<li>VLM 生成的文本 caption（描述物体），把这些多模态条件喂给生成模型，最后得到<strong>物体的 metric 3D mesh（带真实尺度）</strong></li>
</ul>
<p>看到这么多名词是不是有点懵？这些概念性的东西我们需要简单聊聊：</p>
<h4 data-id="heading-0">SLAM</h4>
<p>这个是 ShapeR 的地基核心，<strong>SLAM (Simultaneous Localization and Mapping) 其实就是用算法解决摄像头在陌生化环境的定位和建图</strong>，实现定位的时候建图，建图的时候定位的支持，简单来说就是：</p>
<ul>
<li>摄像头采集数据</li>
<li>通过画面比对计算移动距离</li>
<li>通过算法来修正误差</li>
<li>通过回环检测来解决漂移和消除误差</li>
</ul>
<p>用人话来说就是：<strong>用 SLAM 可以得到 “摄影师的足迹”和“物体的骨架”</strong> ，具体来自：</p>
<ul>
<li><strong>相机位姿</strong>：相当于记录了你拿着手机绕着物体走动时，每一步具体站在哪里，手机镜头朝向哪里（比如：向左走了 1 米，镜头向下倾斜 30 度）<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07e11b19046145d08d65f222dbe03f26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=i0fvm9RdxnTLJf%2B6xatDJBEzD4A%3D" alt="" loading="lazy"/></li>
<li><strong>稀疏点云</strong>：相当于你在物体上撒了一把荧光粉，SLAM 并不试图重建整个物体表面，它只抓取最明显的特征点（比如桌角、杯子的把手尖），看起来稀稀拉拉像个幽灵，<strong>但它锁定了物体的真实尺寸和空间位置</strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd9100dafc1b41ae80c88949d430c2f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=kUOZqIoj32CQffKPcJbDtWT6wvc%3D" alt="" loading="lazy"/></li>
</ul>
<p>SLAM 之所以能做到这一点，核心依赖于<strong>几何学的三角测量和概率学的误差优化</strong>，简单来说：</p>
<ul>
<li>
<p>当你拿着手机移动时（比如向右移动了 10 厘米），SLAM 会对比前后两帧画面：</p>
<ul>
<li><strong>A点（比如桌上的杯子）</strong> 在画面里移动了 100 个像素 -&gt; 推算：<strong>它离我很近</strong></li>
<li><strong>B点（窗外的树）</strong> 在画面里只移动了 2 个像素 -&gt; 推算：<strong>它离我很远</strong></li>
</ul>
<p>通过这种<strong>视差</strong>，配合手机摄像头移动的距离（IMU 传感器提供），算法就能画出一个个三角形，通过几何公式算出每个特征点在三维空间中的精确坐标，这在室内导航 BLE 测距离也会有类似的三角测量用法</p>
</li>
<li>
<p>SLAM 并不是真的知道自己移动了多少米，它最聪明的地方在于不追求一步到位，而是不断“猜”和“改”，通过假设和推算不断去修正误差</p>
</li>
<li>
<p>最后有个回环检测，比如误差越来越大，但是当你绕了一圈回到原点时，摄像头拍到了之前的场景，比对之后会发，这个画面和之前 5 分钟的画面重合，那么它会把过去 5 分钟积累的所有位置偏差强制拉回</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1da6cb9389054a41a99c4f697cfcd92e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=gCdLba23K51c9fDQlw8IHBX4GQo%3D" alt="" loading="lazy"/></p>
<p>这就是 SLAM 的简单概念，实际上这也是移动开发里的 ARCore 和 ARkit 的基础概念之一，同时对于机器人、无人机或者 XR ，SLAM 也是非常重要的基础，如果用人话来说就是，<strong>SLAM 是把硬件数据（IMU 的加速度、摄像头的像素变化）转化为了几何约束</strong>：</p>
<ul>
<li><strong>眼睛（Camera）</strong> ：提供角度信息（我知道杯子在那个方向）</li>
<li><strong>前庭（IMU）</strong> ：提供尺度信息（我感觉我向前冲了 1 米）</li>
<li><strong>大脑（Algorithm）</strong> ：通过几何公式把角度和尺度结合，算出距离，再通过记忆（回环检测）修正走过的路</li>
</ul>
<h4 data-id="heading-1">物体检测 / 实例分割</h4>
<p><strong>物体检测 / 实例分割（Object Detection / Instance Segmentation）简单说就是 “自动抠图”和“聚光灯”</strong> ：</p>
<ul>
<li>你拍的是整个房间，但你只想重建桌上的那个茶壶</li>
<li>这就需要一个算法，能自动在乱糟糟的背景里把茶壶给“圈出来”（画个框），甚至精确到把茶壶的每一个像素都涂上颜色，把背景剔除掉，这就是把茶壶从环境里“抠”出来</li>
</ul>
<p>具体到实现上就是：</p>
<ul>
<li><strong>物体检测 (Detection)</strong> ：输出一个 Bounding Box（边界框），告诉系统物体大概在哪（比如 <code>[x1, y1, x2, y2]</code>）</li>
<li><strong>实例分割 (Instance Segmentation)</strong> ：输出一个 Binary Mask（二值掩码），在这个掩码图里，属于茶壶的像素是 1，背景是 0</li>
</ul>
<p>ShapeR 是 Object-Centric（以物体为中心）的，它需要这些 Mask 来告诉生成模型：“只准重建这个茶壶，不要把后面的墙壁和下面的桌子也算进去了”</p>
<h4 data-id="heading-2">VML</h4>
<p>最后是 VLM (Visual Language Model generated Captions) 生成的文本 Caption，通俗理解来说就是“给 AI 的命题作文”：</p>
<ul>
<li>虽然有了照片，但生成模型有时候比较“笨”，它可能看不清照片里的细节（比如模糊了，或者被挡住了）</li>
<li>这时，就需要一个专门懂图片的 AI（VLM，类似 GPT-4V），让它看一眼照片，然后写一段话：“这是一个红色的复古木质椅子，椅背有雕花，坐垫是天鹅绒材质。”</li>
</ul>
<p>也就是针对图形增加一点文本表述，提供更准确的语义，照片提供了“几何外观”，文本提供了“概念理解”，防止照片里因为反光或遮挡导致细节丢失时，模型可以根据这段文本描述，利用其训练库里关于“复古木质椅子”的知识，合理地“脑补”出看不清的细节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef9a57854e7b4713a225406133b8f56c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=k29TVlcFmssyyZzp4AHwGSmr8Bc%3D" alt="" loading="lazy"/></p>
<p>所以 ShapeR 基本概念就是通过这三者完成建模：</p>
<ul>
<li>SLAM 提供骨架和尺子：“雕像必须这么高，膝盖必须在这里，不能乱动。”（保证准确度）</li>
<li>实例分割提供一个轮廓剪影：“只能在这个范围内雕刻，别把旁边的花瓶也雕进去了。”（保证独立性）</li>
<li>VLM Caption 提供附录：“这可是个由桃花心木做的 18 世纪风格椅子，纹理要细腻。”（保证细节和合理性）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4df52317da414eafa5533f00b8dd09ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=DmJqqGWt6tF4zyIm4gUuzF58WrU%3D" alt="" loading="lazy"/></p>
<p>那么从前面的概念也可以看出来，ShapeR 的特点是：<strong>它不是直接重建一个整体 NeRF / TSDF 场景块，而是先检测场景中的多个对象 ，然后对每个对象单独重建 mesh ，最后再组装成场景</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb8da197bd041e0a2acefe3b59e59ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=2hq4its6ZBU5Ch%2Fb9L92EI7N6bo%3D" alt="" loading="lazy"/></p>
<p>所以在 ShapeR 里，你可以：</p>
<ul>
<li>单独拿出某个物体（比如椅子/桌子）</li>
</ul>

<ul>
<li>替换/移动/重新摆放</li>
</ul>

<ul>
<li>导出到 DCC/引擎里编辑（Blender/Unity/Unreal）</li>
</ul>
<blockquote>
<p>换个概念简单理解，以前你只能得到一个 PNG，现在你可以得到一个 PSD</p>
</blockquote>
<p>那你可能会说，它有什么作用？实际上它的作用还挺丰富，比如：</p>
<ul>
<li>AR 场景理解 / 虚拟摆放</li>
<li>机器人避障、navigation</li>
<li>具身 AI 的数据集构建（真实物体 mesh + 尺度）</li>
</ul>
<p>ShapeR 可以把“现实物体”的视频快速转成结构化的 3D 资产（mesh 级别），当然，事实上 ShapeR 不是“直接吃视频就出 3D”，它吃的是 <strong>预处理后的 per-object 数据包（pkl）</strong> ，里面包含：</p>
<ul>
<li>物体的稀疏 metric point cloud（来自 SLAM / SfM）</li>
<li>带位姿的多视图图像（posed images）</li>
<li>物体的 caption 文本描述</li>
<li>物体的 2D/3D 实例信息（用于从场景里拆出物体）</li>
</ul>
<p><strong>所以 ShapeR 的核心难点确实不在模型推理本身，而在于数据准备</strong> ，目前 ShapeR 的代码库明确指出，它的前提是假设数据已经通过 <strong>Aria MPS (Machine Perception Services)</strong> 流水线处理过。</p>
<p>所以不得不说，官方宣传的“随手拍”很美好，但是实际上并不是想象中那么简单，在他们提供的场景下：</p>
<ul>
<li><strong>录制设备</strong>：Meta 内部的 <strong>Project Aria 眼镜</strong>（智能眼镜）</li>
<li><strong>数据准备</strong>：使用 【Aria MPS 服务】+ 【3D 实例检测】 + 【VLM caption】将眼镜录制的数据转换为上述的 <code>.pkl</code> 格式</li>
</ul>
<blockquote>
<p>这里的 Aria MPS 是闭源的服务，MPS 内部使用的 SLAM（定位与地图构建）、3D 重建、手部追踪等核心算法，暂时只面向 Project Aria Research Kit（ARK）研究合作伙伴开放。</p>
</blockquote>
<p>目前官方已经发布 <strong>ShapeR Evaluation Dataset</strong>，里面每个样本就是推理要用的 <code>.pkl</code>（包含点云、multi-view 图像、相机参数/位姿、caption、GT mesh 等），如果只是想测试，可以下载他们的 evaluation dataset（HuggingFace 上的 <code>facebook/ShapeR-Evaluation</code>，项目页也有 Data 链接），直接跑推理：</p>
<pre><code class="hljs language-css" lang="css">python infer_shape<span class="hljs-selector-class">.py</span> <span class="hljs-attr">--input_pkl</span> &lt;sample<span class="hljs-selector-class">.pkl</span>&gt; <span class="hljs-attr">--config</span> balance <span class="hljs-attr">--output_dir</span> output
</code></pre>
<p><strong>所以，如果你不是合作伙伴，没有 Project Aria 眼镜，那么你只能用它已有的数据集玩玩</strong>，从项目看，大概率这会是一个服务收费的项目。</p>
<p>那我们有没有机会自己玩一下呢？也是有的，ShapeR 特意提供了一个 <code>explore_data.ipynb</code> 来解释这个 pkl 的结构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0f0024353d7447ca63afbb8c3be2d9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=ZrDPeRznBJSsxNDyivrZWrLmQA0%3D" alt="" loading="lazy"/></p>
<p>只是自己做数据这个过程就相当麻烦了，你需要的路径就会复杂很多，并且也不确定是否可以走的通，我们需要使用 ARKit/ARCore 采集数据（录 RGB 帧 + 时间戳 + IMU + 相机内参，最好还有 VIO/轨迹），比如用 iPhone 的 Stray Scanner 数据采集的 App，它能记录 <strong>video + depth（ LiDAR）+ ARKit 的 VIO（里程计/位姿）</strong> 。</p>
<blockquote>
<p>当然，Stray Scanner 导出的数据格式不能直接支持 ShapeR 要求的输入格式（单一结构化 <code>.pkl</code>），所以需要转为它支持的格式，这个目前需要自己参考项目数据结构去变更，工作量巨大。</p>
</blockquote>
<p>另外，官方也提供了一个叫 <code>MapAnything </code>的“通用、前馈式 metric 3D 重建模型”，可以从输入图像（ShapeR 甚至可以从<strong>单目图像</strong>生成度量三维形状，而无需重新训练）直接回归<strong>带度量尺度的几何和相机信息</strong>，所以也可以作为 ShapeR “替代 MPS 的 metric points 生成器” 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfe2d68bed2c4401a2e758daeaca33c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=Bw4EumOYd0pGci5bjt21MMvEPdQ%3D" alt="" loading="lazy"/></p>
<p>所以，一般来说，我们只能期待后续有更完善的转换工具，或者社区第三方的工具支持，这才是真的可以做到随手建模，甚至实时运算的效果，但是这个路线，不管对于智能眼镜，XR 场景还是机器人的导航能力，都是一个非常不错的尝试方向。</p>
<p>最后总结一下，<strong>ShapeR 的核心就是即使数据不全不干净，也可以脑补出完整模型，并且具备精准的尺寸和独立的模型与坐标</strong>。</p>
<p>ShapeR 不是为了替代 Gaussian Splatting 做场景漫游的，它的目标是：当你戴着 AR 眼镜（或拿着手机）扫过房间时，它能把你看到的每一个具体的物体（杯子、椅子、键盘）瞬间变成一个个独立的、有真实尺寸的、完整的 3D 模型，哪怕你只是匆匆扫了一眼。</p>
<p><strong>这就是为什么 Meta 如此重视它，因为这是大概率通往下一代空间计算理解物理世界的关键技术</strong>。</p>
<h2 data-id="heading-3">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebookresearch%2FShapeR" target="_blank" title="https://github.com/facebookresearch/ShapeR" ref="nofollow noopener noreferrer">github.com/facebookres…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零实现企业级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践]]></title>    <link>https://juejin.cn/post/7596342523968028681</link>    <guid>https://juejin.cn/post/7596342523968028681</guid>    <pubDate>2026-01-19T03:38:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596342523968028681" data-draft-id="7596698363933966386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零实现企业级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-19T03:38:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="细雨_吟啸且徐行"/> <meta itemprop="url" content="https://juejin.cn/user/3529879274664043"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零实现企业级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3529879274664043/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    细雨_吟啸且徐行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T03:38:46.000Z" title="Mon Jan 19 2026 03:38:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零实现生产级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践</h2>
<blockquote>
<p>在现代前端开发中，UUID 生成看似简单，但要实现一个<strong>生产级、高兼容性、符合标准</strong>的 UUID 生成器却并不容易。本文将深入解析一个企业级 UUID 生成器的实现，探讨其三层降级策略、兼容性处理和 RFC 4122 标准实现。</p>
</blockquote>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E5%89%8D%E8%A8%80" title="#%E5%89%8D%E8%A8%80">前言：为什么需要自己实现 UUID 生成器？</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0" title="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0">核心实现：三层降级策略</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82" title="#%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82">技术细节深度解析</a></li>
<li><a href="#%E5%85%BC%E5%AE%B9%E6%80%A7%E5%A4%84%E7%90%86" title="#%E5%85%BC%E5%AE%B9%E6%80%A7%E5%A4%84%E7%90%86">兼容性处理的艺术</a></li>
<li><a href="#rfc-4122-%E6%A0%87%E5%87%86" title="#rfc-4122-%E6%A0%87%E5%87%86">RFC 4122 v4 标准实现</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" title="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化与最佳实践</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结与思考</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">前言：为什么需要自己实现 UUID 生成器？</h3>
<p>在现代浏览器中，我们可以直接使用 <code>crypto.randomUUID()</code> 来生成 UUID。但现实情况是：</p>
<ul>
<li><strong>兼容性问题</strong>：<code>crypto.randomUUID()</code> 需要 Chrome 92+、Safari 15.4+，大量旧版浏览器不支持</li>
<li><strong>企业级需求</strong>：需要支持 IE11、旧版移动浏览器等场景</li>
<li><strong>标准合规</strong>：生成的 UUID 必须符合 RFC 4122 v4 标准</li>
<li><strong>可靠性要求</strong>：即使在高并发、异常环境下也要能正常工作</li>
</ul>
<p>因此，我们需要一个<strong>具备完善降级策略</strong>的 UUID 生成器。</p>
<hr/>
<h3 data-id="heading-3">核心实现：三层降级策略</h3>
<p>我们的 UUID 生成器采用了<strong>三层降级策略</strong>，确保在任何环境下都能正常工作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateUUID = (<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 辅助函数：字节转十六进制（兼容 padStart）</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">buffer, start, end</span>) {
    <span class="hljs-keyword">let</span> str = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt; end; i++) {
      <span class="hljs-keyword">const</span> byte = buffer[i];
      <span class="hljs-keyword">const</span> hexStr = byte.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);
      <span class="hljs-comment">// 兼容旧浏览器，不使用 padStart</span>
      str += hexStr.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> ? <span class="hljs-string">'0'</span> + hexStr : hexStr;
    }
    <span class="hljs-keyword">return</span> str;
  }

  <span class="hljs-comment">// 兜底方案：基于时间戳和随机数生成 UUID 格式字符串</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">fallbackUUID</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> random1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    <span class="hljs-keyword">const</span> random2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    <span class="hljs-keyword">const</span> random3 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    <span class="hljs-keyword">const</span> random4 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    
    <span class="hljs-comment">// 格式：xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx (总共36个字符)</span>
    <span class="hljs-comment">// 标准UUID格式：8-4-4-4-12</span>
    <span class="hljs-keyword">return</span> (
      (<span class="hljs-string">'00000000'</span> + (timestamp &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +  <span class="hljs-comment">// 8字符</span>
      <span class="hljs-string">'-'</span> +
      (<span class="hljs-string">'0000'</span> + ((timestamp &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) +  <span class="hljs-comment">// 4字符</span>
      <span class="hljs-string">'-4'</span> +
      (<span class="hljs-string">'000'</span> + (random1 &amp; <span class="hljs-number">0xfff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">3</span>) +              <span class="hljs-comment">// 3字符，加上'4'共4字符</span>
      <span class="hljs-string">'-'</span> +
      (<span class="hljs-string">'8'</span> + (random2 &amp; <span class="hljs-number">0x3fff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) +                <span class="hljs-comment">// 4字符</span>
      <span class="hljs-string">'-'</span> +
      (<span class="hljs-string">'00000000'</span> + (random3 &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +     <span class="hljs-comment">// 8字符</span>
      (<span class="hljs-string">'0000'</span> + (random4 &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>)               <span class="hljs-comment">// 4字符，共12字符</span>
    );
  }

  <span class="hljs-comment">// 优先使用原生实现</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 如果 crypto.randomUUID 抛出异常，降级到备用方案</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>();
      }
    };
  }

  <span class="hljs-comment">// 降级方案：基于 RFC 4122 v4 的强化实现</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 初始化高质量随机数生成器</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomValues</span> = (<span class="hljs-params">buffer</span>) =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">getRandomValues</span>) {
            <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">getRandomValues</span>(buffer);
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-comment">// crypto.getRandomValues 可能抛出异常，继续降级</span>
        }
        
        <span class="hljs-comment">// 终极降级：混合时间戳的 Math.random</span>
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          <span class="hljs-comment">// 安全获取 performance.now()，如果不存在则使用 0</span>
          <span class="hljs-keyword">const</span> perfNow = (<span class="hljs-keyword">typeof</span> performance !== <span class="hljs-string">'undefined'</span> &amp;&amp; performance.<span class="hljs-property">now</span>) 
            ? performance.<span class="hljs-title function_">now</span>() 
            : <span class="hljs-number">0</span>;
          
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-comment">// 混合时间戳熵增强随机性</span>
            <span class="hljs-keyword">const</span> timeEntropy = (now + perfNow) % <span class="hljs-number">1e9</span> / <span class="hljs-number">1e9</span>;
            buffer[i] = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span> + timeEntropy) % <span class="hljs-number">256</span> | <span class="hljs-number">0</span>;
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-comment">// 如果时间戳方法也失败，使用纯 Math.random</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
            buffer[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">256</span>);
          }
        }
        <span class="hljs-keyword">return</span> buffer;
      };

      <span class="hljs-comment">// 检查 Uint8Array 支持</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Uint8Array</span> === <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>();
      }

      <span class="hljs-comment">// 生成 16 字节随机数据 (128位)</span>
      <span class="hljs-keyword">const</span> rnds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">16</span>);
      <span class="hljs-title function_">getRandomValues</span>(rnds);
      
      <span class="hljs-comment">// 应用 RFC 4122 v4 规则 (设置版本和变体)</span>
      rnds[<span class="hljs-number">6</span>] = (rnds[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0x0f</span>) | <span class="hljs-number">0x40</span>; <span class="hljs-comment">// 版本 4</span>
      rnds[<span class="hljs-number">8</span>] = (rnds[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0x3f</span>) | <span class="hljs-number">0x80</span>; <span class="hljs-comment">// 变体 10</span>

      <span class="hljs-comment">// 转换为 UUID 格式字符串</span>
      <span class="hljs-keyword">return</span> (
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">10</span>, <span class="hljs-number">16</span>)
      );
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 所有方法都失败时，返回兜底 UUID</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>();
    }
  };
})();
</code></pre>
<h4 data-id="heading-4">降级策略流程图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────┐
│   crypto<span class="hljs-selector-class">.randomUUID</span>()    │ ← 第一层：现代浏览器（Chrome <span class="hljs-number">92</span>+, Safari <span class="hljs-number">15.4</span>+）
└───────────┬─────────────┘
            │ 失败/不支持
            ▼
┌─────────────────────────┐
│ crypto<span class="hljs-selector-class">.getRandomValues</span>() │ ← 第二层：中等浏览器（IE11+, 大部分现代浏览器）
│   + RFC <span class="hljs-number">4122</span> v4 实现     │
└───────────┬─────────────┘
            │ 失败/不支持
            ▼
┌─────────────────────────┐
│ Math<span class="hljs-selector-class">.random</span>() + 时间戳   │ ← 第三层：兜底方案（任何环境都能工作）
│   + 性能增强             │
└─────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-5">技术细节深度解析</h3>
<h4 data-id="heading-6">1. IIFE 模式：运行时环境检测优化</h4>
<p>使用 <strong>IIFE（立即执行函数表达式）</strong> 模式，在模块加载时只检测一次运行环境，而不是每次调用都检测：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateUUID = (<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 这里的代码只在模块加载时执行一次</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> crypto.<span class="hljs-title function_">randomUUID</span>(); <span class="hljs-comment">// 返回优化后的函数</span>
  }
  <span class="hljs-comment">// ...</span>
})();
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 避免重复的环境检测</li>
<li>✅ 运行时性能最优</li>
<li>✅ 代码更清晰</li>
</ul>
<h4 data-id="heading-7">2. 兼容性处理：手动实现十六进制转换</h4>
<p>现代浏览器可以使用 <code>padStart()</code> 来补零，但为了兼容旧浏览器，我们手动实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">buffer, start, end</span>) {
  <span class="hljs-keyword">let</span> str = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt; end; i++) {
    <span class="hljs-keyword">const</span> byte = buffer[i];
    <span class="hljs-keyword">const</span> hexStr = byte.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);
    <span class="hljs-comment">// 兼容旧浏览器，不使用 padStart</span>
    str += hexStr.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> ? <span class="hljs-string">'0'</span> + hexStr : hexStr;
  }
  <span class="hljs-keyword">return</span> str;
}
</code></pre>
<p><strong>为什么这样做？</strong></p>
<ul>
<li><code>padStart()</code> 需要 ES2017 支持（IE11 不支持）</li>
<li>手动实现兼容性更好，代码量也很少</li>
</ul>
<h4 data-id="heading-8">3. RFC 4122 v4 标准实现</h4>
<p>UUID v4 要求：</p>
<ul>
<li><strong>版本位</strong>：第 13 个字符必须是 <code>4</code></li>
<li><strong>变体位</strong>：第 17 个字符必须是 <code>8</code>、<code>9</code>、<code>a</code> 或 <code>b</code></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成 16 字节随机数据 (128位)</span>
<span class="hljs-keyword">const</span> rnds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">16</span>);
<span class="hljs-title function_">getRandomValues</span>(rnds);

<span class="hljs-comment">// 应用 RFC 4122 v4 规则</span>
rnds[<span class="hljs-number">6</span>] = (rnds[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0x0f</span>) | <span class="hljs-number">0x40</span>; <span class="hljs-comment">// 版本 4：设置第 7 字节的高 4 位为 0100</span>
rnds[<span class="hljs-number">8</span>] = (rnds[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0x3f</span>) | <span class="hljs-number">0x80</span>; <span class="hljs-comment">// 变体 10：设置第 9 字节的高 2 位为 10</span>

<span class="hljs-comment">// 转换为 UUID 格式字符串：xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx</span>
<span class="hljs-keyword">return</span> (
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>) + <span class="hljs-string">'-'</span> +   <span class="hljs-comment">// 8 字符</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>) + <span class="hljs-string">'-'</span> +   <span class="hljs-comment">// 4 字符</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>) + <span class="hljs-string">'-'</span> +   <span class="hljs-comment">// 4 字符（包含版本位 4）</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>) + <span class="hljs-string">'-'</span> +  <span class="hljs-comment">// 4 字符（包含变体位）</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">10</span>, <span class="hljs-number">16</span>)         <span class="hljs-comment">// 12 字符</span>
);
</code></pre>
<p><strong>位运算解析</strong>：</p>
<ul>
<li><code>rnds[6] &amp; 0x0f</code>：保留低 4 位</li>
<li><code>| 0x40</code>：设置高 4 位为 <code>0100</code>（版本 4）</li>
<li><code>rnds[8] &amp; 0x3f</code>：保留低 6 位</li>
<li><code>| 0x80</code>：设置高 2 位为 <code>10</code>（变体标识）</li>
</ul>
<hr/>
<h3 data-id="heading-9">兼容性处理的艺术</h3>
<h4 data-id="heading-10">1. 渐进式降级：从最佳到兜底</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomValues</span> = (<span class="hljs-params">buffer</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 优先：使用 Web Crypto API</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">getRandomValues</span>) {
      <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">getRandomValues</span>(buffer);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// crypto.getRandomValues 可能抛出异常，继续降级</span>
  }
  
  <span class="hljs-comment">// 降级：混合时间戳增强随机性</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> perfNow = (<span class="hljs-keyword">typeof</span> performance !== <span class="hljs-string">'undefined'</span> &amp;&amp; performance.<span class="hljs-property">now</span>) 
      ? performance.<span class="hljs-title function_">now</span>() 
      : <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 混合时间戳熵增强随机性</span>
      <span class="hljs-keyword">const</span> timeEntropy = (now + perfNow) % <span class="hljs-number">1e9</span> / <span class="hljs-number">1e9</span>;
      buffer[i] = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span> + timeEntropy) % <span class="hljs-number">256</span> | <span class="hljs-number">0</span>;
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 终极降级：纯 Math.random</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
      buffer[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">256</span>);
    }
  }
  <span class="hljs-keyword">return</span> buffer;
};
</code></pre>
<h4 data-id="heading-11">2. 兜底方案：基于时间戳的 UUID</h4>
<p>当所有现代 API 都不可用时，使用时间戳 + 随机数生成 UUID 格式字符串：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fallbackUUID</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">const</span> random1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  <span class="hljs-keyword">const</span> random2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  <span class="hljs-keyword">const</span> random3 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  <span class="hljs-keyword">const</span> random4 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  
  <span class="hljs-comment">// 格式：xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx</span>
  <span class="hljs-keyword">return</span> (
    (<span class="hljs-string">'00000000'</span> + (timestamp &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +
    <span class="hljs-string">'-'</span> +
    (<span class="hljs-string">'0000'</span> + ((timestamp &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) +
    <span class="hljs-string">'-4'</span> + <span class="hljs-comment">// 版本位</span>
    (<span class="hljs-string">'000'</span> + (random1 &amp; <span class="hljs-number">0xfff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">3</span>) +
    <span class="hljs-string">'-'</span> +
    (<span class="hljs-string">'8'</span> + (random2 &amp; <span class="hljs-number">0x3fff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) + <span class="hljs-comment">// 变体位</span>
    <span class="hljs-string">'-'</span> +
    (<span class="hljs-string">'00000000'</span> + (random3 &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +
    (<span class="hljs-string">'0000'</span> + (random4 &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>)
  );
}
</code></pre>
<p><strong>注意</strong>：虽然这个方案在极端环境下也能工作，但随机性不如 <code>crypto.getRandomValues()</code>，不建议在生产环境长期使用。</p>
<hr/>
<h3 data-id="heading-12">RFC 4122 v4 标准实现</h3>
<h4 data-id="heading-13">UUID 格式说明</h4>
<p>标准 UUID v4 格式：<code>xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx</code></p>
<ul>
<li><strong>x</strong>：十六进制数字（0-9, a-f）</li>
<li><strong>4</strong>：版本号（固定）</li>
<li><strong>y</strong>：变体标识（8, 9, a, b 之一）</li>
</ul>
<h4 data-id="heading-14">版本位和变体位的设置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 字节数组索引对应关系：</span>
<span class="hljs-comment">// [0-3]   [4-5]   [6-7]   [8-9]   [10-15]</span>
<span class="hljs-comment">//  8位     4位     4位     4位      12位</span>

rnds[<span class="hljs-number">6</span>] = (rnds[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0x0f</span>) | <span class="hljs-number">0x40</span>; 
<span class="hljs-comment">// 第 7 字节：保留低 4 位，设置高 4 位为 0100（版本 4）</span>

rnds[<span class="hljs-number">8</span>] = (rnds[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0x3f</span>) | <span class="hljs-number">0x80</span>; 
<span class="hljs-comment">// 第 9 字节：保留低 6 位，设置高 2 位为 10（变体标识）</span>
</code></pre>
<p><strong>为什么是 <code>0x40</code> 和 <code>0x80</code>？</strong></p>
<ul>
<li><code>0x40</code> = <code>0100 0000</code>（二进制），设置版本位为 4</li>
<li><code>0x80</code> = <code>1000 0000</code>（二进制），设置变体位为 10</li>
</ul>
<hr/>
<h3 data-id="heading-15">性能优化与最佳实践</h3>
<h4 data-id="heading-16">1. 避免重复检测</h4>
<p>使用 IIFE 模式，在模块加载时检测一次环境，运行时直接调用优化后的函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不好的做法：每次调用都检测</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateUUID</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
  }
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ✅ 好的做法：只检测一次</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateUUID = (<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> crypto.<span class="hljs-title function_">randomUUID</span>(); <span class="hljs-comment">// 返回优化后的函数</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 降级实现 */</span> };
})();
</code></pre>
<h4 data-id="heading-17">2. 错误处理策略</h4>
<p>多层 try-catch 确保即使某个 API 抛出异常，也能降级到下一层：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>(); <span class="hljs-comment">// 降级</span>
}
</code></pre>
<h4 data-id="heading-18">3. 类型检查优化</h4>
<p>使用 <code>typeof</code> 检查而不是直接访问，避免在旧环境中抛出 <code>ReferenceError</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 安全的方式</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">randomUUID</span>) {
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ❌ 不安全的方式（旧浏览器可能报错）</span>
<span class="hljs-keyword">if</span> (crypto.<span class="hljs-property">randomUUID</span>) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-19">总结与思考</h3>
<h4 data-id="heading-20">核心亮点</h4>
<ol>
<li><strong>三层降级策略</strong>：从现代 API 到兜底方案，确保任何环境都能工作</li>
<li><strong>标准合规</strong>：完全符合 RFC 4122 v4 标准</li>
<li><strong>兼容性优先</strong>：不使用现代 API（如 <code>padStart</code>），手动实现兼容性更好的版本</li>
<li><strong>性能优化</strong>：使用 IIFE 模式，避免重复检测</li>
<li><strong>错误处理</strong>：完善的异常捕获机制</li>
</ol>
<h4 data-id="heading-21">适用场景</h4>
<ul>
<li>✅ 需要支持旧版浏览器的企业级项目</li>
<li>✅ 对 UUID 标准有严格要求的生产环境</li>
<li>✅ 需要高可靠性的分布式系统</li>
<li>✅ 前端 SDK 或工具库开发</li>
</ul>
<h4 data-id="heading-22">进一步优化建议</h4>
<ol>
<li><strong>添加单元测试</strong>：确保各种环境下的正确性</li>
<li><strong>性能基准测试</strong>：对比不同实现的性能</li>
<li><strong>添加 TypeScript 类型定义</strong>：提升开发体验</li>
<li><strong>考虑使用 Web Workers</strong>：在高频调用场景下避免阻塞主线程</li>
</ol>
<h4 data-id="heading-23">写在最后</h4>
<p>实现一个<strong>看似简单</strong>的功能，往往需要考虑到：</p>
<ul>
<li>🔍 <strong>兼容性</strong>：支持各种浏览器环境</li>
<li>🛡️ <strong>可靠性</strong>：完善的错误处理和降级策略</li>
<li>📏 <strong>标准性</strong>：符合行业标准规范</li>
<li>⚡ <strong>性能</strong>：避免不必要的开销</li>
</ul>
<p>这就是<strong>工程化思维</strong>的体现：不仅要实现功能，更要实现<strong>高质量、可维护、可扩展</strong>的代码。</p>
<hr/>
<h3 data-id="heading-24">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc4122" target="_blank" title="https://tools.ietf.org/html/rfc4122" ref="nofollow noopener noreferrer">RFC 4122 - UUID 标准规范</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FCrypto%2FrandomUUID" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Crypto/randomUUID" ref="nofollow noopener noreferrer">MDN - crypto.randomUUID()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FCrypto%2FgetRandomValues" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Crypto/getRandomValues" ref="nofollow noopener noreferrer">MDN - crypto.getRandomValues()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2Fmdn-api_crypto_randomuuid" target="_blank" title="https://caniuse.com/mdn-api_crypto_randomuuid" ref="nofollow noopener noreferrer">Can I Use - crypto.randomUUID</a></li>
</ul>
<hr/>
<p><strong>如果这篇文章对你有帮助，欢迎点赞、收藏、转发！</strong> 🚀</p>
<p><strong>关注我，获取更多前端技术深度解析！</strong> 💡</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[图文]手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程]]></title>    <link>https://juejin.cn/post/7596768867231760403</link>    <guid>https://juejin.cn/post/7596768867231760403</guid>    <pubDate>2026-01-19T05:43:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596768867231760403" data-draft-id="7596768867231727635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[图文]手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程"/> <meta itemprop="keywords" content="程序员,人工智能"/> <meta itemprop="datePublished" content="2026-01-19T05:43:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洪哥等风来"/> <meta itemprop="url" content="https://juejin.cn/user/3562073402390749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [图文]手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073402390749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洪哥等风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T05:43:41.000Z" title="Mon Jan 19 2026 05:43:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>视频版配套教程可以跳转：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1vvitBfEKv" target="_blank" title="https://www.bilibili.com/video/BV1vvitBfEKv" ref="nofollow noopener noreferrer">《手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程》</a></p>
<h2 data-id="heading-0">一、安装/升级 反代工具CLIProxyAPI</h2>
<h4 data-id="heading-1">Windows</h4>
<p>直接下载最新的文件，解压后就能使用，如果有更新，也是从这个链接中查找就行。</p>
<p>比如写文章时的最新版为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frouter-for-me%2FCLIProxyAPI%2Freleases%2Fdownload%2Fv6.6.84%2FCLIProxyAPI_6.6.84_windows_amd64.zip" target="_blank" title="https://github.com/router-for-me/CLIProxyAPI/releases/download/v6.6.84/CLIProxyAPI_6.6.84_windows_amd64.zip" ref="nofollow noopener noreferrer">CLIProxyAPI_6.6.84_windows_amd64.zip</a></p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/router-for-me/CLIProxyAPI/releases
</code></pre>
<p>本教程中我解压到了<code>D:\Tools\CLIProxyAPI_6.6.84_windows_amd64</code> 目录下，你可以解压到自己需要的目录，路径要全英文的，并且不能有空格。</p>
<h4 data-id="heading-2">Ubuntu/Linux</h4>
<p>使用一键脚本安装或升级，都用这个命令就行</p>
<pre><code class="hljs language-ruby" lang="ruby">curl -fsSL <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/raw.githubusercontent.com/brokechubb</span><span class="hljs-regexp">/cliproxyapi-installer/refs</span><span class="hljs-regexp">/heads/master</span><span class="hljs-regexp">/cliproxyapi-installer | bash
</span></code></pre>
<h4 data-id="heading-3">MacOS</h4>
<p>使用brew安装命令</p>
<pre><code class="hljs">brew install cliproxyapi
</code></pre>
<p>后续升级命令</p>
<pre><code class="hljs">brew upgrade cliproxyapi
</code></pre>
<h2 data-id="heading-4">二、修改配置文件，启用后台管理</h2>
<h4 data-id="heading-5">Windows</h4>
<p>安装目录下把<code>config.example.yaml</code>复制一份，复制的改名为<code>config.yaml</code>，然后修改里面的内容。</p>
<h4 data-id="heading-6">Ubuntu/Linux</h4>
<p>家(Home)目录下找<code>cliproxyapi/config.yaml</code>，即<code>~/cliproxyapi/config.yaml</code>，然后修改里面的内容。</p>
<h4 data-id="heading-7">MacOS</h4>
<p><code>/opt/homebrew/etc</code>目录下找<code>cliproxyapi.conf</code>，即绝对路径为：<code>/opt/homebrew/etc/cliproxyapi.conf</code>，然后修改里面的内容。</p>
<h4 data-id="heading-8">修改文件如下内容(登录密码最好改成你自己的，我这里设置的是my-password)</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">allow-remote: <span class="hljs-literal">true</span>
secret-<span class="hljs-keyword">key</span>: <span class="hljs-string">"my-password"</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171f47b3de934915afe0f80d0ea5c1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=DGOsCTQfNAuK1We7%2FphReonJsdk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">三、 启动CLIProxyAPI， 并登录网页后台查看：</h2>
<h4 data-id="heading-10">Windows</h4>
<p>进入到刚才解压后的目录下直接exe执行就可以了，比如我刚才安装到了<code>D:\Tools\CLIProxyAPI_6.6.84_windows_amd64</code> 下。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6352f72f4d794adf8a72680cd87f254a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=PhJUBfn%2B%2FAaNS2e0%2FFQzNp0QxKc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-11">Ubuntu/Linux</h4>
<p>进入到<code>~/cliproxyapi/</code>目录后，启动。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/cliproxyapi/
./cli-proxy-api 
</code></pre>
<h4 data-id="heading-12">MacOS</h4>
<p>不需要进入任何目录，直接启动即可。</p>
<pre><code class="hljs">brew services restart cliproxyapi
</code></pre>
<h4 data-id="heading-13">登录网页后台</h4>
<p>注意地址，本机的直接访问右边这个地址就行，首次登录密码是刚才设置的 my-password ：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8317%2Fmanagement.html" target="_blank" title="http://localhost:8317/management.html" ref="nofollow noopener noreferrer">http://localhost:8317/management.html</a>
服务器的话要填服务器的地址或域名，比如你部署到了服务器的ip是<code>1.2.3.4</code>，则访问：<code>http://1.2.3.4:8317/management.html</code>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2368c977d9ec48cfad976acb8ac36745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=YMFqu1rwLrS%2BjFv%2BhjXItqrKCvo%3D" alt="在这里插入图片描述" loading="lazy"/>
登录后台成功后，可以看到仪表盘。建议把使用统计打开，这样后面用模型我能能看到用了多少的Tokens。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbbd7aa6769415786f449309109f0fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=HXFvhPNOaQ6Dco4zeUpaeg9W%2BDQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-14">四、从网页登录Antigravity，成功后拷贝网址:</h2>
<p>按照图示登录Antigravity，并等待自动认证成功，认证成功后登录网页会自动关闭。
如果登录界面没有自动关闭(如图)，需要你手动把登录成功的网址复制粘贴回来，然后手动点击<code>提交回调URL</code>。
如果还登录不上，可以尝试重启机器，然后别的软件先别开，这时打开反代服务 + 开启TUN魔法 + 挂到美国IP，再登录下试试。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a17cb14eb97a43f5934f29b6b5bbfeee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=uBv7cl1CLA6jzehTJES5SuOS2qY%3D" alt="在这里插入图片描述" loading="lazy"/>
你还可以登录Gemini CLI ，这样就有更多的Gemini额度了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c214da7e5757472fac911141e01037d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=zVra4LgibS%2FCj66JF69fQL10Qm4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>登录认证成功后，后台就能看到认证信息了。我这里即反代了Antigravity，也反代了Gemini CLI, 如图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74532cfa2b6944ef97e05a2c48537d0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=OBPVBkXlbW%2BjKx0bl8%2Fmf6Lm9WY%3D" alt="在这里插入图片描述" loading="lazy"/>
反代出来的模型，可以在<code>中心信息</code>中查看到。后面使用模型时，需要来这里复制模型名，不能随便写模型名。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/000fe28e26a942408f0a328fdee3978b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=Uo%2Fq60k10bt2KrzpV35Z9PfPR4A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-15">五、Claude Code中使用</h2>
<h4 data-id="heading-16">从网页后台获取api key，配置claude</h4>
<p>注意<code>your-api-key-1</code>要配置成网页后台中的真正的api key，我这里演示的是默认的。
模型的名称也要从网页后台拷贝，不要自己手写。
base url 填写为 <code>"http://localhost:8317"</code>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90e6d33b083946459e7c6f517664bce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=KWK2W1L0l%2BH3QG8beNCAY%2FmuiOo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8317"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-api-key-1"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_DEFAULT_OPUS_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-opus-4-5-thinking"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_DEFAULT_SONNET_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-sonnet-4-5-thinking"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_DEFAULT_HAIKU_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-sonnet-4-5"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-opus-4-5-thinking"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_SMALL_FAST_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-sonnet-4-5-thinking"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<h2 data-id="heading-17">六、其它OpenAI兼容接口中使用</h2>
<p>注意！base url 要改为： <code>http://localhost:8317/v1</code>
api key 和模型名和刚才一样，从网页后台复制就行了。
vscode中可以通过<code>oai</code>插件(<code>OAI Compatible Provider for Copilot</code>)来添加到copilot中。</p>
<h2 data-id="heading-18">Q&amp;A</h2>
<h3 data-id="heading-19">Q1：有没有被封号的风险？</h3>
<p>我在各个社区中还没看到有被封的(仅针对个人用户)。不过仍不建议用自己的大号搞，因为确实逆向了有风险，建议用小号搞吧。</p>
<h3 data-id="heading-20">Q2：需要Google AI会员吗?</h3>
<p>免费版的每周都有额度，但是额度很少，可以先试一下，把流程跑通了。付费会员或教育优惠会员，都是每5小时刷新额度，自己用一般是足够的，并且Gemin Pro\Gemini Flash\Claude这三组额度是独立的。
然后可以考虑某鱼上买个成品号，关键字:<code>geminipro一年</code>，20左右(不知道最近涨价没)。</p>
<h3 data-id="heading-21">Q3：我高强度使用，5小时额度不够怎么办啊？</h3>
<p>最快速的是把谷歌的Gemini CLI工具也反代了，这个工具中只有Gemini系列的模型，并且额度和Antigravity中的不互通，是独立的。</p>
<p>其次有个被社区称为<code>升天</code>的方法：其实就是家庭组，Pro账号可以邀请最多5个人进入家庭(算上自己共6人)。家庭里每个账号的Antigravity和Gemini CLI的额度是独立的，所以可以创建几个小号，来组建家庭后把小号也反代了。</p>
<p>最后，还是那句话，不建议用自己的主号这么搞，最好拿某鱼买的号来搞。</p>
<h3 data-id="heading-22">Q4：API KEY(API 密钥)是怎么生成的，从哪里拿？</h3>
<p>API KEY在我们安装时，配置文件中会默认携带2个，你可以从网页上直接编辑-复制后使用。也可以在网页上把这两个KEY修改掉，或者自己新建后使用。</p>
<h3 data-id="heading-23">Q5：OAI插件是什么？</h3>
<p>OAI插件是搭配vscode copilot使用的，因为官方的copilot不支持自定义的模型和地址，所以需要这个插件来实现。</p>
<h3 data-id="heading-24">Q6：OAI安装后没有右下角的 Ready显示怎么办？</h3>
<p>首次安装后可以按 <code>Ctrl</code> + <code>Shift</code> + <code>P</code>，然后输入<code>oai</code>关键字，点击<code>Open Configuration UI</code>进入。</p>
<h3 data-id="heading-25">Q7：OAI配置好了地址和模型，从copilot中访问失败怎么办？</h3>
<p>大概率是地址配置错误，记得OpenAI格式的请求都需要加上<code>/v1</code>后缀，比如<code>http://10.126.12.162:8317/v1</code>。</p>
<h3 data-id="heading-26">Q8: Windows上第二天就不能用了，访问不到模型了？</h3>
<p>可能是关机了，或CLIProxyAPI被关掉了，然后反代的登录信息就失效了，下次开机或启动后，还需要重新登陆以下。
如果是在服务器上部署的，并且一直执行，是不会失效的，因为CLIProxyAPI会周期性的去刷新下登录信息，保持一直登陆的状态。</p>
<h3 data-id="heading-27">Q9: 能用Nano Banana Pro画图吗？</h3>
<p>可以的，接入自己的画图工具就行了。有限额，但具体多少我不太清楚了。
比如群友有使用CherryStudio的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cherry-ai.com%2Fdownload" target="_blank" title="https://www.cherry-ai.com/download" ref="nofollow noopener noreferrer">www.cherry-ai.com/download</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Huobao Drama 开源短剧生成平台：从剧本到视频]]></title>    <link>https://juejin.cn/post/7596790037097201727</link>    <guid>https://juejin.cn/post/7596790037097201727</guid>    <pubDate>2026-01-19T03:32:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596790037097201727" data-draft-id="7596639774266834986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Huobao Drama 开源短剧生成平台：从剧本到视频"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-19T03:32:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ahubbub"/> <meta itemprop="url" content="https://juejin.cn/user/2999123451061160"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Huobao Drama 开源短剧生成平台：从剧本到视频
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123451061160/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ahubbub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T03:32:03.000Z" title="Mon Jan 19 2026 03:32:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Huobao Drama 开源短剧生成平台：从剧本到视频</h2>
<h2 data-id="heading-1">Huobao Drama</h2>
<p>一句话简介：一个基于 Go + Vue3 的全栈 AI 短剧自动化生产平台，覆盖“剧本解析 → 角色/分镜生成 → 视频合成”的一站式流程。</p>
<p>适用场景（可选）：</p>
<ul>
<li>想快速验证“短剧生成工作流”的产品/技术原型（偏全链路演示）</li>
<li>需要一个可自建的 AI 素材/分镜/视频任务管理后台（本地存储 + SQLite）</li>
<li>自己有模型/聚合 API（OpenAI 兼容/火山/本地 Ollama 等），希望接到可用的 Web 界面里跑通</li>
</ul>
<h2 data-id="heading-2">二、开源协议</h2>
<ul>
<li>CC BY-NC-SA 4.0（署名-非商业性使用-相同方式共享），以仓库 <code>LICENSE</code> 为准</li>
<li>备注：该协议限制商业用途；如需商业使用，README/许可证中给了作者联系方式（以仓库信息为准）</li>
</ul>
<h2 data-id="heading-3">三、界面展示</h2>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img4@main/2026/01/19/1768792890091-d6d4508e-d9cc-456c-88ff-87c5792660c3.png" alt="主界面" loading="lazy"/></p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img2@main/2026/01/19/1768792987694-530000b6-2996-4819-a4f4-990f9a8b0b27.png" alt="项目界面" loading="lazy"/></p>
<h2 data-id="heading-4">四、功能概述</h2>
<h3 data-id="heading-5">1）角色管理</h3>
<ul>
<li>是什么：对短剧角色形象进行生成与管理</li>
<li>怎么做：
<ul>
<li>支持 AI 生成角色形象</li>
<li>支持批量生成</li>
<li>支持角色图片上传与管理</li>
</ul>
</li>
<li>注意事项（可选）：
<ul>
<li>图片生成依赖外部 AI 服务（默认 Provider 在配置中可选，但具体 Key 一般在 Web 界面配置；以仓库文档为准）</li>
<li>生成图片的存储默认走本地存储目录（见 <code>configs/config.yaml</code> 的 <code>storage</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">2）分镜制作（脚本/镜头/图片）</h3>
<ul>
<li>是什么：从剧本/描述拆解出分镜，并为分镜生成图片</li>
<li>怎么做：
<ul>
<li>自动生成分镜脚本</li>
<li>场景描述与镜头设计</li>
<li>分镜图片生成（文生图）</li>
<li>帧类型选择：首帧/关键帧/尾帧/分镜板</li>
</ul>
</li>
<li>注意事项（可选）：
<ul>
<li>仍然依赖外部文生图服务；如果你用的是本地模型，需确认接口是否 OpenAI 兼容，并保证容器/宿主机网络可达（见 <code>DOCKER_HOST_ACCESS.md</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">3）视频生成（图生视频 + 合成剪辑）</h3>
<ul>
<li>是什么：把分镜图转成分镜视频，并进行合成/转场</li>
<li>怎么做：
<ul>
<li>图生视频自动生成</li>
<li>视频合成与剪辑</li>
<li>转场效果</li>
</ul>
</li>
<li>外部依赖必须说明：
<ul>
<li>FFmpeg：项目明确要求 <code>FFmpeg 4.0+</code>，用于视频处理（本地跑需要自己安装；Docker 镜像里已安装 <code>ffmpeg</code>，见 <code>Dockerfile</code>）</li>
<li>视频生成模型/服务：配置中的 <code>ai.default_video_provider</code> 默认为 <code>doubao</code>（火山相关能力），具体调用方式与 Key 配置以仓库实现/界面为准</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">4）资源管理与任务追踪</h3>
<ul>
<li>是什么：统一管理生成的素材，并跟踪任务进度</li>
<li>怎么做：
<ul>
<li>素材库统一管理</li>
<li>本地存储支持</li>
<li>资源导入导出</li>
<li>任务进度追踪</li>
</ul>
</li>
<li>注意事项（可选）：
<ul>
<li>数据库存储默认使用 SQLite（见 <code>configs/config.example.yaml</code>）</li>
<li>静态资源访问基于 <code>storage.base_url</code> 拼接（默认 <code>http://localhost:5678/static</code>），反代/换域名时要一起调整</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">五、技术选型</h2>
<ul>
<li>后端：<code>Go 1.23+ · Gin · GORM · SQLite(含 modernc.org/sqlite) · Zap · Viper</code></li>
<li>前端：<code>Vue 3.4+ · TypeScript · Vite 5 · Element Plus · TailwindCSS · Pinia · Vue Router · vue-i18n · Axios</code></li>
<li>数据：<code>SQLite</code>（默认），配置里也出现 <code>gorm.io/driver/mysql</code> 依赖（是否启用 MySQL 以代码/文档为准）</li>
<li>可观测/日志：<code>Zap</code>（仓库依赖显示）</li>
<li>容器化：<code>Docker 多阶段构建（Node 20 + Go 1.23-alpine + alpine runtime） · docker-compose</code></li>
<li>媒体处理：<code>FFmpeg</code>（必需）</li>
</ul>
<h2 data-id="heading-10">六、如何使用</h2>
<blockquote>
<p>运行前准备（所有方式通用）</p>
</blockquote>
<ul>
<li>如果你本机手动运行（非 Docker）：先安装 <code>ffmpeg</code>，并确保 <code>ffmpeg -version</code> 可用</li>
<li>AI 能力需要配置供应商与 Key：配置文件里仅指定默认 provider，具体 API Key 通常在 Web 界面里配置（以实际界面/仓库文档为准）</li>
<li>默认端口：
<ul>
<li>后端/API：<code>5678</code></li>
<li>前端开发服务器：<code>3012</code>（仅开发模式，见 <code>web/vite.config.ts</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">方式一：Docker</h3>
<p>仓库 README 给了两种 Docker 跑法：Docker Hub 直接跑，或本地构建后跑。这里按 README 原样整理可复制命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接运行（Docker Hub）</span>
docker run -d \
  --name huobao-drama \
  -p 5678:5678 \
  -v $(<span class="hljs-built_in">pwd</span>)/data:/app/data \
  --restart unless-stopped \
  huobao/huobao-drama:latest
</code></pre>
<ul>
<li>数据目录与挂载路径：
<ul>
<li>宿主机：<code>$(pwd)/data</code></li>
<li>容器内：<code>/app/data</code>（SQLite DB + storage 都在这下面，具体以运行后生成内容为准）</li>
</ul>
</li>
<li>访问：
<ul>
<li><code>http://localhost:5678</code></li>
</ul>
</li>
<li>重要说明（Linux）：
<ul>
<li>如果容器内要访问宿主机的 Ollama/本地模型，需加：<code>--add-host=host.docker.internal:host-gateway</code>（详见 <code>DOCKER_HOST_ACCESS.md</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">方式二：Docker Compose（推荐）</h3>
<p>项目自带 <code>docker-compose.yml</code>（包含 healthcheck、命名卷、extra_hosts），最省事：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动</span>
docker-compose up -d

<span class="hljs-comment"># 看日志</span>
docker-compose logs -f

<span class="hljs-comment"># 停止</span>
docker-compose down
</code></pre>
<ul>
<li>默认端口：<code>5678:5678</code></li>
<li>数据持久化：使用命名卷 <code>huobao-data:/app/data</code>（见 <code>docker-compose.yml</code>）</li>
<li>自定义配置文件：
<ul>
<li>compose 里预留了挂载（默认注释掉）：<code>./configs/config.yaml:/app/configs/config.yaml:ro</code></li>
<li>你需要先准备 <code>configs/config.yaml</code>（可从示例复制）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">方式三：手动构建（前端/后端）</h3>
<h4 data-id="heading-14">1）拉代码 + 准备配置</h4>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/chatfire-AI/huobao-drama.git
<span class="hljs-built_in">cd</span> huobao-drama

<span class="hljs-built_in">cp</span> configs/config.example.yaml configs/config.yaml
</code></pre>
<p><code>configs/config.yaml</code> 关键项（示例来自仓库，敏感信息不在这里）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">5678</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"0.0.0.0"</span>
  <span class="hljs-attr">cors_origins:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"http://localhost:3012"</span>

<span class="hljs-attr">database:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"sqlite"</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">"./data/drama_generator.db"</span>

<span class="hljs-attr">storage:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"local"</span>
  <span class="hljs-attr">local_path:</span> <span class="hljs-string">"./data/storage"</span>
  <span class="hljs-attr">base_url:</span> <span class="hljs-string">"http://localhost:5678/static"</span>

<span class="hljs-attr">ai:</span>
  <span class="hljs-attr">default_text_provider:</span> <span class="hljs-string">"openai"</span>
  <span class="hljs-attr">default_image_provider:</span> <span class="hljs-string">"openai"</span>
  <span class="hljs-attr">default_video_provider:</span> <span class="hljs-string">"doubao"</span>
</code></pre>
<h4 data-id="heading-15">2）开发模式（前后端分离，热更新）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 终端 1：后端</span>
go mod download
go run main.go
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 终端 2：前端</span>
<span class="hljs-built_in">cd</span> web
npm install
npm run dev
</code></pre>
<ul>
<li>前端：<code>http://localhost:3012</code></li>
<li>后端：<code>http://localhost:5678</code></li>
<li>代理规则：前端会把 <code>/api</code> 转发到 <code>http://localhost:5678</code>（见 <code>web/vite.config.ts</code>）</li>
</ul>
<h4 data-id="heading-16">3）单服务模式（后端同时提供前端静态文件）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> web
npm install
npm run build
<span class="hljs-built_in">cd</span> ..

go run main.go
</code></pre>
<ul>
<li>访问：<code>http://localhost:5678</code></li>
</ul>
<h2 data-id="heading-17">七、二次开发注意事项</h2>
<ul>
<li>环境依赖版本（从仓库文件推断）：
<ul>
<li>Go：<code>1.23+</code>（见 <code>go.mod</code>）</li>
<li>Node.js：README 写 <code>18+</code>；<code>Dockerfile</code> 使用 <code>node:20-alpine</code>（本地用 18/20 通常都可，最终以你依赖安装结果为准）</li>
<li>FFmpeg：<code>4.0+</code>（必需）</li>
</ul>
</li>
<li>本地开发启动方式：
<ul>
<li>后端：<code>go run main.go</code></li>
<li>前端：<code>npm run dev</code>（默认 <code>3012</code>），并代理 <code>/api -&gt; 5678</code></li>
</ul>
</li>
<li>常见问题
<ul>
<li>SQLite 只读/写权限：生产机用 systemd 部署时，确保运行用户对 <code>data/</code> 目录与 DB 文件都有写权限；否则可能出现 <code>attempt to write a readonly database</code>（README 给了排查与修复命令）</li>
<li>Docker 访问宿主机模型：统一用 <code>http://host.docker.internal:&lt;port&gt;/v1</code>，Linux 下需要 <code>host-gateway</code> 映射（见 <code>DOCKER_HOST_ACCESS.md</code> 与 <code>docker-compose.yml</code> 的 <code>extra_hosts</code>）</li>
<li>跨域/前端连不上后端：检查 <code>configs/config.yaml</code> 的 <code>server.cors_origins</code> 是否包含你的前端地址；开发模式代理在 <code>web/vite.config.ts</code></li>
</ul>
</li>
</ul>
<h2 data-id="heading-18">八、目录结构与主要文件</h2>
<pre><code class="hljs language-text" lang="text">huobao-drama/
├── main.go                    # 后端入口
├── go.mod                     # Go 依赖与版本（Go 1.23）
├── Dockerfile                 # 多阶段构建（前端 build + 后端 build + runtime 含 ffmpeg）
├── docker-compose.yml         # Compose 一键启动（含 healthcheck/volume/extra_hosts）
├── configs/
│   └── config.example.yaml    # 配置示例（复制为 config.yaml 使用）
├── api/                       # API 层（Gin HTTP，按 README 的分层说明）
├── application/               # 应用服务层（业务编排）
├── domain/                    # 领域层（模型/领域逻辑）
├── infrastructure/            # 基础设施层（DB/外部服务等）
├── migrations/                # 迁移相关（README 说明首次启动会自动建表）
├── pkg/                       # 通用包/工具代码
└── web/                       # 前端（Vue3 + Vite）
    ├── package.json           # 前端依赖与脚本
    └── vite.config.ts         # dev server(3012) + /api 代理到 5678
</code></pre>
<h2 data-id="heading-19">九、源码地址</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchatfire-AI%2Fhuobao-drama" target="_blank" title="https://github.com/chatfire-AI/huobao-drama" ref="nofollow noopener noreferrer">github.com/chatfire-AI…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动]]></title>    <link>https://juejin.cn/post/7596245612558319625</link>    <guid>https://juejin.cn/post/7596245612558319625</guid>    <pubDate>2026-01-18T23:21:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596245612558319625" data-draft-id="7596181746083217458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动"/> <meta itemprop="keywords" content="Flutter,Android,前端"/> <meta itemprop="datePublished" content="2026-01-18T23:21:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-18T23:21:16.000Z" title="Sun Jan 18 2026 23:21:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>又是一个小问题可能带来的大改动，感觉官方在评估的时候，有点过分细节了。</p>
<p>这个问题来自去年底的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F179482" target="_blank" title="https://github.com/flutter/flutter/issues/179482" ref="nofollow noopener noreferrer">#179482</a> issue ，Flutter 在 iOS 26 上，某些场景会因为出现半透明键盘，而页面底下本来应该被键盘遮挡的 Widget，由于默认没有被绘制，从而出现键盘背景颜色 UI 异常：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/960cf9e2a42f407dac6a4eb5aafe6af4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=tRkOay%2Fo%2BALX8RVRE3sgp2I%2F%2FXM%3D" alt="" loading="lazy"/></p>
<p>虽然问题看起来是一个圆角问题，但是实际上这是 <strong>iOS 26 系统键盘增加了“半透明”后带来的问题，Flutter 在键盘后面那一层在某些场景下没有正确渲染内容</strong>，导致键盘半透明区域透出来的不是底下 BottomSheet 的真实内容，而是一整块黑色区域。</p>
<blockquote>
<p>issue 提到问题，问题最明显的场景主要出现在 iOS 26 的 <code>showModalBottomSheet()</code> 下。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69a144886c414be3b6e47305a8eb2acd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=D13kmUfKTbIaHLDDcKlqxIe5nXY%3D" alt="" loading="lazy"/></p>
<p>为什么会这样？首先就是你的 App 目前是否使用了最新 Xcode 26 ，以及在 <code>Info.plist</code> 里有没有使用 <code>UIDesignRequiresCompatibility = YES</code> 让 App <strong>继续使用旧的系统设计风格</strong> ：</p>









<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d228c8699cf84bb7a40ff83d84e7d548~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=qA5pgOEtDcAkTEiihO8DTVksfMs%3D" alt="8b13916c1c0c6339201a1a9f3e797b2e" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ea0a6de3c74a58a4eebc509e328332~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=BLnidBWTHY2VKPJ3kDfQnTPmRJ4%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55ea18421a364e35b2dfb93338160e34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=rrzTcCREi89B%2F%2FLdsGeVaGADK90%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56450582bb204f08887af218bc556a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=dZkfJVjFgJuQ8cPCDJ9lDt9rnAU%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>通过上面前两张图我们可以看到，iOS 26 正常情况下，系统键盘其实是会出现半透明效果并且具备圆角，虽然透明效果不是特别明显，但是对比后两张图里，可以看到微信和淘宝还是保留着原本的 iOS 18 的直角效果。</p>
<blockquote>
<p>如果还是保留原本风格，其实并不会遇到这个问题。</p>
</blockquote>
<p><strong>所以这个 issue 首先是需要在 Xcode 26 下，并且没有关闭 Liquid Glass 适配的情况下才会遇到</strong>，当然，就算是 iOS 26 场景，一般情况下也不会有什么大问题，比如下图直接在界面内使用一个 <code>TextField</code> ，其实并不会有明显问题：</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dc21612af4240d792024f59e73534fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=ZczUpzI2%2F4yzJxo7DkHRXWaRdLw%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ebc5e2b57044e39b7a5c0358a303dbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=aT7%2Fhqerqj%2FB%2BOCOg%2BfZbNhCiWM%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>问题还是主要出现在类似 <code>showModalBottomSheet</code> 的场景，特别是在背景色透明的时候，虽然我们设置了 <code>backgroundColor: Colors.transparent</code> ，<strong>但是在 Flutter 里，某些时候 UI 并不会“在键盘背后继续画”</strong> ，因为在 iOS 26 之前，Flutter（以及很多跨平台框架）都默认：</p>
<blockquote>
<p><strong>系统键盘 = 完全不透明的遮挡物</strong>，所以 Flutter 的 pipeline 会认为键盘区域背后不需要特殊关注。</p>
</blockquote>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18616ed0571f43e7bbc53eac69fde608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=RSAJeipogB69tt4c2w2XPajWu8c%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0cf32020255458f9b4da867f2d3ea05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=P1LvlwLkchu2HRQk3wpGKNPbTA0%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>实际上类似同样的问题，在 RN 里也是存在，甚至对于 CMP 来说也是存在不一样的问题，所以对于 CMP 来说，才会有 <a href="https://juejin.cn/post/7594863660280496147" target="_blank" title="https://juejin.cn/post/7594863660280496147">1.10 Interop views 新特性 Overlay </a>，用于支持 UIKit 的半透明/blur 可以采样到 Skia 的内容的实验性 API ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be381af627b044068bca9e81d400132d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=YwDwvtgqLyR2YtSryfsbcVnjHS8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9faa62b4480d4184bf03025906f70b1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=w7sBOdkCPbhguDnuslJt8UcB72A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3131730714474d318e3b6c550948efac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=dKBLX9k4AepYwBhEf%2BPUrJam3MY%3D" alt="" loading="lazy"/></p>
<p><strong>所以这个问题实际上的本质不是圆角</strong>，比如我把 <code>showModalBottomSheet</code> 背景改成红色，此时你可以看到键盘是可以采集到背景色的，甚至我把 <code>Container</code> 也改成红色，你也看不出来异常：</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e1f833111e2401cab0380dd3f811a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=6wRGZG8BkYY%2FZZ%2BOF5ljf%2BLdBvg%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d460ae0c2bb841579d3917c03855cce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=bNYm2ONTVFM2Zait%2F5P2P14v2o4%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p><strong>所以问题更多出现在透明色上</strong>，随着 <code>showModalBottomSheet</code> 弹出并带有透明色的时候，由于 Flutter 认为被键盘这挡住的下层 Widget 并不需要绘制，所以导致系统键盘采集不到对应的像素点，从而出现了一开始的黑色背景。</p>
<p>所以其实这个 Bug 如果想临时解决，只需要在 <code>Info.plist</code> 里配置 <code>UIDesignRequiresCompatibility = YES</code> 就可以了，只是此时 App UI 会是 iOS 18 的风格：</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f4baaf1f0c4451da02bf7dbb4b5a8d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=YgKhzcxCFx8gvExY5AN9MhXse08%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d23e4a28d914858ba80b485a8f84345~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=2jBsVD1XGRDa5aMtDaeaxGKF2qM%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>如果再对比抖音和 Github App ，就可以看到 iOS 26 新键盘风格对于整体应用的风格影响还是挺大的，所以不少 App 目前会选择通过关闭适配拖延时间。</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8960ebb99a104882930870eb0fcf45a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=7AA5kH6iN%2FlkIojKaU4Zy5EpJAE%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97a572ed7869455495d4bf665f42a773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=VzEuqPTXpH9eXu7qZH88fSR1zG8%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>那为什么会说，这个 Bug 会导致整个底层生态的重构？<strong>因为 iOS 26 改变了“系统键盘会完全遮挡 App 内容”这一长期不变的底层假设</strong>，而 Flutter 的渲染 / 布局 / Insets / 事件系统，几乎全都建立在旧假设之上，这套逻辑几乎渗透在：</p>
<ul>
<li><code>RenderObject</code> 的 <code>layout</code></li>
<li><code>Scaffold</code> / <code>BottomSheet</code> / <code>Navigator</code></li>
<li><code>MediaQuery</code></li>
<li><code>TextInputPlugin</code></li>
<li>Engine 中的 view hierarchy</li>
<li>···</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62cbb41513d24b9dabf73ec4acd1f25f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=K6pyjNg8LraIRnLVWOWzzrxIQyM%3D" alt="" loading="lazy"/></p>
<p>也就是如果想完全适配这个新场景（多层嵌套下还提供键盘场景的透明支持），一旦需要完全支持“键盘下内容需要绘制”，就要系统性重构多个核心层，例如</p>
<p>：</p>
<h4 data-id="heading-0">Framework 层（Dart）</h4>
<ul>
<li>
<p><code>MediaQuery.viewInsets</code></p>
<ul>
<li>现在代表“不可见区域”</li>
<li>未来要不要拆成多个：<code>coveredInsets</code> 、<code>obscuredInsets</code> 、<code>visualInsets</code></li>
</ul>
</li>
<li>
<p>Scaffold / BottomSheet</p>
<ul>
<li>是否仍然自动 resize？</li>
<li>还是只做布局、不做裁剪？</li>
</ul>
</li>
<li>
<p>Clip 行为</p>
<ul>
<li>现在大量 widget 默认不 clip</li>
</ul>
</li>
</ul>
<h4 data-id="heading-1">Engine 层（iOS embedder）</h4>
<ul>
<li>
<p>FlutterView / UIView hierarchy</p>
</li>
<li>
<p>CALayer 合成顺序</p>
</li>
<li>
<p>系统 keyboard window vs Flutter window</p>
</li>
<li>
<p>是否需要：</p>
<ul>
<li>在被遮挡区域继续 raster</li>
<li>或改变 backing store 策略</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">输入系统 &amp; Hit Test</h4>
<ul>
<li>
<p>键盘下的 widget：</p>
<ul>
<li>画出来了</li>
<li>但不能响应触摸</li>
</ul>
</li>
<li>
<p>Flutter 目前的 hit-test 假设：</p>
<ul>
<li>“看得见 = 可点”</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">插件 &amp; 三方生态</h4>
<ul>
<li>
<p>各种：</p>
<ul>
<li>bottom sheet 插件</li>
<li>keyboard avoiding 插件</li>
<li>聊天 UI</li>
</ul>
</li>
<li>
<p>各种涉及“手搓” viewInsets 的场景</p>
</li>
</ul>
<p><strong>所以这个“语义场景”如果发生比变化，那么涉及的将是大量底层改动，甚至一些性能指标都会需要调整，从长远来看，这还会是一个 iOS 平台特有的差异化适配场景，并且引入大量 bread change</strong>。</p>
<h2 data-id="heading-4">最后</h2>
<p>最后总结下，<strong>正常大家使用输入框输入文本内容不会有什么问题</strong>，甚至如果你用 Dialog 场景也不会有什么问题，甚至你看下方最后一张图片，在 dialog 下的键盘依然可以正常透视工作：</p>








<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fef0d4e649f4c47b6f6468f3459bb65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=hosWMv7q%2Bh11e2iDmmU0s29C3Pw%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84aa4bb724704c11a5d1ae4d0d3e756d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=F8HbVJ2rHQcJ2szaECmfdca3qFk%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1541015615bd4d74a0422ce80d396b00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=tYfeB7HDMenshvpeLNRL6sd82f4%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>所以问题主要还是存在于 <code>BottomSheet</code> 这种场景，因为 <code>BottomSheet</code> 默认行为是认为底部对齐，高度有限，所以对于 <code>BottomSheet</code> 会认为底部高度区域在键盘下不渲染，所以导致最后采集不到像素出现黑色。</p>
<p><strong>针对问题其实可以选择配置 <code>UIDesignRequiresCompatibility = YES</code> 来解决，或者替换为 Dialog 来绕过场景</strong>，但是如果要等官方修复这个场景，可能会需要等待评估是否真的有必要大规模底层改动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0500f298cdf24bb19b88afb7dc876a1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=tTi4RnJsW0Np0X5mNPeIlRXt5Y8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>从我的角度看，这完全没必要，毕竟真这么修改，带来的就是生态的大量 break change。</p>
</blockquote>
<h2 data-id="heading-5">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F179482" target="_blank" title="https://github.com/flutter/flutter/issues/179482" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0开发大模型之实现Agent（Bash 到 SKILL）]]></title>    <link>https://juejin.cn/post/7596478936387108906</link>    <guid>https://juejin.cn/post/7596478936387108906</guid>    <pubDate>2026-01-19T01:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596478936387108906" data-draft-id="7596583214597799955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0开发大模型之实现Agent（Bash 到 SKILL）"/> <meta itemprop="keywords" content="AIGC,Agent"/> <meta itemprop="datePublished" content="2026-01-19T01:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周末程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056989757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0开发大模型之实现Agent（Bash 到 SKILL）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056989757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周末程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T01:15:04.000Z" title="Mon Jan 19 2026 01:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从《learn-claude-code》受到启发，于是参考源代码写了这篇文章：如何实现从0开始构建Agent？</p>
<h2 data-id="heading-0">1. 前提</h2>
<h3 data-id="heading-1">1.1 <code>AI Agent</code> 构成</h3>
<ul>
<li>模型：为智能体的推理和决策提供动力的LLM，决定了智能体的下限。</li>
<li>工具：智能体可用于采取行动的外部函数或API。</li>
<li>指令：定义智能体行为的明确指导方针和安全策略。</li>
</ul>
<p>三者构成了 <code>AI Agent</code> 的下限和上限，模型越强，对于指令和工具的调度能力更准确，但是从工程学的角度来考虑，较弱的模型通过对工具和指令的结合，一样能制造功能强大的 <code>Agent</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12286f8d23a14c38b82124d9b07bd04c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=gUoYcWwmYUGcRmAMo3p4w%2Bb0XWQ%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 <code>Tool Calling</code></h3>
<p>由于 <code>Anthropic Tool Calling</code> 协议现在大部分模型已经支持，并且非常成熟，所以本文默认都通过传入 <code>TOOLS</code> 来让大模型调用的工具，样例如下：</p>
<pre><code class="hljs language-bash" lang="bash">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"my_function_name"</span>, <span class="hljs-comment"># The name of the function</span>
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"The description of my function"</span>, <span class="hljs-comment"># Describe the function so Claude knows when and how to use it.</span>
    <span class="hljs-string">"input_schema"</span>: { <span class="hljs-comment"># input schema describes the format and the type of parameters Claude needs to generate to use the function</span>
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>, <span class="hljs-comment"># format of the generated Claude response</span>
        <span class="hljs-string">"properties"</span>: { <span class="hljs-comment"># properties defines the input parameters of the function</span>
            <span class="hljs-string">"query"</span>: { <span class="hljs-comment"># the function expects a query parameter</span>
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"The search query to perform."</span>, <span class="hljs-comment"># describes the parameter to Claude</span>
            },
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"query"</span>], <span class="hljs-comment"># define which parameters are required</span>
    },
}
</code></pre>
<p><strong>给模型传入 <code>TOOLS</code> 参数，LLM API 返回如下：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool_use"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"toolu_01A09q90qw90lq917835123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my_function_name"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Latest developments in quantum computing"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">1.3 简单的 v0:Shell 到复杂 v4:Skills</h3>
<p>前面提到 <code>AI Agent</code> 构成包括工具和指令，那么从最简的工具开始，到最后复杂的指令，<code>Agent</code> 的核心原理：<code>感知 -&gt; 认知 -&gt; 执行 -&gt; 反馈 -&gt; 感知 ...</code>，然后循环执行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fab5c05059340eeb16b8de339c92ee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=GjgWZLcpsrreZ%2F3vgQWbAcpKAuc%3D" alt="图片" loading="lazy"/></p>
<p>基于这个核心原理，我们从最简的 Shell 构建，规划如下：</p>
<ul>
<li>v0: Shell 是基础的工具</li>
<li>v1: 模型即代理</li>
<li>v2: 结构化规划与 Todo</li>
<li>v3: 子代理</li>
<li>v4: Skills</li>
</ul>
<h2 data-id="heading-4">2. v0: Shell 是基础的工具</h2>
<p>Shell 在计算机是最常用的，所有的操作系统中都有类似 Bash 脚本的功能，那么基于脚本定义一系列工具如下：</p>





















<table><thead><tr><th>工具</th><th>对应 Bash 命令示例</th></tr></thead><tbody><tr><td>读文件</td><td><code>cat file.txt</code>, <code>head -n 20 file.py</code>, <code>grep "TODO" -n -r .</code></td></tr><tr><td>写文件</td><td><code>echo '...' &gt; file</code>, <code>cat &lt;&lt; 'EOF' &gt; main.py</code></td></tr><tr><td>搜索/导航</td><td><code>find . -name "*.py"</code>, <code>ls -R</code>, <code>rg "keyword" .</code></td></tr></tbody></table>
<h3 data-id="heading-5">2.1 架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/801c7b436d394dfb9ac81f115bf43380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=aBscv%2BlTLTBO7p1WrdhZz%2FePAGs%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>逻辑核心只有一个循环：<strong>模型 → 工具调用 → 工具结果 → 模型</strong></li>
<li>不额外引入 Task/Plan/Registry 等抽象，全部由「自然语言 + Bash + 递归」实现</li>
</ul>
<p><strong>不足：</strong></p>
<ul>
<li>工程化的安全边界（如路径沙盒、命令白名单）</li>
<li>更丰富的可观测性（结构化日志、任务树可视化）</li>
<li>人类语义层面的「角色」区分（计划者/执行者/审阅者）</li>
</ul>
<p>在这个极简版本中，我们遵循的架构设计，只保留<strong>最小完成闭环</strong>所需的要素。</p>
<p><strong>一个工具就够了</strong><br/>
Bash 本身就是工具的「元工具」：其他一切工具都可以通过 Bash 间接调用（curl、git、python、docker 等）。</p>
<p><strong>递归 = 层级结构</strong><br/>
无需实现复杂的 Task/Plan 抽象；只要允许「调用自己」，层级结构自然涌现。</p>
<p><strong>进程 = 上下文隔离</strong><br/>
不需要额外的「会话 ID」或「上下文容器」：操作系统的进程模型天然提供隔离。</p>
<p><strong>提示词 = 行为约束</strong><br/>
系统提示词定义了当前 Agent 的「角色 + 责任边界」，决定了它如何使用 Bash 能力。</p>
<p><strong>核心循环</strong></p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-built_in">response</span> = model(messages, tools)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">response</span>.stop_reason != <span class="hljs-string">"tool_use"</span>:
        return <span class="hljs-built_in">response</span>.text
    results = <span class="hljs-keyword">execute</span>(<span class="hljs-built_in">response</span>.tool_calls)
    messages.append(results)
</code></pre>
<h3 data-id="heading-6">2.2 完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> run_bash, BASH_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)

<span class="hljs-comment"># 系统提示词</span>
SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{os.getcwd()}</span> 的 CLI 代理，系统为 <span class="hljs-subst">{sys.platform}</span>。使用 bash 命令解决问题。

## 规则：
- 优先使用工具而不是文字描述。先行动，后简要解释。
- 读取文件：cat, grep, find, rg, ls, head, tail
- 写入文件：echo '...' &gt; file, sed -i, 或 cat &lt;&lt; 'EOF' &gt; file
- 避免危险操作，如 rm -rf等删除或者清理文件, 或格式化挂载点，或对系统文件进行写操作

## 要求
- 不使用其他工具，仅使用 bash 命令或者 shell 脚本
- 子代理可以通过生成 shell 代码执行
- 如果当前任务超过 bash 的处理范围，则终止不处理
"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_bash_commands</span>(<span class="hljs-params">text</span>):
    <span class="hljs-string">"""从 LLM 响应中提取 bash 命令"""</span>
    <span class="hljs-keyword">import</span> re
    pattern = <span class="hljs-string">r'```bash\n(.*?)\n```'</span>
    matches = re.findall(pattern, text, re.DOTALL)
    <span class="hljs-keyword">return</span> [cmd.strip() <span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> matches <span class="hljs-keyword">if</span> cmd.strip()]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">prompt, history=<span class="hljs-literal">None</span>, max_steps=<span class="hljs-number">10</span></span>):
    <span class="hljs-keyword">if</span> history isNone:
        history = []
    
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
         <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
         history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        <span class="hljs-comment"># 1. 调用模型（传递 tools 参数）</span>
        <span class="hljs-comment"># 使用 chat_with_tools 接口，支持 function calling</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=BASH_TOOLS
        )
        <span class="hljs-keyword">if</span> step == <span class="hljs-number">1</span>:
            prompt = <span class="hljs-string">'继续'</span>

        <span class="hljs-comment"># 2. 解析响应内容</span>
        assistant_text = []
        tool_calls = []
        
        logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步响应: <span class="hljs-subst">{response}</span>"</span>)

        <span class="hljs-comment"># chat_with_tools 返回的是 Response 对象，包含 content 列表</span>
        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"text"</span>:
                assistant_text.append(block.text)
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        <span class="hljs-comment"># 记录助手文本回复</span>
        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        <span class="hljs-keyword">if</span> full_text:
            logger.info(<span class="hljs-string">f"助手: <span class="hljs-subst">{full_text}</span>"</span>)
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        <span class="hljs-keyword">elif</span> tool_calls:
            <span class="hljs-comment"># 如果只有工具调用没有文本，添加一个占位文本到历史，保持对话连贯</span>
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"(Executing tools...)"</span>})
        
        <span class="hljs-comment"># 3. 如果没有工具调用，直接返回内容</span>
        ifnot tool_calls:
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"end_turn"</span>:
                <span class="hljs-keyword">return</span> full_text
            <span class="hljs-comment"># 如果异常结束，也返回</span>
            <span class="hljs-keyword">return</span> full_text o<span class="hljs-string">r"(No response)"</span>

        <span class="hljs-comment"># 4. 执行工具</span>
        logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步工具调用: <span class="hljs-subst">{tool_calls}</span>"</span>)
        all_outputs = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"bash"</span>:
                cmd = tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">"command"</span>)
                <span class="hljs-keyword">if</span> cmd:
                    logger.info(<span class="hljs-string">f"[使用工具] <span class="hljs-subst">{cmd}</span>"</span>)  <span class="hljs-comment"># 黄色显示命令</span>
                    output = run_bash(cmd)
                    all_outputs.append(<span class="hljs-string">f"$ <span class="hljs-subst">{cmd}</span>\n<span class="hljs-subst">{output}</span>"</span>)
                    <span class="hljs-comment"># 如果输出太长则截断打印</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span>:
                        logger.info(<span class="hljs-string">f"输出: <span class="hljs-subst">{output[:<span class="hljs-number">200</span>]}</span>... (已截断)"</span>)
                    <span class="hljs-keyword">else</span>:
                        logger.info(<span class="hljs-string">f"输出: <span class="hljs-subst">{output}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                logger.warning(<span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{tc.name}</span>"</span>)
        
        <span class="hljs-comment"># 5. 将命令执行结果添加到历史记录中</span>
        <span class="hljs-keyword">if</span> all_outputs:
            combined_output = <span class="hljs-string">"\n"</span>.join(all_outputs)
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理。"</span>})
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 有工具调用但没产生输出（可能是解析失败或空命令）</span>
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Error: Tool call failed or produced no output."</span>})

    <span class="hljs-keyword">return</span><span class="hljs-string">"达到最大执行步数限制，停止执行。"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:
        logger.info(chat(sys.argv[<span class="hljs-number">1</span>]))
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 交互模式</span>
        logger.info(<span class="hljs-string">"Bash 代理已启动。输入 'exit' 退出。"</span>)
        history = []
        whileTrue:
            <span class="hljs-keyword">try</span>:
                user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"&gt; "</span>)
                <span class="hljs-keyword">if</span> user_input.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">'exit'</span>, <span class="hljs-string">'quit'</span>]:
                    <span class="hljs-keyword">break</span>
                chat(user_input, history)
            <span class="hljs-keyword">except</span> KeyboardInterrupt:
                logger.info(<span class="hljs-string">"\n正在退出..."</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.info(<span class="hljs-string">f"\n错误: <span class="hljs-subst">{e}</span>"</span>)
                traceback.print_exc()
</code></pre>
<h2 data-id="heading-7">3.1 v1: 模型即代理</h2>
<p><code>Agent</code> 的核心就是自主决策，只需要人工给定目标+约束规则，让大模型自主决策怎么调用工具，怎么遵循规则，这样才能做到通用性。</p>
<p><strong>传统助手模式：</strong></p>
<pre><code class="hljs language-rust" lang="rust">用户 <span class="hljs-punctuation">-&gt;</span> 模型 <span class="hljs-punctuation">-&gt;</span> 文本回复
</code></pre>
<p><strong><code>Agent</code> 系统模式：</strong></p>
<pre><code class="hljs language-rust" lang="rust">用户 <span class="hljs-punctuation">-&gt;</span> 模型 <span class="hljs-punctuation">-&gt;</span> [工具 <span class="hljs-punctuation">-&gt;</span> 结果]* <span class="hljs-punctuation">-&gt;</span> 回复
                     ^_________|
</code></pre>
<p><code>*</code> 模型<strong>可以反复</strong>调用工具，直到它认为任务完成为止，把「聊天机器人」升级为「自主代理」。</p>
<p>Claude Code 之类系统可能挂了 <code>10～20</code> 个工具，但对于一个「本地代码助手」，<strong>4 个就够覆盖 80–90% 的场景</strong>：</p>






























<table><thead><tr><th>工具</th><th>用途</th><th>示例能力</th></tr></thead><tbody><tr><td><code>bash</code></td><td>运行命令</td><td><code>npm install</code>, <code>git status</code>, <code>pytest</code>, <code>ls</code></td></tr><tr><td><code>read_file</code></td><td>读取文件内容</td><td>查看 <code>src/index.ts</code> 的具体实现</td></tr><tr><td><code>write_file</code></td><td>创建/覆盖文件</td><td>创建 <code>README.md</code>、生成新模块</td></tr><tr><td><code>edit_file</code></td><td>精确修改片段</td><td>在一个函数内插入日志、重构一个方法</td></tr></tbody></table>
<p>有了这 4 个工具，模型就是可以完成如下事情：</p>
<ul>
<li><strong>探索代码库</strong>：<code>bash: find, ls, tree, rg/grep</code></li>
<li><strong>理解代码</strong>：<code>read_file</code> 查看具体文件内容</li>
<li><strong>做出修改</strong>：</li>
<li>
<ul>
<li>新建/完全重写：<code>write_file</code></li>
<li>小范围精修：<code>edit_file</code></li>
</ul>
</li>
<li><strong>运行和验证</strong>：<code>bash: python, npm test, make, pytest, go test ...</code></li>
</ul>
<h3 data-id="heading-8">3.2 架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0d38fb337f142c48c7316f333d2ad99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=Ipa7RBS10wM4C4%2Bl%2BnBnVtoEnZ8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>模型是决策者：何时调用工具、调用哪些工具、以什么顺序、何时停止，都由模型决定。</li>
<li>代码只做两件事：</li>
<li>
<ol>
<li>提供一组工具（带清晰的输入 schema 和语义）</li>
<li>驱动「模型 → 工具 → 结果 → 模型」的循环</li>
</ol>
</li>
</ul>
<p><code>agent_loop</code> 正是 v1 的核心：</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-built_in">response</span> = model(messages, tools)

    # 打印文本输出
    <span class="hljs-keyword">if</span> no tool_use:
        return

    results = <span class="hljs-keyword">execute</span>(<span class="hljs-built_in">response</span>.tool_calls)
    messages.append(<span class="hljs-built_in">response</span>)
    messages.append(results)
</code></pre>
<p><strong>模型控制循环</strong><br/>
只要 <code>stop_reason == "tool_use"</code>，说明模型还在「思考 + 操作」，没准备给出最终答案。<br/>
一旦 <code>stop_reason != "tool_use"</code>，模型就认为任务完成，返回最终文本。</p>
<p><strong>工具结果成为上下文</strong><br/>
工具执行结果以 <code>"user"</code> 消息的形式追加回对话，模型下次调用时就能「看到」自己刚刚操作的结果。</p>
<p><strong>记忆自动累积</strong><br/>
所有对话内容、工具调用、结果都放在 <code>messages</code> 里，模型自然拥有整个任务的上下文。</p>
<p><strong>代码逻辑极薄</strong><br/>
你几乎看不到复杂状态机、计划器、子任务调度器——这些都交给模型的「思考 + 工具调用策略」来涌现。</p>
<h3 data-id="heading-9">3.3 为什么这样设计?</h3>
<p><strong>1. 简单</strong></p>
<ul>
<li>没有显式状态机</li>
<li>没有 planner/parser 模块</li>
<li>没有自定义框架</li>
</ul>
<p>只有：<code>messages</code>、<code>tools</code>、<code>while True</code>。</p>
<p><strong>2. 模型负责思考</strong></p>
<ul>
<li>哪个工具：bash / read / write / edit？</li>
<li>什么顺序：先看文件？先找入口？再修改？再跑测试？</li>
<li>何时停止：任务是否已经完成？</li>
</ul>
<p>全都交给模型，用自然语言和工具 schema 引导，而不是手动写死流程。</p>
<p><strong>3. 透明可观测</strong></p>
<ul>
<li>每个工具调用都显式出现在 <code>messages</code> 中 (<code>tool_use</code> + <code>tool_result</code>)</li>
<li>你可以把 <code>messages</code> 持久化，恢复整个过程、调试行为</li>
</ul>
<p><strong>4. 可扩展性强</strong></p>
<p>添加新工具的成本非常低：</p>
<ol>
<li>实现一个 Python 函数（例如 <code>tool_http_request</code>）。</li>
<li>在 <code>TOOLS</code> 列表中增加一个带 JSON schema 的条目。</li>
<li>在 <code>execute_tool</code> 中分发到对应函数。</li>
</ol>
<p>无需改 Agent 循环，循环 <code>Agent</code> 核心调度方式。</p>
<h3 data-id="heading-10">3.4 完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> execute_base_tools, BASIC_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)
WORKDIR = Path.cwd()

SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的编码代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

## 执行流程
简要思考 -&gt; 使用工具（使用 TOOLS） -&gt; 报告结果。

## 规则
- 优先使用工具而不是文字描述。先行动，不要只是解释。  
- 永远不要臆造文件路径。如果不确定，先使用 bash ls/find 确认。  
- 做最小的修改。不要过度设计。  
- 完成后，总结变更内容。  

## 要求：
- 循环尽量简单，不要复杂。  
"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, args: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    result = execute_base_tools(name, args)
    <span class="hljs-keyword">if</span> result isnotNone:
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span><span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt, history=<span class="hljs-literal">None</span>, max_steps=<span class="hljs-number">10</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-keyword">if</span> history isNone:
        history = []
    
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=BASIC_TOOLS,
        )

        assistant_text = []
        tool_calls = []
        
        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"text"</span>:
                assistant_text.append(block.text)
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)
        
        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用工具: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
            logger.info(<span class="hljs-string">f"  [使用工具] <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)
            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

    logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步达到最大执行步数限制，停止执行。"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    logger.info(<span class="hljs-string">f"Mini Claude Code v1 - <span class="hljs-subst">{WORKDIR}</span>"</span>)
    logger.info(<span class="hljs-string">"Type 'exit' to quit.\n"</span>)

    history = []
    whileTrue:
        <span class="hljs-keyword">try</span>:
            user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"You: "</span>).strip()
        <span class="hljs-keyword">except</span> (EOFError, KeyboardInterrupt):
            <span class="hljs-keyword">break</span>

        ifnot user_input <span class="hljs-keyword">or</span> user_input.lower() <span class="hljs-keyword">in</span> (<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"q"</span>):
            <span class="hljs-keyword">break</span>

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input})
        <span class="hljs-keyword">try</span>:
            agent_loop(<span class="hljs-string">''</span>, history, max_steps=<span class="hljs-number">10</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>)
            traceback.print_exc()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-11">4 v2: 结构化规划与 Todo</h2>
<p>v1 已经能正常工作，但在复杂任务上，它容易<strong>失去方向</strong>：</p>
<ul>
<li>在不同子任务之间来回跳转</li>
<li>很难记住已经做了什么、未做什么</li>
<li>难以向用户呈现清晰的进度</li>
</ul>
<p>v2 我们只需要做一个 Plan：<strong>Todo 工具</strong>（增加少量状态管理与提示逻辑），就能实现 "计划（使用 TodoWrite） -&gt; 使用工具行动（使用 TOOLS）"。</p>
<p>在 v1 的工具列表基础上，v2 新增 <code>TodoManager</code> 管理和 <code>TodoWrite</code> 工具。</p>
<h3 data-id="heading-12">4.1 TodoManager：带约束的任务列表</h3>
<p>核心是一个带约束的列表管理器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoManager</span>:
    <span class="hljs-string">"""
    管理具有强制约束的结构化任务列表。

    关键设计决策：
    --------------------
    1. 最多 20 项：防止模型创建无尽的列表
    2. 一个进行中：强制专注 - 一次只能做一件事
    3. 必填字段：每个项目需要 content, status 和 activeForm

    activeForm 字段值得解释：
    - 它是正在发生的事情的现在时形式
    - 当 status 为 "in_progress" 时显示
    - 示例：content="Add tests", activeForm="Adding unit tests..."

    这提供了代理正在做什么的实时可见性。
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.items = []

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, items: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        验证并更新任务列表。

        模型每次发送一个完整的列表。我们验证它，
        存储它，并返回一个模型将看到的渲染视图。

        验证规则：
        - 每个项目必须有：content, status, activeForm
        - Status 必须是：pending | in_progress | completed
        - 一次只能有 ONE 个项目处于 in_progress 状态
        - 最多允许 20 个项目

        Returns:
            任务列表的渲染文本视图
        """</span>
        validated = []
        in_progress_count = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> i, item <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(items):
            <span class="hljs-comment"># Extract and validate fields</span>
            content = <span class="hljs-built_in">str</span>(item.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)).strip()
            status = <span class="hljs-built_in">str</span>(item.get(<span class="hljs-string">"status"</span>, <span class="hljs-string">"pending"</span>)).lower()
            active_form = <span class="hljs-built_in">str</span>(item.get(<span class="hljs-string">"activeForm"</span>, <span class="hljs-string">""</span>)).strip()

            <span class="hljs-comment"># Validation checks</span>
            ifnot content:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Item <span class="hljs-subst">{i}</span>: content required"</span>)
            <span class="hljs-keyword">if</span> status notin (<span class="hljs-string">"pending"</span>, <span class="hljs-string">"in_progress"</span>, <span class="hljs-string">"completed"</span>):
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Item <span class="hljs-subst">{i}</span>: invalid status '<span class="hljs-subst">{status}</span>'"</span>)
            ifnot active_form:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Item <span class="hljs-subst">{i}</span>: activeForm required"</span>)

            <span class="hljs-keyword">if</span> status == <span class="hljs-string">"in_progress"</span>:
                in_progress_count += <span class="hljs-number">1</span>

            validated.append({
                <span class="hljs-string">"content"</span>: content,
                <span class="hljs-string">"status"</span>: status,
                <span class="hljs-string">"activeForm"</span>: active_form
            })

        <span class="hljs-comment"># Enforce constraints</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(validated) &gt; <span class="hljs-number">20</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Max 20 todos allowed"</span>)
        <span class="hljs-keyword">if</span> in_progress_count &gt; <span class="hljs-number">1</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Only one task can be in_progress at a time"</span>)

        self.items = validated
        <span class="hljs-keyword">return</span> self.render()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        将任务列表渲染为人类可读的文本。

        格式：
            [x] 已完成任务
            [&gt;] 进行中任务 &lt;- 正在做某事...
            [ ] 待办任务

            (2/3 completed)

        这个渲染后的文本是模型作为工具结果看到的内容。
        然后它可以根据当前状态更新列表。
        """</span>
        ifnot self.items:
            <span class="hljs-keyword">return</span><span class="hljs-string">"No todos."</span>

        lines = []
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.items:
            <span class="hljs-keyword">if</span> item[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"completed"</span>:
                lines.append(<span class="hljs-string">f"[x] <span class="hljs-subst">{item[<span class="hljs-string">'content'</span>]}</span>"</span>)
            <span class="hljs-keyword">elif</span> item[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"in_progress"</span>:
                lines.append(<span class="hljs-string">f"[&gt;] <span class="hljs-subst">{item[<span class="hljs-string">'content'</span>]}</span> &lt;- <span class="hljs-subst">{item[<span class="hljs-string">'activeForm'</span>]}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                lines.append(<span class="hljs-string">f"[ ] <span class="hljs-subst">{item[<span class="hljs-string">'content'</span>]}</span>"</span>)

        completed = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> self.items <span class="hljs-keyword">if</span> t[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"completed"</span>)
        lines.append(<span class="hljs-string">f"\n(<span class="hljs-subst">{completed}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.items)}</span> completed)"</span>)

        <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join(lines)
</code></pre>
<p>这里的约束是有意设计的「规则」：</p>

































<table><thead><tr><th>规则</th><th>原因</th></tr></thead><tbody><tr><td>最多 20 条</td><td>防止模型把 todo 当成无限备忘录</td></tr><tr><td>必须有 <code>content</code></td><td>保证每条任务有明确描述</td></tr><tr><td>必须有 <code>status</code></td><td>让任务进度可追踪</td></tr><tr><td>必须有 <code>activeForm</code></td><td>帮助描述“当前正在做的具体动作”</td></tr><tr><td>只能一个 <code>in_progress</code></td><td>强制模型一次只专注一个任务</td></tr><tr><td>内容不能重复</td><td>防止模型无意义地复制条目</td></tr></tbody></table>
<p>这些约束<strong>同时限制了行为空间，又增强了可控性和可观察性</strong>。</p>
<h3 data-id="heading-13">4.2 Todo 工具的执行与反馈</h3>
<p>在 Agent 端的实现中：</p>
<pre><code class="hljs language-python" lang="python">todo_manager = TodoManager()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name, args</span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"TodoWrite"</span>:
        <span class="hljs-keyword">try</span>:
            todo_manager.update(args[<span class="hljs-string">"items"</span>])
            <span class="hljs-comment"># 返回给模型看的文本形式，模型可以据此继续思考和更新</span>
            <span class="hljs-keyword">return</span> todo_manager.summary_text()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"[TodoWrite error] <span class="hljs-subst">{e}</span>"</span>

    <span class="hljs-comment"># 其他工具: bash / read_file / write_file / edit_file...</span>
    ...
</code></pre>
<p>以一次调用为例：</p>
<p><strong>模型调用 <code>TodoWrite</code> 输入：</strong></p>
<pre><code class="hljs language-css" lang="css">{
    "items": [
        {
            "<span class="hljs-attribute">content</span>": <span class="hljs-string">"重构认证模块"</span>,
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"completed"</span>,
            <span class="hljs-string">"activeForm"</span>: <span class="hljs-string">"重构已完成"</span>
        },
        {
            "<span class="hljs-attribute">content</span>": <span class="hljs-string">"添加单元测试"</span>,
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"in_progress"</span>,
            <span class="hljs-string">"activeForm"</span>: <span class="hljs-string">"正在为认证模块编写单元测试"</span>
        },
        {
            "<span class="hljs-attribute">content</span>": <span class="hljs-string">"更新文档"</span>,
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"pending"</span>,
            <span class="hljs-string">"activeForm"</span>: <span class="hljs-string">"准备在完成测试后更新文档"</span>
        }
    ]
}
</code></pre>
<p><strong>工具返回给模型的文本（作为 <code>tool_result</code>）：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[x]</span> 重构认证模块  (重构已完成)
<span class="hljs-selector-attr">[&gt;]</span> 添加单元测试  (正在为认证模块编写单元测试)
<span class="hljs-selector-attr">[ ]</span> 更新文档      (准备在完成测试后更新文档)
(<span class="hljs-number">1</span>/<span class="hljs-number">3</span> 已完成)
</code></pre>
<p>模型在下一轮调用时，就能「看到自己刚刚整理的计划」，并基于这个结构化状态决定接下来要做什么。</p>
<h3 data-id="heading-14">4.3 系统提示词：软约束鼓励使用 Todo</h3>
<p>Todo 的使用不是强制性的，而是通过 <strong>软提醒</strong> 进行引导：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">INITIAL_REMINDER</span> = <span class="hljs-string">"&lt;reminder&gt;对于多步骤任务，请使用 TodoWrite 工具创建和维护一个清晰的 todo 列表。&lt;/reminder&gt;"</span>
<span class="hljs-attr">NAG_REMINDER</span> = <span class="hljs-string">"&lt;reminder&gt;已经超过 10 轮未更新 todo，请检查是否需要补充或更新 TodoWrite。&lt;/reminder&gt;"</span>
</code></pre>
<ul>
<li>在对话的合适位置，注入一段额外文本（通常作为 system 或额外的 user 内容），让模型意识到应该使用 Todo 工具。</li>
<li>这些提醒<strong>不是一个单独工具调用</strong>，也<strong>不需要模型回复</strong>，只是一个“背景提示”。</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-css" lang="css">while True:
    ...

    if first_message:
        content.<span class="hljs-built_in">append</span>(INITIAL_REMINDER)
        first_message = False
    elif rounds_without_todo &gt; max_steps:
        content.<span class="hljs-built_in">append</span>(NAG_REMINDER)

    content.<span class="hljs-built_in">append</span>(f<span class="hljs-string">"输入：{user_input}"</span>)
    history.<span class="hljs-built_in">append</span>({"role": <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n"</span>.<span class="hljs-built_in">join</span>(content)})

    try:
        <span class="hljs-built_in">agent_loop</span>(<span class="hljs-string">''</span>, history, max_steps=max_steps)
    except Exception as e:
        logger.<span class="hljs-built_in">error</span>(f<span class="hljs-string">"Error: {e}"</span>)
        traceback.<span class="hljs-built_in">print_exc</span>()
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>模型被“温柔地提醒”：对于多步骤任务，Todo 是推荐做法。</li>
<li>如果模型长期不更新 Todo（比如执行了很多工具调用），会收到 “该更新计划了” 的提示。</li>
</ul>
<h3 data-id="heading-15">4.4 架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62f70228be2d427880f5405a69bd61f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=TsK1IsLbDDIDvM%2BYsmNJExXr40k%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p><strong>显式规划让 Agent 更可靠，而 Todo 是实现显式规划的最小结构单元。</strong><br/>
<strong>结构既是约束，也是能力放大的脚手架。</strong></p>
</blockquote>
<ul>
<li>约束：</li>
<li>
<ul>
<li>限制条目数、状态字段、唯一进行中</li>
<li>要求完整列表，而非局部 patch</li>
</ul>
</li>
<li>赋能：</li>
<li>
<ul>
<li>提供了<strong>可见的计划</strong>（用户、模型都能看到）</li>
<li>提供了<strong>进度追踪</strong>和<strong>当前焦点</strong>的清晰标记</li>
<li>为后续的总结、回顾提供结构</li>
</ul>
</li>
</ul>
<p>类似的模式在 Agent 设计中普遍存在：</p>
<ul>
<li><code>max_tokens</code> 约束 → 赋能了响应可控与流式体验</li>
<li>工具 JSON Schema 约束 → 赋能了结构化调用和验证</li>
<li>Todo 约束 → 赋能了复杂任务的可靠完成和可解释性</li>
</ul>
<p>好的约束不是阻碍，而是让能力更稳定、更可控的支架。</p>
<h3 data-id="heading-16">4.5 完整代码</h3>
<p>v2 是在 v1 基础上的<strong>增量扩展</strong>，不改变核心 Agent 循环：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> execute_base_tools, TodoManager, BASE_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)
WORKDIR = Path.cwd()
TODO = TodoManager()

SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的编码代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

## 执行流程
计划（使用 TodoWrite） -&gt; 使用工具行动（使用 TOOLS） -&gt; 更新任务列表 -&gt; 报告。

## 规则
- 使用 TodoWrite 跟踪多步骤任务
- 开始前将任务标记为 in_progress，完成后标记为 completed
- 优先使用工具而不是文字描述。先行动，不要只是解释。
- 完成后，总结变更内容。"""</span>

<span class="hljs-comment"># 在对话开始时显示</span>
INITIAL_REMINDER = <span class="hljs-string">"&lt;reminder&gt;使用 TodoWrite 处理多步骤任务。&lt;/reminder&gt;"</span>

<span class="hljs-comment"># 如果模型在一段时间内没有更新任务列表，则显示此提醒</span>
NAG_REMINDER = <span class="hljs-string">"&lt;reminder&gt;超过 10 轮未更新任务列表。请更新任务列表。&lt;/reminder&gt;"</span>

max_steps = <span class="hljs-number">20</span>
rounds_without_todo = <span class="hljs-number">0</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_todo</span>(<span class="hljs-params">items: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> TODO.update(items)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span><span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, args: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Dispatch tool call to implementation."""</span>
    result = execute_base_tools(name, args)
    <span class="hljs-keyword">if</span> result isnotNone:
        <span class="hljs-keyword">return</span> result

    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"TodoWrite"</span>:
        <span class="hljs-keyword">return</span> run_todo(args[<span class="hljs-string">"items"</span>])

    <span class="hljs-keyword">return</span><span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-built_in">list</span> = [], max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-keyword">global</span> rounds_without_todo

    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=BASE_TOOLS,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(block.text)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        used_todo = <span class="hljs-literal">False</span>

        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
            logger.info(<span class="hljs-string">f" [使用工具] <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)
            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"TodoWrite"</span>:
                used_todo = <span class="hljs-literal">True</span>

        <span class="hljs-keyword">if</span> used_todo:
            rounds_without_todo = <span class="hljs-number">0</span>
        <span class="hljs-keyword">else</span>:
            rounds_without_todo += <span class="hljs-number">1</span>

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">global</span> rounds_without_todo

    logger.info(<span class="hljs-string">f"Mini Claude Code v2 (with Todos) - <span class="hljs-subst">{WORKDIR}</span>"</span>)
    logger.info(<span class="hljs-string">"Type 'exit' to quit.\n"</span>)

    history = []
    first_message = <span class="hljs-literal">True</span>

    whileTrue:
        <span class="hljs-keyword">try</span>:
            user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"You: "</span>).strip()
        <span class="hljs-keyword">except</span> (EOFError, KeyboardInterrupt):
            <span class="hljs-keyword">break</span>

        ifnot user_input <span class="hljs-keyword">or</span> user_input.lower() <span class="hljs-keyword">in</span> (<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"q"</span>):
            <span class="hljs-keyword">break</span>

        content = []

        <span class="hljs-keyword">if</span> first_message:
            content.append(INITIAL_REMINDER)
            first_message = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">elif</span> rounds_without_todo &gt; max_steps:
            content.append(NAG_REMINDER)

        content.append(<span class="hljs-string">f"输入：<span class="hljs-subst">{user_input}</span>"</span>)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n"</span>.join(content)})

        <span class="hljs-keyword">try</span>:
            agent_loop(<span class="hljs-string">''</span>, history, max_steps=max_steps)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>)
            traceback.print_exc()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-17">5 v3: 子代理</h2>
<p>v2 已经有了 Todo 规划，但对于更大的任务，比如：“先探索代码库，再重构认证，然后补测试和文档”</p>
<p>单一 <code>Agent</code> 很容易撞上<strong>上下文污染与角色混乱</strong>：</p>
<ul>
<li>探索阶段读了 20 个文件，把大量细节塞进上下文</li>
<li>重构时，又在同一个上下文里继续对话</li>
<li>模型很难在「海量历史」中保持聚焦和角色清晰</li>
</ul>
<p>v3 添加了一个新工具：<strong>SubTask</strong>，它可以生成带有隔离上下文的「子代理」，每个子代理专注完成一个子任务。</p>
<h3 data-id="heading-18">5.1 问题：单 Agent 的上下文污染</h3>
<p>在 v2 中，大型任务的历史会变成这样：</p>
<pre><code class="hljs language-bash" lang="bash">主 Agent 历史：
  [探索中...] <span class="hljs-built_in">cat</span> src/auth/login.py -&gt; 500 行
  [探索中...] <span class="hljs-built_in">cat</span> src/auth/session.py -&gt; 300 行
  [探索中...] <span class="hljs-built_in">cat</span> src/models/user.py -&gt; 400 行
  ...
  （15+ 个文件内容）
  [现在重构...] <span class="hljs-string">"等等，login.py 里具体是什么来着？"</span>
</code></pre>
<p>模型需要在「聊天记录 + N 个文件内容 + Todo 列表」的混合上下文里继续工作，容易：</p>
<ul>
<li>失焦：在旧文件和新任务之间来回跳跃</li>
<li>浪费上下文：很多信息是阶段性的，只用于探索</li>
<li>难以区分角色：探索 vs 规划 vs 实现</li>
</ul>
<p>解决方案：<strong>把不同阶段委托给不同的子代理</strong>。</p>
<h3 data-id="heading-19">5.2 思路：用子代理隔离阶段</h3>
<p>把「探索 → 规划 → 实现」拆成三个子代理，每个子代理在一个干净的上下文里工作：</p>
<pre><code class="hljs language-rust" lang="rust">主 Agent 历史：
  [Task: explore] 探索代码库
    <span class="hljs-punctuation">-&gt;</span> 子代理( explore )：读取 <span class="hljs-number">20</span> 个文件
    <span class="hljs-punctuation">-&gt;</span> 返回摘要: <span class="hljs-string">"认证在 src/auth/，数据库在 src/models/..."</span>
  [Task: plan] 设计 JWT 迁移方案
    <span class="hljs-punctuation">-&gt;</span> 子代理( plan )：分析结构，输出步骤
    <span class="hljs-punctuation">-&gt;</span> 返回总结: <span class="hljs-string">"1. 添加 jwt 库 2. 创建 token 工具..."</span>
  [Task: code] 实现 JWT 重构
    <span class="hljs-punctuation">-&gt;</span> 子代理( code )：编辑文件、运行测试
    <span class="hljs-punctuation">-&gt;</span> 返回结果: <span class="hljs-string">"创建 jwt_utils.py，修改 login.py ..."</span>
  [主 Agent] 汇总更改并向用户汇报
</code></pre>
<p>对于主 Agent 来说：</p>
<ul>
<li>存的是<strong>子代理摘要</strong>，而不是全部细节</li>
<li>每个子代理内部使用和 v1/v2 相同的工具循环，但上下文是隔离的</li>
</ul>
<h3 data-id="heading-20">5.3 代理类型注册表：给不同子代理不同「角色 + 权限」</h3>
<p>通过一个简单的注册表定义不同类型代理：</p>
<pre><code class="hljs language-makefile" lang="makefile">AGENT_TYPES = {
    <span class="hljs-string">"explore"</span>: {
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"只读，用于搜索和分析代码结构"</span>,
        <span class="hljs-string">"tools"</span>: [<span class="hljs-string">"bash"</span>, <span class="hljs-string">"read_file"</span>],  <span class="hljs-comment"># 不能写</span>
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一个探索子代理，只负责搜索和分析项目代码。不要修改任何文件。返回简洁、结构化的摘要。"</span>
    },
    <span class="hljs-string">"code"</span>: {
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"完整读写能力，用于实现变更"</span>,
        <span class="hljs-string">"tools"</span>: <span class="hljs-string">"*"</span>,  <span class="hljs-comment"># 所有工具（但通常不含 Task，避免递归）</span>
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一个代码实现子代理，负责根据要求修改代码并跑测试。要高效、谨慎，做完后总结改动。"</span>
    },
    <span class="hljs-string">"plan"</span>: {
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"规划与分析，不做修改"</span>,
        <span class="hljs-string">"tools"</span>: [<span class="hljs-string">"bash"</span>, <span class="hljs-string">"read_file"</span>],  <span class="hljs-comment"># 只读</span>
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一个规划子代理，负责分析现有代码并输出编号计划。不要编辑文件，只提出可执行方案。"</span>
    }
}
</code></pre>
<p>这样可以明确区分：</p>
<ul>
<li>explore：只看不写</li>
<li>plan：只看不写，专注输出计划</li>
<li>code：可以改动代码并跑测试</li>
</ul>
<p>模型在主 Agent 中，通过 Task 工具选择 <code>agent_type</code>，从而决定<strong>派出什么「橘色」的子代理</strong>。</p>
<h3 data-id="heading-21">5.4 Task: 定义 schema + 控制每种子代理的能力边界</h3>
<h4 data-id="heading-22">5.4.1 定义 schema</h4>
<pre><code class="hljs language-makefile" lang="makefile">TASK_TOOL = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Task"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"创建一个聚焦的子任务，并用指定类型的子代理在隔离上下文中执行它。"</span>,
    <span class="hljs-string">"input_schema"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"description"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"子任务的短名称（3-5 个词），用来在日志/进度条中显示。"</span>
            },
            <span class="hljs-string">"prompt"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"详细的自然语言指令，子代理看到的用户任务描述。"</span>
            },
            <span class="hljs-string">"agent_type"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"enum"</span>: [<span class="hljs-string">"explore"</span>, <span class="hljs-string">"code"</span>, <span class="hljs-string">"plan"</span>],
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"子代理的类型（决定工具与系统提示）。"</span>
            }
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"description"</span>, <span class="hljs-string">"prompt"</span>, <span class="hljs-string">"agent_type"</span>],
    },
}
</code></pre>
<p>主 Agent 调用 Task 时，大致会传：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"探索认证代码"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prompt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"找到所有与用户登录和认证相关的文件，阅读后给出结构化摘要。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"agent_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explore"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Task 工具会启动一个子代理，子代理跑完整个 v1/v2 的工具循环，最后返回一段<strong>总结文本</strong>给主 Agent。</p>
<h4 data-id="heading-23">5.4.2 控制每种子代理的能力边界</h4>
<p><code>get_tools_for_agent</code> 的实现决定了每种子代理可以用哪些工具：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">def <span class="hljs-title">get_tools_for_agent</span><span class="hljs-params">(agent_type)</span>:
    allowed =</span> AGENT_TYPES[agent_type][<span class="hljs-string">"tools"</span>]
    <span class="hljs-keyword">if</span> allowed == <span class="hljs-string">"*"</span>:
        <span class="hljs-meta"># code 子代理：拥有所有基础工具（不包含 Task 避免递归）</span>
        <span class="hljs-keyword">return</span> [t <span class="hljs-keyword">for</span> t in BASE_TOOLS <span class="hljs-keyword">if</span> t[<span class="hljs-string">"name"</span>] != <span class="hljs-string">"Task"</span>]
    <span class="hljs-keyword">else</span>:
        <span class="hljs-meta"># explore / plan 子代理：只给指定子集</span>
        <span class="hljs-keyword">return</span> [
            t <span class="hljs-keyword">for</span> t in BASE_TOOLS
            <span class="hljs-keyword">if</span> t[<span class="hljs-string">"name"</span>] in allowed <span class="hljs-keyword">and</span> t[<span class="hljs-string">"name"</span>] != <span class="hljs-string">"Task"</span>
        ]
</code></pre>
<p>默认策略（可根据需要微调）：</p>
<ul>
<li><code>explore</code>：只读 -&gt; <code>bash + read_file</code></li>
<li><code>plan</code>：只读 -&gt; <code>bash + read_file</code></li>
<li><code>code</code>：读写/执行 -&gt; <code>bash + read_file + write_file + edit_file + TodoWrite</code>（但不含 Task）</li>
</ul>
<h3 data-id="heading-24">5.5 对比 v2 与 v3</h3>
<ul>
<li>探索/规划子代理不可能意外修改文件</li>
<li>code 子代理可以对当前子任务做完整修改与验证</li>
<li>主 Agent 负责「宏观协调」，子代理负责「局部执行」</li>
</ul>








































<table><thead><tr><th>功能</th><th>v2</th><th>v3</th></tr></thead><tbody><tr><td>上下文形态</td><td>单一上下文，不断增长</td><td>主 Agent + 多个子代理，各自隔离</td></tr><tr><td>探索行为</td><td>直接在主 Agent 中执行</td><td>通过 explore 子代理执行并总结</td></tr><tr><td>规划行为</td><td>使用 Todo + 主 Agent 自己规划</td><td>可选 plan 子代理生成更结构化的计划</td></tr><tr><td>代码修改</td><td>主 Agent 直接改</td><td>code 子代理在专用上下文中改</td></tr><tr><td>并行潜力</td><td>理论可以，但逻辑复杂</td><td>子代理天然支持并行（演示版未实现并发调度）</td></tr><tr><td/><td/><td/></tr></tbody></table>
<p>核心循环仍然是：</p>
<pre><code class="hljs language-css" lang="css">while True:
    resp = <span class="hljs-built_in">model</span>(messages, tools)
    if resp.stop_reason != <span class="hljs-string">"tool_use"</span>:
        return resp
    results = <span class="hljs-built_in">execute</span>(resp.tool_calls)
    messages.<span class="hljs-built_in">append</span>(resp)
    messages.<span class="hljs-built_in">append</span>(results)
</code></pre>
<p>v3 只是让这个循环<strong>在多个上下文中同时存在</strong>（主 Agent + 子代理），并通过 Task 工具协调这些循环。</p>
<h3 data-id="heading-25">5.6 模式：分而治之 + 上下文隔离</h3>
<p>抽象出来就是：</p>
<pre><code class="hljs language-css" lang="css">复杂任务
  └─ 主 Agent（协调者）
       ├─ 子代理 <span class="hljs-selector-tag">A</span> (explore) -&gt; 返回「结构摘要」
       ├─ 子代理 <span class="hljs-selector-tag">B</span> (plan)    -&gt; 返回「任务计划」
       └─ 子代理 C (<span class="hljs-selector-tag">code</span>)    -&gt; 返回「实现结果」
</code></pre>
<p>所有 Agent（主 + 子）的内部结构都是同一个：</p>
<ul>
<li>有工具</li>
<li>有系统提示词</li>
<li>有 <code>while True</code> 工具循环</li>
</ul>
<p>只是<strong>上下文不同、工具集不同、角色Prompt不同</strong>。</p>
<h3 data-id="heading-26">5.7 详细代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> execute_base_tools, TodoManager, get_agent_descriptions, BASE_TOOLS, SUBAGENT_ALL_TOOLS, AGENT_TYPES

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)
WORKDIR = Path.cwd()

TODO = TodoManager()

SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的编码代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

## 执行流程
计划（使用 TodoWrite）-&gt; 使用工具行动 -&gt; 执行子代理工具 -&gt; 报告。

你可以为复杂的子任务生成子代理：
<span class="hljs-subst">{get_agent_descriptions()}</span>

## 规则
- 对需要集中探索或实现的子任务使用 Task 工具
- 使用 TodoWrite 跟踪多步骤工作
- 优先使用工具而不是文字描述。先行动，不要只是解释。
- 完成后，总结变更内容。"""</span>

max_steps = <span class="hljs-number">20</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tools_for_agent</span>(<span class="hljs-params">agent_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    allowed = AGENT_TYPES.get(agent_type, {}).get(<span class="hljs-string">"tools"</span>, <span class="hljs-string">"*"</span>)

    <span class="hljs-keyword">if</span> allowed == <span class="hljs-string">"*"</span>:
        <span class="hljs-keyword">return</span> BASE_TOOLS  <span class="hljs-comment"># All base tools, but NOT Task (no recursion in demo)</span>

    <span class="hljs-keyword">return</span> [t <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> BASE_TOOLS <span class="hljs-keyword">if</span> t[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">in</span> allowed]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_task</span>(<span class="hljs-params">description: <span class="hljs-built_in">str</span>, prompt: <span class="hljs-built_in">str</span>, agent_type: <span class="hljs-built_in">str</span>, max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    在隔离的上下文中执行子代理任务。

    这是子代理机制的核心：

    1. 创建隔离的消息历史（关键：没有父级上下文！）
    2. 使用特定于代理的系统提示词
    3. 根据代理类型过滤可用工具
    4. 运行与主代理相同的查询循环
    5. 仅返回最终文本（不是中间细节）

    父代理只看到总结，保持其上下文干净。

    进度显示：
    ----------------
    运行时，我们会显示：
      [explore] find auth files ... 5 tools, 3.2s

    这在不污染主对话的情况下提供了可见性。
    """</span>
    <span class="hljs-keyword">if</span> agent_type notin AGENT_TYPES:
        <span class="hljs-keyword">return</span><span class="hljs-string">f"Error: Unknown agent type '<span class="hljs-subst">{agent_type}</span>'"</span>

    config = AGENT_TYPES[agent_type]

    sub_system = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的 <span class="hljs-subst">{agent_type}</span> 子代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

<span class="hljs-subst">{config[<span class="hljs-string">"prompt"</span>]}</span>

完成任务并返回清晰、简洁的总结。"""</span>

    sub_tools = get_tools_for_agent(agent_type)
    sub_messages = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: sub_system}, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}]

    logger.info(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{description}</span>"</span>)
    start = time.time()
    tool_count = <span class="hljs-number">0</span>

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=<span class="hljs-string">''</span>,
            messages=sub_messages,
            tools=sub_tools,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{block.text}</span>"</span>)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            logger.info(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] 第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">break</span>

        results = []

        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            tool_count += <span class="hljs-number">1</span>
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            results.append(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] 工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)
            elapsed = time.time() - start
            sys.stdout.write(
                <span class="hljs-string">f"\r      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{description}</span> ... <span class="hljs-subst">{tool_count}</span> tools, <span class="hljs-subst">{elapsed:<span class="hljs-number">.1</span>f}</span>s\n"</span>
            )
            sys.stdout.flush()

        sub_messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        sub_messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"子代理执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

    elapsed = time.time() - start
    sys.stdout.write(
        <span class="hljs-string">f"\r      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{description}</span> - done (<span class="hljs-subst">{tool_count}</span> tools, <span class="hljs-subst">{elapsed:<span class="hljs-number">.1</span>f}</span>s)\n"</span>
    )

    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
            <span class="hljs-keyword">return</span> full_text

    <span class="hljs-keyword">return</span><span class="hljs-string">"(subagent returned no text)"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, args: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    result = execute_base_tools(name, args)
    <span class="hljs-keyword">if</span> result isnotNone:
        <span class="hljs-keyword">return</span> result

    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"TodoWrite"</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> TODO.update(args[<span class="hljs-string">"items"</span>])
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span><span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>

    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"Task"</span>:
        <span class="hljs-keyword">return</span> run_task(args[<span class="hljs-string">"description"</span>], args[<span class="hljs-string">"prompt"</span>], args[<span class="hljs-string">"agent_type"</span>])

    <span class="hljs-keyword">return</span><span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-built_in">list</span>, max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=SUBAGENT_ALL_TOOLS,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(block.text)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"Task"</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] Task 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">'description'</span>, <span class="hljs-string">'subtask'</span>)}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)

            logger.info(<span class="hljs-string">f"  输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            <span class="hljs-keyword">if</span> tc.name != <span class="hljs-string">"Task"</span>:
                preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
                logger.info(<span class="hljs-string">f"  [使用工具] <span class="hljs-subst">{tc.name}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)
                
            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    logger.info(<span class="hljs-string">f"Mini Claude Code v3 (with Subagents) - <span class="hljs-subst">{WORKDIR}</span>"</span>)
    logger.info(<span class="hljs-string">f"Agent types: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(AGENT_TYPES.keys())}</span>"</span>)
    logger.info(<span class="hljs-string">"Type 'exit' to quit.\n"</span>)

    history = []

    whileTrue:
        <span class="hljs-keyword">try</span>:
            user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"You: "</span>).strip()
        <span class="hljs-keyword">except</span> (EOFError, KeyboardInterrupt):
            <span class="hljs-keyword">break</span>

        ifnot user_input <span class="hljs-keyword">or</span> user_input.lower() <span class="hljs-keyword">in</span> (<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"q"</span>):
            <span class="hljs-keyword">break</span>

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input})

        <span class="hljs-keyword">try</span>:
            agent_loop(<span class="hljs-string">''</span>, history, max_steps=max_steps)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>)
            traceback.print_exc()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-27">6 v4: Skills</h2>
<p>Skills 是知识包，不是工具本身，Skills 机制体现了一个深刻的范式转变：<strong>知识外化 (Knowledge Externalization)</strong>。</p>
<p><strong>传统方式：知识内化于参数</strong></p>
<p>传统 AI 系统中，大部分知识被封装在模型参数里：</p>
<ul>
<li>你看不到里面有什么</li>
<li>你不能精确编辑其中某一部分</li>
<li>很难在不同系统之间精确复用</li>
</ul>
<p>想让模型学会新技能，一般流程是：</p>
<ul>
<li>收集大量相关训练数据</li>
<li>准备/租用分布式训练集群</li>
<li>运行复杂的微调流程（LoRA / 全量微调等）</li>
<li>部署一个新模型版本，并维护兼容性</li>
</ul>
<p>知识被锁死在神经网络的权重矩阵中，对用户来说基本是<strong>不可见、不可编辑、不可精确复用</strong>的。</p>
<p><strong>新范式：知识外化为文档</strong></p>
<p>有了「代码执行 + 文件系统」的范式后，知识可以逐层外化：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                         知识存储层级                              │
│                                                                 │
│  Model Parameters → Context Window → File System → Skill Library│
│       (内化)            (运行时)        (持久化)       (结构化)     │
│                                                                 │
│  ←───────── 训练修改 ──────────→  ←──── 自然语言/文本编辑 ────→     │
│     需要集群、数据、专业知识              任何人都能参与               │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>关键变化：</strong></p>
<ul>
<li>过去：<strong>修改行为 = 修改参数</strong> → 需要训练 → 需要 GPU 集群 + 数据 + ML 技能</li>
<li>现在：<strong>修改行为 = 修改 SKILL.md</strong> → 就像写文档 → 任何人都可以做</li>
</ul>
<p>这类似于给 base model 外挂一个「可热插拔的知识模块」，但你不需要对模型做任何参数级别的改动。</p>
<h3 data-id="heading-28">6.1 为什么 <code>SKill</code> 这种工程范式很重要</h3>
<p><strong>民主化</strong><br/>
不再需要 ML 专业知识就能「定制模型行为」。写 Markdown 文档即可。<br/>
<strong>透明性</strong><br/>
知识存在于人类可读的 SKILL.md 中，可审计、可理解、可讨论。<br/>
<strong>复用性</strong><br/>
一个 Skill 编写一次，可以在任何兼容的 Agent 框架中加载使用。<br/>
<strong>版本控制</strong><br/>
用 Git 管理 Skill 变更：支持协作、Code Review 和回滚。<br/>
<strong>在线学习</strong><br/>
模型在更大的上下文窗口中**即时「学习」**技能内容，无需离线训练。</p>
<p>Skills 正好处在一个「可以工程化的范式」中：</p>
<ul>
<li>持久化存储（文件系统）</li>
<li>按需加载（只在需要时注入）</li>
<li>人类可编辑（Markdown 文档）</li>
</ul>
<h3 data-id="heading-29">6.2 v3 做了结构与上下文，v4 解决「知识从哪来」的问题</h3>
<p>v3 引入了子代理机制，让 <code>Agent</code> 可以：</p>
<ul>
<li>分阶段处理任务（explore / plan / code）</li>
<li>每个阶段在各自的上下文中运行</li>
</ul>
<p>但还有一个更深的问题：<strong>模型怎么知道「做这件事的正确方法」？</strong><br/>
这些不是「工具」，而是<strong>领域知识 / 专业技能</strong>，Tools 决定模型「能做什么」，Skills 决定模型「知道怎么做」。</p>
<p><strong>工具 vs 技能</strong></p>




















<table><thead><tr><th>概念</th><th>定义</th><th>例子</th></tr></thead><tbody><tr><td>Tool</td><td>模型能<strong>做什么</strong></td><td>bash, read_file, http, etc.</td></tr><tr><td>Skill</td><td>模型<strong>知道怎么做</strong></td><td>PDF 处理、MCP 构建、代码审查</td></tr></tbody></table>
<ul>
<li>Tool 是动作层面的能力（能执行什么操作）。</li>
<li>Skill 是策略/知识层面的积累（做这件事的正确方法、最佳实践）。</li>
</ul>
<p><strong>控制上下文</strong><br/>
为了控制上下文开销，Skill 被分成三层：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Layer 1:</span> <span class="hljs-string">元数据</span> <span class="hljs-string">(始终加载，极小)</span>    <span class="hljs-string">~100</span> <span class="hljs-string">tokens/skill</span>
         <span class="hljs-string">└─</span> <span class="hljs-string">name</span> <span class="hljs-string">+</span> <span class="hljs-string">description</span> <span class="hljs-string">（用于检索/展示）</span>

<span class="hljs-attr">Layer 2:</span> <span class="hljs-string">SKILL.md</span> <span class="hljs-string">正文</span> <span class="hljs-string">(触发时加载)</span> <span class="hljs-string">~2k</span> <span class="hljs-string">tokens</span> <span class="hljs-string">级别</span>
         <span class="hljs-string">└─</span> <span class="hljs-string">详细指南、分步骤说明、示例等</span>

<span class="hljs-attr">Layer 3:</span> <span class="hljs-string">资源文件</span> <span class="hljs-string">(必要时再查)</span>      <span class="hljs-string">无硬限制</span>
         <span class="hljs-string">└─</span> <span class="hljs-string">scripts/,</span> <span class="hljs-string">references/,</span> <span class="hljs-string">assets/</span> <span class="hljs-string">等</span>
</code></pre>
<p>这样可以做到：</p>
<ul>
<li>平时只把轻量的「技能列表/描述」放进 prompt（或系统提示）。</li>
<li>当模型「决定使用某个 Skill」时，再通过工具调用真正加载 SKILL.md 正文。</li>
<li>如果正文还引用了脚本/示例，可以按需再用普通文件工具读取。</li>
</ul>
<h3 data-id="heading-30">6.3 Skill 目录结构与 SKILL.md 标准</h3>
<p><strong>Skill 目录结构</strong></p>
<pre><code class="hljs language-bash" lang="bash">skills/
├── pdf/
│   └── SKILL.md          <span class="hljs-comment"># 必需</span>
├── mcp-builder/
│   ├── SKILL.md
│   └── references/       <span class="hljs-comment"># 可选（额外资料）</span>
└── code-review/
    ├── SKILL.md
    └── scripts/          <span class="hljs-comment"># 可选（示例脚本/模板）</span>
</code></pre>
<p><code>SKILL.md</code> 采用「YAML 前置 + Markdown 正文」格式：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">pdf</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">处理</span> <span class="hljs-string">PDF</span> <span class="hljs-string">文件。用于读取、创建或合并</span> <span class="hljs-string">PDF。</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">**Skill</span> <span class="hljs-string">工具定义**</span>

<span class="hljs-string">```python</span>
<span class="hljs-string">SKILL_TOOL</span> <span class="hljs-string">=</span> {
    <span class="hljs-attr">"name":</span> <span class="hljs-string">"Skill"</span>,
    <span class="hljs-attr">"description":</span> <span class="hljs-string">"加载一个技能的文档，以获得领域知识和最佳实践。"</span>,
    <span class="hljs-attr">"input_schema":</span> {
        <span class="hljs-attr">"type":</span> <span class="hljs-string">"object"</span>,
        <span class="hljs-attr">"properties":</span> {
            <span class="hljs-attr">"skill":</span> {
                <span class="hljs-attr">"type":</span> <span class="hljs-string">"string"</span>,
                <span class="hljs-attr">"description":</span> <span class="hljs-string">"要加载的 skill 名称，例如 'pdf'、'mcp-builder'。"</span>
            }
        },
        <span class="hljs-attr">"required":</span> [<span class="hljs-string">"skill"</span>],
    },
}
</code></pre>
<h3 data-id="heading-31">6.4 Skill 工具执行逻辑：缓存友好式注入</h3>
<p>关键点：<strong>Skill 内容作为 tool_result 追加到 messages 末尾</strong>，而不是修改 system prompt 或历史前缀。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_skill</span>(<span class="hljs-params">skill_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">try</span>:
        content = skill_loader.get_skill_content(skill_name)
    <span class="hljs-keyword">except</span> KeyError:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"[Skill error] Skill '<span class="hljs-subst">{skill_name}</span>' not found."</span>

    <span class="hljs-comment"># 完整 Skill 内容作为 tool_result 返回</span>
    <span class="hljs-comment"># 包在一个标签里，方便模型识别</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"""&lt;skill-loaded name="<span class="hljs-subst">{skill_name}</span>"&gt;
<span class="hljs-subst">{content}</span>
&lt;/skill-loaded&gt;

Now follow the instructions and best practices described in this skill."""</span>
</code></pre>
<p>在统一的 <code>execute_tool</code> 中：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">def <span class="hljs-title">execute_tool</span><span class="hljs-params">(name, args)</span>:
    if name =</span>= <span class="hljs-string">"Skill"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">run_skill</span>(args[<span class="hljs-string">"skill"</span>])

    # 其他工具: bash / read_file / write_file / edit_file / TodoWrite / <span class="hljs-built_in">Task</span>...
    ...
</code></pre>
<p>在 <code>agent_loop</code> 中不需要任何结构性变化，只要像处理其他工具那样处理 <code>Skill</code> 即可：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-built_in">list</span>, max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=ALL_TOOLS,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(block.text)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"Task"</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] Task 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">'description'</span>, <span class="hljs-string">'subtask'</span>)}</span>"</span>)
            <span class="hljs-keyword">elif</span> tc.name == <span class="hljs-string">"Skill"</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] 第 <span class="hljs-subst">{step}</span> 步调用 Loading skill: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">'skill'</span>, <span class="hljs-string">'?'</span>)}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)

            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)

            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"Skill"</span>:
                logger.info(<span class="hljs-string">f"  Skill loaded (<span class="hljs-subst">{<span class="hljs-built_in">len</span>(output)}</span> chars)"</span>)
            <span class="hljs-keyword">elif</span> tc.name != <span class="hljs-string">"Task"</span>:
                preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
                logger.info(<span class="hljs-string">f"  [使用工具] <span class="hljs-subst">{tc.name}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)

            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})
</code></pre>
<p>这样：</p>
<ul>
<li>Skill 内容出现在对话末尾的 <code>tool_result</code> 文本里</li>
<li>前缀（system + 之前 history）完全不变 → <strong>prompt cache 可以完全复用</strong></li>
<li>下次请求时，只需对新增的 Skill 内容和新问题部分做计算</li>
</ul>
<h3 data-id="heading-32">6.5 设计哲学：从「训练 AI」到「教育 AI」</h3>
<blockquote>
<p><strong>知识被提升为一等公民资源。</strong></p>
</blockquote>
<p>传统观点把 Agent 看作「调用工具的模型」——模型负责决策，工具负责执行，但这隐含一个前提：模型已经知道「如何使用这些工具解决问题」。</p>
<p>Skills 机制把<strong>领域知识</strong>从模型参数中剥离，做了一件事：</p>
<ul>
<li>过去：要教模型新技能 → 收集数据 + 训练</li>
<li>现在：要教模型新技能 → 写/编辑 SKILL.md 文档</li>
</ul>
<p>这是一种从「训练 AI」到「教育 AI」的转变：</p>
<ul>
<li>技术上：从参数微调 → 上下文注入</li>
<li>组织上：从 ML 团队独占 → 任何工程师/领域专家都能参与</li>
<li>工程上：从黑盒权重 → 白盒文档（可审计、可 review）</li>
</ul>
<h3 data-id="heading-33">6.6 架构图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46f9bc03162e415d8beba3a2d03b8a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=9S69O3vMDpxgvZQEgihwPi2vIlc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-34">6.7 详细代码</h3>
<pre><code class="hljs language-ini" lang="ini">import re
import sys
import time
import traceback
from pathlib import Path
from llm_factory import LLMFactory, LLMChatAdapter
from util.mylog import logger
from utils import execute_base_tools, TodoManager, AGENT_TYPES, get_agent_descriptions, SUBAGENT_ALL_TOOLS, BASE_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
<span class="hljs-attr">llm</span> = LLMFactory.create(
    <span class="hljs-attr">model_type</span>=<span class="hljs-string">"openai"</span>,
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
    <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">8192</span>
)
<span class="hljs-attr">client</span> = LLMChatAdapter(llm)
<span class="hljs-attr">WORKDIR</span> = Path.cwd()
<span class="hljs-attr">SKILLS_DIR</span> = WORKDIR / <span class="hljs-string">"skills"</span>

class SkillLoader:
    """
    从 SKILL.md 文件加载和管理技能。

    技能是一个包含以下内容的文件夹：
    - SKILL.md (必须): YAML frontmatter + markdown 说明
    - scripts/ (可选): 模型可以运行的辅助脚本
    - references/ (可选): 额外的文档
    - assets/ (可选): 模板，输出文件
    """

    def __init__(self, skills_dir: Path):
        <span class="hljs-attr">self.skills_dir</span> = skills_dir
        <span class="hljs-attr">self.skills</span> = {}
        self.load_skills()

    def parse_skill_md(self, path: Path) -&gt; dict:
        <span class="hljs-attr">content</span> = path.read_text()

        <span class="hljs-comment"># Match YAML frontmatter between --- markers</span>
        <span class="hljs-attr">match</span> = re.match(r<span class="hljs-string">"^---\s*\n(.*?)\n---\s*\n(.*)$"</span>, content, re.DOTALL)
        ifnot match:
            returnNone

        frontmatter, <span class="hljs-attr">body</span> = match.groups()

        <span class="hljs-comment"># Parse YAML-like frontmatter (simple key: value)</span>
        <span class="hljs-attr">metadata</span> = {}
        for line in frontmatter.strip().split("\n"):
            if":"in line:
                key, <span class="hljs-attr">value</span> = line.split(<span class="hljs-string">":"</span>, <span class="hljs-number">1</span>)
                metadata<span class="hljs-section">[key.strip()]</span> = value.strip().strip(""'")

        <span class="hljs-comment"># Require name and description</span>
        if"name"notin metadata or"description"notin metadata:
            returnNone

        return {
            "name": metadata<span class="hljs-section">["name"]</span>,
            "description": metadata<span class="hljs-section">["description"]</span>,
            "body": body.strip(),
            "path": path,
            "dir": path.parent,
        }

    def load_skills(self):
        ifnot self.skills_dir.exists():
            return

        for skill_dir in self.skills_dir.iterdir():
            ifnot skill_dir.is_dir():
                continue

            <span class="hljs-attr">skill_md</span> = skill_dir / <span class="hljs-string">"SKILL.md"</span>
            ifnot skill_md.exists():
                continue

            <span class="hljs-attr">skill</span> = self.parse_skill_md(skill_md)
            if skill:
                self.skills<span class="hljs-section">[skill["name"]]</span> = skill

    def get_descriptions(self) -&gt; str:
        ifnot self.skills:
            return"(no skills available)"

        return"\n".join(
            f"- {name}: {skill<span class="hljs-section">['description']</span>}"
            for name, skill in self.skills.items()
        )

    def get_skill_content(self, name: str) -&gt; str:
        if name notin self.skills:
            returnNone

        <span class="hljs-attr">skill</span> = self.skills[name]
        <span class="hljs-attr">content</span> = f<span class="hljs-string">"# Skill: {skill['name']}\n\n{skill['body']}"</span>

        <span class="hljs-attr">resources</span> = []
        for folder, label in <span class="hljs-section">[
            ("scripts", "Scripts"),
            ("references", "References"),
            ("assets", "Assets")
        ]</span>:
            <span class="hljs-attr">folder_path</span> = skill[<span class="hljs-string">"dir"</span>] / folder
            if folder_path.exists():
                <span class="hljs-attr">files</span> = list(folder_path.glob(<span class="hljs-string">"*"</span>))
                if files:
                    resources.append(f"{label}: {', '.join(f.name for f in files)}")

        if resources:
            content += f"\n\n**Available resources in {skill<span class="hljs-section">['dir']</span>}:**\n"
            content += "\n".join(f"- {r}"for r in resources)

        return content

    def list_skills(self) -&gt; list:
        return list(self.skills.keys())


<span class="hljs-attr">SKILLS</span> = SkillLoader(SKILLS_DIR)
<span class="hljs-attr">TODO</span> = TodoManager()

<span class="hljs-attr">SYSTEM</span> = f<span class="hljs-string">"""你是一个位于 {WORKDIR} 的编码代理，系统为 {sys.platform}。

## 执行流程
计划（使用 TodoWrite） -&gt; 使用工具行动 -&gt; 报告。

**可用技能**（当任务匹配时使用 Skill 工具调用）：
{SKILLS.get_descriptions()}

**可用子代理**（对于需要集中注意力的子任务，使用 Task 工具调用）：
{get_agent_descriptions()}

规则：
- 当任务匹配技能描述时，**立即**使用 Skill 工具
- 对需要集中探索或实现的子任务使用 Task 工具
- 使用 TodoWrite 跟踪多步骤工作
- 优先使用工具而不是文字描述。先行动，不要只是解释。
- 完成后，总结变更内容。"""</span>

<span class="hljs-comment"># NEW in v4: Skill tool</span>
<span class="hljs-attr">SKILL_TOOL</span> = {
    "name": "Skill",
    "description": f"""Load a skill to gain specialized knowledge for a task.

Available skills:
{SKILLS.get_descriptions()}

When to use:
- IMMEDIATELY when user task matches a skill description
- Before attempting domain-specific work (PDF, MCP, etc.)

The skill content will be injected into the conversation, giving you
detailed instructions and access to resources.""",
    "input_schema": {
        "type": "object",
        "properties": {
            "skill": {
                "type": "string",
                "description": "Name of the skill to load"
            }
        },
        "required": <span class="hljs-section">["skill"]</span>,
    },
}

<span class="hljs-attr">ALL_TOOLS</span> = SUBAGENT_ALL_TOOLS + [SKILL_TOOL]
<span class="hljs-attr">max_steps</span> = <span class="hljs-number">50</span>

def get_tools_for_agent(agent_type: str) -&gt; list:
    <span class="hljs-attr">allowed</span> = AGENT_TYPES.get(agent_type, {}).get(<span class="hljs-string">"tools"</span>, <span class="hljs-string">"*"</span>)

    if <span class="hljs-attr">allowed</span> == <span class="hljs-string">"*"</span>:
        return BASE_TOOLS  <span class="hljs-comment"># All base tools, but NOT Task (no recursion in demo)</span>

    return <span class="hljs-section">[t for t in BASE_TOOLS if t["name"]</span> in allowed]

def run_subagent_task(description: str, prompt: str, agent_type: str, max_steps: <span class="hljs-attr">int</span> = max_steps) -&gt; str:
    if agent_type notin AGENT_TYPES:
        returnf"Error: Unknown agent type '{agent_type}'"

    <span class="hljs-attr">config</span> = AGENT_TYPES[agent_type]

    <span class="hljs-attr">sub_system</span> = f<span class="hljs-string">"""你是一个位于 {WORKDIR} 的 {agent_type} 子代理，系统为 {sys.platform}。

{config["prompt"]}

完成任务并返回清晰、简洁的总结。"""</span>

    <span class="hljs-attr">sub_tools</span> = get_tools_for_agent(agent_type)
    <span class="hljs-attr">sub_messages</span> = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: sub_system}, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}]

    logger.info(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {description}")
    <span class="hljs-attr">start</span> = time.time()
    <span class="hljs-attr">tool_count</span> = <span class="hljs-number">0</span>

    <span class="hljs-attr">step</span> = <span class="hljs-number">0</span>
    while step &lt; max_steps:
        step += 1
        <span class="hljs-attr">response</span> = client.chat_with_tools(
            <span class="hljs-attr">prompt</span>=<span class="hljs-string">''</span>,
            <span class="hljs-attr">messages</span>=sub_messages,
            <span class="hljs-attr">tools</span>=sub_tools,
        )

        <span class="hljs-attr">assistant_text</span> = []
        <span class="hljs-attr">tool_calls</span> = []

        for block in response.content:
            if hasattr(block, "text"):
                assistant_text.append(block.text)
                logger.info(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {block.text}")
            if <span class="hljs-attr">block.type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        <span class="hljs-attr">full_text</span> = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            logger.info(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> 第 {step} 步结束，无工具调用")
            break

        <span class="hljs-attr">results</span> = []

        for tc in tool_calls:
            tool_count += 1
            <span class="hljs-attr">output</span> = execute_tool(tc.name, tc.input)
            results.append(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> 工具 {tc.name}, 输入: {tc.input}, 返回: {output}")
            <span class="hljs-attr">elapsed</span> = time.time() - start
            sys.stdout.write(
                f"\r      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {description} ... {tool_count} tools, {elapsed:.1f}s\n"
            )
            sys.stdout.flush()

        sub_messages.append({"role": "assistant", "content": full_text})
        <span class="hljs-attr">combined_output</span> = <span class="hljs-string">"\n"</span>.join(results)
        sub_messages.append({"role": "user", "content": f"子代理执行结果：\n{combined_output}\n\n请继续处理"})

    <span class="hljs-attr">elapsed</span> = time.time() - start
    sys.stdout.write(
        f"\r      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {description} - done ({tool_count} tools, {elapsed:.1f}s)\n"
    )

    for block in response.content:
        if hasattr(block, "text"):
            return full_text

    return"(subagent returned no text)"

def run_skill(skill_name: str) -&gt; str:
    """
    加载一项技能并将其注入到对话中。

    这是关键机制：
    1. 获取技能内容（SKILL.md 正文 + 资源提示）
    2. 将其包装在 &lt;skill-loaded&gt; 标签中返回
    3. 模型作为 tool_result（用户消息）接收此内容
    4. 模型现在"知道"如何执行任务

    为什么使用 tool_result 而不是系统提示词？
    - 系统提示词更改会使缓存失效（成本增加 20-50 倍）
    - 工具结果追加到末尾（前缀不变，缓存命中）

    这就是生产系统保持成本效益的方式。
    """
    <span class="hljs-attr">content</span> = SKILLS.get_skill_content(skill_name)

    if content isNone:
        <span class="hljs-attr">available</span> = <span class="hljs-string">", "</span>.join(SKILLS.list_skills()) or<span class="hljs-string">"none"</span>
        returnf"Error: Unknown skill '{skill_name}'. Available: {available}"

    <span class="hljs-comment"># Wrap in tags so model knows it's skill content</span>
    returnf"""&lt;skill-loaded <span class="hljs-attr">name</span>=<span class="hljs-string">"{skill_name}"</span>&gt;
{content}
&lt;/skill-loaded&gt;

Follow the instructions in the skill above to complete the user's task."""

def execute_tool(name: str, args: dict) -&gt; str:
    <span class="hljs-attr">result</span> = execute_base_tools(name, args)
    if result isnotNone:
        return result

    if <span class="hljs-attr">name</span> == <span class="hljs-string">"TodoWrite"</span>:
        try:
            return TODO.update(args<span class="hljs-section">["items"]</span>)
        except Exception as e:
            returnf"Error: {e}"

    if <span class="hljs-attr">name</span> == <span class="hljs-string">"Task"</span>:
        try:
            return run_subagent_task(args<span class="hljs-section">["description"]</span>, args<span class="hljs-section">["prompt"]</span>, args<span class="hljs-section">["agent_type"]</span>)
        except Exception as e:
            returnf"Error: {e}"

    if <span class="hljs-attr">name</span> == <span class="hljs-string">"Skill"</span>:
        try:
            return run_skill(args<span class="hljs-section">["skill"]</span>)
        except Exception as e:
            returnf"Error: {e}"

    returnf"Unknown tool: {name}"

def agent_loop(prompt: str, history: list, max_steps: <span class="hljs-attr">int</span> = max_steps) -&gt; list:
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    <span class="hljs-attr">has_system</span> = any(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span>for msg in history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(0, {"role": "system", "content": SYSTEM})

    <span class="hljs-attr">step</span> = <span class="hljs-number">0</span>
    while step &lt; max_steps:
        step += 1
        <span class="hljs-attr">response</span> = client.chat_with_tools(
            <span class="hljs-attr">prompt</span>=prompt,
            <span class="hljs-attr">messages</span>=history,
            <span class="hljs-attr">tools</span>=ALL_TOOLS,
        )

        <span class="hljs-attr">assistant_text</span> = []
        <span class="hljs-attr">tool_calls</span> = []

        for block in response.content:
            if hasattr(block, "text"):
                assistant_text.append(block.text)
                logger.info(block.text)
            if <span class="hljs-attr">block.type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        <span class="hljs-attr">full_text</span> = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({"role": "assistant", "content": full_text})
            logger.info(f"第 {step} 步结束，无工具调用")
            return history

        <span class="hljs-attr">results</span> = []
        for tc in tool_calls:
            if <span class="hljs-attr">tc.name</span> == <span class="hljs-string">"Task"</span>:
                logger.info(f"\n&gt; <span class="hljs-section">[使用工具]</span> Task 第 {step} 步调用: {tc.input.get('description', 'subtask')}")
            elif <span class="hljs-attr">tc.name</span> == <span class="hljs-string">"Skill"</span>:
                logger.info(f"\n&gt; <span class="hljs-section">[使用工具]</span> 第 {step} 步调用 Loading skill: {tc.input.get('skill', '?')}")
            else:
                logger.info(f"\n&gt; <span class="hljs-section">[使用工具]</span> {tc.name} 第 {step} 步调用: {tc.input}")

            <span class="hljs-attr">output</span> = execute_tool(tc.name, tc.input)

            if <span class="hljs-attr">tc.name</span> == <span class="hljs-string">"Skill"</span>:
                logger.info(f"  Skill loaded ({len(output)} chars)")
            elif tc.name != "Task":
                <span class="hljs-attr">preview</span> = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span>if len(output) &gt; <span class="hljs-number">200</span>else output
                logger.info(f"  <span class="hljs-section">[使用工具]</span> {tc.name}, 返回: {preview}")

            results.append(f"工具 {tc.name}, 输入: {tc.input}, 返回: {output}")

        history.append({"role": "assistant", "content": full_text})
        <span class="hljs-attr">combined_output</span> = <span class="hljs-string">"\n"</span>.join(results)
        history.append({"role": "user", "content": f"执行结果：\n{combined_output}\n\n请继续处理"})

def main():
    logger.info(f"Mini Claude Code v4 (with Skills) - {WORKDIR}")
    logger.info(f"Skills: {', '.join(SKILLS.list_skills()) or 'none'}")
    logger.info(f"Agent types: {', '.join(AGENT_TYPES.keys())}")
    logger.info("Type 'exit' to quit.\n")

    <span class="hljs-attr">history</span> = []

    whileTrue:
        try:
            <span class="hljs-attr">user_input</span> = input(<span class="hljs-string">"You: "</span>).strip()
        except (EOFError, KeyboardInterrupt):
            break

        ifnot user_input or user_input.lower() in ("exit", "quit", "q"):
            break

        history.append({"role": "user", "content": user_input})

        try:
            agent_loop('', history, <span class="hljs-attr">max_steps</span>=max_steps)
        except Exception as e:
            logger.error(f"Error: {e}")
            traceback.print_exc()

if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-35">7 总结</h2>
<p>本文通过使用 <code>deepseek-v3.2</code> 最常用的模型，通过不断规则+工具，实现最小版本的 <code>Claude Code</code>（后续功能继续完善中），代码开源地址：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/linkxzhou</span><span class="hljs-regexp">/mylib/tree</span><span class="hljs-regexp">/master/llm</span><span class="hljs-regexp">/llmapi/miniagent</span>
</code></pre>
<h2 data-id="heading-36">参考</h2>
<p>（1）<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FshareAI-lab%2Flearn-claude-code" target="_blank" title="https://github.com/shareAI-lab/learn-claude-code" ref="nofollow noopener noreferrer">github.com/shareAI-lab…</a><br/>
（2）<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinkxzhou%2FSimpleExcalidraw" target="_blank" title="https://github.com/linkxzhou/SimpleExcalidraw" ref="nofollow noopener noreferrer">github.com/linkxzhou/S…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[断网、弱网、关页都不怕：前端日志上报怎么做到不丢包]]></title>    <link>https://juejin.cn/post/7596247009815412762</link>    <guid>https://juejin.cn/post/7596247009815412762</guid>    <pubDate>2026-01-19T06:22:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596247009815412762" data-draft-id="7595842144906936370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="断网、弱网、关页都不怕：前端日志上报怎么做到不丢包"/> <meta itemprop="keywords" content="前端,JavaScript,监控"/> <meta itemprop="datePublished" content="2026-01-19T06:22:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            断网、弱网、关页都不怕：前端日志上报怎么做到不丢包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T06:22:27.000Z" title="Mon Jan 19 2026 06:22:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>系列回顾（性能·错误·埋点三部曲）：<a href="https://juejin.cn/column/7581619505585209395" target="_blank" title="https://juejin.cn/column/7581619505585209395">不做工具人｜从 0 到 1 手搓前端监控 SDK</a></p>
<p>在前三篇文章中，我们搞定了性能、行为和错误的采集。但有掘友在评论区灵魂发问：<strong>“数据是抓到了，
发不出去有啥用？进电梯断网了咋办？页面关太快请求被掐了咋办？”</strong></p>
<p>今天这篇，我们就来聊聊<strong>如何上报数据</strong>？</p>
<ul>
<li>用什么方式上报最稳、最省事?</li>
<li>什么时候上报最合适?</li>
<li>遇到断网/弱网/关页怎么兜底?</li>
</ul>
</blockquote>
<h2 data-id="heading-0">一、上报方式与策略：如何选出最优解？</h2>
<p>我们平时上报数据主要有三种方式：<strong>Image（图片请求）</strong>、<strong>sendBeacon</strong> 和 <strong>XHR/Fetch</strong>。</p>
<h3 data-id="heading-1"><strong>1. 三种上报方式详解</strong></h3>
<h4 data-id="heading-2"><strong>1. GIF/Image</strong></h4>
<p>这招就是利用图片请求（<code>new Image().src</code>）来传数据。</p>
<ul>
<li>
<p><strong>原理很简单</strong>：把要上报的数据拼在 URL 后面（如 <code>https://log.demo.com/gif?id=123</code>），浏览器发起请求，服务器解析参数拿到数据，然后返回一张 1×1 的透明GIF图（体积小、看不见），浏览器收到后触发 <code>onload</code> 回调即完成上报。</p>
</li>
<li>
<p><strong>特点</strong>：天然支持跨域，<strong>绝无“预检”请求</strong>（因为是简单请求）。</p>
</li>
<li>
<p><strong>局限</strong>：只能发 GET 请求，URL 长度有限（通常 &lt; 2KB），无法携带大数据。</p>
</li>
</ul>
<h4 data-id="heading-3"><strong>2. sendBeacon</strong></h4>
<ul>
<li>
<p><strong>原理</strong>：<code>navigator.sendBeacon(url, data)</code>。浏览器会将数据放入后台队列，<strong>即使页面关闭了，浏览器也会尽力发送</strong>。</p>
</li>
<li>
<p><strong>特点</strong>：异步非阻塞（不卡主线程），且<strong>可靠性极高</strong>。</p>
</li>
<li>
<p><strong>局限</strong>：数据量有限（约 64KB），且无法自定义复杂的请求头。</p>
</li>
</ul>
<h4 data-id="heading-4"><strong>3. XHR / Fetch</strong></h4>
<p>普通的网络请求。</p>
<ul>
<li>
<p><strong>原理</strong>：使用 <code>XMLHttpRequest</code> 或 <code>fetch</code> 发送 POST 请求。</p>
</li>
<li>
<p><strong>特点</strong>：<strong>容量极大</strong>（几兆都没问题），适合发送录屏、长堆栈。</p>
</li>
<li>
<p><strong>局限</strong>：跨域时通常会触发 <code>OPTIONS</code> 预检（成本高），且页面关闭时请求容易被掐断（fetch需配合 <code>keepalive</code>）。</p>
</li>
</ul>
<p><code>注</code>: 所谓的预检，就是浏览器在发送<strong>跨域且非简单请求</strong>前，先偷偷发个 <code>OPTIONS</code> 问服务器：“大佬，我能发这个请求吗？”。只要你用了自定义 Header 或 <code>application/json</code> 就会触发。这会导致请求量直接翻倍，在弱网下多一次往返就多一分失败的风险。</p>
<h3 data-id="heading-5"><strong>2. 策略篇：如何组合使用？</strong></h3>
<p>怎么选并不是随意决定的，而是为了解决两个核心痛点：</p>
<ol>
<li>
<p><strong>成本问题（CORS 预检）</strong>：所谓的预检，就是浏览器在发送<strong>跨域且非简单请求</strong>前，先偷偷发个 <code>OPTIONS</code> 问服务器：“大佬，我能发这个请求吗？”。</p>
<ul>
<li><strong>什么时候触发？</strong> 只要你用了自定义 Header（如 <code>X-Token</code>）或者 <code>Content-Type: application/json</code>，就会触发。</li>
<li><strong>后果是啥？</strong> 请求量直接翻倍，弱网下成功率腰斩。</li>
<li><strong>避坑指南</strong>：这也是为什么很多监控SDK通常都故意使用 <code>text/plain</code> 来发送 JSON 数据。虽然数据格式是 JSON，但告诉浏览器“这是纯文本”，就能骗过预检，直接发送！</li>
</ul>
</li>
<li>
<p><strong>存活问题（页面卸载）</strong>：用户关闭页面时，浏览器通常会直接掐断挂起的异步请求，导致“临终遗言”发不出去。</p>
</li>
</ol>
<p>基于这两个维度，我们将三种方式排个序，也就形成了我们的<strong>降级策略</strong>：</p>
<h3 data-id="heading-6"><strong>1. 首选方案：sendBeacon（六边形战士）</strong></h3>
<p><strong>这是现代浏览器的首选方案</strong>。</p>
<ul>
<li><strong>优势</strong>：专为监控设计，<strong>页面关闭了也能发</strong>（浏览器将其放入后台队列）。</li>
<li><strong>特点</strong>：容量适中（~64KB），且通常不触发预检，完美平衡了“存活”与“成本”。</li>
<li><strong>适用</strong>：绝大多数监控事件。</li>
</ul>
<h3 data-id="heading-7"><strong>2. 降级方案：GIF/Image（老牌救星）</strong></h3>
<p><strong>当 <code>sendBeacon</code> 不可用（如 IE）或数据极小的时候用它。</strong></p>
<ul>
<li><strong>优势</strong>：<strong>天然跨域，绝无预检</strong>。利用 <code>new Image().src</code> 发起请求，服务器返回一张 1x1 透明图即可。</li>
<li><strong>特点</strong>：兼容性无敌，但数据量受 URL 长度限制（~2KB），且页面关闭时发送成功率低。</li>
<li><strong>适用</strong>：PV、点击、心跳等轻量指标。</li>
</ul>
<h3 data-id="heading-8"><strong>3. 兜底方案：XHR / Fetch</strong></h3>
<p><strong>只有前两招搞不定时（数据量太大）才用它。</strong></p>
<ul>
<li><strong>优势</strong>：容量极大，适合传录屏、大段错误堆栈。</li>
<li><strong>劣势</strong>：跨域麻烦（需配 CORS），有预检成本。</li>
<li><strong>注意</strong>：使用 Fetch 时务必加 <code>keepalive: true</code>，告诉浏览器“就算页面关了也别杀我”，尽量提升卸载时的成功率。</li>
</ul>
<h3 data-id="heading-9"><strong>选型对比表</strong></h3>





































<table><thead><tr><th align="left">方案</th><th align="left">跨域/预检</th><th align="left">卸载可靠性</th><th align="left">数据容量</th><th align="left">核心优势</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><strong>sendBeacon</strong></td><td align="left">支持 / <strong>无预检</strong></td><td align="left"><strong>高</strong></td><td align="left">中 (~64KB)</td><td align="left"><strong>关页也能发</strong>，不占主线程</td><td align="left"><strong>首选</strong>，大多数监控事件</td></tr><tr><td align="left"><strong>GIF/Image</strong></td><td align="left">支持 / <strong>无预检</strong></td><td align="left">低</td><td align="left">小 (~2KB)</td><td align="left">兼容性强，无预检</td><td align="left">降级方案，PV/点击/心跳</td></tr><tr><td align="left"><strong>XHR/Fetch</strong></td><td align="left">需 CORS / 有</td><td align="left">低</td><td align="left"><strong>大</strong></td><td align="left">能传大数据</td><td align="left">错误堆栈、录屏</td></tr></tbody></table>
<hr/>
<p><strong>总结我们的代码套路（降级策略）：</strong></p>
<ol>
<li><strong>小包（&lt; 2KB，单条事件）</strong>：优先 <code>sendBeacon</code>；若不支持，再走 <code>Image</code> GET（附 <code>_ts</code> 防缓存）。</li>
<li><strong>中包（≤ 64KB）</strong>：<code>sendBeacon</code> 为首选；若不支持，回退到 <code>Fetch/XHR</code>，<code>Content-Type: text/plain</code> + <code>keepalive: true</code>。</li>
<li><strong>大包（&gt; 64KB）</strong>：<code>Fetch/XHR</code> 承载，必要时拆包分批发送。</li>
</ol>
<p>下面是封装好的 <code>transport</code>上报函数，直接拿去用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REPORT_URL</span> = <span class="hljs-string">'https://log.your-domain.com/collect'</span>; 
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_URL_LENGTH</span> = <span class="hljs-number">2048</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_BEACON_BYTES</span> = <span class="hljs-number">64</span> * <span class="hljs-number">1024</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">byteLen</span>(<span class="hljs-params">s</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encode</span>(s).<span class="hljs-property">length</span>;
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> s.<span class="hljs-property">length</span>;
  }
}

<span class="hljs-comment">/**
 * 通用上报函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object|Array</span>} <span class="hljs-variable">data</span> - 上报数据
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;void&gt;</span>} - 成功 resolve，失败 reject
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transport</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> isArray = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(data);
  <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 1. 优先尝试 sendBeacon</span>
    <span class="hljs-comment">// 注意：sendBeacon 是同步入队，返回 true 仅代表入队成功，不一定是发送成功</span>
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">sendBeacon</span> &amp;&amp; <span class="hljs-title function_">byteLen</span>(json) &lt;= <span class="hljs-variable constant_">MAX_BEACON_BYTES</span>) {
      <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([json], { <span class="hljs-attr">type</span>: <span class="hljs-string">'text/plain'</span> });
      <span class="hljs-comment">// 如果入队成功，直接 resolve（乐观策略）</span>
      <span class="hljs-keyword">if</span> (navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-variable constant_">REPORT_URL</span>, blob)) {
        <span class="hljs-title function_">resolve</span>();
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-comment">// 如果入队失败（如队列已满），不 reject，而是继续往下走降级方案</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[Beacon] 入队失败，尝试降级...'</span>);
    }

    <span class="hljs-comment">// 2. 单条小数据尝试 Image (GET)</span>
    <span class="hljs-keyword">if</span> (!isArray) {
      <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(data);
      params.<span class="hljs-title function_">append</span>(<span class="hljs-string">'_ts'</span>, <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()));
      <span class="hljs-keyword">const</span> qs = params.<span class="hljs-title function_">toString</span>();
      <span class="hljs-keyword">const</span> sep = <span class="hljs-variable constant_">REPORT_URL</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>;
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">REPORT_URL</span>.<span class="hljs-property">length</span> + sep.<span class="hljs-property">length</span> + qs.<span class="hljs-property">length</span> &lt; <span class="hljs-variable constant_">MAX_URL_LENGTH</span>) {
        <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
        img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(); <span class="hljs-comment">// 成功</span>
        img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Image 上报失败'</span>)); <span class="hljs-comment">// 失败</span>
        img.<span class="hljs-property">src</span> = <span class="hljs-variable constant_">REPORT_URL</span> + sep + qs;
        <span class="hljs-keyword">return</span>;
      }
    }

    <span class="hljs-comment">// 3. 兜底方案：Fetch &gt; XHR</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>) {
      <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">REPORT_URL</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> },
        <span class="hljs-attr">body</span>: json,
        <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 关键：允许页面关闭后继续发送</span>
      })
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (res.<span class="hljs-property">ok</span>) <span class="hljs-title function_">resolve</span>();
          <span class="hljs-keyword">else</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Fetch 失败: <span class="hljs-subst">${res.status}</span>`</span>));
        })
        .<span class="hljs-title function_">catch</span>(reject);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// IE 兼容</span>
      <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
      xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-variable constant_">REPORT_URL</span>, <span class="hljs-literal">true</span>);
      xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);
      xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) <span class="hljs-title function_">resolve</span>();
        <span class="hljs-keyword">else</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`XHR 失败: <span class="hljs-subst">${xhr.status}</span>`</span>));
      };
      xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'XHR 网络错误'</span>));
      xhr.<span class="hljs-title function_">send</span>(json);
    }
  });
}
</code></pre>
<h2 data-id="heading-10">二、上报时机：不阻塞主线程干扰业务，断网了也不丢数据</h2>
<h3 data-id="heading-11">1. 调度层：区分优先级，关键时刻不等待</h3>
<p>不是所有数据都适合“攒着发”。我们需要根据重要程度将日志分为两类：</p>
<ul>
<li>
<p><strong>即时上报（Immediate）</strong>：收集到立即上报。</p>
<ul>
<li><strong>场景</strong>：JS 报错阻断了流程、用户点击了“支付”按钮、接口返回 500 等。</li>
<li><strong>原因</strong>：这些数据对实时性要求极高，或者关系到监控系统的报警（比如线上白屏了，你得马上知道），不能因为攒着发而耽误了。</li>
</ul>
</li>
<li>
<p><strong>批量上报（Batch）</strong>：攒一波再发。</p>
<ul>
<li><strong>场景</strong>：用户点击、滚动、性能指标、API 成功日志。这类数据量大但实时性要求低</li>
<li><strong>策略</strong>：<strong>“量”与“时”双重触发（竞态关系）</strong>。比如：攒够 10 条立马发（防止堆积太多），或者每隔 5 秒发一次（防止数量不够一直不发）。</li>
</ul>
</li>
</ul>
<p>代码怎么写？其实就是一个简单的<strong>双保险调度器</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> queue = [];
<span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">QUEUE_MAX</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">QUEUE_WAIT</span> = <span class="hljs-number">5000</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flush</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!queue.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 1. 把当前队列的数据复制出来</span>
  <span class="hljs-keyword">const</span> batch = queue.<span class="hljs-title function_">slice</span>();
  
  <span class="hljs-comment">// 2. 清空队列与定时器</span>
  queue.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">clearTimeout</span>(timer);
  timer = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 3. 利用空闲时间发送（性能优化点）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'requestIdleCallback'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">transport</span>(batch), { <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span> });
  } <span class="hljs-keyword">else</span> {
     <span class="hljs-comment">// 降级兼容</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">transport</span>(batch), <span class="hljs-number">0</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">report</span>(<span class="hljs-params">log, immediate = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-comment">// 1. 紧急情况：绕过队列，直接发</span>
  <span class="hljs-keyword">if</span> (immediate) {
    <span class="hljs-title function_">transport</span>(log);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 普通情况：进入队列（如 点击、PV）</span>
  queue.<span class="hljs-title function_">push</span>({ ...log, <span class="hljs-attr">ts</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() });
  
  <span class="hljs-comment">// 3. 检查触发条件（双重保险）</span>
  <span class="hljs-keyword">if</span> (queue.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable constant_">QUEUE_MAX</span>) {
    <span class="hljs-title function_">flush</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!timer) {
    timer = <span class="hljs-built_in">setTimeout</span>(flush, <span class="hljs-variable constant_">QUEUE_WAIT</span>);
  }
}

<span class="hljs-comment">// 4. 临终兜底：页面关闭/隐藏时，强制把剩下的都发走</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">'hidden'</span>) <span class="hljs-title function_">flush</span>();
});
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pagehide'</span>, flush);
</code></pre>
<p><strong>整体思路：队列暂存 + 多重触发</strong></p>
<p>我们用一个数组（<code>queue</code>）来暂存日志，然后通过 <strong>“量够了”、“时间到了”或“页面要关了”</strong> 这三个时机来触发发送，确保既不积压也不频繁打扰服务器。</p>
<p><strong>性能优化：闲时优先</strong></p>
<p>发送时，我们首选 <code>requestIdleCallback</code>。告诉浏览器你先忙你的（渲染、响应点击），等你有空了再帮我发监控数据</p>
<ul>
<li>这样能最大限度减少对业务主线程的阻塞，让用户感觉不到监控的存在。</li>
<li>当然，如果浏览器不支持这个 API，我们再降级用 <code>setTimeout</code> 兜底。</li>
</ul>
<h3 data-id="heading-12">2. 容灾层：断网了，日志怎么办？</h3>
<p>如果在电梯里断网了或者弱网环境下，请求发不出去怎么办？日志丢了怎么办。
我们的策略是 <strong>“先记在本子上，等有网了再补交作业”</strong>：</p>
<ol>
<li><strong>断网时</strong>：把日志存到 <code>localStorage</code> 里（注意设置上限，别把用户浏览器撑爆了，可用IndexedDB优化）。</li>
<li><strong>连网时</strong>：监听 <code>online</code> 事件，把存的日志拿出来，<strong>分批</strong>发给服务器（别一次性全发过去，容易把后端打挂）。</li>
</ol>
<p><strong>具体怎么判断有没有网呢？</strong></p>
<p>通常我们用 navigator.onLine 来看。如果返回值是 false ，那肯定是没网，直接存本地。</p>
<p>但坑就坑在，这玩意儿有时候会 “撒谎” —— 比如连上了酒店 WiFi 但没登录，或者宽带欠费了。这时候它虽然显示 true （在线），但其实根本上不了网。</p>
<p>所以咱们得留一手：
哪怕它说“在线”，我们也先试着上报一下。 要是报错了发不出去，别管三七二十一，先把这条日志存本地保底（千万别丢数据），然后再去 Ping 一下看看到底是不是真断网了 ，顺便更新一下网络状态。这样最稳。</p>
<h4 data-id="heading-13"><strong>1. 网络状态的检测</strong></h4>
<p>NetworkManager这个模块专门负责盯着网络，它很聪明，只有在发送日志失败的时候才会去复核网络真伪。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">NetworkManager</span> = {
  <span class="hljs-attr">online</span>: navigator.<span class="hljs-property">onLine</span>,
  
  <span class="hljs-comment">// 初始化：盯着系统的 online/offline 事件</span>
  <span class="hljs-title function_">init</span>(<span class="hljs-params">onBackOnline</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'online'</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// 别高兴太早，先看看是不是真的能上网</span>
      <span class="hljs-keyword">const</span> realWait = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">verify</span>();
      <span class="hljs-keyword">if</span> (realWait) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">online</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-title function_">onBackOnline</span>(); <span class="hljs-comment">// 真的回网了，赶紧补传！</span>
      }
    });
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'offline'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">online</span> = <span class="hljs-literal">false</span>);
  },

  <span class="hljs-comment">// “测谎仪”：发个 HEAD 请求看看</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 请求个 favicon 或者 1x1 图片，只要响应了说明网通了</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/favicon.ico'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'HEAD'</span>, <span class="hljs-attr">cache</span>: <span class="hljs-string">'no-store'</span> });
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
};
</code></pre>
<h4 data-id="heading-14">2. 核心上报：能发就发，不行就存本地</h4>
<p>上报函数现在变得非常有弹性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reportData</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 1. 如果明确知道没网，直接存本地 (省一次请求)</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">NetworkManager</span>.<span class="hljs-property">online</span>) {
    <span class="hljs-title function_">saveToLocal</span>(data);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 尝试发送</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">transport</span>(data);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'上报请求失败:'</span>, err);
    
    <span class="hljs-comment">// 3. 不管是因为断网、超时、还是服务器挂了</span>
    <span class="hljs-comment">// 只要没成功，第一件事就是存本地！保证这条日志不丢！</span>
    <span class="hljs-title function_">saveToLocal</span>(data);

    <span class="hljs-comment">// 4. 然后再来诊断网络，决定后续策略</span>
    <span class="hljs-comment">// 只有当是网络层面的错误（如 fetch throw Error）才去怀疑网络</span>
    <span class="hljs-comment">// 如果是 500 错误，其实网是通的，不用 forceOffline</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isNetworkError</span>(err)) {
       <span class="hljs-comment">// 5. Ping 确认</span>
        <span class="hljs-title class_">NetworkManager</span>.<span class="hljs-title function_">verify</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-title class_">NetworkManager</span>.<span class="hljs-property">online</span> = res);
    }
  }
}

<span class="hljs-comment">/**
 * 判断是否为网络层面的错误
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isNetworkError</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-comment">// 原生 fetch 的网络错误通常是 TypeError: Failed to fetch</span>
  <span class="hljs-comment">// 如果是使用 Axios，则可以通过 !err.response 来判断</span>
  <span class="hljs-keyword">return</span> err <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">TypeError</span> || (err.<span class="hljs-property">request</span> &amp;&amp; !err.<span class="hljs-property">response</span>);
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RETRY_KEY</span> = <span class="hljs-string">'RETRY_LOGS'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RETRY_MAX_ITEMS</span> = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToLocal</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> raws = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">RETRY_KEY</span>);
  <span class="hljs-keyword">const</span> logs = raws ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(raws) : [];
  logs.<span class="hljs-title function_">push</span>(data);
  <span class="hljs-keyword">if</span> (logs.<span class="hljs-property">length</span> &gt; <span class="hljs-variable constant_">RETRY_MAX_ITEMS</span>) {
    logs.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, logs.<span class="hljs-property">length</span> - <span class="hljs-variable constant_">RETRY_MAX_ITEMS</span>);
  }
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">RETRY_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(logs));
}
</code></pre>
<h4 data-id="heading-15"><strong>3. 补传逻辑：别把服务器干崩了</strong></h4>
<p>等到网络恢复，本地攒了一堆“欠账”，千万别一股脑儿全发过去（万一本地存了 500 条，一次全发会把服务器打爆的）。</p>
<p>我们要<strong>有节奏</strong>地补传：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">flushLogs</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> logs = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'RETRY_LOGS'</span>) || <span class="hljs-string">'[]'</span>);
  <span class="hljs-keyword">if</span> (!logs.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[回血] 发现 <span class="hljs-subst">${logs.length}</span> 条欠账，开始补传...`</span>);

  <span class="hljs-keyword">while</span> (logs.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 1. 每次只取 5 条，小碎步走</span>
    <span class="hljs-keyword">const</span> batch = logs.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 2. 调用上报中心</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">transport</span>(batch); 
      
      <span class="hljs-comment">// 3. 只有成功了，才把这 5 条从 logs 里剔除</span>
      logs.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">RETRY_LOGS</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(logs));
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-comment">// 4. 如果失败了（断网或服务器挂了）</span>
      <span class="hljs-comment">// 此时 logs 里面还保留着那 5 条数据，所以不用担心丢失</span>
      <span class="hljs-comment">// 记录一下状态，直接跳出循环，等下次 NetworkManager 唤醒</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'补传中途失败，保留剩余欠账'</span>);
      <span class="hljs-keyword">break</span>; 
    }
    
    <span class="hljs-comment">// 2. 歇半秒钟，给正常业务请求让个道</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">500</span>));
  }
}
</code></pre>
<h2 data-id="heading-16">三、总结与实战建议</h2>
<p>监控上报这事儿看着不难，其实门道不少。要在<strong>数据不丢</strong>和<strong>不打扰用户</strong>之间找平衡，咱们得来一套“组合拳”：</p>
<ol>
<li><strong>上报方式</strong>：<strong>sendBeacon 为主，Image 为辅，XHR/Fetch 兜底</strong>。利用 <code>sendBeacon</code> 的特性解决页面卸载时的丢包问题，利用 <code>Image</code> 解决跨域预检的成本问题。</li>
<li><strong>上报时机</strong>：<strong>闲时上报 + 批量打包</strong>。利用 <code>requestIdleCallback</code> 不占用主线程，通过队列机制减少 HTTP 请求频次。</li>
<li><strong>断网处理</strong>：<strong>本地缓存 + 网络侦测</strong>。断网时将数据持久化到 LocalStorage，待网络恢复后分批补传，确保“一条都不丢”。</li>
</ol>
<p><strong>最后，给开发者的 3 个避坑小贴士：</strong></p>
<ul>
<li><strong>不要迷信 <code>navigator.onLine</code></strong>：它只能判断有没有连接到局域网，不能判断是否真的能上网。一定要配合实际的请求探测。</li>
<li><strong>控制补传节奏</strong>：网络恢复后，千万别一次性把积压的几百条日志全发出去，这属于“DDoS 攻击”自家服务器。要分批、甚至加随机延迟发送。</li>
<li><strong>隐私与合规</strong>：上报数据前，务必对敏感信息（如 Token、用户手机号）进行脱敏处理，这是红线。</li>
</ul>
<p>如果你有更好的思路，欢迎在评论区交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[征程 6 H/P 工具链 QAT 精度调优]]></title>    <link>https://juejin.cn/post/7596983314806865970</link>    <guid>https://juejin.cn/post/7596983314806865970</guid>    <pubDate>2026-01-20T04:08:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596983314806865970" data-draft-id="7596890557547118638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="征程 6 H/P 工具链 QAT 精度调优"/> <meta itemprop="keywords" content="算法,自动驾驶"/> <meta itemprop="datePublished" content="2026-01-20T04:08:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            征程 6 H/P 工具链 QAT 精度调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:08:13.000Z" title="Tue Jan 20 2026 04:08:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、QAT 调优流程</h2>
<p><strong>流程总览：</strong></p>
<blockquote>
<p>针对征程 6H/P 的硬件特性，以 int8+int16+fp16 的混合精度量化为主要调优配置，会增加较多的 fp16 设置来优化量化精度</p>
</blockquote>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YTkwY2NjYTc2NDM3Y2VhZmY2NzQ1ZjMwZTVkMWNlYThfZndxWlIxd1ZMdDBYWGZIN0NhWXhZV0lZNjRIUlc0Q3lfVG9rZW46UXBDbmJmQmROb2xvRkN4dFp5cWNBdExQblVnXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<p>注意：</p>
<p>征程 6H/P 上会用到更多 fp16 高精度和 GEMM 类算子双 int16 等的配置，为了配置方式更加简单灵活，QAT 量化工具提供了一套新的 qconfig 量化配置模板，具体使用方式和注意事项参考：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】QAT 新版 qconfig 量化模板使用教程</a></p>
<p><strong>调优原则：</strong></p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZThlNGZmMTliZDc2MGMwZmVkYmQwNmEwOTcwZTM1NjVfNUttTzRwbXF4cjhWM0EzMnVUR3VhdGV2SERpenhLblhfVG9rZW46QXFoamI5bUpwb2VhNEN4dWVNNGM4Q1I1bk5jXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<p>如上是一个标准的对称量化公式，产生误差的地方主要有：</p>
<ol>
<li>round 产生的舍入误差。例如：当采用 int8 量化，scale 为 0.0078 时，浮点数值 0.0157 对应的定点值为 round（0.0157 / 0.0078） = round（2.0128） = 2，浮点数值 0.0185 对应的定点值为 round（0.0185 / 0.0078） = round（2.3718） = 2，两者均产生了舍入误差，且由于舍入误差的存在，两者的定点值一致。 对于舍入误差，可以使用更小的 scale，这样可以使得单个定点值对应的浮点值范围变小。由于直接减小 scale 会导致截断误差，所以常用的方法是使用更高的精度类型，比如：将 int8 换成 int16，由于定点值范围变大， scale 将减小。</li>
<li>clamp 产生的截断误差。当 qmax * scale 无法覆盖需要量化的数值范围时，可能产生较大截断误差。例如：当采用 int8 量化，scale 为 0.0078 时，qmax * scale = 127 * 0.0078 = 0.9906，大于 0.9906 的值对应的定点值将被截断到 127。 对于截断误差，可以使用更大的 scale。scale 一般是由量化工具使用统计方法得到，scale 偏小的原因是校准数据不够全，校准方法不对，导致 scale 统计的不合理。比如：某一输入的理论范围为 [-1， 1]，但校准或 qat 过程中，没有观测到最大值为 1 或最小值为 -1 的样本或观测到此类样本的次数太少。应该增加此类数据或者根据数值范围，手动设置固定 scale。在截断误差不大的情况下，可以调整校准参数，通过不同的校准方法和超参缓解截断误差。</li>
</ol>
<p>因此，QAT 量化精度调优以减少上述两种误差为基本原则，下文将针对 QAT 每个阶段做调优介绍：</p>
<p>注意：</p>
<p>征程 6H/P 平台的浮点模型量化友好设计以及 QAT 模型改造等内容和征程 6E/M 一致，仍可参考该文章对应章节：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a></p>
<h3 data-id="heading-1">1.1 模型检查</h3>
<p>完成模型改造和量化配置后，调用 Prepare 接口时会对模型做算子支持和量化配置上的检查，这些检查一定程度上反映了模型量化存在的问题。对于不支持的算子将以报错的形式提醒用户，一般有两种情况：</p>
<ol>
<li>未正确进行模型的量化改造。Prepare 过程中 QAT 量化工具会对模型进行 trace 来获取完整的计算图，在这个过程中会完成算子替换等的优化，对于这些已替换的算子，输入输出类型如果是 torch.tensor 而非经过 QuantStub 转化后的 qtensor，则会触发不支持算子的报错，表现为 <code>xxx is not implemented for QTensor</code>；</li>
<li>确实存在不支持的算子。工具链已支持业界大量的常用算子，但对于部分非常见算子的不支持情况，需考虑进行算子替换或者作为算子需求向工具链团队导入。</li>
</ol>
<p>Prepare 运行成功后会在当前目录下自动保存模型检查文件 <code>model_check_result.txt</code> 和 <code>fx_graph.txt</code>，建议参考下列解读顺序：</p>
<ol>
<li>算子融合检查。算子融合作为 QAT 量化工具的标准优化手段，常见的融合组合为 Conv+ReLU+BN 和 Conv+Add 等，未融合的算子会在 txt 文件中给出，未按预期融合的算子可能是因为共享没有融合成功或者是 QAT 量化工具的融合逻辑变更（针对新版 qconfig 量化模板 enable_optimize=True 情况，见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】QAT 新版 qconfig 量化模板使用教程</a>），需要检查代码，确认未融合的情况是否符合预期：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain"># 示例：未融合的Conv+Add算子
Fusable modules are listed below:
name       type------  -------------------------
model.view_transformation.input_proj.0.0(shared) 
&lt;class'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt;
model.view_transformation._generated_add_0        
&lt;class'horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional'&gt;
</code></pre>
<p>未融合的算子对模型性能会有一定影响，对于精度的影响需视量化敏感度具体分析，一般来说，Conv/Linear+ReLU+BN 可能会因为算子复用导致未融合，此时建议手动修改融合；在 OE 3.5.0 以及之后版本使用新 qconfig 模板下，Conv+Add 默认不会融合，可不修改</p>
<ol start="2">
<li>共享模块检查。一个 module 只有一组量化参数，多次使用将会共享同一组量化参数，多次数据分布差异较大时，会产生较大误差：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain"># 示例：该共享模块被调用8次
Each module called times:
name      called times
---------  --------------   
...
model.map_head.sparse_head.decoder.gen_sineembed_for_position.div.reciprocal                          
8
</code></pre>
<p>called times &gt; 1 的模块可能有很多个，全部改写成非共享是一劳永逸的。对于修改简单且精度影响大的共享算子如 QuantStub，强烈建议取消共享；对于 DeQuantStub 算子，共享不会对模型精度产生影响，但是会影响 Debug 结果的分析，也建议取消共享，修改方式参考征程 6E/M“模型改造”章节。</p>
<p>例如下面的共享模块，量化表示的最大值为 128 * 0.0446799 ≈ 5.719，在第一次使用中，输出范围明显小于 [-5.719， 5.719]，误差较小， 第二次使用中，输出范围超出 [-5.719， 5.719]，数值被截断，产生了较大误差。两次数值范围的差异也造成了统计出的 scale 不准确，因此该共享模块必须修改</p>
<pre><code class="hljs language-Plain" lang="Plain">+-+-+-+-+-+-+--+-+-+-+-+|   | mod_name | base_op_type   | analy_op_type  | shape  | quant_dtype |  qscale |base_model_min | analy_model_min | base_model_max |   analy_model_max ||-+-+--+-+-+-+-+-+-+-+-+...| 1227 | model.map_head.sparse_head.decoder.gen_sineembed_for_position.div | horizon_plugin_pytorch.nn.div.Div  | horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional.mul  | torch.Size([1, 1600, 128])| qint8  |  0.0446799 | 0.0002146 | 0.0000000 | 4.5935526 |  4.5567998 |...| 1520 | model.map_head.sparse_head.decoder.gen_sineembed_for_position.div | horizon_plugin_pytorch.nn.div.Div  | horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional.mul | torch.Size([1, 1600, 128]) | qint8 |  0.0446799 | 0.0000000 | 0.0000000 |  6.2831225 |  5.7190272 |...
</code></pre>
<p>上面共享算子的修改方式可以参考：</p>
<pre><code class="hljs language-Plain" lang="Plain">class Model(nn.Module):def __init__(self, ) -&gt; None:super().__init__()...
        self.steps = 2for step in range(self.steps):setattr(self, f'div{step}', FloatFunctional())def forward(self, data):...for step in range(self.steps):
            data = getattr(self, f'div{step}').div(x)...
</code></pre>
<p>对于不带权重的 function 类算子都可以参考上面的拆分方式，但是也存在部分共享算子或模块带有权重参数拆分起来比较复杂，是否需要拆分建议先根据量化敏感度进行分析。带有权重参数算子拆分时需要复制权重，拆分方式可以参考：</p>
<pre><code class="hljs language-Plain" lang="Plain">class Model(nn.Module):def __init__(self, ) -&gt; None:super().__init__()...
        self.steps = 3
        self.conv0 = nn.Conv2d(...)
        shared_weight = self.conv0.weight
        shared_bias = self.conv0.bias
        for step in range(1, self.steps):setattr(self, f'conv{step}', nn.Conv2d(...))getattr(self, f'conv{step}').weight = shared_weight
            getattr(self, f'conv{step}').bias = shared_bias
  
    def forward(self, data):...for step in range(self.steps):
            data = getattr(self, f'conv{step}')(x)...
</code></pre>
<p>上述共享算子修改生效后，在 <code>model_check_result.txt</code> 文件中可见到无该算子共享相关的信息：</p>
<pre><code class="hljs language-Plain" lang="Plain"># 修改生效后下面信息将不再显示
Modules below are used multi times:
name      called times
------  --------------
xxxxx                2
</code></pre>
<p>此外，未调用的模块也会在文件中体现，<code>called times</code> 为 0，当 Calibration/QAT/模型导出出现 miss_key 时，可以检查模型中是否有模块未被 trace。</p>
<ol start="3">
<li>量化配置检查。txt 文件中会给出模型量化精度的统计信息：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain"># 算子输入量化精度统计input dtype statistics:+---+--+--+--+| module type                                                                |   torch.float32 |   qint8 |   qint16 ||---+---+--+--+| &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    |             290 |      15 |        0 || &lt;class 'horizon_plugin_pytorch.nn.qat.linear.Linear'&gt;                      |               5 |     117 |        9 || &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.DeQuantStub'&gt;                  |               0 |       8 |        0 |...# 算子输出量化精度统计
output dtype statistics:+---+--+--+--+| module type                                                                |   torch.float32 |   qint8 |   qint16 ||---+--+--+--+| &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    |               0 |     123 |      182 |...# 使用fp16量化精度的算子，量化精度统计+---+--+--+--+--+| module type                                                                |   torch.float32 |   qint8 |   qint16 |   torch.float16 ||-----+--+--+--+--|| &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    |              34 |       0 |        0 |               0 || &lt;class 'torch.nn.modules.padding.ZeroPad2d'&gt;                               |               0 |      11 |        0 |               0 || &lt;class 'horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional'&gt; |              48 |      14 |        9 |              50 |...
</code></pre>
<p>重点检查的信息有：</p>
<ul>
<li><code>&lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;</code> 的 input dtype 应为 <code>torch.float32</code>，对于 <code>qint8</code> 或者 <code>qint16</code> 的 input dtype，一般是冗余的 QuantStub 算子可以改掉，不会对精度产生影响但可能会对部署模型性能有影响（算子数量）</li>
<li>正常来说模型中的算子不应出现 <code>torch.float32</code> 的输入精度（除下文 c 情况），如上图的 <code>&lt;class 'horizon_plugin_pytorch.nn.qat.linear.Linear'&gt;</code>，需要检查是否漏插 <code>QuantStub</code> 未转定点，未转定点的算子在导出部署模型时会 cpu 计算从而影响模型性能。对于模型中的一些浮点常量 tensor，工具已支持自动插入 <code>QuantStub</code> 转定点，建议获取最新版本</li>
<li>对于 GEMM 类算子（Conv/Matmul/Linear）作为模型输出时支持高精度输出（征程 6E/M 支持 int32 输出，征程 6B/H/P 支持浮点输出），体现到这里则是 <code>&lt;class 'horizon_plugin_pytorch.nn.qat.stubs.DeQuantStub'&gt;</code> 的 input dtype 应为 <code>torch.float16</code> 或 <code>torch.float32</code>，对于 <code>qint8</code> 或 <code>qint16</code> 输入的 <code>DeQuantStub</code> 需要检查是否符合高精度输出的条件，符合条件但未高精度输出的需修改。此外对于下面左图的结构，也建议优化为右图结构来保证高精度输出的优化</li>
</ul>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NTk5YTA4YzdhOGVkNzJkMGQ4MGE5ZWMzMjRlMmE5NmVfSmdBVU95N1ZkQktYd3BsZktXaEhUS3o4VHlNamZlTVlfVG9rZW46RGZEb2Jka2dzbzBPclN4bVl2WWNZTWlRbldBXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<ul>
<li>qint8 和 qint16 算子的占比，可以协助判断是否配置全 int16 生效；torch.float16 算子的占比，可以协助判断是否配置 fp16 生效</li>
</ul>
<p>txt 文件同时会给出逐层的量化配置信息：</p>
<pre><code class="hljs language-Plain" lang="Plain"># 激活逐层qconfig
Each layer out qconfig:+--+--+--+--+--+--+| Module Name| Module Type | Input dtype | out dtype | ch_axis | observer ||--+--+--+--+--+---|# 固定scale| quant | &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    | [torch.float32] | ['qint16']| -1  | FixedScaleObserver(scale=tensor([3.0518e-05], device='cuda:0'),zero_point=tensor([0], device='cuda:0')) |# QAT训练激活scale更新| mod2.1.attn.q | &lt;class 'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt;  | ['qint16']  | ['qint16'] | -1 | MinMaxObserver(averaging_constant=0.01) |# QAT训练激活scale不更新| mod2.1.FFN.out_conv.1.0| &lt;class 'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt; | ['qint16']| ['qint16']| -1| MinMaxObserver(averaging_constant=0)  |# 激活fp16 qconfig| bev_fusion.multi_view_cross_attn.32.global_cross_window_attn._generated_add_2[add]| &lt;class 'horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional'&gt; | [torch.float16, torch.float32]                     | [torch.float16] | FakeCast(dtype=torch.float16, min_val=-0.0009765625, max_val=0.0009765625)  | |# 权重逐层qconfig
Weight qconfig:+-----+----+-----+------+---+| Module Name | Module Type | weight dtype|ch_axis|observer ||---+-------+----+----+---|| mod1.0 | &lt;class 'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt; |qint8 | 0 | MinMaxObserver(averaging_constant=0.01) |
</code></pre>
<p>重点检查的信息有：</p>
<ul>
<li>每层算子的输入输出 dtype、权重的 dtype，是否符合量化配置；若和量化配置不符合，比如配置了 int16，但是算子显示为 int8，则需要关注下算子回退信息，例如在旧模板下 Conv+Add 融合时 Conv 不支持 int16 输入，会导致前序算子输出回退到 int8。新的 qconfig 量化配置模板下算子回退过程需查看 qconfig_changelogs.txt，详细参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">developer.horizon.auto/blog/13112</a></li>
<li>配置了 fix scale 的算子，是否正确显示 FixedScaleObserver 信息，scale 值是否正确</li>
<li>逐层算子的 observer 是否正确：权重默认 MinMaxObserver，QAT 校准时激活默认 MSEObserver，QAT 训练时激活默认 MinMaxObserver</li>
<li>若为 QAT 训练阶段且配置了固定校准的激活 scale，查看 averaging_constant，判断是否生效，生效为 averaging_constant=0（即不更新 scale），默认为 0.01（更新 scale）</li>
</ul>
<p>对于 <code>fx_graph.txt</code>，可以从中获取到模型中 op/module 的上下游调用关系，例如当存在算子 <code>called times</code> 为 0 未被调用的情况，可以通过 Graph 定位到上下文算子从而定位未被调用的原因（通常因为在 init 函数中定义了但在 forward 中没有调用，也可能存在逻辑判断或循环次数变化的情况）；此外当出现导出的部署模型（bc 模型）精度异常，也可以通过 Graph 信息来排查是否是导出计算图改变导致的</p>
<pre><code class="hljs language-Plain" lang="Plain"># 模型Graph图结构信息
Graph:
opcode       name        target            args           kwargs
----         -----       -------           -------        -------
placeholder    input_0    input_0              ()         {}
call_module    quant       quant            (input_0,)     {}
call_module  traj_decoder_src_proj_0_0  traj_decoder_src_proj.0.0                                             (quant,)  {}
call_function  scope_end    &lt;function Tracer.scope_end at 0x7f4477d7dc60&gt;   ('traj_decoder_src_proj.0',) {}
call_function  __get__    &lt;method-wrapper '__get__' of getset_descriptor object at 0x7f460922b800&gt;  (traj_decoder_src_proj_0_0,) {}
call_function  __getitem__       &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;     (__get__, 0)   {}
call_function  __getitem___1      &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;   (__get__, 1)  {}
call_function  __getitem___2     &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;   (__get__, 2)   {}
call_function  __getitem___3      &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;   (__get__, 3) {}
call_function  permute     &lt;method 'permute' of 'torch._C.TensorBase' objects&gt;   (traj_decoder_src_proj_0_0, 0, 2, 3, 1)  {}...
</code></pre>
<p>重点关注的 Graph 信息：</p>
<ul>
<li><code>opcode</code> 为算子调用类型</li>
<li><code>name</code> 为当前算子名称，需注意和 <code>model_check_result.txt</code> 中的 <code>module.submodule</code> 名称区别</li>
<li><code>target</code> 为算子输出</li>
<li><code>args</code> 为算子输入</li>
</ul>
<h3 data-id="heading-2">1.2 QAT 校准</h3>
<h4 data-id="heading-3">1.2.1 int8+int16+fp16 混合精度调优</h4>
<blockquote>
<p>如果模型中吸收了前后处理的相关算子和操作，这部分默认需要 fp16 精度进行量化</p>
</blockquote>
<p>对于 int8+int16+fp16 混合精度而言，主要的量化配置如下（配置方式参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】QAT 新版 qconfig 量化模板使用教程</a>）：</p>
<ul>
<li>基础配置： TAE 算子（Conv/Matmul/Linear）双 int8、其他算子 fp16</li>
<li>精度优化配置： TAE 算子（Conv/Matmul/Linear）单 int16（部分双 int16）、其他算子 fp16</li>
<li>精度上限配置： TAE 算子（Conv/Matmul/Linear）双 int16、其他算子 fp16</li>
<li>性能上限配置： 全局 int8，建议仅在测试模型最优性能（精度无保证）或作为高精度耗时优化的对比参考时配置</li>
</ul>
<p>同样的对于较难量化的模型而言，初始应使用精度上限配置，在这个配置下解决量化流程可能的问题，优化量化风险较大的算子/模块，往往通过 Debug 工具进行定位，但在使用 Debug 工具较难定位到量化瓶颈时，可以使用分步量化的小技巧（参考本文最后章节"调优技巧"），也即对选中算子取消量化后对比精度，如定位到前后处理的算子/模块产生明显掉点，建议从模型中剥离；定位到模型中算子/模块，可以使用设置 fix_scale 和拆分共享模块等方式，或者从量化友好角度修改浮点模型（参考征程 6E/M 量化调优对应章节：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a>）</p>
<p>精度上限配置下的模型较难满足部署侧的延时要求，因此解决掉上述的量化瓶颈后需要回归到基础配置。在基础配置上通过敏感度的分析结果，增加 TAE 的 int16 算子，也就是精度优化配置。在基础配置和精度优化配置下精度达标的模型，视延时情况可能需要进一步做性能优化，主要方向为：</p>
<ol>
<li>基础配置下，回退 fp16 性能瓶颈算子到低精度 int8</li>
<li>精度优化配置下，回退双 int16 的 TAE 算子到单 int16，回退 fp16 性能瓶颈算子到低精度 int8</li>
</ol>
<p>精度优化配置下如果 int16 算子比例已超出部署预期但精度仍有一定差距，则可以考虑回退部分 int16 算子后尝试 QAT 训练；基础配置下精度表现距离浮点差距较小（<code>量化精度/浮点精度 &gt; 90%</code>，经验值），直接尝试 QAT 训练，在 <code>量化精度/浮点精度 &gt;= 95%</code>（经验值）的情况下，建议优先尝试固定校准激活 scale 的 QAT 训练（仅调整权重感知量化误差）</p>
<p>对于不同精度配置下的 QAT 校准，都有一些校准超参可以调整，需要用户结合具体模型去做调参优化，其中主要的参数有校准数据的 batch size、校准的 steps，详细的参数参考：</p>
<ol>
<li>基础调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23calibration" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#calibration" ref="nofollow noopener noreferrer">调优指南_基础调优手段</a></li>
<li>高级调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23calibration-1" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#calibration-1" ref="nofollow noopener noreferrer">调优指南_高级调优手段</a></li>
</ol>
<p>由于征程 6H/P 平台使用了较多浮点 FP16 精度，该精度下数值范围超限场景有以下常见的优化方法和优缺点总结：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ed34b77baab4e5c8e3a263def883ae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw5bmz57q_5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486893&amp;x-signature=e1GXEwkjTnUs1dAoQo85Vh%2F0fZ4%3D" alt="image.png" loading="lazy"/></p>
<p>总结：</p>
<p>int8+int16+fp16 混合精度调优的重点应放在 TAE 双 int16+ 其他算子 fp16 的调优上，这里需要把使用问题，量化不友好模块等等各种千奇百怪的问题都解决，看到模型的精度上限，然后根据模型部署的性能要求进行 TAE int8 和 int16 混合精度的调优，最后对非 TAE 算子进行 int8+fp16 混合精度的调优，最终达成部署精度和部署性能的平衡。</p>
<h4 data-id="heading-4">1.2.2 Debug 产出物解读</h4>
<p>征程 6H/P 平台 Debug 产出物的解读和征程 6E/M 一致，仍可参考该文章对应章节：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a></p>
<h6 data-id="heading-5">Badcase 调优</h6>
<p>对于实车或回灌反馈的可视化 badcase，利用 Debug 工具的调优流程为：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmY5MGIxMzk0ZTY0NWFiYzMyMTdhMzEzOTc4YzgzNzVfUGRNZ3RCNjVJdURRNlVoQThCdmlNWlM3QjdPYjZORXBfVG9rZW46Ujd2amJxUWJGb2phbEx4TmNZYmN5c2VwbmllXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">1.3 QAT 训练</h3>
<p>大部分模型仅通过 QAT 校准就可以获得较好的量化精度，对于部分较难调优的模型，以及还需要继续优化误差类指标的模型，通常校准设置的高精度比例导致延时超过部署上限，但精度仍无法达标，这种情况可以尝试 QAT 训练来获得满足预期性能-精度平衡的量化模型。</p>
<p>根据前文所述，在 QAT 校准 <code>量化精度/浮点精度 &gt;= 95%（经验值）</code> 的情况下，充分利用校准阶段较好的激活量化参数，优先尝试固定校准激活 scale 的 QAT 训练（仅调整权重感知量化误差），设置方式具体参考征程 6E/M 精度调优的“模型改造”章节：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a></p>
<p>参考浮点训练，QAT 训练在大部分配置保持和浮点训练一致的基础上，也涉及到部分超参的调整来提升量化训练的精度，例如 QAT 的学习率、weight_decay、迭代次数等，详细的参数调整策略参考：</p>
<ol>
<li>基础调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23qat" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#qat" ref="nofollow noopener noreferrer">调优指南_基础调优手段</a></li>
<li>高级调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23qat-1" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#qat-1" ref="nofollow noopener noreferrer">调优指南_高级调优手段</a></li>
</ol>
<p>浮点和 QAT 训练中都涉及到对 BN 的状态控制，在浮点训练中可能会采用 FreezeBN fine-tune 的方式来提升模型精度，在多任务训练中也会采用 FreezeBN 的技巧。因此在 QAT 训练中，提供了 FuseBN 和 WithBN 两种训练方式：</p>
<ol>
<li>FuseBN 即在 Prepare 后，QAT 训练前将 BN 的 weight 和 bias 吸收到 Conv 的 weight 和 bias 中，在训练过程中不再单独更新，这一吸收过程是无损的。FuseBN 也是 QAT 默认的训练方式。</li>
<li>WithBN 则是在 QAT 训练阶段保持 Conv+BN 不融合，带着 BN 进行训练，BN 的参数单独更新，在训练结束后转成部署模型时再做融合。浮点训练阶段如果采用了 FreezeBN 的训练方式，QAT 训练时需设置 WithBN 来对齐浮点训练方式，设置方式如下：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.qat_mode import QATMode, set_qat_mode
set_qat_mode(QATMode.WithBN)
</code></pre>
<p>通过观察 QAT 训练过程的 Loss 变化来初步判断 QAT 训练的量化效果，一般来说和浮点最后的 Loss 结果越接近越好，Loss 过大可能难以收敛，Loss 过小可能影响泛化性，对于异常的 Loss 建议的优化手段：</p>
<ol>
<li>异常 INF 和 NAN 的 Loss 值，或者初始 Loss 极大且无收敛迹象，按如下顺序排查：
<ol>
<li>去掉 prepare 模型的步骤，用 qat pipeline finetune 浮点模型，排除训练 pipeline 的问题，Loss 如果仍异常，需要检查训练链路的配置如优化器 optimizer 和 lr_updater 等</li>
<li>保持当前 QAT 训练配置，只关闭伪量化节点后观察训练的 Loss 现象，理论上和浮点有微小差异</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.quantization import set_fake_quantize, FakeQuantState
...
set_fake_quantize(qat_model, FakeQuantState._FLOAT)
train(qat_model, qat_dataloader)
</code></pre>
<ol start="2">
<li>在排查完链路问题后出现初始 Loss 较大，有收敛迹象但收敛较慢，这种情况可以尝试调整学习率，延长 QAT 迭代次数，因为 QAT 训练本质上是对已收敛浮点模型的 fine-tune，本身存在一定的随机性，用较大的学习率可以快速波动到一个理想精度（依赖一些中间权重的评测）</li>
<li>对于少数模型，QAT 训练以及尝试了多次超参调整后精度仍无法达标，建议回归 QAT 校准阶段增加少量高精度算子（增加 GEMM 类算子 int16，以及其他算子增加 FP16）、回归浮点结构检查是否还存在量化不友好的结构如使用了大量 GeLU 等（参考征程 6E/M 精度调优对应章节<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a>）</li>
</ol>
<h4 data-id="heading-7">1.3.1 QAT 训练效率</h4>
<p>由于 QAT 训练过程需要感知模型量化所带来的损失，因此模型中会被插入必要的量化相关的节点：数据观测节点 Observer 和伪量化节点 FakeQuant。数据观测节点会不断统计模型中数据的数值范围，伪量化节点会根据量化公式对数据做模拟量化和反量化，两者都会存在开销，此外就是 QAT 工具内部会对部分算子例如 LN 层做拆分算子的实现，因此相同配置下的 QAT 训练效率是会略低于浮点训练效率，具体还和模型参数规模、算子数量等有关。</p>
<p>对于用户可明显感知到的 QAT 训练效率降低，建议的优化手段有：</p>
<ol>
<li>使用 QAT 工具提供的算子，这些算子优化了训练效率，例如 MultiScaleDeformableAttention（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fplugin_api_reference%2Fhorizon_operator%2Fhorizon_plugin_pytorch_nn_MultiScaleDeformableAttention.html" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/plugin_api_reference/horizon_operator/horizon_plugin_pytorch_nn_MultiScaleDeformableAttention.html" ref="nofollow noopener noreferrer">参考手册</a> ）</li>
<li>更新到最新的 horizon-plugin-pytorch 版本，新版本会有持续的 bug fix 和新特性优化，如模型中某些结构或者算子训练耗时增加明显，可以向工具链团队导入</li>
</ol>
<h3 data-id="heading-8">1.4. 模型导出部署</h3>
<p>完成 QAT 精度调优后得到的模型仍是 PyTorch 模型，需要使用简单易用的接口来一步步导出编译成部署模型：<code>PyTorch模型 -&gt; export -&gt; convert-&gt; compile</code></p>
<blockquote>
<p>export 得到 qat.bc； convert 得到 quantized.bc； compile 得到 hbm</p>
</blockquote>
<p>由于导出生成物中计算差异的存在，对于每个生成物需简单验证其精度，可通过单张可视化或 mini 数据集，过程中如存在精度掉点，请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13149" target="_blank" title="https://developer.horizon.auto/blog/13149" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度一致性问题分析流程</a></p>
<h2 data-id="heading-9">二.调优技巧</h2>
<h3 data-id="heading-10">2.1 分部量化</h3>
<p>下面这种方式仅适用于 Calib 阶段，QAT 阶段因为模型已经适应了量化误差，关闭伪量化精度无法保证</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/955e4490db1e4319b48f2895eb21d48b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw5bmz57q_5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486893&amp;x-signature=AdzUU9SAbS1b%2FwfOf2rwzxTVvFw%3D" alt="aW1nX3YzXzAybmlfYjMwYjgwODYtOWFmNS00MmJmLTllMWYtMjVhNWMwNDE4MWRn.jpg" loading="lazy"/></p>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.utils.quant_switch import GlobalFakeQuantSwitch 
class Model(nn.Module):     
    def _init_(...):     
    def forward(self, x):         
        x = self.quant(x)         
        x = self.backbone(x)         
        x = self.neck(x)         
        GlobalFakeQuantSwitch.disable() # 使伪量化失效         # --------- float32 ---------         ​
        x = self.head(x)         
  
  

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python基础知识速刷]]></title>    <link>https://juejin.cn/post/7596955804260925490</link>    <guid>https://juejin.cn/post/7596955804260925490</guid>    <pubDate>2026-01-20T04:09:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596955804260925490" data-draft-id="7138936146792284190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python基础知识速刷"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-20T04:09:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茫茫此生何所求"/> <meta itemprop="url" content="https://juejin.cn/user/465848663552974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python基础知识速刷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848663552974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茫茫此生何所求
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:09:09.000Z" title="Tue Jan 20 2026 04:09:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">import</h2>
<ul>
<li>import modulename 导入整个模块</li>
<li>from modulename import xx 从某个模块导入部分内容</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> keyword
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv,path
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> *
</code></pre>
<h2 data-id="heading-1">保留字</h2>
<p>python提供了keyword库，可以查看所有的保留字</p>
<pre><code class="hljs language-scss" lang="scss">import keyword
<span class="hljs-built_in">print</span>(keyword.kwlist)

<span class="hljs-selector-attr">[<span class="hljs-string">'False'</span>, <span class="hljs-string">'None'</span>, <span class="hljs-string">'True'</span>, <span class="hljs-string">'__peg_parser__'</span>, <span class="hljs-string">'and'</span>, <span class="hljs-string">'as'</span>, <span class="hljs-string">'assert'</span>, <span class="hljs-string">'async'</span>, <span class="hljs-string">'await'</span>, <span class="hljs-string">'break'</span>, <span class="hljs-string">'class'</span>, <span class="hljs-string">'continue'</span>, <span class="hljs-string">'def'</span>, <span class="hljs-string">'del'</span>, <span class="hljs-string">'elif'</span>, <span class="hljs-string">'else'</span>, <span class="hljs-string">'except'</span>, <span class="hljs-string">'finally'</span>, <span class="hljs-string">'for'</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'global'</span>, <span class="hljs-string">'if'</span>, <span class="hljs-string">'import'</span>, <span class="hljs-string">'in'</span>, <span class="hljs-string">'is'</span>, <span class="hljs-string">'lambda'</span>, <span class="hljs-string">'nonlocal'</span>, <span class="hljs-string">'not'</span>, <span class="hljs-string">'or'</span>, <span class="hljs-string">'pass'</span>, <span class="hljs-string">'raise'</span>, <span class="hljs-string">'return'</span>, <span class="hljs-string">'try'</span>, <span class="hljs-string">'while'</span>, <span class="hljs-string">'with'</span>, <span class="hljs-string">'yield'</span>]</span>
</code></pre>
<h2 data-id="heading-2">注释</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 单行注释 </span>

<span class="hljs-string">''' 
多行注释1
'''</span> 

<span class="hljs-string">""" 
多行注释2
"""</span>
</code></pre>
<h2 data-id="heading-3">行与缩进</h2>
<p>代码块使用缩进控制，而不是{}，缩进格数保持一致</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">if</span> xx:
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"Answer"</span>)
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"True"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"Answer"</span>)
  <span class="hljs-built_in">print</span> (<span class="hljs-string">"False"</span>)    <span class="hljs-comment"># 缩进格数与上面不一致，运行错误</span>
</code></pre>
<h2 data-id="heading-4">多行语句</h2>
<p>一条语句如果太长，可以写成多行，行末用 \ 连接</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">y</span> = <span class="hljs-number">1</span> + \
    2 + \
    3
</code></pre>
<p>如果是[] {} ()三种括号，不用\连接，直接回车换行</p>
<h2 data-id="heading-5">控制台打印</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, World!"</span>)
</code></pre>
<h2 data-id="heading-6">单行多语句</h2>
<p>在同一行写多条语句，用分好;隔开</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-number">1</span><span class="hljs-comment">; y = 2; z = '22'</span>
</code></pre>
<h2 data-id="heading-7">变量</h2>
<ul>
<li>变量不需要声明。每个变量在使用前都必须赋值，变量赋值以后该变量才会被创建</li>
<li>变量没有类型</li>
<li>等号（=）用来给变量赋值,等号（=）运算符左边是一个变量名,等号（=）运算符右边是存储在变量中的值</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
<span class="hljs-attr">y</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
<span class="hljs-attr">z</span> = <span class="hljs-string">'22'</span>
</code></pre>
<p>声明多个变量及赋值</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = y = z = <span class="hljs-number">1</span>
a,b,<span class="hljs-attr">c</span> = <span class="hljs-number">1</span>,<span class="hljs-string">'2'</span>,<span class="hljs-number">1.0</span>
</code></pre>
<p>del 删除对象引用</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = y = z = <span class="hljs-number">1</span>
del x,y
</code></pre>
<h2 data-id="heading-8">数据类型</h2>
<p>Python3 的六个标准数据类型中：</p>
<ul>
<li>不可变数据（3 个）：
<ul>
<li>Number（数字）</li>
<li>String（字符串）</li>
<li>Tuple（元组）；</li>
</ul>
</li>
<li>可变数据（3 个）：
<ul>
<li>List（列表）</li>
<li>Dictionary（字典）</li>
<li>Set（集合）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">数字类型</h2>
<p>python中数字有四种类型：整数、布尔型、浮点数和复数</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">y</span> = <span class="hljs-number">1.0</span>
<span class="hljs-attr">z</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># False,bool 是 int 的子类，True 和 False 可以和数字相加， True==1、False==0 会返回 **True**，但可以通过 is 来判断类型。</span>
<span class="hljs-attr">w</span> = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>j
</code></pre>
<p>数值运算</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>+<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>-<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>*<span class="hljs-number">3</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>/<span class="hljs-number">2</span>)  #  <span class="hljs-number">0.5</span>除法，得到小数
<span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>//<span class="hljs-number">2</span>)  # <span class="hljs-number">0</span>   除法，取整，不四舍五入
<span class="hljs-built_in">print</span>(<span class="hljs-number">5%</span><span class="hljs-number">2</span>)  # <span class="hljs-number">1</span>  取余
<span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>**<span class="hljs-number">3</span>)  # <span class="hljs-number">8</span>   指数
</code></pre>
<h2 data-id="heading-10">字符串类型</h2>
<p>中单引号 ' 和双引号 " 使用完全相同，但是要成对儿使用。
python中没有字符类型，单个字符也是字符串</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-string">'a'</span>
<span class="hljs-attr">y</span> = <span class="hljs-string">"b"</span>
<span class="hljs-attr">z</span> = x + y   <span class="hljs-comment"># ab，字符串连接</span>
<span class="hljs-attr">w</span> = x * <span class="hljs-number">3</span>   <span class="hljs-comment"># aaa，*表示重复几次</span>
</code></pre>
<p>字符串访问，索引：</p>
<ul>
<li>正向索引,从0开始  ：0,1,2,3,...,n-1</li>
<li>反向索引，从-1开始：-n,...,-4,-3,-2,-1</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">str</span> = <span class="hljs-string">'123456789'</span>

<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)  <span class="hljs-comment"># 输出字符串</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">0</span>:-<span class="hljs-number">1</span>])  <span class="hljs-comment"># 输出第一个到倒数第二个的所有字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 输出字符串第一个字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">2</span>:<span class="hljs-number">5</span>])  <span class="hljs-comment"># 输出从第三个开始到第五个的字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">2</span>:])  <span class="hljs-comment"># 输出从第三个开始后的所有字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">1</span>:<span class="hljs-number">5</span>:<span class="hljs-number">2</span>])  <span class="hljs-comment"># 输出从第二个开始到第五个且每隔一个的字符（步长为2）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span> * <span class="hljs-number">2</span>)  <span class="hljs-comment"># 输出字符串两次</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'1'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'1'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>)

</code></pre>
<p>转义字符</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">'hello\nrunoob'</span>)  <span class="hljs-comment"># 使用反斜杠()+n转义特殊字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">r'hello\nrunoob'</span>)  <span class="hljs-comment"># 在字符串前面添加一个 r，表示原始字符串，不会发生转义</span>

输出：
hello
runoob
hello\nrunoob
</code></pre>
<p>字符串格式化</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">print</span> (<span class="hljs-string">"我叫 %s 今年 %d 岁!"</span> % (<span class="hljs-string">'小明'</span>, <span class="hljs-number">10</span>))  <span class="hljs-comment"># 字符串格式化 </span>
</code></pre>
<ul>
<li>%c  格式化字符及其ASCII码</li>
<li>%s  格式化字符串</li>
<li>%d  格式化整数</li>
<li>%u  格式化无符号整型</li>
<li>%o  格式化无符号八进制数</li>
<li>%x  格式化无符号十六进制数</li>
<li>%X  格式化无符号十六进制数（大写）</li>
<li>%f  格式化浮点数字，可指定小数点后的精度</li>
<li>%e  用科学计数法格式化浮点数</li>
<li>%E  作用同%e，用科学计数法格式化浮点数</li>
<li>%g  %f和%e的简写</li>
<li>%G  %f 和 %E 的简写</li>
<li>%p  用十六进制数格式化变量的地址</li>
</ul>
<p>f-string</p>
<p>格式化字符串以 f 开头，后面跟着字符串，字符串中的表达式用大括号 {} 包起来，它会将变量或表达式计算后的值替换进去</p>
<pre><code class="hljs language-python" lang="python">name = <span class="hljs-string">"zhangs"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"hello <span class="hljs-subst">{name}</span>"</span>)
</code></pre>
<p>字符串方法：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">name</span> = "<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  "
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">capitalize</span>())  <span class="hljs-selector-id">#Ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cabc</span>,字符串第一个字符大写
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">center</span>(<span class="hljs-number">20</span>,<span class="hljs-string">"*"</span>))  #***<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  ****,返回一个指定的宽度<span class="hljs-selector-tag">width</span>局中的字符串，第二个参数是填充的字符，不传默认空格
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">count</span>(<span class="hljs-string">"a"</span>,<span class="hljs-number">1</span>,<span class="hljs-number">7</span>))  <span class="hljs-selector-id">#1</span>,返回指定字符在字符串中出现的次数，第二三个参数用于指定范围
<span class="hljs-selector-tag">encode_name</span> = <span class="hljs-selector-tag">name</span><span class="hljs-selector-class">.encode</span>(<span class="hljs-string">"UTF-8"</span>)  #编码<span class="hljs-selector-tag">utf-8</span>
<span class="hljs-selector-tag">print</span>(encode_name)  # <span class="hljs-selector-tag">b</span>'<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  '
<span class="hljs-selector-tag">print</span>(encode_name.<span class="hljs-built_in">decode</span>(<span class="hljs-string">"UTF-8"</span>,<span class="hljs-string">"strict"</span>))  <span class="hljs-selector-id">#ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>   用于解码
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">endswith</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">2</span>,<span class="hljs-number">7</span>))  <span class="hljs-selector-id">#False</span>  指定范围内，检测是否以指定字符结尾
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">startswith</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">2</span>,<span class="hljs-number">7</span>))  <span class="hljs-selector-id">#False</span>  检查字符串是否是以指定子字符串 <span class="hljs-selector-tag">substr</span> 开头，是则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>。如果<span class="hljs-selector-tag">beg</span> 和 <span class="hljs-selector-tag">end</span> 指定值，则在指定范围内检查。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">expandtabs</span>(<span class="hljs-number">8</span>))  <span class="hljs-selector-id">#ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  把字符串 <span class="hljs-selector-tag">string</span> 中的 <span class="hljs-selector-tag">tab</span> 符号转为空格，<span class="hljs-selector-tag">tab</span> 符号默认的空格数是 <span class="hljs-number">8</span> 。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">find</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>))  <span class="hljs-selector-id">#3</span>  检测 <span class="hljs-selector-tag">str</span> 是否包含在字符串中，如果指定范围 <span class="hljs-selector-tag">beg</span> 和 <span class="hljs-selector-tag">end</span> ，则检查是否包含在指定范围内，如果包含返回开始的索引值，否则返回<span class="hljs-selector-tag">-1</span>
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">rfind</span>(<span class="hljs-string">"c"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>))  <span class="hljs-selector-id">#3</span>  类似于 <span class="hljs-selector-tag">find</span>()函数，不过是从右边开始查找.

<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">index</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>))  <span class="hljs-selector-id">#3</span>  跟<span class="hljs-selector-tag">find</span>()方法一样，只不过如果<span class="hljs-selector-tag">str</span>不在字符串中会报一个异常。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">rindex</span>(<span class="hljs-string">"c"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>))  <span class="hljs-selector-id">#7</span>  类似于 <span class="hljs-selector-tag">index</span>()，不过是从右边开始.
<span class="hljs-selector-tag">name1</span> = "<span class="hljs-number">124</span><span class="hljs-selector-tag">abc</span>"
<span class="hljs-selector-tag">print</span>(name1.<span class="hljs-built_in">isalnum</span>())  <span class="hljs-selector-id">#True</span>  如果字符串至少有一个字符并且所有字符都是字母或数字则返 回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">name2</span> = "<span class="hljs-number">124</span>中问"
<span class="hljs-selector-tag">print</span>(name2.<span class="hljs-built_in">isalpha</span>())  <span class="hljs-selector-id">#False</span>  如果字符串至少有一个字符并且所有字符都是字母或中文字则返回 <span class="hljs-selector-tag">True</span>, 否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">name3</span> = "<span class="hljs-number">124</span>"
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">isdigit</span>())  <span class="hljs-selector-id">#False</span>  如果字符串只包含数字则返回 <span class="hljs-selector-tag">True</span> 否则返回 <span class="hljs-selector-tag">False</span>..
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">islower</span>())  <span class="hljs-selector-id">#False</span>   如果字符串中包含至少一个区分大小写的字符，并且所有这些(区分大小写的)字符都是小写，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">isnumeric</span>())  <span class="hljs-selector-id">#False</span>   如果字符串中只包含数字字符，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">name4</span> = "    "
<span class="hljs-selector-tag">print</span>(name4.<span class="hljs-built_in">isspace</span>())  <span class="hljs-selector-id">#True</span>  如果字符串中只包含空白，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>.
<span class="hljs-selector-tag">name5</span> = "<span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">Is</span> <span class="hljs-selector-tag">Title</span>"
<span class="hljs-selector-tag">print</span>(name5.<span class="hljs-built_in">istitle</span>())  <span class="hljs-selector-id">#True</span>  如果字符串中所有的单词拼写首字母是否为大写，且其他字母为小写则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>.
<span class="hljs-selector-tag">name10</span> = "<span class="hljs-selector-tag">this</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">title</span>"
<span class="hljs-selector-tag">print</span>(name10.<span class="hljs-built_in">title</span>())  <span class="hljs-selector-id">#This</span> <span class="hljs-selector-tag">Is</span> <span class="hljs-selector-tag">Title</span>  返回"标题化"的字符串,就是说所有单词都是以大写开始，其余字母均为小写(见 <span class="hljs-built_in">istitle</span>())
<span class="hljs-selector-tag">name6</span> = "<span class="hljs-selector-tag">LISI</span>"
<span class="hljs-selector-tag">print</span>(name6.<span class="hljs-built_in">isupper</span>())  <span class="hljs-selector-id">#True</span>  如果字符串中包含至少一个区分大小写的字符，并且所有这些(区分大小写的)字符都是大写，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">s1</span> = "<span class="hljs-selector-tag">-</span>"
<span class="hljs-selector-tag">s2</span> = ""
<span class="hljs-selector-tag">seq</span> = (<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>)  # 字符串序列
<span class="hljs-selector-tag">print</span>(s1.<span class="hljs-built_in">join</span>(seq))  # <span class="hljs-selector-tag">a</span><span class="hljs-selector-tag">-b-c-d</span>,返回通过指定字符连接序列中元素后生成的新字符串。
<span class="hljs-selector-tag">print</span>(s2.<span class="hljs-built_in">join</span>(seq))  # <span class="hljs-selector-tag">abcd</span>

<span class="hljs-selector-tag">print</span>(<span class="hljs-built_in">len</span>(name))  <span class="hljs-selector-id">#13</span>  返回字符串长度
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">20</span>,<span class="hljs-string">"*"</span>))  <span class="hljs-selector-id">#ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  *******    返回一个原字符串左对齐,并使用空格填充至指定长度的新字符串。如果指定的长度小于原字符串的长度则返回原字符串。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">rjust</span>(<span class="hljs-number">20</span>, <span class="hljs-string">"*"</span>))  #*******<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>    返回一个原字符串右对齐,并使用<span class="hljs-selector-tag">fillchar</span>(默认空格）填充至长度 width 的新字符串
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">zfill</span>(<span class="hljs-number">20</span>))  #<span class="hljs-number">0000000</span>ab cab cABC    返回长度为 width 的字符串，原字符串右对齐，前面填充<span class="hljs-number">0</span>
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">lower</span>())  #ab cab cabc   返回将字符串中所有大写字符转换为小写后生成的字符串。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">upper</span>())  #AB CAB CABC   返回将字符串中所有小写字符转换为大写后生成的字符串。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">swapcase</span>())  #AB CAB Cabc   将字符串中大写转换为小写，小写转换为大写
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">lstrip</span>(<span class="hljs-string">" "</span>))  #ab cab cABC  截掉字符串左边的空格或指定字符。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">rstrip</span>(<span class="hljs-string">" "</span>))  #ab cab cABC  删除字符串末尾的空格或指定字符。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">strip</span>(<span class="hljs-string">" "</span>))   #ab cab cABC  在字符串上执行 <span class="hljs-built_in">lstrip</span>()和 <span class="hljs-built_in">rstrip</span>()
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">max</span>(name))  #c返回字符串中最大的字母
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">min</span>(name))  #   返回字符串中最小的字母
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">replace</span>(<span class="hljs-string">"a"</span>,<span class="hljs-string">"z"</span>,<span class="hljs-number">4</span>))  #zb czb cABC   把 将字符串中的 old 替换成 new,如果 max 指定，则替换不超过 max 次。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">split</span>(<span class="hljs-string">" "</span>,<span class="hljs-number">3</span>))  #[<span class="hljs-string">'ab'</span>, <span class="hljs-string">'cab'</span>, <span class="hljs-string">'cABC'</span>, <span class="hljs-string">' '</span>]  以 str 为分隔符截取字符串，如果 num 有指定值，则仅截取 num+<span class="hljs-number">1</span> 个子字符串
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">splitlines</span>())  #[<span class="hljs-string">'ab cab cABC  '</span>]  按照行(<span class="hljs-string">'\r'</span>, <span class="hljs-string">'\r\n'</span>, \n')分隔，返回一个包含各行作为元素的列表，如果参数 keepends 为 False，不包含换行符，如果为 True，则保留换行符。

intab = <span class="hljs-string">"aeiou"</span>
outtab = <span class="hljs-string">"12345"</span>
trantab = str.<span class="hljs-built_in">maketrans</span>(intab, outtab)  # 制作翻译表
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">translate</span>(trantab))  #<span class="hljs-number">1</span>b c1b cABC    返回翻译后的字符串,若给出了 delete 参数，则将原来的bytes中的属于delete的字符删除，剩下的字符要按照table中给出的映射来进行映射 。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">isdecimal</span>())  #False   检查字符串是否只包含十进制字符，如果是返回 true，否则返回 false。
</code></pre>
<h2 data-id="heading-11">列表List</h2>
<p>索引：</p>
<ul>
<li>正向索引,从0开始  ：0,1,2,3,...,n-1</li>
<li>反向索引，从-1开始：-n,...,-4,-3,-2,-1</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(list)  # 输出完整列表
<span class="hljs-built_in">print</span>(list[<span class="hljs-number">0</span>])  # 输出列表第一个元素
<span class="hljs-built_in">print</span>(list[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>])  # 从第二个开始输出到第三个元素
<span class="hljs-built_in">print</span>(list[<span class="hljs-number">2</span>:])  # 输出从第三个元素开始的所有元素
<span class="hljs-built_in">print</span>(list2 * <span class="hljs-number">3</span>)  # 输出三次列表
<span class="hljs-built_in">print</span>(list + list2)  # 连接列表

输出：
<span class="hljs-selector-attr">[1, 2.3, <span class="hljs-string">'abc'</span>, <span class="hljs-string">'hello'</span>, 4.3j]</span>
<span class="hljs-number">1</span>
<span class="hljs-selector-attr">[2.3, <span class="hljs-string">'abc'</span>]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'abc'</span>, <span class="hljs-string">'hello'</span>, 4.3j]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>]</span>
<span class="hljs-selector-attr">[1, 2.3, <span class="hljs-string">'abc'</span>, <span class="hljs-string">'hello'</span>, 4.3j, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>]</span>
</code></pre>
<p>列表函数：</p>
<ul>
<li>append  末尾添加元素</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list1 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>,<span class="hljs-string">"bbb"</span>,<span class="hljs-string">"ccc"</span>,<span class="hljs-string">"ddd"</span>,<span class="hljs-string">"eee"</span>,<span class="hljs-string">"fff"</span>]</span>
list1<span class="hljs-selector-class">.append</span>("ggg")   
<span class="hljs-built_in">print</span>(list1)   #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'eee'</span>, <span class="hljs-string">'fff'</span>, <span class="hljs-string">'ggg'</span>]</span>  
</code></pre>
<ul>
<li>del  删除指定index的元素</li>
</ul>

<pre><code class="hljs language-css" lang="css">list2 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"ddd"</span>, <span class="hljs-string">"eee"</span>, <span class="hljs-string">"fff"</span>]</span>
<span class="hljs-selector-tag">del</span> list2<span class="hljs-selector-attr">[2]</span>     
print(list2    #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'eee'</span>, <span class="hljs-string">'fff'</span>]</span> 
</code></pre>
<ul>
<li>remove  移除列表中某个值的第一个匹配项</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list3 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"fff"</span>]</span>
list3<span class="hljs-selector-class">.remove</span>("ccc")    
<span class="hljs-built_in">print</span>(list3)    #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'fff'</span>]</span> 
</code></pre>
<ul>
<li>len  列表长度</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list4</span> = [<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"fff"</span>]
print(len(list4))  <span class="hljs-comment">#6   </span>
</code></pre>
<ul>
<li>加号 + 连接两个列表</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list5 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>]</span>
list6 = <span class="hljs-selector-attr">[<span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"fff"</span>]</span>
<span class="hljs-built_in">print</span>(list5+list6)  #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'fff'</span>]</span>   
</code></pre>
<ul>
<li>乘号 * 内容重复指定次数</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list7 = <span class="hljs-selector-attr">[<span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>]</span>
<span class="hljs-built_in">print</span>(list7 * <span class="hljs-number">4</span>)  #<span class="hljs-selector-attr">[<span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>]</span>   
</code></pre>
<ul>
<li>in 是否包含元素</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">list17 = [<span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">"ddd"</span> <span class="hljs-keyword">in</span> list17)  <span class="hljs-comment">#True  </span>
</code></pre>
<ul>
<li>for 迭代遍历</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> list7:  
    <span class="hljs-built_in">print</span>(x)
</code></pre>
<ul>
<li>eq  比较两个列的元素是否一一相等</li>
</ul>

<pre><code class="hljs language-perl" lang="perl">a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
b = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
c = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-keyword">print</span>(<span class="hljs-string">"operator.eq(a,b): "</span>, operator.e<span class="hljs-string">q(a, b)</span>)  <span class="hljs-comment">#False   </span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"operator.eq(c,b): "</span>, operator.e<span class="hljs-string">q(c, b)</span>)  <span class="hljs-comment">#True</span>
</code></pre>
<ul>
<li>max  min  返回列表中最大、最小的元素</li>
</ul>

<pre><code class="hljs language-python" lang="python">list8 = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">max</span>(list8))  <span class="hljs-comment">#7   返回列表中最大的元素</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">min</span>(list8))  <span class="hljs-comment">#1   返回列表中最小的元素</span>
</code></pre>
<ul>
<li>list(tuple)  元组转为列表</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">tuple1 = (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>)
<span class="hljs-built_in">print</span>(list(tuple1))   #<span class="hljs-selector-attr">[1, 2, 4, 5, 6]</span>   
</code></pre>
<ul>
<li>count  统计指定元素出现的次数</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list9</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>]
print(list9.count(1))   <span class="hljs-comment">#3   </span>
</code></pre>
<ul>
<li>extend  将指定的元组、集合，扩展到列表末</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"># 列表
language = <span class="hljs-selector-attr">[<span class="hljs-string">'French'</span>, <span class="hljs-string">'English'</span>, <span class="hljs-string">'German'</span>]</span>
# 元组
language_tuple = ('Spanish', 'Portuguese')
# 集合
language_set = {'Chinese', 'Japanese'}
# 添加元组元素到列表末尾
language<span class="hljs-selector-class">.extend</span>(language_tuple)   #扩展元组
<span class="hljs-built_in">print</span>('新列表: ', language)   #<span class="hljs-selector-attr">[<span class="hljs-string">'French'</span>, <span class="hljs-string">'English'</span>, <span class="hljs-string">'German'</span>, <span class="hljs-string">'Spanish'</span>, <span class="hljs-string">'Portuguese'</span>]</span>
# 添加集合元素到列表末尾
language<span class="hljs-selector-class">.extend</span>(language_set)  #扩展集合
<span class="hljs-built_in">print</span>('新列表: ', language)  # <span class="hljs-selector-attr">[<span class="hljs-string">'French'</span>, <span class="hljs-string">'English'</span>, <span class="hljs-string">'German'</span>, <span class="hljs-string">'Spanish'</span>, <span class="hljs-string">'Portuguese'</span>, <span class="hljs-string">'Japanese'</span>, <span class="hljs-string">'Chinese'</span>]</span>
</code></pre>
<ul>
<li>index   从列表中找出某个值第一个匹配项的索引位置</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list10</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>]
print(list10.index(3,2,6))  <span class="hljs-comment">#2   从列表中找出某个值第一个匹配项的索引位置</span>
</code></pre>
<ul>
<li>insert  在指定索引处插入元素</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list11 = <span class="hljs-selector-attr">[1, 2, 3, 1, 5, 1, 7]</span>
list11<span class="hljs-selector-class">.insert</span>(<span class="hljs-number">2</span>,<span class="hljs-number">99</span>)  #<span class="hljs-selector-attr">[1, 2, 99, 3, 1, 5, 1, 7]</span>   在指定索引处插入元素
<span class="hljs-built_in">print</span>(list11)
</code></pre>
<ul>
<li>pop 移除列表中的一个元素（默认最后一个元素），并且返回该元素的值</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list11 = <span class="hljs-selector-attr">[1, 2, 99，3, 1, 5, 1, 7]</span>
list11<span class="hljs-selector-class">.pop</span>(-<span class="hljs-number">2</span>)  #
<span class="hljs-built_in">print</span>(list11)   # <span class="hljs-selector-attr">[1, 2, 99, 3, 1, 5,  7]</span> 
</code></pre>
<ul>
<li>reverse  列表翻转</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">list12 = <span class="hljs-selector-attr">[1, 2, 3, 4, 5, 6, 7]</span>
list12<span class="hljs-selector-class">.reverse</span>()
<span class="hljs-built_in">print</span>(list12)  #<span class="hljs-selector-attr">[7, 6, 5, 4, 3, 2, 1]</span>    列表翻转

</code></pre>
<ul>
<li>sort  对列表元素排序</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list13</span> = [ <span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,<span class="hljs-number">8</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>]
list13.sort()  <span class="hljs-comment">#[1, 2, 3, 3, 3, 4, 5, 8]   对列表元素排序</span>
print(list13)

<span class="hljs-comment"># 获取列表的第二个元素</span>
def takeSecond(elem):
    return elem<span class="hljs-section">[1]</span>
<span class="hljs-comment"># 列表</span>
<span class="hljs-attr">list14</span> = [(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">4</span>, <span class="hljs-number">1</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)]
<span class="hljs-comment"># 指定第二个元素排序  reverse升序还是降序，True降序  False升序</span>
list14.sort(<span class="hljs-attr">key</span>=takeSecond,reverse=<span class="hljs-literal">True</span>)    <span class="hljs-comment">#  [(3, 4), (1, 3), (2, 2), (4, 1)]</span>
<span class="hljs-comment"># 输出类别</span>
print('排序列表：', list14)
</code></pre>
<ul>
<li>clear 清空列表</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list15 = <span class="hljs-selector-attr">[(2, 2), (3, 4), (4, 1), (1, 3)]</span>
list15<span class="hljs-selector-class">.clear</span>()  #清空列表
<span class="hljs-built_in">print</span>(list15)   # <span class="hljs-selector-attr">[]</span>
</code></pre>
<ul>
<li>copy 复制列表元素</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list16</span> = [(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">4</span>, <span class="hljs-number">1</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)]
<span class="hljs-attr">list17</span> = list16.copy()  <span class="hljs-comment">#[(2, 2), (3, 4), (4, 1), (1, 3)]    </span>
print(list17)
</code></pre>
<h2 data-id="heading-12">元组</h2>
<ul>
<li>元祖与列表类似，列表用[],元祖用（）</li>
<li>元组元素不能修改，即,不能进行<code>tuple[1]=34的操作</code>,列表可以<code>list[1]=22</code></li>
</ul>
<p>索引：</p>
<ul>
<li>正向索引,从0开始  ：0,1,2,3,...,n-1</li>
<li>反向索引，从-1开始：-n,...,-4,-3,-2,-1</li>
</ul>
<p>元组常用函数：</p>
<ul>
<li>创建元组</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tuple</span> = (<span class="hljs-string">'aa'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3</span>j)  <span class="hljs-comment"># 创建元组  方式1</span>
<span class="hljs-attr">tuple2</span> = (<span class="hljs-number">123</span>, <span class="hljs-string">'bb'</span>)  <span class="hljs-comment"># 创建元组  方式2</span>
<span class="hljs-attr">tuple3</span> = <span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>  <span class="hljs-comment"># 创建元组   方式3</span>
<span class="hljs-attr">tuple4</span> = ()    <span class="hljs-comment"># 空元组</span>
<span class="hljs-attr">tuple5</span> = (<span class="hljs-number">20</span>,) <span class="hljs-comment"># 一个元素，需要在元素后添加逗号</span>
<span class="hljs-attr">tuple6</span> = tuple + tuple2  <span class="hljs-comment"># 使用两个现有元组创建一个新元组</span>

</code></pre>
<ul>
<li>元组元素访问</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>)  <span class="hljs-comment"># 输出完整元组</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 输出元组的第一个元素</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>])  <span class="hljs-comment"># 输出从第二个元素开始到第三个元素</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>[<span class="hljs-number">2</span>:])  <span class="hljs-comment"># 输出从第三个元素开始的所有元素</span>


输出：
(<span class="hljs-string">'aa'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3j</span>)
aa
(<span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>)
(<span class="hljs-number">2.0</span>, <span class="hljs-number">3j</span>)
</code></pre>
<ul>
<li>del  删除元组</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">tup = ('a', 'b', <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(tup)
<span class="hljs-selector-tag">del</span> tup
# <span class="hljs-built_in">print</span>("删除后的元组 tup : ")
# <span class="hljs-built_in">print</span>(tup)  # 元组删除后，再打印会报错
</code></pre>
<ul>
<li>len  元组内元素个数</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup1</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
print(len(tup1))  <span class="hljs-comment">#4</span>
</code></pre>
<ul>
<li>加号 +  将两个元组连接，建成一个新的元组</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup2</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>)
<span class="hljs-attr">tup3</span> = (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
print(tup2 + tup3)  <span class="hljs-comment">#('a', 'b', 1, 2)</span>
</code></pre>
<ul>
<li>乘号 *  元组内元素重复指定次数</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">tup4 = (<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(tup4 * <span class="hljs-number">3</span>)  # (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
</code></pre>
<ul>
<li>in 判断元素是否包含在元组中</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup5</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
print(1 in tup5)  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>for  元组遍历</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup6</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
for x in tup6 :
    print(x)
</code></pre>
<ul>
<li>max min 返回元组中最大、最小元素</li>
</ul>

<pre><code class="hljs language-python" lang="python">tup7 = (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">max</span>(tup7))  <span class="hljs-comment">#4</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">min</span>(tup7))  <span class="hljs-comment">#1</span>
</code></pre>
<ul>
<li>tuple(list) 将list转为元组</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list8 = <span class="hljs-selector-attr">[1,2,3,4,5]</span>
<span class="hljs-built_in">print</span>(tuple(list8))  #(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
</code></pre>
<h2 data-id="heading-13">Set集合</h2>
<ul>
<li>创建集合</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">site1</span> = ()  <span class="hljs-comment"># 创建空集合</span>
<span class="hljs-attr">site2</span> = set(<span class="hljs-string">"a"</span>)  <span class="hljs-comment">#方式1：创建一个集合</span>
<span class="hljs-attr">sites</span> = {<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'f'</span>}  <span class="hljs-comment">#方式二：创建一个集合</span>
<span class="hljs-comment">#set2 = {} #错误，这是一个字典</span>
<span class="hljs-attr">set3</span> = set()  <span class="hljs-comment">#创建一个空集合</span>
<span class="hljs-attr">set0</span> = set((<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>))  <span class="hljs-comment">#用元组创建一个set</span>
</code></pre>
<ul>
<li>去除重复</li>
</ul>

<pre><code class="hljs language-go" lang="go">set4 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>}
<span class="hljs-built_in">print</span>(set4)  # {<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>}
</code></pre>
<ul>
<li>add 添加</li>
</ul>

<pre><code class="hljs language-go" lang="go">set5 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set5.add(<span class="hljs-string">"d"</span>)
<span class="hljs-built_in">print</span>(set5)  # {<span class="hljs-string">'a'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>}
</code></pre>
<ul>
<li>update更新,可以是列表、元组、字典</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set5</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">list</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]
<span class="hljs-attr">tup</span> = (<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)
<span class="hljs-attr">dict</span> = {<span class="hljs-string">'key1'</span>:<span class="hljs-string">'value1'</span>}
set5.update(list)
set5.update(tup)
set5.update(dict)  <span class="hljs-comment"># 字典取key</span>
print(set5)  <span class="hljs-comment"># {1, 2, 3, 4, 'a', 'key1', 'c', 'b'}</span>
</code></pre>
<p>*</p>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># remove 移除元素</span>
set6 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set6.remove(<span class="hljs-string">"a"</span>)  <span class="hljs-comment"># 不存在会报错</span>
set6.discard(<span class="hljs-string">"d"</span>)  <span class="hljs-comment"># 不存在不会报错</span>
set6.pop()  <span class="hljs-comment"># 随机删除一个元素</span>
<span class="hljs-built_in">print</span>(set6)  <span class="hljs-comment"># {'c'}</span>
</code></pre>
<ul>
<li>clear 集合清空</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set8</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set8.clear()  <span class="hljs-comment"># 集合清空</span>
print(set8)  <span class="hljs-comment"># set()</span>
</code></pre>
<ul>
<li>len 集合长度</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set7</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
print(len(set7))  <span class="hljs-comment"># 3</span>
</code></pre>
<ul>
<li>集合间运算</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 成员测试</span>
<span class="hljs-keyword">if</span> <span class="hljs-string">'a'</span> <span class="hljs-keyword">in</span> sites:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hello'</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hi'</span>)

<span class="hljs-comment"># set可以进行集合运算</span>
a = <span class="hljs-built_in">set</span>(<span class="hljs-string">'abcd'</span>)
b = <span class="hljs-built_in">set</span>(<span class="hljs-string">'cdef'</span>)

<span class="hljs-built_in">print</span>(a)
<span class="hljs-built_in">print</span>(a - b)  <span class="hljs-comment"># a 和 b 的差集</span>
<span class="hljs-built_in">print</span>(a | b)  <span class="hljs-comment"># a 和 b 的并集</span>
<span class="hljs-built_in">print</span>(a &amp; b)  <span class="hljs-comment"># a 和 b 的交集</span>
<span class="hljs-built_in">print</span>(a ^ b)  <span class="hljs-comment"># a 和 b 中不同时存在的元素</span>
</code></pre>
<ul>
<li>in 判断元素是否在集合中</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">set9 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-built_in">print</span>(<span class="hljs-string">"a"</span> <span class="hljs-keyword">in</span> set9)  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>difference() 返回多个集合的差集，自身集合没变化</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set10</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set11</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set10.difference(set11))  <span class="hljs-comment"># {'a'}</span>
</code></pre>
<ul>
<li>difference_update() 移除集合中的元素，该元素在指定的集合也存在。改变了自身集合</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set12</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set13</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
set12.difference_update(set13)
print(set12)   <span class="hljs-comment"># {'a'}</span>
</code></pre>
<ul>
<li>intersection()  返回集合的交集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set14</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set15</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set14.intersection(set15))   <span class="hljs-comment"># {'b', 'c'}</span>
</code></pre>
<ul>
<li>intersection_update() 返回集合的交集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set16</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set17</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
set16.intersection_update(set17)
print(set16)  <span class="hljs-comment"># {'b', 'c'}</span>
</code></pre>
<ul>
<li>isdisjoint() 两个集合,如果没有相同元素返回 True，有至少一个相同元素返回 False。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set18</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set19</span> = {<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>}
print(set18.isdisjoint(set19))  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>issubset() 判断指定集合是否为该方法参数集合的子集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set20</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set21</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set20.issubset(set21))  <span class="hljs-comment"># False</span>
</code></pre>
<ul>
<li>issuperset() 判断该方法的参数集合是否为指定集合的子集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set22</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set23</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
print(set22.issuperset(set23))  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>symmetric_difference() 返回两个集合中不重复的元素集合。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set24</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set25</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set24.symmetric_difference(set25))  <span class="hljs-comment"># {'d', 'a'}</span>
</code></pre>
<ul>
<li>symmetric_difference_update()  移除当前集合中在另外一个指定集合相同的元素，并将另外一个指定集合中不同的元素插入到当前集合中。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set26</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set27</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
set26.symmetric_difference_update(set27)
print(set26)  <span class="hljs-comment"># {'d', 'a'}</span>
</code></pre>
<ul>
<li>union() 返回两个集合的并集</li>
</ul>

<pre><code class="hljs language-c" lang="c">set28 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set29 = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set28.<span class="hljs-keyword">union</span>(set29))  #{<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'c'</span>}
</code></pre>
<h2 data-id="heading-14">字典</h2>
<ul>
<li>创建字典</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict</span> = {}  <span class="hljs-comment">#使用{}创建一个空字典</span>
<span class="hljs-attr">emptyDict2</span> = dict()   <span class="hljs-comment">#使用内建函数 dict() 创建字典</span>
<span class="hljs-attr">dict2</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}  <span class="hljs-comment">#使用{}创建一个有值的字典</span>
</code></pre>
<ul>
<li>dict()可以直接将键值对儿转为字典</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">dict</span>([(<span class="hljs-string">'Runoob'</span>, <span class="hljs-number">1</span>), (<span class="hljs-string">'Google'</span>, <span class="hljs-number">2</span>), (<span class="hljs-string">'Taobao'</span>, <span class="hljs-number">3</span>)])

输出：
{<span class="hljs-string">'Runoob'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'Google'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'Taobao'</span>: <span class="hljs-number">3</span>}
</code></pre>
<ul>
<li>字典访问</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">dict</span>[<span class="hljs-string">'a'</span>] = <span class="hljs-string">"b"</span>
<span class="hljs-built_in">dict</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">dict</span>[<span class="hljs-string">'a'</span>])  <span class="hljs-comment"># 输出键为 'one' 的值</span>
<span class="hljs-comment"># print(dict[2])  # 输出键为 2 的值 ,找不到，报错</span>
<span class="hljs-built_in">print</span>(dict2)  <span class="hljs-comment"># 输出完整的字典</span>

输出：
b
{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>del 删除字典的key</li>
</ul>

<pre><code class="hljs language-css" lang="css">dict2 = {'key1': <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-selector-tag">del</span> dict2<span class="hljs-selector-attr">[<span class="hljs-string">'key1'</span>]</span>
print(dict2)  #{'key2': <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>del 删除字典</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict3</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
del dict3
<span class="hljs-comment"># print(dict3)  #已删除，打印报错</span>
</code></pre>
<ul>
<li>clear  字典清空</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict4</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict4.clear()
print(dict4)  <span class="hljs-comment">#{}</span>
</code></pre>
<ul>
<li>len  字典内键值对儿个数</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict5</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
print(len(dict5))  <span class="hljs-comment">#3</span>
</code></pre>
<ul>
<li>str  字典转为字符串</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict6 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-built_in">print</span>(str(dict6))  #字符串：{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>copy 返回一个字典的浅复制</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict7 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict8 = dict7.<span class="hljs-built_in">copy</span>()
<span class="hljs-built_in">print</span>(str(dict8))  #{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>fromkeys 创建一个新字典，以序列seq中元素做字典的键，val为字典所有键对应的初始值</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">keys <span class="hljs-operator">=</span> (<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>, <span class="hljs-string">'sex'</span>)
<span class="hljs-keyword">values</span> <span class="hljs-operator">=</span> "value"
dict9 <span class="hljs-operator">=</span> dict.fromkeys(keys, <span class="hljs-keyword">values</span>)
print(dict9)  #{<span class="hljs-string">'name'</span>: <span class="hljs-string">'value'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-string">'value'</span>, <span class="hljs-string">'sex'</span>: <span class="hljs-string">'value'</span>}
</code></pre>
<ul>
<li>字典遍历</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">dict2 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>} 
<span class="hljs-built_in">print</span>(dict2.keys())  <span class="hljs-comment"># 输出所有键，是个List</span>
<span class="hljs-built_in">print</span>(dict2.values())  <span class="hljs-comment"># 输出所有值，是个List</span>

输出：
dict_keys([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>, <span class="hljs-string">'key3'</span>])
dict_values([<span class="hljs-string">'value1'</span>, 1, <span class="hljs-string">'value3'</span>])
</code></pre>
<ul>
<li>for、keys、values，字典遍历</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">dict10 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-built_in">print</span>(dict10.get(<span class="hljs-string">"key1"</span>))    <span class="hljs-comment">#value1</span>

dict11 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-built_in">print</span>(<span class="hljs-string">"key1"</span> <span class="hljs-keyword">in</span> dict11)  <span class="hljs-comment">#True</span>

dict12 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> dict12.items():
    <span class="hljs-built_in">print</span>(entry)
    
<span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> dict12.items():
    <span class="hljs-built_in">print</span>(k, v)
    
<span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> dict12.keys():
    <span class="hljs-built_in">print</span>(key)

<span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> dict12.values():
    <span class="hljs-built_in">print</span>(value)
</code></pre>
<ul>
<li>setdefault  和get()类似, 但如果键不存在于字典中，将会添加键并将值设为default</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">dict13 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict13.setdefault(<span class="hljs-string">"key4"</span>,44)
<span class="hljs-built_in">print</span>(dict13.get(<span class="hljs-string">"key4"</span>))  <span class="hljs-comment">#44</span>
</code></pre>
<ul>
<li>update 把字典dict15的键/值对更新到dict14里，存在更新，不存在添加</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict14 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict15 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1111'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'key4'</span>: <span class="hljs-string">'value444'</span>}
dict14.update(dict15)
<span class="hljs-built_in">print</span>(dict14)  #{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1111'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>, <span class="hljs-string">'key4'</span>: <span class="hljs-string">'value444'</span>}
</code></pre>
<ul>
<li>pop 删除字典 key（键）所对应的值，返回被删除的值</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict16 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict16.pop(<span class="hljs-string">"key1"</span>)
<span class="hljs-built_in">print</span>(dict16)  #{<span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>popitem 返回并删除字典中的最后一对键和值</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict17 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict17.popitem()
<span class="hljs-built_in">print</span>(dict17)  #{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>}
</code></pre>
<h2 data-id="heading-15">数据类型转化</h2>
<ul>
<li>隐式类型转换 - 自动完成</li>
<li>显式类型转换 - 需要使用类型函数来转换</li>
</ul>
<p>隐式转换：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">a</span> = <span class="hljs-number">1</span> <span class="hljs-comment"># int</span>
<span class="hljs-attr">b</span> = <span class="hljs-number">1.2</span> <span class="hljs-comment"># float</span>
<span class="hljs-attr">c</span> = a + b <span class="hljs-comment"># float</span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">a</span> = <span class="hljs-number">1</span> <span class="hljs-comment"># int</span>
<span class="hljs-attr">b</span> = <span class="hljs-string">"1"</span> <span class="hljs-comment"># float</span>
<span class="hljs-attr">c</span> = a + b <span class="hljs-comment"># 运行报错，字符串和int不能隐式转换</span>
</code></pre>
<p>显示转化，使用目标类型名函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(<span class="hljs-number">1.2</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">"1"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">float</span>(<span class="hljs-number">1</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">float</span>(<span class="hljs-string">"1.3"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(<span class="hljs-number">1.2</span>))
</code></pre>
<p>显示转化汇总：</p>
<ul>
<li>int(x) 将x转换为一个整数</li>
<li>float(x) 将x转换到一个浮点数</li>
<li>complex(x) 创建一个复数</li>
<li>str(x) 将x转为字符串</li>
<li>repr(x) 将x转为表达式字符串</li>
<li>eval(str) 用来计算在字符串中的有效Python表达式,并返回一个对象</li>
<li>tuple(s) 将序列 s 转换为一个元组</li>
<li>list(s) 将序列 s 转换为一个列表</li>
<li>set(s) 转换为可变集合</li>
<li>dict(d) 创建一个字典。d 必须是一个 (key, value)元组序列</li>
<li>frozenset(s) 转换为不可变集合</li>
<li>chr(x) 将一个整数转换为一个字符</li>
<li>ord(x) 将一个字符转换为它的整数值</li>
<li>hex(x) 将一个整数转换为一个十六进制字符串</li>
<li>oct(x) 将一个整数转换为一个八进制字符串</li>
</ul>
<h2 data-id="heading-16">推导式</h2>
<p>推导式是一种独特的数据处理方式，可以从一个数据序列构建另一个新的数据序列的结构体。</p>
<ul>
<li>列表(list)推导式</li>
<li>字典(dict)推导式</li>
<li>集合(set)推导式</li>
<li>元组(tuple)推导式</li>
</ul>
<p>列表(list)推导式</p>
<pre><code class="hljs language-scss" lang="scss">list = <span class="hljs-selector-attr">[<span class="hljs-string">'ZhangSan'</span>, <span class="hljs-string">'LiSi'</span>, <span class="hljs-string">'wei'</span>, <span class="hljs-string">'wangwu'</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'a'</span>]</span>
list2 = <span class="hljs-selector-attr">[name.upper() for name in list if len(name) &gt; 3]</span>
<span class="hljs-built_in">print</span>(list2) # <span class="hljs-selector-attr">[<span class="hljs-string">'ZHANGSAN'</span>, <span class="hljs-string">'LISI'</span>, <span class="hljs-string">'WANGWU'</span>]</span>

list3 = <span class="hljs-selector-attr">[i for i in range(20) if i%4 == 0]</span>
<span class="hljs-built_in">print</span>(list3) # <span class="hljs-selector-attr">[0, 4, 8, 12, 16]</span>
</code></pre>
<p>字典(dict)推导式</p>
<pre><code class="hljs language-css" lang="css">list = <span class="hljs-selector-attr">[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key222'</span>, <span class="hljs-string">'key33333'</span>]</span>
dict = {key: <span class="hljs-built_in">len</span>(key) for key in list}
print(dict) # {'key1': <span class="hljs-number">4</span>, <span class="hljs-string">'key222'</span>: <span class="hljs-number">6</span>, <span class="hljs-string">'key33333'</span>: <span class="hljs-number">8</span>}

dict2 = {x: x ** <span class="hljs-number">2</span> for x in (<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>)}
print(dict2) # {<span class="hljs-number">2</span>: <span class="hljs-number">4</span>, <span class="hljs-number">4</span>: <span class="hljs-number">16</span>, <span class="hljs-number">6</span>: <span class="hljs-number">36</span>}
</code></pre>
<p>集合(set)推导式</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set1</span> = {i ** <span class="hljs-number">2</span> for i in (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)}
print(set1)  <span class="hljs-comment"># {1, 4, 9}</span>
<span class="hljs-attr">a</span> = {x for x in <span class="hljs-string">'abracadabra'</span> if x not in <span class="hljs-string">'abc'</span>}
print(a)  <span class="hljs-comment"># {'r', 'd'}</span>
</code></pre>
<p>元组(tuple)推导式</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">a</span> = (x for x in range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>))  # 返回的生成器对象，需要用<span class="hljs-built_in">tuple</span>(a)转换成元组
<span class="hljs-built_in">print</span>(tuple(a))  # (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>)
</code></pre>
<h2 data-id="heading-17">运算符</h2>
<ul>
<li>算数运算符</li>
<li>比较运算符</li>
<li>赋值运算符</li>
<li>逻辑运算符</li>
<li>位运算符</li>
<li>成员运算符</li>
<li>身份运算符</li>
<li>运算符优先级</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89079fe1ca3a4c38b7cd31cc21f2051d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1670&amp;h=960&amp;s=145618&amp;e=png&amp;b=fbf9f9" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7cb635f6384453cb8e565228bbdb2af~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1672&amp;h=1018&amp;s=156164&amp;e=png&amp;b=ffffff" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f047849fcf0c448981df1e72e3e9f1c7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1666&amp;h=1154&amp;s=202976&amp;e=png&amp;b=faf8f8" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ea651e14af440b8c4d0d60899ee6b4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1692&amp;h=1604&amp;s=300298&amp;e=png&amp;b=f9f8f8" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee093ca9550d4a9e92e8c48e1076bc3f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1678&amp;h=478&amp;s=102449&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16157fc86d294b65b14702e8c47916b7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1682&amp;h=414&amp;s=94084&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> = <span class="hljs-number">2</span>
<span class="hljs-selector-tag">b</span> = <span class="hljs-number">20</span>
list = <span class="hljs-selector-attr">[1, 2, 3, 4, 5]</span>
if (<span class="hljs-selector-tag">a</span> in list):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - 变量 a 在给定的列表中 list 中"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - 变量 a 不在给定的列表中 list 中"</span>)
if (b not in list):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - 变量 b 不在给定的列表中 list 中"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - 变量 b 在给定的列表中 list 中"</span>)
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d0e78abb59c43669799fe8b6e27d610~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1708&amp;h=480&amp;s=100256&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> = <span class="hljs-number">20</span>
<span class="hljs-selector-tag">b</span> = <span class="hljs-number">20</span>

if (<span class="hljs-selector-tag">a</span> is <span class="hljs-selector-tag">b</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - a 和 b 有相同的标识"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - a 和 b 没有相同的标识"</span>)

if (<span class="hljs-built_in">id</span>(a) == <span class="hljs-built_in">id</span>(b)):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - a 和 b 有相同的标识"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - a 和 b 没有相同的标识"</span>)
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c6f1c9ffa9e40d890b0a31c83dda0b2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1752&amp;h=1830&amp;s=253774&amp;e=png&amp;b=fcfcfc" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-18">数学函数</h2>
<p>常用函数</p>

































































<table><thead><tr><th>函数</th><th>返回值 ( 描述 )</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-abs.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-abs.html" ref="nofollow noopener noreferrer">abs(x)</a></td><td>返回数字的绝对值，如abs(-10) 返回 10</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-ceil.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-ceil.html" ref="nofollow noopener noreferrer">ceil(x)</a></td><td>返回数字的上入整数，如math.ceil(4.1) 返回 5</td></tr><tr><td>cmp(x, y)</td><td>如果 x &lt; y 返回 -1, 如果 x == y 返回 0, 如果 x &gt; y 返回 1。 <strong>Python 3 已废弃，使用 (x&gt;y)-(x&lt;y) 替换</strong>。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-exp.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-exp.html" ref="nofollow noopener noreferrer">exp(x)</a></td><td>返回e的x次幂(ex),如math.exp(1) 返回2.718281828459045</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-fabs.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-fabs.html" ref="nofollow noopener noreferrer">fabs(x)</a></td><td>返回数字的绝对值，如math.fabs(-10) 返回10.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-floor.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-floor.html" ref="nofollow noopener noreferrer">floor(x)</a></td><td>返回数字的下舍整数，如math.floor(4.9)返回 4</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-log.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-log.html" ref="nofollow noopener noreferrer">log(x)</a></td><td>如math.log(math.e)返回1.0,math.log(100,10)返回2.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-log10.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-log10.html" ref="nofollow noopener noreferrer">log10(x)</a></td><td>返回以10为基数的x的对数，如math.log10(100)返回 2.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-max.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-max.html" ref="nofollow noopener noreferrer">max(x1, x2,...)</a></td><td>返回给定参数的最大值，参数可以为序列。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-min.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-min.html" ref="nofollow noopener noreferrer">min(x1, x2,...)</a></td><td>返回给定参数的最小值，参数可以为序列。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-modf.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-modf.html" ref="nofollow noopener noreferrer">modf(x)</a></td><td>返回x的整数部分与小数部分，两部分的数值符号与x相同，整数部分以浮点型表示。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-pow.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-pow.html" ref="nofollow noopener noreferrer">pow(x, y)</a></td><td>x**y 运算后的值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-round.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-round.html" ref="nofollow noopener noreferrer">round(x [,n])</a></td><td>返回浮点数 x 的四舍五入值，如给出 n 值，则代表舍入到小数点后的位数。<strong>其实准确的说是保留值将保留到离上一位更近的一端。</strong></td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-sqrt.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-sqrt.html" ref="nofollow noopener noreferrer">sqrt(x)</a></td><td>返回数字x的平方根。</td></tr></tbody></table>
<h2 data-id="heading-19">随机数函数</h2>
<p>常用随机数函数：</p>

































<table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-choice.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-choice.html" ref="nofollow noopener noreferrer">choice(seq)</a></td><td>从序列的元素中随机挑选一个元素，比如random.choice(range(10))，从0到9中随机挑选一个整数。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-randrange.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-randrange.html" ref="nofollow noopener noreferrer">randrange ([start,] stop [,step])</a></td><td>从指定范围内，按指定基数递增的集合中获取一个随机数，基数默认值为 1</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-random.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-random.html" ref="nofollow noopener noreferrer">random()</a></td><td>随机生成下一个实数，它在[0,1)范围内。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-seed.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-seed.html" ref="nofollow noopener noreferrer">seed([x])</a></td><td>改变随机数生成器的种子seed。如果你不了解其原理，你不必特别去设定seed，Python会帮你选择seed。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-shuffle.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-shuffle.html" ref="nofollow noopener noreferrer">shuffle(lst)</a></td><td>将序列的所有元素随机排序</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-uniform.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-uniform.html" ref="nofollow noopener noreferrer">uniform(x, y)</a></td><td>随机生成下一个实数，它在[x,y]范围内。</td></tr></tbody></table>
<h2 data-id="heading-20">三角函数</h2>
<p>常用三角函数：</p>

















































<table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-acos.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-acos.html" ref="nofollow noopener noreferrer">acos(x)</a></td><td>返回x的反余弦弧度值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-asin.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-asin.html" ref="nofollow noopener noreferrer">asin(x)</a></td><td>返回x的反正弦弧度值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-atan.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-atan.html" ref="nofollow noopener noreferrer">atan(x)</a></td><td>返回x的反正切弧度值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-atan2.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-atan2.html" ref="nofollow noopener noreferrer">atan2(y, x)</a></td><td>返回给定的 X 及 Y 坐标值的反正切值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-cos.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-cos.html" ref="nofollow noopener noreferrer">cos(x)</a></td><td>返回x的弧度的余弦值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-hypot.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-hypot.html" ref="nofollow noopener noreferrer">hypot(x, y)</a></td><td>返回欧几里德范数 sqrt(x<em>x + y</em>y)。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-sin.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-sin.html" ref="nofollow noopener noreferrer">sin(x)</a></td><td>返回的x弧度的正弦值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-tan.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-tan.html" ref="nofollow noopener noreferrer">tan(x)</a></td><td>返回x弧度的正切值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-degrees.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-degrees.html" ref="nofollow noopener noreferrer">degrees(x)</a></td><td>将弧度转换为角度,如degrees(math.pi/2) ， 返回90.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-radians.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-radians.html" ref="nofollow noopener noreferrer">radians(x)</a></td><td>将角度转换为弧度</td></tr></tbody></table>
<h2 data-id="heading-21">数学常量</h2>

















<table><thead><tr><th>常量</th><th>描述</th></tr></thead><tbody><tr><td>pi</td><td>数学常量 pi（圆周率，一般以π来表示）</td></tr><tr><td>e</td><td>数学常量 e，e即自然常数（自然常数）。</td></tr></tbody></table>
<h2 data-id="heading-22">end</h2>
<p>关键字end可以用于将结果输出到同一行，或者在输出的末尾添加不同的字符</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span> = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
<span class="hljs-selector-tag">while</span> <span class="hljs-selector-tag">b</span> &lt; <span class="hljs-number">1000</span>:
    <span class="hljs-selector-tag">print</span>(b, end=<span class="hljs-string">','</span>)
    <span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">b</span>, <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
    
输出：
<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>,<span class="hljs-number">13</span>,<span class="hljs-number">21</span>,<span class="hljs-number">34</span>,<span class="hljs-number">55</span>,<span class="hljs-number">89</span>,<span class="hljs-number">144</span>,<span class="hljs-number">233</span>,<span class="hljs-number">377</span>,<span class="hljs-number">610</span>,<span class="hljs-number">987</span>,
</code></pre>
<h2 data-id="heading-23">循环</h2>
<ul>
<li>while else</li>
</ul>
<p>while true内执行多次，else执行1次</p>
<pre><code class="hljs language-bash" lang="bash">count = 10
<span class="hljs-keyword">while</span> count &lt; 5:
    <span class="hljs-built_in">print</span>(count, <span class="hljs-string">" 小于 5"</span>)
    count = count - 1
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(count, <span class="hljs-string">" 大于或等于 5"</span>)
    count = count - 1
</code></pre>
<ul>
<li>for else</li>
</ul>
<p>只有for内循环一次都未执行时才走else</p>
<pre><code class="hljs language-bash" lang="bash">sites = [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>]
<span class="hljs-keyword">for</span> site <span class="hljs-keyword">in</span> sites:
    <span class="hljs-keyword">if</span> site == <span class="hljs-string">"b"</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"aaa!"</span>)
        <span class="hljs-built_in">break</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"循环数据 "</span> + site)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"没有循环数据!"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"完成循环!"</span>)
</code></pre>
<ul>
<li>range</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">for <span class="hljs-selector-tag">i</span> in <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(i)

for i in <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, <span class="hljs-number">9</span>):
    <span class="hljs-built_in">print</span>(i)

for i in <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(i)

for i in <span class="hljs-built_in">range</span>(-<span class="hljs-number">10</span>, -<span class="hljs-number">100</span>, -<span class="hljs-number">30</span>):
    <span class="hljs-built_in">print</span>(i)

list = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>))
<span class="hljs-built_in">print</span>(list)
</code></pre>
<ul>
<li>pass</li>
</ul>
<p>pass是空语句，是为了保持程序结构的完整性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> letter <span class="hljs-keyword">in</span> <span class="hljs-string">'abcde'</span>:
    <span class="hljs-keyword">if</span> letter == <span class="hljs-string">'o'</span>:
        <span class="hljs-keyword">pass</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'执行 pass 块'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前字母 :'</span>, letter)
</code></pre>
<h2 data-id="heading-24">同时遍历两个序列</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">questions</span> = <span class="hljs-selector-attr">[<span class="hljs-string">'name'</span>, <span class="hljs-string">'quest'</span>, <span class="hljs-string">'favorite color'</span>]</span>
<span class="hljs-selector-tag">answers</span> = <span class="hljs-selector-attr">[<span class="hljs-string">'lancelot'</span>, <span class="hljs-string">'the holy grail'</span>, <span class="hljs-string">'blue'</span>]</span>
<span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">q</span>, <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">zip</span>(questions, answers):
    <span class="hljs-selector-tag">print</span>(<span class="hljs-string">'q = {0}?  a = {1}.'</span>.<span class="hljs-built_in">format</span>(q, a))
    
输出：
<span class="hljs-selector-tag">q</span> = <span class="hljs-selector-tag">name</span>?  <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-tag">lancelot</span>.
<span class="hljs-selector-tag">q</span> = <span class="hljs-selector-tag">quest</span>?  <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">holy</span> <span class="hljs-selector-tag">grail</span>.
<span class="hljs-selector-tag">q</span> = <span class="hljs-selector-tag">favorite</span> <span class="hljs-selector-tag">color</span>?  <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-tag">blue</span>.
</code></pre>
<h2 data-id="heading-25">异常处理</h2>
<ul>
<li>如果没有异常：try...else...finally...</li>
<li>有异常：try...except...finally...</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">this_fails</span>():
    x = <span class="hljs-number">1</span> / <span class="hljs-number">0</span>

<span class="hljs-keyword">try</span>:
    this_fails()
<span class="hljs-keyword">except</span> ZeroDivisionError <span class="hljs-keyword">as</span> err:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Handling run-time error:'</span>, err)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"oveer"</span>)
<span class="hljs-keyword">finally</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'这句话，无论异常是否发生都会执行。'</span>)
</code></pre>
<ul>
<li>抛出异常 raise</li>
</ul>

<pre><code class="hljs language-css" lang="css">x = <span class="hljs-number">10</span>\
if x &gt; <span class="hljs-number">5</span>:\
    raise <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'x 不能大于 5。x 的值为: {}'</span>.<span class="hljs-built_in">format</span>(x))
</code></pre>
<ul>
<li>自定义异常</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, value</span>):
        self.value = value

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">repr</span>(self.value)

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> MyError(<span class="hljs-number">2</span> * <span class="hljs-number">2</span>)
<span class="hljs-keyword">except</span> MyError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'My exception occurred, value:'</span>, e.value)
</code></pre>
<ul>
<li>with</li>
</ul>
<p>关键词 with 语句就可以保证诸如文件之类的对象在使用完之后一定会正确的执行他的清理方法</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"myfile.txt"</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
        <span class="hljs-built_in">print</span>(line, end=<span class="hljs-string">""</span>)
</code></pre>
<h2 data-id="heading-26">类</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>:
    <span class="hljs-string">"""一个简单的类实例"""</span>
    i = <span class="hljs-number">12345</span>
    a = <span class="hljs-number">1</span>
    b = <span class="hljs-number">2</span>
    __c = <span class="hljs-number">2</span>  <span class="hljs-comment"># 私有属性</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b</span>):  <span class="hljs-comment"># 构造方法</span>
        self.i = <span class="hljs-number">222</span>
        self.a = a
        self.b = b

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">self</span>):  <span class="hljs-comment"># 常规方法</span>
        <span class="hljs-keyword">return</span> self.a + self.b + self.__c
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__foo</span>(<span class="hljs-params">self</span>):  <span class="hljs-comment"># 私有方法 </span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'这是私有方法'</span>)

<span class="hljs-comment"># 实例化类</span>
x = MyClass(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)

<span class="hljs-comment"># 访问类的属性和方法</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"MyClass 类的属性 i 为："</span>, x.i)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"MyClass 类的方法 f 输出为："</span>, x.f())
</code></pre>
<ul>
<li>继承</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MySubClass</span>(<span class="hljs-title class_">MyClass</span>):
    d = <span class="hljs-number">4</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>,a,b,d</span>):
        <span class="hljs-title class_">MyClass</span>.__init__(<span class="hljs-variable language_">self</span>,a,b)  <span class="hljs-comment"># 调用父类构造方法</span>
        <span class="hljs-variable language_">self</span>.d = d

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):  <span class="hljs-comment"># 覆写父类方法</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.a * <span class="hljs-variable language_">self</span>.b *<span class="hljs-variable language_">self</span>.d

msc = <span class="hljs-title class_">MySubClass</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
result = msc.f()
print(result)
</code></pre>
<ul>
<li>多继承</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 类定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">people</span>:
    <span class="hljs-comment"># 定义基本属性</span>
    name = <span class="hljs-string">''</span>
    age = <span class="hljs-number">0</span>
    <span class="hljs-comment"># 定义私有属性,私有属性在类外部无法直接进行访问</span>
    __weight = <span class="hljs-number">0</span>

    <span class="hljs-comment"># 定义构造方法</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, a, w</span>):
        self.name = n
        self.age = a
        self.__weight = w

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"%s 说: 我 %d 岁。"</span> % (self.name, self.age))

<span class="hljs-comment"># 单继承示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">student</span>(<span class="hljs-title class_ inherited__">people</span>):
    grade = <span class="hljs-string">''</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, a, w, g</span>):
        <span class="hljs-comment"># 调用父类的构函</span>
        people.__init__(self, n, a, w)
        self.grade = g

    <span class="hljs-comment"># 覆写父类的方法</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"%s 说: 我 %d 岁了，我在读 %d 年级"</span> % (self.name, self.age, self.grade))

<span class="hljs-comment"># 另一个类，多重继承之前的准备</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">speaker</span>():
    topic = <span class="hljs-string">''</span>
    name = <span class="hljs-string">''</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, t</span>):
        self.name = n
        self.topic = t

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"我叫 %s，我是一个演说家，我演讲的主题是 %s"</span> % (self.name, self.topic))

<span class="hljs-comment"># 多重继承</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">sample</span>(speaker, student):
    a = <span class="hljs-string">''</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, a, w, g, t</span>):
        student.__init__(self, n, a, w, g)
        speaker.__init__(self, n, t)

test = sample(<span class="hljs-string">"Tim"</span>, <span class="hljs-number">25</span>, <span class="hljs-number">80</span>, <span class="hljs-number">4</span>, <span class="hljs-string">"Python"</span>)
test.speak()  <span class="hljs-comment"># 方法名同，默认调用的是在括号中参数位置排前父类的方法</span>
</code></pre>
<h2 data-id="heading-27">json</h2>
<ul>
<li>dumps  对象转字符串</li>
<li>loads  字符串转对象</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
data = {
    <span class="hljs-string">'no'</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">'name'</span>: <span class="hljs-string">'Runoob'</span>,
    <span class="hljs-string">'url'</span>: <span class="hljs-string">'http://www.runoob.com'</span>
}

json_str = json.dumps(data)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Python 原始数据："</span>, <span class="hljs-built_in">repr</span>(data))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"JSON 对象："</span>, json_str)

<span class="hljs-comment"># 将 JSON 对象转换为 Python 字典</span>
data2 = json.loads(json_str)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"data2['name']: "</span>, data2[<span class="hljs-string">'name'</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"data2['url']: "</span>, data2[<span class="hljs-string">'url'</span>])
</code></pre>
<p>参考菜鸟教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-tutorial.html" target="_blank" title="https://www.runoob.com/python3/python3-tutorial.html" ref="nofollow noopener noreferrer">www.runoob.com/python3/pyt…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fishhook原理深度剖析：从Mach-O到运行时函数Hook]]></title>    <link>https://juejin.cn/post/7596975035438792713</link>    <guid>https://juejin.cn/post/7596975035438792713</guid>    <pubDate>2026-01-20T04:07:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438792713" data-draft-id="7596890557545971758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fishhook原理深度剖析：从Mach-O到运行时函数Hook"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-20T04:07:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fishhook原理深度剖析：从Mach-O到运行时函数Hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:07:52.000Z" title="Tue Jan 20 2026 04:07:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在iOS/macOS开发中，函数Hook是一项强大的技术，它允许我们在运行时修改函数行为，广泛应用于调试、监控、性能分析等领域。Fishhook作为Facebook开源的一个轻量级Hook框架，其设计精巧、实现简洁，是理解macOS/iOS系统动态链接机制的绝佳案例。本文将深入剖析Fishhook的工作原理，解答一系列核心问题。</p>
<h2 data-id="heading-1">一、Fishhook是什么？</h2>
<p>Fishhook是一个基于动态链接特性的函数Hook库，专门针对macOS和iOS平台设计。它的核心思想是通过修改Mach-O文件中的符号绑定表来实现C函数的Hook。</p>
<p><strong>核心特点：</strong></p>
<ul>
<li>轻量级，仅几百行代码</li>
<li>专注于C函数Hook</li>
<li>基于合法的dyld API</li>
<li>主要用于调试和监控场景</li>
</ul>
<h2 data-id="heading-2">二、核心问题：Fishhook为什么只能Hook动态链接函数？</h2>
<h3 data-id="heading-3">1. Mach-O文件结构回顾</h3>
<p>要理解Fishhook的限制，首先要了解Mach-O文件结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">Mach-O Header
Load Commands
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_SEGMENT_</span>64
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_SYMTAB (符号表)
    - LC_</span>DYSYMTAB (动态符号表)
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_DYLD_</span>INFO (绑定信息)
Data
<span class="hljs-bullet">    -</span> <span class="hljs-strong">__TEXT (代码段，只读)
    - __</span>DATA (数据段，可写)
<span class="hljs-bullet">        -</span> <span class="hljs-strong">__la<span class="hljs-emphasis">_symbol_</span>ptr (惰性绑定指针)
        - __</span>nl<span class="hljs-emphasis">_symbol_</span>ptr (非惰性绑定指针)
<span class="hljs-bullet">        -</span> <span class="hljs-strong">__got (全局偏移表)
    - __</span>LINKEDIT (链接信息)
</code></pre>
<h3 data-id="heading-4">2. 动态链接 vs 静态链接</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 静态链接函数（无法Hook）</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">internal_function</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 编译时直接嵌入二进制</span>
    <span class="hljs-comment">// 调用方式：call 0x100000f00 (直接地址)</span>
}

<span class="hljs-comment">// 动态链接函数（可以Hook）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span> {
    <span class="hljs-comment">// 来自libSystem.dylib</span>
    <span class="hljs-comment">// 调用方式：call [__la_symbol_ptr + offset] (间接寻址)</span>
}
</code></pre>
<p><strong>关键区别：</strong> 动态链接函数通过符号指针表间接调用，Fishhook正是通过修改这个指针表中的地址来实现Hook。</p>
<h3 data-id="heading-5">3. 为什么只能Hook系统库函数？</h3>
<p>这是一个常见的误解！<strong>Fishhook不仅可以Hook系统库函数，也可以Hook自定义动态库函数。</strong></p>
<pre><code class="hljs language-objective-c" lang="objective-c">// 自定义动态库中的函数也可以Hook
__attribute__((visibility("default")))
void my_dynamic_function() {
    // 这个函数可以被Fishhook Hook
}

// 只要满足以下条件：
// 1. 函数来自动态库（不是静态链接）
// 2. 函数具有外部可见性（不是static）
// 3. 函数通过符号表引用
</code></pre>
<h2 data-id="heading-6">三、符号绑定机制深度解析</h2>
<h3 data-id="heading-7">1. 惰性绑定（Lazy Binding） vs 非惰性绑定</h3>
<h4 data-id="heading-8"><strong>惰性绑定（__la_symbol_ptr）</strong></h4>
<pre><code class="hljs language-assembly" lang="assembly">; 第一次调用printf时的流程
call printf    ; 实际调用桩代码

; __stubs中的桩代码
___stub_printf:
    jmp *___la_symbol_ptr[0]   ; 第一次跳转到dyld_stub_binder

; 绑定后的状态
___la_symbol_ptr[0] = 0x7fff12345678 (真实printf地址)
</code></pre>
<h4 data-id="heading-9"><strong>非惰性绑定（__nl_symbol_ptr）</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 程序启动时立即绑定的函数</span>
<span class="hljs-comment">// 现代iOS/macOS中，__nl_symbol_ptr已较少使用</span>
<span class="hljs-comment">// 取而代之的是__got（全局偏移表）</span>

<span class="hljs-comment">// 使用__got的示例</span>
<span class="hljs-type">void</span> *function_ptr __attribute__((section(<span class="hljs-string">"__DATA,__got"</span>))) = &amp;some_function;
</code></pre>
<h4 data-id="heading-10"><strong>现代绑定机制变化</strong></h4>
<p>在现代 iOS/macOS 中，传统的 <code>__nl_symbol_ptr / __la_symbol_ptr</code> 的角色已被弱化，
编译器和 dyld 更多通过<code> GOT-like</code> 的间接寻址方式以及 <code>chained fixups</code> 机制来完成符号绑定；因此使用时需要注意是否能正确实现hook.</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 传统方式的缺点</span>
<span class="hljs-comment"># 1. 重定位表可能很大</span>
<span class="hljs-comment"># 2. 加载时需要大量随机内存访问</span>
<span class="hljs-comment"># 3. 不支持新硬件特性</span>
<span class="hljs-comment"># 4. 安全保护有限</span>

<span class="hljs-comment"># Chained Fixups 的优势</span>
<span class="hljs-comment"># 1. 更小的二进制大小（减少30-50%重定位数据）</span>
<span class="hljs-comment"># 2. 更快的启动速度</span>
<span class="hljs-comment"># 3. 支持指针认证（PAC）</span>
<span class="hljs-comment"># 4. 更好的安全性和性能</span>

// 寻址方式对比
<span class="hljs-comment">; 传统方式（x86_64）</span>
<span class="hljs-comment">; 通过 __la_symbol_ptr 调用 printf</span>
lea     rdi, <span class="hljs-section">[rip + format_string]</span>
call    qword ptr <span class="hljs-section">[rip + ___la_symbol_ptr_printf]</span>

<span class="hljs-comment">; __la_symbol_ptr 节区内容：</span>
___la_symbol_ptr_printf:
    .quad   ___dyld_stub_binder_printf

<span class="hljs-comment">; 现代方式（arm64）</span>
<span class="hljs-comment">; 通过 GOT-like 间接寻址</span>
adrp    x0, _printf@GOTPAGE     <span class="hljs-comment">; 获取 GOT 页</span>
ldr     x1, <span class="hljs-section">[x0, _printf@GOTPAGEOFF]</span> <span class="hljs-comment">; 从 GOT 加载地址</span>
blr     x1                      <span class="hljs-comment">; 间接跳转</span>

<span class="hljs-comment">; 实际上，编译器可能生成更优化的代码</span>
<span class="hljs-comment">; 直接使用 PC 相对寻址，不需要显式的 GOT 节区</span>
</code></pre>
<h3 data-id="heading-11">2. dyld_stub_binder的工作原理</h3>
<p>当第一次调用动态链接函数时，系统如何查找真实地址？</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// dyld_stub_binder的简化流程</span>
<span class="hljs-type">void</span>* <span class="hljs-title function_">dyld_stub_binder</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> lazy_binding_info_offset)</span> {
    <span class="hljs-comment">// 1. 从__LINKEDIT获取绑定信息</span>
    LazyBindingInfo *info = get_binding_info(offset);
    
    <span class="hljs-comment">// 2. 提取符号名和库序号</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symbol_name = info-&gt;symbol_name;
    <span class="hljs-type">int</span> library_ordinal = info-&gt;library_ordinal;
    
    <span class="hljs-comment">// 3. 在指定动态库中查找符号</span>
    <span class="hljs-type">void</span> *address = find_symbol(symbol_name, library_ordinal);
    
    <span class="hljs-comment">// 4. 修改符号指针表</span>
    <span class="hljs-type">void</span> **symbol_ptr = info-&gt;symbol_pointer;
    *symbol_ptr = address;  <span class="hljs-comment">// 关键步骤！</span>
    
    <span class="hljs-comment">// 5. 跳转到目标函数</span>
    <span class="hljs-keyword">return</span> address;
}
</code></pre>
<h3 data-id="heading-12">3. ASLR（地址空间布局随机化）的影响</h3>
<p>ASLR是现代操作系统的安全特性，每次启动时系统模块的加载地址都随机变化：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 没有ASLR：</span>
<span class="hljs-comment">// printf地址固定为0x7fff12345678</span>

<span class="hljs-comment">// 有ASLR：</span>
<span class="hljs-comment">// 第一次启动：printf地址为0x7fff12345678</span>
<span class="hljs-comment">// 第二次启动：printf地址为0x7fff56789abc</span>
<span class="hljs-comment">// 第三次启动：printf地址为0x7fff9abcdef0</span>

<span class="hljs-comment">// Mach-O通过位置无关代码支持ASLR：</span>
<span class="hljs-comment">// 所有外部引用都通过指针表间接访问</span>
<span class="hljs-comment">// 指针表地址在运行时由dyld填充</span>
</code></pre>
<h2 data-id="heading-13">四、Fishhook的核心实现原理</h2>
<h3 data-id="heading-14">1. 核心数据结构：rebinding</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rebinding</span> {</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;      <span class="hljs-comment">// 要Hook的函数名</span>
    <span class="hljs-type">void</span> *replacement;     <span class="hljs-comment">// 替换函数的地址</span>
    <span class="hljs-type">void</span> **replaced;       <span class="hljs-comment">// 保存原始函数指针</span>
};
</code></pre>
<h3 data-id="heading-15">2. Fishhook的工作流程</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">rebind_symbols</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rebinding rebindings[], <span class="hljs-type">size_t</span> rebindings_nel)</span> {
    <span class="hljs-comment">// 1. 遍历所有镜像（动态库）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _dyld_image_count(); i++) {
        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mach_header</span> *<span class="hljs-title">header</span> =</span> _dyld_get_image_header(i);
        
        <span class="hljs-comment">// 2. 查找__DATA段中的符号指针表</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">segment_command</span> *<span class="hljs-title">seg</span> =</span> find_segment(header, <span class="hljs-string">"__DATA"</span>);
        <span class="hljs-keyword">if</span> (!seg) <span class="hljs-keyword">continue</span>;
        
        <span class="hljs-comment">// 3. 查找__la_symbol_ptr和__got节</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">section</span> *<span class="hljs-title">la_section</span> =</span> find_section(seg, <span class="hljs-string">"__la_symbol_ptr"</span>);
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">section</span> *<span class="hljs-title">got_section</span> =</span> find_section(seg, <span class="hljs-string">"__got"</span>);
        
        <span class="hljs-comment">// 4. 处理每个符号指针</span>
        perform_rebinding_with_section(la_section, rebindings, rebindings_nel);
        perform_rebinding_with_section(got_section, rebindings, rebindings_nel);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-16">3. 关键函数：查找和替换符号</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">perform_rebinding_with_section</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> section *section,
                                          <span class="hljs-keyword">struct</span> rebinding rebindings[],
                                          <span class="hljs-type">size_t</span> rebindings_nel)</span> {
    <span class="hljs-comment">// 1. 获取间接符号表</span>
    <span class="hljs-type">uint32_t</span> *indirect_symbol_indices = indirect_symbol_table + section-&gt;reserved1;
    
    <span class="hljs-comment">// 2. 遍历符号指针表中的每个条目</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; section-&gt;size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*); i++) {
        <span class="hljs-type">uint32_t</span> symtab_index = indirect_symbol_indices[i];
        
        <span class="hljs-comment">// 3. 在动态符号表中查找符号信息</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nlist_64</span> *<span class="hljs-title">symbol</span> =</span> &amp;symtab[symtab_index];
        <span class="hljs-type">uint32_t</span> strtab_offset = symbol-&gt;n_un.n_strx;
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symbol_name = strtab + strtab_offset;
        
        <span class="hljs-comment">// 4. 检查是否是需要Hook的函数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; rebindings_nel; j++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(symbol_name, rebindings[j].name) == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 5. 找到目标！进行Hook</span>
                <span class="hljs-type">void</span> **symbol_ptr = (<span class="hljs-type">void</span>**)(section-&gt;addr + i * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*));
                
                <span class="hljs-comment">// 保存原始函数指针</span>
                <span class="hljs-keyword">if</span> (rebindings[j].replaced != <span class="hljs-literal">NULL</span>) {
                    *rebindings[j].replaced = *symbol_ptr;
                }
                
                <span class="hljs-comment">// 替换为新的函数地址</span>
                *symbol_ptr = rebindings[j].replacement;
                
                <span class="hljs-keyword">break</span>;
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-17">五、实际应用场景和限制</h2>
<h3 data-id="heading-18">1. 支持的函数类型</h3>



































<table><thead><tr><th>函数类型</th><th>是否支持</th><th>说明</th></tr></thead><tbody><tr><td>C函数（动态库）</td><td>✅ 完全支持</td><td>Fishhook的主要目标</td></tr><tr><td>Objective-C方法</td><td>❌ 不支持</td><td>使用Method Swizzling</td></tr><tr><td>Swift函数（@_cdecl）</td><td>✅ 条件支持</td><td>需要C接口导出</td></tr><tr><td>静态链接函数</td><td>❌ 不支持</td><td>编译时直接链接</td></tr><tr><td>内联函数</td><td>❌ 不支持</td><td>编译时展开</td></tr></tbody></table>
<h3 data-id="heading-19">2. iOS上的特殊限制</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 在非越狱iOS设备上：
// ✅ 可以Hook自己的函数和系统公开API
// ❌ 不能Hook系统私有函数（受代码签名保护）

// 在越狱iOS设备上：
// ✅ 可以Hook所有函数

// 验证方法：
#include &lt;fishhook.h&gt;
#include &lt;stdio.h&gt;

// 可以Hook的系统公开函数
static int (*original_printf)(const char *, ...);

int hooked_printf(const char *format, ...) {
    // Hook实现
    return original_printf("[HOOKED] %s", format);
}

__attribute__((constructor))
static void setup_hook() {
    struct rebinding rebind = {"printf", hooked_printf, (void**)&amp;original_printf};
    rebind_symbols(&amp;rebind, 1);
}
</code></pre>
<h3 data-id="heading-20">3. 自定义动态库的Hook</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// MyDynamicFramework.framework
__attribute__((visibility("default")))
void framework_function() {
    NSLog(@"Original framework function");
}

// 主工程中的Hook
static void (*original_framework_func)() = NULL;

void hooked_framework_func() {
    NSLog(@"Before framework function");
    original_framework_func();
    NSLog(@"After framework function");
}

// 安装Hook
struct rebinding rebind = {
    "framework_function",
    hooked_framework_func,
    (void**)&amp;original_framework_func
};
rebind_symbols(&amp;rebind, 1);
</code></pre>
<h2 data-id="heading-21">六、与Method Swizzling的对比</h2>
<h3 data-id="heading-22">1. Fishhook（C函数Hook）</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 适用于C函数</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">hook_c_function</span><span class="hljs-params">()</span> {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rebinding</span> <span class="hljs-title">rebind</span> =</span> {<span class="hljs-string">"printf"</span>, hooked_printf, &amp;original_printf};
    rebind_symbols(&amp;rebind, <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-23">2. Method Swizzling（Objective-C方法Hook）</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 适用于Objective-C方法
+ (void)hookObjectiveCMethod {
    Method original = class_getInstanceMethod([UIView class], @selector(setBackgroundColor:));
    Method swizzled = class_getInstanceMethod([self class], @selector(hooked_setBackgroundColor:));
    method_exchangeImplementations(original, swizzled);
}
</code></pre>
<h3 data-id="heading-24">3. 选择指南</h3>





























<table><thead><tr><th>场景</th><th>推荐技术</th></tr></thead><tbody><tr><td>Hook C系统函数</td><td>Fishhook</td></tr><tr><td>Hook C自定义函数</td><td>Fishhook</td></tr><tr><td>Hook Objective-C方法</td><td>Method Swizzling</td></tr><tr><td>Hook Swift方法</td><td>Method Swizzling（通过@objc暴露）</td></tr><tr><td>底层系统监控</td><td>Fishhook</td></tr></tbody></table>
<h2 data-id="heading-25">七、实战案例</h2>
<h3 data-id="heading-26">1. 性能监控</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 监控内存分配
static void *(*original_malloc)(size_t);
static void (*original_free)(void *);

void *hooked_malloc(size_t size) {
    void *ptr = original_malloc(size);
    
    // 记录大内存分配
    if (size &gt; 1024 * 1024) {
        printf("[MEMORY] Large malloc: %zu bytes\n", size);
    }
    
    return ptr;
}

void hooked_free(void *ptr) {
    // 可以在这里添加内存释放监控
    original_free(ptr);
}
</code></pre>
<h2 data-id="heading-27">八、常见问题解答</h2>
<h3 data-id="heading-28">Q1: Fishhook能Hook静态库函数吗？</h3>
<p><strong>A:</strong> 取决于静态库的链接方式：</p>
<ul>
<li>如果静态库被完全复制到动态库中，可以Hook</li>
<li>如果静态库保持外部引用，需要在链接静态库的地方Hook</li>
<li>静态库的私有函数（static）无法Hook</li>
</ul>
<h3 data-id="heading-29">Q2: 为什么OC和Swift方法不能用Fishhook Hook？</h3>
<p><strong>A:</strong> Objective-C和Swift的方法调用机制完全不同：</p>
<ul>
<li>Objective-C使用消息发送机制（objc_msgSend）</li>
<li>Swift有自己的分发机制（虚函数表、直接调用等）</li>
<li>它们不通过符号绑定表调用，因此Fishhook无法修改</li>
</ul>
<h3 data-id="heading-30">Q3: Hook的时机是什么？</h3>
<p><strong>A:</strong> Fishhook可以在运行时任何时间点进行Hook，但最佳实践是：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">// 1. 程序启动时（推荐）
__attribute__((constructor))
static void setup_hooks() {
    // 在main()函数之前执行
}

// 2. 运行时动态Hook
void dynamic_hook() {
    // 可以在需要时动态安装或移除Hook
}

// 3. 使用dispatch_once保证只Hook一次
static dispatch_once_t onceToken;
dispatch_once(&amp;onceToken, ^{
    // 安装Hook
});
</code></pre>
<h3 data-id="heading-31">Q4: 在MachOView中为什么看不到__nl_symbol_ptr？</h3>
<p><strong>A:</strong> 在现代iOS/macOS系统中：</p>
<ul>
<li><code>__nl_symbol_ptr</code>已被<code>__got</code>（全局偏移表）替代</li>
<li>所有需要立即绑定的符号现在都放在<code>__got</code>中</li>
<li>这是为了更好的位置无关代码支持和性能优化</li>
</ul>
<h2 data-id="heading-32">九、Fishhook的局限性</h2>
<h3 data-id="heading-33">1. 技术限制</h3>
<ul>
<li>只能Hook通过符号表调用的函数</li>
<li>无法Hook内联函数和静态链接函数</li>
<li>对C++函数支持有限（名称重整问题）</li>
<li>线程安全问题需要开发者自己处理</li>
</ul>
<h3 data-id="heading-34">2. 平台限制</h3>
<ul>
<li>iOS非越狱设备受限较多</li>
<li>某些系统函数受代码签名保护</li>
<li>不同iOS版本可能有行为差异</li>
</ul>
<h3 data-id="heading-35">3. 性能考虑</h3>
<ul>
<li>第一次Hook需要遍历符号表，有性能开销</li>
<li>频繁的动态Hook/Unhook可能影响性能</li>
<li>需要考虑多线程环境下的安全性</li>
</ul>
<h2 data-id="heading-36">十、未来展望</h2>
<h3 data-id="heading-37">1. 替代方案</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 1. Dobby（原DobbyHook）
// 支持inline hook，更强大
#include &lt;dobby.h&gt;
DobbyHook((void *)printf, (void *)hooked_printf, (void **)&amp;original_printf);

// 2. substrate（越狱设备）
// iOS越狱环境下的完整Hook框架
MSHookFunction((void *)printf, (void *)hooked_printf, (void **)&amp;original_printf);
</code></pre>
<h3 data-id="heading-38">2. 发展趋势</h3>
<ul>
<li>Apple正在加强系统安全性</li>
<li>静态分析和运行时保护机制增强</li>
<li>对动态代码修改的限制可能增加</li>
<li>开发者需要更多关注官方提供的调试和监控API</li>
</ul>
<h2 data-id="heading-39">结语</h2>
<p>Fishhook通过精巧地利用Mach-O文件的动态链接机制，实现了轻量级的函数Hook功能。虽然它有一定的局限性，但仍然是理解macOS/iOS系统底层机制的绝佳案例，也是许多调试和监控工具的基础。</p>
<p>通过本文的详细解析，我们希望读者能够：</p>
<ol>
<li>深入理解Mach-O文件结构和动态链接机制</li>
<li>掌握Fishhook的工作原理和使用方法</li>
<li>了解不同Hook技术的适用场景</li>
<li>在实际开发中正确应用Hook技术</li>
</ol>
<p>记住，强大的工具也意味着重大的责任。Hook技术应该用于正当的调试、监控和优化目的，而不是破坏系统安全或侵犯用户隐私。</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Ffishhook" target="_blank" title="https://github.com/facebook/fishhook" ref="nofollow noopener noreferrer">Fishhook GitHub仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Fdocumentation%2FPerformance%2FConceptual%2FCodeFootprint%2FArticles%2FMachOOverview.html" target="_blank" title="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/Articles/MachOOverview.html" ref="nofollow noopener noreferrer">Apple Mach-O文件格式文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopensource.apple.com%2Fsource%2Fdyld%2F" target="_blank" title="https://opensource.apple.com/source/dyld/" ref="nofollow noopener noreferrer">dyld源码分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F30227889%2F" target="_blank" title="https://book.douban.com/subject/30227889/" ref="nofollow noopener noreferrer">iOS逆向工程：原理与实践</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[中国AI模型登顶！阿里的Z-Image-Turbo 成为文生图天花板]]></title>    <link>https://juejin.cn/post/7596989416760541219</link>    <guid>https://juejin.cn/post/7596989416760541219</guid>    <pubDate>2026-01-20T04:13:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596989416760541219" data-draft-id="7596989416760524835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="中国AI模型登顶！阿里的Z-Image-Turbo 成为文生图天花板"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T04:13:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            中国AI模型登顶！阿里的Z-Image-Turbo 成为文生图天花板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:13:47.000Z" title="Tue Jan 20 2026 04:13:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，这几个月 AI 圈子的变化快得让人有点跟不上。</p>
<p>前阵子大家还在讨论国外的 Midjourney V6 或是 Flux 有多强，结果一转眼，国产模型又杀出来了。</p>
<p>这次的主角是阿里的 Z-Image-Turbo。</p>
<p>名字听起来挺硬核的，但简单来说，它刚刚在一众评测里拿了个第一，算是把“文生图”这个领域的天花板，又往上顶了顶。</p>
<h2 data-id="heading-0">1. 不只是“画得好”，关键是“快”</h2>
<p>大家玩 AI 绘画，最头疼的是什么？除了要费劲写提示词，就是“等”。</p>
<p>以前生成一张高清大图，你可能得去倒杯水，甚至还得修修补补半天。但这次 Z-Image-Turbo 最大的卖点，就在那个 "Turbo" 上。</p>
<p>它的出图速度非常夸张。怎么形容呢？差不多就是你刚敲完回车，脑子里的画面还没完全定型，屏幕上图已经出来了。而且，这可不是那种糊弄人的草图，是那种光影、纹理、甚至是毛发细节都拉满的成品。</p>
<p>有测评博主试了一下，同样的复杂场景——比如“雨夜霓虹灯下的机械姬”，它处理反光和水渍的质感，比之前的行业老大还要自然。这种感觉，就像是给你的显卡打了鸡血一样。</p>
<p>我尝试了以下提示词：</p>
<blockquote>
<p>一张充满张力的漫画风格摄影作品。夜晚，霓虹灯闪烁的赛博朋克街道。一位身穿JK制服的少女，摆出专业的日本女武士拔刀起势姿态（居合道架势），身体重心下沉。她的左手紧握腰间的刀鞘，右手反手握住刀柄，准备拔刀。强烈的彩色霓虹光从她背后照射，勾勒出帅气的剪影轮廓光。她猛然回头看向身后，眼神警觉、锐利，又带有一丝被惊动的慌乱。雨夜湿漉漉的地面反射着光影，颗粒感，极具冲击力。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aadc21030ed74d579cfd2ee4dfe49098~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769487226&amp;x-signature=Q56xMyWfg1hFvQ5azG7JHU6sAhM%3D" alt="" loading="lazy"/></p>
<p>效果非常不错。</p>
<h2 data-id="heading-1">2. 终于不用那是蹩脚的“机翻英文”了</h2>
<p>对于咱们国内用户来说，Z-Image-Turbo 最让人舒服的一点，其实是懂中文。</p>
<p>玩过国外模型的朋友都知道，为了让 AI 听懂人话，不仅得用英文写提示词，还得背各种复杂的语法公式。想画个“红烧肉”，如果不描述清楚肥瘦相间、色泽红亮，它很可能给你画出一块奇怪的生肉。</p>
<p>但阿里的这个模型毕竟是自家孩子，对中文语境的理解那是真的到位。</p>
<p>你直接输入一句大白话，他就能get到我们中国的点，比如：</p>
<blockquote>
<p>大师级作品，油画媒介，半身肖像，1个女孩，特写，斑驳的阳光，丁达尔效应（光柱），光斑落在皮肤上，温暖的金光，绚烂的色彩，丰富的笔触感，厚涂法，秋日氛围，柔焦，梦幻，极其细致的皮肤质感。</p>
</blockquote>
<p>效果如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a5b164343241b5b0ce6ac43c26deb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769487226&amp;x-signature=G7%2BijKhFOf47grx2%2F24cAW5HYaI%3D" alt="" loading="lazy"/></p>
<p>说白了，它降低了咱们普通人玩 AI 的门槛。不用学咒语，只要你会说话，就能当画家。</p>
<h2 data-id="heading-2">3. 最重要的，能白嫖试用</h2>
<p>感兴趣的可以访问网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.z-image-pro.com%2F" target="_blank" title="https://www.z-image-pro.com/" ref="nofollow noopener noreferrer">www.z-image-pro.com/</a> 进行免费试用。</p>
<p>如果你是开发者，你甚至能白嫖API。</p>
<p>当然了，AI 这个领域大家也知道，今天的第一名，可能下个月就被超越了。</p>
<p>但 Z-Image-Turbo 的出现，至少证明了一件事：在审美和技术结合这块，国产模型已经完全不虚那几家国外巨头了。如果你最近正好想做点海报，或者单纯想画着玩，真的可以去试试这个新“天花板”。</p>
<p>毕竟，好用、听话、还画得快，谁能拒绝呢？</p>
<p>一张它画的小怪兽镇楼：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da3a1255f4c947c29f22e4607ae275a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769487226&amp;x-signature=k6BNAHxQSq5jj94qjYObYU6K90Q%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用C#高效嵌入文件和注释附件到PDF文档]]></title>    <link>https://juejin.cn/post/7596989416760377379</link>    <guid>https://juejin.cn/post/7596989416760377379</guid>    <pubDate>2026-01-20T03:39:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596989416760377379" data-draft-id="7596962344045789224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用C#高效嵌入文件和注释附件到PDF文档"/> <meta itemprop="keywords" content="后端,C#"/> <meta itemprop="datePublished" content="2026-01-20T03:39:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户835629078051"/> <meta itemprop="url" content="https://juejin.cn/user/3150554985403516"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用C#高效嵌入文件和注释附件到PDF文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3150554985403516/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户835629078051
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:39:08.000Z" title="Tue Jan 20 2026 03:39:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d48f5da43fee40d38ca3fbc06f73861d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODM1NjI5MDc4MDUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485148&amp;x-signature=jtjCFGXZoSeBxjiKKTfdIXQ4TFc%3D" alt="如何使用C#在PDF文档中插入附件" loading="lazy"/></p>
<p>在现代办公和数据交换中，PDF文档因其跨平台、内容固定等特性，已经成为不可或缺的一部分。然而，有时我们不仅需要共享PDF内容本身，还需要附带一些相关的支持文件，例如源数据文件、详细报告、多媒体内容或是补充说明。这时，如何在PDF文档中高效且专业地嵌入附件，就成为了一个重要的需求。</p>
<p>本教程将深入探讨如何在C#编程环境中，利用强大的Spire.PDF for .NET库实现PDF附件的插入。我们将详细介绍两种关键的附件插入方法：<strong>直接插入附件</strong>和<strong>插入附件注释</strong>，帮助您根据不同场景选择最合适的方案，从而显著提升您的文档处理能力。</p>
<h2 data-id="heading-0">理解PDF附件及其应用场景</h2>
<p>PDF附件，顾名思义，就是嵌入在PDF文件内部的另一个文件。它与普通的超链接或文件路径引用不同，附件是文件本身的一部分，即使PDF文件被移动或重命名，附件依然保持可访问性，无需担心链接失效。</p>
<p>PDF附件的应用场景非常广泛：</p>
<ul>
<li><strong>数据归档与溯源：</strong> 将生成PDF报告的原始数据文件（如Excel、CSV）作为附件嵌入，方便日后查阅和验证。</li>
<li><strong>多媒体内容嵌入：</strong> 在演示文稿或电子书中嵌入视频、音频文件，提供更丰富的阅读体验。</li>
<li><strong>补充文档：</strong> 将合同的附件、技术手册的补充说明等作为附件，确保所有相关信息集中管理。</li>
<li><strong>源代码或配置：</strong> 对于技术文档，可以将示例代码或配置文件作为附件，方便用户直接获取。</li>
</ul>
<p>为了在C#中实现这些功能，我们将依赖于一个专业的PDF处理库——Spire.PDF for .NET。它提供了丰富的API，使开发者能够轻松地创建、修改、读取和转换PDF文档，包括对附件的全面支持。</p>
<h2 data-id="heading-1">使用C#直接插入附件到PDF</h2>
<p>直接插入附件指的是将一个文件作为“包裹”在PDF内部的数据流，通常在PDF阅读器的“附件”面板中可见。这种方式适用于需要批量嵌入附件或附件作为背景数据，不直接在页面上显示的情况。</p>
<h3 data-id="heading-2">详细步骤</h3>
<ol>
<li><strong>环境准备：</strong>
首先，您需要在您的.NET项目中安装Spire.PDF for .NET库。最便捷的方式是通过NuGet包管理器：
Install-Package Spire.PDF</li>
<li><strong>创建或加载PDF文档：</strong>
您可以创建一个新的PDF文档，或者加载一个现有的PDF文档。</li>
<li><strong>选择附件文件：</strong>
指定您希望作为附件插入的文件的路径。</li>
<li><strong>添加附件到PDF文档的附件集合中：</strong>
使用<code>PdfAttachment</code>类创建附件对象，并将其添加到<code>PdfDocument</code>的<code>Attachments</code>集合中。</li>
<li><strong>保存修改后的PDF文档：</strong>
将包含新附件的PDF文档保存到指定路径。</li>
</ol>
<h3 data-id="heading-3">C#代码示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Pdf;
<span class="hljs-keyword">using</span> Spire.Pdf.Attachments;
<span class="hljs-keyword">using</span> System.IO;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">InsertPdfAttachment</span>
{
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// 1. 创建一个新的PDF文档</span>
            PdfDocument doc = <span class="hljs-keyword">new</span> PdfDocument();
            doc.LoadFromFile(<span class="hljs-string">"Input.pdf"</span>); <span class="hljs-comment">// 如果您想加载现有PDF，请使用此行</span>

            <span class="hljs-comment">// 添加一个页面以确保文档有内容（如果是新文档）</span>
            <span class="hljs-keyword">if</span> (doc.Pages.Count == <span class="hljs-number">0</span>)
            {
                doc.Pages.Add();
            }

            <span class="hljs-comment">// 2. 指定附件文件路径</span>
            <span class="hljs-built_in">string</span> attachmentFilePath = <span class="hljs-string">"Sample.xlsx"</span>; <span class="hljs-comment">// 这是一个示例Excel文件</span>

            <span class="hljs-comment">// 创建一个示例附件文件（如果不存在）</span>
            <span class="hljs-keyword">if</span> (!File.Exists(attachmentFilePath))
            {
                File.WriteAllText(attachmentFilePath, <span class="hljs-string">"This is a sample text attachment content."</span>);
            }

            <span class="hljs-comment">// 3. 创建PdfAttachment对象</span>
            PdfAttachment attachment = <span class="hljs-keyword">new</span> PdfAttachment(attachmentFilePath);

            <span class="hljs-comment">// 读取附件文件的所有字节数据</span>
            attachment.Data = File.ReadAllBytes(attachmentFilePath);

            <span class="hljs-comment">// 设置附件的描述和MIME类型（可选）</span>
            attachment.Description = <span class="hljs-string">"这是一个示例文本附件。"</span>;
            attachment.MimeType = <span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>; <span class="hljs-comment">// 可选，可根据附件类型设置MIME类型</span>

            <span class="hljs-comment">// 4. 将附件添加到PDF文档的Attachments集合中</span>
            doc.Attachments.Add(attachment);

            <span class="hljs-comment">// 5. 保存修改后的PDF文档</span>
            doc.SaveToFile(<span class="hljs-string">"PdfWithDirectAttachment.pdf"</span>);
            doc.Close();

            Console.WriteLine(<span class="hljs-string">"附件已成功直接插入到PDF文档中！"</span>);
        }
    }
}
</code></pre>
<p><strong>结果文档预览：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3861a398bbc0437cb44fd3269abc86f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODM1NjI5MDc4MDUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485148&amp;x-signature=QG1eRrxn6zW9zxiiWj8p2X5fu7o%3D" alt="使用C#在PDF文档中直接插入附件" loading="lazy"/></p>
<h3 data-id="heading-4">解释和注意事项</h3>
<ul>
<li><code>PdfAttachment attachment = new PdfAttachment(attachmentFilePath);</code>：构造函数接收附件的文件名，这通常是附件在PDF阅读器中显示的名称。</li>
<li><code>attachment.Data = File.ReadAllBytes(attachmentFilePath);</code>：这是关键一步，将附件文件的二进制内容读取并赋值给<code>Data</code>属性。</li>
<li><code>attachment.Description</code>和<code>attachment.MimeType</code>：这些属性是可选的，但建议设置，它们提供了关于附件的额外信息，有助于阅读器正确处理和显示附件。</li>
<li>文件路径：请确保<code>attachmentFilePath</code>指向的文件实际存在。在实际应用中，您可能需要处理文件不存在的异常。</li>
</ul>
<h2 data-id="heading-5">使用C#插入附件注释</h2>
<p>附件注释（Attachment Annotation）则更为直观和交互。它会在PDF页面上显示一个图标（例如一个回形针），用户点击该图标即可打开或保存附件。这种方式适用于需要在PDF特定位置明确指示附件存在，并提供用户交互的场景。</p>
<h3 data-id="heading-6">详细步骤</h3>
<ol>
<li><strong>创建或加载PDF文档：</strong>
与直接插入附件相同。</li>
<li><strong>选择附件文件：</strong>
指定您希望作为附件注释插入的文件的路径。</li>
<li><strong>创建附件注释对象：</strong>
实例化<code>PdfAttachmentAnnotation</code>类，并指定其在PDF页面上的位置和大小。</li>
<li><strong>关联附件文件到附件注释：</strong>
通过<code>Attachment</code>属性将之前创建的<code>PdfAttachment</code>对象与注释关联起来。</li>
<li><strong>将附件注释添加到PDF页面：</strong>
将创建好的<code>PdfAttachmentAnnotation</code>对象添加到目标页面的<code>Annotations</code>集合中。</li>
<li><strong>保存修改后的PDF文档。</strong></li>
</ol>
<h3 data-id="heading-7">C#代码示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Pdf;
<span class="hljs-keyword">using</span> Spire.Pdf.Annotations;
<span class="hljs-keyword">using</span> Spire.Pdf.Attachments;
<span class="hljs-keyword">using</span> System.Drawing;
<span class="hljs-keyword">using</span> System.IO;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">InsertPdfAttachmentAnnotation</span>
{
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// 1. 创建一个新的PDF文档</span>
            PdfDocument doc = <span class="hljs-keyword">new</span> PdfDocument();
            <span class="hljs-comment">//doc.LoadFromFile("Input.pdf"); // 如果您想加载现有PDF，请使用此行</span>

            <span class="hljs-comment">// 获取第一个页面（如果文档为空，则添加一个新页面）</span>
            PdfPageBase page = doc.Pages.Count &gt; <span class="hljs-number">0</span> ? doc.Pages[<span class="hljs-number">0</span>] : doc.Pages.Add();

            <span class="hljs-comment">// 2. 指定附件文件路径</span>
            <span class="hljs-built_in">string</span> attachmentFilePath = <span class="hljs-string">"Ocean1.png"</span>; <span class="hljs-comment">// 这是一个示例图片文件</span>

            <span class="hljs-comment">// 创建一个示例附件文件（如果不存在）</span>
            <span class="hljs-keyword">if</span> (!File.Exists(attachmentFilePath))
            {
                <span class="hljs-comment">// 简单创建一个空白图片作为示例</span>
                <span class="hljs-keyword">using</span> (Bitmap bmp = <span class="hljs-keyword">new</span> Bitmap(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>))
                {
                    <span class="hljs-keyword">using</span> (Graphics g = Graphics.FromImage(bmp))
                    {
                        g.FillRectangle(Brushes.LightBlue, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
                        g.DrawString(<span class="hljs-string">"附件内容"</span>, <span class="hljs-keyword">new</span> Font(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>), Brushes.Black, <span class="hljs-number">10</span>, <span class="hljs-number">40</span>);
                    }
                    bmp.Save(attachmentFilePath, System.Drawing.Imaging.ImageFormat.Png);
                }
            }

            <span class="hljs-comment">// 3. 创建PdfAttachment对象（与直接插入附件类似）</span>
            PdfAttachment attachment = <span class="hljs-keyword">new</span> PdfAttachment(attachmentFilePath);
            attachment.Data = File.ReadAllBytes(attachmentFilePath);
            attachment.Description = <span class="hljs-string">"这是一个示例图片附件。"</span>;

            <span class="hljs-comment">// 4. 创建附件注释对象，并指定其在页面上的位置和大小</span>
            <span class="hljs-comment">// 在页面坐标 (100, 100) 处创建一个 24x24 像素的注释图标</span>
            RectangleF annotationBounds = <span class="hljs-keyword">new</span> RectangleF(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">24</span>, <span class="hljs-number">24</span>);
            PdfAttachmentAnnotation attachmentAnnotation = <span class="hljs-keyword">new</span> PdfAttachmentAnnotation(annotationBounds, attachment.FileName, attachment.Data);

            <span class="hljs-comment">// 5. 设置附件注释的属性（可选）</span>
            attachmentAnnotation.Icon = PdfAttachmentIcon.Paperclip; <span class="hljs-comment">// 设置图标样式，例如回形针</span>
            attachmentAnnotation.Text = <span class="hljs-string">"点击查看图片附件"</span>; <span class="hljs-comment">// 鼠标悬停时的提示文本</span>
            attachmentAnnotation.Color = Color.LightBlue; <span class="hljs-comment">// 设置注释图标的背景颜色</span>

            <span class="hljs-comment">// 6. 将附件注释添加到PDF页面</span>
            page.Annotations.Add(attachmentAnnotation);

            <span class="hljs-comment">// 7. 保存修改后的PDF文档</span>
            doc.SaveToFile(<span class="hljs-string">"PdfWithAttachmentAnnotation.pdf"</span>);
            doc.Close();

            Console.WriteLine(<span class="hljs-string">"附件注释已成功插入到PDF文档中！"</span>);
        }
    }
}
</code></pre>
<p><strong>结果文档预览：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5320a7e8cfc74a378e394a8469c0f7c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODM1NjI5MDc4MDUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485148&amp;x-signature=s9HXCKaSTKaut23bgtKPUMuEtmA%3D" alt="使用C#在PDF文档中插入附件注释" loading="lazy"/></p>
<h3 data-id="heading-8">解释和注意事项</h3>
<ul>
<li><code>RectangleF annotationBounds = new RectangleF(100, 100, 24, 24);</code>：定义了附件注释图标在页面上的位置（X, Y）和大小（宽度，高度）。</li>
<li><code>PdfAttachmentAnnotation attachmentAnnotation = new PdfAttachmentAnnotation(annotationBounds, fileName, attatchmentData);</code>：构造函数需要注释的边界和要关联的<code>PdfAttachment</code>对象。</li>
<li><code>attachmentAnnotation.Icon = PdfAttachmentIcon.Paperclip;</code>：您可以选择不同的内置图标样式，例如<code>PushPin</code>、<code>Graph</code>等。</li>
<li><code>attachmentAnnotation.Text</code>：鼠标悬停在图标上时显示的文本，提供更好的用户体验。</li>
<li><code>attachmentAnnotation.Color</code>：自定义注释图标的颜色。</li>
</ul>
<h2 data-id="heading-9">两种方法的对比与选择</h2>
<p>了解了两种附件插入方式后，我们可以通过对比来帮助您做出更明智的选择。</p>






























<table><thead><tr><th align="left">特点</th><th align="left">直接插入附件</th><th align="left">插入附件注释</th></tr></thead><tbody><tr><td align="left"><strong>可见性</strong></td><td align="left">通常不可见，需通过PDF阅读器菜单（如“附件”面板）访问</td><td align="left">在PDF页面上显示图标，直观可见，指示附件位置</td></tr><tr><td align="left"><strong>交互性</strong></td><td align="left">较低，用户需主动查找并打开附件</td><td align="left">较高，用户可直接点击页面上的图标来打开附件</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">批量嵌入背景数据、元数据、不需直接在页面上交互的文件；对文件大小有较高要求时，可避免页面渲染额外元素。</td><td align="left">需要明确指示附件位置、提供用户交互、增强文档内容的可读性和功能性；例如在特定图表旁边附加原始数据，或在段落旁附加补充说明。</td></tr><tr><td align="left"><strong>复杂性</strong></td><td align="left">相对简单，只需创建附件对象并添加到文档集合</td><td align="left">略复杂，需考虑注释的位置、大小、图标样式等页面布局因素</td></tr></tbody></table>
<p><strong>选择建议：</strong></p>
<ul>
<li>如果您只是想将一些辅助文件打包到PDF中，而不需要在PDF页面上显示任何指示，或者附件数量较多、不适合在页面上逐一展示，那么<strong>直接插入附件</strong>是更简洁高效的选择。</li>
<li>如果您希望用户能够直观地看到附件的存在，并通过点击页面上的特定区域来访问附件，例如在报告的某个图表旁附上原始数据，或者在说明文档的某处提供一个视频教程，那么<strong>插入附件注释</strong>将提供更好的用户体验和交互性。</li>
</ul>
<h2 data-id="heading-10">结语</h2>
<p>通过本教程，我们深入探讨了如何使用C#和Spire.PDF for .NET库在PDF文档中插入附件。无论是选择直接将文件嵌入PDF，还是通过附件注释提供更具交互性的体验，Spire.PDF都提供了强大且灵活的工具来满足您的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新建一个angular项目]]></title>    <link>https://juejin.cn/post/7596975035438612489</link>    <guid>https://juejin.cn/post/7596975035438612489</guid>    <pubDate>2026-01-20T03:42:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438612489" data-draft-id="7596983314806751282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新建一个angular项目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T03:42:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米诺zuo"/> <meta itemprop="url" content="https://juejin.cn/user/2436173497373399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新建一个angular项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173497373399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米诺zuo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:42:35.000Z" title="Tue Jan 20 2026 03:42:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">新建一个 Angular 项目主要分为三个步骤：<strong>安装环境</strong>、<strong>创建项目</strong> 和 <strong>启动项目</strong>。</h2>
<h3 data-id="heading-1">第一步：安装必要的环境</h3>
<p>在使用 Angular 之前，你的电脑上必须安装 <strong>Node.js</strong>。Angular CLI（命令行工具）依赖于 Node.js 来运行。</p>
<ol>
<li><strong>安装 Node.js</strong>：
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 官网</a>。</li>
<li>下载并安装 <strong>LTS 版本</strong>（长期支持版，最稳定）。</li>
<li><em>提示：安装后，在终端输入 <code>node -v</code> 和 <code>npm -v</code> 检查是否安装成功。</em></li>
</ul>
</li>
<li><strong>全局安装 Angular CLI</strong>：
<ul>
<li>打开终端（Terminal、CMD 或 PowerShell）。</li>
<li>输入以下命令并回车：
<pre><code class="hljs language-bash" lang="bash">npm install -g @angular/cli
</code></pre>
</li>
<li>这个命令会全局安装 Angular 的命令行工具，安装完成后，你可以输入 <code>ng version</code> 来检查是否安装成功。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-2">第二步：创建新项目</h3>
<p>环境准备好后，使用 <code>ng new</code> 命令来创建项目。</p>
<ol>
<li><strong>进入你想要存放项目的目录</strong>（例如 <code>cd Desktop</code>）。</li>
<li><strong>运行创建命令</strong>：
<pre><code class="hljs language-bash" lang="bash">ng new my-first-app
</code></pre>
<em>(注：<code>my-first-app</code> 是你的项目名称，可以自定义)</em></li>
<li><strong>回答配置问题</strong>（以 Angular 17+ 为例）：
命令运行后，CLI 会询问你几个问题来配置项目。通常建议新手如下选择（按提示输入字母并回车）：
<ul>
<li><strong>Which stylesheet format would you like to use?</strong> (你想使用哪种样式表格式？)
<ul>
<li>建议选择：<code>CSS</code> (如果你不熟悉 SCSS/Sass，选 CSS 最简单)</li>
</ul>
</li>
<li><strong>Do you want to enable Server-Side Rendering (SSR) and Static Site Generation (SSG/Prerendering)?</strong> (是否启用服务端渲染？)
<ul>
<li>建议选择：<code>N</code> (No)</li>
<li><em>理由：对于初学者构建普通单页应用，不需要 SSR，这样构建速度更快。</em></li>
</ul>
</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">第三步：启动开发服务器</h3>
<p>项目创建完成后，进入项目文件夹并启动它。</p>
<ol>
<li><strong>进入项目目录</strong>：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> my-first-app
</code></pre>
</li>
<li><strong>启动项目</strong>：
<pre><code class="hljs language-bash" lang="bash">ng serve
</code></pre>
<em>(或者使用简写 <code>npm start</code>)</em></li>
<li><strong>查看结果</strong>：
<ul>
<li>终端显示 <code>Local: http://localhost:4200/</code> 表示编译成功。</li>
<li>打开浏览器，访问 <code>http://localhost:4200/</code>。</li>
<li>如果看到 Angular 的欢迎页面（大大的 Angular Logo），恭喜你，项目创建成功！</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">常用附加操作</h3>
<h4 data-id="heading-5">1. 使用 VS Code 打开项目</h4>
<p>如果你使用 Visual Studio Code 编写代码，可以在终端中输入：</p>
<pre><code class="hljs language-bash" lang="bash">code .
</code></pre>
<p><em>(注意：需要确保你已经安装了 VS Code 并将其添加到了系统环境变量中)</em></p>
<h4 data-id="heading-6">2. 创建一个新组件</h4>
<p>在开发过程中，你通常需要创建新的组件。不要手动创建文件，请使用 CLI 命令：</p>
<pre><code class="hljs language-bash" lang="bash">ng generate component my-new-component
</code></pre>
<h2 data-id="heading-7"><em>(简写: <code>ng g c my-new-component</code>)</em></h2>
<h3 data-id="heading-8">常见问题排查</h3>
<ol>
<li><strong><code>ng</code> 命令找不到</strong>：
<ul>
<li>说明 Angular CLI 没有正确安装或环境变量没配置好。尝试重新运行 <code>npm install -g @angular/cli</code>。</li>
</ul>
</li>
<li><strong>安装速度极慢</strong>：
<ul>
<li>如果你在中国大陆，直接从 npm 服务器下载依赖可能会很慢。建议安装淘宝镜像源：
<pre><code class="hljs language-bash" lang="bash">npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com
</code></pre>
</li>
</ul>
</li>
<li><strong>端口被占用</strong>：
<ul>
<li>如果 4200 端口被占用，可以使用 <code>ng serve --port 4300</code> 来指定其他端口。
祝你开发顺利！</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Composable 中处理 DOM 元素]]></title>    <link>https://juejin.cn/post/7596993862533922816</link>    <guid>https://juejin.cn/post/7596993862533922816</guid>    <pubDate>2026-01-20T03:43:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596993862533922816" data-draft-id="7596993862533890048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Composable 中处理 DOM 元素"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-20T03:43:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unknown331"/> <meta itemprop="url" content="https://juejin.cn/user/2826172528344323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Composable 中处理 DOM 元素
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2826172528344323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unknown331
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:43:06.000Z" title="Tue Jan 20 2026 03:43:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常经典的问题：在 Composable 中处理 DOM 元素。</p>
<p>答案是：<strong>可以抽离，而且非常推荐。</strong> 在 Vue 3 的 Composition API 中，你可以直接将 <code>ref(null)</code> 定义在 Composable 内部并返回，或者从外部将 DOM Ref 作为参数传入。</p>
<p>为了保持逻辑的纯粹性，我建议采用 <strong>“定义在内，暴露在外”</strong> 的方案。这样 <code>InputField.vue</code> 就不需要维护这个 DOM 引用了。</p>
<hr/>
<h3 data-id="heading-0">1. 编写 <code>useInputHistory.js</code></h3>
<p>我们需要将 <code>chatStore</code> 的操作、<code>nextTick</code> 逻辑以及光标控制（<code>placeCaretAtEnd</code>）全部收拢。</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useInputHistory.js
import { ref, nextTick } from 'vue'<span class="hljs-comment">;</span>
import { useChatStore } from '../stores/chat.js'<span class="hljs-comment">;</span>

export function useInputHistory() {
  const <span class="hljs-attr">chatStore</span> = useChatStore()<span class="hljs-comment">;</span>
  
  // 在 Composable 内部定义 DOM Ref
  const <span class="hljs-attr">skillAreaRef</span> = ref(null)<span class="hljs-comment">;</span>

  // 辅助函数：将光标移至 contenteditable 末尾
  const <span class="hljs-attr">placeCaretAtEnd</span> = () =&gt; {
    const <span class="hljs-attr">el</span> = skillAreaRef.value<span class="hljs-comment">;</span>
    if (!el) return<span class="hljs-comment">;</span>
    const <span class="hljs-attr">range</span> = document.createRange()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">selection</span> = window.getSelection()<span class="hljs-comment">;</span>
    range.selectNodeContents(el)<span class="hljs-comment">;</span>
    range.collapse(false)<span class="hljs-comment">;</span>
    selection.removeAllRanges()<span class="hljs-comment">;</span>
    selection.addRange(range)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  /**
   * 撤销或重做逻辑
   * @param {string} keyFlag 'z' 或 'y'
   * @param {Ref} userInput 外部传入的普通输入框文本引用
   * @param {string} mode 模式标识
   */
  const <span class="hljs-attr">unOrRedo</span> = async (keyFlag, userInput, mode = null) =&gt; {
    // 1. 获取 store 计算后的新文本
    const <span class="hljs-attr">finallyMsg</span> = chatStore.operationOfInput(keyFlag)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">newContent</span> = finallyMsg ?? <span class="hljs-string">''</span><span class="hljs-comment">;</span>

    // 2. 更新基础 userInput (textarea 使用)
    <span class="hljs-attr">userInput.value</span> = newContent<span class="hljs-comment">;</span>

    // 3. 处理翻译模式 (contenteditable 使用)
    if (<span class="hljs-attr">mode</span> === <span class="hljs-string">'translate'</span> &amp;&amp; skillAreaRef.value) {
      if (!newContent) {
        // 处理特殊占位符逻辑
        <span class="hljs-attr">skillAreaRef.value.innerText</span> = <span class="hljs-string">'\u200B'</span><span class="hljs-comment">;</span>
        skillAreaRef.value.classList.add('empty')<span class="hljs-comment">;</span>
      } else {
        <span class="hljs-attr">skillAreaRef.value.innerText</span> = newContent<span class="hljs-comment">;</span>
        skillAreaRef.value.classList.remove('empty')<span class="hljs-comment">;</span>
      }

      // 等待 DOM 更新后重置光标
      await nextTick()<span class="hljs-comment">;</span>
      placeCaretAtEnd()<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return {
    skillAreaRef, // 暴露出去，让模板进行绑定
    unOrRedo
  }<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-1">2. 在 <code>InputField.vue</code> 中替换逻辑</h3>
<p>现在，你需要删除组件内原有的 <code>skillAreaRef</code> 定义，改为从 Hook 中获取。</p>
<p>JavaScript</p>
<pre><code class="hljs language-xml" lang="xml">// InputField.vue
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// ... 其他引入</span>
<span class="hljs-keyword">import</span> { useInputHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ChatInput/composables/useInputHistory.js'</span>;

<span class="hljs-comment">// 1. 初始化 Hook</span>
<span class="hljs-comment">// 注意：这里拿到的 skillAreaRef 直接对应模板里的 ref="skillAreaRef"</span>
<span class="hljs-keyword">const</span> { skillAreaRef, unOrRedo } = <span class="hljs-title function_">useInputHistory</span>();

<span class="hljs-comment">// 2. 之前的 handleKeydown 和 handleTranslateKeydown 逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeydown</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-comment">// ... </span>
  <span class="hljs-keyword">if</span> (ctrlKey &amp;&amp; (keyFlag === <span class="hljs-string">'z'</span> || keyFlag === <span class="hljs-string">'y'</span>)) {
    event.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-comment">// 传入 userInput，Hook 会自动处理文本框和 skillArea</span>
    <span class="hljs-title function_">unOrRedo</span>(keyFlag, userInput); 
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTranslateKeydown</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">if</span> (ctrlKey &amp;&amp; (keyFlag === <span class="hljs-string">'z'</span> || keyFlag === <span class="hljs-string">'y'</span>)) {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-comment">// 传入模式标识 'translate'</span>
    <span class="hljs-title function_">unOrRedo</span>(keyFlag, userInput, <span class="hljs-string">'translate'</span>);
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-comment">// 3. 删除组件内原来的 unOrRedo 函数和 placeCaretAtEnd 函数</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"skillAreaRef"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"skill-user-message"</span>
    <span class="hljs-attr">...</span>
  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 为什么这样抽离是正确的？</h3>
<ol>
<li><strong>自动绑定</strong>：在 Vue 3 中，只要 Composable 返回的 <code>ref</code> 名称与模板中的 <code>ref="..."</code> 属性值一致，Vue 会自动完成 DOM 绑定。</li>
<li><strong>降低组件复杂度</strong>：<code>InputField.vue</code> 不再需要关心如何操作 Range 对象、如何处理 <code>\u200B</code> 占位符，它只需要调用 <code>unOrRedo</code> 这个指令即可。</li>
<li><strong>光标逻辑复用</strong>：光标定位逻辑（<code>placeCaretAtEnd</code>）被封装在了 Hook 内部，不会污染主组件的命名空间。</li>
</ol>
<h3 data-id="heading-3">💡 核心总结贴纸</h3>
<blockquote>
<p><strong>Composable 处理 DOM 的黄金定律</strong>：</p>
<ul>
<li><strong>定义在内</strong>：在 Hook 内部 <code>const myRef = ref(null)</code>。</li>
<li><strong>返回引用</strong>：<code>return { myRef }</code>。</li>
<li><strong>外部绑定</strong>：组件 <code>const { myRef } = useHook()</code>，模板 <code>&lt;div ref="myRef"&gt;</code>。</li>
<li><strong>安全访问</strong>：在 Hook 的函数内访问 <code>myRef.value</code> 时需做非空检查。</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 对象字面量与面向对象编程：表现力之源]]></title>    <link>https://juejin.cn/post/7596989416760426531</link>    <guid>https://juejin.cn/post/7596989416760426531</guid>    <pubDate>2026-01-20T03:52:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596989416760426531" data-draft-id="7596989416760410147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 对象字面量与面向对象编程：表现力之源"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T03:52:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 对象字面量与面向对象编程：表现力之源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:52:52.000Z" title="Tue Jan 20 2026 03:52:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 对象字面量与面向对象编程：表现力之源</h2>
<p>JavaScript 作为一门动态、灵活的脚本语言，以其极强的表现力和低门槛著称。与其他静态语言（如 Java、C++）不同，JavaScript <strong>无需预先定义类</strong>即可创建对象——这正是其“表现力”的核心体现之一。在早期 JavaScript 中，甚至没有 <code>class</code> 关键字（ES6 才引入），开发者完全依赖<strong>对象字面量</strong>（Object Literal）来构建复杂的数据结构和行为逻辑。本文将深入探讨 JavaScript 的对象字面量、面向对象思想，以及其独特的数据类型体系，帮助你理解为何 JS 被誉为“最有表现力的脚本语言”。</p>
<hr/>
<h3 data-id="heading-1">一、对象字面量：JSON 风格的直接表达</h3>
<p>在 JavaScript 中，<strong>对象字面量</strong>是用花括号 <code>{}</code> 直接定义对象的方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"郑志鹏"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">hobbies</span>: [<span class="hljs-string">"学习"</span>, <span class="hljs-string">"乒乓球"</span>],
  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好，我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
};
</code></pre>
<p>这种写法直观、简洁，几乎等同于 JSON（JavaScript Object Notation）格式。事实上，JSON 正是从 JS 对象字面量演化而来。</p>
<h4 data-id="heading-2">为什么说它“有表现力”？</h4>
<ul>
<li><strong>无需类模板</strong>：Java 中要创建一个 <code>Person</code> 对象，必须先写一个 <code>class Person</code>；而 JS 可以直接“字面意义上”写出这个对象。</li>
<li><strong>动态可变</strong>：对象属性可在运行时增删改：
<pre><code class="hljs language-js" lang="js">person.<span class="hljs-property">city</span> = <span class="hljs-string">"上饶"</span>; <span class="hljs-comment">// 动态添加属性</span>
<span class="hljs-keyword">delete</span> person.<span class="hljs-property">age</span>;     <span class="hljs-comment">// 删除属性</span>
</code></pre>
</li>
<li><strong>方法即属性</strong>：函数也是值，可作为对象的方法直接嵌入。</li>
</ul>
<blockquote>
<p>✅ <strong>提示</strong>：对象字面量是 JavaScript 实现“简单面向对象”的基石。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">二、面向对象：从属性方法到人际关系建模</h3>
<p>面向对象编程（OOP）的核心思想是：<strong>将现实世界抽象为对象，对象包含属性（数据）和方法（行为）</strong>。</p>
<h4 data-id="heading-4">1. 简单的面向对象</h4>
<p>以“送花”场景为例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> zzp = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"郑志鹏"</span>,
  <span class="hljs-title function_">sendFlower</span>(<span class="hljs-params">target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target.<span class="hljs-property">receiveFlower</span> === <span class="hljs-string">'function'</span>) {
      target.<span class="hljs-title function_">receiveFlower</span>(<span class="hljs-variable language_">this</span>);
    }
  }
};

<span class="hljs-keyword">let</span> xm = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"小美"</span>,
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到了 <span class="hljs-subst">${sender.name}</span> 送的花！`</span>);
  }
};

zzp.<span class="hljs-title function_">sendFlower</span>(xm); <span class="hljs-comment">// 输出：小美收到了 郑志鹏 送的花！</span>
</code></pre>
<p>这里，<code>zzp</code> 和 <code>xm</code> 是两个独立对象，通过方法交互，体现了<strong>封装</strong>（数据与行为绑定）和<strong>消息传递</strong>（调用对方方法）。</p>
<h4 data-id="heading-5">2. 复杂的人际关系建模</h4>
<p>JS 的灵活性允许我们模拟更复杂的关系：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> socialNetwork = {
  <span class="hljs-attr">users</span>: {},
  <span class="hljs-title function_">addUser</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[user.<span class="hljs-property">name</span>] = user;
  },
  <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"><span class="hljs-keyword">from</span>, to, msg</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[to]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[to].<span class="hljs-property">inbox</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">from</span>}</span>: <span class="hljs-subst">${msg}</span>`</span>);
    }
  }
};

<span class="hljs-keyword">let</span> alice = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">inbox</span>: [] };
<span class="hljs-keyword">let</span> bob = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">inbox</span>: [] };

socialNetwork.<span class="hljs-title function_">addUser</span>(alice);
socialNetwork.<span class="hljs-title function_">addUser</span>(bob);
socialNetwork.<span class="hljs-title function_">sendMessage</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"今晚打球吗？"</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bob.<span class="hljs-property">inbox</span>); <span class="hljs-comment">// ["Alice: 今晚打球吗？"]</span>
</code></pre>
<p>这种动态、松耦合的建模方式，正是 JavaScript 在前端状态管理、游戏开发等领域大放异彩的原因。</p>
<hr/>
<h3 data-id="heading-6">三、JavaScript 数据类型详解（面试高频考点）</h3>
<p>理解 JS 的数据类型，是掌握其对象模型的前提。JS 共有 <strong>7 种基本数据类型</strong>（ES2022 起）：</p>













































<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>string</code></td><td>字符串</td><td><code>"hello"</code></td></tr><tr><td><code>number</code></td><td>数值（含整数、浮点、NaN、Infinity）</td><td><code>42</code>, <code>3.14</code></td></tr><tr><td><code>boolean</code></td><td>布尔值</td><td><code>true</code>, <code>false</code></td></tr><tr><td><code>null</code></td><td>空值（有意 absence of value）</td><td><code>null</code></td></tr><tr><td><code>undefined</code></td><td>未定义（变量声明未赋值）</td><td><code>let a; console.log(a); // undefined</code></td></tr><tr><td><code>symbol</code></td><td>唯一标识符（ES6 新增）</td><td><code>Symbol('id')</code></td></tr><tr><td><code>bigint</code></td><td>大整数（ES2020 新增）</td><td><code>123n</code></td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：<strong>数组（Array）不是独立的数据类型！</strong></p>
</blockquote>
<h4 data-id="heading-7">关键认知：万物皆对象？不！</h4>
<p>使用 <code>typeof</code> 操作符可验证：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">typeof</span> <span class="hljs-string">"abc"</span>        <span class="hljs-comment">// "string"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-number">123</span>          <span class="hljs-comment">// "number"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">true</span>         <span class="hljs-comment">// "boolean"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">null</span>         <span class="hljs-comment">// "object" ← 这是历史 bug！</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">undefined</span>    <span class="hljs-comment">// "undefined"</span>
<span class="hljs-keyword">typeof</span> {}           <span class="hljs-comment">// "object"</span>
<span class="hljs-keyword">typeof</span> []           <span class="hljs-comment">// "object" ← 数组本质是对象！</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){} <span class="hljs-comment">// "function" ← 函数是特殊对象</span>
</code></pre>
<h5 data-id="heading-8">重点澄清：</h5>
<ul>
<li><strong>数组是对象</strong>：<code>Array</code> 是 <code>Object</code> 的子类型，具有索引和 <code>length</code> 属性。</li>
<li><strong>函数是对象</strong>：可拥有属性、方法，甚至可被调用。</li>
<li><strong><code>null</code> 的 <code>typeof</code> 是 <code>"object"</code></strong>：这是 JavaScript 最著名的 bug 之一，源于早期实现错误，但为兼容性保留至今。</li>
</ul>
<hr/>
<h3 data-id="heading-9">四、对象 vs 基本类型：引用与值的区别</h3>
<p>这是 JS 面试必考题！</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 基本类型：按值传递</span>
<span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;
<span class="hljs-keyword">let</span> b = a;
b = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 10 → 不受影响</span>

<span class="hljs-comment">// 对象：按引用传递</span>
<span class="hljs-keyword">let</span> obj1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">"A"</span> };
<span class="hljs-keyword">let</span> obj2 = obj1;
obj2.<span class="hljs-property">name</span> = <span class="hljs-string">"B"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">name</span>); <span class="hljs-comment">// "B" → 被修改！</span>
</code></pre>
<ul>
<li><strong>基本类型</strong>（string/number/boolean 等）存储在栈中，赋值时复制值。</li>
<li><strong>对象</strong>（包括数组、函数）存储在堆中，变量保存的是<strong>引用地址</strong>，赋值时复制地址。</li>
</ul>
<blockquote>
<p>💡 理解这一点，才能避免“改了一个对象，另一个也变了”的坑。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">五、现代 JavaScript 的演进：从字面量到 class</h3>
<p>虽然对象字面量足够强大，但随着项目复杂度提升，ES6 引入了 <code>class</code> 语法糖：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 传统字面量（工厂模式）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> {
    name,
    <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>); }
  };
}

<span class="hljs-comment">// ES6 class（更清晰的构造语义）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}
</code></pre>
<p>但请注意：<strong><code>class</code> 本质仍是基于原型的对象</strong>，底层依然依赖对象字面量和函数。</p>
<hr/>
<h3 data-id="heading-11">结语：表现力源于简单与自由</h3>
<p>JavaScript 的魅力，在于它用最简单的语法（<code>{}</code>、<code>[]</code>）实现了强大的抽象能力。你不需要理解复杂的类继承体系，就能用对象字面量表达现实世界的实体与关系。这种“所见即所得”的表现力，正是它成为 Web 开发首选语言的关键。</p>
<blockquote>
<p><strong>记住</strong>：</p>
<ul>
<li>对象字面量是 JS 面向对象的起点；</li>
<li>数组是对象，函数也是对象；</li>
<li><code>let/const</code> 不挂全局，调试时可用 <code>var</code> 或 <code>window.xxx</code>；</li>
<li>理解数据类型与引用机制，是写出健壮代码的基础。</li>
</ul>
</blockquote>
<p>掌握这些核心概念，你不仅能应对面试，更能写出更具表现力的 JavaScript 代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑]]></title>    <link>https://juejin.cn/post/7597009443084419087</link>    <guid>https://juejin.cn/post/7597009443084419087</guid>    <pubDate>2026-01-20T03:59:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084419087" data-draft-id="7596989416760459299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T03:59:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:59:32.000Z" title="Tue Jan 20 2026 03:59:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑</h2>
<p>在软件工程中，<strong>设计模式</strong>是解决常见问题的可复用方案。其中，<strong>代理模式（Proxy Pattern）</strong> 是结构型设计模式的经典代表。它通过引入一个“代理人”对象，控制对目标对象的访问，在不改变原始接口的前提下，增强或拦截行为。</p>
<p>本文将以一个生动的“送花”场景为例，深入讲解 JavaScript 中如何利用<strong>面向接口编程</strong>的思想实现代理模式，并探讨其在现代前端开发中的实际价值。</p>
<hr/>
<h3 data-id="heading-1">一、问题背景：直接送花，可能被拒！</h3>
<p>假设我们有两位女生：</p>
<ul>
<li><strong>小美（xm）</strong>：性格直率，收到花会直接回应。</li>
<li><strong>小红（xh）</strong>：温柔体贴，愿意帮别人传递心意。</li>
</ul>
<p>而男生 <strong>郑志鹏（zzp）</strong> 想给小美送花，但担心被拒绝。于是他灵机一动：<strong>先送给小红，让小红代为转交</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 小美：直接接收</span>
<span class="hljs-keyword">const</span> xm = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小美'</span>,
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到了 <span class="hljs-subst">${sender.name}</span> 的花！`</span>);
    <span class="hljs-keyword">if</span> (sender.<span class="hljs-property">name</span> === <span class="hljs-string">'郑志鹏'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'……但小美拒绝了！'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
};

<span class="hljs-comment">// 郑志鹏</span>
<span class="hljs-keyword">const</span> zzp = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'郑志鹏'</span>,
  <span class="hljs-title function_">sendFlower</span>(<span class="hljs-params">target</span>) {
    target.<span class="hljs-title function_">receiveFlower</span>(<span class="hljs-variable language_">this</span>);
  }
};
</code></pre>
<p>如果 <code>zzp.sendFlower(xm)</code>，结果很可能是被拒。这不符合“高内聚、低耦合”的设计原则——<strong>送花逻辑与接收者的具体行为强耦合</strong>。</p>
<hr/>
<h3 data-id="heading-2">二、面向接口编程：统一行为契约</h3>
<p>在 Java/C# 等语言中，我们会定义一个 <code>FlowerReceiver</code> 接口，要求所有接收者实现 <code>receiveFlower</code> 方法。JavaScript 虽无原生接口，但可通过<strong>约定</strong>实现相同效果：</p>
<blockquote>
<p><strong>只要对象有 <code>receiveFlower(sender)</code> 方法，就视为“花接收者”</strong>。</p>
</blockquote>
<p>这就是<strong>鸭子类型（Duck Typing）</strong>：“如果它走起来像鸭子，叫起来像鸭子，那它就是鸭子。”</p>
<p>于是我们让 <strong>小红（xh）也实现相同的“接口”</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> xh = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小红'</span>,
  <span class="hljs-attr">realTarget</span>: xm, <span class="hljs-comment">// 代理的真实目标</span>
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 作为代理收到了 <span class="hljs-subst">${sender.name}</span> 的花`</span>);
    
    <span class="hljs-comment">// 代理逻辑：先检查送花人</span>
    <span class="hljs-keyword">if</span> (sender.<span class="hljs-property">name</span> === <span class="hljs-string">'郑志鹏'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'小红决定帮忙转交……'</span>);
      <span class="hljs-comment">// 转交给小美</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">realTarget</span>.<span class="hljs-title function_">receiveFlower</span>(sender);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'非郑志鹏，直接转交'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">realTarget</span>.<span class="hljs-title function_">receiveFlower</span>(sender);
    }
  }
};
</code></pre>
<p>现在，<code>xm</code> 和 <code>xh</code> 都实现了相同的“接口”——拥有 <code>receiveFlower</code> 方法。<strong>zzp 无需知道对方是本人还是代理</strong>，只需调用同一方法即可。</p>
<pre><code class="hljs language-js" lang="js">zzp.<span class="hljs-title function_">sendFlower</span>(xh); 
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 小红 作为代理收到了 郑志鹏 的花</span>
<span class="hljs-comment">// 小红决定帮忙转交……</span>
<span class="hljs-comment">// 小美 收到了 郑志鹏 的花！</span>
<span class="hljs-comment">// ……但小美拒绝了！</span>
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：调用方（zzp）只依赖“接口”，不关心具体实现（是本人还是代理）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、代理模式的核心结构</h3>
<p>代理模式包含三个角色：</p>

























<table><thead><tr><th>角色</th><th>说明</th><th>本例对应</th></tr></thead><tbody><tr><td><strong>Subject（抽象主题）</strong></td><td>定义公共接口</td><td><code>receiveFlower</code> 方法约定</td></tr><tr><td><strong>RealSubject（真实主题）</strong></td><td>被代理的真实对象</td><td><code>xm</code>（小美）</td></tr><tr><td><strong>Proxy（代理）</strong></td><td>控制对 RealSubject 的访问</td><td><code>xh</code>（小红）</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[Client: zzp] --&gt;|sendFlower| B[Proxy: xh]
  B --&gt;|receiveFlower| C[RealSubject: xm]
</code></pre>
<p>代理可以在调用前后插入逻辑，例如：</p>
<ul>
<li>权限检查</li>
<li>日志记录</li>
<li>延迟加载</li>
<li>缓存结果</li>
<li>网络请求拦截</li>
</ul>
<hr/>
<h3 data-id="heading-4">四、JavaScript 原生 Proxy：更强大的元编程</h3>
<p>除了手动编写代理对象，ES6 还提供了内置的 <code>Proxy</code> 构造函数，可动态拦截对象操作：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> xm = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小美'</span>,
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到了花`</span>);
    <span class="hljs-keyword">return</span> sender.<span class="hljs-property">name</span> !== <span class="hljs-string">'郑志鹏'</span>;
  }
};

<span class="hljs-comment">// 创建代理</span>
<span class="hljs-keyword">const</span> xhProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(xm, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {
    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'receiveFlower'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">sender</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'【代理拦截】小红正在处理送花请求...'</span>);
        <span class="hljs-keyword">if</span> (sender.<span class="hljs-property">name</span> === <span class="hljs-string">'郑志鹏'</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'检测到郑志鹏！启动情感缓冲策略...'</span>);
          <span class="hljs-comment">// 可以修改行为，比如假装接受</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'小红：花我收下了，谢谢你的心意 ❤️'</span>);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 返回成功，避免伤害</span>
        }
        <span class="hljs-comment">// 否则正常转发</span>
        <span class="hljs-keyword">return</span> target[prop].<span class="hljs-title function_">call</span>(target, sender);
      };
    }
    <span class="hljs-keyword">return</span> target[prop];
  }
});

zzp.<span class="hljs-title function_">sendFlower</span>(xhProxy);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 【代理拦截】小红正在处理送花请求...</span>
<span class="hljs-comment">// 检测到郑志鹏！启动情感缓冲策略...</span>
<span class="hljs-comment">// 小红：花我收下了，谢谢你的心意 ❤️</span>
</code></pre>
<blockquote>
<p>💡 <code>Proxy</code> 允许拦截 <code>get</code>、<code>set</code>、<code>apply</code> 等 13 种操作，是 Vue 3 响应式系统的核心。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">五、代理模式的典型应用场景</h3>
<h4 data-id="heading-6">1. <strong>虚拟代理（Virtual Proxy）</strong></h4>
<p>延迟初始化昂贵资源：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> imageProxy = {
  <span class="hljs-attr">src</span>: <span class="hljs-string">'large-image.jpg'</span>,
  <span class="hljs-title function_">loadImage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>(); <span class="hljs-comment">// 实际加载</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span>.<span class="hljs-property">src</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">src</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span>;
  }
};
</code></pre>
<h4 data-id="heading-7">2. <strong>保护代理（Protection Proxy）</strong></h4>
<p>控制访问权限：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> userProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(realUser, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
    <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'salary'</span> &amp;&amp; currentUser.<span class="hljs-property">role</span> !== <span class="hljs-string">'admin'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'无权访问薪资信息'</span>);
    }
    <span class="hljs-keyword">return</span> target[key];
  }
});
</code></pre>
<h4 data-id="heading-8">3. <strong>缓存代理（Caching Proxy）</strong></h4>
<p>避免重复计算：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> apiProxy = {
  <span class="hljs-attr">cache</span>: {},
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[id]) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[id];
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/data/<span class="hljs-subst">${id}</span>`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[id] = data;
    <span class="hljs-keyword">return</span> data;
  }
};
</code></pre>
<hr/>
<h3 data-id="heading-9">六、为什么代理模式在 JS 中如此重要？</h3>
<ol>
<li>
<p><strong>无类继承，靠组合与代理</strong><br/>
JS 没有接口关键字，但通过“鸭子类型 + 代理”，轻松实现多态。</p>
</li>
<li>
<p><strong>函数是一等公民</strong><br/>
方法可被替换、包装、拦截，天然支持代理行为。</p>
</li>
<li>
<p><strong>响应式框架的基石</strong><br/>
Vue、MobX 等均使用 <code>Proxy</code> 或 <code>Object.defineProperty</code> 实现数据监听。</p>
</li>
<li>
<p><strong>AOP（面向切面编程）的简易实现</strong><br/>
日志、性能监控、错误捕获等横切关注点，可通过代理统一处理。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">结语：代理，让代码更聪明</h3>
<p>回到送花的故事：<strong>小红作为代理，不仅传递了花，更传递了善意</strong>。在代码世界中，代理模式同样扮演着“智能中介”的角色——它解耦调用者与被调用者，赋予系统灵活性、安全性和可扩展性。</p>
<blockquote>
<p><strong>记住</strong>：</p>
<ul>
<li>代理模式的核心是 <strong>“相同的接口，不同的实现”</strong>；</li>
<li>JavaScript 的动态特性使其成为实现代理的理想语言；</li>
<li>无论是手动代理还是 <code>Proxy</code>，本质都是 <strong>控制访问 + 增强行为</strong>。</li>
</ul>
</blockquote>
<p>下次当你需要“在不修改原对象的前提下增加功能”时，不妨想想：<strong>是否该请一位“小红”来帮忙？</strong></p>
<hr/>
<p><strong>延伸思考</strong>：</p>
<ul>
<li>如何用代理模式实现前端 API 请求的统一 loading 和 error 处理？</li>
<li>Vue 3 的 <code>reactive()</code> 是如何利用 <code>Proxy</code> 实现响应式的？</li>
</ul>
<p>掌握代理模式，你离写出优雅、健壮的 JavaScript 代码又近了一步 🌸</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>