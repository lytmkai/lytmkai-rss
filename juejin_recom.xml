<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Requests库入门指南]]></title>    <link>https://juejin.cn/post/7603282168137842707</link>    <guid>https://juejin.cn/post/7603282168137842707</guid>    <pubDate>2026-02-06T05:15:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603282168137842707" data-draft-id="7603352061505650694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Requests库入门指南"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-02-06T05:15:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小张说故事"/> <meta itemprop="url" content="https://juejin.cn/user/741501567509111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Requests库入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/741501567509111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小张说故事
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:15:00.000Z" title="Fri Feb 06 2026 05:15:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 库的概览与核心价值</h2>
<p>想象一下,在网络世界中,如果你想与各种网站和服务进行通信,就像是用传统的信件往来。你需要手动打包数据、编写地址、处理回复编码,这些繁琐的细节会让简单的任务变得复杂。<code>requests</code>库正是为解决这些问题而生的工具。</p>
<p>Requests是Python中最流行的HTTP客户端库,它的设计哲学是"为人类设计"。它将复杂的HTTP协议细节封装在简洁的API之下,让开发者能够用最少的代码完成网络请求。与Python标准库中的<code>urllib</code>相比,Requests的使用体验提升了90%以上——你不再需要手动处理URL编码、表单数据序列化、连接池管理等底层细节。</p>
<p>Requests在Python生态系统中占据着不可或缺的地位。据PyPI官方统计,它的下载量每月超过10亿次,超过50万个开源项目依赖它。无论是调用REST API、构建网络爬虫、自动化测试,还是开发微服务客户端,Requests都是首选工具。它支持HTTP/1.1的所有特性,包括连接池管理、Cookie持久化、SSL验证、自动内容解码等,让HTTP请求变得前所未有的简单。</p>
<h2 data-id="heading-1">2. 环境搭建与"Hello, World"</h2>
<h3 data-id="heading-2">安装说明</h3>
<p>Requests不是Python标准库的一部分,需要通过包管理器安装:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用pip安装(推荐)</span>
pip install requests

<span class="hljs-comment"># 使用conda安装</span>
conda install requests

<span class="hljs-comment"># 使用Python模块方式安装</span>
python -m pip install requests
</code></pre>
<p>Requests官方支持Python 3.9+版本,同时也兼容PyPy解释器。如果在安装过程中遇到权限问题,可以尝试使用<code>--user</code>参数或创建虚拟环境。</p>
<h3 data-id="heading-3">最简示例</h3>
<p>以下是一个简单的"Hello, World"示例,展示如何发送GET请求并获取响应:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

<span class="hljs-comment"># 发送GET请求到GitHub API</span>
response = requests.get(<span class="hljs-string">'https://api.github.com/events'</span>)

<span class="hljs-comment"># 打印响应状态码</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"状态码: <span class="hljs-subst">{response.status_code}</span>"</span>)

<span class="hljs-comment"># 打印响应内容的前100个字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"响应内容: <span class="hljs-subst">{response.text[:<span class="hljs-number">100</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-4">逐行解释</h3>
<ol>
<li><code>import requests</code> - 导入Requests库,使其功能在当前脚本中可用。</li>
<li><code>response = requests.get('https://api.github.com/events')</code> - 调用<code>get()</code>方法向GitHub API发送GET请求,返回的<code>Response</code>对象包含了服务器的全部响应信息。</li>
<li><code>print(f"状态码: {response.status_code}")</code> - 访问<code>Response</code>对象的<code>status_code</code>属性,获取HTTP状态码(200表示成功)。</li>
<li><code>print(f"响应内容: {response.text[:100]}")</code> - 通过<code>text</code>属性获取响应的文本内容,并切片显示前100个字符。</li>
</ol>
<h3 data-id="heading-5">运行结果</h3>
<p>程序运行后会输出类似以下内容:</p>
<pre><code class="hljs language-json" lang="json">状态码<span class="hljs-punctuation">:</span> <span class="hljs-number">200</span>
响应内容<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"25698765432"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"PushEvent"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"actor"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">12345678</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"login"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"userna
</span></code></pre>
<p>这个简单的例子展示了Requests的核心优势:用三行代码就完成了一次完整的HTTP请求,自动处理了连接建立、数据传输、响应解码等所有细节。</p>
<h2 data-id="heading-6">3. 核心概念解析</h2>
<p>Requests库围绕几个核心概念构建,理解这些概念有助于你更灵活地使用它。</p>
<h3 data-id="heading-7">3.1 请求方法(Request Methods)</h3>
<p>HTTP协议定义了多种请求方法,Requests为每种方法都提供了对应的函数:</p>
<ul>
<li><code>requests.get()</code> - 获取资源</li>
<li><code>requests.post()</code> - 提交数据</li>
<li><code>requests.put()</code> - 更新资源(完整替换)</li>
<li><code>requests.patch()</code> - 更新资源(部分修改)</li>
<li><code>requests.delete()</code> - 删除资源</li>
<li><code>requests.head()</code> - 获取响应头</li>
<li><code>requests.options()</code> - 获取服务器支持的方法</li>
</ul>
<h3 data-id="heading-8">3.2 响应对象(Response Object)</h3>
<p>每次请求后,Requests都会返回一个<code>Response</code>对象,它包含了服务器的完整响应信息:</p>
<ul>
<li><code>response.status_code</code> - HTTP状态码</li>
<li><code>response.text</code> - 响应的文本内容(自动解码)</li>
<li><code>response.content</code> - 响应的字节内容(原始二进制)</li>
<li><code>response.json()</code> - 将JSON响应解析为Python字典</li>
<li><code>response.headers</code> - 响应头信息(字典形式)</li>
<li><code>response.cookies</code> - 服务器设置的Cookie</li>
</ul>
<h3 data-id="heading-9">3.3 会话对象(Session Object)</h3>
<p><code>Session</code>对象允许你在多个请求之间保持某些参数(如Cookies、认证信息),并复用TCP连接,显著提高性能:</p>
<pre><code class="hljs language-python" lang="python">session = requests.Session()
session.headers.update({<span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'My App'</span>})

<span class="hljs-comment"># 第一个请求会保存Cookies</span>
response1 = session.get(<span class="hljs-string">'https://httpbin.org/cookies/set/sessionid/123'</span>)

<span class="hljs-comment"># 第二个请求会自动携带之前保存的Cookies</span>
response2 = session.get(<span class="hljs-string">'https://httpbin.org/cookies'</span>)
</code></pre>
<h3 data-id="heading-10">概念关系图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[requests库] --&gt; B[请求方法]
    A --&gt; C[响应对象]
    A --&gt; D[会话对象]
    
    B --&gt; B1[get/post/put/delete等]
    B --&gt; B2[参数传递: params/data/json]
    
    C --&gt; C1[status_code - 状态码]
    C --&gt; C2[text/content/json - 响应内容]
    C --&gt; C3[headers/cookies - 元信息]
    
    D --&gt; D1[保持Cookie和认证信息]
    D --&gt; D2[复用TCP连接]
    D --&gt; D3[提高请求性能]
    
    B1 --&gt; C
    B2 --&gt; C
    D --&gt; B
</code></pre>
<p>这个图表展示了Requests库的核心概念及其关系:请求方法用于发送请求,响应对象用于接收和处理服务器的回应,而会话对象则在多个请求之间提供状态保持和连接复用。</p>
<h2 data-id="heading-11">4. 实战演练:解决一个典型问题</h2>
<h3 data-id="heading-12">需求分析</h3>
<p>假设我们需要开发一个天气查询应用,能够获取指定城市的当前天气信息。我们将使用免费的天气API,通过发送HTTP请求来获取数据,并解析返回的JSON响应。</p>
<h3 data-id="heading-13">方案设计</h3>
<p>这个项目将展示Requests库的几个核心功能:</p>
<ol>
<li>使用<code>requests.get()</code>发送带参数的GET请求</li>
<li>通过<code>params</code>参数传递查询参数(城市名称)</li>
<li>使用<code>response.json()</code>解析JSON响应</li>
<li>实现错误处理和异常捕获</li>
<li>展示响应数据的提取和格式化</li>
</ol>
<h3 data-id="heading-14">代码实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> requests.exceptions <span class="hljs-keyword">import</span> RequestException

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city</span>):
    <span class="hljs-string">"""
    获取指定城市的天气信息
    
    Args:
        city (str): 城市名称,例如"Beijing"或"Shanghai"
    
    Returns:
        dict: 包含天气信息的字典,失败时返回None
    """</span>
    <span class="hljs-comment"># 使用免费的天气API(示例使用httpbin.org模拟)</span>
    base_url = <span class="hljs-string">"https://httpbin.org/get"</span>
    params = {
        <span class="hljs-string">'city'</span>: city,
        <span class="hljs-string">'units'</span>: <span class="hljs-string">'metric'</span>
    }
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送GET请求,设置超时时间为5秒</span>
        response = requests.get(base_url, params=params, timeout=<span class="hljs-number">5</span>)
        
        <span class="hljs-comment"># 检查响应状态码,如果不是2xx则抛出异常</span>
        response.raise_for_status()
        
        <span class="hljs-comment"># 解析JSON响应</span>
        data = response.json()
        
        <span class="hljs-comment"># 提取天气信息(这里模拟真实API的数据结构)</span>
        weather_info = {
            <span class="hljs-string">'city'</span>: data.get(<span class="hljs-string">'args'</span>, {}).get(<span class="hljs-string">'city'</span>, city),
            <span class="hljs-string">'temperature'</span>: <span class="hljs-number">25</span>,  <span class="hljs-comment"># 模拟数据</span>
            <span class="hljs-string">'condition'</span>: <span class="hljs-string">'晴朗'</span>,
            <span class="hljs-string">'humidity'</span>: <span class="hljs-number">45</span>,
            <span class="hljs-string">'wind_speed'</span>: <span class="hljs-number">3.2</span>
        }
        
        <span class="hljs-keyword">return</span> weather_info
        
    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: 请求超时,无法获取<span class="hljs-subst">{city}</span>的天气信息"</span>)
    <span class="hljs-keyword">except</span> requests.exceptions.HTTPError <span class="hljs-keyword">as</span> err:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"HTTP错误: <span class="hljs-subst">{err.response.status_code}</span>"</span>)
    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> err:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求出错: <span class="hljs-subst">{err}</span>"</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数:获取并显示多个城市的天气"""</span>
    cities = [<span class="hljs-string">'Beijing'</span>, <span class="hljs-string">'Shanghai'</span>, <span class="hljs-string">'Guangzhou'</span>]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 天气查询系统 ===\n"</span>)
    
    <span class="hljs-keyword">for</span> city <span class="hljs-keyword">in</span> cities:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在查询 <span class="hljs-subst">{city}</span> 的天气..."</span>)
        weather = get_weather(city)
        
        <span class="hljs-keyword">if</span> weather:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{weather[<span class="hljs-string">'city'</span>]}</span> 天气信息:"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  温度: <span class="hljs-subst">{weather[<span class="hljs-string">'temperature'</span>]}</span>°C"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  天气: <span class="hljs-subst">{weather[<span class="hljs-string">'condition'</span>]}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  湿度: <span class="hljs-subst">{weather[<span class="hljs-string">'humidity'</span>]}</span>%"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  风速: <span class="hljs-subst">{weather[<span class="hljs-string">'wind_speed'</span>]}</span> m/s"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()
</code></pre>
<h3 data-id="heading-15">运行说明</h3>
<ol>
<li>确保已安装Requests库: <code>pip install requests</code></li>
<li>将代码保存为<code>weather_app.py</code></li>
<li>运行程序: <code>python weather_app.py</code></li>
</ol>
<p>程序会依次查询三个城市的天气信息,并格式化输出结果。虽然示例使用了httpbin.org模拟数据,但代码结构可以直接适配真实的天气API(如OpenWeatherMap、和风天气等),只需修改<code>base_url</code>和数据提取逻辑即可。</p>
<h3 data-id="heading-16">关键点解析</h3>
<ul>
<li><strong>参数传递</strong>: 使用<code>params</code>字典传递查询参数,Requests会自动进行URL编码</li>
<li><strong>超时设置</strong>: <code>timeout=5</code>参数防止请求无限期等待</li>
<li><strong>错误处理</strong>: 使用<code>raise_for_status()</code>自动检查状态码,并捕获各类异常</li>
<li><strong>JSON解析</strong>: <code>response.json()</code>将JSON响应直接转换为Python字典</li>
<li><strong>模块化设计</strong>: 将核心功能封装为函数,便于复用和测试</li>
</ul>
<h2 data-id="heading-17">5. 最佳实践与常见陷阱</h2>
<h3 data-id="heading-18">常见错误及规避方法</h3>
<h4 data-id="heading-19">错误1:不检查状态码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>)
data = response.json()  <span class="hljs-comment"># 如果状态码不是200,这里可能抛出异常</span>

<span class="hljs-comment"># ✅ 正确做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>)
response.raise_for_status()  <span class="hljs-comment"># 检查状态码,非2xx时抛出HTTPError</span>
data = response.json()
</code></pre>
<h4 data-id="heading-20">错误2:不设置超时时间</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>)
<span class="hljs-comment"># 如果网络故障或服务器无响应,程序会无限期等待</span>

<span class="hljs-comment"># ✅ 正确做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>, timeout=<span class="hljs-number">10</span>)
<span class="hljs-comment"># 10秒后超时,抛出Timeout异常</span>
</code></pre>
<h4 data-id="heading-21">错误3:在循环中重复创建会话</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
<span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list:
    response = requests.get(url)  <span class="hljs-comment"># 每次都建立新连接,效率低下</span>

<span class="hljs-comment"># ✅ 正确做法</span>
<span class="hljs-keyword">with</span> requests.Session() <span class="hljs-keyword">as</span> session:
    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list:
        response = session.get(url)  <span class="hljs-comment"># 复用连接,性能更高</span>
</code></pre>
<h3 data-id="heading-22">最佳实践建议</h3>
<ol>
<li>
<p><strong>始终使用会话(Session)</strong>: 对于向同一域名发送多个请求的场景,使用Session可以复用TCP连接,减少握手开销,提高性能。</p>
</li>
<li>
<p><strong>合理设置超时</strong>: 建议为所有请求设置超时参数,可以使用元组分别设置连接超时和读取超时,例如<code>timeout=(3, 10)</code>。</p>
</li>
<li>
<p><strong>处理JSON解析异常</strong>: 并非所有API响应都是有效的JSON,使用<code>response.json()</code>时应该捕获<code>JSONDecodeError</code>:</p>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-keyword">try</span>:
    data = response.json()
<span class="hljs-keyword">except</span> json.JSONDecodeError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"响应不是有效的JSON格式"</span>)
    data = <span class="hljs-literal">None</span>
</code></pre>
<ol start="4">
<li><strong>使用User-Agent标识</strong>: 某些网站会检查请求头中的User-Agent,建议设置一个合理的标识:</li>
</ol>
<pre><code class="hljs language-python" lang="python">headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'MyWeatherApp/1.0 (https://myapp.com)'</span>
}
response = requests.get(url, headers=headers)
</code></pre>
<ol start="5">
<li><strong>HTTPS证书验证</strong>: 生产环境中应该验证SSL证书,仅在测试环境或特定场景下禁用:</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生产环境:验证证书(默认行为)</span>
response = requests.get(<span class="hljs-string">'https://example.com'</span>)

<span class="hljs-comment"># 测试环境:禁用证书验证</span>
response = requests.get(<span class="hljs-string">'https://example.com'</span>, verify=<span class="hljs-literal">False</span>)
</code></pre>
<ol start="6">
<li><strong>使用环境变量管理敏感信息</strong>: API密钥、令牌等敏感信息应该存储在环境变量中,而不是硬编码在代码里:</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os

api_key = os.environ.get(<span class="hljs-string">'MY_API_KEY'</span>)
headers = {<span class="hljs-string">'Authorization'</span>: <span class="hljs-string">f'Bearer <span class="hljs-subst">{api_key}</span>'</span>}
</code></pre>
<h3 data-id="heading-23">注意事项</h3>
<ul>
<li>Requests默认使用连接池,会自动处理Keep-Alive,无需手动管理连接</li>
<li>下载大文件时,使用<code>stream=True</code>参数逐步读取,避免内存溢出</li>
<li>处理重定向时,可以通过<code>allow_redirects=False</code>禁用自动重定向</li>
<li>对于需要认证的API,优先使用Session对象的<code>auth</code>参数或<code>headers</code>参数,而不是在每个请求中重复设置</li>
</ul>
<h2 data-id="heading-24">6. 进阶指引</h2>
<h3 data-id="heading-25">高级功能</h3>
<p>Requests提供了许多高级功能,可以应对复杂的HTTP交互场景:</p>
<ul>
<li><strong>认证处理</strong>: 支持Basic认证、Digest认证、OAuth等多种认证方式</li>
<li><strong>代理配置</strong>: 通过<code>proxies</code>参数配置HTTP/SOCKS代理</li>
<li><strong>流式上传/下载</strong>: 处理大文件传输时避免内存问题</li>
<li><strong>事件钩子</strong>: 在请求的不同阶段注册回调函数</li>
<li><strong>自定义适配器</strong>: 实现自定义的传输协议或连接逻辑</li>
</ul>
<h3 data-id="heading-26">生态扩展</h3>
<p>Requests的生态丰富,有许多扩展库可以增强其功能:</p>
<ul>
<li><code>requests-oauthlib</code>: OAuth认证支持</li>
<li><code>requests-cache</code>: 响应缓存,减少重复请求</li>
<li><code>requests-toolbelt</code>: 实用工具集合,如Multipart上传、流式请求等</li>
<li><code>grequests</code>: 基于gevent的异步请求</li>
<li><code>requests-threads</code>: 多线程请求支持</li>
</ul>
<h3 data-id="heading-27">学习路径</h3>
<p>如果你想深入学习Requests,建议按以下路径进行:</p>
<ol>
<li><strong>掌握基础API</strong>: 熟悉所有请求方法和Response对象的属性</li>
<li><strong>理解HTTP协议</strong>: 学习HTTP/1.1规范,理解状态码、请求头、响应头的含义</li>
<li><strong>探索高级特性</strong>: 研究Session对象、连接池、SSL验证等高级功能</li>
<li><strong>阅读源代码</strong>: Requests的代码结构清晰,阅读源码有助于理解其实现原理</li>
<li><strong>实践项目</strong>: 开发一个完整的爬虫或API客户端项目</li>
</ol>
<h3 data-id="heading-28">学习资源</h3>
<ul>
<li><strong>官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.python-requests.org" target="_blank" title="https://docs.python-requests.org" ref="nofollow noopener noreferrer">docs.python-requests.org</a> (最权威、最完整的资源)</li>
<li><strong>GitHub仓库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpsf%2Frequests" target="_blank" title="https://github.com/psf/requests" ref="nofollow noopener noreferrer">github.com/psf/request…</a> (源码、Issue、讨论)</li>
<li><strong>Stack Overflow</strong>: 搜索标签[python-requests]找到常见问题的解答</li>
<li><strong>社区博客</strong>: 许多开发者分享了Requests的实战经验和技巧</li>
</ul>
<p>Requests库的设计理念是"简单即美",但它的背后是HTTP协议的复杂性和网络编程的挑战。掌握了Requests,你就掌握了与网络世界沟通的基本技能。继续探索,你会发现HTTP请求的世界远比你想象的更加丰富和有趣。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch：ES|QL 支持 dense vector 搜索]]></title>    <link>https://juejin.cn/post/7603252259561783332</link>    <guid>https://juejin.cn/post/7603252259561783332</guid>    <pubDate>2026-02-06T03:37:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603252259561783332" data-draft-id="7603282168137498643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch：ES|QL 支持 dense vector 搜索"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-02-06T03:37:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch：ES|QL 支持 dense vector 搜索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:37:36.000Z" title="Fri Feb 06 2026 03:37:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fcarlos-delgado" title="https://www.elastic.co/search-labs/author/carlos-delgado" target="_blank" ref="nofollow noopener noreferrer">Carlos Delgado</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/973046f2739744829b510c37e824b6d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953856&amp;x-signature=LffbOsVLWQflbKxWV6Nyp4%2F2NZA%3D" alt="" loading="lazy"/></p>
<p>在 ES|QL 中对你的 dense_vector 数据进行向量搜索。</p>
<p>更多阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152597172" title="https://elasticstack.blog.csdn.net/article/details/152597172" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch：使用推理端点及语义搜索演示</a></p>
<p>动手体验 Elasticsearch：查看我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">sample notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费的 cloud trial</a>，或者在<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>你现在可以使用 Elasticsearch Query Language (<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fesql" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/esql" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a>) 进行 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fintroduction-to-vector-search" title="https://www.elastic.co/search-labs/blog/introduction-to-vector-search" target="_blank" ref="nofollow noopener noreferrer">vector 搜索</a>！ES|QL 可以检索、过滤并评分 dense_vector 字段。使用 k-nearest neighbors (KNN) 查询进行快速、近似的最近邻搜索，适合大规模数据。使用 vector similarity 函数进行精确搜索和自定义评分。</p>
<p>在 ES|QL 中使用 KNN 比在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fquerydsl" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/querydsl" target="_blank" ref="nofollow noopener noreferrer">Query DSL</a> 中更简单。prefilters 和每个 shard 要检索的结果数量会从 ES|QL 查询自动推断。</p>
<h2 data-id="heading-0">什么是 vector 搜索？</h2>
<p>现代搜索不再仅限于精确的 keyword 匹配。用户希望系统能理解含义，而不仅仅是文本。这就是向量 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134748014" title="https://elasticstack.blog.csdn.net/article/details/134748014" target="_blank" ref="nofollow noopener noreferrer">embeddings</a> 和 Elasticsearch 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fdense-vector" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/dense-vector" target="_blank" ref="nofollow noopener noreferrer">dense_vector</a> 字段类型的用武之地。</p>
<p>在 Elasticsearch 中使用 vector 搜索最简单的方法是使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fsemantic-text" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/semantic-text" target="_blank" ref="nofollow noopener noreferrer">semantic_text 字段类型</a>。它允许你自动生成 text embeddings、执行语义搜索，并处理 chunking。然而，当以下情况出现时，你可能想使用 dense_vector：</p>
<ul>
<li>你已经在使用 dense_vector 字段。</li>
<li>你使用的是非文本数据，比如 images、sound 或 video。</li>
<li>你需要在向 Elasticsearch ingestion 之前单独生成 embeddings。</li>
<li>你需要执行自定义或高级评分。</li>
<li>你希望进行精确的 nearest neighbors 搜索。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fdense-vector" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/dense-vector" target="_blank" ref="nofollow noopener noreferrer">dense_vector</a> 存储由 machine learning models 生成的数值 embeddings。这些 embeddings 捕捉语义相似性：含义相近的文档在高维空间中向量彼此接近。</p>
<p>使用 vectors，你可以构建：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fsemantic-search" title="https://www.elastic.co/docs/solutions/search/semantic-search" target="_blank" ref="nofollow noopener noreferrer">语义文本搜索</a>，用于查找与某个问题相关的文档。</p>
</li>
<li>
<p>Retrieval-augmented generation (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134396254" title="https://elasticstack.blog.csdn.net/article/details/134396254" target="_blank" ref="nofollow noopener noreferrer">RAG</a>)。</p>
</li>
<li>
<p>推荐系统。</p>
</li>
</ul>
<p>ES|QL 为 Elasticsearch 带来了 query-piped 体验的强大功能。对 dense_vector 字段的一流支持意味着你现在可以在 ES|QL 中直接使用 vectors 检索、过滤、评分和搜索，同时处理文本和非文本数据。</p>
<p>本文将演示如何在 ES|QL 中使用 dense_vector 字段，从基本检索到近似和精确相似度搜索，以及如何将 vector 搜索作为 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145697606" title="https://elasticstack.blog.csdn.net/article/details/145697606" target="_blank" ref="nofollow noopener noreferrer">hybrid search</a> 策略的一部分。</p>
<h2 data-id="heading-1">基础：检索 vector 数据</h2>
<p>假设你有一个 mapping 类似于：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  {
2.    <span class="hljs-string">"mappings"</span>: {
3.      <span class="hljs-string">"properties"</span>: {
4.        <span class="hljs-string">"title"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span> },
5.        <span class="hljs-string">"category"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
6.        <span class="hljs-string">"content_vector"</span>: {
7.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"dense_vector"</span>,
8.          <span class="hljs-string">"dims"</span>: 384,
9.          <span class="hljs-string">"similarity"</span>: <span class="hljs-string">"cosine"</span>
10.        }
11.      }
12.    }
13.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>你可以像检索其他列一样检索 vector 字段：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents
<span class="hljs-bullet">2.</span>  | KEEP title, content<span class="hljs-emphasis">_vector
3.  | LIMIT 5

`AI写代码
</span></code></pre>
<p>请记住，vectors 可能很大。用于探索和调试时，检索 vector 数据可能有用，但在生产环境中，除非确实必要，否则应避免返回完整的 vector 数据。</p>
<p>你可以使用熟悉的 ES|QL 构造来检查有多少行包含 vector 信息：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> content_vector <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> STATS non_null <span class="hljs-operator">=</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)

`AI写代码
</code></pre>
<h2 data-id="heading-2">近似搜索使用 KNN</h2>
<p>Vector search 意味着找到与给定 query vector 最相似的 vectors。</p>
<p>对于大型数据集，最常见的方法是近似最近邻（<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F138368674" title="https://elasticstack.blog.csdn.net/article/details/138368674" target="_blank" ref="nofollow noopener noreferrer">approximate nearest neighbor</a> - ANN）搜索。ANN 通过使用允许快速计算相似 vectors 的数据结构来寻找最相似的 vectors，但不能保证考虑到所有 vectors。</p>
<p>ES|QL 通过 KNN 函数提供近似搜索：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents MEDATADATA <span class="hljs-emphasis">_score
2.  | WHERE KNN(content_</span>vector, [0.12, -0.03, 0.98, ...])
<span class="hljs-bullet">3.</span>  | SORT <span class="hljs-emphasis">_score DESC
4.  | KEEP title, _</span>score
<span class="hljs-bullet">5.</span>  | LIMIT 10

`AI写代码
</code></pre>
<p>这个简单示例：</p>
<ul>
<li>在 content_vector 字段上搜索。</li>
<li>使用密集向量查询 [0.12, -0.03, 0.98, ...] 来搜索与其相似的向量。</li>
<li>按分数排序，使用 <code>KNN</code> 函数填充的 METADATA _score 属性。</li>
<li>仅保留 title 和 score，因为 content_vector 字段不需要返回，这样可以避免加载它的内容。</li>
<li>使用 LIMIT 检索前 10 个元素，这会自动将 KNN 函数的 k 设置为 10。</li>
</ul>
<p>KNN 函数可以通过以下选项进一步自定义：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents MEDATADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, [<span class="hljs-number">0.12</span>, <span class="hljs-number">-0.03</span>, <span class="hljs-number">0.98</span>, ...], {"k": <span class="hljs-number">20</span>, "min_candidates": <span class="hljs-number">100</span>, "rescore_oversample": <span class="hljs-number">4.0</span>})
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> KEEP title, _score
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>

`AI写代码
</code></pre>
<p>查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-knn" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-knn" target="_blank" ref="nofollow noopener noreferrer">KNN 函数</a>的命名参数，可以获得可用参数的完整说明。</p>
<h3 data-id="heading-3">将 KNN 与过滤器结合使用</h3>
<p>你可以缩小向量搜索的候选集合：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span><span class="hljs-operator">=</span> "tutorial"
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, [<span class="hljs-number">0.12</span>, <span class="hljs-number">-0.03</span>, <span class="hljs-number">0.98</span>, ...])
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> KEEP title, category, _score

`AI写代码
</code></pre>
<p>当然，你可以使用任何其他 WHERE 子句来过滤结果，或者将 KNN 作为过滤表达式的一部分：</p>
<pre><code class="hljs language-scss" lang="scss">`

<span class="hljs-number">1</span>.  FROM documents METADATA _score
<span class="hljs-number">2</span>.  | WHERE published_date &gt; <span class="hljs-built_in">NOW</span>() - <span class="hljs-number">1</span> hour AND <span class="hljs-built_in">LENGTH</span>(category) &gt; <span class="hljs-number">10</span> AND <span class="hljs-built_in">KNN</span>(content_vector, [<span class="hljs-number">0.12</span>, -<span class="hljs-number">0.03</span>, <span class="hljs-number">0.98</span>, ...])

`AI写代码
</code></pre>
<h3 data-id="heading-4">KNN 使用简单</h3>
<p>在 ES|QL 中使用 KNN 更简单。你不需要显式地为查询指定 prefilters 或 k。</p>
<p>Prefilters 用于确保 KNN 查询返回预期数量的结果。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fquery-dsl%2Fquery-dsl-knn-query%23knn-query-filtering" title="https://www.elastic.co/docs/reference/query-languages/query-dsl/query-dsl-knn-query#knn-query-filtering" target="_blank" ref="nofollow noopener noreferrer">Prefilters</a> 会直接应用于 KNN 搜索，而不是在查询之后应用。</p>
<p>请记住，KNN 会返回请求的 top k 结果。如果在 KNN 查询之后应用过滤器，查询返回的一些结果可能会被过滤掉。如果发生这种情况，我们将检索到的结果数量少于预期。</p>
<p>Query DSL 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fquery-dsl%2Fquery-dsl-knn-query" title="https://www.elastic.co/docs/reference/query-languages/query-dsl/query-dsl-knn-query" target="_blank" ref="nofollow noopener noreferrer">knn 查询</a>包含一个用于指定 prefilters 的部分：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  POST my-image-index/_search
2.  {
3.    <span class="hljs-string">"query"</span> : {
4.      <span class="hljs-string">"knn"</span>: {
5.        <span class="hljs-string">"field"</span>: <span class="hljs-string">"content_vector"</span>,
6.        <span class="hljs-string">"query_vector"</span>: [0.12, -0.03, 0.98, ...],
7.        <span class="hljs-string">"filter"</span> : {
8.          <span class="hljs-string">"term"</span> : { <span class="hljs-string">"category"</span> : <span class="hljs-string">"tutorial"</span> }
9.        }
10.      }
11.    }
12.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>在 ES|QL 中使用 KNN 时，你不需要关心 prefilters。所有过滤器都会作为 KNN 函数的 prefilters 应用，所以不需要将它们作为特定选项或命令指定；只需使用 <code>WHERE</code>，让 ES|QL 自动处理即可！</p>
<p>KNN 还允许指定每个 shard 检索的结果数量，也就是 k 参数。类似于 Query DSL，k 默认等于查询中指定的 LIMIT。</p>
<h2 data-id="heading-5">精确搜索使用 vector similarity 函数</h2>
<p>KNN 的设计目标是快速，这使它非常适合大规模数据集（数十万到数百万个向量）和对延迟敏感的应用。代价是结果是近似的，但通常非常准确。</p>
<p>有时你希望进行精确相似度计算，而不是近似搜索，例如：</p>
<ul>
<li>当你的数据集较小时。</li>
<li>当查询中使用的过滤器非常严格，只选择数据集的小子集时。</li>
</ul>
<p>ES|QL 提供了以下 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions" target="_blank" ref="nofollow noopener noreferrer">vector similarity 函数</a>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_cosine" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_cosine" target="_blank" ref="nofollow noopener noreferrer">V_COSINE</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_dot_product" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_dot_product" target="_blank" ref="nofollow noopener noreferrer">V_DOT_PRODUCT</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_hamming" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_hamming" target="_blank" ref="nofollow noopener noreferrer">V_HAMMING</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_l1_norm" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_l1_norm" target="_blank" ref="nofollow noopener noreferrer">V_L1_NORM</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_l2_norm" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_l2_norm" target="_blank" ref="nofollow noopener noreferrer">V_L2_NORM</a></li>
</ul>
<p>使用这些函数，你可以计算查询向量与查询检索到的所有向量的相似度。</p>
<p>下面的查询使用与上面 KNN 示例相同的 mapping，但使用余弦相似度进行精确搜索：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents
<span class="hljs-bullet">2.</span>  | EVAL similarity = V<span class="hljs-emphasis">_COSINE(content_</span>vector, [0.12, -0.03, 0.98, ...])
<span class="hljs-bullet">3.</span>  | SORT similarity DESC
<span class="hljs-bullet">4.</span>  | KEEP title, similarity
<span class="hljs-bullet">5.</span>  | LIMIT 10

`AI写代码
</code></pre>
<p>这个查询：</p>
<ul>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_cosine" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_cosine" target="_blank" ref="nofollow noopener noreferrer">V_COSINE</a> 向量相似度函数计算相似度。</li>
<li>根据计算出的相似度进行排序。</li>
<li>保留前 10 个最相似的结果。</li>
</ul>
<h2 data-id="heading-6">语义搜索</h2>
<p>进行语义搜索时，你会尝试将文本查询与向量匹配。当然，你可以先计算 embeddings 来获取查询向量，然后将查询向量直接提供给向量搜索。</p>
<p>但更简单的方法是让 Elasticsearch 使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-text_embedding" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-text_embedding" target="_blank" ref="nofollow noopener noreferrer">TEXT_EMBEDDING</a> 函数为你计算 embeddings：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, TEXT_EMBEDDING("my semantic query", inference_id)
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> KEEP title, _score

`AI写代码
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-text_embedding" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-text_embedding" target="_blank" ref="nofollow noopener noreferrer">TEXT_EMBEDDING</a> 使用已经存在的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fsemantic-search%2Fsemantic-search-inference" title="https://www.elastic.co/docs/solutions/search/semantic-search/semantic-search-inference" target="_blank" ref="nofollow noopener noreferrer">inference endpoint</a> 自动计算 embeddings 并在你的查询中使用它们。</p>
<h2 data-id="heading-7">混合搜索</h2>
<p>大多数搜索不仅依赖 vector 数据；它们还需要结合 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134111585" title="https://elasticstack.blog.csdn.net/article/details/134111585" target="_blank" ref="nofollow noopener noreferrer">lexical search</a>，这样才能兼顾两者优势：</p>
<ul>
<li>Lexical 信息适合精确匹配单词和同义词，并提供用户正在寻找特定词的强信号。</li>
<li>Vectors 捕捉含义和意图，使用相似短语或不在词汇上相关的术语。</li>
</ul>
<p>结合 vector search 和 lexical search 最好使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a>：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK
<span class="hljs-number">3.</span>  (<span class="hljs-keyword">WHERE</span> KNN(content_vector, TEXT_EMBEDDING("my query")) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>)
<span class="hljs-number">4.</span>  (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(title, "my query") <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>)
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>

`AI写代码
</code></pre>
<p>上面的查询：</p>
<ul>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> 执行两个查询：
<ul>
<li>对 <code>dense_vector</code> 字段进行 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-knn" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-knn" target="_blank" ref="nofollow noopener noreferrer">KNN</a> 查询。</li>
<li>对文本字段进行 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fsearch-functions%23esql-match" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/search-functions#esql-match" target="_blank" ref="nofollow noopener noreferrer">MATCH</a> 查询。</li>
<li>两个查询都按分数排序，并各自返回前 10 个结果。</li>
</ul>
</li>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a> 将查询结果混合在一起，默认使用倒数排序融合 (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F151765742" title="https://elasticstack.blog.csdn.net/article/details/151765742" target="_blank" ref="nofollow noopener noreferrer">RRF</a>)。</li>
</ul>
<p>这允许你完全控制想执行的查询、每个查询要获取的结果数量，以及如何组合结果。</p>
<p>查看我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F156750993" title="https://elasticstack.blog.csdn.net/article/details/156750993" target="_blank" ref="nofollow noopener noreferrer">多阶段检索</a>博客文章，了解现代搜索的工作原理以及通过 ES|QL 实现的简便方式。</p>
<h2 data-id="heading-8">自定义评分</h2>
<p>使用 ES|QL 计算自定义评分很容易！只需使用 _score 元数据字段来计算你的自定义评分：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, TEXT_EMBEDDING("my semantic query", inference_id)
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> EVAL my_custom_score <span class="hljs-operator">=</span> _score <span class="hljs-operator">*</span> <span class="hljs-number">1.5</span> <span class="hljs-operator">+</span> ...
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> SORT my_custom_score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>

`AI写代码
</code></pre>
<p>如果你使用的是精确搜索，你已经有了向量相似度的评估，可以对其进行微调：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents
<span class="hljs-bullet">2.</span>  | EVAL similarity = V<span class="hljs-emphasis">_COSINE(content_</span>vector, [0.12, -0.03, 0.98, ...])
<span class="hljs-bullet">3.</span>  | EVAL my<span class="hljs-emphasis">_custom_</span>score = similarity * 1.5 + ...
<span class="hljs-bullet">4.</span>  | SORT my<span class="hljs-emphasis">_custom_</span>score DESC
<span class="hljs-bullet">5.</span>  | LIMIT 10

`AI写代码
</code></pre>
<p>与 Query DSL 的 script_score 相比，这种方法更简单、更迭代，并且完美适合 ES|QL 的执行流程。</p>
<h2 data-id="heading-9">使用 query 参数</h2>
<p>在使用查询向量时，你可以像之前的示例那样直接在查询中指定它。但你可能已经注意到，我们使用了省略号（...）来表示还有更多数据。</p>
<p>Dense vectors 通常是高维的；它们可能有数百或数千个维度，因此在查询中直接复制粘贴查询向量会让理解或推理变得困难，因为你会在屏幕上看到成千上万的数值。</p>
<p>记住，你可以使用 ES|QL query 参数来为查询提供参数：</p>
<pre><code class="hljs language-python" lang="python">`

<span class="hljs-number">1.</span>  POST _query
<span class="hljs-number">2.</span>  {
<span class="hljs-number">3.</span>    <span class="hljs-string">"query"</span>: <span class="hljs-string">"""
4.  FROM documents
5.  | WHERE KNN(content_vector, ?query_vector)
6.  | SORT _score DESC
7.  | KEEP title, _score
8.  | LIMIT 10
9.     """</span>,
<span class="hljs-number">10.</span>   <span class="hljs-string">"params"</span>: [{<span class="hljs-string">"query_vector"</span> : [<span class="hljs-number">0.12</span>, -<span class="hljs-number">0.03</span>, <span class="hljs-number">0.98</span>, ...]}]
<span class="hljs-number">11.</span>  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>这有助于将查询逻辑与参数分离，让你可以专注于查询逻辑，而不是被具体参数束缚。</p>
<p>对向量使用 query 参数也更高效，因为这样通过 request parser 解析向量比通过 ES|QL parser 更快。</p>
<h2 data-id="heading-10">结论</h2>
<p>ES|QL 不仅支持 vector search，还将其自然地融入数据查询方式中。它允许你用单一强大的语法处理文本、向量及二者之间的一切，包括：</p>
<ul>
<li>Vector search，包括 approximate 和 exact。</li>
<li>Semantic search，使用文本对向量数据进行搜索。</li>
<li>Hybrid search，结合文本搜索和向量搜索的最佳结果。</li>
<li>Custom vector scoring，使用 EVAL 和 ES|QL 构造函数。</li>
</ul>
<p>ES|QL 中的 vector search 比 Query DSL 更简单，通过推断 prefilters 和参数，并与 ES|QL 提供的丰富表达式无缝集成。</p>
<p>将 KNN 定义为<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F156750993" title="https://elasticstack.blog.csdn.net/article/details/156750993" target="_blank" ref="nofollow noopener noreferrer">多阶段检索</a>管道的一部分只是查询的一环；你可以继续使用 filters，与其他文本函数结合进行 hybrid search，并在向量结果上应用 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143352429" title="https://elasticstack.blog.csdn.net/article/details/143352429" target="_blank" ref="nofollow noopener noreferrer">reranking</a> 或 query completion。</p>
<p>我们将继续增加向量函数，用于 dense vectors 的向量运算和聚合，让你充分利用 ES|QL 的全部功能操作向量数据。</p>
<p>祝你 (vector) 搜索愉快！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fdense-vector-search-elasticsearch-query-language" title="https://www.elastic.co/search-labs/blog/dense-vector-search-elasticsearch-query-language" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[能本地跑，复杂文档识别，0.9B小模型，GLM-OCR开源即巅峰（附源码）]]></title>    <link>https://juejin.cn/post/7603267434502635535</link>    <guid>https://juejin.cn/post/7603267434502635535</guid>    <pubDate>2026-02-06T03:33:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603267434502635535" data-draft-id="7603283380554186786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="能本地跑，复杂文档识别，0.9B小模型，GLM-OCR开源即巅峰（附源码）"/> <meta itemprop="keywords" content="后端,ChatGLM (智谱),开源"/> <meta itemprop="datePublished" content="2026-02-06T03:33:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            能本地跑，复杂文档识别，0.9B小模型，GLM-OCR开源即巅峰（附源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:33:50.000Z" title="Fri Feb 06 2026 03:33:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<p>直接说正事，智谱把自家的新一代OCR模型 GLM-OCR 直接开源了，而且一上来就是“小身材、大能量”的路线。</p>
<p>参数只有0.9B，却在权威的 OmniDocBench V1.5 榜单上拿了 94.6 分，在文本、公式、表格、信息抽取这几项里都冲到了 SOTA。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfdaa9a511cb4ddda8ad8ce807b4ed35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=gIOpVtLKNaF1kFti5%2B5Z5gdieWM%3D" alt="图片" loading="lazy"/></p>
<p><strong>🤯 痛点：传统OCR的“老大难”</strong></p>
<p>用过传统OCR工具的朋友，大概率都遇到过这些场景：</p>
<p>扫描版PDF：稍微模糊一点，或者表格跨页，出来的结果就是一团乱码，不是缺行少列，就是数字对不上。</p>
<p>手写体：学生的作业、医生的处方，识别率直接“跳水”，最后还是得靠人肉校对。</p>
<p>复杂表格：合并单元格、多层表头，识别出来就是一维文本，想还原成可用的表格，得手动调整半天。</p>
<p>公式截图：好不容易拍清楚，OCR 出来的却是一串看不懂的符号，想转成 LaTeX 更是奢望。</p>
<p>印章与文本重叠：盖章文件要提取信息，常常被印章盖住关键字段，传统方法很难把两者干净地分开。</p>
<p>多语言混排：中英文、数字、符号挤在一起，识别结果经常出现“串台”的尴尬情况。</p>
<p>很多方案为了效果，模型动辄几个B、几十B的参数，部署起来对显卡和内存要求很高，普通开发者和小团队只能望而却步。</p>
<p>成本也是个现实问题，按量计费、并发限制，处理海量历史文档时，账单会让人心头一紧。</p>
<p>所以，当我看到 GLM-OCR 的参数和定位时，心里想的是：这模型，能顶。</p>
<p><strong>🧠 GLM-OCR：麻雀虽小，五脏俱全</strong></p>
<p>GLM-OCR 是智谱基于 GLM-V 系列“视觉编码器 + 语言解码器”思路，专门为文档理解打造的一款多模态OCR模型。它的核心特点可以概括为：小、准、全、快、便宜。</p>
<p>小：模型总参数约 0.9B（其中视觉编码器约 400M，语言解码器约 0.5B），体积和显存占用都控制得很好，普通显卡甚至 CPU 环境都有机会跑起来。</p>
<p>准：在 OmniDocBench V1.5 综合榜单上拿到 94.6 分，在文本、公式、表格、信息抽取等多个子任务中都达到了 SOTA 或接近 SOTA 的水平。</p>
<p>全：它不只是“识字”，而是能理解整个文档的版式。官方重点优化了六大真实业务场景：代码文档、复杂表格、手写体、多语言、印章识别、票据提取。</p>
<p>快：官方测试数据显示，单副本单并发下，处理 PDF 的吞吐量约 1.86 页/秒，处理图片约 0.67 张/秒，速度在同类小参数模型里很有竞争力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a84b85d8e75f44859878c4bdcbe58fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=vA58lyCIfOOn5%2FlFa3Y8YFaTBAQ%3D" alt="图片" loading="lazy"/></p>
<p>便宜：官方 API 定价为 0.2 元/百万 Tokens，1 块钱大概能处理 2000 张 A4 扫描图或 200 份 10 页的 PDF，成本约为传统 OCR 方案的十分之一。</p>
<p>从技术架构上看，GLM-OCR 采用了“视觉编码器 → 跨模态连接层 → 语言解码器”的三级结构。</p>
<p>并引入了多 Tokens 预测损失（MTP）和全任务强化学习等训练策略，让模型在有限参数下也能学到更强的上下文理解和泛化能力。</p>
<p><strong>🚀 核心功能：不止于“识字”</strong></p>
<p>GLM-OCR 的功能覆盖了从简单识别到复杂理解的多个层次，实用性很强。</p>
<p>通用文本识别</p>
<p>支持照片、截图、扫描件、PDF 等多种输入，能较好地应对手写体、印章、代码截图等特殊内容。</p>
<p>对于学生、科研人员、程序员等需要数字化笔记或文档的人来说，非常友好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba853d4c2336462ea8d853d6a1351f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=bFdbofQhcahjUOm%2F0OXwF7HXQOU%3D" alt="图片" loading="lazy"/></p>
<p>复杂表格解析</p>
<p>能理解合并单元格、多层表头、斜线表头等复杂结构，并直接输出 HTML 表格代码，无需二次制表。</p>
<p>对于财务、运营、数据分析等经常处理报表的岗位，这能节省大量时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c03943f9d33440daab5877444e54f174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=MRzgbrR8vJYtiVN6WBELQOtZhG8%3D" alt="图片" loading="lazy"/></p>
<p>手写公式识别</p>
<p>能将手写或打印的公式截图准确地转换成 LaTeX 格式，保留上下标、分式、根号等复杂结构。</p>
<p>对于理工科师生和科研人员，这简直是“解放生产力”的神器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb0d7ba1e304e8b9e0cd9d7555dd8e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=NHtu9UJ0WmFkxerJowZ5ohmGza0%3D" alt="图片" loading="lazy"/></p>
<p>信息结构化提取</p>
<p>支持通过 JSON Schema 模板，从发票、证件、报关单等文档中自动提取关键字段并输出结构化 JSON 数据。</p>
<p>这对于需要对接业务系统、构建自动化流程的开发者来说，价值巨大。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9055a4b0fb184412beec7af0274e8b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=3EFp4fGJFl7noNoS2DzxmX37R6k%3D" alt="图片" loading="lazy"/></p>
<p>批量处理与 RAG 支持</p>
<p>支持大批量文档解析，其高精度和规整的输出格式，非常适合作为检索增强生成（RAG）系统的前置文档解析模块，为上层大模型提供高质量的“燃料”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d732cea09fdb497ea8bbb441c4f4fcae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=1E0ffiqAko%2FbYr7ZEEs1PXRoJbE%3D" alt="图片" loading="lazy"/></p>
<p><strong>💻 使用体验：本地与云端部署</strong></p>
<p>GLM-OCR 提供了多种灵活的接入方式，无论是开发者还是普通用户，都能找到适合自己的玩法。</p>
<p>本地/私有化部署：支持 vLLM、SGLang、Ollama多种主流框架。对于注重数据隐私或有本地化部署需求的用户，非常友好。</p>
<p>云端 API 调用：智谱开放平台提供了标准的 API 接口，按量计费，接入成本和使用门槛都很低。</p>
<p>本地安装</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Install from source</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/glm-ocr.git
<span class="hljs-built_in">cd</span> glm-ocr
uv venv --python 3.12 --seed &amp;&amp; <span class="hljs-built_in">source</span> .venv/bin/activate
uv pip install -e .
<span class="hljs-comment"># Install transformers from source</span>
uv pip install git+https://github.com/huggingface/transformers.git


<span class="hljs-comment"># Parse a single image</span>
glmocr parse examples/source/code.png


<span class="hljs-comment"># Parse a directory</span>
glmocr parse examples/source/


<span class="hljs-comment"># Set output directory</span>
glmocr parse examples/source/code.png --output ./results/


<span class="hljs-comment"># Use a custom config</span>
glmocr parse examples/source/code.png --config my_config.yaml


<span class="hljs-comment"># Enable debug logging with profiling</span>
glmocr parse examples/source/code.png --log-level DEBUG


from glmocr import GlmOcr, parse


<span class="hljs-comment"># Simple function</span>
result = parse(<span class="hljs-string">"image.png"</span>)
result = parse([<span class="hljs-string">"img1.png"</span>, <span class="hljs-string">"img2.jpg"</span>])
result = parse(<span class="hljs-string">"https://example.com/image.png"</span>)
result.save(output_dir=<span class="hljs-string">"./results"</span>)


<span class="hljs-comment"># Note: a list is treated as pages of a single document.</span>


<span class="hljs-comment"># Class-based API</span>
with GlmOcr() as parser:
    result = parser.parse(<span class="hljs-string">"image.png"</span>)
    <span class="hljs-built_in">print</span>(result.json_result)
    result.save()
</code></pre>
<p>开源社区</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1</span>.开源地址
<span class="hljs-title class_">Github</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/zai</span>-org/<span class="hljs-variable constant_">GLM</span>-<span class="hljs-variable constant_">OCR</span>
<span class="hljs-title class_">Hugging</span> <span class="hljs-title class_">Face</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/huggingface.co/zai</span>-org/<span class="hljs-variable constant_">GLM</span>-<span class="hljs-variable constant_">OCR</span>

<span class="hljs-number">2</span>.模型<span class="hljs-variable constant_">API</span>
智谱开放平台：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/docs.bigmodel.cn/cn</span><span class="hljs-regexp">/guide/models</span><span class="hljs-regexp">/vlm/glm</span>-ocr
特惠尝鲜礼包上线，<span class="hljs-number">2.9</span>元享<span class="hljs-number">5000</span>万<span class="hljs-title class_">Tokens</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/bigmodel.cn/special</span>_area
Z.ai：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/docs.z.ai/guides</span><span class="hljs-regexp">/vlm/glm</span>-ocr

<span class="hljs-number">3</span>.在线体验
Z.ai：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/ocr.z.ai
</span></code></pre>
<p><strong>👍 为什么推荐它？</strong></p>
<p>结合我自己的感受，推荐 GLM-OCR 的理由主要有以下几点：</p>
<p>开源免费，自主可控：基于 Apache-2.0 license 协议开源，个人和企业都可以免费使用、二次开发和商用。</p>
<p>性能强劲，性价比高：0.9B 的小参数，却在多个权威榜单上取得了顶尖成绩，真正做到了“小而美”。</p>
<p>同时，无论是本地部署的成本还是云端 API 的定价，都极具竞争力。</p>
<p>场景覆盖广，实用性强：从日常办公到科研学习，从简单识别到复杂结构化提取，GLM-OCR 都能提供出色的支持，具有很强的通用性。</p>
<p>工程友好，易于集成：提供了完整的 SDK 和推理工具链，支持多种主流部署方式，无论是开发者还是普通用户，都能快速上手。</p>
<p>国产模型，本土化优势：对于中文用户来说，GLM-OCR 在处理中文文档、票据等本土化场景时，具有天然的优势。</p>
<p><strong>🎯 最后</strong></p>
<p>GLM-OCR 的出现，为 OCR 领域带来了一股新的活力。</p>
<p>“小身材”撬动了“高精度”，用“开源”降低了技术门槛，让更多人能够享受到 AI 带来的便利。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73acc37c5084496185123433e92a42a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=D1HEhIE1M7Izu%2FUfu8b2a66oX9E%3D" alt="图片" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot + AWS Lambda / 阿里云 FC：事件驱动架构下，轻量函数处理异步任务]]></title>    <link>https://juejin.cn/post/7603282168137891859</link>    <guid>https://juejin.cn/post/7603282168137891859</guid>    <pubDate>2026-02-06T05:29:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603282168137891859" data-draft-id="7600333405979361321" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot + AWS Lambda / 阿里云 FC：事件驱动架构下，轻量函数处理异步任务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T05:29:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我爱娃哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/1398234522335383"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot + AWS Lambda / 阿里云 FC：事件驱动架构下，轻量函数处理异步任务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234522335383/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我爱娃哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:29:05.000Z" title="Fri Feb 06 2026 05:29:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">传统异步任务的挑战</h2>
<p>在我们的日常开发工作中，经常会遇到这样的场景：</p>
<ul>
<li>用户上传文件后需要异步处理，但长时间占用应用服务器资源</li>
<li>订单状态变更需要通知多个下游系统，同步调用影响主流程性能</li>
<li>日志分析、数据统计等批量任务需要在后台运行</li>
<li>图片压缩、视频转码等计算密集型任务消耗大量CPU</li>
</ul>
<p>传统的异步任务处理方式要么需要维护额外的服务器资源，要么架构复杂度高。今天我们就来聊聊如何用Serverless函数计算优雅地解决这些问题。
<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.jiangyi.space%2Farticles%2F2026%2F01%2F30%2F1769664610418.html" target="_blank" title="http://www.jiangyi.space/articles/2026/01/30/1769664610418.html" ref="nofollow noopener noreferrer">阅读原文</a></p>
<h2 data-id="heading-1">Serverless函数计算的优势</h2>
<p>相比传统的异步任务处理方案，Serverless有以下显著优势：</p>
<ul>
<li><strong>按需付费</strong>：只对实际执行时间付费，闲置时不收费</li>
<li><strong>弹性伸缩</strong>：根据负载自动扩缩容，无需人工干预</li>
<li><strong>免运维</strong>：无需关心服务器运维，专注业务逻辑</li>
<li><strong>快速部署</strong>：秒级部署，快速响应业务需求</li>
</ul>
<h2 data-id="heading-2">核心实现思路</h2>
<h3 data-id="heading-3">1. 事件驱动架构</h3>
<p>Serverless函数天然适合事件驱动架构：</p>
<ul>
<li><strong>事件源</strong>：消息队列、数据库变更、API调用等</li>
<li><strong>事件处理</strong>：函数接收事件并处理</li>
<li><strong>事件响应</strong>：处理结果可以触发后续事件</li>
</ul>
<h3 data-id="heading-4">2. SpringBoot与Serverless集成</h3>
<p>我们可以通过多种方式将SpringBoot应用与Serverless函数集成：</p>
<ul>
<li><strong>消息队列桥接</strong>：SpringBoot应用发送消息到队列，函数消费</li>
<li><strong>HTTP回调</strong>：函数处理完成后回调SpringBoot接口</li>
<li><strong>数据库状态同步</strong>：通过数据库状态变更触发函数执行</li>
</ul>
<h2 data-id="heading-5">实践方案详解</h2>
<h3 data-id="heading-6">1. AWS Lambda集成</h3>
<h4 data-id="heading-7">函数编写</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskFunction</span> {
    
    <span class="hljs-keyword">public</span> APIGatewayProxyResponseEvent <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(
            APIGatewayProxyRequestEvent input, Context context)</span> {
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 解析事件数据</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">eventBody</span> <span class="hljs-operator">=</span> input.getBody();
            <span class="hljs-type">AsyncTaskEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(eventBody, AsyncTaskEvent.class);
            
            <span class="hljs-comment">// 执行具体任务</span>
            <span class="hljs-keyword">switch</span> (event.getTaskType()) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"FILE_PROCESSING"</span>:
                    processFile(event);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"IMAGE_COMPRESSION"</span>:
                    compressImage(event);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"DATA_ANALYSIS"</span>:
                    analyzeData(event);
                    <span class="hljs-keyword">break</span>;
            }
            
            <span class="hljs-comment">// 返回成功响应</span>
            <span class="hljs-keyword">return</span> createSuccessResponse(<span class="hljs-string">"Task completed"</span>);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            context.getLogger().log(<span class="hljs-string">"Error processing task: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> createErrorResponse(e.getMessage());
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFile</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 文件处理逻辑</span>
        <span class="hljs-type">S3Client</span> <span class="hljs-variable">s3Client</span> <span class="hljs-operator">=</span> S3Client.create();
        <span class="hljs-comment">// ... 具体处理逻辑</span>
    }
}
</code></pre>
<h4 data-id="heading-8">部署配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># serverless.yml</span>
<span class="hljs-attr">service:</span> <span class="hljs-string">async-task-service</span>

<span class="hljs-attr">provider:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">aws</span>
  <span class="hljs-attr">runtime:</span> <span class="hljs-string">java11</span>
  <span class="hljs-attr">region:</span> <span class="hljs-string">us-east-1</span>

<span class="hljs-attr">functions:</span>
  <span class="hljs-attr">fileProcessor:</span>
    <span class="hljs-attr">handler:</span> <span class="hljs-string">com.example.AsyncTaskFunction::handleRequest</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">300</span>
    <span class="hljs-attr">memorySize:</span> <span class="hljs-number">1024</span>
    <span class="hljs-attr">events:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">sqs:</span>
          <span class="hljs-attr">arn:</span> <span class="hljs-type">!GetAtt</span> <span class="hljs-string">TaskQueue.Arn</span>
</code></pre>
<h3 data-id="heading-9">2. 阿里云函数计算集成</h3>
<h4 data-id="heading-10">函数实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FCTaskProcessor</span> {
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(InputStream input, OutputStream output, Context context)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 读取输入流</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">eventJson</span> <span class="hljs-operator">=</span> StreamUtils.copyToString(input, StandardCharsets.UTF_8);
            <span class="hljs-type">AsyncTaskEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(eventJson, AsyncTaskEvent.class);
            
            <span class="hljs-comment">// 根据任务类型执行不同逻辑</span>
            <span class="hljs-type">TaskResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executeTask(event);
            
            <span class="hljs-comment">// 写入输出流</span>
            <span class="hljs-keyword">return</span> JsonUtils.toJson(result);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            context.getLogger().info(<span class="hljs-string">"Task execution failed: "</span> + e.getMessage());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
    
    <span class="hljs-keyword">private</span> TaskResult <span class="hljs-title function_">executeTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-keyword">switch</span> (event.getTaskType()) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"NOTIFICATION"</span>:
                <span class="hljs-keyword">return</span> sendNotification(event);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"REPORT_GENERATION"</span>:
                <span class="hljs-keyword">return</span> generateReport(event);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Unknown task type: "</span> + event.getTaskType());
        }
    }
}
</code></pre>
<h3 data-id="heading-11">3. SpringBoot事件发布</h3>
<p>在SpringBoot应用中发布事件到函数计算：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventPublisherService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SqsTemplate sqsTemplate;  <span class="hljs-comment">// AWS SQS</span>
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;  <span class="hljs-comment">// 阿里云RocketMQ</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishAsyncTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 发布到消息队列，由函数消费</span>
        <span class="hljs-keyword">if</span> (isUsingAWS()) {
            sqsTemplate.convertAndSend(<span class="hljs-string">"async-task-queue"</span>, event);
        } <span class="hljs-keyword">else</span> {
            rocketMQTemplate.convertAndSend(<span class="hljs-string">"async-task-topic"</span>, event);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">triggerLambdaDirectly</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 直接调用Lambda函数</span>
        <span class="hljs-type">InvokeRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> InvokeRequest.builder()
                .functionName(<span class="hljs-string">"async-task-function"</span>)
                .payload(JsonUtils.toJson(event).getBytes())
                .build();
                
        lambdaClient.invoke(request);
    }
}
</code></pre>
<h3 data-id="heading-12">4. 任务状态管理</h3>
<p>为了更好地管理异步任务状态，我们可以结合数据库：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "async_task")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTask</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String taskId;
    <span class="hljs-keyword">private</span> String eventType;
    <span class="hljs-keyword">private</span> String status;  <span class="hljs-comment">// PENDING, PROCESSING, SUCCESS, FAILED</span>
    <span class="hljs-keyword">private</span> String result;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskService</span> {
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createAndPublishTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        
        <span class="hljs-comment">// 保存任务记录</span>
        <span class="hljs-type">AsyncTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTask</span>();
        task.setTaskId(taskId);
        task.setEventType(event.getType());
        task.setStatus(<span class="hljs-string">"PENDING"</span>);
        task.setCreateTime(LocalDateTime.now());
        asyncTaskRepository.save(task);
        
        <span class="hljs-comment">// 发布到函数计算</span>
        eventPublisherService.publishAsyncTask(event);
        
        <span class="hljs-keyword">return</span> taskId;
    }
    
    <span class="hljs-keyword">public</span> AsyncTask <span class="hljs-title function_">getTaskStatus</span><span class="hljs-params">(String taskId)</span> {
        <span class="hljs-keyword">return</span> asyncTaskRepository.findById(taskId).orElse(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h2 data-id="heading-13">高级特性实现</h2>
<h3 data-id="heading-14">1. 函数冷启动优化</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedFunction</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> 
        Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 预热逻辑</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmup</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 预加载常用资源</span>
        initializeResources();
    }
    
    <span class="hljs-keyword">public</span> APIGatewayProxyResponseEvent <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(...)</span> {
        <span class="hljs-comment">// 使用线程池处理任务，减少冷启动影响</span>
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> processTask();
        }, executor).join();
    }
}
</code></pre>
<h3 data-id="heading-15">2. 错误重试机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryableTaskProcessor</span> {
    
    <span class="hljs-meta">@Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 任务处理逻辑</span>
        executeTask(event);
    }
    
    <span class="hljs-meta">@Recover</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recover</span><span class="hljs-params">(Exception ex, AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 重试失败后的处理</span>
        log.error(<span class="hljs-string">"Task failed after retries: {}"</span>, event.getTaskId(), ex);
        updateTaskStatus(event.getTaskId(), <span class="hljs-string">"FAILED"</span>);
    }
}
</code></pre>
<h3 data-id="heading-16">3. 监控与告警</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionMetricsCollector</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordTaskExecution</span><span class="hljs-params">(String taskType, <span class="hljs-type">long</span> duration, <span class="hljs-type">boolean</span> success)</span> {
        Timer.<span class="hljs-type">Sample</span> <span class="hljs-variable">sample</span> <span class="hljs-operator">=</span> Timer.start(meterRegistry);
        
        <span class="hljs-type">Tags</span> <span class="hljs-variable">tags</span> <span class="hljs-operator">=</span> Tags.of(<span class="hljs-string">"task_type"</span>, taskType, <span class="hljs-string">"success"</span>, String.valueOf(success));
        
        sample.stop(Timer.builder(<span class="hljs-string">"function.task.duration"</span>)
                 .tags(tags)
                 .register(meterRegistry));
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorFunctionHealth</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 监控函数执行成功率、延迟等指标</span>
    }
}
</code></pre>
<h2 data-id="heading-17">最佳实践建议</h2>
<ol>
<li><strong>函数设计原则</strong>：函数应该短小精悍，专注单一职责</li>
<li><strong>状态管理</strong>：避免在函数中维护状态，使用外部存储</li>
<li><strong>错误处理</strong>：完善的错误处理和重试机制</li>
<li><strong>资源限制</strong>：合理设置内存和执行时间限制</li>
<li><strong>安全性</strong>：确保函数调用的安全性，防止未授权访问</li>
</ol>
<p>通过Serverless函数计算，我们可以构建高效、弹性的异步任务处理系统，让应用架构更加现代化。</p>
<hr/>
<p>以上就是本期分享的内容，希望对你有所帮助。更多技术干货，请关注服务端技术精选，我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南]]></title>    <link>https://juejin.cn/post/7603227363822256154</link>    <guid>https://juejin.cn/post/7603227363822256154</guid>    <pubDate>2026-02-06T03:37:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603227363822256154" data-draft-id="7603215839582470154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南"/> <meta itemprop="keywords" content="TypeScript,前端工程化"/> <meta itemprop="datePublished" content="2026-02-06T03:37:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="polaris_tl"/> <meta itemprop="url" content="https://juejin.cn/user/4142615545513224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4142615545513224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    polaris_tl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:37:47.000Z" title="Fri Feb 06 2026 03:37:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南</h2>
<h3 data-id="heading-1">1、凡人入道：七玄门里的“藏宝图”</h3>
<p>最近笔者在倒腾一个 <strong>Monorepo</strong> 大工程（全栈开发），不可避免地撞上了 <code>tsconfig.json</code>。盯着里面密密麻麻的配置项，我陷入了沉思：我只是想让 <code>tsc</code> 帮我把代码翻译翻译，为什么需要这么多繁琐的指令？</p>
<p>作为一个老牌“码农修仙者”，以前配置这玩意儿全靠<strong>搜魂术</strong>（Ctrl+C/V），大不了请出<strong>AI邪修</strong>强行破阵。但为了修得正果，我决定深入禁地，扒一扒这本“编译器操作手册”背后的底层逻辑。</p>
<p><strong>本文不复读文档!!</strong>，只论道法。各位道友，请随我入阵！🫡</p>
<hr/>
<h3 data-id="heading-2">2、炼气奠基：诸神黄昏与模块化的恩怨</h3>
<p>要想修仙修得好，<strong>因果背景</strong>不能少。</p>
<p><code>tsconfig.json</code> 之所以复杂，全怪 JS 那些年留下的“情债”。在 JS 道祖开天辟地之初，根本没有模块化。后来江湖大乱，<strong>CommonJS</strong>、<strong>AMD</strong>、<strong>UMD</strong> 割据一方。直到 ES6（2015年），官方才推出了 <strong>ES Module (ESM)</strong> 试图大一统。</p>
<p>但问题来了：即便现在已是 2026 年，npm 生态里依然残留着海量的 CommonJS 老古董。</p>
<p><strong>TypeScript 作为 JS 的超集，它最核心的痛苦就在于：</strong> 它得当一个“翻译官”，协调这些互不兼容的模块体系。</p>
<p>这就是 <code>tsconfig.json</code> 存在的根本意义——<strong>它在告诉编译器：在不同模块体系交火时，该如何“拉偏架”！</strong></p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CommonJS"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 告诉 TS：编译出的代码用哪种方言说话</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 告诉 TS：去哪里寻找那些失散的模块</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 给 ESM 和 CJS 之间搭个桥，别让他们打架</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-comment">// 即使对方没写 default，也允许我“默认”导入</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">3、筑基风云：深入理解核心阵法</h3>
<h4 data-id="heading-4">3.1 核心作用：它到底管什么？</h4>
<p>简单来说，<code>tsconfig.json</code> 负责两件事： <strong>“管人”</strong> （哪些文件参战）和 <strong>“管事”</strong> （怎么打仗）。</p>
<ul>
<li>
<p><strong>文件管理（管人）：</strong></p>
<p>通过 <code>include</code>、<code>exclude</code>、<code>files</code> 划定势力范围。比如：编译 <code>src</code> 里的天才（源码），踢出 <code>node_modules</code> 里的路人。</p>
</li>
<li>
<p><strong>编译规则（管事）：</strong></p>
<ul>
<li><strong>宿主环境</strong>：<code>target</code> 决定你是要在老旧的浏览器（ES5）里爬行，还是在现代引擎（ESNext）里飞升。</li>
<li><strong>模块体系</strong>：<code>module</code> 决定输出的形状。</li>
<li><strong>检查强度</strong>：<code>strict</code> 模式。开启后，编译器就像严师，一丝一毫的类型模糊（any）都可能让你道心破碎。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">3.2 配置继承：分身之术（Extends）</h4>
<p>在 Monorepo 或 Vite 项目中，你会看到 <code>tsconfig.app.json</code>、<code>tsconfig.node.json</code>。</p>
<ul>
<li><strong>extends</strong>：为了避免每个子项目都写一遍冗长的配置，我们可以搞个“祖传秘籍”（base.json），子项直接继承，只需微调（比如前端需要 <code>DOM</code> 库，后端需要 <code>Node</code> 库）。</li>
</ul>
<h4 data-id="heading-6">3.3 路径解析：缩地成寸（Paths）</h4>
<p>受够了 <code>import { tool } from "../../../../../utils"</code> 这种“僵尸路径”？</p>
<p>通过 <code>baseUrl</code> 和 <code>paths</code>，你可以施展<strong>缩地成寸</strong>：</p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>道友请留步：</strong> 这只是给 <code>tsc</code> 看的“幻术”。如果你没配合 Vite/Webpack 进行物理层面的路径映射，代码运行到 JS 环境时会因为找不到路而走火入魔。</p>
<h4 data-id="heading-7">3.4 模块查找：现代修仙的新法门</h4>
<p>到了 TS 5.x 时代，有两个配置值得重点关注：</p>
<ul>
<li><strong>moduleResolution: "bundler"</strong> ：这是给 Vite/Webpack 打包工具量身定制的模式。它更聪明，知道现在的开发者不喜欢写 <code>.js</code> 后缀，也懂得如何处理 <code>package.json</code> 里的各种复杂导出。</li>
<li><strong>verbatimModuleSyntax</strong>：这是<strong>高性能开关</strong>。它要求你明确标记 <code>import type</code>。编译器看到 type 直接“物理删除”，不费脑子去猜，编译速度突飞猛进。</li>
</ul>
<hr/>
<h3 data-id="heading-8">4、结丹：道法总结</h3>
<p>要真正掌握 <code>tsconfig.json</code>，只需记住：</p>
<ol>
<li>它是<strong>输入的准则</strong>：界定哪些文件是你的“门徒”。</li>
<li>它是<strong>运行的蓝图</strong>：决定代码翻译成什么样。</li>
<li>它是<strong>类型的心法</strong>：决定静态检查有多狠。</li>
</ol>
<hr/>
<h3 data-id="heading-9">5、元婴出世：下一步挑战</h3>
<p>修炼至此，你已经识破了 <code>tsconfig.json</code> 的伪装。面对深不可测的 Monorepo 配置，你已经具备了初步的抗性。</p>
<p>好了，现在各位可以去挑战韩老魔了，加油~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bc61c7825bc4585bf1b27adeb33205e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9sYXJpc190bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953868&amp;x-signature=FoI2RYE6MB2bLBIngeVIQajwPj4%3D" alt="honey.jpeg" loading="lazy"/></p>
<p>参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2Fmodules%2Ftheory.html%23module-resolution" target="_blank" title="https://www.typescriptlang.org/docs/handbook/modules/theory.html#module-resolution" ref="nofollow noopener noreferrer">www.typescriptlang.org/docs/handbo…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 DeFi 新范式：意图金融（Intent-Centric）深度解析与实战]]></title>    <link>https://juejin.cn/post/7603227363822436378</link>    <guid>https://juejin.cn/post/7603227363822436378</guid>    <pubDate>2026-02-06T04:28:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603227363822436378" data-draft-id="7602914378388750346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 DeFi 新范式：意图金融（Intent-Centric）深度解析与实战"/> <meta itemprop="keywords" content="智能合约,Solidity,web3"/> <meta itemprop="datePublished" content="2026-02-06T04:28:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 DeFi 新范式：意图金融（Intent-Centric）深度解析与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T04:28:47.000Z" title="Fri Feb 06 2026 04:28:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>“意图金融”（Intent-Centric Finance）是去中心化金融（DeFi）领域的革命性交互范式，其核心逻辑实现了从“过程导向”到“结果导向”的根本性转变。用户无需手动执行授权、跨链、路径筛选等复杂操作，仅需向系统声明最终目标（即“意图”）及约束条件，剩余的执行流程由专业“求解者”（Solvers/Searchers）完成，大幅降低了Web3金融的使用门槛。</p>
</blockquote>
<h2 data-id="heading-1">一、 趋势背景：从“操作导向”到“结果导向”</h2>
<p>在传统的 DeFi 交互中，用户必须充当“操作员”：</p>
<ol>
<li><strong>寻找路径</strong>：去哪个 DEX 换币？用哪个跨链桥？</li>
<li><strong>管理细节</strong>：设置滑点、计算 Gas 费、处理多步授权。</li>
<li><strong>承担风险</strong>：手动操作失误或遭受 MEV 夹击。</li>
</ol>
<p><strong>意图金融 (Intent-Centric Finance)</strong>  在 2026 年彻底改变了这一现状。用户不再提交具体的交易步骤，而是签署一个 <strong>“意图”（Intent）</strong> ——即声明“我想要的结果”，而将“如何达成结果”的过程外包给专业的<strong>求解者（Solvers）</strong> 。</p>
<hr/>
<h2 data-id="heading-2">二、 意图金融 vs. 传统交易 </h2>






























<table><thead><tr><th>维度 </th><th>传统 DeFi 交易 (Imperative)</th><th>意图金融 (Declarative)</th></tr></thead><tbody><tr><td><strong>用户操作</strong></td><td>手动操作：桥接→换 Gas→授权→交换</td><td>声明目标：“我要用100100100USDC 换到最多的 ETH”</td></tr><tr><td><strong>交互复杂性</strong></td><td>用户必须理解各种底层协议和 Gas 优化</td><td><strong>抽象化底层</strong>，用户像“打车”一样，只给目的地</td></tr><tr><td><strong>执行效率</strong></td><td>路径单一，可能因失误导致滑点高或失败</td><td>多个“求解者”竞争，寻找<strong>全网最优路径</strong></td></tr><tr><td><strong>MEV 保护</strong></td><td>易受机器人夹击攻击（MEV）</td><td>通常具备 <strong>MEV 抗性</strong>，风险转嫁给求解者</td></tr></tbody></table>
<h2 data-id="heading-3">三、 意图金融的核心架构</h2>
<p>意图架构由三个核心组件构成：</p>





















<table><thead><tr><th>组件</th><th>职能</th></tr></thead><tbody><tr><td><strong>用户 (User)</strong></td><td>签署包含约束条件（价格、时效、Nonce）的声明，不需支付 Gas 或了解路径。</td></tr><tr><td><strong>求解者 (Solvers)</strong></td><td>链下竞争者，寻找最优执行路径（聚合流动性、跨链、自营资金补足），并代付 Gas。</td></tr><tr><td><strong>结算合约 (Executor)</strong></td><td>链上验证器，确保求解者的结果严格满足用户意图，否则拒绝执行。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">四. 2026 年的主流应用场景 </h2>
<p>随着技术成熟，意图金融在2026年已落地多个核心场景，实现从“极客工具”到“大众金融”的跨越：</p>
<ul>
<li><strong>无缝跨链交易</strong>：以Across协议为代表，用户在A链支付原资产后，可直接在B链接收目标资产，无需手动操作跨链桥的繁琐步骤，实现跨链交互“零门槛”。</li>
<li><strong>最优价格聚合交易</strong>：UniswapX、CoW Swap等平台借助意图机制，自动扫描全网流动性池，整合中心化交易所与去中心化协议资源，为用户达成最优成交价格。</li>
<li><strong>智能收益策略管理</strong>：依托Anoma等底层协议，用户仅需声明收益目标（如“稳定币年化收益＞10%”），系统即可自动在不同DeFi协议间调度资金，动态适配最优收益策略。</li>
</ul>
<h2 data-id="heading-5">五、意图金融智能合约开发、测试、部署</h2>
<h4 data-id="heading-6">一、智能合约</h4>
<p><strong>代币合约</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
<span class="hljs-comment">// Compatible with OpenZeppelin Contracts ^5.5.0</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.24</span>;

<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/ERC20.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20Burnable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/extensions/ERC20Burnable.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20Permit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Ownable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/access/Ownable.sol"</span>;

contract <span class="hljs-title class_">BoykaYuriToken</span> is <span class="hljs-title class_">ERC20</span>, <span class="hljs-title class_">ERC20Burnable</span>, <span class="hljs-title class_">Ownable</span>, <span class="hljs-title class_">ERC20Permit</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">address recipient, address initialOwner</span>)
        <span class="hljs-title class_">ERC20</span>(<span class="hljs-string">"MyToken"</span>, <span class="hljs-string">"MTK"</span>)
        <span class="hljs-title class_">Ownable</span>(initialOwner)
        <span class="hljs-title class_">ERC20Permit</span>(<span class="hljs-string">"MyToken"</span>)
    {
        <span class="hljs-title function_">_mint</span>(recipient, <span class="hljs-number">1000000</span> * <span class="hljs-number">10</span> ** <span class="hljs-title function_">decimals</span>());
    }
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">mint</span>(<span class="hljs-params">address to, uint256 amount</span>) public onlyOwner {
        <span class="hljs-title function_">_mint</span>(to, amount);
    }
}
</code></pre>
<p><strong>意图金融合约</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.24</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/ECDSA.sol"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/utils/ReentrancyGuard.sol"</span>; <span class="hljs-comment">// 引入防重入库</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/IERC20.sol"</span>;

contract IntentExecutor is ReentrancyGuard { <span class="hljs-comment">// 必须在这里显式继承</span>
    <span class="hljs-keyword">using</span> ECDSA <span class="hljs-keyword">for</span> bytes32;
    <span class="hljs-keyword">using</span> MessageHashUtils <span class="hljs-keyword">for</span> bytes32;

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Intent</span> {
        address user;
        address tokenIn;
        uint256 amountIn;
        address tokenOut;
        uint256 minAmountOut;
        uint256 nonce;
        uint256 deadline;
    }

    <span class="hljs-built_in">mapping</span>(address =&gt; uint256) <span class="hljs-keyword">public</span> nonces;

    <span class="hljs-function">event <span class="hljs-title">IntentFulfilled</span><span class="hljs-params">(bytes32 indexed intentHash, address indexed solver)</span></span>;

    <span class="hljs-function">function <span class="hljs-title">getIntentHash</span><span class="hljs-params">(Intent memory intent)</span> <span class="hljs-keyword">public</span> pure <span class="hljs-title">returns</span> <span class="hljs-params">(bytes32)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">keccak256</span>(abi.<span class="hljs-built_in">encode</span>(
            intent.user,
            intent.tokenIn,
            intent.amountIn,
            intent.tokenOut,
            intent.minAmountOut,
            intent.nonce,
            intent.deadline
        ));
    }

    <span class="hljs-comment">/**
     * 注意：OpenZeppelin V5 的修饰器是 nonReentrant (小驼峰)
     */</span>
    <span class="hljs-function">function <span class="hljs-title">executeIntent</span><span class="hljs-params">(Intent calldata intent, bytes calldata signature)</span> 
        external 
        nonReentrant <span class="hljs-comment">// 修正此处：从 non_reentrant 改为 nonReentrant</span>
    </span>{
        <span class="hljs-built_in">require</span>(block.timestamp &lt;= intent.deadline, <span class="hljs-string">"Intent expired"</span>);
        <span class="hljs-built_in">require</span>(intent.nonce == nonces[intent.user], <span class="hljs-string">"Invalid nonce"</span>);

        <span class="hljs-comment">// 验证签名</span>
        bytes32 hash = <span class="hljs-built_in">getIntentHash</span>(intent).<span class="hljs-built_in">toEthSignedMessageHash</span>();
        <span class="hljs-built_in">require</span>(hash.<span class="hljs-built_in">recover</span>(signature) == intent.user, <span class="hljs-string">"Invalid signature"</span>);

        <span class="hljs-comment">// 更新 Nonce 防止重放</span>
        nonces[intent.user]++;

        <span class="hljs-comment">// 执行意图逻辑</span>
        <span class="hljs-comment">// 1. 从用户处转入资产到 Solver (需用户提前 approve 本合约)</span>
        <span class="hljs-built_in">IERC20</span>(intent.tokenIn).<span class="hljs-built_in">transferFrom</span>(intent.user, msg.sender, intent.amountIn);

        <span class="hljs-comment">// 2. Solver 必须确保用户收到目标资产</span>
        <span class="hljs-comment">// 在意图金融中，由 Solver 保证结果的最终性</span>
        <span class="hljs-built_in">require</span>(
            <span class="hljs-built_in">IERC20</span>(intent.tokenOut).<span class="hljs-built_in">transferFrom</span>(msg.sender, intent.user, intent.minAmountOut),
            <span class="hljs-string">"Solver failed to provide minAmountOut"</span>
        );

        <span class="hljs-function">emit <span class="hljs-title">IntentFulfilled</span><span class="hljs-params">(getIntentHash(intent), msg.sender)</span></span>;
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-7">二、意图金融测试脚本</h4>
<p><strong>测试说明</strong>：</p>
<ol>
<li><strong>Solver 应该能够执行有效的用户意图</strong></li>
<li><strong>过期的意图应该执行失败</strong></li>
<li><strong>Nonce 不匹配应该防止重放攻击</strong></li>
</ol>
<pre><code class="hljs language-php" lang="php">import assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert/strict"</span>;
import { describe, it, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
import { parseEther, formatEther, keccak256, encodeAbiParameters, hashMessage } <span class="hljs-keyword">from</span> <span class="hljs-string">'viem'</span>;
import { network } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;

<span class="hljs-title function_ invoke__">describe</span>(<span class="hljs-string">"IntentExecutor 意图金融合约测试"</span>, function () {
    let IntentExecutor: any, MockTokenA: any, MockTokenB: any;
    let publicClient: any, testClient: any;
    let user: any, solver: any, owner: any;

    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">AMOUNT_IN</span> = <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"100"</span>); <span class="hljs-comment">// 用户想出的 100 A</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MIN_AMOUNT_OUT</span> = <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"0.05"</span>); <span class="hljs-comment">// 用户要求的最低回报 0.05 B</span>

    <span class="hljs-title function_ invoke__">beforeEach</span>(async function () {
        <span class="hljs-keyword">const</span> { viem } = await network.<span class="hljs-title function_ invoke__">connect</span>();
        publicClient = await viem.<span class="hljs-title function_ invoke__">getPublicClient</span>();
        testClient = await viem.<span class="hljs-title function_ invoke__">getTestClient</span>();
        [owner, user, solver] = await viem.<span class="hljs-title function_ invoke__">getWalletClients</span>();

        <span class="hljs-comment">// 1. 部署两个 Mock 代币模拟交换</span>
        <span class="hljs-comment">// 使用你的 BoykaYuriToken 或标准 ERC20</span>
        MockTokenA = await viem.<span class="hljs-title function_ invoke__">deployContract</span>(<span class="hljs-string">"BoykaYuriToken"</span>, [owner.account.address, owner.account.address]);
        MockTokenB = await viem.<span class="hljs-title function_ invoke__">deployContract</span>(<span class="hljs-string">"BoykaYuriToken"</span>, [owner.account.address, owner.account.address]);

        <span class="hljs-comment">// 2. 部署意图执行合约</span>
        IntentExecutor = await viem.<span class="hljs-title function_ invoke__">deployContract</span>(<span class="hljs-string">"IntentExecutor"</span>, []);

        <span class="hljs-comment">// 3. 初始资金分配</span>
        <span class="hljs-comment">// 给用户发 TokenA</span>
        await MockTokenA.write.<span class="hljs-title function_ invoke__">transfer</span>([user.account.address, AMOUNT_IN], { <span class="hljs-attr">account</span>: owner.account });
        <span class="hljs-comment">// 给 Solver 发 TokenB (用于履行意图)</span>
        await MockTokenB.write.<span class="hljs-title function_ invoke__">transfer</span>([solver.account.address, <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"10"</span>)], { <span class="hljs-attr">account</span>: owner.account });

        <span class="hljs-comment">// 4. 授权：用户和 Solver 都需要授权给 IntentExecutor 合约</span>
        await MockTokenA.write.<span class="hljs-title function_ invoke__">approve</span>([IntentExecutor.address, AMOUNT_IN], { <span class="hljs-attr">account</span>: user.account });
        await MockTokenB.write.<span class="hljs-title function_ invoke__">approve</span>([IntentExecutor.address, <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"10"</span>)], { <span class="hljs-attr">account</span>: solver.account });
    });

    <span class="hljs-title function_ invoke__">it</span>(<span class="hljs-string">"Solver 应该能够执行有效的用户意图"</span>, async function () {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">nonce</span> = await IntentExecutor.read.<span class="hljs-title function_ invoke__">nonces</span>([user.account.address]);
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">deadline</span> = <span class="hljs-title function_ invoke__">BigInt</span>(Math.<span class="hljs-title function_ invoke__">floor</span>(Date.<span class="hljs-title function_ invoke__">now</span>() / <span class="hljs-number">1000</span>) + <span class="hljs-number">3600</span>);

        <span class="hljs-comment">// 1. 构建意图对象 (必须与 Solidity Struct 顺序一致)</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">intent</span> = {
            user: user.account.address,
            tokenIn: MockTokenA.address,
            amountIn: AMOUNT_IN,
            tokenOut: MockTokenB.address,
            minAmountOut: MIN_AMOUNT_OUT,
            nonce: nonce,
            deadline: deadline
        };

        <span class="hljs-comment">// 2. 链下计算哈希 (对应合约 getIntentHash)</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">structHash</span> = <span class="hljs-title function_ invoke__">keccak256</span>(
            <span class="hljs-title function_ invoke__">encodeAbiParameters</span>(
                [
                    { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> },
                    { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }
                ],
                [intent.user, intent.tokenIn, intent.amountIn, intent.tokenOut, intent.minAmountOut, intent.nonce, intent.deadline]
            )
        );

        <span class="hljs-comment">// 3. 用户进行 EIP-191 签名</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">signature</span> = await user.<span class="hljs-title function_ invoke__">signMessage</span>({
            <span class="hljs-attr">message</span>: { <span class="hljs-attr">raw</span>: structHash },
        });

        <span class="hljs-comment">// 4. Solver 提交交易</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">hash</span> = await IntentExecutor.write.<span class="hljs-title function_ invoke__">executeIntent</span>([intent, signature], { <span class="hljs-attr">account</span>: solver.account });
        await publicClient.<span class="hljs-title function_ invoke__">waitForTransactionReceipt</span>({ hash });

        <span class="hljs-comment">// 5. 验证资产转移</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">userFinalBalanceB</span> = await MockTokenB.read.<span class="hljs-title function_ invoke__">balanceOf</span>([user.account.address]);
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">solverFinalBalanceA</span> = await MockTokenA.read.<span class="hljs-title function_ invoke__">balanceOf</span>([solver.account.address]);

        console.<span class="hljs-title function_ invoke__">log</span>(`意图达成！用户收到 <span class="hljs-attr">TokenB</span>: ${<span class="hljs-title function_ invoke__">formatEther</span>(userFinalBalanceB)}`);
        
        assert.<span class="hljs-title function_ invoke__">equal</span>(userFinalBalanceB, MIN_AMOUNT_OUT, <span class="hljs-string">"用户收到的代币数量不符合意图"</span>);
        assert.<span class="hljs-title function_ invoke__">equal</span>(solverFinalBalanceA, AMOUNT_IN, <span class="hljs-string">"Solver 未收到用户的代币"</span>);
    });
       <span class="hljs-title function_ invoke__">it</span>(<span class="hljs-string">"过期的意图应该执行失败"</span>, async function () {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">latestBlock</span> = await publicClient.<span class="hljs-title function_ invoke__">getBlock</span>({ <span class="hljs-attr">blockTag</span>: <span class="hljs-string">'latest'</span> });
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">currentChainTime</span> = latestBlock.timestamp;
        
        <span class="hljs-comment">// 1. 明确设置一个已经过期的时间</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">expiredDeadline</span> = currentChainTime - <span class="hljs-number">1000</span>n;
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">currentNonce</span> = await IntentExecutor.read.<span class="hljs-title function_ invoke__">nonces</span>([user.account.address]);

        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">intent</span> = {
            user: user.account.address,
            tokenIn: MockTokenA.address,
            amountIn: AMOUNT_IN,
            tokenOut: MockTokenB.address,
            minAmountOut: MIN_AMOUNT_OUT,
            nonce: currentNonce,
            deadline: expiredDeadline
        };

        <span class="hljs-comment">// 2. 生成合法签名（确保错误不是由签名解析引起的）</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">structHash</span> = <span class="hljs-title function_ invoke__">keccak256</span>(
            <span class="hljs-title function_ invoke__">encodeAbiParameters</span>(
                [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }],
                [intent.user, intent.tokenIn, intent.amountIn, intent.tokenOut, intent.minAmountOut, intent.nonce, intent.deadline]
            )
        );
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">signature</span> = await user.<span class="hljs-title function_ invoke__">signMessage</span>({ <span class="hljs-attr">message</span>: { <span class="hljs-attr">raw</span>: structHash } });

        <span class="hljs-comment">// 3. 执行测试</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用 simulateContract 尝试执行</span>
            await publicClient.<span class="hljs-title function_ invoke__">simulateContract</span>({
                <span class="hljs-attr">address</span>: IntentExecutor.address,
                <span class="hljs-attr">abi</span>: IntentExecutor.abi,
                <span class="hljs-attr">functionName</span>: <span class="hljs-string">'executeIntent'</span>,
                <span class="hljs-attr">args</span>: [intent, signature],
                <span class="hljs-attr">account</span>: solver.account,
            });
            assert.<span class="hljs-title function_ invoke__">fail</span>(<span class="hljs-string">"意图已过期，但合约未抛出异常"</span>);
        } <span class="hljs-keyword">catch</span> (error: any) {
            <span class="hljs-comment">// 在 2026 开发实践中，如果无法解析原因，我们通过排除法确认错误</span>
            <span class="hljs-comment">// 只要错误信息包含 "reverted" 或 "RPC error"，且我们已知 deadline 已过</span>
            <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">isReverted</span> = error.message.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"reverted"</span>) || 
                               error.details?.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"reverted"</span>) ||
                               error.message.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"RPC error"</span>);
            
            assert.<span class="hljs-title function_ invoke__">ok</span>(isReverted, `应该触发合约 Revert，实际收到: ${error.message}`);
            console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"✅ 成功捕获到过期导致的合约拦截 (即使 Hardhat 无法解析具体字符串)"</span>);
        }
    });
    <span class="hljs-title function_ invoke__">it</span>(<span class="hljs-string">"Nonce 不匹配应该防止重放攻击"</span>, async function () {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">deadline</span> = <span class="hljs-title function_ invoke__">BigInt</span>(Math.<span class="hljs-title function_ invoke__">floor</span>(Date.<span class="hljs-title function_ invoke__">now</span>() / <span class="hljs-number">1000</span>) + <span class="hljs-number">3600</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">intent</span> = {
            user: user.account.address,
            tokenIn: MockTokenA.address,
            amountIn: AMOUNT_IN,
            tokenOut: MockTokenB.address,
            minAmountOut: MIN_AMOUNT_OUT,
            nonce: <span class="hljs-number">0</span>n,
            deadline: deadline
        };

        <span class="hljs-comment">// 第一次执行成功</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">structHash</span> = <span class="hljs-title function_ invoke__">keccak256</span>(<span class="hljs-title function_ invoke__">encodeAbiParameters</span>(
            [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }],
            [intent.user, intent.tokenIn, intent.amountIn, intent.tokenOut, intent.minAmountOut, intent.nonce, intent.deadline]
        ));
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">signature</span> = await user.<span class="hljs-title function_ invoke__">signMessage</span>({ <span class="hljs-attr">message</span>: { <span class="hljs-attr">raw</span>: structHash } });
        await IntentExecutor.write.<span class="hljs-title function_ invoke__">executeIntent</span>([intent, signature], { <span class="hljs-attr">account</span>: solver.account });

        <span class="hljs-comment">// 尝试再次使用同一个意图/签名进行第二次执行</span>
        <span class="hljs-keyword">try</span> {
            await IntentExecutor.write.<span class="hljs-title function_ invoke__">executeIntent</span>([intent, signature], { <span class="hljs-attr">account</span>: solver.account });
            assert.<span class="hljs-title function_ invoke__">fail</span>(<span class="hljs-string">"不应允许重复使用同一个 Nonce"</span>);
        } <span class="hljs-keyword">catch</span> (error: any) {
            assert.<span class="hljs-title function_ invoke__">ok</span>(error.message.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"Invalid nonce"</span>), <span class="hljs-string">"应该提示 Nonce 无效"</span>);
        }
    });
});

</code></pre>
<h4 data-id="heading-8">三、 部署脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// scripts/deploy.js</span>
<span class="hljs-keyword">import</span> { network, artifacts } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 连接网络</span>
  <span class="hljs-keyword">const</span> { viem } = <span class="hljs-keyword">await</span> network.<span class="hljs-title function_">connect</span>({ <span class="hljs-attr">network</span>: network.<span class="hljs-property">name</span> });<span class="hljs-comment">//指定网络进行链接</span>
  
  <span class="hljs-comment">// 获取客户端</span>
  <span class="hljs-keyword">const</span> [deployer] = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getWalletClients</span>();
  <span class="hljs-keyword">const</span> publicClient = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getPublicClient</span>();
 
  <span class="hljs-keyword">const</span> deployerAddress = deployer.<span class="hljs-property">account</span>.<span class="hljs-property">address</span>;
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"部署者的地址:"</span>, deployerAddress);
  <span class="hljs-comment">// 加载合约</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenAArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"BoykaYuriToken"</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenBArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"BoykaYuriToken"</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">IntentExecutorArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"IntentExecutor"</span>);
 
  <span class="hljs-comment">// 部署（构造函数参数：recipient, initialOwner）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenAHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">BoykaYuriTokenAArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">BoykaYuriTokenAArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [deployerAddress,deployerAddress],<span class="hljs-comment">//部署者地址，初始所有者地址</span>
  });
   <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenAReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">BoykaYuriTokenAHash</span> });
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代币a合约地址:"</span>, <span class="hljs-title class_">BoykaYuriTokenAReceipt</span>.<span class="hljs-property">contractAddress</span>);
<span class="hljs-comment">//</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenBHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">BoykaYuriTokenBArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">BoykaYuriTokenBArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [deployerAddress,deployerAddress],<span class="hljs-comment">//部署者地址，初始所有者地址</span>
  });
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenBReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">BoykaYuriTokenBHash</span> });
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代币b合约地址:"</span>, <span class="hljs-title class_">BoykaYuriTokenBReceipt</span>.<span class="hljs-property">contractAddress</span>);
<span class="hljs-comment">//</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">IntentExecutorHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">IntentExecutorArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">IntentExecutorArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [],<span class="hljs-comment">//</span>
  });
  <span class="hljs-comment">// 等待确认并打印地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">IntentExecutorReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">IntentExecutorHash</span> });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"意图执行器合约地址:"</span>, <span class="hljs-title class_">IntentExecutorReceipt</span>.<span class="hljs-property">contractAddress</span>);
}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
</code></pre>
<hr/>
<h2 data-id="heading-9">七、 2026 DeFi 玩法的核心创新总结</h2>
<ol>
<li><strong>Gas 抽象化</strong>：用户只需“签名”，由求解者支付 Gas。这消除了用户钱包必须持有原生代币（如 ETH）的痛点。</li>
<li><strong>MEV 保护</strong>：意图交易通常在链下内存池（Match-making）完成撮合，减少了链上公开套利机会，保护用户免受夹击攻击。</li>
<li><strong>跨链无缝化</strong>：求解者可以在链 A 接收用户的代币，并在链 B 直接履行结果。用户无需感知跨链桥的存在。</li>
<li><strong>智能流动性</strong>：意图不再受限于单一池子，求解者可以动用 CEX 库存、OTC 渠道或其他链的流动性来满足用户的 <code>minAmountOut</code>。</li>
</ol>
<h2 data-id="heading-10">八、 结语</h2>
<p>意图金融标志着 Web3 交互从“编程模型”向“用户心理模型”的飞跃。到 2026 年，这种“只看结果，不问过程”的模式将使 DeFi 的体验真正媲美 Web2 银行应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次 CloudFront 缓存配置错误导致的用户数据泄露事故]]></title>    <link>https://juejin.cn/post/7603308967124598784</link>    <guid>https://juejin.cn/post/7603308967124598784</guid>    <pubDate>2026-02-06T03:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603308967124598784" data-draft-id="7603288778678534179" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次 CloudFront 缓存配置错误导致的用户数据泄露事故"/> <meta itemprop="keywords" content="前端,AWS"/> <meta itemprop="datePublished" content="2026-02-06T03:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="易码当先"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146916199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次 CloudFront 缓存配置错误导致的用户数据泄露事故
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146916199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    易码当先
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:41:45.000Z" title="Fri Feb 06 2026 03:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一次 CloudFront 缓存配置错误导致的用户数据泄露事故</h2>
<blockquote>
<p>记录一次由于 CDN 缓存配置不当，导致不同用户看到彼此私有数据的严重安全问题。</p>
</blockquote>
<h3 data-id="heading-1">🔥 事故的开端</h3>
<p>那是一个平常的下午，QA 同学在测试环境发现了一个诡异的现象：</p>
<p><strong>"为什么我的会话列表显示的是别人的数据？"</strong></p>
<p>起初我以为是前端缓存的问题，让他清除浏览器缓存试试。但是清除后问题依旧。更奇怪的是，当我用 curl 测试同一个接口时，返回的却是正确的数据。</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># curl 请求 - 返回正确数据</span>

curl <span class="hljs-string">'https://example.com/api/user/sessions'</span> \

    -H <span class="hljs-string">'authorization: Bearer TOKEN_A'</span>

<span class="hljs-comment"># 返回：用户 A 的数据（15 条会话）</span>

</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 浏览器 fetch - 返回错误数据</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://example.com/api/user/sessions'</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> }

})

  


<span class="hljs-comment">// 返回：用户 B 的数据（23 条会话）❌</span>

</code></pre>
<p>这下我意识到，问题可能没那么简单。</p>
<hr/>
<h3 data-id="heading-2">🕵️ 开始排查</h3>
<h4 data-id="heading-3">第一步：检查响应头</h4>
<p>我首先查看了浏览器请求的响应头：</p>
<pre><code class="hljs language-http" lang="http">
HTTP/2 200

cache-control: (null) ⚠️

x-cache: Hit from cloudfront ⚠️

age: 1545 ⚠️

via: 1.1 xxx.cloudfront.net (CloudFront)

</code></pre>
<p>看到这三个关键信息，我心里一凉：</p>
<ol>
<li>
<p><strong>cache-control 为空</strong> - 后端没有设置缓存控制策略</p>
</li>
<li>
<p><strong>x-cache: Hit from cloudfront</strong> - 请求命中了 CloudFront 缓存</p>
</li>
<li>
<p><strong>age: 1545</strong> - 这个缓存已经存在了 1545 秒（约 26 分钟）</p>
</li>
</ol>
<p>问题找到了：<strong>CloudFront 把用户的私有数据缓存了！</strong></p>
<h4 data-id="heading-4">第二步：验证假设</h4>
<p>我用不同的方式测试了几次：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 测试 1: 不带 Cookie，只带 Authorization</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> },

    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'omit'</span>

})

<span class="hljs-comment">// 结果：返回用户 B 的数据（缓存）</span>


<span class="hljs-comment">// 测试 2: 带上 Cookie</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> },

    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>

})

<span class="hljs-comment">// 结果：还是用户 B 的数据（缓存）</span>


<span class="hljs-comment">// 测试 3: 添加随机参数绕过缓存</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/sessions?_t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> }

})

<span class="hljs-comment">// 结果：返回正确的用户 A 数据 ✓</span>

</code></pre>
<p>第三个测试证实了我的猜测：CloudFront 缓存键中没有包含 Authorization header！</p>
<hr/>
<h3 data-id="heading-5">💡 问题根源分析</h3>
<h4 data-id="heading-6">我们的系统架构</h4>
<pre><code class="hljs language-javascript" lang="javascript">
用户浏览器

↓ 请求: <span class="hljs-regexp">/api/u</span>ser/sessions

↓ <span class="hljs-title class_">Header</span>: <span class="hljs-title class_">Authorization</span>: <span class="hljs-title class_">Bearer</span> &lt;token&gt;

<span class="hljs-title class_">CloudFront</span> <span class="hljs-variable constant_">CDN</span> (全球边缘节点)

↓ 缓存键 = 域名 + <span class="hljs-variable constant_">URL</span> 路径

↓ ⚠️ 不包含 <span class="hljs-title class_">Authorization</span> header!

前端服务器

↓ <span class="hljs-title class_">Rewrite</span>: <span class="hljs-regexp">/api/</span>* → backend-api.<span class="hljs-property">com</span><span class="hljs-comment">/*

后端 API 服务器

↓ 根据 Authorization 识别用户

↓ 返回对应用户的数据

</span></code></pre>
<h4 data-id="heading-7">CloudFront 默认缓存行为</h4>
<p>CloudFront 默认的缓存键由以下部分组成：</p>
<pre><code class="hljs">
缓存键 = 域名 + URL 路径 + 查询参数

</code></pre>
<p><strong>不包含：</strong></p>
<ul>
<li>
<p>❌ 请求头（包括 Authorization）</p>
</li>
<li>
<p>❌ Cookie（除非显式配置）</p>
</li>
<li>
<p>❌ 请求体</p>
</li>
</ul>
<h4 data-id="heading-8">问题是如何发生的？</h4>
<p>让我用时间线来还原整个过程：</p>
<pre><code class="hljs language-makefile" lang="makefile">
<span class="hljs-section">10:00 - 用户 A 登录，token_A</span>

<span class="hljs-section">10:01 - 用户 A 请求 /api/user/sessions</span>

        → CloudFront: 缓存 Miss

        → 转发到后端，带上 Authorization: Bearer token_A

        → 后端识别用户 A，返回用户 A 的数据

        → CloudFront 缓存这个响应（缓存键 = /api/user/sessions）

  


<span class="hljs-section">10:15 - 用户 B 登录，token_B</span>

<span class="hljs-section">10:16 - 用户 B 请求 /api/user/sessions</span>

        → CloudFront: 缓存 Hit! (因为 URL 相同)

        → 直接返回缓存（用户 A 的数据）❌

        → 请求根本没有到达后端

        → 后端无法识别 token_B

</code></pre>
<p><strong>这就是问题的本质：不同用户请求同一个 URL，CloudFront 认为它们是同一个请求，直接返回了缓存的内容。</strong></p>
<hr/>
<h3 data-id="heading-9">🤔 为什么 curl 返回正确数据？</h3>
<p>这是一个有趣的问题。可能的原因：</p>
<ol>
<li>
<p><strong>请求头差异</strong>：curl 和浏览器的请求头不同，可能形成了不同的缓存键</p>
</li>
<li>
<p><strong>时机问题</strong>：curl 测试时缓存可能已经过期</p>
</li>
<li>
<p><strong>Vary 响应头</strong>：如果后端设置了某些 Vary 头，curl 可能命中了不同的缓存</p>
</li>
</ol>
<p>但无论如何，<strong>这都说明了缓存策略的不确定性和危险性</strong>。</p>
<hr/>
<h3 data-id="heading-10">🔧 解决方案探索</h3>
<h4 data-id="heading-11">方案对比</h4>
<p>我考虑了三个方案：</p>
<h5 data-id="heading-12">方案 1：修改 CloudFront Cache Policy，将 Authorization 加入缓存键</h5>
<p><strong>想法</strong>：让每个 token 有独立的缓存。</p>
<p><strong>问题</strong>：</p>
<pre><code class="hljs language-css" lang="css">
用户 <span class="hljs-selector-tag">A</span> (token_A) → 缓存 <span class="hljs-selector-tag">A</span>

用户 <span class="hljs-selector-tag">B</span> (token_B) → 缓存 <span class="hljs-selector-tag">B</span>

...

</code></pre>
<ul>
<li>
<p>❌ 用户数据仍然会被缓存在 CDN 边缘节点（安全风险）</p>
</li>
<li>
<p>❌ 缓存数量爆炸（每个用户一份缓存）</p>
</li>
<li>
<p>❌ 如果 token 刷新，缓存会失效，浪费资源</p>
</li>
<li>
<p>❌ 需要修改 CloudFront 配置（由于我们有前端 rewrite，很容易配错导致 502）</p>
</li>
</ul>
<p><strong>结论</strong>：不推荐</p>
<h5 data-id="heading-13">方案 2：在 CloudFront 禁用 /api/* 路径的缓存</h5>
<p><strong>想法</strong>：直接禁用 API 路径的缓存。</p>
<p><strong>问题</strong>：</p>
<ul>
<li>
<p>⚠️ 由于我们的架构（前端服务器做了 rewrite），配置 <code>/api/*</code> 的 Cache Behavior 会绕过前端服务器，直接转发到后端</p>
</li>
<li>
<p>💥 后端没有 <code>/api/*</code> 这个路径，导致 502 错误（我们实际遇到了这个问题）</p>
</li>
</ul>
<p><strong>结论</strong>：不适用于我们的架构</p>
<h5 data-id="heading-14">方案 3：在后端设置 Cache-Control 响应头 ⭐</h5>
<p><strong>想法</strong>：让后端明确告诉 CloudFront："这个响应不要缓存！"</p>
<pre><code class="hljs language-http" lang="http">
Cache-Control: private, no-cache, no-store, must-revalidate

Pragma: no-cache

Expires: 0

</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>
<p>✅ 最根本的解决方案</p>
</li>
<li>
<p>✅ 不需要修改 CloudFront 配置</p>
</li>
<li>
<p>✅ 对所有中间层（CDN、代理、浏览器）都生效</p>
</li>
<li>
<p>✅ 符合 HTTP 标准和最佳实践</p>
</li>
</ul>
<p><strong>结论</strong>：采用！</p>
<hr/>
<h3 data-id="heading-15">🛠️ 具体实现</h3>
<h4 data-id="heading-16">1. 后端添加中间件</h4>
<p>我们使用 Go + Gin 框架，实现很简单：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// middleware/nocache.go</span>

<span class="hljs-keyword">package</span> middleware

<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NoCacheMiddleware</span><span class="hljs-params">()</span></span> gin.HandlerFunc {

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {

        c.Header(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"private, no-cache, no-store, must-revalidate"</span>)

        c.Header(<span class="hljs-string">"Pragma"</span>, <span class="hljs-string">"no-cache"</span>)

        c.Header(<span class="hljs-string">"Expires"</span>, <span class="hljs-string">"0"</span>)

        c.Next()

    }

}

</code></pre>
<p>在路由中应用：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// router/router.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetupRouter</span><span class="hljs-params">()</span></span> *gin.Engine {

    r := gin.Default()

    <span class="hljs-comment">// 对所有需要身份验证的路由应用</span>

    authRoutes := r.Group(<span class="hljs-string">"/"</span>)

    authRoutes.Use(middleware.AuthMiddleware())

    authRoutes.Use(middleware.NoCacheMiddleware()) <span class="hljs-comment">// 关键！</span>

    {

        authRoutes.GET(<span class="hljs-string">"/user/sessions"</span>, handlers.GetUserSessions)

        authRoutes.GET(<span class="hljs-string">"/user/quota"</span>, handlers.GetUserQuota)

        authRoutes.GET(<span class="hljs-string">"/user/profile"</span>, handlers.GetUserProfile)

    }

    <span class="hljs-keyword">return</span> r

}

</code></pre>
<h4 data-id="heading-17">2. 清除 CloudFront 现有缓存</h4>
<p>代码部署后，还需要清除已经存在的缓存：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># AWS CLI 方式</span>

aws cloudfront create-invalidation \

    --distribution-id E1234567890ABC \

    --paths <span class="hljs-string">"/*"</span>


<span class="hljs-comment"># 或者在 AWS Console 中操作：</span>

<span class="hljs-comment"># CloudFront → Distributions → Invalidations → Create</span>

<span class="hljs-comment"># Path: /*</span>

</code></pre>
<h4 data-id="heading-18">3. 验证修复</h4>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 等待 5-10 分钟后测试</span>

curl -I <span class="hljs-string">'https://example.com/api/user/sessions'</span> \

    -H <span class="hljs-string">'authorization: Bearer YOUR_TOKEN'</span>

</code></pre>
<p>期望看到：</p>
<pre><code class="hljs language-http" lang="http">
HTTP/2 200

cache-control: private, no-cache, no-store, must-revalidate ✓

pragma: no-cache ✓

expires: 0 ✓

x-cache: Miss from cloudfront ✓

age: (不存在) ✓

</code></pre>
<p>多次请求应该都是 <code>Miss from cloudfront</code>，而不是 <code>Hit</code>。</p>
<hr/>
<h3 data-id="heading-19">📚 深入理解 Cache-Control</h3>
<p>这次事故让我重新审视了 HTTP 缓存机制。让我详细解释一下这些响应头：</p>
<h4 data-id="heading-20">Cache-Control 指令详解</h4>
<pre><code class="hljs language-http" lang="http">
Cache-Control: private, no-cache, no-store, must-revalidate

</code></pre>
<ul>
<li>
<p><strong><code>private</code></strong>：响应只能被浏览器缓存，不能被 CDN 等共享缓存存储</p>
</li>
<li>
<p>即使后续有人设置了代理缓存，也不会缓存这个响应</p>
</li>
<li>
<p><strong><code>no-cache</code></strong>：可以缓存，但使用前必须向服务器验证</p>
</li>
<li>
<p>看起来矛盾？其实是"not without revalidation"的意思</p>
</li>
<li>
<p>主要用于需要实时验证但允许存储的场景</p>
</li>
<li>
<p><strong><code>no-store</code></strong>：完全不缓存，任何情况下都不存储</p>
</li>
<li>
<p>最严格的禁止缓存指令</p>
</li>
<li>
<p>用于高度敏感的数据</p>
</li>
<li>
<p><strong><code>must-revalidate</code></strong>：缓存过期后必须向服务器验证，不能使用过期内容</p>
</li>
<li>
<p>防止在网络故障时使用过期缓存</p>
</li>
</ul>
<h4 data-id="heading-21">Pragma 和 Expires</h4>
<pre><code class="hljs language-http" lang="http">
Pragma: no-cache

Expires: 0

</code></pre>
<p>这两个是为了兼容 HTTP/1.0 的老旧客户端和代理服务器。虽然现在大多数系统都支持 HTTP/1.1，但加上它们没有坏处。</p>
<h4 data-id="heading-22">为什么需要这么多指令？</h4>
<p>因为缓存层级很多：</p>
<pre><code class="hljs">
浏览器缓存

↓

正向代理（公司代理）

↓

CDN 边缘节点

↓

CDN 中心节点

↓

反向代理（Nginx）

↓

后端服务器

</code></pre>
<p>每一层都可能缓存，所以需要明确告诉它们："这个响应不要缓存！"</p>
<hr/>
<h3 data-id="heading-23">🎯 经验教训</h3>
<h4 data-id="heading-24">1. 用户数据永远不要被 CDN 缓存</h4>
<p><strong>原则：需要身份验证的接口 = 私有数据 = 禁止缓存</strong></p>
<p>即使你认为"缓存可以提高性能"，也不要这样做。因为：</p>
<ul>
<li>
<p>用户数据随时可能变化</p>
</li>
<li>
<p>Token 可能被刷新或撤销</p>
</li>
<li>
<p>存在数据泄露风险</p>
</li>
<li>
<p>可能违反数据保护法规（GDPR、CCPA）</p>
</li>
</ul>
<h4 data-id="heading-25">2. 明确区分可缓存和不可缓存的内容</h4>
<p>在设计 API 时，就应该考虑缓存策略：</p>
<pre><code class="hljs language-bash" lang="bash">
✓ 可以缓存：

    /public/articles - 公开文章列表

    /static/logo.png - 静态资源

    /api/public/config - 公开配置

  


✗ 禁止缓存：

    /api/user/* - 用户数据

    /api/auth/* - 认证相关

    /api/admin/* - 管理接口

</code></pre>
<h4 data-id="heading-26">3. 不要依赖 CDN 的默认行为</h4>
<p>CloudFront 的默认缓存策略是：</p>
<ul>
<li>
<p>对 GET/HEAD 请求缓存成功的响应（200、301、404 等）</p>
</li>
<li>
<p>缓存键只包含 URL 和查询参数</p>
</li>
</ul>
<p><strong>这对静态资源很好，但对 API 可能是灾难。</strong></p>
<h4 data-id="heading-27">4. 后端要对响应负责</h4>
<p>不要期望运维或前端来配置正确的缓存策略。后端应该明确告诉客户端和中间层如何处理响应：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 好的做法：创建统一的响应函数</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RespondJSON</span><span class="hljs-params">(c *gin.Context, code <span class="hljs-type">int</span>, data <span class="hljs-keyword">interface</span>{})</span></span> {

    <span class="hljs-comment">// 自动添加安全的响应头</span>

    c.Header(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"private, no-cache, no-store, must-revalidate"</span>)

    c.Header(<span class="hljs-string">"Pragma"</span>, <span class="hljs-string">"no-cache"</span>)

    c.Header(<span class="hljs-string">"Expires"</span>, <span class="hljs-string">"0"</span>)

    c.JSON(code, data)

}

</code></pre>
<h4 data-id="heading-28">5. 测试要覆盖缓存场景</h4>
<p>在测试用例中应该包含：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// test/api-cache.test.js</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'API Caching'</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not cache user data'</span>, <span class="hljs-keyword">async</span> () =&gt; {

        <span class="hljs-comment">// 第一次请求</span>

        <span class="hljs-keyword">const</span> res1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

            <span class="hljs-attr">headers</span>: { <span class="hljs-attr">authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token1}</span>`</span> }

        });

        <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">await</span> res1.<span class="hljs-title function_">json</span>();

        <span class="hljs-comment">// 第二次请求（不同用户）</span>

        <span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

            <span class="hljs-attr">headers</span>: { <span class="hljs-attr">authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token2}</span>`</span> }

        });

        <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">await</span> res2.<span class="hljs-title function_">json</span>();

        <span class="hljs-comment">// 验证返回的是不同用户的数据</span>

        <span class="hljs-title function_">expect</span>(data1.<span class="hljs-property">userId</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toBe</span>(data2.<span class="hljs-property">userId</span>);

        <span class="hljs-comment">// 验证响应头</span>

        <span class="hljs-title function_">expect</span>(res1.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'cache-control'</span>)).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'no-cache'</span>);

        <span class="hljs-title function_">expect</span>(res2.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'cache-control'</span>)).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'no-cache'</span>);

    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not be cached by CDN'</span>, <span class="hljs-keyword">async</span> () =&gt; {

        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

        <span class="hljs-attr">headers</span>: { <span class="hljs-attr">authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span> }

        });

        <span class="hljs-comment">// 验证没有命中 CDN 缓存</span>

        <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'x-cache'</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Miss from cloudfront'</span>);

        <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'age'</span>)).<span class="hljs-title function_">toBeNull</span>();

    });

});

</code></pre>
<hr/>
<h3 data-id="heading-29">🔍 排查技巧分享</h3>
<h4 data-id="heading-30">如何快速判断是否是缓存问题？</h4>
<p><strong>1. 查看响应头</strong></p>
<pre><code class="hljs language-bash" lang="bash">
curl -I <span class="hljs-string">'https://example.com/api/user/sessions'</span> \

    -H <span class="hljs-string">'authorization: Bearer TOKEN'</span>

</code></pre>
<p>关键字段：</p>
<ul>
<li>
<p><code>x-cache: Hit</code> - 命中缓存</p>
</li>
<li>
<p><code>age: 数字</code> - 缓存存在的时间</p>
</li>
<li>
<p><code>cache-control: null</code> - 没有缓存策略（危险！）</p>
</li>
</ul>
<p><strong>2. 添加随机参数测试</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 如果这个返回正确数据，说明是缓存问题</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/sessions?_t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>)

</code></pre>
<p><strong>3. 使用不同的客户端测试</strong></p>
<ul>
<li>
<p>浏览器 → 可能命中缓存</p>
</li>
<li>
<p>curl → 可能绕过缓存</p>
</li>
<li>
<p>Postman → 可能有独立的缓存</p>
</li>
</ul>
<p>如果不同客户端返回不同的数据，很可能是缓存问题。</p>
<h4 data-id="heading-31">使用 Chrome DevTools 检查</h4>
<ol>
<li>
<p>打开 Network 标签</p>
</li>
<li>
<p>刷新页面</p>
</li>
<li>
<p>点击对应的请求</p>
</li>
<li>
<p>查看 Response Headers</p>
</li>
</ol>
<p>重点关注：</p>
<ul>
<li>
<p><code>CF-Cache-Status: HIT</code> (Cloudflare)</p>
</li>
<li>
<p><code>X-Cache: Hit from cloudfront</code> (CloudFront)</p>
</li>
<li>
<p><code>X-Cache-Lookup: HIT from xxx</code> (其他 CDN)</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-32">🛡️ 预防措施</h3>
<h4 data-id="heading-33">1. 建立监控告警</h4>
<p><strong>监控指标</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// CloudWatch Logs Insights 查询</span>

fields @timestamp, request_path, cache_status

| filter cache_status = <span class="hljs-string">"Hit"</span>

and request_path like /^\/api\<span class="hljs-comment">//</span>

and request_path not like /^\/api\/public\<span class="hljs-comment">//</span>

| stats <span class="hljs-title function_">count</span>() by request_path

</code></pre>
<p><strong>告警规则</strong>：</p>
<ul>
<li>
<p>如果私有 API 出现缓存命中 → 立即告警</p>
</li>
<li>
<p>如果 API 响应缺少 <code>Cache-Control</code> 头 → 告警</p>
</li>
</ul>
<h4 data-id="heading-34">2. 代码审查检查项</h4>
<p>在 Code Review 时，检查：</p>
<ul class="contains-task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled="disabled"/> 新的 API endpoint 是否添加了 no-cache 响应头？</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled="disabled"/> 是否使用了统一的响应函数？</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled="disabled"/> 是否有测试覆盖缓存场景？</p>
</li>
</ul>
<h4 data-id="heading-35">3. 架构层面的防护</h4>
<p><strong>前端服务器添加安全响应头</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// next.config.js</span>

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">headers</span>(<span class="hljs-params"/>) {

        <span class="hljs-keyword">return</span> [

            {

                <span class="hljs-attr">source</span>: <span class="hljs-string">'/api/:path*'</span>,

                <span class="hljs-attr">headers</span>: [

                    {

                        <span class="hljs-attr">key</span>: <span class="hljs-string">'Cache-Control'</span>,

                        <span class="hljs-attr">value</span>: <span class="hljs-string">'private, no-cache, no-store, must-revalidate'</span>,

                    },

                ],

            },

        ];

    },

};

</code></pre>
<p>这样即使后端忘记设置，前端也会添加安全的响应头（双重保险）。</p>
<h4 data-id="heading-36">4. 定期安全审计</h4>
<p>每个季度检查：</p>
<ul>
<li>
<p>哪些 API 可以被缓存？</p>
</li>
<li>
<p>缓存的内容是否包含敏感信息？</p>
</li>
<li>
<p>CDN 配置是否正确？</p>
</li>
<li>
<p>是否有新的 API 没有设置缓存策略？</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-37">📊 影响分析</h3>
<p>这次事故的影响范围：</p>
<h4 data-id="heading-38">受影响的接口</h4>
<p>我们排查了所有 API，发现以下接口都有同样的问题：</p>
<pre><code class="hljs language-bash" lang="bash">
✓ 已修复：

/api/user/sessions - 用户会话列表

/api/user/quota - 用户配额

/api/user/profile - 用户资料

/api/user/settings - 用户设置

</code></pre>
<h4 data-id="heading-39">潜在的数据泄露</h4>
<ul>
<li>
<p><strong>时间窗口</strong>：从部署到发现，约 2 周</p>
</li>
<li>
<p><strong>受影响用户</strong>：所有活跃用户</p>
</li>
<li>
<p><strong>泄露数据类型</strong>：会话信息、配额使用情况、用户设置</p>
</li>
<li>
<p><strong>严重程度</strong>：高（虽然没有密码等核心数据，但仍然是隐私信息）</p>
</li>
</ul>
<h4 data-id="heading-40">合规性问题</h4>
<p>根据 GDPR 和 CCPA：</p>
<ul>
<li>
<p>用户数据被缓存在第三方服务器（CloudFront 边缘节点）</p>
</li>
<li>
<p>用户没有被告知数据会被如此处理</p>
</li>
<li>
<p>存在未经授权的数据访问</p>
</li>
</ul>
<p>幸运的是，我们在测试环境发现了这个问题，没有影响到生产环境。</p>
<hr/>
<h3 data-id="heading-41">💭 反思</h3>
<h4 data-id="heading-42">为什么会犯这个错误？</h4>
<ol>
<li><strong>对 CDN 的理解不够深入</strong></li>
</ol>
<ul>
<li>
<p>我们知道 CDN 会缓存，但没想到会缓存 API 响应</p>
</li>
<li>
<p>以为"有 Authorization header 就不会缓存"</p>
</li>
</ul>
<ol start="2">
<li><strong>缺少完整的测试</strong></li>
</ol>
<ul>
<li>
<p>功能测试只关注"能否返回正确数据"</p>
</li>
<li>
<p>没有测试"不同用户是否会看到彼此的数据"</p>
</li>
</ul>
<ol start="3">
<li><strong>架构变更时没有充分评估</strong></li>
</ol>
<ul>
<li>
<p>引入 CloudFront 时，只考虑了性能提升</p>
</li>
<li>
<p>没有评估对 API 的影响</p>
</li>
</ul>
<ol start="4">
<li><strong>缺少安全意识</strong></li>
</ol>
<ul>
<li>
<p>没有建立"默认禁止缓存私有数据"的原则</p>
</li>
<li>
<p>没有代码规范要求必须设置 Cache-Control</p>
</li>
</ul>
<h4 data-id="heading-43">如果重来一次，我会怎么做？</h4>
<ol>
<li><strong>在架构设计阶段就明确缓存策略</strong></li>
</ol>
<pre><code class="hljs">
静态资源 → CDN 缓存

公开 API → CDN 缓存（短时间）

私有 API → 禁止缓存

</code></pre>
<ol start="2">
<li><strong>建立统一的响应规范</strong></li>
</ol>
<ul>
<li>
<p>创建标准的响应函数</p>
</li>
<li>
<p>自动添加正确的响应头</p>
</li>
<li>
<p>不允许手动设置响应头</p>
</li>
</ul>
<ol start="3">
<li><strong>完善测试覆盖</strong></li>
</ol>
<ul>
<li>
<p>添加缓存测试用例</p>
</li>
<li>
<p>添加跨用户数据隔离测试</p>
</li>
<li>
<p>在 CI/CD 中检查响应头</p>
</li>
</ul>
<ol start="4">
<li><strong>部署前的安全审计</strong></li>
</ol>
<ul>
<li>
<p>检查所有新的 API endpoint</p>
</li>
<li>
<p>验证响应头是否正确</p>
</li>
<li>
<p>使用不同用户 token 测试</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-44">🎓 拓展阅读</h3>
<h4 data-id="heading-45">关于 HTTP 缓存</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FCaching" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching" ref="nofollow noopener noreferrer">MDN - HTTP 缓存</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7234" target="_blank" title="https://tools.ietf.org/html/rfc7234" ref="nofollow noopener noreferrer">RFC 7234 - HTTP/1.1 Caching</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fhttp-cache%2F" target="_blank" title="https://web.dev/http-cache/" ref="nofollow noopener noreferrer">Web.dev - HTTP Caching</a></p>
</li>
</ul>
<h4 data-id="heading-46">关于 CloudFront</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2FAmazonCloudFront%2Flatest%2FDeveloperGuide%2Fcontrolling-the-cache-key.html" target="_blank" title="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/controlling-the-cache-key.html" ref="nofollow noopener noreferrer">CloudFront 缓存键和策略</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2FAmazonCloudFront%2Flatest%2FDeveloperGuide%2FResponseHeadersPolicies.html" target="_blank" title="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/ResponseHeadersPolicies.html" ref="nofollow noopener noreferrer">CloudFront 响应头策略</a></p>
</li>
</ul>
<h4 data-id="heading-47">关于 Web 安全</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fowasp.org%2Fwww-project-top-ten%2F" target="_blank" title="https://owasp.org/www-project-top-ten/" ref="nofollow noopener noreferrer">OWASP Top 10</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fowasp.org%2Fwww-project-api-security%2F" target="_blank" title="https://owasp.org/www-project-api-security/" ref="nofollow noopener noreferrer">OWASP API Security Top 10</a></p>
</li>
</ul>
<hr/>
<h3 data-id="heading-48">✨ 总结</h3>
<p>这次事故给我上了深刻的一课：</p>
<p><strong>1. CDN 是双刃剑</strong></p>
<ul>
<li>
<p>能提升性能，但配置不当会导致严重的安全问题</p>
</li>
<li>
<p>理解 CDN 的缓存机制是必须的</p>
</li>
</ul>
<p><strong>2. 后端要明确告诉客户端如何处理响应</strong></p>
<ul>
<li>
<p>不要依赖默认行为</p>
</li>
<li>
<p>使用 <code>Cache-Control</code> 明确控制缓存策略</p>
</li>
</ul>
<p><strong>3. 安全测试很重要</strong></p>
<ul>
<li>
<p>功能测试 + 安全测试</p>
</li>
<li>
<p>不同用户的数据隔离测试</p>
</li>
</ul>
<p><strong>4. 建立防护机制</strong></p>
<ul>
<li>
<p>监控告警</p>
</li>
<li>
<p>代码规范</p>
</li>
<li>
<p>自动化检查</p>
</li>
</ul>
<h4 data-id="heading-49">核心原则</h4>
<blockquote>
<p><strong>需要身份验证的 API，永远不要被 CDN 缓存。</strong></p>
</blockquote>
<p>如果你的系统也使用了 CloudFront、Cloudflare 或其他 CDN，建议立即检查一下你的 API 响应头。方法很简单：</p>
<pre><code class="hljs language-bash" lang="bash">
curl -I <span class="hljs-string">'https://your-api.com/api/user/data'</span> \

-H <span class="hljs-string">'authorization: Bearer YOUR_TOKEN'</span> \

| grep -i cache

</code></pre>
<p>如果看到 <code>x-cache: Hit</code> 或者 <code>cache-control: null</code>，那你可能也面临同样的问题。</p>
<hr/>
<h3 data-id="heading-50">🙏 致谢</h3>
<p>感谢 QA 团队发现了这个问题，感谢团队快速响应和修复。这次事故虽然是在测试环境发现的，但也提醒我们：</p>
<p><strong>再小的问题也可能导致严重的后果，安全无小事。</strong></p>
<hr/>
<p><strong>你遇到过类似的缓存问题吗？欢迎在评论区分享你的经验。</strong></p>
<hr/>
<p><em>本文技术栈：CloudFront + Next.js + Go，但原理适用于所有 CDN + API 的架构。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chrome 浏览器底层架构学习笔记（补充篇）]]></title>    <link>https://juejin.cn/post/7603309951226298418</link>    <guid>https://juejin.cn/post/7603309951226298418</guid>    <pubDate>2026-02-06T05:35:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951226298418" data-draft-id="7603283691457101834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome 浏览器底层架构学习笔记（补充篇）"/> <meta itemprop="keywords" content="Chrome"/> <meta itemprop="datePublished" content="2026-02-06T05:35:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会敲代码1"/> <meta itemprop="url" content="https://juejin.cn/user/1927884034804425"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome 浏览器底层架构学习笔记（补充篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927884034804425/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会敲代码1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:35:00.000Z" title="Fri Feb 06 2026 05:35:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Chrome 浏览器底层架构学习笔记（补充篇）</h2>
<h3 data-id="heading-1">九、进程与线程的执行模式对比</h3>
<p>在理解 Chrome 的多进程架构时，理解<strong>单线程</strong>与<strong>多线程</strong>的执行差异至关重要。</p>
<h4 data-id="heading-2">1. 单线程处理模型（进程 A）</h4>
<p>在单线程模型中，所有任务都按顺序在一个线程中执行：</p>
<pre><code class="hljs language-css" lang="css">时间线：任务<span class="hljs-number">1</span> → 任务<span class="hljs-number">2</span> → 任务<span class="hljs-number">3</span> → 任务<span class="hljs-number">4</span> → 显示结果
       <span class="hljs-selector-attr">[主线程依次执行所有任务]</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>简单易实现，避免并发冲突</li>
<li>但 CPU 利用率低，一个耗时任务会阻塞后续所有任务</li>
<li>早期的 JavaScript 执行环境采用这种模型</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13c194f611b743368f3a55cf549f46ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=OLc55NTHjgwFBRFUUOQWxFwd0uw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 多线程处理模型（进程 B）</h4>
<p>在多线程模型中，任务可以并行分配给不同线程：</p>
<pre><code class="hljs language-scss" lang="scss">时间线：
线程<span class="hljs-number">1</span>：任务<span class="hljs-number">1</span>(<span class="hljs-number">1</span>+<span class="hljs-number">2</span>)
线程<span class="hljs-number">2</span>：任务<span class="hljs-number">2</span>(<span class="hljs-number">20</span>/<span class="hljs-number">5</span>)
线程<span class="hljs-number">3</span>：任务<span class="hljs-number">3</span>(<span class="hljs-number">7</span>*<span class="hljs-number">8</span>)
<span class="hljs-selector-attr">[所有线程并行执行]</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>充分利用多核 CPU，提高执行效率</li>
<li>复杂任务可并行处理，减少总执行时间</li>
<li>但需要处理线程同步和资源竞争问题</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f70352a512dd44e9b7d5ec05a7914ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=NtxnAszYK45k%2FiNSLqB9fOQSa28%3D" alt="image.png" loading="lazy"/></p>
<p><strong>示例计算任务：</strong></p>
<ul>
<li>任务1: 1+2 = 3</li>
<li>任务2: 20/5 = 4</li>
<li>任务3: 7*8 = 56</li>
</ul>
<p>在单线程中，这三个计算需要顺序执行；而在多线程中，它们可以同时进行。</p>
<h3 data-id="heading-4">十、线程间的数据共享与通信</h3>
<p>多线程模型中，一个重要概念是<strong>线程共享进程资源</strong>。这意味着：</p>
<h4 data-id="heading-5">1. 共享内存空间</h4>
<p>多个线程可以访问进程的同一内存区域，这需要<strong>线程同步机制</strong>来避免数据冲突。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af581f23796146f38da2e5cd5bfe1f51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=huKVHvRa5HYs%2BFjdlJwR1AegOMQ%3D" alt="屏幕截图 2026-02-05 191232.png" loading="lazy"/></p>
<h4 data-id="heading-6">2. 线程同步示例</h4>
<p>如示意图所示，当多个线程需要写入共享变量"A"时：</p>
<ul>
<li>线程1可能写入值3</li>
<li>线程2可能执行1+2的计算</li>
<li>需要同步机制确保数据一致性</li>
</ul>
<h3 data-id="heading-7">十一、单进程浏览器 vs 多进程浏览器</h3>
<h4 data-id="heading-8">1. 单进程浏览器架构</h4>
<p>早期的浏览器（如旧版 IE）采用单进程架构：</p>
<pre><code class="hljs language-markdown" lang="markdown">单进程浏览器
├── 代码区
├── 数据区
├── 文件区
└── 线程：
<span class="hljs-code">    ├── 网络线程
    ├── 页面线程（核心）
    │   ├── 页面渲染
    │   ├── 页面展现
    │   ├── JavaScript环境
    │   └── 插件运行
    └── 其他线程
</span></code></pre>
<p><strong>问题：</strong></p>
<ul>
<li><strong>稳定性差</strong>：一个标签页崩溃会导致整个浏览器崩溃</li>
<li><strong>安全性低</strong>：恶意页面可能访问其他页面数据</li>
<li><strong>性能瓶颈</strong>：所有任务共享同一个进程资源</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24db6861d56469289bb264cc6244355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=J7SYwwz2fYgchgTMuwDQHc2230c%3D" alt="屏幕截图 2026-02-05 191958.png" loading="lazy"/></p>
<h4 data-id="heading-9">2. 现代 Chrome 的多进程架构</h4>
<p>Chrome 将不同功能模块拆分为独立的进程：</p>
<pre><code class="hljs language-scss" lang="scss">Chrome 多进程架构：
┌─────────────────────────────────────┐
│        浏览器主进程                  │
│  (Browser Process)                  │
│  • 界面管理                         │
│  • 用户交互                         │
│  • 子进程管理                       │
└───────────┬─────────────────────────┘
            │ IPC通信
┌───────────┼─────────────────────────┐
│ 渲染进程  │  网络进程   │  GPU进程   │
│ (多个)    │ (独立)     │ (独立)     │
│ • 页面渲染│ • 资源加载 │ • 图形处理 │
│ • JS执行  │           │ • <span class="hljs-number">3</span>D加速   │
└───────────┴───────────┴─────────────┘
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>稳定性增强</strong>：单个页面崩溃不影响其他页面</li>
<li><strong>安全性提升</strong>：进程间内存隔离，沙箱机制</li>
<li><strong>性能优化</strong>：专用进程处理专门任务</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/686169a0bdce47329575fdbfdd5bd3ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=JKebnXHIlJIpphelL2SgBUodkAQ%3D" alt="屏幕截图 2026-02-05 193001.png" loading="lazy"/></p>
<h3 data-id="heading-10">十二、Chrome 进程架构演进细节</h3>
<h4 data-id="heading-11">1. 进程独立化趋势</h4>
<p>Chrome 在发展过程中，逐渐将关键功能从浏览器主进程中独立出来：</p>
<ul>
<li><strong>网络进程</strong>：原本属于浏览器进程，现独立以优化网络请求处理</li>
<li><strong>GPU进程</strong>：为支持更复杂的图形渲染和硬件加速而独立</li>
<li><strong>存储进程</strong>：专门处理本地存储和缓存</li>
</ul>
<h4 data-id="heading-12">2. 沙箱（Sandbox）安全机制</h4>
<p>在支持的系统上，Chrome 为渲染进程等启用沙箱机制：</p>
<ul>
<li>限制进程的权限，防止恶意代码访问系统资源</li>
<li>即使渲染进程被攻破，攻击者也难以突破沙箱限制</li>
</ul>
<h3 data-id="heading-13">十三、对前端开发的启示</h3>
<h4 data-id="heading-14">1. 性能优化策略</h4>
<ul>
<li><strong>减少主线程阻塞</strong>：避免长时间的 JavaScript 计算</li>
<li><strong>合理使用 Web Workers</strong>：将计算密集型任务移至后台线程</li>
<li><strong>注意内存管理</strong>：页面关闭时进程会释放内存，但长时间运行的 SPA 需注意内存泄漏</li>
</ul>
<h4 data-id="heading-15">2. 调试技巧</h4>
<ul>
<li>使用 Chrome 任务管理器识别内存泄漏</li>
<li>通过 <code>chrome://process-internals</code> 查看详细进程信息</li>
<li>利用 Performance 面板分析页面线程活动</li>
</ul>
<h3 data-id="heading-16">十四、总结：Chrome 架构设计的演进思想</h3>
<p>Chrome 的多进程架构代表了现代浏览器的发展方向：</p>
<ol>
<li><strong>模块化</strong>：将复杂系统拆分为独立的、功能单一的模块</li>
<li><strong>隔离性</strong>：通过进程隔离提高安全性和稳定性</li>
<li><strong>专业化</strong>：专用进程处理专门任务，提高效率</li>
<li><strong>可扩展性</strong>：便于添加新功能和优化现有模块</li>
</ol>
<p>这种架构虽然增加了内存开销，但换来了更好的用户体验和更高的安全性，这也是 Chrome 能成为主流浏览器的重要原因。</p>
<hr/>
<p>理解这些底层原理不仅有助于调试和优化网页性能，也能让我们更好地理解现代 Web 技术栈的设计思想，为构建高性能 Web 应用打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android系统APN(Access Point Name)加载流程详解]]></title>    <link>https://juejin.cn/post/7603294029531660339</link>    <guid>https://juejin.cn/post/7603294029531660339</guid>    <pubDate>2026-02-06T05:23:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603294029531660339" data-draft-id="7603263490342453257" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android系统APN(Access Point Name)加载流程详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T05:23:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android系统APN(Access Point Name)加载流程详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:23:56.000Z" title="Fri Feb 06 2026 05:23:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于代码分析，我将详细讲解Android系统如何加载和管理APN配置。</p>
<h3 data-id="heading-0">整体架构</h3>
<pre><code class="hljs">APN配置文件 → XML解析 → 数据库存储 → 应用程序查询
</code></pre>
<hr/>
<h3 data-id="heading-1">第一阶段：APN配置文件来源</h3>
<h4 data-id="heading-2">1.1 文件存储位置（优先级顺序）</h4>
<p>TelephonyProvider查找APN配置文件时按照以下优先级顺序：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// TelephonyProvider.java: 887-896 行</span>
private File <span class="hljs-title function_">getApnConfFile</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 默认系统文件 (最低优先级)</span>
    File confFile = new File(Environment.getRootDirectory(), PARTNER_APNS_PATH);
    <span class="hljs-comment">// = /system/etc/apns-conf.xml</span>
    
    <span class="hljs-comment">// 2. OEM定制文件 (更高优先级)</span>
    File oemConfFile = new File(Environment.getOemDirectory(), OEM_APNS_PATH);
    <span class="hljs-comment">// = /oem/telephony/apns-conf.xml</span>
    
    <span class="hljs-comment">// 3. 产品配置文件</span>
    File productConfFile = new File(Environment.getProductDirectory(), PARTNER_APNS_PATH);
    <span class="hljs-comment">// = /product/etc/apns-conf.xml</span>
    
    <span class="hljs-comment">// 4. OTA更新文件 (最高优先级)</span>
    File updatedConfFile = new File(Environment.getDataDirectory(), OTA_UPDATED_APNS_PATH);
    <span class="hljs-comment">// = /data/misc/apns/apns-conf.xml</span>
    
    <span class="hljs-comment">// 按优先级选择</span>
    confFile = pickSecondIfExists(confFile, oemConfFile);
    confFile = pickSecondIfExists(confFile, productConfFile);
    confFile = pickSecondIfExists(confFile, updatedConfFile);  <span class="hljs-comment">// 最终优先级最高</span>
    <span class="hljs-keyword">return</span> confFile;
}
</code></pre>
<p><strong>优先级关系：</strong></p>
<pre><code class="hljs">OTA文件 &gt; 产品文件 &gt; OEM文件 &gt; 系统默认文件
</code></pre>
<h4 data-id="heading-3">1.2 文件结构</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">apns</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"8"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 每条APN配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">apn</span>
        <span class="hljs-attr">mcc</span>=<span class="hljs-string">"310"</span>
        <span class="hljs-attr">mnc</span>=<span class="hljs-string">"04"</span>
        <span class="hljs-attr">carrier</span>=<span class="hljs-string">"Verizon"</span>
        <span class="hljs-attr">apn</span>=<span class="hljs-string">"vzwinternet"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"default,hipri"</span>
        <span class="hljs-attr">protocol</span>=<span class="hljs-string">"IP"</span>
        <span class="hljs-attr">roaming_protocol</span>=<span class="hljs-string">"IP"</span>
        <span class="hljs-attr">proxy</span>=<span class="hljs-string">"0.0.0.0"</span>
        <span class="hljs-attr">port</span>=<span class="hljs-string">"0"</span>
        <span class="hljs-attr">mmsproxy</span>=<span class="hljs-string">"0.0.0.0"</span>
        <span class="hljs-attr">mmsport</span>=<span class="hljs-string">"0"</span>
        <span class="hljs-attr">mmsc</span>=<span class="hljs-string">""</span>
        <span class="hljs-attr">carrier_enabled</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">user_editable</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">user_visible</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">authtype</span>=<span class="hljs-string">"3"</span>
        <span class="hljs-attr">bearer_bitmask</span>=<span class="hljs-string">"0"</span>
    /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">apns</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">第二阶段：初始化阶段</h3>
<h4 data-id="heading-5">2.1 数据库初始化时机</h4>
<p>当TelephonyProvider首次启动或数据库版本变化时，触发初始化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 918-998 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initDatabase</span><span class="hljs-params">(SQLiteDatabase db)</span> {
    <span class="hljs-comment">// 步骤1：加载系统内置APN</span>
    <span class="hljs-comment">// 步骤2：加载OEM/Partner提供的APN</span>
    <span class="hljs-comment">// 步骤3：清理已删除的APN</span>
}
</code></pre>
<h4 data-id="heading-6">2.2 校验和检查</h4>
<p>为了避免不必要的数据库重新加载，系统使用校验和机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 905-911 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apnDbUpdateNeeded</span><span class="hljs-params">()</span> {
    <span class="hljs-type">File</span> <span class="hljs-variable">confFile</span> <span class="hljs-operator">=</span> getApnConfFile();
    <span class="hljs-type">long</span> <span class="hljs-variable">newChecksum</span> <span class="hljs-operator">=</span> getChecksum(confFile);        <span class="hljs-comment">// 计算新校验和</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">oldChecksum</span> <span class="hljs-operator">=</span> getApnConfChecksum();         <span class="hljs-comment">// 读取旧校验和</span>
    
    <span class="hljs-keyword">if</span> (DBG) log(<span class="hljs-string">"newChecksum: "</span> + newChecksum);
    <span class="hljs-keyword">if</span> (DBG) log(<span class="hljs-string">"oldChecksum: "</span> + oldChecksum);
    
    <span class="hljs-keyword">return</span> newChecksum != oldChecksum;  <span class="hljs-comment">// 校验和不同则需要更新</span>
}
</code></pre>
<p><strong>存储位置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SharedPreferences中</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">sp</span> <span class="hljs-operator">=</span> mContext.getSharedPreferences(PREF_FILE, Context.MODE_PRIVATE);
sp.getLong(APN_CONF_CHECKSUM, -<span class="hljs-number">1</span>);  <span class="hljs-comment">// "apn_conf_checksum"</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">第三阶段：加载流程</h3>
<h4 data-id="heading-8">3.1 两层APN数据源</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 918-936 行</span>
<span class="hljs-comment">// 第一层：系统内置APN</span>
<span class="hljs-type">Resources</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> mContext.getResources();
<span class="hljs-type">XmlResourceParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> r.getXml(com.android.internal.R.xml.apns);
<span class="hljs-keyword">try</span> {
    XmlUtils.beginDocument(parser, <span class="hljs-string">"apns"</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">publicversion</span> <span class="hljs-operator">=</span> Integer.parseInt(parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"version"</span>));
    loadApns(db, parser, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// 加载内置APN (isOverlay=true)</span>
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 第二层：OEM/Partner提供的APN</span>
<span class="hljs-type">File</span> <span class="hljs-variable">confFile</span> <span class="hljs-operator">=</span> getApnConfFile();
<span class="hljs-type">FileReader</span> <span class="hljs-variable">confreader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(confFile);
<span class="hljs-type">XmlPullParser</span> <span class="hljs-variable">confparser</span> <span class="hljs-operator">=</span> Xml.newPullParser();
confparser.setInput(confreader);

<span class="hljs-comment">// 版本校验：内置版本必须与外部配置版本一致</span>
<span class="hljs-type">int</span> <span class="hljs-variable">confversion</span> <span class="hljs-operator">=</span> Integer.parseInt(confparser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"version"</span>));
<span class="hljs-keyword">if</span> (publicversion != confversion) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Internal APNS file version doesn't match"</span>);
}

loadApns(db, confparser, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// 加载外部APN (isOverlay=false)</span>
</code></pre>
<h4 data-id="heading-9">3.2 XML解析和数据提取</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2716-2831 行</span>
<span class="hljs-keyword">private</span> ContentValues <span class="hljs-title function_">getRow</span><span class="hljs-params">(XmlPullParser parser, <span class="hljs-type">boolean</span> isOverlay)</span> {
    <span class="hljs-type">ContentValues</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();
    
    <span class="hljs-comment">// 必需字段：MCC/MNC</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">mcc</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mcc"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">mnc</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mnc"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">numeric</span> <span class="hljs-operator">=</span> mcc + mnc;  <span class="hljs-comment">// 如: "31004" (Verizon)</span>
    
    map.put(NUMERIC, numeric);
    map.put(MCC, mcc);
    map.put(MNC, mnc);
    
    <span class="hljs-comment">// 基本信息</span>
    map.put(NAME, parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"carrier"</span>));
    map.put(APN, parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"apn"</span>));
    
    <span class="hljs-comment">// 网络参数</span>
    addStringAttribute(parser, <span class="hljs-string">"proxy"</span>, map, PROXY);
    addStringAttribute(parser, <span class="hljs-string">"port"</span>, map, PORT);
    
    <span class="hljs-comment">// MMS参数</span>
    addStringAttribute(parser, <span class="hljs-string">"mmsproxy"</span>, map, MMSPROXY);
    addStringAttribute(parser, <span class="hljs-string">"mmsport"</span>, map, MMSPORT);
    addStringAttribute(parser, <span class="hljs-string">"mmsc"</span>, map, MMSC);
    
    <span class="hljs-comment">// 认证信息</span>
    addStringAttribute(parser, <span class="hljs-string">"user"</span>, map, USER);
    addStringAttribute(parser, <span class="hljs-string">"password"</span>, map, PASSWORD);
    addIntAttribute(parser, <span class="hljs-string">"authtype"</span>, map, AUTH_TYPE);
    
    <span class="hljs-comment">// APN类型 (default, mms, supl, hipri, fota, ims, ia, dun等)</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">apnType</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"type"</span>);
    <span class="hljs-keyword">if</span> (apnType != <span class="hljs-literal">null</span>) {
        apnType = apnType.replaceAll(<span class="hljs-string">"\\s+"</span>, <span class="hljs-string">""</span>);  <span class="hljs-comment">// 移除空格</span>
        map.put(TYPE, apnType);
    }
    
    <span class="hljs-comment">// 协议配置</span>
    addStringAttribute(parser, <span class="hljs-string">"protocol"</span>, map, PROTOCOL);              <span class="hljs-comment">// IP/IPV6/IPV4V6</span>
    addStringAttribute(parser, <span class="hljs-string">"roaming_protocol"</span>, map, ROAMING_PROTOCOL);
    
    <span class="hljs-comment">// 网络技术支持</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">networkTypeBitmask</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">networkTypeList</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"network_type_bitmask"</span>);
    <span class="hljs-keyword">if</span> (networkTypeList != <span class="hljs-literal">null</span>) {
        networkTypeBitmask = getBitmaskFromString(networkTypeList);
    }
    map.put(NETWORK_TYPE_BITMASK, networkTypeBitmask);
    
    <span class="hljs-comment">// 承载网络类型</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">bearerBitmask</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">bearerList</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"bearer_bitmask"</span>);
    <span class="hljs-keyword">if</span> (bearerList != <span class="hljs-literal">null</span>) {
        bearerBitmask = getBitmaskFromString(bearerList);
    }
    map.put(BEARER_BITMASK, bearerBitmask);
    
    <span class="hljs-comment">// 高级配置</span>
    addBoolAttribute(parser, <span class="hljs-string">"carrier_enabled"</span>, map, CARRIER_ENABLED);
    addBoolAttribute(parser, <span class="hljs-string">"user_visible"</span>, map, USER_VISIBLE);
    addBoolAttribute(parser, <span class="hljs-string">"user_editable"</span>, map, USER_EDITABLE);
    addBoolAttribute(parser, <span class="hljs-string">"modem_cognitive"</span>, map, MODEM_PERSIST);
    addBoolAttribute(parser, <span class="hljs-string">"always_on"</span>, map, ALWAYS_ON);
    
    <span class="hljs-comment">// MVNO配置 (虚拟运营商)</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">mvno_type</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mvno_type"</span>);
    <span class="hljs-keyword">if</span> (mvno_type != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">String</span> <span class="hljs-variable">mvno_match_data</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mvno_match_data"</span>);
        <span class="hljs-keyword">if</span> (mvno_match_data != <span class="hljs-literal">null</span>) {
            map.put(MVNO_TYPE, mvno_type);        <span class="hljs-comment">// gid, spn, imsi等</span>
            map.put(MVNO_MATCH_DATA, mvno_match_data);
        }
    }
    
    <span class="hljs-keyword">return</span> map;
}
</code></pre>
<p><strong>提取的关键字段：</strong></p>


















































<table><thead><tr><th>字段名</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td>numeric</td><td>MCC+MNC</td><td>31004 (Verizon)</td></tr><tr><td>apn</td><td>接入点名称</td><td>vzwinternet</td></tr><tr><td>type</td><td>APN类型</td><td>default,hipri,mms</td></tr><tr><td>protocol</td><td>协议</td><td>IP/IPV6/IPV4V6</td></tr><tr><td>proxy</td><td>代理地址</td><td>0.0.0.0</td></tr><tr><td>mmsc</td><td>MMS中心地址</td><td><a href="https://link.juejin.cn?target=http%3A%2F%2Fmms.verizon.com" target="_blank" title="http://mms.verizon.com" ref="nofollow noopener noreferrer">mms.verizon.com</a></td></tr><tr><td>user/password</td><td>认证凭证</td><td>(可选)</td></tr><tr><td>bearer_bitmask</td><td>网络技术</td><td>LTE, 3G等</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">第四阶段：数据库插入</h3>
<h4 data-id="heading-11">4.1 事务化插入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2865-2888 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadApns</span><span class="hljs-params">(SQLiteDatabase db, XmlPullParser parser, <span class="hljs-type">boolean</span> isOverlay)</span> {
    <span class="hljs-keyword">if</span> (parser != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            db.beginTransaction();  <span class="hljs-comment">// 开始事务</span>
            XmlUtils.nextElement(parser);
            
            <span class="hljs-comment">// 循环解析每条APN</span>
            <span class="hljs-keyword">while</span> (parser.getEventType() != XmlPullParser.END_DOCUMENT) {
                <span class="hljs-type">ContentValues</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> getRow(parser, isOverlay);  <span class="hljs-comment">// 解析一条APN</span>
                <span class="hljs-keyword">if</span> (row == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlPullParserException</span>(<span class="hljs-string">"Expected 'apn' tag"</span>, parser, <span class="hljs-literal">null</span>);
                }
                insertAddingDefaults(db, row);  <span class="hljs-comment">// 插入数据库</span>
                XmlUtils.nextElement(parser);
            }
            
            db.setTransactionSuccessful();  <span class="hljs-comment">// 提交事务</span>
        } <span class="hljs-keyword">catch</span> (XmlPullParserException | IOException | SQLException e) {
            <span class="hljs-comment">// 异常处理</span>
        } <span class="hljs-keyword">finally</span> {
            db.endTransaction();
        }
    }
}
</code></pre>
<h4 data-id="heading-12">4.2 冲突处理</h4>
<p>当APN已存在时，系统采用合并策略：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2891-2931 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertAddingDefaults</span><span class="hljs-params">(SQLiteDatabase db, ContentValues row)</span> {
    row = setDefaultValue(row);  <span class="hljs-comment">// 设置默认值</span>
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试插入 (CONFLICT_ABORT: 如果冲突则中止)</span>
        db.insertWithOnConflict(CARRIERS_TABLE, <span class="hljs-literal">null</span>, row, SQLiteDatabase.CONFLICT_ABORT);
    } <span class="hljs-keyword">catch</span> (SQLException e) {
        <span class="hljs-comment">// 插入失败 - 检查是否存在冲突的APN</span>
        <span class="hljs-type">Cursor</span> <span class="hljs-variable">oldRow</span> <span class="hljs-operator">=</span> selectConflictingRow(db, CARRIERS_TABLE, row);
        <span class="hljs-keyword">if</span> (oldRow != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">ContentValues</span> <span class="hljs-variable">mergedValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();
            <span class="hljs-type">int</span> <span class="hljs-variable">edited</span> <span class="hljs-operator">=</span> oldRow.getInt(oldRow.getColumnIndex(EDITED_STATUS));
            
            <span class="hljs-comment">// 处理编辑状态</span>
            <span class="hljs-keyword">if</span> (edited == USER_DELETED) {
                <span class="hljs-comment">// 用户删除但在XML中存在 -&gt; 标记为 USER_DELETED_BUT_PRESENT_IN_XML</span>
                edited = USER_DELETED_BUT_PRESENT_IN_XML;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (edited == CARRIER_DELETED) {
                edited = CARRIER_DELETED_BUT_PRESENT_IN_XML;
            }
            mergedValues.put(EDITED_STATUS, edited);
            
            <span class="hljs-comment">// 合并字段并更新数据库</span>
            mergeFieldsAndUpdateDb(db, CARRIERS_TABLE, oldRow, row, 
                                   mergedValues, <span class="hljs-literal">false</span>, mContext);
        }
    }
}
</code></pre>
<h4 data-id="heading-13">4.3 APN编辑状态</h4>
<p>系统跟踪APN的编辑状态：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java</span>
UNEDITED = <span class="hljs-number">0</span>                                    <span class="hljs-comment">// 未编辑（系统APN）</span>
USER_EDITED = <span class="hljs-number">1</span>                                <span class="hljs-comment">// 用户编辑</span>
USER_DELETED = <span class="hljs-number">2</span>                               <span class="hljs-comment">// 用户删除</span>
CARRIER_EDITED = <span class="hljs-number">3</span>                             <span class="hljs-comment">// 运营商编辑</span>
CARRIER_DELETED = <span class="hljs-number">4</span>                            <span class="hljs-comment">// 运营商删除</span>
USER_DELETED_BUT_PRESENT_IN_XML = <span class="hljs-number">5</span>           <span class="hljs-comment">// 用户删除但在XML中存在</span>
CARRIER_DELETED_BUT_PRESENT_IN_XML = <span class="hljs-number">6</span>        <span class="hljs-comment">// 运营商删除但在XML中存在</span>
</code></pre>
<p><strong>清理规则：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 973-984 行</span>
<span class="hljs-comment">// 加载完成后清理已删除的APN</span>

<span class="hljs-comment">// 删除用户/运营商明确删除的APN</span>
db.delete(CARRIERS_TABLE, IS_USER_DELETED + <span class="hljs-string">" or "</span> + IS_CARRIER_DELETED, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 将"删除但在XML中存在"状态改为"已删除"</span>
<span class="hljs-type">ContentValues</span> <span class="hljs-variable">cv</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();
cv.put(EDITED_STATUS, USER_DELETED);
db.update(CARRIERS_TABLE, cv, IS_USER_DELETED_BUT_PRESENT_IN_XML, <span class="hljs-literal">null</span>);
</code></pre>
<hr/>
<h3 data-id="heading-14">第五阶段：字段合并策略</h3>
<p>当新旧APN冲突时，系统采用智能合并策略：</p>
<h4 data-id="heading-15">5.1 APN类型合并</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2938-2982 行</span>
<span class="hljs-comment">// 如果类型不同，合并所有唯一的类型</span>
<span class="hljs-comment">// 例如：</span>
<span class="hljs-comment">// oldType = "default,hipri"</span>
<span class="hljs-comment">// newType = "default,mms"</span>
<span class="hljs-comment">// mergedType = "default,hipri,mms"</span>

<span class="hljs-keyword">if</span> (!oldType.equalsIgnoreCase(newType)) {
    String[] oldTypes = oldType.toLowerCase(Locale.ROOT).split(<span class="hljs-string">","</span>);
    String[] newTypes = newType.toLowerCase(Locale.ROOT).split(<span class="hljs-string">","</span>);
    
    ArrayList&lt;String&gt; mergedTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    mergedTypes.addAll(Arrays.asList(oldTypes));
    
    <span class="hljs-keyword">for</span> (String s : newTypes) {
        <span class="hljs-keyword">if</span> (!mergedTypes.contains(s.trim())) {
            mergedTypes.add(s);  <span class="hljs-comment">// 添加新类型</span>
        }
    }
    
    <span class="hljs-comment">// 重新组合</span>
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">mergedType</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mergedTypes.size(); i++) {
        mergedType.append((i == <span class="hljs-number">0</span> ? <span class="hljs-string">""</span> : <span class="hljs-string">","</span>) + mergedTypes.get(i));
    }
    newRow.put(TYPE, mergedType.toString());
}
</code></pre>
<h4 data-id="heading-16">5.2 Bearer/NetworkType位掩码合并</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2985-3009 行</span>
<span class="hljs-comment">// 位掩码按位或操作合并</span>
<span class="hljs-comment">// 例如：</span>
<span class="hljs-comment">// oldBearer = 0x0001 (GSM)</span>
<span class="hljs-comment">// newBearer = 0x0002 (CDMA)</span>
<span class="hljs-comment">// mergedBearer = 0x0003 (GSM | CDMA)</span>

<span class="hljs-keyword">if</span> (oldBearer != newBearer) {
    <span class="hljs-keyword">if</span> (oldBearer == <span class="hljs-number">0</span> || newBearer == <span class="hljs-number">0</span>) {
        newRow.put(BEARER_BITMASK, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 0表示所有网络</span>
    } <span class="hljs-keyword">else</span> {
        newRow.put(BEARER_BITMASK, (oldBearer | newBearer));  <span class="hljs-comment">// 按位或</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-17">第六阶段：OTA更新机制</h3>
<h4 data-id="heading-18">6.1 系统更新安装</h4>
<p>OTA更新可以推送新的APN配置文件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ApnDbInstallReceiver.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApnDbInstallReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ConfigUpdateInstallReceiver</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ApnDbInstallReceiver</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"/data/misc/apns/"</span>,      <span class="hljs-comment">// 安装目录</span>
              <span class="hljs-string">"apns-conf.xml"</span>,          <span class="hljs-comment">// 文件名</span>
              <span class="hljs-string">"metadata/"</span>,              <span class="hljs-comment">// 元数据目录</span>
              <span class="hljs-string">"version"</span>);               <span class="hljs-comment">// 版本文件</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postInstall</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 安装后触发数据库更新</span>
        <span class="hljs-type">ContentResolver</span> <span class="hljs-variable">resolver</span> <span class="hljs-operator">=</span> context.getContentResolver();
        resolver.delete(UPDATE_APN_DB, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// 触发更新</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-19">第七阶段：应用查询APN</h3>
<h4 data-id="heading-20">7.1 通过ContentProvider查询</h4>
<p>应用程序通过标准ContentProvider查询APN：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例代码</span>
<span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> resolver.query(
    Telephony.Carriers.CONTENT_URI,
    <span class="hljs-literal">null</span>,
    Telephony.Carriers.NUMERIC + <span class="hljs-string">"=?"</span>,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"31004"</span>},  <span class="hljs-comment">// MCC+MNC</span>
    <span class="hljs-literal">null</span>
);

<span class="hljs-comment">// 获取特定MNC的所有APN</span>
<span class="hljs-keyword">while</span> (cursor.moveToNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">apn</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(Telephony.Carriers.APN));
    <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(Telephony.Carriers.TYPE));
    <span class="hljs-type">String</span> <span class="hljs-variable">mmsc</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(Telephony.Carriers.MMSC));
}
</code></pre>
<h4 data-id="heading-21">7.2 优先级选择</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ContentProvider支持查询首选APN</span>
<span class="hljs-comment">// 表中有preferred字段，值为1的APN被视为首选</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">数据库存储结构</h3>
<p>APN数据存储在<code>carriers</code>表中：</p>







































































































































<table><thead><tr><th>字段名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>_id</td><td>INTEGER PRIMARY KEY</td><td>行ID</td></tr><tr><td>numeric</td><td>TEXT</td><td>MCC+MNC</td></tr><tr><td>mcc</td><td>TEXT</td><td>Mobile Country Code</td></tr><tr><td>mnc</td><td>TEXT</td><td>Mobile Network Code</td></tr><tr><td>apn</td><td>TEXT</td><td>接入点名称</td></tr><tr><td>name</td><td>TEXT</td><td>运营商名称</td></tr><tr><td>proxy</td><td>TEXT</td><td>代理地址</td></tr><tr><td>port</td><td>TEXT</td><td>代理端口</td></tr><tr><td>mmsproxy</td><td>TEXT</td><td>MMS代理</td></tr><tr><td>mmsport</td><td>TEXT</td><td>MMS端口</td></tr><tr><td>mmsc</td><td>TEXT</td><td>MMS中心URL</td></tr><tr><td>user</td><td>TEXT</td><td>用户名</td></tr><tr><td>password</td><td>TEXT</td><td>密码</td></tr><tr><td>server</td><td>TEXT</td><td>服务器</td></tr><tr><td>type</td><td>TEXT</td><td>APN类型</td></tr><tr><td>protocol</td><td>TEXT</td><td>协议</td></tr><tr><td>roaming_protocol</td><td>TEXT</td><td>漫游协议</td></tr><tr><td>authtype</td><td>INTEGER</td><td>认证类型 (0-PAP, 1-CHAP, 3-PAP/CHAP)</td></tr><tr><td>bearer_bitmask</td><td>INTEGER</td><td>网络技术位掩码</td></tr><tr><td>network_type_bitmask</td><td>INTEGER</td><td>网络类型位掩码</td></tr><tr><td>edited</td><td>INTEGER</td><td>编辑状态 (0-未编辑, 1-用户编辑等)</td></tr><tr><td>user_editable</td><td>BOOLEAN</td><td>用户是否可编辑</td></tr><tr><td>user_visible</td><td>BOOLEAN</td><td>用户是否可见</td></tr><tr><td>carrier_enabled</td><td>BOOLEAN</td><td>是否启用</td></tr><tr><td>modem_cognitive</td><td>BOOLEAN</td><td>Modem持久化</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-23">APN类型详解</h3>
<pre><code class="hljs language-scss" lang="scss">default      - 默认数据连接
mms          - 彩信(MMS)
supl         - <span class="hljs-selector-tag">A</span>-GPS (Assisted GPS)
hipri        - 高优先级数据连接
fota         - Firmware Over-The-Air更新
ims          - IP Multimedia Subsystem
ia           - Initial Attach (初始附着)
dun          - Dial-Up Networking
cbs          - Carrier Branded Services
</code></pre>
<hr/>
<h3 data-id="heading-24">完整的APN加载时序</h3>
<pre><code class="hljs language-scss" lang="scss">启动时序：
│
├─ <span class="hljs-selector-attr">[1]</span> TelephonyProvider<span class="hljs-selector-class">.onCreate</span>()
│    └─→ DatabaseHelper<span class="hljs-selector-class">.getReadableDatabase</span>()
│
├─ <span class="hljs-selector-attr">[2]</span> 检查校验和
│    └─→ <span class="hljs-built_in">apnDbUpdateNeeded</span>()?
│
├─ <span class="hljs-selector-attr">[3]</span> 如果需要更新，执行<span class="hljs-built_in">initDatabase</span>()
│    │
│    ├─ 加载系统内置APN
│    │  └─→ Resources<span class="hljs-selector-class">.getXml</span>(R.xml.apns)
│    │
│    ├─ 加载外部APN配置
│    │  └─→ <span class="hljs-built_in">getApnConfFile</span>() (优先选择最新的)
│    │      ├─ /data/misc/apns/apns-conf<span class="hljs-selector-class">.xml</span> (OTA)
│    │      ├─ /product/etc/apns-conf<span class="hljs-selector-class">.xml</span>
│    │      ├─ /oem/telephony/apns-conf<span class="hljs-selector-class">.xml</span>
│    │      └─ /system/etc/apns-conf<span class="hljs-selector-class">.xml</span>
│    │
│    ├─ 事务化插入数据库
│    │  └─→ <span class="hljs-built_in">loadApns</span>(db, parser)
│    │      ├─ <span class="hljs-built_in">getRow</span>() 解析每条APN
│    │      └─ <span class="hljs-built_in">insertAddingDefaults</span>() 插入或合并
│    │
│    └─ 清理已删除的APN
│        └─→ 删除USER_DELETED/CARRIER_DELETED
│
├─ <span class="hljs-selector-attr">[4]</span> 更新校验和
│    └─→ <span class="hljs-built_in">setApnConfChecksum</span>()
│
└─ <span class="hljs-selector-attr">[5]</span> 应用程序可以查询APN
     └─→ ContentProvider查询
</code></pre>
<hr/>
<h3 data-id="heading-25">关键设计点</h3>
<ol>
<li><strong>多源支持</strong> - 支持系统、OEM、Product、OTA等多个来源</li>
<li><strong>版本校验</strong> - 内置版本必须与外部版本一致</li>
<li><strong>智能合并</strong> - 新旧APN冲突时智能合并而不是覆盖</li>
<li><strong>编辑跟踪</strong> - 区分用户编辑、运营商编辑和系统APN</li>
<li><strong>校验和优化</strong> - 避免无必要的数据库重新加载</li>
<li><strong>事务保证</strong> - 确保APN加载的原子性</li>
<li><strong>向后兼容</strong> - 数据库升级时保留用户和运营商编辑</li>
</ol>
<p>这就是Android系统的完整APN加载机制！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Telephony通话状态更新消息上报流程]]></title>    <link>https://juejin.cn/post/7603288778678812707</link>    <guid>https://juejin.cn/post/7603288778678812707</guid>    <pubDate>2026-02-06T04:29:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603288778678812707" data-draft-id="7603283380554530850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Telephony通话状态更新消息上报流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T04:29:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Telephony通话状态更新消息上报流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T04:29:07.000Z" title="Fri Feb 06 2026 04:29:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我来详细分析Android Telephony中通话状态更新消息的上报流程。</p>
<p>现在让我查看更多AT指令的处理和上报流程：</p>
<p>现在让我查看更多关于AT命令处理和轮询的细节：</p>
<p>现在让我查看frameworks层的处理，以了解完整的上报流程：</p>
<p>基于我对代码的分析，这个流程涉及多个层次的交互，我将详细讲解从Modem到上层应用的完整路径。</p>
<h3 data-id="heading-0">整体架构概览</h3>
<p>通话状态更新的上报流程包括以下主要环节：</p>
<pre><code class="hljs">Modem → HAL → RIL Framework → HIDL Service → Java Framework → Phone/CallTracker → Application
</code></pre>
<hr/>
<h3 data-id="heading-1">第一阶段：Modem端的主动上报</h3>
<h4 data-id="heading-2">1.1 Modem主动上报（Unsolicited Response）</h4>
<p>Modem在通话状态发生变化时，主动向基带驱动发送未经请求的回复信息。常见的主动上报包括：</p>
<ul>
<li><strong>RING</strong>: 来电铃声指示</li>
<li><strong>+CRING</strong>: GSM特定的铃声格式（如"VOICE"）</li>
<li><strong>NO CARRIER</strong>: 通话结束，载波消失</li>
<li><strong>+CCWA</strong>: 来电等待指示</li>
<li><strong>+CREG</strong>: 网络注册状态变化</li>
<li><strong>+CGREG</strong>: GPRS网络注册状态变化</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// reference-ril.c: 3490-3497 行</span>
<span class="hljs-comment">// 当Modem发来上述指示时，Reference RIL解析并上报</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strStartsWith(s,<span class="hljs-string">"+CRING:"</span>)
            || strStartsWith(s,<span class="hljs-string">"RING"</span>)
            || strStartsWith(s,<span class="hljs-string">"NO CARRIER"</span>)
            || strStartsWith(s,<span class="hljs-string">"+CCWA"</span>)
) {
    RIL_onUnsolicitedResponse (
        RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED,
        <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-3">第二阶段：Vendor RIL处理</h3>
<h4 data-id="heading-4">2.1 Vendor RIL的AT指令处理</h4>
<p>Vendor RIL运行在独立的进程中，通过以下步骤处理Modem的主动上报：</p>
<ol>
<li><strong>AT Reader线程</strong> 持续从Modem读取数据</li>
<li><strong>未经请求的响应处理</strong> (<code>onUnsolicitedResponse</code>回调)</li>
<li><strong>调用RIL_onUnsolicitedResponse</strong>将消息上报给RIL Framework</li>
</ol>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// reference-ril.c: 3490-3497</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">onUnsolicited</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *sms_pdu)</span>
{
    <span class="hljs-comment">// ... 解析AT指令 ...</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strStartsWith(s,<span class="hljs-string">"+CRING:"</span>)
                || strStartsWith(s,<span class="hljs-string">"RING"</span>)
                || strStartsWith(s,<span class="hljs-string">"NO CARRIER"</span>)
                || strStartsWith(s,<span class="hljs-string">"+CCWA"</span>)
    ) {
        RIL_onUnsolicitedResponse (
            RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED,
            <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">第三阶段：RIL Framework处理</h3>
<h4 data-id="heading-6">3.1 RIL_onUnsolicitedResponse函数</h4>
<p>这是RIL Framework的核心处理函数，在<code>libril/ril.cpp</code>中实现：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 722-729 行</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RIL_onUnsolicitedResponse</span><span class="hljs-params">(<span class="hljs-type">int</span> unsolResponse, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data,
                                <span class="hljs-type">size_t</span> datalen, RIL_SOCKET_ID socket_id)</span>
</span></code></pre>
<p><strong>主要处理步骤：</strong></p>
<ol>
<li>
<p><strong>Wakelock管理</strong> - 根据消息类型获取Partial Wakelock，防止CPU休眠</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 757-761 行</span>
<span class="hljs-keyword">switch</span> (s_unsolResponses[unsolResponseIndex].wakeType) {
    <span class="hljs-keyword">case</span> WAKE_PARTIAL:
        <span class="hljs-built_in">grabPartialWakeLock</span>();
        shouldScheduleTimeout = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">break</span>;
}
</code></pre>
</li>
<li>
<p><strong>HIDL指示分发</strong> - 通过HIDL接口将消息转发给上层</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 793-797 行</span>
<span class="hljs-keyword">if</span> (s_unsolResponses[unsolResponseIndex].responseFunction) {
    ret = s_unsolResponses[unsolResponseIndex].<span class="hljs-built_in">responseFunction</span>(
            (<span class="hljs-type">int</span>) soc_id, responseType, <span class="hljs-number">0</span>, RIL_E_SUCCESS, 
            <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(data), datalen);
}
</code></pre>
</li>
<li>
<p><strong>Wakelock释放</strong> - 设置超时后释放Wakelock（默认200ms）</p>
</li>
</ol>
<h4 data-id="heading-7">3.2 未经请求响应映射表</h4>
<p>在<code>ril_unsol_commands.h</code>中定义了消息类型到处理函数的映射：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ril_unsol_commands.h: 17-19 行</span>
{RIL_UNSOL_RESPONSE_RADIO_STATE_CHANGED, radio::radioStateChangedInd, WAKE_PARTIAL},
{RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED, radio::callStateChangedInd, WAKE_PARTIAL},
{RIL_UNSOL_RESPONSE_VOICE_NETWORK_STATE_CHANGED, radio::networkStateChangedInd, WAKE_PARTIAL},
</code></pre>
<hr/>
<h3 data-id="heading-8">第四阶段：HIDL服务处理</h3>
<h4 data-id="heading-9">4.1 callStateChangedInd函数</h4>
<p>在<code>ril_service.cpp</code>中实现HIDL指示处理：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril_service.cpp: 6758-6773 行</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">radio::callStateChangedInd</span><span class="hljs-params">(<span class="hljs-type">int</span> slotId,
                               <span class="hljs-type">int</span> indicationType, <span class="hljs-type">int</span> token, RIL_Errno e, <span class="hljs-type">void</span> *response,
                               <span class="hljs-type">size_t</span> responseLen)</span> </span>{
    <span class="hljs-keyword">if</span> (radioService[slotId] != <span class="hljs-literal">NULL</span> &amp;&amp; radioService[slotId]-&gt;mRadioIndication != <span class="hljs-literal">NULL</span>) {
        Return&lt;<span class="hljs-type">void</span>&gt; retStatus = radioService[slotId]-&gt;mRadioIndication-&gt;<span class="hljs-built_in">callStateChanged</span>(
                <span class="hljs-built_in">convertIntToRadioIndicationType</span>(indicationType));
        radioService[slotId]-&gt;<span class="hljs-built_in">checkReturnStatus</span>(retStatus);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>获取对应Slot的HIDL Indication实例</li>
<li>调用HIDL接口的<code>callStateChanged</code>方法</li>
<li>将消息转发给Java层</li>
</ul>
<hr/>
<h3 data-id="heading-10">第五阶段：Java Framework处理</h3>
<h4 data-id="heading-11">5.1 VoiceIndication接收</h4>
<p>在<code>VoiceIndication.java</code>的<code>callStateChanged</code>方法中处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// VoiceIndication.java: 94-99 行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callStateChanged</span><span class="hljs-params">(<span class="hljs-type">int</span> indicationType)</span> {
    mRil.processIndication(HAL_SERVICE_VOICE, indicationType);

    <span class="hljs-keyword">if</span> (mRil.isLogOrTrace()) mRil.unsljLog(RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED);

    mRil.mCallStateRegistrants.notifyRegistrants();
}
</code></pre>
<p><strong>处理流程：</strong></p>
<ol>
<li>处理指示类型（标记为已处理）</li>
<li>记录日志</li>
<li><strong>通知所有已注册的监听者</strong></li>
</ol>
<h4 data-id="heading-12">5.2 CallStateRegistrants通知</h4>
<p><code>mCallStateRegistrants</code>是一个<code>RegistrantList</code>，包含所有对通话状态变化感兴趣的监听者（如<code>GsmCdmaCallTracker</code>）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BaseCommands.java: 292-294 行</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerForCallStateChanged</span><span class="hljs-params">(Handler h, <span class="hljs-type">int</span> what, Object obj)</span> {
    mCallStateRegistrants.addUnique(h, what, obj);
}
</code></pre>
<p>GsmCdmaCallTracker在初始化时注册：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 160-171 行</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">GsmCdmaCallTracker</span><span class="hljs-params">(GsmCdmaPhone phone, FeatureFlags featureFlags)</span> {
    <span class="hljs-comment">// ...</span>
    mCi = phone.mCi;
    mCi.registerForCallStateChanged(<span class="hljs-built_in">this</span>, EVENT_CALL_STATE_CHANGE, <span class="hljs-literal">null</span>);
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-13">第六阶段：CallTracker轮询当前通话列表</h3>
<h4 data-id="heading-14">6.1 触发getCurrentCalls请求</h4>
<p>当接收到<code>EVENT_CALL_STATE_CHANGE</code>消息时，GsmCdmaCallTracker不会直接使用该消息，而是<strong>主动轮询</strong>当前的通话列表：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CallTracker.java: 91-98 行</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pollCallsWhenSafe</span><span class="hljs-params">()</span> {
    mNeedsPoll = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span> (checkNoOperationsPending()) {
        mLastRelevantPoll = obtainMessage(EVENT_POLL_CALLS_RESULT);
        mCi.getCurrentCalls(mLastRelevantPoll);
    }
}
</code></pre>
<p><strong>为什么需要轮询？</strong></p>
<ul>
<li>Modem上报的只是"状态有变化"的信号，不包含具体的通话列表数据</li>
<li>必须通过AT+CLCC命令主动查询当前的通话详情</li>
</ul>
<h4 data-id="heading-15">6.2 RIL.getCurrentCalls请求</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RIL.java: 1640-1655 行</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getCurrentCalls</span><span class="hljs-params">(Message result)</span> {
    <span class="hljs-type">RadioVoiceProxy</span> <span class="hljs-variable">voiceProxy</span> <span class="hljs-operator">=</span> getRadioServiceProxy(RadioVoiceProxy.class);
    <span class="hljs-keyword">if</span> (!canMakeRequest(<span class="hljs-string">"getCurrentCalls"</span>, voiceProxy, result, RADIO_HAL_VERSION_1_4)) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-type">RILRequest</span> <span class="hljs-variable">rr</span> <span class="hljs-operator">=</span> obtainRequest(RIL_REQUEST_GET_CURRENT_CALLS, result, mRILDefaultWorkSource);

    <span class="hljs-keyword">if</span> (RILJ_LOGD) {
        riljLog(rr.serialString() + <span class="hljs-string">"&gt; "</span> + RILUtils.requestToString(rr.mRequest));
    }

    radioServiceInvokeHelper(HAL_SERVICE_VOICE, rr, <span class="hljs-string">"getCurrentCalls"</span>, () -&gt; {
        voiceProxy.getCurrentCalls(rr.mSerial);
    });
}
</code></pre>
<hr/>
<h3 data-id="heading-16">第七阶段：解析通话列表</h3>
<h4 data-id="heading-17">7.1 Modem响应getCurrentCalls</h4>
<p>Modem响应AT+CLCC命令，返回当前通话列表。每条通话的格式为：</p>
<pre><code class="hljs language-xml" lang="xml">+CLCC: <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">dir</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">stat</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">bearer</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">mpty</span>&gt;</span>[,<span class="hljs-tag">&lt;<span class="hljs-name">number</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>[,<span class="hljs-tag">&lt;<span class="hljs-name">alpha</span>&gt;</span>]]
</code></pre>
<p>例如：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">+<span class="hljs-built_in">CLCC</span>: <span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-string">"10086"</span>,<span class="hljs-number">129</span>
+<span class="hljs-built_in">CLCC</span>: <span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-18">7.2 handlePollCalls处理结果</h4>
<p>当RIL返回通话列表后，<code>handlePollCalls</code>在<code>GsmCdmaCallTracker</code>中处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 848-863 行</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlePollCalls</span><span class="hljs-params">(AsyncResult ar)</span> {
    List polledCalls;

    <span class="hljs-keyword">if</span> (VDBG) log(<span class="hljs-string">"handlePollCalls"</span>);
    <span class="hljs-keyword">if</span> (ar.exception == <span class="hljs-literal">null</span>) {
        polledCalls = (List)ar.result;  <span class="hljs-comment">// DriverCall列表</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isCommandExceptionRadioNotAvailable(ar.exception)) {
        polledCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
    } <span class="hljs-keyword">else</span> {
        pollCallsAfterDelay();
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// ... 处理通话列表 ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-19">第八阶段：更新通话状态和通知上层</h3>
<h4 data-id="heading-20">8.1 遍历并更新通话对象</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 878-1070 行</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, curDC = <span class="hljs-number">0</span>, dcSize = polledCalls.size(); i &lt; mConnections.length; i++) {
    <span class="hljs-type">GsmCdmaConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> mConnections[i];
    <span class="hljs-type">DriverCall</span> <span class="hljs-variable">dc</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 获取Modem返回的通话信息</span>
    <span class="hljs-keyword">if</span> (curDC &lt; dcSize) {
        dc = (DriverCall) polledCalls.get(curDC);
        <span class="hljs-keyword">if</span> (dc.index == i+<span class="hljs-number">1</span>) {
            curDC++;
        } <span class="hljs-keyword">else</span> {
            dc = <span class="hljs-literal">null</span>;
        }
    }
    
    <span class="hljs-comment">// 比较本地记录和Modem状态</span>
    <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span> &amp;&amp; dc != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 新通话出现 - 创建新的GsmCdmaConnection</span>
        mConnections[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GsmCdmaConnection</span>(mPhone, dc, <span class="hljs-built_in">this</span>, i);
        newRinging = checkMtFindNewRinging(dc, i);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span> &amp;&amp; dc == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 通话已被删除 - 标记为已丢弃</span>
        mDroppedDuringPoll.add(conn);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span> &amp;&amp; dc != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 通话存在，更新其状态</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">changed</span> <span class="hljs-operator">=</span> conn.update(dc);
        hasNonHangupStateChanged = hasNonHangupStateChanged || changed;
    }
}
</code></pre>
<h4 data-id="heading-21">8.2 更新Phone状态</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 1201-1202 行</span>
updatePhoneState();
</code></pre>
<p>这个函数根据通话列表确定Phone的总体状态（IDLE、RINGING、OFFHOOK）。</p>
<h4 data-id="heading-22">8.3 通知监听者</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 1215-1218 行</span>
<span class="hljs-keyword">if</span> (hasNonHangupStateChanged || newRinging != <span class="hljs-literal">null</span> || hasAnyCallDisconnected) {
    mPhone.notifyPreciseCallStateChanged();
    updateMetrics(mConnections);
}
</code></pre>
<hr/>
<h3 data-id="heading-23">第九阶段：上层应用感知</h3>
<h4 data-id="heading-24">9.1 Phone层的通知</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 1117 行</span>
<span class="hljs-keyword">if</span> (newRinging != <span class="hljs-literal">null</span>) {
    mPhone.notifyNewRingingConnection(newRinging);
}
</code></pre>
<p>通知Phone有新的来电。</p>
<h4 data-id="heading-25">9.2 应用层感知</h4>
<p>应用程序通过以下方式感知通话状态变化：</p>
<ol>
<li><strong>TelephonyCallback监听</strong> （推荐方式）</li>
<li><strong>PhoneStateListener</strong> （已废弃）</li>
<li><strong>TelephonyRegistry</strong> （系统级通知）</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用层代码示例</span>
<span class="hljs-type">TelephonyManager</span> <span class="hljs-variable">tm</span> <span class="hljs-operator">=</span> context.getSystemService(TelephonyManager.class);
tm.registerTelephonyCallback(executor, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TelephonyCallback</span>.CallStateListener() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCallStateChanged</span><span class="hljs-params">(<span class="hljs-type">int</span> state)</span> {
        <span class="hljs-comment">// 处理通话状态变化</span>
    }
});
</code></pre>
<hr/>
<h2 data-id="heading-26">完整的消息流时序图</h2>
<pre><code class="hljs language-scss" lang="scss">时间轴 ────────────────────────────────────────────────────────────────
│
├─ <span class="hljs-selector-attr">[1]</span> Modem检测到通话状态变化
│       └─→ 发送未经请求的回复 (RING, NO CARRIER, etc.)
│
├─ <span class="hljs-selector-attr">[2]</span> Vendor RIL接收AT指示
│       └─→ 调用 <span class="hljs-built_in">RIL_onUnsolicitedResponse</span>()
│
├─ <span class="hljs-selector-attr">[3]</span> RIL Framework处理
│       ├─→ 获取Partial Wakelock
│       └─→ 调用HIDL response handler (callStateChangedInd)
│
├─ <span class="hljs-selector-attr">[4]</span> HIDL Service转发
│       └─→ RadioIndication<span class="hljs-selector-class">.callStateChanged</span>() (AIDL)
│
├─ <span class="hljs-selector-attr">[5]</span> Java Framework接收
│       └─→ VoiceIndication<span class="hljs-selector-class">.callStateChanged</span>()
│           └─→ RIL<span class="hljs-selector-class">.mCallStateRegistrants</span><span class="hljs-selector-class">.notifyRegistrants</span>()
│
├─ <span class="hljs-selector-attr">[6]</span> CallTracker感知状态变化
│       └─→ EVENT_CALL_STATE_CHANGE handler
│           └─→ <span class="hljs-built_in">pollCallsWhenSafe</span>()
│               └─→ RIL<span class="hljs-selector-class">.getCurrentCalls</span>() <span class="hljs-selector-attr">[同步轮询]</span>
│
├─ <span class="hljs-selector-attr">[7]</span> Modem返回通话列表
│       └─→ AT+CLCC响应 (多条+CLCC行)
│
├─ <span class="hljs-selector-attr">[8]</span> GsmCdmaCallTracker处理
│       ├─→ EVENT_POLL_CALLS_RESULT handler
│       ├─→ <span class="hljs-built_in">handlePollCalls</span>(AsyncResult ar)
│       ├─→ 比较并更新mConnections<span class="hljs-selector-attr">[]</span>数组
│       ├─→ <span class="hljs-built_in">updatePhoneState</span>()
│       ├─→ mPhone<span class="hljs-selector-class">.notifyPreciseCallStateChanged</span>()
│       └─→ mPhone<span class="hljs-selector-class">.notifyNewRingingConnection</span>()
│
├─ <span class="hljs-selector-attr">[9]</span> Phone层通知
│       └─→ TelephonyRegistry广播
│           └─→ 通知系统服务和应用
│
└─ <span class="hljs-selector-attr">[10]</span> 应用层获得通话状态更新
        └─→ TelephonyCallback<span class="hljs-selector-class">.onCallStateChanged</span>()
</code></pre>
<hr/>
<h2 data-id="heading-27">关键数据结构</h2>
<h3 data-id="heading-28">1. RIL_Call 结构体</h3>
<p>定义单个通话的状态信息：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ril.h</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">int</span> index;              <span class="hljs-comment">// 通话索引</span>
    <span class="hljs-type">int</span> isMT;               <span class="hljs-comment">// 1=来电, 0=去电</span>
    RIL_CallState state;    <span class="hljs-comment">// 通话状态 (ACTIVE/HOLDING/DIALING/等)</span>
    <span class="hljs-type">int</span> mode;               <span class="hljs-comment">// 通话模式 (0=语音, 1=数据, 等)</span>
    <span class="hljs-type">int</span> mpty;               <span class="hljs-comment">// 0=非多方通话, 1=多方通话</span>
    <span class="hljs-comment">// ... 其他字段 ...</span>
} RIL_Call;
</code></pre>
<h3 data-id="heading-29">2. DriverCall 结构体（Java端）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DriverCall</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> {
        ACTIVE, HOLDING, DIALING, ALERTING, INCOMING, WAITING
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> index;
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> isMT;       <span class="hljs-comment">// Mobile Terminated (incoming)</span>
    <span class="hljs-keyword">public</span> State state;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> number;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> type;
    <span class="hljs-comment">// ... 其他字段 ...</span>
}
</code></pre>
<h3 data-id="heading-30">3. GsmCdmaConnection 类</h3>
<p>代表一条逻辑通话连接，维护其状态、时间戳等信息。</p>
<hr/>
<h2 data-id="heading-31">Wakelock机制</h2>
<p>为了防止CPU因接收Unsolicited Response而过度休眠/唤醒，RIL Framework采用了Wakelock机制：</p>
<ol>
<li><strong>Unsolicited Response到达时</strong> → 获取Partial Wakelock</li>
<li><strong>消息处理完成后</strong> → 设置200ms超时</li>
<li><strong>超时后</strong> → 释放Wakelock，允许CPU休眠</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 700-718 行</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">wakeTimeoutCallback</span> <span class="hljs-params">(<span class="hljs-type">void</span> *param)</span> </span>{
    <span class="hljs-keyword">if</span> (s_callbacks.version &gt;= <span class="hljs-number">13</span>) {
        <span class="hljs-keyword">if</span> (param == <span class="hljs-literal">NULL</span>) {
            s_wakelock_count = <span class="hljs-number">0</span>;
            <span class="hljs-built_in">release_wake_lock</span>(ANDROID_WAKE_LOCK_NAME);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-32">性能优化点</h2>
<ol>
<li><strong>Partial Wakelock</strong> - 只唤醒CPU，不点亮屏幕</li>
<li><strong>轮询延迟</strong> - 对于未完成状态（DIALING/ALERTING/INCOMING/WAITING），设置轮询延迟（通常500ms）</li>
<li><strong>去重机制</strong> - 冗余或重复的通话状态消息被容忍（如文档中所说）</li>
<li><strong>异步处理</strong> - 所有操作都在RIL事件循环中异步进行</li>
</ol>
<hr/>
<h2 data-id="heading-33">异常处理</h2>
<p>当Radio不可用时：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 854-857 行</span>
<span class="hljs-keyword">if</span> (ar.exception == <span class="hljs-literal">null</span>) {
    polledCalls = (List)ar.result;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isCommandExceptionRadioNotAvailable(ar.exception)) {
    polledCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();  <span class="hljs-comment">// 清空通话列表</span>
} <span class="hljs-keyword">else</span> {
    pollCallsAfterDelay();  <span class="hljs-comment">// 稍后重试</span>
}
</code></pre>
<hr/>
<p>这个流程展示了Android Telephony系统的高度分层设计，从底层Modem事件到上层应用通知，涉及多个进程间的通信和同步机制。</p>
<p>我已经为你详细总结了<strong>Android Telephony通话状态更新消息的完整上报流程</strong>。这个分析涵盖了从Modem底层到上层应用的9个关键阶段：</p>
<h2 data-id="heading-34">核心要点速览：</h2>
<ol>
<li><strong>Modem主动上报</strong> - 发送RING/NO CARRIER等未经请求的回复</li>
<li><strong>Vendor RIL处理</strong> - 解析AT指令，调用RIL_onUnsolicitedResponse</li>
<li><strong>RIL Framework</strong> - 获取Wakelock，通过HIDL转发消息</li>
<li><strong>HIDL Service</strong> - 将C++消息转换为Java AIDL调用</li>
<li><strong>Java Framework</strong> - VoiceIndication通知CallStateRegistrants</li>
<li><strong>CallTracker轮询</strong> - 主动调用getCurrentCalls查询通话列表</li>
<li><strong>解析通话列表</strong> - 处理Modem返回的AT+CLCC响应</li>
<li><strong>状态更新</strong> - GsmCdmaCallTracker更新本地通话对象</li>
<li><strong>应用感知</strong> - 通过TelephonyCallback通知上层应用</li>
</ol>
<p>关键的<strong>设计模式</strong>包括：</p>
<ul>
<li>✅ <strong>主动轮询</strong> - 上报只是信号，通话详情需轮询获取</li>
<li>✅ <strong>Wakelock管理</strong> - 防止CPU过度休眠</li>
<li>✅ <strong>分层通信</strong> - Native/HAL/Java各层清晰解耦</li>
<li>✅ <strong>异步处理</strong> - 所有操作都在事件循环中进行</li>
</ul>
<p>如果你需要深入了解特定阶段（如AT指令的详细解析、HIDL消息转换、或特定通话操作的实现），我可以提供更详细的代码分析！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue Router导航守卫中使用ElMessageBox的坑点与解决方案]]></title>    <link>https://juejin.cn/post/7603294029531725875</link>    <guid>https://juejin.cn/post/7603294029531725875</guid>    <pubDate>2026-02-06T05:37:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603294029531725875" data-draft-id="7603294029531693107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue Router导航守卫中使用ElMessageBox的坑点与解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T05:37:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="puhaha"/> <meta itemprop="url" content="https://juejin.cn/user/2665652787090318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue Router导航守卫中使用ElMessageBox的坑点与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2665652787090318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    puhaha
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:37:14.000Z" title="Fri Feb 06 2026 05:37:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>在Vue 3 + Vue Router项目中，我们经常需要在用户离开页面前进行确认，特别是当表单有未保存的更改时。<code>onBeforeRouteLeave</code> 与 Element Plus 的 <code>ElMessageBox.confirm</code> 结合使用是一个常见方案，但在实际应用中存在不少坑点。</p>
<h2 data-id="heading-1">直接上代码</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onBeforeRouteLeave</span>(<span class="hljs-keyword">async</span> (to, <span class="hljs-keyword">from</span>, next) =&gt; {
  <span class="hljs-keyword">if</span> (!modelDirty.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>()
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'还未保存，离开会丢失，确定继续吗？'</span>, <span class="hljs-string">'提示'</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">'取消'</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
      <span class="hljs-attr">closeOnHashChange</span>: <span class="hljs-literal">false</span>
    })
    modelDirty.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    <span class="hljs-title function_">next</span>()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">next</span>(<span class="hljs-literal">false</span>)
  }
})
</code></pre>
<h2 data-id="heading-2">坑点梳理</h2>
<h3 data-id="heading-3">坑点1：<code>next()</code> 调用时机问题</h3>
<p><strong>问题描述</strong>：在异步操作中忘记调用 <code>next()</code>，或者重复调用</p>
<p>javascript</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// ❌ 错误示例：可能在某些路径下未调用<span class="hljs-keyword">next</span>
onBeforeRouteLeave(<span class="hljs-keyword">async</span> (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!dirty) {
    // 这里没有调用 <span class="hljs-keyword">next</span>()！
    <span class="hljs-keyword">return</span>
  }
  // ...其他逻辑
})
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确示例：确保所有路径都调用next</span>
<span class="hljs-title function_">onBeforeRouteLeave</span>(<span class="hljs-keyword">async</span> (to, <span class="hljs-keyword">from</span>, next) =&gt; {
  <span class="hljs-keyword">if</span> (!modelDirty.<span class="hljs-property">value</span>) {
    <span class="hljs-title function_">next</span>() <span class="hljs-comment">// 确保这里也调用next</span>
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">// ...其他逻辑</span>
})
</code></pre>
<h3 data-id="heading-4">坑点2：<code>closeOnHashChange</code> 设置的必要性</h3>
<p><strong>问题描述</strong>：用户点击浏览器前进/后退按钮时，hash变化可能导致MessageBox意外关闭</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 必须设置 closeOnHashChange: false</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'提示内容'</span>, <span class="hljs-string">'标题'</span>, {
  <span class="hljs-comment">// ...其他配置</span>
  <span class="hljs-attr">closeOnHashChange</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 防止路由hash变化自动关闭</span>
  <span class="hljs-attr">closeOnClickModal</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 防止点击遮罩层关闭</span>
  <span class="hljs-attr">closeOnPressEscape</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 防止ESC键关闭（可选）</span>
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Hash 到 HyperLogLog：Redis 海量 UV 统计的 3 种高阶玩法]]></title>    <link>https://juejin.cn/post/7603227363822567450</link>    <guid>https://juejin.cn/post/7603227363822567450</guid>    <pubDate>2026-02-06T05:42:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603227363822567450" data-draft-id="7603283691457150986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Hash 到 HyperLogLog：Redis 海量 UV 统计的 3 种高阶玩法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T05:42:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Hash 到 HyperLogLog：Redis 海量 UV 统计的 3 种高阶玩法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:42:51.000Z" title="Fri Feb 06 2026 05:42:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">真实业务场景</h2>
<p>假设我们正在开发一个电商大促活动页，产品经理提了一个“简单”的需求：我们需要实时显示“当前正在浏览商品的用户数”。这个数字每秒可能变化数万次。在 10 万级并发下，传统关系型数据库会面临什么问题？</p>
<p><strong>经典错误场景：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Java 初学者的常见做法</span>
public synchronized void <span class="hljs-built_in">addCount</span>() {
    int count = <span class="hljs-built_in">getFromMySQL</span>();
    <span class="hljs-built_in">updateMySQL</span>(count + <span class="hljs-number">1</span>);
}
</code></pre>
<p>上述代码在高并发下会导致：</p>
<ol>
<li>数据库连接池过载（超时错误）</li>
<li>行锁竞争（死锁风险）</li>
<li>CPU 飙升至 100%（性能崩溃）</li>
</ol>
<p>这正是我们需要设计 Redis 统计方案的核心原因——在这种场景下，关系型数据库的 ACID 特性反而成了负担。</p>
<h2 data-id="heading-1">Redis 方案的演进</h2>
<h3 data-id="heading-2">阶段 1：Hash 方案——精确统计的起点</h3>
<p><strong>原理：</strong> 使用哈希表记录每个独立访客，适用于对精度要求高、中小型规模的场景。</p>
<pre><code class="hljs language-ini" lang="ini">// 将用户访问记录添加到 Hash
Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)<span class="hljs-comment">;</span>
String <span class="hljs-attr">pageKey</span> = <span class="hljs-string">"page_visit_count:examplePage"</span><span class="hljs-comment">; // 页面访问计数 Key</span>
String <span class="hljs-attr">userId</span> = <span class="hljs-string">"user_123"</span><span class="hljs-comment">; // 已登录用户</span>
String <span class="hljs-attr">visitorId</span> = <span class="hljs-string">"visitor_abc123"</span><span class="hljs-comment">; // 未登录用户</span>

// 使用 HSET 命令添加数据，值简单设为 "1"
jedis.hset(pageKey, userId, "1")<span class="hljs-comment">;</span>
jedis.hset(pageKey, visitorId, "1")<span class="hljs-comment">;</span>

// 统计访问量，直接使用 HLEN 命令获取字段数量
long <span class="hljs-attr">visitCount</span> = jedis.hlen(pageKey)<span class="hljs-comment">;</span>
System.out.println("The page visit count is: " + visitCount)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方法的优点是简单直接——实现容易，查询方便，且精度极高。但缺点也显而易见。</p>
<p>随着访问页面的增加，Key 像滚雪球一样膨胀，链表变长，内存占用迅速飙升，性能逐渐下降。</p>
<p>因此，这种方法更适合流量相对较低的页面，作为初期的尝试。</p>
<h3 data-id="heading-3">阶段 2：Bitmap 方案——空间与性能的平衡</h3>
<p>当用户基数变大时，使用 Hash 在空间上就显得有些浪费了。</p>
<p>这正是 Bitmap 大显身手的时候，它是空间效率的大师。它巧妙地利用了 32 位 int 类型——不再存储一个完整的用户 ID，而是拆解 32 位，每一位代表一个用户，直接节省了 32 倍的空间。</p>
<p>对于已登录用户，其 ID 直接映射到 Bitmap 中的特定位。对于未登录用户，通过哈希算法将随机字符串标识符转换为哈希值**，再映射到特定位。例如，用户 ID 为 5，对应 Bitmap 第 5 位；随机字符串哈希值为 10，对应第 10 位。</p>
<pre><code class="hljs language-ini" lang="ini">// 使用 Bitmap 统计页面访问量
Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)<span class="hljs-comment">;</span>
String <span class="hljs-attr">pageKey</span> = <span class="hljs-string">"bitmap_visit_count:examplePage"</span><span class="hljs-comment">; // Bitmap 访问计数 Key</span>
String <span class="hljs-attr">loginUserId</span> = <span class="hljs-string">"5"</span><span class="hljs-comment">; // 已登录用户 ID</span>
String <span class="hljs-attr">nonLoginUserKey</span> = <span class="hljs-string">"random_str_123"</span><span class="hljs-comment">; // 未登录用户的随机 Key</span>

// 对于已登录用户，直接设置对应位
jedis.setbit(pageKey, Long.parseLong(loginUserId), true)<span class="hljs-comment">;</span>

// 对于未登录用户，先对 Key 进行哈希，再设置位
String <span class="hljs-attr">hashValue</span> = DigestUtils.md5DigestAsHex(nonLoginUserKey.getBytes())<span class="hljs-comment">;</span>
long <span class="hljs-attr">hashBitIndex</span> = Long.parseLong(hashValue.substring(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>), <span class="hljs-number">16</span>) % Long.MAX_VALUE<span class="hljs-comment">;</span>
jedis.setbit(pageKey, hashBitIndex, true)<span class="hljs-comment">;</span>

// 使用 BITCOUNT 命令统计访问量
long <span class="hljs-attr">visitCount</span> = jedis.bitcount(pageKey)<span class="hljs-comment">;</span>
System.out.println("The page visit count is: " + visitCount)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方法的优势在于极小的内存占用和便捷的查询，甚至可以检查特定用户是否访问过页面。</p>
<p>但也存在明显的缺点。多个用户可能会碰撞到同一位上，导致统计略有偏差。此外，如果用户分布稀疏——例如用户 ID 是 1 亿——则需要分配 1 亿个位，可能会造成内存浪费。</p>
<p>因此，这种方法更适合用户分布相对密集的场景。</p>
<h3 data-id="heading-4">阶段 3：HyperLogLog 方案——超大数据量的“量子”统计</h3>
<p><strong>突破性思维：</strong> 通常，系统不需要绝对精确的数据，可以用可控的误差换取内存和性能的巨大提升。</p>
<p>它不再追求记录每个用户的确切计数，而是使用概率算法估算近似访问量，误差控制在 0.81% 以内，这在实际应用中通常已经足够。</p>
<pre><code class="hljs language-ini" lang="ini">// 使用 HyperLogLog 统计页面访问量
Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)<span class="hljs-comment">;</span>
String <span class="hljs-attr">pageKey</span> = <span class="hljs-string">"hyperloglog_visit_count:examplePage"</span><span class="hljs-comment">; // HyperLogLog 访问计数 Key</span>
String <span class="hljs-attr">userId</span> = <span class="hljs-string">"user_456"</span><span class="hljs-comment">; // 用户标识，可以是 ID 或其他唯一标识</span>

// 使用 PFADD 命令添加用户访问记录
jedis.pfadd(pageKey, userId)<span class="hljs-comment">;</span>

// 使用 PFCOUNT 命令统计访问量
long <span class="hljs-attr">approxVisitCount</span> = jedis.pfcount(pageKey)<span class="hljs-comment">;</span>
System.out.println("The approximate page visit count is: " + approxVisitCount)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>这三种方案各有所长。</p>
<p>Hash 就像一本细致的账本，适用于小规模、高精度的统计。Bitmap 是空间压缩的大师，适合用户分布密集的才中等规模场景。HyperLogLog 则是概率统计专家，专为超高并发、高流量的网站设计。</p>
<p>在实际项目中，我们需要根据业务场景灵活选择，从而在并发战场中掌控全局，精准高效地统计用户访问量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Ansible实现免密钥的原理]]></title>    <link>https://juejin.cn/post/7603252259561734180</link>    <guid>https://juejin.cn/post/7603252259561734180</guid>    <pubDate>2026-02-06T03:20:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603252259561734180" data-draft-id="7602512064976289855" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Ansible实现免密钥的原理"/> <meta itemprop="keywords" content="Linux,运维"/> <meta itemprop="datePublished" content="2026-02-06T03:20:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sheffield"/> <meta itemprop="url" content="https://juejin.cn/user/362164852109770"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Ansible实现免密钥的原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362164852109770/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sheffield
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:20:50.000Z" title="Fri Feb 06 2026 03:20:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SSH 免密是自动化运维的基础，Ansible远程管控、脚本自动执行都得靠它。用大白话讲清免密核心原理，拆解3个核心步骤，内容极简、好懂、能直接用。</p>
<h2 data-id="heading-0">一、SSH 免密核心原理</h2>
<p>SSH 免密靠<strong>非对称加密</strong>，全程无明文密码传输，控制端Rsync（172.16.0.61）免密控制被控制端NFS/DataBase（172.16.0.41），核心就3点：</p>
<ol>
<li>控制端生成<strong>密钥对</strong>：私钥（id_rsa）留本地，相当于「个人身份证」，绝不能泄露；公钥（id_rsa.pub）可公开，相当于「免密授权函」。</li>
<li>把控制端的<strong>公钥</strong>，放到被控制端的「免密白名单」（/root/.ssh/authorized_keys）里。</li>
<li>控制端连被控制端时，用私钥做身份验证，被控制端用白名单里的公钥验证，匹配上就直接连接，不用输密码。</li>
</ol>
<h2 data-id="heading-1">二、你的实战Playbook</h2>
<p>实现<strong>172.16.0.61 免密控制 172.16.0.41</strong>的极简Playbook，也是我个人环境的写法，重复执行不报错：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">实现SSH免密登录</span>
  <span class="hljs-attr">hosts:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.61</span>  <span class="hljs-comment"># 控制端（生成密钥的机器）</span>
  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span>
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-comment"># 步骤1：控制端生成密钥对，已存在则跳过</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">生成密钥</span>
      <span class="hljs-attr">command:</span> <span class="hljs-string">ssh-keygen</span> <span class="hljs-string">-t</span> <span class="hljs-string">rsa</span> <span class="hljs-string">-N</span> <span class="hljs-string">""</span> <span class="hljs-string">-f</span> <span class="hljs-string">/root/.ssh/id_rsa</span>
      <span class="hljs-attr">args:</span>
        <span class="hljs-attr">creates:</span> <span class="hljs-string">/root/.ssh/id_rsa</span>

    <span class="hljs-comment"># 步骤2：读取控制端公钥，注册为变量</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">读取公钥</span>
      <span class="hljs-attr">slurp:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/.ssh/id_rsa.pub</span>
      <span class="hljs-attr">register:</span> <span class="hljs-string">id_rsa_pub</span>

    <span class="hljs-comment"># 步骤3：把公钥写入被控制端41的免密白名单</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">免密控制41</span>
      <span class="hljs-attr">authorized_key:</span>
        <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ id_rsa_pub.content | b64decode }}</span>"</span>
      <span class="hljs-attr">delegate_to:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.41</span>
</code></pre>
<h2 data-id="heading-2">三、3 步拆解：每一步做什么？为什么这么做？</h2>
<h3 data-id="heading-3">步骤 1：控制端生成密钥对</h3>
<p><strong>核心作用</strong>：给控制端生成「身份证+授权函」，命令<code>ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa</code>：</p>
<ul>
<li><code>-t rsa</code>：用最常用的 RSA 加密算法，安全又兼容；</li>
<li><code>-N ""</code>：密钥无密码，自动化场景必须加，否则会弹窗输密码中断任务；</li>
<li><code>creates: /root/.ssh/id_rsa</code>：关键！如果密钥已存在，直接跳过，避免重复生成提示覆盖文件。</li>
</ul>
<p><strong>执行结果</strong>：控制端<code>/root/.ssh/</code>下生成 2 个文件 ——<code>id_rsa</code>（私钥，权限 600，严禁泄露）、<code>id_rsa.pub</code>（公钥，可自由传输）。</p>
<h3 data-id="heading-4">步骤 2：读取公钥并注册变量</h3>
<p><strong>核心作用</strong>：把公钥内容读出来，供后续步骤使用。</p>
<ul>
<li>用<code>slurp</code>模块而非简单的<code>cat</code>命令：自动对内容做Base64编码，跨机传输不丢内容、无编码问题；</li>
<li><code>register: id_rsa_pub</code>：把编码后的公钥存到变量里，后续直接调用就行。</li>
</ul>
<h3 data-id="heading-5">步骤 3：写入被控制端免密白名单</h3>
<p><strong>核心作用</strong>：把控制端的「授权函」，放到被控制端41的白名单里，实现免密。</p>
<ul>
<li><code>authorized_key</code>：Ansible专用管理免密白名单的模块，自动校验公钥格式，避免重复写入，比手动敲命令安全；</li>
<li><code>{{ id_rsa_pub.content | b64decode }}</code>：把步骤2编码的公钥解码为原始内容，正常写入白名单；</li>
<li><code>delegate_to: 172.16.0.41</code>：核心指令！把这个任务的执行目标，从控制端61切换到被控制端41，不用手动登录41操作；</li>
<li><code>user: root</code>：公钥写入41服务器root用户的白名单，控制端后续以root身份免密连接41。</li>
</ul>
<h2 data-id="heading-6">四、一键验证：免密是否生效？</h2>
<p>在控制端61执行以下命令，<strong>不用输密码</strong>就能连接41，说明配置成功：
运行</p>
<pre><code class="hljs language-css" lang="css">ssh root<span class="hljs-keyword">@172</span>.16.0.41
</code></pre>
<h2 data-id="heading-7">五、快速扩展：一键免密多台服务器</h2>
<p>如果需要同时免密41、31，只需把步骤3改成遍历IP，一行搞定多台：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">免密控制多台服务器</span>
  <span class="hljs-attr">authorized_key:</span>
    <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ id_rsa_pub.content | b64decode }}</span>"</span>
  <span class="hljs-attr">delegate_to:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item }}</span>"</span>
  <span class="hljs-attr">with_items:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.41</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.31</span>
</code></pre>
<h2 data-id="heading-8">总结</h2>
<ol>
<li>SSH免密核心：<strong>控制端生密钥对，公钥写入被控制端的 /root/.ssh/authorized_keys</strong>；</li>
<li>Ansible实现3步：<strong>生成密钥→读取公钥→写入远端白名单</strong>，全程自动化，重复执行不报错；</li>
<li>关键要点：<code>creates</code>防重复生成、<code>slurp</code>保公钥完整、<code>delegate_to</code>切执行目标，这是生产环境规范写法。</li>
</ol>
<h2 data-id="heading-9">最后人话举个栗子🌰：由于此时此刻的运维机对控制的两台机器都做了免密，我们把其中一台称为小明，一台称为小美，运维机有两家智能锁的编辑权限。某一天，小明要去小美家修家电，但是小美家的智能锁不认识小明，小明怎么按指纹都无济于事。这个时候，运维机就可以向小明要手指指纹，然后保存一下，进入小美家的智能锁后台系统，输入小明的指纹。于是，小明再次按压指纹，就可以进入小美的家中了，也可以操控小美家的电灯电视洗衣机了🤭</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent应用开发初探]]></title>    <link>https://juejin.cn/post/7603352061469442090</link>    <guid>https://juejin.cn/post/7603352061469442090</guid>    <pubDate>2026-02-06T03:38:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352061469442090" data-draft-id="7603352061469425706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent应用开发初探"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-02-06T03:38:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户7694900413493"/> <meta itemprop="url" content="https://juejin.cn/user/442428164682333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent应用开发初探
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/442428164682333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户7694900413493
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:38:03.000Z" title="Fri Feb 06 2026 03:38:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">一、从 LLM 到 Agent</h2>
<p>LLM：基于Transform + 大参数量 + 大数据量 =&gt; 从概率上预测文本接下来的内容，使文本得到合理的“延续”，最终表现为像有思考能力的“大脑🧠”一样，能够基于问题回答问题。</p>
<p>Agent：基于LLM能力，提供“四肢”，使得像人一样，不仅能思考还能行动。所谓的“四肢”，可以理解为由用户实时数据+工具，使得LLM与现实建立连接，并且能对现实产生影响。</p>
<h2 data-id="heading-1">二、AI Agent的系统组成</h2>
<h3 data-id="heading-2">1. 上下文(Context &amp; Memory)</h3>
<blockquote>
<p>上下文：历史对话记录，通常表现为User-AI一问一答的形式</p>
<p>记忆：AI回复能够基于历史对话进行回复，像拥有记忆一样</p>
</blockquote>
<h4 data-id="heading-3">1. 记忆实现</h4>
<p>每次请求模型时，携带历史对话窗口信息，当作query的一部分。</p>
<p>对话窗口通常实现为滑动窗口，维护最近n轮对话信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3706679e3e541fdbbd6209eb7d4702c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=RtPvizwYThLHIabxM7ougJyhwDU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-4">2. 上下文维护</h4>
<p>在最简单（滑动窗口）实现的<strong>短期</strong>记忆基础上，考虑如何<strong>更高效维护长短记忆（降低成本</strong> <strong>token</strong> <strong>消耗</strong>）、<strong>维护长期记忆</strong>。</p>
<p><strong>降低成本：</strong></p>
<ol>
<li>多轮对话改写：将<strong>能够</strong>压缩的多轮对话，精简至一条。</li>
<li>阶段总结：总结窗口内前m轮对话为一条，最近n-m条不变。</li>
</ol>
<p><strong>维护长期记忆：</strong></p>
<ol>
<li>滚动摘要：每n轮对话，总结一次对话内容，将总结结果维护至系统提示词or向量化嵌入，进行文档召回。</li>
</ol>
<h3 data-id="heading-5">2. 检索增强 (RAG)</h3>
<blockquote>
<p>提供<strong>外部数据源信息</strong>作为模型生成内容时的参考。</p>
</blockquote>
<p>文档：用户提供的文本信息，欲为模型提供信息（外部数据源）。</p>
<p>文档解析：读取文档中的文本内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1e3bf1f6e3f4f1e8ecad0224cf763df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=l9UtxII6Kts6P0j6PAR7lMCEks4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>文档切分：将文本内容切分成小的一段（chunk）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4a2298fd5d84731aa6f718c81e11f3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=7MB%2FQvkklg9NsA%2FrGiygwmK9bPM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>向量化：通过向量化模型将文本解析成多维向量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe99e552afd4d02b586fd7b069e5205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=NZtC8373h%2FMSSSjJWWKAHSR7Acg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>嵌入：向量存储到向量数据库的动作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bad3f22608184fc9983441fcfa3b9b63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=yaGrLw%2B8nvxIu40ECGi0rrsFuMw%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>文档召回：根据query，将query向量化，从向量化数据库中根据<strong>向量相似度计算</strong>进行文档召回。</p>
<p>重排序：应用于文档召回的结果，再做一次<strong>精排</strong>过滤。</p>
<p>向量与文本之间的关系：</p>
<ol>
<li>
<p>向量时是文本在<strong>语义空间</strong>里的<strong>位置坐标</strong>。</p>
</li>
<li>
<p>每一个维度表示一种语义，用来区分文本的表达，同时向量维度越高，表达力越高，同时对向量化模型的能力与向量的存储要求也高。</p>
</li>
</ol>
<p>eg.</p>
<p>文本：你是谁</p>
<p>[   0.02134, -0.11782,  0.33491, -0.05217,  0.90831, -0.44102,  0.12944, -0.77230,   0.05681,  0.24899, -0.31540,  0.60127, -0.04498,  0.18733,  0.09211, -0.50988,   0.41102, -0.03277,  0.27561, -0.19844,  0.00321,  0.81277, -0.62108,  0.14419,   ...   -0.08211,  0.19344, -0.44720,  0.06177 ]</p>
<p>RAG核心流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc4966c39f40411f83842e0d4e2b31f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=CMKZEhYgmRIl6uBHFv9aaeb8pOo%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h3 data-id="heading-6">3. 工具调用 (Function calling)</h3>
<blockquote>
<p>给模型提供的工具，使得能够与外界进行<strong>交互与应用</strong>，实现<strong>数据交换</strong>或<strong>产生影响。</strong></p>
<p>模型通过开发者对工具的定义，判断什么情况下需要调用工具。</p>
</blockquote>
<p>function calling流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6ceffcdf7b5452486799b0952969e27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=DnH1iKQr0A%2B8wEeSlmzUTtIVbIc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>1次工具调用 =&gt; 与至少模型交互2回合</p>
<h4 data-id="heading-7">MCP</h4>
<blockquote>
<p>大模型与外界数据源交互的统一协议。</p>
</blockquote>
<p>在agent应用中，本质也是一种工具调用（function calling），就是规范协议，方便开发者接入与开发。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16200b11e2514f018ec48668260e9a0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=v9ULzqraeHYScSFzC9woqF0KG60%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h2 data-id="heading-8">三、大模型应用框架</h2>
<blockquote>
<p>引言：</p>
<p>模型只提供生成能力，以工程的角度来看就是提供一个对话API，包含模型超参、上下文信息、是否开启流式等等。</p>
<p>但仅依赖模型原生能力，难以构建具备<strong>拟人性、可用性和工程可靠性</strong>的对话系统，因此在实际应用中，还需要围绕模型引入一系列工程能力，包括：</p>
<p>记忆实现、记忆（上下文）维护、提示词工程、检索增强（RAG）、工具调用（辅助生成/产生影响）。</p>
<p>为了更关注工程实现，避免重复实现这些通用能力，就有了大模型应用框架，对上述能力统一进行了抽象和封装，</p>
<p>让开发逻辑聚焦于需要实现什么样的对话能力，而不是控制如何跟模型交互。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50def9559929483eb79972f3738fad16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=1TflBqmvQDoF7dYkSWPhty07TRc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
</blockquote>
<h3 data-id="heading-9">业内主流应用框架</h3>













































<table><thead><tr><th/><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td><strong>维度</strong></td><td><strong>LangChain</strong></td><td><strong>LangChain4j</strong></td><td><strong>Spring AI</strong></td><td><strong>Eino</strong></td><td/></tr><tr><td>语言</td><td>Python</td><td>Java</td><td>Java</td><td>Go</td><td/></tr><tr><td>定位</td><td>LLM 应用框架</td><td>LangChain 的 Java 生态实现</td><td>Spring 体系下的 AI 抽象层</td><td>Go 生态的 LLM 应用框架</td><td/></tr><tr><td>与业务框架融合</td><td>弱（偏独立库）</td><td>中等</td><td>强（Spring 原生）</td><td>中等</td><td/></tr></tbody></table>
<h3 data-id="heading-10">Langchain4j</h3>
<h4 data-id="heading-11">1. 聊天</h4>
<p><strong>语言模型</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1753cc1148c447ddb87d47f72b011a7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=Y%2BhNwRiZ2JCAO4XkI7RngV1Bc4E%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<pre><code class="hljs language-scss" lang="scss">OpenAiChatModel model = OpenAiChatModel<span class="hljs-selector-class">.builder</span>()
        <span class="hljs-selector-class">.apiKey</span>(System.getenv("OPENAI_API_KEY"))
        <span class="hljs-selector-class">.modelName</span>("gpt-<span class="hljs-number">4</span>o-mini")
        <span class="hljs-selector-class">.temperature</span>(<span class="hljs-number">0.3</span>)
        <span class="hljs-selector-class">.timeout</span>(ofSeconds(<span class="hljs-number">60</span>))
        <span class="hljs-selector-class">.build</span>();
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>聊天消息类型</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a49db446dc7d46e68e0e9ce8d43cdd28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=sUulENE6dhTJNWj02ZWfLJJeYl4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p><strong>聊天记忆</strong></p>
<p>ChatMemory接口提供聊天对话存储能力（记忆），可以自实现接口实现持久化存储。langchain4j提供了两种实现：</p>
<ul>
<li><code>MessageWindowChatMemory：</code> 滑动窗口，仅保留最近窗口内的N条对话记录。</li>
</ul>

<ul>
<li><code>MessageWindowChatMemory：</code> 也是滑动窗口，但专注于保留最近N个Token。</li>
</ul>
<p>当有新消息时，会自动回调ChatMemory接口中相关的方法，同步更新对话上下文存储。</p>
<p><strong>聊天示例：</strong></p>
<pre><code class="hljs language-scss" lang="scss">interface Assistant {
    String <span class="hljs-built_in">chat</span>(String message);
}

public static void <span class="hljs-selector-tag">main</span>(String[] args) {
    <span class="hljs-comment">// 1. 最近对话(记忆)存储器</span>
    ChatMemory chatMemory = MessageWindowChatMemory<span class="hljs-selector-class">.withMaxMessages</span>(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 2. 语言模型</span>
    ChatModel model = OpenAiChatModel<span class="hljs-selector-class">.builder</span>()
            <span class="hljs-selector-class">.apiKey</span>(ApiKeys.OPENAI_API_KEY)
            <span class="hljs-selector-class">.modelName</span>(GPT_4_O_MINI)
            <span class="hljs-selector-class">.build</span>();
    
    <span class="hljs-comment">// 3. ai服务</span>
    Assistant assistant = AiServices<span class="hljs-selector-class">.builder</span>(Assistant.class)
            <span class="hljs-selector-class">.chatModel</span>(model)
            <span class="hljs-selector-class">.chatMemory</span>(chatMemory)
            <span class="hljs-selector-class">.build</span>();

    String answer = assistant<span class="hljs-selector-class">.chat</span>("你好，我叫小明");
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(answer); <span class="hljs-comment">// 小明你好，有什么可以帮助你的吗？</span>

    String answerWithName = assistant<span class="hljs-selector-class">.chat</span>("我的名字叫啥");
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(answerWithName); <span class="hljs-comment">// 你叫小明</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-12">2. 工具调用</h4>
<h5 data-id="heading-13"><strong>1. 工具定义</strong></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Tool("对给定的 2 个数字求和")</span>
<span class="hljs-type">double</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-meta">@Tool("返回给定数字的平方根")</span>
<span class="hljs-type">double</span> <span class="hljs-title function_">squareRoot</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> {
    <span class="hljs-keyword">return</span> Math.sqrt(x);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-14"><strong>2. 工具注册</strong></h5>
<pre><code class="hljs language-arduino" lang="arduino">interface MathGenius {
    
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">ask</span><span class="hljs-params">(<span class="hljs-type">String</span> question)</span></span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    
    @<span class="hljs-function">Tool
    <span class="hljs-type">double</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
        <span class="hljs-keyword">return</span> a + b;
    }

    @<span class="hljs-function">Tool
    <span class="hljs-type">double</span> <span class="hljs-title">squareRoot</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> </span>{
        <span class="hljs-keyword">return</span> Math.<span class="hljs-built_in">sqrt</span>(x);
    }
}

MathGenius mathGenius = AiServices.<span class="hljs-built_in">builder</span>(MathGenius.<span class="hljs-keyword">class</span>)
    .<span class="hljs-built_in">chatLanguageModel</span>(model)
    .<span class="hljs-built_in">tools</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Calculator</span>())
    .<span class="hljs-built_in">build</span>();

<span class="hljs-type">String</span> answer = mathGenius.<span class="hljs-built_in">ask</span>(<span class="hljs-string">"475695037565 的平方根是多少？"</span>);

System.out.<span class="hljs-built_in">println</span>(answer); <span class="hljs-comment">// 475695037565 的平方根是 689706.486532。</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-15"><strong>3. 调用过程</strong></h5>
<pre><code class="hljs language-markdown" lang="markdown">请求 1：
<span class="hljs-bullet">-</span> 消息：
<span class="hljs-bullet">    -</span> UserMessage：
<span class="hljs-bullet">        -</span> 文本：475695037565 的平方根是多少？
<span class="hljs-bullet">-</span> 工具：
<span class="hljs-bullet">    -</span> sum(double a, double b)：对给定的 2 个数字求和
<span class="hljs-bullet">    -</span> squareRoot(double x)：返回给定数字的平方根

响应 1：
<span class="hljs-bullet">-</span> AiMessage：
<span class="hljs-bullet">    -</span> toolExecutionRequests：
<span class="hljs-bullet">        -</span> squareRoot(475695037565)


请求 2：
<span class="hljs-bullet">-</span> 消息：
<span class="hljs-bullet">    -</span> UserMessage：
<span class="hljs-bullet">        -</span> 文本：475695037565 的平方根是多少？
<span class="hljs-bullet">    -</span> AiMessage：
<span class="hljs-bullet">        -</span> toolExecutionRequests：
<span class="hljs-bullet">            -</span> squareRoot(475695037565)
<span class="hljs-bullet">    -</span> ToolExecutionResultMessage：
<span class="hljs-bullet">        -</span> 文本：689706.486532

响应 2：
<span class="hljs-bullet">-</span> AiMessage：
<span class="hljs-bullet">    -</span> 文本：475695037565 的平方根是 689706.486532。
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-16">4. MCP接入</h5>
<blockquote>
<p>框架提供mcp客户端的封装，只需要注册mcp客户端，即可像调工具一样调用mcp服务。</p>
</blockquote>
<p><strong>接入示例</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">String</span> dashscopeApiKey = <span class="hljs-string">"api-key"</span>;
        
        <span class="hljs-comment">// 0. mcp客户端鉴权</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; headers = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer "</span> + dashscopeApiKey,
            <span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>
        );
        
        <span class="hljs-comment">// 1. mcp（联网搜索）封装</span>
        <span class="hljs-title class_">McpTransport</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHttpMcpTransport</span>.<span class="hljs-title class_">Builder</span>()
            .<span class="hljs-title function_">url</span>(<span class="hljs-string">"https://dashscope.aliyuncs.com/api/v1/mcps/WebSearch/sse"</span>)
            .<span class="hljs-title function_">customHeaders</span>(headers)
            .<span class="hljs-title function_">logRequests</span>(<span class="hljs-literal">true</span>)
            .<span class="hljs-title function_">logResponses</span>(<span class="hljs-literal">true</span>)
            .<span class="hljs-title function_">build</span>();
        
        <span class="hljs-comment">// 2. mcp注册</span>
        <span class="hljs-title class_">McpClient</span> mcpClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMcpClient</span>.<span class="hljs-title class_">Builder</span>()
            .<span class="hljs-title function_">transport</span>(transport)
            .<span class="hljs-title function_">build</span>();

        <span class="hljs-title class_">McpToolProvider</span> toolProvider = <span class="hljs-title class_">McpToolProvider</span>.<span class="hljs-title function_">builder</span>()
            .<span class="hljs-title function_">mcpClients</span>(<span class="hljs-title class_">List</span>.<span class="hljs-title function_">of</span>(mcpClient))
            .<span class="hljs-title function_">build</span>();
        
        <span class="hljs-comment">// 3. 带有联网搜索能力的ai服务</span>
        <span class="hljs-title class_">Bot</span> bot = <span class="hljs-title class_">AiServices</span>.<span class="hljs-title function_">builder</span>(<span class="hljs-title class_">Bot</span>.<span class="hljs-property">class</span>)
            .<span class="hljs-title function_">chatLanguageModel</span>(model)
            .<span class="hljs-title function_">toolProvider</span>(toolProvider)
            .<span class="hljs-title function_">build</span>()
            .<span class="hljs-title function_">getService</span>();
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-17">3. RAG</h4>
<p><strong>关键词解释</strong></p>
<p>Query：用户输入</p>
<p>Embedding Model： 向量化模型</p>
<p>Embedding Store： 向量化数据库</p>
<p>Relevant Segments： 检索（召回）结果</p>
<p>Retrieval Augmentor： 检索增强器，所有RAG相关的组件封装在该类中。</p>
<p>QueryTransformer： 问题拆分器，如果一次query包含多个问题，会被拆分成子问题。</p>
<p>Content Retrieval：内容检索器，从给定数据源（向量数据库）中检索。</p>
<p>Query Router：query路由器，将拆分的子问题智能路由到检索器中。</p>
<p>Content Aggregator：内容聚合器，规定如何将多个内容检索器的结果聚合。</p>
<p>Content Injector：规定检索结果如何嵌入到原始query中。</p>
<h5 data-id="heading-18">检索流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f159996386943c586c680e610eae538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=OxmUW%2Fv0FS7h30LD68yd5id%2Flmg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p><strong>作业流程</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/223bb2ecdd754898b8bf335a776f2b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=xmA%2BJGT4%2BMY9Cr35qPIdrJqdIsI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue状态管理封神对比：Pinia vs Vuex，到底该弃用谁？（核心差异一文吃透）]]></title>    <link>https://juejin.cn/post/7603201727715672116</link>    <guid>https://juejin.cn/post/7603201727715672116</guid>    <pubDate>2026-02-06T01:35:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603201727715672116" data-draft-id="7602929352717484032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue状态管理封神对比：Pinia vs Vuex，到底该弃用谁？（核心差异一文吃透）"/> <meta itemprop="keywords" content="JavaScript,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-02-06T01:35:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue状态管理封神对比：Pinia vs Vuex，到底该弃用谁？（核心差异一文吃透）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T01:35:39.000Z" title="Fri Feb 06 2026 01:35:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">正文</h2>
<h3 data-id="heading-1">一、前言：为什么要搞懂Pinia和Vuex的区别？</h3>
<p>在Vue项目开发中，状态管理是中大型项目的刚需——当组件间共享数据、跨层级通信频繁时，单纯依靠props/emits、provide/inject会导致代码冗余、状态混乱，此时就需要专门的状态管理工具。</p>
<p>Vuex作为Vue官方早期推出的状态管理库，曾是Vue项目的“标配”；而Pinia作为Vue3官方推荐的新一代状态管理库，凭借更简洁的API、更友好的TS支持，逐渐取代Vuex成为主流。</p>
<p>很多开发者都会困惑：Pinia和Vuex到底有什么区别？新项目该选哪个？旧项目要不要从Vuex迁移到Pinia？本文聚焦两者<strong>核心差异</strong>，不堆砌无关知识点，帮你快速理清选型思路、吃透用法区别。</p>
<h3 data-id="heading-2">二、先明确：两者的核心定位（快速区分）</h3>
<p>在深入对比前，先明确两者的核心定位，避免混淆，快速匹配自身项目需求：</p>
<ul>
<li><strong>Vuex</strong>：Vue官方早期推出的状态管理库，适用于Vue2、Vue3项目，核心采用“单一状态树+模块化”设计，规范严格但用法繁琐，侧重“集中式管理”。</li>
<li><strong>Pinia</strong>：Vue3官方推荐的状态管理库（Vue核心团队开发），可兼容Vue2，核心采用“模块化存储”（无单一状态树限制），API简洁、TS友好，侧重“轻量化、易用性”，是Vuex的替代方案。</li>
</ul>
<p>关键结论：Vue3新项目优先选Pinia；Vue2项目可继续用Vuex，也可迁移到Pinia；小型项目无需状态管理工具，中大型项目优先Pinia。</p>
<h3 data-id="heading-3">三、核心差异拆解（重点！5个维度对比，一目了然）</h3>
<p>以下是Pinia与Vuex（以Vuex 4.x为例，适配Vue3）的核心差异，结合实操体验和项目场景，每一项都对应实际开发中的痛点，建议收藏备用。</p>
<h4 data-id="heading-4">1. 核心架构：单一状态树 vs 模块化存储（最核心差异）</h4>
<p>这是两者最本质的区别，直接决定了用法复杂度和项目适配性：</p>
<h5 data-id="heading-5">Vuex：单一状态树（Single State Tree）</h5>
<p>Vuex的核心设计是“单一状态树”——整个项目的所有状态，都集中在一个大的state对象中，即使是模块化开发，最终也会合并到这个单一状态树中。</p>
<p>痛点：当项目规模扩大，模块化增多时，单一状态树会变得异常庞大，状态查找、调试、维护难度翻倍；且模块化需要手动注册、命名空间（namespaced: true），用法繁琐。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Vuex 4.x 模块化写法（繁琐）</span>
<span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-comment">// 定义模块</span>
<span class="hljs-keyword">const</span> userModule = {
  <span class="hljs-attr">namespaced</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 必须手动开启命名空间，否则状态、方法会冲突</span>
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Vuex'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">5</span> }),
  <span class="hljs-attr">mutations</span>: { <span class="hljs-title function_">setName</span>(<span class="hljs-params">state, name</span>) { state.<span class="hljs-property">name</span> = name } },
  <span class="hljs-attr">actions</span>: { <span class="hljs-title function_">fetchName</span>(<span class="hljs-params">{ commit }</span>) { <span class="hljs-comment">/* 异步逻辑 */</span> } }
}

<span class="hljs-comment">// 单一状态树：所有模块合并到一个store中</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>({
  <span class="hljs-attr">modules</span>: {
    <span class="hljs-attr">user</span>: userModule <span class="hljs-comment">// 注册模块，使用时需加命名空间（user/setName）</span>
  }
})
</code></pre>
<h5 data-id="heading-6">Pinia：模块化存储（无单一状态树限制）</h5>
<p>Pinia摒弃了“单一状态树”，采用“模块化存储”——每个模块（称之为Store）都是独立的，拥有自己的state、actions、getters，无需合并到全局，也无需手动开启命名空间。</p>
<p>优势：结构清晰，每个模块独立维护，调试、维护更简单；无需命名空间，直接调用模块方法即可，用法更简洁。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Pinia 模块化写法（简洁）</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-comment">// 定义一个独立的Store（模块），无需手动注册</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">3</span> }),
  <span class="hljs-attr">actions</span>: { <span class="hljs-title function_">setName</span>(<span class="hljs-params">name</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name } }, <span class="hljs-comment">// 无需mutations，直接修改state</span>
  <span class="hljs-attr">getters</span>: { <span class="hljs-title function_">fullName</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">`Mr. <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span> } }
})

<span class="hljs-comment">// 再定义另一个独立的Store（无需合并）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCartStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'cart'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">list</span>: [] }),
  <span class="hljs-attr">actions</span>: { <span class="hljs-title function_">addCart</span>(<span class="hljs-params">item</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">push</span>(item) } }
})
</code></pre>
<h4 data-id="heading-7">2. API设计：繁琐冗余 vs 简洁易用（开发效率差异）</h4>
<p>Vuex的API设计繁琐，需要区分mutations、actions、getters，且修改状态必须通过mutations；而Pinia简化了API，去掉了mutations，用法更灵活。</p>



































<table><thead><tr><th>特性</th><th>Vuex 4.x</th><th>Pinia</th><th>核心优势</th></tr></thead><tbody><tr><td>状态修改</td><td>必须通过mutations（同步）、actions（异步），不能直接修改state</td><td>无需mutations，可在actions中直接修改state（同步/异步均可）</td><td>Pinia：减少代码冗余，异步逻辑更简洁</td></tr><tr><td>模块化</td><td>需手动注册模块、开启命名空间</td><td>每个defineStore就是一个独立模块，自动隔离</td><td>Pinia：开发效率更高，无需关注命名冲突</td></tr><tr><td>getters</td><td>支持，但用法繁琐，需在模块中定义</td><td>支持，写法简洁，可直接访问state，支持缓存</td><td>Pinia：API更友好，缓存性能更优</td></tr><tr><td>全局注册</td><td>需创建store实例，手动挂载到Vue实例</td><td>只需创建Store，无需手动注册，直接在组件中使用</td><td>Pinia：简化配置，减少冗余代码</td></tr></tbody></table>
<h4 data-id="heading-8">3. TS支持：勉强适配 vs 原生友好（大型项目关键）</h4>
<p>TS支持是两者的核心差异之一，也是大型项目选型的关键因素——Vuex对TS的支持较差，需要手动定义大量类型，而Pinia原生支持TS，无需额外配置。</p>
<h5 data-id="heading-9">Vuex：TS支持繁琐，体验差</h5>
<p>Vuex的API设计没有考虑TS的类型推导，使用TS时，需要手动定义state、mutations、actions的类型，代码冗余，且容易出现类型不匹配的问题。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Vuex + TS 写法（繁琐）</span>
<span class="hljs-keyword">import</span> { createStore, <span class="hljs-title class_">Commit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-comment">// 手动定义state类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserState</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">const</span> userModule = {
  <span class="hljs-attr">namespaced</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">state</span>: (): <span class="hljs-function"><span class="hljs-params">UserState</span> =&gt;</span> ({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Vuex'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">5</span> }),
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-comment">// 手动定义参数类型</span>
    <span class="hljs-title function_">setName</span>(<span class="hljs-params">state: UserState, name: <span class="hljs-built_in">string</span></span>) {
      state.<span class="hljs-property">name</span> = name
    }
  },
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 手动定义commit类型</span>
    <span class="hljs-title function_">fetchName</span>(<span class="hljs-params">{ commit }: { commit: Commit }, name: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'setName'</span>, name)
    }
  }
}
</code></pre>
<h5 data-id="heading-10">Pinia：原生TS支持，零额外配置</h5>
<p>Pinia是基于TS开发的，原生支持类型推导，无需手动定义大量类型，state、actions、getters的类型会自动推导，开发体验极佳，是大型TS项目的首选。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Pinia + TS 写法（简洁，自动类型推导）</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-comment">// 无需手动定义state类型，自动推导</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ 
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia'</span>, <span class="hljs-comment">// 自动推导为string类型</span>
    <span class="hljs-attr">age</span>: <span class="hljs-number">3</span> <span class="hljs-comment">// 自动推导为number类型</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 自动推导参数类型、this类型</span>
    <span class="hljs-title function_">setName</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name <span class="hljs-comment">// this自动关联state类型，不会报错</span>
    }
  },
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-comment">// 自动推导返回值类型</span>
    <span class="hljs-title function_">fullName</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`Mr. <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span> <span class="hljs-comment">// 自动推导为string类型</span>
    }
  }
})
</code></pre>
<h4 data-id="heading-11">4. 性能：略逊 vs 更优（中大型项目感知明显）</h4>
<p>两者的性能差异主要体现在“状态更新”和“模块化渲染”上，小型项目感知不明显，中大型项目差异显著：</p>
<ul>
<li>Vuex：由于采用单一状态树，当某个模块的state更新时，会触发全局state的重新渲染，即使其他模块与该更新无关，也可能出现不必要的性能损耗。</li>
<li>Pinia：每个Store是独立的，状态更新时，只会触发使用该Store的组件重新渲染，不会影响其他模块，性能更优；且Pinia去掉了mutations的中间层，状态更新更高效。</li>
</ul>
<h4 data-id="heading-12">5. 生态与兼容性：成熟 vs 主流（选型参考）</h4>
<ul>
<li><strong>Vuex</strong>：生态成熟，有大量的第三方插件（如vuex-persistedstate用于状态持久化）；兼容Vue2、Vue3，但Vue3中已不再推荐使用，后续不会有重大更新。</li>
<li><strong>Pinia</strong>：生态逐渐完善，官方支持状态持久化（pinia-plugin-persistedstate），且兼容Vue2、Vue3；是Vue3官方推荐的状态管理库，后续会持续迭代更新，生态会越来越完善。</li>
</ul>
<h3 data-id="heading-13">四、实操对比：组件中使用方式（直观感受差异）</h3>
<p>结合组件中的实际使用方式，更直观地感受两者的用法差异，新手可直接对比套用。</p>
<h4 data-id="heading-14">1. Vuex 在组件中使用</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{{ $store.state.user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSetName"</span>&gt;</span>修改名称<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-comment">// 1. 获取store实例</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useStore</span>()

<span class="hljs-comment">// 2. 调用mutations修改状态（必须通过mutations）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSetName</span> = (<span class="hljs-params"/>) =&gt; {
  store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'user/setName'</span>, <span class="hljs-string">'Vuex-Update'</span>) <span class="hljs-comment">// 需加命名空间</span>
}

<span class="hljs-comment">// 3. 调用actions执行异步逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchName</span> = (<span class="hljs-params"/>) =&gt; {
  store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">'user/fetchName'</span>, <span class="hljs-string">'Vuex-Async'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-15">2. Pinia 在组件中使用</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{{ userStore.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>{{ userStore.fullName }}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSetName"</span>&gt;</span>修改名称<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 1. 直接导入对应的Store，无需获取全局实例</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 2. 直接调用actions修改状态（无需mutations）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSetName</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.<span class="hljs-title function_">setName</span>(<span class="hljs-string">'Pinia-Update'</span>) <span class="hljs-comment">// 无需加命名空间，直接调用</span>
}

<span class="hljs-comment">// 3. 调用actions执行异步逻辑（与同步写法一致）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchName</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.<span class="hljs-title function_">fetchName</span>(<span class="hljs-string">'Pinia-Async'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-16">五、选型建议（新手直接抄作业）</h3>
<p>结合项目规模、技术栈、开发需求，给出明确的选型建议，避免盲目选型：</p>
<ol>
<li>Vue3 + 新项目（无论大小）：<strong>优先选Pinia</strong>——API简洁、TS友好、性能更优，符合Vue3的发展趋势，开发效率更高。</li>
<li>Vue3 + 旧项目（已用Vuex）：<strong>可暂不迁移</strong>，但新模块建议用Pinia；若项目重构，可逐步迁移到Pinia。</li>
<li>Vue2 + 项目：<strong>继续用Vuex</strong>，或迁移到Pinia（Pinia兼容Vue2，但需额外配置）；小型Vue2项目无需状态管理工具。</li>
<li>大型TS项目：<strong>必选Pinia</strong>——原生TS支持，减少类型定义冗余，降低维护成本。</li>
<li>小型项目（无复杂状态共享）：<strong>无需使用状态管理工具</strong>，用props/emits、provide/inject即可满足需求，避免过度封装。</li>
</ol>
<h3 data-id="heading-17">六、总结：核心要点（新手必背）</h3>
<p>Pinia不是Vuex的“升级版本”，而是Vue官方推出的“替代方案”，核心优势在于“简洁、易用、TS友好”，两者的核心差异可总结为3句话：</p>
<ol>
<li>架构上：Vuex是单一状态树+繁琐模块化，Pinia是独立模块化+无命名空间，维护更简单；</li>
<li>用法上：Vuex需区分mutations/actions，Pinia去掉mutations，API更简洁，开发效率更高；</li>
<li>体验上：Vuex TS支持差，Pinia原生TS友好，中大型项目性能更优，是Vue3首选。</li>
</ol>
<p>其实两者的核心功能都是“状态管理”，但Pinia解决了Vuex的诸多痛点，更贴合现代Vue项目的开发需求。新手建议直接从Pinia入手，上手简单、易精通；老手可快速迁移，提升开发效率。掌握两者的核心差异，无论选型还是开发，都能游刃有余～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pinia封神用法对比：Setup Store vs Option Store，到底该用哪种？]]></title>    <link>https://juejin.cn/post/7603183929252986932</link>    <guid>https://juejin.cn/post/7603183929252986932</guid>    <pubDate>2026-02-06T01:39:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603183929252986932" data-draft-id="7602936997176115252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pinia封神用法对比：Setup Store vs Option Store，到底该用哪种？"/> <meta itemprop="keywords" content="JavaScript,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-02-06T01:39:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pinia封神用法对比：Setup Store vs Option Store，到底该用哪种？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T01:39:53.000Z" title="Fri Feb 06 2026 01:39:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">正文</h2>
<h3 data-id="heading-1">一、前言：为什么要分清Setup Store和Option Store？</h3>
<p>Pinia作为Vue3官方推荐的状态管理库，彻底摒弃了Vuex的繁琐配置，而它的灵活性核心，就在于支持两种截然不同的Store写法——Setup Store和Option Store。</p>
<p>很多使用Pinia的开发者都会困惑：两种写法到底有什么区别？什么时候用Option Store？什么时候选Setup Store？选错写法不仅会增加代码冗余，还会降低开发效率。</p>
<p>本文聚焦两者<strong>核心差异</strong>，不堆砌无关知识点，结合Vue3 
</p><h3 data-id="heading-2">二、先明确：两者的核心定位（快速区分）</h3>
<p>在深入对比前，先明确两种写法的核心定位，一句话分清，避免混淆：</p>
<ul>
<li><strong>Option Store（选项式Store）</strong> ：Pinia早期推荐写法，模仿Vuex的选项式API（state、getters、actions），结构清晰、规范，上手门槛低，适合简单状态管理场景。</li>
<li><strong>Setup Store（组合式Store）</strong> ：Pinia目前推荐写法，贴合Vue3组合式API（
</li></ul>
<p>关键结论：简单场景（无复杂逻辑、少量状态）用Option Store；复杂场景（多逻辑、多复用、TS友好）用Setup Store；Vue3新项目优先选Setup Store，贴合组合式开发趋势。</p>
<h3 data-id="heading-3">三、核心差异拆解（重点！4个维度对比，一目了然）</h3>
<p>以下是Setup Store与Option Store的核心差异，结合实操代码，每一项都对应实际开发中的用法选择，建议收藏备用（均基于Vue3 + TS演示，适配主流开发场景）。</p>
<h4 data-id="heading-4">1. 写法格式：选项式 vs 组合式（最直观差异）</h4>
<p>两者的写法差异最直观，Option Store是“对象选项”，Setup Store是“函数返回”，结合代码快速感受：</p>
<h5 data-id="heading-5">Option Store：选项式写法（模仿Vuex，规范清晰）</h5>
<p>核心：用对象形式定义state、getters、actions三个选项，结构固定，Pinia会自动处理三者的关联，上手简单，适合新手。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Option Store 写法（src/stores/user.ts）</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-comment">// 定义Option Store，第二个参数是选项对象（state、getters、actions）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-comment">// 状态：存储数据（类似Vue组件的data）</span>
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">false</span>
  }),
  <span class="hljs-comment">// 计算属性：基于state派生数据（类似Vue组件的computed），自动缓存</span>
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">fullName</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> <span class="hljs-string">`Mr. <span class="hljs-subst">${state.name}</span>`</span>, <span class="hljs-comment">// 接收state作为参数</span>
    <span class="hljs-attr">loginText</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">isLogin</span> ? <span class="hljs-string">'退出登录'</span> : <span class="hljs-string">'登录'</span>
  },
  <span class="hljs-comment">// 方法：处理逻辑（同步/异步均可，类似Vue组件的methods）</span>
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 同步修改状态（直接操作this，this指向state）</span>
    <span class="hljs-title function_">setLogin</span>(<span class="hljs-params">status: <span class="hljs-built_in">boolean</span></span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLogin</span> = status
    },
    <span class="hljs-comment">// 异步逻辑（如接口请求）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUserInfo</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>)
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = data.<span class="hljs-property">name</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = data.<span class="hljs-property">age</span>
    }
  }
})
</code></pre>
<h5 data-id="heading-6">Setup Store：组合式写法（贴合Vue3，灵活度高）</h5>
<p>核心：用函数形式定义，内部通过ref/reactive定义状态，用computed定义计算属性，用普通函数定义方法，最后统一返回，完全贴合Vue3组合式API的写法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Setup Store 写法（src/stores/user.ts）</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 定义Setup Store，第二个参数是函数（类似Vue3的setup函数）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1. 用ref/reactive定义状态（替代Option Store的state）</span>
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Pinia'</span>)
  <span class="hljs-keyword">const</span> age = <span class="hljs-title function_">ref</span>(<span class="hljs-number">3</span>)
  <span class="hljs-keyword">const</span> isLogin = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

  <span class="hljs-comment">// 2. 用computed定义计算属性（替代Option Store的getters）</span>
  <span class="hljs-keyword">const</span> fullName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">`Mr. <span class="hljs-subst">${name.value}</span>`</span>)
  <span class="hljs-keyword">const</span> loginText = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> isLogin.<span class="hljs-property">value</span> ? <span class="hljs-string">'退出登录'</span> : <span class="hljs-string">'登录'</span>)

  <span class="hljs-comment">// 3. 用普通函数定义方法（替代Option Store的actions）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setLogin</span> = (<span class="hljs-params">status: <span class="hljs-built_in">boolean</span></span>) =&gt; {
    isLogin.<span class="hljs-property">value</span> = status <span class="hljs-comment">// 操作ref需加.value</span>
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>)
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
    name.<span class="hljs-property">value</span> = data.<span class="hljs-property">name</span>
    age.<span class="hljs-property">value</span> = data.<span class="hljs-property">age</span>
  }

  <span class="hljs-comment">// 关键：必须返回需要暴露给组件使用的状态、计算属性、方法</span>
  <span class="hljs-keyword">return</span> {
    name, age, isLogin,
    fullName, loginText,
    setLogin, fetchUserInfo
  }
})
</code></pre>
<h4 data-id="heading-7">2. 核心特性：固定结构 vs 灵活自由（开发效率差异）</h4>
<p>除了写法不同，两者在核心特性上的差异，直接决定了适配场景，用表格清晰对比：</p>









































<table><thead><tr><th>特性</th><th>Option Store（选项式）</th><th>Setup Store（组合式）</th><th>核心优势</th></tr></thead><tbody><tr><td>状态定义</td><td>固定在state选项中，无需手动暴露</td><td>用ref/reactive定义，需手动返回暴露</td><td>Setup Store：可灵活拆分状态，支持局部状态</td></tr><tr><td>计算属性</td><td>固定在getters选项，自动接收state，自动缓存</td><td>用computed定义，需手动返回，缓存逻辑一致</td><td>两者一致，Option Store更规范，Setup Store更灵活</td></tr><tr><td>方法定义</td><td>固定在actions选项，this指向state，无需加.value</td><td>普通函数，操作ref需加.value，this指向undefined</td><td>Option Store上手简单，Setup Store贴合组合式API</td></tr><tr><td>逻辑复用</td><td>难以拆分复用复杂逻辑，结构固定死板</td><td>可拆分逻辑为独立函数，自由组合、复用性强</td><td>Setup Store：复杂场景开发效率翻倍</td></tr><tr><td>TS支持</td><td>支持，但需手动定义部分类型，推导不够灵活</td><td>原生TS友好，ref/reactive自动推导类型，零额外配置</td><td>Setup Store：TS项目首选，类型体验更优</td></tr></tbody></table>
<h4 data-id="heading-8">3. 组件中使用：用法一致，体验略有差异</h4>
<p>值得注意的是，无论哪种Store写法，在Vue组件中使用的方式完全一致，无需修改组件代码，仅Store内部定义不同，示例如下：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>姓名：{{ userStore.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>全称：{{ userStore.fullName }}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"userStore.setLogin(true)"</span>&gt;</span>{{ userStore.loginText }}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 导入Store（无论Setup还是Option写法，导入方式一致）</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 调用异步方法（用法一致）</span>
userStore.<span class="hljs-title function_">fetchUserInfo</span>()
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>小差异：Option Store中，组件中操作状态可通过userStore.$patch批量修改；Setup Store中，需直接操作ref/reactive，或自定义批量修改方法。</p>
<h4 data-id="heading-9">4. 高频踩坑点（必看！）</h4>
<h5 data-id="heading-10">坑点1：Setup Store 忘记返回状态/方法，组件无法访问</h5>
<p>痛点：Setup Store中定义的状态、计算属性、方法，若未在return中暴露，组件中调用会报错（undefined）。</p>
<p>解决方案：牢记“定义即返回”，确保所有需要在组件中使用的内容，都包含在return对象中（无需暴露的局部逻辑，可不用返回）。</p>
<h5 data-id="heading-11">坑点2：Option Store 中actions使用箭头函数，this指向错误</h5>
<p>痛点：Option Store的actions中用箭头函数，会导致this指向undefined，无法操作state。</p>
<p>解决方案：Option Store的actions必须用普通函数，禁止用箭头函数；Setup Store无此问题（本身无this）。</p>
<h5 data-id="heading-12">坑点3：Setup Store 操作状态忘记加.value</h5>
<p>痛点：Setup Store中用ref定义的状态，操作时忘记加.value，导致状态修改失败、无响应。</p>
<p>解决方案：牢记“ref加.value，reactive不用加”，可配合vue-helper插件自动提示，避免遗漏。</p>
<h3 data-id="heading-13">四、选型建议（新手直接抄作业）</h3>
<p>结合项目场景、开发习惯、技术栈，给出明确的选型建议，避免盲目选择，提升开发效率：</p>
<ol>
<li>新手入门、简单场景（少量状态、无复杂逻辑）：<strong>优先选Option Store</strong>——结构规范、上手简单，无需关注ref/reactive和return，快速实现状态管理。</li>
<li>Vue3 ——贴合组合式开发趋势，逻辑拆分灵活，复用性强。</li>
<li>TS项目（无论简单还是复杂）：<strong>必选Setup Store</strong>——原生TS友好，自动类型推导，无需手动定义大量类型，减少类型报错。</li>
<li>团队协作项目：<strong>统一写法</strong>——建议小型项目统一Option Store，中大型项目统一Setup Store，避免两种写法混用，降低维护成本。</li>
<li>迁移项目（从Vuex迁移到Pinia）：<strong>优先Option Store</strong>——写法类似Vuex，迁移成本低，后续可逐步重构为Setup Store。</li>
</ol>
<h3 data-id="heading-14">五、扩展：两种写法的相互转换（按需切换）</h3>
<p>实际开发中，若需切换Store写法，可直接按以下规则转换，无需修改组件代码，示例（以用户Store为例）：</p>
<p>核心转换逻辑：state → ref/reactive，getters → computed，actions → 普通函数，Option Store的this.xxx → Setup Store的ref.value。</p>
<p>（参考前文两种写法的代码，可直接对照转换，此处不再重复赘述，重点是“属性对应、逻辑不变”）</p>
<h3 data-id="heading-15">六、总结：核心要点（新手必背）</h3>
<p>Setup Store和Option Store，没有绝对的优劣，核心是“适配场景”，两者的核心差异可总结为3句话：</p>
<ol>
<li>写法上：Option Store是“选项对象”，规范死板；Setup Store是“组合函数”，灵活自由，贴合Vue3组合式API。</li>
<li>体验上：Option Store上手简单，适合新手；Setup Store TS友好、复用性强，适合复杂场景和TS项目。</li>
<li>选型上：简单场景选Option Store，复杂场景、TS项目选Setup Store，Vue3新项目优先Setup Store。</li>
</ol>
<p>其实Pinia的两种写法，本质都是为了实现状态管理，只是适配不同的开发场景和习惯。掌握两者的差异和选型技巧，既能快速上手Pinia，也能根据项目需求灵活选择，提升开发效率、降低维护成本。新手建议先从Option Store入手，熟练后再过渡到Setup Store，逐步吃透Pinia的灵活性～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ESP32 进阶开发杂谈：从异步请求、动图显示到资源OTA]]></title>    <link>https://juejin.cn/post/7603261102794522650</link>    <guid>https://juejin.cn/post/7603261102794522650</guid>    <pubDate>2026-02-06T02:14:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603261102794522650" data-draft-id="7603227363821715482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESP32 进阶开发杂谈：从异步请求、动图显示到资源OTA"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2026-02-06T02:14:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chaosgoo"/> <meta itemprop="url" content="https://juejin.cn/user/2541726616010317"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESP32 进阶开发杂谈：从异步请求、动图显示到资源OTA
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726616010317/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chaosgoo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:14:27.000Z" title="Fri Feb 06 2026 02:14:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文首发于我的个人博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchaosgoo.com%2F2022%2F09%2F20%2Fesp32-advanced-dev-tips%2F" target="_blank" title="https://chaosgoo.com/2022/09/20/esp32-advanced-dev-tips/" ref="nofollow noopener noreferrer">chaosgoo.com</a>，欢迎来访交流。</p>
</blockquote>
<blockquote>
<p>很多时候，我们从零开始构建一个ESP32项目，往往会掉进各种各样的“坑”里。</p>
</blockquote>
<p>在之前的一些项目中(比如<a href="https://link.juejin.cn?target=https%3A%2F%2Fchaosgoo.com%2F2020%2F07%2F30%2FMake%2520A%2520Tiny%2520Pixel%2520Screen%2F" target="_blank" title="https://chaosgoo.com/2020/07/30/Make%20A%20Tiny%20Pixel%20Screen/" ref="nofollow noopener noreferrer">做个桌面像素小屏幕吧</a>)，我遇到过各种各样的问题：网络请求卡死主线程、屏幕显示太单调、休眠时PWM停转、以及每次只更新几张图片却要重刷整个固件的痛苦。</p>
<p>把这些坑踩平之后，我整理了四个在ESP32开发中非常实用的技巧。为了避免大家重蹈覆辙，也为了方便我自己日后查阅（Copy），这篇文章将把这些技术点汇总起来。</p>
<p>希望能给正在折腾ESP32的你提供一些灵感。</p>
<h2 data-id="heading-0">技巧一：拒绝阻塞！使用异步网络请求</h2>
<h3 data-id="heading-1">痛点分析</h3>
<p>在早期的像素小屏幕项目中，我为了获取B站粉丝数，直接使用了同步的HTTP Client。结果就是每次请求网络时，整个设备的UI都会卡住几百毫秒甚至几秒。这对于用户体验来说简直是灾难——你不能让用户觉得设备“死机”了。</p>
<p>为了优雅，必须上异步。</p>
<h3 data-id="heading-2">解决方案</h3>
<p>我们可以利用 <code>AsyncTCP</code> 库来实现非阻塞的HTTP请求。虽然写起来回调函数（Callback）套娃有点多，但换来的是丝般顺滑的主循环。</p>
<h3 data-id="heading-3">核心代码</h3>
<p>这里使用的是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fme-no-dev%2FAsyncTCP" target="_blank" title="https://github.com/me-no-dev/AsyncTCP" ref="nofollow noopener noreferrer">AsyncTCP-esphome</a> 库。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;AsyncTCP.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;WiFi.h&gt;</span></span>

<span class="hljs-comment">// ... WiFi配置省略 ...</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">asyncReqeust</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-type">static</span> AsyncClient *aClient;
  <span class="hljs-keyword">if</span> (aClient) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 防止重复创建</span>

  aClient = <span class="hljs-keyword">new</span> <span class="hljs-built_in">AsyncClient</span>();
  <span class="hljs-keyword">if</span> (!aClient) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 注册错误回调</span>
  aClient-&gt;<span class="hljs-built_in">onError</span>([](<span class="hljs-type">void</span> *arg, AsyncClient *client, <span class="hljs-type">int</span> error) {
      Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Connect Error"</span>);
      aClient = <span class="hljs-literal">NULL</span>;
      <span class="hljs-keyword">delete</span> client;
  }, <span class="hljs-literal">NULL</span>);

  <span class="hljs-comment">// 注册连接回调</span>
  aClient-&gt;<span class="hljs-built_in">onConnect</span>([](<span class="hljs-type">void</span> *arg, AsyncClient *client) {
      Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Connected"</span>);
      aClient-&gt;<span class="hljs-built_in">onError</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);

      <span class="hljs-comment">// 注册断开连接回调</span>
      client-&gt;<span class="hljs-built_in">onDisconnect</span>([](<span class="hljs-type">void</span> *arg, AsyncClient *c) {
          aClient = <span class="hljs-literal">NULL</span>;
          <span class="hljs-keyword">delete</span> c;
          Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Disconnected"</span>);
      }, <span class="hljs-literal">NULL</span>);

      <span class="hljs-comment">// 注册数据接收回调（核心逻辑）</span>
      client-&gt;<span class="hljs-built_in">onData</span>([](<span class="hljs-type">void</span> *arg, AsyncClient *c, <span class="hljs-type">void</span> *data, <span class="hljs-type">size_t</span> len) {
          Serial.<span class="hljs-built_in">write</span>((<span class="hljs-type">uint8_t</span> *)data, len);
          <span class="hljs-comment">// 这里可以解析JSON数据</span>
      }, <span class="hljs-literal">NULL</span>);

      <span class="hljs-comment">// 发送HTTP GET请求</span>
      client-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-string">"GET /x/relation/stat?vmid=14374079 HTTP/1.1\r\n"</span>
                    <span class="hljs-string">"Host: api.bilibili.com\r\n"</span>
                    <span class="hljs-string">"Content-Type: application/json; charset=utf-8\r\n\r\n"</span>);
  }, <span class="hljs-literal">NULL</span>);

  <span class="hljs-keyword">if</span> (!aClient-&gt;<span class="hljs-built_in">connect</span>(<span class="hljs-string">"api.bilibili.com"</span>, <span class="hljs-number">80</span>)) {
      Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Connect Fail"</span>);
      AsyncClient *client = aClient;
      aClient = <span class="hljs-literal">NULL</span>;
      <span class="hljs-keyword">delete</span> client;
  }
}
</code></pre>
<p>这样，网络请求在后台默默进行，你的主循环 <code>loop()</code> 依然可以跑得飞起，去处理按键扫描或者屏幕刷新。</p>
<hr/>
<h3 data-id="heading-4">技巧二：让画面动起来——播放GIF动图</h3>
<h4 data-id="heading-5">视觉升级</h4>
<p>网络通畅了，界面也不能太寒酸。在做一个带有240x135分辨率的装置时，我实在想不出什么高级的算法动画，于是决定“偷懒”：直接在屏幕上播放GIF表情包。</p>
<p>这里推荐使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbitbank2%2FAnimatedGIF" target="_blank" title="https://github.com/bitbank2/AnimatedGIF" ref="nofollow noopener noreferrer">AnimatedGIF</a> 库，配合 TFT_eSPI 驱动，效果非常不错。</p>
<h4 data-id="heading-6">制作GIF头文件</h4>
<p>首先，我们需要把GIF文件转换成代码能读取的数组。在Linux或者WSL子系统下，一行 <code>xxd</code> 命令就能搞定：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">## 将GIF转换为C数组</span>
xxd -i angry_80px.gif &gt;&gt; loading.h
</code></pre>
<p>生成的 <code>loading.h</code> 里面就是一个巨大的 <code>unsigned char</code> 数组。</p>
<h4 data-id="heading-7">驱动代码</h4>
<p>代码基于官方示例修改，适配了 TFT_eSPI。</p>
<pre><code class="hljs language-cpp" lang="cpp">#<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;AnimatedGIF.h&gt;</span></span>
#<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;TFT_eSPI.h&gt;</span></span>
#<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"loading.h"</span> <span class="hljs-comment">// 刚才生成的头文件</span></span>

AnimatedGIF gif;
TFT_eSPI tft = <span class="hljs-built_in">TFT_eSPI</span>();

<span class="hljs-comment">// 回调函数：将解码后的一行像素推送到屏幕</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GIFDraw</span><span class="hljs-params">(GIFDRAW *pDraw)</span> </span>{
    <span class="hljs-comment">// ... 核心绘制逻辑，包含透明度处理和DMA加速 ...</span>
    <span class="hljs-comment">// 篇幅原因，核心逻辑是调用 tft.pushPixels 将 pDraw-&gt;pPixels 推送显示</span>
    <span class="hljs-comment">// 完整逻辑参考 AnimatedGIF 的 TFT_eSPI_memory 示例</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  tft.<span class="hljs-built_in">begin</span>();
  tft.<span class="hljs-built_in">setRotation</span>(<span class="hljs-number">1</span>);
  tft.<span class="hljs-built_in">fillScreen</span>(TFT_BLACK);
  gif.<span class="hljs-built_in">begin</span>(BIG_ENDIAN_PIXELS);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (gif.<span class="hljs-built_in">open</span>((<span class="hljs-type">uint8_t</span> *)angry_80px_gif, <span class="hljs-built_in">sizeof</span>(angry_80px_gif), GIFDraw)) {
    <span class="hljs-keyword">while</span> (gif.<span class="hljs-built_in">playFrame</span>(<span class="hljs-literal">true</span>, <span class="hljs-literal">NULL</span>)) {
      <span class="hljs-built_in">yield</span>(); <span class="hljs-comment">// 喂狗，防止复位</span>
    }
    gif.<span class="hljs-built_in">close</span>();
  }
}
</code></pre>
<p>只要内存够大，放个蔡徐坤打篮球的GIF也不是不可能（逃）。</p>
<h2 data-id="heading-8">技巧三：Light-Sleep模式下保持PWM输出</h2>
<h3 data-id="heading-9">奇怪的需求</h3>
<p>有些场景下（比如背光保持），我们需要ESP32进入 <code>Light-Sleep</code> 省电，但又不希望 屏幕背光的PWM 信号中断。
默认情况下，进入睡眠后高速时钟会关闭，导致 PWM 停摆。</p>
<h3 data-id="heading-10">开启 RTC8M 时钟</h3>
<p>查阅 ESP-IDF 手册发现，如果将 PWM 的时钟源配置为 <code>RTC8M_CLK</code>，即使在 Light-Sleep 下也能工作。但这有个前提，需要修改 <code>menuconfig</code>。</p>
<ol>
<li>
<p><strong>环境配置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">idf.py menuconfig
</code></pre>
<p>进入 <code>Component config</code> -&gt; <code>Hardware Settings</code> -&gt; <code>Sleep Config</code>。
<strong>务必关闭</strong> <code>light sleep GPIO reset workaround</code>。</p>
</li>
<li>
<p><strong>代码实现</strong>：
使用 ESP-IDF 原生 API 配置 LEDC。</p>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#include</span> "driver/ledc<span class="hljs-selector-class">.h</span>"
<span class="hljs-selector-id">#include</span> "esp_sleep<span class="hljs-selector-class">.h</span>"

void <span class="hljs-built_in">app_main</span>(void) {
  <span class="hljs-comment">// 1. 定时器配置：重点是选用 LEDC_USE_RTC8M_CLK</span>
  ledc_timer_config_t ledc_timer = {
      <span class="hljs-selector-class">.duty_resolution</span> = LEDC_TIMER_13_BIT,
      <span class="hljs-selector-class">.freq_hz</span> = <span class="hljs-number">1000</span>,
      <span class="hljs-selector-class">.speed_mode</span> = LEDC_LOW_SPEED_MODE, <span class="hljs-comment">// 必须是低速模式</span>
      <span class="hljs-selector-class">.timer_num</span> = LEDC_TIMER_0,
      <span class="hljs-selector-class">.clk_cfg</span> = LEDC_USE_RTC8M_CLK,     <span class="hljs-comment">// 关键！</span>
  };
  <span class="hljs-built_in">ESP_ERROR_CHECK</span>(ledc_timer_config(&amp;ledc_timer));

  <span class="hljs-comment">// 2. 通道配置... (常规配置，略)</span>
  
  <span class="hljs-comment">// 3. 强制开启RTC8M电源域</span>
  <span class="hljs-built_in">esp_sleep_pd_config</span>(ESP_PD_DOMAIN_RTC8M, ESP_PD_OPTION_ON);

  while (<span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 设置一个占空比</span>
    <span class="hljs-built_in">ledc_set_duty</span>(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_0, <span class="hljs-number">1000</span>);
    <span class="hljs-built_in">ledc_update_duty</span>(LEDC_LOW_SPEED_MODE, LEDC_CHANNEL_0);
    
    <span class="hljs-comment">// 进入浅睡眠，PWM依然会保持输出</span>
    <span class="hljs-built_in">esp_sleep_enable_timer_wakeup</span>(<span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">5</span>); <span class="hljs-comment">// 睡5秒</span>
    <span class="hljs-built_in">esp_light_sleep_start</span>();
  }
}
</code></pre>
<p>实测这个功能对于降低功耗非常有用。</p>
<hr/>
<h3 data-id="heading-11">技巧四：只更新资源文件？试试 SPIFFS 分区 OTA</h3>
<h4 data-id="heading-12">场景</h4>
<p>随着项目越来越大，我发现一个问题：有时候我只想更新一下UI里的图片资源或者字体库，并不想更新代码。
传统的OTA是更新 App 分区，这很浪费流量和时间。其实我们完全可以只针对 SPIFFS 数据分区进行 OTA。</p>
<h4 data-id="heading-13">分区表设计</h4>
<p>首先，我们需要自定义分区表（partitions.csv），把数据独立出来。</p>
<pre><code class="hljs language-csv" lang="csv">## Name,   Type, SubType, Offset,  Size, Flags
nvs,      data, nvs,     0x9000,  0x5000,
otadata,  data, ota,     0xe000,  0x2000,
app0,     app,  ota_0,   0x10000, 0x300000,
storage,  data, spiffs,  0x310000, 0xC000,
</code></pre>
<p>这里我划了一个 48KB 的 <code>storage</code> 分区用于演示。</p>
<h4 data-id="heading-14">OTA 核心逻辑</h4>
<p>不同于更新 App，更新分区实际上就是“擦除 + 写入”的过程。假设新的文件镜像已经通过网络下载到了内存中（或者像本例一样，为了演示直接 embed 在代码里）。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update_spiffs_partition</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 查找 SPIFFS 分区</span>
    <span class="hljs-type">const</span> <span class="hljs-type">esp_partition_t</span> *spiffs_part = <span class="hljs-built_in">esp_partition_find_first</span>(
            ESP_PARTITION_TYPE_DATA, ESP_PARTITION_SUBTYPE_DATA_SPIFFS, <span class="hljs-literal">NULL</span>);
    
    <span class="hljs-keyword">if</span> (spiffs_part == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">ESP_LOGE</span>(<span class="hljs-string">"OTA"</span>, <span class="hljs-string">"SPIFFS partition not found!"</span>);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 擦除原分区内容</span>
    <span class="hljs-built_in">ESP_LOGI</span>(<span class="hljs-string">"OTA"</span>, <span class="hljs-string">"Erasing partition..."</span>);
    <span class="hljs-built_in">esp_partition_erase_range</span>(spiffs_part, <span class="hljs-number">0</span>, spiffs_part-&gt;size);

    <span class="hljs-comment">// 3. 写入新数据</span>
    <span class="hljs-comment">// 假设 spiffs2_start 和 spiffs2_end 是新镜像在内存中的地址</span>
    <span class="hljs-type">size_t</span> image_size = spiffs2_end - spiffs2_start - <span class="hljs-number">1</span>;
    <span class="hljs-built_in">ESP_LOGI</span>(<span class="hljs-string">"OTA"</span>, <span class="hljs-string">"Writing new data: %d bytes"</span>, image_size);
    
    <span class="hljs-built_in">esp_partition_write</span>(spiffs_part, <span class="hljs-number">0</span>, spiffs2_start, image_size);

    <span class="hljs-built_in">ESP_LOGI</span>(<span class="hljs-string">"OTA"</span>, <span class="hljs-string">"Done! Restarting..."</span>);
    <span class="hljs-built_in">esp_restart</span>();
}
</code></pre>
<p>这个技巧在做图片更换、字体切换等功能时特别好用，不用动核心代码，安全又快速。</p>
<hr/>
<h2 data-id="heading-15">总结</h2>
<p>以上就是我过去折腾ESP32时总结的四个实用技巧。
从避免阻塞的异步请求，到花里胡哨的GIF播放，再到低功耗下的PWM控制和灵活的资源OTA，每一个点都是在实际开发中为了解决特定痛点而摸索出来的。</p>
<p>硬件开发的乐趣大概就在于此：遇到一个坑，填平它，然后看着设备按照预想的方式运行，那种成就感是无法替代的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 2026 年，3D 工业视觉成为视觉算法分化的一年？]]></title>    <link>https://juejin.cn/post/7603288778678419491</link>    <guid>https://juejin.cn/post/7603288778678419491</guid>    <pubDate>2026-02-06T03:10:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603288778678419491" data-draft-id="7603267434502406159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 2026 年，3D 工业视觉成为视觉算法分化的一年？"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-02-06T03:10:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 2026 年，3D 工业视觉成为视觉算法分化的一年？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:10:20.000Z" title="Fri Feb 06 2026 03:10:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这几年，3D 工业视觉走得很快，也走得有点累。</p>
<p>参数一路狂飙：像素更高、帧率更快、功率更猛、视角更广、体积更小。单看规格表，很难不让人兴奋。但真正把设备装上产线的人，往往会在几周后露出一种复杂的表情——系统确实更“强”了，可现场并没有因此变得更“简单”。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ca30630501a4862ad4811172122e05c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770952220&amp;x-signature=ZJlvKzXXELb9XX4Z61aV7QN9YEs%3D" alt="faq-what-is-3d-vision-16x9-1600x900.jpg.imgo.jpg" loading="lazy"/></p>
<p>反光的金属依旧刺眼，深色材质还是难拍，乱堆料一上来，点云开始发虚。问题不但没消失，反而因为节拍更快、工况更复杂，被放大得更加明显。</p>
<p>行业正在经历一个不太舒服的时刻：</p>
<p><em><strong>硬件已经卷到极限了，可真正的差距，好像不在这里。</strong></em></p>
<h2 data-id="heading-0"><strong>当“看得更清楚”不再等于“问题被解决”</strong></h2>
<p>说起来，3D 视觉这条路，最早并不是这样走的。</p>
<p>在很长一段时间里，大家默认一个逻辑：</p>
<p>只要像素够高、光打得够强、帧率够快，问题总能被“拍清楚”。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74826655334e474e813073c9bb957848~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770952220&amp;x-signature=RxKFn4synnfIwHpECaMrKKCgAQ4%3D" alt="images.png" loading="lazy"/></p>
<p>这个逻辑在实验环境里成立，在标准工件、固定治具下也很少翻车。但一旦进入真实工厂，它开始变得不那么可靠。</p>
<ul>
<li>反光不是均匀反光，而是随角度跳变；</li>
<li>暗色不是单纯变暗，而是边界直接消失；</li>
<li>柔性工位不是偶尔变化，而是持续变化。</li>
</ul>
<p>于是出现了一种略显尴尬的现象：</p>
<p><strong>设备拍到了更多信息，但系统却更难稳定地“理解”这些信息。</strong></p>
<p>这时候再往硬件上堆，收益开始明显变薄。</p>
<h2 data-id="heading-1"><strong>真正拉开差距的，是算法能否“吃得下现实世界”</strong></h2>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beee3ce52a4645c0b09849b6c6e1e1cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770952220&amp;x-signature=1qOSTj3UMQz57m2DzlF2qJEI2JY%3D" alt="1400x788_ECCV_Blog_hero_v2-640x360.jpg" loading="lazy"/></p>
<p>慢慢地，行业里的共识开始发生转移。</p>
<p>决定系统成败的，不是多出来的几个像素，而是算法在复杂输入下能否保持判断力；</p>
<p>也不是单次测试有多准，而是连续运行一个月后，状态是否依然稳定。</p>
<p>这背后，其实是一个更深层的问题：</p>
<p><strong>算法面对的，是一个被精心整理过的世界，还是一个真实、混乱、不可预测的世界？</strong></p>
<p>当柔性制造成为常态，多 SKU、随机姿态、复杂材质、工位频繁切换叠加在一起，视觉系统已经不再只是“采集工具”，而是被推上了“空间理解底座”的位置。</p>
<p>这一步跨不过去，参数再好看，也只能停留在展示层。</p>
<h2 data-id="heading-2"><strong>同一时间，学术界在走一条看似相反、实则一致的路</strong></h2>
<p>有意思的是，类似的转向，也正在学术界发生。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5d025f23c6d4cd69fa3ed9238b63d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770952220&amp;x-signature=%2FsD31b%2BnPkSAQPgRMS0P4nt6XNE%3D" alt="LiDAR-vs-Vision-517x306-1-e1748502410760.jpg" loading="lazy"/></p>
<p>在自动驾驶和机器人领域，研究者开始反复挑战一个看似激进的问题：<strong>真的需要这么多传感器吗？</strong></p>
<p>激光雷达、毫米波雷达、摄像头层层叠加，确实安全，但成本、功耗、维护复杂度同样叠加。于是，一条“减法路线”逐渐清晰——尝试仅依赖视觉，甚至只用 360° 环视摄像头，去完成 3D 环境理解。</p>
<p>这并不是退而求其次，而是一次难度极高的正面进攻。</p>
<p>单纯的视觉缺乏直接深度，算法必须真正理解几何、运动和语义，才能补足信息缺口。</p>
<p>把这条路线放回工业场景，其实会发现一个共通点：</p>
<p><strong>行业不再指望硬件替系统兜底，而是要求系统自己具备理解能力。</strong></p>
<h2 data-id="heading-3"><strong>从单点性能，走向系统协同</strong></h2>
<p>也正是在这样的背景下，“系统协同”开始被反复提起。</p>
<p>一套 3D 工业视觉系统，很少只由一个模型决定成败。</p>
<p>光机稳定性、成像一致性、标定精度、重建算法、平台工具链，任何一个环节波动，都会被算法成倍放大。</p>
<p>这也是为什么，越来越多客户开始关注一个问题：</p>
<p align="center">**<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb18b2f0f51841d6a1987243ee1ea6f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770952220&amp;x-signature=3OZg6%2BSkFQgxsF358Un23lsVUE8%3D" alt="ScreenShot_2026-02-05_164154_547.png" loading="lazy"/>**</p>
<p><strong>系统是不是为算法而设计，而不是算法被迫去适配硬件。</strong></p>
<p>当输入源不稳定，算法再聪明也只能疲于修补；</p>
<p>当成像行为批次不一致，模型泛化就无从谈起。</p>
<h2 data-id="heading-4"><strong>全链路能力，正在成为真正的分水岭</strong></h2>
<p>站在 2026 年这个时间点回看，行业的分化逻辑已经相当清晰。</p>
<p>未来的竞争，不会只围绕“谁的参数更高”，而是围绕：谁能在复杂工况下，长期、稳定地输出可用的三维信息；</p>
<p>谁能把光机、成像、重建、算法和平台，拧成一条真正协同的链路。</p>
<p>这也是为什么，具备全链路掌控能力的企业开始显露出结构性优势。</p>
<p>在算法被持续放大的时代，</p>
<ul>
<li>可控、可预测的输入源本身就是壁垒；</li>
<li>稳定、一致的成像链路，本身就是算法的放大器；</li>
<li>而平台化的软件能力，决定了系统能走多远。</li>
</ul>
<p>当 3D 工业视觉系统被推向“长期稳定运行”的要求时，问题已经不再是有没有模型，而是：模型是否被放在了一条可控、可复现、可迭代的系统链路里。</p>
<p>Coovally 正是沿着这条思路构建的。</p>
<p>它并不试图用某一个“更强”的模型去覆盖所有复杂工况，而是把重点放在如何让算法持续吃得下真实世界：</p>
<p>从数据处理开始，到模型训练、评估、版本管理，再到边缘端部署，所有环节被纳入同一套平台体系中，输入来源、实验条件和输出结果都可以被清晰追溯。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74a099dc0f064d4798b508620d437071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770952220&amp;x-signature=7n%2B7QRff7SFBe5pRkQCv0vcQIqY%3D" alt="Coovally操作动图.gif" loading="lazy"/></p>
<p>在实际项目中，这种能力的价值往往体现在细节里——当成像条件发生变化，模型效果波动时，工程团队能迅速定位问题究竟出在数据、训练策略，还是部署环境；当工况升级、多 SKU 并行成为常态，模型不需要“推倒重来”，而是沿着已有链路继续演进。</p>
<p>如果你已经有明确的工业场景，正在评估如何把视觉算法真正用进生产流程中，也可以通过下方二维码联系 Coovally。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/580693153b9f47daaf1bb87fa15b72cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770952220&amp;x-signature=TbyEOTeed0uiZKZVN7qpo%2FZ%2BHLE%3D" alt="小助手二维码.png" loading="lazy"/></p>
<p>我们更关注的，不是给你一套现成模型，而是一起把你的场景拆解成一条可长期运行的系统方案。</p>
<h2 data-id="heading-5"><strong>不是洗牌，而是能力开始兑现</strong></h2>
<p>所以，与其说 2026 年是一次行业洗牌，不如说是一轮能力兑现。</p>
<p>过去几年被反复验证、却不够“好讲故事”的系统能力，正在被现实场景逐一放大；</p>
<p>而单纯依赖硬件参数领先的优势，开始变得脆弱。</p>
<p>3D 工业视觉真正的时代，或许才刚刚进入正题。</p>
<p>它不再奖励最激进的参数，而更偏爱那些在混乱中依然能保持秩序的系统。</p>
<p>站在这个节点上再回头看，会发现方向其实已经很明确了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp脚手架编译微信小程序出现白屏问题，狂踩坑得出的结论]]></title>    <link>https://juejin.cn/post/7603263490342060041</link>    <guid>https://juejin.cn/post/7603263490342060041</guid>    <pubDate>2026-02-06T03:09:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490342060041" data-draft-id="7603216479836815411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp脚手架编译微信小程序出现白屏问题，狂踩坑得出的结论"/> <meta itemprop="keywords" content="微信小程序"/> <meta itemprop="datePublished" content="2026-02-06T03:09:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="douze"/> <meta itemprop="url" content="https://juejin.cn/user/1948793732608462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp脚手架编译微信小程序出现白屏问题，狂踩坑得出的结论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1948793732608462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    douze
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:09:26.000Z" title="Fri Feb 06 2026 03:09:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>因为公司的小程序项目是使用uniapp脚手架编译的，因为我们在测试阶段和生产阶段基本不会出现，但是用户基数过多的时候就会两遍产生质变，以下内容是我踩过的坑得出的一些结论（使用ai润色了一下）</p>
<p>微信小程序端“白屏”很多时候不是渲染问题，而是以下几类原因导致 JS 逻辑中断或卡死：</p>
<ul>
<li>路由重定向循环、并发跳转、tabBar 跳转方式错误</li>
<li>请求层抛异常未捕获（Unhandled Rejection），页面逻辑直接断掉</li>
<li>首屏直接落到分包页/鉴权页/深链页，启动竞态导致白屏</li>
<li>小程序退到后台太久，回来状态脏了（token/用户态）继续跑导致异常</li>
</ul>
<p>本文按排查优先级给一套稳定方案，适配 <strong>Vue3 + Pinia</strong>。</p>
<p>先把白屏变“可见错误”：全局异常捕获（必做）</p>
<p>App.vue（Vue3 写法）</p>
<pre><code class="hljs language-&lt;script" lang="&lt;script">import { onLaunch, onShow } from '@dcloudio/uni-app'

onLaunch(() =&gt; {
  // Vue3 没有 Vue.config.errorHandler，这里主要补齐小程序错误与未处理 Promise
  // #ifdef MP-WEIXIN
  wx.onError((msg) =&gt; {
    console.error('[wx.onError]', msg)
  })
  wx.onUnhandledRejection((res) =&gt; {
    console.error('[wx.onUnhandledRejection]', res)
  })
  // #endif
})

onShow(() =&gt; {
  // 可选：记录每次回前台
})
&lt;/script&gt;

</code></pre>
<p>说明：Vue3 侧的 errorHandler 更建议在 main.ts 用 <code>app.config.errorHandler</code> 做（下面会给）。</p>
<blockquote>
<p>main.ts（推荐补全 Vue 错误捕获）</p>
</blockquote>
<pre><code class="hljs language-import" lang="import">import App from './App.vue'
import { createPinia } from 'pinia'

export function createApp() {
  const app = createSSRApp(App)
  const pinia = createPinia()
  app.use(pinia)

  app.config.errorHandler = (err, instance, info) =&gt; {
    console.error('[VueError]', err, info)
  }

  return { app, pinia }
}

</code></pre>
<h2 data-id="heading-1">（一）排查页面重定向问题：防并发、防循环、统一入口</h2>
<h3 data-id="heading-2">1.1 常见坑点（白屏高发）</h3>
<ul>
<li>tabBar 页面用了 <code>navigateTo</code>（会 fail）</li>
<li>A → redirectTo B，B 又 redirectTo A（循环）</li>
<li>onLoad/onShow 同时触发登录校验 + 活动跳转（并发跳转）</li>
<li>启动时频繁 <code>reLaunch</code>/<code>redirectTo</code>（竞态）</li>
</ul>
<h3 data-id="heading-3">1.2 路由统一封装（Vue3 直接用函数）</h3>
<p>/src/utils/router.ts</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOCK_KEY</span> = <span class="hljs-string">'__router_lock__'</span>
<span class="hljs-keyword">let</span> lastUrl = <span class="hljs-string">''</span>
<span class="hljs-keyword">let</span> lastAt = <span class="hljs-number">0</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAB_BAR_PAGES</span> = [
  <span class="hljs-string">'/pages/index/index'</span>,
  <span class="hljs-comment">// '/pages/home/index',</span>
]

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isTabBar</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> path = url.<span class="hljs-title function_">split</span>(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">TAB_BAR_PAGES</span>.<span class="hljs-title function_">includes</span>(path)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeGo</span>(<span class="hljs-params">options: { url: <span class="hljs-built_in">string</span>; <span class="hljs-keyword">type</span>?: <span class="hljs-string">'navigateTo'</span> | <span class="hljs-string">'redirectTo'</span> | <span class="hljs-string">'reLaunch'</span> }</span>) {
  <span class="hljs-keyword">const</span> { url, <span class="hljs-keyword">type</span> = <span class="hljs-string">'navigateTo'</span> } = options
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()

  <span class="hljs-comment">// 300ms 内重复跳同一地址，直接拦截</span>
  <span class="hljs-keyword">if</span> (now - lastAt &lt; <span class="hljs-number">300</span> &amp;&amp; url === lastUrl) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[router] blocked duplicate:'</span>, url)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> app = getApp&lt;{ <span class="hljs-attr">globalData</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; }&gt;()
  <span class="hljs-keyword">if</span> (app.<span class="hljs-property">globalData</span>[<span class="hljs-variable constant_">LOCK_KEY</span>]) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[router] locked, ignore:'</span>, url)
    <span class="hljs-keyword">return</span>
  }
  app.<span class="hljs-property">globalData</span>[<span class="hljs-variable constant_">LOCK_KEY</span>] = <span class="hljs-literal">true</span>

  lastUrl = url
  lastAt = now

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">done</span> = (<span class="hljs-params"/>) =&gt; {
    app.<span class="hljs-property">globalData</span>[<span class="hljs-variable constant_">LOCK_KEY</span>] = <span class="hljs-literal">false</span>
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isTabBar</span>(url)) {
    uni.<span class="hljs-title function_">switchTab</span>({ url, <span class="hljs-attr">complete</span>: done })
    <span class="hljs-keyword">return</span>
  }

  uni[<span class="hljs-keyword">type</span>]({
    url,
    <span class="hljs-attr">complete</span>: done,
    <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[router] fail:'</span>, <span class="hljs-keyword">type</span>, url, e)
      <span class="hljs-title function_">done</span>()
      uni.<span class="hljs-title function_">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span> }) <span class="hljs-comment">// 兜底回首页</span>
    },
  })
}

</code></pre>
<p>后面文章里涉及跳转，统一用 <code>safeGo()</code>，你会发现白屏概率会明显下降。</p>
<h2 data-id="heading-4">（二）排查 http 抛出异常接收：请求层不要随意 throw，统一兜底结构</h2>
<h3 data-id="heading-5">2.1 推荐：request 永远 resolve（ok/data/msg/code）</h3>
<p>/src/utils/http.ts</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_URL</span> = <span class="hljs-string">'https://api.xxx.com'</span>

export type HttpResult&lt;T = any&gt; = {
  ok: <span class="hljs-keyword">boolean</span>
  data: T | <span class="hljs-literal">null</span>
  msg: <span class="hljs-keyword">string</span>
  code: number
}

export <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">request</span>&lt;<span class="hljs-title">T</span> = <span class="hljs-title">any</span>&gt;(<span class="hljs-params">opt: {
  url: <span class="hljs-keyword">string</span>
  method?: UniApp.RequestOptions[<span class="hljs-string">'method'</span>]
  data?: any
  header?: any
  timeout?: number
}</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">HttpResult</span>&lt;<span class="hljs-title">T</span>&gt;&gt; </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>((resolve) =&gt; {
    uni.<span class="hljs-title function_ invoke__">request</span>({
      <span class="hljs-attr">url</span>: BASE_URL + opt.url,
      <span class="hljs-attr">method</span>: opt.method || <span class="hljs-string">'GET'</span>,
      <span class="hljs-attr">data</span>: opt.data || {},
      <span class="hljs-attr">header</span>: opt.header || {},
      <span class="hljs-attr">timeout</span>: opt.timeout || <span class="hljs-number">15000</span>,
      <span class="hljs-attr">success</span>: (res) =&gt; {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">status</span> = res.statusCode || <span class="hljs-number">0</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">body</span>: any = res.data || {}

        <span class="hljs-comment">// 按你们后端协议调整：例如 code === 0 成功</span>
        <span class="hljs-keyword">if</span> (status &gt;= <span class="hljs-number">200</span> &amp;&amp; status &lt; <span class="hljs-number">300</span>) {
          <span class="hljs-keyword">if</span> (body.code === <span class="hljs-number">0</span>) {
            <span class="hljs-title function_ invoke__">resolve</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: body.data ?? <span class="hljs-literal">null</span>, <span class="hljs-attr">msg</span>: body.msg || <span class="hljs-string">'ok'</span>, <span class="hljs-attr">code</span>: body.code })
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_ invoke__">resolve</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">msg</span>: body.msg || <span class="hljs-string">'业务异常'</span>, <span class="hljs-attr">code</span>: body.code ?? -<span class="hljs-number">2</span> })
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_ invoke__">resolve</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">msg</span>: `HTTP ${status}`, <span class="hljs-attr">code</span>: status })
        }
      },
      fail: (err) =&gt; {
        console.<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">'[http.fail]'</span>, err)
        <span class="hljs-title function_ invoke__">resolve</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">msg</span>: err.errMsg || <span class="hljs-string">'网络异常'</span>, <span class="hljs-attr">code</span>: -<span class="hljs-number">1</span> })
      },
    })
  })
}

</code></pre>
<p>2.2 页面调用必须兜底（不要默认成功）</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/http'</span>

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> request&lt;{ <span class="hljs-attr">list</span>: <span class="hljs-built_in">any</span>[] }&gt;({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/list'</span> })
<span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) {
  uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: res.<span class="hljs-property">msg</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> })
  <span class="hljs-keyword">return</span>
}
list.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>?.<span class="hljs-property">list</span> || []

</code></pre>
<p>这样你几乎不会再遇到“请求失败直接白屏”，因为页面逻辑永远能走到兜底分支。</p>
<h2 data-id="heading-6">（三）进入页面一定先进入首页：缓存记录再重定向（首屏稳定策略）</h2>
<p>你的目标：<strong>无论从哪里打开小程序，先落首页渲染，再二跳到目标页</strong>。<br/>
这能解决：分包未加载、鉴权竞态、启动时多处跳转造成的白屏。</p>
<h3 data-id="heading-7">3.1 Pinia 用户态（用于清理等）</h3>
<p><code>/src/stores/user.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">token</span>: uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>) || <span class="hljs-string">''</span>,
    <span class="hljs-attr">userInfo</span>: uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userInfo'</span>) || <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>,
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">setToken</span>(<span class="hljs-params">t: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = t
      uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, t)
    },
    <span class="hljs-title function_">setUserInfo</span>(<span class="hljs-params">info: <span class="hljs-built_in">any</span></span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = info
      uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'userInfo'</span>, info)
    },
    <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = <span class="hljs-string">''</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = <span class="hljs-literal">null</span>
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>)
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'userInfo'</span>)
    },
  },
})

</code></pre>
<p>3.2 App 启动记录目标页，并强制 reLaunch 首页
App.vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onLaunch, onShow, onHide } <span class="hljs-keyword">from</span> <span class="hljs-string">'@dcloudio/uni-app'</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EXPIRE_MS</span> = <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 30分钟</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">buildTargetFromLaunchOptions</span>(<span class="hljs-params"/>): string {
  <span class="hljs-comment">// #ifdef MP-WEIXIN</span>
  <span class="hljs-keyword">const</span> opts = wx.<span class="hljs-property">getLaunchOptionsSync</span>?.() || {}
  <span class="hljs-keyword">if</span> (!opts.<span class="hljs-property">path</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> path = <span class="hljs-string">'/'</span> + opts.<span class="hljs-property">path</span>
  <span class="hljs-keyword">const</span> query = opts.<span class="hljs-property">query</span> || {}
  <span class="hljs-keyword">const</span> qs = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(query).<span class="hljs-property">length</span>
    ? <span class="hljs-string">'?'</span> + <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(query).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${k}</span>=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(query[k])}</span>`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'&amp;'</span>)
    : <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> full = path + qs
  <span class="hljs-keyword">if</span> (full.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/pages/index/index'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  <span class="hljs-keyword">return</span> full
  <span class="hljs-comment">// #endif</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">clearUserData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useUserStore</span>()
  user.<span class="hljs-title function_">reset</span>()
  uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'pending_redirect'</span>)
}

<span class="hljs-title function_">onLaunch</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1) 记录目标页</span>
  <span class="hljs-keyword">const</span> target = <span class="hljs-title function_">buildTargetFromLaunchOptions</span>()
  <span class="hljs-keyword">if</span> (target) uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'pending_redirect'</span>, target)

  <span class="hljs-comment">// 2) 强制先落首页</span>
  uni.<span class="hljs-title function_">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span> })
})

<span class="hljs-title function_">onHide</span>(<span class="hljs-function">() =&gt;</span> {
  uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'last_hide_time'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())
})

<span class="hljs-title function_">onShow</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> last = <span class="hljs-title class_">Number</span>(uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'last_hide_time'</span>) || <span class="hljs-number">0</span>)
  <span class="hljs-keyword">if</span> (!last) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> gap = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - last
  <span class="hljs-keyword">if</span> (gap &gt; <span class="hljs-variable constant_">EXPIRE_MS</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[expire] too long:'</span>, gap)
    <span class="hljs-title function_">clearUserData</span>()
    uni.<span class="hljs-title function_">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span> })
  }
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

</code></pre>
<p>3.3 首页负责“二跳重定向”（只执行一次）
/pages/index/index.vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onShow } <span class="hljs-keyword">from</span> <span class="hljs-string">'@dcloudio/uni-app'</span>
<span class="hljs-keyword">import</span> { safeGo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/router'</span>

<span class="hljs-title function_">onShow</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> target = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'pending_redirect'</span>)
  <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 先清掉，避免循环</span>
  uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'pending_redirect'</span>)

  <span class="hljs-comment">// 延迟一帧，确保首屏先渲染出来</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">safeGo</span>({ <span class="hljs-attr">url</span>: target, <span class="hljs-attr">type</span>: <span class="hljs-string">'redirectTo'</span> })
  }, <span class="hljs-number">0</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

</code></pre>
<p>这套模式非常“抗白屏”：启动无论多复杂，先给用户一个能渲染的首页，再做业务跳转。</p>
<h2 data-id="heading-8">四）退出时长处理：超过时长清除用户数据（Pinia 版）</h2>
<p>上面 App.vue 已经实现了“退后台超时清理”。这里补充两个经验点：</p>
<h3 data-id="heading-9">4.1 不建议清 <code>uni.clearStorageSync()</code></h3>
<p>会误删配置/引导标记/AB 实验等数据。只清用户相关即可（token、userInfo、pending_redirect）。</p>
<h3 data-id="heading-10">4.2 如果要“页面级超时”</h3>
<p>对敏感页面可叠加页面级超时（业务更安全），但全局超时依然建议保留。</p>
<hr/>
<h2 data-id="heading-11">最后：一套白屏排查优先级（直接照这个顺序查）</h2>
<ol>
<li><strong>路由</strong>：tabBar 跳转方式正确吗？有无重定向循环？有无并发跳转？</li>
<li><strong>请求</strong>：有没有 throw 未 catch？有没有 unhandledRejection？请求失败有没有兜底？</li>
<li><strong>首屏策略</strong>：是否允许启动直接落到深层页？建议“先首页渲染，再二跳”。</li>
<li><strong>后台超时</strong>：用户退后台太久回来，是否需要清理 token/用户态避免脏状态引发白屏？</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NestJS 入门：从零到 CRUD 接口]]></title>    <link>https://juejin.cn/post/7603267434502520847</link>    <guid>https://juejin.cn/post/7603267434502520847</guid>    <pubDate>2026-02-06T03:17:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603267434502520847" data-draft-id="7603288778678222883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NestJS 入门：从零到 CRUD 接口"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2026-02-06T03:17:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codingWhat"/> <meta itemprop="url" content="https://juejin.cn/user/2189882895642728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NestJS 入门：从零到 CRUD 接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882895642728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codingWhat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:17:37.000Z" title="Fri Feb 06 2026 03:17:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">NestJS 入门：从零到 CRUD 接口</h2>
<p>本文基于一个真实的 NestJS + MongoDB 项目，带你理解 NestJS 的核心概念和目录结构，适合有 Node/TypeScript 基础、想上手 Nest 的读者。</p>
<hr/>
<h3 data-id="heading-1">一、话不多说，NestJS 是什么得搞清楚？</h3>
<p>NestJS 是一个用于构建<strong>服务端应用</strong>的 Node 框架，底层默认基于 <strong>Express</strong>（也可切换为 Fastify）。支持用 <strong>TypeScript</strong> 编写，采用<strong>模块化</strong>和<strong>依赖注入</strong>，结构类似 Angular，适合写中大型后端项目。</p>
<p>让我们简要概括一下特点：</p>
<ul>
<li><strong>分层清晰</strong>：Controller → Service → Model，职责分离</li>
<li><strong>装饰器驱动</strong>：路由、参数、校验等用 <code>@Get()</code>、<code>@Body()</code> 等声明</li>
<li><strong>模块化</strong>：按功能拆成 Module，便于扩展与复用</li>
<li><strong>开箱即用</strong>：与 TypeORM、Mongoose、Config、Validation 等集成简单</li>
</ul>
<hr/>
<h3 data-id="heading-2">二、项目结构一览</h3>
<pre><code class="hljs language-ruby" lang="ruby">src/
├── main.ts                    <span class="hljs-comment"># 应用入口，创建实例、全局配置、监听端口</span>
├── app.<span class="hljs-keyword">module</span>.ts              <span class="hljs-comment"># 根模块，汇总各功能模块与全局依赖</span>
├── app.controller.ts          <span class="hljs-comment"># 根控制器（如健康检查）</span>
├── app.service.ts
├── example/                  <span class="hljs-comment"># 示例功能模块（按业务划分）</span>
│   ├── example.<span class="hljs-keyword">module</span>.ts     <span class="hljs-comment"># 示例模块：注册模型、控制器、服务</span>
│   ├── example.controller.ts <span class="hljs-comment"># 示例相关 HTTP 接口</span>
│   ├── example.service.ts    <span class="hljs-comment"># 示例业务逻辑与数据库操作</span>
│   ├── dto/
│   │   └── example.dto.ts    <span class="hljs-comment"># 入参/出参的数据结构</span>
│   └── schemas/
│       └── example.schemas.ts <span class="hljs-comment"># Mongoose 文档模型</span>
├── tansform/
│   └── tansform.interceptor.ts  <span class="hljs-comment"># 全局响应包装（统一返回格式）</span>
└── http-exeption/
    └── http-exception.filter.ts <span class="hljs-comment"># 全局异常捕获与错误返回格式</span>
</code></pre>
<p>先建立整体印象：<strong>入口 → 根模块 → 各功能模块（Module + Controller + Service + Schema/DTO）</strong>，再配合拦截器、过滤器做统一格式和错误处理。</p>
<hr/>
<h3 data-id="heading-3">三、首先看一下入口文件：main.ts</h3>
<p>大都为固定写法，应用从这里启动：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TansformInterceptor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./tansform/tansform.interceptor'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HttpExceptionFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./http-exeption/http-exception.filter'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  app.<span class="hljs-title function_">setGlobalPrefix</span>(<span class="hljs-string">'api'</span>);                           <span class="hljs-comment">// 所有路由加 /api 前缀</span>
  app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TansformInterceptor</span>()); <span class="hljs-comment">// 统一成功响应格式</span>
  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpExceptionFilter</span>());      <span class="hljs-comment">// 统一错误响应格式</span>
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3005</span>);
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<p>简单解释一下：</p>
<ul>
<li><code>NestFactory.create(AppModule)</code>：根据根模块创建应用。</li>
<li><code>setGlobalPrefix('api')</code>：例如 <code>/example</code> 会变成 <code>/api/example</code>。</li>
<li>全局拦截器：在控制器返回后，把结果包成 <code>{ errno: 0, data }</code>。</li>
<li>全局异常过滤器：捕获 <code>HttpException</code>，返回 <code>{ error: -1, message, ... }</code>。</li>
<li>端口从环境变量 <code>PORT</code> 读，默认 3005。</li>
</ul>
<hr/>
<h3 data-id="heading-4">四、再看根模块：app.module.ts</h3>
<p>根模块负责「拼装」整个应用：配置、数据库、各业务模块。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>(),   <span class="hljs-comment">// 必须最先加载，才能读到 process.env</span>
    <span class="hljs-title class_">MongooseModule</span>.<span class="hljs-title function_">forRoot</span>(
      <span class="hljs-string">`mongodb://<span class="hljs-subst">${process.env.MONGO_HOST}</span>:<span class="hljs-subst">${process.env.MONGO_PORT}</span>/<span class="hljs-subst">${process.env.MONGO_DATABASE}</span>`</span>,
    ),
    <span class="hljs-title class_">ExampleModule</span>,
    <span class="hljs-title class_">UserModule</span>,
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<p>注意几个点：</p>
<ul>
<li><strong>ConfigModule.forRoot()</strong> 要放在最前面，否则后面的 <code>process.env.*</code> 可能是 <code>undefined</code>（例如 MongoDB 连接会变成 <code>undefined:undefined</code>）。</li>
<li><strong>MongooseModule.forRoot()</strong> 连接 MongoDB，一条连接多模块复用。</li>
<li><strong>ExampleModule、UserModule</strong> 等是功能模块，各自内部再注册 Controller、Service 和 <code>forFeature</code> 的模型。</li>
</ul>
<hr/>
<h3 data-id="heading-5">五、功能模块：以 Example 为例</h3>
<p>一个完整功能通常包含：<strong>Module + Controller + Service + Schema（+ DTO）</strong>。</p>
<h4 data-id="heading-6">5.1 模块：example.module.ts</h4>
<p>模块把「该功能需要的模型、控制器、服务」捆绑在一起：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">MongooseModule</span>.<span class="hljs-title function_">forFeature</span>([
      { <span class="hljs-attr">name</span>: <span class="hljs-title class_">Example</span>.<span class="hljs-property">name</span>, <span class="hljs-attr">schema</span>: <span class="hljs-title class_">ExampleSchema</span> },
    ]),
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">ExampleController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">ExampleService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleModule</span> {}
</code></pre>
<ul>
<li><strong>MongooseModule.forFeature</strong>：在当前模块内注册 Mongoose 模型，这样在 Service 里才能 <code>@InjectModel(Example.name)</code>。</li>
<li><strong>controllers / providers</strong>：声明本模块的控制器和可注入服务。</li>
</ul>
<h4 data-id="heading-7">5.2 控制器：example.controller.ts</h4>
<p>控制器只做「接收请求、调 Service、返回结果」，不写具体业务和数据库逻辑（类似于java中的controller去调用Facade，其实就是一个分层，使逻辑更清晰）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Controller</span>(<span class="hljs-string">'example'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> exampleService: ExampleService</span>) {}

  <span class="hljs-meta">@Post</span>()
  <span class="hljs-title function_">create</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exampleService</span>.<span class="hljs-title function_">create</span>();
  }

  <span class="hljs-meta">@Get</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-title function_">findOne</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">'id'</span>) id: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exampleService</span>.<span class="hljs-title function_">findOne</span>(id);
  }

  <span class="hljs-meta">@Patch</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-title class_">UpdateOne</span>(<span class="hljs-meta">@Param</span>(<span class="hljs-string">'id'</span>) <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-meta">@Body</span>() <span class="hljs-attr">exampleDto</span>: <span class="hljs-title class_">ExampleDto</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exampleService</span>.<span class="hljs-title function_">update</span>(id, exampleDto);
  }

  <span class="hljs-meta">@Delete</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-title function_">deleteOne</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">'id'</span>) id: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exampleService</span>.<span class="hljs-title function_">delete</span>(id);
  }
}
</code></pre>
<p>注意一下装饰器语法，常用的有：</p>
<ul>
<li><code>@Controller('example')</code>：路径前缀，得到 <code>/api/example/...</code>。</li>
<li><code>@Get() / @Post() / @Patch() / @Delete()</code>：HTTP 方法。</li>
<li><code>@Query()</code>：查询参数；<code>@Param()</code>：路径参数；<code>@Body()</code>：请求体。</li>
<li>Service 通过构造函数注入，由 Nest 自动创建并注入实例。</li>
</ul>
<h4 data-id="heading-8">5.3 服务：example.service.ts</h4>
<p>业务逻辑和数据库访问都放在 Service 里，通过注入的 Model 调用 Mongoose API：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@InjectModel</span>(Example.name)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> exampleModel,
  </span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> example = <span class="hljs-keyword">new</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">exampleModel</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'test'</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-attr">name</span>: <span class="hljs-string">'nest.js'</span> });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> example.<span class="hljs-title function_">save</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findOne</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exampleModel</span>.<span class="hljs-title function_">findById</span>(id);
  }


  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, updateData</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exampleModel</span>.<span class="hljs-title function_">updateOne</span>({ <span class="hljs-attr">_id</span>: id }, updateData);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exampleModel</span>.<span class="hljs-title function_">findByIdAndDelete</span>(id);
  }
}
</code></pre>
<ul>
<li><strong>@InjectModel(Example.name)</strong>：注入 Mongoose Model，<code>findById</code>、<code>updateOne</code>、<code>findByIdAndDelete</code> 等都是 Model 自带方法。</li>
</ul>
<h4 data-id="heading-9">5.4 文档模型：schemas/example.schemas.ts</h4>
<p>用 Nest 的 <code>@Schema</code> 和 Mongoose 定义集合结构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Schema</span>({ <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {
  <span class="hljs-meta">@Prop</span>({ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Prop</span>()
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ExampleSchema</span> = <span class="hljs-title class_">SchemaFactory</span>.<span class="hljs-title function_">createForClass</span>(<span class="hljs-title class_">Example</span>);
</code></pre>
<ul>
<li><code>timestamps: true</code> 会自动加 <code>createdAt</code>、<code>updatedAt</code>。</li>
<li><code>ExampleSchema</code> 在 <code>example.module.ts</code> 里通过 <code>forFeature</code> 注册，对应 MongoDB 里的一个集合。</li>
</ul>
<h4 data-id="heading-10">5.5 DTO：dto/example.dto.ts</h4>
<p>DTO 描述「请求体或某段数据的形状」，便于类型约束和后续加校验（如 class-validator）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleDto</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>在 Controller 里用 <code>@Body() exampleDto: ExampleDto</code> 即可获得类型提示和统一结构。</p>
<hr/>
<h3 data-id="heading-11">六、全局拦截器与异常过滤器</h3>
<h4 data-id="heading-12">6.1 统一成功响应：TansformInterceptor</h4>
<p>所有正常返回都会先经过拦截器，被包装成：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"errno"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
</code></pre>
<p>实现方式：在 <code>next.handle()</code> 的 Observable 上 <code>map</code> 一层即可,这样前端可以统一根据 <code>errno === 0</code> 和 <code>data</code> 处理成功结果。</p>
<h4 data-id="heading-13">6.2 统一错误响应：HttpExceptionFilter</h4>
<p>当控制器或 Service 抛出 <code>HttpException</code>（或 Nest 内置的 BadRequestException、NotFoundException 等）时，会被该过滤器捕获，返回例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"错误信息"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-01-30T..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/api/example/xxx"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>同时可以保留正确的 HTTP 状态码（如 400、404）。这样成功走拦截器、失败走过滤器，前后端约定清晰。</p>
<hr/>
<h3 data-id="heading-14">七、环境变量与 MongoDB</h3>
<p>根目录 <code>.env</code> 示例：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">MONGO_HOST</span>=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>
<span class="hljs-attr">MONGO_PORT</span>=<span class="hljs-number">27017</span>
<span class="hljs-attr">MONGO_DATABASE</span>=nestdb
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3005</span>
</code></pre>
<p>务必保证 <strong>ConfigModule.forRoot()</strong> 在 AppModule 的 <code>imports</code> 里排在最前，否则 <code>process.env.MONGO_HOST</code> 等可能未定义，导致连接失败。</p>
<hr/>
<h3 data-id="heading-15">八、小结与常用命令</h3>





































<table><thead><tr><th>概念</th><th>作用</th></tr></thead><tbody><tr><td><strong>Module</strong></td><td>把 Controller、Service、Mongoose forFeature 等组织在一起</td></tr><tr><td><strong>Controller</strong></td><td>定义路由，使用 @Query / @Param / @Body，调用 Service</td></tr><tr><td><strong>Service</strong></td><td>业务逻辑 + 注入 Model，做增删改查</td></tr><tr><td><strong>Schema</strong></td><td>Mongoose 文档结构，对应一个集合</td></tr><tr><td><strong>DTO</strong></td><td>请求/响应数据结构，便于类型与校验</td></tr><tr><td><strong>Interceptor</strong></td><td>在响应返回前统一包装（如 errno + data）</td></tr><tr><td><strong>ExceptionFilter</strong></td><td>捕获异常，统一错误返回格式</td></tr></tbody></table>
<p>常用命令（与常规前端应用基本一致）：</p>
<pre><code class="hljs language-bash" lang="bash">npm run start:dev   <span class="hljs-comment"># 开发模式，热重载</span>
npm run build       <span class="hljs-comment"># 编译</span>
npm run start:prod  <span class="hljs-comment"># 生产运行（需先 build）</span>
</code></pre>
<p>按「入口 → 根模块 → 功能模块（Module/Controller/Service/Schema/DTO）→ 拦截器与过滤器」这条线把项目走一遍，再动手增删改几条示例接口，就能快速入门 NestJS啦。<br/>
后续也可以在此基础上加入校验（ValidationPipe）、鉴权（Guard）等，逐步完善项目。<br/>如有错误，敬请指正~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JWT 认证原理与流程详解]]></title>    <link>https://juejin.cn/post/7603227363822125082</link>    <guid>https://juejin.cn/post/7603227363822125082</guid>    <pubDate>2026-02-06T03:18:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603227363822125082" data-draft-id="7603216479836913715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JWT 认证原理与流程详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T03:18:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小飞Coding"/> <meta itemprop="url" content="https://juejin.cn/user/954816145155181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JWT 认证原理与流程详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954816145155181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小飞Coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:18:51.000Z" title="Fri Feb 06 2026 03:18:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是 JWT？</h2>
<p><strong>JWT（JSON Web Token）</strong> 是一种开放标准（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7519" target="_blank" title="https://tools.ietf.org/html/rfc7519" ref="nofollow noopener noreferrer">RFC 7519</a>），用于在各方之间以 JSON 对象的形式安全地传输信息。它广泛应用于<strong>身份认证（Authentication）</strong> 和 <strong>信息交换（Information Exchange）</strong>。</p>
<h3 data-id="heading-1">1.1 JWT 的结构</h3>
<p>一个合法的 JWT 由三部分组成，用点 <code>.</code> 分隔：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">Header</span><span class="hljs-selector-class">.Payload</span><span class="hljs-selector-class">.Signature</span>
</code></pre>
<ul>
<li>
<p><strong>Header（头部）</strong>：描述签名算法和 token 类型</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"alg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HS256"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"typ"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"JWT"</span> <span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Payload（载荷）</strong>：包含“声明”（Claims），如用户 ID、角色、过期时间等</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"sub"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1001"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Alice"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"iat"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1700000000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1700003600</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Signature（签名）</strong>：用于验证 token 是否被篡改</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">HMACSHA256</span>(base64UrlEncode(header) + "." + <span class="hljs-built_in">base64UrlEncode</span>(payload), secret)
</code></pre>
</li>
</ul>
<blockquote>
<p>⚠️ 注意：JWT 使用 Base64Url <strong>编码</strong>，不是加密！<strong>不要在 Payload 中存放敏感信息（如密码）</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">二、JWT 认证的基本流程</h2>
<h3 data-id="heading-3">2.1 标准认证流程（浏览器或客户端）</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Client as 客户端
    participant AuthServer as 认证服务器
    participant API as 资源服务器

    User-&gt;&gt;Client: 输入账号密码
    Client-&gt;&gt;AuthServer: POST /login {username, password}
    AuthServer--&gt;&gt;AuthServer: 验证凭证
    AuthServer-&gt;&gt;Client: 200 OK { access_token, [refresh_token] }
    Client-&gt;&gt;API: GET /profile&lt;br/&gt;Authorization: Bearer &lt;access_token&gt;
    API-&gt;&gt;API: 验证 JWT（签名 + 过期时间）
    API--&gt;&gt;Client: 返回受保护资源
</code></pre>
<p><strong>Refresh Token可选。</strong></p>
<h3 data-id="heading-4">2.2 关键细节说明</h3>
<ul>
<li>
<p><strong>Access Token</strong>：短期有效（如 15 分钟），通常为 JWT。</p>
</li>
<li>
<p>传输方式：通过 HTTP Header：</p>
<pre><code class="hljs language-http" lang="http"/></pre>
</li>
</ul>
<p>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.x.x</p>
<pre><code class="hljs language-markdown" lang="markdown">
<span class="hljs-bullet">-</span> <span class="hljs-code">`Authorization`</span> 是 Header 名（key）
<span class="hljs-bullet">-</span> <span class="hljs-code">`Bearer &lt;token&gt;`</span> 是值（value），其中 <span class="hljs-code">`Bearer`</span> 是 OAuth 2.0 定义的认证方案。

------

<span class="hljs-section">## 三、JWT 的安全性原理</span>

<span class="hljs-section">### 3.1 为什么需要密钥？——签名机制</span>

JWT 的签名不是普通哈希，而是 <span class="hljs-strong">**带密钥的消息认证码（MAC）**</span>：

<span class="hljs-bullet">-</span> <span class="hljs-strong">**HS256（对称）**</span>：使用共享密钥（secret）进行 HMAC-SHA256 签名。
<span class="hljs-bullet">-</span> 只有知道密钥的服务端才能签发或验证 token。
<span class="hljs-bullet">-</span> ❌ 密钥 ≠ “盐”：盐可公开，密钥必须严格保密。
<span class="hljs-bullet">-</span> <span class="hljs-strong">**RS256（非对称）**</span>：服务端用私钥签名，其他服务用公钥验证。
<span class="hljs-bullet">-</span> 更适合微服务架构，避免密钥分发问题。

<span class="hljs-quote">&gt; ✅ 签名作用：确保 token 未被篡改，且来源可信。</span>

<span class="hljs-section">### 3.2 安全限制与风险</span>

| 风险                 | 应对措施                                                     |
| -------------------- | ------------------------------------------------------------ |
| Token 泄露（如 XSS） | 使用 HTTPS；Access Token 短有效期                            |
| 无法主动失效         | 引入 Refresh Token 机制；或维护 token 黑名单（牺牲无状态性） |
| 重放攻击             | 绑定设备/IP（可选）；限制 token 作用域                       |

------

<span class="hljs-section">## 四、Token 过期与刷新机制</span>

<span class="hljs-section">### 4.1 为什么需要 Refresh Token？</span>

<span class="hljs-bullet">-</span> Access Token 短期有效 → 安全性高，但频繁登录体验差。
<span class="hljs-bullet">-</span> Refresh Token 长期有效 → 用于静默获取新 Access Token。

<span class="hljs-section">### 4.2 推荐设计</span>

| 属性           | Access Token            | Refresh Token                                    |
| -------------- | ----------------------- | ------------------------------------------------ |
| 格式           | JWT                     | <span class="hljs-strong">**随机字符串（Opaque Token）**</span>                   |
| 存储（服务端） | 无（无状态）            | 数据库 / Redis（可撤销）                         |
| 有效期         | 5~30 分钟               | 数天至数周                                       |
| 传输方式       | <span class="hljs-code">`Authorization: Bearer`</span> | <span class="hljs-strong">**非浏览器：JSON Body；浏览器：HttpOnly Cookie**</span> |

<span class="hljs-quote">&gt; ✅ <span class="hljs-strong">**Refresh Token 不建议用 JWT**</span>，因其需支持吊销（如用户登出、异常检测）。</span>

<span class="hljs-section">### 4.3 刷新流程（外部系统调用）</span>

<span class="hljs-code">```mermaid
sequenceDiagram
  participant Client as 外部系统
  participant AuthServer as 认证服务器
  participant API as 资源服务器

  Client-&gt;&gt;API: GET /data&lt;br/&gt;Authorization: Bearer &lt;expired_token&gt;
  API--&gt;&gt;Client: 401 Unauthorized

  Client-&gt;&gt;AuthServer: POST /auth/refresh&lt;br/&gt;{ "refresh_token": "abc123" }
  AuthServer-&gt;&gt;AuthServer: 验证 refresh_token（查库 + 检查状态）
  alt 有效
      AuthServer-&gt;&gt;Client: 200 OK { "access_token": "new_jwt..." }
      Client-&gt;&gt;API: 重试请求 with new token
      API--&gt;&gt;Client: 200 OK 数据
  else 无效或过期
      AuthServer--&gt;&gt;Client: 401 { error: "invalid_grant" }
      Client-&gt;&gt;Client: 重新走完整登录流程
  end
</span></code></pre>
<blockquote>
<p>💡 外部系统（如 HttpClient）<strong>不应使用 Cookie</strong>，而应通过 JSON 或 Header 传递所有 token。</p>
</blockquote>
<hr/>
<p>非常好！你提供的技术资料已经非常完整，现在我们<strong>专门针对“内部系统作为客户端调用 token 接口”的场景</strong>，补充一个简洁、实用、不复杂的安全机制：<strong>使用 Client ID + Client Secret（客户端凭证）来保护 token 下发接口</strong>。</p>
<p>以下是新增的章节，建议插入在 <strong>第五节“特殊场景：非浏览器客户端”之后、第六节“JWT 验证流程”之前</strong>，作为 <strong>第五节（原第五节顺延为第六节，以此类推）</strong>：</p>
<hr/>
<h2 data-id="heading-5">五、保护 Token 下发接口：确保只有受信任的内部客户端能获取 JWT</h2>
<p>当你开放一个接口（如 <code>/auth/token</code>）用于下发 Access Token 时，<strong>必须防止该接口被任意程序调用</strong>。否则，攻击者可直接请求此接口，绕过前端逻辑，甚至暴力尝试用户凭证。</p>
<p>对于<strong>内部系统之间的调用</strong>（例如微服务 A 调用认证服务获取 JWT），推荐采用 <strong>Client ID + Client Secret（客户端凭证）</strong> 机制。这是一种简单、标准、安全的做法，无需复杂协议。</p>
<h3 data-id="heading-6">5.1 基本原理</h3>
<ul>
<li>每个可信的内部服务在认证服务器注册时，分配一对唯一凭证：
<ul>
<li><code>client_id</code>：公开标识（如 <code>order-service</code>）</li>
<li><code>client_secret</code>：高熵密钥（如 <code>aB3$xK9!qL2@mN8</code>），严格保密</li>
</ul>
</li>
<li>调用 <code>/token</code> 接口时，客户端必须提供这对凭证</li>
<li>认证服务验证凭证合法后，才签发 JWT</li>
</ul>
<blockquote>
<p>✅ 这本质上是 OAuth 2.0 的 <strong>Client Credentials Flow</strong>，但实现可以极简。</p>
</blockquote>
<h3 data-id="heading-7">5.2 调用方式（推荐 HTTP Basic Auth）</h3>
<p>客户端通过 <strong>HTTP Basic Authentication</strong> 传递凭证（符合标准且简单）：</p>
<pre><code class="hljs language-http" lang="http">POST /auth/token
Host: auth.yourcompany.com
Authorization: Basic base64(client_id:client_secret)
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
</code></pre>
<h4 data-id="heading-8">示例（curl）：</h4>
<pre><code class="hljs language-bash" lang="bash">curl -u <span class="hljs-string">"order-service:aB3<span class="hljs-variable">$xK9</span>!qL2@mN8"</span> \
  -d <span class="hljs-string">"grant_type=client_credentials"</span> \
  https://auth.yourcompany.com/auth/token
</code></pre>
<blockquote>
<p>💡 为什么用 Basic Auth？</p>
<ul>
<li>凭证不会出现在 URL 或请求体明文</li>
<li>所有 HTTP 客户端天然支持</li>
<li>避免自定义 Header 带来的兼容性问题</li>
</ul>
</blockquote>
<h3 data-id="heading-9">5.3 服务端验证逻辑（简化版）</h3>
<p>认证服务收到请求后，执行以下步骤：</p>
<ol>
<li>从 <code>Authorization: Basic xxx</code> 中解析出 <code>client_id</code> 和 <code>client_secret</code></li>
<li>查询本地配置或数据库，检查：
<ul>
<li><code>client_id</code> 是否存在？</li>
<li>提供的 <code>client_secret</code> 是否匹配？</li>
</ul>
</li>
<li>若验证通过，生成并返回 JWT；否则返回 <code>401 Unauthorized</code></li>
</ol>
<blockquote>
<p>🔐 安全提示：</p>
<ul>
<li><code>client_secret</code> 应通过安全方式分发（如环境变量、K8s Secret、Vault）</li>
<li>不要将 secret 写入代码或明文配置文件</li>
<li>所有通信必须走 HTTPS</li>
</ul>
</blockquote>
<h3 data-id="heading-10">5.4 优势与适用性</h3>

























<table><thead><tr><th>优点</th><th>说明</th></tr></thead><tbody><tr><td><strong>简单</strong></td><td>无需 PKI、mTLS、复杂签名</td></tr><tr><td><strong>标准</strong></td><td>符合 OAuth 2.0，工具链广泛支持</td></tr><tr><td><strong>可控</strong></td><td>可随时禁用某个 <code>client_id</code>（如服务下线或泄露）</td></tr><tr><td><strong>隔离</strong></td><td>不同服务使用不同凭证，权限可细分</td></tr></tbody></table>
<blockquote>
<p>✅ 适用于：内部微服务、定时任务、后台脚本等<strong>可信后端系统</strong>。</p>
</blockquote>
<hr/>
<p>这样补充后，你的技术资料就完整覆盖了 <strong>“如何防止 token 接口裸奔”</strong> 的关键安全问题，同时保持实现简单、易于落地。</p>
<p>其余章节编号请相应顺延即可。是否需要我帮你生成完整的修订版文档？</p>
<h2 data-id="heading-11">六、特殊场景：非浏览器客户端（如第三方系统）</h2>
<p>✅**正确做法：**全部使用 Token（放在 Header 中）</p>
<p>在非浏览器客户端场景下，当调用方是后端服务、脚本或外部系统时：</p>




















<table><thead><tr><th>Token 类型</th><th>存放位置</th><th>说明</th></tr></thead><tbody><tr><td><strong>Access Token</strong></td><td><code>Authorization: Bearer &lt;JWT&gt;</code></td><td>必须，用于每次 API 调用</td></tr><tr><td><strong>Refresh Token</strong></td><td><strong>也放在 Body 或 Header</strong>（不再是 Cookie！）</td><td>因为对方是程序，可以安全存储并主动发送</td></tr></tbody></table>
<h3 data-id="heading-12">示例流程（外部系统调用）</h3>
<pre><code class="hljs language-http" lang="http"># 1. 获取 token（客户端 ID + Secret）
POST /oauth/token
Content-Type: application/json

{ "grant_type": "client_credentials", "client_id": "svc-a", "client_secret": "xxx" }

→ 
200 OK
{
  "access_token": "eyJ...",      // JWT
  "refresh_token": "def456...",  // 随机字符串 or JWT（根据设计）
  "expires_in": 900
}
# 2. 调用 API
GET /api/data
Authorization: Bearer eyJ...
# 3. 刷新 token（当 access_token 过期）
POST /oauth/refresh
Content-Type: application/json

{ "refresh_token": "def456..." }  ← 放在 body 中！

→ 
200 OK
{ "access_token": "new_jwt...", "refresh_token": "new_def..." }
</code></pre>
<h2 data-id="heading-13">🛡️ 安全建议（针对外部系统）</h2>
<ol>
<li><strong>使用 HTTPS 强制加密</strong>
所有 token 在传输中必须加密（否则会被中间人窃取）。</li>
<li><strong>Refresh Token 仍应可撤销</strong>
即使放在 Body 中，也要在服务端数据库存储其状态（是否过期、是否被吊销）。</li>
<li><strong>限制客户端权限（Scope）</strong>
使用 OAuth2 的 <code>scope</code> 字段，确保外部系统只能访问所需资源。</li>
<li><strong>使用 Client Credentials Flow（OAuth2）</strong>
适合 M2M 场景：用 <code>client_id + client_secret</code> 换取 Access Token，无需用户参与。</li>
</ol>
<hr/>
<h2 data-id="heading-14">七、JWT 验证流程（服务端视角）</h2>
<p>当收到一个 JWT，服务端按以下步骤验证：</p>
<ol>
<li><strong>格式检查</strong>：是否包含 exactly 两个 <code>.</code>？</li>
<li><strong>分割三段</strong>：Header、Payload、Signature。</li>
<li><strong>Base64Url 解码</strong> Header 和 Payload。</li>
<li>验证签名：
<ul>
<li>用 header 指定的算法 + 服务端密钥重新计算签名。</li>
<li>与原始 Signature 比较，不一致则拒绝。</li>
</ul>
</li>
<li>验证 Claims：
<ul>
<li><code>exp</code>：是否过期？</li>
<li><code>nbf</code>：是否尚未生效？</li>
<li><code>iss</code> / <code>aud</code>：签发者和受众是否合法？</li>
</ul>
</li>
<li><strong>（可选）额外检查</strong>：用户是否被禁用？IP 是否异常？</li>
<li><strong>通过</strong>：从 <code>sub</code> 等字段提取用户身份，继续处理请求。</li>
</ol>
<blockquote>
<p>✅ 整个过程通常无需查数据库（除非做额外风控）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">八、最佳实践总结</h2>





































<table><thead><tr><th>项目</th><th>建议</th></tr></thead><tbody><tr><td><strong>Access Token</strong></td><td>使用 JWT，短期有效，放 <code>Authorization: Bearer</code></td></tr><tr><td><strong>Refresh Token</strong></td><td>使用随机字符串，长期有效，服务端可撤销</td></tr><tr><td><strong>浏览器场景</strong></td><td>Refresh Token 存 HttpOnly + Secure + SameSite Cookie</td></tr><tr><td><strong>外部系统场景</strong></td><td>所有 token 通过 JSON/Header 传递，不用 Cookie</td></tr><tr><td><strong>传输安全</strong></td><td>强制 HTTPS</td></tr><tr><td><strong>算法选择</strong></td><td>优先 RS256（非对称）；若单体应用可用 HS256（密钥严格保密）</td></tr><tr><td><strong>错误处理</strong></td><td>明确区分 <code>access_token_expired</code> 与 <code>invalid_refresh_token</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">九、常见误区澄清</h2>
<ul>
<li>❌ “JWT 是加密的” → 实际只是编码，内容可读。</li>
<li>❌ “Refresh Token 也该是 JWT” → 会失去可撤销性，不推荐。</li>
<li>❌ “HttpOnly Cookie 能防 CSRF” → 不能！需配合 <code>SameSite</code> 或 CSRF Token。</li>
<li>❌ “所有客户端都适合用 Cookie” → 仅浏览器适用，外部系统应走 Token-in-Header。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[CustomColorBuffer节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7603201727716442164</link>    <guid>https://juejin.cn/post/7603201727716442164</guid>    <pubDate>2026-02-06T03:30:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603201727716442164" data-draft-id="7603201727716425780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[CustomColorBuffer节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2026-02-06T03:30:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[CustomColorBuffer节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:30:03.000Z" title="Fri Feb 06 2026 03:30:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>自定义颜色节点（Custom Color Node）是Unity高清渲染管线（HDRP）中一个重要的着色器图形节点，专门用于访问HDRP分配的自定义通道颜色缓冲区。这个节点为着色器开发者提供了在渲染过程中读取和利用自定义颜色数据的能力，是实现复杂渲染效果的关键工具之一。</p>
<p>在HDRP渲染管线中，自定义颜色缓冲区是一种特殊的渲染目标，允许开发者在渲染过程中存储额外的颜色信息。这些信息可以在后续的渲染通道中被其他着色器读取和使用，从而实现各种高级渲染技术，如自定义光照计算、后期处理效果、材质属性传递等。</p>
<p>自定义颜色节点的核心功能是从自定义颜色缓冲区中采样数据。它接受UV坐标作为输入，返回对应屏幕位置的自定义颜色值。这使得开发者能够在着色器中访问之前渲染通道中存储的颜色信息，为创建复杂的多通道渲染效果提供了可能。</p>
<h2 data-id="heading-0">渲染管线兼容性</h2>
<p>自定义颜色节点在不同渲染管线中的支持情况是开发者需要重点关注的内容。了解节点的兼容性有助于正确选择和使用该节点，避免在不支持的渲染管线中出现错误或意外行为。</p>















<table><thead><tr><th><strong>节点</strong></th><th><strong>通用渲染管线 (URP)</strong></th><th><strong>高清渲染管线 (HDRP)</strong></th></tr></thead><tbody><tr><td>Custom Color Node</td><td>否</td><td>是</td></tr></tbody></table>
<p>从兼容性表格可以清楚地看到，自定义颜色节点是HDRP特有的功能，在URP中不被支持。这一差异源于两个渲染管线的架构设计和功能定位不同。</p>
<p>HDRP作为Unity的高端渲染解决方案，专注于实现最高质量的图形效果，支持各种复杂的渲染技术。自定义颜色缓冲区是HDRP多通道渲染架构的重要组成部分，允许开发者在不同的渲染通道之间传递颜色数据。</p>
<p>相比之下，URP作为轻量级渲染管线，优先考虑性能和跨平台兼容性，因此没有实现自定义颜色缓冲区这样的高级功能。URP提供了更简化的渲染路径，减少了渲染通道的复杂性和资源消耗。</p>
<p>当在URP项目中使用自定义颜色节点时，Shader Graph会显示错误提示，并且节点不会产生任何有效输出。如果项目需要从URP迁移到HDRP，或者反之，开发者需要注意这一点，并相应调整着色器逻辑。</p>
<h2 data-id="heading-1">端口详解</h2>
<p>自定义颜色节点包含两个主要端口：输入端口UV和输出端口Output。理解这些端口的功能和使用方法是正确使用该节点的关键。</p>
<h3 data-id="heading-2">UV输入端口</h3>
<p>UV输入端口是自定义颜色节点的主要输入接口，用于指定从自定义颜色缓冲区采样的位置。</p>





























<table><thead><tr><th>特性</th><th>描述</th></tr></thead><tbody><tr><td><strong>名称</strong></td><td>UV</td></tr><tr><td><strong>方向</strong></td><td>输入</td></tr><tr><td><strong>类型</strong></td><td>Vector 4</td></tr><tr><td><strong>绑定</strong></td><td>屏幕位置（Screen Position）</td></tr><tr><td><strong>描述</strong></td><td>设置用于采样的标准化屏幕坐标</td></tr></tbody></table>
<p>UV端口接受Vector 4类型的输入，但实际使用的通常是xy分量，对应屏幕空间的标准化坐标。标准化坐标意味着坐标值范围在[0,1]之间，其中(0,0)表示屏幕左下角，(1,1)表示屏幕右上角。</p>
<p>在实际使用中，UV输入通常连接到Screen Position节点的输出。Screen Position节点提供了当前像素在屏幕空间中的位置信息，可以以不同的坐标空间形式输出：</p>
<ul>
<li>默认的屏幕空间坐标（中心为(0,0)，范围取决于分辨率）</li>
<li>标准化屏幕坐标（范围[0,1]）</li>
<li>原始屏幕坐标（像素坐标）</li>
</ul>
<p>对于自定义颜色节点，最常用的是标准化屏幕坐标，因为它不受屏幕分辨率影响，能够确保在不同分辨率和宽高比下的一致行为。</p>
<p>除了直接使用屏幕位置，UV输入还可以经过变换处理，以实现特定的采样效果。例如，可以通过Tiling和Offset操作实现纹理的平铺和偏移，或者使用数学节点对UV坐标进行扭曲，创建特殊的视觉效果。</p>
<h3 data-id="heading-3">Output输出端口</h3>
<p>Output输出端口是自定义颜色节点的主要输出接口，提供从自定义颜色缓冲区采样得到的颜色值。</p>





























<table><thead><tr><th>特性</th><th>描述</th></tr></thead><tbody><tr><td><strong>名称</strong></td><td>Output</td></tr><tr><td><strong>方向</strong></td><td>输出</td></tr><tr><td><strong>类型</strong></td><td>Vector 4</td></tr><tr><td><strong>绑定</strong></td><td>无</td></tr><tr><td><strong>描述</strong></td><td>采样坐标位置的自定义通道颜色缓冲区中的值</td></tr></tbody></table>
<p>Output端口输出Vector 4类型的值，对应RGBA颜色通道。在HDRP中，自定义颜色缓冲区通常使用HDR（高动态范围）格式存储颜色信息，这意味着颜色值可以超过[0,1]的范围，支持更亮的颜色和更丰富的光照细节。</p>
<p>输出颜色的具体含义和用途取决于自定义颜色缓冲区的写入内容。在HDRP中，自定义颜色缓冲区可以通过以下方式填充：</p>
<ul>
<li>使用自定义渲染通道（Custom Pass）写入数据</li>
<li>在材质的着色器中直接写入自定义颜色缓冲区</li>
<li>通过HDRP的体积系统或后期处理效果写入</li>
</ul>
<p>由于自定义颜色缓冲区可能包含各种类型的数据（不仅仅是颜色值），开发者在使用时需要了解数据的来源和格式。例如，自定义颜色缓冲区可能存储的是法线信息、深度值、材质属性或其他自定义数据，这时需要对采样结果进行适当的解码和处理。</p>
<h2 data-id="heading-4">使用场景与示例</h2>
<p>自定义颜色节点在HDRP项目中有广泛的应用场景，特别是在需要多通道渲染和自定义后期处理效果的复杂项目中。</p>
<h3 data-id="heading-5">屏幕空间效果</h3>
<p>自定义颜色节点常用于创建各种屏幕空间效果，通过在一个渲染通道中计算并存储数据，在后续通道中读取使用。</p>
<ul>
<li><strong>屏幕空间反射</strong>：在第一个通道中渲染场景并存储反射数据到自定义颜色缓冲区，在第二个通道中采样这些数据计算反射效果</li>
<li><strong>高级雾效</strong>：存储每个像素的雾效参数，在后期处理中实现复杂的体积雾效果</li>
<li><strong>自定义抗锯齿</strong>：存储几何边界信息，用于实现比MSAA更高级的自定义抗锯齿算法</li>
</ul>
<h3 data-id="heading-6">材质特效</h3>
<p>通过自定义颜色节点，可以实现需要访问屏幕空间数据的复杂材质效果。</p>
<ul>
<li><strong>湿表面效果</strong>：根据自定义颜色缓冲区中存储的湿度图，动态调整材质的反射率和光滑度</li>
<li><strong>变形效果</strong>：使用自定义颜色缓冲区中的变形数据，扭曲材质表面创建热浪或水下扭曲效果</li>
<li><strong>边缘光增强</strong>：结合自定义颜色缓冲区中的深度和法线信息，实现更精确的边缘光效果</li>
</ul>
<h3 data-id="heading-7">数据传递与后处理</h3>
<p>自定义颜色节点可以作为不同渲染元素之间的数据桥梁，实现复杂的渲染管线。</p>
<ul>
<li><strong>光照传递</strong>：将复杂的光照计算结果存储到自定义颜色缓冲区，供多个后期处理效果使用</li>
<li><strong>蒙版与选择</strong>：存储对象ID或选择信息，实现点击选择、区域高亮等交互功能</li>
<li><strong>自定义深度使用</strong>：存储非标准的深度信息，用于特殊的光照计算或雾效</li>
</ul>
<h2 data-id="heading-8">配置与设置</h2>
<p>在HDRP中使用自定义颜色节点前，需要正确配置渲染管线资产和自定义颜色缓冲区。</p>
<h3 data-id="heading-9">HDRP资源配置</h3>
<p>确保HDRP资源中启用了自定义颜色缓冲区支持：</p>
<ul>
<li>在Project窗口中选择HDRP资源</li>
<li>在Inspector中找到Frame Settings &gt; Lighting</li>
<li>确保Custom Color选项已启用</li>
<li>根据需要设置自定义颜色缓冲区的格式和精度</li>
</ul>
<h3 data-id="heading-10">自定义渲染通道设置</h3>
<p>通过自定义渲染通道（Custom Pass）向自定义颜色缓冲区写入数据：</p>
<ul>
<li>创建Custom Pass Volume或将Custom Pass组件添加到相机</li>
<li>选择适当的Custom Pass类型（如Draw Renderers）</li>
<li>在Custom Pass的设置中，指定目标颜色缓冲区为Custom Color</li>
<li>编写或选择用于写入自定义颜色缓冲区的着色器</li>
</ul>
<h3 data-id="heading-11">着色器中的写入</h3>
<p>在着色器中向自定义颜色缓冲区写入数据：</p>
<pre><code class="hljs language-scss" lang="scss">HLSL

<span class="hljs-comment">// 在片元着色器中</span>
void <span class="hljs-built_in">frag</span>(v2f i, out float4 outColor : COLOR, out float4 customColor : CustomColor)
{
    <span class="hljs-comment">// 计算主颜色输出</span>
    outColor = <span class="hljs-built_in">CalculateMainColor</span>(i);

    <span class="hljs-comment">// 计算并写入自定义颜色</span>
    customColor = <span class="hljs-built_in">CalculateCustomData</span>(i);
}
</code></pre>
<h2 data-id="heading-12">性能考虑</h2>
<p>使用自定义颜色节点时需要考虑性能影响，特别是在移动平台或性能敏感的场景中。</p>
<h3 data-id="heading-13">带宽与内存</h3>
<p>自定义颜色缓冲区会增加显存占用和内存带宽使用：</p>
<ul>
<li>评估是否需要全分辨率的自定义颜色缓冲区，考虑使用半分辨率或四分之一分辨率</li>
<li>选择合适的缓冲区格式，避免不必要的精度浪费</li>
<li>在不需要自定义颜色效果的相机上禁用相关功能</li>
</ul>
<h3 data-id="heading-14">采样优化</h3>
<p>优化自定义颜色缓冲区的采样操作：</p>
<ul>
<li>避免在片元着色器中进行多次采样，考虑使用预计算或顶点着色器采样</li>
<li>使用适当的mipmap级别或使用采样器状态优化读取性能</li>
<li>考虑使用计算着色器进行批量处理，减少片元着色器的负担</li>
</ul>
<h3 data-id="heading-15">平台差异</h3>
<p>不同硬件平台对自定义颜色缓冲区的支持可能有所不同：</p>
<ul>
<li>移动设备可能对渲染目标数量有限制</li>
<li>某些平台可能不支持特定的缓冲区格式</li>
<li>测试在不同设备上的性能和兼容性，准备回退方案</li>
</ul>
<h2 data-id="heading-16">故障排除</h2>
<p>在使用自定义颜色节点时可能遇到的常见问题及解决方法。</p>
<h3 data-id="heading-17">节点不工作</h3>
<p>如果自定义颜色节点没有输出预期结果：</p>
<ul>
<li>确认项目使用的是HDRP渲染管线，而不是URP或内置渲染管线</li>
<li>检查HDRP资源中是否启用了Custom Color功能</li>
<li>验证自定义颜色缓冲区是否已被正确写入数据</li>
<li>检查UV输入是否正确连接，确保采样位置正确</li>
</ul>
<h3 data-id="heading-18">颜色值异常</h3>
<p>如果采样得到的颜色值不符合预期：</p>
<ul>
<li>确认自定义颜色缓冲区的数据格式与读取预期一致</li>
<li>检查写入自定义颜色缓冲区的着色器逻辑是否正确</li>
<li>验证颜色空间（Gamma/Linear）设置是否一致</li>
<li>使用Frame Debugger检查自定义颜色缓冲区的实际内容</li>
</ul>
<h3 data-id="heading-19">性能问题</h3>
<p>如果使用自定义颜色节点导致性能下降：</p>
<ul>
<li>检查自定义颜色缓冲区的分辨率和格式是否必要</li>
<li>分析渲染管线，确认自定义颜色缓冲区是否被多次读写</li>
<li>考虑合并渲染通道，减少渲染目标切换</li>
<li>使用RenderDoc或类似工具分析GPU性能</li>
</ul>
<h2 data-id="heading-20">进阶技巧</h2>
<p>掌握基本用法后，可以尝试以下进阶技巧提升渲染效果和性能。</p>
<h3 data-id="heading-21">多缓冲区协同</h3>
<p>结合多个自定义颜色缓冲区实现复杂效果：</p>
<ul>
<li>使用不同的自定义颜色缓冲区存储不同类型的数据</li>
<li>通过组合多个缓冲区的数据创建复杂的材质响应</li>
<li>实现基于物理的渲染扩展，存储额外的光照信息</li>
</ul>
<h3 data-id="heading-22">动态分辨率</h3>
<p>根据性能需求动态调整自定义颜色缓冲区的分辨率：</p>
<ul>
<li>在高速运动时使用低分辨率缓冲区</li>
<li>静态场景或重要时刻使用高分辨率</li>
<li>实现基于内容的自适应分辨率策略</li>
</ul>
<h3 data-id="heading-23">自定义解码</h3>
<p>对自定义颜色缓冲区中的数据进行特殊编码和解码：</p>
<ul>
<li>将多个参数打包到单个颜色通道中</li>
<li>使用特殊的数据编码方案提高精度或范围</li>
<li>实现无损或有损的数据压缩，减少带宽使用</li>
</ul>
<h2 data-id="heading-24">总结</h2>
<p>自定义颜色节点是HDRP中一个强大而灵活的工具，为着色器开发者提供了访问自定义颜色缓冲区的能力。通过正确理解和使用这个节点，可以实现各种高级渲染效果，提升项目的视觉质量。</p>
<p>关键要点包括：</p>
<ul>
<li>自定义颜色节点仅在HDRP中可用，URP不支持</li>
<li>节点通过UV输入指定采样位置，输出对应位置的颜色值</li>
<li>使用前需要正确配置HDRP资源和自定义颜色缓冲区</li>
<li>考虑性能影响，特别是在移动设备和低端硬件上</li>
<li>结合自定义渲染通道和后期处理可以实现复杂的效果</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS-AbortController：优雅中止请求操作]]></title>    <link>https://juejin.cn/post/7603263490342158345</link>    <guid>https://juejin.cn/post/7603263490342158345</guid>    <pubDate>2026-02-06T03:32:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490342158345" data-draft-id="7603294029531250739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS-AbortController：优雅中止请求操作"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-02-06T03:32:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS-AbortController：优雅中止请求操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:32:44.000Z" title="Fri Feb 06 2026 03:32:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在前端开发中，我们经常遇到需要中途撤回请求的情况（例如：搜索框快速输入、大型文件上传取消、或是 AI 聊天流的即时中断）。传统的 Promise 一旦启动就无法在外部“叫停”，而 <code>AbortController</code> 的出现，完美填补了这一空白。</p>
<h2 data-id="heading-1">一、 核心概念与原理</h2>
<p><code>AbortController</code> 是 JavaScript 内置的信号控制对象，它是实现异步操作可控制、可中止的核心。</p>
<h3 data-id="heading-2">1. 关键组成部分</h3>
<ul>
<li>
<p><strong><code>controller.signal</code></strong>：一个 <code>AbortSignal</code> 对象实例。它充当“监听器”，将其传递给异步操作后，该操作会持续观察信号状态。</p>
</li>
<li>
<p><strong><code>controller.abort()</code></strong> ：触发中止的方法。调用后，<code>signal</code> 上的 <code>abort</code> 事件会被触发，同时将 <code>signal.aborted</code> 设为 <code>true</code>。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 基础使用模式</h2>
<h3 data-id="heading-4">1. 实现步骤</h3>
<ol>
<li>使用 <code>new AbortController()</code> 生成实例。</li>
<li>将实例中的 <code>signal</code> 属性传递给需要支持中止的异步 API（如 <code>fetch</code>）。</li>
<li>在合适的时机调用 <code>controller.abort()</code> 即可主动终止。</li>
</ol>
<h3 data-id="heading-5">2. 代码示例</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 1. 创建 AbortController 实例</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> { signal } = controller;

<span class="hljs-comment">// 2. 发起请求并绑定信号</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/data"</span>, { signal })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求成功:"</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-comment">// 3. 捕获中止错误</span>
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">"AbortError"</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"主动取消：请求被成功截断"</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求失败:"</span>, err);
    }
  });

<span class="hljs-comment">// 2 秒后主动取消请求</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>(); 
}, <span class="hljs-number">2000</span>);
</code></pre>
<hr/>
<h2 data-id="heading-6">三、 进阶技巧与场景</h2>
<h3 data-id="heading-7">1. 批量取消请求</h3>
<p>如果想同时取消多个相关的请求，可以给这些请求<strong>共享同一个 <code>signal</code></strong>。当调用 <code>abort()</code> 时，所有关联的任务都会收到中止信号。</p>
<h3 data-id="heading-8">2. 示例</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 使用同一个 AbortController 取消多个请求</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

<span class="hljs-comment">// 请求1</span>
<span class="hljs-keyword">const</span> request1 = <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'url1'</span>, {
  <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
});

<span class="hljs-comment">// 请求2</span>
<span class="hljs-keyword">const</span> request2 = <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'url2'</span>, {
  <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
});

<span class="hljs-comment">// 请求3</span>
<span class="hljs-keyword">const</span> request3 = <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'url3'</span>, {
  <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
});

<span class="hljs-comment">// 同时取消所有请求</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'cancelBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有请求已取消'</span>);
});

<span class="hljs-comment">// 等待所有请求</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([request1, request2, request3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">responses</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(responses.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>())))
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有数据:'</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消'</span>);
    }
  });
</code></pre>
<h3 data-id="heading-9">3. 注意事项</h3>
<ul>
<li><strong>兼容性</strong>：并非所有 API 都原生支持。目前 <code>fetch</code>、<code>Axios (v0.22+)</code> 模块已提供支持。</li>
<li><strong>幂等性</strong>：<code>abort()</code> 方法<strong>只能生效一次</strong>。多次调用虽然不会报错，但只有第一次调用会触发中止逻辑。</li>
</ul>
<hr/>
<h2 data-id="heading-10">四、 总结对比</h2>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>传统 Promise</strong></th><th><strong>带有 AbortController 的 Promise</strong></th></tr></thead><tbody><tr><td><strong>可控性</strong></td><td>开启后无法干预</td><td>可随时通过 <code>abort()</code> 中止</td></tr><tr><td><strong>异常处理</strong></td><td>只有成功/失败</td><td>增加 <code>AbortError</code> 类型，方便区分主动取消与网络异常</td></tr><tr><td><strong>应用场景</strong></td><td>简单的数据获取</td><td>复杂交互、流式输出、性能调优</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 面试问题]]></title>    <link>https://juejin.cn/post/7603294029531349043</link>    <guid>https://juejin.cn/post/7603294029531349043</guid>    <pubDate>2026-02-06T03:39:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603294029531349043" data-draft-id="7603216479837061171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 面试问题"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-02-06T03:39:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 面试问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:39:36.000Z" title="Fri Feb 06 2026 03:39:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是为初学者和初级开发者（0-3年经验）准备的<strong>2024-2025版终极汇总清单——88个Spring Boot面试问题全集</strong>。</p>
<p><img src="https://cf-blog.icodebuddy.com/image/108/108-0.jpg" alt="" loading="lazy"/></p>
<p>涵盖了TCS、Infosys、Cognizant、Accenture、Capgemini、Wipro、Deloitte、IBM、Mindtree、LTIMindtree、Tech Mahindra、HCL等公司提出的所有问题。</p>
<p>| 序号 | 问题 |</p>
<p>| :--- | :--- |</p>
<p>| 1 | 什么是 Spring Boot？ |</p>
<p>| 2 | Spring Boot 相较于 Spring Framework 有哪些优势？ |</p>
<p>| 3 | Spring Boot 中的自动配置是什么？ |</p>
<p>| 4 | 什么是 Spring Boot Starters？列举一些重要的 starter。 |</p>
<p>| 5 | <code>@SpringBootApplication</code> 注解的作用是什么？ |</p>
<p>| 6 | <code>@SpringBootApplication</code> 内部包含哪三个主要注解？ |</p>
<p>| 7 | 解释 SpringBootApplication 的 <code>main()</code> 方法的作用。 |</p>
<p>| 8 | 什么是 <code>application.properties</code> 和 <code>application.yml</code>？ |</p>
<p>| 9 | 如何在 Spring Boot 中更改默认端口？ |</p>
<p>| 10 | <code>application.properties</code> 和 <code>application.yml</code> 之间的区别？ |</p>
<p>| 11 | <code>@RestController</code> 注解是什么？ |</p>
<p>| 12 | <code>@Controller</code> 和 <code>@RestController</code> 的区别？ |</p>
<p>| 13 | 什么是 <code>@RequestMapping</code>？ |</p>
<p>| 14 | <code>@GetMapping</code>、<code>@PostMapping</code>、<code>@PutMapping</code>、<code>@DeleteMapping</code> 是什么？ |</p>
<p>| 15 | <code>@PathVariable</code> 和 <code>@RequestParam</code> 的区别？ |</p>
<p>| 16 | 如何在 Spring Boot 中返回 JSON 响应？ |</p>
<p>| 17 | 什么是 Spring Boot Actuator？如何启用它？ |</p>
<p>| 18 | 列举一些重要的 Actuator 端点。 |</p>
<p>| 19 | 如何启用所有的 Actuator 端点？ |</p>
<p>| 20 | <code>@Component</code>、<code>@Service</code>、<code>@Repository</code> 注解的用途？ |</p>
<p>| 21 | 什么是依赖注入？Spring Boot 是如何实现的？ |</p>
<p>| 22 | <code>@Autowired</code> 是什么？我们可以在哪里使用它？ |</p>
<p>| 23 | <code>@Component</code> 和 <code>@Bean</code> 的区别？ |</p>
<p>| 24 | <code>@Configuration</code> 注解是什么？ |</p>
<p>| 25 | Spring Boot 中的 <code>@Profile</code> 是什么？如何使用？ |</p>
<p>| 26 | 如何创建多个配置文件（dev、prod、test）？ |</p>
<p>| 27 | 什么是 Spring Boot DevTools？它为什么有用？ |</p>
<p>| 28 | <code>@Entity</code> 注解的用途是什么？ |</p>
<p>| 29 | 什么是 JPA 和 Hibernate？ |</p>
<p>| 30 | 什么是 Spring Data JPA？ |</p>
<p>| 31 | <code>spring-boot-starter-data-jpa</code> 的作用是什么？ |</p>
<p>| 32 | 如何使用 <code>application.properties</code> 连接数据库？ |</p>
<p>| 33 | Spring Boot 中默认的嵌入式数据库是什么？ |</p>
<p>| 34 | 列举你使用过的不同 Spring Boot Starters。 |</p>
<p>| 35 | 什么是 <code>spring-boot-starter-web</code>？ |</p>
<p>| 36 | 什么是 <code>spring-boot-starter-test</code>？它包含哪些库？ |</p>
<p>| 37 | <code>@SpringBootTest</code> 注解是什么？ |</p>
<p>| 38 | <code>@MockBean</code> 的用途是什么？ |</p>
<p>| 39 | 如何在 Spring Boot 中全局处理异常？ |</p>
<p>| 40 | 什么是 <code>@ControllerAdvice</code> 和 <code>@ExceptionHandler</code>？ |</p>
<p>| 41 | 如何在 Spring Boot 中创建自定义异常？ |</p>
<p>| 42 | <code>@ResponseStatus</code> 和 <code>@ExceptionHandler</code> 的区别？ |</p>
<p>| 43 | Spring Boot 中的日志记录是什么？如何更改日志级别？ |</p>
<p>| 44 | Spring Boot 中默认的日志框架是什么？ |</p>
<p>| 45 | 如何在 Spring Boot 中外部化配置？ |</p>
<p>| 46 | 什么是 Spring Boot CLI？ |</p>
<p>| 47 | 如何创建可执行 JAR？ |</p>
<p>| 48 | Spring MVC 和 Spring Boot 的区别？ |</p>
<p>| 49 | <code>pom.xml</code> 和 <code>spring-boot-starter-parent</code> 的作用是什么？ |</p>
<p>| 50 | <code>spring-boot-starter-parent</code> 和导入 BOM 的区别？ |</p>
<p>| 51 | 如何覆盖 <code>spring-boot-starter-parent</code> 的属性？ |</p>
<p>| 52 | <code>@Bean</code> 与 <code>@Component</code>？何时使用哪个？ |</p>
<p>| 53 | 什么是 <code>@Qualifier</code>？举例说明。 |</p>
<p>| 54 | <code>@Primary</code> 和 <code>@Qualifier</code> 的区别？ |</p>
<p>| 55 | 分步解释 Spring Boot 的启动过程。 |</p>
<p>| 56 | 什么是嵌入式 Tomcat？为什么它是 Spring Boot 的默认选项？ |</p>
<p>| 57 | 如何将嵌入式服务器更改为 Jetty 或 Undertow？ |</p>
<p>| 58 | REST 中受检查异常和非受检查异常的区别？ |</p>
<p>| 59 | 什么是 <code>@ResponseEntity</code>？为什么以及何时使用它？ |</p>
<p>| 60 | 如何在 Spring Boot 中进行验证？（<code>@Valid</code> 与 <code>@Validated</code>） |</p>
<p>| 61 | <code>application-dev.yml</code>、<code>application-prod.yml</code> 是什么？Spring 如何选取它们？ |</p>
<p>| 62 | 什么是 Spring Boot 优雅关机？如何启用？ |</p>
<p>| 63 | <code>@ConfigurationProperties</code> 和 <code>@Value</code> 的区别？ |</p>
<p>| 64 | Spring Boot 3 的主要变化有哪些？（Java 17, Jakarta EE 等） |</p>
<p>| 65 | <code>javax.*</code> 和 <code>jakarta.*</code> 包的区别？ |</p>
<p>| 66 | <code>@Component</code>、<code>@Service</code>、<code>@Repository</code>、<code>@Controller</code> 之间的确切区别？ |</p>
<p>| 67 | 为什么 <code>@Repository</code> 将受检查异常转换为非受检查异常？ |</p>
<p>| 68 | 什么是 <code>@Lazy</code> 注解？ |</p>
<p>| 69 | 构造器注入 vs 字段注入 vs Setter注入 —— Spring Boot 3 中推荐哪种？ |</p>
<p>| 70 | <code>application.yml</code> 和 <code>bootstrap.yml</code> 的区别？ |</p>
<p>| 71 | 如何保护 Spring Boot 应用程序？（至少 3 种方式） |</p>
<p>| 72 | 什么是 <code>spring-boot-starter-security</code>？ |</p>
<p>| 73 | Spring Boot 3 中的 <code>@EnableMethodSecurity</code> 是什么？ |</p>
<p>| 74 | 如何创建自定义自动配置？ |</p>
<p>| 75 | <code>spring.factories</code> / <code>spring-boot-autoconfigure-META-INF</code> 的作用是什么？ |</p>
<p>| 76 | Actuator + Micrometer + Prometheus + Grafana 是什么？ |</p>
<p>| 77 | 如何创建自定义健康指示器？ |</p>
<p>| 78 | <code>/actuator/health</code> 和 <code>/actuator/info</code> 的区别？ |</p>
<p>| 79 | 如何从命令行运行特定 profile？ |</p>
<p>| 80 | 什么是 <code>@ConditionalOnMissingBean</code>？举例说明？ |</p>
<p>| 81 | 你能在不使用任何 starter 的情况下运行 Spring Boot 吗？ |</p>
<p>| 82 | <code>SpringApplication.run()</code> 和 <code>new SpringApplication().run()</code> 的区别？ |</p>
<p>| 83 | 如何禁用 Spring Boot 横幅？（3 种方式） |</p>
<p>| 84 | <code>@EntityScan</code> 和 <code>@ComponentScan</code> 的区别？ |</p>
<p>| 85 | Spring Boot 如何支持响应式编程？（WebFlux 与 MVC） |</p>
<p>| 86 | 什么是 <code>@EnableAutoConfiguration</code>？ |</p>
<p>| 87 | 如何禁用特定的自动配置？ |</p>
<p>| 88 | 什么是 Spring Initializr？（start.spring.io） |</p>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fbhu_kalki%2Fspring-boot-interview-question-1chb" target="_blank" title="https://dev.to/bhu_kalki/spring-boot-interview-question-1chb" ref="nofollow noopener noreferrer">Spring Boot Interview Question - DEV Community</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别云盘限制！NanoPi R4S+iStoreOS 打造专属私有云，用了cpolar外网访问也能超丝滑]]></title>    <link>https://juejin.cn/post/7603261102795063322</link>    <guid>https://juejin.cn/post/7603261102795063322</guid>    <pubDate>2026-02-06T03:52:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603261102795063322" data-draft-id="7603216479837159475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别云盘限制！NanoPi R4S+iStoreOS 打造专属私有云，用了cpolar外网访问也能超丝滑"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T03:52:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别云盘限制！NanoPi R4S+iStoreOS 打造专属私有云，用了cpolar外网访问也能超丝滑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:52:48.000Z" title="Fri Feb 06 2026 03:52:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bcecdacfee546b18a5905d0cebcfb09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=RtU99xIAS1m0gWCJJC0EmTJEw1s%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>NanoPi R4S 搭配 iStoreOS 系统，核心功能是依托 WebDAV 协议实现跨设备文件共享与管理，还能兼顾软路由、智能家居控制等实用功能，适配有私人数据存储需求的家庭用户、远程办公人群，以及追求数据自主可控的普通使用者。它的优势很贴合日常使用场景：硬件体积小巧不占空间，低功耗设计长期运行也不费电，USB3.0 接口传输文件速度稳定，还能自主设置存储权限，比公共云盘更能保障数据隐私。</p>
<p>使用过程中也有一些实际的小体会：首次配置时建议先确认硬盘格式为 EXT4，避免识别异常；日常使用中如果同时开启路由和 NAS 功能，要注意网线连接方式，双网口模式下管理 IP 更固定，新手上手更省心；另外移动硬盘尽量选择稳定的品牌，避免供电不足导致文件传输中断。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18c8640713924dd7bd3288236895babb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=6oKMlzlYJBGPzKr3QzGMzgwXoCE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>不过仅靠局域网使用的话，实际体验会打不少折扣。比如出差在外想调取家里存储的工作合同、设计素材，或者回老家想查看自己存在设备里的家庭照片和视频，都因为不在同一网络而无法访问；甚至家人在不同房间用不同设备，想共享刚下载的纪录片，也得连同一局域网才行，日常使用的灵活性大大降低。</p>
<p>而将这套系统与 cpolar 结合后，就能彻底打破网络边界：无需申请公网 IP，也不用复杂的网络配置，就能让私有云服务实现外网访问。比如在公司用电脑、在咖啡厅用平板，都能随时访问家里的存储文件，异地备份重要数据也变得简单，哪怕是和异地的家人共享家庭影音资料，也能直接通过专属地址访问，实用性直接拉满。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81e06532760f4eb5a83953067a0323ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=OffF6iiqrzi0y%2Bz%2FwE7kQPNqgvg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>完整的保姆级教程。就在下面呦！</p>
<h2 data-id="heading-0">1 NanoPi R4S是什么？</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/621dcee17911448992842ba1db2d9d08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=3iKIKtMmaOxQmNyxl%2FDO3UsemWw%3D" alt="image-20250917134030895" loading="lazy"/></p>
<p><strong>NanoPi R4S</strong> 是由友善电子（FriendlyELEC）推出的一款高性能、低功耗的迷你开发板，专为软路由、物联网网关、NAS（网络附加存储）和智能家居等应用场景设计。</p>
<h3 data-id="heading-1">🔧 核心硬件规格</h3>
<ul>
<li><strong>处理器</strong>：Rockchip RK3399，6核架构（2×Cortex-A72 + 4×Cortex-A53），主频最高可达 2.0GHz。</li>
<li><strong>内存</strong>：1GB DDR3 或 4GB LPDDR4（取决于版本）。</li>
<li><strong>存储</strong>：支持 microSD 卡启动，不支持 eMMC。</li>
<li><strong>网络接口</strong>：2 个千兆以太网口（支持双千兆全速转发）。</li>
<li><strong>USB 接口</strong>：2 个 USB 3.0 接口。</li>
<li><strong>电源接口</strong>：USB Type-C 5V 电源输入。</li>
<li><strong>尺寸</strong>：约 66mm × 66mm，适合嵌入式或墙面安装。</li>
</ul>
<h3 data-id="heading-2">💡 应用场景</h3>
<p>NanoPi R4S 适用于多种场景，包括：</p>
<ul>
<li><strong>软路由</strong>：作为高性能的路由器，支持 OpenWrt 等系统，具备强大的网络处理能力。</li>
<li><strong>物联网网关</strong>：作为物联网设备的中枢，连接和管理多个设备。</li>
<li><strong>NAS（网络附加存储）</strong>：通过 USB 接口连接硬盘，提供网络存储服务。</li>
<li><strong>智能家居中心</strong>：作为智能家居设备的控制中心，管理和调度各类设备。</li>
</ul>
<h2 data-id="heading-3">2 准备阶段</h2>
<p>本教程需要用到如下材料：</p>
<ol>
<li><strong>NanoPi R4S设备</strong> *1（本教程演示的为4G版本）</li>
<li><strong>电源</strong> *1（5V3A电源，r4s的电源是c口的，需要Type-C的数据线）</li>
<li><strong>USB读卡器</strong> *1（插入SD卡用）</li>
<li><strong>TF卡/SD卡</strong> *1</li>
<li><strong>网线</strong> *2（建议2根，1根的话就需转单网口模式）</li>
<li><strong>移动硬盘</strong> *1（固态硬盘/机械硬盘都可以  <strong>容量&gt;=20G，格式为：EXT4</strong>）</li>
<li><strong>本教程可能需要用到的资源文件</strong>（iStoreOS系统固件，balenaEtcher烧录工具，局域网IP扫描工具，RaiDrive.Mount挂载软件）</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ad3f8a0c0c4a50ae107fc35cafd8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=%2BxvYzrTMYTnlzyEPJQs0eL8B59I%3D" alt="image-20250917181053867" loading="lazy"/></p>
<p><strong>123云盘永久链接：</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">提取码1314</span>
https://www.123865.com/s/3jOKVv-apNzH?pwd=1314#
</code></pre>
<h2 data-id="heading-4">3 烧录iStoreOS镜像至SD卡</h2>
<p>在电脑上安装链接中的<code>balenaEtcher-Setup-1.18.11.exe</code>应用程序，打开后直接将<code>istoreos-24.10.2-2025090517-r4s-squashfs.img.gz</code>镜像拖入到<code>balenaEtcher</code>的从文件烧录位置，会自动导入：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d8601f082246989efee4cbba8b8b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=IZQ51cJkkijOSeq%2BT%2FNDDq2HllY%3D" alt="image-20250917143751594" loading="lazy"/></p>
<p>然后将<code>USB读卡器（读卡器插入SD卡）</code>插入到电脑的<code>USB口</code>，接着<code>目标磁盘</code>选择SD卡设备（不要选错了，别把电脑上的磁盘给选上了）：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0dd32202e2b404185b2c618e3ee23cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=twgY1e9AUUG0QgNBVjD8qtNhH1Y%3D" alt="image-20250917143942841" loading="lazy"/></p>
<p>选定后，点击<code>现在烧录</code>，期间弹出的一些错误提示不用理会，属于正常现象，如：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70d2693b35914c62aad9d36c163d97ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=o0W4fvUkPRdC6w%2FwvFcqL08aYM8%3D" alt="image-20250917144150188" loading="lazy"/></p>
<p>等待烧录和验证，提示烧录成功即可拔出U盘：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6554952409c845bb947efcf83a23d951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=zA5RbbcdCpuKs7rUq3zH%2Bn9POps%3D" alt="image-20250917144116621" loading="lazy"/></p>
<h2 data-id="heading-5">4 启动iStoreOS系统</h2>
<p>由于<code>R4S</code>有双网口，一个<code>WAN口</code>和一个<code>LAN口</code>，根据不同的连接方式会产生不同的IP地址情况。如果采用<strong>双网口模式</strong>（WAN口接入上游路由器/光猫，LAN口连接下游设备），R4S会作为路由器工作并执行NAT转换，创建新的网段（默认为192.168.100.x），此时R4S的管理IP为<strong>192.168.100.1</strong>；如果采用<strong>单网口模式</strong>（仅LAN口连接到上游路由器的LAN口），R4S与上游路由器处于同一局域网内，共享相同网段（如192.168.50.x），无NAT转换，需要通过路由器管理页面或IP扫描工具来确定R4S的具体IP地址。建议初次配置时使用双网口模式，便于直接通过192.168.100.1访问管理界面。</p>
<p>本部分将以<code>双网口模式</code>进行演示，<code>单网口模式</code>请将网线插入<code>R4S</code>的<code>LAN口</code>，另一头插入路由器的<code>LAN口</code>，形成同一局域网，然后使用<code>资源分享链接</code>中的<code>局域网IP扫描工具</code>来进行扫描获取<code>R4S的IP地址</code>。</p>
<p>在前面的步骤，已经将<code>iStoreOS系统</code>烧录至<code>SD卡</code>中了，接下来将<code>SD卡</code>插入至<code>R4S</code>中：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f666a75e712f432ea38f20cadd60ba25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=2Zb1zbxjL45sC2JVYGH3KGC57Hc%3D" alt="image-20250917154623613" loading="lazy"/></p>
<p>然后插将<code>网线1</code>和<code>网线2</code>两根网线分别插入<code>R4S</code>的<code>WAN口</code>和<code>LAN口</code>，另一头分别插入路由器的<code>LAN口（或光猫LAN/WAN口）</code>和电脑的<code>网口</code>,参考图如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5df8e797791481082c3dfcbcfa3b49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=mbhaGMrYXUfwlm9eAZj%2F6pbBrQ8%3D" alt="image-20250917155512215" loading="lazy"/></p>
<p>当前教程中连接示意图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa7e03f959524b9e9bc7e5e94157979c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=B%2Fmwn7I7hA0WxeDfkQp%2BUdHvVWw%3D" alt="image-20250917161123045" loading="lazy"/></p>
<p>等待<code>2~3</code>分钟，可以看到<code>R4S</code>的指示灯全部点亮(单网口模式WAN口不会亮，因为没有接网线)，表示系统启动完成：</p>
<ul>
<li><strong>PWR（电源灯）</strong>: 红色常亮，表示设备正常供电</li>
<li><strong>SYS（系统灯）</strong>: 绿色闪烁后常亮，表示系统启动完成</li>
<li><strong>WAN（WAN口灯）</strong>: 绿色常亮，表示WAN口网络连接正常</li>
<li><strong>LAN（LAN口灯）</strong>: 绿色常亮，表示LAN口网络连接正常</li>
</ul>
<p>参考如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd836741c64e4844b2ee4b0ab70a1419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=LfK3%2F8Camc2LDHWQCAb42FCr5d0%3D" alt="e56a7e7c87c575a227da8f7394a8846e" loading="lazy"/></p>
<p>为了确认IP是否为<strong>192.168.100.1</strong>，可以在<code>cmd</code>中输入如下命令，然后查看<code>以太网适配器</code>的IPV4是否为100网段：</p>
<pre><code class="hljs language-shell" lang="shell">ipconfig
</code></pre>
<p>如下图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/367f5078c798452c88a89baa127ef9d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=dH66L4z0YomJp6P4WUwZpLj8I7k%3D" alt="image-20250917161859495" loading="lazy"/></p>
<p>可以看到，当前电脑的IP显示为<code>192.168.100.137</code>,网关显示为<code>192.168.100.1</code>,接着，我们直接访问浏览器测试:</p>
<pre><code class="hljs language-shell" lang="shell">http://192.168.100.1
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cfd83b970c5488aa9af01fb3d0a2a1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=O8NysQzynYdFSPpmsXVKqG%2Fwa0I%3D" alt="image-20250917162038653" loading="lazy"/></p>
<p>成功跳转访问到了<code>iStoreOS系统</code>的登录界面啦！</p>
<h2 data-id="heading-6">5.iStoreOS系统中配置WebDAV</h2>
<p>在前面步骤已经成功烧录好镜像且成功访问到<code>iStoreOS系统</code>,接下来需要进行配置<code>WebDAV</code>以用来进行挂载。**WebDAV（Web Distributed Authoring and Versioning）**是一种基于HTTP协议的文件传输协议，配置完成后，你可以在任何地方通过网络访问家中的文件，就像使用网盘一样。比如在公司需要查看家里电脑上的照片、在出差时访问重要文档、或者在朋友家里下载自己的音乐收藏，都可以通过WebDAV轻松实现，而且数据完全掌握在自己手中，无需担心隐私泄露或存储空间限制。</p>
<p>首先，在登录界面直接点击<code>登录</code>按钮进入主页（首次访问默认没有密码），进入主页后按顶部提示进行设置一个管理员密码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51158250bd3d4c29b9db5b8340421d90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=%2BzD%2FqMRAaQRQpXsJsvOwUrUCfio%3D" alt="image-20250917164235876" loading="lazy"/></p>
<p>进入到密码设置页面后，设置好密码点击<code>保存</code>按钮：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f64b854825e84849856feb6188ef6937~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=YBfZvH27vOg8ttfCz2CxxfSSDK8%3D" alt="image-20250917164506164" loading="lazy"/></p>
<p>接下来，回到首页，点击<code>存储服务</code>下的<code>快速配置</code>按钮：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1289fe75d45429aae5cd17ca2ee790c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=UmCawnUmYw0NeLhc1LD5MuB6Azk%3D" alt="image-20250917164840820" loading="lazy"/></p>
<p>然后在弹出的页面选择<code>局域网文件共享（WebDAV）</code>，接着点击<code>下一步</code>会提示：<strong>检测到你尚未安装 GoWebdav 插件,是否安装？</strong>,点击<code>确定</code>按钮即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f8bfc12d6ae4a6d9a3b3b064a66e113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=Stnr0PbElh7z2Xav4O9REPaD5MA%3D" alt="image-20250917165049027" loading="lazy"/></p>
<p>接着，插入一个<code>移动硬盘</code>，插入到<code>R4S</code>的另一边<code>USB接口（两个中任意一个口都可以）</code>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ad98ef328a74ddd991cf7803a426ac0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=WxpEErZqEE%2F%2BrO27c21uTGDp3FU%3D" alt="7f9e257b19ab58ef4c6aa836b3fb2c41" loading="lazy"/></p>
<p>然后在选择硬盘页面选择插入的<code>移动硬盘(没有的话，也可以直接选择默认的SD卡)</code>:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/324e24c3092a4b77abbe36e1c7d17315~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=joQNDmAc8cSFLc2%2BPwy8XHYeBrI%3D" alt="image-20250917170526921" loading="lazy"/></p>
<p>接着来到硬盘配置页面，格式化选项按需选择即可，可以选择不进行格式化。这里选择格式化该硬盘（如有资料，建议先备份好资料）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e549ba7934e4c93aefdcbb5c3a9f99f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=jARBJr%2BDzj4gItiWGuIi%2Fj7II%2FU%3D" alt="image-20250917170722279" loading="lazy"/></p>
<p>然后到共享配置页面，设置一个用户名和密码，点击创建按钮：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b09131c463624e2aa1d3fceb6a8467cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=ETovnqVmJ3qO7ZrSpfbB1pOkcms%3D" alt="image-20250917170907695" loading="lazy"/></p>
<p>创建完成后，在首页的<code>存储服务</code>下的<code>WEBDAV</code>栏可以看到如下信息：</p>
<ul>
<li><strong>挂载路径</strong>：<code>/mnt/usb6-3</code></li>
<li>服务路径：<code>http://192.168.100.1:6086</code></li>
<li><strong>账号</strong>：<code>user</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e1d32645cdc4a1c80ca3b0e1f6128aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=wXSgUnxkAH2dNUN4xzbcMM5%2BvPE%3D" alt="image-20250917171050926" loading="lazy"/></p>
<p>到这里，WEBDAV就配置好啦，浏览器访问一下服务路径测试一下：</p>
<pre><code class="hljs language-shell" lang="shell">http://192.168.100.1:6086
</code></pre>
<p>访问如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/020bcb10fafa48bfb7cbb8d5930d1b1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=nsPBV9DOaJ8tvYtM8QRvbNj8X5U%3D" alt="image-20250917174453751" loading="lazy"/></p>
<p>可以看到需要输入刚才设置的用户名和密码，输入一下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba9a85977e1f45b5b8f4c4fcca645cd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=9BMwWlcgXFKoOUXSOolFu79QoJI%3D" alt="image-20250917174601342" loading="lazy"/></p>
<p>可以看到成功进来了，如果没有进行格式化，应该能看到自己的一些目录和文件！这里上传了一个视频，让我们演示播放看看：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d85f373a5194a1c84e0c2b5d77a0509~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=l95g2NiuoMyoB2SsJIkKX9qtEmc%3D" alt="image-20250917175012886" loading="lazy"/></p>
<p>可以发现，成功的访问且播放了视频！至此，WebDAV服务已经在局域网内配置成功，你现在拥有了一个在家庭网络内的私人存储服务。在同一局域网下，你可以通过任何设备（手机、电脑、平板等）轻松访问和管理R4S上的文件数据，为后续实现外网访问打下了坚实的基础。</p>
<h2 data-id="heading-7">6.在Windows上挂载WebDAV</h2>
<p>为了更方便地使用WebDAV服务，我们可以将其挂载为Windows系统的网络驱动器，这样就能像访问本地硬盘一样直接在文件资源管理器中操作文件。RaiDrive是一款免费的网络驱动器挂载工具，支持WebDAV、FTP、SFTP等多种协议，操作简单且稳定性好。</p>
<p>首先，需要安装<code>RaiDrive</code>，可以从前面提供的资源分享链接中的windows版本应用程序（适用于win10/win11）下载安装：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b06daf58002f49e08a93622e23b09a74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=pskQV4j19Kk6SuOnKN%2F0JgTqLWM%3D" alt="image-20250917182105838" loading="lazy"/></p>
<p>或者前往官网进行下载：</p>
<pre><code class="hljs language-shell" lang="shell">https://www.raidrive.com/download
</code></pre>
<p>下载下来后安装好，打开程序后，提示需要进行登录，点击<code>Sign In</code>进行登录：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e964f59dc764068982f4598c623000e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=wI8RaCZ8aM41QbsF31WgzYHYbws%3D" alt="image-20250917182554310" loading="lazy"/></p>
<p>登录完成后，顶部导航栏浅灰色的<code>Add</code>按钮会变为白色，点击<code>Add</code>按钮，然后进行如下图操作：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7404b43781204e49a3e810515af62689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=xI2PJNAsCJyTzJXqJTnv9EwgzLs%3D" alt="image-20250917183655099" loading="lazy"/></p>
<p>点击连接后，可以看到在资源管理器中，多出了一个网络位置的磁盘：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b1c84f190b3432e8b46502e1f13dc4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=LmRp2RTOSKbJrIwThZWueL9dvE4%3D" alt="image-20250917184005229" loading="lazy"/></p>
<p>如果显示大小不对，可以先<code>停止连接</code>，然后再点击<code>设置</code>按钮：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d818e9a5e5184c9dbb313bf5343f480c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=Co%2BMpo0PGSQIvINOKnBATU50nF8%3D" alt="image-20250917184124461" loading="lazy"/></p>
<p>在高级选项里面配置一下硬盘真正的大小，然后重新连接即可：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd15260536584184b866faf73d3d87d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=ZTZxuLZKFvtkj8ods5Ee8uk26P0%3D" alt="image-20250917184209034" loading="lazy"/></p>
<p>让我们播放一下视频测试一下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f8831f6ac5f4546889c0974519d98d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=8SmuiEdjKXEvnySl5Ud%2FZZUvJGw%3D" alt="image-20250917184430694" loading="lazy"/></p>
<p>可以看到，成功的访问了局域网配置WebDAV的硬盘中视频，且调用了电脑上的播放器进行播放！至此，RaiDrive挂载功能已经完全配置成功，你现在可以像使用本地硬盘一样在Windows资源管理器中直接操作远程文件，无需频繁的上传下载操作。但目前这种访问方式仅限于局域网内，接下来我们将通过cpolar内网穿透服务，让你在世界任何地方都能访问家中的数据。</p>
<h2 data-id="heading-8">7 配置cpolar内网穿透实现外网访问</h2>
<p>通过前文的步骤，我们已经在本地局域网成功部署了WebDAV服务。虽然可以正常访问，但细心的你可能已经发现：<strong>浏览器地址栏中显示的IP是<code>192.168.x.x</code>这样的局域网地址</strong>。</p>
<p>这意味着：</p>
<ul>
<li>外出办公时无法获取家中存储的工作资料</li>
<li>度假期间想要备份手机照片到家中存储设备时无法连接</li>
<li>无法将家中的文件直接分享给远程的朋友或同事</li>
</ul>
<p><strong>如何打破这层"局域网枷锁"，让部署在NanoPi R4S上的WebDAV服务随时随地可访问？</strong></p>
<p>本节将使用<strong>cpolar内网穿透</strong>，一款安全易用的国产工具，无需公网IP，只需简单配置，就能为你的本地服务创建一条安全的隧道，生成一个专属的公共网址。让你在任何有网络的地方，都能顺畅访问家中R4S上的WebDAV文件服务。</p>
<h3 data-id="heading-9">7.1 iStoreOS系统中安装cpolar服务</h3>
<p>首先，点击首页的终端按钮：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e2c3f38aded462093659741cb4ebf98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=tyHSHfIhfhiWo%2FRdgwDiQjVNYjY%3D" alt="image-20250822191618779" loading="lazy"/></p>
<p>点击后会跳转新的页面，新的iStoreOS终端页面登录进系统：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f251e7c32d04d3aa6077cbc1e127773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=tY5stikLhZHV3tIquE2CM0Mo%2BAA%3D" alt="image-20250918095938766" loading="lazy"/></p>
<p>然后执行如下命令，下载公钥：</p>
<pre><code class="hljs language-shell" lang="shell">wget -O cpolar-public.key http://openwrt.cpolar.com/releases/public.key
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecb5b32215f243f29993dba95b2eecb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=FGQCZmtAXABRMfgVkTVvWlTuZcQ%3D" alt="image-20250918100000390" loading="lazy"/></p>
<p>下载完成以后，添加该公钥，以及添加cpolar的opkg仓库源：</p>
<pre><code class="hljs language-shell" lang="shell">opkg-key add cpolar-public.key

echo "src/gz cpolar_packages http://openwrt.cpolar.com/releases/packages/$(. /etc/openwrt_release ; echo $DISTRIB_ARCH)" &gt;&gt; /etc/opkg/customfeeds.conf
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02cea7d3128e4dce81d841a51d08637f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=RVTJGsD00g%2FtZ765oWTIr5kNHSQ%3D" alt="image-20250822193822744" loading="lazy"/></p>
<p>接下来，更新仓库:</p>
<pre><code class="hljs language-shell" lang="shell">opkg update
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9218ed1a3ef04946b03c84ad1b629333~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=0igP6F9RBHpmKA2zEUFh%2FlBtDFY%3D" alt="image-20250918100107298" loading="lazy"/></p>
<p>然后安装cpolar内网穿透工具，执行如下3条命令：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">安装 cpolar 主程序，这是核心二进制文件，可以运行隧道服务。</span>
opkg install cpolar
<span class="hljs-meta prompt_">#</span><span class="bash">安装 LuCI 的前端管理界面插件，也就是在 iStoreOS 的 Web 界面（LuCI）里能看到图形化的 Cpolar 配置。</span>
opkg install luci-app-cpolar
<span class="hljs-meta prompt_">#</span><span class="bash">安装 LuCI 的中文语言包，让 Web 界面显示中文。</span>
opkg install luci-i18n-cpolar-zh-cn
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bc377afb70f4200a9b7e6f869d01309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=pMzIEl0P9%2FAQ16b2ymbTI4whWQc%3D" alt="image-20250918100159524" loading="lazy"/></p>
<p>执行完成后，直接刷新iStoreOS首页，然后点击服务，展开即可看到Cpolar菜单：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9e22b4ec804c0490a39714c6ce66b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=hK5IPEpqLNmIdT%2FWL57xnQTiTzY%3D" alt="image-20250918100904662" loading="lazy"/></p>
<h3 data-id="heading-10">7.2 配置WebDAV的http隧道</h3>
<p>点击<code>打开Web-UI管理界面</code>按钮，即可跳转至web ui的后台管理界面，如果还没有账号，也可以直接在该页面跳转注册页面注册账号：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e262de968bbf472c86e8964393cb27e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=8pZ4qkKFCb2uqlliO9TCN2rdbAM%3D" alt="image-20250918101021629" loading="lazy"/></p>
<p>注册好账号以后，回到该页面进行登录即可，登录成功后，进入侧边的【隧道管理&gt;隧道列表】，可以看到有2条隧道：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eac5faea4464692a8a5caec8d5ca3c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=UvR4Rm0rY7%2FctrVfjkUCPJL%2FiII%3D" alt="image-20250918101111162" loading="lazy"/></p>
<p>选择【website】这条隧道，点击编辑进行修改（也可以创建新的隧道）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/757cfb272c694b43a5f073817130b640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=QIADCz%2FNINYOYY0lH5d97kVwQs8%3D" alt="image-20250918101351042" loading="lazy"/></p>
<p>接着点击【状态】&gt;【在线隧道里列表】，可以看到有2条隧道，一条为http的协议，另一条为https的协议：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68358af935fb4e029a10c70189e58881~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=OOKVPHloLYw4eqfpE8eM%2B6jxuJA%3D" alt="image-20250918101527952" loading="lazy"/></p>
<p>这里以https为例：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b60c87cc9cdc4bd094db5a86b9ff0a02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=vW6ZPbJTrqvrk8gKXAVLjNFLDQg%3D" alt="image-20250918101600835" loading="lazy"/></p>
<p>访问成功！</p>
<h3 data-id="heading-11">7.3 固定二级子域名（升级任意套餐）</h3>
<p>由于前面设置的为随机域名，随机域名的数据隧道处于临时状态（每24小时重置一次），大多用于测试场景。作为WebDav这种类型的服务，更适合长期访问，所以这里进行设置一个固定二级子域名，使其长期不变，方便记忆的域名。</p>
<p>首先，进入官网的预留页面：</p>
<pre><code class="hljs language-shell" lang="shell">https://dashboard.cpolar.com/reserved
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4419572449447d5be123ff3a3c6ba5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=QuMXFNp8KOeAEx27piYTedmbcy8%3D" alt="image-20250918102539005" loading="lazy"/></p>
<p>列表中显示了一条已保留的二级子域名记录：</p>
<ul>
<li>地区：显示为<code>China Top</code>。</li>
<li>二级域名：显示为<code>dav01</code>。</li>
</ul>

<pre><code class="hljs">注：二级域名是唯一的，每个账号都不相同，请以自己设置的二级域名保留的为主
</code></pre>
<p>接下来，进入侧边菜单栏的<code>隧道管理</code>下的<code>隧道列表</code>，可以看到名为<code>WebDAV-6086</code>的隧道</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1078cf8bd0446ca6d0dd952509a457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=%2Bj6c5eFcKyMWDWLbu3cGRyyNCbE%3D" alt="image-20250918102307459" loading="lazy"/></p>
<p>点击<code>编辑</code>按钮进入编辑页面，修改域名类型为<code>二级子域名</code>，然后填写前面配置好的子域名，点击更新按钮：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6ca0a3fa4864d8daa6e585e245e5355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=1OhSkFRjruJist7gIFjG1mB%2B6FI%3D" alt="image-20250918102444306" loading="lazy"/></p>
<p>来到<code>状态</code>菜单下的<code>在线隧道列表</code>可以看到隧道名称为<code>WebDAV-6086</code>的公网地址已经变更为<code>二级子域名+固定域名主体及后缀</code>的形式了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ab4e523948f43d5bc83e1940be7bf19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=UU4yAYA6Tr3MhV8eNHXgMhZBJow%3D" alt="image-20250918102521091" loading="lazy"/></p>
<p>这里以https协议做访问测试:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49577b1dbde4a2cb73f82989f4c049d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=HP3ycjDagLeagqMMxBITLB6zByw%3D" alt="image-20250918102619779" loading="lazy"/></p>
<p>访问成功！这样，一个固定不变的域名就设置完成啦！</p>
<h3 data-id="heading-12">7.4 配置RaiDrive挂载穿透后的地址</h3>
<p>回到<code>RaiDrive Mount</code>应用程序中，点击<code>Add</code>添加一个，操作如下图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e46132632a0491991b5c21d24c1eb72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=L4SXrqzLtPGTPcvNEDA0ersFzvY%3D" alt="image-20250918103413097" loading="lazy"/></p>
<p>点击连接后，可以在资源管理器中看到新增的网络磁盘，现在即使离开家庭网络环境，也能通过这个公网地址正常访问WebDAV服务了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6884d97c5d44538b43ef0cf66423b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770954767&amp;x-signature=CWf5WlFowbjDfx2HM%2FTya2Dqlus%3D" alt="image-20250918103925393" loading="lazy"/></p>
<p>至此，我们已经成功完成了NanoPi R4S刷入iStoreOS系统并配置WebDAV外网挂载的全部步骤。通过这套方案，你现在拥有了一个完全属于自己的私人云存储系统。</p>
<h2 data-id="heading-13">总结</h2>
<p>NanoPi R4S+iStoreOS 的组合本就为私人数据管理提供了稳定、自主的基础，而 cpolar 的加入则弥补了局域网使用的局限性，让私有云真正实现了 “随时随地可用”。这套方案没有复杂的操作门槛，也无需依赖第三方云服务，无论是日常存储家庭照片、工作文档，还是管理智能家居设备，都能在保障数据安全的前提下，满足跨场景、跨地域的使用需求，真正让普通用户也能轻松拥有属于自己的、实用又便捷的私有云系统。</p>
<p>感谢您阅读本篇文章，有任何问题欢迎留言交流。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2F" target="_blank" title="https://www.cpolar.com/" ref="nofollow noopener noreferrer">cpolar官网-安全的内网穿透工具 | 无需公网ip | 远程访问 | 搭建网站</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一段JavaScript代码是如何运行的？]]></title>    <link>https://juejin.cn/post/7603201727715917876</link>    <guid>https://juejin.cn/post/7603201727715917876</guid>    <pubDate>2026-02-06T02:04:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603201727715917876" data-draft-id="7602488966609928230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一段JavaScript代码是如何运行的？"/> <meta itemprop="keywords" content="JavaScript,前端,Node.js"/> <meta itemprop="datePublished" content="2026-02-06T02:04:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="libokaifa"/> <meta itemprop="url" content="https://juejin.cn/user/676954894018808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一段JavaScript代码是如何运行的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/676954894018808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    libokaifa
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:04:20.000Z" title="Fri Feb 06 2026 02:04:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>众所周知JavaScript 是解释型语言，解释型语言都有编译器，通过谷歌浏览器的编译器是V8引擎 生成字节码并被计算机认识并执行。</p>
</blockquote>
<blockquote>
<p>V8引擎主要运行代码行为是： 源代码(.js 文件)--&gt;词法分析(解析器（parser)--&gt;AST(语法分析)--&gt;字节码（Ignition 生成）-》执行（）</p>
</blockquote>
<h2 data-id="heading-0">词法分析</h2>
<pre><code class="hljs language-ini" lang="ini">// 我是注释
var <span class="hljs-attr">answer</span> = <span class="hljs-number">6</span> * <span class="hljs-number">7</span><span class="hljs-comment">;</span>
</code></pre>
<p>像上面一段代码</p>
<p>会被V8引擎去除无用的的注释等通过解析器（parser）分解为最小的词法单元token(<a href="https://link.juejin.cn?target=https%3A%2F%2Fesprima.org%2Fdemo%2Fparse.html%23" target="_blank" title="https://esprima.org/demo/parse.html#" ref="nofollow noopener noreferrer">parser</a>)，
使用正则表达式，匹配出最小单元的Token，让V8更快的扫描并进行解析</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d99c847362a546d29e6163c26ed08bb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGlib2thaWZh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770948262&amp;x-signature=BqrSgY69sJYiGvxVfT9y9AZMZ7U%3D" alt="image.png" loading="lazy"/>
这段代码被拆解为：token 数组，并标识了type类型和value</p>
<h2 data-id="heading-1">语法分析AST</h2>
<p>众所周知 是静态语音，类似VsCode 编辑器虽然也会对代码编写时的语法的静态检查，但是是非常轻量级，并且不涉及到编译的过程，所以在词法分析的下一步进行编译阶段的语法分析AST以保证代码语法结构的正确性，同时为后续的语义分析等提供结构性的数据。下面是一段代码AST 结构图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae24281cd8044026b7fea10ef979ac4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGlib2thaWZh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770948262&amp;x-signature=L8LsB4p75a07akfb1hbkv6m6Etc%3D" alt="image.png" loading="lazy"/>
上图是根据上一步的词法分析Token数组生产的Json树状结构树，其主要包含的信息有：<code>"VariableDeclaration"</code>（变量声明）<code>"BinaryExpression"</code>（计算的二元表达式）,<code>"name"</code>(标识符的名称),<code>"value"</code>(字面量的值)，<code>"operato"</code>(表达式的操作符)等。在这一阶段如果发生错误代码加载会在这步停止并抛出异常如：<code> 输出: Unexpected token at line 1, column 5</code></p>
<h2 data-id="heading-2">生成字节码</h2>
<p>JS 字节码 的生成是由V8（Ignition 解释器完成），熟悉Java 的都知道，Java的字节码 经过AOT存在.class文件中，但JavaScript 为了快速执行把字节码存在了内存中，然后经过JIT 生成机器码。到这里我们发现为什么大部分语言都是先是生成字节码再生成机器码呢。其实早期V8 引擎也是直接生成机器码，用空间换时间，执行效率高，但同时也带来另一个问题，当内存不足时，就会造成失败和卡顿。有了字节码以后做了中间流程后,引擎可以检测热点（hot code）代码，由TurboFan 编译器再生成机器码，提升运行时效率，非热点代码的字节码可以立即执行，并且生成字节码的速度远大于生产机器码的速度，这样的一顿操作后V8就可以平衡代码运行时的时间和空间的复杂度。
下面是模拟字节码和机器码运行的测试代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 计算密集型函数（模拟热点）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">computeIntensive</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> result = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000000</span>; i++) {  <span class="hljs-comment">// 增加循环次数以放大差距</span>
    result += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(i) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(i);
  }
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 冷启动测试：第一次执行（主要使用字节码）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Cold Start (Bytecode)'</span>);
<span class="hljs-title function_">computeIntensive</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Cold Start (Bytecode)'</span>);

<span class="hljs-comment">// 热启动测试：多次执行后（触发 JIT，机器码优化）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Hot Start (Machine Code)'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-title function_">computeIntensive</span>();  <span class="hljs-comment">// 重复执行，V8 会优化成机器码</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Hot Start (Machine Code)'</span>);
</code></pre>
<p>在终端运行：<code>node --trace-opt  test.js</code>(<strong>Node.js</strong>：是一个基于 V8 JavaScript 引擎的运行时环境),执行结果如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c75243a0251451f885b0abe5fcdcd7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGlib2thaWZh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770948262&amp;x-signature=t3rCcKROxtGDQJnhRe0aoc4wJe8%3D" alt="image.png" loading="lazy"/>
冷启动的时候执行了，耗时：1.486s ,但代码立即执行了一次。
Hot Code热启动 耗时：14.955s，但执行了100,000,000次，可以看出V8 通过分层执行字节码和机器码以保证代码执行的效率；</p>
<h2 data-id="heading-3">执行</h2>
<p>生成后的机器码和字节码全部存在内存里，当一个执行命令执行到一个函数后，V8 runtime 会检测是调取机器码还是字节码，并把地址信息给到Cpu，来执行该地址的指令</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[刚刚，Claude Opus 4.6 和 GPT-5.3-Codex 同时炸场！AI 编程要变天了]]></title>    <link>https://juejin.cn/post/7603263490341945353</link>    <guid>https://juejin.cn/post/7603263490341945353</guid>    <pubDate>2026-02-06T02:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490341945353" data-draft-id="7603263490341814281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="刚刚，Claude Opus 4.6 和 GPT-5.3-Codex 同时炸场！AI 编程要变天了"/> <meta itemprop="keywords" content="AI编程,程序员,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T02:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            刚刚，Claude Opus 4.6 和 GPT-5.3-Codex 同时炸场！AI 编程要变天了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:39:54.000Z" title="Fri Feb 06 2026 02:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>今天凌晨，AI 圈又双叒炸了。Anthropic 和 OpenAI 几乎同时发布了自家的最新大模型 —— Claude Opus 4.6 和 GPT-5.3-Codex，中门对狙，火药味十足。</p>
<p><img src="https://pic.yupi.icu/1/image-20260206092008146.png" alt="" loading="lazy"/></p>
<p>这次两家是真往编程和实际工作能力上卷了，不是那种 “跑分升了 2 个点” 就发篇博客的敷衍更新。</p>
<p>下面我带大家快速了解一下，这两个模型到底更新了什么？对我们程序员和 AI 玩家来说有什么用？</p>
<h2 data-id="heading-0">Claude Opus 4.6：更聪明、更能干、更持久</h2>
<p>先说 Anthropic 这边。Claude Opus 4.6 是目前 Claude 家族最强的模型，之前用 Claude Opus 4.5 编程就已经让我感觉 “AI 写代码无所不能” 了，而这次的 Opus 4.6 在多项评估中均处于最先进水平，包括智能编码、多学科推理、知识工作和智能搜索等。</p>
<p>光看这个跑分我就贼激动了！</p>
<p><img src="https://pic.yupi.icu/1/1770339059467-24cdc13f-957e-4ff8-bee2-7b8625d0c4a6.png" alt="" loading="lazy"/></p>
<p>实际上手后，我最直观的感受就是：<strong>干活更靠谱了</strong>。</p>
<p>具体更新了这些：</p>
<p>1）编程能力大幅提升：Opus 4.6 能更好地在大型代码库中工作，调试和代码审查能力增强，写完代码还能自己检查错误。</p>
<p>我实测了一波，让之前的 Opus 4.5 和新出的 Opus 4.6 同时开发一个「聚合搜索引擎」项目：</p>
<pre><code class="hljs language-markdown" lang="markdown">请你帮我开发一个聚合搜索网站，包含完整的前端和后端，能够同时从多个不同的搜索引擎搜索和聚合结果。
应该先做 MVP 最小可行产品，整个过程不需要向我确认、不需要我提供 API Key，你必须确保功能正常可用。

</code></pre>
<p><img src="https://pic.yupi.icu/1/image-20260206095821042.png" alt="" loading="lazy"/></p>
<p>几分钟后，二者都完成了任务：</p>
<p><img src="https://pic.yupi.icu/1/image-20260206100013366.png" alt="" loading="lazy"/></p>
<p>但是对比一下实际搜索效果，Opus 4.5 完败，看到这我就放心了，以后我用 AI 编程估计 Bug 更少了~</p>
<p><img src="https://pic.yupi.icu/1/image-20260206100155670.png" alt="" loading="lazy"/></p>
<p>2）100 万 token 上下文窗口。Opus 系列第一次支持这么长的上下文，简单来说就是你可以一次性给它丢一大堆文件和代码，它都能记住并理解，不会像以前那样聊着聊着就失忆了。</p>
<p>这也是我最最最期待的特性，复杂的前后端项目也可以在同一对话框中一把梭了！不用来来回回总结上下文和新开对话框。</p>
<p>赣，准备嘎嘎烧 Tokens 了。</p>
<p>3）128k 输出 token。输出长度翻倍，意味着 Claude 可以一次性生成更长的代码和文档，不用再拆成好几次请求了。</p>
<p>4）自适应思考。以前开发者只能手选开启或关闭深度推理，现在 Claude 会自动判断这个问题需不需要深度思考。简单问题秒回，复杂问题慢慢想，智能调节，省时省钱。</p>
<p>5）上下文压缩。以前跑长任务的时候，AI 经常会撞到上下文长度的天花板。现在 Claude 能自动压缩和总结之前的对话内容，让长时间运行的任务不会中途翻车。搭配 100 万 token 上下文，不敢想象有多持久！</p>
<p>6）Claude Code 支持多智能体协作。你可以同时启动多个 AI Agent 并行工作，比如让几个 Agent 同时审查代码库的不同部分，效率直接翻倍。</p>
<p>7）Claude in Excel 大升级。现在能处理更复杂的长时间任务，支持数据透视表、图表修改、条件格式、数据验证等，还能一次性处理多步骤操作。</p>
<p><img src="https://pic.yupi.icu/1/6984ae18765ce9ada0768cfc_ClaudeExcel-Blog-Hero-Desktop.png" alt="" loading="lazy"/></p>
<p>8）Claude in PowerPoint 上线。能读取你已有的模板、字体和母版，保持品牌风格一致，然后直接帮你生成完整的 PPT。</p>
<p><img src="https://pic.yupi.icu/1/1770339189972-c3c8b2e7-234b-4089-8b69-d172b523d5d4.png" alt="" loading="lazy"/></p>
<p>大家对 Opus 4.6 也是一致好评，不少早期测试的公司都表示 “用了回不去”，Cursor 官方说 Opus 4.6 是他们内部长任务测试中的最强模型，Replit 说它的任务拆解和并行规划能力有了巨大飞跃。</p>
<h2 data-id="heading-1">GPT-5.3-Codex：OpenAI 的编程杀手锏</h2>
<p>再看 OpenAI 这边。这次发布的 GPT-5.3-Codex，剑指 <strong>最强编程 Agent</strong>，而且不只是写代码，还能像你的同事一样边干活边和你沟通。</p>
<p>相比 Claude 官方连发好几个帖子介绍自家新模型，OpenAI 官方这边则低调不少。Sam Altman 亲自在 X 上喊话：</p>
<p><img src="https://pic.yupi.icu/1/1770340355704-c9569d19-a5f5-4e46-98c4-b6b75dab01bc-20260206093449865.png" alt="" loading="lazy"/></p>
<p>来看看具体有什么：</p>
<p>1）编程跑分全面领先。SWE-Bench Pro 57% 和 TerminalBench 2.0 77%，编程相关基准都创了新高。尤其是 OSWorld（测试 AI 在真实桌面环境中完成任务的能力）直接从上一代的 38.2% 飙到 64.7%，这个提升幅度相当炸裂。</p>
<p><img src="https://pic.yupi.icu/1/image-20260206094035858.png" alt="" loading="lazy"/></p>
<p>2）速度更快、更省钱。完成同样的任务，token 消耗量不到上一代（5.2-Codex）的一半，而且每个 token 处理速度还快了 25%。又快又省，这才是实实在在的体验提升。</p>
<p>3）边干活边汇报。以前你丢一个任务给 AI，只能干等结果。现在 GPT-5.3-Codex 会在工作过程中实时告诉你它在做什么、做到哪了，你随时可以插嘴调整方向，就像真的在和一个同事协作一样。</p>
<p>4）超强的前端开发能力。官方直接展示了让它做赛车游戏和潜水游戏的效果，完整度高得离谱，有多个地图、道具系统和完整的游戏逻辑。</p>
<p><img src="https://pic.yupi.icu/1/image-20260206094133069.png" alt="" loading="lazy"/></p>
<p>生成普通网页时 AI 也更懂你的意图了，默认就能给你做出功能更丰富、设计更合理的页面。</p>
<p>5）电脑操作能力增强。不只是写代码，它还能像人一样操作电脑完成各种任务，比如做 PPT、分析数据、处理表格，把编程 Agent 的边界扩展到了全能打工 Agent。</p>
<p>6）自己训练自己。OpenAI 团队说 GPT-5.3-Codex 是第一个 <strong>参与了自身创造</strong> 的模型。团队用它的早期版本来调试训练过程、管理部署、分析测试结果。也就是说，AI 在加速 AI 自身的进化，以后的进化速度肯定会越来越快。</p>
<p>7）网络安全能力大幅增强。这是第一个被 OpenAI 归类为高能力网络安全模型的版本，能主动发现代码漏洞。OpenAI 同时承诺投入 1000 万美元 API 额度支持网络防御研究。</p>
<h2 data-id="heading-2">我的看法</h2>
<p>这次两家巨头同时发布新模型，互相贴脸开大，对我们用户来说是好事。可以看到，这两个模型都在往 <strong>实用方向</strong> 猛卷，是真的想让你日常工作中用得上。</p>
<p>这两个大模型应该如何选择呢？</p>
<p>简单对比一下：</p>
<ul>
<li>Claude Opus 4.6 是六边形战士，编程、办公、研究样样行，特别是在 Excel、PowerPoint 这些办公场景里做了很深的整合。</li>
<li>GPT-5.3-Codex 把编程能力拉满，在代码生成、任务执行和人机协作上打出了差异化优势。</li>
</ul>
<p>不过我估计网络和价格就已经劝退一大波国内用户了，如果你只是日常学习、或者做做工具类小项目，也不必盲目追求国外的大模型。很快 DeepSeek V4 等一系列国产大模型应该就要出来了，期待一波~</p>
<h2 data-id="heading-3">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a><br/>
📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a><br/>
✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a><br/>
📖 AI 学习指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">鱼皮 AI 导航</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 2.2.20 技术前瞻：WebAssembly 支持的深度解析与未来图景]]></title>    <link>https://juejin.cn/post/7603352061468246058</link>    <guid>https://juejin.cn/post/7603352061468246058</guid>    <pubDate>2026-02-05T16:54:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352061468246058" data-draft-id="7603352061468229674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 2.2.20 技术前瞻：WebAssembly 支持的深度解析与未来图景"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T16:54:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码哥_常"/> <meta itemprop="url" content="https://juejin.cn/user/705230023172650"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 2.2.20 技术前瞻：WebAssembly 支持的深度解析与未来图景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/705230023172650/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码哥_常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T16:54:20.000Z" title="Thu Feb 05 2026 16:54:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>注：本文为技术前瞻性分析。截至2024年中，Kotlin 官方最新稳定版为 1.9.20，Kotlin 2.0.0 尚未发布。所谓“2.2.20"系基于 Kotlin/Wasm 当前实验进展（Kotlin 1.8.20+）与 JetBrains 路线图的合理推演，旨在探讨 Kotlin 深度集成 WebAssembly 的技术路径与生态价值。实际功能请以 JetBrains 官方发布为准。</em></p>
<hr/>
<h2 data-id="heading-0">一、为何 Kotlin 需要 WebAssembly？—— 战略背景</h2>
<p>WebAssembly（Wasm）已从“浏览器补充技术”演进为跨平台运行时基石（WASI、Serverless、边缘计算）。对 Kotlin 而言：</p>
<ul>
<li><strong>突破 JavaScript 性能瓶颈</strong>：计算密集型场景（图像处理、游戏逻辑、科学计算）需接近原生的执行效率</li>
<li><strong>统一多平台战略</strong>：Kotlin Multiplatform（KMP）需覆盖 Web 端高性能场景，补全“Kotlin/JS（兼容性） + Kotlin/Wasm（性能）”双轨方案</li>
<li><strong>拥抱现代 Web 标准</strong>：Wasm GC Proposal（2023年底进入 Phase 4）为带 GC 语言（如 Kotlin）提供原生对象模型支持，消除 JS 互操作开销</li>
</ul>
<blockquote>
<p>💡 关键转折：Kotlin 1.8.20 首次引入实验性 <code>wasm</code> 目标；1.9.20 优化内存管理与 JS 互操作。本文假设在“2.2.20"中，Kotlin/Wasm 达到 <strong>Production-Ready</strong> 级别。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、核心技术深度解析（基于当前路线图推演）</h2>
<h3 data-id="heading-2">1. 编译器架构：从 IR 到 Wasm GC</h3>
<ul>
<li><strong>统一中间表示（IR）</strong>：Kotlin 编译器前端生成平台无关 IR，后端针对 Wasm GC 生成高效字节码</li>
<li><strong>Wasm GC 深度集成</strong>：
<ul>
<li>Kotlin 对象 → Wasm Struct/Array（非线性内存模拟）</li>
<li>协程状态机 → Wasm 引用类型（避免 JS 堆拷贝）</li>
<li>标准库精简：仅保留 <code>kotlin.wasm</code> 模块必要 API，体积较 Kotlin/JS 减少 40%+</li>
</ul>
</li>
<li><strong>双模式输出</strong>：
<ul>
<li><code>wasm32-unknown-wasi</code>：服务端/边缘计算场景</li>
<li><code>wasm32-unknown-emscripten</code>：浏览器环境（含 JS 胶水代码优化）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2. 内存与并发模型革新</h3>






























<table><thead><tr><th>特性</th><th>Kotlin/JS</th><th>Kotlin/Wasm（推演）</th></tr></thead><tbody><tr><td><strong>内存管理</strong></td><td>依赖 JS GC</td><td>直接使用 Wasm GC（与宿主隔离）</td></tr><tr><td><strong>协程调度</strong></td><td>基于 JS Promise</td><td>原生 Wasm 异步（<code>asyncify</code> 优化）</td></tr><tr><td><strong>线程支持</strong></td><td>无（单线程）</td><td>Wasm Threads Proposal（SharedArrayBuffer）</td></tr><tr><td><strong>启动延迟</strong></td><td>高（JS 解析）</td><td>低（二进制预编译）</td></tr></tbody></table>
<h3 data-id="heading-4">3. 无缝互操作设计</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 代码（编译为 Wasm 模块）</span>
<span class="hljs-meta">@WasmExport</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processImage</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">ByteArray</span>)</span></span>: ByteArray {
    <span class="hljs-comment">// 高性能图像处理（直接操作 Wasm 线性内存）</span>
    <span class="hljs-keyword">return</span> applyFilter(<span class="hljs-keyword">data</span>)
}

<span class="hljs-meta">@WasmImport(<span class="hljs-string">"env"</span>, <span class="hljs-string">"logMessage"</span>)</span>
<span class="hljs-keyword">external</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(msg: <span class="hljs-type">String</span>)</span></span>

<span class="hljs-comment">// JS 调用示例（浏览器）</span>
<span class="hljs-keyword">const</span> module = await WebAssembly.instantiateStreaming(fetch(<span class="hljs-string">'app.wasm'</span>));
module.exports.processImage(imageBuffer); <span class="hljs-comment">// 零拷贝传递 ArrayBuffer</span>
</code></pre>
<ul>
<li><strong>智能胶水层</strong>：编译器自动生成最小化 JS 胶水代码（较 Emscripten 减少 70%）</li>
<li><strong>类型安全桥接</strong>：Kotlin <code>String</code> ↔ Wasm UTF-8 编码，集合类型自动转换</li>
<li><strong>异常传递</strong>：Kotlin 异常 → Wasm Exception Handling Proposal（避免 fatal abort）</li>
</ul>
<h3 data-id="heading-5">4. 工具链与开发者体验</h3>
<ul>
<li><strong>Gradle 插件增强</strong>：
<pre><code class="hljs language-gradle" lang="gradle">kotlin {
    wasm("wasmBrowser") {
        browser()
        binaries.executable() // 生成 .wasm + .js 胶水
    }
}
</code></pre>
</li>
<li><strong>调试支持</strong>：Source Map 映射至 Kotlin 源码，Chrome DevTools 直接断点调试</li>
<li><strong>性能分析</strong>：集成 Wasm Profiler，可视化协程调度与内存分配热点</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、实战价值：何时选择 Kotlin/Wasm？</h2>
<p>✅ <strong>推荐场景</strong></p>
<ul>
<li>游戏引擎逻辑（Godot 插件、WebGL 渲染后端）</li>
<li>音视频编解码（FFmpeg Kotlin 封装）</li>
<li>加密/区块链计算（敏感逻辑隔离执行）</li>
<li>KMP 共享业务逻辑（移动端 + Web 高性能模块统一）</li>
</ul>
<p>❌ <strong>暂不适用</strong></p>
<ul>
<li>简单 DOM 操作（Kotlin/JS 更轻量）</li>
<li>重度依赖浏览器 API 的应用（需等待 Wasm Interface Types 普及）</li>
<li>低配设备（Wasm GC 浏览器支持需 Chromium 119+ / Firefox 115+）</li>
</ul>
<hr/>
<h2 data-id="heading-7">四、挑战与社区演进</h2>

























<table><thead><tr><th>挑战</th><th>应对路径（JetBrains 社区动态）</th></tr></thead><tbody><tr><td><strong>浏览器支持碎片化</strong></td><td>提供降级方案：Wasm 模块 + Kotlin/JS 回退</td></tr><tr><td><strong>调试体验待优化</strong></td><td>与 Chrome DevTools 团队合作增强 Source Map 支持</td></tr><tr><td><strong>生态库迁移</strong></td><td>kotlinx-wasm 标准库扩展（协程、序列化专项优化）</td></tr><tr><td><strong>构建体积</strong></td><td>Tree-shaking 深度优化 + 按需加载模块</td></tr></tbody></table>
<blockquote>
<p>🌐 社区动态：Kotlin/Wasm 已在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJetBrains%2Fkotlin-wasm-showcase" target="_blank" title="https://github.com/JetBrains/kotlin-wasm-showcase" ref="nofollow noopener noreferrer">kotlin-wasm-showcase</a> 提供图像滤镜、物理引擎等 Demo；Compose Multiplatform 未来或支持 Wasm 渲染后端。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">五、结语：不止于“编译到 Wasm”</h2>
<p>Kotlin 对 WebAssembly 的拥抱，本质是 <strong>“用工程化思维重构 Web 性能边界”</strong>：</p>
<ul>
<li>对开发者：保留 Kotlin 的空安全、协程等生产力特性，无缝切入高性能场景</li>
<li>对生态：强化 Kotlin Multiplatform “一次编写，全端高性能运行”的愿景</li>
<li>对行业：推动 Wasm 从“C/Rust 专属”走向主流 JVM 语言友好生态</li>
</ul>
<blockquote>
<p>📌 <strong>行动建议</strong>：</p>
<ol>
<li>关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.jetbrains.com%2Fkotlin%2F" target="_blank" title="https://blog.jetbrains.com/kotlin/" ref="nofollow noopener noreferrer">Kotlin Blog</a> 的 Wasm 专题</li>
<li>尝试 Kotlin 1.9.20+ 的实验性 <code>wasm</code> 目标（需启用 <code>-Xwasm-enable</code>）</li>
<li>参与 kotlinx-wasm 社区讨论，贡献用例与反馈</li>
</ol>
</blockquote>
<p>技术演进从无坦途，但当 Kotlin 的优雅与 WebAssembly 的锋芒相遇，我们正站在下一代全栈开发的门槛上。保持好奇，理性期待——真正的 2.2.20 时代，值得每一位 Kotlin 开发者共同塑造。</p>
<blockquote>
<p>📌 <strong>转载提醒</strong>：<br/>
本文最早发布于<a href="https://link.juejin.cn?target=https%3A%2F%2Fmake.dxmwl.com%2F" target="_blank" title="https://make.dxmwl.com/" ref="nofollow noopener noreferrer">码客</a><br/>
文章地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmake.dxmwl.com%2Fp%2F67" target="_blank" title="https://make.dxmwl.com/p/67" ref="nofollow noopener noreferrer">make.dxmwl.com/p/67</a><br/>
转载请注明出处，并与作者进行联系</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3. iOS开发中使用atomic，有什么问题？]]></title>    <link>https://juejin.cn/post/7603185231802564634</link>    <guid>https://juejin.cn/post/7603185231802564634</guid>    <pubDate>2026-02-05T18:22:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603185231802564634" data-draft-id="7603185231802548250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3. iOS开发中使用atomic，有什么问题？"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-02-05T18:22:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS在入门"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426627758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3. iOS开发中使用atomic，有什么问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426627758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS在入门
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T18:22:52.000Z" title="Thu Feb 05 2026 18:22:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>借助AI辅助。</p>
</blockquote>
<h3 data-id="heading-0">1. 核心结论</h3>
<p><strong>在 iOS 开发中，我们几乎总是使用 <code>nonatomic</code>，极少使用 <code>atomic</code>。</strong></p>
<p>使用 <code>atomic</code> 存在两个主要问题：</p>
<ol>
<li><strong>性能损耗</strong>：<code>atomic</code> 会在 setter/getter 方法中加锁，频繁访问时会严重拖慢性能。</li>
<li><strong>虚假的线程安全</strong>：<code>atomic</code> 只能保证属性的<strong>读写操作（Accessors）<strong>是原子的，但</strong>不能保证对象的操作逻辑</strong>是线程安全的。</li>
</ol>
<hr/>
<h3 data-id="heading-1">2. 深度解析：为什么说它是“虚假”的线程安全？</h3>
<p><code>atomic</code> 保证的是：当一个线程在写数据（Setter）时，另一个线程无法同时去写，也无法同时去读（Getter）。它保证了你读到的数据要么是“修改前”的，要么是“修改后”的，不会读到“写了一半”的脏数据。</p>
<p><strong>但是！它不管后续的操作。</strong></p>
<p><strong>举个例子：</strong>
假设你有一个 <code>atomic</code> 的数组属性 <code>self.dataArray</code>。</p>
<pre><code class="hljs language-objective-c" lang="objective-c">@property (atomic, strong) NSMutableArray *dataArray;
</code></pre>
<p><strong>场景：</strong> 线程 A 在读取数组的第 0 个元素，线程 B 同时在清空数组。</p>
<pre><code class="hljs language-objective-c" lang="objective-c">// 线程 A
id obj = [self.dataArray objectAtIndex:0]; 

// 线程 B
[self.dataArray removeAllObjects];
</code></pre>
<p><strong>结果：</strong> 依然会崩溃（Crash）。</p>
<p><strong>原因：</strong></p>
<ul>
<li><code>[self.dataArray]</code> 这个读取操作是原子的（安全的），你确实拿到了数组对象。</li>
<li>但是在你拿到数组后，紧接着调用 <code>objectAtIndex:0</code> 时，线程 B 可能刚好把数组清空了。</li>
<li><code>atomic</code> 锁不住 <code>objectAtIndex:</code> 和 <code>removeAllObjects</code> 这些方法调用。它只管 <code>self.dataArray = ...</code> (setter) 和 <code>... = self.dataArray</code> (getter)。</li>
</ul>
<p><strong>结论：</strong> 要想真正实现线程安全，你需要使用更高层级的锁（如 <code>@synchronized</code>, <code>NSLock</code>, <code>dispatch_semaphore</code> 或串行队列）来包裹住整段逻辑代码，而不仅仅是依赖属性的 <code>atomic</code>。</p>
<hr/>
<h3 data-id="heading-2">3. 性能问题（底层实现）</h3>
<p><code>atomic</code> 的底层实现大致如下（伪代码）：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">- (void)setName:(NSString *)name {
    // 自动加锁
    [self.internalLock lock];
    _name = name;
    [self.internalLock unlock];
}

- (NSString *)name {
    // 自动加锁
    [self.internalLock lock];
    NSString *result = [[_name retain] autorelease];
    [self.internalLock unlock];
    return result;
}
</code></pre>
<p>每次访问属性都要经历 <code>lock</code> -&gt; <code>unlock</code> 的过程。在 UI 渲染或高频计算等对性能敏感的场景下，这种开销是不可接受的。相比之下，<code>nonatomic</code> 直接访问内存，速度快得多。</p>
<hr/>
<h3 data-id="heading-3">4. 什么时候真正需要用 atomic？</h3>
<p>虽然很少，但也不是完全没有。</p>
<ul>
<li>如果你开发的不是 App，而是一个<strong>第三方 SDK</strong> 或 <strong>底层库</strong>。</li>
<li>并且你确定该属性仅仅是保存一个简单的值（比如一个整数配置项，或者一个指针），不涉及复杂的集合操作或逻辑依赖。</li>
<li>此时为了防止外部调用者在多线程环境下读到脏数据，可以使用 <code>atomic</code> 作为一种兜底的防护手段。</li>
</ul>
<h3 data-id="heading-4">参考文章</h3>
<ol>
<li><a href="https://juejin.cn/post/6844903748997758983?searchId=202602061058580880844DB6A443C7B232" target="_blank" title="https://juejin.cn/post/6844903748997758983?searchId=202602061058580880844DB6A443C7B232">关于IOS 属性atomic（原子性）的理解</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被AI坑了3次后，我终于学会用Git救命]]></title>    <link>https://juejin.cn/post/7603185231802449946</link>    <guid>https://juejin.cn/post/7603185231802449946</guid>    <pubDate>2026-02-05T16:06:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603185231802449946" data-draft-id="7602965400810176562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被AI坑了3次后，我终于学会用Git救命"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-02-05T16:06:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户54881731631"/> <meta itemprop="url" content="https://juejin.cn/user/3625533074849658"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被AI坑了3次后，我终于学会用Git救命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3625533074849658/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户54881731631
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T16:06:56.000Z" title="Thu Feb 05 2026 16:06:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 Git + GitHub + VSCode 零基础保姆级入队指南</h2>
<h3 data-id="heading-1">引言：AI编程的救命稻草——Git</h3>
<blockquote>
<p>同学，你可能在想：“git是什么 我们是写代码的 为什么要安装这个东西？”</p>
<p><strong>回答</strong>：因为我们是AI编程，AI有时候“发神经”会把你的项目改的丑不拉几 无法运行 改的地方太多了又不好撤回 这是我的真实经历 ：</p>
</blockquote>
<p><strong>真实故事</strong>：我之前用Trae AI改代码，优化我们的问卷网页的时候。我一次性巴拉巴拉输出了5个需求。测试一下这个的能力上限。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62f1c992e89349a680ad2c98662d4812~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=BMX2a4FGW%2FVJl2AZLEBpDnNpNnM%3D" alt="我提了5个需求看Trae能不能一次性完成" loading="lazy"/>
我当时兴冲冲地打开网页，结果网页不仅丑不拉几还突然运行不了了，气死我了。我当时还手贱在编辑器里想修改一下，然后还点击了确认。无敌了
<strong>幸好我之前听了ai的建议先装了Git</strong>，一条命令把代码恢复到之前正常的状态。如果没有Git，我们这个项目可能原地解散了哈哈
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194addbcdb86466aacd85a41963ba24e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=k2J%2Byo2hq0GauLhP1eCbixt2w9c%3D" alt="回退版本" loading="lazy"/></p>
<p><strong>这就是Git的作用</strong>：代码的“时光机”和“后悔药”。</p>
<h4 data-id="heading-2">Git vs GitHub：它们是什么关系？</h4>























<table><thead><tr><th>工具</th><th>是什么？</th><th>作用</th><th>类比</th></tr></thead><tbody><tr><td><strong>Git</strong></td><td>版本控制软件（融合到你的命令行里面去）</td><td>记录每次代码修改，可以随时回到你提交过的历史版本</td><td>就像玩游戏的“存档”一样，这个档打废了可以读档</td></tr><tr><td><strong>GitHub</strong></td><td>代码托管平台（网站，免费的代码云端存储库）</td><td>1. 备份你的代码到云端，永不丢失<br/>2. 多人协作，合并代码<br/>3. 展示你的项目（简历里放个项目那不是nb?(doge)）</td><td>就像代码的“网盘+朋友圈”</td></tr></tbody></table>
<p><strong>核心比喻</strong>：</p>
<ul>
<li><strong>Git</strong> = 你电脑上的“存档软件”（想要存档的时候3行命令就行了）</li>
<li><strong>GitHub</strong> = 把“存档”过的记录上传到云端（备份+协作）</li>
</ul>
<p><strong>为什么必须用？</strong></p>
<ol>
<li><strong>防AI发神经</strong>：AI改代码把项目改坏了，一键恢复</li>
<li><strong>防手残</strong>：自己改错了，一键恢复</li>
<li><strong>团队协作</strong>：四个人同时改代码，自动合并，不会互相覆盖</li>
<li><strong>代码备份</strong>：电脑坏了、丢了，代码都在云端</li>
</ol>
<hr/>
<h3 data-id="heading-3">第一章：注册GitHub账号（电脑版全流程）</h3>
<h4 data-id="heading-4">1.1 为什么先注册GitHub？</h4>
<p>因为我们要把代码存到云端，需要先有个账户。GitHub是全球最大的代码托管平台，也是程序员的“社交网络”。</p>
<h4 data-id="heading-5">1.2 注册步骤（每个步骤都需要截图！）</h4>
<p><strong>步骤1：打开GitHub官网</strong>（需要梯子 然后最好有一个翻译的插件 外国网站 除非你的英文特别好 不然还是翻译一下 这是我用的 edge插件商店里搜一下就行了） <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12449694e8f9492b918a8c5575c4c636~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=UmOixH50s0u1Fzosovq2U7ra0Jg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li><strong>网址</strong>：<code>https://github.com</code> 把你的邮箱填进去（常用的 qq邮箱就行）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a0e908c3a7349829c4324b9d4af6987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=gnfFvZan%2BdoIQmQThBkzcHuBXiE%3D" alt="github官网" loading="lazy"/></li>
</ul>
<p><strong>步骤2：点击“Sign up后填写信息”</strong></p>
<ul>
<li>【配图2】点击后的注册页面截图
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d244a5b0234322b06172f8af0ee2c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=e6aod28%2FDRzQQpK13O0nvAegHc0%3D" alt="在这里插入图片描述" loading="lazy"/>
点击“Create account”</li>
</ul>
<p>tips:用户名不要太抽象哈哈 Hr可能会看
✔️ 接收产品更新（可选）
<strong>步骤3：人机验证</strong>
6道变态的人机验证题目（我的是连线题目)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5d22b3813da40a1a362d8e7892d054f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=XHcPJFguaVhHudBMOpVC%2B3LHyQQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然后github会给你的邮箱发一个验证码 填入就行了 进入你的邮箱</p>
<p><strong>步骤4：完成注册</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cda9c012f1f4298808676fd9378f6c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=NZX3oc2cyr5emFp%2BibZKF%2BKfG3M%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>重要提示</strong>：</p>
<ul>
<li>✅ 注册后<strong>立即登录一次</strong>，确认成功</li>
<li>✅ 把用户名和密码记在手机备忘录</li>
<li>✅ 队友间互相加好友（后面教）</li>
</ul>
<hr/>
<h3 data-id="heading-6">第二章：安装Git（Windows/Mac双版本）</h3>
<h4 data-id="heading-7">2.1 安装Git的目的</h4>
<p>Git是运行在你电脑上的“命令行存档软件”，只有安装了Git，才能使用GitHub的云端功能。</p>
<h4 data-id="heading-8">2.2 Windows用户安装步骤</h4>
<p><strong>步骤1：下载Git</strong></p>
<ul>
<li><strong>网址</strong>：<code>https://git-scm.com/download/win</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c70ae7df05f4415c8ca5abc9f4d93595~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=gRsXCGveCsrpNuWKD5pSwTTto8Q%3D" alt="" loading="lazy"/>
就这第一个 看你电脑 一般都是x64 最新版的</li>
</ul>
<p><strong>步骤2：运行安装程序</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92e03341206045feae07b9aed9c2aec0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=vxmX0DN7evWZCxp0OOUNhwIDTYI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>步骤3：选择安装位置</strong></p>
<ul>
<li>默认C盘即可，点Next</li>
</ul>
<p><strong>步骤4：选择组件（）</strong></p>
<pre><code class="hljs">这个也默认就行

</code></pre>
<p><strong>步骤5：其他设置</strong></p>
<ul>
<li>一路Next，都用默认设置</li>
<li>最后点Install</li>
</ul>
<p><strong>步骤6：验证安装</strong></p>
<ul>
<li>
<p>按<code>Win + R</code>，输入<code>cmd</code>回车
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f23dd4d133274c85ab2c11b905cd2832~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=F7FdBqh4MvnfdJp4u6OeLE2AmXI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
<li>
<p>输入<code>git --version</code>（注意有个空格）</p>
</li>
<li>
<p>看到版本号就成功了！
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6baf4fb2894746179afd94c26fd8a9a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=MbD4hLkRcvm9N15zRn5MOKCqqag%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
</ul>
<hr/>
<h3 data-id="heading-9">第四章：连接Git和GitHub（关键！）</h3>
<h4 data-id="heading-10">4.1 配置Git用户信息（一次性）</h4>
<ul>
<li>打开终端（Windows用CMD）（vscode里面的终端也行）</li>
<li>输入以下两行命令（绿色的字替换成你的信息）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">git config --global user.name <span class="hljs-string">"你的GitHub用户名"</span>
git config --global user.email <span class="hljs-string">"你的GitHub注册邮箱"</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ec07cdb19db4b77a6e9f9c7e7a545fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=545pAE0m%2BndMdaaF1x6ZGfet7Ss%3D" alt="在这里插入图片描述" loading="lazy"/>
（两行分开输入 不然就会报错
git只认识一行命令）</p>
<h4 data-id="heading-11">4.2 给Git 挂载代理</h4>
<p>【原因】git 默认不会走梯子 得告诉他走这个梯子</p>
<ul>
<li>动作：在终端输入以下命令（告诉 Git 走 7890 通道）：
【端口就是梯子配置的端口 默认都是7890】</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">git config --global http.proxy http://127.0.0.1:7890
</code></pre>
<hr/>
<h3 data-id="heading-12">第五章：可以部署一个的github的项目</h3>
<h4 data-id="heading-13">5.1 这是我们团队的做的一个问卷网站的项目 你们可以尝试部署这个作为练习</h4>
<p>网址：</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//github.com/hhh-dahah/CyberTCM.git</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/860152143bfe4dae9b8ba67c4fca2526~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=UXmLsfTZ%2BGFdFwuMBCdCosoOnOo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-14">5.2 克隆项目到本地</h4>
<p><strong>步骤1：选择存放位置</strong></p>
<ul>
<li>建议放桌面或D盘，路径不要有中文</li>
</ul>
<p><strong>步骤2：用VS Code克隆</strong></p>
<ol>
<li>
<p>打开VS Code</p>
</li>
<li>
<p>按<code>Ctrl+Shift+P</code></p>
</li>
<li>
<p>输入“Git: Clone”</p>
</li>
<li>
<p>粘贴项目地址 （我上面给的网址）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/081a6d1f0e0b432d8a81e04a6a15ecd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=HIDv0E3OFexNg6JpBvJig6rXOgY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
<li>
<p>选择存放文件夹 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aaee337fd874cf9bbcf364201c9bb2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=f4aF7CPlrP9XCI%2BrBLsPNhcyABE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
</ol>
<p><strong>步骤3：打开项目</strong></p>
<ul>
<li>克隆完成后，VS Code会提示打开</li>
<li>点击“Open”
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e3a1700d33d412ca1b9b6444ec61373~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=Qw2LfGO%2FKxg1BzpZczftZeGYjM4%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<hr/>
<h3 data-id="heading-15">第六章：运行项目（验证一切正常）</h3>
<h4 data-id="heading-16">6.1 第一次运行前检查</h4>
<p><strong>检查1：文件夹结构</strong></p>
<ul>
<li>左边栏应该看到这些文件：</li>
</ul>

<pre><code class="hljs language-erlang" lang="erlang">CyberTCM/
├── app.py
├── requirements.txt
├── assets/
└── ...
</code></pre>
<p><strong>检查2：打开终端</strong></p>
<ul>
<li>VS Code顶部菜单：查看 → 终端</li>
<li>确认路径正确（结尾是<code>/CyberTCM&gt;</code>）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a686a6dbbc4458ba76b616ab37805d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=1nzC6BdQSC5tw%2FjmW6a9JvCI0zw%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<h4 data-id="heading-17">6.2 安装Python依赖</h4>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<ul>
<li>我把依赖全部写在requirement 这个文件里了所以直接运行这个命令就行了<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a80926b120e4eedb6f4b358bf25ca55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=xCLQJGGWlYT5qz%2FJDyUOUtKXonE%3D" alt="在这里插入图片描述" loading="lazy"/>我这已经安装过了（安装过程开梯子 不然很慢）</li>
</ul>
<h4 data-id="heading-18">6.3 运行项目</h4>
<p>-命令行输入</p>
<pre><code class="hljs language-bash" lang="bash">streamlit run app.py
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23f32c31819448a19e150f140e467648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=N3nPuHoScoMilXSjBjRxZsYJYT0%3D" alt="在这里插入图片描述" loading="lazy"/>
-如果没有自动打开网页就按住ctrl 鼠标点一下下面那个Local URL就可以打开网页 就这样 （评论区截图交作业啊hh)
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cce7f0ed02547b0854b2bb5d41414e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTQ4ODE3MzE2MzE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770912416&amp;x-signature=sIb1kU4%2FpKRzt7SS%2BX4%2Fdn5dXsc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-19">第七章：日常协作流程（简化版SOP）</h3>
<h4 data-id="heading-20">7.1 每天开始工作前</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 拉取最新代码（同步队友的修改）</span>
git pull origin master

<span class="hljs-comment"># 2. 运行项目</span>
streamlit run app.py
</code></pre>
<h4 data-id="heading-21">7.2 写完代码后保存</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 添加所有修改</span>
git add .  【注意后面有个空格和一个点】

<span class="hljs-comment"># 2. 写提交信息（必须！）</span>
git commit -m <span class="hljs-string">"你的名字: 做了什么"</span>
<span class="hljs-comment"># 示例：git commit -m "张三: 修复了登录按钮bug"</span>

<span class="hljs-comment"># 3. 推送到GitHub 【开梯子】</span>
git push origin master
</code></pre>
<h4 data-id="heading-22">7.3 记住这3个命令就够用</h4>
<pre><code class="hljs language-sql" lang="sql">每天开始：git pull
修改后：git <span class="hljs-keyword">add</span> . → git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "描述" → git push
</code></pre>
<hr/>
<h3 data-id="heading-23">第八章：常见问题解决（Q&amp;A）</h3>
<h4 data-id="heading-24">Q1：命令输错了怎么办？</h4>
<p><strong>A</strong>：按<code>Ctrl+C</code>可以中断当前命令。</p>
<h4 data-id="heading-25">Q2：终端显示一堆看不懂的英文？</h4>
<p><strong>A</strong>：直接复制问ai 让它解决</p>
<hr/>
<h3 data-id="heading-26">第九章：团队验收任务清单</h3>
<p>每个队员完成以下任务后<strong>在群里打卡</strong>：</p>
<h4 data-id="heading-27">✅ 任务清单</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 注册GitHub账号，把用户名发群里</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 安装VS Code，截图主界面</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 克隆项目，截图文件结构</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 运行项目，截图浏览器打开的网页</li>
</ul>
<h4 data-id="heading-28">🏆 完成奖励</h4>
<ul>
<li>全队完成：请我喝奶茶</li>
<li>前三名完成：给我发红包</li>
<li>帮助队友解决问题：团队贡献加分</li>
</ul>
<hr/>
<h3 data-id="heading-29">第十章：下一步学习计划</h3>
<p>完成这个指南后，我们按这个顺序学习：</p>
<h4 data-id="heading-30">学习路线图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Git基础] --&gt; B[Trae熟练使用]
    B --&gt; C[Docker环境统一]
    C --&gt; D[Docker环境统一]
    
    D --&gt; F[项目部署上线]
</code></pre>
<h4 data-id="heading-31">预计时间</h4>
<ul>
<li>本周：完成Git基础（这个指南）</li>
<li>下周：项目开发规范</li>
<li>下下周：Docker入门</li>
<li>一个月后：我们的AI项目中级版完成！</li>
</ul>
<hr/>
<p>遇到任何问题，随时在群里@我，或者直接打我的电话。</p>
<p><strong>记住</strong>：我们是一个团队，你的问题就是团队的问题。没有人会笑你问“蠢问题”，因为每个人都是从零开始的。</p>
<p>现在，开始第一步吧！从打开<code>github.com</code>开始。</p>
<hr/>
<h3 data-id="heading-32">📎 附录：所有链接汇总</h3>
<h4 data-id="heading-33">必备网站</h4>
<ol>
<li>GitHub注册：<code>https://github.com</code></li>
<li>Git下载：<code>https://git-scm.com/downloads</code></li>
<li>VS Code下载：<code>https://code.visualstudio.com</code></li>
</ol>
<h4 data-id="heading-34">团队资源</h4>
<ol>
<li>项目地址：<code>https://github.com/hhh-dahah/CyberTCM.git</code></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[spring-ai mcp-server入门指南]]></title>    <link>https://juejin.cn/post/7603261102794686490</link>    <guid>https://juejin.cn/post/7603261102794686490</guid>    <pubDate>2026-02-06T02:44:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603261102794686490" data-draft-id="7587779957675262003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="spring-ai mcp-server入门指南"/> <meta itemprop="keywords" content="Spring Boot,MCP"/> <meta itemprop="datePublished" content="2026-02-06T02:44:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昵称为空C"/> <meta itemprop="url" content="https://juejin.cn/user/1267096172897005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            spring-ai mcp-server入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1267096172897005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昵称为空C
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:44:04.000Z" title="Fri Feb 06 2026 02:44:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：本文主要介绍<code>springboot3</code>+ <code>spring ai</code>实现<code>mcp-server</code>来增加我们的生产力；下文用一个温度的查询和数据库查询的案例来实现开发步骤。</p>
<h2 data-id="heading-0">核心概念</h2>
<blockquote>
<p>Spring AI 提供了与 <strong>Model Context Protocol (MCP)</strong> ​ 的集成，这是一个新兴的协议，旨在为 AI 应用提供标准化工具和上下文管理方式。</p>
</blockquote>
<p><strong>MCP</strong>​ 是一个开放协议，让 AI 模型能够：</p>
<ul>
<li>发现和使用工具</li>
<li>访问各种数据源</li>
<li>管理上下文信息</li>
<li>以标准化方式与外部系统交互</li>
</ul>
<h2 data-id="heading-1">实战案例</h2>
<h3 data-id="heading-2"><code>pom.xml</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sp3-mcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>sp3-mcp<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>sp3-mcp<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">licenses</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">license</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">licenses</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">developers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">developer</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">developers</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">connection</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">developerConnection</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tag</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">scm</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3"><code>application.properties</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># spring.main.web-application-type=none</span>

<span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> You must disable the banner and the console logging </span>
<span class="hljs-comment"># to allow the STDIO transport to work !!!</span>
<span class="hljs-attr">spring.main.banner-mode</span>=<span class="hljs-literal">off</span>
<span class="hljs-comment"># logging.pattern.console=</span>

<span class="hljs-comment"># spring.ai.mcp.server.stdio=false</span>

<span class="hljs-attr">spring.ai.mcp.server.name</span>=mcp-weather-server
<span class="hljs-attr">spring.ai.mcp.server.request-timeout</span>=<span class="hljs-number">1</span>h

<span class="hljs-attr">spring.ai.mcp.server.protocol</span>=sse

<span class="hljs-attr">logging.file.name</span>=./mcp-weather-server/target/server.log
</code></pre>
<h3 data-id="heading-4"><code>Application.java</code></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sp3McpApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">Sp3McpApplication</span>.<span class="hljs-property">class</span>, args);
    }

}
</code></pre>
<h3 data-id="heading-5"><code>WeatherService.java</code></h3>
<blockquote>
<p>提供的温度查询的工具</p>
</blockquote>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class WeatherService {

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">RestClient</span> <span class="hljs-selector-tag">restClient</span> = <span class="hljs-selector-tag">RestClient</span><span class="hljs-selector-class">.create</span>();

    <span class="hljs-comment">/**
     * The response format from the Open-Meteo API
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">record</span> <span class="hljs-selector-tag">WeatherResponse</span>(Current current) {
        <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">record</span> <span class="hljs-selector-tag">Current</span>(LocalDateTime time, int interval, double temperature_2m) {
        }
    }

    <span class="hljs-variable">@McpTool</span>(description = <span class="hljs-string">"Get the temperature (in celsius) for a specific location"</span>)
    public String <span class="hljs-built_in">getTemperature</span>(McpSyncServerExchange exchange,
                                 <span class="hljs-variable">@McpToolParam</span>(description = <span class="hljs-string">"The location latitude"</span>) double latitude,
                                 <span class="hljs-variable">@McpToolParam</span>(description = <span class="hljs-string">"The location longitude"</span>) double longitude,
                                 <span class="hljs-variable">@McpProgressToken</span> String progressToken) {

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.loggingNotification</span>(LoggingMessageNotification.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">level</span>(LoggingLevel.DEBUG)
                .<span class="hljs-built_in">data</span>(<span class="hljs-string">"Call getTemperature Tool with latitude: "</span> + latitude + <span class="hljs-string">" and longitude: "</span> + longitude)
                .<span class="hljs-built_in">meta</span>(Map.<span class="hljs-built_in">of</span>()) <span class="hljs-comment">// non null meata as a workaround for <span class="hljs-doctag">bug:</span> ...</span>
                .<span class="hljs-built_in">build</span>());

        <span class="hljs-comment">// 0% progress</span>
        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"Retrieving weather forecast"</span>));

        <span class="hljs-selector-tag">WeatherResponse</span> <span class="hljs-selector-tag">weatherResponse</span> = <span class="hljs-selector-tag">restClient</span><span class="hljs-selector-class">.get</span>()
                <span class="hljs-selector-class">.uri</span>(<span class="hljs-string">"https://api.open-meteo.com/v1/forecast?latitude={latitude}&amp;longitude={longitude}&amp;current=temperature_2m"</span>,
                        latitude, longitude)
                <span class="hljs-selector-class">.retrieve</span>()
                <span class="hljs-selector-class">.body</span>(WeatherResponse.class);

        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">epicPoem</span> = "<span class="hljs-selector-tag">MCP</span> <span class="hljs-selector-tag">client</span> <span class="hljs-selector-tag">doesn</span>'<span class="hljs-selector-tag">t</span> <span class="hljs-selector-tag">provide</span> <span class="hljs-selector-tag">sampling</span> <span class="hljs-selector-tag">capability</span>.";

        <span class="hljs-selector-tag">if</span> (exchange.<span class="hljs-built_in">getClientCapabilities</span>().<span class="hljs-built_in">sampling</span>() != null) {

            <span class="hljs-comment">// 50% progress</span>
            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"Start sampling"</span>));

            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">samplingMessage</span> = """
                <span class="hljs-selector-tag">For</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">weather</span> <span class="hljs-selector-tag">forecast</span> (temperature is in Celsius): %<span class="hljs-selector-tag">s</span>.
                <span class="hljs-selector-tag">At</span> <span class="hljs-selector-tag">location</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">latitude</span>: %<span class="hljs-selector-tag">s</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">longitude</span>: %<span class="hljs-selector-tag">s</span>.
                <span class="hljs-selector-tag">Please</span> <span class="hljs-selector-tag">write</span> <span class="hljs-selector-tag">an</span> <span class="hljs-selector-tag">epic</span> <span class="hljs-selector-tag">poem</span> <span class="hljs-selector-tag">about</span> <span class="hljs-selector-tag">this</span> <span class="hljs-selector-tag">forecast</span> <span class="hljs-selector-tag">using</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">Shakespearean</span> <span class="hljs-selector-tag">style</span>.
                """<span class="hljs-selector-class">.formatted</span>(weatherResponse.<span class="hljs-built_in">current</span>().<span class="hljs-built_in">temperature_2m</span>(), latitude, longitude);

            <span class="hljs-selector-tag">CreateMessageResult</span> <span class="hljs-selector-tag">samplingResponse</span> = <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.createMessage</span>(CreateMessageRequest.<span class="hljs-built_in">builder</span>()
                    .<span class="hljs-built_in">systemPrompt</span>(<span class="hljs-string">"You are a poet!"</span>)
                    .<span class="hljs-built_in">messages</span>(List.<span class="hljs-built_in">of</span>(new <span class="hljs-built_in">SamplingMessage</span>(Role.USER, new <span class="hljs-built_in">TextContent</span>(samplingMessage))))
                    .<span class="hljs-built_in">modelPreferences</span>(ModelPreferences.<span class="hljs-built_in">builder</span>().<span class="hljs-built_in">addHint</span>(<span class="hljs-string">"anthropic"</span>).<span class="hljs-built_in">build</span>())
                    .<span class="hljs-built_in">build</span>());

            <span class="hljs-selector-tag">epicPoem</span> = ((TextContent) samplingResponse.<span class="hljs-built_in">content</span>())<span class="hljs-selector-class">.text</span>();

        }

        <span class="hljs-comment">// 100% progress</span>
        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"Task completed"</span>));

        <span class="hljs-selector-tag">return</span> """
             <span class="hljs-selector-tag">Weather</span> <span class="hljs-selector-tag">Poem2</span>: %<span class="hljs-selector-tag">s</span>
             <span class="hljs-selector-tag">about</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">weather</span>: %<span class="hljs-selector-tag">s</span>°<span class="hljs-selector-tag">C</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">location</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">latitude</span>: %<span class="hljs-selector-tag">s</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">longitude</span>: %<span class="hljs-selector-tag">s</span>
             """<span class="hljs-selector-class">.formatted</span>(epicPoem, weatherResponse.<span class="hljs-built_in">current</span>().<span class="hljs-built_in">temperature_2m</span>(), latitude, longitude);
    }

}
</code></pre>
<h3 data-id="heading-6"><code>DatabaseService.java</code></h3>
<blockquote>
<p>数据库查询工具</p>
</blockquote>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class DatabaseService {

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Connection</span> <span class="hljs-selector-tag">connection</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">jdbcUrl</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">username</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">password</span>;

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DatabaseService</span>() {
        <span class="hljs-comment">// 从环境变量读取数据库配置</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">host</span> = "<span class="hljs-number">192.168</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.134</span>";
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">port</span> = "<span class="hljs-number">30635</span>";
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">database</span> = "<span class="hljs-selector-tag">test_1</span>";
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.username</span> = "<span class="hljs-selector-tag">root</span>";
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.password</span> = "<span class="hljs-selector-tag">xxxx</span>";
        
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.jdbcUrl</span> = <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.format</span>(<span class="hljs-string">"jdbc:mysql://%s:%s/%s?useSSL=false&amp;allowPublicKeyRetrieval=true&amp;serverTimezone=UTC"</span>, 
                                   host, port, database);
        
        <span class="hljs-comment">// 初始化数据库连接</span>
        <span class="hljs-selector-tag">initializeConnection</span>();
    }

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">getEnvOrDefault</span>(String key, String defaultValue) {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.getenv</span>(key);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">value</span> != <span class="hljs-selector-tag">null</span> ? <span class="hljs-selector-tag">value</span> : <span class="hljs-selector-tag">defaultValue</span>;
    }

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">getRequiredEnv</span>(String key) {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.getenv</span>(key);
        <span class="hljs-selector-tag">if</span> (value == null || value.<span class="hljs-built_in">trim</span>().<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">IllegalArgumentException</span>(<span class="hljs-string">"Required environment variable "</span> + key + <span class="hljs-string">" is not set"</span>);
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">value</span>;
    }

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">initializeConnection</span>() {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">Class</span><span class="hljs-selector-class">.forName</span>(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.connection</span> = <span class="hljs-selector-tag">DriverManager</span><span class="hljs-selector-class">.getConnection</span>(jdbcUrl, username, password);
        } <span class="hljs-selector-tag">catch</span> (ClassNotFoundException | SQLException e) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"Failed to initialize database connection: "</span> + e.<span class="hljs-built_in">getMessage</span>(), e);
        }
    }

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Connection</span> <span class="hljs-selector-tag">getConnection</span>() <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">SQLException</span> {
        <span class="hljs-selector-tag">if</span> (connection == null || connection.<span class="hljs-built_in">isClosed</span>()) {
            <span class="hljs-selector-tag">initializeConnection</span>();
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">connection</span>;
    }

    @<span class="hljs-selector-tag">McpTool</span>(description = <span class="hljs-string">"执行MySQL查询语句(SELECT)"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">executeQuery</span>(McpSyncServerExchange exchange,
                              <span class="hljs-variable">@McpToolParam</span>(description = <span class="hljs-string">"要执行的SQL查询语句"</span>) String sql,
                              <span class="hljs-variable">@McpProgressToken</span> String progressToken) {

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.loggingNotification</span>(LoggingMessageNotification.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">level</span>(LoggingLevel.DEBUG)
                .<span class="hljs-built_in">data</span>(<span class="hljs-string">"Executing query: "</span> + sql)
                .<span class="hljs-built_in">meta</span>(Map.<span class="hljs-built_in">of</span>())
                .<span class="hljs-built_in">build</span>());

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"开始执行查询"</span>));

        <span class="hljs-selector-tag">try</span> (Connection conn = <span class="hljs-built_in">getConnection</span>();
             Statement stmt = conn.<span class="hljs-built_in">createStatement</span>();
             ResultSet rs = stmt.<span class="hljs-built_in">executeQuery</span>(sql)) {

            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"处理查询结果"</span>));

            <span class="hljs-selector-tag">ResultSetMetaData</span> <span class="hljs-selector-tag">metaData</span> = <span class="hljs-selector-tag">rs</span><span class="hljs-selector-class">.getMetaData</span>();
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">columnCount</span> = <span class="hljs-selector-tag">metaData</span><span class="hljs-selector-class">.getColumnCount</span>();

            <span class="hljs-selector-tag">StringBuilder</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">StringBuilder</span>();
            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"查询执行成功!\n\n"</span>);
            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"列信息:\n"</span>);
            <span class="hljs-selector-tag">for</span> (int i = <span class="hljs-number">1</span>; i &lt;= columnCount; i++) {
                <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(String.<span class="hljs-built_in">format</span>(<span class="hljs-string">"  %s (%s)\n"</span>, 
                    metaData.<span class="hljs-built_in">getColumnName</span>(i), 
                    metaData.<span class="hljs-built_in">getColumnTypeName</span>(i)));
            }
            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"\n查询结果:\n"</span>);

            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">rowCount</span> = <span class="hljs-number">0</span>;
            <span class="hljs-selector-tag">while</span> (rs.<span class="hljs-built_in">next</span>()) {
                <span class="hljs-selector-tag">rowCount</span>++;
                <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"行 "</span>)<span class="hljs-selector-class">.append</span>(rowCount)<span class="hljs-selector-class">.append</span>(<span class="hljs-string">": "</span>);
                <span class="hljs-selector-tag">for</span> (int i = <span class="hljs-number">1</span>; i &lt;= columnCount; i++) {
                    <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">value</span> = <span class="hljs-selector-tag">rs</span><span class="hljs-selector-class">.getObject</span>(i);
                    <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(metaData.<span class="hljs-built_in">getColumnName</span>(i))<span class="hljs-selector-class">.append</span>(<span class="hljs-string">"="</span>)<span class="hljs-selector-class">.append</span>(value);
                    <span class="hljs-selector-tag">if</span> (i &lt; columnCount) <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">", "</span>);
                }
                <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"\n"</span>);
            }

            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"查询完成"</span>));
            
            <span class="hljs-selector-tag">if</span> (rowCount == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"(查询未返回任何行)"</span>);
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"\n总计: "</span>)<span class="hljs-selector-class">.append</span>(rowCount)<span class="hljs-selector-class">.append</span>(<span class="hljs-string">" 行"</span>);
            }

            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.toString</span>();

        } <span class="hljs-selector-tag">catch</span> (SQLException e) {
            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"查询失败"</span>));
            <span class="hljs-selector-tag">return</span> "查询执行失败: " + <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.getMessage</span>();
        }
    }

    @<span class="hljs-selector-tag">McpTool</span>(description = <span class="hljs-string">"执行MySQL更新语句(INSERT, UPDATE, DELETE)"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">executeUpdate</span>(McpSyncServerExchange exchange,
                               <span class="hljs-variable">@McpToolParam</span>(description = <span class="hljs-string">"要执行的SQL更新语句"</span>) String sql,
                               <span class="hljs-variable">@McpProgressToken</span> String progressToken) {

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.loggingNotification</span>(LoggingMessageNotification.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">level</span>(LoggingLevel.DEBUG)
                .<span class="hljs-built_in">data</span>(<span class="hljs-string">"Executing update: "</span> + sql)
                .<span class="hljs-built_in">meta</span>(Map.<span class="hljs-built_in">of</span>())
                .<span class="hljs-built_in">build</span>());

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"开始执行更新"</span>));

        <span class="hljs-selector-tag">try</span> (Connection conn = <span class="hljs-built_in">getConnection</span>();
             Statement stmt = conn.<span class="hljs-built_in">createStatement</span>()) {

            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"执行更新语句"</span>));

            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">affectedRows</span> = <span class="hljs-selector-tag">stmt</span><span class="hljs-selector-class">.executeUpdate</span>(sql);

            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"更新完成"</span>));

            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.format</span>(<span class="hljs-string">"更新执行成功! 影响了 %d 行。"</span>, affectedRows);

        } <span class="hljs-selector-tag">catch</span> (SQLException e) {
            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"更新失败"</span>));
            <span class="hljs-selector-tag">return</span> "更新执行失败: " + <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.getMessage</span>();
        }
    }

    @<span class="hljs-selector-tag">McpTool</span>(description = <span class="hljs-string">"执行任意MySQL语句"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">executeSql</span>(McpSyncServerExchange exchange,
                            <span class="hljs-variable">@McpToolParam</span>(description = <span class="hljs-string">"要执行的SQL语句"</span>) String sql,
                            <span class="hljs-variable">@McpProgressToken</span> String progressToken) {

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.loggingNotification</span>(LoggingMessageNotification.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">level</span>(LoggingLevel.DEBUG)
                .<span class="hljs-built_in">data</span>(<span class="hljs-string">"Executing SQL: "</span> + sql)
                .<span class="hljs-built_in">meta</span>(Map.<span class="hljs-built_in">of</span>())
                .<span class="hljs-built_in">build</span>());

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"开始执行SQL"</span>));

        <span class="hljs-selector-tag">try</span> (Connection conn = <span class="hljs-built_in">getConnection</span>();
             Statement stmt = conn.<span class="hljs-built_in">createStatement</span>()) {

            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"执行SQL语句"</span>));

            <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">isResultSet</span> = <span class="hljs-selector-tag">stmt</span><span class="hljs-selector-class">.execute</span>(sql);

            <span class="hljs-selector-tag">StringBuilder</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">StringBuilder</span>();

            <span class="hljs-selector-tag">if</span> (isResultSet) {
                <span class="hljs-comment">// 处理查询结果</span>
                <span class="hljs-selector-tag">try</span> (ResultSet rs = stmt.<span class="hljs-built_in">getResultSet</span>()) {
                    <span class="hljs-selector-tag">ResultSetMetaData</span> <span class="hljs-selector-tag">metaData</span> = <span class="hljs-selector-tag">rs</span><span class="hljs-selector-class">.getMetaData</span>();
                    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">columnCount</span> = <span class="hljs-selector-tag">metaData</span><span class="hljs-selector-class">.getColumnCount</span>();

                    <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"SQL执行成功 - 查询结果:\n\n"</span>);
                    <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"列信息:\n"</span>);
                    <span class="hljs-selector-tag">for</span> (int i = <span class="hljs-number">1</span>; i &lt;= columnCount; i++) {
                        <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(String.<span class="hljs-built_in">format</span>(<span class="hljs-string">"  %s (%s)\n"</span>, 
                            metaData.<span class="hljs-built_in">getColumnName</span>(i), 
                            metaData.<span class="hljs-built_in">getColumnTypeName</span>(i)));
                    }
                    <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"\n数据:\n"</span>);

                    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">rowCount</span> = <span class="hljs-number">0</span>;
                    <span class="hljs-selector-tag">while</span> (rs.<span class="hljs-built_in">next</span>()) {
                        <span class="hljs-selector-tag">rowCount</span>++;
                        <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"行 "</span>)<span class="hljs-selector-class">.append</span>(rowCount)<span class="hljs-selector-class">.append</span>(<span class="hljs-string">": "</span>);
                        <span class="hljs-selector-tag">for</span> (int i = <span class="hljs-number">1</span>; i &lt;= columnCount; i++) {
                            <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">value</span> = <span class="hljs-selector-tag">rs</span><span class="hljs-selector-class">.getObject</span>(i);
                            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(metaData.<span class="hljs-built_in">getColumnName</span>(i))<span class="hljs-selector-class">.append</span>(<span class="hljs-string">"="</span>)<span class="hljs-selector-class">.append</span>(value);
                            <span class="hljs-selector-tag">if</span> (i &lt; columnCount) <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">", "</span>);
                        }
                        <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"\n"</span>);
                    }

                    <span class="hljs-selector-tag">if</span> (rowCount == <span class="hljs-number">0</span>) {
                        <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"(查询未返回任何行)"</span>);
                    } <span class="hljs-selector-tag">else</span> {
                        <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"\n总计: "</span>)<span class="hljs-selector-class">.append</span>(rowCount)<span class="hljs-selector-class">.append</span>(<span class="hljs-string">" 行"</span>);
                    }
                }
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-comment">// 处理更新结果</span>
                <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">affectedRows</span> = <span class="hljs-selector-tag">stmt</span><span class="hljs-selector-class">.getUpdateCount</span>();
                <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">"SQL执行成功 - 更新了 "</span>)<span class="hljs-selector-class">.append</span>(affectedRows)<span class="hljs-selector-class">.append</span>(<span class="hljs-string">" 行。"</span>);
            }

            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"SQL执行完成"</span>));
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.toString</span>();

        } <span class="hljs-selector-tag">catch</span> (SQLException e) {
            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"SQL执行失败"</span>));
            <span class="hljs-selector-tag">return</span> "<span class="hljs-selector-tag">SQL</span>执行失败: " + <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.getMessage</span>();
        }
    }

    @<span class="hljs-selector-tag">McpTool</span>(description = <span class="hljs-string">"获取数据库表列表"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">getTables</span>(McpSyncServerExchange exchange,
                           <span class="hljs-variable">@McpProgressToken</span> String progressToken) {

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.loggingNotification</span>(LoggingMessageNotification.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">level</span>(LoggingLevel.DEBUG)
                .<span class="hljs-built_in">data</span>(<span class="hljs-string">"Getting database tables"</span>)
                .<span class="hljs-built_in">meta</span>(Map.<span class="hljs-built_in">of</span>())
                .<span class="hljs-built_in">build</span>());

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"获取表列表"</span>));

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">executeQuery</span>(exchange, <span class="hljs-string">"SHOW TABLES"</span>, progressToken);
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"获取表列表失败"</span>));
            <span class="hljs-selector-tag">return</span> "获取表列表失败: " + <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.getMessage</span>();
        }
    }

    @<span class="hljs-selector-tag">McpTool</span>(description = <span class="hljs-string">"获取指定表的结构信息"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">getTableStructure</span>(McpSyncServerExchange exchange,
                                  <span class="hljs-variable">@McpToolParam</span>(description = <span class="hljs-string">"表名"</span>) String tableName,
                                  <span class="hljs-variable">@McpProgressToken</span> String progressToken) {

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.loggingNotification</span>(LoggingMessageNotification.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">level</span>(LoggingLevel.DEBUG)
                .<span class="hljs-built_in">data</span>(<span class="hljs-string">"Getting table structure: "</span> + tableName)
                .<span class="hljs-built_in">meta</span>(Map.<span class="hljs-built_in">of</span>())
                .<span class="hljs-built_in">build</span>());

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"获取表结构"</span>));

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">sql</span> = "<span class="hljs-selector-tag">DESCRIBE</span> " + <span class="hljs-selector-tag">tableName</span>;
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">executeQuery</span>(exchange, sql, progressToken);
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"获取表结构失败"</span>));
            <span class="hljs-selector-tag">return</span> "获取表结构失败: " + <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.getMessage</span>();
        }
    }

    @<span class="hljs-selector-tag">McpTool</span>(description = <span class="hljs-string">"测试数据库连接"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">testConnection</span>(McpSyncServerExchange exchange,
                                <span class="hljs-variable">@McpProgressToken</span> String progressToken) {

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.loggingNotification</span>(LoggingMessageNotification.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">level</span>(LoggingLevel.DEBUG)
                .<span class="hljs-built_in">data</span>(<span class="hljs-string">"Testing database connection"</span>)
                .<span class="hljs-built_in">meta</span>(Map.<span class="hljs-built_in">of</span>())
                .<span class="hljs-built_in">build</span>());

        <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"测试连接"</span>));

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">Connection</span> <span class="hljs-selector-tag">conn</span> = <span class="hljs-selector-tag">getConnection</span>();
            <span class="hljs-selector-tag">if</span> (conn != null &amp;&amp; !conn.<span class="hljs-built_in">isClosed</span>()) {
                <span class="hljs-selector-tag">DatabaseMetaData</span> <span class="hljs-selector-tag">metaData</span> = <span class="hljs-selector-tag">conn</span><span class="hljs-selector-class">.getMetaData</span>();
                <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.format</span>(
                    <span class="hljs-string">"数据库连接测试成功!\n"</span> +
                    <span class="hljs-string">"数据库产品: %s\n"</span> +
                    <span class="hljs-string">"数据库版本: %s\n"</span> +
                    <span class="hljs-string">"驱动名称: %s\n"</span> +
                    <span class="hljs-string">"驱动版本: %s\n"</span> +
                    <span class="hljs-string">"连接URL: %s"</span>,
                    metaData.<span class="hljs-built_in">getDatabaseProductName</span>(),
                    metaData.<span class="hljs-built_in">getDatabaseProductVersion</span>(),
                    metaData.<span class="hljs-built_in">getDriverName</span>(),
                    metaData.<span class="hljs-built_in">getDriverVersion</span>(),
                    jdbcUrl
                );
                
                <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"连接测试完成"</span>));
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">result</span>;
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"连接测试失败"</span>));
                <span class="hljs-selector-tag">return</span> "数据库连接失败: 连接无效或已关闭";
            }
        } <span class="hljs-selector-tag">catch</span> (SQLException e) {
            <span class="hljs-selector-tag">exchange</span><span class="hljs-selector-class">.progressNotification</span>(new <span class="hljs-built_in">ProgressNotification</span>(progressToken, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-string">"连接测试失败"</span>));
            <span class="hljs-selector-tag">return</span> "数据库连接测试失败: " + <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.getMessage</span>();
        }
    }
}
</code></pre>
<h3 data-id="heading-7">启动日志</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dd5cfa04c174e6cbee133123875d69d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950644&amp;x-signature=vIPeZpuKRufhVZWTM38s2tFybUM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">客户端配置<code>MCP</code></h2>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"天气服务"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"disabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"disabledTools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8080/sse"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1be6cc19d6443b9f26d1675b210f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950644&amp;x-signature=lb9zyr7ruQZBJonK95LY4du39u0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>然后就可以愉快使用了</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot实现公正有趣好玩的年会抽奖系统]]></title>    <link>https://juejin.cn/post/7603294029530890291</link>    <guid>https://juejin.cn/post/7603294029530890291</guid>    <pubDate>2026-02-06T02:43:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603294029530890291" data-draft-id="7603283691456626698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot实现公正有趣好玩的年会抽奖系统"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T02:43:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot实现公正有趣好玩的年会抽奖系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:43:55.000Z" title="Fri Feb 06 2026 02:43:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SpringBoot实现公正有趣好玩的年会抽奖系统</h2>
<h3 data-id="heading-1">一、项目背景与设计思路</h3>
<p>年会抽奖是每个企业年末的重要活动，但传统的抽奖方式往往存在公平性不足、互动性差的问题。本文将基于SpringBoot框架，设计并实现一个公正、有趣、好玩的年会抽奖系统，确保抽奖过程的透明性和随机性，同时增加多种互动功能。</p>
<h4 data-id="heading-2">系统核心设计原则：</h4>
<ol>
<li><strong>公正性</strong>：使用加密随机算法，确保结果不可预测</li>
<li><strong>趣味性</strong>：多种抽奖模式，动画效果，实时互动</li>
<li><strong>可靠性</strong>：高并发支持，数据持久化，操作日志</li>
<li><strong>易用性</strong>：简洁的Web界面，易于部署和管理</li>
</ol>
<h3 data-id="heading-3">二、技术栈选型</h3>
<ul>
<li><strong>后端框架</strong>：SpringBoot 2.7.x</li>
<li><strong>前端技术</strong>：Thymeleaf + Bootstrap 5 + jQuery</li>
<li><strong>数据库</strong>：MySQL 8.0 + Redis 7.0</li>
<li><strong>实时通信</strong>：WebSocket</li>
<li><strong>安全框架</strong>：Spring Security</li>
<li><strong>构建工具</strong>：Maven 3.8+</li>
</ul>
<h3 data-id="heading-4">三、项目结构设计</h3>
<pre><code class="hljs language-bash" lang="bash">lottery-system/
├── src/main/java/com/lottery/
│   ├── config/          <span class="hljs-comment"># 配置类</span>
│   ├── controller/      <span class="hljs-comment"># 控制器层</span>
│   ├── service/         <span class="hljs-comment"># 业务逻辑层</span>
│   ├── repository/      <span class="hljs-comment"># 数据访问层</span>
│   ├── model/          <span class="hljs-comment"># 实体类</span>
│   ├── utils/          <span class="hljs-comment"># 工具类</span>
│   ├── aspect/         <span class="hljs-comment"># AOP切面</span>
│   └── security/       <span class="hljs-comment"># 安全配置</span>
├── src/main/resources/
│   ├── static/         <span class="hljs-comment"># 静态资源</span>
│   └── templates/      <span class="hljs-comment"># 模板文件</span>
└── pom.xml
</code></pre>
<h3 data-id="heading-5">四、数据库设计</h3>
<h4 data-id="heading-6">4.1 核心表结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 员工表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employee (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    employee_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    department <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    avatar_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),
    is_attended <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">false</span>,
    created_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 奖品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> prize (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    level <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'奖品等级：1-特等奖，2-一等奖，3-二等奖...'</span>,
    total_count <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    remain_count <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    image_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),
    description TEXT,
    created_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 中奖记录表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> winning_record (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    employee_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    prize_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    draw_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    draw_method <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) COMMENT <span class="hljs-string">'抽奖方式'</span>,
    <span class="hljs-keyword">FOREIGN</span> KEY (employee_id) <span class="hljs-keyword">REFERENCES</span> employee(employee_id),
    <span class="hljs-keyword">FOREIGN</span> KEY (prize_id) <span class="hljs-keyword">REFERENCES</span> prize(id)
);

<span class="hljs-comment">-- 抽奖活动表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> lottery_event (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    start_time DATETIME,
    end_time DATETIME,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'NOT_STARTED'</span>,
    settings JSON COMMENT <span class="hljs-string">'活动配置'</span>
);
</code></pre>
<h3 data-id="heading-7">五、核心功能实现</h3>
<h4 data-id="heading-8">5.1 项目依赖配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 数据库 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 工具类 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>31.1-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- JSON处理 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">5.2 员工实体类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "employee")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-meta">@Column(name = "employee_id", unique = true, nullable = false)</span>
    <span class="hljs-keyword">private</span> String employeeId;
    
    <span class="hljs-meta">@Column(nullable = false)</span>
    <span class="hljs-keyword">private</span> String name;
    
    <span class="hljs-keyword">private</span> String department;
    <span class="hljs-keyword">private</span> String avatarUrl;
    
    <span class="hljs-meta">@Column(name = "is_attended")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">isAttended</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-meta">@CreationTimestamp</span>
    <span class="hljs-meta">@Column(name = "created_time", updatable = false)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
    
    <span class="hljs-meta">@Transient</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">isWinner</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-10">5.3 抽奖服务核心实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LotteryService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> EmployeeRepository employeeRepository;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PrizeRepository prizeRepository;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> WinningRecordRepository winningRecordRepository;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-comment">/**
     * 核心抽奖算法 - 使用加密安全的随机数
     */</span>
    <span class="hljs-keyword">public</span> LotteryResult <span class="hljs-title function_">drawPrize</span><span class="hljs-params">(Long prizeId, String drawMethod)</span> {
        <span class="hljs-type">Prize</span> <span class="hljs-variable">prize</span> <span class="hljs-operator">=</span> prizeRepository.findById(prizeId)
            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"奖品不存在"</span>));
            
        <span class="hljs-keyword">if</span> (prize.getRemainCount() &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"该奖品已抽完"</span>);
        }
        
        <span class="hljs-comment">// 获取所有未中奖的参会员工</span>
        List&lt;Employee&gt; candidates = employeeRepository.findByIsAttendedTrueAndIsWinnerFalse();
        <span class="hljs-keyword">if</span> (candidates.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"没有符合条件的抽奖人员"</span>);
        }
        
        <span class="hljs-comment">// 使用SecureRandom确保随机性</span>
        <span class="hljs-type">SecureRandom</span> <span class="hljs-variable">secureRandom</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandom</span>();
        <span class="hljs-type">byte</span>[] randomBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];
        secureRandom.nextBytes(randomBytes);
        
        <span class="hljs-comment">// 基于哈希值选择中奖者</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> Math.abs(Arrays.hashCode(randomBytes)) % candidates.size();
        <span class="hljs-type">Employee</span> <span class="hljs-variable">winner</span> <span class="hljs-operator">=</span> candidates.get(index);
        
        <span class="hljs-comment">// 保存中奖记录</span>
        <span class="hljs-type">WinningRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WinningRecord</span>();
        record.setEmployeeId(winner.getEmployeeId());
        record.setPrizeId(prizeId);
        record.setDrawMethod(drawMethod);
        record.setDrawTime(LocalDateTime.now());
        winningRecordRepository.save(record);
        
        <span class="hljs-comment">// 更新奖品剩余数量</span>
        prize.setRemainCount(prize.getRemainCount() - <span class="hljs-number">1</span>);
        prizeRepository.save(prize);
        
        <span class="hljs-comment">// 标记员工为中奖状态（实际中可能需要更复杂的逻辑）</span>
        markEmployeeAsWinner(winner.getId());
        
        <span class="hljs-comment">// 发送WebSocket通知</span>
        sendWinningNotification(winner, prize);
        
        <span class="hljs-keyword">return</span> LotteryResult.builder()
                .winner(winner)
                .prize(prize)
                .drawTime(LocalDateTime.now())
                .drawId(record.getId())
                .build();
    }
    
    <span class="hljs-comment">/**
     * 批量导入员工
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importEmployees</span><span class="hljs-params">(MultipartFile file)</span> {
        <span class="hljs-keyword">try</span> {
            List&lt;Employee&gt; employees = parseEmployeeFile(file);
            employeeRepository.saveAll(employees);
            log.info(<span class="hljs-string">"成功导入{}名员工"</span>, employees.size());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"导入员工失败"</span>, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"导入失败: "</span> + e.getMessage());
        }
    }
    
    <span class="hljs-comment">/**
     * 多种抽奖模式
     */</span>
    <span class="hljs-keyword">public</span> LotteryResult <span class="hljs-title function_">drawWithMode</span><span class="hljs-params">(Prize prize, DrawMode mode)</span> {
        <span class="hljs-keyword">switch</span> (mode) {
            <span class="hljs-keyword">case</span> RANDOM:
                <span class="hljs-keyword">return</span> randomDraw(prize);
            <span class="hljs-keyword">case</span> LUCKY_NUMBER:
                <span class="hljs-keyword">return</span> luckyNumberDraw(prize);
            <span class="hljs-keyword">case</span> ROULETTE:
                <span class="hljs-keyword">return</span> rouletteDraw(prize);
            <span class="hljs-keyword">case</span> GRID:
                <span class="hljs-keyword">return</span> gridDraw(prize);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> randomDraw(prize);
        }
    }
    
    <span class="hljs-comment">/**
     * 轮盘抽奖算法
     */</span>
    <span class="hljs-keyword">private</span> LotteryResult <span class="hljs-title function_">rouletteDraw</span><span class="hljs-params">(Prize prize)</span> {
        List&lt;Employee&gt; candidates = getValidCandidates();
        
        <span class="hljs-comment">// 为每个候选人分配权重（这里简单按部门分配不同权重）</span>
        Map&lt;Employee, Double&gt; weights = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (Employee emp : candidates) {
            <span class="hljs-type">double</span> <span class="hljs-variable">weight</span> <span class="hljs-operator">=</span> getDepartmentWeight(emp.getDepartment());
            weights.put(emp, weight);
        }
        
        <span class="hljs-comment">// 轮盘选择</span>
        <span class="hljs-type">Employee</span> <span class="hljs-variable">winner</span> <span class="hljs-operator">=</span> rouletteSelect(weights);
        <span class="hljs-keyword">return</span> createLotteryResult(winner, prize, <span class="hljs-string">"ROULETTE"</span>);
    }
    
    <span class="hljs-keyword">private</span> Employee <span class="hljs-title function_">rouletteSelect</span><span class="hljs-params">(Map&lt;Employee, Double&gt; weights)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">totalWeight</span> <span class="hljs-operator">=</span> weights.values().stream().mapToDouble(Double::doubleValue).sum();
        <span class="hljs-type">double</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> Math.random() * totalWeight;
        
        <span class="hljs-type">double</span> <span class="hljs-variable">cumulativeWeight</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;
        <span class="hljs-keyword">for</span> (Map.Entry&lt;Employee, Double&gt; entry : weights.entrySet()) {
            cumulativeWeight += entry.getValue();
            <span class="hljs-keyword">if</span> (random &lt;= cumulativeWeight) {
                <span class="hljs-keyword">return</span> entry.getKey();
            }
        }
        
        <span class="hljs-keyword">return</span> weights.keySet().iterator().next();
    }
}
</code></pre>
<h4 data-id="heading-11">5.4 WebSocket实时通信</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSocket</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebSocketConfigurer</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerWebSocketHandlers</span><span class="hljs-params">(WebSocketHandlerRegistry registry)</span> {
        registry.addHandler(lotteryWebSocketHandler(), <span class="hljs-string">"/ws/lottery"</span>)
                .setAllowedOrigins(<span class="hljs-string">"*"</span>)
                .withSockJS();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> WebSocketHandler <span class="hljs-title function_">lotteryWebSocketHandler</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LotteryWebSocketHandler</span>();
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LotteryWebSocketHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TextWebSocketHandler</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, WebSocketSession&gt; sessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterConnectionEstablished</span><span class="hljs-params">(WebSocketSession session)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> session.getId();
        sessions.put(sessionId, session);
        
        <span class="hljs-comment">// 发送欢迎消息</span>
        sendMessage(session, <span class="hljs-string">"欢迎加入年会抽奖！"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleTextMessage</span><span class="hljs-params">(WebSocketSession session, TextMessage message)</span> {
        <span class="hljs-comment">// 处理客户端消息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> message.getPayload();
        <span class="hljs-comment">// 处理业务逻辑...</span>
    }
    
    <span class="hljs-comment">/**
     * 广播中奖消息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastWinningMessage</span><span class="hljs-params">(Employee winner, Prize prize)</span> {
        Map&lt;String, Object&gt; message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        message.put(<span class="hljs-string">"type"</span>, <span class="hljs-string">"WINNING_NOTIFICATION"</span>);
        message.put(<span class="hljs-string">"winner"</span>, winner.getName());
        message.put(<span class="hljs-string">"prize"</span>, prize.getName());
        message.put(<span class="hljs-string">"department"</span>, winner.getDepartment());
        message.put(<span class="hljs-string">"time"</span>, LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_TIME));
        
        <span class="hljs-type">String</span> <span class="hljs-variable">jsonMessage</span> <span class="hljs-operator">=</span> JSON.toJSONString(message);
        
        sessions.values().forEach(session -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (session.isOpen()) {
                    session.sendMessage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextMessage</span>(jsonMessage));
                }
            } <span class="hljs-keyword">catch</span> (IOException e) {
                log.error(<span class="hljs-string">"发送WebSocket消息失败"</span>, e);
            }
        });
    }
}
</code></pre>
<h4 data-id="heading-12">5.5 抽奖控制器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Controller</span>
<span class="hljs-meta">@RequestMapping("/lottery")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LotteryController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LotteryService lotteryService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LotteryWebSocketHandler webSocketHandler;
    
    <span class="hljs-comment">/**
     * 抽奖页面
     */</span>
    <span class="hljs-meta">@GetMapping("/draw")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">drawPage</span><span class="hljs-params">(Model model)</span> {
        List&lt;Prize&gt; availablePrizes = lotteryService.getAvailablePrizes();
        List&lt;Employee&gt; attendees = lotteryService.getAttendees();
        
        model.addAttribute(<span class="hljs-string">"prizes"</span>, availablePrizes);
        model.addAttribute(<span class="hljs-string">"attendees"</span>, attendees);
        model.addAttribute(<span class="hljs-string">"totalAttendees"</span>, attendees.size());
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"lottery/draw"</span>;
    }
    
    <span class="hljs-comment">/**
     * 执行抽奖
     */</span>
    <span class="hljs-meta">@PostMapping("/execute")</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;LotteryResult&gt; <span class="hljs-title function_">executeDraw</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam</span> Long prizeId,
            <span class="hljs-meta">@RequestParam(defaultValue = "RANDOM")</span> String mode)</span> {
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">LotteryResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> lotteryService.drawWithMode(prizeId, mode);
            
            <span class="hljs-comment">// 发送实时通知</span>
            webSocketHandler.broadcastWinningMessage(
                result.getWinner(), 
                result.getPrize()
            );
            
            <span class="hljs-keyword">return</span> ApiResponse.success(result);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> ApiResponse.error(e.getMessage());
        }
    }
    
    <span class="hljs-comment">/**
     * 大屏幕显示
     */</span>
    <span class="hljs-meta">@GetMapping("/screen")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">bigScreen</span><span class="hljs-params">(Model model)</span> {
        List&lt;WinningRecord&gt; recentWinners = lotteryService.getRecentWinners(<span class="hljs-number">10</span>);
        model.addAttribute(<span class="hljs-string">"winners"</span>, recentWinners);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"lottery/screen"</span>;
    }
    
    <span class="hljs-comment">/**
     * 数据统计
     */</span>
    <span class="hljs-meta">@GetMapping("/statistics")</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;Statistics&gt; <span class="hljs-title function_">getStatistics</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Statistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> lotteryService.getLotteryStatistics();
        <span class="hljs-keyword">return</span> ApiResponse.success(stats);
    }
}
</code></pre>
<h4 data-id="heading-13">5.6 前端抽奖页面实现</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">"http://www.thymeleaf.org"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>年会抽奖系统<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Bootstrap CSS --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-class">.lottery-container</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
        }
        
        <span class="hljs-selector-class">.prize-card</span> {
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
            <span class="hljs-attribute">cursor</span>: pointer;
        }
        
        <span class="hljs-selector-class">.prize-card</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);
        }
        
        <span class="hljs-selector-class">.lottery-wheel</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
        }
        
        <span class="hljs-selector-class">.wheel-canvas</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
        }
        
        <span class="hljs-selector-class">.winner-display</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.9</span>);
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">animation</span>: slideIn <span class="hljs-number">0.5s</span> ease;
        }
        
        <span class="hljs-keyword">@keyframes</span> slideIn {
            <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">50px</span>); <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
            <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>); <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
        }
        
        <span class="hljs-selector-class">.confetti</span> {
            <span class="hljs-attribute">position</span>: fixed;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f00</span>;
            <span class="hljs-attribute">top</span>: -<span class="hljs-number">10px</span>;
            <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-keyword">@keyframes</span> confetti-fall {
            <span class="hljs-number">0%</span> { <span class="hljs-attribute">top</span>: -<span class="hljs-number">10px</span>; <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
            <span class="hljs-number">100%</span> { <span class="hljs-attribute">top</span>: <span class="hljs-number">100vh</span>; <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lottery-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 标题区域 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-center text-white mb-5"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"display-3 fw-bold"</span>&gt;</span>🎉 年会幸运大抽奖 🎉<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lead"</span>&gt;</span>梦想成真，幸运降临<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-comment">&lt;!-- 抽奖主区域 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 左侧：奖品选择 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-header bg-primary text-white"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-0"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-gift"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 奖品列表<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"prizeList"</span>&gt;</span>
                            <span class="hljs-comment">&lt;!-- 奖品列表动态加载 --&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    
                    <span class="hljs-comment">&lt;!-- 抽奖控制 --&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card mt-3"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-3"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-label"</span>&gt;</span>抽奖模式<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-select"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"drawMode"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"RANDOM"</span>&gt;</span>随机抽奖<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"ROULETTE"</span>&gt;</span>幸运轮盘<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"GRID"</span>&gt;</span>九宫格抽奖<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"LUCKY_NUMBER"</span>&gt;</span>幸运数字<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-danger btn-lg w-100"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"drawButton"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-play"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 开始抽奖
                            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                
                <span class="hljs-comment">&lt;!-- 中间：抽奖动画 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lottery-wheel"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wheelCanvas"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"wheel-canvas"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-center mt-3"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"winner-display"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"winnerDisplay"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none;"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">h4</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-success"</span>&gt;</span>🎊 恭喜中奖！ 🎊<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"winnerName"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fw-bold"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>获得：<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"prizeName"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-primary"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                
                <span class="hljs-comment">&lt;!-- 右侧：中奖名单 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-md-4"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-header bg-success text-white"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-0"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-trophy"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 中奖名单<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"winnerList"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list-group"</span>&gt;</span>
                                <span class="hljs-comment">&lt;!-- 中奖名单动态加载 --&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    
                    <span class="hljs-comment">&lt;!-- 统计数据 --&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card mt-3"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>抽奖统计<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row text-center"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-6"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"display-6"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"totalAttendees"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>参会人数<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-6"</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"display-6"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"totalWinners"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>已中奖人数<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- WebSocket连接 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/stomp.js/2.3.3/stomp.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">LotterySystem</span> {
            <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">stompClient</span> = <span class="hljs-literal">null</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPrizeId</span> = <span class="hljs-literal">null</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">false</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
            }
            
            <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadPrizes</span>();
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadWinners</span>();
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadStatistics</span>();
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">connectWebSocket</span>();
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindEvents</span>();
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWheel</span>();
            }
            
            <span class="hljs-title function_">connectWebSocket</span>(<span class="hljs-params"/>) {
                <span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SockJS</span>(<span class="hljs-string">'/ws/lottery'</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">stompClient</span> = <span class="hljs-title class_">Stomp</span>.<span class="hljs-title function_">over</span>(socket);
                
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">stompClient</span>.<span class="hljs-title function_">connect</span>({}, <span class="hljs-function">(<span class="hljs-params">frame</span>) =&gt;</span> {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Connected: '</span> + frame);
                    
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stompClient</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'/topic/winners'</span>, <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
                        <span class="hljs-keyword">const</span> notification = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message.<span class="hljs-property">body</span>);
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showWinningNotification</span>(notification);
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadWinners</span>();
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadStatistics</span>();
                    });
                });
            }
            
            <span class="hljs-title function_">loadPrizes</span>(<span class="hljs-params"/>) {
                $.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/lottery/prizes'</span>, <span class="hljs-function">(<span class="hljs-params">prizes</span>) =&gt;</span> {
                    <span class="hljs-keyword">const</span> container = $(<span class="hljs-string">'#prizeList'</span>);
                    container.<span class="hljs-title function_">empty</span>();
                    
                    prizes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prize</span> =&gt;</span> {
                        <span class="hljs-keyword">const</span> card = <span class="hljs-string">`
                            &lt;div class="card prize-card mb-2" data-prize-id="<span class="hljs-subst">${prize.id}</span>"&gt;
                                &lt;div class="card-body"&gt;
                                    &lt;h6 class="card-title"&gt;<span class="hljs-subst">${prize.name}</span>&lt;/h6&gt;
                                    &lt;p class="card-text text-muted small"&gt;剩余: <span class="hljs-subst">${prize.remainCount}</span>/<span class="hljs-subst">${prize.totalCount}</span>&lt;/p&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        `</span>;
                        container.<span class="hljs-title function_">append</span>(card);
                    });
                    
                    <span class="hljs-comment">// 绑定选择事件</span>
                    $(<span class="hljs-string">'.prize-card'</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
                        $(<span class="hljs-string">'.prize-card'</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">'border-primary'</span>);
                        $(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">'border-primary border-3'</span>);
                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPrizeId</span> = $(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">data</span>(<span class="hljs-string">'prize-id'</span>);
                    });
                });
            }
            
            <span class="hljs-title function_">loadWinners</span>(<span class="hljs-params"/>) {
                $.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/lottery/recent-winners'</span>, <span class="hljs-function">(<span class="hljs-params">winners</span>) =&gt;</span> {
                    <span class="hljs-keyword">const</span> container = $(<span class="hljs-string">'#winnerList'</span>);
                    container.<span class="hljs-title function_">empty</span>();
                    
                    winners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">record</span> =&gt;</span> {
                        <span class="hljs-keyword">const</span> item = <span class="hljs-string">`
                            &lt;div class="list-group-item"&gt;
                                &lt;div class="d-flex w-100 justify-content-between"&gt;
                                    &lt;h6 class="mb-1"&gt;<span class="hljs-subst">${record.employeeName}</span>&lt;/h6&gt;
                                    &lt;small&gt;<span class="hljs-subst">${record.department}</span>&lt;/small&gt;
                                &lt;/div&gt;
                                &lt;p class="mb-1"&gt;<span class="hljs-subst">${record.prizeName}</span>&lt;/p&gt;
                                &lt;small class="text-muted"&gt;<span class="hljs-subst">${record.drawTime}</span>&lt;/small&gt;
                            &lt;/div&gt;
                        `</span>;
                        container.<span class="hljs-title function_">prepend</span>(item);
                    });
                });
            }
            
            <span class="hljs-title function_">loadStatistics</span>(<span class="hljs-params"/>) {
                $.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/lottery/statistics'</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {
                    $(<span class="hljs-string">'#totalAttendees'</span>).<span class="hljs-title function_">text</span>(stats.<span class="hljs-property">totalAttendees</span>);
                    $(<span class="hljs-string">'#totalWinners'</span>).<span class="hljs-title function_">text</span>(stats.<span class="hljs-property">totalWinners</span>);
                });
            }
            
            <span class="hljs-title function_">bindEvents</span>(<span class="hljs-params"/>) {
                $(<span class="hljs-string">'#drawButton'</span>).<span class="hljs-title function_">click</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPrizeId</span>) {
                        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请先选择奖品！'</span>);
                        <span class="hljs-keyword">return</span>;
                    }
                    
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span>) {
                        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'正在抽奖中，请稍候...'</span>);
                        <span class="hljs-keyword">return</span>;
                    }
                    
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">true</span>;
                    $(<span class="hljs-string">'#drawButton'</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">true</span>).<span class="hljs-title function_">html</span>(<span class="hljs-string">'&lt;i class="fas fa-spinner fa-spin"&gt;&lt;/i&gt; 抽奖中...'</span>);
                    
                    <span class="hljs-keyword">const</span> drawMode = $(<span class="hljs-string">'#drawMode'</span>).<span class="hljs-title function_">val</span>();
                    
                    <span class="hljs-comment">// 开始抽奖动画</span>
                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startWheelAnimation</span>();
                    
                    <span class="hljs-comment">// 发送抽奖请求</span>
                    $.<span class="hljs-title function_">ajax</span>({
                        <span class="hljs-attr">url</span>: <span class="hljs-string">'/lottery/execute'</span>,
                        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
                        <span class="hljs-attr">data</span>: {
                            <span class="hljs-attr">prizeId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPrizeId</span>,
                            <span class="hljs-attr">mode</span>: drawMode
                        },
                        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
                            <span class="hljs-keyword">if</span> (response.<span class="hljs-property">success</span>) {
                                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showWinner</span>(response.<span class="hljs-property">data</span>);
                                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createConfetti</span>();
                                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">false</span>;
                                    $(<span class="hljs-string">'#drawButton'</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">false</span>).<span class="hljs-title function_">html</span>(<span class="hljs-string">'&lt;i class="fas fa-play"&gt;&lt;/i&gt; 开始抽奖'</span>);
                                }, <span class="hljs-number">3000</span>);
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-title function_">alert</span>(response.<span class="hljs-property">message</span>);
                                <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">false</span>;
                                $(<span class="hljs-string">'#drawButton'</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">false</span>).<span class="hljs-title function_">html</span>(<span class="hljs-string">'&lt;i class="fas fa-play"&gt;&lt;/i&gt; 开始抽奖'</span>);
                            }
                        },
                        <span class="hljs-attr">error</span>: <span class="hljs-function">() =&gt;</span> {
                            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'抽奖失败，请重试！'</span>);
                            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">false</span>;
                            $(<span class="hljs-string">'#drawButton'</span>).<span class="hljs-title function_">prop</span>(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">false</span>).<span class="hljs-title function_">html</span>(<span class="hljs-string">'&lt;i class="fas fa-play"&gt;&lt;/i&gt; 开始抽奖'</span>);
                        }
                    });
                });
            }
            
            <span class="hljs-title function_">startWheelAnimation</span>(<span class="hljs-params"/>) {
                <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wheelCanvas'</span>);
                <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
                <span class="hljs-keyword">const</span> centerX = canvas.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>;
                <span class="hljs-keyword">const</span> centerY = canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>;
                <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(centerX, centerY) - <span class="hljs-number">10</span>;
                
                <span class="hljs-keyword">let</span> rotation = <span class="hljs-number">0</span>;
                
                <span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
                    ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
                    
                    <span class="hljs-comment">// 绘制转盘</span>
                    rotation += <span class="hljs-number">0.1</span>;
                    
                    <span class="hljs-comment">// 绘制扇形</span>
                    <span class="hljs-keyword">const</span> segments = <span class="hljs-number">12</span>;
                    <span class="hljs-keyword">const</span> segmentAngle = (<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / segments;
                    
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; segments; i++) {
                        <span class="hljs-keyword">const</span> startAngle = segmentAngle * i + rotation;
                        <span class="hljs-keyword">const</span> endAngle = segmentAngle * (i + <span class="hljs-number">1</span>) + rotation;
                        
                        ctx.<span class="hljs-title function_">beginPath</span>();
                        ctx.<span class="hljs-title function_">moveTo</span>(centerX, centerY);
                        ctx.<span class="hljs-title function_">arc</span>(centerX, centerY, radius, startAngle, endAngle);
                        ctx.<span class="hljs-title function_">closePath</span>();
                        
                        <span class="hljs-comment">// 交替颜色</span>
                        ctx.<span class="hljs-property">fillStyle</span> = i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'#FF6B6B'</span> : <span class="hljs-string">'#4ECDC4'</span>;
                        ctx.<span class="hljs-title function_">fill</span>();
                        
                        <span class="hljs-comment">// 绘制文字</span>
                        ctx.<span class="hljs-title function_">save</span>();
                        ctx.<span class="hljs-title function_">translate</span>(centerX, centerY);
                        ctx.<span class="hljs-title function_">rotate</span>(startAngle + segmentAngle / <span class="hljs-number">2</span>);
                        ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'right'</span>;
                        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'white'</span>;
                        ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'bold 14px Arial'</span>;
                        ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'幸运'</span>, radius - <span class="hljs-number">20</span>, <span class="hljs-number">10</span>);
                        ctx.<span class="hljs-title function_">restore</span>();
                    }
                    
                    <span class="hljs-comment">// 绘制指针</span>
                    ctx.<span class="hljs-title function_">beginPath</span>();
                    ctx.<span class="hljs-title function_">moveTo</span>(centerX, centerY - <span class="hljs-number">20</span>);
                    ctx.<span class="hljs-title function_">lineTo</span>(centerX, centerY - radius + <span class="hljs-number">20</span>);
                    ctx.<span class="hljs-title function_">lineTo</span>(centerX + <span class="hljs-number">10</span>, centerY - radius);
                    ctx.<span class="hljs-title function_">lineTo</span>(centerX - <span class="hljs-number">10</span>, centerY - radius);
                    ctx.<span class="hljs-title function_">closePath</span>();
                    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#FFD93D'</span>;
                    ctx.<span class="hljs-title function_">fill</span>();
                    
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span>) {
                        <span class="hljs-title function_">requestAnimationFrame</span>(animate);
                    }
                };
                
                canvas.<span class="hljs-property">width</span> = <span class="hljs-number">500</span>;
                canvas.<span class="hljs-property">height</span> = <span class="hljs-number">500</span>;
                <span class="hljs-title function_">animate</span>();
            }
            
            <span class="hljs-title function_">showWinner</span>(<span class="hljs-params">result</span>) {
                $(<span class="hljs-string">'#winnerName'</span>).<span class="hljs-title function_">text</span>(result.<span class="hljs-property">winner</span>.<span class="hljs-property">name</span>);
                $(<span class="hljs-string">'#prizeName'</span>).<span class="hljs-title function_">text</span>(result.<span class="hljs-property">prize</span>.<span class="hljs-property">name</span>);
                $(<span class="hljs-string">'#winnerDisplay'</span>).<span class="hljs-title function_">fadeIn</span>();
                
                <span class="hljs-comment">// 播放音效</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">playSound</span>(<span class="hljs-string">'winning'</span>);
            }
            
            <span class="hljs-title function_">showWinningNotification</span>(<span class="hljs-params">notification</span>) {
                <span class="hljs-comment">// 显示实时通知</span>
                <span class="hljs-keyword">const</span> notificationHtml = <span class="hljs-string">`
                    &lt;div class="toast show" role="alert"&gt;
                        &lt;div class="toast-header bg-success text-white"&gt;
                            &lt;strong class="me-auto"&gt;🎉 恭喜中奖！&lt;/strong&gt;
                            &lt;small&gt;刚刚&lt;/small&gt;
                        &lt;/div&gt;
                        &lt;div class="toast-body"&gt;
                            &lt;strong&gt;<span class="hljs-subst">${notification.winner}</span>&lt;/strong&gt; 获得 &lt;strong&gt;<span class="hljs-subst">${notification.prize}</span>&lt;/strong&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                `</span>;
                
                $(<span class="hljs-string">'.toast-container'</span>).<span class="hljs-title function_">remove</span>();
                $(<span class="hljs-string">'body'</span>).<span class="hljs-title function_">append</span>(<span class="hljs-string">`&lt;div class="toast-container position-fixed top-0 end-0 p-3"&gt;<span class="hljs-subst">${notificationHtml}</span>&lt;/div&gt;`</span>);
                
                <span class="hljs-comment">// 5秒后自动移除</span>
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                    $(<span class="hljs-string">'.toast-container'</span>).<span class="hljs-title function_">remove</span>();
                }, <span class="hljs-number">5000</span>);
            }
            
            <span class="hljs-title function_">createConfetti</span>(<span class="hljs-params"/>) {
                <span class="hljs-keyword">const</span> colors = [<span class="hljs-string">'#FF6B6B'</span>, <span class="hljs-string">'#4ECDC4'</span>, <span class="hljs-string">'#FFD93D'</span>, <span class="hljs-string">'#6BCF7F'</span>];
                
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
                    <span class="hljs-keyword">const</span> confetti = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
                    confetti.<span class="hljs-property">className</span> = <span class="hljs-string">'confetti'</span>;
                    confetti.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span> + <span class="hljs-string">'vw'</span>;
                    confetti.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> = colors[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * colors.<span class="hljs-property">length</span>)];
                    confetti.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">10</span> + <span class="hljs-number">5</span> + <span class="hljs-string">'px'</span>;
                    confetti.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">10</span> + <span class="hljs-number">5</span> + <span class="hljs-string">'px'</span>;
                    confetti.<span class="hljs-property">style</span>.<span class="hljs-property">animation</span> = <span class="hljs-string">`confetti-fall <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">3</span> + <span class="hljs-number">2</span>}</span>s linear forwards`</span>;
                    confetti.<span class="hljs-property">style</span>.<span class="hljs-property">animationDelay</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1</span> + <span class="hljs-string">'s'</span>;
                    
                    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(confetti);
                    
                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                        confetti.<span class="hljs-title function_">remove</span>();
                    }, <span class="hljs-number">5000</span>);
                }
            }
            
            <span class="hljs-title function_">playSound</span>(<span class="hljs-params">type</span>) {
                <span class="hljs-keyword">const</span> audio = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Audio</span>();
                <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'winning'</span>) {
                    audio.<span class="hljs-property">src</span> = <span class="hljs-string">'/sound/winning.mp3'</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'draw'</span>) {
                    audio.<span class="hljs-property">src</span> = <span class="hljs-string">'/sound/draw.mp3'</span>;
                }
                audio.<span class="hljs-title function_">play</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'音频播放失败:'</span>, e));
            }
            
            <span class="hljs-title function_">initWheel</span>(<span class="hljs-params"/>) {
                <span class="hljs-comment">// 初始化抽奖转盘</span>
                <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wheelCanvas'</span>);
                <span class="hljs-keyword">if</span> (canvas.<span class="hljs-property">getContext</span>) {
                    <span class="hljs-comment">// 已经在上面的startWheelAnimation中初始化了</span>
                }
            }
        }
        
        <span class="hljs-comment">// 页面加载完成后初始化</span>
        $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">lotterySystem</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LotterySystem</span>();
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">六、系统特色功能</h3>
<h4 data-id="heading-15">6.1 多种抽奖模式</h4>
<ol>
<li><strong>随机抽奖</strong>：完全随机，确保公平</li>
<li><strong>幸运轮盘</strong>：视觉冲击力强，增加趣味性</li>
<li><strong>九宫格抽奖</strong>：互动性强，适合小团队</li>
<li><strong>幸运数字</strong>：与员工工号关联，增加参与感</li>
</ol>
<h4 data-id="heading-16">6.2 实时互动功能</h4>
<ul>
<li><strong>WebSocket实时通知</strong>：中奖结果实时推送到所有客户端</li>
<li><strong>大屏幕显示</strong>：专门为中奖展示设计的全屏界面</li>
<li><strong>弹幕互动</strong>：员工可以发送祝福弹幕</li>
<li><strong>倒计时功能</strong>：增加紧张氛围</li>
</ul>
<h4 data-id="heading-17">6.3 防作弊机制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LotterySecurityService</span> {
    
    <span class="hljs-comment">/**
     * 验证抽奖请求的合法性
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateDrawRequest</span><span class="hljs-params">(String sessionId, Long prizeId)</span> {
        <span class="hljs-comment">// 防止频繁请求</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"draw:limit:"</span> + sessionId;
        <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().increment(key, <span class="hljs-number">1</span>);
        
        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">1</span>) {
            redisTemplate.expire(key, <span class="hljs-number">10</span>, TimeUnit.SECONDS);
        }
        
        <span class="hljs-keyword">return</span> count &lt;= <span class="hljs-number">3</span>; <span class="hljs-comment">// 10秒内最多请求3次</span>
    }
    
    <span class="hljs-comment">/**
     * 验证员工资格
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateEmployeeEligibility</span><span class="hljs-params">(String employeeId)</span> {
        <span class="hljs-comment">// 检查是否已签到</span>
        <span class="hljs-comment">// 检查是否已中奖（限制每人最多中奖次数）</span>
        <span class="hljs-comment">// 检查是否符合特定奖品要求</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">/**
     * 生成抽奖过程审计日志
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">auditDrawProcess</span><span class="hljs-params">(LotteryResult result, String operator)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">auditLog</span> <span class="hljs-operator">=</span> String.format(
            <span class="hljs-string">"抽奖审计 - 操作人:%s, 奖品:%s, 中奖人:%s, 时间:%s, 随机种子:%s"</span>,
            operator,
            result.getPrize().getName(),
            result.getWinner().getName(),
            LocalDateTime.now(),
            generateRandomSeed()
        );
        
        log.info(auditLog);
        saveToBlockchain(auditLog); <span class="hljs-comment">// 可选：保存到区块链确保不可篡改</span>
    }
}
</code></pre>
<h4 data-id="heading-18">6.4 数据统计与分析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StatisticsService</span> {
    
    <span class="hljs-keyword">public</span> LotteryStatistics <span class="hljs-title function_">getStatistics</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LotteryStatistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LotteryStatistics</span>();
        
        <span class="hljs-comment">// 基础统计</span>
        stats.setTotalAttendees(employeeRepository.countByIsAttendedTrue());
        stats.setTotalWinners(winningRecordRepository.count());
        stats.setTotalPrizes(prizeRepository.count());
        
        <span class="hljs-comment">// 部门中奖分布</span>
        Map&lt;String, Long&gt; deptDistribution = winningRecordRepository
            .getDepartmentDistribution();
        stats.setDepartmentDistribution(deptDistribution);
        
        <span class="hljs-comment">// 时间段分析</span>
        List&lt;HourlyDraw&gt; hourlyDraws = winningRecordRepository
            .getHourlyDrawCount();
        stats.setHourlyDraws(hourlyDraws);
        
        <span class="hljs-comment">// 奖品热度</span>
        List&lt;PrizePopularity&gt; prizePopularity = winningRecordRepository
            .getPrizePopularity();
        stats.setPrizePopularity(prizePopularity);
        
        <span class="hljs-keyword">return</span> stats;
    }
    
    <span class="hljs-comment">/**
     * 生成抽奖报告
     */</span>
    <span class="hljs-keyword">public</span> Report <span class="hljs-title function_">generateReport</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Report</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Report</span>();
        
        <span class="hljs-comment">// 总体情况</span>
        report.setSummary(getSummary());
        
        <span class="hljs-comment">// 详细数据</span>
        report.setDetails(getDetailedData());
        
        <span class="hljs-comment">// 图表数据</span>
        report.setCharts(getChartData());
        
        <span class="hljs-comment">// 分析结论</span>
        report.setAnalysis(getAnalysis());
        
        <span class="hljs-keyword">return</span> report;
    }
}
</code></pre>
<h3 data-id="heading-19">七、部署与配置</h3>
<h4 data-id="heading-20">7.1 应用配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/lottery_db?useSSL=false&amp;serverTimezone=UTC</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">lottery_admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">lottery_password</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    
  <span class="hljs-attr">jpa:</span>
    <span class="hljs-attr">hibernate:</span>
      <span class="hljs-attr">ddl-auto:</span> <span class="hljs-string">update</span>
    <span class="hljs-attr">show-sql:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">properties:</span>
      <span class="hljs-attr">hibernate:</span>
        <span class="hljs-attr">format_sql:</span> <span class="hljs-literal">true</span>
        
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">password:</span> 
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">5000ms</span>
    
  <span class="hljs-attr">thymeleaf:</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">mode:</span> <span class="hljs-string">HTML</span>
    <span class="hljs-attr">encoding:</span> <span class="hljs-string">UTF-8</span>
    
<span class="hljs-attr">lottery:</span>
  <span class="hljs-attr">security:</span>
    <span class="hljs-attr">admin-username:</span> <span class="hljs-string">admin</span>
    <span class="hljs-attr">admin-password:</span> <span class="hljs-string">${ADMIN_PASSWORD:admin123}</span>
    <span class="hljs-attr">jwt-secret:</span> <span class="hljs-string">${JWT_SECRET:lottery-secret-key}</span>
    
  <span class="hljs-attr">draw:</span>
    <span class="hljs-attr">max-attempts-per-minute:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">cooldown-seconds:</span> <span class="hljs-number">5</span>
    
  <span class="hljs-attr">ui:</span>
    <span class="hljs-attr">title:</span> <span class="hljs-string">年会幸运大抽奖</span>
    <span class="hljs-attr">theme:</span> <span class="hljs-string">gradient-blue</span>
    <span class="hljs-attr">animation-enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
<h4 data-id="heading-21">7.2 Docker部署</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># Dockerfile
FROM openjdk:11-jre-slim

WORKDIR /app

COPY target/lottery-system-1.0.0.jar app.jar

RUN mkdir -p /app/logs /app/uploads

ENV TZ=Asia/Shanghai
ENV JAVA_OPTS="-Xmx512m -Xms256m"

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.yml</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root_password</span>
      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">lottery_db</span>
      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">lottery_admin</span>
      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">lottery_password</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql_data:/var/lib/mysql</span>
      
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>
      
  <span class="hljs-attr">lottery-app:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">SPRING_DATASOURCE_URL:</span> <span class="hljs-string">jdbc:mysql://mysql:3306/lottery_db</span>
      <span class="hljs-attr">SPRING_REDIS_HOST:</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
      
<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">mysql_data:</span>
  <span class="hljs-attr">redis_data:</span>
</code></pre>
<h3 data-id="heading-22">八、系统优化与扩展</h3>
<h4 data-id="heading-23">8.1 性能优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LotteryOptimizationService</span> {
    
    <span class="hljs-comment">/**
     * 使用Redis缓存热门数据
     */</span>
    <span class="hljs-meta">@Cacheable(value = "prizes", key = "'available'")</span>
    <span class="hljs-keyword">public</span> List&lt;Prize&gt; <span class="hljs-title function_">getAvailablePrizes</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> prizeRepository.findByRemainCountGreaterThan(<span class="hljs-number">0</span>);
    }
    
    <span class="hljs-comment">/**
     * 批量处理优化
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchProcessWinners</span><span class="hljs-params">(List&lt;Long&gt; winnerIds, Long prizeId)</span> {
        <span class="hljs-comment">// 使用批量插入提高性能</span>
        List&lt;WinningRecord&gt; records = winnerIds.stream()
            .map(employeeId -&gt; {
                <span class="hljs-type">WinningRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WinningRecord</span>();
                record.setEmployeeId(employeeId.toString());
                record.setPrizeId(prizeId);
                <span class="hljs-keyword">return</span> record;
            })
            .collect(Collectors.toList());
            
        winningRecordRepository.saveAll(records);
    }
    
    <span class="hljs-comment">/**
     * 异步处理非核心业务
     */</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncSendNotification</span><span class="hljs-params">(WinningRecord record)</span> {
        <span class="hljs-comment">// 发送邮件通知</span>
        emailService.sendWinningEmail(record);
        
        <span class="hljs-comment">// 发送短信通知</span>
        smsService.sendWinningSMS(record);
        
        <span class="hljs-comment">// 记录日志</span>
        auditService.logWinningEvent(record);
    }
}
</code></pre>
<h4 data-id="heading-24">8.2 扩展功能</h4>
<ol>
<li><strong>微信小程序接入</strong>：员工扫码参与</li>
<li><strong>人脸识别签到</strong>：防止代签</li>
<li><strong>虚拟礼物系统</strong>：员工互送祝福</li>
<li><strong>抽奖策略引擎</strong>：可配置的抽奖规则</li>
<li><strong>多会场支持</strong>：分布式抽奖同步</li>
</ol>
<h3 data-id="heading-25">九、测试与验证</h3>
<h4 data-id="heading-26">9.1 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@AutoConfigureMockMvc</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LotteryServiceTest</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRandomDraw</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试随机抽奖的公平性</span>
        Map&lt;Long, Integer&gt; winCount = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-type">int</span> <span class="hljs-variable">totalTests</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; totalTests; i++) {
            <span class="hljs-type">LotteryResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> lotteryService.drawPrize(<span class="hljs-number">1L</span>, <span class="hljs-string">"RANDOM"</span>);
            <span class="hljs-type">Long</span> <span class="hljs-variable">winnerId</span> <span class="hljs-operator">=</span> result.getWinner().getId();
            winCount.put(winnerId, winCount.getOrDefault(winnerId, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>);
        }
        
        <span class="hljs-comment">// 验证分布是否均匀</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">expectedFrequency</span> <span class="hljs-operator">=</span> totalTests / <span class="hljs-number">100.0</span>; <span class="hljs-comment">// 假设有100个候选人</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">chiSquare</span> <span class="hljs-operator">=</span> calculateChiSquare(winCount, expectedFrequency);
        
        assertTrue(chiSquare &lt; <span class="hljs-number">15.0</span>, <span class="hljs-string">"抽奖分布不均匀"</span>);
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConcurrentDraw</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-comment">// 测试并发抽奖</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(threadCount);
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(threadCount);
        
        List&lt;Future&lt;LotteryResult&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threadCount; i++) {
            Future&lt;LotteryResult&gt; future = executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> lotteryService.drawPrize(<span class="hljs-number">1L</span>, <span class="hljs-string">"RANDOM"</span>);
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown();
                }
            });
            futures.add(future);
        }
        
        latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
        
        <span class="hljs-comment">// 验证没有重复中奖</span>
        Set&lt;Long&gt; winnerIds = futures.stream()
            .map(f -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> f.get().getWinner().getId();
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                }
            })
            .filter(Objects::nonNull)
            .collect(Collectors.toSet());
            
        assertEquals(threadCount, winnerIds.size(), <span class="hljs-string">"存在重复中奖情况"</span>);
    }
}
</code></pre>
<h3 data-id="heading-27">十、总结</h3>
<p>本文详细介绍了如何使用SpringBoot + Java构建一个公正、有趣、好玩的年会抽奖系统。系统具有以下特点：</p>
<ol>
<li><strong>公正性保障</strong>：使用加密安全的随机数生成算法，所有操作都有审计日志</li>
<li><strong>趣味性体验</strong>：多种抽奖模式，炫酷的动画效果，实时互动功能</li>
<li><strong>高可靠性</strong>：支持高并发，数据持久化，完善的错误处理机制</li>
<li><strong>易于扩展</strong>：模块化设计，方便添加新功能和抽奖模式</li>
<li><strong>部署简单</strong>：支持Docker容器化部署，一键启动</li>
</ol>
<p>系统不仅满足了基本的抽奖需求，还通过WebSocket实时通信、多种抽奖模式、数据统计分析等功能，大大提升了年会的互动性和趣味性。企业可以根据自身需求，进一步扩展功能，如集成企业微信、添加更多互动游戏等，打造独一无二的年会抽奖体验。</p>
<p>通过本系统的实施，企业可以确保抽奖活动的公平公正，同时提升员工的参与感和满意度，为年会增添更多欢乐和惊喜。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[版本更新与缓存清除]]></title>    <link>https://juejin.cn/post/7603261102794719258</link>    <guid>https://juejin.cn/post/7603261102794719258</guid>    <pubDate>2026-02-06T02:45:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603261102794719258" data-draft-id="7599630795804491822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="版本更新与缓存清除"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T02:45:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="耀耀切克闹灬"/> <meta itemprop="url" content="https://juejin.cn/user/1781681116679854"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            版本更新与缓存清除
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1781681116679854/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    耀耀切克闹灬
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:45:02.000Z" title="Fri Feb 06 2026 02:45:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>update-version.js</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@FileDesc</span>: 部署前自动更新版本号脚本
 * <span class="hljs-doctag">@Usage</span>: 在package.json的build脚本中调用
 * 例如: "build": "node scripts/update-version.js &amp;&amp; vite build"
 */</span>
#!<span class="hljs-regexp">/usr/</span>bin/env node

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@FileDesc</span>: 部署前自动更新版本号脚本
 * <span class="hljs-doctag">@Usage</span>: 在package.json的build脚本中调用
 * 例如: "build": "node scripts/update-version.js &amp;&amp; vite build"
 */</span>

<span class="hljs-keyword">import</span> { readFileSync, writeFileSync, existsSync, mkdirSync } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>
<span class="hljs-keyword">import</span> { resolve, join } <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">"url"</span>

<span class="hljs-comment">// 获取当前文件的目录</span>
<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)
<span class="hljs-keyword">const</span> __dirname = <span class="hljs-title function_">resolve</span>(__filename, <span class="hljs-string">".."</span>)

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 获取项目根目录</span>
    <span class="hljs-keyword">const</span> projectRoot = <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"../"</span>)
    <span class="hljs-keyword">const</span> packageJsonPath = <span class="hljs-title function_">join</span>(projectRoot, <span class="hljs-string">"package.json"</span>)
    <span class="hljs-keyword">const</span> versionJsonPath = <span class="hljs-title function_">join</span>(projectRoot, <span class="hljs-string">"public/version.json"</span>)

    <span class="hljs-comment">// 确保 public 目录存在</span>
    <span class="hljs-keyword">const</span> publicDir = <span class="hljs-title function_">join</span>(projectRoot, <span class="hljs-string">"public"</span>)
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">existsSync</span>(publicDir)) {
        <span class="hljs-title function_">mkdirSync</span>(publicDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> })
    }

    <span class="hljs-comment">// 从 package.json 获取版本号</span>
    <span class="hljs-keyword">const</span> packageJsonContent = <span class="hljs-title function_">readFileSync</span>(packageJsonPath, <span class="hljs-string">"utf-8"</span>)
    <span class="hljs-keyword">const</span> packageJson = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(packageJsonContent)
    <span class="hljs-keyword">const</span> version = packageJson.<span class="hljs-property">version</span> || <span class="hljs-string">"1.0.0"</span>

    <span class="hljs-comment">// 获取当前时间（ISO 8601格式）</span>
    <span class="hljs-keyword">const</span> buildTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()

    <span class="hljs-comment">// 创建 version.json 内容</span>
    <span class="hljs-keyword">const</span> versionInfo = {
        version,
        buildTime
    }

    <span class="hljs-comment">// 写入 version.json 文件</span>
    <span class="hljs-title function_">writeFileSync</span>(versionJsonPath, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(versionInfo, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 版本文件已更新:"</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   版本号: <span class="hljs-subst">${version}</span>`</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   构建时间: <span class="hljs-subst">${buildTime}</span>`</span>)
} <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"❌ 版本文件更新失败:"</span>, error.<span class="hljs-property">message</span>)
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>)
}

</code></pre>
<p>version.ts</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/*
 * @FileDesc: 版本管理和更新检测工具
 */</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Toast</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd-mobile"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dialog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd-mobile"</span>

<span class="hljs-comment">/** 声明全局变量 */</span>
declare <span class="hljs-keyword">const</span> <span class="hljs-attr">__BUILD_TIME__</span>: string | <span class="hljs-literal">undefined</span>

<span class="hljs-comment">/** 版本检查相关常量 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span> = {
    <span class="hljs-comment">// 版本检查的localStorage key - 存储 buildTime，用于检测更新</span>
    <span class="hljs-attr">STORAGE_KEY_VERSION</span>: <span class="hljs-string">"APP_BUILD_TIME"</span>,
    <span class="hljs-comment">// 版本检查间隔（毫秒），5分钟检查一次</span>
    <span class="hljs-attr">CHECK_INTERVAL</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,
    <span class="hljs-comment">// 版本API接口</span>
    <span class="hljs-attr">VERSION_URL</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">import</span>.meta.env.VITE_BASE_PATH || <span class="hljs-string">"/"</span>}</span>version.json`</span>
}

<span class="hljs-comment">/** 版本信息接口 */</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">IVersionInfo</span> {
    <span class="hljs-attr">version</span>: string
    <span class="hljs-attr">buildTime</span>: string
}

<span class="hljs-comment">/**
 * 获取当前应用版本
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getCurrentVersion = (): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> buildTime = <span class="hljs-keyword">typeof</span> __BUILD_TIME__ !== <span class="hljs-string">"undefined"</span> ? __BUILD_TIME__ : <span class="hljs-string">""</span>
    <span class="hljs-keyword">return</span> buildTime || <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>) || <span class="hljs-string">"0.0.0"</span>
}

<span class="hljs-comment">/**
 * 获取远端版本信息
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchRemoteVersion = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">IVersionInfo</span> | <span class="hljs-literal">null</span>&gt; =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">VERSION_URL</span>, {
            <span class="hljs-attr">cache</span>: <span class="hljs-string">"no-cache"</span>
        })

        <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }

        <span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">IVersionInfo</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
        <span class="hljs-keyword">return</span> data
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取远端版本失败:"</span>, error)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
}

<span class="hljs-comment">/**
 * 清除所有缓存和本地数据（除了版本信息）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearAllCaches</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ⚠️ 关键：保存版本信息，防止清除后丢失</span>
        <span class="hljs-keyword">const</span> versionBuildTime = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>)

        <span class="hljs-comment">// 清除Service Worker缓存</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"caches"</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
            <span class="hljs-keyword">const</span> cacheNames = <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">keys</span>()
            <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(cacheNames.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">cacheName</span> =&gt;</span> caches.<span class="hljs-title function_">delete</span>(cacheName)))
        }

        <span class="hljs-comment">// 清除localStorage和sessionStorage</span>
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">clear</span>()
        sessionStorage.<span class="hljs-title function_">clear</span>()

        <span class="hljs-comment">// 如果存在IndexedDB，也清除掉</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"indexedDB"</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
            <span class="hljs-keyword">const</span> databases = <span class="hljs-keyword">await</span> indexedDB.<span class="hljs-title function_">databases</span>()
            databases.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">db</span> =&gt;</span> {
                <span class="hljs-keyword">if</span> (db.<span class="hljs-property">name</span>) {
                    indexedDB.<span class="hljs-title function_">deleteDatabase</span>(db.<span class="hljs-property">name</span>)
                }
            })
        }

        <span class="hljs-comment">// 恢复版本信息，防止重复检测</span>
        <span class="hljs-keyword">if</span> (versionBuildTime) {
            <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>, versionBuildTime)
        }
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"清除缓存失败:"</span>, error)
    }
}

<span class="hljs-comment">/**
 * 清除登录状态
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearLoginState</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 清除与登录相关的localStorage数据</span>
        <span class="hljs-keyword">const</span> loginRelatedKeys = [<span class="hljs-string">"xczzH5Token"</span>, <span class="hljs-string">"applyStatus"</span>]

        loginRelatedKeys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
            <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key)
            sessionStorage.<span class="hljs-title function_">removeItem</span>(key)
        })
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"清除登录状态失败:"</span>, error)
    }
}

<span class="hljs-comment">/**
 * 处理应用更新
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAppUpdate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">newBuildTime?: string</span>) =&gt; {
    <span class="hljs-comment">// 显示更新提示对话框</span>
    <span class="hljs-title class_">Dialog</span>.<span class="hljs-title function_">show</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">"发现新版本"</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">"应用已更新，请重新登录以获取最新功能"</span>,
        <span class="hljs-attr">closeOnAction</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">actions</span>: [
            {
                <span class="hljs-attr">key</span>: <span class="hljs-string">"confirm"</span>,
                <span class="hljs-attr">text</span>: <span class="hljs-string">"重新登录"</span>,
                <span class="hljs-attr">onClick</span>: <span class="hljs-keyword">async</span> () =&gt; {
                    <span class="hljs-keyword">const</span> toastHandler = <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({
                        <span class="hljs-attr">content</span>: <span class="hljs-string">"正在清除缓存..."</span>,
                        <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span>
                    })

                    <span class="hljs-comment">// 先更新版本号，再清除缓存</span>
                    <span class="hljs-keyword">if</span> (newBuildTime) {
                        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>, newBuildTime)
                    }

                    <span class="hljs-comment">// 清除所有缓存和登录状态</span>
                    <span class="hljs-keyword">await</span> <span class="hljs-title function_">clearAllCaches</span>()
                    <span class="hljs-keyword">await</span> <span class="hljs-title function_">clearLoginState</span>()

                    <span class="hljs-keyword">if</span> (toastHandler) {
                        toastHandler.<span class="hljs-title function_">close</span>()
                    }

                    <span class="hljs-comment">// 重定向到登录页</span>
                    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">import</span>.meta.env.VITE_BASE_PATH || <span class="hljs-string">"/"</span>}</span>login`</span>
                }
            }
        ]
    })
}

<span class="hljs-comment">/**
 * 检查应用版本并处理更新
 * ⚠️ 关键改进：
 * 1. 添加去重标志，防止重复弹窗
 * 2. 添加详细日志追踪
 * 3. 添加异常处理
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkAndHandleUpdate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 获取本地记录的构建时间</span>
        <span class="hljs-keyword">const</span> storedBuildTime = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>)

        <span class="hljs-comment">// 获取远端版本</span>
        <span class="hljs-keyword">const</span> remoteVersion = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchRemoteVersion</span>()

        <span class="hljs-keyword">if</span> (!remoteVersion) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"⚠️ 无法获取远端版本信息"</span>)
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// 添加详细日志</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📊 版本检查详情:"</span>, {
            <span class="hljs-string">"远端 buildTime"</span>: remoteVersion.<span class="hljs-property">buildTime</span>,
            <span class="hljs-string">"本地 buildTime"</span>: storedBuildTime || <span class="hljs-string">"未记录（首次访问）"</span>,
            版本号: remoteVersion.<span class="hljs-property">version</span>,
            需要更新: !!storedBuildTime &amp;&amp; storedBuildTime !== remoteVersion.<span class="hljs-property">buildTime</span>
        })

        <span class="hljs-keyword">if</span> (storedBuildTime &amp;&amp; storedBuildTime !== remoteVersion.<span class="hljs-property">buildTime</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔄 检测到版本更新！`</span>)
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   旧版本: <span class="hljs-subst">${storedBuildTime}</span>`</span>)
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   新版本: <span class="hljs-subst">${remoteVersion.buildTime}</span>`</span>)

            <span class="hljs-comment">// 传递新的 buildTime，在用户确认后更新</span>
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">handleAppUpdate</span>(remoteVersion.<span class="hljs-property">buildTime</span>)
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!storedBuildTime) {
            <span class="hljs-comment">// 第一次访问，记录当前版本</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`📝 首次访问，记录 buildTime: <span class="hljs-subst">${remoteVersion.buildTime}</span>`</span>)
            <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>, remoteVersion.<span class="hljs-property">buildTime</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 版本无更新，应用为最新版本"</span>)
        }
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"❌ 版本检查出错:"</span>, error)
    }
}

<span class="hljs-comment">/**
 * 启动版本检查（定时检查）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">startVersionCheck</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🚀 版本检查已启动"</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`📋 检查间隔: <span class="hljs-subst">${VERSION_CHECK_CONFIG.CHECK_INTERVAL / <span class="hljs-number">1000</span>}</span> 秒`</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔗 版本 API: <span class="hljs-subst">${VERSION_CHECK_CONFIG.VERSION_URL}</span>`</span>)

    <span class="hljs-comment">// 立即检查一次</span>
    <span class="hljs-title function_">checkAndHandleUpdate</span>()

    <span class="hljs-comment">// 定时检查</span>
    <span class="hljs-keyword">const</span> intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`⏰ [<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>] 执行定时版本检查...`</span>)
        <span class="hljs-title function_">checkAndHandleUpdate</span>()
    }, <span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">CHECK_INTERVAL</span>)

    <span class="hljs-comment">// 暴露到全局作用域，方便调试</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
        ;(<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">__versionCheckUtils__</span> = {
            <span class="hljs-comment">// 手动检查版本</span>
            <span class="hljs-attr">checkNow</span>: <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔍 手动触发版本检查..."</span>)
                <span class="hljs-title function_">checkAndHandleUpdate</span>()
            },
            <span class="hljs-comment">// 清空版本记录，下次访问会重新记录</span>
            <span class="hljs-attr">resetVersion</span>: <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>)
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 版本记录已清空，刷新页面后会重新记录"</span>)
            },
            <span class="hljs-comment">// 查看当前版本信息</span>
            <span class="hljs-attr">getVersionInfo</span>: <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">"本地 buildTime"</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>),
                    <span class="hljs-string">"存储 key"</span>: <span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">STORAGE_KEY_VERSION</span>,
                    <span class="hljs-string">"API 地址"</span>: <span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">VERSION_URL</span>,
                    <span class="hljs-string">"检查间隔(秒)"</span>: <span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span>.<span class="hljs-property">CHECK_INTERVAL</span> / <span class="hljs-number">1000</span>
                }
            },
            <span class="hljs-comment">// 获取远端版本</span>
            <span class="hljs-attr">getRemoteVersion</span>: <span class="hljs-keyword">async</span> () =&gt; {
                <span class="hljs-keyword">const</span> version = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchRemoteVersion</span>()
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🌐 远端版本:"</span>, version)
                <span class="hljs-keyword">return</span> version
            },
            <span class="hljs-comment">// 测试清除缓存</span>
            <span class="hljs-attr">testClearCache</span>: <span class="hljs-keyword">async</span> () =&gt; {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🧹 测试清除缓存..."</span>)
                <span class="hljs-keyword">await</span> <span class="hljs-title function_">clearAllCaches</span>()
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 缓存清除完成"</span>)
            },
            <span class="hljs-comment">// 间隔 ID</span>
            intervalId
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"💡 调试工具已加载，可在控制台使用 window.__versionCheckUtils__"</span>)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   - checkNow()        手动检查版本"</span>)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   - resetVersion()    清空版本记录"</span>)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   - getVersionInfo()  查看版本信息"</span>)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   - getRemoteVersion()获取远端版本"</span>)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   - testClearCache()  测试清除缓存"</span>)
    }
}

</code></pre>
<h2 data-id="heading-0">版本更新与缓存清除</h2>
<hr/>
<h3 data-id="heading-1">🎯 核心功能</h3>
<h4 data-id="heading-2">1. 自动版本检测</h4>
<ul>
<li>应用启动时自动检查 <code>/version.json</code></li>
<li>每5分钟定时检查一次</li>
<li>比对构建时间（buildTime）检测新版本</li>
</ul>
<h4 data-id="heading-3">2. 缓存清除</h4>
<ul>
<li>Service Worker 缓存</li>
<li>localStorage / sessionStorage</li>
<li>IndexedDB 数据库</li>
<li>所有登录相关数据</li>
</ul>
<h4 data-id="heading-4">3. 强制重新登录</h4>
<ul>
<li>检测到新版本时显示"发现新版本"提示</li>
<li>点击"重新登录"清除缓存并跳转到登录页</li>
<li>用户重新登录后获取最新版本代码</li>
</ul>
<hr/>
<h3 data-id="heading-5">📁 文件结构</h3>
<pre><code class="hljs language-csharp" lang="csharp">src/
├── utils/
│   └── version.ts                    <span class="hljs-meta"># 核心版本检查工具</span>
├── hooks/
│   └── update/
│       └── useVersionCheck.ts        <span class="hljs-meta"># 版本检查 Hook</span>
├── stores/
│   └── userInfo.ts                   <span class="hljs-meta"># 已集成 logout 方法（清除缓存）</span>
└── App.tsx                           <span class="hljs-meta"># 已集成 useVersionCheck Hook</span>

<span class="hljs-keyword">public</span>/
└── version.json                      <span class="hljs-meta"># 版本信息文件（自动生成）</span>

scripts/
├── update-version.js                 <span class="hljs-meta"># 自动更新版本脚本</span>
├── update-version.sh                 <span class="hljs-meta"># Linux/Mac 版本脚本</span>
└── update-version.bat                <span class="hljs-meta"># Windows 版本脚本</span>

package.json                          <span class="hljs-meta"># build 脚本</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">🚀 使用方式</h3>
<h4 data-id="heading-7">1. 开发环境</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm start
</code></pre>
<h4 data-id="heading-8">2. 构建项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动更新版本并构建</span>
pnpm build

<span class="hljs-comment"># 测试云构建</span>
pnpm build:testcloud

<span class="hljs-comment"># 生产云构建</span>
pnpm build:prodcloud
</code></pre>
<h4 data-id="heading-9">3. 手动更新版本（可选）</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm update-version
</code></pre>
<hr/>
<h3 data-id="heading-10">🔄 工作流程</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 执行 pnpm build
   ↓
<span class="hljs-bullet">2.</span> 运行 update-version.js 脚本
   ↓
<span class="hljs-bullet">3.</span> 读取 package.json 中的版本号
   ↓
<span class="hljs-bullet">4.</span> 生成当前构建时间（ISO 8601）
   ↓
<span class="hljs-bullet">5.</span> 生成/更新 public/version.json
   ↓
<span class="hljs-bullet">6.</span> Vite 构建应用
   ↓
<span class="hljs-bullet">7.</span> 部署到服务器
   ↓
<span class="hljs-bullet">8.</span> 用户访问应用
   ↓
<span class="hljs-bullet">9.</span> useVersionCheck Hook 启动
   ↓
<span class="hljs-bullet">10.</span> 定时检查 /version.json
<span class="hljs-code">    ↓
11. 版本不同 → 显示更新提示 → 清除缓存 → 重新登录
</span></code></pre>
<hr/>
<h3 data-id="heading-11">🛠️ 部署配置</h3>
<h4 data-id="heading-12">Nginx 配置（重要）</h4>
<p><strong>必须禁用 version.json 的缓存，否则更新检测无法生效：</strong></p>
<pre><code class="hljs language-nginx" lang="nginx"># 版本检查文件 - 禁用缓存
location /version.json {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# 其他资源 - 长期缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# HTML 文件
location ~* \.html$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
</code></pre>
<hr/>
<h3 data-id="heading-13">📊 版本信息文件格式</h3>
<p><code>public/version.json</code> 内容示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.4.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"buildTime"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026-01-27T10:30:00Z"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-14">自动生成说明</h4>
<ul>
<li><code>version</code>：从 <code>package.json</code> 中读取</li>
<li><code>buildTime</code>：构建时的当前时间（自动生成）</li>
</ul>
<hr/>
<h3 data-id="heading-15">🧪 测试版本更新</h3>
<h4 data-id="heading-16">本地测试步骤</h4>
<ol>
<li>
<p><strong>修改版本号</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑 package.json，改变 version 字段</span>
<span class="hljs-comment"># 例如：1.4.3 -&gt; 1.4.4</span>
</code></pre>
</li>
<li>
<p><strong>重新构建</strong></p>
<pre><code class="hljs language-bash" lang="bash">pnpm build
pnpm preview
</code></pre>
</li>
<li>
<p><strong>验证功能</strong></p>
<ul>
<li>打开应用</li>
<li>打开浏览器开发者工具</li>
<li>编辑 <code>public/version.json</code>，改变 buildTime</li>
<li>刷新页面</li>
<li>应该会弹出"发现新版本"提示</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-17">🔍 调试</h3>
<h4 data-id="heading-18">查看版本信息</h4>
<p>在浏览器控制台执行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取远端版本</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/version.json"</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"远端版本:"</span>, data))

<span class="hljs-comment">// 检查本地版本记录</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"本地版本:"</span>, <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"APP_VERSION"</span>))
</code></pre>
<h4 data-id="heading-19">查看缓存</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Service Worker 缓存</span>
caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">names</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"缓存列表:"</span>, names))

<span class="hljs-comment">// localStorage</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"localStorage:"</span>, <span class="hljs-variable language_">localStorage</span>)

<span class="hljs-comment">// sessionStorage</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"sessionStorage:"</span>, sessionStorage)
</code></pre>
<h4 data-id="heading-20">手动清除缓存</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { clearAllCaches, clearLoginState } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/version"</span>

<span class="hljs-comment">// 清除所有缓存</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">clearAllCaches</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"缓存已清除"</span>)

<span class="hljs-comment">// 清除登录状态</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">clearLoginState</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"登录状态已清除"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-21">⚙️ 配置调整</h3>
<h4 data-id="heading-22">修改检查间隔</h4>
<p>编辑 <code>src/utils/version.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VERSION_CHECK_CONFIG</span> = {
    <span class="hljs-comment">// 改为 10 分钟检查一次</span>
    <span class="hljs-attr">CHECK_INTERVAL</span>: <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
    <span class="hljs-comment">// ...其他配置</span>
}
</code></pre>
<h4 data-id="heading-23">禁用版本检查</h4>
<p>在 <code>src/App.tsx</code> 中注释掉：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// useVersionCheck() // 注释掉这行</span>
</code></pre>
<h4 data-id="heading-24">自定义更新提示</h4>
<p>编辑 <code>src/utils/version.ts</code> 中的 <code>handleAppUpdate()</code> 函数</p>
<hr/>
<h3 data-id="heading-25">📚 更多资源</h3>
<p>详细部署指南请查看 <a href="https://link.juejin.cn?target=..%2FDEPLOYMENT_GUIDE.md" target="_blank" title="../DEPLOYMENT_GUIDE.md" ref="nofollow noopener noreferrer">DEPLOYMENT_GUIDE.md</a></p>
<hr/>
<h3 data-id="heading-26">💡 关键要点</h3>
<p>✅ <strong>一定要做的事：</strong></p>
<ol>
<li>在 Nginx/Apache 中禁用 version.json 的缓存</li>
<li>确保 Service Worker 正常注册</li>
<li>每次部署前运行 <code>pnpm build</code>（会自动更新版本）</li>
</ol>
<p>❌ <strong>不要做的事：</strong></p>
<ol>
<li>手动修改 public/version.json（会被覆盖）</li>
<li>启用 version.json 的缓存</li>
<li>在部署前忘记构建项目</li>
</ol>
<hr/>
<h3 data-id="heading-27">📞 常见问题</h3>
<p><strong>Q: 用户更新后仍看到旧版本？</strong>
A: 检查 Nginx 缓存配置，确保禁用了 version.json 的缓存</p>
<p><strong>Q: 版本文件未生成？</strong>
A: 检查是否有写入 public 目录的权限</p>
<p><strong>Q: 如何强制所有用户更新？</strong>
A: 修改 version.json 中的 buildTime 字段</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据库巡检进入智能时代：异常检测算法的落地实践]]></title>    <link>https://juejin.cn/post/7603288778678255651</link>    <guid>https://juejin.cn/post/7603288778678255651</guid>    <pubDate>2026-02-06T02:44:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603288778678255651" data-draft-id="7603054272158777394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据库巡检进入智能时代：异常检测算法的落地实践"/> <meta itemprop="keywords" content="数据库,运维,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T02:44:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="去哪儿技术沙龙"/> <meta itemprop="url" content="https://juejin.cn/user/2251436075786791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据库巡检进入智能时代：异常检测算法的落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2251436075786791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    去哪儿技术沙龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:44:42.000Z" title="Fri Feb 06 2026 02:44:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么传统巡检不够用？</h2>
<p>传统的巡检系统都是基于固定阈值来判定指标是否异常，一般为了防止产生过多的指标异常信息，这种阈值设置的都偏高。虽然这种方式也能发现异常，但是场景过于单一，无法感知指标的动态变化，例如在业务逐渐进入高峰期时，数据库的QPS、负载或者数据体量也都是逐渐升高的，等达到日常的异常阈值再处理，时间上会比较紧张，而如果能提前发现数据库核心指标的变化以及变化幅度，那DBA就能提前介入分析和处理，也减小了因为负载过高或者容量紧张带来的业务异常的可能性。</p>
<h2 data-id="heading-1">二、异常检测：巡检的“第二双眼睛”</h2>
<p>近年来，机器学习和人工智能技术快速发展为时序监控提供了新思路，机器学习可以从历史数据中找到自身的规律，识别出常规之外的行为。去哪儿网DBA将时序监控数据的异常检测运用到日常巡检中，通过智能分析来发现数据库指标的动态变化异常。</p>
<p>整体思路如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a9dbf0e417b4f108eacfdc084af82cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=uoPE%2BmPZXQetGrkVWW%2B0746GZgE%3D" alt="" loading="lazy"/></p>
<ol>
<li>
<p>特征分析：有些实例的指标具有周期性的变化规律，在周期内可能会出现快速的上涨或下降，这种符合周期性变化的场景不应该算作异常，例如部分Redis内存的使用量会在夜间快速的降低而在早上又快速的上涨，需要把这种具有周期性规律的实例提取出来，进行周期性检测。而有些实例的指标或许是持续平稳上涨的，如MySQL服务器磁盘使用量一般是平稳增长的，如果短时间内上涨很多，那么就可能有异常。所以第一步我们需要把实例指标的周期性，平稳性等变化特征进行提取。</p>
</li>
<li>
<p>算法选择：根据不同特征需求，使用不同的转换算法或异常检测算法进行处理。通过滑动窗口法将监控数据转换生成新的曲线；通过四分位距法进行异常点的检测；通过周期检测算法将有周期性规律的指标识别出来并且获得周期长度，检测出不符合周期规律的情况；通过水位检测识别出指标水位突然上升的情况等等。</p>
</li>
<li>
<p>调优：通过算法识别出来的异常点不一定是真实业务场景的异常点，因为异常算法只是从数学的角度进行的检测，即使考虑到历史规律特性，在某些场景下的算法识别的异常点我们并不需要处理，所以最终结果需要通过动态阈值和静态阈值参数相结合。机器学习可以通过历史数据自动计算出动态阈值，可以通过窗口大小、灵敏度等算法参数影响动态阈值的变化，但有些场景还需要静态阈值给予辅助判断，例如磁盘空间虽然快速上涨，如果使用率还很低，这种场景我们暂时不需要做任何处理，也就不需要把它识别成异常点，所以需要设置一个上边界阈值。通过一些特定的参数和静态阈值，对不同的指标，不同的集群赋予一些特殊的意义，我们希望最终暴露出来的异常点都是我们需要处理的场景。另外一些已知干扰项，例如节点迁移，改表工单，参数配置不合理等也需要考虑进算法中。</p>
</li>
<li>
<p>报警收敛：为避免同一消息发送很多次，从一个报警第一次发送开始计时，同一个消息在近n个小时只发送一次消息，剩下的报警在原消息的内容上更新，只显示最新的检测内容。另外一个集群的多个实例同时报警收敛为一个消息，一组集群同时报警收敛为一个消息，这样大大减少了报警数量,可以避免由于接收到大量的相同消息而把其它需要关注的消息忽略掉。</p>
</li>
</ol>
<h2 data-id="heading-2">三、三大典型应用场景</h2>
<h3 data-id="heading-3">3.1 平稳趋势异常检测</h3>
<p>MySQL服务器磁盘使用量、服务器内存使用量、Redis内存使用量等绝大部分监控指标的监控曲线特征基本是相同的，也就是正常情况下趋势平稳（平稳上升/下降，或者变化趋势不明显），这类监控指标在底层可以共用一套异常检测逻辑，通过不同的参数来调整各自的特征。上面再封装一层不同的业务检测逻辑进行定制化，减少误报。本章节以MySQL磁盘使用率检测为例进行介绍。</p>
<p><strong>3.1.1 场景分析</strong></p>
<p>MySQL磁盘使用率一般都是均匀上涨的，如下面监控曲线展示，在红框标识的范围之前，使用率变化非常平稳，对于这种场景，如果使用率突然增加可视为异常，如红框范围内的数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30e0010bb88f41e9ba4599fbd4e1ce4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=ODfRP3ABxFmA27gMh9vYWaONJhQ%3D" alt="" loading="lazy"/></p>
<p>报警信息如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d7bcc45226a4f55b1ad4021ed3d1ed3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=xnkpBMeZTommH1k1f0%2FWS0y7RBo%3D" alt="" loading="lazy"/></p>
<p><strong>3.1.2 平稳趋势异常检测实现</strong></p>
<p>平稳趋势异常检测使用的DoubleRollingAggregate算法，是一种窗口检测算法，其主要原理如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5449c60359834396ba802a8c4bb36461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=eTxPKrZ63c2GXeimtoG9Y%2B9Psrs%3D" alt="" loading="lazy"/></p>
<p>在监控曲线上创建两个滑动窗口，每个窗口覆盖n个监控点（可设置），两个窗口依次从左向右滑动，右窗口的平均值-左窗口的平均值的结果生成一条新的曲线，也可以根据需求计算每个窗口的中位数/最大值/IQR等指标，得到的数据曲线如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a99676e45cdf4b7994b026f8195bdcbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=YnZl06PHdRYLQWSU4uK6dIrwP%2Bg%3D" alt="" loading="lazy"/></p>
<p>新曲线小于0的点说明是原曲线在下降，新曲线大于0的点说明是原曲线在上升，曲线上绝对值越大，那么变化（上升/下降）的幅度就越大。</p>
<p>可以根据新曲线大于0/小于0的点的个数占总点数的比例，来判断整体趋势上升或下降的程度。</p>
<p>窗口大小可调节，窗口越大，结果越平缓，IQR检测时越能消除噪音，负面影响就是可能漏掉一些异常点。</p>
<p><strong>3.1.3 检测调优</strong></p>
<p>根据磁盘增长的特性，检测逻辑如下:</p>
<ul>
<li>
<p>首先对主机进行筛选，例如对于磁盘使用率小于50%的主机不进行检测。</p>
</li>
<li>
<p>增长幅度大于设定阈值，说明增长过快，则判定为异常。</p>
</li>
<li>
<p>最近使用率大于设定阈值，则判定为异常（和普通的固定阈值异常检测相结合）。</p>
</li>
<li>
<p>和具体场景结合：</p>
</li>
</ul>
<p>a.在磁盘使用率小于设定阈值时检测到有变化异常，但是异常时间范围内有对应实例中的表在执行DDL操作功能，且工单执行时间范围和异常时间范围吻合度较高，则不记为需要关注的异常现象。</p>
<p>b.在磁盘使用率小于设定阈值时检测到有变化异常，但是有数据在往其主机上进行迁移，迁移执行时间范围和异常时间范围吻合度较高，则不记为需要关注的异常现象。</p>
<ul>
<li>主机磁盘使用辅助报表</li>
</ul>
<p>有些实例没有设置max_binlog_files参数，只设置了保留7天的binlog，在有归档任务时可能会产生几百G的binlog，导致磁盘异常上涨，这种场景会把这台服务器上的所有实例信息展示出来，包括参数配置，binlog大小等信息，方便快速定位问题。所以在磁盘使用量异常报警消息中增加了一个辅助报表协助DBA定位磁盘使用异常的原因。报表内容如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d87b243f644e9d9dcf4abeb85a0320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=hHzXZRR82fP52h2emevJsZYmkd0%3D" alt="" loading="lazy"/></p>
<p><strong>3.1.4 稳定性算法延伸</strong></p>
<p>稳定性算法通过调整一些参数就可以检测到长期缓慢增涨的场景，例如下面监控图是MySQL扫描行数的监控图，由于业务新上线了一个sql，随着表数据量增加和执行频率增加，导致实例扫描行数长期缓慢上涨，，在造成严重的慢查询前需要检测出这种异常来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02cf71f27cab4197a58110fc1ca247d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=TwblYmQLaIu4IoDpMIFxZV1VlXU%3D" alt="" loading="lazy"/></p>
<p>具体实现如下：</p>
<p>先过滤出近一天最大扫描行数大于设定阈值的实例。对于这种长期增长的检测可以简化为对比每天高峰期时间扫描行数异常变化的检测，取每天高峰时间内的一个监控点，连续取近30天的监控数据，然后对这30个监控点进行平稳性异常检测，如设置窗口大小为5，每个窗口取最大值，计算两个窗口的差，通过判断新曲线正值的比例，即可判断出这种增长异常。</p>
<p>为什么不简单的使用扫描行数大于某个阈值就视为异常呢？首先各个实例对应业务场景不同，阈值的设定无法进行较好的统一，设置较低告警信息太多，设置较高会导致漏报。如果和趋势判断结合，就能弥补固定阈值检测导致的漏报问题，并且可以提前发现风险进行介入处理。</p>
<h3 data-id="heading-4">3.2 周期性变化异常检测</h3>
<p>对于实例的QPS，MySQL的扫描行数，Redis内存使用这些指标，有些业务场景下是具有周期性变化规律的。但是最近一段时间突然脱离了周期性的变化范围或幅度，这种异常情况也需要进行识别，本章节以Redis周期性内存使用量异常检测介绍符合周期性变化特征的异常检测。</p>
<p><strong>3.2.1 场景分析</strong></p>
<p>以下是一个Redis实例内存使用率监控数据:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/310e3296d90947cc8891562f8dc73dc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=Fooo8p4Es4JLmdsuTI8xC5ztr%2B8%3D" alt="" loading="lazy"/></p>
<p>从监控图上可以看出该Redis实例的内存使用有两个明显特点：</p>
<ul>
<li>
<p>内存使用量呈现以一天为周期的变化规律。</p>
</li>
<li>
<p>在周期内Redis使用量具有波动性。</p>
</li>
</ul>
<p>对于这种情况我们重点关注的是连续周期的变化趋势是不是一致的，最近的变化和之前的同周期变化有无较大差异，而对于单个周期内的增减变化不予以重点关注。通过周期性异常检测算法检测结果如下，红色的监控点是检测出来的异常点。可以看出最近一个周期的变化量明显高于前面的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a6c22cd6a77414690bd46d18eb905dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=Dq1TLji7MzhkRT0IXGqRovB%2Fagw%3D" alt="" loading="lazy"/></p>
<p>报警消息如下:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3118fbffc76940f1a5053e87b51f9f95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=1oY6Pr5LUrWMLLjDpqfv%2BBQwCLY%3D" alt="" loading="lazy"/></p>
<p><strong>3.2.2 周期性异常检测算法实现原理</strong></p>
<p>周期性检测通过SeasonalAD算法实现，此算法通过pipenet连接多个数据转换器和异常检测器来检测出异常点，具体流程如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1ed4c2d8f234320b23831429f7d4f3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=c31Hl9CEfc8WthfrsX5mTy6MzUw%3D" alt="" loading="lazy"/></p>
<p>a.数据转换器deseasonal_residual: deseasonal_residual通过ClassicSeasonalDecomposition算法去除周期性的规律特性。基于自相关函数(ACF)获取周期长度，经典的周期性分解假设时间序列是由趋势项 (trend)、季节项 (seasonal pattern) 和噪声（即残差） 三部分加和而成的。此步骤通过移动平均计算并移除趋势成分，通过计算去趋势化后序列在多个季节周期上的平均值来提取季节模式，最终返回残差序列。 返回的结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c1b5c45949b463db2c8b0c27f3fa9cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=TdGO0oW%2FaIhi4jwvc0zagAaCXcE%3D" alt="" loading="lazy"/></p>
<p>b. 异常分析：异常分析通过由两条检测链路进行检测，然后取两个链路结果交集。</p>
<p>链路1 sin_check：用于检测上升的异常或检测下降的异常，或者都检测，通过参数side设置。例如side = "positive"，那么sin_check输出的异常点是所有deseasonal_residual大于0的点，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5efb2c93745a496bb0f5d17a450da77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=1Uo7BYGd1yNGvNIchTZHsgttzNM%3D" alt="" loading="lazy"/></p>
<p>这样再和链路2的iqr_ad求交集后，就只剩下iqr_ad上涨的异常点了。</p>
<p>链路2中有两个算法，首先是abs_residual，用于计算deseasonal_residual结果的绝对值，转化为绝对值是为了在使用四分位距法检测异常时便于计算，转化为绝对值后的结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7455717ff94e45029a7bcd56c38fe51d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=jXBhWEt5YtU%2Fd2%2FqmP0SFlPQX2k%3D" alt="" loading="lazy"/></p>
<p>通过abs_residual转换的结果再通过iqr_ad(InterQuartileRangeAD)的四分位距法计算离群点，检测结果如下，其中红色为离群点（异常点）:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9156b46472074b98b14713523e02cfd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=OFutuxPvWad9XDKmkFX7uDg2T%2Fs%3D" alt="" loading="lazy"/></p>
<p>最后将链路1 sign_check检测出来的异常点和链路2 检测出来的异常点求交集，得到最终结果如下，其中红色部分为我们需要关注的异常点:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29f52818a23446468534ab9dc4430df5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=AMEJ16wKMfQBii%2BoiPgkqGsYFrM%3D" alt="" loading="lazy"/></p>
<p>在原始监控图标识出上面检测到的异常点，得到的最终结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9d8e6740e2c47d58b00a87f7e268158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=LTMydq2VUat%2B2zJu6%2BMeTQRvPOc%3D" alt="" loading="lazy"/></p>
<p><strong>3.2.3 检测调优</strong></p>
<p>在使用周期性变化异常检测之前，首先要识别出要检测的指标是否具有周期性变化的规律，通过机器学习模型训练，对近n天的监控数据进行分解周期特征，计算自相关性来获得周期信息。一般情况下这种周期性规律不会有很大的变化，所以在初始节点将需要进行检测的指标全部遍历检测一遍，然后将符合周期性的集群信息记录到元数据库中，后面再定时更新相关元数据。在进行周期性变化异常检测时只检测数据库中有相应记录的集群即可。另外对于有周期性变化规律的集群指标，在进行平稳性异常检测时可以很好的进行过滤或者设置特殊的阈值。</p>
<p>在使用周期性变化异常检测时还需要有其他检测标准进行联合判断，否则可能会导致很多无效的异常信息，在满足下列其中一项条件的情况下，对于Redis内存使用量检测，即使周期性变化监测到有异常行为也被视为安全范围内的异常波动，不需要关注和进行消息提醒：</p>
<ul>
<li>
<p>检测时间范围内如果Redis内存使用量或使用率小于一定阈值。</p>
</li>
<li>
<p>实际使用内存最大值-最小值的差小于设定阈值(波动小)。</p>
</li>
<li>
<p>在一定时间段内异常点的数量小于设定阈值。</p>
</li>
</ul>
<h3 data-id="heading-5">3.3 突变异常检测</h3>
<p>这种情况是指在很短时间范围(瞬时)内，监控指标突然发生较大幅度的变化，下面以MySQL服务器CPU水位变化检测和QPS异常检测为例分别介绍。</p>
<p><strong>3.3.1 MySQL服务器CPU水位变化</strong></p>
<h4 data-id="heading-6">3.3.1.1 场景分析</h4>
<p>正常情况下，MySQL的CPU水位在20%以下，常规报警阈值设置为50%，在达到报警阈值之前，如果cpu水位突然上涨并持续一段时间，说明业务有不合理的请求，需要关注。 如下面所示的监控曲线，在16:25时间点突然上涨约一倍的量，并一直持续保持在30%的使用率，对于这种瞬时突变的场景应视为异常现象:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14d4fde974364168a9fa3b744742e38d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=vZpG6h%2FgClyShmVXgfKmedg2HlQ%3D" alt="" loading="lazy"/></p>
<p>报警信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc1df50b9e8844a7b79333c37beb9757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=9JwKp%2B%2FxGv%2Bil4k%2BsyAmhNjkwNM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.3.1.2 水位监测实现原理</h4>
<p>水位突变检测使用LevelShiftAD检测算法，它使用了多个转换器和检测器，通过pipenet连接起来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe8d8f518cf94131a3b2c63e74dc7d45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=R%2Bh7ViXzKhrZMkGzhYmpuSAxRqk%3D" alt="" loading="lazy"/></p>
<p>链路1先用DoubleRollingAggregate(diff_abs)算法进行数据转换,同时使用两个滑动窗口从左向右滑动，计算两个滑动窗口的中位数的绝对差值(Absolute difference)，产生一组新的时间序列。再通过InterQuartileRangeAD(iqr_ads)四分位距法计算离群点。</p>
<p>diff_abs将图4-1-1监控数据转换成新的时间序列，形成的曲线结果如下:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0532832ab35d4dfd887b58ad5575a6c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=4lIWvc7nmuu4R6lWUkAmSi22bS8%3D" alt="" loading="lazy"/></p>
<p>将diff_abs转化后的时间序列作为iqr_ads的输入，通过iqr计算出异常点,异常检测之后的图示结果如下，红色点是异常点：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41658950370b4a9b836f16dac7f906fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=UCB5CDf31xNlmefrKT%2FaghqXWVA%3D" alt="" loading="lazy"/></p>
<p>链路2同样先通过DoubleRollingAggregate(diff)算法进行数据转换，不同的是这次是计算的两个窗口中位数的差值，产生另一组新的时间序列，形成的曲线如下。然后再通过ThresholdAD(sign_check)算法检测异常点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c648e5b1b4f4e00bad5de3cf9b38ce3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=id3%2Bb42vPOebV7SJHptF82vKeX0%3D" alt="" loading="lazy"/></p>
<p>sign_check作用和周期性检测中的sign_check一样,用于区分方向性，这里只检测水位上升，所以所有正数都是异常点。 图示结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1f8f226a63143e3967fb49000f5ae97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=A8%2FtPps7zpv%2B8VY%2BuTqFa16JnBY%3D" alt="" loading="lazy"/></p>
<p>链路1和链路2的检测结果求交集，获得最后的结果，检测出水位突然上升的边缘，图示如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6925143a10024d8ea996a9131617382e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=LXV95a7DpAeVE3t%2B4Rm5WSr6Hbw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.3.1.3 检测调优</h4>
<p>通过静态参数过滤掉一些没有必要的报警，例如如果cpu的最大值小于阈值，则不算异常。如果最近几个点的平均值小于阈值，则不算异常，因为已经恢复了，没必要重复报警。一些BI类业务设置高阈值。</p>
<p><strong>3.3.2 QPS异常负增长检测</strong></p>
<p>QPS虽然波动很大，但一般都是向上突增，即使有向下的波动其变化幅度也不应该很大。如果一个实例的QPS突然降低到几乎为零，然后又快速恢复，那这种情况是存在异常的。本章节介绍检测QPS掉0的场景。注意这里说的掉0是突然降低到很低的水平，不一定全是0。</p>
<h4 data-id="heading-9">3.3.2.1 场景分析</h4>
<p>在大事务提交时，由于写binlog耗时长，将Binlog Events写入Binlog文件的过程必须要串行执行，只有一个事务写完了，另外一个事务才能执行，这时可能导致写操作掉0。低版本的MySQL是单线程复制，从节点应用大事务时，也会导致从节点QPS掉0，并伴有主从延迟。如下监控所示，在约16:30时刻QPS突然大幅度降低，然后又快速恢复。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf12f8d055b84f509051715fa0d07a62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=m7KE85B13EgzltNFNwPlzJ0JSTM%3D" alt="" loading="lazy"/></p>
<p>通过异常检测算法检测出来的效果如下(红色点是异常点)：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36cd07bfa09e401d9939b3064e5243fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=9ZVXf6eLQBmkwwBJGHHcRPkUseA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">3.3.2.2 算法实现原理</h4>
<p>这种指标突然掉0的异常情况使用IQR（Interquartile Range，四分位距）检测可以快速地把异常值筛选出来。IQR是统计学中衡量数据分散程度的指标，特别适合处理非正态分布或存在异常值的数据。通过聚焦数据中间50%的分布范围，规避极端值干扰，是数据分析中稳健的离散度度量工具。</p>
<p>很多异常检测都是把原始数据转换后，通过IQR进行的离群点检测，是一种基本的离群点检测算法。</p>
<p>IQR 描述的是数据集中“中间50%”的数据范围，详细概念如下：</p>
<ul>
<li>
<p>将数据从小到大排序后，平均分成4段：</p>
</li>
<li>
<p>Q1（第1四分位数）：排名在前25%位置的数值（例：班级考试第25名的分数）</p>
</li>
<li>
<p>Q3（第3四分位数）：排名在前75%位置的数值（例：班级考试第75名的分数）</p>
</li>
<li>
<p>IQR = Q3 - Q1 ,即中间50%数据的跨度（如下图示）</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c779a00f8d84c9b955c06b6b388541c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=dZpRg%2BUfZ%2BltDejDfGRE%2Fr%2Fzy1c%3D" alt="" loading="lazy"/></p>
<p>若数据超出 [𝑄1−𝑐1 * 𝐼𝑄𝑅 , 𝑄3+𝑐2 * 𝐼𝑄𝑅] 范围，则视为异常值。</p>
<p>举例说明：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 把监控数据从小到大排序后，数据如下</span>
data = [<span class="hljs-number">5</span>,<span class="hljs-number">7</span>,<span class="hljs-number">10</span>,<span class="hljs-number">15</span>,<span class="hljs-number">19</span>,<span class="hljs-number">21</span>,<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>,<span class="hljs-number">23</span>,<span class="hljs-number">23</span>,<span class="hljs-number">23</span>,<span class="hljs-number">23</span>,<span class="hljs-number">24</span>,<span class="hljs-number">24</span>,<span class="hljs-number">24</span>,<span class="hljs-number">24</span>,<span class="hljs-number">25</span>]
<span class="hljs-built_in">len</span>(data) <span class="hljs-comment"># 19 </span>
<span class="hljs-comment"># 散列图</span>
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
plt.scatter(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)),data)
<span class="hljs-comment"># 直方图 是频率分布</span>
plt.hist(data)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffc94cc24d446ed8eea3bff8f6d4bc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=BqwTpr6UVTM4gCxqiTo43YM2Cqw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/542c6579566e4bb3b86218e8b7be0a41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=0%2FAx9uiw1iDXz4mpZBjZ4jKTrZQ%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 第一个四分位数</span>
<span class="hljs-attr">Q1</span> = df.number.quantile(<span class="hljs-number">0.25</span>,interpolation=<span class="hljs-string">'nearest'</span>)
Q1 <span class="hljs-comment"># 19</span>
<span class="hljs-comment"># 第三个四分位数</span>
<span class="hljs-attr">Q3</span> = df.number.quantile(<span class="hljs-number">0.75</span>,interpolation=<span class="hljs-string">'nearest'</span>)
Q3 <span class="hljs-comment"># 24</span>
<span class="hljs-comment">#四分位间距</span>
<span class="hljs-attr">IQR</span> = Q3-Q1
IQR <span class="hljs-comment"># 5</span>
<span class="hljs-comment"># 假设c1设为1.5，第一个四分位数以下，并检查较低的离群值。小于这个值的数为异常点</span>
Q1 - 1.5*IQR <span class="hljs-comment">#11.5</span>

<span class="hljs-comment"># 假设c2设为1.5,第三个四分位数以上，并检查较高的离群值。大于这个值的数为异常点</span>
Q3 + 1.5*IQR <span class="hljs-comment"># 31.5</span>
</code></pre>
<p>正常范围是 [𝑄1−𝑐1 * 𝐼𝑄𝑅 , 𝑄3+𝑐2 * 𝐼𝑄𝑅] = [11.5,31.5]</p>
<p>所以超出[11.5,31.5]范围的点认为是异常点，5，7，10这3个点是小于下限点异常点，没有大于上限的异常点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1486cd45a0949abae38388c77f79328~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=FlfykD6dTSXQp%2FFtJ7psnS10Vqk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">3.3.2.3 检测调优</h4>
<p>在实际场景中很多集群的QPS波动幅度很大，且没有明显的规律性，从数学意义上的离群点中过滤出我们需要关心的异常点是此检测项中的重点。</p>
<p>首先我们需要明确，这种场景下我们只想检测出突然掉为0的这种变化比较极端的情况，所以c2设一个很大值，不检查突增的异常点，c1设一个合理值，这样可以检测出突然掉0的异常点。</p>
<p>因为这种掉0的情况持续很短，检测监控点的时间范围一般不能太长，否则容易丢掉异常或者有误判，所以从prometheus获取监控数据的step设为了15s，提高采集精度。如果由于故障导致QPS长时间掉0，那么其他核心指标也会出现异常，数据库报警会发现这种情况进行报警，这种情况不在该异常检测场景中。</p>
<p>在做这种突然掉为0的极端变化异常检测时，还需要考虑周期性和先突增又突降的情况：</p>
<p>a.周期性下降</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58a674b559b84cefa1209bdcfb170802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=DcYAwUsAkw4zuGWLNkAeNzd40hM%3D" alt="" loading="lazy"/></p>
<p>上图这种周期性掉0的情况不应该算做异常，需要剔除掉。检测思路如下：</p>
<p>计算近一段时间是否具有周期性规律，如果有周期性规律，计算出一个周期的长度n(一个周期里有n个监控点)，计算最近连续的2个低水位的异常点的平均值a，获得这2个点对应的前一个周期同一时刻的监控平均值b和前两个周期对应同一时刻的监控平均值c，对比a和b的绝对值，a和c的绝对值，因为正常情况下异常点的值都很小，所以这里用绝对值进行比较，没有用比例。如果绝对值差别不大，说明此次掉0是具有周期性的，不算做异常。</p>
<p>从历史曲线中计算出周期长度的思路如下：</p>
<ul>
<li>
<p>因为非等间隔采样会破坏自相关计算的基础,需要先检测输入的监控点是否连续，相邻的时间戳的差是否相等。</p>
</li>
<li>
<p>使用自相关函数ACF计算自相关性,获得自相关系数，寻找有效自相关起点。</p>
</li>
<li>
<p>检测显著峰值。</p>
</li>
<li>
<p>如果有多个候选峰值，获得自相关值最大的位置，返回周期长度。</p>
</li>
</ul>
<p>对周期性下降检测处理后的结果如下，这种不会发送巡检异常消息，这里为了展示处理效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27747ab56a3f4e2c8e6a74a9a064bbcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=YnRfdGw9IGOxSd%2B4o5jKIBu3MmE%3D" alt="" loading="lazy"/></p>
<p>b.水位上升然后下降</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc05f65e9d94a7a807e8efe1ae18ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=hAFDFsO2zfiur4VjNEWpfFbrJ9E%3D" alt="" loading="lazy"/></p>
<p>上图这种下降后持续保持低位，可能是有任务导致的，IQR检测时取的近30分钟的数据，但定时任务可能执行很长时间，所以这里取近10个小时的监控数据，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a9324006454f88acf13c20639d0736~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=%2Fc76gJaBCdY84oaHs4FEj%2Fj1t70%3D" alt="" loading="lazy"/></p>
<p>需要把这种水位上升之前qps本来就很低的场景识别出来，这种场景不应该算作异常。水位异常变化的场景基于LevelShiftAD算法检测,和MySQL服务器CPU水位检测算法一样，检测结果如下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b450088821484050aaf985ac345e1638~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=ICJISzPoiUqD%2F0skM44CPpXIa0c%3D" alt="" loading="lazy"/></p>
<p>这样就获得了levelshift变化的异常点，但这种异常点有很多，例如上图中水位高的这部分中又有一个峰值(qps大于1000的这部分)，需要进行处理。</p>
<p>从iqr返回的异常点中获取最近一段连续的异常点，求最小值min_iqr，这个值就是最近的qps掉0时的值。</p>
<p>从levelshift返回到异常点中从右向左遍历，获取每组连续的异常点，剔除最右边的一组(这组是qps下降的点),获取剩下的异常点的值，因为窗口法滑动时有滞后性，所以还要获得每个异常点左边的window个点的值(window为一个窗口覆盖多少个点)，求最小值min_ls,比较min_iqr和min_ls的绝对值，如果水位增长前的点和iqr最近的异常点的差值在很小的一个范围内，或者min_ls比min_iqr还小，则认为水位前后的qps一样，不算做异常。</p>
<p>为了调试方便，把详细过程发送到消息里:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d2151016b7470fbfb0f6d6992f4d99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=M78fYr7%2Bc1JTs5r7%2BMGZm0aD5po%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">四、实战经验与调优</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33aba3da26054b538fa9de70066fce3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950682&amp;x-signature=se%2FC4QMr0y7g8%2BNo0d5PHQ9KoRI%3D" alt="" loading="lazy"/></p>
<p>目前我们已经在线上成功部署了CPU/磁盘/内存/表大小/QPS/扫描行数等十几个关键指标检测项，系统报警准确率在80%以上，显著提高了巡检效率，并有效减少了常规报警数量。</p>
<p>在算法策略方面， 我们认识到不同指标具有各自的数据特征，无法依赖单一算法覆盖所有场景。因此，我们通过对指标进行相似特征归类，提取其数学意义上的共性，对同一类指标采用适配的算法体系。目前通用算法已覆盖约 80% 的检测需求，其余部分则通过定制化逻辑精准补充。</p>
<p>我们将算法与业务场景深度结合，主动识别并过滤由 DDL 工单执行、数据迁移等不定期操作引起的指标波动。这类业务行为属于正常范畴，不应触发异常报警，从而有效降低误报率。</p>
<p>在阈值管理方面，采用动态与静态相结合的策略：动态阈值通过机器学习自动学习指标历史规律，实现敏感度的自适应调整；静态阈值则作为硬性边界，提供兜底保护，防止极端情况下的漏报。</p>
<p>针对报警通知，我们实施了多维收敛机制：纵向收敛基于时间窗口，对连续出现的同一报警进行合并与消息更新；横向收敛依托关联分析，对同一集群下多个实例的相同报警，或同一业务组内多个集群的同类报警进行聚合处理，从根源上避免告警风暴，提升告警可读性和可操作性。</p>
<h2 data-id="heading-13">五、未来展望</h2>
<p>在推进智能异常检测系统演进的过程中，我们坚持由简入繁、循序渐进的策略：首先从单指标异常检测入手，逐步拓展到多指标联合分析，最终实现自动化的根因定位。目前，去哪儿网DBA团队已在单指标检测方面覆盖绝大多数运维场景，并针对特定集群和业务需求完成了定制化处理，有效提升了检测的适用性与准确性。</p>
<p>当前，我们正稳步推进多指标联合异常检测的探索与实践，旨在通过指标间的关联分析进一步提升检测覆盖率和精准度。未来，系统将逐步承担更多自动化诊断工作，帮助DBA减少重复性巡检负担，使其能够将精力聚焦于更高价值的技术优化与紧急故障处置中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于npm包调用与环境兼容问题的解答]]></title>    <link>https://juejin.cn/post/7603252259561062436</link>    <guid>https://juejin.cn/post/7603252259561062436</guid>    <pubDate>2026-02-06T01:49:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603252259561062436" data-draft-id="7603252259561046052" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于npm包调用与环境兼容问题的解答"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-02-06T01:49:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我叫黑大帅"/> <meta itemprop="url" content="https://juejin.cn/user/1678295463898875"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于npm包调用与环境兼容问题的解答
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1678295463898875/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我叫黑大帅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T01:49:59.000Z" title="Fri Feb 06 2026 01:49:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">关于npm包调用与环境兼容问题的解答</h2>
<p>在前端开发和Node.js应用开发过程中，很多新手会遇到两个核心疑问：一是为什么Node.js中用JavaScript（JS）编写的npm包，用TypeScript（TS）代码能成功调用？二是为什么有些npm包能在Vue3中使用，有些却只能在Node.js中使用？本文将结合基础原理和实际场景，用通俗易懂的方式为大家梳理清楚这两个问题。</p>
<h3 data-id="heading-1">一、TS为何能成功调用JS编写的npm包？</h3>
<p>要搞懂这个问题，核心要抓住一个关键前提：TypeScript本身并不能被浏览器或Node.js直接运行，它最终一定会被编译成标准的JavaScript代码。这是TS能调用JS包的基础，具体可以从“执行层面”和“类型层面”两个维度拆解。</p>
<h4 data-id="heading-2">1. 执行层面：TS最终会转为JS运行</h4>
<p>Node.js和浏览器的运行时环境，只认识JavaScript代码，对TS代码是“无感知”的。我们在开发时编写的TS代码，无论是引入JS包还是编写业务逻辑，最终都需要通过TS编译器（tsc）或构建工具（如Vite、Webpack）编译，转换成纯JS代码后才能运行。</p>
<p>举个实际的例子：假设我们引入一个纯JS编写的npm包（比如名为js-written-package），编写的TS代码如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 编写的TS代码（index.ts）</span>
<span class="hljs-keyword">import</span> { sum } <span class="hljs-keyword">from</span> <span class="hljs-string">'js-written-package'</span>; <span class="hljs-comment">// 引入JS编写的npm包</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 调用包中的sum函数</span>
</code></pre>
<p>经过编译后，会生成Node.js能直接运行的JS代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 编译后的JS代码（index.js）</span>
<span class="hljs-keyword">const</span> { sum } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'js-written-package'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<p>从这个过程可以看出，Node.js实际运行的是编译后的JS代码，它根本不知道我们的源码是用TS写的，自然能正常调用JS编写的npm包——本质上还是JS与JS之间的调用。</p>
<h4 data-id="heading-3">2. 类型层面：类型声明文件解决TS类型校验问题</h4>
<p>TS的核心价值是“类型检查”，它会在开发阶段校验变量类型、函数参数、返回值等，避免类型错误。但纯JS编写的npm包，本身没有任何类型信息，直接在TS中引入时，TS编译器会报错（提示“找不到模块的类型声明文件”）。</p>
<p>为了解决这个问题，社区和包作者提供了三种主流方案，确保TS能“认识”JS包的类型：</p>
<ul>
<li>
<p><strong>方案1：包自带类型声明文件（.d.ts文件）</strong>：很多主流JS包（如axios、dayjs）在发布时，会特意附带后缀为.d.ts的类型声明文件。这个文件不包含任何可执行逻辑，只负责向TS编译器描述：这个包有哪些函数、函数的参数类型是什么、返回值类型是什么、有哪些属性等。TS编译器读取这个文件后，就能完成类型校验，不会再报错。</p>
</li>
<li>
<p><strong>方案2：社区公共类型库（@types/xxx）</strong>：对于一些老旧的JS包，作者可能没有提供自带的类型声明文件，这时社区会在@types命名空间下维护公共的类型声明。我们只需要通过npm安装对应的@types包，TS就能识别该JS包的类型。比如使用lodash（纯JS包）时，安装类型声明包：<code>npm install @types/lodash -D</code>，安装后TS就能正常校验lodash的类型了。</p>
</li>
<li>
<p><strong>方案3：忽略类型校验（兜底方案）</strong>：如果某个JS包既没有自带类型声明，也没有社区维护的@types包，我们还可以通过配置tsconfig.json文件，关闭严格类型检查（比如设置"strict": false），这时TS会把该JS包当作any类型（任意类型）处理，编译过程依然能正常通过，只是失去了TS的类型校验功能。</p>
</li>
</ul>
<h4 data-id="heading-4">3. 总结：TS调用JS包的完整流程</h4>
<ol>
<li>
<p>开发者编写TS代码，引入纯JS编写的npm包；</p>
</li>
<li>
<p>TS编译器通过.d.ts类型声明文件（自带或@types提供）获取包的类型信息，完成类型校验；</p>
</li>
<li>
<p>TS代码被编译为标准的JavaScript代码；</p>
</li>
<li>
<p>Node.js（或浏览器）运行编译后的JS代码，正常调用npm包的JS逻辑。</p>
</li>
</ol>
<h3 data-id="heading-5">二、为什么有些npm包适配Vue3，有些只适配Node.js？</h3>
<p>这个问题的核心答案的是：npm包的适用场景，由它所依赖的“运行环境API”决定。Vue3项目和Node.js的运行环境完全不同，二者支持的底层API不互通，这就导致了包的兼容性差异。</p>
<p>首先我们明确两个核心运行环境的区别：</p>























<table><thead><tr><th>运行环境</th><th>核心载体</th><th>专属API来源</th><th>核心特征</th></tr></thead><tbody><tr><td>浏览器环境（Vue3前端）</td><td>Chrome、Edge等浏览器</td><td>DOM API（document、element）、BOM API（window、location）</td><td>用于页面渲染、用户交互，无文件系统、服务端能力</td></tr><tr><td>Node.js环境</td><td>Node.js运行时（独立程序）</td><td>内置模块API（fs文件系统、path路径、http服务）</td><td>用于服务端开发、工具构建，无DOM、BOM对象</td></tr></tbody></table>
<blockquote>
<p>需要特别注意：Vue3项目并非完全脱离Node.js——开发和构建阶段（比如运行npm run dev、npm run build），Vue3的配置文件（如vite.config.ts、vue.config.js）是运行在Node.js环境中的；但Vue3的页面代码（如.vue文件中的脚本、组件），最终会运行在浏览器环境中。这也是很多人混淆包适配场景的关键。</p>
</blockquote>
<h4 data-id="heading-6">1. 四类npm包的适配场景解析</h4>
<p>根据依赖的API不同，npm包主要分为四类，适配场景各有差异：</p>
<h5 data-id="heading-7">（1）纯工具函数包：全环境通用（Vue3和Node.js都能用）</h5>
<p>这类包的核心特点是：不依赖任何环境专属API，只做纯逻辑计算（比如数学运算、字符串处理、数据格式化、日期处理等），代码本身是“环境无关”的，因此可以在任何JS运行时中执行。</p>
<p>典型例子：lodash（通用工具函数库）、dayjs（轻量日期处理库）、axios（请求库，兼容双环境）、moment（日期处理，已逐步被dayjs替代）。</p>
<p>使用示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. Node.js中使用</span>
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
_.<span class="hljs-title function_">debounce</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'延迟执行'</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// 防抖函数</span>

<span class="hljs-comment">// 2. Vue3项目中使用（&lt;script setup&gt;语法）</span>
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
<span class="hljs-keyword">const</span> handleClick = _.<span class="hljs-title function_">throttle</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'节流点击'</span>);
}, <span class="hljs-number">500</span>);
</code></pre>
<h5 data-id="heading-8">（2）Node.js专属包：仅Node.js可用（Vue3前端代码不可用）</h5>
<p>这类包的代码中，直接调用了Node.js的内置模块API（比如fs文件读写、path路径处理、http创建服务、child_process子进程等）。由于浏览器环境中没有这些API，一旦在Vue3的前端页面代码中引入并调用，浏览器会直接报错（比如“fs is not defined”“require is not defined”）。</p>
<p>典型例子：express（Node.js服务端框架）、koa（轻量服务端框架）、multer（文件上传处理库）、fs-extra（文件系统增强库）、dotenv（环境变量配置库）。</p>
<p>补充说明：这类包虽然不能用在Vue3的前端页面代码中，但可以用在Vue3的开发构建配置中（比如vite.config.ts），因为配置文件是运行在Node.js环境中的。</p>
<p>错误示例（Vue3前端代码中引入Node专属包）：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;script setup&gt;
<span class="hljs-comment">// 错误：在Vue3前端代码中引入fs-extra（Node专属包）</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs-extra'</span>;
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data); <span class="hljs-comment">// 浏览器会报错：fs is not defined</span>
});
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-9">（3）浏览器专属包：仅Vue3/前端可用（Node.js不可用）</h5>
<p>这类包依赖浏览器独有的API（比如window对象、document对象、DOM操作、Canvas绘图、CSS样式操作等），Node.js环境中没有这些对象和API，因此无法在Node.js中直接运行，调用时会报错（比如“window is not defined”“document is not defined”）。</p>
<p>典型例子：element-plus（Vue3 UI组件库）、vuetify（Vue3组件库）、chart.js（图表库）、swiper（轮播组件库）、dom-to-image（DOM转图片库）。</p>
<p>错误示例（Node.js中引入浏览器专属包）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误：在Node.js中引入element-plus（浏览器专属包）</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">ElButton</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'element-plus'</span>);
<span class="hljs-comment">// Node.js会报错：window is not defined</span>
</code></pre>
<h5 data-id="heading-10">（4）框架专属绑定包：仅对应框架可用</h5>
<p>这类包是为特定前端框架（如Vue3、React）专门封装的，依赖框架的核心API（比如Vue3的组合式API、React的Hooks API），只能在对应框架的项目中使用，在其他环境或框架中无法正常工作。</p>
<p>典型例子：@vueuse/core（Vue3组合式工具库）、vue-router（Vue3路由库）、pinia（Vue3状态管理库）、react-router-dom（React路由库）。</p>
<h4 data-id="heading-11">2. 快速判断npm包适配环境的3个方法</h4>
<p>开发中遇到一个新包，想快速知道它能在什么环境中使用，只需记住3个方法：</p>
<ul>
<li>
<p><strong>看npm官网文档</strong>：包的介绍页（比如npmjs.com上的包详情）会明确标注适用环境（比如“Browser &amp; Node.js”“Node.js only”“Vue3”），这是最准确的方式。</p>
</li>
<li>
<p><strong>看依赖的API</strong>：查看包的源码或文档，若依赖fs、path、http等 → 仅Node.js可用；若依赖window、document、DOM → 仅浏览器/Vue3可用；若不依赖任何专属API → 全环境通用。</p>
</li>
<li>
<p><strong>看包的分类</strong>：UI组件库、前端交互工具 → 浏览器/Vue3专用；服务端框架、文件处理工具 → Node.js专用；通用工具函数 → 全环境通用。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java基础-8：深入了解synchronized底层机制和完整使用指南（JDK 17+ 专项版）]]></title>    <link>https://juejin.cn/post/7603261102794735642</link>    <guid>https://juejin.cn/post/7603261102794735642</guid>    <pubDate>2026-02-06T02:48:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603261102794735642" data-draft-id="7603227363821944858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java基础-8：深入了解synchronized底层机制和完整使用指南（JDK 17+ 专项版）"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-02-06T02:48:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="beata"/> <meta itemprop="url" content="https://juejin.cn/user/1839900247461280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java基础-8：深入了解synchronized底层机制和完整使用指南（JDK 17+ 专项版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1839900247461280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    beata
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:48:21.000Z" title="Fri Feb 06 2026 02:48:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文基于 <strong>OpenJDK 17+</strong> 深度解析 <code>synchronized</code> 底层机制，重点阐明<strong>锁升级设计哲学</strong>、<strong>JDK 17+ 关键变更</strong>、<strong>明确禁用场景</strong>，助你精准驾驭并发编程。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、开篇：为何在 JDK 17+ 仍需精通 synchronized？</h2>
<p>尽管现代并发工具日益丰富，<code>synchronized</code> 仍是 Java 并发体系的<strong>基石级存在</strong>：</p>
<ul>
<li>✅ <strong>零失误安全</strong>：编译器自动释放锁，杜绝“忘 unlock”死锁</li>
<li>✅ <strong>JVM 深度优化</strong>：锁消除/粗化等 JIT 优化仅对 synchronized 生效</li>
<li>✅ <strong>诊断友好</strong>：<code>jstack</code>/JFR 直接识别锁状态</li>
<li>⚠️ <strong>但需清醒认知</strong>：JDK 17+ 已移除偏向锁，锁升级路径简化；且存在明确不适用场景</li>
</ul>
<p><strong>本文聚焦 JDK 17+ 真实环境，拒绝过时知识，直击实战痛点。</strong></p>
<hr/>
<h2 data-id="heading-1">二、底层原理：锁升级的“为什么”与“怎么做”（JDK 17+ 核心）</h2>
<h3 data-id="heading-2">2.1 为什么需要锁升级？—— 设计哲学深度解析</h3>
<p><strong>核心问题</strong>：为何不直接使用重量级锁？为何要“逐步升级”？</p>

































<table><thead><tr><th>锁方案</th><th>无竞争开销</th><th>低竞争开销</th><th>高竞争开销</th><th>CPU/OS 资源消耗</th></tr></thead><tbody><tr><td><strong>重量级锁</strong></td><td>极高（~1500ns）</td><td>高</td><td>中</td><td>线程挂起/唤醒（上下文切换）</td></tr><tr><td><strong>轻量级锁</strong></td><td>低（~50ns）</td><td>中</td><td>极高（自旋空转）</td><td>CPU 持续占用</td></tr><tr><td><strong>无锁</strong></td><td>0</td><td>0</td><td>不适用</td><td>无</td></tr></tbody></table>
<p><strong>锁升级的本质是“动态成本最优策略”</strong>：</p>
<ol>
<li><strong>避免“杀鸡用牛刀”</strong><br/>
无竞争场景下，重量级锁的系统调用、线程状态切换开销远超业务逻辑本身。轻量级锁通过 CAS + 栈帧存储，将开销降至纳秒级。</li>
<li><strong>防止“硬扛耗资源”</strong><br/>
高竞争时若坚持自旋（轻量级锁），CPU 会持续空转（100% 占用），导致系统吞吐崩塌。升级重量级锁让出 CPU，保障系统整体稳定性。</li>
<li><strong>自适应智能决策</strong><br/>
JVM 通过<strong>历史竞争数据</strong>动态调整：
<ul>
<li>自旋次数（<code>-XX:PreBlockSpin</code>）</li>
<li>升级阈值（如连续失败次数）<br/>
<em>实现“低竞争时轻量高效，高竞争时稳住大局”</em></li>
</ul>
</li>
</ol>
<blockquote>
<p>💡 <strong>关键洞见</strong>：锁升级不是“功能堆砌”，而是 JVM 对 <strong>“时间成本” vs “CPU 资源成本”</strong> 的精密权衡。现代应用多为短临界区、低竞争场景，轻量级锁成为 JDK 17+ 主力。</p>
</blockquote>
<h3 data-id="heading-3">2.2 JDK 17+ 锁升级路径（重大变更！）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cf3050665a242429eeee745c0e63ac7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmVhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770950901&amp;x-signature=VXWHSVUSJkxvMppfmH82D%2FHqmz8%3D" alt="synchronized-lock.png" loading="lazy"/></p>
<h4 data-id="heading-4">🔑 JDK 17+ 关键变更（JEP 420）</h4>





























<table><thead><tr><th>特性</th><th>JDK ≤14</th><th>JDK 15~16</th><th><strong>JDK 17+</strong></th></tr></thead><tbody><tr><td>偏向锁</td><td>默认启用</td><td>默认禁用（JEP 374）</td><td><strong>彻底移除</strong>（JEP 420）</td></tr><tr><td>升级路径</td><td>无锁→偏向→轻量→重量</td><td>同左（但偏向锁不生效）</td><td><strong>无锁→轻量→重量</strong></td></tr><tr><td>原因</td><td>单线程优化</td><td>撤销成本高，收益低</td><td>现代应用多线程竞争为主，维护成本 &gt; 收益</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>实践提示</strong>：</p>
<ul>
<li>无需再配置 <code>-XX:-UseBiasedLocking</code>（JDK 17+ 该参数已失效）</li>
<li>代码中避免依赖“偏向锁优化”，所有同步均按“轻量级锁起点”设计</li>
</ul>
</blockquote>
<h3 data-id="heading-5">2.3 底层流转详解（JDK 17+ 简化版）</h3>
<ol>
<li><strong>轻量级锁</strong>
<ul>
<li>线程栈创建 <code>Lock Record</code></li>
<li>CAS 将对象头 Mark Word 替换为指向 Lock Record 的指针</li>
<li><strong>优势</strong>：无系统调用，失败自旋（避免立即阻塞）</li>
<li><strong>触发升级</strong>：CAS 失败 + 自旋超限（由 JVM 动态计算）</li>
</ul>
</li>
<li><strong>重量级锁</strong>
<ul>
<li>对象头指向 <code>ObjectMonitor</code></li>
<li>竞争线程进入 <code>_EntryList</code> 阻塞（OS 级挂起）</li>
<li><strong>优势</strong>：释放 CPU 资源，避免空转</li>
<li><strong>代价</strong>：线程唤醒需上下文切换（~1000ns+）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">2.4 JIT 优化（JDK 17+ 依然生效）</h3>
<ul>
<li><strong>锁消除</strong>：逃逸分析确认锁对象不逃逸 → 移除同步
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// JIT 可消除锁（sb 为局部变量，无逃逸）</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">concat</span><span class="hljs-params">()</span> {
    <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(); <span class="hljs-comment">// 内部 synchronized append</span>
    sb.append(<span class="hljs-string">"a"</span>).append(<span class="hljs-string">"b"</span>);
    <span class="hljs-keyword">return</span> sb.toString();
}
</code></pre>
</li>
<li><strong>锁粗化</strong>：紧凑同步块合并，减少 monitorenter/exit 次数</li>
</ul>
<hr/>
<h2 data-id="heading-7">三、高频陷阱与避坑指南（JDK 17+ 验证）</h2>
<h3 data-id="heading-8">⚠️ 锁对象致命误区（附 JDK 17 验证代码）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 陷阱1：锁字符串字面量（字符串驻留导致全局锁）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-string">"config"</span>;
<span class="hljs-keyword">synchronized</span>(LOCK) { ... } <span class="hljs-comment">// 所有模块使用"config"处互斥！</span>

<span class="hljs-comment">// ❌ 陷阱2：锁自动拆装箱对象（锁对象变更）</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">synchronized</span>(count) {
    count++; <span class="hljs-comment">// count 指向新 Integer 对象！后续同步失效</span>
}

<span class="hljs-comment">// ✅ JDK 17+ 推荐写法</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <span class="hljs-comment">// final 确保引用不变</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">synchronized</span>(lock) {
        <span class="hljs-comment">// 临界区逻辑</span>
    }
}
</code></pre>
<h3 data-id="heading-9">⚠️ wait/notify 标准模板（防虚假唤醒）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span>(lock) {
    <span class="hljs-keyword">while</span> (!conditionMet) { <span class="hljs-comment">// 必须用 while！</span>
        lock.wait(); <span class="hljs-comment">// 释放锁，进入 WaitSet</span>
    }
    <span class="hljs-comment">// 执行业务</span>
    lock.notifyAll(); <span class="hljs-comment">// 优先 notifyAll 避免遗漏</span>
}
</code></pre>
<h3 data-id="heading-10">⚠️ 其他高危陷阱</h3>

























<table><thead><tr><th>陷阱</th><th>风险</th><th>JDK 17+ 解决方案</th></tr></thead><tbody><tr><td>静态/实例方法混用</td><td>锁对象不同（Class vs this）</td><td>显式注释锁范围，统一规范</td></tr><tr><td>子类覆盖未加锁</td><td>父类同步逻辑被绕过</td><td>子类方法显式添加 synchronized</td></tr><tr><td>锁内执行耗时 I/O</td><td>阻塞线程池，吞吐骤降</td><td>提前校验，锁外执行 I/O</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">四、何时绝对不能使用 synchronized？（关键决策清单）</h2>
<h3 data-id="heading-12">🚫 明确禁用场景（附替代方案）</h3>



























































<table><thead><tr><th>场景</th><th>为什么不能用 synchronized</th><th>推荐方案</th><th>原因说明</th></tr></thead><tbody><tr><td><strong>需要中断等待</strong></td><td>wait 可中断，但<strong>锁等待不可中断</strong></td><td><code>ReentrantLock.lockInterruptibly()</code></td><td>长时间阻塞需响应取消信号</td></tr><tr><td><strong>需超时获取锁</strong></td><td>无超时机制，易死锁</td><td><code>ReentrantLock.tryLock(timeout)</code></td><td>避免线程永久挂起</td></tr><tr><td><strong>需公平锁策略</strong></td><td>始终非公平，可能线程饥饿</td><td><code>new ReentrantLock(true)</code></td><td>保障请求顺序（如交易系统）</td></tr><tr><td><strong>多条件变量同步</strong></td><td>仅1个 wait set</td><td><code>ReentrantLock + 多 Condition</code></td><td>生产者-消费者等复杂模型</td></tr><tr><td><strong>读多写少且读写分离</strong></td><td>读写互斥，吞吐瓶颈</td><td><code>ReentrantReadWriteLock</code></td><td>读操作并发提升 5-10 倍</td></tr><tr><td><strong>分布式系统跨 JVM</strong></td><td>仅限单 JVM 内部</td><td>Redisson / ZooKeeper 锁</td><td>服务集群需全局协调</td></tr><tr><td><strong>高性能计数器（高竞争）</strong></td><td>重量级锁开销大</td><td><code>LongAdder</code> / <code>Striped64</code></td><td>无锁分段累加，吞吐提升百倍</td></tr><tr><td><strong>需锁状态监控埋点</strong></td><td>无法获取持有者/等待队列信息</td><td><code>ReentrantLock.getQueueLength()</code></td><td>运维监控、动态降级需求</td></tr></tbody></table>
<h3 data-id="heading-13">💡 决策心法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码：选择逻辑</span>
<span class="hljs-keyword">if</span> (需要中断 || 需要超时 || 需要公平锁 || 多条件变量) {
    选 ReentrantLock;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (读 &gt;&gt; 写 &amp;&amp; 读写可分离) {
    选 ReadWriteLock;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (单变量原子操作) {
    选 AtomicXXX / LongAdder;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (跨 JVM) {
    选分布式锁;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// ✅ 90% 场景：选 synchronized（安全、简洁、JVM 优化友好）</span>
    <span class="hljs-keyword">synchronized</span>(lock) { ... }
}
</code></pre>
<hr/>
<h2 data-id="heading-14">五、synchronized vs 其他机制（JDK 17+ 对比）</h2>









































<table><thead><tr><th><strong>维度</strong></th><th><strong>synchronized</strong></th><th><strong>ReentrantLock</strong></th><th><strong>Atomic/LongAdder</strong></th></tr></thead><tbody><tr><td><strong>自动释放</strong></td><td>✅（编译器保障）</td><td>❌（需 finally unlock）</td><td>N/A</td></tr><tr><td><strong>JVM 优化</strong></td><td>✅（锁消除/粗化）</td><td>❌</td><td>✅（ intrinsic 优化）</td></tr><tr><td><strong>诊断友好度</strong></td><td>✅（jstack/JFR 直接可见）</td><td>⚠️（需代码埋点）</td><td>✅</td></tr><tr><td><strong>高竞争吞吐</strong></td><td>中（重量级锁开销）</td><td>中（可调优）</td><td><strong>极高</strong>（LongAdder 分段）</td></tr><tr><td><strong>适用场景</strong></td><td>通用同步、低竞争、代码简洁优先</td><td>需高级特性、高竞争精细控制</td><td>计数器、状态标志</td></tr></tbody></table>
<blockquote>
<p>📊 <strong>JDK 17+ 性能实测参考</strong>（无竞争场景）：<br/>
<code>synchronized</code> ≈ <code>ReentrantLock</code>（纳秒级差异）<br/>
<strong>结论</strong>：无特殊需求时，synchronized 因“零失误安全”成为首选。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">六、JDK 17+ 最佳实践与诊断</h2>
<h3 data-id="heading-16">✅ 黄金准则</h3>
<ol>
<li><strong>锁对象</strong>：<code>private final Object lock = new Object();</code>（杜绝非 final 引用）</li>
<li><strong>锁粒度</strong>：仅包裹临界区，I/O、RPC、耗时计算移至锁外</li>
<li><strong>优先工具类</strong>：<code>ConcurrentHashMap</code>、<code>CopyOnWriteArrayList</code>、<code>LongAdder</code></li>
<li><strong>wait 模板</strong>：<code>while</code> 判断 + <code>notifyAll</code></li>
</ol>
<h3 data-id="heading-17">🔍 JDK 17+ 诊断利器</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 死锁检测（直接定位）</span>
jstack &lt;pid&gt; | grep -A 20 <span class="hljs-string">"deadlock"</span>

<span class="hljs-comment"># 2. JFR（Java Flight Recorder）监控锁竞争</span>
java -XX:+FlightRecorder -XX:StartFlightRecording=duration=60s,filename=recording.jfr MyApp
<span class="hljs-comment"># 使用 JDK Mission Control 分析 "Java Monitor Blocked" 事件</span>

<span class="hljs-comment"># 3. 锁粗化效果验证（需开启）</span>
-XX:+PrintEliminateLocks  <span class="hljs-comment"># 观察锁消除日志</span>
</code></pre>
<h3 data-id="heading-18">🌐 JDK 17+ 版本注意事项</h3>

























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>偏向锁</td><td><strong>已彻底移除</strong>，无需关注相关配置与行为</td></tr><tr><td>锁升级起点</td><td>所有同步操作起点为<strong>轻量级锁</strong></td></tr><tr><td>推荐 JVM 参数</td><td>无需特殊配置；高并发服务可微调 <code>-XX:PreBlockSpin</code>（默认自适应）</td></tr><tr><td>逃逸分析</td><td>依然生效，合理编写代码可触发锁消除（局部对象同步）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-19">七、总结：JDK 17+ 下的 synchronized 使用心法</h2>
<h3 data-id="heading-20">🌟 三大核心认知</h3>
<ol>
<li>
<p><strong>锁升级是“成本动态平衡术”</strong><br/>
轻量级锁（低开销）与重量级锁（保系统）的智能切换，是 JVM 对并发场景的深度理解。<strong>无需手动干预，信任 JVM 自适应机制</strong>。</p>
</li>
<li>
<p><strong>synchronized 是“安全网”，非“万能锤”</strong></p>
<ul>
<li>✅ 用它：通用同步、代码简洁性优先、避免人为失误</li>
<li>❌ 不用它：需中断/超时/公平锁/分布式/读写分离等明确场景（见第四章清单）</li>
</ul>
</li>
<li>
<p><strong>JDK 17+ 是新起点</strong><br/>
偏向锁移除标志着 JVM 向“现代多线程应用”全面对齐。<strong>聚焦轻量级锁优化逻辑，摒弃过时认知</strong>。</p>
</li>
</ol>
<h3 data-id="heading-21">💬 最后忠告</h3>
<blockquote>
<p>“不要因为 ReentrantLock 有更多功能就滥用它。<br/>
synchronized 的自动释放特性，是无数生产事故的‘隐形守护者’。”<br/>
—— 源自多年线上故障复盘</p>
</blockquote>
<p><strong>正确姿势</strong>：<br/>
1️⃣ 优先用 synchronized 保证逻辑正确<br/>
2️⃣ 通过 JFR/Arthas <strong>实测</strong>锁竞争热点<br/>
3️⃣ 仅在<strong>明确需求+数据支撑</strong>下替换为高级锁</p>
<blockquote>
<p>本文所有结论均基于 OpenJDK 17.0.10+ 验证。<br/>
代码有边界，认知需迭代 —— 愿你的并发之路，稳如 Monitor，快如 CAS。</p>
</blockquote>
<blockquote>
<p><strong>作者</strong>：架构师Beata<br/>
<strong>日期</strong>：2026年2月5日
<strong>声明</strong>：本文基于生产实践与源码分析，如有疏漏，欢迎指正。转载请注明出处。<br/>
<strong>互动</strong>：你在使用synchronized时遇到过哪些坑？欢迎在评论区分享！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[APISIX 网关如何实现验签]]></title>    <link>https://juejin.cn/post/7603267434502340623</link>    <guid>https://juejin.cn/post/7603267434502340623</guid>    <pubDate>2026-02-06T02:53:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603267434502340623" data-draft-id="7603238967291379764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="APISIX 网关如何实现验签"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-02-06T02:53:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="海尔智慧家技术平台"/> <meta itemprop="url" content="https://juejin.cn/user/3848721122725016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            APISIX 网关如何实现验签
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7156434854350389283/posts" data-v-d326b38e=""><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4176c1a2e0b4e1b986f105126840cc9~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7156434854350389283/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="三翼鸟数字化技术团队" class="title" data-v-d326b38e="">三翼鸟数字化技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-02-06T02:53:19.000Z" title="Fri Feb 06 2026 02:53:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-02-06
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读10分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              @海尔优家智能科技（北京）有限公司
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 APISIX（云原生 API 网关）中实现<strong>接口验签逻辑</strong>，核心是通过其<strong>插件机制</strong>完成 —— 利用 APISIX 内置的验签相关插件（如<code>hmac-auth</code>、<code>jwt-auth</code>）或自定义 Lua 插件，拦截请求并执行签名验证流程，确保请求来源合法、数据未被篡改。</p>
<h2 data-id="heading-0">1. APISIX 验签的核心原理</h2>
<p>APISIX 的请求处理流程为：<code>请求进入 → 插件执行（顺序可配置） → 转发至上游服务</code>。验签逻辑本质是在<strong>插件执行阶段</strong>，通过以下步骤实现：</p>
<ol>
<li><strong>提取</strong> <strong>签名</strong> <strong>相关参数</strong>：从请求头（如<code>X-Signature</code>、<code>Authorization</code>）、请求参数或 Body 中，提取签名值、时间戳、随机串、AccessKey 等验签必需信息。</li>
<li><strong>生成待验签串</strong>：按照业务约定的规则（如 “参数按 ASCII 排序 + 拼接时间戳 + 密钥”），重组请求中的关键数据（如请求参数、Body、时间戳），生成 “待验签字符串”。</li>
<li><strong>执行</strong> <strong>签名</strong> <strong>验证</strong>：使用与客户端约定的算法（如 HMAC-SHA256、RSA），结合预设的密钥（或公钥）对 “待验签串” 进行签名，对比生成的签名与请求中提取的签名是否一致。</li>
<li><strong>拦截或放行</strong>：验证通过则继续转发请求至上游；验证失败（如签名不匹配、时间戳过期）则直接返回 401/403 错误，拦截请求。</li>
</ol>
<h2 data-id="heading-1">2. APISIX 实现验签的 3 种常见方式</h2>
<p>根据业务场景（如是否需要自定义验签规则、签名算法类型），APISIX 提供了 “内置插件”“自定义 Lua 插件”“集成外部服务” 三种实现方式，以下详细说明：</p>
<h3 data-id="heading-2">方式 1：使用 APISIX 内置验签插件（推荐，无需编码）</h3>
<p>APISIX 提供了多个成熟的内置插件，覆盖主流验签场景（如 HMAC 对称加密、JWT 令牌、Basic Auth），无需编写代码，仅需通过配置即可启用。</p>
<h4 data-id="heading-3">1.1 HMAC 对称加密验签（<code>hmac-auth</code>插件）</h4>
<p>适用于<strong>客户端与</strong> <strong>网关</strong> <strong>共享</strong> <strong>密钥</strong>的场景（如内部服务间调用），基于 HMAC 算法（如 HMAC-SHA256）验证签名，支持防重放（通过时间戳 + nonce）。</p>
<p>核心配置步骤：</p>
<p><strong>（1）创建 Consumer（消费者，即客户端身份）</strong> 为每个客户端配置唯一的<code>access_key</code>（标识客户端）和<code>secret_key</code>（对称密钥，需客户端与网关一致），并绑定<code>hmac-auth</code>插件。示例（通过 APISIX Admin API 配置）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建Consumer并启用hmac-auth插件curl http://apisix-admin:9180/apisix/admin/consumers -X PUT -d '</span>
{
  <span class="hljs-string">"username"</span>: <span class="hljs-string">"client_001"</span>,  <span class="hljs-comment"># Consumer名称（自定义）</span>
  <span class="hljs-string">"plugins"</span>: {
    <span class="hljs-string">"hmac-auth"</span>: {
      <span class="hljs-string">"access_key"</span>: <span class="hljs-string">"AK123456"</span>,  <span class="hljs-comment"># 客户端唯一标识（客户端需携带）</span>
      <span class="hljs-string">"secret_key"</span>: <span class="hljs-string">"SKabcdef123456"</span>,  <span class="hljs-comment"># 对称密钥（客户端与网关共享，需保密）</span>
      <span class="hljs-string">"sign_header"</span>: <span class="hljs-string">"X-HMAC-Signature"</span>,  <span class="hljs-comment"># 请求头中签名的字段名</span>
      <span class="hljs-string">"clock_skew"</span>: 300,  <span class="hljs-comment"># 允许的时间戳偏差（秒，防重放）</span>
      <span class="hljs-string">"nonce_header"</span>: <span class="hljs-string">"X-HMAC-Nonce"</span>,  <span class="hljs-comment"># 请求头中随机串的字段名</span>
      <span class="hljs-string">"timestamp_header"</span>: <span class="hljs-string">"X-HMAC-Timestamp"</span>  <span class="hljs-comment"># 请求头中时间戳的字段名</span>
    }
  }
}<span class="hljs-string">'
</span></code></pre>
<p><strong>（2）为 Route/</strong> <strong>Service</strong> <strong>绑定</strong> <strong><code>hmac-auth</code></strong> <strong>插件</strong>将插件应用到需要验签的路由（Route）或服务（Service），确保该路由的所有请求都必须通过 HMAC 验签。示例（为 Route 配置）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 为Route 1绑定hmac-auth插件curl http://apisix-admin:9180/apisix/admin/routes/1 -X PUT -d '</span>
{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"/api/v1/order/*"</span>,  <span class="hljs-comment"># 需验签的接口路径</span>
  <span class="hljs-string">"upstream"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"roundrobin"</span>,
    <span class="hljs-string">"nodes"</span>: {<span class="hljs-string">"192.168.1.100:8080"</span>: 1}  <span class="hljs-comment"># 上游服务地址</span>
  },
  <span class="hljs-string">"plugins"</span>: {
    <span class="hljs-string">"hmac-auth"</span>: {}  <span class="hljs-comment"># 启用插件（无需额外配置，复用Consumer的插件参数）</span>
  }
}<span class="hljs-string">'
</span></code></pre>
<p><strong>（3）客户端请求示例</strong></p>
<p>  客户端需按以下规则生成签名并携带请求头：</p>
<ul>
<li>生成<code>nonce</code>（随机串，如<code>abc123</code>）、<code>timestamp</code>（当前时间戳，如<code>1690000000</code>）；</li>
<li>待验签串规则：<code>method + uri + timestamp + nonce + body</code>（具体规则可通过插件参数<code>sign_params</code>自定义）；</li>
<li>使用<code>secret_key</code>对 “待验签串” 进行 HMAC-SHA256 加密，得到签名值；</li>
<li>请求头携带：<code>X-HMAC-AccessKey: AK123456</code>、<code>X-HMAC-Timestamp: 1690000000</code>、<code>X-HMAC-Nonce: abc123</code>、<code>X-HMAC-Signature: 签名值</code>。</li>
</ul>
<h4 data-id="heading-4">1.2 JWT 令牌验签（<code>jwt-auth</code>插件）</h4>
<p>适用于<strong>分布式</strong> <strong>系统、用户认证</strong>场景，客户端先通过登录接口获取 JWT 令牌，后续请求携带令牌，网关通过公钥验证令牌有效性（支持对称 / 非对称加密）。</p>
<p>核心配置步骤：</p>
<p><strong>（1）创建 Consumer 并配置</strong> <strong>JWT</strong> <strong>参数</strong>示例（对称加密，使用<code>secret</code>验证；非对称加密需配置<code>public_key</code>）：</p>
<pre><code class="hljs language-csharp" lang="csharp">curl http:<span class="hljs-comment">//apisix-admin:9180/apisix/admin/consumers -X PUT -d '</span>
{
  <span class="hljs-string">"username"</span>: <span class="hljs-string">"user_001"</span>,
  <span class="hljs-string">"plugins"</span>: {
    <span class="hljs-string">"jwt-auth"</span>: {
      <span class="hljs-string">"secret"</span>: <span class="hljs-string">"jwt_secret_123"</span>,  <span class="hljs-meta"># 对称密钥（非对称加密用public_key替代）</span>
      <span class="hljs-string">"algorithm"</span>: <span class="hljs-string">"HS256"</span>,  <span class="hljs-meta"># 算法（HS256=对称，RS256=非对称）</span>
      <span class="hljs-string">"exp"</span>: <span class="hljs-number">3600</span>,  <span class="hljs-meta"># 令牌过期时间（秒）</span>
      <span class="hljs-string">"token_header"</span>: <span class="hljs-string">"Authorization"</span>,  <span class="hljs-meta"># 携带令牌的请求头（如Bearer Token）</span>
      <span class="hljs-string">"token_prefix"</span>: <span class="hljs-string">"Bearer "</span>  <span class="hljs-meta"># 令牌前缀（如"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."）</span>
    }
  }
}<span class="hljs-string">'
</span></code></pre>
<p><strong>（2）为 Route 绑定</strong> <strong><code>jwt-auth</code></strong> <strong>插件</strong>确保请求需携带有效 JWT 令牌才能访问：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">curl http://apisix-admin:<span class="hljs-number">9180</span>/apisix/admin/routes/<span class="hljs-number">2</span> -X PUT -d <span class="hljs-comment">'</span>
{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"/api/v1/user/*"</span>,
  <span class="hljs-string">"upstream"</span>: {<span class="hljs-string">"nodes"</span>: {<span class="hljs-string">"192.168.1.101:8080"</span>: <span class="hljs-number">1</span>}},
  <span class="hljs-string">"plugins"</span>: {<span class="hljs-string">"jwt-auth"</span>: {}}
}<span class="hljs-comment">'</span>
</code></pre>
<p><strong>（3）客户端请求示例</strong></p>
<ul>
<li>登录获取 JWT 令牌：客户端通过登录接口（如<code>/login</code>）提交账号密码，上游服务生成 JWT 令牌（使用<code>secret</code>签名）返回给客户端；</li>
<li>后续请求携带令牌：请求头添加<code>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</code>，APISIX 验证令牌签名及过期时间。</li>
</ul>
<h3 data-id="heading-5">方式 2：自定义 Lua 插件（适合复杂自定义验签规则）</h3>
<p>若内置插件无法满足业务需求（如特殊签名算法、复杂验签逻辑），可基于 APISIX 的<strong>Lua 插件开发框架</strong>编写自定义验签插件，完全控制验签流程。</p>
<p>核心开发步骤：</p>
<p><strong>（1）创建插件目录与文件</strong>APISIX 插件默认存放在<code>/usr/local/apisix/plugins/</code>目录，新建自定义插件文件（如<code>custom-sign.lua</code>）。</p>
<p><strong>（2）编写插件核心逻辑</strong>插件需实现<code>rewrite</code>（请求转发前执行）或<code>access</code>（权限校验阶段）方法，在方法中编写验签逻辑。示例（自定义 HMAC 验签插件核心代码）：</p>
<pre><code class="hljs language-ini" lang="ini">local <span class="hljs-attr">core</span> = require(<span class="hljs-string">"apisix.core"</span>)local hmac = require(<span class="hljs-string">"resty.hmac"</span>)-- 插件Schema（定义配置参数，如secret_key、sign_header）local schema = {
  <span class="hljs-attr">type</span> = <span class="hljs-string">"object"</span>,
  <span class="hljs-attr">properties</span> = {
    <span class="hljs-attr">secret_key</span> = {type = <span class="hljs-string">"string"</span>},  -- 对称密钥
    <span class="hljs-attr">sign_header</span> = {type = <span class="hljs-string">"string"</span>, default = <span class="hljs-string">"X-Custom-Sign"</span>},  -- 签名请求头
    <span class="hljs-attr">timestamp_header</span> = {type = <span class="hljs-string">"string"</span>, default = <span class="hljs-string">"X-Custom-Timestamp"</span>}  -- 时间戳请求头},
  <span class="hljs-attr">required</span> = {<span class="hljs-string">"secret_key"</span>}}-- 插件主逻辑（access阶段执行）local function access(conf, ctx)-- <span class="hljs-number">1</span>. 提取请求中的验签参数local req_sign = core.request.header(ctx, conf.sign_header)local req_timestamp = core.request.header(ctx, conf.timestamp_header)local req_method = core.request.get_method(ctx)local req_uri = ctx.var.uri
  local <span class="hljs-attr">req_body</span> = core.request.get_body(ctx)  -- 需开启body读取（在APISIX配置中设置）-- <span class="hljs-number">2</span>. 校验必要参数是否存在if not req_sign or not req_timestamp thenreturn <span class="hljs-number">401</span>, {message = <span class="hljs-string">"missing sign or timestamp"</span>}end-- <span class="hljs-number">3</span>. 校验时间戳（防重放，允许<span class="hljs-number">5</span>分钟偏差）local current_ts = ngx.time()if math.abs(current_ts - tonumber(req_timestamp)) &gt; <span class="hljs-number">300</span> thenreturn <span class="hljs-number">401</span>, {message = <span class="hljs-string">"timestamp expired"</span>}end-- <span class="hljs-number">4</span>. 生成待验签串（按业务规则拼接）local sign_str = string.format(<span class="hljs-string">"%s%s%s%s"</span>, req_method, req_uri, req_timestamp, req_body or <span class="hljs-string">""</span>)-- <span class="hljs-number">5</span>. 计算HMAC签名并对比local hmac_obj = hmac:new(conf.secret_key, hmac.ALGOS.SHA256)local computed_sign = hmac_obj:final(sign_str, <span class="hljs-literal">true</span>)  -- <span class="hljs-literal">true</span>表示返回hex格式if computed_sign ~= req_sign thenreturn <span class="hljs-number">403</span>, {message = <span class="hljs-string">"invalid signature"</span>}end-- <span class="hljs-number">6</span>. 验签通过，继续转发请求returnend-- 注册插件return {
  <span class="hljs-attr">version</span> = <span class="hljs-number">0.1</span>,
  <span class="hljs-attr">priority</span> = <span class="hljs-number">2000</span>,  -- 插件执行优先级（数值越大越先执行）
  <span class="hljs-attr">name</span> = <span class="hljs-string">"custom-sign"</span>,  -- 插件名称
  <span class="hljs-attr">schema</span> = schema,
  <span class="hljs-attr">access</span> = access  -- 绑定access阶段执行}
</code></pre>
<p><strong>（3）启用自定义插件</strong></p>
<ul>
<li>在 APISIX 配置文件（<code>config.yaml</code>）中添加插件到<code>plugins</code>列表，确保 APISIX 加载插件：</li>
</ul>
<pre><code class="hljs language-markdown" lang="markdown">plugins:
<span class="hljs-bullet">  -</span> custom-sign  # 添加自定义插件名称
<span class="hljs-bullet">  -</span> hmac-auth
<span class="hljs-bullet">  -</span> jwt-auth
</code></pre>
<ul>
<li>重启 APISIX：<code>apisix restart</code>；</li>
<li>为 Consumer 和 Route 绑定<code>custom-sign</code>插件（同内置插件配置方式）。</li>
</ul>
<h3 data-id="heading-6">方式 3：集成外部验签服务（适合验签逻辑独立部署）</h3>
<p>若验签逻辑复杂（如依赖数据库查询密钥、多系统共享验签服务），可通过 APISIX 的<code>ext-plugin</code>（外部插件）或<code>http-logger</code>+<code>request-validator</code>，将验签请求转发到外部服务（如 Java/Python 编写的验签服务），由外部服务返回验签结果，APISIX 根据结果决定是否放行。</p>
<p>核心实现思路：</p>
<p><strong>（1）部署外部验签服务</strong></p>
<p>开发一个验签 API（如<code>http://sign-service:8080/verify</code>），接收 APISIX 转发的请求参数（如请求头、Body、路径），执行验签逻辑，返回<code>{"success": true/false, "message": "..."}</code>。</p>
<p><strong>（2）APISIX 配置转发与结果判断</strong>使用<code>ext-plugin</code>的<code>pre-req</code>（请求前调用外部服务）功能，或通过<code>proxy-rewrite</code>将请求转发到验签服务，再通过<code>response-rewrite</code>判断结果：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 示例：为Route配置外部验签服务curl http://apisix-admin:9180/apisix/admin/routes/3 -X PUT -d '</span>
{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"/api/v1/pay/*"</span>,
  <span class="hljs-string">"plugins"</span>: {
    <span class="hljs-string">"ext-plugin-pre-req"</span>: {
      <span class="hljs-string">"conf"</span>: [
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">"ext-plugin-http"</span>,  <span class="hljs-comment"># 调用外部HTTP服务的插件</span>
          <span class="hljs-string">"value"</span>: '{<span class="hljs-string">"uri"</span>:<span class="hljs-string">"http://sign-service:8080/verify"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"POST"</span>,<span class="hljs-string">"timeout"</span>:500}'
        }
      ]
    }
  },
  <span class="hljs-string">"upstream"</span>: {<span class="hljs-string">"nodes"</span>: {<span class="hljs-string">"192.168.1.102:8080"</span>: 1}}
}'
</code></pre>
<p>外部验签服务返回<code>success: false</code>时，APISIX 直接拦截请求并返回错误。</p>
<h2 data-id="heading-7">3. 验签配置的最佳实践</h2>
<ol>
<li>
<p><strong>密钥管理</strong></p>
<ol>
<li>对称密钥（如<code>hmac-auth</code>的<code>secret_key</code>）需通过 APISIX 的<strong>配置中心</strong>（如 etcd、Nacos）管理，避免硬编码；</li>
<li>非对称加密（如 JWT RS256）需定期轮换公钥 / 私钥，确保密钥安全。</li>
</ol>
</li>
<li>
<p><strong>防重放攻击</strong></p>
<ol>
<li>必须加入 “时间戳 + nonce” 机制（如<code>hmac-auth</code>的<code>clock_skew</code>和<code>nonce_header</code>），防止攻击者复用旧签名；</li>
<li>可通过 APISIX 的<code>redis</code>插件缓存已使用的<code>nonce</code>，避免重复使用。</li>
</ol>
</li>
<li>
<p><strong>性能优化</strong></p>
<ol>
<li>自定义插件中避免频繁 IO 操作（如数据库查询），可将密钥缓存到 APISIX 本地（如<code>core.lrucache</code>）；</li>
<li>对于大 Body 请求，验签时可仅对 Body 的哈希值（如 MD5）进行签名，减少数据处理量。</li>
</ol>
</li>
<li>
<p><strong>日志与监控</strong></p>
<ol>
<li>启用 APISIX 的<code>error-log-logger</code>和<code>access-logger</code>，记录验签失败日志（如签名不匹配、时间戳过期）；</li>
<li>通过 APISIX 的监控插件（如<code>prometheus</code>）统计验签成功率，及时发现异常请求。</li>
</ol>
</li>
</ol>
<h2 data-id="heading-8">4. 常见问题排查</h2>
<ol>
<li>
<p><strong>验签失败但客户端确认</strong> <strong>签名</strong> <strong>正确</strong></p>
<ol>
<li>检查 “待验签串” 的拼接规则是否与客户端一致（如参数排序、是否包含 Body、大小写敏感）；</li>
<li>确认 APISIX 是否正确读取请求 Body（需在<code>config.yaml</code>中设置<code>proxy_body_temp_path</code>，并确保插件启用 Body 读取）。</li>
</ol>
</li>
<li>
<p><strong>JWT 令牌验证失败</strong></p>
<ol>
<li>检查<code>algorithm</code>是否匹配（如客户端用 HS256，网关配置 RS256）；</li>
<li>确认令牌未过期（<code>exp</code>字段），且<code>secret</code>/<code>public_key</code>与客户端签名时使用的密钥一致。</li>
</ol>
</li>
<li>
<p><strong>自定义插件不生效</strong></p>
<ol>
<li>检查插件是否添加到 APISIX 的<code>plugins</code>列表中；</li>
<li>通过 APISIX 日志（<code>/usr/local/apisix/logs/error.log</code>）查看插件执行报错信息。</li>
</ol>
</li>
</ol>
<h2 data-id="heading-9">5.团队介绍</h2>
<p>「<strong>智慧家技术平台-应用软件框架开发</strong>」主要负责设计工具的研发，包括营销设计工具、家电VR设计和展示、水电暖通前置设计能力，研发并沉淀素材库，构建家居家装素材库，集成户型库、全品类产品库、设计方案库、生产工艺模型，打造基于户型和风格的AI设计能力，快速生成算量和报价；同时研发了门店设计师中心和项目中心，包括设计师管理能力和项目经理管理能力。实现了场景全生命周期管理，同时为水，空气，厨房等产业提供商机管理工具，从而实现了以场景贯穿的B端C端全流程系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从回调函数到Promise]]></title>    <link>https://juejin.cn/post/7603246733318144054</link>    <guid>https://juejin.cn/post/7603246733318144054</guid>    <pubDate>2026-02-06T02:50:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603246733318144054" data-draft-id="7603282168137023507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从回调函数到Promise"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2026-02-06T02:50:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="夜尽丶"/> <meta itemprop="url" content="https://juejin.cn/user/3263006244342062"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从回调函数到Promise
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006244342062/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    夜尽丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:50:15.000Z" title="Fri Feb 06 2026 02:50:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在面试中遇到了很多关于 <code>Promise</code> 的问题，因为以前的业务在请求方面并不复杂，多数时候都是在用 <code>async/await</code>，对 <code>Promise</code> 的理解还是有所欠缺，最近重新学习了一下 <code>Promise</code>，尽量避免写成API式的文章，主要还是结合自己的一些理解和思考来整理一下。</p>
<h2 data-id="heading-0">为什么要使用 Promise</h2>
<p>众所周知，JavaScript 的主线程是单线程执行的，所有的同步代码都是在一个线程中执行的，当遇到一些耗时操作时（比如网络请求、文件读取等），如果采用同步的方式去处理这些操作，就会阻塞主线程，导致页面卡顿，用户体验变差。为了解决这个问题，我们发明了异步编程，最早的异步编程方式是回调函数（Callback），我们先看一个简单的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">getX, getY, finalCallback</span>) {
  <span class="hljs-keyword">var</span> x, y;
  <span class="hljs-title function_">getX</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">xVal</span>) {
    x = xVal;
    <span class="hljs-keyword">if</span> (y !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-title function_">finalCallback</span>(x + y);
    }
  });

  <span class="hljs-title function_">getY</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">yVal</span>) {
    y = yVal;
    <span class="hljs-keyword">if</span> (x !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-title function_">finalCallback</span>(x + y);
    }
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchX</span>(<span class="hljs-params">xCallback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-title function_">xCallback</span>(<span class="hljs-number">2</span>);
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchY</span>(<span class="hljs-params">yCallback</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-title function_">yCallback</span>(<span class="hljs-number">3</span>);
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-title function_">add</span>(fetchX, fetchY, <span class="hljs-keyword">function</span> (<span class="hljs-params">sum</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Sum is: "</span> + sum);
});
</code></pre>
<p><code>fetchX</code> 和 <code>fetchY</code> 是两个异步函数，分别模拟从服务器获取数据的过程，我们要进行 <code>x+y</code> 的计算，如果它们中的任何一个还没有准备好，就等待两者都准备好。我们逐步拆解这个过程：</p>
<ol>
<li>
<p>调用 <code>add</code> 函数，传入 <code>fetchX</code>、<code>fetchY</code> 和回调函数。</p>
</li>
<li>
<p>在 <code>add</code> 函数内部，调用 <code>getX</code>（即 <code>fetchX</code>），传入一个回调函数。</p>
</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> (<span class="hljs-params">xVal</span>) {
  x = xVal;
  <span class="hljs-keyword">if</span> (y !== <span class="hljs-literal">undefined</span>) {
    <span class="hljs-title function_">finalCallback</span>(x + y);
  }
}
</code></pre>
<ol start="3">
<li>
<p><code>fetchX</code> 开始执行，经过1秒钟后，调用传入的回调函数（<code>xCallback</code>），将 <code>2</code> 作为参数传递进去。</p>
</li>
<li>
<p>回调函数执行，<code>x</code> 被赋值为 <code>2</code>，然后检查 <code>y</code> 是否已经准备好（即 <code>y</code> 是否不为 <code>undefined</code>）。此时 <code>y</code> 还没有准备好，所以不会调用最终的 <code>finalCallback</code>。</p>
</li>
<li>
<p>同样的过程发生在 <code>getY</code>（即 <code>fetchY</code>）上，经过1秒钟后，<code>y</code> 被赋值为 <code>3</code>，然后检查 <code>x</code> 是否已经准备好。此时 <code>x</code> 已经准备好了（<code>x=2</code>），所以调用 <code>finalCallback</code>，计算出最终的结果 <code>5</code>，并打印出来。</p>
</li>
</ol>
<p>从这个例子中，我们是否能看出使用回调函数来处理异步操作存在一些问题？首先，也许这个思路很巧妙，但是代码很复杂，我在逐步拆解前很难直接理解这个过程。其次，如果有更多的异步操作需要处理，代码会变得更加复杂，难以维护，这就是著名的“回调地狱”问题。</p>
<p>回想我刚上班时，使用的还是 jQuery，jQuery 的 Ajax 请求就是基于回调函数的，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">$.<span class="hljs-title function_">ajax</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">"https://api.example.com/data"</span>,
  <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>,
  <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Data received:"</span>, data);
    $.<span class="hljs-title function_">ajax</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">"https://api.example.com/more-data"</span>,
      <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>,
      <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">moreData</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"More data received:"</span>, moreData);
        <span class="hljs-comment">// 继续嵌套更多的回调...</span>
      },
      <span class="hljs-attr">error</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error fetching more data:"</span>, err);
      },
    });
  },
  <span class="hljs-attr">error</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error fetching data:"</span>, err);
  },
});
</code></pre>
<p>显然，随着嵌套层级的增加，代码变得越来越难以阅读和维护，而且错误处理也变得复杂。所以回收这一节的标题，因为用回调函数来处理异步操作确实存在一些问题：</p>
<ol>
<li>可读性差：嵌套的回调函数使代码难以理解。</li>
<li>错误处理复杂：每个回调函数都需要单独处理错误，导致代码冗长。</li>
<li>控制流困难：管理多个异步操作的顺序和依赖关系变得复杂。</li>
</ol>
<p>等讲完 <code>Promise</code> 之后我们看下 <code>Promise</code> 是否能解决这些问题。</p>
<h2 data-id="heading-1">Promise</h2>
<h3 data-id="heading-2">是什么</h3>
<p>通俗的说，我们可以把 <code>Promise</code> 理解成一个异步操作的代理，它是异步操作的返回值，原本只有同步操作才能有返回值，异步操作只能使用我们上面所说的回调函数嵌套来获得结果。</p>
<blockquote>
<p>异步方法不会立即返回最终值，而是返回一个 <code>Promise</code>，以便在将来的某个时间点提供该值。</p>
</blockquote>
<p><code>Promise</code> 的基本用法应该都很熟悉了，我们创建一个 <code>Promise</code> 的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES6 原生 Promise</span>
<span class="hljs-keyword">const</span> asyncTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 模拟异步操作（比如接口请求、文件读取）</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> success = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (success) {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"操作成功"</span>); <span class="hljs-comment">// 成功回调</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">reject</span>(<span class="hljs-string">"操作失败"</span>); <span class="hljs-comment">// 失败回调</span>
    }
  }, <span class="hljs-number">1000</span>);
});

<span class="hljs-comment">// 调用 Promise</span>
asyncTask
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)) <span class="hljs-comment">// 输出：操作成功</span>
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error))
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"操作完成"</span>));
</code></pre>
<p>可以看到，我们把异步操作 <code>setTimeout</code> 包装在 <code>Promise</code> 中，然后通过 <code>then</code>、<code>catch</code> 和 <code>finally</code> 来处理结果和错误，<code>setTimeout</code> 可以是任意异步操作，比如网络请求、文件读取等。</p>
<p>隐藏在这些 API 之下的还有一个参数，一个 <code>Promise</code> 必然处于以下三种状态之一：</p>
<ul>
<li><strong><code>Pending</code>（进行中）</strong>：初始状态，既不是成功，也不是失败。</li>
<li><strong><code>Fulfilled</code>（已成功）</strong>：操作成功完成。</li>
<li><strong><code>Rejected</code>（已失败）</strong>：操作失败。</li>
</ul>
<p>这一部分内容可以参考 MDN 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FPromise" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise" ref="nofollow noopener noreferrer">Promise - JavaScript | MDN</a>，讲得很清楚。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b269d2a441e45aa830d1b733b54fc08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770951014&amp;x-signature=KYxb7aLlIptL2lma5P%2B3xxGzSzM%3D" alt="" loading="lazy"/></p>
<p>参考这张图，<code>Pending</code> 状态通向两个结果：<code>Fulfilled</code> 和 <code>Rejected</code>，这个过程是单向不可逆的，一旦状态改变，就会永久保持该状态。当任意一种情况发生时，<code>then</code> 方法注册的回调函数就会被调用，即不再处于"待定"（<code>Pending</code>）状态，称之为"已敲定"（<code>Settled</code>）。</p>
<h4 data-id="heading-3">Rejected</h4>
<p>我们先看 <code>Rejected</code> 的情况：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// catch</span>
<span class="hljs-keyword">const</span> failedTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-string">"操作失败"</span>); <span class="hljs-comment">// 失败回调</span>
  }, <span class="hljs-number">1000</span>);
});

failedTask
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)) <span class="hljs-comment">// 输出：操作失败</span>
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"操作完成"</span>));

<span class="hljs-comment">// then 第二个参数</span>
<span class="hljs-keyword">const</span> anotherFailedTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-string">"操作失败"</span>); <span class="hljs-comment">// 失败回调</span>
  }, <span class="hljs-number">1000</span>);
});

anotherFailedTask
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"成功："</span> + result),
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"失败："</span> + error),
  ) <span class="hljs-comment">// 输出：操作失败</span>
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"操作完成"</span>));
</code></pre>
<p>有两种方式可以捕获 <code>Promise</code> 的拒绝状态：一种是使用 <code>catch</code> 方法，另一种是将错误处理函数作为 <code>then</code> 方法的第二个参数传入。两种方式都能有效地处理 <code>Promise</code> 的拒绝状态，如果不进行错误处理，未捕获的拒绝会导致未处理的 <code>Promise</code> 拒绝警告。更详细的说明我们后面再聊，这里只看用法。</p>
<h4 data-id="heading-4">Fulfilled</h4>
<p>在构造器 <code>Promise(..)</code> 中，我们通常用两个回调函数来表示成功和失败的情况，这两个函数的命名并不固定，通常我们使用 <code>resolve</code> 和 <code>reject</code>，<code>reject</code> 很清楚地表示失败，并且代表 <code>Promise</code> 进入 <code>Rejected</code> 状态，而成功的回调函数 <code>resolve</code>（决议），它表示 <code>Promise</code> 进入 <code>Fulfilled</code> 状态，这里用 ES6 规范中的回调命名来说明：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">myPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> onFulfilled, onRejected)
</code></pre>
<h4 data-id="heading-5">链式调用</h4>
<p>在提到 <code>Promise</code> 时，链式调用是一个非常重要的概念，上面的例子中，我们看到 <code>Promise</code> 对象可以调用 <code>then</code> 方法，而 <code>then</code> 方法又可以调用 <code>catch</code> 和 <code>finally</code> 方法，因为 <code>then</code> 方法返回的仍然是一个 <code>Promise</code> 对象，而 <code>catch</code> 和 <code>finally</code> 方法内在内部调用的也是 <code>then</code> 方法，这样它们就可以链式调用。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// Promise.resolve这种写法我们之后讨论</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第一步结果'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// 打印：第一步结果</span>
    <span class="hljs-comment">// return 普通值 → 新 Promise 状态为 fulfilled</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'第二步结果'</span>;
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// 打印：第二步结果</span>
    <span class="hljs-comment">// return 新 Promise → 新 Promise 跟随该 Promise 的状态</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第三步结果'</span>);
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// 打印：第三步结果</span>
  });
</code></pre>
<p>通过例子可以看到，链式调用可以将多个异步操作串联起来，每个 <code>then</code> 方法处理上一个 <code>Promise</code> 的结果，这就解决了我们最开始提到的回调地狱问题，使代码更加清晰和易于维护。</p>
<p>这个例子中还有一个细节，在 <code>then</code> 方法中通过 <code>return</code> 来传递值，当使用 <code>return</code> 返回一个普通值时，新的 <code>Promise</code> 会进入 <code>Fulfilled</code> 状态，也可以返回一个新的 <code>Promise</code> 对象，这样新的 <code>Promise</code> 会跟随该 <code>Promise</code> 的状态。值得注意的是，如果返回的是一个 <code>thenable</code> 对象（具有 <code>then</code> 方法的对象），<code>Promise</code> 也会等待该对象解决，这使得 <code>Promise</code> 可以与其他实现了类 <code>Promise</code> 接口的库进行互操作。</p>
<p>大体上我们了解了 <code>Promise</code> 的用法，我们用 <code>Promise</code> 来实现嵌套异步操作：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getFirstData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 返回一个 Promise，用 setTimeout 模拟异步</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-string">"第一个异步操作的结果"</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Data received:"</span>, data);
      <span class="hljs-comment">// 异步成功，传递结果给下一个 .then()</span>
      <span class="hljs-title function_">resolve</span>(data);
    }, <span class="hljs-number">1000</span>);
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSecondData</span>(<span class="hljs-params">prevData</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> moreData = <span class="hljs-string">`第二个异步操作的结果（基于上一步：<span class="hljs-subst">${prevData}</span>）`</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"More data received:"</span>, moreData);
      <span class="hljs-title function_">resolve</span>(moreData); <span class="hljs-comment">// 可选：继续传递结果给后续链式调用</span>
    }, <span class="hljs-number">1000</span>);
  });
}

<span class="hljs-comment">// 链式调用</span>
<span class="hljs-title function_">getFirstData</span>()
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-comment">// 第一个异步成功后，执行第二个异步</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getSecondData</span>(data);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-comment">// 统一捕获所有异步操作的错误</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"异步操作出错："</span>, err);
  });
</code></pre>
<h3 data-id="heading-6">Promise 解决了什么问题</h3>
<p>通过这个例子可以看到，我们一开始提出的回调函数的三个问题得到了不同程度的解决：</p>
<ol>
<li><strong>可读性提升</strong>：通过链式调用，代码结构更加清晰，每个异步操作都在自己的 <code>then</code> 块中处理，避免了嵌套回调的复杂性。</li>
<li><strong>统一错误处理</strong>：使用 <code>catch</code> 方法可以统一捕获所有异步操作的错误，简化了错误处理逻辑。</li>
<li><strong>控制流简化</strong>：通过链式调用，可以更容易地管理多个异步操作的顺序和依赖关系，使代码更易于理解。</li>
</ol>
<p>这里有点像一种 <code>if</code> 语句的替代写法：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">if</span> (condition1) {
  <span class="hljs-comment">// do something</span>
  <span class="hljs-keyword">if</span> (condition2) {
    <span class="hljs-comment">// do something</span>
    <span class="hljs-keyword">if</span> (condition3) {
      <span class="hljs-comment">// do something</span>
    }
  }
}

<span class="hljs-comment">// 可以改写为：</span>

<span class="hljs-keyword">if</span>(!condition1) <span class="hljs-keyword">return</span>;
<span class="hljs-comment">// do something</span>
<span class="hljs-keyword">if</span>(!condition2) <span class="hljs-keyword">return</span>;
<span class="hljs-comment">// do something</span>
<span class="hljs-keyword">if</span>(!condition3) <span class="hljs-keyword">return</span>;
<span class="hljs-comment">// do something</span>

</code></pre>
<p>换个思路，作用相同，但代码的可读性会变高，不过 <code>Promise</code> 要复杂得多，我没有直接使用一开始的回调函数版本来对比，并非做不到，而是涉及了新的知识点，需要用到 <code>Promise</code> 的一些 API，我打算换一种角度来理解，然后我们再回头看这个对比。</p>
<h3 data-id="heading-7">Promise 的 API 与原型</h3>
<p><code>Promise</code> 是 ES6（ES2015）引入的一种用于处理异步操作的<strong>对象</strong>，最近刚写了一篇关于原型的文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2FLFeather%2Fp%2F19312203" target="_blank" title="https://www.cnblogs.com/LFeather/p/19312203" ref="nofollow noopener noreferrer">对于原型、原型链和继承的理解</a>，这里就是想从原型和面向对象的角度来加深一下理解，我们还是用前面的例子，分步拆解：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES6 原生 Promise</span>
<span class="hljs-keyword">const</span> asyncTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 模拟异步操作（比如接口请求、文件读取）</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> success = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (success) {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"操作成功"</span>); <span class="hljs-comment">// 成功回调</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">reject</span>(<span class="hljs-string">"操作失败"</span>); <span class="hljs-comment">// 失败回调</span>
    }
  }, <span class="hljs-number">1000</span>);
});

<span class="hljs-comment">// 调用 Promise</span>
asyncTask
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)) <span class="hljs-comment">// 输出：操作成功</span>
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error))
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"操作完成"</span>));
</code></pre>
<h4 data-id="heading-8">构造函数 Promise()</h4>
<p>先从核心语句说起， <code>new Promise((resolve, reject) =&gt; { ... })</code> 这里事关两个概念：构造函数和 <code>new</code>。</p>
<p><code>Promise()</code> 是一个构造器（Constructor）或者说构造函数，用于创建 <code>Promise</code> 对象。</p>
<p>使用构造函数的形式来创建对象有几个好处：</p>
<ol>
<li>
<p><strong>封装初始化逻辑</strong>：<code>Promise</code> 构造函数内部封装了初始化 <code>Promise</code> 对象所需的逻辑，比如设置初始状态（<code>pending</code>）、设置回调函数（<code>resolve</code> 和 <code>reject</code>）。</p>
</li>
<li>
<p><strong>共享方法</strong>：通过构造函数创建的对象实例可以共享原型上的方法（如 <code>then</code>、<code>catch</code>、<code>finally</code>），避免每个实例都创建一份相同的方法，节省内存。</p>
</li>
<li>
<p><strong>立即执行</strong>：当我们创建一个新的 <code>Promise</code> 实例时，传入的执行器函数（executor function）会立即执行，这使得我们可以在创建 <code>Promise</code> 的同时开始异步操作。</p>
</li>
</ol>
<p>而 <code>new</code> 关键字用于创建一个新的对象实例，并将其原型链接到构造函数的原型对象上，也就是让新创建的对象继承构造函数原型上的方法和属性，结合上面的例子就是说我们创建的 <code>asyncTask</code> 对象会继承 <code>Promise.prototype</code> 上的方法，比如 <code>then</code>、<code>catch</code> 和 <code>finally</code>，这也就是为什么我们可以在 <code>asyncTask</code> 上调用这些方法，以及进行前面所说的链式调用。</p>
<p>要注意的一点是，执行器函数的返回值对 <code>Promise</code> 的影响有限，在 <code>then</code> 方法中我们通过 <code>return</code> 来传递值，但在执行器函数中 <code>return</code> 语句仅影响控制流程，并不会直接改变 <code>Promise</code> 的状态，<code>Promise</code> 的状态只能通过调用 <code>resolve</code> 或 <code>reject</code> 来改变。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 一些异步操作</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-comment">/* 操作成功 */</span>) {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"成功结果"</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-string">"失败原因"</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">"这个返回值不会影响 Promise 的状态"</span>;
});
</code></pre>
<h4 data-id="heading-9">入参 (resolve, reject) =&gt; { ... }</h4>
<p>接下来我们看构造函数的入参 <code>(resolve, reject) =&gt; { ... }</code> ，也就是执行器函数（executor function），它会在 <code>Promise</code> 实例创建时立即执行，这个上面说过了。使用 <code>Promise</code> 时，我们不会关注执行器函数，主要是使用这个函数的入参 <code>resolve</code> 和 <code>reject</code> 用来改变 <code>Promise</code> 的状态。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">executor</span>(<span class="hljs-params">resolveFunc, rejectFunc</span>) {
  <span class="hljs-comment">// 通常，`executor` 函数用于封装某些接受回调函数作为参数的异步操作，比如上面的 `setTimeout` 函数</span>
}
</code></pre>
<p>当调用 <code>resolve</code> 或 <code>reject</code> 时，<code>Promise</code> 的状态会立即改变，从 <code>pending</code> 变为 <code>fulfilled</code> 或 <code>rejected</code>，然后执行回调函数，这个回调函数就是我们通过 <code>then</code> 方法注册的函数。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 执行器函数立即执行'</span>);
  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'成功'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. resolve 调用完成（同步）'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. Promise 创建完成'</span>);

p.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. then 回调执行:'</span>, value);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. then 方法调用完成'</span>);

<span class="hljs-comment">// 输出顺序：</span>
<span class="hljs-comment">// 1. 执行器函数立即执行</span>
<span class="hljs-comment">// 2. resolve 调用完成（同步）</span>
<span class="hljs-comment">// 3. Promise 创建完成</span>
<span class="hljs-comment">// 4. then 方法调用完成</span>
<span class="hljs-comment">// 5. then 回调执行: 成功</span>
</code></pre>
<p>但我们用到 <code>Promise</code> 时主要还是用于异步任务，<code>then</code> 方法是典型的微任务（microtask），如果 <code>then</code> 方法先执行，里面的回调函数会被放入微任务队列，等待当前宏任务执行完毕后再执行。</p>
<p>对于更细致的执行顺序，之前有写过一篇关于事件循环的文章，刚好是用 <code>Promise</code> 举例，可以参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2FLFeather%2Fp%2F16139014.html" target="_blank" title="https://www.cnblogs.com/LFeather/p/16139014.html" ref="nofollow noopener noreferrer">有关 JavaScript 事件循环的若干疑问探究</a>。</p>
<p><code>Promise</code> 内部的大致逻辑是这样的：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// Promise 内部简化实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'pending'</span>;           <span class="hljs-comment">// 状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>;           <span class="hljs-comment">// 结果值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span> = [];   <span class="hljs-comment">// ← 存储 then 的成功回调</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [];    <span class="hljs-comment">// ← 存储 then 的失败回调</span>

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'pending'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'fulfilled'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
        <span class="hljs-comment">// ← 关键：遍历回调队列，将所有回调加入微任务</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> {
          <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">callback</span>(value));
        });
      }
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'pending'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'rejected'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = reason;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> {
          <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">callback</span>(reason));
        });
      }
    };

    <span class="hljs-title function_">executor</span>(resolve, reject);
  }

  <span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) {
    <span class="hljs-comment">// 如果 Promise 还是 pending，就把回调存起来</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'pending'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">push</span>(onFulfilled);  <span class="hljs-comment">// ← 存储回调</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(onRejected);
    }
    <span class="hljs-comment">// 如果 Promise 已经 fulfilled，立即将回调加入微任务</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'fulfilled'</span>) {
      <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>));
    }
    <span class="hljs-comment">// 如果 Promise 已经 rejected</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'rejected'</span>) {
      <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>));
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">() =&gt;</span> {}); <span class="hljs-comment">// 简化，实际更复杂</span>
  }
}
</code></pre>
<p>所以 <code>then</code> 中的回调函数被执行的前提是 <code>resolve</code> 或 <code>reject</code> 被调用并且 <code>then</code> 方法也被调用，这也是 <code>Promise</code> 能处理异步操作的关键。</p>
<h4 data-id="heading-10">静态方法</h4>
<p>简单提一下，静态方法是直接挂载在构造函数上的方法，而不是实例对象上，以前面的例子来说，<code>asyncTask</code> 是 <code>Promise</code> 的一个实例对象，而 <code>Promise.all(..)</code> 和 <code>Promise.resolve(..)</code> 这种则是 <code>Promise</code> 构造函数的一个静态方法。</p>
<p>基于上面的简单例子，<code>Promise</code> 大体上的用法我们已经了解了，但还有很多 API 没有涉及到，我们可以通过打印 <code>Promise</code> 的原型来查看：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/138aaa75ea604f16b7318d83fe94cdde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770951014&amp;x-signature=2LOlRGlB9OqcoDn2%2FskbksmcKJg%3D" alt="" loading="lazy"/></p>
<p>我们可以看到 <code>then</code>、<code>catch</code> 和 <code>finally</code> 方法都在 <code>Promise.prototype</code> 上，这些方法是实例方法，意味着它们可以被任何 <code>Promise</code> 实例调用。</p>
<p>由于安全机制，直接打印 <code>Promise</code> 本身是看不到原生代码的，我们换一种方式，只需要得到静态方法名就行：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(<span class="hljs-title class_">Promise</span>));

<span class="hljs-comment">// 输出：['length', 'name', 'prototype', 'all', 'allSettled', 'any', 'race', 'resolve', 'reject', 'withResolvers', 'try']</span>
</code></pre>
<p>输出结果中有的熟悉有的不熟悉，因为我之前对 <code>Promise</code> 仅停留在会用的层面，所以有些我甚至是第一次知道，但没关系，通过原型再对照 MDN 文档，逐个学习一下。 <code>length</code>、<code>name</code> 和 <code>prototype</code> 是函数对象的默认属性，我们主要关注其他的静态方法：</p>
<ol>
<li><code>Promise.resolve(..)</code> 和 <code>Promise.reject(..)</code></li>
</ol>
<p>这两个方法应该是最常见的了，上面的例子中也用到过，<code>reject</code> 比较简单，返回一个拒绝状态的 <code>Promise</code> 对象，入参就是拒绝的原因：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> promiseReject = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"失败原因"</span>));
promiseReject.<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason.<span class="hljs-property">message</span>);
  <span class="hljs-comment">// Expected output: 失败原因</span>
});

<span class="hljs-comment">// 或者</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resolved</span>(<span class="hljs-params">result</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Resolved"</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">rejected</span>(<span class="hljs-params">result</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Rejected:"</span>, result);
}

<span class="hljs-keyword">const</span> promiseReject2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">"失败原因"</span>);
promiseReject2.<span class="hljs-title function_">then</span>(resolved, rejected);
</code></pre>
<p><code>resolve</code> 方法则比较复杂一些，它有两种返回形式：1. 如果入参是一个普通值（非 <code>Promise</code> 对象），则返回一个以该值为结果的已解决（<code>fulfilled</code>）状态的 <code>Promise</code> 对象，这一点与 <code>reject</code> 对应；2. 如果入参是一个 <code>Promise</code> 对象，则返回该 <code>Promise</code> 对象本身。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 入参是普通值</span>
<span class="hljs-keyword">const</span> promise1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">123</span>);

promise1.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);
  <span class="hljs-comment">// Expected output: 123</span>
});

<span class="hljs-comment">// 入参是 Promise 对象</span>
<span class="hljs-keyword">const</span> originalPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"原始 Promise 结果"</span>);
  }, <span class="hljs-number">1000</span>);
});

<span class="hljs-keyword">const</span> promise2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(originalPromise);
promise2.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);
  <span class="hljs-comment">// Expected output: 原始 Promise 结果</span>
});
</code></pre>
<ol start="2">
<li><code>Promise.all(..)</code>、<code>Promise.race(..)</code>、<code>Promise.allSettled(..)</code> 和 <code>Promise.any(..)</code></li>
</ol>
<p>这四个我觉得可以放一起介绍，它们都是用于处理多个 <code>Promise</code> 对象的静态方法，入参都是一个可迭代对象（通常是数组），包含多个 <code>Promise</code> 对象，返回一个新的 <code>Promise</code> 对象，其他的区别用一张表格来说明：</p>






























<table><thead><tr><th>方法</th><th>描述</th><th>返回值</th></tr></thead><tbody><tr><td><code>Promise.all(..)</code></td><td>全成功才成功，一失败就失败。</td><td>成功时返回一个包含所有结果的数组，失败时返回第一个失败的原因。</td></tr><tr><td><code>Promise.allSettled(..)</code></td><td>等所有完成，无论成败。</td><td>结果是一个包含每个 <code>Promise</code> 结果状态的数组。</td></tr><tr><td><code>Promise.any(..)</code></td><td>一成功就成功，全失败才失败。</td><td>成功时返回第一个成功的结果，失败时返回一个 <code>AggregateError</code>，包含所有失败的原因。</td></tr><tr><td><code>Promise.race(..)</code></td><td>谁先完成（成败均可），就用谁的结果。</td><td>结果是第一个解决或拒绝的 <code>Promise</code> 的结果或原因。</td></tr></tbody></table>
<p>关于 <code>Promise.all(..)</code> 的应用，我们最开始的回调函数就是一个很好的例子，我们可以用它来重写：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchX</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>);
    }, <span class="hljs-number">1000</span>);
  });
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchY</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>);
    }, <span class="hljs-number">1000</span>);
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">fetchX</span>(), <span class="hljs-title function_">fetchY</span>()]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[x, y]</span>) =&gt;</span> x + y);
}

<span class="hljs-title function_">add</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">sum</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Sum is: "</span> + sum); <span class="hljs-comment">// 输出：Sum is: 5</span>
});
</code></pre>
<p>如果有三个异步操作：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchZ</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-number">4</span>);
    }, <span class="hljs-number">1000</span>);
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">addThree</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">fetchX</span>(), <span class="hljs-title function_">fetchY</span>(), <span class="hljs-title function_">fetchZ</span>()]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[x, y, z]</span>) =&gt;</span> x + y + z);
}
</code></pre>
<p>MDN上的 <code>Promise.allSettled(..)</code> 例子：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">33</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">66</span>), <span class="hljs-number">0</span>)),
  <span class="hljs-number">99</span>,
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"一个错误"</span>)),
]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">values</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(values));

<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   { status: 'fulfilled', value: 33 },</span>
<span class="hljs-comment">//   { status: 'fulfilled', value: 66 },</span>
<span class="hljs-comment">//   { status: 'fulfilled', value: 99 },</span>
<span class="hljs-comment">//   { status: 'rejected', reason: Error: 一个错误 }</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<p>这里的返回值有些不同，是一个对象数组，每个对象表示对应 <code>Promise</code> 的状态和结果。</p>
<p><code>Promise.any(..)</code> 的返回值是第一个成功的结果，如果所有 <code>Promise</code> 都失败了，则返回一个 <code>AggregateError</code>，它包含所有失败的原因：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> promiseA = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">"失败原因 A"</span>);
<span class="hljs-keyword">const</span> promiseB = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">"失败原因 B"</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([promiseA, promiseB])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
  });

<span class="hljs-comment">// 输出：AggregateError: All promises were rejected</span>
</code></pre>
<p>与其他三个方法不同，<code>Promise.race(..)</code> 返回的 <code>Promise</code> 状态的敲定总是异步的，前面的三种方法入参的 <code>Promise</code> 数组中有一个甚至多个是已经解决（<code>fulfilled</code>）或拒绝（<code>rejected</code>）的 <code>Promise</code> 对象（简单来说，和上面的大部分例子一样，我们传入一个确定的值而不是异步方法），那么 <code>Promise.all(..)</code>、<code>Promise.allSettled(..)</code> 和 <code>Promise.any(..)</code> 会立即返回结果，而 <code>Promise.race(..)</code> 的返回值则是异步的。</p>
<p>MDN 针对每个方法的返回值都有详细的说明，比如说 <code>Promise.all(..)</code> ，如果传入的参数为空，则它的状态会立即变为 <strong>已解决（<code>fulfilled</code>）</strong> 另外两种返回状态则为 <strong>异步兑现（asynchronously fulfilled）</strong> 和 <strong>异步拒绝（asynchronously rejected）</strong> ，而 <code>Promise.any(..)</code> 则是相反的，如果传入的参数为空，则它的状态会立即变为 <strong>已拒绝（<code>rejected</code>）</strong>，其他情况都是异步的。</p>
<p>向 <code>Promise.race(..)</code> 传入一个空的可迭代对象会导致返回的 <code>Promise</code> 永远处于挂起状态（<code>pending</code>），因为没有任何 <code>Promise</code> 可以兑现或拒绝。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> foreverPendingPromise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(foreverPendingPromise);
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"堆栈现在为空"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(foreverPendingPromise);
});

<span class="hljs-comment">// 按顺序打印：</span>
<span class="hljs-comment">// Promise { &lt;state&gt;: "pending" }</span>
<span class="hljs-comment">// 堆栈现在为空</span>
<span class="hljs-comment">// Promise { &lt;state&gt;: "pending" }</span>
</code></pre>
<p><code>Promise.race(..)</code> 的异步性有什么意义呢？假设我们有一个网络请求操作，我们希望在一定时间内获得响应，否则就放弃请求，这时我们可以使用 <code>Promise.race(..)</code> 来实现超时控制：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> data = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api"</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 5 秒后拒绝</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"请求超时"</span>)), <span class="hljs-number">5000</span>);
  }),
])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title function_">displayError</span>(err));
</code></pre>
<ol start="3">
<li><code>Promise.try()</code></li>
</ol>
<blockquote>
<p><code>Promise.try()</code> 静态方法接受一个任意类型的回调函数（无论其是同步或异步，返回结果或抛出异常），并将其结果封装成一个 <code>Promise</code>。</p>
</blockquote>
<p>这是一个截止到目前（2026年2月）仍在提案阶段的 API，在一些现代浏览器和 Node.js 最新版本中已经可以使用，作用类似于 <code>async</code> 函数，可以将同步代码和异步代码统一处理为 <code>Promise</code> 对象：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 这里可以是同步代码</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">synchronousFunction</span>();
  <span class="hljs-keyword">return</span> result;
})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"同步结果:"</span>, value);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"错误:"</span>, error);
  });
<span class="hljs-comment">// 也可以是异步代码</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asynchronousFunction</span>();
  <span class="hljs-keyword">return</span> result;
})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"异步结果:"</span>, value);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"错误:"</span>, error);
  });
</code></pre>
<ol start="4">
<li><code>Promise.withResolvers()</code></li>
</ol>
<blockquote>
<p><code>Promise.withResolvers()</code> 静态方法返回一个对象，其包含一个新的 <code>Promise</code> 对象和两个函数，用于解决或拒绝它，对应于传入给 <code>Promise()</code> 构造函数执行器的两个参数。</p>
</blockquote>
<p>它完全等价于下面的代码：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">let</span> resolve, reject;
<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
  resolve = res;
  reject = rej;
});
</code></pre>
<p>它的作用是简化创建一个可控的 <code>Promise</code> 对象，我们可以在外部调用 <code>resolve</code> 和 <code>reject</code> 来改变 <code>Promise</code> 的状态：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
<span class="hljs-comment">// 模拟异步操作</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> success = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (success) {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"操作成功"</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-string">"操作失败"</span>);
  }
}, <span class="hljs-number">1000</span>);
promise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error))
  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"操作完成"</span>));
</code></pre>
<p>这个 API 的使用场景比较少见，目前我还不能完全理解它的作用，感兴趣可以到 MDN 上查看。</p>
<h2 data-id="heading-11">async/await 与 Promise</h2>
<p>最开始就说到 <code>async/await</code> 了，我是先接触到 <code>async/await</code> 这种写法的，然后才了解到它是基于 <code>Promise</code> 的语法糖，个人理解来说，<code>async/await</code> 让异步代码看起来更像同步代码，主要是提高代码的可读性和可维护性，就像 <code>Promise</code> 之于回调函数一样。</p>
<p>在使用上，<code>async/await</code> 的争议集中在是否要使用 <code>try/catch</code> 来处理错误，我之前的处理方式是在请求的封装里使用 <code>try/catch</code> 来捕获错误，调用时正常使用 <code>async/await</code> ，其他地方处理异步操作还是直接使用 <code>Promise</code>。以前其实没有太深入考虑过合理性的问题，在新公司看代码规范时发现他们有针对这个问题讨论过，才意识到这个问题的重要性。关于这个问题争议比较大，而且关于 <code>async/await</code> 完全可以单独写一篇，这篇主要还是针对 <code>Promise</code> 的学习记录，再写下去也有些超篇幅了，之后学习时应该还会再聊到。</p>
<h2 data-id="heading-12">缺陷</h2>
<p>这个部分对于我来说还是有些超纲了，但也有参考资料，列一下《你不知道的JavaScript》中卷提到的几个缺陷，不过这些纸质书有一定的时代性，内容仅供参考：</p>
<ol>
<li><strong>顺序错误处理</strong>： 如果构建了一个没有错误处理函数的Promise链，链中后续的 <code>then</code> 仍然会被执行，可能导致错误被忽略或处理不当。</li>
<li><strong>单一值</strong>： <code>Promise</code> 只能处理单一值的传递，无法直接处理多个值或复杂的数据结构（可以传递封装的对象，但如果在链中的每一步都进行封装和解封，就有些笨重了）。</li>
<li><strong>单决议</strong>： <code>Promise</code> 一旦被解决（<code>fulfilled</code>）或拒绝（<code>rejected</code>），其状态就不能再改变，无法重新解决或拒绝。</li>
<li><strong>惯性</strong>： 时代性的体现，考虑当时的环境 <code>Promise</code> 还未普及，现在应该可以忽略这一点了。</li>
<li><strong>不可取消</strong>： 一旦创建，<code>Promise</code> 就会一直执行，无法取消正在进行的异步操作。这个也有些时代性了，现在有 <code>AbortController</code> 可以配合 <code>fetch</code> 来实现取消请求的功能。</li>
<li><strong>性能</strong>： 相较于回调函数，<code>Promise</code> 在创建和管理状态方面有一定的性能开销，但个人认为这在通常的应用场景中影响不大。</li>
</ol>
<h2 data-id="heading-13">总结</h2>
<p>说实话动笔之前就是觉得应该写一篇关于 <code>Promise</code> 的，但开始写之后发现没什么方向，相关资料也是浩如烟海，写这篇耗费了非常多的时间，开始不断地深挖细节后感觉有无穷无尽的问题，好在现在通过 AI 至少可以把这些问题大致理清楚，"大致"理解说明还有很多内容没有涉及，之后在项目中应该会更加注意 <code>Promise</code> 的应用，然后把《你不知道的JavaScript》的相关内容看完结合一下应该还可以再水一篇。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java程序员必做项目！基于LangChain实现的ReAct智能体项目。助你拿offer！（第三期）]]></title>    <link>https://juejin.cn/post/7603238967290986548</link>    <guid>https://juejin.cn/post/7603238967290986548</guid>    <pubDate>2026-02-06T02:20:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603238967290986548" data-draft-id="7603238967290921012" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java程序员必做项目！基于LangChain实现的ReAct智能体项目。助你拿offer！（第三期）"/> <meta itemprop="keywords" content="后端,AI编程"/> <meta itemprop="datePublished" content="2026-02-06T02:20:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="感性的程序员小王"/> <meta itemprop="url" content="https://juejin.cn/user/1915806770272506"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java程序员必做项目！基于LangChain实现的ReAct智能体项目。助你拿offer！（第三期）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1915806770272506/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    感性的程序员小王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:20:24.000Z" title="Fri Feb 06 2026 02:20:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">4、文档检索bug修复</h4>
<p>可以看到，llm根据知识库文档检索出了内容并给出了答案，但是会发现，为什么检索的四篇相关的文档都是同一片文档呢？</p>
<p>根本原因就在于：根本原因在于：</p>
<blockquote>
<p><strong>我们的文档在分块（text splitting）时，被切成了多个重叠或高度相似的 chunk，而这些 chunk 都被向量化并存入了向量数据库。检索时，它们都与查询高度相似，因此都被返回了。</strong></p>
</blockquote>
<p>我们的<code>java-thread-pool.md</code> 文件开头是：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Java 线程池最佳实践  </span>
<span class="hljs-section">## 场景与目标  </span>
<span class="hljs-bullet">-</span> 统一管理线程...  
<span class="hljs-bullet">-</span> 控制并发度...  
<span class="hljs-section">## 核心参数与含义  </span>
<span class="hljs-bullet">-</span> 核心线程数 corePoolSize...
</code></pre>
<p>这种<strong>标题 + 列表</strong>的结构，在分块时容易导致多个 chunk 都包含相同的开头部分（尤其是当 chunk_size 不够大时）。</p>
<p>而我们的分块策略是**<code>CharacterTextSplitter</code> 的分块策略**</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(
    <span class="hljs-attr">separator</span>=<span class="hljs-string">"\n\n"</span>, 
    <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">500</span>, 
    <span class="hljs-attr">chunk_overlap</span>=<span class="hljs-number">80</span>
)
</code></pre>
<ul>
<li><code>separator="\n\n"</code>：按<strong>空行</strong>切分</li>
<li>但如果文档中<strong>段落很长</strong>，或者<strong>开头没有空行</strong>，它会 fallback 到按字符切（每 500 字切一次）</li>
<li><code>chunk_overlap=80</code>：前后块重叠 80 字符 → 进一步增加重复</li>
<li>结果：文件开头的大段内容被切成多个“几乎一样”的 chunk。</li>
</ul>
<p><strong>Chroma 默认返回 top-k 个最相似结果</strong></p>
<p>我们设置了 <code>search_kwargs={"k": 4}</code>，所以即使 4 个 chunk 内容高度重复，只要它们的 embedding 相似度都排前 4，就会全部返回。</p>
<p>那我们怎么去解决这个问题呢，最简单的是使用专业的<strong>MarkdownTextSplitter</strong>，这是langchain中专门分割md文档的分割器，还有就是调整我们的分割策略：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(
    <span class="hljs-attr">separator</span>=<span class="hljs-string">"\n## "</span>,  <span class="hljs-comment"># 在二级标题处分割</span>
    <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">800</span>,     <span class="hljs-comment"># 增大块大小，减少碎片</span>
    <span class="hljs-attr">chunk_overlap</span>=<span class="hljs-number">100</span>,
    <span class="hljs-attr">length_function</span>=len,
    <span class="hljs-attr">is_separator_regex</span>=<span class="hljs-literal">False</span>
)
</code></pre>
<p>我们这里呢就使用<strong>MarkdownTextSplitter</strong>,修改对应的文档分割器代码</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.text_splitter import MarkdownTextSplitter
​
<span class="hljs-comment"># 如果主要是 .md 文件</span>
<span class="hljs-attr">text_splitter</span> = MarkdownTextSplitter(
    <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">500</span>,
    <span class="hljs-attr">chunk_overlap</span>=<span class="hljs-number">50</span>
)
</code></pre>
<p>然后在运行代码：</p>
<pre><code class="hljs language-javascript" lang="javascript">0it [<span class="hljs-number">00</span>:<span class="hljs-number">00</span>, ?it/s]
<span class="hljs-number">100</span>%|██████████| <span class="hljs-number">8</span>/<span class="hljs-number">8</span> [<span class="hljs-number">00</span>:<span class="hljs-number">00</span>&lt;<span class="hljs-number">00</span>:<span class="hljs-number">00</span>, <span class="hljs-number">5464.</span>00it/s]
0it [<span class="hljs-number">00</span>:<span class="hljs-number">00</span>, ?it/s]
/<span class="hljs-title class_">Users</span>/fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/agent/ai_client.<span class="hljs-property">py</span>:<span class="hljs-number">75</span>: <span class="hljs-title class_">LangChainDeprecationWarning</span>: <span class="hljs-title class_">The</span> <span class="hljs-keyword">class</span> <span class="hljs-string">`Chroma`</span> was deprecated <span class="hljs-keyword">in</span> <span class="hljs-title class_">LangChain</span> <span class="hljs-number">0.2</span><span class="hljs-number">.9</span> and will be removed <span class="hljs-keyword">in</span> <span class="hljs-number">1.0</span>. <span class="hljs-title class_">An</span> updated version <span class="hljs-keyword">of</span> the <span class="hljs-keyword">class</span> <span class="hljs-title class_">exists</span> <span class="hljs-keyword">in</span> the :<span class="hljs-attr">class</span>:<span class="hljs-string">`~langchain-chroma package and should be used instead. To use it run `</span>pip install -U :<span class="hljs-attr">class</span>:<span class="hljs-string">`~langchain-chroma`</span> and <span class="hljs-keyword">import</span> <span class="hljs-keyword">as</span> <span class="hljs-string">`from :class:`</span>~langchain_chroma <span class="hljs-keyword">import</span> <span class="hljs-title class_">Chroma</span><span class="hljs-string">``</span>.
  vectorstore = <span class="hljs-title class_">Chroma</span>(
新增 <span class="hljs-number">23</span> 个文档片段
<span class="hljs-variable constant_">RAG</span> 链初始化完成
​
✅ 向量数据库检索到 <span class="hljs-number">4</span> 篇相关文档：
  📄 [<span class="hljs-number">1</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-thread-pool.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"# Java 线程池最佳实践  ## 场景与目标 - 统一管理线程，避免频繁创建/销毁的开销 - 控制并发度与任务排队策略，匹配业务峰谷  ## 核心参数与含义 - 核心线程数 corePoolSize：常驻线程数量 - 最大线程数 maximumPoolSize：峰值并发上限 - 存活时间 kee..."</span>
  📄 [<span class="hljs-number">2</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-thread-pool.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"```  ## 监控与降级 - 指标：活跃线程、队列长度、任务耗时分位、拒绝次数 - 降级：限流/丢弃非关键任务/降级功能开关  ## 常见坑 - 使用 Executors 工具类默认配置可能导致 OOM（无界队列/最大线程数不受控） - 线程泄漏：任务异常未捕获，线程死锁 - 任务不可中断：IO..."</span>
  📄 [<span class="hljs-number">3</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-thread-pool.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"## 典型构造 ```java ExecutorService pool = new ThreadPoolExecutor(     corePoolSize,     maximumPoolSize,     60L, TimeUnit.SECONDS,     new LinkedBlockin..."</span>
  📄 [<span class="hljs-number">4</span>] 来源: <span class="hljs-regexp">/Users/</span>fenghuanwang/<span class="hljs-title class_">PythonProject</span>/langchain-test/doc/java-concurrency.<span class="hljs-property">md</span> | 预览: <span class="hljs-string">"## 场景示例 - 高并发计数：LongAdder - 高读低写缓存：ReadWriteLock 或 Caffeine - 任务编排：CompletableFuture 并行拉取 + 超时兜底..."</span>
​
自定义线程池需设置核心线程数、最大线程数、空闲存活时间、任务队列（建议有界）、线程工厂（命名规范）和拒绝策略。根据业务类型选择参数：<span class="hljs-variable constant_">CPU</span>密集型用较小核心线程数，<span class="hljs-variable constant_">IO</span>密集型适当增加。避免使用<span class="hljs-title class_">Executors</span>默认无界队列，防止<span class="hljs-variable constant_">OOM</span>。建议监控队列长度和拒绝次数，动态调整。
<span class="hljs-title class_">Process</span> finished <span class="hljs-keyword">with</span> exit code <span class="hljs-number">0</span>
</code></pre>
<p>这时候四篇文章就不会是相同的了，</p>
<p>ps：如果没有改变的话，是因为存在之前运行代码所缓存的向量数据，把存储向量数据的文件夹内的所有文件都删了就好了。</p>
<p>但是，这还不够，我们会发现，如果我们在问完一个问题之后，在想接着询问的时候llm不知道我们再说什么，也就是llm没有把之前的对话作为上下文。专业的说就是，现在我们所开发的llm还没有对话记忆的功能，那么下面，我们就来实现一下。</p>
<h4 data-id="heading-1">5、对话记忆实现（基于内存）</h4>
<p>要想实现对话记忆，又很多方式，包括基于内存的对话存储，基于redis的，mysql的，sqllite的以及向量存储等诸多方式。那么我们先来尝试实现一下基于内存的记忆：</p>
<p>首先呢，在langchain的<strong>langchain.memory</strong>包下面的<strong>ChatMessageHistory</strong>,提供了一些方便的函数，可以保存人类的消息llm的消息。但是呢，这个只是底层的存储结构，只管存消息。我们真正使用的时候，使用的是<strong>ConversationBufferMemory</strong>这个是一个高层的记忆组建，内部默认使用的<strong>ChatMessageHistory</strong>来存储消息，并提供了与langchain链集成的接口（但是他还是不能嵌入到新式的Runnable中，也就是使用类似于Unix管道符的方式一层一层的向下传递处理好的信息），由于我们现在所使用的是新式的Runnable,所以我们不使用这个方式。我们来使用**<code>RunnableWithMessageHistory</code>**。</p>
<p>它是 LangChain 为 <strong>新时代 <code>Runnable</code></strong> 专门设计的<strong>记忆包装器</strong>，底层可以接：</p>
<ul>
<li><code>ChatMessageHistory</code>（内存）</li>
<li><code>RedisChatMessageHistory</code>（Redis）</li>
<li>或任何 <code>BaseChatMessageHistory</code> 子类</li>
</ul>
<p>它<strong>不依赖 <code>ConversationBufferMemory</code></strong>，而是直接操作 <code>ChatMessageHistory</code>，更轻量、更符合 <code>Runnable</code> 范式。</p>
<p>我们导入所需要的包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> langchain.<span class="hljs-property">memory</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">ChatMessageHistory</span>
<span class="hljs-keyword">from</span> langchain_core.<span class="hljs-property">runnables</span>.<span class="hljs-property">history</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>
<span class="hljs-keyword">from</span> langchain_core.<span class="hljs-property">messages</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">HumanMessage</span>
</code></pre>
<p>然后初始化一个会话历史存储器，来实现单用户的多轮对话</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 内存中的会话存储：session_id -&gt; ChatMessageHistory</span>
<span class="hljs-comment"># 目前我们只用一个固定 session_id，实现单用户多轮对话</span>
<span class="hljs-attr">store</span> = {}

def get_session_history(session_id: str) -&gt; ChatMessageHistory:
    if session_id not in store:
        store<span class="hljs-section">[session_id]</span> = ChatMessageHistory()
    return store<span class="hljs-section">[session_id]</span>
</code></pre>
<p>说明：</p>
<ul>
<li><code>store</code> 是一个字典，模拟多用户（虽然我们现在只用一个）；</li>
<li><code>get_session_history("user1")</code> 会返回该用户的对话历史对象；</li>
<li>所有消息（Human/AI）都存在 <code>ChatMessageHistory.messages</code> 列表中。</li>
</ul>
<p>这种写法是</p>
<p>然后修改原来的系统提示词</p>
<pre><code class="hljs language-swift" lang="swift">system_prompt <span class="hljs-operator">=</span> (
    <span class="hljs-string">"你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。<span class="hljs-subst">\n</span>"</span>
    <span class="hljs-string">"请基于以下检索到的上下文和之前的对话历史回答用户的问题。<span class="hljs-subst">\n</span>"</span>
    <span class="hljs-string">"如果上下文不相关，请仅基于你的知识回答，不要编造。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>
    <span class="hljs-string">"上下文：<span class="hljs-subst">\n</span>{context}<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>
    <span class="hljs-string">"对话历史：<span class="hljs-subst">\n</span>{chat_history}"</span>
)
</code></pre>
<p>接着，修改提示词模板中的用户输入变量为<strong>input</strong></p>
<pre><code class="hljs language-swift" lang="swift">from langchain_core.prompts <span class="hljs-keyword">import</span> MessagesPlaceholder

prompt <span class="hljs-operator">=</span> <span class="hljs-type">ChatPromptTemplate</span>.from_messages([
    (<span class="hljs-string">"system"</span>, 
     <span class="hljs-string">"你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。<span class="hljs-subst">\n</span>"</span>
     <span class="hljs-string">"请基于以下检索到的上下文回答用户的问题。<span class="hljs-subst">\n</span>"</span>
     <span class="hljs-string">"如果上下文不相关，请仅基于你的知识回答，不要编造。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>
     <span class="hljs-string">"上下文：<span class="hljs-subst">\n</span>{context}"</span>
    ),
  # 历史消息占位
    <span class="hljs-type">MessagesPlaceholder</span>(variable_name<span class="hljs-operator">=</span><span class="hljs-string">"chat_history"</span>),  # <span class="hljs-operator">←</span> 自动插入历史
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>)
])
</code></pre>
<p>为什么必须要用<strong>input</strong> 呢，这是因为<code>RunnableWithMessageHistory</code> 默认从输入中取 <code>"input"</code> 字段作为用户消息。</p>
<p>然后，重构rag链（不带有底层记忆，只会处理一次问答）,后续呢我们会把他升级成支持对话记忆的链。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 单次问答的 RAG 链（无记忆）</span>
from langchain_core.runnables import RunnablePassthrough

<span class="hljs-comment"># 单次问答链（）</span>
<span class="hljs-attr">rag_chain</span> = (
    RunnablePassthrough.assign(<span class="hljs-attr">context</span>=itemgetter(<span class="hljs-string">"input"</span>) | retriever | format_docs)
    | prompt
    | llm
    | StrOutputParser()
)
</code></pre>
<p>升级链：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 带记忆的完整 RAG 链</span>
<span class="hljs-attr">rag_with_history</span> = RunnableWithMessageHistory(
    rag_chain,
    get_session_history,
    <span class="hljs-attr">input_messages_key</span>=<span class="hljs-string">"input"</span>,        <span class="hljs-comment"># 用户输入字段</span>
    <span class="hljs-attr">history_messages_key</span>=<span class="hljs-string">"chat_history"</span> <span class="hljs-comment"># 历史消息字段（对应 MessagesPlaceholder）</span>
)
</code></pre>
<ul>
<li><code>get_session_history</code>：告诉它如何根据 <code>session_id</code> 获取历史；</li>
<li><code>input_messages_key="input"</code>：用户输入在字典中的 key；</li>
<li><code>history_messages_key="chat_history"</code>：这个值会被自动注入到 prompt 的 <code>{chat_history}</code> 中。</li>
</ul>
<p>下面是改造完成之后的完整的代码（包含测试用例）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ai_client.py</span>
import os
from langchain_community.chat_models import ChatTongyi
from langchain_community.document_loaders import DirectoryLoader, TextLoader, PyPDFLoader
from langchain_community.embeddings import DashScopeEmbeddings
from langchain_community.vectorstores import Chroma
from langchain.text_splitter import CharacterTextSplitter
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.prompts import MessagesPlaceholder
from langchain.memory import ChatMessageHistory
from langchain_core.runnables import RunnablePassthrough
from langchain_core.runnables.history import RunnableWithMessageHistory
from operator import itemgetter
​
import config
​
<span class="hljs-comment"># 注入 DashScope API Key</span>
if config.DASHSCOPE_API_KEY:
    os.environ<span class="hljs-section">["DASHSCOPE_API_KEY"]</span> = config.DASHSCOPE_API_KEY
​
<span class="hljs-comment"># 初始化 LLM</span>
<span class="hljs-attr">llm</span> = ChatTongyi(
    <span class="hljs-attr">model</span>=config.MODEL,
    <span class="hljs-attr">temperature</span>=config.TEMPERATURE,
)
​
<span class="hljs-comment"># ========== 加载文档 ==========</span>
<span class="hljs-attr">all_docs</span> = []
try:
    <span class="hljs-attr">txt_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.txt"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">md_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.md"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">pdf_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.pdf"</span>,
        <span class="hljs-attr">loader_cls</span>=config.DOC_DIR,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">all_docs</span> = (txt_docs or []) + (md_docs or []) + (pdf_docs or [])
except Exception as e:
    print(f"⚠️ 文档加载失败: {e}")
    <span class="hljs-attr">all_docs</span> = []
​
<span class="hljs-comment"># 分块</span>
<span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(separator=<span class="hljs-string">"\n\n"</span>, chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">80</span>)
<span class="hljs-attr">texts</span> = text_splitter.split_documents(all_docs) if all_docs else []
​
<span class="hljs-comment"># 初始化 Embeddings</span>
<span class="hljs-attr">embeddings</span> = DashScopeEmbeddings(model=<span class="hljs-string">"text-embedding-v2"</span>)
​
<span class="hljs-comment"># 初始化向量数据库（Chroma）</span>
if texts:
    <span class="hljs-attr">vectorstore</span> = Chroma.from_documents(
        <span class="hljs-attr">documents</span>=texts,
        <span class="hljs-attr">embedding</span>=embeddings,
        <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR
    )
    vectorstore.persist()
else:
    <span class="hljs-comment"># 如果没有文档，尝试从已有数据库加载（避免报错）</span>
    try:
        <span class="hljs-attr">vectorstore</span> = Chroma(
            <span class="hljs-attr">persist_directory</span>=config.EMBEDDINGS_DIR,
            <span class="hljs-attr">embedding_function</span>=embeddings
        )
    except Exception as e:
        print("⚠️ 无文档且无法加载向量库，将使用纯 LLM 模式（无检索）")
        <span class="hljs-attr">vectorstore</span> = None
​
<span class="hljs-comment"># 初始化检索器</span>
if vectorstore:
    <span class="hljs-attr">retriever</span> = vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
else:
    <span class="hljs-comment"># 无检索器时，返回空列表</span>
    <span class="hljs-attr">retriever</span> = lambda query: []
​
<span class="hljs-comment"># 格式化检索结果</span>
def format_docs(docs):
    return "\n\n".join(doc.page_content for doc in docs)
​
<span class="hljs-comment"># ========== 构建带记忆的 RAG 链 ==========</span>
​
<span class="hljs-comment"># Step 1: 修改 Prompt，加入聊天历史</span>
<span class="hljs-attr">system_prompt</span> = (
    "你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。\n"
    "请基于以下检索到的上下文和之前的对话历史回答用户的问题。\n"
    "如果上下文不相关，请仅基于你的知识回答，不要编造。\n\n"
    "上下文：\n{context}\n\n"
    "对话历史：\n{chat_history}"
)
​
<span class="hljs-attr">prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>,
     <span class="hljs-string">"你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。\n"</span>
     <span class="hljs-string">"请基于以下检索到的上下文回答用户的问题。\n"</span>
     <span class="hljs-string">"如果上下文不相关，请仅基于你的知识回答，不要编造。\n\n"</span>
     <span class="hljs-string">"上下文：\n{context}"</span>
    ),
  <span class="hljs-comment"># 历史消息占位</span>
    MessagesPlaceholder(variable_name=<span class="hljs-string">"chat_history"</span>),  <span class="hljs-comment"># ← 自动插入历史</span>
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>)
])
​
<span class="hljs-comment"># Step 2: 单次问答 RAG 链（无记忆）</span>
<span class="hljs-attr">rag_chain</span> = (
    RunnablePassthrough.assign(<span class="hljs-attr">context</span>=itemgetter(<span class="hljs-string">"input"</span>) | retriever | format_docs)
    | prompt
    | llm
    | StrOutputParser()
)
<span class="hljs-comment"># Step 3: 内存中的会话历史存储</span>
<span class="hljs-attr">store</span> = {}
​
def get_session_history(session_id: str) -&gt; ChatMessageHistory:
    if session_id not in store:
        store<span class="hljs-section">[session_id]</span> = ChatMessageHistory()
    return store<span class="hljs-section">[session_id]</span>
​
<span class="hljs-comment"># Step 4: 用 RunnableWithMessageHistory 包装，自动管理历史</span>
<span class="hljs-attr">rag_with_history</span> = RunnableWithMessageHistory(
    rag_chain,
    get_session_history,
    <span class="hljs-attr">input_messages_key</span>=<span class="hljs-string">"input"</span>,        <span class="hljs-comment"># 用户输入字段</span>
    <span class="hljs-attr">history_messages_key</span>=<span class="hljs-string">"chat_history"</span> <span class="hljs-comment"># 历史消息字段（对应 MessagesPlaceholder）</span>
)
​
<span class="hljs-comment"># ========== 多轮对话测试 ==========</span>
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-attr">SESSION_ID</span> = <span class="hljs-string">"user_session_1"</span>  <span class="hljs-comment"># 固定会话 ID，实现单用户多轮</span>
​
    print("💬 欢迎使用 Java 专家问答系统（支持多轮对话）\n")
​
    <span class="hljs-comment"># 第一轮</span>
    <span class="hljs-attr">question1</span> = <span class="hljs-string">"怎么自定义线程池,不用给我代码，简单说不超过200个字"</span>
    print(f"👤 用户: {question1}")
    print("🤖 AI: ", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    for chunk in rag_with_history.stream(
        {"input": question1},
        <span class="hljs-attr">config</span>={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"session_id"</span>: SESSION_ID}}
    ):
        print(chunk, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    print("\n")
​
    <span class="hljs-comment"># 第二轮</span>
    <span class="hljs-attr">question2</span> = <span class="hljs-string">"那核心线程数一般设多少？"</span>
    print(f"\n👤 用户: {question2}")
    print("🤖 AI: ", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    for chunk in rag_with_history.stream(
        {"input": question2},
        <span class="hljs-attr">config</span>={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"session_id"</span>: SESSION_ID}}
    ):
        print(chunk, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    print("\n")
​
    <span class="hljs-comment"># 第三轮</span>
    <span class="hljs-attr">question3</span> = <span class="hljs-string">"如果任务很多，队列会满吗？"</span>
    print(f"\n👤 用户: {question3}")
    print("🤖 AI: ", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    for chunk in rag_with_history.stream(
        {"input": question3},
        <span class="hljs-attr">config</span>={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"session_id"</span>: SESSION_ID}}
    ):
        print(chunk, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    print("\n")
​
    print("\n✅ 多轮对话测试完成！")
</code></pre>
<p>llm的回复如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9929b35a8aa449e9b6652775bea44ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770949326&amp;x-signature=4F2exKDlBBVHFQgSFl9%2B%2F0rhEB4%3D" alt="image-20251018143506520" loading="lazy"/></p>
<p>现在，我们的ai应用已经支持基于本地内存的多轮会话了！！！</p>
<h4 data-id="heading-2">6、对话记忆实现（基于Redis）</h4>
<p>那我们接着来思考一下，仅仅是基于本地内存又有什么弊端呢？</p>
<p>我们的服务如果是部署在多个服务器上呢，如果我们的服务器内存不足呢，那么问题立马就暴露出来了，如果部署在多台服务器上的话，用户A第一次的请求被nginx负载均衡算法转发到了服务器A，那如果还是用户A，第二次请求被转发到了服务器B呢，这时候服务器B的内存中是没有用户A上一次的会话记忆的，就会出现一个类似于我们的多轮会话失效了的现象。</p>
<p>好，问题既然已经发现了，那怎么去解决呢，其实在上面我们提到了，LangChain不仅仅提供了基于本地内存的会话记忆，而且提供了基于Redis的会话记忆。想必Redis大家都应该听过吧，尤其是做Java后端开发的同学，什么缓存击穿，缓存雪崩，缓存穿透啊，但是现在我们用不到这些😄。因为我们就是把对话记录在本地内存存储的方式换成了存到Redis中，Redis是单线程(不过跟咱们现在这个项目没关系)的，并且可以搭建集群，同时呢Redis可以把对话通过生成rdb文件的方式持久化到磁盘，不管我们部署了多少个AI应用服务，部署了多少台服务器，都可以去Redis中查询对话记录。</p>
<p>首先我们要安装Redis，在这里，由于我现在使用的是macOS，所以就用docker的方式安装Redis了。win平台的可以自行去网上搜索安装方式</p>
<pre><code class="hljs language-lua" lang="lua">docker run -d \
  <span class="hljs-comment">--name my-redis \</span>
  -p <span class="hljs-number">6379</span>:<span class="hljs-number">6379</span> \
  -v redis-data:/data \
  <span class="hljs-comment">--restart unless-stopped \</span>
  redis:<span class="hljs-number">7.0</span> redis-server <span class="hljs-comment">--appendonly yes</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61191a0318764ff39a28ec46032a1c81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770949326&amp;x-signature=lSg5SPmnGXzoHYeVDgNHCHmoadA%3D" alt="image-20251019163743463" loading="lazy"/></p>
<p>出现这个界面，就代表Redis docker容器成功运行了</p>
<p>然后使用一款可视化的Redis管理工具:<strong>Another Redis Desktop Manager</strong> 连接到本地的Redis实例默认6379端口</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab9f92fa9ba84583b2218561e7854573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770949326&amp;x-signature=e8K4k83QKKID8hVtLG%2B2jGizNN8%3D" alt="image-20251019163718402" loading="lazy"/></p>
<p>安装好Redis实例之后，我们还需要使用LangChain去操作redis，就需要在项目中安装<strong>langchain-redis</strong>,使用pip命令，或者使用PyCharm可视化安装：</p>
<p>这里我就使用pip命令安装了,进入到当前项目的路径，在终端中输入：</p>
<pre><code class="hljs">pip install langchain-redis
</code></pre>
<p>好了，我们回到<strong>ai_client.py</strong>,导入所需要的包：<strong>RedisChatMessageHistory</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> langchain_community.<span class="hljs-property">chat_message_histories</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">RedisChatMessageHistory</span>
</code></pre>
<p>删除原来的sore和函数<strong>get_session_history</strong>,改为下面的代码</p>
<pre><code class="hljs language-ini" lang="ini">def get_session_history(session_id: str) -&gt; RedisChatMessageHistory:
    return RedisChatMessageHistory(
        <span class="hljs-attr">session_id</span>=session_id,
        <span class="hljs-attr">url</span>=config.REDIS_URL,          <span class="hljs-comment"># e.g., "redis://localhost:6379/0"</span>
        <span class="hljs-attr">ttl</span>=config.REDIS_TTL           <span class="hljs-comment"># 可选：过期时间（秒），如 3600</span>
    )
</code></pre>
<p>说明：</p>
<ul>
<li>每次调用都会创建一个绑定到<code>session_id</code>的Redis历史对象</li>
<li>LangChain会自动在Redis中以<code>message_store:{session_id}</code>为key存储消息</li>
<li>ttl，也就是存活时间，可以自动清理过期的会话，避免占用过多的内存</li>
</ul>
<p>在<strong>config.py</strong>中添加下面的配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># redis连接地址</span>
<span class="hljs-attr">REDIS_URL</span> = <span class="hljs-string">"redis://localhost:6379/0"</span>
<span class="hljs-comment"># redis key过期时间</span>
<span class="hljs-attr">REDIS_TTL</span> = <span class="hljs-number">10000000</span>
</code></pre>
<p>保持rag链不变，</p>
<p>修改之后完整的代码如下（包含测试用例）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ai_client.py</span>
import os
from langchain_community.chat_models import ChatTongyi
from langchain_community.document_loaders import DirectoryLoader, TextLoader, PyPDFLoader
from langchain_community.embeddings import DashScopeEmbeddings
from langchain_community.vectorstores import Chroma
from langchain.text_splitter import CharacterTextSplitter
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.runnables import RunnablePassthrough
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_community.chat_message_histories import RedisChatMessageHistory
from operator import itemgetter
​
import config
​
<span class="hljs-comment"># 设置 API Key</span>
if config.DASHSCOPE_API_KEY:
    os.environ<span class="hljs-section">["DASHSCOPE_API_KEY"]</span> = config.DASHSCOPE_API_KEY
​
<span class="hljs-comment"># 初始化 LLM</span>
<span class="hljs-attr">llm</span> = ChatTongyi(
    <span class="hljs-attr">model</span>=config.MODEL,
    <span class="hljs-attr">temperature</span>=config.TEMPERATURE,
)
​
<span class="hljs-comment"># ========== 加载文档 ==========</span>
<span class="hljs-attr">all_docs</span> = []
try:
    <span class="hljs-attr">txt_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.txt"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">md_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.md"</span>,
        <span class="hljs-attr">loader_cls</span>=TextLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">pdf_docs</span> = DirectoryLoader(
        config.DOC_DIR,
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"**/*.pdf"</span>,
        <span class="hljs-attr">loader_cls</span>=PyPDFLoader,
        <span class="hljs-attr">show_progress</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_multithreading</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">silent_errors</span>=<span class="hljs-literal">True</span>
    ).load()
    <span class="hljs-attr">all_docs</span> = (txt_docs or []) + (md_docs or []) + (pdf_docs or [])
except Exception as e:
    print(f"⚠️ 文档加载失败: {e}")
    <span class="hljs-attr">all_docs</span> = []
​
<span class="hljs-comment"># 分块</span>
<span class="hljs-attr">text_splitter</span> = CharacterTextSplitter(separator=<span class="hljs-string">"\n\n"</span>, chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">80</span>)
<span class="hljs-attr">texts</span> = text_splitter.split_documents(all_docs) if all_docs else []
​
<span class="hljs-comment"># 初始化 Embeddings</span>
<span class="hljs-attr">embeddings</span> = DashScopeEmbeddings(model=<span class="hljs-string">"text-embedding-v2"</span>)
​
<span class="hljs-comment"># 初始化向量数据库</span>
if texts:
    <span class="hljs-attr">vectorstore</span> = Chroma.from_documents(
        <span class="hljs-attr">documents</span>=texts,
        <span class="hljs-attr">embedding</span>=embeddings,
        <span class="hljs-attr">persist_directory</span>=config.DB_PATH
    )
    vectorstore.persist()
else:
    try:
        <span class="hljs-attr">vectorstore</span> = Chroma(
            <span class="hljs-attr">persist_directory</span>=config.DB_PATH,
            <span class="hljs-attr">embedding_function</span>=embeddings
        )
    except Exception as e:
        print("⚠️ 无文档且无法加载向量库，将使用纯 LLM 模式")
        <span class="hljs-attr">vectorstore</span> = None
​
<span class="hljs-comment"># 初始化检索器</span>
if vectorstore:
    <span class="hljs-attr">retriever</span> = vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
else:
    <span class="hljs-attr">retriever</span> = lambda query: []
​
<span class="hljs-comment"># 格式化检索结果</span>
def format_docs(docs):
    return "\n\n".join(doc.page_content for doc in docs)
​
<span class="hljs-comment"># ========== 构建 Prompt ==========</span>
<span class="hljs-attr">prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>,
     <span class="hljs-string">"你是一名资深 Java 开发专家，精通 JDK 8-17、Spring 生态、并发、JVM 调优等。\n"</span>
     <span class="hljs-string">"请基于以下检索到的上下文回答用户的问题。\n"</span>
     <span class="hljs-string">"如果上下文不相关，请仅基于你的知识回答，不要编造。\n\n"</span>
     <span class="hljs-string">"上下文：\n{context}"</span>
    ),
    MessagesPlaceholder(variable_name=<span class="hljs-string">"chat_history"</span>),  <span class="hljs-comment"># 自动插入历史消息</span>
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>)
])
​
<span class="hljs-comment"># ========== 构建 RAG 链 ==========</span>
<span class="hljs-attr">rag_chain</span> = (
    RunnablePassthrough.assign(
        <span class="hljs-attr">context</span>=itemgetter(<span class="hljs-string">"input"</span>) | retriever | format_docs
    )
    | prompt
    | llm
    | StrOutputParser()
)
​
<span class="hljs-comment"># ========== Redis 会话历史 ==========</span>
def get_session_history(session_id: str):
    return RedisChatMessageHistory(
        <span class="hljs-attr">session_id</span>=session_id,
        <span class="hljs-attr">url</span>=config.REDIS_URL,
        <span class="hljs-attr">ttl</span>=config.REDIS_TTL  <span class="hljs-comment"># 自动过期（秒）</span>
    )
​
<span class="hljs-comment"># ========== 带记忆的完整链 ==========</span>
<span class="hljs-attr">rag_with_history</span> = RunnableWithMessageHistory(
    rag_chain,
    get_session_history,
    <span class="hljs-attr">input_messages_key</span>=<span class="hljs-string">"input"</span>,
    <span class="hljs-attr">history_messages_key</span>=<span class="hljs-string">"chat_history"</span>
)
​
<span class="hljs-comment"># ========== 测试多轮对话 ==========</span>
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-attr">SESSION_ID</span> = <span class="hljs-string">"user_12345"</span>  <span class="hljs-comment"># 实际项目中可用用户ID或UUID</span>
​
    print("💬 Java 专家问答系统（Redis 多轮对话）\n")
​
    <span class="hljs-comment"># 第一轮</span>
    <span class="hljs-attr">q1</span> = <span class="hljs-string">"Java 中如何创建一个固定大小的线程池？"</span>
    print(f"👤 用户: {q1}")
    print("🤖 AI: ", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    for chunk in rag_with_history.stream(
        {"input": q1},
        <span class="hljs-attr">config</span>={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"session_id"</span>: SESSION_ID}}
    ):
        print(chunk, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    print("\n")
​
    <span class="hljs-comment"># 第二轮</span>
    <span class="hljs-attr">q2</span> = <span class="hljs-string">"那它和 cachedThreadPool 有什么区别？"</span>
    print(f"\n👤 用户: {q2}")
    print("🤖 AI: ", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    for chunk in rag_with_history.stream(
        {"input": q2},
        <span class="hljs-attr">config</span>={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"session_id"</span>: SESSION_ID}}
    ):
        print(chunk, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    print("\n")
​
    <span class="hljs-comment"># 第三轮</span>
    <span class="hljs-attr">q3</span> = <span class="hljs-string">"如果任务抛异常，线程池会怎样？"</span>
    print(f"\n👤 用户: {q3}")
    print("🤖 AI: ", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    for chunk in rag_with_history.stream(
        {"input": q3},
        <span class="hljs-attr">config</span>={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"session_id"</span>: SESSION_ID}}
    ):
        print(chunk, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
    print("\n")
​
    print("✅ 对话已持久化到 Redis！")
</code></pre>
<p>运行代码控制台输出如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2457e519170452ea0642c2b23599e53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770949326&amp;x-signature=SpCEsM%2Fzma7J%2FFw2duX8YMhK0Os%3D" alt="image-20251019165928716" loading="lazy"/></p>
<p>Redis中已经成功存储了对话</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3863cf51c4554ceeb3e792b4ba51b389~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770949326&amp;x-signature=obrkvZ60T5JDtVWFbBrVULlQnh0%3D" alt="image-20251019170037803" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/926e07388b074e5dad3f631ab176dc4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oSf5oCn55qE56iL5bqP5ZGY5bCP546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770949326&amp;x-signature=hPqFJ6tUO9PZNEwEfR5o0FVo168%3D" alt="image-20251019170111468" loading="lazy"/></p>
<p>至此，基于Redis的多轮对话记忆开发完毕！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[promise-logic v2.8 更新]]></title>    <link>https://juejin.cn/post/7603263490341584905</link>    <guid>https://juejin.cn/post/7603263490341584905</guid>    <pubDate>2026-02-06T01:36:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490341584905" data-draft-id="7603227363821502490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="promise-logic v2.8 更新"/> <meta itemprop="keywords" content="JavaScript,开源"/> <meta itemprop="datePublished" content="2026-02-06T01:36:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xier123456"/> <meta itemprop="url" content="https://juejin.cn/user/546930955651113"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            promise-logic v2.8 更新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/546930955651113/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xier123456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T01:36:39.000Z" title="Fri Feb 06 2026 01:36:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、主要更新内容</h2>
<h3 data-id="heading-1">1. allFulfilled &amp; allRejected 性能优化</h3>
<h4 data-id="heading-2">难点分析：</h4>
<ul>
<li>需兼顾“即时返回结果”与“保持输入顺序”的双重需求</li>
<li>避免因等待所有 Promise 完成导致的性能损耗</li>
<li>确保高并发场景下的结果一致性</li>
</ul>
<h4 data-id="heading-3">解决方案：</h4>
<ul>
<li>底层重构实现逻辑，采用“增量收集+顺序校准”机制</li>
<li>单个 Promise 完成后立即返回当前已收集结果，无需等待全部完成</li>
<li>最终结果严格遵循输入顺序排列，不受 Promise 完成顺序影响</li>
</ul>
<h4 data-id="heading-4">示例：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromiseLogic</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'promise-logic'</span>;

<span class="hljs-comment">// 快慢 Promise 混合场景</span>
<span class="hljs-keyword">const</span> operations = [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'slowSuccess'</span>), <span class="hljs-number">100</span>)),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'error'</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'fastSuccess'</span>), <span class="hljs-number">10</span>))
];

<span class="hljs-comment">// 10ms 时返回 ['fastSuccess']，100ms 时返回 ['slowSuccess', 'fastSuccess']</span>
<span class="hljs-title class_">PromiseLogic</span>.<span class="hljs-title function_">allFulfilled</span>(operations).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'优化后结果:'</span>, results);
});
</code></pre>
<h3 data-id="heading-5">2. maxTimer 链式超时增强</h3>
<h4 data-id="heading-6">难点分析：</h4>
<ul>
<li>需支持自定义错误信息，满足不同业务场景的报错需求</li>
<li>保持超时逻辑的中断特性，同时兼容链式调用</li>
<li>确保错误类型与原有错误体系一致</li>
</ul>
<h4 data-id="heading-7">解决方案：</h4>
<ul>
<li>扩展  maxTimer  方法参数，支持传入自定义错误信息</li>
<li>超时后立即中断 Promise 链，跳转至错误处理逻辑</li>
<li>错误类型统一归类为  PromiseLogicError ，通过  error.type  标识超时类型</li>
</ul>
<h4 data-id="heading-8">示例：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromiseLogic</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'promise-logic'</span>;

<span class="hljs-title class_">PromiseLogic</span>.<span class="hljs-title function_">and</span>([
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">3000</span>)), <span class="hljs-comment">// 3秒任务</span>
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>)
])
.<span class="hljs-title function_">maxTimer</span>(<span class="hljs-number">2000</span>, <span class="hljs-string">'接口请求超时：2秒内未完成所有操作'</span>) <span class="hljs-comment">// 自定义错误信息</span>
.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>); <span class="hljs-comment">// 输出自定义错误信息</span>
});
</code></pre>
<h3 data-id="heading-9">3. TypeScript 类型修复</h3>
<h4 data-id="heading-10">难点分析：</h4>
<ul>
<li>解决 TypeScript 版本中类型推断不准确的问题</li>
<li>支持显式类型断言与自动类型推断双模式</li>
<li>确保所有逻辑门方法的类型定义一致性</li>
</ul>
<h4 data-id="heading-11">解决方案：</h4>
<ul>
<li>重构 TypeScript 类型声明文件，优化泛型约束</li>
<li>为所有核心方法添加泛型支持，支持显式指定返回类型</li>
<li>修复  majority 、 allFulfilled  等方法的类型推断漏洞</li>
</ul>
<h4 data-id="heading-12">示例：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromiseLogic</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'promise-logic/typescript'</span>;

<span class="hljs-comment">// 显式类型断言</span>
<span class="hljs-title class_">PromiseLogic</span>.<span class="hljs-title function_">majority</span>([<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api1'</span>), <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api2'</span>)])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results: Response[]</span>) =&gt;</span> { <span class="hljs-comment">/* 类型安全 */</span> });

<span class="hljs-comment">// 自动类型推断</span>
<span class="hljs-title class_">PromiseLogic</span>.<span class="hljs-title function_">and</span>([<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>), <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>)])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results: number[]</span>) =&gt;</span> { <span class="hljs-comment">/* 自动推断为number数组 */</span> });
</code></pre>
<h2 data-id="heading-13">二、项目更新内容</h2>
<ol>
<li>性能优化：底层重构  allFulfilled 、 allRejected  实现，兼顾即时返回与顺序一致性</li>
<li>超时功能增强： maxTimer  方法支持自定义错误信息，错误类型标准化</li>
<li>TypeScript 支持：修复类型声明问题，完善泛型支持，支持显式/自动类型推断</li>
<li>测试覆盖：新增  allFulfilled 、 allRejected 、 maxTimer  完整单元测试，覆盖率100%</li>
<li>代码重构：优化项目结构，拆分逻辑模块，提升可维护性</li>
</ol>
<h2 data-id="heading-14">三、版本更新说明</h2>
<ul>
<li>英文： v2.8.0_Performance optimization for allFulfilled/allRejected, add custom error messages for maxTimer, fix TypeScript type issues, complete test cases, refactor code structure</li>
<li>中文： v2.8.0_优化 allFulfilled/allRejected 性能，maxTimer 支持自定义错误信息，修复 TypeScript 类型问题，完善测试用例，重构代码结构</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 模拟器管理完全指南：xcrun simctl 从入门到精通]]></title>    <link>https://juejin.cn/post/7603238967290822708</link>    <guid>https://juejin.cn/post/7603238967290822708</guid>    <pubDate>2026-02-06T02:05:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603238967290822708" data-draft-id="7603043152673570831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 模拟器管理完全指南：xcrun simctl 从入门到精通 "/> <meta itemprop="keywords" content="iOS,Apple"/> <meta itemprop="datePublished" content="2026-02-06T02:05:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wangruofeng"/> <meta itemprop="url" content="https://juejin.cn/user/712139266070296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 模拟器管理完全指南：xcrun simctl 从入门到精通 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139266070296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wangruofeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:05:59.000Z" title="Fri Feb 06 2026 02:05:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>本文整理了开发过程中常用的 <code>xcrun simctl</code> 命令，用于管理 iOS 模拟器和运行时环境。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f41d40c96854ecb85d63ea2bd410ccf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2FuZ3J1b2Zlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770948360&amp;x-signature=G%2FzqrPfrVQj4C4Mby1cMWtGbvxk%3D" alt="iOS 模拟器管理完全指南封面_compressed.webp" loading="lazy"/></p>
<p><code>xcrun</code> 是 macOS 上的一个命令行工具，用于在命令行中执行 Xcode 开发工具链中的各种工具和实用程序，而无需直接指定其完整路径。这使得在终端中更轻松地调用和管理 Xcode 相关的工具。</p>
<h2 data-id="heading-0">运行时管理</h2>
<h3 data-id="heading-1">列出所有运行时</h3>
<pre><code class="hljs language-bash" lang="bash">xcrun simctl list runtimes
</code></pre>
<p><strong>说明</strong>：显示所有已安装的 iOS、watchOS、tvOS 等运行时环境，包括运行时版本、构建号和唯一标识符。</p>
<h3 data-id="heading-2">列出可用的运行时</h3>
<pre><code class="hljs language-bash" lang="bash">xcrun simctl list runtimes available
</code></pre>
<p><strong>说明</strong>：仅显示当前可用的运行时，过滤掉不可用的版本。</p>
<h3 data-id="heading-3">JSON 格式输出</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 输出为 JSON 格式（适合脚本处理）</span>
xcrun simctl list runtimes -j
xcrun simctl runtime list --json
</code></pre>
<h3 data-id="heading-4">添加运行时</h3>
<pre><code class="hljs language-bash" lang="bash">xcrun simctl runtime add <span class="hljs-string">"path/to/Simulator_Runtime.dmg"</span>
</code></pre>
<p><strong>说明</strong>：安装指定的运行时环境。需要从 Apple 开发者网站下载对应的 <code>.dmg</code> 文件。</p>
<h3 data-id="heading-5">删除运行时</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 推荐方式</span>
xcrun simctl runtime delete com.apple.CoreSimulator.SimRuntime.iOS-18-2

<span class="hljs-comment"># 删除指定天数未使用的运行时</span>
xcrun simctl runtime delete --notUsedSinceDays 30

<span class="hljs-comment"># 预览将要删除的内容（不实际删除）</span>
xcrun simctl runtime delete com.apple.CoreSimulator.SimRuntime.iOS-18-2 --dry-run
</code></pre>
<p><strong>常见运行时标识符</strong>：</p>
<ul>
<li><code>com.apple.CoreSimulator.SimRuntime.iOS-18-2</code></li>
<li><code>com.apple.CoreSimulator.SimRuntime.iOS-17-5</code></li>
<li><code>com.apple.CoreSimulator.SimRuntime.tvOS-18-1</code></li>
</ul>
<hr/>
<h2 data-id="heading-6">设备管理</h2>
<h3 data-id="heading-7">列出和筛选设备</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出设备和运行时</span>
xcrun simctl list devices
xcrun simctl list runtimes

<span class="hljs-comment"># 列出设备类型（默认行为）</span>
xcrun simctl list

<span class="hljs-comment"># 输出为 JSON 格式</span>
xcrun simctl list devices --json

<span class="hljs-comment"># 获取所有的设备（包含真机）使用 xctrace</span>
xcrun xctrace list devices

<span class="hljs-comment"># 筛选特定版本的设备</span>
xcrun simctl list devices | grep -A 20 <span class="hljs-string">"iOS 18.2"</span>

<span class="hljs-comment"># 列出设备类型</span>
xcrun simctl list devicetypes
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>不带参数的 <code>list</code> 默认显示设备类型</li>
<li>使用 <code>list devices</code> 显示已创建的模拟器设备</li>
<li>使用 <code>list runtimes</code> 显示运行时环境</li>
<li>使用 <code>grep</code> 筛选特定 iOS 版本的设备，<code>-A 20</code> 表示显示匹配行及后续 20 行</li>
</ul>
<h3 data-id="heading-8">设备操作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除不可用的设备</span>
xcrun simctl delete unavailable

<span class="hljs-comment"># 创建新设备</span>
xcrun simctl create <span class="hljs-string">"My iPhone 15"</span> <span class="hljs-string">"iPhone 15"</span> <span class="hljs-string">"iOS18.2"</span>

<span class="hljs-comment"># 克隆现有设备</span>
xcrun simctl <span class="hljs-built_in">clone</span> &lt;sourceUDID&gt; <span class="hljs-string">"New Device Name"</span>

<span class="hljs-comment"># 重命名设备</span>
xcrun simctl rename &lt;UDID&gt; <span class="hljs-string">"New Device Name"</span>

<span class="hljs-comment"># 升级设备到新运行时</span>
xcrun simctl upgrade &lt;UDID&gt; &lt;runtime_identifier&gt;
</code></pre>
<h3 data-id="heading-9">设备控制</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打开上次启动的模拟器</span>
open -a simulator

<span class="hljs-comment"># 启动指定模拟器</span>
xcrun simctl boot &lt;UDID&gt;

<span class="hljs-comment"># 关闭指定模拟器</span>
xcrun simctl shutdown &lt;UDID&gt;

<span class="hljs-comment"># 重置指定模拟器</span>
xcrun simctl erase &lt;UDID&gt;

<span class="hljs-comment"># 清除所有 iOS 模拟器缓存</span>
xcrun simctl erase all

<span class="hljs-comment"># 切换主题模式</span>
xcrun simctl ui &lt;UDID&gt; appearance light  <span class="hljs-comment"># 浅色主题</span>
xcrun simctl ui &lt;UDID&gt; appearance dark   <span class="hljs-comment"># 深色主题</span>
</code></pre>
<hr/>
<h2 data-id="heading-10">应用和数据管理</h2>
<h3 data-id="heading-11">应用安装和启动</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装应用</span>
xcrun simctl install &lt;UDID&gt; &lt;path/to/app.app&gt;

<span class="hljs-comment"># 启动指定应用</span>
xcrun simctl launch booted &lt;packageName&gt;
xcrun simctl launch &lt;UDID&gt; &lt;packageName&gt;

<span class="hljs-comment"># 关闭已打开的应用</span>
xcrun simctl terminate booted &lt;packageName&gt;
xcrun simctl terminate &lt;UDID&gt; &lt;packageName&gt;

<span class="hljs-comment"># 卸载应用</span>
xcrun simctl uninstall &lt;UDID&gt; &lt;bundleIdentifier&gt;

<span class="hljs-comment"># 获取应用容器路径</span>
xcrun simctl get_app_container &lt;UDID&gt; &lt;bundleIdentifier&gt;

<span class="hljs-comment"># 安装应用数据</span>
xcrun simctl install_app_data &lt;UDID&gt; &lt;path/to/data.xcappdata&gt;
</code></pre>
<h3 data-id="heading-12">隐私和权限管理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 授予所有权限</span>
xcrun simctl privacy booted grant all &lt;packageName&gt;

<span class="hljs-comment"># 授予特定权限</span>
xcrun simctl privacy booted grant photos &lt;packageName&gt;

<span class="hljs-comment"># 撤销权限</span>
xcrun simctl privacy booted revoke camera &lt;packageName&gt;

<span class="hljs-comment"># 重置权限</span>
xcrun simctl privacy booted reset all &lt;packageName&gt;
</code></pre>
<h3 data-id="heading-13">状态栏控制</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置时间</span>
xcrun simctl status_bar booted override --time 23:59

<span class="hljs-comment"># 设置电量为50</span>
xcrun simctl status_bar booted override --batteryLevel 50

<span class="hljs-comment"># 设置数据网络类型</span>
xcrun simctl status_bar booted override --dataNetwork 5g

<span class="hljs-comment"># 设置 WiFi 信号栏（0-3）</span>
xcrun simctl status_bar booted override --wifiBars 3

<span class="hljs-comment"># 设置运营商名称</span>
xcrun simctl status_bar booted override --operatorName <span class="hljs-string">'中国电信'</span>

<span class="hljs-comment"># 清除所有修改</span>
xcrun simctl status_bar booted clear
</code></pre>
<hr/>
<h2 data-id="heading-14">截图和录屏</h2>
<blockquote>
<p><code>booted</code> 代表当前启动的模拟器；也可指定模拟器 <code>&lt;UDID&gt;</code></p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 截图</span>
xcrun simctl io booted screenshot xxx.png
xcrun simctl io &lt;UDID&gt; screenshot xxx.png

<span class="hljs-comment"># 录制模拟器视频（在终端按 Ctrl+C 来停止录屏）</span>
xcrun simctl io booted recordVideo test.mp4

<span class="hljs-comment"># 保存到指定目录</span>
xcrun simctl io booted screenshot ~/Desktop/screenshot.png
xcrun simctl io booted screenshot /Users/username/Pictures/screenshot.png
</code></pre>
<hr/>
<h2 data-id="heading-15">高级功能</h2>
<h3 data-id="heading-16">剪贴板操作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 复制到剪贴板</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Hello"</span> | xcrun simctl pbcopy &lt;UDID&gt;

<span class="hljs-comment"># 粘贴剪贴板内容</span>
xcrun simctl pbpaste &lt;UDID&gt;

<span class="hljs-comment"># 在设备间同步剪贴板内容</span>
xcrun simctl pbsync &lt;sourceUDID&gt; &lt;destinationUDID&gt;
</code></pre>
<h3 data-id="heading-17">URL 和位置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打开 URL</span>
xcrun simctl openurl booted <span class="hljs-string">"https://www.example.com"</span>

<span class="hljs-comment"># 设置模拟位置</span>
xcrun simctl location booted <span class="hljs-built_in">set</span> 37.7749,-122.4194

<span class="hljs-comment"># 清除模拟位置</span>
xcrun simctl location booted clear
</code></pre>
<h3 data-id="heading-18">推送通知</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 发送模拟推送通知</span>
xcrun simctl push booted &lt;bundleIdentifier&gt; &lt;path/to/push.json&gt;
</code></pre>
<p>推送通知 JSON 示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"aps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"alert"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Test Push Notification"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"badge"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sound"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"default"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">Keychain 和媒体文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加钥匙条目</span>
xcrun simctl keychain booted add-root-cert &lt;path/to/cert.der&gt;

<span class="hljs-comment"># 删除钥匙串</span>
xcrun simctl keychain booted reset

<span class="hljs-comment"># 添加照片到设备</span>
xcrun simctl addmedia booted ~/Photos/photo.jpg

<span class="hljs-comment"># 添加视频到设备</span>
xcrun simctl addmedia booted ~/Videos/video.mp4
</code></pre>
<h3 data-id="heading-20">环境变量和系统信息</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取启动的模拟器 UDID</span>
xcrun simctl getenv booted SIMULATOR_UDID

<span class="hljs-comment"># 获取环境变量</span>
xcrun simctl getenv &lt;UDID&gt; &lt;variable_name&gt;

<span class="hljs-comment"># 读取所有 iOS 模拟器的信息</span>
defaults <span class="hljs-built_in">read</span> com.apple.iphonesimulator

<span class="hljs-comment"># 触发 iCloud 同步</span>
xcrun simctl icloud_sync booted

<span class="hljs-comment"># 启用详细日志</span>
xcrun simctl logverbose booted <span class="hljs-built_in">enable</span>

<span class="hljs-comment"># 禁用详细日志</span>
xcrun simctl logverbose booted <span class="hljs-built_in">disable</span>
</code></pre>
<hr/>
<h2 data-id="heading-21">诊断工具</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基本诊断</span>
xcrun simctl diagnose

<span class="hljs-comment"># 指定输出目录</span>
xcrun simctl diagnose --output ~/Desktop/diag

<span class="hljs-comment"># 包含所有设备日志</span>
xcrun simctl diagnose --all-logs

<span class="hljs-comment"># 不创建压缩包</span>
xcrun simctl diagnose --no-archive

<span class="hljs-comment"># 无超时运行</span>
xcrun simctl diagnose -X
</code></pre>
<p><strong>说明</strong>：生成模拟器诊断报告，用于排查模拟器问题和故障。常用参数：</p>
<ul>
<li><code>--output</code>: 指定输出目录</li>
<li><code>--all-logs</code>: 包含所有设备日志</li>
<li><code>--no-archive</code>: 不创建压缩包</li>
<li><code>-X</code>: 无超时运行（忽略超时设置）</li>
</ul>
<hr/>
<h2 data-id="heading-22">常见使用场景</h2>
<h3 data-id="heading-23">场景 1：清理旧版本运行时</h3>
<p>当需要升级到新的 iOS 版本时，可以删除旧运行时以释放空间：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看当前运行时</span>
xcrun simctl list runtimes

<span class="hljs-comment"># 2. 删除不需要的运行时</span>
sudo xcrun simctl runtime delete com.apple.CoreSimulator.SimRuntime.iOS-18-2

<span class="hljs-comment"># 3. 确认删除成功</span>
xcrun simctl list runtimes
</code></pre>
<h3 data-id="heading-24">场景 2：清理无效设备</h3>
<p>定期清理失效的模拟器设备：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看所有设备</span>
xcrun simctl list

<span class="hljs-comment"># 2. 删除不可用的设备</span>
xcrun simctl delete unavailable

<span class="hljs-comment"># 3. 验证清理结果</span>
xcrun simctl list
</code></pre>
<h3 data-id="heading-25">场景 3：检查特定版本的设备</h3>
<p>查找使用特定 iOS 版本的设备：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查找 iOS 18.2 的设备</span>
xcrun simctl list devices | grep -A 20 <span class="hljs-string">"iOS 18.2"</span>

<span class="hljs-comment"># 使用 JSON 和 jq 进行更精确的过滤</span>
xcrun simctl list devices --json | jq <span class="hljs-string">'.devices'</span>
</code></pre>
<h3 data-id="heading-26">场景 4：批量清理旧运行时</h3>
<p>定期清理未使用的运行时以释放磁盘空间：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看所有运行时（详细信息）</span>
xcrun simctl runtime list -v

<span class="hljs-comment"># 2. 预览将要删除的运行时（安全模式）</span>
xcrun simctl runtime delete --notUsedSinceDays 30 --dry-run

<span class="hljs-comment"># 3. 删除 30 天未使用的运行时</span>
xcrun simctl runtime delete --notUsedSinceDays 30

<span class="hljs-comment"># 4. 确认清理结果</span>
xcrun simctl list runtimes
</code></pre>
<h3 data-id="heading-27">场景 5：自动化测试截图</h3>
<p>在自动化测试中截取屏幕截图：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动模拟器</span>
xcrun simctl boot &lt;UDID&gt;

<span class="hljs-comment"># 安装应用</span>
xcrun simctl install &lt;UDID&gt; /path/to/app.app

<span class="hljs-comment"># 启动应用</span>
xcrun simctl launch &lt;UDID&gt; com.example.app

<span class="hljs-comment"># 等待应用加载...</span>

<span class="hljs-comment"># 截图</span>
xcrun simctl io &lt;UDID&gt; screenshot screenshot.png

<span class="hljs-comment"># 录制视频</span>
xcrun simctl io &lt;UDID&gt; recordVideo demo.mp4
</code></pre>
<h3 data-id="heading-28">场景 6：模拟不同状态栏状态</h3>
<p>测试应用在不同状态栏状态下的表现：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 模拟低电量</span>
xcrun simctl status_bar booted override --batteryLevel 10

<span class="hljs-comment"># 模拟特定时间</span>
xcrun simctl status_bar booted override --time 23:59

<span class="hljs-comment"># 模拟无信号</span>
xcrun simctl status_bar booted override --wifiBars 0

<span class="hljs-comment"># 测试完成后清除</span>
xcrun simctl status_bar booted clear
</code></pre>
<h3 data-id="heading-29">场景 7：测试推送通知</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建推送通知文件</span>
<span class="hljs-built_in">cat</span> &gt; push.json &lt;&lt; <span class="hljs-string">EOF
{
  "aps": {
    "alert": {
      "title": "新消息",
      "body": "您有一条新消息"
    },
    "badge": 1,
    "sound": "default"
  }
}
EOF</span>

<span class="hljs-comment"># 发送推送通知</span>
xcrun simctl push booted com.example.app push.json
</code></pre>
<hr/>
<h2 data-id="heading-30">命令速查表</h2>
<h3 data-id="heading-31">运行时管理</h3>





























<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>xcrun simctl list runtimes</code></td><td>列出所有运行时</td></tr><tr><td><code>xcrun simctl runtime list</code></td><td>列出可用运行时</td></tr><tr><td><code>xcrun simctl runtime add &lt;path&gt;</code></td><td>添加运行时</td></tr><tr><td><code>xcrun simctl runtime delete &lt;identifier&gt;</code></td><td>删除运行时（推荐）</td></tr><tr><td><code>xcrun simctl runtime delete --notUsedSinceDays &lt;days&gt;</code></td><td>删除指定天数未使用的运行时</td></tr></tbody></table>
<h3 data-id="heading-32">设备管理</h3>





































<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>xcrun simctl list devices</code></td><td>列出所有设备</td></tr><tr><td><code>xcrun simctl list devicetypes</code></td><td>列出设备类型</td></tr><tr><td><code>xcrun simctl delete unavailable</code></td><td>删除不可用设备</td></tr><tr><td><code>xcrun simctl create &lt;name&gt; &lt;type&gt; &lt;runtime&gt;</code></td><td>创建新设备</td></tr><tr><td><code>xcrun simctl clone &lt;UDID&gt; &lt;name&gt;</code></td><td>克隆设备</td></tr><tr><td><code>xcrun simctl rename &lt;UDID&gt; &lt;name&gt;</code></td><td>重命名设备</td></tr><tr><td><code>xcrun simctl upgrade &lt;UDID&gt; &lt;runtime&gt;</code></td><td>升级设备运行时</td></tr></tbody></table>
<h3 data-id="heading-33">设备控制</h3>

























<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>xcrun simctl boot &lt;UDID&gt;</code></td><td>启动模拟器</td></tr><tr><td><code>xcrun simctl shutdown &lt;UDID&gt;</code></td><td>关闭模拟器</td></tr><tr><td><code>xcrun simctl erase &lt;UDID&gt;</code></td><td>重置模拟器</td></tr><tr><td><code>xcrun simctl ui &lt;UDID&gt; appearance &lt;mode&gt;</code></td><td>切换主题模式</td></tr></tbody></table>
<h3 data-id="heading-34">应用和数据</h3>













































<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>xcrun simctl launch &lt;UDID&gt; &lt;bundleID&gt;</code></td><td>启动应用</td></tr><tr><td><code>xcrun simctl terminate &lt;UDID&gt; &lt;bundleID&gt;</code></td><td>关闭应用</td></tr><tr><td><code>xcrun simctl install &lt;UDID&gt; &lt;path&gt;</code></td><td>安装应用</td></tr><tr><td><code>xcrun simctl uninstall &lt;UDID&gt; &lt;bundleID&gt;</code></td><td>卸载应用</td></tr><tr><td><code>xcrun simctl get_app_container &lt;UDID&gt; &lt;bundleID&gt;</code></td><td>获取应用容器路径</td></tr><tr><td><code>xcrun simctl privacy &lt;UDID&gt; grant all &lt;bundleID&gt;</code></td><td>授予所有权限</td></tr><tr><td><code>xcrun simctl status_bar booted override --time &lt;time&gt;</code></td><td>设置时间</td></tr><tr><td><code>xcrun simctl status_bar booted override --batteryLevel &lt;level&gt;</code></td><td>设置电量</td></tr><tr><td><code>xcrun simctl status_bar booted clear</code></td><td>清除状态栏修改</td></tr></tbody></table>
<h3 data-id="heading-35">截图和录屏</h3>

















<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>xcrun simctl io booted screenshot &lt;file.png&gt;</code></td><td>截图</td></tr><tr><td><code>xcrun simctl io booted recordVideo &lt;file.mp4&gt;</code></td><td>录制视频</td></tr></tbody></table>
<h3 data-id="heading-36">高级功能</h3>





















































<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>xcrun simctl diagnose</code></td><td>运行诊断</td></tr><tr><td><code>xcrun simctl getenv booted SIMULATOR_UDID</code></td><td>获取当前模拟器 UDID</td></tr><tr><td><code>xcrun simctl openurl booted &lt;url&gt;</code></td><td>打开 URL</td></tr><tr><td><code>xcrun simctl location booted set &lt;lat,lon&gt;</code></td><td>设置模拟位置</td></tr><tr><td><code>xcrun simctl push booted &lt;bundleID&gt; &lt;json&gt;</code></td><td>发送推送通知</td></tr><tr><td><code>xcrun simctl pbcopy &lt;UDID&gt;</code></td><td>复制到剪贴板</td></tr><tr><td><code>xcrun simctl pbpaste &lt;UDID&gt;</code></td><td>粘贴剪贴板内容</td></tr><tr><td><code>xcrun simctl keychain booted add-root-cert &lt;path&gt;</code></td><td>添加证书到钥匙串</td></tr><tr><td><code>xcrun simctl addmedia booted &lt;path&gt;</code></td><td>添加媒体文件</td></tr><tr><td><code>xcrun simctl icloud_sync booted</code></td><td>触发 iCloud 同步</td></tr><tr><td><code>xcrun simctl logverbose booted enable/disable</code></td><td>启用/禁用详细日志</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-37">高级用法</h2>
<p><strong>JSON 输出和脚本化处理</strong></p>
<p>所有 <code>list</code> 命令都支持 JSON 输出，适合脚本化处理：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 输出运行时为 JSON 格式</span>
xcrun simctl list runtimes -j

<span class="hljs-comment"># 输出设备列表为 JSON 格式</span>
xcrun simctl list devices --json

<span class="hljs-comment"># 使用 jq 进行过滤和格式化</span>
xcrun simctl list runtimes -j | jq <span class="hljs-string">'.runtimes[] | select(.name | contains("iOS"))'</span>

<span class="hljs-comment"># 获取所有设备 UDID</span>
xcrun simctl list devices --json | jq -r <span class="hljs-string">'.devices | to_entries[] | .value[] | .udid'</span>

<span class="hljs-comment"># 获取所有已启动的设备</span>
xcrun simctl list devices --json | jq -r <span class="hljs-string">'.devices | to_entries[] | .value[] | select(.state == "Booted") | .udid'</span>

<span class="hljs-comment"># 获取特定运行时的所有设备</span>
xcrun simctl list devices --json | jq -r <span class="hljs-string">'.devices | to_entries[] | .value[] | select(.runtime.identifier | contains("iOS18-2")) | .name'</span>
</code></pre>
<hr/>
<h2 data-id="heading-38">完整命令参考</h2>
<p><code>xcrun simctl</code> 支持的所有子命令：</p>





























































































































































<table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td><code>addmedia</code></td><td>添加照片、实时照片、视频或联系人到设备库</td></tr><tr><td><code>boot</code></td><td>启动设备或设备对</td></tr><tr><td><code>clone</code></td><td>克隆现有设备</td></tr><tr><td><code>create</code></td><td>创建新设备</td></tr><tr><td><code>delete</code></td><td>删除指定设备、不可用设备或所有设备</td></tr><tr><td><code>diagnose</code></td><td>收集诊断信息和日志</td></tr><tr><td><code>erase</code></td><td>擦除设备的内容和设置</td></tr><tr><td><code>get_app_container</code></td><td>打印已安装应用的容器路径</td></tr><tr><td><code>getenv</code></td><td>打印运行设备的环境变量</td></tr><tr><td><code>help</code></td><td>打印给定子命令的使用说明</td></tr><tr><td><code>icloud_sync</code></td><td>在设备上触发 iCloud 同步</td></tr><tr><td><code>install</code></td><td>在设备上安装应用</td></tr><tr><td><code>install_app_data</code></td><td>安装 xcappdata 包到设备，替换容器当前内容</td></tr><tr><td><code>io</code></td><td>设置设备 IO 操作</td></tr><tr><td><code>keychain</code></td><td>操作设备钥匙串</td></tr><tr><td><code>launch</code></td><td>在设备上通过标识符启动应用</td></tr><tr><td><code>list</code></td><td>列出可用设备、设备类型、运行时或设备对</td></tr><tr><td><code>location</code></td><td>控制设备的模拟位置</td></tr><tr><td><code>logverbose</code></td><td>启用或禁用设备的详细日志</td></tr><tr><td><code>openurl</code></td><td>在设备中打开 URL</td></tr><tr><td><code>pair</code></td><td>创建新手表和手机对</td></tr><tr><td><code>pair_activate</code></td><td>将给定的对设置为活动</td></tr><tr><td><code>pbcopy</code></td><td>将标准输入复制到设备剪贴板</td></tr><tr><td><code>pbpaste</code></td><td>将设备剪贴板内容打印到标准输出</td></tr><tr><td><code>pbsync</code></td><td>将剪贴板内容从一个剪贴板同步到另一个</td></tr><tr><td><code>privacy</code></td><td>授予、撤销或重置隐私和权限</td></tr><tr><td><code>push</code></td><td>发送模拟推送通知</td></tr><tr><td><code>rename</code></td><td>重命名设备</td></tr><tr><td><code>runtime</code></td><td>对运行时执行操作</td></tr><tr><td><code>shutdown</code></td><td>关闭设备</td></tr><tr><td><code>spawn</code></td><td>通过在设备上执行给定可执行文件来生成进程</td></tr><tr><td><code>status_bar</code></td><td>设置或清除状态栏覆盖</td></tr><tr><td><code>terminate</code></td><td>在设备上通过标识符终止应用</td></tr><tr><td><code>ui</code></td><td>获取或设置 UI 选项</td></tr><tr><td><code>uninstall</code></td><td>从设备卸载应用</td></tr><tr><td><code>unpair</code></td><td>取消手表和手机对</td></tr><tr><td><code>upgrade</code></td><td>将设备升级到更新的运行时</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-39">注意事项</h2>
<ol>
<li><strong>权限问题</strong>：删除运行时通常需要 <code>sudo</code> 权限</li>
<li><strong>设备依赖</strong>：删除运行时前确保没有设备在使用该运行时</li>
<li><strong>磁盘空间</strong>：运行时占用较大磁盘空间（通常 10GB+），定期清理可释放空间</li>
<li><strong>Xcode 版本</strong>：不同 Xcode 版本支持的运行时版本可能不同</li>
<li><strong>JSON 输出</strong>：使用 <code>-j</code> 或 <code>--json</code> 参数便于脚本处理和数据分析</li>
<li><strong>UDID vs booted</strong>：
<ul>
<li>使用 <code>&lt;UDID&gt;</code> 需要指定具体设备的唯一标识符</li>
<li>使用 <code>booted</code> 自动选择当前启动的模拟器</li>
<li>可以通过 <code>xcrun simctl getenv booted SIMULATOR_UDID</code> 获取当前启动设备的 UDID</li>
</ul>
</li>
<li><strong>应用 Bundle ID</strong>：大部分应用相关命令需要使用应用的 Bundle Identifier（如 <code>com.example.app</code>）</li>
<li><strong>录制视频</strong>：录制过程中终端会被占用，使用 <code>Ctrl+C</code> 停止录制</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搭建Hyperf本地开发环境之Docker容器开发(二)]]></title>    <link>https://juejin.cn/post/7603238967291396148</link>    <guid>https://juejin.cn/post/7603238967291396148</guid>    <pubDate>2026-02-06T02:52:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603238967291396148" data-draft-id="7603283380554022946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搭建Hyperf本地开发环境之Docker容器开发(二)"/> <meta itemprop="keywords" content="后端,PHP,Docker"/> <meta itemprop="datePublished" content="2026-02-06T02:52:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="joker丶牧羊人"/> <meta itemprop="url" content="https://juejin.cn/user/4054654614250958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搭建Hyperf本地开发环境之Docker容器开发(二)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654614250958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    joker丶牧羊人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T02:52:09.000Z" title="Fri Feb 06 2026 02:52:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">写在前面</h3>
<blockquote>
<p>《搭建Hyperf本地开发环境之Docker容器开发（二）》是继 《搭建Hyperf本地开发环境之Docker容器开发（一）》的补充说明；</p>
<p>为什么要做这个补充呢，是因为我发现我在安装 oracle 扩展的时候，发现不能成功，所以重新做了改动来满足我的需求；</p>
<p>初衷还是不变，都是通过修改配置文件来控制一切；</p>
</blockquote>
<h4 data-id="heading-1">快闪回放</h4>
<p><a href="https://juejin.cn/post/7576086557716168755" target="_blank" title="https://juejin.cn/post/7576086557716168755">搭建Hyperf本地开发环境之Docker容器开发（一）</a></p>
<h4 data-id="heading-2">目录结构</h4>
<pre><code class="hljs language-shell" lang="shell">project
|--config
   |--build.conf
   |--extension_deps.conf
   |--extension_special.conf
   |--system_tools.conf
|--extension
|--logs
|--build.sh
|--Dockerfile
</code></pre>
<h4 data-id="heading-3">文件内容及说明</h4>
<h5 data-id="heading-4">build.conf</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">PHP Hyperf Docker 构建配置文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">PHP 基础镜像（只能选择一个，其他注释掉）</span>
[base_image]
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.3-cli</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.3-cli-alpine</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.2-cli</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.2-cli-alpine</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.1-cli</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.1-cli-alpine</span>
php:7.4-cli
<span class="hljs-meta prompt_">#</span><span class="bash">php:7.4-cli-alpine</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">格式说明：</span>
<span class="hljs-meta prompt_"># </span><span class="bash">  扩展名           - 安装最新版本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">  扩展名-版本号    - 安装指定版本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">  <span class="hljs-built_in">local</span>:扩展名     - 强制从本地安装</span>
<span class="hljs-meta prompt_"># </span><span class="bash">  pecl:扩展名      - 强制从PECL安装</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[extension]
<span class="hljs-meta prompt_"># </span><span class="bash">核心扩展（docker-php-ext-install）</span>
pcntl
pdo_mysql
bcmath
sockets
<span class="hljs-meta prompt_">
# </span><span class="bash">GD库（自动处理依赖）</span>
gd
<span class="hljs-meta prompt_">
# </span><span class="bash">压缩扩展</span>
zip
<span class="hljs-meta prompt_">
# </span><span class="bash">PECL扩展</span>
redis
swoole-4.8.13
<span class="hljs-meta prompt_">
# </span><span class="bash">可选扩展（按需取消注释）</span>
<span class="hljs-meta prompt_">#</span><span class="bash">mongodb</span>
<span class="hljs-meta prompt_">#</span><span class="bash">xlswriter</span>
<span class="hljs-meta prompt_">#</span><span class="bash">protobuf</span>
<span class="hljs-meta prompt_">#</span><span class="bash">grpc</span>
<span class="hljs-meta prompt_">#</span><span class="bash">imagick</span>
<span class="hljs-meta prompt_">#</span><span class="bash">memcached</span>
<span class="hljs-meta prompt_">#</span><span class="bash">oci8</span>
pdo_oci
<span class="hljs-meta prompt_"># </span><span class="bash">SQL Server php7.4 对应 pdo_sqlsrv-5.10.1</span>
pdo_sqlsrv-5.10.1
<span class="hljs-meta prompt_">#</span><span class="bash">sqlsrv</span>
pdo_pgsql
<span class="hljs-meta prompt_">#</span><span class="bash">pgsql</span>
<span class="hljs-meta prompt_">#</span><span class="bash">amqp</span>
<span class="hljs-meta prompt_">#</span><span class="bash">rdkafka</span>
<span class="hljs-meta prompt_">#</span><span class="bash">igbinary</span>
<span class="hljs-meta prompt_">#</span><span class="bash">msgpack</span>
<span class="hljs-meta prompt_">#</span><span class="bash">yaf</span>
<span class="hljs-meta prompt_">#</span><span class="bash">yar</span>
<span class="hljs-meta prompt_">#</span><span class="bash">apcu</span>
<span class="hljs-meta prompt_">#</span><span class="bash">xdebug</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">构建模式：prod / dev</span>
<span class="hljs-meta prompt_"># </span><span class="bash">prod: 生产模式，优化构建，清理缓存</span>
<span class="hljs-meta prompt_"># </span><span class="bash">dev:  开发模式，保留调试信息</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[mode]
prod
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">项目工作目录</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[workdir]
/opt/www
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">APT/APK 系统镜像源（用于加速系统包下载）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">可选：default / aliyun / ustc / tsinghua / 163</span>
<span class="hljs-meta prompt_"># </span><span class="bash">default: 使用官方源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[system_mirror]
aliyun
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Composer 镜像源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">可选：auto / aliyun / tencent / ustc / packagist / huaweicloud</span>
<span class="hljs-meta prompt_"># </span><span class="bash">auto: 自动检测最快的源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[composer_mirror]
auto
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">PHP 配置（php.ini）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">格式：配置项=值</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[php]
swoole.use_shortname=Off
memory_limit=1G
opcache.enable_cli=On
opcache.jit_buffer_size=128M
date.timezone=Asia/Shanghai
max_execution_time=0
post_max_size=100M
upload_max_filesize=100M
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Docker CMD 命令配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">留空则不设置CMD</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[cmd]
<span class="hljs-meta prompt_">#</span><span class="bash">php /opt/www/bin/hyperf.php start</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">常用系统工具</span>
<span class="hljs-meta prompt_"># </span><span class="bash">支持的工具列表见 config/system_tools.conf</span>
<span class="hljs-meta prompt_"># </span><span class="bash">脚本会自动识别系统类型安装对应的包</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[system_tools]
<span class="hljs-meta prompt_"># </span><span class="bash">网络诊断工具</span>
<span class="hljs-meta prompt_">#</span><span class="bash">curl</span>
wget
telnet
<span class="hljs-meta prompt_">#</span><span class="bash">netcat</span>
<span class="hljs-meta prompt_">#</span><span class="bash">ping</span>
<span class="hljs-meta prompt_">#</span><span class="bash">traceroute</span>
<span class="hljs-meta prompt_">#</span><span class="bash">dig</span>
<span class="hljs-meta prompt_">#</span><span class="bash">nslookup</span>
ss
netstat
lsof
<span class="hljs-meta prompt_">#</span><span class="bash">tcpdump</span>
<span class="hljs-meta prompt_">#</span><span class="bash">iptables</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">编辑器和文本处理</span>
vim
<span class="hljs-meta prompt_">#</span><span class="bash">nano</span>
<span class="hljs-meta prompt_">#</span><span class="bash">less</span>
<span class="hljs-meta prompt_">#</span><span class="bash">jq</span>
<span class="hljs-meta prompt_">#</span><span class="bash">tree</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">系统监控工具</span>
<span class="hljs-meta prompt_">#</span><span class="bash">htop</span>
<span class="hljs-meta prompt_">#</span><span class="bash">top</span>
<span class="hljs-meta prompt_">#</span><span class="bash">ps</span>
<span class="hljs-meta prompt_">#</span><span class="bash">iostat</span>
<span class="hljs-meta prompt_">#</span><span class="bash">vmstat</span>
<span class="hljs-meta prompt_">#</span><span class="bash">strace</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">文件和压缩工具</span>
<span class="hljs-meta prompt_">#</span><span class="bash">tar</span>
<span class="hljs-meta prompt_">#</span><span class="bash">gzip</span>
<span class="hljs-meta prompt_">#</span><span class="bash">unzip</span>
<span class="hljs-meta prompt_">#</span><span class="bash">zip</span>
<span class="hljs-meta prompt_">#</span><span class="bash">file</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">其他实用工具</span>
<span class="hljs-meta prompt_">#</span><span class="bash">git</span>
<span class="hljs-meta prompt_">#</span><span class="bash">procps</span>
<span class="hljs-meta prompt_">#</span><span class="bash">coreutils</span>
<span class="hljs-meta prompt_">#</span><span class="bash">findutils</span>
<span class="hljs-meta prompt_">#</span><span class="bash">grep</span>
<span class="hljs-meta prompt_">#</span><span class="bash">sed</span>
<span class="hljs-meta prompt_">#</span><span class="bash">awk</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">额外的系统包（空格分隔，直接指定包名）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[extra_packages]
<span class="hljs-meta prompt_">

# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">环境变量配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">格式：变量名=值</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[env]
<span class="hljs-meta prompt_">#</span><span class="bash">APP_ENV=dev</span>
<span class="hljs-meta prompt_">#</span><span class="bash">SCAN_CACHEABLE=<span class="hljs-literal">false</span></span>
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">构建参数</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
[build_args]
<span class="hljs-meta prompt_"># </span><span class="bash">启用构建缓存</span>
enable_cache=true
<span class="hljs-meta prompt_"># </span><span class="bash">并行编译数（0为自动检测）</span>
parallel_jobs=0
<span class="hljs-meta prompt_"># </span><span class="bash">内存限制（防止OOM，单位MB，0为不限制）</span>
memory_limit=2048
<span class="hljs-meta prompt_"># </span><span class="bash">清理构建缓存</span>
clean_cache=true
</code></pre>
<h5 data-id="heading-5">extension_deps.conf</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">PHP 扩展依赖配置文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">格式：扩展名|Debian依赖|Alpine依赖</span>
<span class="hljs-meta prompt_"># </span><span class="bash">多个依赖用逗号分隔</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">核心扩展</span>
pcntl||
pdo_mysql||
bcmath||
sockets||
calendar||
exif||
gettext||
shmop||
sysvmsg||
sysvsem||
sysvshm||
<span class="hljs-meta prompt_">
# </span><span class="bash">GD库</span>
gd|libpng-dev,libjpeg-dev,libfreetype6-dev,libwebp-dev,libxpm-dev|libpng-dev,libjpeg-turbo-dev,freetype-dev,libwebp-dev,libxpm-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">压缩相关</span>
zip|libzip-dev|libzip-dev
bz2|libbz2-dev|bzip2-dev
zlib||zlib-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">图像处理</span>
imagick|libmagickwand-dev|imagemagick-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">数据库扩展</span>
pdo_pgsql|libpq-dev|postgresql-dev
pgsql|libpq-dev|postgresql-dev
pdo_sqlite|libsqlite3-dev|sqlite-dev
sqlite3|libsqlite3-dev|sqlite-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">Redis/Memcached</span>
redis||
memcached|libmemcached-dev,zlib1g-dev|libmemcached-dev,zlib-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">消息队列</span>
amqp|librabbitmq-dev|rabbitmq-c-dev
rdkafka|librdkafka-dev|librdkafka-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">其他常用扩展</span>
swoole|libcurl4-openssl-dev,libssl-dev,libc-ares-dev|curl-dev,openssl-dev,c-ares-dev
mongodb|libssl-dev|openssl-dev
xlswriter|zlib1g-dev|zlib-dev
protobuf||
grpc||
igbinary||
msgpack||
apcu||
xdebug||
yaf||
yar|libcurl4-openssl-dev|curl-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">国际化</span>
intl|libicu-dev|icu-dev
iconv||
<span class="hljs-meta prompt_">
# </span><span class="bash">加密</span>
sodium|libsodium-dev|libsodium-dev
mcrypt|libmcrypt-dev|libmcrypt-dev
openssl||
<span class="hljs-meta prompt_">
# </span><span class="bash">XML相关</span>
xml|libxml2-dev|libxml2-dev
dom|libxml2-dev|libxml2-dev
xmlrpc|libxml2-dev|libxml2-dev
xmlreader|libxml2-dev|libxml2-dev
xmlwriter|libxml2-dev|libxml2-dev
xsl|libxslt-dev|libxslt-dev
simplexml|libxml2-dev|libxml2-dev
soap|libxml2-dev|libxml2-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">LDAP</span>
ldap|libldap2-dev|openldap-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">其他</span>
curl|libcurl4-openssl-dev|curl-dev
gmp|libgmp-dev|gmp-dev
imap|libc-client-dev,libkrb5-dev|imap-dev,krb5-dev
snmp|libsnmp-dev|net-snmp-dev
tidy|libtidy-dev|tidyhtml-dev
ftp||
fileinfo||
phar||
posix||
readline|libreadline-dev|readline-dev
tokenizer||
ctype||
filter||
json||
mbstring|libonig-dev|oniguruma-dev
pdo||
reflection||
session||
standard||
opcache||

</code></pre>
<h5 data-id="heading-6">extension_special.conf</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">PHP 扩展特殊配置文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">需要特殊处理的扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">GD 库配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[gd]
<span class="hljs-meta prompt_"># </span><span class="bash">Debian 配置命令</span>
debian_configure=docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp --with-xpm
<span class="hljs-meta prompt_"># </span><span class="bash">Alpine 配置命令</span>
alpine_configure=docker-php-ext-configure gd --with-freetype --with-jpeg --with-webp --with-xpm
<span class="hljs-meta prompt_"># </span><span class="bash">PHP 7.x 兼容配置（不同的参数格式）</span>
php7_debian_configure=docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-webp-dir=/usr/include/ --with-xpm-dir=/usr/include/
php7_alpine_configure=docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-webp-dir=/usr/include/ --with-xpm-dir=/usr/include/
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Oracle 扩展配置 (oci8, pdo_oci)</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[oci8]
<span class="hljs-meta prompt_"># </span><span class="bash">依赖：需要 Oracle Instant Client</span>
<span class="hljs-meta prompt_"># </span><span class="bash">注意：oci8 需要单独安装，不能和其他核心扩展一起批量安装</span>
install_method=separate
pre_install=&lt;&lt;EOF
<span class="hljs-meta prompt_"># </span><span class="bash">下载并安装 Oracle Instant Client</span>
log_info "安装 Oracle Instant Client..."
mkdir -p /opt/oracle
cd /opt/oracle
<span class="hljs-meta prompt_">
# </span><span class="bash">设置 Oracle 版本</span>
ORACLE_VERSION="21_14"
ORACLE_MAJOR="21"
<span class="hljs-meta prompt_">
# </span><span class="bash">Debian</span>
if command -v apt-get &amp;&gt;/dev/null; then
    apt-get update &amp;&amp; apt-get install -y libaio1 libaio-dev unzip wget
    
    # 下载 Oracle Instant Client
    if [ ! -f "instantclient-basic-linux.x64-${ORACLE_MAJOR}.*.zip" ]; then
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-basic-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-basic.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-basic-linuxx64.zip" -O instantclient-basic.zip
    fi
    if [ ! -f "instantclient-sdk-linux.x64-${ORACLE_MAJOR}.*.zip" ]; then
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-sdk-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-sdk.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-sdk-linuxx64.zip" -O instantclient-sdk.zip
    fi
    
    unzip -o instantclient-basic.zip
    unzip -o instantclient-sdk.zip
    rm -f *.zip
    
    # 获取实际安装目录
    INSTANT_CLIENT_DIR=$(ls -d /opt/oracle/instantclient_* 2&gt;/dev/null | head -1)
    if [ -z "$INSTANT_CLIENT_DIR" ]; then
        log_error "Oracle Instant Client 安装失败"
    fi
    
    # 配置链接库
    echo "$INSTANT_CLIENT_DIR" &gt; /etc/ld.so.conf.d/oracle-instantclient.conf
    ldconfig
fi
<span class="hljs-meta prompt_">
# </span><span class="bash">Alpine</span>
if command -v apk &amp;&gt;/dev/null; then
    apk add --no-cache libaio libnsl libc6-compat unzip wget
    
    if [ ! -f "instantclient-basic.zip" ]; then
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-basic-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-basic.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-basic-linuxx64.zip" -O instantclient-basic.zip
    fi
    if [ ! -f "instantclient-sdk.zip" ]; then
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-sdk-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-sdk.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-sdk-linuxx64.zip" -O instantclient-sdk.zip
    fi
    
    unzip -o instantclient-basic.zip
    unzip -o instantclient-sdk.zip
    rm -f *.zip
    
    INSTANT_CLIENT_DIR=$(ls -d /opt/oracle/instantclient_* 2&gt;/dev/null | head -1)
    if [ -z "$INSTANT_CLIENT_DIR" ]; then
        log_error "Oracle Instant Client 安装失败"
    fi
    
    # Alpine 兼容性
    ln -sf /lib/libc.musl-x86_64.so.1 /lib/ld-linux-x86-64.so.2 2&gt;/dev/null || true
fi
<span class="hljs-meta prompt_">
# </span><span class="bash">导出环境变量（写入 profile 以便后续脚本使用）</span>
export ORACLE_HOME="$INSTANT_CLIENT_DIR"
export LD_LIBRARY_PATH="$INSTANT_CLIENT_DIR:$LD_LIBRARY_PATH"
echo "export ORACLE_HOME=$INSTANT_CLIENT_DIR" &gt;&gt; /etc/profile
echo "export LD_LIBRARY_PATH=$INSTANT_CLIENT_DIR:\$LD_LIBRARY_PATH" &gt;&gt; /etc/profile

log_info "Oracle Instant Client 安装完成: $INSTANT_CLIENT_DIR"
<span class="hljs-meta prompt_">
# </span><span class="bash">直接安装 oci8 扩展</span>
log_step "安装 oci8 扩展..."
docker-php-ext-configure oci8 --with-oci8=instantclient,$INSTANT_CLIENT_DIR
docker-php-ext-install -j$(nproc) oci8
log_info "oci8 扩展安装成功"
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">标记为已在 pre_install 中完成安装</span>
skip_install=true

[pdo_oci]
<span class="hljs-meta prompt_"># </span><span class="bash">pdo_oci 需要单独安装</span>
install_method=separate
pre_install=&lt;&lt;EOF
<span class="hljs-meta prompt_"># </span><span class="bash">检查 Oracle Instant Client 是否已安装（如果没有安装 oci8 的话）</span>
INSTANT_CLIENT_DIR=$(ls -d /opt/oracle/instantclient_* 2&gt;/dev/null | head -1)

if [ -z "$INSTANT_CLIENT_DIR" ]; then
    log_info "安装 Oracle Instant Client for pdo_oci..."
    mkdir -p /opt/oracle
    cd /opt/oracle
    
    ORACLE_VERSION="21_14"
    ORACLE_MAJOR="21"
    
    if command -v apt-get &amp;&gt;/dev/null; then
        apt-get update &amp;&amp; apt-get install -y libaio1 libaio-dev unzip wget
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-basic-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-basic.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-basic-linuxx64.zip" -O instantclient-basic.zip
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-sdk-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-sdk.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-sdk-linuxx64.zip" -O instantclient-sdk.zip
        unzip -o instantclient-basic.zip
        unzip -o instantclient-sdk.zip
        rm -f *.zip
        INSTANT_CLIENT_DIR=$(ls -d /opt/oracle/instantclient_* 2&gt;/dev/null | head -1)
        echo "$INSTANT_CLIENT_DIR" &gt; /etc/ld.so.conf.d/oracle-instantclient.conf
        ldconfig
    fi
    
    if command -v apk &amp;&gt;/dev/null; then
        apk add --no-cache libaio libnsl libc6-compat unzip wget
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-basic-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-basic.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-basic-linuxx64.zip" -O instantclient-basic.zip
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/${ORACLE_VERSION}/instantclient-sdk-linux.x64-${ORACLE_MAJOR}.14.0.0.0dbru.zip" -O instantclient-sdk.zip || \
        wget -q "https://download.oracle.com/otn_software/linux/instantclient/instantclient-sdk-linuxx64.zip" -O instantclient-sdk.zip
        unzip -o instantclient-basic.zip
        unzip -o instantclient-sdk.zip
        rm -f *.zip
        INSTANT_CLIENT_DIR=$(ls -d /opt/oracle/instantclient_* 2&gt;/dev/null | head -1)
        ln -sf /lib/libc.musl-x86_64.so.1 /lib/ld-linux-x86-64.so.2 2&gt;/dev/null || true
    fi
    
    echo "export ORACLE_HOME=$INSTANT_CLIENT_DIR" &gt;&gt; /etc/profile
    echo "export LD_LIBRARY_PATH=$INSTANT_CLIENT_DIR:\$LD_LIBRARY_PATH" &gt;&gt; /etc/profile
fi

export ORACLE_HOME="$INSTANT_CLIENT_DIR"
export LD_LIBRARY_PATH="$INSTANT_CLIENT_DIR:$LD_LIBRARY_PATH"

log_info "Oracle Instant Client 路径: $INSTANT_CLIENT_DIR"
<span class="hljs-meta prompt_">
# </span><span class="bash">直接安装 pdo_oci 扩展</span>
log_step "安装 pdo_oci 扩展..."
docker-php-ext-configure pdo_oci --with-pdo-oci=instantclient,$INSTANT_CLIENT_DIR
docker-php-ext-install -j$(nproc) pdo_oci
log_info "pdo_oci 扩展安装成功"
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">标记为已在 pre_install 中完成安装</span>
skip_install=true
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">SQL Server 扩展配置 (sqlsrv, pdo_sqlsrv)</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[sqlsrv]
pre_install=&lt;&lt;EOF
<span class="hljs-meta prompt_"># </span><span class="bash">安装 Microsoft ODBC Driver</span>
if command -v apt-get &amp;&gt;/dev/null; then
    # 安装 gnupg 和 curl
    apt-get update
    apt-get install -y gnupg curl

    curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/microsoft.gpg
    #curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
    curl -fsSL https://packages.microsoft.com/config/debian/$(cat /etc/debian_version | cut -d. -f1)/prod.list &gt; /etc/apt/sources.list.d/mssql-release.list
    apt-get update
    ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev
fi
if command -v apk &amp;&gt;/dev/null; then
    apk add --no-cache unixodbc-dev
    # Alpine 需要从 edge 仓库安装 msodbcsql
    echo "Note: SQL Server driver on Alpine requires manual setup"
fi
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">PECL 安装</span>
install_method=pecl

[pdo_sqlsrv]
pre_install=&lt;&lt;EOF
<span class="hljs-meta prompt_"># </span><span class="bash">复用 sqlsrv 的 ODBC 驱动安装</span>
if ! command -v sqlcmd &amp;&gt;/dev/null; then
    if command -v apt-get &amp;&gt;/dev/null; then
        # 安装 gnupg 和 curl
        apt-get update
        apt-get install -y gnupg curl

        curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/microsoft.gpg
        #curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
        curl -fsSL https://packages.microsoft.com/config/debian/$(cat /etc/debian_version | cut -d. -f1)/prod.list &gt; /etc/apt/sources.list.d/mssql-release.list
        apt-get update
        ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev
    fi
    if command -v apk &amp;&gt;/dev/null; then
        apk add --no-cache unixodbc-dev
    fi
fi
EOF
install_method=pecl
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">PostgreSQL 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[pdo_pgsql]
<span class="hljs-meta prompt_"># </span><span class="bash">Debian 额外配置</span>
debian_extra=ln -sf /usr/include/postgresql /usr/include/pgsql

[pgsql]
debian_extra=ln -sf /usr/include/postgresql /usr/include/pgsql
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">IMAP 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[imap]
debian_configure=docker-php-ext-configure imap --with-kerberos --with-imap-ssl
alpine_configure=docker-php-ext-configure imap --with-kerberos --with-imap-ssl
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">LDAP 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[ldap]
debian_extra=ln -sf /usr/lib/x86_64-linux-gnu/libldap.so /usr/lib/libldap.so &amp;&amp; ln -sf /usr/lib/x86_64-linux-gnu/liblber.so /usr/lib/liblber.so
debian_configure=docker-php-ext-configure ldap --with-libdir=lib/x86_64-linux-gnu
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Swoole 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[swoole]
<span class="hljs-meta prompt_"># </span><span class="bash">Swoole 编译参数</span>
pecl_configure=--enable-openssl --enable-sockets --enable-mysqlnd --enable-swoole-curl --enable-cares
<span class="hljs-meta prompt_"># </span><span class="bash">PHP 7.x 兼容配置</span>
php7_pecl_configure=--enable-openssl --enable-sockets --enable-mysqlnd --enable-http2
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">GrPC 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[grpc]
<span class="hljs-meta prompt_"># </span><span class="bash">grpc 需要大量内存编译</span>
build_memory=4096
<span class="hljs-meta prompt_"># </span><span class="bash">编译超时时间（秒）</span>
build_timeout=3600
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">xlswriter 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[xlswriter]
pecl_configure=--enable-reader
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">imagick 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[imagick]
<span class="hljs-meta prompt_"># </span><span class="bash">需要 ImageMagick 开发库</span>
post_install=&lt;&lt;EOF
<span class="hljs-meta prompt_"># </span><span class="bash">确保 ImageMagick 策略允许 PDF 处理</span>
if [ -f /etc/ImageMagick-6/policy.xml ]; then
    sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
fi
if [ -f /etc/ImageMagick-7/policy.xml ]; then
    sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-7/policy.xml
fi
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">memcached 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[memcached]
pecl_configure=--enable-memcached-igbinary --enable-memcached-json --enable-memcached-session --enable-memcached-sasl
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">xdebug 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[xdebug]
<span class="hljs-meta prompt_"># </span><span class="bash">仅在 dev 模式安装</span>
mode_only=dev
<span class="hljs-meta prompt_"># </span><span class="bash">xdebug 3.x 配置</span>
php_ini_config=&lt;&lt;EOF
xdebug.mode=develop,debug
xdebug.start_with_request=yes
xdebug.client_host=host.docker.internal
xdebug.client_port=9003
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">----------------------------------------</span>
<span class="hljs-meta prompt_"># </span><span class="bash">opcache 扩展配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">----------------------------------------</span>
[opcache]
php_ini_config=&lt;&lt;EOF
opcache.enable=1
opcache.enable_cli=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=100000
opcache.validate_timestamps=0
opcache.save_comments=1
opcache.fast_shutdown=1
EOF
<span class="hljs-meta prompt_"># </span><span class="bash">生产模式特殊配置</span>
prod_php_ini_config=&lt;&lt;EOF
opcache.enable=1
opcache.enable_cli=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=100000
opcache.validate_timestamps=0
opcache.save_comments=1
opcache.fast_shutdown=1
opcache.jit_buffer_size=256M
opcache.jit=1255
EOF

</code></pre>
<h5 data-id="heading-7">system_tools.conf</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">系统工具映射配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">格式: 工具名|debian包名|alpine包名|说明</span>
<span class="hljs-meta prompt_"># </span><span class="bash">如果包名为 - 表示该系统不支持或不需要安装</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">网络诊断工具</span>
curl|curl|curl|命令行URL工具
wget|wget|wget|文件下载工具
telnet|telnet|busybox-extras|远程登录协议客户端
netcat|netcat-openbsd|netcat-openbsd|网络连接工具
nc|netcat-openbsd|netcat-openbsd|netcat别名
ping|iputils-ping|iputils|网络连通性测试
traceroute|traceroute|traceroute|路由追踪
tracepath|iputils-tracepath|iputils|路径MTU发现
dig|dnsutils|bind-tools|DNS查询工具
nslookup|dnsutils|bind-tools|DNS查询工具
host|dnsutils|bind-tools|DNS查询工具
ss|iproute2|iproute2|套接字统计工具
netstat|net-tools|net-tools|网络统计工具（旧版）
ip|iproute2|iproute2|IP配置工具
ifconfig|net-tools|net-tools|网络接口配置（旧版）
lsof|lsof|lsof|列出打开的文件
tcpdump|tcpdump|tcpdump|网络抓包工具
iptables|iptables|iptables|防火墙规则管理
nmap|nmap|nmap|网络扫描工具
mtr|mtr|mtr|网络诊断工具
<span class="hljs-meta prompt_">
# </span><span class="bash">编辑器和文本处理</span>
vim|vim|vim|Vi改进版编辑器
vi|vim|vim|vim别名
nano|nano|nano|简易文本编辑器
less|less|less|分页查看器
more|util-linux|util-linux|分页查看器
cat|coreutils|coreutils|文件查看
head|coreutils|coreutils|查看文件头部
tail|coreutils|coreutils|查看文件尾部
jq|jq|jq|JSON处理工具
yq|yq|yq|YAML处理工具
tree|tree|tree|目录树显示
diff|diffutils|diffutils|文件比较
<span class="hljs-meta prompt_">
# </span><span class="bash">系统监控工具</span>
htop|htop|htop|交互式进程查看器
top|procps|procps|进程监控
ps|procps|procps|进程状态
free|procps|procps|内存使用情况
uptime|procps|procps|系统运行时间
watch|procps|procps|周期性执行命令
pstree|psmisc|psmisc|进程树显示
killall|psmisc|psmisc|按名称终止进程
fuser|psmisc|psmisc|显示文件使用者
iostat|sysstat|sysstat|IO统计
vmstat|procps|procps|虚拟内存统计
sar|sysstat|sysstat|系统活动报告
mpstat|sysstat|sysstat|CPU统计
pidstat|sysstat|sysstat|进程统计
strace|strace|strace|系统调用追踪
ltrace|ltrace|-|库调用追踪
dstat|dstat|-|资源统计工具
iotop|iotop|iotop|IO监控
iftop|iftop|iftop|网络带宽监控
nload|nload|nload|网络流量监控
<span class="hljs-meta prompt_">
# </span><span class="bash">文件和压缩工具</span>
tar|tar|tar|归档工具
gzip|gzip|gzip|gzip压缩
gunzip|gzip|gzip|gzip解压
bzip2|bzip2|bzip2|bzip2压缩
bunzip2|bzip2|bzip2|bzip2解压
xz|xz-utils|xz|xz压缩
unxz|xz-utils|xz|xz解压
zip|zip|zip|zip压缩
unzip|unzip|unzip|zip解压
7z|p7zip-full|p7zip|7zip压缩
rar|unrar|-|RAR解压
file|file|file|文件类型识别
stat|coreutils|coreutils|文件状态
du|coreutils|coreutils|磁盘使用统计
df|coreutils|coreutils|磁盘空间统计
ln|coreutils|coreutils|链接创建
cp|coreutils|coreutils|文件复制
mv|coreutils|coreutils|文件移动
rm|coreutils|coreutils|文件删除
mkdir|coreutils|coreutils|创建目录
rmdir|coreutils|coreutils|删除目录
chmod|coreutils|coreutils|权限修改
chown|coreutils|coreutils|所有者修改
touch|coreutils|coreutils|修改时间戳
<span class="hljs-meta prompt_">
# </span><span class="bash">查找和搜索工具</span>
find|findutils|findutils|文件查找
locate|mlocate|mlocate|快速文件定位
which|debianutils|which|命令路径查找
whereis|util-linux|util-linux|命令位置查找
grep|grep|grep|文本搜索
egrep|grep|grep|扩展正则搜索
fgrep|grep|grep|固定字符串搜索
ack|ack|ack|代码搜索工具
ag|silversearcher-ag|the_silver_searcher|快速代码搜索
rg|ripgrep|-|更快的代码搜索
<span class="hljs-meta prompt_">
# </span><span class="bash">文本处理</span>
sed|sed|sed|流编辑器
awk|gawk|gawk|文本处理语言
gawk|gawk|gawk|GNU AWK
cut|coreutils|coreutils|文本切割
sort|coreutils|coreutils|排序
uniq|coreutils|coreutils|去重
wc|coreutils|coreutils|字数统计
tr|coreutils|coreutils|字符转换
tee|coreutils|coreutils|输出分流
xargs|findutils|findutils|参数传递
column|bsdmainutils|util-linux|列格式化
<span class="hljs-meta prompt_">
# </span><span class="bash">版本控制</span>
git|git|git|Git版本控制
svn|subversion|subversion|SVN版本控制
<span class="hljs-meta prompt_">
# </span><span class="bash">系统管理</span>
sudo|sudo|sudo|权限提升
su|login|shadow|用户切换
useradd|passwd|shadow|添加用户
usermod|passwd|shadow|修改用户
userdel|passwd|shadow|删除用户
groupadd|passwd|shadow|添加组
passwd|passwd|passwd|修改密码
crontab|cron|busybox|定时任务
systemctl|systemd|-|服务管理（Debian）
service|sysvinit-utils|openrc|服务管理
rc-service|-|openrc|服务管理（Alpine）
<span class="hljs-meta prompt_">
# </span><span class="bash">开发工具</span>
make|make|make|构建工具
gcc|gcc|gcc|C编译器
g++|g++|g++|C++编译器
python|python3|python3|Python解释器
python3|python3|python3|Python3解释器
pip|python3-pip|py3-pip|Python包管理
node|nodejs|nodejs|Node.js
npm|npm|npm|Node包管理
perl|perl|perl|Perl解释器
<span class="hljs-meta prompt_">
# </span><span class="bash">数据库客户端</span>
mysql|mariadb-client|mariadb-client|MySQL客户端
psql|postgresql-client|postgresql-client|PostgreSQL客户端
redis-cli|redis-tools|redis|Redis客户端
mongo|mongodb-clients|-|MongoDB客户端
sqlite3|sqlite3|sqlite|SQLite客户端
<span class="hljs-meta prompt_">
# </span><span class="bash">其他实用工具</span>
procps|procps|procps|进程工具集
coreutils|coreutils|coreutils|核心工具集
util-linux|util-linux|util-linux|系统工具集
ca-certificates|ca-certificates|ca-certificates|CA证书
openssl|openssl|openssl|SSL工具
tzdata|tzdata|tzdata|时区数据
locales|locales|-|语言环境（仅Debian）
bash|bash|bash|Bash shell
zsh|zsh|zsh|Zsh shell
tmux|tmux|tmux|终端复用器
screen|screen|screen|终端复用器
rsync|rsync|rsync|文件同步
sshpass|sshpass|sshpass|SSH密码工具
expect|expect|expect|自动化交互工具
bc|bc|bc|计算器
xxd|xxd|vim|十六进制查看
hexdump|bsdmainutils|util-linux|十六进制转储
base64|coreutils|coreutils|Base64编解码
md5sum|coreutils|coreutils|MD5校验
sha256sum|coreutils|coreutils|SHA256校验

</code></pre>
<h5 data-id="heading-8">build.sh</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">PHP Hyperf Docker 构建脚本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">用法: ./build.sh 镜像名称:标签</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>

set -e
set -o pipefail  # 确保管道中任何一步失败，整个命令都返回错误
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">全局变量</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &amp;&amp; pwd)"
CONFIG_DIR="${SCRIPT_DIR}/config"
BUILD_SCRIPTS_DIR="${SCRIPT_DIR}/build_scripts"
EXTENSION_DIR="${SCRIPT_DIR}/extension"
LOGS_DIR="${SCRIPT_DIR}/logs"
LOG_FILE="${LOGS_DIR}/build_$(date +%Y%m%d_%H%M%S).log"
<span class="hljs-meta prompt_">
# </span><span class="bash">配置文件</span>
BUILD_CONF="${CONFIG_DIR}/build.conf"
EXTENSION_DEPS_CONF="${CONFIG_DIR}/extension_deps.conf"
EXTENSION_SPECIAL_CONF="${CONFIG_DIR}/extension_special.conf"
<span class="hljs-meta prompt_">
# </span><span class="bash">默认值</span>
DEFAULT_WORKDIR="/opt/www"
DEFAULT_MODE="prod"
DEFAULT_COMPOSER_MIRROR="auto"
<span class="hljs-meta prompt_">
# </span><span class="bash">Bash 版本检查</span>
BASH_VERSION_MAJOR="${BASH_VERSION%%.*}"
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">颜色定义</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color
BOLD='\033[1m'
BLINK='\033[5m'
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">日志函数</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
log_info() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1"
    echo -e "${GREEN}${msg}${NC}"
    echo "$msg" &gt;&gt; "$LOG_FILE"
}

log_warn() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] $1"
    echo -e "${YELLOW}${msg}${NC}"
    echo "$msg" &gt;&gt; "$LOG_FILE"
}

log_error() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1"
    echo -e "${RED}${BOLD}${msg}${NC}"
    echo "$msg" &gt;&gt; "$LOG_FILE"
}

log_success() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] [SUCCESS] $1"
    echo -e "${GREEN}${BOLD}${msg}${NC}"
    echo "$msg" &gt;&gt; "$LOG_FILE"
}

log_step() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] [STEP] $1"
    echo -e "${CYAN}${BOLD}══════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}${BOLD}  $1${NC}"
    echo -e "${CYAN}${BOLD}══════════════════════════════════════════════════════════${NC}"
    echo "$msg" &gt;&gt; "$LOG_FILE"
}

log_debug() {
    if [ "$DEBUG" = "true" ]; then
        local msg="[$(date '+%Y-%m-%d %H:%M:%S')] [DEBUG] $1"
        echo -e "${MAGENTA}${msg}${NC}"
        echo "$msg" &gt;&gt; "$LOG_FILE"
    fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">进度显示函数</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
SPINNER_PID=""

start_spinner() {
    local msg="$1"
    local delay=0.1
    local spinstr='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    
    (
        while true; do
            for (( i=0; i&lt;${#spinstr}; i++ )); do
                echo -ne "\r${CYAN}${BLINK}${spinstr:$i:1}${NC} ${msg}   "
                sleep $delay
            done
        done
    ) &amp;
    SPINNER_PID=$!
    disown
}

stop_spinner() {
    local status="$1"
    if [ -n "$SPINNER_PID" ]; then
        kill $SPINNER_PID 2&gt;/dev/null || true
        wait $SPINNER_PID 2&gt;/dev/null || true
        SPINNER_PID=""
    fi
    
    if [ "$status" = "success" ]; then
        echo -e "\r${GREEN}✔${NC} $2                    "
    elif [ "$status" = "fail" ]; then
        echo -e "\r${RED}✘${NC} $2                    "
    else
        echo -e "\r  $2                    "
    fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">进度条</span>
show_progress() {
    local current=$1
    local total=$2
    local msg="$3"
    local width=50
    local percent=$((current * 100 / total))
    local filled=$((current * width / total))
    local empty=$((width - filled))
    
    printf "\r${CYAN}[${NC}"
    printf "%${filled}s" | tr ' ' '█'
    printf "%${empty}s" | tr ' ' '░'
    printf "${CYAN}]${NC} ${percent}%% ${msg}"
    
    if [ "$current" -eq "$total" ]; then
        echo ""
    fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">配置解析函数</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
declare -A CONFIG
declare -a EXTENSIONS
declare -a SYSTEM_TOOLS
declare -A PHP_CONFIG
declare -A ENV_VARS
declare -A BUILD_ARGS
declare -A TOOLS_DEBIAN
declare -A TOOLS_ALPINE

parse_config() {
    log_step "解析配置文件"
    
    if [ ! -f "$BUILD_CONF" ]; then
        log_error "配置文件不存在: $BUILD_CONF"
        exit 1
    fi
    
    start_spinner "正在解析 build.conf..."
    
    local current_section=""
    local line_num=0
    
    while IFS= read -r line || [ -n "$line" ]; do
        line_num=$((line_num + 1))
        
        # 去除首尾空白
        line="$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
        
        # 跳过空行和注释
        if [ -z "$line" ] || [[ "$line" =~ ^# ]]; then
            continue
        fi
        
        # 检测段落
        if [[ "$line" =~ ^\[([a-zA-Z_]+)\]$ ]]; then
            current_section="${BASH_REMATCH[1]}"
            log_debug "进入段落: $current_section"
            continue
        fi
        
        # 根据段落解析内容
        case "$current_section" in
            base_image)
                if [[ ! "$line" =~ ^# ]]; then
                    CONFIG["base_image"]="$line"
                    log_debug "基础镜像: $line"
                fi
                ;;
            extension)
                EXTENSIONS+=("$line")
                log_debug "扩展: $line"
                ;;
            mode)
                CONFIG["mode"]="$line"
                ;;
            workdir)
                CONFIG["workdir"]="$line"
                ;;
            composer_mirror)
                CONFIG["composer_mirror"]="$line"
                ;;
            system_mirror)
                CONFIG["system_mirror"]="$line"
                ;;
            php)
                if [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
                    local key="${BASH_REMATCH[1]}"
                    local value="${BASH_REMATCH[2]}"
                    PHP_CONFIG["$key"]="$value"
                fi
                ;;
            cmd)
                CONFIG["cmd"]="$line"
                ;;
            system_tools)
                SYSTEM_TOOLS+=("$line")
                log_debug "系统工具: $line"
                ;;
            extra_packages)
                if [ -n "$line" ]; then
                    CONFIG["extra_packages"]="${CONFIG["extra_packages"]} $line"
                fi
                ;;
            env)
                if [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
                    ENV_VARS["${BASH_REMATCH[1]}"]="${BASH_REMATCH[2]}"
                fi
                ;;
            build_args)
                if [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
                    BUILD_ARGS["${BASH_REMATCH[1]}"]="${BASH_REMATCH[2]}"
                fi
                ;;
        esac
    done &lt; "$BUILD_CONF"
    
    # 设置默认值
    CONFIG["base_image"]="${CONFIG["base_image"]:-php:8.2-cli}"
    CONFIG["mode"]="${CONFIG["mode"]:-$DEFAULT_MODE}"
    CONFIG["workdir"]="${CONFIG["workdir"]:-$DEFAULT_WORKDIR}"
    CONFIG["composer_mirror"]="${CONFIG["composer_mirror"]:-$DEFAULT_COMPOSER_MIRROR}"
    CONFIG["system_mirror"]="${CONFIG["system_mirror"]:-default}"
    
    stop_spinner "success" "配置解析完成"
    
    # 显示解析结果
    log_info "基础镜像: ${CONFIG["base_image"]}"
    log_info "构建模式: ${CONFIG["mode"]}"
    log_info "工作目录: ${CONFIG["workdir"]}"
    log_info "系统镜像源: ${CONFIG["system_mirror"]}"
    log_info "Composer源: ${CONFIG["composer_mirror"]}"
    log_info "扩展数量: ${#EXTENSIONS[@]}"
    log_info "系统工具数量: ${#SYSTEM_TOOLS[@]}"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">检测镜像类型</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
detect_image_type() {
    local image="${CONFIG["base_image"]}"
    
    if [[ "$image" =~ alpine ]]; then
        CONFIG["os_type"]="alpine"
        CONFIG["pkg_manager"]="apk"
    else
        CONFIG["os_type"]="debian"
        CONFIG["pkg_manager"]="apt-get"
    fi
    
    # 提取 PHP 版本
    if [[ "$image" =~ php:([0-9]+\.[0-9]+) ]]; then
        CONFIG["php_version"]="${BASH_REMATCH[1]}"
        CONFIG["php_major"]="${CONFIG["php_version"]%%.*}"
    else
        CONFIG["php_version"]="8.2"
        CONFIG["php_major"]="8"
    fi
    
    log_info "操作系统类型: ${CONFIG["os_type"]}"
    log_info "PHP 版本: ${CONFIG["php_version"]}"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">扩展依赖解析</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
declare -A EXT_DEPS_DEBIAN
declare -A EXT_DEPS_ALPINE

parse_extension_deps() {
    log_step "解析扩展依赖配置"
    
    if [ ! -f "$EXTENSION_DEPS_CONF" ]; then
        log_warn "扩展依赖配置文件不存在: $EXTENSION_DEPS_CONF"
        return
    fi
    
    while IFS='|' read -r ext debian alpine; do
        # 跳过注释和空行
        [[ "$ext" =~ ^# ]] &amp;&amp; continue
        [ -z "$ext" ] &amp;&amp; continue
        
        ext="$(echo "$ext" | tr -d '[:space:]')"
        EXT_DEPS_DEBIAN["$ext"]="$debian"
        EXT_DEPS_ALPINE["$ext"]="$alpine"
    done &lt; "$EXTENSION_DEPS_CONF"
    
    log_info "已加载 ${#EXT_DEPS_DEBIAN[@]} 个扩展依赖配置"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">扩展特殊配置解析</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
declare -A EXT_SPECIAL

parse_extension_special() {
    log_step "解析扩展特殊配置"
    
    if [ ! -f "$EXTENSION_SPECIAL_CONF" ]; then
        log_warn "扩展特殊配置文件不存在: $EXTENSION_SPECIAL_CONF"
        return
    fi
    
    local current_ext=""
    local current_key=""
    local in_heredoc=false
    local heredoc_content=""
    
    while IFS= read -r line || [ -n "$line" ]; do
        # 检测扩展段落
        if [[ "$line" =~ ^\[([a-zA-Z0-9_]+)\]$ ]]; then
            current_ext="${BASH_REMATCH[1]}"
            continue
        fi
        
        # 跳过注释和空行
        [[ "$line" =~ ^[[:space:]]*# ]] &amp;&amp; continue
        
        if [ -n "$current_ext" ]; then
            # 处理 heredoc
            if [ "$in_heredoc" = true ]; then
                if [[ "$line" =~ ^EOF$ ]]; then
                    EXT_SPECIAL["${current_ext}_${current_key}"]="$heredoc_content"
                    in_heredoc=false
                    heredoc_content=""
                else
                    heredoc_content="${heredoc_content}${line}\n"
                fi
                continue
            fi
            
            # 检测 heredoc 开始
            if [[ "$line" =~ ^([a-zA-Z_]+)=\&lt;\&lt;EOF$ ]]; then
                current_key="${BASH_REMATCH[1]}"
                in_heredoc=true
                heredoc_content=""
                continue
            fi
            
            # 普通键值对
            if [[ "$line" =~ ^([a-zA-Z_]+)=(.+)$ ]]; then
                local key="${BASH_REMATCH[1]}"
                local value="${BASH_REMATCH[2]}"
                EXT_SPECIAL["${current_ext}_${key}"]="$value"
            fi
        fi
    done &lt; "$EXTENSION_SPECIAL_CONF"
    
    log_info "已加载扩展特殊配置"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">解析系统工具配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
resolve_system_tools() {
    log_step "解析系统工具映射"

    local tools_conf="${CONFIG_DIR}/system_tools.conf"
    if [ ! -f "$tools_conf" ]; then
        log_warn "系统工具映射文件不存在: $tools_conf"
        return
    fi

    local os_type="${CONFIG["os_type"]}"
    local tool_packages=""

    # 读取配置文件建立映射
    declare -A TOOLS_MAP
    while IFS='|' read -r tool debian alpine desc; do
        [[ "$tool" =~ ^# ]] &amp;&amp; continue
        [ -z "$tool" ] &amp;&amp; continue

        tool="$(echo "$tool" | tr -d '[:space:]')"

        if [ "$os_type" = "alpine" ]; then
            TOOLS_MAP["$tool"]="$(echo "$alpine" | tr -d '[:space:]')"
        else
            TOOLS_MAP["$tool"]="$(echo "$debian" | tr -d '[:space:]')"
        fi
    done &lt; "$tools_conf"

    # 匹配选中的工具
    for tool in "${SYSTEM_TOOLS[@]}"; do
        # 去除注释
        [[ "$tool" =~ ^# ]] &amp;&amp; continue

        local pkg_name="${TOOLS_MAP[$tool]}"

        if [ -n "$pkg_name" ] &amp;&amp; [ "$pkg_name" != "-" ]; then
            tool_packages="$tool_packages $pkg_name"
            log_debug "映射工具: $tool -&gt; $pkg_name"
        else
            log_warn "未找到工具 $tool 的对应包名或该系统不支持"
        fi
    done

    # 将结果保存到全局配置中，供后续使用
    CONFIG["resolved_tools"]="$tool_packages"
    log_info "已解析系统工具包: $tool_packages"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">检查本地扩展</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
declare -A LOCAL_EXTENSIONS

check_local_extensions() {
    log_step "检查本地扩展目录"
    
    if [ ! -d "$EXTENSION_DIR" ]; then
        log_info "本地扩展目录不存在，跳过本地扩展检查"
        return
    fi
    
    local ext_count=0
    
    shopt -s nullglob
    local ext_files=("$EXTENSION_DIR"/*.tgz "$EXTENSION_DIR"/*.tar.gz "$EXTENSION_DIR"/*.zip)
    shopt -u nullglob
    
    for ext_file in "${ext_files[@]}"; do
        [ -f "$ext_file" ] || continue
        
        local filename=$(basename "$ext_file")
        local ext_name=""
        local ext_version=""
        
        # 解析扩展名和版本
        if [[ "$filename" =~ ^([a-zA-Z_]+)-([0-9.]+)\.(tgz|tar\.gz|zip)$ ]]; then
            ext_name="${BASH_REMATCH[1]}"
            ext_version="${BASH_REMATCH[2]}"
        elif [[ "$filename" =~ ^([a-zA-Z_]+)\.(tgz|tar\.gz|zip)$ ]]; then
            ext_name="${BASH_REMATCH[1]}"
            ext_version="latest"
        fi
        
        if [ -n "$ext_name" ]; then
            # 检查是否已存在该扩展的记录
            if [ -n "${LOCAL_EXTENSIONS[$ext_name]}" ]; then
                # 比较版本，保留更高版本
                local existing_version="${LOCAL_EXTENSIONS[$ext_name]%%|*}"
                if version_compare "$ext_version" "$existing_version"; then
                    LOCAL_EXTENSIONS["$ext_name"]="${ext_version}|${ext_file}"
                    log_debug "更新本地扩展: $ext_name 版本 $existing_version -&gt; $ext_version"
                fi
            else
                LOCAL_EXTENSIONS["$ext_name"]="${ext_version}|${ext_file}"
                log_debug "发现本地扩展: $ext_name 版本 $ext_version"
            fi
            ext_count=$((ext_count + 1))
        fi
    done
    
    log_info "发现 ${#LOCAL_EXTENSIONS[@]} 个本地扩展"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">版本比较函数</span>
version_compare() {
    local v1="$1"
    local v2="$2"
    
    [ "$v1" = "latest" ] &amp;&amp; return 0
    [ "$v2" = "latest" ] &amp;&amp; return 1
    
    if [ "$(printf '%s\n' "$v1" "$v2" | sort -V | tail -n1)" = "$v1" ]; then
        return 0
    else
        return 1
    fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">判断扩展类型</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">核心扩展列表（使用 docker-php-ext-install）</span>
CORE_EXTENSIONS=(
    "bcmath" "bz2" "calendar" "ctype" "curl" "dba" "dom" "enchant"
    "exif" "fileinfo" "filter" "ftp" "gd" "gettext" "gmp" "hash"
    "iconv" "imap" "intl" "json" "ldap" "mbstring" "mysqli" "oci8"
    "odbc" "opcache" "pcntl" "pdo" "pdo_dblib" "pdo_firebird" "pdo_mysql"
    "pdo_oci" "pdo_odbc" "pdo_pgsql" "pdo_sqlite" "pgsql" "phar" "posix"
    "pspell" "readline" "reflection" "session" "shmop" "simplexml"
    "snmp" "soap" "sockets" "sodium" "spl" "standard" "sysvmsg"
    "sysvsem" "sysvshm" "tidy" "tokenizer" "xml" "xmlreader" "xmlrpc"
    "xmlwriter" "xsl" "zip" "zlib"
)

is_core_extension() {
    local ext="$1"
    for core_ext in "${CORE_EXTENSIONS[@]}"; do
        [ "$ext" = "$core_ext" ] &amp;&amp; return 0
    done
    return 1
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成安装脚本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_install_scripts() {
    log_step "生成安装脚本"
    
    # 创建脚本目录
    mkdir -p "$BUILD_SCRIPTS_DIR"
    
    local os_type="${CONFIG["os_type"]}"
    local php_major="${CONFIG["php_major"]}"
    local total_ext=${#EXTENSIONS[@]}
    local current_ext=0

    # 解析系统工具
    resolve_system_tools
    
    # 收集所有依赖
    local all_deps=""
    local install_core=""
    local install_pecl=""
    local install_local=""
    local configure_cmds=""
    local pre_install_cmds=""
    local post_install_cmds=""
    
    for ext_entry in "${EXTENSIONS[@]}"; do
        current_ext=$((current_ext + 1))
        show_progress $current_ext $total_ext "处理扩展: $ext_entry"
        
        # 解析扩展名和版本
        local ext_name=""
        local ext_version=""
        local force_local=false
        local force_pecl=false
        
        # 检查强制标记
        if [[ "$ext_entry" =~ ^local:(.+)$ ]]; then
            ext_entry="${BASH_REMATCH[1]}"
            force_local=true
        elif [[ "$ext_entry" =~ ^pecl:(.+)$ ]]; then
            ext_entry="${BASH_REMATCH[1]}"
            force_pecl=true
        fi
        
        # 解析版本号
        if [[ "$ext_entry" =~ ^([a-zA-Z_]+)-([0-9.]+)$ ]]; then
            ext_name="${BASH_REMATCH[1]}"
            ext_version="${BASH_REMATCH[2]}"
        else
            ext_name="$ext_entry"
            ext_version=""
        fi
        
        # 检查是否仅限特定模式
        local mode_only="${EXT_SPECIAL["${ext_name}_mode_only"]}"
        if [ -n "$mode_only" ] &amp;&amp; [ "$mode_only" != "${CONFIG["mode"]}" ]; then
            log_debug "跳过扩展 $ext_name (仅限 $mode_only 模式)"
            continue
        fi
        
        # 获取依赖
        local deps=""
        if [ "$os_type" = "alpine" ]; then
            deps="${EXT_DEPS_ALPINE[$ext_name]}"
        else
            deps="${EXT_DEPS_DEBIAN[$ext_name]}"
        fi
        
        if [ -n "$deps" ]; then
            all_deps="$all_deps $deps"
        fi
        
        # 检查预安装命令
        local pre_install="${EXT_SPECIAL["${ext_name}_pre_install"]}"
        if [ -n "$pre_install" ]; then
            pre_install_cmds="${pre_install_cmds}\n# Pre-install for $ext_name\n$(echo -e "$pre_install")"
        fi
        
        # 检查额外配置
        local extra_cmd=""
        if [ "$os_type" = "debian" ]; then
            extra_cmd="${EXT_SPECIAL["${ext_name}_debian_extra"]}"
        fi
        if [ -n "$extra_cmd" ]; then
            pre_install_cmds="${pre_install_cmds}\n$extra_cmd"
        fi
        
        # 确定安装方式
        local install_method="${EXT_SPECIAL["${ext_name}_install_method"]}"
        
        # 检查是否跳过安装（已在 pre_install 中完成）
        local skip_install="${EXT_SPECIAL["${ext_name}_skip_install"]}"
        if [ "$skip_install" = "true" ]; then
            log_debug "扩展 $ext_name 将在 pre_install 脚本中安装"
            continue
        fi
        
        # 检查本地扩展
        if [ "$force_local" = true ] || [ -n "${LOCAL_EXTENSIONS[$ext_name]}" ]; then
            local local_info="${LOCAL_EXTENSIONS[$ext_name]}"
            if [ -n "$local_info" ]; then
                local local_file="${local_info#*|}"
                install_local="${install_local}\n# Install $ext_name from local\ninstall_local_extension \"$ext_name\" \"$local_file\""
                continue
            fi
        fi
        
        # 检查是否为核心扩展
        if is_core_extension "$ext_name" &amp;&amp; [ "$force_pecl" != true ] &amp;&amp; [ "$install_method" != "pecl" ]; then
            # 检查配置命令
            local configure_cmd=""
            if [ "$php_major" -lt 8 ]; then
                configure_cmd="${EXT_SPECIAL["${ext_name}_php7_${os_type}_configure"]}"
            fi
            if [ -z "$configure_cmd" ]; then
                configure_cmd="${EXT_SPECIAL["${ext_name}_${os_type}_configure"]}"
            fi
            
            if [ -n "$configure_cmd" ]; then
                configure_cmds="${configure_cmds}\n$configure_cmd"
            fi
            
            install_core="${install_core} $ext_name"
        else
            # PECL 安装
            local pecl_name="$ext_name"
            if [ -n "$ext_version" ]; then
                pecl_name="${ext_name}-${ext_version}"
            fi
            
            # 检查 PECL 配置参数
            local pecl_configure=""
            if [ "$php_major" -lt 8 ]; then
                pecl_configure="${EXT_SPECIAL["${ext_name}_php7_pecl_configure"]}"
            fi
            if [ -z "$pecl_configure" ]; then
                pecl_configure="${EXT_SPECIAL["${ext_name}_pecl_configure"]}"
            fi
            
            if [ -n "$pecl_configure" ]; then
                install_pecl="${install_pecl}\ninstall_pecl_extension \"$pecl_name\" \"$pecl_configure\""
            else
                install_pecl="${install_pecl}\ninstall_pecl_extension \"$pecl_name\" \"\""
            fi
        fi
        
        # 检查后置安装命令
        local post_install="${EXT_SPECIAL["${ext_name}_post_install"]}"
        if [ -n "$post_install" ]; then
            post_install_cmds="${post_install_cmds}\n# Post-install for $ext_name\n$(echo -e "$post_install")"
        fi
        
        # 检查 PHP 配置
        local php_ini_config=""
        if [ "${CONFIG["mode"]}" = "prod" ]; then
            php_ini_config="${EXT_SPECIAL["${ext_name}_prod_php_ini_config"]}"
        fi
        if [ -z "$php_ini_config" ]; then
            php_ini_config="${EXT_SPECIAL["${ext_name}_php_ini_config"]}"
        fi
        if [ -n "$php_ini_config" ]; then
            # 添加到 PHP 配置
            while IFS= read -r ini_line; do
                [ -z "$ini_line" ] &amp;&amp; continue
                if [[ "$ini_line" =~ ^([^=]+)=(.*)$ ]]; then
                    PHP_CONFIG["${BASH_REMATCH[1]}"]="${BASH_REMATCH[2]}"
                fi
            done &lt;&lt;&lt; "$(echo -e "$php_ini_config")"
        fi
    done
    
    # 去重依赖
    all_deps=$(echo "$all_deps" | tr ',' ' ' | tr ' ' '\n' | sort -u | tr '\n' ' ')
    
<span class="hljs-meta prompt_"># </span><span class="bash">   log_info <span class="hljs-string">"生成依赖安装脚本..."</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">   generate_deps_script <span class="hljs-string">"<span class="hljs-variable">$all_deps</span>"</span></span>
    # 合并扩展依赖和系统工具包
    local final_deps="${all_deps} ${CONFIG["resolved_tools"]}"
    # 去重处理
    final_deps=$(echo "$final_deps" | tr ' ' '\n' | sort -u | tr '\n' ' ')

    log_info "生成依赖安装脚本(包含系统工具)..."
    generate_deps_script "$final_deps"
    
    log_info "生成扩展安装脚本..."
    generate_extensions_script "$install_core" "$install_pecl" "$install_local" "$configure_cmds" "$pre_install_cmds"
    
    log_info "生成后置安装脚本..."
    generate_post_install_script "$post_install_cmds"
    
    log_info "生成 Composer 安装脚本..."
    generate_composer_script
    
    log_info "生成 PHP 配置文件..."
    generate_php_ini
    
    log_info "生成环境变量文件..."
    generate_env_file
    
<span class="hljs-meta prompt_"># </span><span class="bash">   log_info <span class="hljs-string">"生成入口点脚本..."</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">   generate_entrypoint_script</span>
    
    log_success "所有安装脚本生成完成"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成依赖安装脚本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_deps_script() {
    local deps="$1"
    local os_type="${CONFIG["os_type"]}"
    local system_mirror="${CONFIG["system_mirror"]}"
    
    cat &gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_HEADER'
<span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
set -e
<span class="hljs-meta prompt_">
# </span><span class="bash">颜色定义</span>
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

log_info "开始安装系统依赖..."

SCRIPT_HEADER

    if [ "$os_type" = "alpine" ]; then
        # 生成 Alpine 镜像源切换脚本
        if [ "$system_mirror" != "default" ]; then
            cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; SCRIPT_ALPINE_MIRROR
<span class="hljs-meta prompt_"># </span><span class="bash">切换 Alpine 镜像源</span>
log_info "切换 Alpine 镜像源到: $system_mirror"
SCRIPT_ALPINE_MIRROR
            case "$system_mirror" in
                aliyun)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_ALPINE_ALIYUN'
sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
SCRIPT_ALPINE_ALIYUN
                    ;;
                ustc)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_ALPINE_USTC'
sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
SCRIPT_ALPINE_USTC
                    ;;
                tsinghua)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_ALPINE_TSINGHUA'
sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories
SCRIPT_ALPINE_TSINGHUA
                    ;;
                163)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_ALPINE_163'
sed -i 's/dl-cdn.alpinelinux.org/mirrors.163.com/g' /etc/apk/repositories
SCRIPT_ALPINE_163
                    ;;
            esac
        fi
        
        cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; SCRIPT_ALPINE
<span class="hljs-meta prompt_"># </span><span class="bash">Alpine 系统依赖</span>
apk update
apk add --no-cache --virtual .build-deps \\
    \$PHPIZE_DEPS \\
    autoconf \\
    automake \\
    libtool \\
    make \\
    gcc \\
    g++ \\
    linux-headers
<span class="hljs-meta prompt_">
# </span><span class="bash">安装运行时依赖</span>
apk add --no-cache \\
    $deps

log_info "Alpine 系统依赖安装完成"
SCRIPT_ALPINE
    else
        # 生成 Debian 镜像源切换脚本
        if [ "$system_mirror" != "default" ]; then
            cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; SCRIPT_DEBIAN_MIRROR
<span class="hljs-meta prompt_"># </span><span class="bash">切换 Debian 镜像源</span>
log_info "切换 Debian/Ubuntu 镜像源到: $system_mirror"
<span class="hljs-meta prompt_">
# </span><span class="bash">备份原始源</span>
cp /etc/apt/sources.list /etc/apt/sources.list.bak 2&gt;/dev/null || true
<span class="hljs-meta prompt_">
# </span><span class="bash">检测 Debian 版本</span>
DEBIAN_VERSION=\$(cat /etc/os-release | grep VERSION_CODENAME | cut -d= -f2)
if [ -z "\$DEBIAN_VERSION" ]; then
    DEBIAN_VERSION="bullseye"
fi

log_info "检测到 Debian 版本: \$DEBIAN_VERSION"

SCRIPT_DEBIAN_MIRROR
            case "$system_mirror" in
                aliyun)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_DEBIAN_ALIYUN'
cat &gt; /etc/apt/sources.list &lt;&lt; EOF
deb https://mirrors.aliyun.com/debian/ $DEBIAN_VERSION main contrib non-free
deb https://mirrors.aliyun.com/debian/ $DEBIAN_VERSION-updates main contrib non-free
deb https://mirrors.aliyun.com/debian-security $DEBIAN_VERSION-security main contrib non-free
EOF
SCRIPT_DEBIAN_ALIYUN
                    ;;
                ustc)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_DEBIAN_USTC'
cat &gt; /etc/apt/sources.list &lt;&lt; EOF
deb https://mirrors.ustc.edu.cn/debian/ $DEBIAN_VERSION main contrib non-free
deb https://mirrors.ustc.edu.cn/debian/ $DEBIAN_VERSION-updates main contrib non-free
deb https://mirrors.ustc.edu.cn/debian-security $DEBIAN_VERSION-security main contrib non-free
EOF
SCRIPT_DEBIAN_USTC
                    ;;
                tsinghua)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_DEBIAN_TSINGHUA'
cat &gt; /etc/apt/sources.list &lt;&lt; EOF
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ $DEBIAN_VERSION main contrib non-free
deb https://mirrors.tuna.tsinghua.edu.cn/debian/ $DEBIAN_VERSION-updates main contrib non-free
deb https://mirrors.tuna.tsinghua.edu.cn/debian-security $DEBIAN_VERSION-security main contrib non-free
EOF
SCRIPT_DEBIAN_TSINGHUA
                    ;;
                163)
                    cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; 'SCRIPT_DEBIAN_163'
cat &gt; /etc/apt/sources.list &lt;&lt; EOF
deb http://mirrors.163.com/debian/ $DEBIAN_VERSION main contrib non-free
deb http://mirrors.163.com/debian/ $DEBIAN_VERSION-updates main contrib non-free
deb http://mirrors.163.com/debian-security $DEBIAN_VERSION-security main contrib non-free
EOF
SCRIPT_DEBIAN_163
                    ;;
            esac
        fi
        
        cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_deps.sh" &lt;&lt; SCRIPT_DEBIAN
<span class="hljs-meta prompt_"># </span><span class="bash">Debian 系统依赖</span>
apt-get update
apt-get install -y --no-install-recommends \\
    \$PHPIZE_DEPS \\
    autoconf \\
    automake \\
    libtool \\
    make \\
    gcc \\
    g++ \\
    $deps

log_info "Debian 系统依赖安装完成"
SCRIPT_DEBIAN
    fi
    
    chmod +x "$BUILD_SCRIPTS_DIR/install_deps.sh"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成扩展安装脚本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_extensions_script() {
    local core_exts="$1"
    local pecl_exts="$2"
    local local_exts="$3"
    local configure_cmds="$4"
    local pre_install_cmds="$5"
    
    cat &gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh" &lt;&lt; 'SCRIPT_HEADER'
<span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
set -e
<span class="hljs-meta prompt_">
# </span><span class="bash">颜色定义</span>
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
log_step() { echo -e "${CYAN}[STEP]${NC} $1"; }
<span class="hljs-meta prompt_">
# </span><span class="bash">PECL 扩展安装函数</span>
install_pecl_extension() {
    local ext_name="$1"
    local configure_opts="$2"
    
    log_step "安装 PECL 扩展: $ext_name"
    
    if [ -n "$configure_opts" ]; then
        printf "\n" | pecl install $ext_name &lt;&lt;&lt; "$configure_opts" || {
            log_warn "带配置安装失败，尝试默认安装..."
            printf "\n" | pecl install $ext_name
        }
    else
        printf "\n" | pecl install $ext_name || log_error "安装 $ext_name 失败"
    fi
    
    # 获取纯扩展名（去除版本号）
    local pure_name="${ext_name%%-*}"
    docker-php-ext-enable $pure_name || log_error "启用 $pure_name 失败"
    
    log_info "PECL 扩展 $ext_name 安装成功"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">本地扩展安装函数</span>
install_local_extension() {
    local ext_name="$1"
    local ext_file="$2"
    
    log_step "从本地安装扩展: $ext_name"
    
    local ext_dir="/tmp/ext_$ext_name"
    mkdir -p "$ext_dir"
    
    case "$ext_file" in
        *.tgz|*.tar.gz)
            tar -xzf "$ext_file" -C "$ext_dir" --strip-components=1
            ;;
        *.zip)
            unzip -q "$ext_file" -d "$ext_dir"
            ;;
        *)
            log_error "不支持的扩展格式: $ext_file"
            ;;
    esac
    
    cd "$ext_dir"
    phpize
    ./configure
    make -j$(nproc)
    make install
    docker-php-ext-enable $ext_name
    
    rm -rf "$ext_dir"
    log_info "本地扩展 $ext_name 安装成功"
}

log_info "开始安装 PHP 扩展..."

SCRIPT_HEADER

    # 添加预安装命令
    if [ -n "$pre_install_cmds" ]; then
        echo -e "\n# 预安装命令" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
        echo -e "$pre_install_cmds" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
    fi
    
    # 添加配置命令
    if [ -n "$configure_cmds" ]; then
        echo -e "\n# 扩展配置命令" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
        echo -e "$configure_cmds" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
    fi
    
    # 添加核心扩展安装
    if [ -n "$core_exts" ]; then
        cat &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh" &lt;&lt; SCRIPT_CORE
<span class="hljs-meta prompt_">
# </span><span class="bash">安装核心扩展</span>
log_step "安装核心扩展:$core_exts"
docker-php-ext-install -j\$(nproc)$core_exts || log_error "核心扩展安装失败"
log_info "核心扩展安装成功"
SCRIPT_CORE
    fi
    
    # 添加 PECL 扩展安装
    if [ -n "$pecl_exts" ]; then
        echo -e "\n# 安装 PECL 扩展" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
        echo -e "$pecl_exts" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
    fi
    
    # 添加本地扩展安装
    if [ -n "$local_exts" ]; then
        echo -e "\n# 安装本地扩展" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
        echo -e "$local_exts" &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
    fi
    
    echo -e '\nlog_info "所有 PHP 扩展安装完成"' &gt;&gt; "$BUILD_SCRIPTS_DIR/install_extensions.sh"
    
    chmod +x "$BUILD_SCRIPTS_DIR/install_extensions.sh"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成后置安装脚本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_post_install_script() {
    local post_cmds="$1"
    
    cat &gt; "$BUILD_SCRIPTS_DIR/post_install.sh" &lt;&lt; 'SCRIPT_HEADER'
<span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
set -e

log_info() { echo -e "\033[0;32m[INFO]\033[0m $1"; }

log_info "执行后置安装脚本..."

SCRIPT_HEADER

    if [ -n "$post_cmds" ]; then
        echo -e "$post_cmds" &gt;&gt; "$BUILD_SCRIPTS_DIR/post_install.sh"
    fi
    
    echo -e '\nlog_info "后置安装脚本执行完成"' &gt;&gt; "$BUILD_SCRIPTS_DIR/post_install.sh"
    
    chmod +x "$BUILD_SCRIPTS_DIR/post_install.sh"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成 Composer 安装脚本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_composer_script() {
    local mirror="${CONFIG["composer_mirror"]}"
    
    cat &gt; "$BUILD_SCRIPTS_DIR/install_composer.sh" &lt;&lt; 'SCRIPT_HEADER'
<span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
set -e

log_info() { echo -e "\033[0;32m[INFO]\033[0m $1"; }
log_error() { echo -e "\033[0;31m[ERROR]\033[0m $1"; exit 1; }

MIRROR="$1"

log_info "安装 Composer..."
<span class="hljs-meta prompt_">
# </span><span class="bash">下载并安装 Composer</span>
EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
    rm composer-setup.php
    log_error 'Composer installer 校验失败'
fi

php composer-setup.php --install-dir=/usr/local/bin --filename=composer
rm composer-setup.php
<span class="hljs-meta prompt_">
# </span><span class="bash">配置镜像源</span>
configure_mirror() {
    case "$MIRROR" in
        aliyun)
            composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/
            ;;
        tencent)
            composer config -g repo.packagist composer https://mirrors.cloud.tencent.com/composer/
            ;;
        ustc)
            composer config -g repo.packagist composer https://mirrors.ustc.edu.cn/composer/
            ;;
        huaweicloud)
            composer config -g repo.packagist composer https://repo.huaweicloud.com/repository/php/
            ;;
        packagist)
            composer config -g repo.packagist composer https://packagist.org
            ;;
        auto)
            # 自动检测最快的源
            log_info "自动检测最快的 Composer 源..."
            MIRRORS=(
                "https://mirrors.aliyun.com/composer/"
                "https://mirrors.cloud.tencent.com/composer/"
                "https://packagist.org"
            )
            FASTEST=""
            FASTEST_TIME=999
            for m in "${MIRRORS[@]}"; do
                TIME=$(curl -o /dev/null -s -w '%{time_total}' --connect-timeout 3 "$m" 2&gt;/dev/null || echo "999")
                if (( $(echo "$TIME &lt; $FASTEST_TIME" | bc -l 2&gt;/dev/null || echo 0) )); then
                    FASTEST_TIME=$TIME
                    FASTEST=$m
                fi
            done
            if [ -n "$FASTEST" ]; then
                composer config -g repo.packagist composer "$FASTEST"
                log_info "使用最快源: $FASTEST"
            fi
            ;;
    esac
}

configure_mirror

log_info "Composer 安装完成"
composer --version
SCRIPT_HEADER

    chmod +x "$BUILD_SCRIPTS_DIR/install_composer.sh"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成 PHP 配置文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_php_ini() {
    local ini_file="$BUILD_SCRIPTS_DIR/php.ini"
    
    echo "; PHP Custom Configuration" &gt; "$ini_file"
    echo "; Generated by build.sh at $(date)" &gt;&gt; "$ini_file"
    echo "" &gt;&gt; "$ini_file"
    
    for key in "${!PHP_CONFIG[@]}"; do
        echo "$key=${PHP_CONFIG[$key]}" &gt;&gt; "$ini_file"
    done
    
    log_debug "PHP 配置文件生成完成"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成环境变量文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_env_file() {
    local env_file="$BUILD_SCRIPTS_DIR/env.sh"
    
    echo "# Environment Variables" &gt; "$env_file"
    echo "# Generated by build.sh at $(date)" &gt;&gt; "$env_file"
    echo "" &gt;&gt; "$env_file"
    
    for key in "${!ENV_VARS[@]}"; do
        echo "export $key=\"${ENV_VARS[$key]}\"" &gt;&gt; "$env_file"
    done
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">生成入口点脚本</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
generate_entrypoint_script() {
    local cmd="${CONFIG["cmd"]}"
    
    cat &gt; "$BUILD_SCRIPTS_DIR/entrypoint.sh" &lt;&lt; 'SCRIPT_HEADER'
<span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
set -e
<span class="hljs-meta prompt_">
# </span><span class="bash">加载环境变量</span>
if [ -f /etc/profile ]; then
    source /etc/profile
fi
<span class="hljs-meta prompt_">
# </span><span class="bash">如果传入了命令，执行传入的命令</span>
if [ $# -gt 0 ]; then
    exec "$@"
fi

SCRIPT_HEADER

    # 添加默认命令
    if [ -n "$cmd" ]; then
        echo "# 默认命令" &gt;&gt; "$BUILD_SCRIPTS_DIR/entrypoint.sh"
        echo "exec $cmd" &gt;&gt; "$BUILD_SCRIPTS_DIR/entrypoint.sh"
    else
        echo "# 无默认命令，保持容器运行" &gt;&gt; "$BUILD_SCRIPTS_DIR/entrypoint.sh"
        echo 'exec tail -f /dev/null' &gt;&gt; "$BUILD_SCRIPTS_DIR/entrypoint.sh"
    fi
    
    chmod +x "$BUILD_SCRIPTS_DIR/entrypoint.sh"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">验证配置</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
validate_config() {
    log_step "验证配置"
    
    local errors=0
    
    # 验证基础镜像
    if [ -z "${CONFIG["base_image"]}" ]; then
        log_error "未配置基础镜像"
        errors=$((errors + 1))
    fi
    
    # 验证扩展数量
    if [ ${#EXTENSIONS[@]} -eq 0 ]; then
        log_warn "未配置任何扩展"
    fi
    
    # 验证工作目录
    if [ -z "${CONFIG["workdir"]}" ]; then
        log_warn "未配置工作目录，使用默认值: $DEFAULT_WORKDIR"
        CONFIG["workdir"]="$DEFAULT_WORKDIR"
    fi
    
    if [ $errors -gt 0 ]; then
        log_error "配置验证失败，发现 $errors 个错误"
        exit 1
    fi
    
    log_success "配置验证通过"
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Docker 构建</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
build_docker_image() {
    local image_tag="$1"
    
    log_step "开始构建 Docker 镜像: $image_tag"
    
    # 准备构建参数
    local build_args=""
    build_args="$build_args --build-arg BASE_IMAGE=${CONFIG["base_image"]}"
    build_args="$build_args --build-arg WORKDIR=${CONFIG["workdir"]}"
    build_args="$build_args --build-arg BUILD_MODE=${CONFIG["mode"]}"
    build_args="$build_args --build-arg COMPOSER_MIRROR=${CONFIG["composer_mirror"]}"

    # 传递额外包参数
    if [ -n "${CONFIG["extra_packages"]}" ]; then
        build_args="$build_args --build-arg EXTRA_PACKAGES=\"${CONFIG["extra_packages"]}\""
    fi
    
    # 内存限制（防止 OOM）
    local memory_limit="${BUILD_ARGS["memory_limit"]:-2048}"
    if [ "$memory_limit" != "0" ]; then
        build_args="$build_args --memory=${memory_limit}m"
    fi
    
    # 并行编译数
    local parallel_jobs="${BUILD_ARGS["parallel_jobs"]:-0}"
    if [ "$parallel_jobs" = "0" ]; then
        parallel_jobs=$(nproc)
    fi
    build_args="$build_args --build-arg PARALLEL_JOBS=$parallel_jobs"
    
    # 缓存设置
    local enable_cache="${BUILD_ARGS["enable_cache"]:-true}"
    if [ "$enable_cache" != "true" ]; then
        build_args="$build_args --no-cache"
    fi
    
    # 复制本地扩展到构建上下文
    if [ -d "$EXTENSION_DIR" ] &amp;&amp; [ "$(ls -A "$EXTENSION_DIR" 2&gt;/dev/null)" ]; then
        mkdir -p "$BUILD_SCRIPTS_DIR/extensions"
        cp -r "$EXTENSION_DIR"/* "$BUILD_SCRIPTS_DIR/extensions/" 2&gt;/dev/null || true
    fi
    
    log_info "构建参数: $build_args"
    
    # 执行构建
    start_spinner "正在构建 Docker 镜像..."

    # 修改判断逻辑，确保报错立即退出，不打印成功信息
    if docker build $build_args -t "$image_tag" -f "$SCRIPT_DIR/Dockerfile" "$SCRIPT_DIR" 2&gt;&amp;1 | tee -a "$LOG_FILE"; then
        stop_spinner "success" "Docker 镜像构建成功"
        log_success "镜像构建完成: $image_tag"
    else
        # 只要 docker build 失败，进入这里
        stop_spinner "fail" "Docker 镜像构建失败"
        log_error "构建过程中发生错误，请查看上方日志或检查: $LOG_FILE"
        exit 1  # 强制退出，不执行后续逻辑
    fi
    
    # 清理临时文件
    if [ "${BUILD_ARGS["clean_cache"]}" = "true" ]; then
        log_info "清理构建缓存..."
        rm -rf "$BUILD_SCRIPTS_DIR/extensions" 2&gt;/dev/null || true
    fi
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">显示帮助信息</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
show_help() {
    cat &lt;&lt; EOF
<span class="hljs-meta prompt_">$</span><span class="bash">{CYAN}<span class="hljs-variable">${BOLD}</span>PHP Hyperf Docker 构建工具<span class="hljs-variable">${NC}</span></span>
<span class="hljs-meta prompt_">
$</span><span class="bash">{YELLOW}用法:<span class="hljs-variable">${NC}</span></span>
    ./build.sh &lt;镜像名称:标签&gt;
    ./build.sh [选项]
<span class="hljs-meta prompt_">
$</span><span class="bash">{YELLOW}选项:<span class="hljs-variable">${NC}</span></span>
    -h, --help          显示帮助信息
    -v, --version       显示版本信息
    -d, --debug         启用调试模式
    --dry-run           仅解析配置，不执行构建
    --validate          仅验证配置
<span class="hljs-meta prompt_">
$</span><span class="bash">{YELLOW}示例:<span class="hljs-variable">${NC}</span></span>
    ./build.sh myapp:latest
    ./build.sh myapp:v1.0.0
    ./build.sh --debug myapp:dev
<span class="hljs-meta prompt_">
$</span><span class="bash">{YELLOW}配置文件:<span class="hljs-variable">${NC}</span></span>
    config/build.conf           主配置文件
    config/extension_deps.conf  扩展依赖配置
    config/extension_special.conf 扩展特殊配置
<span class="hljs-meta prompt_">
$</span><span class="bash">{YELLOW}本地扩展:<span class="hljs-variable">${NC}</span></span>
    将扩展文件放入 extension/ 目录
    支持格式: .tgz, .tar.gz, .zip
    命名格式: 扩展名-版本号.tgz (如: swoole-4.8.13.tgz)
<span class="hljs-meta prompt_">
$</span><span class="bash">{YELLOW}日志文件:<span class="hljs-variable">${NC}</span></span>
    logs/build_YYYYMMDD_HHMMSS.log

EOF
}
<span class="hljs-meta prompt_">
# </span><span class="bash">========================================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">主函数</span>
<span class="hljs-meta prompt_"># </span><span class="bash">========================================</span>
main() {
    # 创建日志目录
    mkdir -p "$LOGS_DIR"
    
    # 参数解析
    local image_tag=""
    local dry_run=false
    local validate_only=false
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                echo "PHP Hyperf Docker Builder v1.0.0"
                exit 0
                ;;
            -d|--debug)
                DEBUG=true
                shift
                ;;
            --dry-run)
                dry_run=true
                shift
                ;;
            --validate)
                validate_only=true
                shift
                ;;
            -*)
                log_error "未知选项: $1"
                show_help
                exit 1
                ;;
            *)
                image_tag="$1"
                shift
                ;;
        esac
    done
    
    # 检查镜像标签
    if [ -z "$image_tag" ] &amp;&amp; [ "$validate_only" != true ]; then
        log_error "请指定镜像名称和标签"
        echo ""
        show_help
        exit 1
    fi
    
    echo ""
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║         PHP Hyperf Docker 构建工具 v1.0.0                  ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    log_info "日志文件: $LOG_FILE"
    
    # 解析配置
    parse_config
    detect_image_type
    parse_extension_deps
    parse_extension_special
    check_local_extensions
    
    # 验证配置
    validate_config
    
    if [ "$validate_only" = true ]; then
        log_success "配置验证完成"
        exit 0
    fi
    
    # 生成安装脚本
    generate_install_scripts
    
    if [ "$dry_run" = true ]; then
        log_success "Dry run 完成，脚本已生成到: $BUILD_SCRIPTS_DIR"
        exit 0
    fi
    
    # 构建 Docker 镜像
    #build_docker_image "$image_tag"
    build_docker_image "$image_tag" || {
        echo -e "${RED}构建失败，请检查上方日志${NC}"
        exit 1
    }
    
    echo ""
    log_success "构建完成！"
    echo ""
    echo -e "${GREEN}运行容器:${NC}"
    echo -e "  docker run -d --name hyperf -p 9501:9501 $image_tag"
    echo ""
    echo -e "${GREEN}查看日志:${NC}"
    echo -e "  docker logs -f hyperf"
    echo ""
}
<span class="hljs-meta prompt_">
# </span><span class="bash">执行主函数</span>
main "$@"

</code></pre>
<h5 data-id="heading-9">Dockerfile</h5>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># ========================================
# PHP Hyperf Docker 构建文件
# 所有参数通过 ARG 传入，不直接修改此文件
# ========================================

# 基础镜像参数
ARG BASE_IMAGE=php:8.2-cli
FROM ${BASE_IMAGE}

# 构建参数
ARG WORKDIR=/opt/www
ARG BUILD_MODE=prod
ARG PARALLEL_JOBS=4
ARG COMPOSER_MIRROR=auto
ARG TIMEZONE=Asia/Shanghai

# 环境变量
ARG ENV_VARS=""
ARG PHP_INI_CONFIG=""
ARG EXTRA_PACKAGES=""
ARG CMD_COMMAND=""

# 扩展安装脚本（由 build.sh 生成）
ARG INSTALL_DEPS_SCRIPT=""
ARG INSTALL_EXTENSIONS_SCRIPT=""
ARG POST_INSTALL_SCRIPT=""

# 标签
LABEL maintainer="PHP Hyperf Builder"
LABEL description="PHP Hyperf Application Container"
LABEL build.mode="${BUILD_MODE}"

# 设置工作目录
WORKDIR ${WORKDIR}

# 设置时区
ENV TZ=${TIMEZONE}

# 检测系统类型并安装基础依赖
RUN set -eux; \
    # 检测是否为 Alpine
    if [ -f /etc/alpine-release ]; then \
        echo "Detected Alpine Linux"; \
        apk update; \
        apk add --no-cache \
            bash \
            curl \
            wget \
            git \
            unzip \
            tzdata \
            $EXTRA_PACKAGES; \
        cp /usr/share/zoneinfo/${TIMEZONE} /etc/localtime; \
        echo "${TIMEZONE}" &gt; /etc/timezone; \
    else \
        echo "Detected Debian/Ubuntu"; \
        apt-get update; \
        apt-get install -y --no-install-recommends \
            bash \
            curl \
            wget \
            git \
            unzip \
            ca-certificates \
            $EXTRA_PACKAGES; \
        ln -snf /usr/share/zoneinfo/${TIMEZONE} /etc/localtime; \
        echo "${TIMEZONE}" &gt; /etc/timezone; \
    fi

# 复制依赖安装脚本
COPY build_scripts/install_deps.sh /tmp/install_deps.sh
COPY build_scripts/install_extensions.sh /tmp/install_extensions.sh
COPY build_scripts/post_install.sh /tmp/post_install.sh
COPY build_scripts/install_composer.sh /tmp/install_composer.sh

# 安装系统依赖
RUN chmod +x /tmp/install_deps.sh &amp;&amp; /tmp/install_deps.sh

# 安装 PHP 扩展
RUN chmod +x /tmp/install_extensions.sh &amp;&amp; /tmp/install_extensions.sh

# 安装 Composer
RUN chmod +x /tmp/install_composer.sh &amp;&amp; /tmp/install_composer.sh ${COMPOSER_MIRROR}

# 执行后置安装脚本
RUN chmod +x /tmp/post_install.sh &amp;&amp; /tmp/post_install.sh

# 复制 PHP 配置
COPY build_scripts/php.ini /usr/local/etc/php/conf.d/99-custom.ini

# 清理
RUN set -eux; \
    rm -rf /tmp/*; \
    if [ -f /etc/alpine-release ]; then \
        rm -rf /var/cache/apk/*; \
    else \
        apt-get clean; \
        rm -rf /var/lib/apt/lists/*; \
    fi; \
    # 生产模式额外清理
    if [ "${BUILD_MODE}" = "prod" ]; then \
        rm -rf /usr/src/php*; \
        rm -rf /usr/local/include/php; \
    fi

# 设置环境变量
COPY build_scripts/env.sh /tmp/env.sh
RUN if [ -f /tmp/env.sh ]; then cat /tmp/env.sh &gt;&gt; /etc/profile; fi

# 暴露端口
#EXPOSE 9501

# 设置工作目录权限
RUN mkdir -p ${WORKDIR} &amp;&amp; chmod -R 755 ${WORKDIR}

# 健康检查
#HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
#    CMD curl -f http://localhost:9501/health || exit 1

# 入口点（可被覆盖）
#COPY build_scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
#RUN chmod +x /usr/local/bin/entrypoint.sh
#ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# CMD 命令（如果配置了）
# 这行会被 build.sh 动态添加

</code></pre>
<h4 data-id="heading-10">执行构建</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">进入项目目录</span>
cd project
<span class="hljs-meta prompt_">
# </span><span class="bash">添加文件执行权限</span>
chmod +x ./build.sh
<span class="hljs-meta prompt_">
# </span><span class="bash">执行构建</span>
./build.sh 新的镜像名称
</code></pre>
<h4 data-id="heading-11">结语</h4>
<p>该份套餐可以做到：</p>
<ul>
<li>构建逻辑通用：不同版本、不同扩展的构建只需要修改 build.conf 配置文件</li>
<li>扩展自由度高：可自由增减扩展信息，可指定版本，也可不指定，不指定时安装最新版本</li>
<li>构建模式切换：分为 prod/dev，prod 构建会清楚构建缓存等信息，减少镜像体积；dev模式不会，方便多次构建，减少构建时间</li>
<li>自定义系统依赖源：自由配置是否使用自定义系统依赖源，减少构建成功率和构建速度</li>
<li>自定义php配置：不同的开发需求，可能需要不通过的php配置，可以自由配置，构建后覆盖原有的默认配置</li>
<li>构建目标自由：可自由配置构建 基础镜像(base)、最终镜像(final)、基础+最终(all)</li>
<li>系统依赖自动检测：可根据配置的基础镜像，自动识别镜像系统（debian/alpine）、并安装对应的依赖，如：系统依赖、系统工具等</li>
<li>GD 扩展自动配置：如果 local 扩展中存在 GD 扩展，则自动做扩展特殊配置</li>
<li>镜像名称自定义：基础镜像名称自动生成，最终镜像名称可以自由定义</li>
<li>扩展安装重试机制：安装扩展容易因为各种原因失败，追加重试机制（3次）减少失败次数</li>
<li>... ... ...</li>
</ul>
<p>okk，提升到此结束，又可以愉快的做牛马了 ... ... ...</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码随想录算法训练营day23]]></title>    <link>https://juejin.cn/post/7603219519667273747</link>    <guid>https://juejin.cn/post/7603219519667273747</guid>    <pubDate>2026-02-05T16:02:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603219519667273747" data-draft-id="7603252259560374308" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码随想录算法训练营day23"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-02-05T16:02:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="流浪小孩"/> <meta itemprop="url" content="https://juejin.cn/user/4355606019312011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码随想录算法训练营day23
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355606019312011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    流浪小孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T16:02:48.000Z" title="Thu Feb 05 2026 16:02:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>回溯算法的进一步强化
39.组合总和
和之前的组合数类似，仅仅需要注意可以取重就可以</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-attr">private</span>:
    vector&lt;vector&lt;int&gt;&gt; result;<span class="hljs-comment">//存储所有结果</span>
    vector&lt;int&gt; tmp;<span class="hljs-comment">//存储临时结果</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtracking</span>(<span class="hljs-params">vector&lt;int&gt;&amp; candidates,int target,int index,int sum</span>){
        <span class="hljs-comment">//递归底层</span>
        <span class="hljs-keyword">if</span>(sum&gt;target) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sum==target) {
          result.<span class="hljs-title function_">push_back</span>(tmp);
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">//单层递归逻辑</span>
        <span class="hljs-keyword">for</span>(int i=index;i&lt;candidates.<span class="hljs-title function_">size</span>()&amp;&amp;sum&lt;target;i++){
          sum=sum+candidates[i];
          tmp.<span class="hljs-title function_">push_back</span>(candidates[i]);
          <span class="hljs-title function_">backtracking</span>(candidates,target,i,sum);
          sum=sum-candidates[i];
          tmp.<span class="hljs-title function_">pop_back</span>();
        }
    }
    
<span class="hljs-attr">public</span>:
    vector&lt;vector&lt;int&gt;&gt; <span class="hljs-title function_">combinationSum</span>(<span class="hljs-params">vector&lt;int&gt;&amp; candidates, int target</span>) {
        result.<span class="hljs-title function_">clear</span>();
        tmp.<span class="hljs-title function_">clear</span>();
        <span class="hljs-title function_">backtracking</span>(candidates,target,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> result;
        
    }
};
</code></pre>
<p>40 组合数二
增加了剪支操作以及判断不能够重复取数，减少时间复杂度</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-attr">private</span>:
    vector&lt;vector&lt;int&gt;&gt; result;
    vector&lt;int&gt; path;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtracking</span>(<span class="hljs-params">vector&lt;int&gt;&amp; candidates, int target, int sum, int startIndex</span>) {
        <span class="hljs-keyword">if</span> (sum == target) {
            result.<span class="hljs-title function_">push_back</span>(path);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">for</span> (int i = startIndex; i &lt; candidates.<span class="hljs-title function_">size</span>() &amp;&amp; sum + candidates[i] &lt;= target; i++) {
            <span class="hljs-comment">// 要对同一树层使用过的元素进行跳过</span>
            <span class="hljs-keyword">if</span> (i &gt; startIndex &amp;&amp; candidates[i] == candidates[i - <span class="hljs-number">1</span>]) {
                <span class="hljs-keyword">continue</span>;
            }
            sum += candidates[i];
            path.<span class="hljs-title function_">push_back</span>(candidates[i]);
            <span class="hljs-title function_">backtracking</span>(candidates, target, sum, i + <span class="hljs-number">1</span>); <span class="hljs-comment">// 和39.组合总和的区别1，这里是i+1，每个数字在每个组合中只能使用一次</span>
            sum -= candidates[i];
            path.<span class="hljs-title function_">pop_back</span>();
        }
    }

<span class="hljs-attr">public</span>:
    vector&lt;vector&lt;int&gt;&gt; <span class="hljs-title function_">combinationSum2</span>(<span class="hljs-params">vector&lt;int&gt;&amp; candidates, int target</span>) {
        path.<span class="hljs-title function_">clear</span>();
        result.<span class="hljs-title function_">clear</span>();
        <span class="hljs-comment">// 首先把给candidates排序，让其相同的元素都挨在一起。</span>
        <span class="hljs-title function_">sort</span>(candidates.<span class="hljs-title function_">begin</span>(), candidates.<span class="hljs-title function_">end</span>());
        <span class="hljs-title function_">backtracking</span>(candidates, target, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> result;
    }
};
</code></pre>
<p>131 分割回文串</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-comment">//设计思路，采用递归的方式不断对s进行拆分递归。</span>
<span class="hljs-comment">//第一步，递归函数需要传入的参数，除s之外，还应当有分割下标。具体结果分别存储在result和tmp之中</span>
<span class="hljs-attr">private</span>:
    vector&lt;vector&lt;string&gt;&gt; result;
    vector&lt;string&gt; tmp;
    <span class="hljs-comment">//判断字符串是否为回文串的函数</span>
   bool <span class="hljs-title function_">reword</span>(<span class="hljs-params">string s</span>){
          <span class="hljs-comment">//使用双指针</span>
        <span class="hljs-keyword">for</span>( int i=<span class="hljs-number">0</span>,j=s.<span class="hljs-title function_">size</span>()-<span class="hljs-number">1</span>;i&lt;j;i++,j--){
            <span class="hljs-keyword">if</span>(s[i]!=s[j])
               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
   
   <span class="hljs-keyword">void</span> <span class="hljs-title function_">backtracking</span>(<span class="hljs-params">string s,int index</span>){
        <span class="hljs-comment">//底层递归，当index==s.size()时表示回文串被分割完，返回</span>
        <span class="hljs-keyword">if</span>(index==s.<span class="hljs-title function_">size</span>()){
            result.<span class="hljs-title function_">push_back</span>(tmp);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">//单层递归逻辑</span>
        <span class="hljs-keyword">for</span>(int i=index;i&lt;s.<span class="hljs-title function_">size</span>();i++){
            <span class="hljs-comment">//判断该段分割是否满足回文字符串</span>
            string cur=s.<span class="hljs-title function_">substr</span>(index, i - index + <span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span>(!<span class="hljs-title function_">reword</span>(cur))
               <span class="hljs-keyword">continue</span>;
            tmp.<span class="hljs-title function_">push_back</span>(cur);
            <span class="hljs-title function_">backtracking</span>(s,i+<span class="hljs-number">1</span>);
            tmp.<span class="hljs-title function_">pop_back</span>();
        }
    }
<span class="hljs-attr">public</span>:
    vector&lt;vector&lt;string&gt;&gt; <span class="hljs-title function_">partition</span>(<span class="hljs-params">string s</span>) {
        result.<span class="hljs-title function_">clear</span>();
        tmp.<span class="hljs-title function_">clear</span>();
        <span class="hljs-title function_">backtracking</span>(s,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> result;
    }
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 littlefs 的日志存储解决方案]]></title>    <link>https://juejin.cn/post/7603195960255250432</link>    <guid>https://juejin.cn/post/7603195960255250432</guid>    <pubDate>2026-02-05T18:07:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603195960255250432" data-draft-id="7603183929252397108" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 littlefs 的日志存储解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T18:07:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林雨852"/> <meta itemprop="url" content="https://juejin.cn/user/3775071381890170"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 littlefs 的日志存储解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3775071381890170/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林雨852
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T18:07:05.000Z" title="Thu Feb 05 2026 18:07:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 littlefs 的日志存储解决方案</h2>
<h3 data-id="heading-1">项目架构概览</h3>
<h4 data-id="heading-2">littlefs 适配层（现有）</h4>
<p>本项目在 <code>src/middleware/chips/ws63/littlefs/</code> 中已提供了 littlefs 的适配层：</p>
<p><strong>主要 API 函数：</strong></p>
<pre><code class="hljs language-c" lang="c">fs_adapt_mount()              <span class="hljs-comment">// 挂载文件系统</span>
fs_adapt_unmount()            <span class="hljs-comment">// 卸载文件系统</span>
fs_adapt_open(path, flags)    <span class="hljs-comment">// 打开文件：返回文件描述符 (fd)</span>
fs_adapt_close(fd)            <span class="hljs-comment">// 关闭文件</span>
fs_adapt_write(fd, buf, len)  <span class="hljs-comment">// 写入数据：成功返回写入字节数</span>
fs_adapt_read(fd, buf, len)   <span class="hljs-comment">// 读取数据：成功返回读取字节数</span>
fs_adapt_seek(fd, offset, whence)  <span class="hljs-comment">// 文件指针定位</span>
fs_adapt_stat(path, &amp;size)    <span class="hljs-comment">// 获取文件大小</span>
fs_adapt_delete(path)         <span class="hljs-comment">// 删除文件</span>
fs_adapt_mkdir(path)          <span class="hljs-comment">// 创建目录</span>
fs_adapt_sync(fd)             <span class="hljs-comment">// 文件同步到存储</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">日志存储管理方案</h3>
<h4 data-id="heading-4">核心功能需求</h4>
<p>✅ 存储 20+ 个日志文件<br/>
✅ 根据时间戳命名文件<br/>
✅ 自动文件轮转（超过 1MB 自动创建新文件）<br/>
✅ 支持按文件名读取日志<br/>
✅ 支持日志追加写入</p>
<h4 data-id="heading-5">实现步骤</h4>
<h5 data-id="heading-6">1️⃣ <strong>初始化与挂载</strong></h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"littlefs_adapt.h"</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">init_log_storage</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 1. 挂载 littlefs 文件系统</span>
    fs_adapt_mount();
    
    <span class="hljs-comment">// 2. 创建日志目录</span>
    <span class="hljs-type">int</span> ret = fs_adapt_mkdir(<span class="hljs-string">"/logs"</span>);
    <span class="hljs-keyword">if</span> (ret != LFS_ERR_OK &amp;&amp; ret != LFS_ERR_EXIST) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h5 data-id="heading-7">2️⃣ <strong>生成时间戳文件名</strong></h5>
<p><strong>示例：生成文件名如 <code>2025-02-06_143022.log</code></strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-comment">// 生成时间戳格式的文件名</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">generate_log_filename</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename, <span class="hljs-type">size_t</span> max_len)</span>
{
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tm</span> *<span class="hljs-title">timeinfo</span> =</span> localtime(&amp;now);
    
    <span class="hljs-built_in">snprintf</span>(filename, max_len, <span class="hljs-string">"/logs/%04d%02d%02d_%02d%02d%02d.log"</span>,
             timeinfo-&gt;tm_year + <span class="hljs-number">1900</span>,
             timeinfo-&gt;tm_mon + <span class="hljs-number">1</span>,
             timeinfo-&gt;tm_mday,
             timeinfo-&gt;tm_hour,
             timeinfo-&gt;tm_min,
             timeinfo-&gt;tm_sec);
}
</code></pre>
<hr/>
<h5 data-id="heading-8">3️⃣ <strong>日志写入（带自动轮转）</strong></h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_FILE_MAX_SIZE (1024 * 1024)  <span class="hljs-comment">// 1MB</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">write_log</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *log_content)</span>
{
    <span class="hljs-type">char</span> filename[<span class="hljs-number">64</span>];
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> file_size = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 获取当前日志文件名</span>
    generate_log_filename(filename, <span class="hljs-keyword">sizeof</span>(filename));
    
    <span class="hljs-comment">// 检查文件是否存在及大小</span>
    <span class="hljs-keyword">if</span> (fs_adapt_stat(filename, &amp;file_size) == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 文件存在，检查是否超过 1MB</span>
        <span class="hljs-keyword">if</span> (file_size &gt;= LOG_FILE_MAX_SIZE) {
            <span class="hljs-comment">// 文件已满，生成新文件名（加时间戳）</span>
            <span class="hljs-type">char</span> new_filename[<span class="hljs-number">64</span>];
            <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tm</span> *<span class="hljs-title">timeinfo</span> =</span> localtime(&amp;now);
            
            <span class="hljs-built_in">snprintf</span>(new_filename, <span class="hljs-keyword">sizeof</span>(new_filename), 
                     <span class="hljs-string">"/logs/%04d%02d%02d_%02d%02d%02d_%lu.log"</span>,
                     timeinfo-&gt;tm_year + <span class="hljs-number">1900</span>,
                     timeinfo-&gt;tm_mon + <span class="hljs-number">1</span>,
                     timeinfo-&gt;tm_mday,
                     timeinfo-&gt;tm_hour,
                     timeinfo-&gt;tm_min,
                     timeinfo-&gt;tm_sec,
                     (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)now);  <span class="hljs-comment">// 添加时间戳避免重名</span>
            <span class="hljs-built_in">strcpy</span>(filename, new_filename);
        }
    }
    
    <span class="hljs-comment">// 以追加模式打开文件（O_CREAT | O_APPEND）</span>
    <span class="hljs-type">int</span> fd = fs_adapt_open(filename, O_RDWR | O_CREAT | O_APPEND);
    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-comment">// 写入日志内容</span>
    <span class="hljs-type">int</span> ret = fs_adapt_write(fd, log_content, <span class="hljs-built_in">strlen</span>(log_content));
    <span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 写入换行符</span>
        fs_adapt_write(fd, <span class="hljs-string">"\n"</span>, <span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 同步到存储（确保数据不丢失）</span>
    fs_adapt_sync(fd);
    
    <span class="hljs-comment">// 关闭文件</span>
    fs_adapt_close(fd);
    
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<hr/>
<h5 data-id="heading-9">4️⃣ <strong>按文件名读取日志</strong></h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 定义缓冲区大小</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_BUFFER_SIZE (4096)</span>

<span class="hljs-type">ssize_t</span> <span class="hljs-title function_">read_log_file</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> max_len)</span>
{
    <span class="hljs-comment">// 完整路径</span>
    <span class="hljs-type">char</span> filepath[<span class="hljs-number">64</span>];
    <span class="hljs-built_in">snprintf</span>(filepath, <span class="hljs-keyword">sizeof</span>(filepath), <span class="hljs-string">"/logs/%s"</span>, filename);
    
    <span class="hljs-comment">// 以只读模式打开文件</span>
    <span class="hljs-type">int</span> fd = fs_adapt_open(filepath, O_RDONLY);
    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;  <span class="hljs-comment">// 文件不存在</span>
    }
    
    <span class="hljs-comment">// 从文件开头读取</span>
    <span class="hljs-type">ssize_t</span> bytes_read = fs_adapt_read(fd, buffer, max_len - <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">if</span> (bytes_read &gt; <span class="hljs-number">0</span>) {
        buffer[bytes_read] = <span class="hljs-string">'\0'</span>;  <span class="hljs-comment">// 字符串空终止</span>
    }
    
    fs_adapt_close(fd);
    
    <span class="hljs-keyword">return</span> bytes_read;
}
</code></pre>
<hr/>
<h5 data-id="heading-10">5️⃣ <strong>列出所有日志文件</strong></h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">char</span> filename[<span class="hljs-number">64</span>];
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;
} <span class="hljs-type">log_file_info_t</span>;

<span class="hljs-comment">// 列出 /logs 目录下的所有文件</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">list_all_logs</span><span class="hljs-params">(<span class="hljs-type">log_file_info_t</span> *log_files, <span class="hljs-type">int</span> max_count, <span class="hljs-type">int</span> *actual_count)</span>
{
    <span class="hljs-type">lfs_dir_t</span> dir;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lfs_info</span> <span class="hljs-title">info</span>;</span>
    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 打开 /logs 目录（需要使用原生 littlefs API）</span>
    <span class="hljs-comment">// 注意：当前适配层不提供目录遍历，需要扩展</span>
    
    <span class="hljs-comment">// 暂时使用文件时间戳约定来管理</span>
    <span class="hljs-comment">// 应用层可维护一个日志文件索引表</span>
    
    <span class="hljs-keyword">return</span> count;
}
</code></pre>
<hr/>
<h3 data-id="heading-11">完整使用示例</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"littlefs_adapt.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>

<span class="hljs-comment">// 完整的日志管理示例</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">log_management_example</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 1️⃣ 初始化</span>
    init_log_storage();
    
    <span class="hljs-comment">// 2️⃣ 写入日志（模拟多个日志条目）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
        <span class="hljs-type">char</span> log_str[<span class="hljs-number">256</span>];
        <span class="hljs-built_in">snprintf</span>(log_str, <span class="hljs-keyword">sizeof</span>(log_str), 
                 <span class="hljs-string">"[INFO] Log entry %d - Timestamp: %ld"</span>, i, time(<span class="hljs-literal">NULL</span>));
        
        write_log(log_str);
        
        <span class="hljs-comment">// 模拟延迟</span>
        usleep(<span class="hljs-number">10000</span>);
    }
    
    <span class="hljs-comment">// 3️⃣ 读取特定日志文件</span>
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
    <span class="hljs-type">ssize_t</span> ret = read_log_file(<span class="hljs-string">"20250206_143022.log"</span>, buffer, <span class="hljs-keyword">sizeof</span>(buffer));
    <span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Log content:\n%s\n"</span>, buffer);
    }
    
    <span class="hljs-comment">// 4️⃣ 卸载文件系统</span>
    fs_adapt_unmount();
}
</code></pre>
<hr/>
<h3 data-id="heading-12">关键 API 调用总结</h3>




























































<table><thead><tr><th>操作</th><th>API 调用</th><th>说明</th></tr></thead><tbody><tr><td><strong>初始化</strong></td><td><code>fs_adapt_mount()</code></td><td>文件系统初始化</td></tr><tr><td><strong>创建目录</strong></td><td><code>fs_adapt_mkdir("/logs")</code></td><td>创建日志目录</td></tr><tr><td><strong>打开文件</strong></td><td><code>fs_adapt_open(path, O_RDWR|O_CREAT|O_APPEND)</code></td><td>以追加模式打开</td></tr><tr><td><strong>写入数据</strong></td><td><code>fs_adapt_write(fd, buf, len)</code></td><td>写入日志内容</td></tr><tr><td><strong>同步数据</strong></td><td><code>fs_adapt_sync(fd)</code></td><td>确保数据刷新到 Flash</td></tr><tr><td><strong>关闭文件</strong></td><td><code>fs_adapt_close(fd)</code></td><td>关闭文件描述符</td></tr><tr><td><strong>读取数据</strong></td><td><code>fs_adapt_read(fd, buf, len)</code></td><td>读取文件内容</td></tr><tr><td><strong>检查大小</strong></td><td><code>fs_adapt_stat(path, &amp;size)</code></td><td>获取文件大小</td></tr><tr><td><strong>删除文件</strong></td><td><code>fs_adapt_delete(path)</code></td><td>删除旧日志</td></tr><tr><td><strong>定位指针</strong></td><td><code>fs_adapt_seek(fd, offset, SEEK_SET)</code></td><td>移动文件指针</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">高级特性建议</h3>
<h4 data-id="heading-14">1. <strong>日志文件索引管理</strong></h4>
<p>维护内存中的索引表，记录所有日志文件及其元数据：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">char</span> filename[<span class="hljs-number">64</span>];
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;
    <span class="hljs-type">time_t</span> created_time;
    <span class="hljs-type">time_t</span> last_modified;
} <span class="hljs-type">log_index_t</span>;
</code></pre>
<h4 data-id="heading-15">2. <strong>自动清理机制</strong></h4>
<p>当日志总数超过 20 个时，删除最旧的文件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">cleanup_old_logs</span><span class="hljs-params">(<span class="hljs-type">int</span> max_files)</span>
{
    <span class="hljs-comment">// 按修改时间排序</span>
    <span class="hljs-comment">// 删除超过数量的最旧文件</span>
}
</code></pre>
<h4 data-id="heading-16">3. <strong>环形缓冲优化</strong></h4>
<p>对于高频日志场景，使用环形缓冲区减少 I/O：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
    <span class="hljs-type">int</span> write_pos;
    <span class="hljs-type">int</span> flush_threshold;
} <span class="hljs-type">log_circular_buffer_t</span>;
</code></pre>
<h4 data-id="heading-17">4. <strong>日志压缩</strong></h4>
<p>超过 1MB 的文件可选择压缩或分片存储</p>
<hr/>
<h3 data-id="heading-18">文件系统容量计算</h3>
<p>假设 littlefs 分区大小为 256KB：</p>
<ul>
<li>每个文件最大 1MB （可配置）</li>
<li>可存储约 <strong>20-25 个</strong> 日志文件</li>
<li>需在 <code>littlefs_config.h</code> 中配置适当的分区大小</li>
</ul>
<hr/>
<h3 data-id="heading-19">常见问题</h3>
<p><strong>Q: 如何确保日志不丢失？</strong><br/>
A: 每次写入后调用 <code>fs_adapt_sync(fd)</code> 强制刷新到 Flash</p>
<p><strong>Q: 如何处理文件名冲突？</strong><br/>
A: 添加微秒级时间戳或序列号后缀</p>
<p><strong>Q: 如何快速查询特定时间段的日志？</strong><br/>
A: 解析文件名中的时间戳，或维护时间索引表</p>
<p><strong>Q: littlefs 性能如何？</strong><br/>
A: 小文件性能优秀，适合 MCU 场景（延迟 &lt; 10ms）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[日志管理库集成指南（Integration Guide）]]></title>    <link>https://juejin.cn/post/7603043152673898511</link>    <guid>https://juejin.cn/post/7603043152673898511</guid>    <pubDate>2026-02-05T18:10:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603043152673898511" data-draft-id="7603043152673882127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="日志管理库集成指南（Integration Guide）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T18:10:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林雨852"/> <meta itemprop="url" content="https://juejin.cn/user/3775071381890170"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            日志管理库集成指南（Integration Guide）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3775071381890170/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林雨852
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T18:10:50.000Z" title="Thu Feb 05 2026 18:10:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">日志管理库集成指南（Integration Guide）</h2>
<h3 data-id="heading-1">快速开始</h3>
<h4 data-id="heading-2">文件列表</h4>
<pre><code class="hljs language-bash" lang="bash">├── log_manager.h              <span class="hljs-comment"># 日志管理库头文件（公共API）</span>
├── log_manager.c              <span class="hljs-comment"># 日志管理库实现</span>
├── log_manager_examples.c     <span class="hljs-comment"># 使用示例和测试用例</span>
├── LOG_STORAGE_SOLUTION.md    <span class="hljs-comment"># 详细的架构文档</span>
└── INTEGRATION_GUIDE.md       <span class="hljs-comment"># 本文件</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">1️⃣ 核心 API 总结</h3>
<h4 data-id="heading-4">初始化和清理</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;              <span class="hljs-comment">// 初始化日志系统</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_cleanup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;           <span class="hljs-comment">// 关闭日志系统</span>
</code></pre>
<h4 data-id="heading-5">日志写入</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *log_message)</span>;                    <span class="hljs-comment">// 写入简单日志</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span>;                  <span class="hljs-comment">// 格式化写入（printf风格）</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_write_level</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *level, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *message)</span>;  <span class="hljs-comment">// 带日志等级</span>
</code></pre>
<h4 data-id="heading-6">日志读取</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> max_len)</span>;
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_read_offset</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> max_len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset)</span>;
</code></pre>
<h4 data-id="heading-7">文件管理</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_get_file_size</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *file_size)</span>;
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_list_files</span><span class="hljs-params">(<span class="hljs-type">log_file_info_t</span> *files, <span class="hljs-type">int</span> max_count, <span class="hljs-type">int</span> *actual_count)</span>;
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_delete_file</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename)</span>;
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_cleanup_old_files</span><span class="hljs-params">(<span class="hljs-type">int</span> max_files)</span>;
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_clear_all</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;
</code></pre>
<h4 data-id="heading-8">文件名生成</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">char</span>* <span class="hljs-title function_">log_manager_generate_filename</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename, <span class="hljs-type">size_t</span> max_len)</span>;
<span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_get_current_file_info</span><span class="hljs-params">(<span class="hljs-type">log_file_info_t</span> *current_file)</span>;
</code></pre>
<hr/>
<h3 data-id="heading-9">2️⃣ 最小化集成步骤</h3>
<h4 data-id="heading-10">步骤1：添加文件到项目</h4>
<p>将 <code>log_manager.h</code> 和 <code>log_manager.c</code> 复制到项目的 middleware 目录：</p>
<pre><code class="hljs language-bash" lang="bash">src/middleware/chips/ws63/log_manager/
├── CMakeLists.txt
├── log_manager.h
└── log_manager.c
</code></pre>
<h4 data-id="heading-11">步骤2：修改 CMakeLists.txt</h4>
<p>在 <code>src/middleware/CMakeLists.txt</code> 中添加：</p>
<pre><code class="hljs language-cmake" lang="cmake">add_subdirectory(chips/${CONFIG_CHIP_TYPE}/log_manager)
</code></pre>
<p>在 <code>src/middleware/chips/ws63/log_manager/CMakeLists.txt</code> 中添加：</p>
<pre><code class="hljs language-cmake" lang="cmake">cmake_minimum_required(VERSION 3.5)

file(GLOB_RECURSE LOG_MANAGER_SOURCES "*.c")

add_library(log_manager STATIC ${LOG_MANAGER_SOURCES})

target_include_directories(log_manager PUBLIC 
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${MIDD_DIR}/chips/${CONFIG_CHIP_TYPE}/littlefs
)

target_link_libraries(log_manager littlefs)
</code></pre>
<h4 data-id="heading-12">步骤3：在应用代码中使用</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"log_manager.h"</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">main_application</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 初始化</span>
    log_manager_init();
    
    <span class="hljs-comment">// 写入日志</span>
    log_manager_write(<span class="hljs-string">"System started"</span>);
    log_manager_printf(<span class="hljs-string">"Temperature: %d°C"</span>, <span class="hljs-number">28</span>);
    log_manager_write_level(<span class="hljs-string">"INFO"</span>, <span class="hljs-string">"Sensor initialized"</span>);
    
    <span class="hljs-comment">// 读取日志</span>
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
    log_manager_read(<span class="hljs-string">"20250206_143022.log"</span>, buffer, <span class="hljs-keyword">sizeof</span>(buffer));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, buffer);
    
    <span class="hljs-comment">// 清理</span>
    log_manager_cleanup();
}
</code></pre>
<hr/>
<h3 data-id="heading-13">3️⃣ 常见场景实现</h3>
<h4 data-id="heading-14">场景A：设备启动日志</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">log_device_startup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    log_manager_init();
    
    log_manager_write_level(<span class="hljs-string">"INFO"</span>, <span class="hljs-string">"=== Device Startup ==="</span>);
    log_manager_write_level(<span class="hljs-string">"INFO"</span>, <span class="hljs-string">"Firmware: v1.0.0"</span>);
    log_manager_write_level(<span class="hljs-string">"DEBUG"</span>, <span class="hljs-string">"Initializing sensors"</span>);
    log_manager_write_level(<span class="hljs-string">"INFO"</span>, <span class="hljs-string">"All systems online"</span>);
    
    log_manager_cleanup();
}
</code></pre>
<h4 data-id="heading-15">场景B：周期性传感器采样</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">sensor_monitoring_task</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    log_manager_init();
    
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-type">int</span> temp = read_temperature();
        <span class="hljs-type">int</span> humidity = read_humidity();
        
        log_manager_printf(<span class="hljs-string">"SENSOR: T=%dC H=%d%% Battery=85%%"</span>, 
                           temp, humidity);
        
        sleep(<span class="hljs-number">60</span>);  <span class="hljs-comment">// 每分钟一次</span>
    }
    
    log_manager_cleanup();
}
</code></pre>
<h4 data-id="heading-16">场景C：错误诊断</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">error_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> error_code)</span>
{
    log_manager_init();
    
    log_manager_printf(<span class="hljs-string">"ERROR_CODE: 0x%04X"</span>, error_code);
    log_manager_write_level(<span class="hljs-string">"ERROR"</span>, <span class="hljs-string">"System error detected"</span>);
    log_manager_write_level(<span class="hljs-string">"ERROR"</span>, <span class="hljs-string">"Attempting recovery..."</span>);
    
    <span class="hljs-comment">// 记录调用栈或其他诊断信息</span>
    log_manager_printf(<span class="hljs-string">"Error source: %s:%d"</span>, __FILE__, __LINE__);
    
    log_manager_cleanup();
}
</code></pre>
<h4 data-id="heading-17">场景D：日志查询和导出</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">export_logs_to_uart</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    log_manager_init();
    
    <span class="hljs-comment">// 获取所有日志文件列表</span>
    <span class="hljs-type">log_file_info_t</span> files[<span class="hljs-number">20</span>];
    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;
    log_manager_list_files(files, <span class="hljs-number">20</span>, &amp;count);
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"=== Log Export ===\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Total files: %d\n\n"</span>, count);
    
    <span class="hljs-comment">// 逐个读取并导出</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"--- File: %s ---\n"</span>, files[i].filename);
        
        <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
        log_manager_read(files[i].filename, buffer, <span class="hljs-keyword">sizeof</span>(buffer));
        
        uart_send(buffer, <span class="hljs-built_in">strlen</span>(buffer));
        
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
    }
    
    log_manager_cleanup();
}
</code></pre>
<hr/>
<h3 data-id="heading-18">4️⃣ 内存和存储考虑</h3>
<h4 data-id="heading-19">内存使用</h4>
<ul>
<li>全局结构体 <code>log_manager_t</code>: ~5.5 KB
<ul>
<li>20 个文件信息缓存</li>
<li>当前文件名缓冲区</li>
</ul>
</li>
</ul>
<h4 data-id="heading-20">存储使用</h4>
<p>假设 littlefs 分区 256KB：</p>
<ul>
<li><strong>最多存储数量</strong>: ~20-25 个 1MB 级文件</li>
<li><strong>实际可用</strong>: 根据分区大小调整 <code>LOG_MAX_FILE_SIZE</code></li>
</ul>
<h4 data-id="heading-21">优化建议</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 根据实际需求调整这些值</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_MAX_FILE_SIZE (512 * 1024)   <span class="hljs-comment">// 改为 512KB</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_MAX_FILES 30                  <span class="hljs-comment">// 增加文件数量</span></span>
</code></pre>
<hr/>
<h3 data-id="heading-22">5️⃣ 线程安全性</h3>
<h4 data-id="heading-23">当前实现</h4>
<ul>
<li><strong>非线程安全</strong>: 适用于单线程 MCU</li>
<li>全局变量 <code>g_log_mgr</code> 用于状态管理</li>
</ul>
<h4 data-id="heading-24">多线程环境</h4>
<p>如果需要多线程支持，执行以下步骤：</p>
<h5 data-id="heading-25">5a. 添加互斥锁</h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_OSAL_MUTEX</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"soc_osal.h"</span></span>

<span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> g_log_mgr_mutex;

<span class="hljs-type">void</span> <span class="hljs-title function_">log_manager_lock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    osal_mutex_lock(g_log_mgr_mutex);
}

<span class="hljs-type">void</span> <span class="hljs-title function_">log_manager_unlock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    osal_mutex_unlock(g_log_mgr_mutex);
}
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<h5 data-id="heading-26">5b. 在关键函数中加锁</h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">log_manager_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *log_message)</span>
{
    log_manager_lock();
    <span class="hljs-comment">// ... 原有逻辑</span>
    log_manager_unlock();
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<hr/>
<h3 data-id="heading-27">6️⃣ 性能优化</h3>
<h4 data-id="heading-28">优化1：缓冲批量写入</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 减少 I/O 次数，而不是每条消息都同步</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> USE_LOG_BUFFER 1  <span class="hljs-comment">// 启用缓冲</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_BUFFER_THRESHOLD 512  <span class="hljs-comment">// 512字节后再同步</span></span>
</code></pre>
<h4 data-id="heading-29">优化2：文件压缩存档</h4>
<p>对于长期存储，可以压缩旧文件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 伪代码</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">compress_old_logs</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">log_file_info_t</span> old_log;
    
    <span class="hljs-comment">// 找到最旧的文件</span>
    <span class="hljs-keyword">if</span> (get_oldest_file(&amp;old_log) == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 使用 zlib 或其他压缩库</span>
        compress_file(old_log.filename);
    }
}
</code></pre>
<h4 data-id="heading-30">优化3：智能文件轮转</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 不是简单的大小限制，考虑时间戳重名</span>
<span class="hljs-comment">// 当同一秒内多个写入触发轮转时</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">rotate_with_sequence</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">static</span> <span class="hljs-type">int</span> rotation_seq = <span class="hljs-number">0</span>;
    <span class="hljs-type">char</span> filename[<span class="hljs-number">256</span>];
    
    <span class="hljs-built_in">snprintf</span>(filename, <span class="hljs-keyword">sizeof</span>(filename), 
             <span class="hljs-string">"/logs/%s_%d.log"</span>,
             get_timestamp(), rotation_seq++);
    
    <span class="hljs-comment">// ... 创建新文件</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-31">7️⃣ 调试和故障排除</h3>
<h4 data-id="heading-32">启用调试输出</h4>
<p>在 <code>littlefs_config.h</code> 中启用日志：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_LFS_ADAPT_DEBUG   <span class="hljs-comment">// littlefs 调试日志</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CONFIG_LFS_ADAPT_ERROR   <span class="hljs-comment">// littlefs 错误日志</span></span>
</code></pre>
<h4 data-id="heading-33">常见问题</h4>






























<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>fs_adapt_open</code> 返回 -1</td><td>文件路径无效或目录不存在</td><td>检查 <code>mkdir</code> 是否成功</td></tr><tr><td>日志写入后立即读取为空</td><td>未调用 <code>fs_adapt_sync</code></td><td>每次写入后调用 sync</td></tr><tr><td>文件轮转不工作</td><td>文件大小检查逻辑</td><td>验证 <code>should_rotate_file()</code></td></tr><tr><td>内存溢出</td><td>文件列表过多</td><td>增加 <code>LOG_MAX_FILES</code> 或清理旧文件</td></tr></tbody></table>
<h4 data-id="heading-34">调试用函数</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">debug_print_manager_state</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Log Manager State:\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  Initialized: %d\n"</span>, g_log_mgr.initialized);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  Current FD: %d\n"</span>, g_log_mgr.current_fd);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  Current file: %s\n"</span>, g_log_mgr.current_filename);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  Current size: %u\n"</span>, g_log_mgr.current_file_size);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  File count: %d\n"</span>, g_log_mgr.file_count);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; g_log_mgr.file_count; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"    [%d] %s - %u bytes\n"</span>, i,
               g_log_mgr.file_list[i].filename,
               g_log_mgr.file_list[i].size);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-35">8️⃣ 完整示例代码</h3>
<h4 data-id="heading-36">简洁版使用</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"log_manager.h"</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 初始化</span>
    log_manager_init();
    
    <span class="hljs-comment">// 写入日志</span>
    log_manager_write_level(<span class="hljs-string">"INFO"</span>, <span class="hljs-string">"Application started"</span>);
    log_manager_printf(<span class="hljs-string">"Current time: %ld"</span>, time(<span class="hljs-literal">NULL</span>));
    
    <span class="hljs-comment">// 读取日志</span>
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
    log_manager_read(<span class="hljs-string">"2025020_143022.log"</span>, buffer, <span class="hljs-keyword">sizeof</span>(buffer));
    
    <span class="hljs-comment">// 文件管理</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> total_size;
    log_manager_get_total_size(&amp;total_size);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Total log size: %u bytes\n"</span>, total_size);
    
    <span class="hljs-comment">// 清理</span>
    log_manager_cleanup();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-37">总结</h3>
<p>✅ <strong>已完成的功能</strong></p>
<ul>
<li>时间戳命名文件</li>
<li>自动文件轮转 (1MB 限制)</li>
<li>格式化日志写入</li>
<li>按文件名读取日志</li>
<li>文件管理（列表、删除、清理）</li>
</ul>
<p>⚠️ <strong>需要根据项目调整</strong></p>
<ul>
<li>分区大小（当前假设 256KB）</li>
<li>最大文件数量（当前 20 个）</li>
<li>文件大小限制（当前 1MB）</li>
<li>线程安全性（如需要）</li>
</ul>
<p>📦 <strong>集成检查清单</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 复制 <code>log_manager.h</code> 和 <code>log_manager.c</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更新 CMakeLists.txt</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 包含头文件</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 调用 <code>log_manager_init()</code> 和 <code>log_manager_cleanup()</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 测试基本写入和读取</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 验证文件轮转功能</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 性能测试和优化</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[web audio api前端录音与实时语音转写技术实现]]></title>    <link>https://juejin.cn/post/7603054272159170610</link>    <guid>https://juejin.cn/post/7603054272159170610</guid>    <pubDate>2026-02-05T11:24:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603054272159170610" data-draft-id="7602634187283955722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="web audio api前端录音与实时语音转写技术实现"/> <meta itemprop="keywords" content="前端,JavaScript,开源"/> <meta itemprop="datePublished" content="2026-02-05T11:24:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xlybyte"/> <meta itemprop="url" content="https://juejin.cn/user/1082388769678615"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            web audio api前端录音与实时语音转写技术实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1082388769678615/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xlybyte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T11:24:25.000Z" title="Thu Feb 05 2026 11:24:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端录音与实时语音转写技术实现</h2>
<h3 data-id="heading-1">一、项目概述</h3>
<p>这是一个基于浏览器原生能力的前端录音工具，集成了<strong>阿里云通译听悟</strong>的实时语音转写（ASR）能力。项目核心功能包括：</p>
<ul>
<li><strong>音频录制</strong>：使用 Web Audio API 实现高质量录音</li>
<li><strong>实时转写</strong>：通过 WebSocket 将音频流实时发送到阿里云 ASR 服务</li>
<li><strong>波形可视化</strong>：提供频率柱状图</li>
<li><strong>录音控制</strong>：支持开始、暂停、继续、停止等操作</li>
</ul>
<h3 data-id="heading-2">二、技术架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                      Vue 组件层 (index.vue)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  录音控制   │  │  ASR展示    │  │   WebSocket 通信    │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
└─────────┼────────────────┼───────────────────┼─────────────┘
          │                │                   │
          ▼                ▼                   ▼
┌─────────────────┐  ┌───────────────┐  ┌─────────────────────┐
│   Recorder类    │  │ WaveformVisual│  │   阿里云 ASR API    │
│  (recorder.js)  │  │  (wave.js)    │  │   (听悟服务)        │
└────────┬────────┘  └───────────────┘  └─────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│              Web <span class="hljs-selector-tag">Audio</span> API + getUserMedia                    │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">三、核心实现原理</h3>
<h4 data-id="heading-4">3.1 音频采集原理</h4>
<p>浏览器录音主要依赖两个核心 API：</p>




















<table><thead><tr><th>API</th><th>作用</th><th>浏览器支持</th></tr></thead><tbody><tr><td><code>getUserMedia</code></td><td>获取麦克风音频流</td><td>所有现代浏览器</td></tr><tr><td><code>AudioContext</code></td><td>音频处理上下文</td><td>Chrome 35+, Firefox 25+</td></tr></tbody></table>
<p><strong>音频处理流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">麦克风 → MediaStream → AudioContext → ScriptProcessorNode → PCM数据
<span class="hljs-code">                              ↓
                        AnalyserNode → 波形数据
</span></code></pre>
<h4 data-id="heading-5">3.2 Recorder 类核心设计</h4>
<p><code>Recorder</code> 类是整个录音功能的核心，采用了<strong>面向对象</strong>的设计模式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Recorder</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-comment">// 配置参数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">sampleBits</span>: <span class="hljs-number">16</span>,        <span class="hljs-comment">// 采样位数</span>
      <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span>,     <span class="hljs-comment">// 采样率（阿里云ASR推荐）</span>
      <span class="hljs-attr">numChannels</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 声道数</span>
      <span class="hljs-attr">compiling</span>: <span class="hljs-literal">true</span>,       <span class="hljs-comment">// 边录边转模式</span>
    };
  }
}
</code></pre>
<p><strong>关键技术点</strong>：</p>
<h5 data-id="heading-6">1) 音频节点创建</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建音频分析节点</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">analyser</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">createAnalyser</span>();
<span class="hljs-variable language_">this</span>.<span class="hljs-property">analyser</span>.<span class="hljs-property">fftSize</span> = <span class="hljs-number">2048</span>;

<span class="hljs-comment">// 创建脚本处理节点（每采集4096个样本触发一次）</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">recorder</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">createScriptProcessor</span>(<span class="hljs-number">4096</span>, numChannels, numChannels);
</code></pre>
<p><strong>为什么选择 4096？</strong></p>
<ul>
<li>平衡延迟和性能</li>
<li>4096 样本 ≈ 95ms（44.1kHz采样率下）</li>
<li>适合实时处理场景</li>
</ul>
<h5 data-id="heading-7">2) 音频数据采集</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">recorder</span>.<span class="hljs-property">onaudioprocess</span> = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
  <span class="hljs-comment">// 获取左声道PCM数据（Float32Array，范围[-1, 1]）</span>
  <span class="hljs-keyword">let</span> lData = e.<span class="hljs-property">inputBuffer</span>.<span class="hljs-title function_">getChannelData</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// 存储原始数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lBuffer</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(lData));
  
  <span class="hljs-comment">// 边录边转：立即转换为PCM格式</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">compiling</span>) {
    <span class="hljs-keyword">let</span> pcm = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transformIntoPCM</span>(lData, rData);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tempPCM</span>.<span class="hljs-title function_">push</span>(pcm);
  }
};
</code></pre>
<h5 data-id="heading-8">3) PCM 编码原理</h5>
<p>PCM（Pulse Code Modulation）是音频的原始数字表示形式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">encodePCM</span>(<span class="hljs-params">bytes, sampleBits, littleEdian = <span class="hljs-literal">true</span></span>) {
  <span class="hljs-comment">// Float32Array [-1, 1] → Int16 [-32768, 32767]</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; bytes.<span class="hljs-property">length</span>; i++, offset += <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">let</span> s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(-<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, bytes[i]));
    <span class="hljs-comment">// 负数 * 32768，正数 * 32767</span>
    data.<span class="hljs-title function_">setInt16</span>(offset, s &lt; <span class="hljs-number">0</span> ? s * <span class="hljs-number">0x8000</span> : s * <span class="hljs-number">0x7FFF</span>, littleEdian);
  }
}
</code></pre>




















<table><thead><tr><th>采样位数</th><th>范围</th><th>计算公式</th></tr></thead><tbody><tr><td>8-bit</td><td>[0, 255]</td><td><code>val = s * 128 + 128</code></td></tr><tr><td>16-bit</td><td>[-32768, 32767]</td><td><code>val = s * 32768</code> (负数) / <code>s * 32767</code> (正数)</td></tr></tbody></table>
<h5 data-id="heading-9">4) WAV 文件格式</h5>
<p>WAV = WAV Header (44字节) + PCM 数据</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">encodeWAV</span>(<span class="hljs-params">bytes, sampleRate, numChannels, sampleBits</span>) {
  <span class="hljs-keyword">let</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">44</span> + bytes.<span class="hljs-property">byteLength</span>);
  <span class="hljs-keyword">let</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);
  
  <span class="hljs-comment">// RIFF 标识</span>
  <span class="hljs-title function_">writeString</span>(view, <span class="hljs-number">0</span>, <span class="hljs-string">'RIFF'</span>);
  view.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">4</span>, <span class="hljs-number">36</span> + bytes.<span class="hljs-property">byteLength</span>, <span class="hljs-literal">true</span>);
  <span class="hljs-title function_">writeString</span>(view, <span class="hljs-number">8</span>, <span class="hljs-string">'WAVE'</span>);
  
  <span class="hljs-comment">// fmt 子块</span>
  <span class="hljs-title function_">writeString</span>(view, <span class="hljs-number">12</span>, <span class="hljs-string">'fmt '</span>);
  view.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-literal">true</span>);        <span class="hljs-comment">// 子块大小</span>
  view.<span class="hljs-title function_">setUint16</span>(<span class="hljs-number">20</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);         <span class="hljs-comment">// 音频格式（PCM=1）</span>
  view.<span class="hljs-title function_">setUint16</span>(<span class="hljs-number">22</span>, numChannels, <span class="hljs-literal">true</span>);
  view.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">24</span>, sampleRate, <span class="hljs-literal">true</span>);
  <span class="hljs-comment">// ... 更多头部信息</span>
  
  <span class="hljs-comment">// data 子块</span>
  <span class="hljs-title function_">writeString</span>(view, <span class="hljs-number">36</span>, <span class="hljs-string">'data'</span>);
  view.<span class="hljs-title function_">setUint32</span>(<span class="hljs-number">40</span>, bytes.<span class="hljs-property">byteLength</span>, <span class="hljs-literal">true</span>);
  
  <span class="hljs-comment">// 追加 PCM 数据</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);
}
</code></pre>
<h4 data-id="heading-10">3.3 边录边转实现</h4>
<p><strong>核心流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">录音开始 → onaudioprocess 触发 → 转换PCM → WebSocket发送 → 阿里云ASR
<span class="hljs-code">              ↓                                            ↓
         每4096样本触发                              返回识别结果
</span></code></pre>
<p><strong>关键代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// index.vue 中的处理</span>
<span class="hljs-title function_">processFn</span>(<span class="hljs-params">params</span>) {
  <span class="hljs-keyword">const</span> newBuff = params.<span class="hljs-property">data</span>[params.<span class="hljs-property">data</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];  <span class="hljs-comment">// 获取最新PCM块</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>?.<span class="hljs-property">readyState</span> == <span class="hljs-number">1</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-title function_">send</span>(newBuff);  <span class="hljs-comment">// 实时发送</span>
  }
}
</code></pre>
<h4 data-id="heading-11">3.4 阿里云实时 ASR 集成</h4>
<p><strong>WebSocket 通信协议</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 建立连接</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wsSrc</span>);  <span class="hljs-comment">// wsSrc 从通义拿到的websocket连接地址</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-property">binaryType</span> = <span class="hljs-string">"arraybuffer"</span>; <span class="hljs-comment">//传输的是 ArrayBuffer 类型的数据</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">async</span> () =&gt; {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-property">readyState</span> == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">const</span> params = {
              <span class="hljs-attr">header</span>: {
                <span class="hljs-attr">name</span>: <span class="hljs-string">"StartTranscription"</span>,
                <span class="hljs-attr">namespace</span>: <span class="hljs-string">"SpeechTranscriber"</span>,
              },
              <span class="hljs-attr">payload</span>: { <span class="hljs-attr">format</span>: <span class="hljs-string">"pcm"</span> },
            };
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params));
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WebSocket连接已成功打开"</span>);
            <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">includes</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-property">readyState</span>)) {
            <span class="hljs-title function_">reject</span>(<span class="hljs-literal">false</span>);
          }
        };
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"WebSocket错误:"</span>, err);
          <span class="hljs-title function_">reject</span>(<span class="hljs-literal">false</span>);
        };
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WebSocket连接已关闭"</span>);
          <span class="hljs-comment">// reject(false);</span>
          <span class="hljs-built_in">setTimeout</span>( <span class="hljs-function">()=&gt;</span> {  <span class="hljs-comment">// 简单实现自动重连</span>
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WebSocket 尝试重新连接"</span>);
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">openWs</span>();
          }, <span class="hljs-number">3</span> * <span class="hljs-number">1000</span>);
        };
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsObj</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleMessage</span>(msg);
        };
      });
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 连接建立后发送开始指令</span>
<span class="hljs-keyword">const</span> params = {
  <span class="hljs-attr">header</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"StartTranscription"</span>,
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">"SpeechTranscriber"</span>,
  },
  <span class="hljs-attr">payload</span>: { <span class="hljs-attr">format</span>: <span class="hljs-string">"pcm"</span> },
};
wsObj.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params));

<span class="hljs-comment">// 2. 持续发送音频数据</span>
wsObj.<span class="hljs-title function_">send</span>(pcmData);  <span class="hljs-comment">// ArrayBuffer 格式</span>

<span class="hljs-comment">// 3. 接收识别结果</span>
wsObj.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> dataJson = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(msg.<span class="hljs-property">data</span>);
  <span class="hljs-keyword">switch</span> (dataJson.<span class="hljs-property">header</span>.<span class="hljs-property">name</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"SentenceBegin"</span>:           <span class="hljs-comment">// 句子开始</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"TranscriptionResultChanged"</span>: <span class="hljs-comment">// 实时结果变化</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"SentenceEnd"</span>:             <span class="hljs-comment">// 句子结束</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"ResultTranslated"</span>:        <span class="hljs-comment">// 翻译结果</span>
  }
};
</code></pre>
<p><strong>事件类型说明</strong>：</p>
<p>来源于通义文档，最新请参考通义文档(在文档底部有提供地址)</p>






























<table><thead><tr><th>事件</th><th>说明</th><th>用途</th></tr></thead><tbody><tr><td><code>SentenceBegin</code></td><td>新句子开始</td><td>初始化新句子对象</td></tr><tr><td><code>TranscriptionResultChanged</code></td><td>识别中结果变化</td><td>实时更新显示</td></tr><tr><td><code>SentenceEnd</code></td><td>句子结束</td><td>合并最终结果</td></tr><tr><td><code>ResultTranslated</code></td><td>翻译完成</td><td>显示翻译内容</td></tr></tbody></table>
<h4 data-id="heading-12">3.5 波形可视化实现</h4>
<p>项目提供两种可视化方式：</p>
<p><strong>1) 频率柱状图 (wave.js)</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c74a870cd0f4531a8024a82fcc2f4db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGx5Ynl0ZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770895465&amp;x-signature=qHsNjABXZ29eq%2B0KgXQHgNeiFYk%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WaveformVisualizer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">canvas, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = canvas;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span> = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);

    <span class="hljs-comment">// 默认配置</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">barWidth</span>: options.<span class="hljs-property">barWidth</span> || <span class="hljs-number">5</span>,
      <span class="hljs-attr">barSpacing</span>: options.<span class="hljs-property">barSpacing</span> || <span class="hljs-number">2</span>,
      <span class="hljs-attr">minHeight</span>: options.<span class="hljs-property">minHeight</span> || <span class="hljs-number">5</span>, <span class="hljs-comment">// 最小高度百分比</span>
      <span class="hljs-attr">amplification</span>: options.<span class="hljs-property">amplification</span> || <span class="hljs-number">3</span>, <span class="hljs-comment">// 放大倍数</span>
      <span class="hljs-attr">smoothing</span>: options.<span class="hljs-property">smoothing</span> || <span class="hljs-number">0.7</span>, <span class="hljs-comment">// 平滑度 (0-1)</span>
      <span class="hljs-attr">barColor</span>: options.<span class="hljs-property">barColor</span> || <span class="hljs-string">'#4d79ff'</span>,
      <span class="hljs-attr">gradientColor</span>: options.<span class="hljs-property">gradientColor</span> || <span class="hljs-string">'#ff4d4d'</span>
    };

    <span class="hljs-comment">// 状态变量</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationId</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentData</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">1024</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">smoothedData</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-number">1024</span>);

    <span class="hljs-comment">// 初始化Canvas尺寸</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resizeCanvas</span>();
    <span class="hljs-comment">// window.addEventListener('resize', () =&gt; this.resizeCanvas());</span>
  }

  <span class="hljs-comment">// 调整Canvas尺寸</span>
  <span class="hljs-title function_">resizeCanvas</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">offsetWidth</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">offsetHeight</span>;
  }

  <span class="hljs-comment">// 更新配置</span>
  <span class="hljs-title function_">updateConfig</span>(<span class="hljs-params">newConfig</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>, ...newConfig };
  }

  <span class="hljs-comment">// 设置数据</span>
  <span class="hljs-title function_">setData</span>(<span class="hljs-params">dataArray</span>) {
    <span class="hljs-keyword">if</span> (dataArray &amp;&amp; dataArray.<span class="hljs-property">length</span> === <span class="hljs-number">1024</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentData</span> = dataArray;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentData</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">1024</span>);
    }
  }

  <span class="hljs-comment">// 处理数据 - 增强波动效果</span>
  <span class="hljs-title function_">processData</span>(<span class="hljs-params">dataArray</span>) {
    <span class="hljs-keyword">const</span> { amplification, smoothing } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    <span class="hljs-keyword">const</span> processedData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">1024</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataArray.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 应用放大倍数</span>
      <span class="hljs-keyword">let</span> value = dataArray[i] * amplification;

      <span class="hljs-comment">// 应用平滑处理</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">smoothedData</span>[i] = smoothing * <span class="hljs-variable language_">this</span>.<span class="hljs-property">smoothedData</span>[i] + (<span class="hljs-number">1</span> - smoothing) * value;

      <span class="hljs-comment">// 确保值在0-255范围内</span>
      processedData[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">smoothedData</span>[i]));
    }

    <span class="hljs-keyword">return</span> processedData;
  }

  <span class="hljs-comment">// 绘制波形</span>
  <span class="hljs-title function_">draw</span>(<span class="hljs-params">dataArray = <span class="hljs-variable language_">this</span>.currentData</span>) {
    <span class="hljs-keyword">const</span> { barWidth, barSpacing, minHeight, barColor, gradientColor } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
    <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>;
    <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>;

    <span class="hljs-comment">// 清除画布</span>
    ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span>);

    <span class="hljs-comment">// 绘制中心线</span>
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, centerY);
    ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span>, centerY);
    ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'rgba(255, 255, 255, 0.2)'</span>;
    ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">1</span>;
    ctx.<span class="hljs-title function_">stroke</span>();

    <span class="hljs-comment">// 计算每个柱子的总宽度（柱子宽度+间距）</span>
    <span class="hljs-keyword">const</span> totalBarWidth = barWidth + barSpacing;

    <span class="hljs-comment">// 计算可以绘制的柱子数量</span>
    <span class="hljs-keyword">const</span> maxBars = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span> / totalBarWidth);

    <span class="hljs-comment">// 创建渐变</span>
    <span class="hljs-keyword">const</span> gradient = ctx.<span class="hljs-title function_">createLinearGradient</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span>, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 水平方向</span>
    gradient.<span class="hljs-title function_">addColorStop</span>(<span class="hljs-number">0</span>, barColor);
    gradient.<span class="hljs-title function_">addColorStop</span>(<span class="hljs-number">0.5</span>, gradientColor);
    gradient.<span class="hljs-title function_">addColorStop</span>(<span class="hljs-number">1</span>, barColor);

    <span class="hljs-comment">// 计算最小高度（基于画布高度的百分比）</span>
    <span class="hljs-keyword">const</span> minHeightPixels = (minHeight / <span class="hljs-number">100</span>) * centerY;

    <span class="hljs-comment">// 处理数据以增强波动效果</span>
    <span class="hljs-keyword">const</span> processedData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processData</span>(dataArray);

    <span class="hljs-comment">// 绘制柱子  水平方向渐变</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxBars &amp;&amp; i &lt; processedData.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 计算柱子的x位置</span>
      <span class="hljs-keyword">const</span> x = i * totalBarWidth;

      <span class="hljs-comment">// 获取处理后的数据值</span>
      <span class="hljs-keyword">const</span> value = processedData[i];

      <span class="hljs-comment">// 计算实际高度，确保不低于最小高度</span>
      <span class="hljs-keyword">const</span> dynamicHeight = (value / <span class="hljs-number">255</span>) * (centerY - <span class="hljs-number">20</span>);
      <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(minHeightPixels, dynamicHeight);

      <span class="hljs-comment">// 绘制上下对称的柱子</span>
      ctx.<span class="hljs-property">fillStyle</span> = gradient;
      ctx.<span class="hljs-title function_">fillRect</span>(x, centerY - height, barWidth, height * <span class="hljs-number">2</span>);
    }
  }

  <span class="hljs-comment">// 开始绘制</span>
  <span class="hljs-title function_">start</span>(<span class="hljs-params">dataGenerator, interval = <span class="hljs-number">100</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">drawFrame</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 获取数据并绘制</span>
      <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">dataGenerator</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>(data);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">draw</span>(data);

      <span class="hljs-comment">// 继续动画</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationId</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">requestAnimationFrame</span>(drawFrame);
      }, interval);
    };

    <span class="hljs-title function_">drawFrame</span>();
  }

  <span class="hljs-comment">// 停止绘制</span>
  <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDrawing</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationId</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">animationId</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationId</span> = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 清除画布</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span>);

    <span class="hljs-comment">// 绘制停止状态文本</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(255, 255, 255, 0.7)'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">font</span> = <span class="hljs-string">'24px Arial'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'已停止绘制'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>);
  }
}

<span class="hljs-comment">// 模拟录音数据生成器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDataGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> frameCount = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> dataArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">1024</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataArray.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 基础噪声</span>
      <span class="hljs-keyword">let</span> value = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">20</span>;

      <span class="hljs-comment">// 添加一些周期性波形</span>
      value += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(i / <span class="hljs-number">20</span> + frameCount / <span class="hljs-number">20</span>) * <span class="hljs-number">30</span>;
      value += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(i / <span class="hljs-number">5</span> + frameCount / <span class="hljs-number">10</span>) * <span class="hljs-number">10</span>;

      <span class="hljs-comment">// 随机峰值</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.97</span>) {
        value += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>;
      }

      <span class="hljs-comment">// 确保值在0-255范围内</span>
      dataArray[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, value));
    }

    frameCount++;
    <span class="hljs-keyword">return</span> dataArray;
  };
}

<span class="hljs-comment">// 无声数据生成器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createSilenceDataGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-comment">// 返回全0数组模拟无声</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">1024</span>);
  };
}

<span class="hljs-keyword">export</span> {
  <span class="hljs-title class_">WaveformVisualizer</span>,
  createDataGenerator,
  createSilenceDataGenerator
}
</code></pre>
<p><strong>2) 时域波形 (waveTimeDomain.js)</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">draw</span>(<span class="hljs-params">dataArray</span>) {
  <span class="hljs-comment">// 转换数据范围 [0, 255] → [-1, 1]</span>
  <span class="hljs-keyword">let</span> value = (dataArray[i] - <span class="hljs-number">128</span>) / <span class="hljs-number">128</span>;
  
  <span class="hljs-comment">// 绘制连续波形线</span>
  ctx.<span class="hljs-title function_">beginPath</span>();
  ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, firstY);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; processedData.<span class="hljs-property">length</span>; i++) {
    ctx.<span class="hljs-title function_">lineTo</span>(x, y);
  }
  ctx.<span class="hljs-title function_">stroke</span>();
}
</code></pre>
<h3 data-id="heading-13">四、使用步骤</h3>
<h4 data-id="heading-14">4.1 基础录音</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Recorder</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"js-audio-recorder"</span>;

<span class="hljs-comment">// 1. 创建实例</span>
<span class="hljs-keyword">const</span> recorder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Recorder</span>({
  <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span>,
  <span class="hljs-attr">sampleBits</span>: <span class="hljs-number">16</span>,
  <span class="hljs-attr">numChannels</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">compiling</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启边录边转</span>
});

<span class="hljs-comment">// 2. 监听处理事件</span>
recorder.<span class="hljs-property">onprogress</span> = <span class="hljs-function">(<span class="hljs-params">{ duration, fileSize, vol, data }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`录音时长: <span class="hljs-subst">${duration}</span>秒`</span>);
};

<span class="hljs-comment">// 3. 开始录音</span>
<span class="hljs-keyword">await</span> recorder.<span class="hljs-title function_">start</span>();

<span class="hljs-comment">// 4. 暂停/继续</span>
recorder.<span class="hljs-title function_">pause</span>();
recorder.<span class="hljs-title function_">resume</span>();

<span class="hljs-comment">// 5. 停止并获取WAV</span>
recorder.<span class="hljs-title function_">stop</span>();
<span class="hljs-keyword">const</span> blob = recorder.<span class="hljs-title function_">getWAVBlob</span>();

<span class="hljs-comment">// 6. 销毁</span>
<span class="hljs-keyword">await</span> recorder.<span class="hljs-title function_">destroy</span>();
</code></pre>
<h4 data-id="heading-15">4.2 集成实时转写</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 建立WebSocket连接</span>
<span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'wss://your-asr-service.com'</span>);
ws.<span class="hljs-property">binaryType</span> = <span class="hljs-string">'arraybuffer'</span>;

<span class="hljs-comment">// 2. 发送开始指令</span>
ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
  <span class="hljs-attr">header</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"StartTranscription"</span>, <span class="hljs-attr">namespace</span>: <span class="hljs-string">"SpeechTranscriber"</span> },
  <span class="hljs-attr">payload</span>: { <span class="hljs-attr">format</span>: <span class="hljs-string">"pcm"</span> }
}));

<span class="hljs-comment">// 3. 实时发送音频</span>
recorder.<span class="hljs-property">onprogress</span> = <span class="hljs-function">(<span class="hljs-params">{ data }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> latestPCM = data[data.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
  ws.<span class="hljs-title function_">send</span>(latestPCM);
};

<span class="hljs-comment">// 4. 接收识别结果</span>
ws.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(msg.<span class="hljs-property">data</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">payload</span>.<span class="hljs-property">result</span>);
};
</code></pre>
<h3 data-id="heading-16">五、性能优化策略</h3>
<h4 data-id="heading-17">5.1 采样率压缩</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">data, inputSampleRate, outputSampleRate</span>) {
  <span class="hljs-keyword">const</span> rate = inputSampleRate / outputSampleRate;
  <span class="hljs-comment">// 48kHz → 16kHz：每隔3个样本取1个</span>
  <span class="hljs-keyword">while</span> (index &lt; length) {
    result[index] = lData[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(j)];
    j += rate;
  }
}
</code></pre>
<h4 data-id="heading-18">5.2 内存管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 录音结束后及时清理</span>
<span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lBuffer</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">rBuffer</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">PCM</span> = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 销毁时关闭音频上下文</span>
<span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopStream</span>();  <span class="hljs-comment">// 停止媒体流</span>
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">closeAudioContext</span>();  <span class="hljs-comment">// 关闭音频上下文</span>
}
</code></pre>
<h4 data-id="heading-19">5.3 波形绘制优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化绘制：减少数据点</span>
<span class="hljs-keyword">const</span> step = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(processedData.<span class="hljs-property">length</span> / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>));
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; processedData.<span class="hljs-property">length</span>; i += step) {
  <span class="hljs-comment">// 只绘制关键帧</span>
}
</code></pre>
<h3 data-id="heading-20">六、浏览器兼容性</h3>








































<table><thead><tr><th>特性</th><th>Chrome</th><th>Firefox</th><th>Safari</th><th>Edge</th></tr></thead><tbody><tr><td>getUserMedia</td><td>49+</td><td>44+</td><td>11+</td><td>79+</td></tr><tr><td>AudioContext</td><td>35+</td><td>25+</td><td>14.1+</td><td>79+</td></tr><tr><td>ScriptProcessorNode</td><td>14+</td><td>23+</td><td>6+</td><td>12+</td></tr><tr><td>WebSocket</td><td>16+</td><td>11+</td><td>7.1+</td><td>12+</td></tr></tbody></table>
<p><strong>注意事项</strong>：</p>
<ul>
<li>Safari 需要 HTTPS 环境</li>
<li>iOS Safari 有特殊的音频策略</li>
<li>部分浏览器需要用户交互后才能录音</li>
</ul>
<p>本地开发时解决非https不允许录音问题</p>
<p>由于chrome限制，因安全原因，不允许非安全环境下使用录音权限，这里可以通过配置chrome来解决
浏览器地址栏输入<code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58654e960404f60982e1dfecdf5040a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGx5Ynl0ZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770895465&amp;x-signature=Oq2e49BVleIlCRlGv2oyJOFWcvI%3D" alt="image.png" loading="lazy"/>
启用后，重启浏览器即可解决</p>
<h3 data-id="heading-21">七、总结</h3>
<p>这个项目展示了如何利用浏览器原生能力构建一个功能完整的录音工具：</p>
<ol>
<li><strong>Web Audio API</strong> 提供强大的音频处理能力</li>
<li><strong>边录边转</strong> 模式实现实时语音识别</li>
<li><strong>WebSocket</strong> 实现低延迟的双向通信</li>
<li><strong>Canvas</strong> 实现流畅的波形可视化</li>
</ol>
<p><strong>关键技术要点</strong>：</p>
<ul>
<li>PCM 数据的编码与格式转换</li>
<li>音频节点的连接与数据流转</li>
<li>阿里云 ASR 协议的正确实现</li>
<li>内存管理和性能优化</li>
</ul>
<hr/>
<p><strong>参考链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWeb_Audio_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Audio_API" ref="nofollow noopener noreferrer">Web Audio API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ftingwu%2Finterface-and-implementation" target="_blank" title="https://help.aliyun.com/zh/tingwu/interface-and-implementation" ref="nofollow noopener noreferrer">阿里云听悟接口文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fjs-audio-recorder" target="_blank" title="https://www.npmjs.com/package/js-audio-recorder" ref="nofollow noopener noreferrer">js-audio-recorder - npm</a>record.js第三方库推荐</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Vue3项目中如何取消重复请求？]]></title>    <link>https://juejin.cn/post/7603183929251708980</link>    <guid>https://juejin.cn/post/7603183929251708980</guid>    <pubDate>2026-02-05T12:03:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603183929251708980" data-draft-id="7602991346585714722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Vue3项目中如何取消重复请求？"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2026-02-05T12:03:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3905133219288"/> <meta itemprop="url" content="https://juejin.cn/user/3609051079121550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Vue3项目中如何取消重复请求？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609051079121550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3905133219288
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T12:03:36.000Z" title="Thu Feb 05 2026 12:03:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天我们来聊聊一个实际开发中常见的问题：在Vue3项目中，如何取消重复的请求。</p>
<h2 data-id="heading-0">为什么需要取消重复请求？</h2>
<p>这样做有几个明显的好处：</p>
<ol>
<li> <strong>节省资源</strong>：释放浏览器连接，减轻服务器压力。</li>
<li> <strong>保证数据正确性</strong>：避免因请求响应顺序错乱导致页面显示旧数据。</li>
<li> <strong>提升用户体验</strong>：防止无效请求阻塞后续有效操作。</li>
</ol>
<p>在Vue3的生态中，我们最常用的HTTP客户端是 <code>axios</code>。因此，本文的核心将围绕如何使用 <code>axios</code> 的取消令牌（CancelToken）及其更现代的替代品——AbortController——来实现请求取消。</p>
<hr/>
<h2 data-id="heading-1">方案一：使用 Axios 的 CancelToken</h2>
<p><code>axios</code> 从很早就支持通过 <code>CancelToken</code> 来取消请求。虽然它在 <code>axios</code> v0.22.0 之后被标记为已弃用，转而推荐使用标准的 <code>AbortController</code>，但很多现有项目仍在使用这个API，所以我们有必要了解一下。
它的工作原理是：创建一个“取消令牌”的源（source），将这个令牌配置到请求中。当我们需要取消请求时，调用这个源的 <code>cancel</code> 方法。</p>
<h3 data-id="heading-2">基本使用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 创建一个 CancelToken Source</span>
<span class="hljs-keyword">const</span> source = axios.<span class="hljs-property">CancelToken</span>.<span class="hljs-title function_">source</span>();

<span class="hljs-comment">// 2. 发起请求，并配置 cancelToken</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/123'</span>, {
  <span class="hljs-attr">cancelToken</span>: source.<span class="hljs-property">token</span>
}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">data</span>);
}).<span class="hljs-keyword">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">thrown</span>) {
  <span class="hljs-comment">// 判断错误是否是因为请求被取消</span>
  <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(thrown)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, thrown.<span class="hljs-property">message</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 处理其他错误</span>
  }
});

<span class="hljs-comment">// 3. 在需要的时候取消请求</span>
source.<span class="hljs-title function_">cancel</span>(<span class="hljs-string">'操作被用户取消'</span>);
</code></pre>
<h3 data-id="heading-3">在Vue3组件中管理重复请求</h3>
<p>在实际项目中，我们通常需要一种机制来管理“同一个”重复请求。一个常见的思路是：<strong>将每个请求的唯一标识（例如：请求方法+URL）和一个取消函数关联起来，在发起新请求前，检查并取消旧的、未完成的相同请求。</strong></p>
<p>我们可以利用Vue3的响应式系统和组合式API，封装一个可复用的逻辑。</p>
<p>首先，我们创建一个用于存储所有进行中请求的Map，以及相关的操作函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 存储所有进行中请求的Map</span>
<span class="hljs-keyword">const</span> pendingRequestMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">/**
 * 生成请求的唯一标识键
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} config axios的请求配置对象
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 唯一键
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateReqKey</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> { method, url, params, data } = config;
  <span class="hljs-comment">// 简单拼接，可根据业务复杂化（如对data排序）</span>
  <span class="hljs-keyword">return</span> [method, url, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params), <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)].<span class="hljs-title function_">join</span>(<span class="hljs-string">'&amp;'</span>);
}

<span class="hljs-comment">/**
 * 添加请求到等待队列
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} config axios的请求配置对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addPendingRequest</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> requestKey = <span class="hljs-title function_">generateReqKey</span>(config);
  <span class="hljs-comment">// 为这个请求创建一个取消令牌源</span>
  config.<span class="hljs-property">cancelToken</span> = config.<span class="hljs-property">cancelToken</span> || <span class="hljs-keyword">new</span> axios.<span class="hljs-title class_">CancelToken</span>(<span class="hljs-function">(<span class="hljs-params">cancel</span>) =&gt;</span> {
    <span class="hljs-comment">// 如果Map中还没有这个key，则添加进去</span>
    <span class="hljs-keyword">if</span> (!pendingRequestMap.<span class="hljs-title function_">has</span>(requestKey)) {
      pendingRequestMap.<span class="hljs-title function_">set</span>(requestKey, cancel);
    }
  });
}

<span class="hljs-comment">/**
 * 移除等待队列中的请求
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} config axios的请求配置对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">removePendingRequest</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> requestKey = <span class="hljs-title function_">generateReqKey</span>(config);
  <span class="hljs-keyword">if</span> (pendingRequestMap.<span class="hljs-title function_">has</span>(requestKey)) {
    <span class="hljs-comment">// 如果在Map中存在这个请求，说明它还未完成，将其取消并从Map中移除</span>
    <span class="hljs-keyword">const</span> cancel = pendingRequestMap.<span class="hljs-title function_">get</span>(requestKey);
    <span class="hljs-title function_">cancel</span>(requestKey); <span class="hljs-comment">// 取消请求，可以传递消息</span>
    pendingRequestMap.<span class="hljs-title function_">delete</span>(requestKey);
  }
}

<span class="hljs-comment">// 创建axios实例</span>
<span class="hljs-keyword">const</span> service = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
});

<span class="hljs-comment">// 请求拦截器：在请求发出前，检查并取消重复请求</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// 检查并取消之前的相同请求</span>
    <span class="hljs-title function_">removePendingRequest</span>(config);
    <span class="hljs-comment">// 将当前请求添加到等待队列</span>
    <span class="hljs-title function_">addPendingRequest</span>(config);
    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-comment">// 响应拦截器：请求完成后（无论成功失败），将其从等待队列中移除</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-title function_">removePendingRequest</span>(response.<span class="hljs-property">config</span>);
    <span class="hljs-keyword">return</span> response;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-comment">// 如果错误是因为取消请求造成的，我们选择忽略这个错误，不抛出到业务层</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'已取消的重复请求:'</span>, error.<span class="hljs-property">message</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">() =&gt;</span> {}); <span class="hljs-comment">// 返回一个“永远pending”的Promise，中断Promise链</span>
    }
    <span class="hljs-comment">// 对于其他错误，移除请求并正常抛出</span>
    <span class="hljs-title function_">removePendingRequest</span>(error.<span class="hljs-property">config</span> || {});
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> service;
</code></pre>
<p>然后，在Vue组件中，你可以直接使用这个封装好的 <code>service</code> 来发起请求。它会自动处理重复请求的取消。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;script setup&gt;
import { ref } from 'vue'<span class="hljs-comment">;</span>
import request from '@/utils/request'<span class="hljs-comment">;</span>

const <span class="hljs-attr">searchResults</span> = ref([])<span class="hljs-comment">;</span>
const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">handleSearch</span> = async (keyword) =&gt; {
  <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  try {
    const <span class="hljs-attr">response</span> = await request.get(<span class="hljs-string">'/api/search'</span>, {
      params: { keyword }
    })<span class="hljs-comment">;</span>
    <span class="hljs-attr">searchResults.value</span> = response.data<span class="hljs-comment">;</span>
  } catch (error) {
    // 这里不会捕获到因重复请求被取消而抛出的错误，因为我们在拦截器中已经处理了
    console.error('搜索失败:', error)<span class="hljs-comment">;</span>
  } finally {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>注意</strong>：<code>CancelToken</code> 方式在 <code>axios</code> 新版本中已被标记为弃用。对于新项目，建议直接使用下面介绍的更现代的 <code>AbortController</code> 方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">方案二： AbortController</h2>
<p><code>AbortController</code> 是一个现代的Web API，它提供了一种更通用、更标准的方式来中止一个或多个Web请求。<code>fetch</code> API 和新的 <code>axios</code> 版本都原生支持它。使用 <code>AbortController</code> 是当前推荐的做法。</p>
<h3 data-id="heading-5">基本概念</h3>
<ul>
<li>• <code>AbortController</code>：控制器对象，用于触发中止信号。</li>
<li>• <code>AbortSignal</code>：信号对象，关联到具体的请求上。控制器可以通过它来通知请求“需要中止”。</li>
</ul>
<h3 data-id="heading-6">基本使用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建一个 AbortController 实例</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>; <span class="hljs-comment">// 获取它的 signal</span>

<span class="hljs-comment">// 2. 发起 fetch 请求，并将 signal 关联上去</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/some-data'</span>, { signal })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-comment">// 如果错误是因为请求被中止</span>
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetch 请求被中止'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'其他错误:'</span>, err);
    }
  });

<span class="hljs-comment">// 3. 在需要的时候中止请求</span>
controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 这会触发 signal 的中止事件，从而取消请求</span>
</code></pre>
<h3 data-id="heading-7">在 Axios 中使用 AbortController</h3>
<p>从 <code>axios</code> v0.22.0 开始，你可以使用 <code>signal</code> 属性来配置 <code>AbortSignal</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/123'</span>, {
  <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> <span class="hljs-comment">// 将 signal 传递给请求配置</span>
}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">data</span>);
}).<span class="hljs-keyword">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) {
  <span class="hljs-comment">// 判断错误是否是因为请求被取消</span>
  <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 处理其他错误</span>
  }
});

<span class="hljs-comment">// 取消请求</span>
controller.<span class="hljs-title function_">abort</span>();
</code></pre>
<h3 data-id="heading-8">封装基于 AbortController 的重复请求取消</h3>
<p>我们可以用类似的思路，用 <code>AbortController</code> 重构之前的工具函数。主要变化是将存储的 <code>cancel</code> 函数替换为 <code>AbortController</code> 实例。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request-abort.js</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-keyword">const</span> pendingRequestMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateReqKey</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> { method, url, params, data } = config;
  <span class="hljs-keyword">return</span> [method, url, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params), <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)].<span class="hljs-title function_">join</span>(<span class="hljs-string">'&amp;'</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">addPendingRequest</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> requestKey = <span class="hljs-title function_">generateReqKey</span>(config);
  <span class="hljs-comment">// 如果已有相同请求在进行，则中止它</span>
  <span class="hljs-keyword">if</span> (pendingRequestMap.<span class="hljs-title function_">has</span>(requestKey)) {
    <span class="hljs-keyword">const</span> oldController = pendingRequestMap.<span class="hljs-title function_">get</span>(requestKey);
    oldController.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 中止旧的请求</span>
    pendingRequestMap.<span class="hljs-title function_">delete</span>(requestKey);
  }
  <span class="hljs-comment">// 为当前请求创建新的控制器并存储</span>
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  config.<span class="hljs-property">signal</span> = controller.<span class="hljs-property">signal</span>; <span class="hljs-comment">// 关键：将 signal 赋给请求配置</span>
  pendingRequestMap.<span class="hljs-title function_">set</span>(requestKey, controller);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">removePendingRequest</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> requestKey = <span class="hljs-title function_">generateReqKey</span>(config);
  <span class="hljs-keyword">if</span> (pendingRequestMap.<span class="hljs-title function_">has</span>(requestKey)) {
    <span class="hljs-comment">// 请求完成，直接从Map中移除即可，不需要手动abort</span>
    pendingRequestMap.<span class="hljs-title function_">delete</span>(requestKey);
  }
}

<span class="hljs-keyword">const</span> service = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
});

service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-title function_">removePendingRequest</span>(config); <span class="hljs-comment">// 先移除可能存在的旧记录（清理作用）</span>
    <span class="hljs-title function_">addPendingRequest</span>(config); <span class="hljs-comment">// 添加新请求</span>
    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-title function_">removePendingRequest</span>(response.<span class="hljs-property">config</span>);
    <span class="hljs-keyword">return</span> response;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-comment">// 判断错误是否由取消请求导致</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'已取消的重复请求:'</span>, error.<span class="hljs-property">message</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">() =&gt;</span> {}); <span class="hljs-comment">// 中断Promise链</span>
    }
    <span class="hljs-title function_">removePendingRequest</span>(error.<span class="hljs-property">config</span> || {});
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> service;
</code></pre>
<p>这个版本的逻辑更清晰：<strong>在添加新请求时，直接中止旧的相同请求</strong>。响应拦截器里只需要做清理工作。</p>
<hr/>
<h2 data-id="heading-9">进阶与优化</h2>
<p>上面的方案解决了核心问题，但在实际项目中，我们可能还需要考虑更多细节。</p>
<h3 data-id="heading-10">1. 白名单控制</h3>
<p>有些请求我们可能不希望被自动取消。例如，一个轮询定时请求，或者多个并行的不同数据请求。我们可以通过给请求配置添加一个自定义标记（如 <code>allowRepeat: true</code>）来实现白名单。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 在拦截器中</span>
service.interceptors.request.<span class="hljs-built_in">use</span>(
  (config) =&gt; {
    <span class="hljs-comment">// 如果配置了允许重复，则跳过取消逻辑</span>
    <span class="hljs-keyword">if</span> (config.allowRepeat) {
      <span class="hljs-keyword">return</span> config;
    }
    <span class="hljs-built_in">removePendingRequest</span>(config);
    <span class="hljs-built_in">addPendingRequest</span>(config);
    <span class="hljs-keyword">return</span> config;
  }
);

<span class="hljs-comment">// 在组件中使用</span>
request.<span class="hljs-built_in">get</span>(<span class="hljs-string">'/api/polling'</span>, { allowRepeat: <span class="hljs-literal">true</span> });
</code></pre>
<h3 data-id="heading-11">2. 与 Vue Router 导航守卫结合</h3>
<p>当用户切换页面时，我们通常希望取消所有未完成的请求，以免它们在后台继续运行并可能更新一个已经销毁的组件状态。这可以在Vue Router的全局前置守卫中实现。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// router/index.js</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>;
<span class="hljs-keyword">import</span> { pendingRequestMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request-abort'</span>; <span class="hljs-comment">// 需要将map导出</span>

router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 遍历并中止所有进行中的请求</span>
  pendingRequestMap.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">controller, key</span>) =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>(<span class="hljs-string">`路由跳转至 <span class="hljs-subst">${to.path}</span>`</span>);
  });
  <span class="hljs-comment">// 清空Map</span>
  pendingRequestMap.<span class="hljs-title function_">clear</span>();
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<h3 data-id="heading-12">3. 使用 Composition API 封装</h3>
<p>在Vue3中，我们可以利用组合式API，将取消逻辑封装成一个更优雅、可复用的 <code>useRequest</code> Hook。</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useRequest.js
import { ref, onUnmounted } from 'vue'<span class="hljs-comment">;</span>
import request from '@/utils/request-abort'<span class="hljs-comment">;</span>

export function useRequest() {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  let <span class="hljs-attr">abortController</span> = null<span class="hljs-comment">;</span>

  const <span class="hljs-attr">execute</span> = async (config) =&gt; {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
    // 为这次执行创建一个独立的控制器（可选，如果全局已管理则可省略）
    <span class="hljs-attr">abortController</span> = new AbortController()<span class="hljs-comment">;</span>
    try {
      const <span class="hljs-attr">response</span> = await request({
        ...config,
        signal: abortController.signal
      })<span class="hljs-comment">;</span>
      <span class="hljs-attr">data.value</span> = response.data<span class="hljs-comment">;</span>
      return response<span class="hljs-comment">;</span>
    } catch (err) {
      if (!axios.isCancel(err)) {
        <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
      }
      throw err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  // 组件卸载时，取消由这个Hook发起的请求
  onUnmounted(() =&gt; {
    if (abortController) {
      abortController.abort()<span class="hljs-comment">;</span>
    }
  })<span class="hljs-comment">;</span>

  // 提供一个手动取消的方法
  const <span class="hljs-attr">cancel</span> = () =&gt; {
    if (abortController) {
      abortController.abort()<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return {
    data,
    error,
    loading,
    execute,
    cancel
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>在组件中使用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useRequest'</span>;

<span class="hljs-keyword">const</span> { data, loading, execute } = <span class="hljs-title function_">useRequest</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">execute</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/submit'</span>,
    <span class="hljs-attr">data</span>: { <span class="hljs-comment">/* ... */</span> }
  });
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<p>取消重复请求是一个看似简单，但能显著提升应用健壮性的优化点。在Vue3项目中，结合 <code>axios</code> 和 <code>AbortController</code>，我们可以用清晰的代码实现这一功能。希望本文介绍的方法和思路，能帮助你更好地处理项目中的网络请求问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 帮你编译部署鸿蒙应用：harmonyos-build-deploy Skill]]></title>    <link>https://juejin.cn/post/7603183929251954740</link>    <guid>https://juejin.cn/post/7603183929251954740</guid>    <pubDate>2026-02-05T13:10:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603183929251954740" data-draft-id="7603183929251905588" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 帮你编译部署鸿蒙应用：harmonyos-build-deploy Skill "/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T13:10:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="城中的雾"/> <meta itemprop="url" content="https://juejin.cn/user/77390767983908"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 帮你编译部署鸿蒙应用：harmonyos-build-deploy Skill 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/77390767983908/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    城中的雾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T13:10:02.000Z" title="Thu Feb 05 2026 13:10:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这不是一篇教你敲命令的文章。这是一篇关于如何让 AI 成为你的鸿蒙开发助手，帮你完成从编译到部署全流程的实践分享。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb2953a95cac489c9fff8e7aeaf6a8b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=PVAKo1ThDDdrpu3R0C0gUAnfsXw%3D" alt="image-20260205203044086.png" loading="lazy"/></p>
<h2 data-id="heading-0">为什么要做这个 Skill？</h2>
<h3 data-id="heading-1">不是给开发者用的，是给 AI 用的</h3>
<p>传统的 CLI 工具设计理念是：<strong>开发者学习命令 → 开发者执行命令</strong>。</p>
<p>但在 AI Coding 时代，我们有了新的可能：<strong>开发者描述需求 → AI 理解并执行</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2def81b6d21a47309bfe50ed4b73faff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=Czj5R1LmuA9mTds6xOesKRxtKBs%3D" alt="01.001.png" loading="lazy"/></p>
<p><strong>harmonyos-build-deploy</strong> 的设计初心就是：</p>
<blockquote>
<p>让 Claude 能够理解鸿蒙项目，自动完成编译、签名、部署、调试的全流程。开发者只需要用自然语言描述需求。</p>
</blockquote>
<h2 data-id="heading-2">什么是 Claude Code Skill？</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.ai%2Fcode" target="_blank" title="https://claude.ai/code" ref="nofollow noopener noreferrer">Claude Code</a> 是 Anthropic 推出的 AI 编程助手。<strong>Skill</strong> 是一种扩展机制，可以教会 Claude 特定领域的知识和能力。</p>
<p>当你安装了 harmonyos-build-deploy Skill 后，Claude 就具备了：</p>
<ul>
<li>🧠 理解鸿蒙项目结构（HAP/HSP/HAR 模块）</li>
<li>🔧 知道如何使用 hvigorw、hdc、ohpm 等工具</li>
<li>📦 能够分析模块依赖并按正确顺序编译</li>
<li>📱 可以将应用部署到真机并启动</li>
<li>🏪 能够打包 .app 文件用于上架 AppGallery</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c19d43d22b5a44ebbc87b51f7fe3208a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=i2%2B0pt%2BT%2FM1frVBMvtvdJQmEd54%3D" alt="01.1.png" loading="lazy"/></p>
<h2 data-id="heading-3">实际使用场景</h2>
<h3 data-id="heading-4">场景 1：日常开发调试</h3>
<p><strong>你只需要说：</strong></p>
<pre><code class="hljs">帮我编译一下这个鸿蒙项目，部署到手机上运行
</code></pre>
<p><strong>Claude 会自动：</strong></p>
<ol>
<li>识别这是一个鸿蒙项目</li>
<li>调用 <code>npx harmonyos-deploy --all --launch</code></li>
<li>等待编译完成，处理可能的错误</li>
<li>部署到设备并启动应用</li>
<li>向你报告结果</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56550596755444cfa9b446d1fe17a567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=OOJQZoeUEN2vA9lZWdk4q4KkJeA%3D" alt="02.png" loading="lazy"/></p>
<h3 data-id="heading-5">场景 2：切换环境</h3>
<p><strong>你只需要说：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">切换到生产环境，用 release 模式重新打包部署
</code></pre>
<p><strong>Claude 理解后执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npx harmonyos-deploy --all -p production --release --launch
</code></pre>
<h3 data-id="heading-6">场景 3：调试问题</h3>
<p><strong>你只需要说：</strong></p>
<pre><code class="hljs">应用好像有问题，帮我看看设备日志，过滤 NetworkError 相关的
</code></pre>
<p><strong>Claude 会：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npx harmonyos-deploy --log-only --filter NetworkError
</code></pre>
<p>然后帮你分析日志内容，定位问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b825a6a74ae3424db345f1857dcf72cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=fcfLp1lVyVOG%2BTWoU8p27frYU9U%3D" alt="03.png" loading="lazy"/></p>
<h3 data-id="heading-7">场景 4：准备上架</h3>
<p><strong>你只需要说：</strong></p>
<pre><code class="hljs">项目开发完了，帮我打个包准备上架华为应用市场
</code></pre>
<p><strong>Claude 会：</strong></p>
<ol>
<li>使用 release 模式打包 .app 文件</li>
<li>确保 debuggable=false</li>
<li>输出文件路径和大小</li>
<li>告诉你下一步去 AppGallery Connect 上传</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx harmonyos-deploy --app -p production --release -o ./dist
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79520962ad3b4c3dacc31ef4a74d50e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=QNKhLeKIOu5f%2B34O5lbrRcXrpt8%3D" alt="04.png" loading="lazy"/></p>
<h2 data-id="heading-8">AI + Skill 的协作模式</h2>
<h3 data-id="heading-9">传统方式 vs AI Coding</h3>





























<table><thead><tr><th>传统方式</th><th>AI Coding + Skill</th></tr></thead><tbody><tr><td>查文档学习 hvigorw 命令</td><td>直接说"编译项目"</td></tr><tr><td>记忆各种参数组合</td><td>AI 自动选择正确参数</td></tr><tr><td>手动分析编译错误</td><td>AI 解读错误并给出修复建议</td></tr><tr><td>一个个执行命令</td><td>AI 自动串联完整流程</td></tr><tr><td>切换环境要改配置</td><td>说一句话就切换</td></tr></tbody></table>
<h3 data-id="heading-10">Skill 如何工作</h3>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│                        开发者                               │
│                    "帮我编译部署"                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Claude <span class="hljs-selector-tag">Code</span>                            │
│  <span class="hljs-number">1</span>. 理解用户意图：编译 + 部署                                │
│  <span class="hljs-number">2</span>. 识别项目类型：检测到 build-profile<span class="hljs-selector-class">.json5</span> → 鸿蒙项目      │
│  <span class="hljs-number">3</span>. 调用 Skill：harmonyos-build-deploy                      │
│  <span class="hljs-number">4</span>. 执行命令：npx harmonyos-deploy <span class="hljs-attr">--all</span> <span class="hljs-attr">--launch</span>           │
│  <span class="hljs-number">5</span>. 处理结果：成功/失败 → 反馈给用户                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   harmonyos-deploy CLI                      │
│  • ohpm install                                             │
│  • hvigorw assembleHap/assembleHsp                          │
│  • hdc install                                              │
│  • aa start                                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      鸿蒙设备                                │
│                    应用成功运行                              │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec7b964855940a4b99b062e870b7c36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=M7rAbRnY7dSzR4Yy4kYnD9AswpM%3D" alt="02.2.png" loading="lazy"/></p>
<h2 data-id="heading-11">如何开始使用</h2>
<h3 data-id="heading-12">方式 1：在 Claude Code 中安装 Skill</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 skill</span>
/skill install harmonyos-build-deploy
</code></pre>
<p>安装后，Claude 就会在你提到鸿蒙编译、部署、hvigor、hdc 等关键词时自动激活这个 Skill。</p>
<h3 data-id="heading-13">方式 2：直接使用（无需 Skill）</h3>
<p>即使不安装 Skill，你也可以在对话中引导 Claude 使用这个工具：</p>
<pre><code class="hljs">我的项目是鸿蒙应用，请使用 npx harmonyos-deploy 来帮我编译部署
</code></pre>
<h3 data-id="heading-14">方式 3：项目级配置</h3>
<p>在项目根目录创建 <code>.claude/skills/</code> 文件夹，将 Skill 文件放入，Claude 会自动加载。</p>
<h2 data-id="heading-15">触发关键词</h2>
<p>当你在对话中提到以下关键词时，Claude 会自动识别并使用 harmonyos-build-deploy：</p>
<ul>
<li>鸿蒙、HarmonyOS、OpenHarmony</li>
<li>编译、构建、部署、安装</li>
<li>hvigor、hvigorw、hdc</li>
<li>HAP、HSP、HAR</li>
<li>AppGallery、上架</li>
<li>ohpm、hilog</li>
</ul>
<h2 data-id="heading-16">Skill 的技术实现</h2>
<h3 data-id="heading-17">零依赖设计</h3>
<p>整个工具是一个约 1900 行的 Node.js 脚本，不依赖任何第三方 npm 包。这意味着：</p>
<ul>
<li>✅ 无需 <code>npm install</code></li>
<li>✅ 直接 <code>npx</code> 运行</li>
<li>✅ AI 可以立即使用</li>
</ul>
<h3 data-id="heading-18">智能依赖解析</h3>
<p>对于多模块项目，工具会：</p>
<ol>
<li>扫描所有 <code>oh-package.json5</code></li>
<li>解析 dependencies 字段</li>
<li>构建依赖图</li>
<li>拓扑排序得到正确的编译顺序</li>
</ol>

<pre><code class="hljs language-scss" lang="scss">lushu_acommon (无依赖)
    ↓
lushu_appcommon (依赖 acommon)
    ↓
lushu_home, lushu_service... (依赖 acommon + appcommon)
    ↓
entry (HAP，最后编译)
</code></pre>
<h3 data-id="heading-19">错误诊断</h3>
<p>当编译或安装失败时，工具会分析错误并给出修复建议，AI 可以直接将这些信息呈现给你。</p>
<h2 data-id="heading-20">未来展望</h2>
<h3 data-id="heading-21">更深度的 AI 集成</h3>
<ul>
<li>🔮 AI 直接修改代码后自动重新编译部署</li>
<li>🔮 AI 分析运行时日志，自动定位并修复 Bug</li>
<li>🔮 AI 根据测试结果自动优化性能</li>
</ul>
<h3 data-id="heading-22">更完整的 DevOps 支持</h3>
<ul>
<li>🔮 自动化测试集成</li>
<li>🔮 多设备并行部署</li>
<li>🔮 版本管理和发布流程</li>
</ul>
<h2 data-id="heading-23">开源地址</h2>
<ul>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsupermanaaaa%2Fharmonyos-build-deploy" target="_blank" title="https://github.com/supermanaaaa/harmonyos-build-deploy" ref="nofollow noopener noreferrer">github.com/supermanaaa…</a></li>
<li><strong>npm</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fharmonyos-deploy" target="_blank" title="https://www.npmjs.com/package/harmonyos-deploy" ref="nofollow noopener noreferrer">www.npmjs.com/package/har…</a></li>
<li><strong>Claude Skills</strong>: 已提交至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Fpull%2F342" target="_blank" title="https://github.com/anthropics/skills/pull/342" ref="nofollow noopener noreferrer">anthropics/skills</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddff22b034214b15ad1275ac8c2218dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5Lit55qE6Zu-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770901805&amp;x-signature=RKj7QerwF2G9I%2FJ2bGoqolfcnxQ%3D" alt="05.png" loading="lazy"/></p>
<h2 data-id="heading-24">总结</h2>
<p><strong>harmonyos-build-deploy</strong> 不仅仅是一个 CLI 工具，更是连接 <strong>AI 能力</strong> 和 <strong>鸿蒙开发</strong> 的桥梁。</p>
<p>它的存在让 Claude 能够：</p>
<ul>
<li>理解鸿蒙项目的结构和构建流程</li>
<li>执行复杂的多模块编译</li>
<li>处理设备部署和调试</li>
<li>完成应用上架打包</li>
</ul>
<p>而你只需要：</p>
<ul>
<li>用自然语言描述需求</li>
<li>让 AI 帮你完成剩下的工作</li>
</ul>
<p><strong>这就是 AI Coding 时代的开发方式。</strong></p>
<hr/>
<blockquote>
<p>作者：supermanaaaa</p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsupermanaaaa%2Fharmonyos-build-deploy" target="_blank" title="https://github.com/supermanaaaa/harmonyos-build-deploy" ref="nofollow noopener noreferrer">github.com/supermanaaa…</a></p>
<p>如果这个 Skill 对你有帮助，请给个 ⭐️ Star 支持一下！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在web应用中使用高德地图的能力]]></title>    <link>https://juejin.cn/post/7603195960254709760</link>    <guid>https://juejin.cn/post/7603195960254709760</guid>    <pubDate>2026-02-05T13:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603195960254709760" data-draft-id="7602512064977584191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在web应用中使用高德地图的能力"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T13:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FanetheDivine"/> <meta itemprop="url" content="https://juejin.cn/user/4246761716322491"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在web应用中使用高德地图的能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4246761716322491/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FanetheDivine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T13:41:51.000Z" title="Thu Feb 05 2026 13:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基础知识</h2>
<p>高德地图使用GCJ-02坐标 是经过加密变换后的坐标系统 与百度地图/GPS的坐标有所不同</p>
<p>可以使用<code>AMap.convertFrom</code>将GPS转化为高德坐标</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Ftools%2Fpicker" target="_blank" title="https://lbs.amap.com/tools/picker" ref="nofollow noopener noreferrer">官方坐标拾取工具</a></p>
<h2 data-id="heading-1">前期准备</h2>
<p>登录<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2F" target="_blank" title="https://lbs.amap.com/" ref="nofollow noopener noreferrer">高德开放平台</a>后在<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.amap.com%2Fdev%2Fkey%2Fapp" target="_blank" title="https://console.amap.com/dev/key/app" ref="nofollow noopener noreferrer">控制台</a>创建应用、添加key 选择<code>Web端(JS API)</code> 并得到key和安全密钥</p>
<p>接下来 参考<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fguide%2Fabc%2Famap-react" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/guide/abc/amap-react" ref="nofollow noopener noreferrer">文档</a>在react构建地图组件</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">FC</span>, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AMapLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@amap/amap-jsapi-loader'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MapContainer</span>: <span class="hljs-variable constant_">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> mapRef = useRef&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">createMap</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">map</span>) =&gt;</span> (mapRef.<span class="hljs-property">current</span> = map))
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      mapRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">destroy</span>()
    }
  }, [])

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'container'</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'h-full w-full overflow-hidden'</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">MapContainer</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createMap</span>(<span class="hljs-params"/>) {
  ;(<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">_AMapSecurityConfig</span> = {
    <span class="hljs-attr">securityJsCode</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 安全密钥</span>
  }
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">AMap</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AMapLoader</span>.<span class="hljs-title function_">load</span>({
    <span class="hljs-attr">key</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// key</span>
    <span class="hljs-attr">version</span>: <span class="hljs-string">'2.0'</span>,
    <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'AMap.Scale'</span>],
  })
  <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'container'</span>, {
    <span class="hljs-attr">viewMode</span>: <span class="hljs-string">'2D'</span>,
    <span class="hljs-attr">zoom</span>: <span class="hljs-number">11</span>,
    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.397428</span>, <span class="hljs-number">39.90923</span>],
  })
  <span class="hljs-keyword">return</span> map
}
</code></pre>
<p>接下来将聚焦于<code>AMap.Map</code>类 在构造map实例时可以添加其他地图能力 实例本身也有函数对地图进行操作 也可以监听其中的事件</p>
<p>完整能力参考<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fdocumentation%23map" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/documentation#map" ref="nofollow noopener noreferrer">AMap官方文档</a></p>
<p>下面将按照<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Ftutorails%2Fdisplay-a-map" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/tutorails/display-a-map" ref="nofollow noopener noreferrer">官方文档</a>的 介绍高德地图的常见能力</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a372a0221f74b038de77cdd99819352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=pVU39VObbsVYxnL6n9pcbV3eBfs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">展示地图</h2>
<p>地图的展示与 zoom/center/mapStyle属性有关</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'container'</span>, {
    <span class="hljs-attr">zoom</span>: <span class="hljs-number">11</span>,<span class="hljs-comment">// 缩放比 值越大 地图放大倍数越大 展示的范围就越小</span>
    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.397428</span>, <span class="hljs-number">39.90923</span>],<span class="hljs-comment">//中心点</span>
    <span class="hljs-attr">mapStyle</span>: <span class="hljs-string">"amap://styles/normal"</span>, <span class="hljs-comment">//地图样式</span>
  })
</code></pre>
<p>地图样式参考<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Ftutorails%2Fdisplay-a-map%23s5" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/tutorails/display-a-map#s5" ref="nofollow noopener noreferrer">文档</a><br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f752c692194328bf0d462450a808b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=7GHJuXM8ZxuvCnYgkBgbI%2Bq645c%3D" alt="image.png" loading="lazy"/></p>
<p>构造函数中仅传入初始值 这些属性可能会被用户操作修改 也可以通过后续<code>map.setStatus</code>主动修改</p>
<h2 data-id="heading-3">图层</h2>
<p>图层可以整体为地图附加信息</p>
<p>添加图层前后
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e7f4d6f9a9d4c4e96663596ae201a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=p7mMxyGwFLQMoLEeDCFS%2BxruE9c%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efdabbc17b384a91ba1502a3d9809ccc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=hYywvudUbLfuHLGHsshyoiOOCzA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 官方的交通图层 可以展示交通信息信息情况</span>
<span class="hljs-keyword">const</span> traffic = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-property">TileLayer</span>.<span class="hljs-title class_">Traffic</span>();

<span class="hljs-comment">// 变更map的图层(可以传数组)</span>
map.<span class="hljs-title function_">add</span>(traffic)
map.<span class="hljs-title function_">remove</span>(traffic)

<span class="hljs-comment">// 控制显隐</span>
traffic.<span class="hljs-title function_">hide</span>()
traffic.<span class="hljs-title function_">show</span>()

</code></pre>
<p>图层具有setOptions以设置属性</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fguide%2Flayers%2Fofficial-layers" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/guide/layers/official-layers" ref="nofollow noopener noreferrer">官方图层</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fdocumentation%23%25e9%25ab%2598%25e5%25be%25b7%25e5%25ae%2598%25e6%2596%25b9%25e5%259b%25be%25e5%25b1%2582" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/documentation#%e9%ab%98%e5%be%b7%e5%ae%98%e6%96%b9%e5%9b%be%e5%b1%82" ref="nofollow noopener noreferrer">完整的图层文档</a></p>
<h2 data-id="heading-4">控件</h2>
<p>指地图上的各种按钮 如缩放、比例尺等 位置仅与地图容器关联 不与坐标相关</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bef2201865834568b9e1335f798e28b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=3OmHq22C6GpVDczVSTH8VvLeQZ8%3D" alt="image.png" loading="lazy"/></p>
<p>需要动态引入控件 并通过map的addControl将其插入地图中</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-title class_">AMap</span>.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'AMap.ToolBar'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> toolbar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">ToolBar</span>() <span class="hljs-comment">// 缩放器</span>
    map.<span class="hljs-title function_">addControl</span>(toolbar)

  })    
   
    <span class="hljs-comment">// 如果需要移除控件</span>
    map.<span class="hljs-title function_">removeControl</span>(toolbar)
    
    <span class="hljs-comment">// 控制显隐</span>
    toolbar.<span class="hljs-title function_">hide</span>()
    toolbar.<span class="hljs-title function_">show</span>()
</code></pre>
<p>控件是插件系统的一部分 高德地图提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fguide%2Fabc%2Fplugins-list" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/guide/abc/plugins-list" ref="nofollow noopener noreferrer">官方插件</a></p>
<h2 data-id="heading-5">点标记</h2>
<p>与控件相比 点标记可以添加多个相同类型的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a6a2a6cf73484a9949d4af6a428c7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=6V1V2nAXwkUCZoxBRwNRJlmmVb8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">//点标记显示内容 outerHTML</span>
  <span class="hljs-keyword">const</span> markerContent = <span class="hljs-string">`&lt;img src="//a.amap.com/jsapi_demos/static/demo-center/icons/dir-via-marker.png"&gt;`</span>
  <span class="hljs-comment">// 点标记经纬度</span>
  <span class="hljs-keyword">const</span> position = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">LngLat</span>(<span class="hljs-number">116.397428</span>, <span class="hljs-number">39.90923</span>)
  <span class="hljs-keyword">const</span> marker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    position,
    <span class="hljs-attr">content</span>: markerContent,
    <span class="hljs-comment">// position是marker左上角的坐标 offset是在此基础上的偏移</span>
    <span class="hljs-comment">// 此处是为了让marker的下边中心处于position位置</span>
    <span class="hljs-attr">offset</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Pixel</span>(-<span class="hljs-number">13</span>, -<span class="hljs-number">30</span>),
    <span class="hljs-attr">draggable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许拖拽</span>
  })
  
  <span class="hljs-comment">// 添加/移除点标记</span>
  map.<span class="hljs-title function_">add</span>(marker)
  map.<span class="hljs-title function_">remove</span>(marker)
  <span class="hljs-comment">// 监听标记事件 </span>
  marker.<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)
</code></pre>
<p>点标记的offset类型是<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fdocumentation%23pixel" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/documentation#pixel" ref="nofollow noopener noreferrer">Amap.Pixel</a> 单位是px</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fdocumentation%23%25e7%2582%25b9%25e6%25a0%2587%25e8%25ae%25b0" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/documentation#%e7%82%b9%e6%a0%87%e8%ae%b0" ref="nofollow noopener noreferrer">完整的点标记文档</a></p>
<h2 data-id="heading-6">多边形</h2>
<p>在地图上绘制多边形</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c7616d86a394c7f8bdbe48e5260614b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=QGoBDQo85d5KAbJgHuP60EpKhEo%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> path = [
    [
      [<span class="hljs-number">116.35</span>, <span class="hljs-number">39.92</span>],
      [<span class="hljs-number">116.46</span>, <span class="hljs-number">39.92</span>],
      [<span class="hljs-number">116.46</span>, <span class="hljs-number">39.86</span>],
      [<span class="hljs-number">116.35</span>, <span class="hljs-number">39.86</span>],
    ],
  ]

  <span class="hljs-keyword">const</span> polygon = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Polygon</span>({
    <span class="hljs-attr">path</span>: path,
    <span class="hljs-attr">draggable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许拖拽</span>
  })
  map.<span class="hljs-title function_">add</span>(polygon)
</code></pre>
<p>path按照顺时针顺序</p>
<p>如果需要镂空多边形</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> path = [
    [
      [<span class="hljs-number">116.35</span>, <span class="hljs-number">39.92</span>],
      [<span class="hljs-number">116.46</span>, <span class="hljs-number">39.92</span>],
      [<span class="hljs-number">116.46</span>, <span class="hljs-number">39.86</span>],
      [<span class="hljs-number">116.35</span>, <span class="hljs-number">39.86</span>],
    ],
    <span class="hljs-comment">// 后面的所有坐标都镂空</span>
    [
      [<span class="hljs-number">116.359</span>, <span class="hljs-number">39.9</span>],
      [<span class="hljs-number">116.4</span>, <span class="hljs-number">39.9</span>],
      [<span class="hljs-number">116.4</span>, <span class="hljs-number">39.869</span>],
      [<span class="hljs-number">116.359</span>, <span class="hljs-number">39.869</span>],
    ],
  ]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad24573ca6664a3c9021c773df7ea366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=AdrmRPljX0GvVTfzduWUWsJeiF4%3D" alt="image.png" loading="lazy"/></p>
<p>可以用<code>polygon.on</code>添加事件 镂空的部分不触发事件</p>
<p>可以用<code>polygon.setOptions</code>调整颜色样式透明度等</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fdocumentation%23%25e7%259f%25a2%25e9%2587%258f%25e5%259b%25be%25e5%25bd%25a2" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/documentation#%e7%9f%a2%e9%87%8f%e5%9b%be%e5%bd%a2" ref="nofollow noopener noreferrer">多边形文档</a></p>
<p>如果需要节点可拖拽 参考<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fguide%2Famap-polygon%2Fpolygon%23t2" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/guide/amap-polygon/polygon#t2" ref="nofollow noopener noreferrer">多边形编辑文档</a></p>
<h2 data-id="heading-7">路径信息</h2>
<p>可以使用官方的路径规划能力 参考<a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Ftutorails%2Fcar-dir" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/tutorails/car-dir" ref="nofollow noopener noreferrer">文档</a></p>
<h3 data-id="heading-8">自定义路径绘制</h3>
<p>使用Polylines</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> path = [
    [<span class="hljs-number">116.4</span>, <span class="hljs-number">39.869</span>],
    [<span class="hljs-number">116.46</span>, <span class="hljs-number">39.86</span>],
    [<span class="hljs-number">116.35</span>, <span class="hljs-number">39.92</span>],
    [<span class="hljs-number">116.35</span>, <span class="hljs-number">39.86</span>],
  ]
  <span class="hljs-keyword">const</span> polyline = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Polyline</span>({
    path,
    <span class="hljs-attr">strokeWeight</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">showDir</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">strokeOpacity</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">lineJoin</span>: <span class="hljs-string">'round'</span>,
    <span class="hljs-attr">lineCap</span>: <span class="hljs-string">'round'</span>,
  })
  map.<span class="hljs-title function_">add</span>(polyline)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29689b0dd3ef41e09eb97d7eca505964~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770903711&amp;x-signature=WGFsDY5GEYJQtopJOcSD29q8e4g%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>