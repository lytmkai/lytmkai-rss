<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[支付宝H5支付接入实战：Java一站式解决方案]]></title>    <link>https://juejin.cn/post/7588487605248442377</link>    <guid>https://juejin.cn/post/7588487605248442377</guid>    <pubDate>2025-12-29T01:26:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588487605248442377" data-draft-id="7588365276191719462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付宝H5支付接入实战：Java一站式解决方案"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-12-29T01:26:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付宝H5支付接入实战：Java一站式解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:26:27.000Z" title="Mon Dec 29 2025 01:26:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c51c51c68b8d43ac948426360accf804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=CVCmABBZ4L2KR6NENXXWrSo38pM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>支付产品千千万，作为领军产品的当属微信和支付宝。支付产品的接入常用的场景越来越多，同一个产品，又分很多场景的支付场景。以支付宝为例，支付的产品包括当面付、<code>APP</code>支付、手机网站支付等，每一种产品都对应不同的支付场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a50af8bf931348e38037e3ef96136fc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=ebc8IE82XTOe20pPLsLrobM41DI%3D" alt="" loading="lazy"/></p>
<p>刚好这段时间因为业务需要接入支付宝的<code>H5</code>支付，整理一下分享给大家。</p>
<h2 data-id="heading-1">02 H5支付介绍</h2>
<h3 data-id="heading-2">2.1 产品介绍</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/534441b359674c1a9219a4986cf0c14f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=Hw71%2BXQhSYUyDAxYJB%2BwXKvscrM%3D" alt="" loading="lazy"/></p>
<p><code>H5</code>支付在支付宝产品内部叫手机网站支付，是支付宝面向移动端网页场景提供的支付解决方案。用户在使用手机浏览器访问商户网页时，可通过调用支付宝客户端或跳转到支付宝网页完成支付。相比传统的PC端支付，<code>H5</code>支付更适合移动端用户，提供更流畅的支付体验。</p>
<p>简单来讲就是再没有支付宝生态的环境下的一种支付方式，也叫支付宝外支付。</p>
<h3 data-id="heading-3">2.2 角色介绍</h3>
<p>支付宝的开放业务存在三种角色类型：</p>
<ul>
<li>**开发者角色：**需要开发者账号，一般登录支付宝 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenhome.alipay.com%2Fplatform%2Fhome.htm" target="_blank" title="https://openhome.alipay.com/platform/home.htm" ref="nofollow noopener noreferrer">开放平台</a> 完成应用开发相关操作。</li>
<li>**商家角色：**需要商家账号，一般登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fb.alipay.com%2Findex2.htm" target="_blank" title="https://b.alipay.com/index2.htm" ref="nofollow noopener noreferrer">商家服务平台</a> 开通支付服务并完成商家经营相关操作。</li>
<li>**服务商角色：**需要服务商账号，一般登录<a href="https://link.juejin.cn?target=https%3A%2F%2Fp.alipay.com%2Fworkspace%2Fhome" target="_blank" title="https://p.alipay.com/workspace/home" ref="nofollow noopener noreferrer"> 服务商平台</a> 完成协助商家开通产品等操作。</li>
</ul>
<p>作为公司直连产品，主要就是两个角色：开发者和商家</p>
<p>同时不同的角色需要进入不同的平台设置。商家也就是收款方，一般就是公司需要申请收款账号。开发者也就是开发人员需要配置<code>API</code>属性，使用的账号可以直接使用商家的账号即可。</p>
<h2 data-id="heading-4">03 H5支付接入-开放平台</h2>
<p><code>H5</code>支付的接入官方文档介绍的相当详细，但是开发平台和商家平台来回跳可能会将人绕晕，我们将逐步拆解。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddd4a960a31d48eeb584cadaeed34650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=bxoI8%2FGFbcPkplZT%2BEmLZsmH5Lw%3D" alt="" loading="lazy"/></p>
<p>官方文档贴心的提供了检测小工具，如上图。</p>
<p>官方接入文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopendocs.alipay.com%2Fopen%2F203%2F107084" target="_blank" title="https://opendocs.alipay.com/open/203/107084" ref="nofollow noopener noreferrer">opendocs.alipay.com/open/203/10…</a></p>
<h3 data-id="heading-5">3.1 开放平台创建应用</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d20869c95dd94d5b8304d35f4bb872f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=xvfwqjJIuMJX7YDbSMHS6uQjIr4%3D" alt="" loading="lazy"/></p>
<p>首先需要开发者在开放平台创建 网页/移动应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ebc053f258c45ff950413ceefd6e791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=uiM2i5tqlY9%2FAwl2WBj5ksRX6Zk%3D" alt="" loading="lazy"/></p>
<p>创建完成之后等待官方审核，一般一个工作日之内完成审核。</p>
<h3 data-id="heading-6">3.2 开放平台配置应用</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91596fea47594056ae0772a339f8d94f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=y35WHQSwt7PltSdb4zLaRDSg7xE%3D" alt="" loading="lazy"/></p>
<p>我们需要关注的配置有接口加签方式、接口内容加密方式以及<code>openid</code>配置管理。</p>
<p><strong>接口加签方式</strong></p>
<p>接口加签必填选项，用于防止数据篡改，保障应用和支付宝交互的安全性</p>
<p>需要接入官方秘钥工具生成即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1746dd20cfb244a1bd3308ec31b7bf6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=qDv65yOn%2F5mS02xQxMaVk81PNNc%3D" alt="" loading="lazy"/></p>
<p>官方统一工具地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopendocs.alipay.com%2Fcommon%2F02kipk" target="_blank" title="https://opendocs.alipay.com/common/02kipk" ref="nofollow noopener noreferrer">opendocs.alipay.com/common/02ki…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10a1146980de41fa832dfcb539d34ed4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=s9GD2qf%2FHOPHn6as0umfkJMFqI0%3D" alt="" loading="lazy"/></p>
<p>最终我们生成的秘钥文件包括：应用公钥和私钥</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e2892b843b3445485cc41055aae6d5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=J10GR3cIeOnjyZzZ2Xz%2FbmkkAGE%3D" alt="" loading="lazy"/></p>
<p>还有一个支付宝公钥：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d0a6d5e91f14d0ba7188719d04a9b1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=o%2BR28SwcFJK%2BihM95U7uHdnZSSk%3D" alt="" loading="lazy"/></p>
<p>其中支付宝公钥和应用私钥参与代码逻辑。</p>
<p><strong>接口内容加密方式</strong></p>
<p>这个选填项，用于加 / 解密 <code>OpenAPI bizContent</code> 报文内容，可大幅提升接口内容传输的安全性。</p>
<p><strong>openid配置管理</strong></p>
<p><code>openid</code>配置管理是新版默认开启的参数。低版本支付宝服务端 <code>SDK</code> 不支持获取 <code>openid</code>，在使用 <code>openid</code> 开发接入前，请先确保使用的 <code>SDK</code> 符合版本要求：</p>

























<table><thead><tr><th><strong>开发语言</strong></th><th><strong>SDK版本要求</strong></th></tr></thead><tbody><tr><td>Java</td><td>4.35.37 及以上的版本</td></tr><tr><td>.NET</td><td>4.7.144 及以上的版本</td></tr><tr><td>PHP</td><td>4.19.30 及以上的版本</td></tr><tr><td>PYTHON</td><td>3.6.528 及以上的版本</td></tr></tbody></table>
<p>否则会出现不支持的提示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c5554a5f22a48859be46e2a8b1bbcd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=Ff4xoD%2ByXDRP36KZ7jpwbraeEFM%3D" alt="" loading="lazy"/></p>
<p>到这里，开发平台基本就配置好了。</p>
<h3 data-id="heading-7">3.3 应用APPID</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2df19cc71f94580a9237ca5cba450be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=QsoEzRHrZaZuxyLfcR8Gnym5TXI%3D" alt="" loading="lazy"/></p>
<p>这里的<code>APPID</code>需要和商家后台绑定。</p>
<h3 data-id="heading-8">3.4 开放平台</h3>
<p>开放平台是独立的平台。</p>
<p>开放平台地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenhome.alipay.com%2F" target="_blank" title="https://openhome.alipay.com/" ref="nofollow noopener noreferrer">openhome.alipay.com/</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e867890980484cdfa1ab758d58b16457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=18TLnbXINUHgtyWHil90c62GtN4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">04 H5支付接入-商家平台</h2>
<p>商家平台地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fb.alipay.com%2Fpage%2Fhome" target="_blank" title="https://b.alipay.com/page/home" ref="nofollow noopener noreferrer">b.alipay.com/page/home</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4e1c4e03a854359b6bf8f4fa54e92ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=JLN9Itysg44jOLpCE2yWPJ750yo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">4.1 绑定APPID</h3>
<p>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fb.alipay.com%2Fpage%2Fhome" target="_blank" title="https://b.alipay.com/page/home" ref="nofollow noopener noreferrer">商家平台</a> &gt; <strong>账号中心</strong> &gt; <strong>绑定</strong> &gt; <strong>APPID绑定</strong>，点击 <strong>添加绑定</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25e0251444eb4f56951e04c4b389b904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=cSCgnU607Bh8NxYHOjF%2BCxl%2BdWY%3D" alt="" loading="lazy"/></p>
<p>然后添加绑定关系：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f34ac6e60c340dcaa747d04addcab58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=btdpxD%2FcLXC11jojoySDh7xwegY%3D" alt="" loading="lazy"/></p>
<p>这里的<code>APPID</code>就是开放平台的<code>APPID</code></p>
<h3 data-id="heading-11">4.2 开通产品</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea3128f0e0f3414b8806c1948521f7b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=MSGgQTBIFGkUUjL%2BpkQdDOVFNuw%3D" alt="" loading="lazy"/></p>
<p>这里的我已经开通过了，没有开通话需要开通支付产品。开通过程中，如果网站的主体和商家后台的主体不一致需要授权。授权函如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e63c4f6466c49a8b43cfcdf0cf8d9fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=%2Fs6%2FeHqJ%2Fr3sFqALKooetk49WZE%3D" alt="" loading="lazy"/></p>
<p>到这里就完成了支付宝<code>H5</code>支付的所有配置，下来就到了编码环节了。</p>
<h2 data-id="heading-12">05 Java代码</h2>
<p>Java代码是非常简单的，只需要复制官方文档的代码即可，使用适合自己的参数即可，这里不再赘述。</p>
<p>代码示例地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopendocs.alipay.com%2Fopen%2F29ae8cb6_alipay.trade.wap.pay%3Fscene%3D21%26pathHash%3D1ef587fd" target="_blank" title="https://opendocs.alipay.com/open/29ae8cb6_alipay.trade.wap.pay?scene=21&amp;pathHash=1ef587fd" ref="nofollow noopener noreferrer">opendocs.alipay.com/open/29ae8c…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1720930acaa54a49925c40b7979a4582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767576388&amp;x-signature=w6s88iWxqI7yLPZKVJDbW%2BKIOmw%3D" alt="" loading="lazy"/></p>
<p>这里简单的说以配置的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AlipayConfig <span class="hljs-title function_">getAlipayConfig</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">privateKey</span>  <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;-- 请填写您的应用私钥，例如：MIIEvQIBADANB ... ... --&gt;"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">alipayPublicKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;-- 请填写您的支付宝公钥，例如：MIIBIjANBg... --&gt;"</span>;
    <span class="hljs-type">AlipayConfig</span> <span class="hljs-variable">alipayConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayConfig</span>();
    alipayConfig.setServerUrl(<span class="hljs-string">"https://openapi.alipay.com/gateway.do"</span>);
    alipayConfig.setAppId(<span class="hljs-string">"&lt;-- 请填写您的AppId，例如：2019091767145019 --&gt;"</span>);
    alipayConfig.setPrivateKey(privateKey);
    alipayConfig.setFormat(<span class="hljs-string">"json"</span>);
    alipayConfig.setAlipayPublicKey(alipayPublicKey);
    alipayConfig.setCharset(<span class="hljs-string">"UTF-8"</span>);
    alipayConfig.setSignType(<span class="hljs-string">"RSA2"</span>);
    <span class="hljs-keyword">return</span> alipayConfig;
}
</code></pre>
<p>这里的配置是初始化支付宝客户端需要的参数，其中<code>privateKey</code>和<code>alipayPublicKey</code>就是开放平台生成的应用私钥和应用公钥。</p>
<p>这里的<code>APPID</code>就是应用的<code>APPID</code>。</p>
<h2 data-id="heading-13">06 小结</h2>
<p>对接下来无论支付宝和微信，都需要一个载体去连接商户号（商家后台），然后通过关联的方式打通支付渠道。</p>
<p>支付宝的产品中有一个指定买家付款的功能，可以杜绝三方付款。而微信只能用到指定的行业如金融、保险等，需要额外申请。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如果2025的我是强化学习，那最终奖励会是什么？]]></title>    <link>https://juejin.cn/post/7588695570635030566</link>    <guid>https://juejin.cn/post/7588695570635030566</guid>    <pubDate>2025-12-29T02:56:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588695570635030566" data-draft-id="7588695570634965030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如果2025的我是强化学习，那最终奖励会是什么？"/> <meta itemprop="keywords" content="程序员,人工智能,Trae"/> <meta itemprop="datePublished" content="2025-12-29T02:56:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不惑_"/> <meta itemprop="url" content="https://juejin.cn/user/1471609400466218"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如果2025的我是强化学习，那最终奖励会是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1471609400466218/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不惑_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:56:57.000Z" title="Mon Dec 29 2025 02:56:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>年底了，打开备忘录准备写年终总结，光标闪了半天，愣是一个字没憋出来。</p>
<p>不是没东西写，恰恰相反，太多了。写文、做自媒体、参加比赛、办活动、学大模型……日历上密密麻麻全是痕迹，手机相册里存满了各种活动的合影和奖状。可就是这么奇怪，明明做了这么多事儿，坐下来一盘点，心里却空落落的。</p>
<p>那天晚上三点多，躺在床上睡不着，脑子里突然蹦出一个念头：我这一年，活得像不像一个强化学习的智能体？</p>
<h2 data-id="heading-0">一、先聊聊什么是强化学习，用人话说</h2>
<p>别急着划走，我不打算讲什么马尔可夫决策过程，也不会贴代码。</p>
<p>强化学习这东西，核心思路特别简单：一个小家伙（咱们叫它智能体），被丢进一个陌生环境里，它不知道该干嘛，只能瞎试。做对了一件事，环境给它一点甜头，叫"奖励"；做错了，可能挨一巴掌，叫"惩罚"。时间长了，它就学会了——哦，原来这么干能拿奖励，那我就多干这个。</p>
<p>听着是不是特耳熟？</p>
<p>这不就是咱们吗？</p>
<p>从小到大，考试考好了，爸妈给买玩具；上班业绩好了，老板给发奖金；发条朋友圈，点赞多了心情就好。我们不也是在这个环境里不断试探，看看什么动作能换来正向反馈，然后调整自己的行为吗？</p>
<p>想通这一点之后，我突然对自己这一年有了新的理解。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0a3bb67b9a14df3bf758f95d510690f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581816&amp;x-signature=GqmyQ6h5vdbo4DQZlbVe5%2BmL7rw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、写了一年的文章，奖励在哪儿</h2>
<p>先说写文这件事吧。</p>
<p>今年我确实写了不少，打开后台一看，几十篇是有的。但说实话，大部分都是水文。不是我想水，是真的没时间打磨。白天上班，晚上还有各种事儿要处理，能抽出来写东西的时间本来就不多，还得保证更新频率，只能压缩质量。</p>
<p>最开始我给自己设定的奖励是阅读量。每发一篇就盯着后台数据看，刷新，刷新，再刷新。阅读量涨了，开心一下午；阅读量扑了，郁闷好几天。</p>
<p>后来发现这个奖励信号太不稳定了。同样的内容质量，有时候赶上热点就爆了，有时候发出去连个水花都没有。渐渐地，我开始怀疑自己：到底是我写得不好，还是运气不好？</p>
<p>再后来，我干脆不看数据了。写完发出去就完事儿，眼不见心不烦。</p>
<p>可是这样一来，新的问题又出现了——没有奖励信号的反馈，我就不知道自己在进步还是在退步。就像一个在黑暗中摸索的人，偶尔会撞到墙，但大部分时间都不知道自己走的方向对不对。</p>
<p>强化学习里有个概念叫"稀疏奖励"，就是说奖励来得太少太慢，智能体很难学到东西。我今年写文章的状态，大概就是这样。做了很多动作，但有效的反馈太少了，以至于我到现在都不确定，自己在写作这条路上，到底有没有变强。</p>
<h2 data-id="heading-2">三、自媒体这条路，我的奖励函数可能设错了</h2>
<p>如果说写文章的奖励是稀疏的，那自媒体这块儿，简直就是负奖励连击。</p>
<p>先说公众号。今年有段时间，我开始重写公众号，阅读量还不错，大几千，我当时可高兴了，心想这条路走对了，以后多写这种内容。知道某一天，我写了一篇分析某家公司的文章，自认为挺客观的，数据翔实，观点中立。发出去之后。</p>
<p>结果第二天，投诉来了。</p>
<p>具体的我就不细说了，反正后果就是，那篇文章之后，我的账号流量直接从大几千变成了十几。不是几百，是十几。你能想象那种落差吗？就像打游戏打到一半，突然被系统判定开挂，直接封号重来。</p>
<p>更让人沮丧的是，我根本不知道自己错在哪儿。写得太真实了？触碰了谁的利益？还是纯粹运气不好被人盯上了？没有人告诉你答案，你只能自己猜，然后在下次行动时更加小心翼翼。</p>
<p>这算什么奖励？这是惩罚啊。而且是那种你都不知道为什么挨打的惩罚。</p>
<p>小红书也差不多。今年我换了好几个方向，什么技术分享、工具推荐、生活记录都试过了，就是找不到流量密码。看着别人随手发个帖子就几千赞，我认认真真做的内容却连一百浏览都没有，真的会怀疑人生。</p>
<p>最离谱的是出海那段时间。信心满满地做内容，想着国外市场大，竞争没那么卷。结果呢？整整一个季度，回来一看，粉丝数：3。</p>
<p>三个。</p>
<p>就三个。</p>
<p>我都怀疑那三个人是不是点错了。</p>
<p>这种体验让我开始反思：是不是我给自己设定的奖励函数就有问题？</p>
<p>我把"涨粉"、"阅读量"当作奖励，把"变现"当作终极目标。但这些东西真的是我能控制的吗？算法一变，规则一调，你之前积累的所有经验可能一夜之间全作废。追着这些外部指标跑，我越来越像一只被牵着鼻子走的驴，筋疲力尽却不知道自己在图什么。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b25f0f972adb49afac808a3f69fdbe38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581816&amp;x-signature=9wvlAjVNdtbshtWfaj%2FOjsVnAoE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">四、比赛和活动，终于拿到奖励了，然后呢</h2>
<p>今年参加比赛的次数不多，主要是实在抽不出时间。但就这仅有的两次，都翻车了。</p>
<p>一次是选题方向搞错了。比赛要求的是A方向，我阴差阳错理解成了B方向，辛辛苦苦做了一周的东西，最后要提交上去才发现跑偏了。那一刻真的很崩溃，不是因为浪费了时间，而是那种"明明很努力却因为低级错误功亏一篑"的感觉，太打击人了。</p>
<p>另一次更离谱，我把最终提交时间记错了。以为还有一天，结果截止日期就是当天晚上十二点。等我反应过来的时候，已经来不及了。</p>
<p>你说这怪谁？怪自己呗。但人就是这样，明明知道是自己的问题，还是会找理由开脱——太忙了，事情太多了，精力跟不上了。</p>
<p>活动倒是参加了不少，每次名次都一般般。不上不下，拿个参与奖或者安慰奖。东西挺好的，就是没什么用。家里已经堆了一堆马克杯、帆布袋、充电宝，真的用不上那么多。</p>
<p>有时候我会想，这算奖励吗？</p>
<p>从强化学习的角度看，算。毕竟你做了某个动作（参加比赛），得到了一个正向反馈（奖品）。但问题是，这个奖励的价值太低了，低到不足以激励我下次付出同样的努力。</p>
<p>更让人无奈的是，大奖拿不到。不是不想拿，是真的够不着。看着第一名的奖品眼馋，但自己和人家的差距明明白白摆在那儿，也不好说什么。</p>
<p>有一瞬间我突然觉得自己老了。不是身体老，是脑子跟不上了。年轻人的思路天马行空，创意层出不穷，我还在这儿按部就班地套方法论。可能我不是不努力，是努力的方向已经过时了。</p>
<h2 data-id="heading-4">五、办活动这件事，终于尝到了一点甜头</h2>
<p>说了这么多丧气话，还是有些让人欣慰的事儿。</p>
<p>今年我成功办了TRAE的Meetup和黑客松，这是实打实落地的东西。从筹备到执行，从邀请嘉宾到现场协调，每一个环节都是自己一点点推进的。</p>
<p>活动当天看着现场坐满了人，大家认真听讲、积极交流，那一刻是真的有成就感。这种感觉和写文章涨了阅读量不一样，也和拿了个小奖品不一样。它是一种"我做成了一件事"的确定性，是看得见摸得着的反馈。</p>
<p>还被邀请参加了一些活动的分享嘉宾，这种体验也挺新鲜的。站在台上讲东西，底下几十号人看着你，那种感觉既紧张又兴奋。</p>
<p>当然，也有社死的时候。互动环节被现场观众拷打，问的问题我答不上来，脸上笑嘻嘻心里慌得一批。那种冒汗的感觉，谁经历谁知道。</p>
<p>但事后想想，这也算一种奖励吧——被拷打说明人家认真听了，问得出专业问题说明他们在乎你讲的内容。如果全程没人理你，那才是真正的失败。</p>
<p>这件事让我意识到，有些奖励是即时的，有些奖励是延迟的。办活动这种事，当下可能看不到什么直接收益，但它带来的人脉、口碑、经验，都是会在未来某个时刻兑现的。强化学习里也有这个概念，叫"延迟奖励"，你现在做的事情可能要过很久才能看到回报。</p>
<p>难的是，很多人等不了那么久。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc2e15a5d88c4b8d82bff01d5a96971c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581816&amp;x-signature=BdAfWKOsC3WhusQR3QxswGWwVnQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">六、学了一堆东西，奖励还在路上</h2>
<p>今年在学习上投入的时间真的不少。</p>
<p>大模型那些东西，该玩的都玩了一遍。魔搭、HuggingFace、各种国内外的工具和平台，我敢说自己用得挺六的。看到什么新东西出来，第一时间就去上手试试，了解它能干什么、怎么用、有什么坑。</p>
<p>可问题在于，我只停留在"会用"的层面，始终没想明白怎么把它变成钱。</p>
<p>直到有一天，看见一个博主发视频，用我也会的工具做了个简单应用，然后靠这个接广告变现了。那一刻真的很复杂，一方面是替人家高兴，另一方面是懊恼——这东西我也会啊，怎么就没想到呢？</p>
<p>这种"后知后觉"的感觉太难受了。就像考试的时候，题目明明都会做，但出了考场才反应过来自己写错了。不是能力问题，是脑子没转过弯来。</p>
<p>后来我总结了一下，大模型这东西，学是学不完的。技术迭代太快了，今天学的东西可能下个月就过时了。与其追着技术跑，不如想清楚自己要用这些东西干什么。</p>
<p>还有一个建议，给那些和我一样在学大模型的朋友：别入算法的坑。不是说算法不重要，是性价比太低了。你花大半年时间搞明白transformer的数学原理，可能还不如人家花两周学会怎么调用API变现来得实在。当然，如果你是搞科研的，当我没说。</p>
<p>学习的奖励是什么？短期来看，是掌握了新技能；长期来看，应该是用这些技能创造价值。但问题是，我目前还卡在"短期"这一步，长期的奖励还没到账。</p>
<p>希望2026年能兑现吧。</p>
<h2 data-id="heading-6">七、回到最初的问题：奖励到底是什么</h2>
<p>写到这里，我突然发现一个问题。</p>
<p>这一年，我一直在找奖励，却从来没有认真想过，什么才是我真正想要的奖励。</p>
<p>是阅读量吗？那个数字涨涨跌跌，情绪被它牵着走，太累了。
是粉丝数吗？追了一年，没追上。
是奖品吗？家里堆了一堆用不上的东西。
是钱吗？商单还是几百块的水平，没什么长进。
是成就感吗？有过，但很短暂。
是认可吗？有一些，但总觉得不够。</p>
<p>或许问题就出在这里——我的奖励函数太混乱了。</p>
<p>同时追求太多东西，每一个都想要，每一个都舍不得放弃。结果就是精力被切得七零八碎，什么都做了，什么都没做好。</p>
<p>强化学习里有个说法，叫"探索与利用的权衡"。探索是尝试新的可能，利用是专注于已经验证有效的方向。一个好的智能体，需要在这两者之间找到平衡。</p>
<p>回看我的2025，探索做了很多，利用却严重不足。我尝试了写文、自媒体、比赛、活动、学习各种方向，但没有一条路走到足够深的地方。</p>
<p>2026年，也许我应该停下来想一想，到底什么才是值得我all in的事情。不是什么都要，而是选定一两个真正重要的目标，然后把那条路走穿。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be7ef14114e9450c91fce70912a9a501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581816&amp;x-signature=fCWBLQWqt3dwlLe2xFqHLlu1k2w%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">八、写在最后</h2>
<p>凌晨四点，写完这篇文章，窗外天已经有点蒙蒙亮了。</p>
<p>我问自己：这一年，你比去年优秀了吗？</p>
<p>说实话，我不知道。</p>
<p>如果用那些外部指标来衡量——粉丝数、阅读量、收入——答案大概是没有，甚至可能还倒退了。</p>
<p>但如果换一个角度想，这一年我确实经历了很多、尝试了很多、也失败了很多。这些经历本身，难道不也是一种奖励吗？</p>
<p>不是那种立竿见影的奖励，而是更隐蔽、更深远的那种。</p>
<p>就像强化学习里的智能体，它在环境中不断试错，每一次失败都让它对这个世界有了更准确的理解。我今年踩过的坑、走过的弯路、犯过的低级错误，其实都在帮我建立一个更清晰的世界模型。</p>
<p>这个模型会告诉我，哪些事情值得做，哪些事情是陷阱；什么样的奖励是真实的，什么样的奖励是海市蜃楼。</p>
<p>所以，如果我的2025是强化学习，那奖励是什么？</p>
<p>答案可能是：我终于开始认真思考这个问题了。</p>
<p>知道自己想要什么，比盲目地追逐一切，重要得多。</p>
<p>2026，希望能少一点稀疏奖励，多一点确定性的收获。</p>
<p>也希望每一个和我一样在深夜里彷徨的人，都能找到属于自己的奖励函数。</p>
<p>晚安，或者说，早安。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 美团技术团队热门技术文章汇总]]></title>    <link>https://juejin.cn/post/7588376012122030107</link>    <guid>https://juejin.cn/post/7588376012122030107</guid>    <pubDate>2025-12-29T03:00:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588376012122030107" data-draft-id="7588487605248983049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 美团技术团队热门技术文章汇总"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-29T03:00:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="美团技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3509296845313741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 美团技术团队热门技术文章汇总
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ccb42d726640a7889ba1e64ae203e6~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="美团技术团队" class="title" data-v-d326b38e="">美团技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-29T03:00:18.000Z" title="Mon Dec 29 2025 03:00:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-29
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读17分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              美团小编 @美团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf0b4b71c3924503ab6ddb9a5c6dd260~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=MFNy64YBOJsyBVfH0NMG9T8kWVc%3D" alt="" loading="lazy"/></p>
<p>时光奔流，我们即将与 2025 年挥手作别。感谢这一路上，每一位伙伴的并肩前行与坚定支持。</p>
<p>今年，美团技术团队在持续深耕中涌现出不少值得分享的实践与开源产品&amp;服务。我们从中精选了18篇具有代表性的技术文章，内容涵盖<strong>大模型开源、研发技能、产品服务</strong>三大方向。值得一提的是，美团 LongCat 团队今年在大模型开源领域成果显著，陆续发布了涵盖基座模型、图像、视频、语音等多个方向的开源产品与工具，期望能够持续推动AI技术分享与生态共建。</p>
<p>希望这些开源的大模型产品、服务及凝结一线技术实战经验的内容，能为大家带来启发和帮助，陪伴同学们在技术前行的道路上扎实成长。愿我们在新年里，继续向下扎根、向上生长，迎着光，奔赴更高、更远的山海。2026，期待继续同行！</p>
<h2 data-id="heading-0">大模型开源</h2>
<h3 data-id="heading-1">01 | 美团正式发布并开源 LongCat-Flash-Chat，动态计算开启高效 AI 时代</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3f03ab909484880b51022780f8d98c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=wTLVxfh6MQ30v7r%2FJOY8Ph184Fo%3D" alt="" loading="lazy"/></p>
<p>9月初，美团正式发布并开源 LongCat-Flash-Chat。LongCat-Flash 采用创新性混合专家模型（Mixture-of-Experts, MoE）架构，总参数 560 B，激活参数 18.6B~31.3B（平均 27B），实现了计算效率与性能的双重优化。</p>
<p>根据多项基准测试综合评估，作为一款非思考型基础模型，LongCat-Flash-Chat 在仅激活少量参数的前提下，性能比肩当下领先的主流模型，尤其在智能体任务中具备突出优势。并且，因为面向推理效率的设计和创新，LongCat-Flash-Chat 具有明显更快的推理速度，更适合于耗时较长的复杂智能体应用。</p>
<p>目前，已在 Github、Hugging Face 平台同步开源，同时你也可以访问官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Flongcat.ai%2F" target="_blank" title="https://longcat.ai/" ref="nofollow noopener noreferrer">longcat.ai/</a>，与 LongCat-Flash-Chat 开启对话。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FpJMQdKM772IXggJRSZMoQA" target="_blank" title="https://mp.weixin.qq.com/s/pJMQdKM772IXggJRSZMoQA" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Flash-Chat" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Flash-Chat" ref="nofollow noopener noreferrer">Hugging Face</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Flash-Chat" target="_blank" title="https://github.com/meituan-longcat/LongCat-Flash-Chat" ref="nofollow noopener noreferrer">Github</a></p>
<h3 data-id="heading-2">02 | LongCat-Flash-Thinking 正式发布，更强、更专业，保持极速！</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03ff931bf2084266b1bab7fa2ff6deaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=k3enosDPMfGPNS3%2BejMwZB9W5x4%3D" alt="" loading="lazy"/></p>
<p>9月，美团 LongCat 团队正式发布全新高效推理模型 LongCat-Flash-Thinking。在保持了 LongCat-Flash-Chat 极致速度的同时，全新发布的 LongCat-Flash-Thinking 更强大、更专业。综合评估显示，LongCat-Flash-Thinking 在逻辑、数学、代码、智能体等多个领域的推理任务中，达到了全球开源模型的先进水平。</p>
<p>同时，LongCat-Flash-Thinking 不仅增强了智能体自主调用工具的能力，还扩展了形式化定理证明能力，成为国内首个同时具备「深度思考+工具调用」与「非形式化+形式化」推理能力相结合的大语言模型。我们发现，尤其在超高复杂度的任务（如数学、代码、智能体任务）处理上， LongCat-Flash-Thinking 具备更显著的优势。目前， 该模型已在HuggingFace、Github全面开源。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAs9-QzWCcSQivIFUdB-OTg" target="_blank" title="https://mp.weixin.qq.com/s/As9-QzWCcSQivIFUdB-OTg" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Flash-Thinking" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Flash-Thinking" ref="nofollow noopener noreferrer">Hugging Face</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Flash-Thinking" target="_blank" title="https://github.com/meituan-longcat/LongCat-Flash-Thinking" ref="nofollow noopener noreferrer">Github</a></p>
<h3 data-id="heading-3">03 | LongCat-Video 视频生成模型正式发布，探索世界模型的第一步</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f5246d45dfb412b8e6aeb1d0acb5ad5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=NgX74jkrsP26n6oReRpmPaRjFac%3D" alt="" loading="lazy"/></p>
<p>要让人工智能真正理解、预测甚至重构真实世界，“世界模型”（World Model）已成为通往下一代智能的核心引擎。作为能够建模物理规律、时空演化与场景逻辑的智能系统，世界模型赋予AI“看见”世界运行本质的能力。而视频生成模型有望成为构建世界模型的关键路径——通过视频生成任务压缩几何、语义、物理等多种形式的知识，AI得以在数字空间中模拟、推演乃至预演真实世界的运行。</p>
<p>基于这一关键目标，10月，美团 LongCat 团队正式发布 LongCat-Video 视频生成模型 —— 不仅以统一模型在文生、图生视频基础任务上达到开源先进水平，更依托原生视频续写任务预训练，实现分钟级长视频连贯生成，从根源上保障跨帧时序一致性与物理运动合理性，尤其在长视频生成领域具备显著优势。</p>
<p>作为一款视频生成模型，LongCat-Video 凭借其精准重构真实世界运行状态的能力，正在成为美团探索世界模型的第一步，也是关键的一步。同时，这也为后续支撑更多自动驾驶、具身智能等深度交互业务场景，夯实了技术基础。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FiWxKChMbPULHww8ooq3tHw" target="_blank" title="https://mp.weixin.qq.com/s/iWxKChMbPULHww8ooq3tHw" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Video" target="_blank" title="https://github.com/meituan-longcat/LongCat-Video" ref="nofollow noopener noreferrer">GitHub</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Video" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Video" ref="nofollow noopener noreferrer">Hugging Face</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fmeituan-longcat.github.io%2FLongCat-Video%2F" target="_blank" title="https://meituan-longcat.github.io/LongCat-Video/" ref="nofollow noopener noreferrer">Project Page</a></p>
<h3 data-id="heading-4">04 | LongCat-Flash-Omni 正式发布并开源：开启全模态实时交互时代</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0b5624748c347baa6b2a174a396559a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=3sr6wEn%2BzPDInK3MZEUnnP32gfU%3D" alt="" loading="lazy"/></p>
<p>11月，LongCat-Flash-Omni 正式发布并开源。LongCat-Flash-Omni 以 LongCat-Flash 系列的高效架构设计为基础（ Shortcut-Connected MoE，含零计算专家），同时创新性集成了高效多模态感知模块与语音重建模块。即便在总参数 5600 亿（激活参数 270 亿）的庞大参数规模下，仍实现了低延迟的实时音视频交互能力，为开发者的多模态应用场景提供了更高效的技术选择。</p>
<p>综合评估结果表明，LongCat-Flash-Omni 在全模态基准测试中达到开源先进水平，同时在文本、图像、视频理解及语音感知与生成等关键单模态任务中，均展现出极强的竞争力。LongCat-Flash-Omni 是业界首个实现 “全模态覆盖、端到端架构、大参数量高效推理” 于一体的开源大语言模型，首次在开源范畴内实现了全模态能力对闭源模型的对标，并凭借创新的架构设计与工程优化，让大参数模型在多模态任务中也能实现毫秒级响应，解决了行业内推理延迟的痛点。模型已同步开源，欢迎体验。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F-VsWhtii1u22CcnHCtP57Q" target="_blank" title="https://mp.weixin.qq.com/s/-VsWhtii1u22CcnHCtP57Q" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Flash-Omni" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Flash-Omni" ref="nofollow noopener noreferrer">Hugging Face</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Flash-Omni" target="_blank" title="https://github.com/meituan-longcat/LongCat-Flash-Omni" ref="nofollow noopener noreferrer">Github</a></p>
<h3 data-id="heading-5">05 | 美团开源 LongCat-Audio-Codec，高效语音编解码器助力实时交互落地</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c50ba305b84fce9d458c2e21fc42ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=hkWkbAinHJPMKwuk7f72veEPh7I%3D" alt="" loading="lazy"/></p>
<p>语音大语言模型（Speech LLM）想落地，绕不开一个死结：既要快速理解语音里的语义，又要说出自然的音色，还得实时响应。比如智能音箱 “听不懂” 语音，车载助手 “说” 得像机器人，实时翻译延迟卡半秒。深究根源，全在 “语音 Token 化”：作为拆分语音为 Speech LLM “离散单元” 的关键步骤，传统方案始终没平衡好 —— 要么缺语义、要么丢声学、要么延迟高，刚好卡了 Speech LLM 落地的 “死结”。</p>
<p>针对 Speech LLM 落地中的音频处理难题，11月，美团 LongCat 团队正式开源专用语音编解码方案 LongCat-Audio-Codec。它提供了一套一站式的 Token 生成器（Tokenizer）与 Token 还原器（DeTokenizer）工具链，其核心功能是将原始音频信号映射为语义与声学并行的 token 序列，实现高效离散化，再通过解码模块重构高质量音频，为 Speech LLM 提供从信号输入到输出的全链路音频处理支持。通过创新的架构设计与训练策略，LongCat-Audio-Codec 在语义建模、声学重建、流式合成三大维度实现突破。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Flf4NdUPEk9ZigCxpG0KuKw" target="_blank" title="https://mp.weixin.qq.com/s/lf4NdUPEk9ZigCxpG0KuKw" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Audio-Codec" target="_blank" title="https://github.com/meituan-longcat/LongCat-Audio-Codec" ref="nofollow noopener noreferrer">Github</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Audio-Codec" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Audio-Codec" ref="nofollow noopener noreferrer">Hugging Face</a></p>
<h3 data-id="heading-6">06 | 美团发布 LongCat-Image 图像生成模型，编辑能力登顶开源SOTA</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90800e9a053f474f8bdab1c51750819c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=3Ej7q9Qlq910zyXq1r4ni8b9HDU%3D" alt="" loading="lazy"/></p>
<p>12月初，美团发布 LongCat-Image 图像生成模型。当前 AI 图像生成技术需求旺盛，但行业陷入 “两难困境”：闭源大模型性能强劲但无法自行部署或二次定制开发，开源方案普遍存在轻量化与模型性能难以兼顾、面向商用专项能力不足的痛点，制约商业创作与技术普惠。</p>
<p>为此，美团 LongCat 团队正式发布并开源 LongCat-Image 模型，通过高性能模型架构设计、系统性的训练策略和数据工程，以 6B 参数规模，成功在文生图和图像编辑的核心能力维度上逼近更大尺寸模型效果，为开发者社区与产业界提供了 “高性能、低门槛、全开放” 的全新选择。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FnyQSD4fDsvmUkUExVSuQVQ" target="_blank" title="https://mp.weixin.qq.com/s/nyQSD4fDsvmUkUExVSuQVQ" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Image" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Image" ref="nofollow noopener noreferrer">Hugging Face</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Image" target="_blank" title="https://github.com/meituan-longcat/LongCat-Image" ref="nofollow noopener noreferrer">GitHub</a></p>
<h3 data-id="heading-7">07 | 美团 LongCat-Video-Avatar 发布，实现开源SOTA级拟真表现</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c712d11c75c4111ae032513217fd034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=8ZoncN62cmgCMVFZKgkjpxMrs04%3D" alt="" loading="lazy"/></p>
<p>今年 8 月，美团开源的 InfiniteTalk 项目凭借无限长度生成能力与精准的唇形、头部、表情及姿态同步表现，迅速成为语音驱动虚拟人领域的主流工具，吸引全球数十万名开发者的使用。10月底，LongCat 团队开源了 LongCat-Video 视频生成模型，尤其在长视频生成领域具备显著优势。</p>
<p>在 InfiniteTalk 和 LongCat-Video 基座的良好基础上，LongCat 团队针对实际场景中的核心痛点持续优化，12月正式发布并开源 SOTA 级虚拟人视频生成模型 —— LongCat-Video-Avatar。</p>
<p>该模型基于 LongCat-Video 基座打造，延续 “一个模型支持多任务” 的核心设计，原生支持 Audio-Text-to-Video（AT2V）、Audio-Text-Image-to-Video（ATI2V）及视频续写等核心功能，同时在底层架构上全面升级，实现动作拟真度、长视频稳定性与身份一致性三大维度的显著突破，为开发者提供更稳定、高效、实用的创作解决方案。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyG2Hf5PVR2_xRVsnNuBh1w" target="_blank" title="https://mp.weixin.qq.com/s/yG2Hf5PVR2_xRVsnNuBh1w" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Video" target="_blank" title="https://github.com/meituan-longcat/LongCat-Video" ref="nofollow noopener noreferrer">GitHub</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Video-Avatar" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Video-Avatar" ref="nofollow noopener noreferrer">Hugging Face</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fmeigen-ai.github.io%2FLongCat-Video-Avatar%2F" target="_blank" title="https://meigen-ai.github.io/LongCat-Video-Avatar/" ref="nofollow noopener noreferrer">Project</a></p>
<h2 data-id="heading-8">研发技能</h2>
<h3 data-id="heading-9">08 | MTGR：美团外卖生成式推荐Scaling Law落地实践</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1583213227b946d4b46bc1cb9e7429d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=EawVq%2FyUj4I5IPO7RGKvFbSFjUo%3D" alt="" loading="lazy"/></p>
<p>美团外卖推荐算法团队基于HSTU提出了MTGR框架以探索推荐系统中Scaling Law。MTGR对齐传统模型特征体系，并对多条序列利用Transformer架构进行统一建模。通过极致的性能优化，样本前向推理FLOPs提升65倍，推理成本降低12%，训练成本持平。MTGR离在线均取得近2年迭代最大收益，且于2025年4月底在外卖推荐场景全量。本文系相关工作的实践与经验总结，希望能给从事相关方向研究的同学带来一些帮助。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJiDOqD-ThU0Upp6xnNg3Nw" target="_blank" title="https://mp.weixin.qq.com/s/JiDOqD-ThU0Upp6xnNg3Nw" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-10">09 | JDK高版本特性总结与ZGC实践</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f063ce6e4d674d9faa2bbfcef50c8c79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=fIrErCanHJcFspog%2BdZWdljhkH0%3D" alt="" loading="lazy"/></p>
<p>美团信息安全技术团队核心服务升级JDK 17后，性能与稳定性大幅提升，机器成本降低了10%。高版本JDK与ZGC技术令人惊艳，且Java AI SDK最低支持JDK 17。本文总结了JDK 17的主要特性，然后重点分享了JDK 17+ZGC在安全领域的一些实践，希望能对大家有所帮助或启发。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXE_HnkVleuBDcWf-8-oBpQ" target="_blank" title="https://mp.weixin.qq.com/s/XE_HnkVleuBDcWf-8-oBpQ" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-11">10 | 鸿蒙应用签名实操及机制探究</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c072ce754af9496fb69be7443fbbfa62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=H%2FsLQCfuoel3LPiuuKnqiLLjJl4%3D" alt="" loading="lazy"/></p>
<p>华为鸿蒙单框架操作系统HarmonyOS NEXT已于2024年10月23日正式发布Release版。HarmonyOSNEXT仅支持鸿蒙原生应用，不再兼容安卓。本文对鸿蒙公开资料进行了深入分析和解读，梳理了鸿蒙单框架应用的签名机制，拆解每一步的实操过程和背后的实现原理，并对源码分析整理签名的校验机制。从中管中窥豹，探究鸿蒙系统的安全设计思路，给从事鸿蒙研发的同学提供一些借鉴。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F76wcXOf98nv8eRzJI71hWQ" target="_blank" title="https://mp.weixin.qq.com/s/76wcXOf98nv8eRzJI71hWQ" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-12">11 | 预测技术在美团弹性伸缩场景的探索与应用</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50e05bf71ef7491a9f69b21bcfe4050f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=ZJ%2Fl238K067dnALwLBvvYLAF4%2BI%3D" alt="" loading="lazy"/></p>
<p>管理企业大规模服务的弹性伸缩场景中，往往会面临着两个挑战：第一个挑战是精准的负载预测，由于应用实例的启动需要一定预热时间，被动响应式伸缩会在一段时间内影响服务质量；第二个挑战是高效的资源分配，即在保障服务质量的同时控制资源成本。为了解决这些挑战，美团与中国人民大学信息学院柴云鹏教授团队展开了“预测技术在弹性伸缩场景的应用”科研合作，相关论文《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.acm.org%2Fdoi%2F10.1145%2F3589334.3645330" target="_blank" title="https://dl.acm.org/doi/10.1145/3589334.3645330" ref="nofollow noopener noreferrer">PASS: Predictive Auto-Scaling System for Large-scale Enterprise Web Applications</a>》在具有国际影响力的会议The Web Conference 2024（CCF-A类会议）上作为Research Full Paper发表。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F7dwa3S2ziUed59O_idJq_A" target="_blank" title="https://mp.weixin.qq.com/s/7dwa3S2ziUed59O_idJq_A" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-13">12 | 从0到1建设美团数据库容量评估系统</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15c7b9045eb14d17b60db8f9b76590ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=7XhtcOm3OpxeGF63y0r8Nd15BWw%3D" alt="" loading="lazy"/></p>
<p>美团数据库团队推出了数据库容量评估系统，旨在解决数据库容量评估与变更风险防控等领域难题。本文介绍了系统架构和主要功能：系统使用线上流量在沙盒环境回放验证变更安全，结合倍速回放技术探测集群性能瓶颈，构建容量运营体系实现集群容量观测与治理闭环。系统具备数据操作安全、结果真实可靠、灵活高效赋能等特点，有效提升数据库稳定性与资源利用率。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FexcBMwipnmuRe730a8qfDw" target="_blank" title="https://mp.weixin.qq.com/s/excBMwipnmuRe730a8qfDw" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-14">13 | AI Coding与单元测试的协同进化：从验证到驱动</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb59dfd44ae347b0b489bef457fd6375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=dQ0U1EmSmhdQ5b3Ucc5uHy5rgeI%3D" alt="" loading="lazy"/></p>
<p>AI生成代码质量难以把控！本文分享来自美团的技术实践，三大策略破解AI编程痛点。单测快速验证逻辑正确性，安全网保护存量代码演进，TDD模式精准传递需求。告别「看起来没问题」的错觉，构建AI时代的代码质量保障体系。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fvqqw60fwEfI3pjBgUc4QUg" target="_blank" title="https://mp.weixin.qq.com/s/vqqw60fwEfI3pjBgUc4QUg" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-15">14 | LongCat-Flash：如何使用SGLang部署美团Agentic模型</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c17b62263d4b3eae4c4d740ea67e83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=VufS0Z6CoQLyEWC7MG42Ibz2XuA%3D" alt="" loading="lazy"/></p>
<p>SGLang 团队是业界专注于大模型推理系统优化的技术团队，提供并维护大模型推理的开源框架SGLang。近期，美团M17团队与SGLang团队一起合作，共同实现了LongCat-Flash模型在SGLang上的优化，并产出了一篇技术博客《LongCat-Flash: Deploying Meituan's Agentic Model with SGLang》，文章发表后，得到了很多技术同学的认可，因此我们将原文翻译出来，并添加了一些背景知识，希望更多同学能够从LongCat-Flash的系统优化中获益。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5BfcvmEp859wkKKGSMvP5g" target="_blank" title="https://mp.weixin.qq.com/s/5BfcvmEp859wkKKGSMvP5g" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-16">15 | 可信实验白皮书系列：从0到1的方法论与实践指南</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/754c29cb534d45a6aea4a407d63f5322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=zg5Ol0Qg4b8vBPkm6lG4EFZRk2o%3D" alt="" loading="lazy"/></p>
<p>增长与优化是企业永恒的主题。面对未知的策略价值，数据驱动的AB实验已经成为互联网企业在策略验证、产品迭代、算法优化、风险控制等方向必备的工具。越来越多的岗位，如数据科学家、算法工程师、产品经理以及运营人员等，要求候选人了解AB实验相关知识。然而，许多从业者由于缺乏有效的学习渠道，对AB实验的理解仍停留在初级阶段，甚至存在一些误解。我们希望通过系统性地分享和交流AB实验的理论基础、基本流程、核心要素及其应用优势，能够帮助更多相关人员深入了解实验，提升实验文化的普及度，最终辅助企业在更多领域做出精确数据驱动决策。</p>
<p>除了广泛传播实验文化外，该白皮书在深度上也可给实验研究人员，提供复杂业务制约下进行可信实验设计与科学分析评估的参考经验和启发。从美团履约技术团队、美团外卖业务的实践来看，实验者常常面临多种复杂的实验制约和难题，例如，在美团履约业务中，实验往往需要应对小样本、溢出效应（即实验单元间互相干扰）以及避免引发公平性风险等多重约束，需设计科学复杂的实验方案以克服相应挑战。通过撰写白皮书，我们系统性地总结和分享应对复杂实验约束的研究经验，进而能够促进实验技术的传播与升级，推动实验科学持续进步。</p>
<p>本白皮书以AB实验为中心，涵盖AB实验概述与价值、实验方法基础原理与案例剖析以及配套SDK代码分析等，内容丰富且易于理解和应用。适合从事AB实验研究的数据科学家、系统开发人员，以及需要实验驱动策略决策的业务和产研团队，同时也适合对数据驱动增长和数据科学等领域感兴趣的读者。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FgoYuFb1SdpZcoPci1lsosA" target="_blank" title="https://mp.weixin.qq.com/s/goYuFb1SdpZcoPci1lsosA" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p>| <strong>获取方式</strong>：关注美团技术团队微信公众号，在对话框回复「<strong>可信实验白皮书</strong>」即可获取PDF电子书下载链接。</p>
<h2 data-id="heading-17">产品服务</h2>
<h3 data-id="heading-18">16 | 无需代码！美团 NoCode 像聊天一样轻松搭建你的专属网站</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eab21ab000b34e8ca02b2eea67fb11cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=l0UJURAW9g1eDftqLT3%2B5x8A%2FMo%3D" alt="" loading="lazy"/></p>
<p>这是一款由美团技术团队打造的 AI 编程类产品——NoCode，可以像聊天一样轻松搭建你的专属网站、游戏、各种小工具等等，当然还有更多的隐藏功能等你发现，文末我们还准备了2项互动奖励，期待跟大家一起，开启全新的 AI 编程之旅。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FNYU-KGeE60xLbZbK1-kVzQ" target="_blank" title="https://mp.weixin.qq.com/s/NYU-KGeE60xLbZbK1-kVzQ" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-19">17 | 美团首款 AI IDE 产品 CatPaw 开启公测</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fa189d0e4ae494bae99521a0a51f908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=8b2gwECv8sA8RgIp2gAOeuHFP9s%3D" alt="" loading="lazy"/></p>
<p>Meituan CatPaw （以下统一使用“CatPaw”）是美团推出的 AI IDE，以 Agent &amp; 人协作为核心，通过 Agent 智能驱动编程，辅以代码补全、项目预览调试等功能，结合美团自研的基于编程场景特训的 LongCat 模型，并支持多种模型混合调用，让编码过程更专注，项目交付更高效！</p>
<p>CatPaw 早在 2023 年就在美团内部以编辑器插件形态正式上线，此次完成全新升级后进行公开测试。目前在美团内部研发渗透率超 95%，增量代码 AI 生成率超 50%。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGvAF_JU01eBdFchTt_-3Qw" target="_blank" title="https://mp.weixin.qq.com/s/GvAF_JU01eBdFchTt_-3Qw" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<h3 data-id="heading-20">18 | 美团 LongCat 上线 AI 生图！精准高效，AI 创作不设限</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/367cd22068c948268c0fdc27d26b94c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=lpBsXwdIBVYQ2AmJOSfLF3ymRUM%3D" alt="" loading="lazy"/></p>
<p>美团 LongCat 全新上线 AI 生图功能，该功能基于LongCat系列模型「LongCat-Image」打造而成。不仅在文生图任务中实现了“快、真、准” ：出图快速响应、达到摄影棚拍摄质感、中文渲染精准度高；更在图像编辑任务上做到了精准便捷，无需复杂指令，可以用自然语言对图像进行二次编辑。</p>
<p>无论是追求高效出图的普通用户，还是需要精准落地创意的专业创作者，LongCat 都以 “轻量化模型 + 流畅体验” ，让 AI 生图真正成为人人可用的创作工具。目前，AI 生图功能已在LongCat APP和 <a href="https://link.juejin.cn?target=https%3A%2F%2Flongcat.ai%2F" target="_blank" title="https://longcat.ai/" ref="nofollow noopener noreferrer">longcat.ai/</a> 同步上线，轻松解锁高效创作新方式。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fgh8EcUVp4Z6UnkgGRNCw2g" target="_blank" title="https://mp.weixin.qq.com/s/gh8EcUVp4Z6UnkgGRNCw2g" ref="nofollow noopener noreferrer">阅读全文</a>）</p>
<p>| 关注「美团技术团队」微信公众号，在公众号菜单栏对话框回复【2024年货】、【2023年货】、【2022年货】、【2021年货】、【2020年货】、【2019年货】、【2018年货】、【2017年货】等关键词，可查看美团技术团队历年技术文章合集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d91779962d948be809d71024c483dbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582017&amp;x-signature=J1d%2BLmWvrxi99lqOkKWvq5Z7fYg%3D" alt="" loading="lazy"/></p>
<p>| 本文系美团技术团队出品，著作权归属美团。欢迎出于分享和交流等非商业目的转载或使用本文内容，敬请注明“内容转载自美团技术团队”。本文未经许可，不得进行商业性转载或者使用。任何商用行为，请发送邮件至 <a href="https://link.juejin.cn?target=mailto%3Atech%40meituan.com" target="_blank" title="mailto:tech@meituan.com" ref="nofollow noopener noreferrer">tech@meituan.com</a> 申请授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot读取Excel文件，一场与“表格怪兽”的搏斗记]]></title>    <link>https://juejin.cn/post/7588793670494666792</link>    <guid>https://juejin.cn/post/7588793670494666792</guid>    <pubDate>2025-12-29T02:41:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588793670494666792" data-draft-id="7588793670494601256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot读取Excel文件，一场与“表格怪兽”的搏斗记"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-29T02:41:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot读取Excel文件，一场与“表格怪兽”的搏斗记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:41:24.000Z" title="Mon Dec 29 2025 02:41:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">前情提要：Excel——那个伪装成表格的数据怪兽</h2>
<p>想象一下，你正悠闲地喝着咖啡，产品经理突然拍着你的肩膀说：“嘿，这是客户发来的Excel文件，里面有十万条数据，明天上线前要导入系统哦！”</p>
<p>这时你才发现，你面对的不仅是一个.xlsx文件，而是一个披着网格外衣的“数据怪兽”。它有隐藏的工作表、合并的单元格、还有那些任性格式化的日期字段！但别怕，拿起SpringBoot这把“圣剑”，我们一起来驯服这个怪兽！</p>
<h2 data-id="heading-1">战斗准备：装备你的SpringBoot武器库</h2>
<h3 data-id="heading-2">第一步：添加神奇药剂（依赖）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 主武器：SpringBoot基础装备 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 对付Excel的专属神器：Apache POI --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi-ooxml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 辅助装备：简化代码的Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">第二步：创建数据模型——给怪兽分类</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">Data</span>;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;        <span class="hljs-comment">// 姓名列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> age;        <span class="hljs-comment">// 年龄列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> email;       <span class="hljs-comment">// 邮箱列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Date</span> birthDate;     <span class="hljs-comment">// 生日列（Excel最擅长把日期搞乱）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Double</span> salary;      <span class="hljs-comment">// 工资列（希望这个数字让你开心）</span>
    
    <span class="hljs-comment">// 可选：给怪兽的数据加个验证</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isValid</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> name != <span class="hljs-literal">null</span> &amp;&amp; !name.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">isEmpty</span>() 
            &amp;&amp; email != <span class="hljs-literal">null</span> &amp;&amp; email.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"@"</span>);
    }
}
</code></pre>
<h3 data-id="heading-4">第三步：创建Excel读取服务——我们的"怪兽翻译官"</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.poi.ss.usermodel.*;
<span class="hljs-keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcelReaderService</span> {
    
    <span class="hljs-comment">/**
     * 读取Excel文件的主要方法
     * <span class="hljs-doctag">@param</span> file 上传的Excel文件
     * <span class="hljs-doctag">@return</span> 用户列表
     * <span class="hljs-doctag">@throws</span> Exception 如果Excel怪兽太难对付
     */</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">readExcelFile</span><span class="hljs-params">(MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 安全检查：先确认这不是个空文件陷阱</span>
        <span class="hljs-keyword">if</span> (file.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"文件是空的！Excel怪兽使用了隐身术！"</span>);
        }
        
        <span class="hljs-comment">// 检查文件类型：.xlsx还是.xls？</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> file.getOriginalFilename();
        <span class="hljs-keyword">if</span> (fileName == <span class="hljs-literal">null</span> || (!fileName.endsWith(<span class="hljs-string">".xlsx"</span>) &amp;&amp; !fileName.endsWith(<span class="hljs-string">".xls"</span>))) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"这不是一个合法的Excel文件！可能是伪装的怪兽！"</span>);
        }
        
        List&lt;User&gt; userList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 尝试打开Excel文件（打开怪兽的嘴）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> file.getInputStream();
             <span class="hljs-type">Workbook</span> <span class="hljs-variable">workbook</span> <span class="hljs-operator">=</span> WorkbookFactory.create(inputStream)) {
            
            <span class="hljs-comment">// 获取第一个工作表（Excel怪兽可能有多个头）</span>
            <span class="hljs-type">Sheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> workbook.getSheetAt(<span class="hljs-number">0</span>);
            
            <span class="hljs-comment">// 遍历每一行（像翻阅怪兽的日记）</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= sheet.getLastRowNum(); i++) { <span class="hljs-comment">// 从1开始，跳过表头</span>
                <span class="hljs-type">Row</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> sheet.getRow(i);
                
                <span class="hljs-comment">// 跳过空行（怪兽的空白记忆）</span>
                <span class="hljs-keyword">if</span> (row == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">continue</span>;
                }
                
                <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> convertRowToUser(row);
                <span class="hljs-keyword">if</span> (user.isValid()) {
                    userList.add(user);
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"第 "</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">" 行数据不完整，已跳过"</span>);
                }
            }
        }
        
        System.out.println(<span class="hljs-string">"成功从Excel怪兽手中解救了 "</span> + userList.size() + <span class="hljs-string">" 个用户！"</span>);
        <span class="hljs-keyword">return</span> userList;
    }
    
    <span class="hljs-comment">/**
     * 把一行数据转换成User对象
     * 注意：这个方法要和Excel的结构对应上！
     */</span>
    <span class="hljs-keyword">private</span> User <span class="hljs-title function_">convertRowToUser</span><span class="hljs-params">(Row row)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 第一列：姓名（字符串）</span>
            <span class="hljs-type">Cell</span> <span class="hljs-variable">nameCell</span> <span class="hljs-operator">=</span> row.getCell(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (nameCell != <span class="hljs-literal">null</span>) {
                user.setName(getCellValueAsString(nameCell));
            }
            
            <span class="hljs-comment">// 第二列：年龄（数字）</span>
            <span class="hljs-type">Cell</span> <span class="hljs-variable">ageCell</span> <span class="hljs-operator">=</span> row.getCell(<span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span> (ageCell != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (ageCell.getCellType() == CellType.NUMERIC) {
                    user.setAge((<span class="hljs-type">int</span>) ageCell.getNumericCellValue());
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 尝试从字符串解析</span>
                    <span class="hljs-type">String</span> <span class="hljs-variable">ageStr</span> <span class="hljs-operator">=</span> getCellValueAsString(ageCell);
                    <span class="hljs-keyword">if</span> (ageStr.matches(<span class="hljs-string">"\\d+"</span>)) {
                        user.setAge(Integer.parseInt(ageStr));
                    }
                }
            }
            
            <span class="hljs-comment">// 第三列：邮箱（字符串）</span>
            <span class="hljs-type">Cell</span> <span class="hljs-variable">emailCell</span> <span class="hljs-operator">=</span> row.getCell(<span class="hljs-number">2</span>);
            <span class="hljs-keyword">if</span> (emailCell != <span class="hljs-literal">null</span>) {
                user.setEmail(getCellValueAsString(emailCell));
            }
            
            <span class="hljs-comment">// 第四列：生日（日期）</span>
            <span class="hljs-type">Cell</span> <span class="hljs-variable">birthCell</span> <span class="hljs-operator">=</span> row.getCell(<span class="hljs-number">3</span>);
            <span class="hljs-keyword">if</span> (birthCell != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (birthCell.getCellType() == CellType.NUMERIC &amp;&amp; 
                    DateUtil.isCellDateFormatted(birthCell)) {
                    user.setBirthDate(birthCell.getDateCellValue());
                }
            }
            
            <span class="hljs-comment">// 第五列：工资（数字）</span>
            <span class="hljs-type">Cell</span> <span class="hljs-variable">salaryCell</span> <span class="hljs-operator">=</span> row.getCell(<span class="hljs-number">4</span>);
            <span class="hljs-keyword">if</span> (salaryCell != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (salaryCell.getCellType() == CellType.NUMERIC) {
                    user.setSalary(salaryCell.getNumericCellValue());
                }
            }
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"处理第 "</span> + (row.getRowNum()+<span class="hljs-number">1</span>) + <span class="hljs-string">" 行时遇到问题: "</span> + e.getMessage());
        }
        
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-comment">/**
     * 智能获取单元格值作为字符串
     * Excel怪兽喜欢把数据打扮成各种类型
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getCellValueAsString</span><span class="hljs-params">(Cell cell)</span> {
        <span class="hljs-keyword">if</span> (cell == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        
        <span class="hljs-keyword">switch</span> (cell.getCellType()) {
            <span class="hljs-keyword">case</span> STRING:
                <span class="hljs-keyword">return</span> cell.getStringCellValue().trim();
            <span class="hljs-keyword">case</span> NUMERIC:
                <span class="hljs-keyword">if</span> (DateUtil.isCellDateFormatted(cell)) {
                    <span class="hljs-keyword">return</span> cell.getDateCellValue().toString();
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 避免科学计数法，也避免不必要的.0</span>
                    <span class="hljs-type">double</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> cell.getNumericCellValue();
                    <span class="hljs-keyword">if</span> (num == Math.floor(num)) {
                        <span class="hljs-keyword">return</span> String.valueOf((<span class="hljs-type">int</span>) num);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">return</span> String.valueOf(num);
                    }
                }
            <span class="hljs-keyword">case</span> BOOLEAN:
                <span class="hljs-keyword">return</span> String.valueOf(cell.getBooleanCellValue());
            <span class="hljs-keyword">case</span> FORMULA:
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> cell.getStringCellValue();
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">return</span> String.valueOf(cell.getNumericCellValue());
                    } <span class="hljs-keyword">catch</span> (Exception ex) {
                        <span class="hljs-keyword">return</span> cell.getCellFormula();
                    }
                }
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 高级功能：读取多个工作表
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, List&lt;User&gt;&gt; <span class="hljs-title function_">readMultipleSheets</span><span class="hljs-params">(MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception {
        Map&lt;String, List&lt;User&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> file.getInputStream();
             <span class="hljs-type">Workbook</span> <span class="hljs-variable">workbook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>(inputStream)) {
            
            <span class="hljs-comment">// 遍历所有工作表</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; workbook.getNumberOfSheets(); i++) {
                <span class="hljs-type">Sheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> workbook.getSheetAt(i);
                <span class="hljs-type">String</span> <span class="hljs-variable">sheetName</span> <span class="hljs-operator">=</span> sheet.getSheetName();
                List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                
                <span class="hljs-keyword">for</span> (Row row : sheet) {
                    <span class="hljs-keyword">if</span> (row.getRowNum() == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过表头</span>
                    
                    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> convertRowToUser(row);
                    <span class="hljs-keyword">if</span> (user.isValid()) {
                        users.add(user);
                    }
                }
                
                result.put(sheetName, users);
                System.out.println(<span class="hljs-string">"工作表 '"</span> + sheetName + <span class="hljs-string">"' 中读取到 "</span> + users.size() + <span class="hljs-string">" 个用户"</span>);
            }
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 data-id="heading-5">第四步：创建控制器——与前端通信的"传令兵"</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Autowired</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">http</span>.<span class="hljs-property">ResponseEntity</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.*;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">multipart</span>.<span class="hljs-property">MultipartFile</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">List</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api/excel"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcelController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">ExcelReaderService</span> excelReaderService;
    
    <span class="hljs-comment">/**
     * 上传并读取Excel文件
     * POST /api/excel/upload
     */</span>
    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/upload"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; <span class="hljs-title function_">uploadExcel</span>(<span class="hljs-params">
            <span class="hljs-meta">@RequestParam</span>(<span class="hljs-string">"file"</span>) MultipartFile file</span>) {
        
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 调用服务读取Excel</span>
            <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; users = excelReaderService.<span class="hljs-title function_">readExcelFile</span>(file);
            
            <span class="hljs-comment">// 构建响应</span>
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"success"</span>, <span class="hljs-literal">true</span>);
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"文件读取成功！"</span>);
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"totalRecords"</span>, users.<span class="hljs-title function_">size</span>());
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"data"</span>, users);
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"suggestions"</span>, <span class="hljs-title function_">generateSuggestions</span>(users));
            
            <span class="hljs-comment">// 这里可以添加数据库保存逻辑</span>
            <span class="hljs-comment">// userRepository.saveAll(users);</span>
            
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(response);
            
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"success"</span>, <span class="hljs-literal">false</span>);
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"读取文件时出错: "</span> + e.<span class="hljs-title function_">getMessage</span>());
            response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"error"</span>, e.<span class="hljs-title function_">toString</span>());
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">badRequest</span>().<span class="hljs-title function_">body</span>(response);
        }
    }
    
    <span class="hljs-comment">/**
     * 生成一些有趣的统计数据
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">generateSuggestions</span>(<span class="hljs-params">List&lt;User&gt; users</span>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; suggestions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">if</span> (users.<span class="hljs-title function_">isEmpty</span>()) {
            suggestions.<span class="hljs-title function_">put</span>(<span class="hljs-string">"note"</span>, <span class="hljs-string">"Excel文件是空的，或者没有找到有效数据"</span>);
            <span class="hljs-keyword">return</span> suggestions;
        }
        
        <span class="hljs-comment">// 统计平均年龄</span>
        double avgAge = users.<span class="hljs-title function_">stream</span>()
                .<span class="hljs-title function_">filter</span>(u -&gt; u.<span class="hljs-title function_">getAge</span>() != <span class="hljs-literal">null</span>)
                .<span class="hljs-title function_">mapToInt</span>(<span class="hljs-title class_">User</span>::getAge)
                .<span class="hljs-title function_">average</span>()
                .<span class="hljs-title function_">orElse</span>(<span class="hljs-number">0</span>);
        suggestions.<span class="hljs-title function_">put</span>(<span class="hljs-string">"averageAge"</span>, <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"%.1f 岁"</span>, avgAge));
        
        <span class="hljs-comment">// 统计最年长和最年轻</span>
        users.<span class="hljs-title function_">stream</span>()
                .<span class="hljs-title function_">filter</span>(u -&gt; u.<span class="hljs-title function_">getAge</span>() != <span class="hljs-literal">null</span>)
                .<span class="hljs-title function_">max</span>((u1, u2) -&gt; u1.<span class="hljs-title function_">getAge</span>() - u2.<span class="hljs-title function_">getAge</span>())
                .<span class="hljs-title function_">ifPresent</span>(oldest -&gt; 
                    suggestions.<span class="hljs-title function_">put</span>(<span class="hljs-string">"oldest"</span>, oldest.<span class="hljs-title function_">getName</span>() + <span class="hljs-string">" ("</span> + oldest.<span class="hljs-title function_">getAge</span>() + <span class="hljs-string">"岁)"</span>));
        
        <span class="hljs-comment">// 邮箱域名统计</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Long</span>&gt; emailDomains = users.<span class="hljs-title function_">stream</span>()
                .<span class="hljs-title function_">filter</span>(u -&gt; u.<span class="hljs-title function_">getEmail</span>() != <span class="hljs-literal">null</span> &amp;&amp; u.<span class="hljs-title function_">getEmail</span>().<span class="hljs-title function_">contains</span>(<span class="hljs-string">"@"</span>))
                .<span class="hljs-title function_">map</span>(u -&gt; u.<span class="hljs-title function_">getEmail</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">"@"</span>)[<span class="hljs-number">1</span>])
                .<span class="hljs-title function_">collect</span>(<span class="hljs-title class_">Collectors</span>.<span class="hljs-title function_">groupingBy</span>(domain -&gt; domain, <span class="hljs-title class_">Collectors</span>.<span class="hljs-title function_">counting</span>()));
        
        <span class="hljs-keyword">if</span> (!emailDomains.<span class="hljs-title function_">isEmpty</span>()) {
            suggestions.<span class="hljs-title function_">put</span>(<span class="hljs-string">"emailDomains"</span>, emailDomains);
        }
        
        <span class="hljs-keyword">return</span> suggestions;
    }
    
    <span class="hljs-comment">/**
     * 下载Excel模板
     * GET /api/excel/template
     */</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/template"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;byte[]&gt; <span class="hljs-title function_">downloadTemplate</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 这里可以创建一个模板Excel文件并返回</span>
        <span class="hljs-comment">// 为了简洁，这里省略具体实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>().<span class="hljs-title function_">body</span>(<span class="hljs-string">"请创建自己的模板文件"</span>.<span class="hljs-title function_">getBytes</span>());
    }
}
</code></pre>
<h3 data-id="heading-6">第五步：前端HTML页面——我们的"战斗指挥台"</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Excel文件读取器 - 怪兽驯服界面<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">40px</span> auto;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#f5f7fa</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#c3cfe2</span> <span class="hljs-number">100%</span>);
        }
        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">30px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
        }
        <span class="hljs-selector-tag">h1</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
        }
        <span class="hljs-selector-class">.upload-area</span> {
            <span class="hljs-attribute">border</span>: <span class="hljs-number">3px</span> dashed <span class="hljs-number">#4CAF50</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
        }
        <span class="hljs-selector-class">.upload-area</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0fff0</span>;
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#45a049</span>;
        }
        <span class="hljs-selector-class">.upload-area</span><span class="hljs-selector-class">.dragover</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e8f5e9</span>;
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#2e7d32</span>;
        }
        <span class="hljs-selector-id">#fileInput</span> {
            <span class="hljs-attribute">display</span>: none;
        }
        <span class="hljs-selector-class">.btn</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4CAF50</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">24px</span>;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span>;
        }
        <span class="hljs-selector-class">.btn</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#45a049</span>;
        }
        <span class="hljs-selector-class">.result</span> {
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8f9fa</span>;
            <span class="hljs-attribute">display</span>: none;
        }
        <span class="hljs-selector-class">.result</span><span class="hljs-selector-class">.success</span> {
            <span class="hljs-attribute">display</span>: block;
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#4CAF50</span>;
        }
        <span class="hljs-selector-class">.result</span><span class="hljs-selector-class">.error</span> {
            <span class="hljs-attribute">display</span>: block;
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#f44336</span>;
        }
        <span class="hljs-selector-tag">table</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">border-collapse</span>: collapse;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-tag">th</span>, <span class="hljs-selector-tag">td</span> {
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
            <span class="hljs-attribute">text-align</span>: left;
        }
        <span class="hljs-selector-tag">th</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4CAF50</span>;
            <span class="hljs-attribute">color</span>: white;
        }
        <span class="hljs-selector-tag">tr</span><span class="hljs-selector-pseudo">:nth-child</span>(even) {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f2f2f2</span>;
        }
        <span class="hljs-selector-class">.loading</span> {
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">display</span>: none;
        }
        <span class="hljs-selector-class">.loading</span><span class="hljs-selector-class">.show</span> {
            <span class="hljs-attribute">display</span>: block;
        }
        <span class="hljs-selector-class">.stats</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e8f5e9</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">15px</span> <span class="hljs-number">0</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Excel文件读取器<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>上传你的Excel文件，让我们一起驯服这个"数据怪兽"！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-area"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dropArea"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>拖放文件到这里<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>或者<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"document.getElementById('fileInput').click()"</span>&gt;</span>
                选择Excel文件
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">".xlsx,.xls"</span> <span class="hljs-attr">onchange</span>=<span class="hljs-string">"handleFileSelect()"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 15px; color: #666;"</span>&gt;</span>
                支持 .xlsx 和 .xls 格式，请确保第一行是表头
            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"loading"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"loading"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>正在读取Excel文件...<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>正在与Excel怪兽搏斗中，请稍候！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 20px;"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%; background-color: #ddd; border-radius: 5px;"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"progressBar"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 0%; height: 20px; background-color: #4CAF50; border-radius: 5px; transition: width 0.3s;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"result"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"result"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 30px; text-align: center;"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"downloadTemplate()"</span>&gt;</span>下载模板文件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"clearResults()"</span>&gt;</span>清除结果<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> dropArea = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dropArea'</span>);
        <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fileInput'</span>);
        <span class="hljs-keyword">const</span> loading = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'loading'</span>);
        <span class="hljs-keyword">const</span> resultDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>);
        <span class="hljs-keyword">const</span> progressBar = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'progressBar'</span>);
        
        <span class="hljs-comment">// 拖放功能</span>
        [<span class="hljs-string">'dragenter'</span>, <span class="hljs-string">'dragover'</span>, <span class="hljs-string">'dragleave'</span>, <span class="hljs-string">'drop'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
            dropArea.<span class="hljs-title function_">addEventListener</span>(eventName, preventDefaults, <span class="hljs-literal">false</span>);
        });
        
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">preventDefaults</span>(<span class="hljs-params">e</span>) {
            e.<span class="hljs-title function_">preventDefault</span>();
            e.<span class="hljs-title function_">stopPropagation</span>();
        }
        
        [<span class="hljs-string">'dragenter'</span>, <span class="hljs-string">'dragover'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
            dropArea.<span class="hljs-title function_">addEventListener</span>(eventName, highlight, <span class="hljs-literal">false</span>);
        });
        
        [<span class="hljs-string">'dragleave'</span>, <span class="hljs-string">'drop'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventName</span> =&gt;</span> {
            dropArea.<span class="hljs-title function_">addEventListener</span>(eventName, unhighlight, <span class="hljs-literal">false</span>);
        });
        
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">highlight</span>(<span class="hljs-params"/>) {
            dropArea.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'dragover'</span>);
        }
        
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">unhighlight</span>(<span class="hljs-params"/>) {
            dropArea.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'dragover'</span>);
        }
        
        dropArea.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'drop'</span>, handleDrop, <span class="hljs-literal">false</span>);
        
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDrop</span>(<span class="hljs-params">e</span>) {
            <span class="hljs-keyword">const</span> dt = e.<span class="hljs-property">dataTransfer</span>;
            <span class="hljs-keyword">const</span> files = dt.<span class="hljs-property">files</span>;
            fileInput.<span class="hljs-property">files</span> = files;
            <span class="hljs-title function_">handleFileSelect</span>();
        }
        
        <span class="hljs-comment">// 处理文件选择</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFileSelect</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> file = fileInput.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">if</span> (!file) <span class="hljs-keyword">return</span>;
            
            <span class="hljs-keyword">if</span> (!file.<span class="hljs-property">name</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\.(xlsx|xls)$/i</span>)) {
                <span class="hljs-title function_">showError</span>(<span class="hljs-string">'请选择Excel文件 (.xlsx 或 .xls)'</span>);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 显示加载动画</span>
            loading.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'show'</span>);
            resultDiv.<span class="hljs-property">className</span> = <span class="hljs-string">'result'</span>;
            progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'30%'</span>;
            
            <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
            formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, file);
            
            <span class="hljs-keyword">try</span> {
                progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'60%'</span>;
                
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/excel/upload'</span>, {
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
                    <span class="hljs-attr">body</span>: formData
                });
                
                progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'90%'</span>;
                
                <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
                
                progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'100%'</span>;
                
                <span class="hljs-keyword">if</span> (data.<span class="hljs-property">success</span>) {
                    <span class="hljs-title function_">showSuccess</span>(data);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-title function_">showError</span>(data.<span class="hljs-property">message</span>);
                }
                
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">showError</span>(<span class="hljs-string">'上传失败: '</span> + error.<span class="hljs-property">message</span>);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                    loading.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'show'</span>);
                    progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'0%'</span>;
                }, <span class="hljs-number">500</span>);
            }
        }
        
        <span class="hljs-comment">// 显示成功结果</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">showSuccess</span>(<span class="hljs-params">data</span>) {
            resultDiv.<span class="hljs-property">className</span> = <span class="hljs-string">'result success'</span>;
            
            <span class="hljs-keyword">let</span> html = <span class="hljs-string">`&lt;h3&gt;文件读取成功！&lt;/h3&gt;`</span>;
            html += <span class="hljs-string">`&lt;p&gt;共读取 &lt;strong&gt;<span class="hljs-subst">${data.totalRecords}</span>&lt;/strong&gt; 条记录&lt;/p&gt;`</span>;
            
            <span class="hljs-comment">// 显示统计信息</span>
            <span class="hljs-keyword">if</span> (data.<span class="hljs-property">suggestions</span>) {
                html += <span class="hljs-string">`&lt;div class="stats"&gt;`</span>;
                html += <span class="hljs-string">`&lt;h4&gt;统计信息：&lt;/h4&gt;`</span>;
                <span class="hljs-keyword">if</span> (data.<span class="hljs-property">suggestions</span>.<span class="hljs-property">averageAge</span>) {
                    html += <span class="hljs-string">`&lt;p&gt;平均年龄: <span class="hljs-subst">${data.suggestions.averageAge}</span>&lt;/p&gt;`</span>;
                }
                <span class="hljs-keyword">if</span> (data.<span class="hljs-property">suggestions</span>.<span class="hljs-property">oldest</span>) {
                    html += <span class="hljs-string">`&lt;p&gt;最年长: <span class="hljs-subst">${data.suggestions.oldest}</span>&lt;/p&gt;`</span>;
                }
                html += <span class="hljs-string">`&lt;/div&gt;`</span>;
            }
            
            <span class="hljs-comment">// 显示数据表格</span>
            <span class="hljs-keyword">if</span> (data.<span class="hljs-property">data</span> &amp;&amp; data.<span class="hljs-property">data</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                html += <span class="hljs-string">`&lt;h4&gt;数据预览（前10条）：&lt;/h4&gt;`</span>;
                html += <span class="hljs-string">`&lt;table&gt;`</span>;
                html += <span class="hljs-string">`&lt;tr&gt;&lt;th&gt;姓名&lt;/th&gt;&lt;th&gt;年龄&lt;/th&gt;&lt;th&gt;邮箱&lt;/th&gt;&lt;th&gt;生日&lt;/th&gt;&lt;th&gt;工资&lt;/th&gt;&lt;/tr&gt;`</span>;
                
                data.<span class="hljs-property">data</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
                    html += <span class="hljs-string">`&lt;tr&gt;`</span>;
                    html += <span class="hljs-string">`&lt;td&gt;<span class="hljs-subst">${user.name || <span class="hljs-string">''</span>}</span>&lt;/td&gt;`</span>;
                    html += <span class="hljs-string">`&lt;td&gt;<span class="hljs-subst">${user.age || <span class="hljs-string">''</span>}</span>&lt;/td&gt;`</span>;
                    html += <span class="hljs-string">`&lt;td&gt;<span class="hljs-subst">${user.email || <span class="hljs-string">''</span>}</span>&lt;/td&gt;`</span>;
                    html += <span class="hljs-string">`&lt;td&gt;<span class="hljs-subst">${user.birthDate || <span class="hljs-string">''</span>}</span>&lt;/td&gt;`</span>;
                    html += <span class="hljs-string">`&lt;td&gt;<span class="hljs-subst">${user.salary || <span class="hljs-string">''</span>}</span>&lt;/td&gt;`</span>;
                    html += <span class="hljs-string">`&lt;/tr&gt;`</span>;
                });
                
                html += <span class="hljs-string">`&lt;/table&gt;`</span>;
                
                <span class="hljs-keyword">if</span> (data.<span class="hljs-property">data</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">10</span>) {
                    html += <span class="hljs-string">`&lt;p&gt;... 还有 <span class="hljs-subst">${data.data.length - <span class="hljs-number">10</span>}</span> 条记录未显示&lt;/p&gt;`</span>;
                }
            }
            
            resultDiv.<span class="hljs-property">innerHTML</span> = html;
        }
        
        <span class="hljs-comment">// 显示错误</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">showError</span>(<span class="hljs-params">message</span>) {
            resultDiv.<span class="hljs-property">className</span> = <span class="hljs-string">'result error'</span>;
            resultDiv.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
                &lt;h3&gt;读取失败！&lt;/h3&gt;
                &lt;p&gt;<span class="hljs-subst">${message}</span>&lt;/p&gt;
                &lt;p&gt;请检查：&lt;/p&gt;
                &lt;ul&gt;
                    &lt;li&gt;文件是否为Excel格式&lt;/li&gt;
                    &lt;li&gt;文件是否损坏&lt;/li&gt;
                    &lt;li&gt;文件结构是否符合要求&lt;/li&gt;
                &lt;/ul&gt;
            `</span>;
        }
        
        <span class="hljs-comment">// 下载模板</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">downloadTemplate</span>(<span class="hljs-params"/>) {
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'模板下载功能需要后端实现！'</span>);
            <span class="hljs-comment">// 实际实现应该调用后端的模板下载接口</span>
            <span class="hljs-comment">// window.location.href = '/api/excel/template';</span>
        }
        
        <span class="hljs-comment">// 清除结果</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">clearResults</span>(<span class="hljs-params"/>) {
            resultDiv.<span class="hljs-property">className</span> = <span class="hljs-string">'result'</span>;
            resultDiv.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
            fileInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-7">第六步：配置文件——设置战斗参数</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">multipart:</span>
      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">10MB</span>      <span class="hljs-comment"># 最大文件大小</span>
      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">10MB</span>   <span class="hljs-comment"># 最大请求大小</span>
      
  <span class="hljs-comment"># 如果你要保存到数据库</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/excel_db</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    
  <span class="hljs-attr">jpa:</span>
    <span class="hljs-attr">hibernate:</span>
      <span class="hljs-attr">ddl-auto:</span> <span class="hljs-string">update</span>
    <span class="hljs-attr">show-sql:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 自定义配置</span>
<span class="hljs-attr">excel:</span>
  <span class="hljs-attr">upload:</span>
    <span class="hljs-attr">max-size:</span> <span class="hljs-number">10485760</span>  <span class="hljs-comment"># 10MB</span>
    <span class="hljs-attr">allowed-extensions:</span> <span class="hljs-string">.xlsx,.xls</span>
  <span class="hljs-attr">batch:</span>
    <span class="hljs-attr">insert-size:</span> <span class="hljs-number">1000</span>   <span class="hljs-comment"># 批量插入大小</span>
</code></pre>
<h2 data-id="heading-8">第七步：高级功能——添加批量处理</h2>
<pre><code class="hljs language-scss" lang="scss">import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Service</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.transaction</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Transactional</span>;

<span class="hljs-keyword">@Service</span>
public class ExcelBatchService {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserRepository userRepository;
    
    <span class="hljs-comment">/**
     * 批量保存用户，提高性能
     */</span>
    <span class="hljs-keyword">@Transactional</span>
    public void batchSaveUsers(List&lt;User&gt; users, int batchSize) {
        List&lt;User&gt; batch = new ArrayList&lt;&gt;(batchSize);
        
        for (int i = <span class="hljs-number">0</span>; i &lt; users.size(); <span class="hljs-selector-tag">i</span>++) {
            batch<span class="hljs-selector-class">.add</span>(users.get(i));
            
            if (batch.size() == batchSize || <span class="hljs-selector-tag">i</span> == users<span class="hljs-selector-class">.size</span>() - <span class="hljs-number">1</span>) {
                userRepository<span class="hljs-selector-class">.saveAll</span>(batch);
                batch<span class="hljs-selector-class">.clear</span>();
                
                <span class="hljs-comment">// 显示进度</span>
                System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.printf</span>("已保存 %d/%d 条记录 (%.<span class="hljs-number">1</span>f%%)%n", 
                    <span class="hljs-selector-tag">i</span> + <span class="hljs-number">1</span>, users<span class="hljs-selector-class">.size</span>(), (i + <span class="hljs-number">1</span>) * <span class="hljs-number">100.0</span> / users<span class="hljs-selector-class">.size</span>());
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 异步处理大文件
     */</span>
    <span class="hljs-keyword">@Async</span>
    public CompletableFuture&lt;List&lt;User&gt;&gt; processLargeFileAsync(MultipartFile file) {
        return CompletableFuture<span class="hljs-selector-class">.supplyAsync</span>(() -&gt; {
            try {
                <span class="hljs-comment">// 这里处理大文件，可以使用SAX模式读取</span>
                return <span class="hljs-built_in">readLargeExcelFile</span>(file);
            } catch (Exception e) {
                throw new <span class="hljs-built_in">RuntimeException</span>("处理文件失败", e);
            }
        });
    }
}
</code></pre>
<h2 data-id="heading-9">战斗总结：我们是如何驯服Excel怪兽的？</h2>
<p>经过这场与Excel怪兽的搏斗，我们学到了不少宝贵经验：</p>
<h3 data-id="heading-10">我们的战利品：</h3>
<ol>
<li><strong>Apache POI</strong>：我们的主力武器，专门对付各种Excel格式</li>
<li><strong>智能单元格处理</strong>：Excel怪兽喜欢把数据伪装成各种类型，我们都能识别</li>
<li><strong>批量处理能力</strong>：即使面对十万大军（数据），我们也能有序处理</li>
<li><strong>用户友好界面</strong>：让非技术人员也能轻松使用</li>
</ol>
<h3 data-id="heading-11">注意事项：</h3>
<ol>
<li><strong>内存管理</strong>：大文件就像大怪兽，小心它吃光你的内存！考虑使用SAX模式</li>
<li><strong>数据类型</strong>：Excel的日期格式是个狡猾的敌人，总想迷惑我们</li>
<li><strong>空值处理</strong>：Excel怪兽喜欢留空白，我们要妥善处理</li>
<li><strong>性能优化</strong>：批量操作和异步处理是我们的秘密武器</li>
</ol>
<h3 data-id="heading-12">可以继续增强的功能：</h3>
<ol>
<li><strong>数据验证</strong>：添加更严格的业务规则验证</li>
<li><strong>模板验证</strong>：检查上传文件是否符合预定模板</li>
<li><strong>错误报告</strong>：生成详细的错误报告，告诉用户哪里出错了</li>
<li><strong>进度反馈</strong>：对于大文件，提供实时进度反馈</li>
<li><strong>数据转换</strong>：更复杂的数据转换和清洗逻辑</li>
</ol>
<h3 data-id="heading-13">建议：</h3>
<p>每个Excel文件都是一个独特的"怪兽"，可能有自己的小脾气（奇怪的格式、隐藏的工作表等）。我们的代码要足够健壮，既能处理规整的数据，也能应对意外情况。</p>
<p>现在，当产品经理再给你Excel文件时，你可以微笑着说："放马过来吧，我有SpringBoot这个神器！"</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d0eb394f14141a3896d9fa0ed18a6ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580884&amp;x-signature=nRQBRnZD3r5A4WF5qBZyAIIimdw%3D" alt="SpringBoot读取Excel文件，一场与“表格怪兽”的搏斗记.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过 Python 提取 PDF 表格数据（导出为 TXT、Excel 格式）]]></title>    <link>https://juejin.cn/post/7588730836864466959</link>    <guid>https://juejin.cn/post/7588730836864466959</guid>    <pubDate>2025-12-29T03:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588730836864466959" data-draft-id="7588456115883261987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过 Python 提取 PDF 表格数据（导出为 TXT、Excel 格式）"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-12-29T03:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="咕白m625"/> <meta itemprop="url" content="https://juejin.cn/user/775609987638480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过 Python 提取 PDF 表格数据（导出为 TXT、Excel 格式）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/775609987638480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    咕白m625
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:11:51.000Z" title="Mon Dec 29 2025 03:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据处理与办公自动化场景中，PDF 表格因格式稳定被广泛使用，但不可直接编辑的特性，给数据统计、分析和二次加工带来诸多不便。手动复制粘贴不仅效率低下，还容易出现数据错位、遗漏等问题。</p>
<p>本文将分享一种高效的解决方案—基于Python结合Spire系列库，实现 PDF 表格数据的精准提取，并分别导出为 TXT 文本和 Excel 表格格式。该方案无需复杂的正则表达式或OCR识别，代码简洁易上手，适合批量处理各类PDF表格文件。</p>
<h2 data-id="heading-0">一、准备工作：安装所需 Python 库</h2>
<p>本次实战需要两个核心库，分别负责 PDF 表格提取和 Excel 文件生成，功能分工明确：</p>
<ul>
<li>• <strong>Spire.PDF for Python</strong>：一款轻量级 PDF 处理库，支持直接识别 PDF 中的表格结构，精准提取单元格数据，无需依赖额外的 OCR 工具。</li>
<li>• <strong>Spire.XLS for Python</strong>：专业的 Excel 操作库，可实现 Excel 文件的创建、数据写入、格式优化等功能，完美适配各类 Excel 版本。</li>
</ul>
<p>打开命令行终端，执行以下pip命令完成安装（建议在虚拟环境中操作，避免版本冲突）：</p>
<pre><code class="hljs language-bash" lang="bash">pip install Spire.PDF
pip install Spire.XLS
</code></pre>
<h2 data-id="heading-1">二、实战1：提取 PDF 表格数据到 TXT 文件</h2>
<p>TXT 文件具有体积小、兼容性强的特点，适合快速查看和传输数据。使用 Spire.PDF for Python 提取数据并写入 TXT 的核心逻辑，是按<strong>页面→表格→行→列</strong>的层级遍历 PDF 内容，最终将数据格式化输出。</p>
<h3 data-id="heading-2">实现步骤拆解</h3>
<ol>
<li><strong>加载 PDF 文档</strong>：通过 <code>PdfDocument</code> 类的 <code>LoadFromFile()</code> 方法读取目标 PDF 文件，支持相对路径和绝对路径。</li>
<li><strong>初始化提取工具</strong>：创建 <code>PdfTableExtractor</code> 对象，用于识别并提取 PDF 页面中的表格数据。</li>
<li><strong>层级遍历数据</strong>：依次遍历 PDF 的每一页、每页中的每个表格、表格的每一行和每一列，通过 <code>GetText(rowIndex, columnIndex)</code> 方法获取单元格文本。</li>
<li><strong>写入 TXT 文件</strong>：将提取的数据按“列用空格分隔、行用换行分隔”的格式整理，写入TXT文件并指定 UTF-8 编码，避免中文乱码。</li>
</ol>
<h3 data-id="heading-3">完整代码示例（含详细注释）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.pdf.common <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> spire.pdf <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># 1. 加载PDF文档，替换为你的目标PDF文件路径</span>
pdf_doc = PdfDocument()
pdf_doc.LoadFromFile(<span class="hljs-string">"表格.pdf"</span>)

<span class="hljs-comment"># 2. 创建列表存储提取的数据，便于后续拼接</span>
data_list = []

<span class="hljs-comment"># 3. 初始化表格提取器</span>
table_extractor = PdfTableExtractor(pdf_doc)

<span class="hljs-comment"># 4. 遍历PDF的每一页</span>
<span class="hljs-keyword">for</span> page_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pdf_doc.Pages.Count):
    <span class="hljs-comment"># 提取当前页面的所有表格</span>
    tables = table_extractor.ExtractTable(page_idx)
    <span class="hljs-comment"># 判断当前页面是否存在表格，避免空指针异常</span>
    <span class="hljs-keyword">if</span> tables <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(tables) &gt; <span class="hljs-number">0</span>:
        <span class="hljs-comment"># 遍历每个表格</span>
        <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> tables:
            row_num = table.GetRowCount()  <span class="hljs-comment"># 获取表格总行数</span>
            col_num = table.GetColumnCount()  <span class="hljs-comment"># 获取表格总列数</span>
            <span class="hljs-comment"># 遍历表格的每一行</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(row_num):
                row_data = []
                <span class="hljs-comment"># 遍历该行的每一列</span>
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(col_num):
                    <span class="hljs-comment"># 获取单元格文本</span>
                    cell_text = table.GetText(i, j)
                    row_data.append(cell_text)
                <span class="hljs-comment"># 用空格分隔列数据，拼接成一行</span>
                data_list.append(<span class="hljs-string">" "</span>.join(row_data))
            <span class="hljs-comment"># 不同表格之间添加空行，区分数据边界</span>
            data_list.append(<span class="hljs-string">""</span>)

<span class="hljs-comment"># 5. 将数据写入TXT文件</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"提取PDF表格.txt"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    f.write(<span class="hljs-string">"\n"</span>.join(data_list))

<span class="hljs-comment"># 6. 释放资源，避免内存占用</span>
pdf_doc.Close()
</code></pre>
<h2 data-id="heading-4">三、实战2：提取 PDF 表格数据到 Excel 文件</h2>
<p>Excel 文件支持数据筛选、公式计算、图表生成等高级功能，是数据分析的首选格式。本示例需要结合 <code>Spire.PDF for Python</code> 和 <code>Spire.XLS for Python</code>，在提取数据的基础上，实现 Excel 文件的创建和数据写入。</p>
<h3 data-id="heading-5">实现步骤拆解</h3>
<p>数据提取的步骤与 TXT 示例一致，额外增加 Excel 文件操作的3个核心步骤：</p>
<ol>
<li><strong>创建Excel工作簿</strong>：实例化 <code>Workbook</code> 对象，清空默认工作表，为后续添加新表格做准备。</li>
<li><strong>数据写入单元格</strong>：Excel 的行列索引从1开始（与Python的0索引不同），因此需要将表格的行、列索引分别+1，确保数据写入正确位置。</li>
<li><strong>优化表格格式</strong>：调用 <code>AutoFitColumns()</code> 方法设置列宽自适应内容，提升表格可读性，最后保存为指定版本的Excel文件。</li>
</ol>
<h3 data-id="heading-6">完整代码示例（含详细注释）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.pdf <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> spire.xls <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># 1. 加载PDF文档</span>
pdf_doc = PdfDocument()
pdf_doc.LoadFromFile(<span class="hljs-string">"表格.pdf"</span>)

<span class="hljs-comment"># 2. 创建Excel工作簿并清空默认工作表</span>
excel_workbook = Workbook()
excel_workbook.Worksheets.Clear()

<span class="hljs-comment"># 3. 初始化表格提取器</span>
table_extractor = PdfTableExtractor(pdf_doc)

<span class="hljs-comment"># 4. 工作表编号，用于命名新工作表</span>
sheet_index = <span class="hljs-number">1</span>

<span class="hljs-comment"># 5. 遍历PDF的每一页</span>
<span class="hljs-keyword">for</span> page_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pdf_doc.Pages.Count):
    tables = table_extractor.ExtractTable(page_idx)
    <span class="hljs-keyword">if</span> tables <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(tables) &gt; <span class="hljs-number">0</span>:
        <span class="hljs-comment"># 遍历当前页面的每个表格</span>
        <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> tables:
            <span class="hljs-comment"># 创建新工作表，命名为“sheet+编号”</span>
            worksheet = excel_workbook.Worksheets.Add(<span class="hljs-string">f"sheet<span class="hljs-subst">{sheet_index}</span>"</span>)
            row_num = table.GetRowCount()
            col_num = table.GetColumnCount()
            <span class="hljs-comment"># 遍历表格单元格</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(row_num):
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(col_num):
                    cell_text = table.GetText(i, j)
                    <span class="hljs-comment"># Excel索引从1开始，需将i和j分别+1</span>
                    worksheet.Range[i + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>].Value = cell_text
            <span class="hljs-comment"># 设置列宽自适应内容，优化显示效果</span>
            worksheet.AllocatedRange.AutoFitColumns()
            <span class="hljs-comment"># 工作表编号递增</span>
            sheet_index += <span class="hljs-number">1</span>

<span class="hljs-comment"># 6. 保存Excel文件，指定保存路径和Excel版本</span>
excel_workbook.SaveToFile(<span class="hljs-string">"导出PDF表格到Excel.xlsx"</span>, ExcelVersion.Version2016)

<span class="hljs-comment"># 7. 释放资源</span>
pdf_doc.Close()
excel_workbook.Dispose()
</code></pre>
<h2 data-id="heading-7">四、关键注意事项</h2>
<ol>
<li><strong>文件路径问题</strong>：若运行代码时提示“文件不存在”，请检查 PDF 文件路径是否正确，建议使用绝对路径（如 <code>C:/data/表格.pdf</code>）避免路径错误。</li>
<li><strong>中文乱码处理</strong>：写入 TXT 文件时，务必指定 <code>encoding="utf-8"</code>；导出 Excel 文件时，Spire.XLS for Python 默认支持中文，无需额外配置。</li>
<li><strong>资源释放</strong>：使用 <code>Close()</code> 和 <code>Dispose()</code> 方法释放 PDF 和 Excel 对象，避免长时间运行导致内存泄漏。</li>
</ol>
<h2 data-id="heading-8">五、总结</h2>
<p>基于Spire系列库，能够快速实现 PDF 表格数据的提取与格式转换，相比传统的手动操作，效率提升数十倍。该方案适用于各类场景，如批量提取财务报表、科研数据、政务文件中的 PDF 表格，为数据自动化处理提供了可靠的技术支撑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通用管理后台组件库-3-vue-i18n国际化集成]]></title>    <link>https://juejin.cn/post/7588865809473257512</link>    <guid>https://juejin.cn/post/7588865809473257512</guid>    <pubDate>2025-12-29T02:48:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588865809473257512" data-draft-id="7588730836864303119" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通用管理后台组件库-3-vue-i18n国际化集成"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T02:48:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没想好d"/> <meta itemprop="url" content="https://juejin.cn/user/1275872963211399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通用管理后台组件库-3-vue-i18n国际化集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1275872963211399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没想好d
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:48:13.000Z" title="Mon Dec 29 2025 02:48:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">i18n国际化集成</h2>
<p>说明：使用vue-i18n库实现系统国际化，结合@intlify/unplugin-vue-i18n插件实现预加载（开发中国际化显示），同时集成elementplus中en和zh-cn文件的组件国际化。</p>
<h4 data-id="heading-1">1.国际化文件</h4>
<p>/locales/en.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"anything"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anything"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hello"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hello"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>/locales/zh-CN.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hello"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-2">2.插件i18n ally, 使用命令添加文本国际化翻译</h4>
<p>.vscode/setting.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"i18n-ally.localesPaths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"locales"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.keystyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nested"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.sortKeys"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.namespace"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.enabledParsers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"yaml"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"js"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"json"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.sourceLanguage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"en"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.displayLanguage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zh-CN"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.enabledFrameworks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"i18n-ally.translate.engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"baidu"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"google"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-3">3.国际化i18n.ts</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">App</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { createI18n, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Locale</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-i18n'</span>

<span class="hljs-comment">// Legacy模式（选项式API）:语言设置是直接赋值,vue2的赋值方式</span>
<span class="hljs-comment">// Composition模式（组合式API）：语言设置是赋值给响应式变量</span>

<span class="hljs-comment">// 创建一个i18n实例</span>
<span class="hljs-keyword">const</span> i18n = <span class="hljs-title function_">createI18n</span>({
  <span class="hljs-attr">legacy</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">locale</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">messages</span>: {}
})

<span class="hljs-comment">// 解析locales目录下的所有语言文件，转换为对象，例如：{ en: () =&gt; import('../../locales/en.js'), zh-CN: () =&gt; import('../../locales/zh-CN.js') }</span>
<span class="hljs-keyword">const</span> localesMap = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-title function_">glob</span>(<span class="hljs-string">'../../locales/*.json'</span>)).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[path, loadLocale]</span>) =&gt;</span> [
    path.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/([\w-]*)\.json$/</span>)?.[<span class="hljs-number">1</span>],
    loadLocale
  ])
) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">Locale</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">default</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; }&gt;&gt;

<span class="hljs-comment">// 集成elementplus中的国际化文件en和zh-CN</span>
<span class="hljs-keyword">const</span> elementPlusLocaleMap = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-title function_">glob</span>(<span class="hljs-string">'../../node_modules/element-plus/dist/locale/*.mjs'</span>)).<span class="hljs-title function_">map</span>(
    <span class="hljs-function">(<span class="hljs-params">[path, loadLocale]</span>) =&gt;</span> [path.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/([\w-]*)\.mjs$/</span>)?.[<span class="hljs-number">1</span>], loadLocale]
  )
) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">Locale</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">default</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; }&gt;&gt;

<span class="hljs-comment">// 获取存在的语言数组</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> availableLocales = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(localesMap)

<span class="hljs-comment">// 过滤elementplus中的国际化文件，只保留en和zh-CN</span>
<span class="hljs-keyword">const</span> filterEPLocaleMap = availableLocales.<span class="hljs-title function_">reduce</span>(
  <span class="hljs-function">(<span class="hljs-params">acc: Record&lt;Locale, () =&gt; <span class="hljs-built_in">Promise</span>&lt;{ <span class="hljs-keyword">default</span>: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; }&gt;&gt;, locale: Locale</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      ...acc,
      <span class="hljs-comment">//locale.toLowerCase()将zh-CN转换为小写,elementplus中的语言文件都是小写的</span>
      [locale]: elementPlusLocaleMap[locale.<span class="hljs-title function_">toLowerCase</span>()]
    }
  },
  {}
)
<span class="hljs-comment">// 记住用户选择的语言</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">loadedLanguages</span>: <span class="hljs-built_in">string</span>[] = []

<span class="hljs-comment">// 设置国际化(i18n)语言的函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setI18nLanguage</span>(<span class="hljs-params">locale: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// Composition模式赋值</span>
  i18n.<span class="hljs-property">global</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">value</span> = locale
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">document</span> !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'html'</span>)?.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'lang'</span>, locale)
  }
}

<span class="hljs-comment">// 加载国际化(i18n)语言包的异步函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadLocaleMessages</span>(<span class="hljs-params">lang: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 如果语言包i18n已经加载过，则直接设置i18n.locale</span>
  <span class="hljs-keyword">if</span> (i18n.<span class="hljs-property">global</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">value</span> === lang || loadedLanguages.<span class="hljs-title function_">includes</span>(lang)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">setI18nLanguage</span>(lang)
  }
  <span class="hljs-comment">// 通过语言代码从预定义的语言映射中获取对应的语言包加载函数并执行</span>
  <span class="hljs-keyword">const</span> messages = <span class="hljs-keyword">await</span> localesMap[lang]()
  <span class="hljs-comment">// 获取elementplus的语言包</span>
  <span class="hljs-keyword">const</span> messagesEP = <span class="hljs-keyword">await</span> filterEPLocaleMap[lang]()
  <span class="hljs-comment">// 将加载的语言包设置到i18n实例中</span>
  i18n.<span class="hljs-property">global</span>.<span class="hljs-title function_">setLocaleMessage</span>(lang, { ...messagesEP.<span class="hljs-property">default</span>, ...messages.<span class="hljs-property">default</span> })
  loadedLanguages.<span class="hljs-title function_">push</span>(lang)
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">setI18nLanguage</span>(lang)
}

<span class="hljs-comment">// 挂载到app上</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">app: App</span>) {
    app.<span class="hljs-title function_">use</span>(i18n)
    <span class="hljs-comment">// 设置默认语言为中文</span>
    <span class="hljs-title function_">loadLocaleMessages</span>(<span class="hljs-string">'zh-CN'</span>)
  }
}
</code></pre>
<p>main.ts中挂载到app上</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">'./modules/i18n'</span>
app.<span class="hljs-title function_">use</span>(i18n)
</code></pre>
<h4 data-id="heading-4">4.构建和打包优化，因elementplus包中不止en和zh-cn文件，还有其他语言文件，所有在构建时过滤出en和zh-cn文件打包到dist中。</h4>
<p>vite.config.ts</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>
<span class="hljs-keyword">import</span> { defineConfig, loadEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> vueJsx <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue-jsx'</span>
<span class="hljs-keyword">import</span> vueDevTools <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-vue-devtools'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UnoCSS</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss/vite'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-router/vite'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VueRouterAutoImports</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Layouts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-vue-layouts'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VitePWA</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-pwa'</span>
<span class="hljs-keyword">import</span> { viteMockServe } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-mock'</span>
<span class="hljs-comment">// import dotenv from 'dotenv'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElementPlusResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>
<span class="hljs-comment">// Load environment variables</span>
<span class="hljs-keyword">import</span> { createSvgIconsPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-svg-icons'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueI18</span>nPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@intlify/unplugin-vue-i18n/vite'</span>

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-comment">// 加载环境变量</span>
  <span class="hljs-keyword">const</span> env = <span class="hljs-title function_">loadEnv</span>(mode, process.<span class="hljs-title function_">cwd</span>()) <span class="hljs-comment">// 加载 `.env.[mode]`</span>

  <span class="hljs-keyword">const</span> enablePWADEBUG = env.<span class="hljs-property">VITE_PWA_DEBUG</span> === <span class="hljs-string">'true'</span>
  <span class="hljs-keyword">const</span> enableMock = env.<span class="hljs-property">VITE_MOCK_ENABLE</span> === <span class="hljs-string">'true'</span>

  <span class="hljs-comment">/**
   * elementplus国际化文件打包和构建优化，只保留zh-cn和en文件到dist中。
   * 过滤elementplus的.mjs文件，不打包不需要的locales
   * 判断，/locales中对应的文件名的.mjs文件作为过滤条件-&gt;保留
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">filterElementPlusLocales</span>(<span class="hljs-params">id: string</span>) {
    <span class="hljs-comment">// 返回true表示打包，false表示不打包</span>
    <span class="hljs-comment">// locales文件查找</span>
    <span class="hljs-keyword">const</span> localesDir = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'locales'</span>)
    <span class="hljs-keyword">const</span> localesFiles = fs
      .<span class="hljs-title function_">readdirSync</span>(localesDir)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> file.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/([\w-]*)\.json$/</span>)?.[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>)
    <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'element-plus/dist/locale'</span>)) {
      <span class="hljs-comment">// 获取id的basename</span>
      <span class="hljs-keyword">const</span> basename = path.<span class="hljs-title function_">basename</span>(id, <span class="hljs-string">'.mjs'</span>)
      <span class="hljs-comment">// 判断basename是否在localesFiles中</span>
      <span class="hljs-keyword">return</span> !localesFiles.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> basename === file.<span class="hljs-title function_">toLowerCase</span>())
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">build</span>: {
      <span class="hljs-attr">rollupOptions</span>: {
        <span class="hljs-comment">// id:文件名，external:是否打包</span>
        <span class="hljs-attr">external</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> <span class="hljs-title function_">filterElementPlusLocales</span>(id)
      }
    },
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-title class_">VueRouter</span>(),
      <span class="hljs-title function_">vue</span>(),
      <span class="hljs-title function_">vueJsx</span>(),
      <span class="hljs-title function_">vueDevTools</span>(),
      <span class="hljs-title class_">UnoCSS</span>(),
      <span class="hljs-title class_">AutoImport</span>({
        <span class="hljs-attr">include</span>: [
          <span class="hljs-regexp">/\.[tj]sx?$/</span>, <span class="hljs-comment">// .ts, .tsx, .js, .jsx</span>
          <span class="hljs-regexp">/\.vue$/</span>,
          <span class="hljs-regexp">/\.vue\?vue/</span>, <span class="hljs-comment">// .vue</span>
          <span class="hljs-regexp">/\.md$/</span> <span class="hljs-comment">// .md</span>
        ],

        <span class="hljs-comment">// global imports to register</span>
        <span class="hljs-attr">imports</span>: [
          <span class="hljs-comment">// presets</span>
          <span class="hljs-string">'vue'</span>,
          <span class="hljs-comment">// 'vue-router'</span>
          <span class="hljs-title class_">VueRouterAutoImports</span>,
          <span class="hljs-string">'@vueuse/core'</span>
        ],
        <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()]
      }),
      <span class="hljs-title class_">Components</span>({
        <span class="hljs-attr">directoryAsNamespace</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">collapseSamePrefixes</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()]
      }),
      <span class="hljs-title class_">Layouts</span>({
        <span class="hljs-attr">layoutsDirs</span>: <span class="hljs-string">'src/layouts'</span>,
        <span class="hljs-attr">defaultLayout</span>: <span class="hljs-string">'default'</span>
      }),
      <span class="hljs-title class_">VitePWA</span>({
        <span class="hljs-attr">injectRegister</span>: <span class="hljs-string">'auto'</span>,
        <span class="hljs-attr">manifest</span>: {
          <span class="hljs-attr">name</span>: <span class="hljs-string">'Vite App'</span>,
          <span class="hljs-attr">short_name</span>: <span class="hljs-string">'Vite App'</span>,
          <span class="hljs-attr">theme_color</span>: <span class="hljs-string">'#ffffff'</span>,
          <span class="hljs-attr">icons</span>: [
            {
              <span class="hljs-attr">src</span>: <span class="hljs-string">'/192x192.png'</span>,
              <span class="hljs-attr">sizes</span>: <span class="hljs-string">'192x192'</span>,
              <span class="hljs-attr">type</span>: <span class="hljs-string">'image/png'</span>
            },
            {
              <span class="hljs-attr">src</span>: <span class="hljs-string">'/512x512.png'</span>,
              <span class="hljs-attr">sizes</span>: <span class="hljs-string">'512x512'</span>,
              <span class="hljs-attr">type</span>: <span class="hljs-string">'image/png'</span>
            }
          ]
        },
        <span class="hljs-attr">registerType</span>: <span class="hljs-string">'autoUpdate'</span>,
        <span class="hljs-attr">workbox</span>: {
          <span class="hljs-attr">navigateFallback</span>: <span class="hljs-string">'/'</span>,
          <span class="hljs-comment">// 如果大家有很大的资源文件，wasm bundle.js</span>
          <span class="hljs-attr">globPatterns</span>: [<span class="hljs-string">'**/*.*'</span>]
        },
        <span class="hljs-attr">devOptions</span>: {
          <span class="hljs-attr">enabled</span>: enablePWADEBUG,
          <span class="hljs-attr">suppressWarnings</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">navigateFallbackAllowlist</span>: [<span class="hljs-regexp">/^\/$/</span>],
          <span class="hljs-attr">type</span>: <span class="hljs-string">'module'</span>
        }
      }),
      <span class="hljs-title function_">viteMockServe</span>({
        <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>,
        <span class="hljs-attr">enable</span>: enableMock
      }),
      <span class="hljs-title function_">createSvgIconsPlugin</span>({
        <span class="hljs-comment">// 指定需要缓存的图标文件夹</span>
        <span class="hljs-attr">iconDirs</span>: [path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons'</span>)],
        <span class="hljs-comment">// 指定symbolId格式</span>
        <span class="hljs-attr">symbolId</span>: <span class="hljs-string">'icon-[dir]-[name]'</span>
      }),
      <span class="hljs-title class_">VueI18</span>nPlugin({
        <span class="hljs-attr">include</span>: [path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./locales/**'</span>)],
        <span class="hljs-comment">// 组合式赋值方式，契合Vue3.0</span>
        <span class="hljs-attr">compositionOnly</span>: <span class="hljs-literal">true</span>
      })
    ],
    <span class="hljs-attr">resolve</span>: {
      <span class="hljs-attr">alias</span>: {
        <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
      }
    }
  }
})

</code></pre>
<h4 data-id="heading-5">5.使用和效果</h4>
<pre><code class="hljs language-bash" lang="bash">&lt;div&gt;自定义国际化：{{ <span class="hljs-variable">$t</span>(<span class="hljs-string">'hello'</span>) }}&lt;/div&gt;
&lt;div&gt;elementplus国际化：{{ <span class="hljs-variable">$t</span>(<span class="hljs-string">'el.colorpicker.confirm'</span>) }}&lt;/div&gt;
&lt;div&gt;{{ <span class="hljs-variable">$t</span>(<span class="hljs-string">'anything'</span>) }}&lt;/div&gt;
&lt;el-select v-model=<span class="hljs-string">"locale"</span> placeholder=<span class="hljs-string">"请选择"</span> @change=<span class="hljs-string">"changeLocale"</span>
  &lt;el-option label=<span class="hljs-string">"中文"</span> value=<span class="hljs-string">"zh-CN"</span> /&gt;
  &lt;el-option label=<span class="hljs-string">"英文"</span> value=<span class="hljs-string">"en"</span> /&gt;
&lt;/el-select&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05fb5b1868234a1ea3074e37e0c0ec5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5oOz5aW9ZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581293&amp;x-signature=78Q1EHaIQyEALbgdj1jlBQxvxJs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13ff13eed41f46e1889b94bfa4a3eee2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5oOz5aW9ZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581293&amp;x-signature=DSzzhUb2dd3AwK6R70%2FgKKux1Ow%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js：Web 最重要的 3D 渲染引擎的技术综述]]></title>    <link>https://juejin.cn/post/7588680081352523812</link>    <guid>https://juejin.cn/post/7588680081352523812</guid>    <pubDate>2025-12-29T02:49:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081352523812" data-draft-id="7588124225702461480" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js：Web 最重要的 3D 渲染引擎的技术综述"/> <meta itemprop="keywords" content="three.js,WebGL,前端"/> <meta itemprop="datePublished" content="2025-12-29T02:49:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AlanHou"/> <meta itemprop="url" content="https://juejin.cn/user/62022837364253"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js：Web 最重要的 3D 渲染引擎的技术综述
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/62022837364253/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AlanHou
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:49:07.000Z" title="Mon Dec 29 2025 02:49:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>理解赋能 Web 实时 3D 图形的抽象层、渲染管线和性能特征。</strong></p>
</blockquote>
<p>现代 Web 越来越依赖丰富的视觉体验——数据可视化、模拟仿真、产品预览、生成艺术以及沉浸式 UI。虽然浏览器早已通过 Canvas 和 SVG 支持 2D 图形，但实时 3D 渲染需要一套复杂得多的 GPU 驱动操作。Three.js 已成为填补这一空白的<strong>事实标准（de facto standard）</strong> 。</p>
<p>虽然大多数介绍将 Three.js 描述为“一个 JavaScript 3D 库”，但它在架构上的角色更为基础。Three.js 是 WebGL 之上的一个结构化抽象层，旨在减少直接与 GPU 交互时的脚手架代码、复杂性和脆弱性。开发者无需手动管理着色器（shaders）、缓冲区（buffers）和渲染状态，而是使用连贯的高级构造——场景、相机、网格、材质——而库则负责高效地编排底层的 GPU 管线。</p>
<p>本文将从技术角度概述 Three.js 的工作原理、支持其性能的内部系统，以及为什么一旦应用程序超越简单的演示（demo）阶段，理解这些系统就变得至关重要。</p>
<h2 data-id="heading-0">I. Three.js 作为 WebGL 的抽象层</h2>
<p>WebGL 是一个低级 API，它将可编程图形管线暴露给浏览器。在其核心，WebGL 要求开发者手动处理：</p>
<ul>
<li>着色器的编译和链接</li>
<li>顶点和索引缓冲区的创建</li>
<li>属性（Attribute）和统一变量（Uniform）的绑定</li>
<li>纹理上传</li>
<li>状态变更</li>
<li>绘制调用（Draw call）的执行</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f943551e51d494caedf80be05e3fdaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581347&amp;x-signature=%2FHwgvTO9TEq79jxk%2FbkgNVAIw%2Fo%3D" alt="WebGL：底层图形 API 和状态机" loading="lazy"/>
Three.js 通过统一的渲染架构抽象了这些职责。</p>
<h3 data-id="heading-1">架构目的：结构化的 GPU 交互</h3>
<p>Three.js 不是 WebGL 的替代品；它是一个<strong>控制层</strong>，旨在消除冗余的复杂性，同时保留对底层 GPU 特性的访问能力。</p>
<p>它提供了：</p>
<ul>
<li>场景图（Scene graph）</li>
<li>几何体（Geometry）和材质（Material）抽象</li>
<li>中心化的渲染器（Renderer）</li>
<li>相机系统</li>
<li>对光照、阴影、动画和加载器的内置支持</li>
</ul>
<p>这在不降低能力的情况下减少了认知负荷。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea92b04cce474c0088fe682d64e4f3f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581347&amp;x-signature=dAIUJUUOz7tOEGi0flmvT8m%2Fat4%3D" alt="Three.js 不是 WebGL 的替代品；它是一个控制层" loading="lazy"/></p>
<h2 data-id="heading-2">II. 场景图：核心数据结构</h2>
<p>Three.js 将 3D 世界组织成一个分层的<strong>场景图（Scene Graph）</strong> ，其中每个对象都表示为一个具有变换（transform）和可选子节点的节点。</p>
<pre><code class="hljs language-scss" lang="scss">Scene (场景)
 ├── Mesh (网格)
 │     ├── Geometry (几何体)
 │     └── Material (材质)
 ├── Group (组)
 ├── Camera (相机)
 └── Lights (光源)
</code></pre>
<h3 data-id="heading-3">场景图在技术上的重要性</h3>
<p>每个节点都携带：</p>
<ul>
<li>局部变换矩阵（Local transformation matrix）</li>
<li>世界变换矩阵（World transformation matrix）</li>
<li>位置、旋转、缩放</li>
<li>父子关系</li>
</ul>
<p>在渲染期间，Three.js 遍历场景图以计算：</p>
<ul>
<li>更新后的世界矩阵</li>
<li>基于视锥体剔除（Frustum culling）的可见性</li>
<li>材质 + 几何体的组合</li>
<li>渲染顺序和绘制调用</li>
</ul>
<p>这种层级结构使得复杂的动画、实例化（instancing）和空间组织变得可预测且高效。如果没有场景图，开发者将需要手动同步数以百计或千计的独立 GPU 绑定对象。</p>
<h2 data-id="heading-4">III. 几何体、缓冲区和类型化数组</h2>
<p>在 GPU 层面，所有 3D 网格最终只是结构化的数字数组。Three.js 通过 <code>BufferGeometry</code> 暴露了这一点，它直接反映了 GPU 如何使用顶点数据。</p>
<p>一个 <code>BufferGeometry</code> 包含：</p>
<ul>
<li><code>position</code> 属性：每个顶点的 3D 坐标</li>
<li><code>normal</code> 属性：用于光照计算</li>
<li><code>uv</code> 属性：用于纹理映射</li>
<li>可选的 <code>index</code> 缓冲区 — 定义哪些顶点构成三角形</li>
</ul>
<p>每个属性都由<strong>类型化数组</strong>（Typed Array）支持，如 <code>Float32Array</code> 或 <code>Uint16Array</code>。</p>
<h3 data-id="heading-5">为什么类型化数组是必要的</h3>
<p>类型化数组提供：</p>
<ul>
<li>连续的内存布局</li>
<li>可预测的性能</li>
<li>到 GPU 缓冲区的直接二进制传输</li>
<li>每帧更新时的最小开销</li>
</ul>
<p>JavaScript 对象无法匹配这种级别的可预测性或效率。通过将几何体结构化为连续的缓冲区，Three.js 最小化了 CPU-GPU 的同步开销，即使在包含数万个顶点的场景中也能确保稳定的性能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959e25e7435b49d2851ef8cb9ebde2bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581347&amp;x-signature=%2Fsmx4X7NbB6TH90tD%2BH0Rc5UMN4%3D" alt="为什么类型化数组是必要的" loading="lazy"/></p>
<h2 data-id="heading-6">IV. 材质和着色器程序的生成</h2>
<p>Three.js 提供了多种材质类型——<code>MeshBasicMaterial</code>、<code>MeshStandardMaterial</code>、<code>MeshPhysicalMaterial</code>、<code>ShaderMaterial</code> 等。无论抽象级别如何，所有材质最终都会编译成在 GPU 上执行的 GLSL 着色器程序。</p>
<h3 data-id="heading-7">内部着色器系统</h3>
<p>Three.js 根据以下内容动态生成着色器：</p>
<ul>
<li>光照配置</li>
<li>阴影设置</li>
<li>雾化参数</li>
<li>纹理使用情况</li>
<li>材质类型和参数</li>
<li>精度和性能指令</li>
</ul>
<p>这种动态编译允许材质保持灵活性，同时确保着色器程序针对特定的场景配置进行优化。</p>
<h3 data-id="heading-8">为什么理解着色器仍然重要</h3>
<p>虽然 Three.js 抽象了着色器的创建，但开发者通常需要理解：</p>
<ul>
<li>法线映射（Normal mapping）</li>
<li>粗糙度/金属度工作流（Roughness/metalness workflows）</li>
<li>BRDF 计算</li>
<li>片元操作（Fragment operations）</li>
<li>渲染目标（Render target）行为</li>
</ul>
<p>自定义材质或高级效果几乎总是需要手动编写着色器，这使得 GLSL 读写能力成为严肃的 Three.js 开发的一项宝贵技能。</p>
<h2 data-id="heading-9">V. 渲染循环和帧生命周期</h2>
<p>Three.js 运行在一个可预测的渲染循环上，通常由 <code>requestAnimationFrame</code> 驱动。</p>
<p>每一帧涉及：</p>
<ol>
<li>处理动画更新</li>
<li>更新相机矩阵</li>
<li>遍历场景图</li>
<li>运行视锥体剔除</li>
<li>准备材质 + 着色器程序</li>
<li>准备几何体缓冲区</li>
<li>执行 WebGL 绘制调用</li>
<li>呈现帧</li>
</ol>
<p>整个过程必须在约 16 毫秒内完成，以维持 60 FPS。</p>
<h3 data-id="heading-10">关于渲染成本的技术观察</h3>
<ul>
<li>每个网格至少触发一次绘制调用</li>
<li>材质切换会产生 GPU 状态变更</li>
<li>阴影需要额外的渲染通道（Render passes）</li>
<li>动态对象比静态对象更昂贵</li>
</ul>
<p>渲染循环的效率直接决定了应用程序的性能。</p>
<h2 data-id="heading-11">VI. 性能架构：Three.js 中真正关键的因素</h2>
<p>Three.js 的性能瓶颈通常不在于 JavaScript 的执行，而在于 GPU 限制、显存带宽和绘制调用的开销。</p>
<p>以下是影响实际性能的领域：</p>
<h3 data-id="heading-12">1. 最小化绘制调用（Draw Call）</h3>
<p>GPU 执行少量的大型绘制调用比执行许多小型绘制调用更高效。每次绘制调用都需要状态绑定、程序切换和缓冲区设置。</p>
<p>优化措施包括：</p>
<ul>
<li>几何体合并（Geometry merging）</li>
<li>实例化网格（<code>InstancedMesh</code>）</li>
<li>减少材质变体</li>
<li>策略性地使用图层（Layers）和分组</li>
</ul>
<h3 data-id="heading-13">2. 纹理和内存策略</h3>
<p>高分辨率纹理会增加：</p>
<ul>
<li>VRAM（显存）使用</li>
<li>上传成本</li>
<li>Mipmap 生成时间</li>
</ul>
<p>WebGPU 将改善某些方面，但在 WebGL 上，使用压缩纹理格式（如 Basis/KTX2）可提供显著的性能提升。</p>
<h3 data-id="heading-14">3. CPU-GPU 同步约束</h3>
<p>在渲染循环内分配对象或每帧修改几何体属性会导致垃圾回收（GC）压力和缓冲区重新上传。</p>
<p>性能准则包括：</p>
<ul>
<li>避免在循环内重新创建向量或矩阵</li>
<li>除非必要，避免修改缓冲区几何体</li>
<li>优先使用基于着色器的变换</li>
</ul>
<h3 data-id="heading-15">4. 材质复杂性</h3>
<p>基于物理的渲染（PBR）材质（如 <code>MeshStandardMaterial</code>）计算量大，原因在于：</p>
<ul>
<li>环境采样</li>
<li>多光源计算</li>
<li>基于 BRDF 的着色</li>
</ul>
<p>选择最简单的适用材质通常能立即带来 FPS 的提升。</p>
<h2 data-id="heading-16">VII. Three.js 与 TypeScript：强大的架构组合</h2>
<p>Three.js 提供了健壮的 TypeScript 定义，强制执行：</p>
<ul>
<li>属性类型安全</li>
<li>几何体一致性</li>
<li>材质参数正确性</li>
<li>相机和渲染器配置的有效性</li>
</ul>
<p>在大型应用程序——可视化仪表盘、模拟仿真或产品配置器——中，Three.js 与类型化场景定义的结合显著减少了运行时缺陷。</p>
<h2 data-id="heading-17">VIII. 技术学习路径：从高级 API 到 GPU 理解</h2>
<p>Three.js 让人可以在几分钟内构建出功能性的 3D 场景。然而，一旦项目对性能、保真度或自定义视觉效果提出要求，深入的理解就变得不可或缺。</p>
<p>关键领域包括：</p>
<ul>
<li>GLSL 着色器开发</li>
<li>WebGL 管线状态机行为</li>
<li>GPU 内存限制</li>
<li>纹理流式传输（Streaming）和 Mipmapping</li>
<li>实例化（Instancing）和批处理（Batching）</li>
<li>渲染目标管理</li>
<li>后处理链（Post-processing chains）</li>
</ul>
<p>Three.js 提供了脚手架，但高性能的 3D 开发要求对库本身以及底层图形学原理都能熟练掌握。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af8e2970c6d844b1bc750a7ee7fc12d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581347&amp;x-signature=zm7K1Je1vsih5Jz7Io4w3KVc574%3D" alt="技术学习路径：从高级 API 到 GPU 理解" loading="lazy"/></p>
<h2 data-id="heading-18">结论</h2>
<p>Three.js 远不止是一个 WebGL 的便捷包装器。它是一个精心设计的渲染层，旨在使 GPU 编程变得易于上手，同时在需要时保留低级控制权。它在几何体、着色器、渲染循环和性能优化方面的结构化方法，为 JavaScript 和实时 3D 图形之间搭建了一座高效的桥梁。</p>
<p>随着 3D 界面、模拟仿真、数字孪生和 AR/VR 驱动的应用程序变得越来越普遍，从技术层面理解 Three.js 将成为一种有意义的工程优势。那些既理解抽象层又理解其背后 GPU 层面含义的开发者，将能够设计出不仅视觉震撼，而且稳健、高性能且可扩展的系统。</p>
<p>翻译整理自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fjavascript-in-plain-english%2Fthree-js-a-technical-overview-of-the-webs-most-important-3d-rendering-engine-5054199b75fe" target="_blank" title="https://medium.com/javascript-in-plain-english/three-js-a-technical-overview-of-the-webs-most-important-3d-rendering-engine-5054199b75fe" ref="nofollow noopener noreferrer">Three.js: A Technical Overview of the Web’s Most Important 3D Rendering Engine</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 跨层级组件通信：使用 `useContext` 打破“长安的荔枝”困境]]></title>    <link>https://juejin.cn/post/7588464673285947419</link>    <guid>https://juejin.cn/post/7588464673285947419</guid>    <pubDate>2025-12-29T03:01:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588464673285947419" data-draft-id="7588109656042438702" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 跨层级组件通信：使用 `useContext` 打破“长安的荔枝”困境"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-29T03:01:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 跨层级组件通信：使用 `useContext` 打破“长安的荔枝”困境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:01:58.000Z" title="Mon Dec 29 2025 03:01:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 开发中，组件通信是绕不开的核心话题。当应用结构逐渐复杂，父子组件之间的简单 <code>props</code> 传递就显得力不从心——尤其是当数据需要<strong>跨越多层组件</strong>传递时，开发者常常陷入“一路往下传”的泥潭。这种模式不仅代码冗余，还极难维护，被戏称为 <strong>“长安的荔枝”</strong> ：为了把一颗荔枝从岭南送到长安，要层层接力，劳民伤财。</p>
<p>幸运的是，React 提供了 <strong><code>useContext</code> + <code>createContext</code></strong> 的组合拳，让我们能<strong>在任意深度的子组件中直接获取顶层数据</strong>，彻底告别 props drilling（属性层层透传）。</p>
<p>本文将通过一个完整示例，带你掌握 <code>useContext</code> 的使用方法、原理和最佳实践。</p>
<hr/>
<h2 data-id="heading-0">一、问题场景：为什么需要跨层级通信？</h2>
<p>假设我们有如下组件树：</p>
<pre><code class="hljs language-css" lang="css">
App
 └── Page
      └── <span class="hljs-selector-tag">Header</span>
           └── UserInfo   ← 需要显示用户信息
</code></pre>
<ul>
<li>
<p>用户信息（如 <code>name: 'Andrew'</code>）在最顶层的 <code>App</code> 中定义。</p>
</li>
<li>
<p>而真正需要展示它的组件是深层嵌套的 <code>UserInfo</code>。</p>
</li>
<li>
<p>如果用传统 <code>props</code> 传递：</p>
<ul>
<li><code>App</code> → 传给 <code>Page</code></li>
<li><code>Page</code> → 传给 <code>Header</code></li>
<li><code>Header</code> → 传给 <code>UserInfo</code></li>
</ul>
</li>
</ul>
<p>中间的 <code>Page</code> 和 <code>Header</code> <strong>根本不关心用户数据</strong>，却被迫成为“传话筒”。这就是典型的 <strong>props drilling</strong> 问题。</p>
<blockquote>
<p>🍒 <strong>“长安的荔枝”比喻</strong>：<br/>
就像唐代为杨贵妃运送荔枝，从岭南到长安，沿途设驿站接力传递。中间每一站都不吃荔枝，只为传递而存在——效率低下，成本高昂。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、解决方案：React Context + useContext</h2>
<p>React 的 <strong>Context API</strong> 允许我们在组件树中<strong>创建一个全局可访问的数据容器</strong>，任何后代组件都可以直接“订阅”这个容器，无需中间组件介入。</p>
<h3 data-id="heading-2">✅ 核心三要素：</h3>

























<table><thead><tr><th>角色</th><th>API</th><th>作用</th></tr></thead><tbody><tr><td><strong>1. 创建上下文</strong></td><td><code>createContext(defaultValue)</code></td><td>创建一个 Context 对象</td></tr><tr><td><strong>2. 提供数据</strong></td><td><code>&lt;Context.Provider value={data}&gt;</code></td><td>在顶层包裹组件树，注入数据</td></tr><tr><td><strong>3. 消费数据</strong></td><td><code>const data = useContext(Context)</code></td><td>在任意子组件中读取数据</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">三、实战：用 <code>useContext</code> 实现用户信息共享</h2>
<h3 data-id="heading-4">步骤 1：创建 Context 容器（通常在 <code>App.js</code> 或单独文件）</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">import</span> { createContext, useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Page</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./views/Page'</span>;

<span class="hljs-comment">// 1. 创建 Context（可导出供其他文件使用）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 2. 定义要共享的数据</span>
  <span class="hljs-keyword">const</span> user = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Andrew'</span>,
    <span class="hljs-attr">role</span>: <span class="hljs-string">'Developer'</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 3. 用 Provider 包裹整个子树，提供 value</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{user}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Page</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p>💡 <code>createContext(null)</code> 中的 <code>null</code> 是默认值，当组件未被 <code>Provider</code> 包裹时使用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">步骤 2：在深层子组件中消费数据</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// components/UserInfo.jsx</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../App'</span>; <span class="hljs-comment">// 导入 Context</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 4. 使用 useContext 获取数据</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user); <span class="hljs-comment">// { name: 'Andrew', role: 'Developer' }</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>欢迎你，{user?.name}！<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>角色：{user?.role}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">UserInfo</span>;
</code></pre>
<blockquote>
<p>✅ 注意：</p>
<ul>
<li><code>UserInfo</code> 不需要任何 <code>props</code></li>
<li>即使它嵌套在 <code>Header</code> → <code>Page</code> 之下，也能直接访问 <code>user</code></li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-6">步骤 3：中间组件完全“无感”</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// components/Header.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserInfo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./UserInfo'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// Header 完全不知道 user 的存在！</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">UserInfo</span> /&gt;</span> {/* 直接使用，无需传 props */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Header</span>;
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// views/Page.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/Header'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// Page 也完全无感</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Page</span>;
</code></pre>
<blockquote>
<p>🎯 <strong>关键优势</strong>：<br/>
中间组件 <strong>零耦合、零负担</strong>，只负责自己的 UI 结构。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">四、useContext 的工作原理</h2>
<p>你可以把 <code>UserContext</code> 想象成一个<strong>全局广播站</strong>：</p>
<ul>
<li><code>&lt;UserContext.Provider value={user}&gt;</code>：开启广播，内容为 <code>user</code></li>
<li><code>useContext(UserContext)</code>：在任意位置“收听”这个频道</li>
<li>数据变化时，所有“听众”组件自动重新渲染（类似 state）</li>
</ul>
<blockquote>
<p>⚠️ 注意：Context 适合<strong>低频更新</strong>的全局状态（如用户信息、主题、语言）。高频状态（如表单输入）建议用 Zustand、Redux 或 useState 提升。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">五、最佳实践与注意事项</h2>
<h3 data-id="heading-9">✅ 1. 将 Context 抽离到单独文件（推荐）</h3>
<p>避免循环依赖，提高可维护性：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// contexts/UserContext.js</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">jsx
编辑
<span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./contexts/UserContext'</span>;
</code></pre>
<h3 data-id="heading-10">✅ 2. 提供默认值或空对象</h3>
<p>防止未包裹 Provider 时崩溃：</p>
<pre><code class="hljs language-ini" lang="ini">
const <span class="hljs-attr">user</span> = useContext(UserContext) || {}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-11">✅ 3. 避免滥用 Context</h3>
<ul>
<li>不要为每个小状态都创建 Context</li>
<li>合并相关状态到一个 Context（如 <code>AuthContext</code> 包含 user、login、logout）</li>
</ul>
<h3 data-id="heading-12">✅ 4. 性能优化：拆分 Context</h3>
<p>如果多个不相关的数据放在一起，会导致<strong>无关组件不必要的重渲染</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">
// ❌ 不好：一个 Context 包含所有
&lt;UserContext.Provider <span class="hljs-attr">value</span>={{ user, theme, lang }}&gt;

// ✅ 好：按功能拆分
&lt;AuthContext.Provider <span class="hljs-attr">value</span>={auth}&gt;
&lt;ThemeContext.Provider <span class="hljs-attr">value</span>={theme}&gt;
</code></pre>
<hr/>
<h2 data-id="heading-13">六、useContext vs 其他状态管理方案</h2>



































<table><thead><tr><th>方案</th><th>适用场景</th><th>学习成本</th><th>适用规模</th></tr></thead><tbody><tr><td><code>useState</code> + Props</td><td>简单父子通信</td><td>⭐</td><td>小型组件</td></tr><tr><td><code>useContext</code></td><td>跨层级、低频全局状态</td><td>⭐⭐</td><td>中小型应用</td></tr><tr><td>Zustand / Jotai</td><td>复杂状态、高频更新</td><td>⭐⭐</td><td>中大型应用</td></tr><tr><td>Redux</td><td>超大型应用、时间旅行调试</td><td>⭐⭐⭐</td><td>大型团队项目</td></tr></tbody></table>
<blockquote>
<p>💡 对于大多数 React 应用，<strong><code>useContext</code> + <code>useReducer</code> 已足够应对 80% 的状态管理需求</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">七、总结：告别“长安的荔枝”，拥抱 Context</h2>
<ul>
<li><strong>问题</strong>：props drilling 导致中间组件冗余、维护困难。</li>
<li><strong>方案</strong>：使用 <code>createContext</code> + <code>Provider</code> + <code>useContext</code> 创建全局数据通道。</li>
<li><strong>效果</strong>：任意深度子组件直接访问数据，中间组件零负担。</li>
<li><strong>原则</strong>：用于<strong>跨层级、低频更新</strong>的共享状态。</li>
</ul>
<blockquote>
<p>🌟 <strong>记住</strong>：<br/>
<strong>Context 不是万能的，但它是解决“跨层级通信”最轻量、最 React 原生的方式。</strong></p>
</blockquote>
<p>现在，你可以自信地重构那些“传了五层 props 才到目标组件”的代码了！让数据像空气一样，在组件树中自由流动，而无需层层搬运 🍃。</p>
<hr/>
<p><strong>动手试试吧！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端必备技能：彻底搞懂JavaScript深浅拷贝，告别数据共享的坑！]]></title>    <link>https://juejin.cn/post/7588711557499519026</link>    <guid>https://juejin.cn/post/7588711557499519026</guid>    <pubDate>2025-12-29T03:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588711557499519026" data-draft-id="7588695570635128870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端必备技能：彻底搞懂JavaScript深浅拷贝，告别数据共享的坑！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T03:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端必备技能：彻底搞懂JavaScript深浅拷贝，告别数据共享的坑！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:15:24.000Z" title="Mon Dec 29 2025 03:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>❤ 写在前面<br/>
如果觉得对你有帮助的话，点个小❤❤ 吧，你的支持是对我最大的鼓励~<br/>
个人独立开发wx小程序，感谢支持！
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfTGlrZXJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582924&amp;x-signature=chl3%2Byup2mXw7GcM6zXhpET%2Bta8%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">开篇故事：为什么我的数据“打架”了？</h2>
<p>想象一下这个场景：你在开发一个购物车功能，复制了一个商品对象准备修改数量，结果发现原始商品的数据也变了！这种“灵异事件”让很多前端开发者头疼不已。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> originalProduct = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"JavaScript高级程序设计"</span>,
  <span class="hljs-attr">price</span>: <span class="hljs-number">99</span>,
  <span class="hljs-attr">details</span>: {
    <span class="hljs-attr">publisher</span>: <span class="hljs-string">"人民邮电出版社"</span>,
    <span class="hljs-attr">pages</span>: <span class="hljs-number">728</span>
  }
};

<span class="hljs-comment">// 你以为的“复制”</span>
<span class="hljs-keyword">let</span> copiedProduct = originalProduct;
copiedProduct.<span class="hljs-property">price</span> = <span class="hljs-number">79</span>; <span class="hljs-comment">// 修改副本的价格</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(originalProduct.<span class="hljs-property">price</span>); <span class="hljs-comment">// 79？！原对象也被修改了！</span>
</code></pre>
<p>这就是我们今天要解决的“深浅拷贝”问题！下面，让我们一步步解开这个谜团。</p>
<h2 data-id="heading-1">内存模型：理解深浅拷贝的基础</h2>
<p>在深入之前，我们先看看JavaScript中数据是如何存储的：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────┐      ┌───────────────┐
│  栈内存     │      │   堆内存       │
│ (Stack)     │      │   (Heap)      │
├─────────────┤      ├───────────────┤
│ 基本类型    │      │               │
│ 变量名|值   │      │  引用类型     │
│ <span class="hljs-selector-tag">a</span> -&gt; <span class="hljs-number">10</span>     │      │  的对象数据   │
│ <span class="hljs-selector-tag">b</span> -&gt; true   │      │  {name: <span class="hljs-string">"xxx"</span>}│
│             │      │  <span class="hljs-selector-attr">[1,2,3]</span>      │
│ obj1 -&gt; ↗═══╪══════&gt; {x: <span class="hljs-number">1</span>, y: <span class="hljs-number">2</span>}  │
│ obj2 -&gt; ↗═══╪══════&gt; {name: <span class="hljs-string">"test"</span>}│
└─────────────┘      └───────────────┘
</code></pre>
<p>基本类型（Number, String, Boolean等）直接存储在栈内存中，而引用类型（Object, Array等）在栈中只存储地址指针，真正的数据在堆内存中。</p>
<h2 data-id="heading-2">深浅拷贝对比流程图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[原始对象] --&gt; B{选择拷贝方式}
    B --&gt; C[浅拷贝]
    B --&gt; D[深拷贝]
    
    C --&gt; E[只复制第一层属性]
    E --&gt; F[嵌套对象仍共享内存]
    F --&gt; G[修改嵌套属性会影响原对象]
    
    D --&gt; H[递归复制所有层级]
    H --&gt; I[完全独立的新对象]
    I --&gt; J[新旧对象互不影响]
    
    G --&gt; K[适用场景：简单数据结构]
    J --&gt; L[适用场景：复杂嵌套对象]
</code></pre>
<h2 data-id="heading-3">浅拷贝：只挖第一层</h2>
<p>浅拷贝就像只复制房子的钥匙，不复制房子里的家具。</p>
<h3 data-id="heading-4">常见的浅拷贝方法</h3>
<h4 data-id="heading-5">方法1：展开运算符（最常用）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> shallowCopy = { ...originalObject };
<span class="hljs-keyword">let</span> shallowCopyArray = [...originalArray];
</code></pre>
<h4 data-id="heading-6">方法2：Object.assign()</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> shallowCopy = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, originalObject);
</code></pre>
<h4 data-id="heading-7">方法3：数组的slice()和concat()</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> shallowCopyArray = originalArray.<span class="hljs-title function_">slice</span>();
<span class="hljs-keyword">let</span> anotherCopy = originalArray.<span class="hljs-title function_">concat</span>();
</code></pre>
<h3 data-id="heading-8">浅拷贝的陷阱</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> user = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"小明"</span>,
  <span class="hljs-attr">settings</span>: {
    <span class="hljs-attr">theme</span>: <span class="hljs-string">"dark"</span>,
    <span class="hljs-attr">notifications</span>: <span class="hljs-literal">true</span>
  }
};

<span class="hljs-keyword">let</span> userCopy = { ...user };
userCopy.<span class="hljs-property">name</span> = <span class="hljs-string">"小红"</span>; <span class="hljs-comment">// ✅ 不会影响原对象</span>
userCopy.<span class="hljs-property">settings</span>.<span class="hljs-property">theme</span> = <span class="hljs-string">"light"</span>; <span class="hljs-comment">// ❌ 原对象的theme也被修改了！</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">settings</span>.<span class="hljs-property">theme</span>); <span class="hljs-comment">// "light" 中招了！</span>
</code></pre>
<h2 data-id="heading-9">深拷贝：连根拔起的复制</h2>
<p>深拷贝是真正的"克隆"，创建一个完全独立的新对象。</p>
<h3 data-id="heading-10">方法1：JSON大法（最简单但有局限）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> deepCopy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(originalObject));
</code></pre>
<p><strong>注意限制：</strong></p>
<ul>
<li>不能复制函数、undefined、Symbol</li>
<li>不能处理循环引用</li>
<li>Date对象会变成字符串</li>
</ul>
<h3 data-id="heading-11">方法2：手写递归深拷贝函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj, hash = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakMap</span>()</span>) {
  <span class="hljs-comment">// 处理基本类型和null</span>
  <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">return</span> obj;
  }
  
  <span class="hljs-comment">// 处理Date</span>
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(obj);
  }
  
  <span class="hljs-comment">// 处理数组</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj)) {
    <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">deepClone</span>(item, hash));
  }
  
  <span class="hljs-comment">// 处理普通对象</span>
  <span class="hljs-keyword">if</span> (hash.<span class="hljs-title function_">has</span>(obj)) {
    <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(obj); <span class="hljs-comment">// 解决循环引用</span>
  }
  
  <span class="hljs-keyword">let</span> cloneObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj));
  hash.<span class="hljs-title function_">set</span>(obj, cloneObj);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
      cloneObj[key] = <span class="hljs-title function_">deepClone</span>(obj[key], hash);
    }
  }
  
  <span class="hljs-keyword">return</span> cloneObj;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">let</span> complexObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"测试"</span>,
  <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
  <span class="hljs-attr">nested</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> },
  <span class="hljs-attr">arr</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>]]
};
complexObj.<span class="hljs-property">self</span> = complexObj; <span class="hljs-comment">// 循环引用</span>

<span class="hljs-keyword">let</span> cloned = <span class="hljs-title function_">deepClone</span>(complexObj);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cloned !== complexObj); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cloned.<span class="hljs-property">nested</span> !== complexObj.<span class="hljs-property">nested</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cloned.<span class="hljs-property">self</span> === cloned); <span class="hljs-comment">// true，循环引用正确处理</span>
</code></pre>
<h3 data-id="heading-12">方法3：使用现成库</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// lodash</span>
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
<span class="hljs-keyword">let</span> deepCopy = _.<span class="hljs-title function_">cloneDeep</span>(originalObject);

<span class="hljs-comment">// 或者使用structuredClone（现代浏览器原生API）</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> structuredClone === <span class="hljs-string">'function'</span>) {
  <span class="hljs-keyword">let</span> deepCopy = <span class="hljs-title function_">structuredClone</span>(originalObject);
}
</code></pre>
<h2 data-id="heading-13">实战场景：什么时候用什么拷贝？</h2>
<h3 data-id="heading-14">场景1：表单编辑（推荐深拷贝）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 编辑前深拷贝原始数据</span>
<span class="hljs-keyword">let</span> editData = <span class="hljs-title function_">deepClone</span>(originalData);

<span class="hljs-comment">// 用户随意编辑...</span>
editData.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">avatar</span> = <span class="hljs-string">"new_avatar.jpg"</span>;

<span class="hljs-comment">// 点击取消，原始数据完好无损</span>
<span class="hljs-comment">// 点击保存，提交editData</span>
</code></pre>
<h3 data-id="heading-15">场景2：状态管理中的状态更新（浅拷贝足够）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Redux reducer中的状态更新</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state = initialState, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'UPDATE_SETTINGS'</span>:
      <span class="hljs-keyword">return</span> {
        ...state, <span class="hljs-comment">// 浅拷贝</span>
        <span class="hljs-attr">settings</span>: {
          ...state.<span class="hljs-property">settings</span>, <span class="hljs-comment">// 嵌套对象也需要展开</span>
          <span class="hljs-attr">theme</span>: action.<span class="hljs-property">payload</span>
        }
      };
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<h3 data-id="heading-16">场景3：配置对象合并（浅拷贝+深度合并）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeConfig</span>(<span class="hljs-params">defaultConfig, userConfig</span>) {
  <span class="hljs-keyword">return</span> {
    ...defaultConfig,
    ...userConfig,
    <span class="hljs-comment">// 深度合并嵌套对象</span>
    <span class="hljs-attr">options</span>: {
      ...defaultConfig.<span class="hljs-property">options</span>,
      ...userConfig.<span class="hljs-property">options</span>
    }
  };
}
</code></pre>
<h2 data-id="heading-17">性能考虑：深浅拷贝的选择</h2>



































<table><thead><tr><th>方法</th><th>速度</th><th>内存占用</th><th>适用场景</th></tr></thead><tbody><tr><td>浅拷贝</td><td>⚡⚡⚡⚡⚡（快）</td><td>少</td><td>简单对象，无嵌套修改</td></tr><tr><td>JSON深拷贝</td><td>⚡⚡⚡（中）</td><td>中</td><td>数据简单，无函数/日期</td></tr><tr><td>递归深拷贝</td><td>⚡⚡（慢）</td><td>多</td><td>复杂对象，需要完整复制</td></tr><tr><td>structuredClone</td><td>⚡⚡⚡⚡（较快）</td><td>中</td><td>现代浏览器，需要原生支持</td></tr></tbody></table>
<h2 data-id="heading-18">总结：拷贝选择速查表</h2>
<ol>
<li><strong>只需要复制第一层数据？</strong> → 使用展开运算符 <code>...</code></li>
<li><strong>需要完全独立的副本？</strong> → 使用深拷贝</li>
<li><strong>数据简单，不含函数/日期？</strong> → <code>JSON.parse(JSON.stringify())</code></li>
<li><strong>需要处理复杂类型和循环引用？</strong> → 手写递归或使用lodash</li>
<li><strong>现代浏览器环境？</strong> → 尝试 <code>structuredClone</code></li>
</ol>
<p>记住这个黄金法则：<strong>当你不知道嵌套属性是否需要独立修改时，选择深拷贝更安全！</strong></p>
<h2 data-id="heading-19">互动挑战</h2>
<p>试试看你能看出下面代码的输出吗？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> puzzle = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">b</span>: { <span class="hljs-attr">inner</span>: <span class="hljs-number">2</span> },
  <span class="hljs-attr">c</span>: [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
};

<span class="hljs-keyword">let</span> copy1 = { ...puzzle };
<span class="hljs-keyword">let</span> copy2 = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(puzzle));

copy1.<span class="hljs-property">b</span>.<span class="hljs-property">inner</span> = <span class="hljs-number">999</span>;
copy1.<span class="hljs-property">c</span>.<span class="hljs-title function_">push</span>(<span class="hljs-number">888</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(puzzle.<span class="hljs-property">b</span>.<span class="hljs-property">inner</span>); <span class="hljs-comment">// 是多少？</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(puzzle.<span class="hljs-property">c</span>.<span class="hljs-property">length</span>); <span class="hljs-comment">// 是多少？</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(copy2.<span class="hljs-property">b</span>.<span class="hljs-property">inner</span>); <span class="hljs-comment">// 是多少？</span>
</code></pre>
<p>答案：第一个是999（浅拷贝共享嵌套对象），第二个是4（数组也被修改了），第三个是2（深拷贝完全独立）。</p>
<p>希望这篇博客能帮你彻底理解JavaScript中的深浅拷贝！下次遇到数据"打架"的情况，你就知道该怎么处理了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端实战：让表格Header优雅吸顶的魔法]]></title>    <link>https://juejin.cn/post/7588461466598981683</link>    <guid>https://juejin.cn/post/7588461466598981683</guid>    <pubDate>2025-12-29T03:17:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588461466598981683" data-draft-id="7588487605249097737" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端实战：让表格Header优雅吸顶的魔法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T03:17:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端实战：让表格Header优雅吸顶的魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:17:50.000Z" title="Mon Dec 29 2025 03:17:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>❤ 写在前面<br/>
如果觉得对你有帮助的话，点个小❤❤ 吧，你的支持是对我最大的鼓励~<br/>
个人独立开发wx小程序，感谢支持！
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfTGlrZXJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583070&amp;x-signature=IqrKW0nwUssVX9rM0tSB9V%2BwDFM%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">引言：当表格太长时，表头去哪了？</h2>
<p>你有没有遇到过这样的尴尬场景：查看一个超长的数据表格，滚动到下面时，完全忘记了每一列代表什么意思？只能不停地上下来回滚动，就像在玩“表头捉迷藏”游戏。</p>
<p>今天，我要分享的正是解决这个痛点的实用技巧——<strong>表格Header吸顶效果</strong>。就像给你的表格表头装上“磁铁”，无论怎么滚动，表头都会固定在顶部！</p>
<h2 data-id="heading-1">效果展示</h2>
<p>想象一下这样的体验：</p>
<ul>
<li>默认状态：表头在表格顶部</li>
<li>向下滚动：表头“粘”在浏览器顶部</li>
<li>继续滚动：表头始终可见</li>
<li>向上滚动：表头回归原位</li>
</ul>
<p>是不是很酷？让我们一步步实现它！</p>
<h2 data-id="heading-2">技术方案对比</h2>
<h3 data-id="heading-3">方案一：CSS <code>position: sticky</code>（简单但有限制）</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">thead</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}
</code></pre>
<p><strong>优点</strong>：一行代码搞定！
<strong>缺点</strong>：父容器不能有<code>overflow: hidden</code>，兼容性需要考虑</p>
<h3 data-id="heading-4">方案二：JavaScript动态计算（灵活可控）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听滚动，动态切换样式</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (table到达顶部) {
    表头添加固定定位
  } <span class="hljs-keyword">else</span> {
    表头移除固定定位
  }
});
</code></pre>
<p><strong>优点</strong>：兼容性好，控制精细
<strong>缺点</strong>：需要写更多代码</p>
<h2 data-id="heading-5">完整实现方案（JavaScript版）</h2>
<h3 data-id="heading-6">第一步：HTML结构准备</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page-header"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>员工信息表<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>共128条记录，滚动查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-wrapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sticky-table"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">thead</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>ID<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>部门<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>职位<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>入职时间<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>状态<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据行会通过JS生成 --&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">第二步：CSS样式设计</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础样式 */</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.page-header</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#6a11cb</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#2575fc</span> <span class="hljs-number">100%</span>);
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">30px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
  <span class="hljs-attribute">text-align</span>: center;
}

<span class="hljs-selector-class">.table-wrapper</span> {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
}

<span class="hljs-comment">/* 表格基础样式 */</span>
<span class="hljs-selector-id">#sticky-table</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">border-collapse</span>: collapse;
}

<span class="hljs-comment">/* 表头默认样式 */</span>
<span class="hljs-selector-class">.table-header</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2c3e50</span>;
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-selector-class">.table-header</span> <span class="hljs-selector-tag">th</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span> <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">text-align</span>: left;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#34495e</span>;
}

<span class="hljs-comment">/* 表头吸顶时的样式 */</span>
<span class="hljs-selector-class">.table-header</span><span class="hljs-selector-class">.sticky</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2c3e50</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">12px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>);
  <span class="hljs-attribute">animation</span>: slideDown <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-comment">/* 吸顶动画 */</span>
<span class="hljs-keyword">@keyframes</span> slideDown {
  <span class="hljs-selector-tag">from</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">100%</span>);
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
  <span class="hljs-selector-tag">to</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>);
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  }
}

<span class="hljs-comment">/* 数据行样式 */</span>
<span class="hljs-selector-tag">tbody</span> <span class="hljs-selector-tag">tr</span> {
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.2s</span>;
}

<span class="hljs-selector-tag">tbody</span> <span class="hljs-selector-tag">tr</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f9f9f9</span>;
}

<span class="hljs-selector-tag">tbody</span> <span class="hljs-selector-tag">td</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">14px</span> <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
}

<span class="hljs-selector-class">.status-active</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#27ae60</span>;
  <span class="hljs-attribute">font-weight</span>: bold;
}

<span class="hljs-selector-class">.status-inactive</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#e74c3c</span>;
  <span class="hljs-attribute">font-weight</span>: bold;
}
</code></pre>
<h3 data-id="heading-8">第三步：JavaScript实现逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StickyTableHeader</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tableId</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(tableId);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">header</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'thead'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSticky</span> = <span class="hljs-literal">false</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 创建占位元素（防止表头固定后表格内容跳动）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createPlaceholder</span>();
    
    <span class="hljs-comment">// 2. 生成测试数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateTableData</span>();
    
    <span class="hljs-comment">// 3. 监听滚动事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleScroll</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    
    <span class="hljs-comment">// 4. 监听窗口大小变化（重新计算位置）</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
  }
  
  <span class="hljs-title function_">createPlaceholder</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建与表头相同大小的透明占位元素</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span>.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.header.offsetHeight}</span>px`</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">insertBefore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>);
  }
  
  <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 获取表格相对于视口的位置</span>
    <span class="hljs-keyword">const</span> tableRect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> headerHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-property">header</span>.<span class="hljs-property">offsetHeight</span>;
    
    <span class="hljs-comment">// 判断逻辑：表格顶部是否滚动出视口</span>
    <span class="hljs-keyword">if</span> (tableRect.<span class="hljs-property">top</span> &lt;= <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">activateSticky</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tableRect.<span class="hljs-property">top</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deactivateSticky</span>();
    }
    
    <span class="hljs-comment">// 额外优化：如果表格底部已经在视口中，取消固定</span>
    <span class="hljs-keyword">if</span> (tableRect.<span class="hljs-property">bottom</span> &lt;= headerHeight + <span class="hljs-number">100</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deactivateSticky</span>();
    }
  }
  
  <span class="hljs-title function_">handleResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 窗口大小变化时，更新占位元素高度</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span>.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.header.offsetHeight}</span>px`</span>;
    }
    
    <span class="hljs-comment">// 如果当前是吸顶状态，需要重新计算宽度</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSticky</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setHeaderWidth</span>();
    }
  }
  
  <span class="hljs-title function_">activateSticky</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSticky</span> = <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 添加吸顶类名</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">header</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'sticky'</span>);
    
    <span class="hljs-comment">// 显示占位元素</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'block'</span>;
    
    <span class="hljs-comment">// 设置表头宽度与表格一致</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setHeaderWidth</span>();
  }
  
  <span class="hljs-title function_">deactivateSticky</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isSticky</span> = <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 移除吸顶类名</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">header</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'sticky'</span>);
    
    <span class="hljs-comment">// 隐藏占位元素</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">placeholder</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  }
  
  <span class="hljs-title function_">setHeaderWidth</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 确保固定表头的宽度与表格容器一致</span>
    <span class="hljs-keyword">const</span> tableWidth = <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-property">offsetWidth</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">header</span>.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${tableWidth}</span>px`</span>;
    
    <span class="hljs-comment">// 同步每一列的宽度</span>
    <span class="hljs-keyword">const</span> ths = <span class="hljs-variable language_">this</span>.<span class="hljs-property">header</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'th'</span>);
    <span class="hljs-keyword">const</span> tbodyFirstRow = <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'tbody tr'</span>);
    
    <span class="hljs-keyword">if</span> (tbodyFirstRow) {
      <span class="hljs-keyword">const</span> tds = tbodyFirstRow.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'td'</span>);
      
      ths.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">th, index</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (tds[index]) {
          th.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${tds[index].offsetWidth}</span>px`</span>;
        }
      });
    }
  }
  
  <span class="hljs-title function_">generateTableData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 生成模拟数据</span>
    <span class="hljs-keyword">const</span> departments = [<span class="hljs-string">'技术部'</span>, <span class="hljs-string">'市场部'</span>, <span class="hljs-string">'设计部'</span>, <span class="hljs-string">'人力资源'</span>, <span class="hljs-string">'财务部'</span>];
    <span class="hljs-keyword">const</span> positions = [<span class="hljs-string">'工程师'</span>, <span class="hljs-string">'经理'</span>, <span class="hljs-string">'设计师'</span>, <span class="hljs-string">'专员'</span>, <span class="hljs-string">'总监'</span>, <span class="hljs-string">'助理'</span>];
    <span class="hljs-keyword">const</span> statuses = [<span class="hljs-string">'active'</span>, <span class="hljs-string">'inactive'</span>];
    
    <span class="hljs-keyword">const</span> tbody = <span class="hljs-variable language_">this</span>.<span class="hljs-property">table</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'tbody'</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">50</span>; i++) {
      <span class="hljs-keyword">const</span> row = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'tr'</span>);
      
      <span class="hljs-keyword">const</span> department = departments[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * departments.<span class="hljs-property">length</span>)];
      <span class="hljs-keyword">const</span> position = positions[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * positions.<span class="hljs-property">length</span>)];
      <span class="hljs-keyword">const</span> status = statuses[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * statuses.<span class="hljs-property">length</span>)];
      <span class="hljs-keyword">const</span> startDate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2018</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">5</span>), 
                                 <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">12</span>), 
                                 <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">28</span>) + <span class="hljs-number">1</span>);
      
      row.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
        &lt;td&gt;<span class="hljs-subst">${<span class="hljs-number">1000</span> + i}</span>&lt;/td&gt;
        &lt;td&gt;员工<span class="hljs-subst">${i}</span>&lt;/td&gt;
        &lt;td&gt;<span class="hljs-subst">${department}</span>&lt;/td&gt;
        &lt;td&gt;<span class="hljs-subst">${position}</span>&lt;/td&gt;
        &lt;td&gt;<span class="hljs-subst">${startDate.getFullYear()}</span>-<span class="hljs-subst">${<span class="hljs-built_in">String</span>(startDate.getMonth() + <span class="hljs-number">1</span>).padStart(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>-<span class="hljs-subst">${<span class="hljs-built_in">String</span>(startDate.getDate()).padStart(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>&lt;/td&gt;
        &lt;td class="status-<span class="hljs-subst">${status}</span>"&gt;<span class="hljs-subst">${status === <span class="hljs-string">'active'</span> ? <span class="hljs-string">'在职'</span> : <span class="hljs-string">'离职'</span>}</span>&lt;/td&gt;
      `</span>;
      
      tbody.<span class="hljs-title function_">appendChild</span>(row);
    }
  }
}

<span class="hljs-comment">// 初始化表格</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">StickyTableHeader</span>(<span class="hljs-string">'sticky-table'</span>);
  
  <span class="hljs-comment">// 添加滚动提示</span>
  <span class="hljs-keyword">const</span> hint = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  hint.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #3498db;
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 14px;
    z-index: 1001;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    animation: bounce 2s infinite;
  `</span>;
  hint.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'👇 滚动试试，表头会吸顶哦！'</span>;
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(hint);
  
  <span class="hljs-comment">// 添加提示动画</span>
  <span class="hljs-keyword">const</span> style = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'style'</span>);
  style.<span class="hljs-property">textContent</span> = <span class="hljs-string">`
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
  `</span>;
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(style);
  
  <span class="hljs-comment">// 5秒后隐藏提示</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    hint.<span class="hljs-property">style</span>.<span class="hljs-property">opacity</span> = <span class="hljs-string">'0'</span>;
    hint.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">'opacity 1s'</span>;
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> hint.<span class="hljs-title function_">remove</span>(), <span class="hljs-number">1000</span>);
  }, <span class="hljs-number">5000</span>);
});
</code></pre>
<h2 data-id="heading-9">实现原理流程图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[开始] --&gt; B[初始化表格和表头]
    B --&gt; C[创建占位元素]
    C --&gt; D[生成表格数据]
    D --&gt; E[监听滚动事件]
    
    E --&gt; F{表格顶部是否滚动出视口?}
    F --&gt;|是| G[激活吸顶效果]
    F --&gt;|否| H[检查是否已吸顶]
    
    H --&gt;|是| I[取消吸顶效果]
    H --&gt;|否| E
    
    G --&gt; J[添加sticky类名]
    J --&gt; K[显示占位元素]
    K --&gt; L[设置表头宽度]
    L --&gt; E
    
    I --&gt; M[移除sticky类名]
    M --&gt; N[隐藏占位元素]
    N --&gt; E
</code></pre>
<h2 data-id="heading-10">关键技巧和注意事项</h2>
<h3 data-id="heading-11">1. 占位元素的重要性</h3>
<p>吸顶效果会让表头脱离文档流，导致下面的内容突然上跳。占位元素在表头固定时显示，保持布局稳定。</p>
<h3 data-id="heading-12">2. 性能优化</h3>
<ul>
<li>使用<code>requestAnimationFrame</code>优化滚动事件</li>
<li>添加防抖处理，避免频繁计算</li>
<li>缓存DOM查询结果</li>
</ul>
<p>优化后的滚动处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">handleScroll</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用requestAnimationFrame优化性能</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">ticking</span>) {
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateStickyState</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ticking</span> = <span class="hljs-literal">false</span>;
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ticking</span> = <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<h3 data-id="heading-13">3. 边界情况处理</h3>
<ul>
<li>表格数据很少时，不需要吸顶</li>
<li>窗口大小变化时，重新计算宽度</li>
<li>表格完全滚动出视口时，取消吸顶</li>
</ul>
<h3 data-id="heading-14">4. 视觉细节</h3>
<ul>
<li>添加平滑过渡动画</li>
<li>固定时添加阴影，增强层次感</li>
<li>保持表头列宽与数据列对齐</li>
</ul>
<h2 data-id="heading-15">响应式设计考虑</h2>
<p>在移动设备上，我们可能需要调整吸顶策略：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 移动端调整 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.table-header</span><span class="hljs-selector-class">.sticky</span> {
    <span class="hljs-comment">/* 移动端可以缩小内边距 */</span>
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">4px</span>;
  }
  
  <span class="hljs-comment">/* 表格水平滚动 */</span>
  <span class="hljs-selector-class">.table-wrapper</span> {
    <span class="hljs-attribute">overflow-x</span>: auto;
  }
  
  <span class="hljs-selector-id">#sticky-table</span> {
    <span class="hljs-attribute">min-width</span>: <span class="hljs-number">600px</span>;
  }
}
</code></pre>
<h2 data-id="heading-16">总结</h2>
<p>实现表格Header吸顶效果，就像给用户提供了一个"阅读助手"，让长表格的浏览体验大大提升。通过今天分享的方法，你可以：</p>
<ol>
<li>用少量代码实现核心功能</li>
<li>处理各种边界情况</li>
<li>优化性能确保流畅体验</li>
<li>适配不同设备屏幕</li>
</ol>
<p>记住，好的用户体验往往就藏在这些细节中。下次当你遇到长表格时，不妨试试这个"吸顶魔法"，让你的页面变得更加友好！</p>
<h2 data-id="heading-17">动手试试</h2>
<p>你可以复制上面的代码到本地HTML文件，或者访问我在CodePen上创建的<a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io" target="_blank" title="https://codepen.io" ref="nofollow noopener noreferrer">示例</a>（模拟链接），直接体验和修改代码。</p>
<p><strong>小挑战</strong>：尝试添加一个功能，当表头吸顶时，右侧显示一个"回到顶部"的按钮，点击后平滑滚动到表格开始位置。祝你好运！</p>
<hr/>
<p>希望这篇教程对你有所帮助！如果有任何问题或改进建议，欢迎在评论区留言讨论。Happy coding! 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 智能体高可靠设计模式：并行执行]]></title>    <link>https://juejin.cn/post/7588865809473486888</link>    <guid>https://juejin.cn/post/7588865809473486888</guid>    <pubDate>2025-12-29T03:14:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588865809473486888" data-draft-id="7588456115883311139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 智能体高可靠设计模式：并行执行"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-29T03:14:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俞凡"/> <meta itemprop="url" content="https://juejin.cn/user/290747765274222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 智能体高可靠设计模式：并行执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290747765274222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俞凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:14:52.000Z" title="Mon Dec 29 2025 03:14:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>本系列介绍增强现代智能体系统可靠性的设计模式，以直观方式逐一介绍每个概念，拆解其目的，然后实现简单可行的版本，演示其如何融入现实世界的智能体系统。本系列一共 14 篇文章，这是第 1 篇。原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Flevelup.gitconnected.com%2Fbuilding-the-14-key-pillars-of-agentic-ai-229e50f65986" title="https://levelup.gitconnected.com/building-the-14-key-pillars-of-agentic-ai-229e50f65986" target="_blank" ref="nofollow noopener noreferrer">Building the 14 Key Pillars of Agentic AI</a></em></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffd9f041f934487f9d82064babdcbdbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582891&amp;x-signature=9ijX4n24pV0Goi7VLLjrgaIaeQk%3D" alt="" loading="lazy"/></p>
<p>优化智能体解决方案需要软件工程确保组件协调、并行运行并与系统高效交互。例如<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSpeculative_execution" title="https://en.wikipedia.org/wiki/Speculative_execution" target="_blank" ref="nofollow noopener noreferrer">预测执行</a>，会尝试处理可预测查询以<strong>降低时延</strong>，或者进行<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.arm.com%2Fcommunity%2Farm-community-blogs%2Fb%2Fembedded-and-microcontrollers-blog%2Fposts%2Fcomparing-lock-step-redundant-execution-versus-split-lock-technologies" title="https://developer.arm.com/community/arm-community-blogs/b/embedded-and-microcontrollers-blog/posts/comparing-lock-step-redundant-execution-versus-split-lock-technologies" target="_blank" ref="nofollow noopener noreferrer">冗余执行</a>，即<strong>对同一智能体重复执行多次</strong>以防单点故障。其他增强现代智能体系统可靠性的模式包括：</p>
<ul>
<li><strong>并行工具</strong>：智能体同时执行独立 API 调用以隐藏 I/O 时延。</li>
<li><strong>层级智能体</strong>：管理者将任务拆分为由执行智能体处理的小步骤。</li>
<li><strong>竞争性智能体组合</strong>：多个智能体提出答案，系统选出最佳。</li>
<li><strong>冗余执行</strong>：即两个或多个智能体解决同一任务以检测错误并提高可靠性。</li>
<li><strong>并行检索和混合检索</strong>：多种检索策略协同运行以提升上下文质量。</li>
<li><strong>多跳检索</strong>：智能体通过迭代检索步骤收集更深入、更相关的信息。</li>
</ul>
<p>还有很多其他模式。</p>
<p>本系列将实现最常用智能体模式背后的基础概念，以直观方式逐一介绍每个概念，拆解其目的，然后实现简单可行的版本，演示其如何融入现实世界的智能体系统。</p>
<p>所有理论和代码都在 GitHub 仓库里：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFareedKhan-dev%2Fagentic-parallelism" title="https://github.com/FareedKhan-dev/agentic-parallelism" target="_blank" ref="nofollow noopener noreferrer">🤖 Agentic Parallelism: A Practical Guide 🚀</a></p>
<p>代码库组织如下：</p>
<pre><code class="hljs language-erlang" lang="erlang">agentic-parallelism/
    ├── <span class="hljs-number">01</span>_parallel_tool_use.ipynb
    ├── <span class="hljs-number">02</span>_parallel_hypothesis.ipynb
    ...
    ├── <span class="hljs-number">06</span>_competitive_agent_ensembles.ipynb
    ├── <span class="hljs-number">07</span>_agent_assembly_line.ipynb
    ├── <span class="hljs-number">08</span>_decentralized_blackboard.ipynb
    ...
    ├── <span class="hljs-number">13</span>_parallel_context_preprocessing.ipynb
    └── <span class="hljs-number">14</span>_parallel_multi_hop_retrieval.ipynb
</code></pre>
<hr/>
<h2 data-id="heading-0">并行工具隐藏 I/O 时延</h2>
<p>智能体系统中最主要且最常见的瓶颈（许多开发者已经知道，但我认为对初学者来说很重要）不是 LLM 思考时间，而是 I/O 时延……即等待网络、数据库和外部 API 响应的时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aeb9500d35d4cfbbc95f5db95862624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582891&amp;x-signature=jQ%2BJKuMX6MXiKxfZqRa3KSW6ESc%3D" alt="并行工具处理" loading="lazy"/></p>
<p>当代理需要从多个来源收集信息时，例如查询股价和搜索最新新闻，天真、顺序的方法会依次执行调用，效率低下。如果都是独立调用，没有理由不同时执行。</p>
<p>我们现在构建一个智能体系统，学习该模式在哪种情况下以及如何使用最有效。该系统会接收用户查询，识别需要调用两个不同的实时 API，并并行执行。</p>
<p>首先需要创造一些真实的工具，利用 <code>yfinance</code> 库获取实时股票价格数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">import</span> yfinance <span class="hljs-keyword">as</span> yf

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_stock_price</span>(<span class="hljs-params">symbol: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""Get the current stock price for a given stock symbol using Yahoo Finance."""</span>
    <span class="hljs-comment"># 添加一条 print 语句，以清楚指示何时执行此工具</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- [Tool Call] Executing get_stock_price for symbol: <span class="hljs-subst">{symbol}</span> ---"</span>)
    
    <span class="hljs-comment"># 实例化 yfinance Ticker 对象</span>
    ticker = yf.Ticker(symbol)
    
    <span class="hljs-comment"># 获取股票信息，用 'regularMarketPrice' 增强可靠性，并带有回退</span>
    price = ticker.info.get(<span class="hljs-string">'regularMarketPrice'</span>, ticker.info.get(<span class="hljs-string">'currentPrice'</span>))
    
    <span class="hljs-comment"># 处理股票代码无效或数据不可用的情况</span>
    <span class="hljs-keyword">if</span> price <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Could not find price for symbol <span class="hljs-subst">{symbol}</span>"</span>
    <span class="hljs-keyword">return</span> price
</code></pre>
<p>LangChain 的 @tool 将标准 Python 函数装饰为工具提供给代理，从而获取给定股票代码的市价。</p>
<p>快速测试一下，确保正确连接到了实时 API。</p>
<pre><code class="hljs language-python" lang="python">get_stock_price.invoke({<span class="hljs-string">"symbol"</span>: <span class="hljs-string">"NVDA"</span>})

<span class="hljs-comment">#### 输出 ####</span>
--- [Tool Call] Executing get_stock_price <span class="hljs-keyword">for</span> symbol: NVDA ---
<span class="hljs-number">121.79</span> ...
</code></pre>
<p>可以看到输出确认工具连接正确，可以访问外部 <code>yfinance</code> API。如果失败，就需要检查网络连接或 <code>yfinance</code> 安装情况。</p>
<p>接下来将创建第二个用于获取最新公司新闻的工具，使用针对基于 LLM 的代理优化的 <code>Tavily</code> 搜索 API。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.tools.tavily_search <span class="hljs-keyword">import</span> TavilySearchResults

<span class="hljs-comment"># 首先，初始化基本 Tavily 搜索工具</span>
<span class="hljs-comment"># 'max_results=5' 将限制搜索前 5 个最相关文章</span>
tavily_search = TavilySearchResults(max_results=<span class="hljs-number">5</span>)
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_recent_company_news</span>(<span class="hljs-params">company_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-string">"""Get recent news articles and summaries for a given company name using the Tavily search engine."""</span>
    <span class="hljs-comment"># 添加 print 语句，以便清楚记录工具的执行情况</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- [Tool Call] Executing get_recent_company_news for: <span class="hljs-subst">{company_name}</span> ---"</span>)
    
    <span class="hljs-comment"># 为搜索引擎构造更具体的查询</span>
    query = <span class="hljs-string">f"latest news about <span class="hljs-subst">{company_name}</span>"</span>
    
    <span class="hljs-comment"># 调用底层 Tavily 工具</span>
    <span class="hljs-keyword">return</span> tavily_search.invoke(query)
</code></pre>
<p>这里把基础工具 <code>TavilySearchResults</code> 封装在自定义 <code>@tool</code> 函数里，目的是获取用户查询的最新新闻。</p>
<p>测试一下这个工具……</p>
<pre><code class="hljs language-python" lang="python">get_recent_company_news.invoke({<span class="hljs-string">"company_name"</span>: <span class="hljs-string">"NVIDIA"</span>})

<span class="hljs-comment">#### 输出 ####</span>
--- [Tool Call] Executing get_recent_company_news <span class="hljs-keyword">for</span>: NVIDIA ---
[{<span class="hljs-string">'url'</span>: <span class="hljs-string">'https://www.reuters.com/technology/nvidia-briefly-surpasses-microsoft-most-valuable-company-2024-06-18/'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">'Nvidia briefly overtakes Microsoft as most valuable company...'</span>}, ...]
</code></pre>
<p>输出是一份近期新闻列表，证实第二个工具也正常工作，我们的代理现在具备两种不同的真实世界数据收集能力。</p>
<p>为了正确衡量效率提升，需要整理工作流，更新图状态，加入用于记录性能指标的字段。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, Annotated, <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> BaseMessage
<span class="hljs-keyword">import</span> operator

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-comment"># 'messages' 将保存对话历史</span>
    messages: Annotated[<span class="hljs-type">List</span>[BaseMessage], operator.add]
    <span class="hljs-comment"># 'performance_log' 将累积详细说明每个步骤执行时间的字符串</span>
    <span class="hljs-comment"># 'operator.add' 归约函数告诉 LangGraph 追加列表而非替换</span>
    performance_log: Annotated[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], operator.add]
</code></pre>
<p><code>AgentState</code> 是智能体运行的<strong>黑匣子录音机</strong>，通过添加带有 <code>Annotated</code> <code>operator.add</code> 归约函数的 <code>performance_log</code> 字段创建持久化日志，图中的每个节点都会更新该日志，为我们提供分析总执行时间和各阶段耗时所需的原始数据。</p>
<p>现在创建第一个仪表化节点，调用 LLM 的代理大脑。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_model</span>(<span class="hljs-params">state: AgentState</span>):
    <span class="hljs-string">"""The agent node: calls the LLM, measures its own execution time, and logs the result to the state."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- AGENT: Invoking LLM --- "</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># 从状态中获取当前消息历史</span>
    messages = state[<span class="hljs-string">'messages'</span>]
    
    <span class="hljs-comment"># 调用工具感知 LLM，LLM 将决定是否可以直接回答或需要调用工具</span>
    response = llm_with_tools.invoke(messages)
    
    end_time = time.time()
    execution_time = end_time - start_time
    
    <span class="hljs-comment"># 用性能数据创建日志条目</span>
    log_entry = <span class="hljs-string">f"[AGENT] LLM call took <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span> seconds."</span>
    <span class="hljs-built_in">print</span>(log_entry)
    
    <span class="hljs-comment"># 返回 LLM 响应和要添加到状态的新日志条目</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"messages"</span>: [response],
        <span class="hljs-string">"performance_log"</span>: [log_entry]
    }
</code></pre>
<p><code>call_model</code> 函数是我们第一个仪表化图节点，用带 <code>time.time()</code> 的 <code>llm_with_tools.invoke()</code> 封装调用，精确测量 LLM 的思考时间，并将测量数据格式化为人类可读的字符串，作为状态更新的一部分返回。</p>
<p>接下来创建用于执行工具的仪表化节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langgraph.prebuilt <span class="hljs-keyword">import</span> ToolExecutor

<span class="hljs-comment"># ToolExecutor 是一个 LangGraph 工具，可以获取一组工具列表并执行</span>
tool_executor = ToolExecutor(tools)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_tool</span>(<span class="hljs-params">state: AgentState</span>):
    <span class="hljs-string">"""The tool node: executes the tool calls planned by the LLM, measures performance, and logs the results."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- TOOLS: Executing tool calls --- "</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># 来自代理的最后一条消息将包含工具调用</span>
    last_message = state[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
    tool_invocations = last_message.tool_calls
    
    <span class="hljs-comment"># ToolExecutor 可以批量执行工具调用，对于同步工具，底层仍然是顺序的，</span>
    <span class="hljs-comment"># 但这是一种管理执行的干净方式</span>
    responses = tool_executor.batch(tool_invocations)
    
    end_time = time.time()
    execution_time = end_time - start_time
    
    <span class="hljs-comment"># 为工具执行阶段创建日志条目</span>
    log_entry = <span class="hljs-string">f"[TOOLS] Executed <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tool_invocations)}</span> tools in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span> seconds."</span>
    <span class="hljs-built_in">print</span>(log_entry)
    
    <span class="hljs-comment"># 将工具响应格式化为 ToolMessages，这是 LangGraph 期望的标准格式</span>
    tool_messages = [
        ToolMessage(content=<span class="hljs-built_in">str</span>(response), tool_call_id=call[<span class="hljs-string">'id'</span>])
        <span class="hljs-keyword">for</span> call, response <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(tool_invocations, responses)
    ]
    
    <span class="hljs-comment"># 返回工具消息和性能日志</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"messages"</span>: tool_messages,
        <span class="hljs-string">"performance_log"</span>: [log_entry]
    }
</code></pre>
<p>类似于 <code>call_model</code> 节点，将核心逻辑 <code>tool_executor.batch(tool_invocations)</code> 封装在计时仪表中，通过记录执行 <code>batch</code> 的总时间，可以稍后和模拟顺序执行比较，以量化并行的好处。</p>
<p>定义好仪表节点后，可以将它们接线成 <code>StateGraph</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> END, StateGraph

<span class="hljs-comment"># 此函数作为条件边，根据代理的最后一条消息路由工作流</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state: AgentState</span>) -&gt; <span class="hljs-built_in">str</span>:
    last_message = state[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-comment"># 如果最后一条消息包含工具调用，路由到 'tools' 节点</span>
    <span class="hljs-keyword">if</span> last_message.tool_calls:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tools"</span>
    <span class="hljs-comment"># 否则，智能体已经完成推理，结束执行图</span>
    <span class="hljs-keyword">return</span> END

<span class="hljs-comment"># 定义图工作流</span>
workflow = StateGraph(AgentState)

<span class="hljs-comment"># 添加仪表节点</span>
workflow.add_node(<span class="hljs-string">"agent"</span>, call_model)
workflow.add_node(<span class="hljs-string">"tools"</span>, call_tool)

<span class="hljs-comment"># 入口点是 'agent' 节点</span>
workflow.set_entry_point(<span class="hljs-string">"agent"</span>)

<span class="hljs-comment"># 为路由添加条件边</span>
workflow.add_conditional_edges(<span class="hljs-string">"agent"</span>, should_continue, {<span class="hljs-string">"tools"</span>: <span class="hljs-string">"tools"</span>, END: END})

<span class="hljs-comment"># 添加从工具回到代理的边</span>
workflow.add_edge(<span class="hljs-string">"tools"</span>, <span class="hljs-string">"agent"</span>)

<span class="hljs-comment"># 编译成可执行应用程序</span>
app = workflow.<span class="hljs-built_in">compile</span>()
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa95fa744a549db9a9e765258f53ddd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767582891&amp;x-signature=4XuCjOLzaoRTesWUg98kkH9oZio%3D" alt="并行工具调用" loading="lazy"/></p>
<p>我们定义了一个简单的循环：</p>
<ol>
<li><code>agent</code> 思考</li>
<li><code>should_continue</code> 边检查是否需要行动，如果需要，<code>tools</code> 节点会行动，然后流返回 <code>agent</code> 节点处理其动作的结果。</li>
<li><code>compile()</code> 方法将该抽象定义转化为具体、可执行的对象。</li>
</ol>
<p>接下来给代理一个查询，要求它同时使用两个工具并进行流式执行，并在每一步检查状态。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 图的初始输入，包括用户查询</span>
inputs = {
    <span class="hljs-string">"messages"</span>: [HumanMessage(content=<span class="hljs-string">"What is the current stock price of NVIDIA (NVDA) and what is the latest news about the company?"</span>)],
    <span class="hljs-string">"performance_log"</span>: []
}
step_counter = <span class="hljs-number">1</span>
final_state = <span class="hljs-literal">None</span>

<span class="hljs-comment"># 用 .Stream() 使用 stream_mode='values' 获取每个节点运行后的完整状态字典</span>
<span class="hljs-keyword">for</span> output <span class="hljs-keyword">in</span> app.stream(inputs, stream_mode=<span class="hljs-string">"values"</span>):

    <span class="hljs-comment"># 输出字典的键是刚刚运行的节点名称</span>
    node_name = <span class="hljs-built_in">list</span>(output.keys())[<span class="hljs-number">0</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'*'</span> * <span class="hljs-number">100</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"**Step <span class="hljs-subst">{step_counter}</span>: <span class="hljs-subst">{node_name.capitalize()}</span> Node Execution**"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'*'</span> * <span class="hljs-number">100</span>}</span>"</span>)
    
    <span class="hljs-comment"># 打印状态，以便详细检查</span>
    state_for_printing = output[node_name].copy()
    <span class="hljs-keyword">if</span> <span class="hljs-string">'messages'</span> <span class="hljs-keyword">in</span> state_for_printing:
        <span class="hljs-comment"># 将消息对象转换为更可读的字符串表示形式</span>
        state_for_pr...tty_repr() <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> state_for_printing[<span class="hljs-string">'messages'</span>]]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nCurrent State:"</span>)
    <span class="hljs-built_in">print</span>(json.dumps(state_for_printing, indent=<span class="hljs-number">4</span>))

    <span class="hljs-comment"># 为每一步添加分析</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'-'</span> * <span class="hljs-number">100</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"State Analysis:"</span>)

    <span class="hljs-keyword">if</span> node_name == <span class="hljs-string">"agent"</span>:
        <span class="hljs-comment"># 检查代理响应是否包含工具调用</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"tool_calls"</span> <span class="hljs-keyword">in</span> state_for_printing[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>]:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"The agent has processed the input. The LLM correctly planned parallel tool calls. The execution time of the LLM call has been logged."</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"The agent has received the tool results and synthesized them into a coherent, final answer. The performance log now contains the full history."</span>)
    <span class="hljs-keyword">elif</span> node_name == <span class="hljs-string">"tools"</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"The tool executor received the tool calls and executed them. The results are now in the state as ToolMessages. The performance log is accumulating."</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'-'</span> * <span class="hljs-number">100</span>}</span>"</span>)
    step_counter += <span class="hljs-number">1</span>
    final_state = output[node_name]
</code></pre>
<p>执行查询，看看并行模拟是如何工作的……</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#### 输出 ####</span>
****************************************************************************************************
**Step <span class="hljs-number">1</span>: Agent Node Execution**
****************************************************************************************************
--- AGENT: Invoking LLM --- 
[AGENT] LLM call took <span class="hljs-number">4.12</span> seconds.

Current State:
{
    <span class="hljs-string">"messages"</span>: [
        <span class="hljs-string">"HumanMessage(content='What is the current stock price of NVIDIA (NVDA) and what is the latest news about the company?')"</span>,
        <span class="hljs-string">"AIMessage(content='', tool_calls=[{'name': 'get_stock_price', 'args': {'symbol': 'NVDA'}, 'id': '...'}, {'name': 'get_recent_company_news', 'args': {'company_name': 'NVIDIA'}, 'id': '...'}])"</span>
    ],
    <span class="hljs-string">"performance_log"</span>: [ <span class="hljs-string">"[AGENT] LLM call took 4.12 seconds."</span> ]
}
----------------------------------------------------------------------------------------------------
State Analysis:
The agent has processed the <span class="hljs-built_in">input</span>. The LLM correctly planned parallel tool calls. The execution time of the LLM call has be...------------------------------

****************************************************************************************************
**Step <span class="hljs-number">2</span>: Tools Node Execution**
****************************************************************************************************
--- TOOLS: Executing tool calls --- 
--- [Tool Call] Executing get_stock_price <span class="hljs-keyword">for</span> symbol: NVDA ---
--- [Tool Call] Executing get_recent_company_news <span class="hljs-keyword">for</span>: NVIDIA ---
[TOOLS] Executed <span class="hljs-number">2</span> tools <span class="hljs-keyword">in</span> <span class="hljs-number">2.31</span> seconds.
Current State:
{
    <span class="hljs-string">"messages"</span>: [ ... ],
    <span class="hljs-string">"performance_log"</span>: [ <span class="hljs-string">"[AGENT] LLM call took 4.12 seconds."</span>, <span class="hljs-string">"[TOOLS] Executed 2 tools in 2.31 seconds."</span> ]
}
----------------------------------------------------------------------------------------------------
State Analysis:
The tool executor received the tool calls <span class="hljs-keyword">and</span> executed them. The results are now <span class="hljs-keyword">in</span> the state <span class="hljs-keyword">as</span> ToolMessages. The performance log <span class="hljs-keyword">is</span> accumulating.
----------------------------------------------------------------------------------------------------
...
</code></pre>
<p>流输出提供了代理周期的逐步视图。</p>
<ul>
<li><strong>步骤 1（代理）</strong>：在 <code>agent</code> 节点初始运行中，通过 <code>AIMessage</code> 可以看到 Llama 3 模型正确识别需要调用两个独立工具，<code>get_stock_price</code> 和 <code>get_recent_company_news</code>，并且在一次回合内完成了规划，从而实现了并行优化计划。</li>
<li><strong>步骤 2（工具）</strong>：<code>tools</code> 节点接收两条计划调用，日志显示两条 <code>[Tool Call]</code> 打印语句，确认被 <code>ToolExecutor</code> 同时执行。性能日志条目 <code>[TOOLS] Executed 2 tools in 2.31 seconds</code> 是关键数据。</li>
<li><strong>步骤 3（代理）</strong>：最后一步，代理收到 <code>ToolMessage</code> 结果并综合生成最终答案。</li>
</ul>
<p>现在进行最终定量证明，分析完整性能日志，计算节省的时间。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"Run Log:"</span>)
total_time = <span class="hljs-number">0</span>
tool_time = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> log <span class="hljs-keyword">in</span> final_state[<span class="hljs-string">'performance_log'</span>]:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f" - <span class="hljs-subst">{log}</span>"</span>)
    <span class="hljs-comment"># 从日志字符串中提取时间值</span>
    time_val = <span class="hljs-built_in">float</span>(log.split(<span class="hljs-string">' '</span>)[-<span class="hljs-number">2</span>])
    total_time += time_val
    <span class="hljs-keyword">if</span> <span class="hljs-string">"[TOOLS]"</span> <span class="hljs-keyword">in</span> log:
        tool_time = time_val
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"-"</span>*<span class="hljs-number">60</span> + <span class="hljs-string">"\n"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Total Execution Time: <span class="hljs-subst">{total_time:<span class="hljs-number">.2</span>f}</span> seconds\n"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Analysis:"</span>)
</code></pre>
<p>可以看到并行处理解决了时延问题……</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#### 输出 ####</span>
============================================================
               FINAL PERFORMANCE REPORT
============================================================
Run Log:
 - [AGENT] LLM call took <span class="hljs-number">4.12</span> seconds.
 - [TOOLS] Executed <span class="hljs-number">2</span> tools <span class="hljs-keyword">in</span> <span class="hljs-number">2.31</span> seconds.
 - [AGENT] LLM call took <span class="hljs-number">5.23</span> seconds.
------------------------------------------------------------

Total Execution Time: <span class="hljs-number">11.66</span> seconds
</code></pre>
<p>工具执行总时间为 2.31s，假设每个网络调用耗时约 1.5s，顺序执行需时约 3.0s（1.5s + 1.5s）。</p>
<p>并发执行节省了约 0.7s，增益看起来很小，但在一个有 5-10 个独立工具调用、每次需要 2-3s 的复杂系统中，差别会更大。顺序过程需 10-30s，而并行过程仍只需 2-3s，这就是可用系统和不可用系统的区别。</p>
<hr/>
<blockquote>
<p>Hi，我是俞凡，一名兼具技术深度与管理视野的技术管理者。曾就职于 Motorola，现任职于 Mavenir，多年带领技术团队，聚焦后端架构与云原生，持续关注 AI 等前沿方向，也关注人的成长，笃信持续学习的力量。在这里，我会分享技术实践与思考。欢迎关注公众号「DeepNoMind」，星标不迷路。也欢迎访问独立站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.deepnomind.com" title="https://www.deepnomind.com" target="_blank" ref="nofollow noopener noreferrer">www.DeepNoMind.com</a>，一起交流成长。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 中的 Output 解析器与 Zod：用法与意义]]></title>    <link>https://juejin.cn/post/7589102404168515603</link>    <guid>https://juejin.cn/post/7589102404168515603</guid>    <pubDate>2025-12-29T02:49:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589102404168515603" data-draft-id="7589102404168433683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 中的 Output 解析器与 Zod：用法与意义"/> <meta itemprop="keywords" content="JavaScript,LangChain"/> <meta itemprop="datePublished" content="2025-12-29T02:49:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 中的 Output 解析器与 Zod：用法与意义
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:49:57.000Z" title="Mon Dec 29 2025 02:49:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain 中的 Output 解析器与 Zod：用法与意义</h2>
<p>在与大语言模型（LLM）交互时，我们常常需要模型输出特定格式的内容（如 JSON），以方便程序进一步处理。但 LLM 的输出往往具有不确定性，可能包含多余文本或格式错误。LangChain 提供的 Output 解析器与 Zod 库的结合，正是为解决这一问题而生。</p>
<h3 data-id="heading-1">Output 解析器：确保 LLM 输出格式可靠</h3>
<h4 data-id="heading-2">什么是 Output 解析器？</h4>
<p>Output 解析器是 LangChain 中的核心组件，用于将 LLM 生成的非结构化文本转换为结构化数据（如 JSON、特定对象等），并验证其格式合法性。它解决了 “LLM 输出格式不可控” 的痛点 —— 即使提示词要求输出 JSON，模型仍可能额外添加解释性文字或出现格式错误，导致程序解析失败。</p>
<h4 data-id="heading-3">Output 解析器的用法（结合实例）</h4>
<p>在<code>main.js</code>中，我们可以看到 Output 解析器的典型使用流程：</p>
<ol>
<li><strong>定义解析目标格式</strong>：通过 Zod 定义 JSON 结构（后续详解），明确字段名、类型和约束。</li>
<li><strong>创建解析器实例</strong>：使用<code>JsonOutputParser</code>并传入 Zod 的 schema，生成解析器。</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">jsonParser</span> = new JsonOutputParser(FrontendConceptSchema)<span class="hljs-comment">;</span>
</code></pre>
<ol start="3">
<li><strong>在提示词中注入格式要求</strong>：通过<code>jsonParser.getFormatInstructions()</code>获取解析规则，并嵌入提示词，强制 LLM 按规则输出。</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">prompt</span> = PromptTemplate.fromTemplate(`
 你是一个只会输出 JSON 的 API，不允许输出任何解释性文字。
 ⚠️ 你必须【只返回】符合以下 Schema 的 JSON：
 {format_instructions}
 前端概念：{topic}
`)<span class="hljs-comment">;</span>
</code></pre>
<ol start="4">
<li><strong>构建处理链</strong>：将提示词、模型、解析器通过<code>pipe</code>连接，形成从输入到结构化输出的完整流程。</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">chain</span> = prompt.pipe(model).pipe(jsonParser)<span class="hljs-comment">;</span>
</code></pre>
<ol start="5">
<li><strong>执行并获取结果</strong>：调用<code>chain.invoke()</code>后，解析器会自动验证输出格式，返回符合 schema 的结构化数据。</li>
</ol>
<h4 data-id="heading-4">Output 解析器的意义</h4>
<ul>
<li><strong>格式强制校验</strong>：确保 LLM 输出严格符合预期结构（如不增删字段、字段名一致），避免程序因格式错误崩溃。</li>
<li><strong>简化下游处理</strong>：直接得到结构化数据（如 JSON 对象），无需手动处理字符串切割、正则匹配等繁琐操作。</li>
<li><strong>提升鲁棒性</strong>：即使 LLM 偶尔 “失控” 输出多余内容，解析器也会报错提醒，便于调试和优化提示词。</li>
</ul>
<h3 data-id="heading-5">Zod：为结构化输出提供 “契约”</h3>
<h4 data-id="heading-6">什么是 Zod？</h4>
<p>Zod 是一个 TypeScript 优先的模式验证库，用于定义数据结构的 “契约”（schema），并校验数据是否符合该契约。在 LangChain 中，Zod 的核心作用是为 Output 解析器提供结构化的校验规则。</p>
<h4 data-id="heading-7">Zod 在 LangChain 中的用法（结合实例）</h4>
<p>在<code>main.js</code>中，Zod 的使用体现在对 “前端概念” 数据结构的定义：</p>
<ol>
<li><strong>定义 schema</strong>：通过<code>z.object()</code>定义 JSON 对象的结构，包括字段名、类型、描述和约束</li>
</ol>
<pre><code class="hljs language-css" lang="css">const FrontendConceptSchema = z<span class="hljs-selector-class">.object</span>({
  name: z.<span class="hljs-built_in">string</span>().<span class="hljs-built_in">describe</span>(<span class="hljs-string">"概念名称"</span>), // 字符串类型，描述为“概念名称”
  core: z.<span class="hljs-built_in">string</span>().<span class="hljs-built_in">describe</span>(<span class="hljs-string">"核心要点"</span>),
  useCase: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()).<span class="hljs-built_in">describe</span>(<span class="hljs-string">"常见使用场景"</span>), // 字符串数组类型
  difficulty: z.<span class="hljs-built_in">enum</span>([<span class="hljs-string">'简单'</span>,<span class="hljs-string">'中等'</span>,<span class="hljs-string">'复杂'</span>]).<span class="hljs-built_in">describe</span>(<span class="hljs-string">"学习难度"</span>) // 枚举类型，限制可选值
});
</code></pre>
<ol start="2">
<li><strong>为解析器提供规则</strong>：将 Zod 的 schema 传入<code>JsonOutputParser</code>，解析器会基于此 schema 生成格式说明（<code>getFormatInstructions()</code>），并在 LLM 输出后进行校验。</li>
</ol>
<h4 data-id="heading-8">Zod 在 LangChain 中的意义</h4>
<ul>
<li><strong>明确数据结构</strong>：通过 schema 清晰定义预期输出的字段、类型和约束（如<code>enum</code>限制难度级别），让 LLM 和开发者对 “输出格式” 有统一认知。</li>
<li><strong>自动生成格式说明</strong>：Zod 的 schema 可被解析器转换为自然语言指令（如 “<code>difficulty</code>必须是 ' 简单 '、' 中等 ' 或' 复杂 '”），无需手动编写繁琐的格式要求。</li>
<li><strong>严格校验保障</strong>：解析器会基于 Zod 的 schema 对 LLM 输出进行校验，拒绝不符合规则的数据（如类型错误、缺少字段），确保数据合法性。</li>
</ul>
<h3 data-id="heading-9">协同作用：Output 解析器与 Zod 的配合</h3>
<p>Zod 与 Output 解析器的结合，形成了 “定义规则→传递规则→验证规则” 的闭环：</p>
<ol>
<li>Zod 定义 “数据应该是什么样的”（schema）；</li>
<li>Output 解析器将 schema 转换为 LLM 能理解的格式说明，并注入提示词；</li>
<li>LLM 基于格式说明输出内容；</li>
<li>Output 解析器再用 Zod 的 schema 校验输出，返回合法的结构化数据。</li>
</ol>
<p>这种配合让 LLM 的输出从 “自由文本” 转变为 “可控的结构化数据”，大幅提升了 AI 应用的可靠性和工程化程度。</p>
<h3 data-id="heading-10">总结</h3>
<p>在 LangChain 中，Output 解析器负责将 LLM 输出转换为结构化数据并校验格式，而 Zod 则为这一过程提供清晰的规则定义。二者结合解决了 LLM 输出格式不可控的核心问题，使得 AI 生成的内容能被程序高效、安全地处理，是构建可靠 AI 应用的关键技术组合。# LangChain 中的 Output 解析器与 Zod：用法与意义</p>
<p>在与大语言模型（LLM）交互时，我们常常需要模型输出特定格式的内容（如 JSON），以方便程序进一步处理。但 LLM 的输出往往具有不确定性，可能包含多余文本或格式错误。LangChain 提供的 Output 解析器与 Zod 库的结合，正是为解决这一问题而生。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI数字人搭建（魔珐星云SDK）]]></title>    <link>https://juejin.cn/post/7588445332772667446</link>    <guid>https://juejin.cn/post/7588445332772667446</guid>    <pubDate>2025-12-29T03:30:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445332772667446" data-draft-id="7586569284550246440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI数字人搭建（魔珐星云SDK）"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-29T03:30:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="提前退休的java猿"/> <meta itemprop="url" content="https://juejin.cn/user/465848660928872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI数字人搭建（魔珐星云SDK）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660928872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    提前退休的java猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:30:24.000Z" title="Mon Dec 29 2025 03:30:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>我是[<a href="https://juejin.cn/user/465848660928872" title="https://juejin.cn/user/465848660928872" target="_blank">提前退休的java猿</a>]，一名7年java开发经验的开发组长，主要分享工作中的各种问题！<br/>
最近在忙项目去呢，有一段时间没有输出高质量的文章了，愿谅解呀😁</p>
</blockquote>
<h3 data-id="heading-1">数字人应用场景</h3>
<p>数字人已经深度融入各行业了，有的是解决业务问题，提高生产效率，有的则是强行嵌入对外称已经和AI技术接轨。
我们公司在去年也接入了数字人功能，对于很多公司来说我们都是购买三方的服务，自己集成就行了。今天分享一下如何利用第三方的产品（<a href="https://link.juejin.cn?target=https%3A%2F%2Fxingyun3d.com%3Futm_campaign%3Ddaren%26utm_source%3Djavayuan" target="_blank" title="https://xingyun3d.com?utm_campaign=daren&amp;utm_source=javayuan" ref="nofollow noopener noreferrer">魔珐星云数字人开放平台</a>）搭建AI数字人🤷。</p>
<h2 data-id="heading-2">魔珐星云数字人开放平台</h2>
<p>星云具身驱动能力，将 AI 的表达从“文本”升级为“ 3D 多模态”。 它可基于文本输入，实时生成语音、表情与动作，驱动 3D 数字人或人形机器人，实现如真人般自然的表达。 相比传统仅能输出文字或语音的 AI ，星云赋予 AI 更丰富的表现力与更自然的交互体验。</p>
<p>🌈就是让AI驱动的数字人（或机器人）能像真人一样说话、做表情和做动作，实现实时交互。当然视频生成也是可以的，比如用来做一些宣传片或者口播视频也是可以的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c933a3ecb5ef4d9983086e2ce84293e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=Yi0dj4iKqSYYTOHkBIX%2FIkL12Xs%3D" alt="image.png" loading="lazy"/></p>
<p>有兴趣的可以去<a href="https://link.juejin.cn?target=https%3A%2F%2Fxingyun3d.com%3Futm_campaign%3Ddaren%26utm_source%3Djavayuan" target="_blank" title="https://xingyun3d.com?utm_campaign=daren&amp;utm_source=javayuan" ref="nofollow noopener noreferrer">魔珐星云数字人开放平台</a> 体验🏋️‍♀️</p>
<blockquote>
<p>📢珐星云已免费开放，用邀请码(<code>JU8AKXCGW8</code>)注册可以获得更多使用额度。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfba1cb8bf3246c7a153050873a5e99f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=hWnjgg6VSrlxcP%2FlCcldwVzBtFU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fxingyun3d.com%3Futm_campaign%3Ddaren%26utm_source%3Djavayuan" target="_blank" title="https://xingyun3d.com?utm_campaign=daren&amp;utm_source=javayuan" ref="nofollow noopener noreferrer">魔珐星云数字人平台</a>特点</h3>
<p>魔珐星云 AI 数字人的核心特点是 “具身智能 + 低门槛规模化”，以高质量 3D 形象、低延时实时交互、低成本端侧部署为核心，打通从形象生成到场景落地的全链路，同时具备强适配与高开放度，适合企业快速规模化落地数字人应用魔珐科技。以下是详细解析：</p>
<h4 data-id="heading-4">一、核心技术与能力特点</h4>
<h5 data-id="heading-5">1. 具身智能驱动，“有形象 + 会表达 + 有大脑 + 能办事”</h5>
<ul>
<li>形象生成：3000 + 超写实 3D 数字人库，支持图生 3D 与个性化编辑（妆容、发型、服饰），180 + 面部控制点精准驱动微表情，呈现电影级皮肤纹理、毛发与服饰细节。</li>
<li>自然表达：TTS 语音合成小模型延时约 100ms、大模型约 500ms，支持多语言 / 多音色；语音、表情、动作实时协同，可随语义与情感自动调整微表情与肢体语言，支持中途打断交互。</li>
<li>智能交互：可对接魔珐自研大模型或文心一言、DeepSeek 等第三方 LLM，结合企业知识库实现多轮对话、意图理解与自主任务执行，完成从 “有问必答” 到 “有感而应” 的体验升级魔珐科技。</li>
<li>端侧渲染：独创 AI 实时端侧渲染，无需高性能 GPU，百元级芯片（如 RK3566）即可流畅运行，100% 兼容国产信创，首次加载后缓存常用动作，降低网络开销。</li>
</ul>
<h5 data-id="heading-6">2. 突破 “高质量 - 低延时 - 低成本” 不可能三角</h5>






























<table><thead><tr><th align="left">维度</th><th align="left">具体表现</th><th align="left">行业价值</th></tr></thead><tbody><tr><td align="left">高质量</td><td align="left">电影级 3D 建模，4K 级细节，微表情精准自然</td><td align="left">提升品牌形象与用户沉浸感</td></tr><tr><td align="left">低延时</td><td align="left">端到端延迟＜1.5 秒，流式输出响应约 500ms</td><td align="left">实现接近真人的实时交互体验</td></tr><tr><td align="left">低成本</td><td align="left">无 GPU 依赖，端侧轻量化部署，硬件成本低</td><td align="left">降低规模化落地门槛，适配中小企业</td></tr><tr><td align="left">高并发</td><td align="left">支持千万级设备同时驱动，单应用可承载 500 + 并发</td><td align="left">满足直播、客服等大规模场景需求</td></tr></tbody></table>
<h5 data-id="heading-7">3. 全链路开放与多终端适配</h5>
<ul>
<li>开放能力：提供 SDK/API 与完善工具链，支持数字人形象定制、视频生成、实时驱动等全流程开发，可深度集成到企业现有系统（CRM、知识库、直播平台）魔珐科技。</li>
<li>多终端覆盖：适配 Web、App、小程序、车机、人形机器人等，支持 Android、iOS、鸿蒙等系统，虚实兼容（可驱动 3D 数字人或实体机器人）。</li>
<li>快速生产：AI 一键生成场景布局、角色调度与运镜，支持批量生成视频 / 直播内容，适配营销、培训等规模化内容生产需求。</li>
</ul>
<hr/>
<h4 data-id="heading-8">二、差异化优势总结</h4>
<ol>
<li><strong>具身智能深度融合</strong>：将大模型智能与 3D 数字人 “身体” 结合，实现语义 - 语音 - 动作一体化实时驱动，而非单纯的预录内容播放。</li>
<li><strong>轻量化部署革命</strong>：无 GPU 端侧渲染技术，解决了高质量 3D 数字人依赖高端硬件的行业痛点，让低成本规模化成为可能。</li>
<li><strong>全链路技术自研</strong>：从建模、绑定、动画到渲染、交互，构建 “AI 形象 + AI 表达 + AI 大脑 + AI 互动” 四位一体体系，避免第三方技术依赖，保障稳定性与定制化空间魔珐科技。</li>
</ol>
<h3 data-id="heading-9">数字人集成（Android版本）</h3>
<p>星云数字人 数字人目前也是支持两种方式的集成JS和Android，今天分享一下<code>SDK Android</code>的集成</p>
<h4 data-id="heading-10">数字人DEMO运行</h4>
<p><strong>1.拉去demo:</strong></p>
<p><strong>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpublicize0828%2FXmovLiteAvatarAndroidDemo" target="_blank" title="https://github.com/publicize0828/XmovLiteAvatarAndroidDemo" ref="nofollow noopener noreferrer">github.com/publicize08…</a></strong><br/>
<strong>Gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxmovmaster%2FXmovLiteAvatarAndroidDemo" target="_blank" title="https://gitee.com/xmovmaster/XmovLiteAvatarAndroidDemo" ref="nofollow noopener noreferrer">gitee.com/xmovmaster/…</a></strong></p>
<p><code>Android studio</code>打开项目，出现不支持 <code>AGP 8.12.1</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b574a402fb7642fa9f73842b9dd83127~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=xQaOPMFUGrqDDB8tcy1nnnUDz8E%3D" alt="image.png" loading="lazy"/>
这里我把原来的AGP <code>8.12.1</code>版本改成了 <code>8.11.0</code> (当然没有这个报错最好)</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acbe579008a8430db490f7122fd83cc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=GLTOm6V1Zhj%2BnY%2FNXNDswNzOcTY%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2.替换appid和appSecret</strong>
appid 和 appSecret 从我们开发平台创建数字人之后的右上角就有分配，替换demo中参数如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8efb80caa00d44f9ad82057c3a7563df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=hvTZWELWzH%2BUOLo%2F79GO%2B1cntYw%3D" alt="image.png" loading="lazy"/></p>
<p>3.启动项目
屏幕上有初始化SDK的按钮，初始之后就可以连接我们的数字人了。人物形象就行我们在 星云平台搭建的数字人了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bf68cae33284f6d9ed6f19a7f57ff26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=Es%2Fi%2BzfmJaTEhKRYptZ3cDGaToY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">Android SDK 集成和简单说明</h4>
<p>1.将开发包拷贝到工程</p>
<p>将SDK中libs目录下的aar包拷贝到自己工程的libs目录下，如没有该目录需新建。
在app文件夹下的build.gradle的dependencies中配置对应版本的aar依赖详细代码如下：</p>
<pre><code class="hljs language-java" lang="java">implementation <span class="hljs-title function_">files</span><span class="hljs-params">(<span class="hljs-string">'libs/xmovdigitalhuman-xxx.aar'</span>)</span>
</code></pre>
<p>2.添加外部第三方依赖 详细代码如下：</p>
<pre><code class="hljs language-java" lang="java">    implementation <span class="hljs-string">"javax.vecmath:vecmath:1.5.2"</span>
    implementation <span class="hljs-string">"com.google.code.gson:gson:2.13.1"</span>
    implementation <span class="hljs-string">"com.squareup.okhttp3:okhttp:5.1.0"</span>
    implementation <span class="hljs-string">"org.msgpack:msgpack-core:0.9.3"</span>
    implementation <span class="hljs-string">"io.socket:socket.io-client:2.1.0"</span>
</code></pre>
<p>3.配置AndroidManifest.xml文件</p>
<p>在manifest标签内添加必要的权限支持</p>
<pre><code class="hljs language-java" lang="java">&lt;uses-permission android:name=<span class="hljs-string">"android.permission.INTERNET"</span>/&gt;
</code></pre>
<p>4.混淆规则</p>
<pre><code class="hljs language-java" lang="java">-keep <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.xmov.metahuman.sdk.data. { ;}
-keep <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.xmov.metahuman.sdk.impl.data. {;}
-keep <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.xmov.metahuman.sdk.impl.transport.http.{ ;}
-keep <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">com</span>.xmov.metahuman.sdk.IXmovAvatar {;}
-keep <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.xmov.metahuman.sdk.IXmovAvatar$Companion {  ;}
-keep <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">com</span>.xmov.metahuman.sdk.IAvatarListener {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">protected</span> ;
}
-keep <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">com</span>.xmov.metahuman.sdk.PreCacheListener {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">protected</span> *;
}
</code></pre>
<p>通过上面的几个步骤，工程就配置完成了，接下来就可以在工程中使用虚拟人SDK进行开发了。</p>
<blockquote>
<p>详细的开发文档可以参考官网： <a href="https://link.juejin.cn?target=https%3A%2F%2Fxingyun3d.com%2Fdevelopers%2F52-193%3Futm_campaign%3Ddaren%26utm_source%3Djavayuan" target="_blank" title="https://xingyun3d.com/developers/52-193?utm_campaign=daren&amp;utm_source=javayuan" ref="nofollow noopener noreferrer">具身驱动SDK</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c0adba9f27347158ca3761b8eb5a7c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=YxmmKLxNg%2Fp%2FIqlOeEa69dfb4iA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-12">总结</h2>
<p>通过上面的文章的，可以看出这个demo 或者是SDK的集成其实是非常的简单！以及介绍魔珐星云数字人的特点
多模态生成、低成本、虚实兼容、跨端适配。有需要集成数字人的开发可以去了解一下这个平台。
不管是企业使用，还是个人的使用都有它的运用场景，所以大家有必要了解这个产品。</p>
<p>🪐<strong>如果大家还是想不到数字人的应用场景或者说无应用于自己所处行业，不妨看一下下面这些应用场景，一定能给你一些启发</strong>：</p>
<ul>
<li>公共服务大屏：深度落地酒店大堂、银行网点、医院诊室、交通车站等高频场景，化身 24/7 全天候智能服务专员，无需轮班值守，高效解答咨询、指引流程、办理基础业务，让公共服务更便民、更省心。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02aa27c86c37488fabdf552673c1d8c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=oSEhk%2FWnD2aF292e3PAI2LkvM9g%3D" alt="数字人应用场景概述.png" loading="lazy"/></p>
<ul>
<li>零售/营销屏：扎根商场中庭、品牌门店、户外数字标牌等消费场景，变身主动式智能导购与品牌宣传员，精准捕捉客流并主动互动，讲解产品亮点、推送优惠活动、引导消费决策，激活线下营销活力，提升转化效率。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b395be0f91480ea8cefdffe1b3843f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767583823&amp;x-signature=Mh%2F20VoX7rTuesEiCUCpHHq8pHM%3D" alt="数字人应用场景概述 (1).png" loading="lazy"/></p>
<ul>
<li>个人设备: 全面渗透手机、智能电视、车载车机屏等个人终端，成为贴身智能伙伴，既能陪聊互动、答疑解惑，也能提供生活服务、影音陪伴、车载导航辅助等多元功能，让数字人服务融入日常，触手可及。</li>
</ul>
<p>看到这儿，现在能够想到数字人的应用场景了吧🙆‍♂️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据科学和ML领域的趋势是什么？为2026年做准备]]></title>    <link>https://juejin.cn/post/7588745319401619456</link>    <guid>https://juejin.cn/post/7588745319401619456</guid>    <pubDate>2025-12-29T03:34:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588745319401619456" data-draft-id="7588730836864811023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据科学和ML领域的趋势是什么？为2026年做准备"/> <meta itemprop="keywords" content="OpenAI,AIGC,Agent"/> <meta itemprop="datePublished" content="2025-12-29T03:34:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安思派Anspire"/> <meta itemprop="url" content="https://juejin.cn/user/3044964115417419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据科学和ML领域的趋势是什么？为2026年做准备
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044964115417419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安思派Anspire
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:34:23.000Z" title="Mon Dec 29 2025 03:34:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">3个（对我来说）最突出的关键趋势</h2>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35e90653488d4474ade07371e44d4e4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767584062&amp;x-signature=BgQTLQIya4zlhhTy52eGETEILY0%3D" alt="" loading="lazy"/></p>
<p>描绘AutoGen背后动机的漫画。图片由AutoGen提供。</p>
<p>这些就是在活动期间让我印象深刻的趋势，并且在某种程度上，它们已经积累了足够的动力，值得密切关注。</p>
<h3 data-id="heading-1">1. 从传统分析到智能体分析</h3>
<p>我们正在进入分析的新阶段。在这个阶段，仪表盘和静态报告已经不够用了。</p>
<p>我预计到2026年初，这个话题将变得更加热门</p>
<p>。</p>
<p>重点将放在创建更具活力的系统上，这些系统可以加速从数据到洞察的过程，使分析更具适应性，减少对人工探索的依赖，许多人开始将其称为自主分析。</p>
<p>💡有一点很明确，在这场智能分析转型中引领潮流的公司，将是那些有远见卓识，能够构建强大的数据工程基础并投资于语义建模的公司。这最终将使AI智能体能够以有意义的方式与数据进行交互。</p>
<p>本文稍后将对此进行更多阐述。</p>
<h3 data-id="heading-2">2. 小语言模型是下一个大趋势</h3>
<p>小型语言模型（sLMs）正变得惊人地强大。</p>
<p>像<strong>Phi-3</strong>、<strong>Mistral</strong>和<strong>Llama 3 8B</strong>这样的模型表明，你不需要庞大的基础设施就能获得强大的性能。通过一些微调，它们甚至可以在特定任务上超越更大的模型。</p>
<p>💡对于开发者和小型团队来说，这也意味着我们现在可以在普通笔记本电脑甚至手机上运行快速、私密且低成本的模型。</p>
<h3 data-id="heading-3">3. 专业化多智能体系统的兴起</h3>
<p>一个反复出现的重要主题是向<strong>分层多智能体系统</strong>的转变。与依赖单个智能体处理整个工作流程不同，现在的新架构使用<strong>协调智能体</strong>将任务分解成更小的部分，并将其委派给专门的子智能体。</p>
<p>每个子智能体专注于一项微小、定义明确的任务，如清理数据、总结发现或生成代码，并在这单一任务上变得极为擅长。它们共同构成一个协调的系统，比单独工作的通用智能体更快、更便宜且更可靠。</p>
<p>💡这种“分而治之”的方法也为**小型语言模型（sLMs）**发挥更大作用打开了大门。由于每个子智能体只需要处理一项狭窄的任务，即使是轻量级模型，在精心编排的系统中组合使用时也能表现出色。</p>
<p>随着自主系统的成熟并投入生产使用，我们很可能会更多地看到这种设计模式。</p>
<h2 data-id="heading-4">数据科学家应该注意什么？</h2>
<p>我的建议，尤其是给那些希望在职业发展中实现下一次飞跃的中高级数据科学家：<strong>在你所在公司引领自主分析转型。</strong></p>
<p>据我所见，大多数组织才刚刚开始意识到这一变化。</p>
<p>这意味着你有真正的机会发挥引领作用，无论是通过倡导能够实现自主分析的现代企业工具，还是通过构建自己的智能体，使分析更快、更具交互性，且更贴近决策过程。</p>
<p>那些能尽早弥合AI智能体与分析之间差距的人，将塑造未来十年数据科学的实践方式。</p>
<h2 data-id="heading-5">数据科学领域的5个现实世界代理AI用例</h2>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d74110cefe2542ef8165b35411805efa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767584062&amp;x-signature=YckpsCekca5sbPC%2F2BN1kh1KkpU%3D" alt="" loading="lazy"/></p>
<p>TimeGPT如何将目标值的历史值和额外的外生变量作为输入来生成预测的示意图。图片由TimeGPT提供。</p>
<p>以下是GenAI和智能体AI已经开始产生影响的一些用例：</p>
<ol>
<li>
<p><strong>用于快速洞察的对话式仪表盘</strong>想象一下，你可以与之对话、用通俗易懂的英语提问，并能立即获得摘要或可视化结果的仪表盘。Power BI Copilot和Tableau Pulse是早期的例子，但这一概念适用于任何非技术用户需要从数据中快速获取答案的工作流程。</p>
</li>
<li>
<p><strong>EDA****和数据清理代理</strong> AI代理正开始自动执行在EDA期间检测离群值、规范化数据和生成初始可视化的耗时工作。像Tableau的数据专家这样的工具暗示了如何构建代理来加速数据准备过程。</p>
</li>
<li>
<p><strong>用于分析的基础模型</strong> 与为每个指标或产品训练新模型不同，像 TimeGPT 这样的基础模型开始直接从原始数据处理预测、异常检测和其他分析任务。这使得高级分析更易于获取，即使对于在时间序列或模型构建方面没有深厚专业知识的团队也是如此。</p>
</li>
<li>
<p><strong>自主监测与主动分析</strong> 自主系统无需等待人工查看仪表盘，就能监控关键绩效指标（KPI）、发现变化，并触发警报或建议。Tableau Inspector和Adverity正在推动这一趋势，但只要设置得当，任何分析师都可以探索这一模式。</p>
</li>
<li>
<p><strong>ML工作流的多智能体编排</strong>像causaLens这样的平台就是AI智能体协作的一个例子，有的负责清理数据，有的负责构建模型，还有的负责解释结果。这不仅仅是自动化，更是协调，它让我们得以窥见未来ML工作流可能的运行方式。</p>
</li>
</ol>
<h2 data-id="heading-6">🔑不要忽视这一点：语义层</h2>
<p>我想再次提及这个概念，因为我觉得阅读这篇文章的很多人可能会忽略它，而这将是一个重大错误。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb4d61cbf25c4fcca3d3767a1398ef65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767584062&amp;x-signature=HyuEErK1SCJGL5N5B3JPv55ANMs%3D" alt="" loading="lazy"/></p>
<p>语义层架构。图片由Tallius提供。</p>
<p>在过去大约6个月的时间里，我花了更多时间构建自己的AI工作流程，以优化和自动化我的大部分数据科学工作。最近，我部署了一个名为“与数据对话”的Slack机器人，它正在慢慢重新定义我公司自助式分析的含义。</p>
<p>这些工具成功的关键之一是定义语义层。</p>
<p>📌</p>
<p>这也是我正在向目前参加我的<a href="https://link.juejin.cn?target=https%3A%2F%2Ffutureproofds.com%2F" target="_blank" title="https://futureproofds.com/" ref="nofollow noopener noreferrer">AI工作流训练营</a>的22位数据科学家传授它的原因。</p>
<p>其理念很简单：语义层为指标和业务逻辑创建一个共享定义，以便数据科学家、利益相关者，最重要的是，AI智能体，都能基于同一事实来源开展工作。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17d7d4fad8bb455cb52d4097ff7e4dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767584062&amp;x-signature=AOORRvOmvBCqayEPbPPjuAkWup8%3D" alt="" loading="lazy"/></p>
<p>语义层 YAML 文件示例。图片由 dbt 提供。</p>
<p>相信我，你不需要成为数据工程师就能开始构建语义层来增强你的AI智能体。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java对比Python 3.10+ 全栈语法与底层进阶百科全书]]></title>    <link>https://juejin.cn/post/7588388014505705514</link>    <guid>https://juejin.cn/post/7588388014505705514</guid>    <pubDate>2025-12-29T03:35:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588388014505705514" data-draft-id="7588730836864417807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java对比Python 3.10+ 全栈语法与底层进阶百科全书"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-29T03:35:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若丶相见"/> <meta itemprop="url" content="https://juejin.cn/user/2330620381380311"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java对比Python 3.10+ 全栈语法与底层进阶百科全书
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2330620381380311/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若丶相见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:35:14.000Z" title="Mon Dec 29 2025 03:35:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这份文档是为你——一位 <strong>Java 17 资深开发者</strong>量身定制的 <strong>Python 3.10+ 全栈语法与底层进阶百科全书</strong>。</p>
<p>它融合了底层运行机制、现代语法特性、跨语言横向对比以及工程化实践，旨在帮助你从 JVM 思维无痛切换至 Pythonic 思维。</p>
<hr/>
<h2 data-id="heading-0">🐍 Python 3.10+ 全栈进阶百科全书 (Java 17 兼容版)</h2>
<h3 data-id="heading-1">第一部分：核心语法基准对照表</h3>





























































<table><thead><tr><th align="left">特性</th><th align="left"><strong>Java 17 (你的基准)</strong></th><th align="left"><strong>Python 3.10+</strong></th><th align="left"><strong>Kotlin</strong></th><th align="left"><strong>TypeScript</strong></th></tr></thead><tbody><tr><td align="left"><strong>代码块</strong></td><td align="left"><code>{ }</code> 大括号</td><td align="left"><strong>缩进 (Indent)</strong></td><td align="left"><code>{ }</code></td><td align="left"><code>{ }</code></td></tr><tr><td align="left"><strong>变量声明</strong></td><td align="left"><code>int x = 10;</code> / <code>var x = 10;</code></td><td align="left"><code>x: int = 10</code></td><td align="left"><code>val x = 10</code> / <code>var x = 10</code></td><td align="left"><code>const x = 10</code> / <code>let x = 10</code></td></tr><tr><td align="left"><strong>空值</strong></td><td align="left"><code>null</code></td><td align="left"><strong><code>None</code></strong></td><td align="left"><code>null</code></td><td align="left"><code>null</code> / <code>undefined</code></td></tr><tr><td align="left"><strong>方法定义</strong></td><td align="left"><code>public R name(P p) { }</code></td><td align="left"><code>def name(p: P) -&gt; R:</code></td><td align="left"><code>fun name(p: P): R { }</code></td><td align="left"><code>function name(p: P): R { }</code></td></tr><tr><td align="left"><strong>构造函数</strong></td><td align="left"><code>public ClassName() { }</code></td><td align="left"><code>def __init__(self):</code></td><td align="left"><code>constructor() { }</code></td><td align="left"><code>constructor() { }</code></td></tr><tr><td align="left"><strong>当前实例</strong></td><td align="left"><code>this</code> (隐式)</td><td align="left"><strong><code>self</code> (必须显式在首位)</strong></td><td align="left"><code>this</code></td><td align="left"><code>this</code></td></tr><tr><td align="left"><strong>密封类/匹配</strong></td><td align="left"><code>sealed class</code> + <code>permits</code></td><td align="left"><code>match ... case</code></td><td align="left"><code>sealed class</code> + <code>when</code></td><td align="left"><code>union types</code> + <code>switch</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">第二部分：底层逻辑对标 (JVM vs CPython)</h3>
<p>在写代码前，必须理解两者“世界观”的差异：</p>
<ol>
<li><strong>运行模型 (GIL vs JIT)</strong>：
<ul>
<li><strong>Java</strong>：真多线程并行，依赖 JIT 编译优化。</li>
<li><strong>Python</strong>：拥有 <strong>GIL (全局解释器锁)</strong>。同一时刻只有一个线程执行字节码。</li>
<li><strong>结论</strong>：计算密集型任务用 <code>multiprocessing</code>（多进程），IO 密集型用 <code>asyncio</code>。</li>
</ul>
</li>
<li><strong>内存管理</strong>：
<ul>
<li><strong>Java</strong>：可达性分析，由 GC（G1/ZGC）负责扫描。</li>
<li><strong>Python</strong>：核心是 <strong>引用计数 (Reference Counting)</strong>，辅以<strong>标记清除</strong>解决循环引用。对象引用归零时立即释放。</li>
</ul>
</li>
<li><strong>作用域 (LEGB Rule)</strong>：
<ul>
<li>Python 没有块级作用域（<code>if/for</code> 块内定义的变量块外可见）。变量查找顺序：Local -&gt; Enclosing (闭包) -&gt; Global -&gt; Built-in。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">第三部分：核心进阶特性深度解析</h3>
<h4 data-id="heading-4">1. 类型注解与结构化匹配 (Java Record &amp; Switch 增强)</h4>
<ul>
<li><strong>Java 对标</strong>：Java 17 的 <code>record</code> 和模式匹配 <code>switch</code>。</li>
<li><strong>Python 实战</strong>：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    role: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_user</span>(<span class="hljs-params">data: User | <span class="hljs-built_in">dict</span></span>): <span class="hljs-comment"># 3.10+ 联合类型写法</span>
    <span class="hljs-keyword">match</span> data:
        <span class="hljs-keyword">case</span> User(<span class="hljs-built_in">id</span>=idx, role=<span class="hljs-string">"admin"</span>): <span class="hljs-comment"># 结构化解构</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Admin <span class="hljs-subst">{idx}</span> logged in"</span>)
        <span class="hljs-keyword">case</span> {<span class="hljs-string">"id"</span>: idx}: <span class="hljs-comment"># 字典解构</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Guest <span class="hljs-subst">{idx}</span>"</span>)
        <span class="hljs-keyword">case</span> _:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Unknown"</span>)
</code></pre>
</li>
</ul>
<h4 data-id="heading-5">2. 协议 (Protocols) 与魔法方法</h4>
<ul>
<li><strong>Java 对标</strong>：<code>interface</code>。</li>
<li><strong>Python 逻辑</strong>：Python 使用 <strong>鸭子类型</strong>。如果你实现了特殊的“魔法方法”，你就实现了对应的“接口”。
<ul>
<li><code>__call__</code>：使对象可调用（类似 <code>@FunctionalInterface</code>）。</li>
<li><code>__getitem__</code>：使对象支持索引取值（类似 <code>List.get()</code>）。</li>
<li><code>__enter__ / __exit__</code>：支持 <code>with</code> 语句（类似 <code>AutoCloseable</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">3. 装饰器 (Decorators)</h4>
<ul>
<li><strong>Java 对标</strong>：<strong>Spring AOP</strong>。</li>
<li><strong>本质</strong>：它是高阶函数，<code>@log</code> 装饰 <code>func</code> 等同于执行 <code>func = log(func)</code>。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Calling <span class="hljs-subst">{func.__name__}</span>"</span>)
        <span class="hljs-keyword">return</span> func(*args, **kwargs)
    <span class="hljs-keyword">return</span> wrapper
</code></pre>
</li>
</ul>
<h4 data-id="heading-7">4. 异步编程 (Async/Await)</h4>
<ul>
<li><strong>Java 对标</strong>：<code>CompletableFuture</code> 或 Java 21 的虚拟线程。</li>
<li><strong>关键点</strong>：Python 异步是<strong>单线程协作式</strong>。在 <code>await</code> 处挂起，让出 CPU 给其他协程。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>) <span class="hljs-comment"># 非阻塞休眠</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"data"</span>: <span class="hljs-number">200</span>}
</code></pre>
</li>
</ul>
<h4 data-id="heading-8">5. 上下文管理器 (Context Managers)</h4>
<ul>
<li><strong>Java 对标</strong>：<code>try-with-resources</code>。</li>
<li><strong>Python 优雅之处</strong>：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"config.json"</span>) <span class="hljs-keyword">as</span> f:
    data = f.read()
<span class="hljs-comment"># 离开缩进自动关闭文件</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-9">6. 生成器 (Generators / yield)</h4>
<ul>
<li><strong>Java 对标</strong>：Java 没有直接对应，通常通过 <code>Iterator</code> 模拟。</li>
<li><strong>价值</strong>：处理海量数据时，一次只产出一个值，内存占用极低。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">count_stream</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):
        <span class="hljs-keyword">yield</span> i <span class="hljs-comment"># 暂停并返回</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-10">7. 元类 (Metaclasses)</h4>
<ul>
<li><strong>Java 对标</strong>：<strong>动态代理 / 字节码增强 (ByteBuddy)</strong>。</li>
<li><strong>用途</strong>：拦截类的创建过程。比如所有继承自 <code>BaseModel</code> 的类，在加载时自动检查是否定义了主键。</li>
</ul>
<h4 data-id="heading-11">8. 属性描述符 (Descriptors)</h4>
<ul>
<li><strong>Java 对标</strong>：Lombok 的底层逻辑或自定义 Getter/Setter。</li>
<li><strong>实现</strong>：通过 <code>__get__</code> 和 <code>__set__</code> 代理属性访问，是 Django ORM 等框架实现的核心。</li>
</ul>
<h4 data-id="heading-12">9. 弱引用 (Weak References)</h4>
<ul>
<li><strong>Java 对标</strong>：<code>WeakReference&lt;T&gt;</code>。</li>
<li><strong>场景</strong>：实现大对象缓存，避免因缓存导致的内存泄漏。</li>
</ul>
<h4 data-id="heading-13">10. 函数工具 (functools)</h4>
<ul>
<li><strong>核心工具</strong>：
<ul>
<li><code>@lru_cache</code>：一行代码实现方法结果缓存。</li>
<li><code>@wraps</code>：确保装饰器不丢失原函数的元数据（如函数名）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-14">第四部分：四语言“全能示例”建模对比</h3>
<p><strong>场景：异步用户服务，包含数据定义、异步获取与流式处理。</strong></p>
<h4 data-id="heading-15">Python 3.10+ (Modern Python)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:
    uid: <span class="hljs-built_in">int</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_async</span>(<span class="hljs-params">self, uid: <span class="hljs-built_in">int</span></span>) -&gt; User:
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
        <span class="hljs-keyword">return</span> User(uid)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_stream</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
            <span class="hljs-keyword">yield</span> User(i) <span class="hljs-comment"># 生成器</span>
</code></pre>
<h4 data-id="heading-16">Java 17</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">User</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> CompletableFuture&lt;User&gt; <span class="hljs-title function_">getUserAsync</span><span class="hljs-params">(<span class="hljs-type">int</span> uid)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">100</span>); } <span class="hljs-keyword">catch</span> (Exception e) {}
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(uid);
        });
    }

    <span class="hljs-keyword">public</span> Stream&lt;User&gt; <span class="hljs-title function_">getUserStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>).mapToObj(User::<span class="hljs-keyword">new</span>);
    }
}
</code></pre>
<h4 data-id="heading-17">Kotlin</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> uid: <span class="hljs-built_in">Int</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserAsync</span><span class="hljs-params">(uid: <span class="hljs-type">Int</span>)</span></span>: User {
        delay(<span class="hljs-number">100</span>)
        <span class="hljs-keyword">return</span> User(uid)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserStream</span><span class="hljs-params">()</span></span> = sequence {
        repeat(<span class="hljs-number">3</span>) { yield(User(it)) }
    }
}
</code></pre>
<h4 data-id="heading-18">TypeScript</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> { <span class="hljs-attr">uid</span>: <span class="hljs-built_in">number</span>; }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserAsync</span>(<span class="hljs-attr">uid</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">100</span>));
        <span class="hljs-keyword">return</span> { uid };
    }

    *<span class="hljs-title function_">getUserStream</span>(): <span class="hljs-title class_">IterableIterator</span>&lt;<span class="hljs-title class_">User</span>&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) <span class="hljs-keyword">yield</span> { <span class="hljs-attr">uid</span>: i };
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-19">第五部分：Java 开发者转 Python 避坑指南</h3>
<ol>
<li><strong>可变默认参数</strong>：
<ul>
<li>❌ <code>def add(item, items=[])</code>：这个 <code>[]</code> 是静态的，所有调用共享同一个列表！</li>
<li>✅ <code>def add(item, items=None)</code>：内部初始化 <code>if items is None: items = []</code>。</li>
</ul>
</li>
<li><strong>多线程误区</strong>：
<ul>
<li>不要指望 Python 的 <code>threading</code> 能加速 CPU 密集型计算。计算量大请直奔 <code>multiprocessing</code>。</li>
</ul>
</li>
<li><strong>工程化选型</strong>：
<ul>
<li><strong>包管理</strong>：放弃 <code>pip</code>，使用 <strong>Poetry</strong> (类似 Maven/Gradle)。</li>
<li><strong>Lint/格式化</strong>：使用 <strong>Ruff</strong> (极速 Rust 编写)。</li>
<li><strong>Web 框架</strong>：首选 <strong>FastAPI</strong> (基于类型注解，自带 Swagger，性能卓越)。</li>
</ul>
</li>
<li><strong>相等性判断</strong>：
<ul>
<li>Python 的 <code>==</code> 默认比较内容（类似 Java 的 <code>.equals()</code>）。</li>
<li>Python 的 <code>is</code> 比较引用（类似 Java 的 <code>==</code>）。</li>
</ul>
</li>
</ol>
<p>这份百科全书将 Python 的灵活性与 Java 的严谨性有机结合。当你掌握了 <strong>魔法方法</strong>、<strong>异步协程</strong> 和 <strong>模式匹配</strong> 后，你将能在 Python 领域发挥出等同于 Java 专家的生产力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java、Python、Kotlin、TS 语言对比]]></title>    <link>https://juejin.cn/post/7588445332772716598</link>    <guid>https://juejin.cn/post/7588445332772716598</guid>    <pubDate>2025-12-29T03:34:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445332772716598" data-draft-id="7587740546954444840" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java、Python、Kotlin、TS 语言对比"/> <meta itemprop="keywords" content="全栈"/> <meta itemprop="datePublished" content="2025-12-29T03:34:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若丶相见"/> <meta itemprop="url" content="https://juejin.cn/user/2330620381380311"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java、Python、Kotlin、TS 语言对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2330620381380311/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若丶相见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T03:34:42.000Z" title="Mon Dec 29 2025 03:34:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们将 Java 17 作为基准坐标，深度拆解 Python 3.10+ 的核心特性，并同步对比 Kotlin 和 TypeScript。这份文档分为<strong>基础语法实战</strong>与<strong>进阶特性大百科</strong>两部分。</p>
<hr/>
<h2 data-id="heading-0">第一部分：语法基础实战 (快速上手)</h2>
<p>这部分旨在让你看完就能模仿写出基础代码。</p>
<h4 data-id="heading-1">1. 变量与类型定义</h4>
<ul>
<li><strong>Java 17</strong>: <code>var list = new ArrayList&lt;String&gt;();</code> 或 <code>final String s = "Hi";</code></li>
<li><strong>Python</strong>: <code>names: list[str] = ["A", "B"]</code> (类型注解可选)</li>
<li><strong>Kotlin</strong>: <code>val name: String = "A"</code> (常量), <code>var age: Int = 1</code> (变量)</li>
<li><strong>TS</strong>: <code>const name: string = "A"</code>, <code>let age: number = 1</code></li>
</ul>
<h4 data-id="heading-2">2. 函数定义</h4>

























<table><thead><tr><th align="left">语言</th><th align="left">示例代码</th></tr></thead><tbody><tr><td align="left"><strong>Java</strong></td><td align="left"><code>public int add(int a, int b) { return a + b; }</code></td></tr><tr><td align="left"><strong>Python</strong></td><td align="left"><code>def add(a: int, b: int) -&gt; int: return a + b</code></td></tr><tr><td align="left"><strong>Kotlin</strong></td><td align="left"><code>fun add(a: Int, b: Int): Int = a + b</code></td></tr><tr><td align="left"><strong>TS</strong></td><td align="left"><code>function add(a: number, b: number): number { return a + b; }</code></td></tr></tbody></table>
<h4 data-id="heading-3">3. 基础类结构</h4>

























<table><thead><tr><th align="left">语言</th><th align="left">核心写法 (包含构造函数和成员)</th></tr></thead><tbody><tr><td align="left"><strong>Java</strong></td><td align="left"><code>class User { private String name; public User(String n) { this.name = n; } }</code></td></tr><tr><td align="left"><strong>Python</strong></td><td align="left"><code>class User: def __init__(self, name: str): self.name = name</code></td></tr><tr><td align="left"><strong>Kotlin</strong></td><td align="left"><code>class User(val name: String)</code> (主构造函数极致简洁)</td></tr><tr><td align="left"><strong>TS</strong></td><td align="left"><code>class User { constructor(public name: string) {} }</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">第二部分：进阶特性深度对比 (高级工具箱)</h2>
<p>每个模块包含：<strong>定义</strong>、<strong>Java 背景</strong>、<strong>多语言实战示例</strong>。</p>
<h4 data-id="heading-5">1. 类型注解 (Type Hints)</h4>
<ul>
<li><strong>定义</strong>：在动态语言里显式标注类型，以便 IDE 检查错误和代码补全。</li>
<li><strong>Java 17 背景</strong>：Java 是强类型，不写类型过不了编译。Python 引入注解是为了解决“动态类型一时爽，重构代码火葬场”的问题。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python: 复杂类型使用 typing 模块</span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Union</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">vals: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], flag: <span class="hljs-type">Union</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Done"</span> <span class="hljs-keyword">if</span> vals <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># TS: 结构几乎一致</span>
function processData(vals: number[], flag: number | string): string | null {
    <span class="hljs-keyword">return</span> vals.length &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"Done"</span> : null;
}
</code></pre>
<h4 data-id="heading-6">2. 异步编程 (async/await)</h4>
<ul>
<li><strong>定义</strong>：非阻塞 IO。当程序在等待网络返回时，CPU 可以去处理别的任务。</li>
<li><strong>Java 17 背景</strong>：对应 <code>CompletableFuture</code>。Java 21 引入了虚拟线程（Virtual Threads）来简化这种开发。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>) <span class="hljs-comment"># 模拟网络等待</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Data"</span>

<span class="hljs-comment"># TS</span>
<span class="hljs-keyword">async</span> function fetch(): Promise&lt;string&gt; {
    <span class="hljs-keyword">await</span> new Promise(resolve =&gt; setTimeout(resolve, <span class="hljs-number">1000</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Data"</span>;
}

<span class="hljs-comment"># Kotlin (使用协程)</span>
suspend fun fetch(): String {
    delay(<span class="hljs-number">1000</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Data"</span>
}
</code></pre>
<h4 data-id="heading-7">3. 装饰器 (Decorators)</h4>
<ul>
<li><strong>定义</strong>：在函数或类之上添加逻辑的包装器（AOP 思想）。</li>
<li><strong>Java 17 背景</strong>：类似于 Spring 的 <code>@Transactional</code> 或 <code>@Cacheable</code>，但 Java 必须配合反射和 AOP 框架实现。Python 是原生语法支持。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python: 装饰器是一个接收函数并返回新函数的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"调用了 <span class="hljs-subst">{func.__name__}</span>"</span>)
        <span class="hljs-keyword">return</span> func(*args)
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@debug</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">my_job</span>(): <span class="hljs-keyword">pass</span>
</code></pre>
<h4 data-id="heading-8">4. 上下文管理器 (Context Managers)</h4>
<ul>
<li><strong>定义</strong>：自动管理资源的生命周期（如：自动关闭文件、释放锁）。</li>
<li><strong>Java 17 背景</strong>：等同于 <strong><code>try-with-resources</code></strong>。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'data.txt'</span>, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
    content = f.read() <span class="hljs-comment"># 离开缩进块后 f 自动关闭</span>

<span class="hljs-comment"># Java 17</span>
<span class="hljs-keyword">try</span> (var reader = new FileReader(<span class="hljs-string">"data.txt"</span>)) {
    // 自动关闭
}

<span class="hljs-comment"># Kotlin</span>
File(<span class="hljs-string">"data.txt"</span>).bufferedReader().use { it.readText() }
</code></pre>
<h4 data-id="heading-9">5. 生成器 (Generators / yield)</h4>
<ul>
<li><strong>定义</strong>：一种可以暂停和恢复的函数，每次产出一个值，不一次性占用内存。</li>
<li><strong>Java 17 背景</strong>：Java 没有 <code>yield</code>。类似功能需要用 <code>Iterator</code> 或 <code>Stream</code> 模拟。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">count_to_three</span>():
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>

<span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> count_to_three(): <span class="hljs-built_in">print</span>(n)

<span class="hljs-comment"># TS</span>
function* countToThree() {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>; <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
}
</code></pre>
<h4 data-id="heading-10">6. 异步生成器 (Async Generators)</h4>
<ul>
<li><strong>定义</strong>：结合了异步等待和惰性产出。常用于流式处理网络数据。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_gen</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>) <span class="hljs-comment"># 每秒产生一个数据</span>
        <span class="hljs-keyword">yield</span> i

<span class="hljs-comment"># TS</span>
<span class="hljs-keyword">async</span> function* asyncGen() {
    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">await</span> Promise.resolve(<span class="hljs-number">1</span>);
}
</code></pre>
<h4 data-id="heading-11">7. 数据类 (Dataclasses)</h4>
<ul>
<li><strong>定义</strong>：自动生成构造、equals、toString 等方法的类。</li>
<li><strong>Java 17 背景</strong>：完全等同于 <strong><code>record</code></strong>。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>:
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    name: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># Java 17</span>
public record User(<span class="hljs-built_in">int</span> <span class="hljs-built_in">id</span>, String name) {}

<span class="hljs-comment"># Kotlin</span>
data <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(val <span class="hljs-built_in">id</span>: Int, val name: String)
</code></pre>
<h4 data-id="heading-12">8. 属性装饰器 (@property)</h4>
<ul>
<li><strong>定义</strong>：将方法伪装成属性。外部通过 <code>obj.age</code> 访问，内部运行 <code>get_age()</code> 逻辑。</li>
<li><strong>Java 17 背景</strong>：标准的 Getter/Setter 模式。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bank</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>): self._money = <span class="hljs-number">0</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">money</span>(<span class="hljs-params">self</span>): <span class="hljs-keyword">return</span> self._money
<span class="hljs-meta">    @money.setter</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">money</span>(<span class="hljs-params">self, val</span>): 
        <span class="hljs-keyword">if</span> val &lt; <span class="hljs-number">0</span>: <span class="hljs-keyword">raise</span> ValueError
        self._money = val
</code></pre>
<h4 data-id="heading-13">9. 静态与类方法 (@staticmethod / @classmethod)</h4>
<ul>
<li><strong>Java 17 背景</strong>：Java 只有一种 <code>static</code>。</li>
<li><strong>Python 细化</strong>：
<ul>
<li><code>@staticmethod</code>: 纯工具函数。</li>
<li><code>@classmethod</code>: 第一个参数是 <code>cls</code>，支持多态（子类调用时 <code>cls</code> 是子类）。</li>
</ul>
</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Tool</span>:
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">cls</span>): <span class="hljs-comment"># 工厂模式</span>
        <span class="hljs-keyword">return</span> cls()

<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>): <span class="hljs-keyword">return</span> a + b
</code></pre>
<h4 data-id="heading-14">10. 元类 (Metaclasses)</h4>
<ul>
<li><strong>定义</strong>：“制造类的工厂”。</li>
<li><strong>Java 17 背景</strong>：对应动态代理或字节码操作（CGLIB/ByteBuddy）。</li>
<li><strong>实战场景</strong>：例如 <code>AutoTransactionDecoratorMeta</code> 可以在类加载时，自动给所有以 <code>save_</code> 开头的方法加上事务逻辑。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 示例：所有属性变大写</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UpperMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, name, bases, dct</span>):
        upper_dct = {k.upper(): v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> dct.items()}
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().__new__(cls, name, bases, upper_dct)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>(metaclass=UpperMeta):
    name = <span class="hljs-string">"test"</span> <span class="hljs-comment"># 访问时需用 MyClass.NAME</span>
</code></pre>
<h4 data-id="heading-15">11. 弱引用 (Weak References)</h4>
<ul>
<li><strong>定义</strong>：不阻止垃圾回收。</li>
<li><strong>Java 17 背景</strong>：<code>WeakReference&lt;T&gt;</code>。</li>
<li><strong>实战场景</strong>：大对象缓存。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">import</span> weakref
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LargeObject</span>: <span class="hljs-keyword">pass</span>
obj = LargeObject()
r = weakref.ref(obj) <span class="hljs-comment"># 当 obj = None 时，r() 也会变成 None</span>

<span class="hljs-comment"># TS</span>
const cache = new WeakMap(); // 键被回收后，值自动清理
</code></pre>
<h4 data-id="heading-16">12. 枚举类 (Enum)</h4>
<ul>
<li><strong>Java 17 背景</strong>：Java 的 Enum 非常强大（能写方法）。</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Color</span>(<span class="hljs-title class_ inherited__">Enum</span>):
    RED = <span class="hljs-number">1</span>
    BLUE = <span class="hljs-number">2</span>

<span class="hljs-comment"># TS</span>
enum Color { Red = <span class="hljs-number">1</span>, Blue = <span class="hljs-number">2</span> }
</code></pre>
<h4 data-id="heading-17">13. 函数工具 (functools)</h4>
<ul>
<li><strong>定义</strong>：增强函数操作的工具集。</li>
<li><strong>核心工具</strong>：
<ul>
<li><code>@wraps</code>: 防止装饰器弄丢原函数的元数据。</li>
<li><code>partial</code>: 偏函数，固定部分参数。</li>
</ul>
</li>
<li><strong>实战示例</strong>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial

<span class="hljs-keyword">def</span> <span class="hljs-title function_">power</span>(<span class="hljs-params">base, exp</span>): <span class="hljs-keyword">return</span> base ** exp
square = partial(power, exp=<span class="hljs-number">2</span>) <span class="hljs-comment"># 固定 exp 为 2</span>
<span class="hljs-built_in">print</span>(square(<span class="hljs-number">5</span>)) <span class="hljs-comment"># 结果 25</span>
</code></pre>
<h4 data-id="heading-18">14. Protocol Buffers (Protobuf)</h4>
<ul>
<li><strong>定义</strong>：跨语言的结构化数据序列化协议。</li>
<li><strong>实战说明</strong>：
<ul>
<li><strong>Java</strong>: 编译 <code>.proto</code> 文件生成 Java 类，通过 <code>get/set</code> 操作。</li>
<li><strong>Python</strong>: 生成 <code>_pb2.py</code>，操作像操作普通类属性一样。</li>
<li><strong>对比</strong>: Java 是编译期确定的；Python 在运行时更灵活，但也容易写错字段名。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-19">总结：Java 17 开发者上手建议</h2>
<ol>
<li><strong>关于 <code>self</code></strong>：Python 的 <code>self</code> 对应 Java 的 <code>this</code>，但必须显式写在方法的第一个参数里。</li>
<li><strong>关于缩进</strong>：不要在 Python 里找大括号，缩进就是你的逻辑边界。</li>
<li><strong>关于异步</strong>：Python 的 <code>asyncio</code> 是单线程异步，<strong>严禁</strong>在 <code>async</code> 函数里写耗时长的同步计算（会卡死整个程序），这与 Java 的多线程模型完全不同。</li>
<li><strong>关于 Record</strong>：只要在 Python 里想用 Java Record，直接用 <code>@dataclass</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 防抖函数中的闭包陷阱与解决方案]]></title>    <link>https://juejin.cn/post/7588711557499879474</link>    <guid>https://juejin.cn/post/7588711557499879474</guid>    <pubDate>2025-12-29T04:01:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588711557499879474" data-draft-id="7588711557499830322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 防抖函数中的闭包陷阱与解决方案"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-29T04:01:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鲫小鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1046390798032110"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 防抖函数中的闭包陷阱与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390798032110/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鲫小鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T04:01:06.000Z" title="Mon Dec 29 2025 04:01:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在 React 开发中，我们经常需要对用户输入进行防抖处理，以减少不必要的 API 请求。例如，在搜索功能中，我们希望用户停止输入 500ms 后再发起搜索请求。</p>
<p>然而，当我们在 <code>useEffect</code> 中使用防抖函数时，如果不注意处理，很容易遇到**闭包陷阱（Stale Closure）**问题，导致防抖函数内部访问的是过时的状态值，而不是最新的值。</p>
<h2 data-id="heading-1">问题场景</h2>
<p>假设我们有一个搜索组件，需要在用户输入关键词时，延迟 500ms 后获取推荐商品列表：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 如果没有搜索关键字，不请求</span>
    <span class="hljs-keyword">if</span> (!keyWord || !keyWord.<span class="hljs-title function_">trim</span>()) {
      <span class="hljs-title function_">setProductList</span>([])
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Search</span>.<span class="hljs-property">SearchParams</span> = {
      <span class="hljs-attr">keyword</span>: keyWord.<span class="hljs-title function_">trim</span>(),  <span class="hljs-comment">// 使用 keyWord</span>
      <span class="hljs-attr">size</span>: <span class="hljs-number">5</span>,
      <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
    }

    <span class="hljs-keyword">if</span> (vehicleData?.<span class="hljs-property">attributeValueId</span>) {
      params.<span class="hljs-property">attributeValueId</span> = vehicleData.<span class="hljs-property">attributeValueId</span>
    }

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(params)
    <span class="hljs-comment">// ... 处理响应</span>
  }

  <span class="hljs-comment">// 创建防抖函数</span>
  <span class="hljs-keyword">const</span> debouncedFn = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
  <span class="hljs-title function_">debouncedFn</span>()

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    debouncedFn.<span class="hljs-title function_">cancel</span>()
  }
}, [keyWord, vehicleData?.<span class="hljs-property">attributeValueId</span>, vehicleData?.<span class="hljs-property">allAttributeValue</span>])
</code></pre>
<h3 data-id="heading-2">问题表现</h3>
<p>当用户快速输入时，比如：</p>
<ol>
<li>输入 "tire" → <code>keyWord = "tire"</code></li>
<li>继续输入 "tire 17" → <code>keyWord = "tire 17"</code></li>
</ol>
<p>期望：防抖函数执行时应该使用最新的 <code>keyWord = "tire 17"</code>
实际：防抖函数可能使用的是旧的 <code>keyWord = "tire"</code></p>
<h2 data-id="heading-3">问题分析：闭包陷阱</h2>
<h3 data-id="heading-4">什么是闭包？</h3>
<p>闭包（Closure）是 JavaScript 中的一个重要概念。当一个函数内部定义了另一个函数，并且内部函数引用了外部函数的变量时，就形成了闭包。内部函数会"记住"创建时能访问到的变量。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>  <span class="hljs-comment">// 外部变量</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    count++  <span class="hljs-comment">// 闭包捕获了 count</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count)
  }
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>()
<span class="hljs-title function_">counter</span>()  <span class="hljs-comment">// 输出: 1</span>
<span class="hljs-title function_">counter</span>()  <span class="hljs-comment">// 输出: 2</span>
</code></pre>
<h3 data-id="heading-5">React 中的闭包陷阱</h3>
<p>在 React 中，每次组件重新渲染时，函数组件都会重新执行，创建新的作用域。这导致了一个问题：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 第一次渲染：keyWord = "tire"</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// fetchProductList_1 闭包捕获：keyWord = "tire"</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList_1</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(keyWord)  <span class="hljs-comment">// "tire"</span>
  }

  <span class="hljs-comment">// debouncedFn 保存了 fetchProductList_1 的引用</span>
  <span class="hljs-keyword">const</span> debouncedFn = <span class="hljs-title function_">debounce</span>(fetchProductList_1, <span class="hljs-number">500</span>)

}, [keyWord])

<span class="hljs-comment">// 第二次渲染：keyWord = "tire 17"</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// fetchProductList_2 闭包捕获：keyWord = "tire 17"</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList_2</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(keyWord)  <span class="hljs-comment">// "tire 17"</span>
  }

  <span class="hljs-comment">// 但是！如果防抖函数已经存在，不会重新创建</span>
  <span class="hljs-comment">// debouncedFn 内部仍然引用的是 fetchProductList_1</span>
  <span class="hljs-comment">// 当防抖执行时，调用的是 fetchProductList_1，打印的是 "tire" ❌</span>

}, [keyWord])
</code></pre>
<h3 data-id="heading-6">为什么会出现这个问题？</h3>
<ol>
<li><strong>防抖函数只创建一次</strong>：为了保持防抖效果，我们通常会将防抖函数保存在 <code>useRef</code> 中，只创建一次</li>
<li><strong>闭包捕获旧值</strong>：第一次创建防抖函数时，<code>fetchProductList</code> 通过闭包捕获了当时的 <code>keyWord</code> 值</li>
<li><strong>后续更新无效</strong>：即使 <code>keyWord</code> 变化，<code>useEffect</code> 重新执行，但防抖函数已经存在，它内部仍然引用的是旧的 <code>fetchProductList</code>，而旧的 <code>fetchProductList</code> 闭包捕获的是旧值</li>
</ol>
<h3 data-id="heading-7">闭包链的传递</h3>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-function"><span class="hljs-title">keyWord</span> <span class="hljs-params">(第一次渲染的值，比如 <span class="hljs-string">"tire"</span>)</span>
    ↓
<span class="hljs-title">fetchProductList</span> <span class="hljs-params">(闭包捕获了 keyWord = <span class="hljs-string">"tire"</span>)</span>
    ↓
<span class="hljs-title">debounce</span><span class="hljs-params">(fetchProductList)</span> <span class="hljs-params">(保存了 fetchProductList 的引用)</span>
    ↓
<span class="hljs-title">debouncedFetchProductListRef</span>.<span class="hljs-title">current</span> <span class="hljs-params">(防抖函数只创建一次)</span>
</span></code></pre>
<p>当 <code>keyWord</code> 变成 <code>"tire 17"</code> 时：</p>
<ul>
<li><code>useEffect</code> 重新执行</li>
<li>创建新的 <code>fetchProductList</code>（捕获新的 <code>keyWord = "tire 17"</code>）</li>
<li>但防抖函数已经存在，不会重新创建</li>
<li>防抖函数内部仍然引用旧的 <code>fetchProductList</code>（捕获的是 <code>"tire"</code>）</li>
</ul>
<h2 data-id="heading-8">解决方案：使用 useRef 保存最新值</h2>
<h3 data-id="heading-9">核心思路</h3>
<p>使用 <code>useRef</code> 来保存最新的状态值，因为 <code>ref.current</code> 是一个可变的对象属性，不受闭包影响，读取时总是最新值。</p>
<h3 data-id="heading-10">实现步骤</h3>
<h4 data-id="heading-11">1. 创建 ref 保存最新值</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用于保存最新的 keyWord 和 vehicleData</span>
<span class="hljs-keyword">const</span> keyWordRef = useRef&lt;<span class="hljs-built_in">string</span>&gt;(keyWord)
<span class="hljs-keyword">const</span> vehicleDataRef = <span class="hljs-title function_">useRef</span>(vehicleData)
<span class="hljs-comment">// 用于保存防抖函数</span>
<span class="hljs-keyword">const</span> debouncedFetchProductListRef = useRef&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> debounce&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)
</code></pre>
<h4 data-id="heading-12">2. 在独立的 useEffect 中更新 ref</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 更新 ref 的值，确保防抖函数总是使用最新的值</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  keyWordRef.<span class="hljs-property">current</span> = keyWord
  vehicleDataRef.<span class="hljs-property">current</span> = vehicleData
}, [keyWord, vehicleData])
</code></pre>
<h4 data-id="heading-13">3. 在防抖函数中使用 ref 获取最新值</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 使用 ref 获取最新的值，而不是直接使用闭包变量</span>
    <span class="hljs-keyword">const</span> currentKeyWord = keyWordRef.<span class="hljs-property">current</span>
    <span class="hljs-keyword">const</span> currentVehicleData = vehicleDataRef.<span class="hljs-property">current</span>

    <span class="hljs-comment">// 如果没有搜索关键字，不请求</span>
    <span class="hljs-keyword">if</span> (!currentKeyWord || !currentKeyWord.<span class="hljs-title function_">trim</span>()) {
      <span class="hljs-title function_">setProductList</span>([])
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Search</span>.<span class="hljs-property">SearchParams</span> = {
      <span class="hljs-attr">keyword</span>: currentKeyWord.<span class="hljs-title function_">trim</span>(),  <span class="hljs-comment">// 使用 ref 的值</span>
      <span class="hljs-attr">size</span>: <span class="hljs-number">5</span>,
      <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
    }

    <span class="hljs-keyword">if</span> (currentVehicleData?.<span class="hljs-property">attributeValueId</span>) {
      params.<span class="hljs-property">attributeValueId</span> = currentVehicleData.<span class="hljs-property">attributeValueId</span>
    }

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(params)
    <span class="hljs-comment">// ... 处理响应</span>
  }

  <span class="hljs-comment">// 创建防抖函数（如果还没有创建）</span>
  <span class="hljs-keyword">if</span> (!debouncedFetchProductListRef.<span class="hljs-property">current</span>) {
    debouncedFetchProductListRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
  }

  <span class="hljs-comment">// 调用防抖函数</span>
  debouncedFetchProductListRef.<span class="hljs-title function_">current</span>()

  <span class="hljs-comment">// 清理函数：组件卸载时取消待执行的防抖调用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (debouncedFetchProductListRef.<span class="hljs-property">current</span>) {
      debouncedFetchProductListRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">cancel</span>()
    }
  }
}, [keyWord, vehicleData?.<span class="hljs-property">attributeValueId</span>, vehicleData?.<span class="hljs-property">allAttributeValue</span>])
</code></pre>
<h3 data-id="heading-14">完整代码示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useState, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> debounce <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/my-lodash/debounce'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [keyWord, setKeyWord] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> [vehicleData, setVehicleData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> [productList, setProductList] = <span class="hljs-title function_">useState</span>([])
  <span class="hljs-keyword">const</span> [productLoading, setProductLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>)

  <span class="hljs-comment">// 用于跟踪当前请求的 ID，确保只处理最新请求的结果</span>
  <span class="hljs-keyword">const</span> requestIdRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)
  <span class="hljs-comment">// 用于保存防抖函数</span>
  <span class="hljs-keyword">const</span> debouncedFetchProductListRef = useRef&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> debounce&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)
  <span class="hljs-comment">// 用于保存最新的 keyWord 和 vehicleData，供防抖函数使用</span>
  <span class="hljs-keyword">const</span> keyWordRef = useRef&lt;<span class="hljs-built_in">string</span>&gt;(keyWord)
  <span class="hljs-keyword">const</span> vehicleDataRef = <span class="hljs-title function_">useRef</span>(vehicleData)

  <span class="hljs-comment">// 更新 ref 的值，确保防抖函数总是使用最新的值</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    keyWordRef.<span class="hljs-property">current</span> = keyWord
    vehicleDataRef.<span class="hljs-property">current</span> = vehicleData
  }, [keyWord, vehicleData])

  <span class="hljs-comment">// 获取推荐商品列表</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 使用 ref 获取最新的值</span>
      <span class="hljs-keyword">const</span> currentKeyWord = keyWordRef.<span class="hljs-property">current</span>
      <span class="hljs-keyword">const</span> currentVehicleData = vehicleDataRef.<span class="hljs-property">current</span>

      <span class="hljs-comment">// 如果没有搜索关键字，不请求</span>
      <span class="hljs-keyword">if</span> (!currentKeyWord || !currentKeyWord.<span class="hljs-title function_">trim</span>()) {
        <span class="hljs-title function_">setProductList</span>([])
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-comment">// 生成新的请求 ID</span>
      <span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>
      <span class="hljs-keyword">const</span> currentKeyword = currentKeyWord.<span class="hljs-title function_">trim</span>()

      <span class="hljs-title function_">setProductLoading</span>(<span class="hljs-literal">true</span>)
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Search</span>.<span class="hljs-property">SearchParams</span> = {
          <span class="hljs-attr">keyword</span>: currentKeyword,
          <span class="hljs-attr">size</span>: <span class="hljs-number">5</span>,
          <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
        }

        <span class="hljs-comment">// 如果有车型信息，添加到参数中</span>
        <span class="hljs-keyword">if</span> (currentVehicleData?.<span class="hljs-property">attributeValueId</span>) {
          params.<span class="hljs-property">attributeValueId</span> = currentVehicleData.<span class="hljs-property">attributeValueId</span>
        }
        <span class="hljs-keyword">if</span> (currentVehicleData?.<span class="hljs-property">allAttributeValue</span>) {
          params.<span class="hljs-property">allAttributeValue</span> = currentVehicleData.<span class="hljs-property">allAttributeValue</span>
        }

        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(params)

        <span class="hljs-comment">// 检查是否是最新的请求，如果不是则忽略结果</span>
        <span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
          <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// 再次检查关键词是否仍然匹配（双重保险）</span>
        <span class="hljs-keyword">if</span> (currentKeyword !== keyWordRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">trim</span>()) {
          <span class="hljs-keyword">return</span>
        }

        <span class="hljs-keyword">const</span> items = response?.<span class="hljs-property">itemList</span>?.<span class="hljs-property">data</span> || []
        <span class="hljs-title function_">setProductList</span>(items.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>))
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
          <span class="hljs-keyword">return</span>
        }
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取推荐商品失败:'</span>, error)
        <span class="hljs-title function_">setProductList</span>([])
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (currentRequestId === requestIdRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">setProductLoading</span>(<span class="hljs-literal">false</span>)
        }
      }
    }

    <span class="hljs-comment">// 创建防抖函数（如果还没有创建）</span>
    <span class="hljs-keyword">if</span> (!debouncedFetchProductListRef.<span class="hljs-property">current</span>) {
      debouncedFetchProductListRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
    }

    <span class="hljs-comment">// 调用防抖函数</span>
    debouncedFetchProductListRef.<span class="hljs-title function_">current</span>()

    <span class="hljs-comment">// 清理函数：组件卸载时取消待执行的防抖调用</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (debouncedFetchProductListRef.<span class="hljs-property">current</span>) {
        debouncedFetchProductListRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">cancel</span>()
      }
    }
  }, [keyWord, vehicleData?.<span class="hljs-property">attributeValueId</span>, vehicleData?.<span class="hljs-property">allAttributeValue</span>])

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// ... JSX</span>
  )
}
</code></pre>
<h2 data-id="heading-15">原理解析</h2>
<h3 data-id="heading-16">为什么 ref 可以解决闭包陷阱？</h3>
<p>关键在于理解 <code>ref.current</code> 的特性：</p>
<ol>
<li><strong>ref 是可变的对象属性</strong>：<code>ref.current</code> 是一个对象的属性，不是闭包变量</li>
<li><strong>读取时总是最新值</strong>：每次读取 <code>ref.current</code> 时，获取的都是当前最新的值</li>
<li><strong>不受闭包影响</strong>：即使函数通过闭包捕获了 <code>ref</code> 对象，读取 <code>ref.current</code> 时仍然能获取最新值</li>
</ol>
<h3 data-id="heading-17">对比分析</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误方式：直接使用闭包变量</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(keyWord)  <span class="hljs-comment">// 闭包捕获：keyWord = "tire"（创建时的值）</span>
  }
  <span class="hljs-keyword">const</span> debouncedFn = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
}, [keyWord])

<span class="hljs-comment">// ✅ 正确方式：使用 ref</span>
<span class="hljs-keyword">const</span> keyWordRef = <span class="hljs-title function_">useRef</span>(keyWord)

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  keyWordRef.<span class="hljs-property">current</span> = keyWord  <span class="hljs-comment">// 更新同一个对象的属性</span>
}, [keyWord])

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(keyWordRef.<span class="hljs-property">current</span>)  <span class="hljs-comment">// 读取对象属性，总是最新值</span>
  }
  <span class="hljs-keyword">const</span> debouncedFn = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
}, [])
</code></pre>
<h3 data-id="heading-18">执行流程对比</h3>
<p><strong>错误方式（直接使用闭包变量）：</strong></p>
<pre><code class="hljs language-ini" lang="ini">第一次渲染：<span class="hljs-attr">keyWord</span> = <span class="hljs-string">"tire"</span>
  → fetchProductList 闭包捕获 <span class="hljs-attr">keyWord</span> = <span class="hljs-string">"tire"</span>
  → debounce(fetchProductList) 保存引用
  → 防抖函数内部：永远只能访问 "tire"

第二次渲染：<span class="hljs-attr">keyWord</span> = <span class="hljs-string">"tire 17"</span>
  → 创建新的 fetchProductList（捕获 "tire 17"）
  → 但防抖函数已存在，不会重新创建
  → 防抖函数仍然调用旧的 fetchProductList（捕获 "tire"）❌
</code></pre>
<p><strong>正确方式（使用 ref）：</strong></p>
<pre><code class="hljs language-ini" lang="ini">第一次渲染：<span class="hljs-attr">keyWord</span> = <span class="hljs-string">"tire"</span>
  → <span class="hljs-attr">keyWordRef.current</span> = <span class="hljs-string">"tire"</span>
  → fetchProductList 读取 keyWordRef.current
  → debounce(fetchProductList) 保存引用

第二次渲染：<span class="hljs-attr">keyWord</span> = <span class="hljs-string">"tire 17"</span>
  → <span class="hljs-attr">keyWordRef.current</span> = <span class="hljs-string">"tire 17"</span>（更新同一个对象属性）
  → 防抖函数执行时，读取 <span class="hljs-attr">keyWordRef.current</span> = <span class="hljs-string">"tire 17"</span> ✅
</code></pre>
<h2 data-id="heading-19">最佳实践</h2>
<h3 data-id="heading-20">1. 分离 ref 更新逻辑</h3>
<p>将 ref 的更新放在独立的 <code>useEffect</code> 中，确保每次状态变化时都能及时更新：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 更新 ref 的值</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  keyWordRef.<span class="hljs-property">current</span> = keyWord
  vehicleDataRef.<span class="hljs-property">current</span> = vehicleData
}, [keyWord, vehicleData])
</code></pre>
<h3 data-id="heading-21">2. 防抖函数只创建一次</h3>
<p>使用条件判断确保防抖函数只创建一次：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (!debouncedFetchProductListRef.<span class="hljs-property">current</span>) {
  debouncedFetchProductListRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
}
</code></pre>
<h3 data-id="heading-22">3. 在清理函数中取消防抖</h3>
<p>组件卸载时取消待执行的防抖调用，避免内存泄漏：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (debouncedFetchProductListRef.<span class="hljs-property">current</span>) {
    debouncedFetchProductListRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">cancel</span>()
  }
}
</code></pre>
<h3 data-id="heading-23">4. 使用请求 ID 防止竞态条件</h3>
<p>对于异步请求，使用请求 ID 确保只处理最新请求的结果：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> requestIdRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>
  <span class="hljs-comment">// ... 发起请求</span>

  <span class="hljs-comment">// 检查是否是最新的请求</span>
  <span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
    <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 忽略旧请求的结果</span>
  }
  <span class="hljs-comment">// ... 处理响应</span>
}
</code></pre>
<h2 data-id="heading-24">常见错误</h2>
<h3 data-id="heading-25">错误 1：在防抖函数中直接使用状态变量</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!keyWord || !keyWord.<span class="hljs-title function_">trim</span>()) {  <span class="hljs-comment">// 闭包捕获旧值</span>
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// ...</span>
  }
  <span class="hljs-keyword">const</span> debouncedFn = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
}, [keyWord])
</code></pre>
<h3 data-id="heading-26">错误 2：每次重新创建防抖函数</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误：失去防抖效果</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; { <span class="hljs-comment">/* ... */</span> }
  <span class="hljs-keyword">const</span> debouncedFn = <span class="hljs-title function_">debounce</span>(fetchProductList, <span class="hljs-number">500</span>)
  <span class="hljs-title function_">debouncedFn</span>()
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> debouncedFn.<span class="hljs-title function_">cancel</span>()
}, [keyWord])  <span class="hljs-comment">// 每次 keyWord 变化都重新创建，防抖失效</span>
</code></pre>
<h3 data-id="heading-27">错误 3：忘记更新 ref</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误：ref 没有更新</span>
<span class="hljs-keyword">const</span> keyWordRef = <span class="hljs-title function_">useRef</span>(keyWord)

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> currentKeyWord = keyWordRef.<span class="hljs-property">current</span>  <span class="hljs-comment">// 永远是初始值</span>
    <span class="hljs-comment">// ...</span>
  }
}, [keyWord])  <span class="hljs-comment">// 缺少更新 ref 的 useEffect</span>
</code></pre>
<h2 data-id="heading-28">总结</h2>
<ol>
<li>
<p><strong>问题根源</strong>：防抖函数只创建一次，但内部函数通过闭包捕获了创建时的状态值，导致后续状态更新无法反映到防抖函数中。</p>
</li>
<li>
<p><strong>解决方案</strong>：使用 <code>useRef</code> 保存最新的状态值，在防抖函数中通过 <code>ref.current</code> 访问最新值，避免闭包陷阱。</p>
</li>
<li>
<p><strong>关键要点</strong>：</p>
<ul>
<li>防抖函数只创建一次，保持防抖效果</li>
<li>通过 ref 访问最新状态，避免闭包陷阱</li>
<li>及时更新 ref 的值</li>
<li>正确处理清理逻辑</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：所有需要在防抖/节流函数中访问最新状态的场景，如搜索输入、滚动事件处理、窗口大小变化等。</p>
</li>
</ol>
<h2 data-id="heading-29">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fescape-hatches%23stale-closures" target="_blank" title="https://react.dev/learn/escape-hatches#stale-closures" ref="nofollow noopener noreferrer">React Hooks FAQ - Stale Closures</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseRef" target="_blank" title="https://react.dev/reference/react/useRef" ref="nofollow noopener noreferrer">useRef Hook</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FClosures" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures" ref="nofollow noopener noreferrer">JavaScript Closures</a></li>
</ul>
<blockquote>
<p>最后感谢阅读！欢迎关注我，微信公众号：《鲫小鱼不正经》。欢迎点赞、收藏、关注，一键三连！！！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式系统重试策略详解：可靠性与资源消耗的平衡艺术]]></title>    <link>https://juejin.cn/post/7588365276192112678</link>    <guid>https://juejin.cn/post/7588365276192112678</guid>    <pubDate>2025-12-29T02:13:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588365276192112678" data-draft-id="7588464673285537819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式系统重试策略详解：可靠性与资源消耗的平衡艺术"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-12-29T02:13:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式系统重试策略详解：可靠性与资源消耗的平衡艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:13:44.000Z" title="Mon Dec 29 2025 02:13:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">分布式系统重试策略详解：可靠性与资源消耗的平衡艺术</h2>
<p>在分布式系统中，网络抖动、服务临时不可用、资源竞争等问题屡见不鲜。一个稳定的分布式系统，必然需要一套完善的“容错机制”来应对这些瞬时故障，而“重试策略”正是其中最基础也最核心的一环——通过对失败操作的合理重试，能极大提升系统的可靠性和最终一致性。但重试并非“越多越好”，不当的重试会导致资源浪费、雪崩效应等新问题。今天，我们就全面拆解重试策略的核心逻辑、常见类型、设计要点及落地实践，搞懂如何在“保证可靠性”与“控制资源消耗”之间找到平衡。</p>
<h3 data-id="heading-1">一、为什么需要重试策略？分布式场景的痛点驱动</h3>
<p>在单体系统中，故障多源于本地资源（如数据库连接、内存），故障范围可控；但分布式系统涉及多服务、多网络交互，故障场景更复杂且不可预测，主要痛点包括：</p>
<ul>
<li><strong>网络瞬时故障</strong>：跨服务调用时，网络延迟、 packet 丢失等瞬时问题会导致调用失败，这类故障通常无需复杂修复，重试一次即可恢复；</li>
<li><strong>服务临时不可用</strong>：服务因GC、峰值负载过高导致短暂响应超时，或节点重启、扩容期间的临时下线，等待片刻后重试即可成功；</li>
<li><strong>资源竞争冲突</strong>：如分布式锁竞争、数据库行锁争抢，短期内重试可规避冲突；</li>
<li><strong>第三方依赖不稳定</strong>：调用支付、物流等第三方接口时，第三方服务的瞬时抖动会导致调用失败，需通过重试保障业务连续性。</li>
</ul>
<p>重试策略的核心价值，就是通过“有条件、有策略的重复执行”，将这些“瞬时故障”带来的业务失败转化为成功，同时避免“无效重试”带来的资源浪费（如CPU、网络带宽）和“过度重试”引发的雪崩效应（如服务已崩溃仍持续重试，加剧负载）。</p>
<h3 data-id="heading-2">二、重试策略的核心定义：什么是“合理的重试”？</h3>
<p>重试策略并非“简单重复执行失败操作”，而是一套包含“触发条件、重试时机、重试次数、间隔规则、终止条件”的完整逻辑体系。核心定义是：<strong>针对可恢复的瞬时故障，按照预设的规则重复执行目标操作，直至操作成功或达到终止条件（如重试次数上限、超时），同时保证不会因重试引发新的系统问题</strong>。</p>
<p>一个完整的重试策略需包含5个核心要素：</p>
<ol>
<li><strong>触发条件</strong>：明确哪些失败场景需要重试（仅针对可恢复故障，如网络超时、服务暂时不可用；不可恢复故障如参数错误、业务逻辑失败，无需重试）；</li>
<li><strong>重试次数</strong>：设定最大重试次数（避免无限重试）；</li>
<li><strong>重试间隔</strong>：两次重试之间的时间间隔规则（如固定间隔、动态调整间隔）；</li>
<li><strong>终止条件</strong>：达到最大重试次数、超过总超时时间、遇到不可恢复故障，立即终止重试；</li>
<li><strong>降级/兜底方案</strong>：重试终止后仍失败的处理逻辑（如返回默认值、触发告警、人工介入）。</li>
</ol>
<h3 data-id="heading-3">三、常见重试策略详解：原理、适用场景与优缺点</h3>
<p>不同的业务场景（如高并发、低延迟、第三方依赖）需要不同的重试策略。下面拆解5种最常用的重试策略，明确其适用边界：</p>
<h4 data-id="heading-4">1. 固定间隔重试（Fixed Interval Retry）</h4>
<p>核心原理：每次重试的时间间隔固定不变（如每隔10秒重试一次）。</p>
<p>执行逻辑示例：调用失败后，等待10秒重试；再失败，等待10秒重试；直至达到最大重试次数（如3次）后终止。</p>
<p>适用场景：</p>
<ul>
<li>故障恢复时间可预测且稳定的场景（如服务定期重启，已知重启时间为5秒）；</li>
<li>对延迟不敏感的低频操作（如后台数据同步、日志归档）；</li>
<li>简单的本地重试或低并发场景（如数据库连接重试）。</li>
</ul>
<p>优点：实现最简单，逻辑清晰，开发维护成本低。</p>
<p>缺点：</p>
<ul>
<li>灵活性差：若服务恢复需要15秒，10秒间隔的重试会多一次无效重试；若服务1秒内恢复，10秒间隔会浪费时间，导致业务延迟；</li>
<li>资源浪费风险：高并发场景下，大量请求按固定间隔重试，可能集中冲击服务，引发二次故障。</li>
</ul>
<h4 data-id="heading-5">2. 指数退避重试（Exponential Backoff Retry）</h4>
<p>核心原理：重试间隔随重试次数呈指数级增长（如1秒、2秒、4秒、8秒...），给服务足够的时间恢复，同时减少无效重试。</p>
<p>执行逻辑示例：首次失败等待1秒重试；第二次失败等待2秒重试；第三次失败等待4秒重试；最大重试次数4次，总等待时间1+2+4+8=15秒。</p>
<p>适用场景：</p>
<ul>
<li>分布式系统核心场景：如跨服务调用、消息投递（如本地消息表向MQ投递消息）、第三方接口调用（支付、物流接口）；</li>
<li>故障恢复时间不确定的场景（如网络抖动、服务峰值负载过高）；</li>
<li>高并发场景：通过指数级增长的间隔，分散重试请求，避免集中冲击。</li>
</ul>
<p>优点：</p>
<ul>
<li>灵活性高：重试间隔动态调整，适配不同的故障恢复时间；</li>
<li>资源友好：减少无效重试，高并发下可避免重试风暴；</li>
<li>适用性广：是分布式系统的“首选重试策略”。</li>
</ul>
<p>缺点：</p>
<ul>
<li>实现稍复杂：需要计算指数级间隔，需注意间隔上限（避免后期间隔过大导致业务延迟过高）；</li>
<li>可能过度延迟：重试次数过多时，间隔会非常大（如第10次重试间隔512秒），不适合对延迟敏感的业务。</li>
</ul>
<p>优化变种：“指数退避+随机抖动”（Exponential Backoff with Jitter）——在指数间隔基础上增加随机值（如1±0.2秒、2±0.3秒），进一步分散高并发场景下的重试请求，避免“重试峰值”。这是目前最常用的优化方案，如RocketMQ、Kafka的重试机制均采用类似逻辑。</p>
<h4 data-id="heading-6">3. 线性递增退避重试（Linear Backoff Retry）</h4>
<p>核心原理：重试间隔随重试次数线性增长（如1秒、3秒、5秒、7秒...），介于固定间隔和指数退避之间，平衡灵活性和延迟。</p>
<p>执行逻辑示例：首次失败等待1秒，第二次3秒，第三次5秒，最大重试3次，总等待时间9秒。</p>
<p>适用场景：</p>
<ul>
<li>故障恢复时间呈线性增长的场景（如服务逐步扩容、资源逐步释放）；</li>
<li>对延迟敏感，且不希望指数退避后期间隔过大的场景（如用户端发起的异步操作）；</li>
<li>中等并发的跨服务调用场景。</li>
</ul>
<p>优点：平衡了固定间隔的简单性和指数退避的灵活性，延迟可控，资源消耗适中。</p>
<p>缺点：灵活性略逊于指数退避，对不可预测的故障恢复时间适配性一般。</p>
<h4 data-id="heading-7">4. 随机退避重试（Random Backoff Retry）</h4>
<p>核心原理：重试间隔为指定范围内的随机值（如每次在5~15秒内随机选择间隔）。</p>
<p>执行逻辑示例：首次失败等待8秒重试，第二次等待12秒重试，第三次等待6秒重试，达到最大次数后终止。</p>
<p>适用场景：</p>
<ul>
<li>高并发、大规模分布式场景（如秒杀活动中的服务调用）；</li>
<li>需要彻底分散重试请求，避免集中冲击的场景（如大量请求同时调用一个临时不可用的服务）；</li>
<li>故障恢复时间完全不可预测的场景。</li>
</ul>
<p>优点：能最大程度分散重试请求，避免重试风暴，保护服务稳定性。</p>
<p>缺点：</p>
<ul>
<li>逻辑不可控：可能出现间隔过短（无效重试）或过长（业务延迟）的情况；</li>
<li>不适合对延迟敏感的业务：随机间隔可能导致关键业务长时间等待。</li>
</ul>
<h4 data-id="heading-8">5. 熔断后停止重试（Circuit Breaker + Retry）</h4>
<p>核心原理：结合熔断机制，当失败率达到阈值（如1分钟内失败率50%）时，触发熔断，暂时停止重试，一段时间后再尝试“半开”状态（允许少量请求重试），避免对已崩溃的服务持续施压。</p>
<p>执行逻辑示例：1分钟内调用失败率达50%，触发熔断，接下来30秒内所有请求直接失败，不重试；30秒后进入半开状态，允许10个请求重试；若重试成功率达80%，熔断关闭，恢复正常重试；若仍失败，继续熔断。</p>
<p>适用场景：</p>
<ul>
<li>依赖不稳定的第三方服务（如外部支付接口、天气接口）；</li>
<li>服务集群故障，短时间内无法恢复的场景；</li>
<li>高并发、核心业务链路（如电商下单、支付链路）。</li>
</ul>
<p>优点：能有效避免重试风暴，保护系统整体稳定性；熔断状态的动态调整，平衡了可靠性和资源消耗。</p>
<p>缺点：实现复杂，需要结合熔断机制（如使用Resilience4j、Sentinel等框架），开发维护成本高。</p>
<h3 data-id="heading-9">四、重试策略设计要点：避开这些“坑”，才能落地成功</h3>
<p>重试策略的核心是“平衡”，设计时需重点关注以下6个要点，避免因不当设计引发新问题：</p>
<h4 data-id="heading-10">1. 明确重试触发条件：只对“可恢复故障”重试</h4>
<p>这是重试策略的“前提”，若对不可恢复故障重试，只会浪费资源。需严格区分故障类型：</p>
<ul>
<li><strong>可重试故障</strong>：网络超时、连接拒绝（服务临时下线）、服务繁忙（503状态码）、数据库死锁（短暂重试可规避）、MQ暂时不可用；</li>
<li><strong>不可重试故障</strong>：参数错误（400状态码）、权限不足（403）、业务逻辑失败（如库存不足、订单已取消）、资源不存在（404）、代码异常（500状态码，需修复代码）。</li>
</ul>
<p>实践建议：通过异常类型或状态码过滤，如HTTP请求中只对503、504、连接超时重试；RPC调用中只对“服务未就绪”“网络异常”重试。</p>
<h4 data-id="heading-11">2. 必须保证幂等性：避免重试导致数据异常</h4>
<p>重试的本质是“重复执行同一操作”，若操作不具备幂等性，会导致严重的数据问题（如重复扣减余额、重复创建订单）。这是重试策略落地的“核心保障”。</p>
<p>幂等性实现方案：</p>
<ul>
<li>使用唯一标识：如分布式事务中的“事务ID”、消息的“消息ID”，通过唯一标识判断操作是否已执行；</li>
<li>基于状态判断：如订单状态为“待支付”时才执行支付操作，已支付则直接返回成功；</li>
<li>使用幂等性接口：如数据库的“INSERT IGNORE”“UPDATE ... WHERE 版本号”。</li>
</ul>
<h4 data-id="heading-12">3. 合理设置重试阈值：避免无限重试和过度延迟</h4>
<p>需同时设置“最大重试次数”和“总超时时间”，双重限制：</p>
<ul>
<li><strong>最大重试次数</strong>：根据业务场景设定，高频核心操作（如支付）建议3<del>5次；低频后台操作（如数据同步）可设5</del>10次；</li>
<li><strong>总超时时间</strong>：避免重试间隔过长导致业务延迟过高，如用户端操作总超时建议≤30秒，后台操作可放宽至5分钟。</li>
</ul>
<p>示例：指数退避重试，最大次数4次，总超时时间15秒，既保证了重试机会，又控制了延迟。</p>
<h4 data-id="heading-13">4. 选择合适的退避策略：结合并发和延迟需求</h4>
<p>不同场景的策略选择建议：</p>
<ul>
<li>高并发、分布式核心链路：优先“指数退避+随机抖动”；</li>
<li>低频、延迟不敏感操作：选择“固定间隔重试”（简单高效）；</li>
<li>延迟敏感、故障恢复时间线性增长：选择“线性递增退避”；</li>
<li>第三方依赖不稳定、高并发：选择“熔断+指数退避”。</li>
</ul>
<h4 data-id="heading-14">5. 处理死信消息/失败任务：避免数据不一致</h4>
<p>重试终止后仍失败的任务（如死信消息），需有兜底方案，不能直接丢弃：</p>
<ul>
<li>存入死信队列/失败表：如MQ的死信队列、本地消息表的“投递失败”状态；</li>
<li>触发告警机制：通过短信、邮件通知运维人员介入处理；</li>
<li>人工重试/补偿：提供后台手动重试接口，或定时任务再次尝试（如每天凌晨重试死信消息）。</li>
</ul>
<h4 data-id="heading-15">6. 异步重试优先：避免阻塞核心业务</h4>
<p>核心业务链路（如用户下单、支付）的重试建议采用“异步重试”，避免同步重试阻塞主线程，导致用户等待过长：</p>
<ul>
<li>同步重试：仅适用于本地短耗时操作（如数据库连接重试、缓存获取重试），重试次数≤2次，间隔≤1秒；</li>
<li>异步重试：适用于跨服务调用、第三方接口调用、消息投递，通过定时任务或消息队列实现（如本地消息表的定时重试、死信队列的异步消费）。</li>
</ul>
<h3 data-id="heading-16">五、常见场景落地实践：重试策略的具体应用</h3>
<p>结合之前聊过的分布式事务场景，举例说明重试策略的落地：</p>
<h4 data-id="heading-17">场景1：本地消息表向MQ投递消息</h4>
<p>核心需求：保证消息可靠投递，避免因MQ临时不可用导致消息丢失。</p>
<p>重试策略设计：</p>
<ul>
<li>触发条件：MQ连接超时、投递失败（可重试）；MQ集群崩溃（不可重试，标记失败）；</li>
<li>重试策略：指数退避+随机抖动（首次10秒，第二次20秒，第三次40秒，最大重试5次）；</li>
<li>终止条件：重试5次失败，标记消息状态为“投递失败”，触发告警；</li>
<li>实现方式：定时任务扫描本地消息表，按策略重试投递，保证异步非阻塞。</li>
</ul>
<h4 data-id="heading-18">场景2：MQ消息消费失败重试</h4>
<p>核心需求：保证消息消费成功，避免因服务临时不可用导致业务失败。</p>
<p>重试策略设计：</p>
<ul>
<li>触发条件：服务超时、数据库异常（可重试）；业务逻辑失败（不可重试，直接进入死信队列）；</li>
<li>重试策略：RocketMQ默认的“指数退避+随机抖动”（重试16次，间隔从1秒递增到1024秒）；</li>
<li>终止条件：重试16次失败，进入死信队列；</li>
<li>兜底方案：运维人员监控死信队列，手动重试或分析失败原因。</li>
</ul>
<h4 data-id="heading-19">场景3：第三方支付接口调用</h4>
<p>核心需求：保证支付状态同步，避免因支付接口临时抖动导致状态不一致。</p>
<p>重试策略设计：</p>
<ul>
<li>触发条件：支付接口超时、503状态码（可重试）；400参数错误、403权限不足（不可重试）；</li>
<li>重试策略：线性递增退避（首次3秒，第二次6秒，第三次9秒，最大重试3次）；</li>
<li>终止条件：重试3次失败，异步记录到“支付失败表”，触发告警；</li>
<li>幂等性保障：通过“订单ID”作为唯一标识，避免重复支付。</li>
</ul>
<h3 data-id="heading-20">六、总结：重试策略的核心是“适度容错”</h3>
<p>重试策略不是“越多越好”，而是“适度容错”——它的核心价值是应对“瞬时故障”，提升系统可靠性，但不能替代系统本身的稳定性优化。一个优秀的重试策略，必然是“触发条件精准、间隔规则合理、终止条件明确、幂等性保障到位”的，同时结合业务场景选择同步/异步重试，平衡可靠性、延迟和资源消耗。</p>
<p>在实际开发中，建议优先使用成熟框架实现重试（如Resilience4j的Retry模块、Spring Retry、RocketMQ的重试机制），避免重复造轮子；同时，重试策略需要持续监控和优化——通过监控重试次数、成功率、死信数量，调整重试参数（如间隔、次数），让策略更适配业务实际情况。</p>
<p>最后，记住：<strong>重试是容错的“兜底手段”，而非“解决方案”</strong> 。优化服务稳定性（如服务熔断、限流、集群部署）、减少故障发生，才是提升分布式系统可靠性的根本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【高斯泼溅】3DGS城市模型从“硬盘杀手”到“轻盈舞者”？看我们如何实现14倍压缩]]></title>    <link>https://juejin.cn/post/7588456115883048995</link>    <guid>https://juejin.cn/post/7588456115883048995</guid>    <pubDate>2025-12-29T02:13:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588456115883048995" data-draft-id="7588793670494240808" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【高斯泼溅】3DGS城市模型从“硬盘杀手”到“轻盈舞者”？看我们如何实现14倍压缩"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-29T02:13:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【高斯泼溅】3DGS城市模型从“硬盘杀手”到“轻盈舞者”？看我们如何实现14倍压缩
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:13:34.000Z" title="Mon Dec 29 2025 02:13:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如何把一座城市渲染出来？</p>
<p>三年前，NeRF给出的答案是**“隐式网络+无尽采样”**，渲染的算力黑洞让人望而却步；如今，3D Gaussian Splatting(3DGS)用“显式高斯椭球”消除了渲染阶段对网络的依赖，却悄悄把问题翻了个面——<strong>模型体量大</strong>成了新瓶颈。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24bf14f8dc0b437fa18ffc9c36c009f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=TGkVtna4skWyc1lunrKvMRGAzB4%3D" alt="" loading="lazy"/></p>
<p><em>3DGS模型与椭球分布</em></p>
<p>当场景从“桌面摆件”扩展到“十字街头”再到“万亩城区”，数据像吹气球一样膨胀：数千万椭球、上百GB模型文件，<strong>训练时卡爆GPU，加载时撑爆显卡，传输时堵爆带宽，保存时挤占硬盘</strong>。</p>
<p><strong>“怎样在保真的同时变得更轻”</strong>，本文将主要分析3DGS模型潜在的冗余椭球问题及探讨相应的解决方法。</p>
<h2 data-id="heading-0">冗余椭球与训练缓慢</h2>
<p>当我们训练一个3DGS模型时，总会有一个疑问：这个场景到底需要多少椭球，才能既保证渲染质量又保证训练速度？</p>
<p><em><strong>01椭球数量的增长</strong></em></p>
<p>3DGS原始实现并没有设置一个固定的数量上限，而是靠着人为设置的阈值在指定训练次数后停止增长椭球。在典型的小区域环绕场景中椭球可以增长到500~600万左右。这个数量一般远超想要表达的主要兴趣区域所需。</p>
<p>图中在仅使用234万椭球的情况下即可达到570万的渲染指标。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11d835aacfeb4648984c91b9fe53aac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=BtPB11Fg6Od5dwe9EHcr2YP2Xbo%3D" alt="" loading="lazy"/></p>
<p><em>原生算法和简化效果对比</em></p>
<p><em><strong>02训练速度的降低</strong></em></p>
<p>随着椭球数量的增长，随之而来的是显卡显存的占用和计算压力的提升，带来的直接影响便是训练时长的显著增加。3DGS原始实现训练常用的小场景数据集时间平均在20~40分钟之间，而且我们可以显著的观察到<strong>训练速度是随着点数增长而相应降低</strong>的。</p>
<p>如何用更少的椭球数量实现同等的渲染质量是一个必须研究的方向。<strong>识别冗余椭球并删除</strong>，是一个显而易见的可行方案。</p>
<h2 data-id="heading-1">主流删除方案：直接法与剪枝法</h2>
<p><strong>直接法</strong>和<strong>剪枝法</strong>目的都是删除冗余点，但他们之间最主要的区别是：删除依据是可学习的还是人工设计的。</p>
<p><em><strong>01直接法</strong></em></p>
<p>直接法一般不参与训练中的梯度计算，仅在训练中/后直接<strong>计算每个椭球的重要性分数</strong>，逐步/一次删除至设定的点数。</p>
<p>这方面的代表有<strong>LightGaussian</strong>、<strong>TamingGS</strong>和<strong>Mini-splatting</strong>等论文。重要性分数的计算共有步骤有：</p>
<ol>
<li>输入训练视角的所有图片和位姿</li>
<li>遍历图片，每张图片计算与其有关椭球的重要性分数(不透明度、命中像素次数等)</li>
<li>累加所有视角，计算出最终每个椭球的重要性分数</li>
<li>根据需要，删除低分数椭球</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d74e18fcfbd74be1ac34b6136fc2b37d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=MHUTE4ewguEXGUhD3X0Dg357dlY%3D" alt="" loading="lazy"/></p>
<p><em>LightGaussian重要性计算</em></p>
<p><em><strong>02剪枝法</strong></em></p>
<p>剪枝法认为直接限制椭球数量上限难以满足渲染质量的要求，因此一般是在<strong>训练过程中识别并逐渐删除</strong>对渲染质量贡献较小的冗余高斯。</p>
<p>剪枝法的核心思想是为每个椭球<strong>增加一个可训练的参数</strong>，用于表示其对渲染的贡献程度，从而可以依据该参数直接进行删除。该方法的相关工作有<strong>CompactGS、MaskGS、GaussianSpa</strong>等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf1e80bd3c7425da30313b6e00cfc95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=4QlUa3y5EKERYKSHlSHrxe%2FhpmI%3D" alt="" loading="lazy"/></p>
<p><em>MaskGS流程图，M为可学习参数</em></p>
<p>与直接法重要性得分计算类似，剪枝法需要构建一个<strong>可以微分的重要性得分</strong>。在上述工作中，主要与椭球的不透明度、形状、透射率等参数相关联，依托椭球本身的属性来构建重要性。</p>
<p>比如<strong>CompactGS</strong>方法思路较为直接，直接构建mask掩膜，为每个椭球分配一个二值变量(0或1)，其中1表示渲染，0表示删除。虽然二值操作本身不可导，不能被优化，但是可以通过构造可导的间接变量，使得梯度可以传导至掩码。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a32f8e66b264bb78564a2a602abefae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=0G1peFS2ITjZE1TyqGG7mE4P4xI%3D" alt="" loading="lazy"/></p>
<p><em>CompactGS掩码公式</em></p>
<p>从下表可以看出：</p>
<ul>
<li>原始3DGS中确实存在较多冗余椭球</li>
<li>两类方法均可以在<strong>较大的压缩比</strong>下实现<strong>接近甚至超出的质量</strong></li>
<li>删除椭球后<strong>训练时间</strong>有不同程度<strong>降低</strong>(GaussianSPA训练轮数更多)</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad423dd2692143aa8aa8e7387bf972e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=LHd4caJed7FYVOZYIlxVF%2Bad%2BJg%3D" alt="" loading="lazy"/></p>
<p><em>建模质量与数量对比</em></p>
<p>两种方法的适用情况也不尽相同，<strong>直接法</strong>的重要性分数一般<strong>可以在训练后算出</strong>，<strong>剪枝法</strong>一般需要<strong>伴随一定量的训练步骤</strong>。如果是已经<strong>训练完的原始模型</strong>，最好<strong>使用直接法删除椭球</strong>，以降低可能的额外训练时间。</p>
<h2 data-id="heading-2">Mapmost 高斯泼溅建模平台</h2>
<p>结合学术界压缩方法，我们在<strong>Mapmost</strong>高斯泼溅建模平台综合并改进了一套模型轻量化算法，可以在保证细节的情况下，最高达到14倍的压缩比。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/575fa7c627cb42b690515176b758fa3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=ySxyKNanhhBtZu0IpesZoKjZmWs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91147a80edfe4057aeb3676223848cbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579214&amp;x-signature=Oj2U2W%2B7uYE6966JGocrZ6pUhdE%3D" alt="" loading="lazy"/></p>
<p>图中14倍压缩率情况下，模型体积从170MB降低至16MB，文字细节和屋顶轮廓仍然保持较高还原度。这样不仅减小了存储占用，同时也有利于建模和渲染性能的提升。</p>
<p><strong>Mapmost高斯泼溅建模平台</strong>正式开放体验！让专业级城市三维建模，从此没有门槛。上传航拍图，即可获得一个<strong>高精度、轻量化、即拿即用</strong>的3DGS模型。</p>
<p>登录<strong>Mapmost 3DGS Builder体验版</strong>(<a href="https://link.juejin.cn?target=studio.mapmost.com%2F3dgs" target="_blank" title="studio.mapmost.com/3dgs" ref="nofollow noopener noreferrer">studio.mapmost.com/3dgs</a>)，立即开始建模！</p>
<p>申请试用，请至<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mapmost.com%2F%23%2F" title="https://www.mapmost.com/#/" target="_blank" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArrayList 和 LinkedList 的区别？一篇讲透，从此开发和面试都不再纠结]]></title>    <link>https://juejin.cn/post/7588507284953415695</link>    <guid>https://juejin.cn/post/7588507284953415695</guid>    <pubDate>2025-12-29T02:16:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588507284953415695" data-draft-id="7579094978682617902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArrayList 和 LinkedList 的区别？一篇讲透，从此开发和面试都不再纠结"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-29T02:16:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArrayList 和 LinkedList 的区别？一篇讲透，从此开发和面试都不再纠结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:16:47.000Z" title="Mon Dec 29 2025 02:16:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常Java开发中，我们几乎每天都在使用List 。</p>
<p>而Java中最常用的两个列表实现就是 <code>ArrayList</code> 和 <code>LinkedList</code>。面试官也是，非常喜欢问它们有什么区别。</p>
<p>很多朋友会死记硬背：“<code>ArrayList</code> 查询快，增删慢； <code>LinkedList</code> 查询慢，增删快。”</p>
<p>但你知道为什么吗？今天我们来深入的了解一下。</p>
<hr/>
<h2 data-id="heading-0">一、举个例子</h2>
<p>你有一排书架：</p>
<h4 data-id="heading-1">ArrayList 就像一整排连续的书柜</h4>
<p>所有书按顺序紧挨着放，编号 0、1、2……你想拿第5本书时，直接走过去拿就行，非常快！</p>
<h4 data-id="heading-2">LinkedList 就像用绳子串连起来的一堆独立小盒子</h4>
<p>每个盒子里除了书，还写着前一个盒子在哪和后一个盒子在哪。你想拿第5本书时，得从第一个盒子开始，一个一个顺着绳子找过去。</p>
<p>下面我们再从技术角度进行深入分析。</p>
<hr/>
<h2 data-id="heading-3">二、底层结构：数组 vs 链表</h2>
<h3 data-id="heading-4">ArrayList</h3>
<p><code>ArrayList</code> 底层是动态数组，元素在内存中是连续存放的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ArrayList简化版原理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayList</span> {
    <span class="hljs-keyword">private</span> Object[] elementData; <span class="hljs-comment">// 核心数组</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size; <span class="hljs-comment">// 当前元素个数</span>
    
    <span class="hljs-comment">// 添加元素时，如果数组满了会自动扩容</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Object element)</span> {
        <span class="hljs-keyword">if</span> (size == elementData.length) {
            <span class="hljs-comment">// 创建一个1.5倍大的新数组，然后拷贝数据</span>
            elementData = Arrays.copyOf(elementData, newCapacity);
        }
        elementData[size++] = element;
    }
}
</code></pre>
<p>特点：</p>
<ul>
<li>内存中连续存储，像一排整齐的座位</li>
<li>自动扩容，但扩容时需要拷贝所有数据</li>
<li>访问速度快，但插入删除可能较慢</li>
</ul>
<h3 data-id="heading-5">LinkedList</h3>
<p><code>LinkedList</code> 的底层是双向链表，元素在内存中是分散存放的，每个元素（节点）都记录着它前后邻居的“地址”。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LinkedList节点结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
    E item;        <span class="hljs-comment">// 当前节点数据</span>
    Node next;     <span class="hljs-comment">// 指向下一个节点</span>
    Node prev;     <span class="hljs-comment">// 指向上一个节点</span>
}

<span class="hljs-comment">// LinkedList简化版原理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedList</span> {
    <span class="hljs-keyword">private</span> Node first; <span class="hljs-comment">// 头节点</span>
    <span class="hljs-keyword">private</span> Node last;  <span class="hljs-comment">// 尾节点</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;
}
</code></pre>
<p>每个元素（节点）都保存着前后邻居的信息，就像每个人都知道自己前后是谁。</p>
<hr/>
<h2 data-id="heading-6">三、性能对比</h2>
<p>我们从三个最常用的操作来看：</p>
<h3 data-id="heading-7">1. 随机访问（比如 list.get(100)）</h3>
<h4 data-id="heading-8">ArrayList：O(1)</h4>
<p>直接跳到第 100 个位置，秒取！</p>
<h4 data-id="heading-9">LinkedList：O(n)</h4>
<p>得从头开始数 100 次才能拿到。</p>
<p><strong>结论</strong>：如果你经常通过下标取数据（比如 for 循环遍历），<code>ArrayList</code>要快得多！</p>
<hr/>
<h3 data-id="heading-10">2. 在末尾添加/删除（list.add(obj) 或 remove(last)）</h3>
<h4 data-id="heading-11">ArrayList：平均 O(1)</h4>
<p>正常情况直接加在最后；但如果空间满了，要扩容（复制整个数组），这时会慢一下（但平均下来还是很快）。</p>
<h4 data-id="heading-12">LinkedList：O(1)</h4>
<p>直接在尾巴上挂新节点，永远不慢。</p>
<p><strong>结论</strong>：两者在尾部操作都很快，但 <code>ArrayList</code> 还是占优势（因为内存连续，CPU缓存友好）。</p>
<hr/>
<h3 data-id="heading-13">3. 在中间或开头插入/删除（比如 list.add(0, obj)）</h3>
<h4 data-id="heading-14">ArrayList：O(n)</h4>
<p>插入第 0 位？后面所有元素都要往后挪一位！删也一样，前面空了，后面的要往前挤。</p>
<h4 data-id="heading-15">LinkedList：理论上 O(1)，但实际常是 O(n)</h4>
<p>虽然插入本身只要改指针，但你要先找到第 0 个节点啊！找的过程就要从头遍历，所以整体还是 O(n)。</p>
<p><strong>重要提醒</strong>：
很多人以为 LinkedList 在中间插入更快，其实只有当你已经有那个位置的引用时才快（比如用 Iterator 遍历时删除）。</p>
<p>如果只是用 <code>list.add(500, obj)</code>，它照样要先找第 500 个节点，速度并不比 ArrayList 快！</p>
<hr/>
<h2 data-id="heading-16">四、内存占用</h2>
<h4 data-id="heading-17">ArrayList</h4>
<p>只存数据和一点预留空间（比如容量 10，只用了 6，那有 4 个空位）。</p>
<h4 data-id="heading-18">LinkedList</h4>
<p>每个元素都要额外存两个指针（指向前一个和后一个节点），<strong>内存开销大很多</strong>！</p>
<p>举个例子：存1000个 <code>Integer</code> 对象：</p>
<ul>
<li><code>ArrayList</code>：约4KB（假设每个 int 4 字节）</li>
<li><code>LinkedList</code>：约4KB（数据）+ 8KB（指针，每个指针 8 字节 × 2 × 1000）= <strong>12KB+</strong></li>
</ul>
<p><strong>结论</strong>：<strong>ArrayList 更省内存</strong>，尤其存大量小对象时优势更加明显。</p>
<hr/>
<h2 data-id="heading-19">五、其他细节补充</h2>
<h3 data-id="heading-20">是否支持“快速随机访问”？</h3>
<ul>
<li><code>ArrayList</code> 实现了 <code>RandomAccess</code> 接口（这是一个标记接口，告诉程序员：“我支持快速随机访问”）。</li>
<li><code>LinkedList</code> 没有实现它。</li>
</ul>
<p>有些工具类（如 <code>Collections.binarySearch</code>）会根据这个接口选择不同算法，进一步优化性能。</p>
<h3 data-id="heading-21">线程安全吗？</h3>
<p><strong>都不安全！</strong> 多线程环境下直接用会出问题。</p>
<p>如果需要线程安全，可以用：</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; safeList = Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());
</code></pre>
<p>或者用 <code>CopyOnWriteArrayList</code>（适合读多写少的场景）。</p>
<h3 data-id="heading-22">LinkedList 还能当队列用！</h3>
<p><code>LinkedList</code> 实现了 <code>Deque</code> 接口，可以当双端队列用：</p>
<pre><code class="hljs language-java" lang="java">LinkedList&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
queue.addFirst(<span class="hljs-string">"A"</span>);
queue.addLast(<span class="hljs-string">"B"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> queue.removeFirst(); <span class="hljs-comment">// A</span>
</code></pre>
<p>这时候它的链表结构就非常合适！</p>
<hr/>
<h2 data-id="heading-23">六、开发时该用哪个？</h2>



































<table><thead><tr><th>使用场景</th><th>推荐选择</th><th>原因</th></tr></thead><tbody><tr><td>经常通过下标访问（如 for 循环、get(i)）</td><td>ArrayList</td><td>随机访问快</td></tr><tr><td>主要在末尾增删（如日志记录、追加数据）</td><td>ArrayList</td><td>简单高效，缓存友好</td></tr><tr><td>需要频繁在<strong>已知位置</strong>插入/删除（如用 Iterator 遍历时删元素）</td><td>LinkedList</td><td>指针操作快</td></tr><tr><td>要实现队列、栈、双端队列</td><td>LinkedList</td><td>原生支持 addFirst/removeLast</td></tr><tr><td>内存紧张 or 存大量小对象</td><td>ArrayList</td><td>内存更紧凑</td></tr></tbody></table>
<p><strong>一般情况下，默认选 ArrayList 就对了！</strong></p>
<p>只有在明确需要链表特性（如双端操作）时，才考虑 LinkedList。</p>
<hr/>
<h2 data-id="heading-24">总结</h2>
<p><strong>ArrayList</strong> 底层是数组，内存连续，访问快（O(1)），中间增删慢（O(n)）。</p>
<p><strong>LinkedList</strong> 底层是链表，内存分散，访问慢（O(n)），头尾增删快（O(1)）。</p>
<p>日常开发中，优先选 <code>ArrayList</code> 准没错！</p>
<p>只有当你真的需要频繁在列表头尾增删、或者用它当队列/栈时，再考虑 <code>LinkedList</code>。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-25">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F184BGM_pdMFLc0ASrferwQ" target="_blank" title="https://mp.weixin.qq.com/s/184BGM_pdMFLc0ASrferwQ" ref="nofollow noopener noreferrer">《代码里全是 new 对象，真的很 Low 吗？我认真想了一晚》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX-MSa0CHwVW_qgPezbpMUA" target="_blank" title="https://mp.weixin.qq.com/s/X-MSa0CHwVW_qgPezbpMUA" ref="nofollow noopener noreferrer">《这 5 个冷门 HTML 标签，让我直接删了100 行 JS 代码》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FT3ronvigepWew6dRC4uH2g" target="_blank" title="https://mp.weixin.qq.com/s/T3ronvigepWew6dRC4uH2g" ref="nofollow noopener noreferrer">《Vue 组件通信的 8 种最佳实践，你知道几种？》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再卷 Python 了！Go + 字节 Eino 框架，才是后端人转 AI 的降维打击（附源码）]]></title>    <link>https://juejin.cn/post/7588300640600113158</link>    <guid>https://juejin.cn/post/7588300640600113158</guid>    <pubDate>2025-12-28T20:18:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640600113158" data-draft-id="7588411503121023012" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再卷 Python 了！Go + 字节 Eino 框架，才是后端人转 AI 的降维打击（附源码）"/> <meta itemprop="keywords" content="后端,Go,面试"/> <meta itemprop="datePublished" content="2025-12-28T20:18:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再卷 Python 了！Go + 字节 Eino 框架，才是后端人转 AI 的降维打击（附源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T20:18:19.000Z" title="Sun Dec 28 2025 20:18:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p><strong>摘要</strong>：2026 年，CRUD 工程师的生存空间被无限压缩，大厂面试全是 AI Agent、RAG、向量数据库。作为 Go/Java 开发者，真的要重头学 Python 吗？本文将通过一个<strong>已上线的企业级 AI 面试平台</strong>（基于字节跳动 Eino + Hertz + Milvus），带你从 0 到 1 拆解如何用 Go 语言构建高性能 AI 应用。</p>
</blockquote>
<h2 data-id="heading-0">一、 后端人的“中年危机”与 AI 破局</h2>
<p>兄弟们，见字如面，我是阳哥。</p>
<p>最近翻看 Boss 直聘和拉勾，大家有没有发现一个扎心的现象：<strong>纯后端开发的岗位越来越少了，要求越来越高了。</strong>
以前会写 CRUD、懂点 Redis/MySQL 就能拿高薪，现在 JD 里满屏都是：</p>
<ul>
<li>“熟悉 LLM 应用开发”</li>
<li>“有 LangChain/Agent 落地经验优先”</li>
<li>“熟悉 RAG 检索增强生成技术”</li>
</ul>
<p>很多兄弟私信我：“阳哥，我想转 AI，是不是得先把 Python 学一遍？我看网上教程都是 Python 的。”</p>
<p><strong>错！大错特错！</strong></p>
<p>在 <strong>模型训练（Training）</strong> 阶段，Python 确实是王者。但在  **应用落地 Serving **阶段，特别是企业级的高并发场景下，<strong>Go 语言的并发能力、类型安全和工程化优势，是 Python 无法比拟的。</strong></p>
<p>字节跳动最近开源的 <strong>Eino</strong> 框架，更是给 Go 开发者送来了一把“神兵利器”。它让我们可以像写微服务一样，用强类型、组件化的方式编排复杂的 AI Agent。</p>
<p>今天，我就通过我最近带队开发并上线的 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fmianshiba.dayu.club%2F" target="_blank" title="http://mianshiba.dayu.club/" ref="nofollow noopener noreferrer">【面试吧】（Interview Agent）</a></strong> 项目，手把手带你看看：<strong>一个真正的企业级 AI Agent 平台，到底是怎么长出来的。</strong></p>
<h2 data-id="heading-1"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2f0fb3927a74a4e8336a2d1fbecdf0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767557898&amp;x-signature=vXntnLPsjnBRd6JGF3ukMCVt6Wk%3D" alt="image.png" loading="lazy"/></h2>
<h2 data-id="heading-2">二、 为什么是 Go + Eino？</h2>
<p>在做这个项目之前，我也调研过 Python 的 LangChain。说实话，写 Demo 很爽，但一上生产环境就头大：</p>
<ul>
<li><strong>调试困难</strong>：动态类型一时爽，重构火葬场。</li>
<li><strong>并发拉胯</strong>：Python 的 GIL 锁懂的都懂，高并发下延迟感人。</li>
<li><strong>黑盒严重</strong>：很多逻辑被封装在库里，想改改不动。</li>
</ul>
<p>而 <strong>Eino</strong>（CloudWeGo 团队开源）完美解决了这些痛点：</p>
<ol>
<li><strong>强类型约束</strong>：编译期就能发现 80% 的错误，代码写起来心里有底。</li>
<li><strong>Graph 编排</strong>：用图（Graph）的结构来定义 Agent 的思考路径，逻辑清晰，比满屏的 <code>if-else</code> 优雅太多。</li>
<li><strong>完美融入 Go 生态</strong>：可以无缝结合 <strong>Hertz</strong>（高性能 Web 框架）和 <strong>Kitex</strong>（RPC 框架）。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0bf327293344f908a103bba5653e2f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767557898&amp;x-signature=AM3U0L6tsjQhgOMusos2lzkiE7Y%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">三、 硬核拆解：从架构到代码</h2>
<p><strong>【面试吧】</strong> 是一个模拟真实面试的 AI 平台。用户上传简历，AI 面试官（Go/Java/Redis 专项专家）会根据简历内容进行多轮提问，并生成评估报告。</p>
<p><strong>在线体验</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fmianshiba.dayu.club%2F" target="_blank" title="http://mianshiba.dayu.club/" ref="nofollow noopener noreferrer">mianshiba.dayu.club/</a></p>
<h3 data-id="heading-4">3.1 总体架构设计</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/183fffe2379f449e9cacc2c8201b1695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767557898&amp;x-signature=nTIT%2FTUb6Ghsl62L%2B0jpsZEvgWM%3D" alt="image.png" loading="lazy"/></p>
<p>我们没有搞简单的 API 套壳，而是按照<strong>大厂微服务标准</strong>设计的：</p>
<ul>
<li><strong>网关层</strong>：Hertz (HTTP)</li>
<li><strong>编排层</strong>：Eino (Agent Graph)</li>
<li><strong>模型层</strong>：接入 DeepSeek/OpenAI</li>
<li><strong>数据层</strong>：MySQL (业务数据) + Milvus (向量数据)</li>
<li><strong>中间件</strong>：Redis Queue (异步削峰)</li>
</ul>
<h3 data-id="heading-5">3.2 核心代码 Show Case</h3>
<p><strong>场景一：定义一个“会思考”的 Agent</strong></p>
<p>在 Eino 中，我们不再写死对话逻辑，而是定义一个 <strong>Agent</strong>。看这段代码，我们如何创建一个 <strong>Go 语言专项面试官</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2721bbe9304d07be9a9bb48ece2099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767557898&amp;x-signature=163%2FVEzidsWqWKxD1vxUeekQD0I%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/chatApp/agent/interview/specialized/go_agent.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGoSpecializedAgent</span><span class="hljs-params">(userId <span class="hljs-type">uint</span>, needResumeTool <span class="hljs-type">bool</span>)</span></span> (adk.Agent, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 准备工具箱（Tool Use）</span>
    <span class="hljs-comment">// 如果需要分析简历，就挂载简历分析工具</span>
    <span class="hljs-keyword">var</span> toolsConfig adk.ToolsConfig
    <span class="hljs-keyword">if</span> needResumeTool {
        toolsConfig = adk.ToolsConfig{
            ToolsNodeConfig: compose.ToolsNodeConfig{
                Tools: []componenttool.BaseTool{
                    tool2.GetResumeInfoTool(), <span class="hljs-comment">// 自定义工具：从 PDF 解析简历</span>
                },
            },
        }
    }

    <span class="hljs-comment">// 2. 创建 Agent</span>
    <span class="hljs-comment">// 使用 ReAct 范式：Reasoning + Acting</span>
    baseAgent, err := adk.NewChatModelAgent(ctx, &amp;adk.ChatModelAgentConfig{
        Name:        <span class="hljs-string">"GoSpecializedAgent"</span>,
        Description: <span class="hljs-string">"Go 专项面试官，专注于评估 GMP 模型、GC 机制等深度知识"</span>,
        Instruction: GoSpecializedAgentInstruction, <span class="hljs-comment">// 深度调优的 System Prompt</span>
        Model:       model, <span class="hljs-comment">// 底层大模型</span>
        ToolsConfig: toolsConfig,
        MaxIterations: <span class="hljs-number">15</span>, <span class="hljs-comment">// 最大思考轮数，防止死循环</span>
    })
    <span class="hljs-keyword">return</span> baseAgent, <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>亮点</strong>：通过 <code>ToolsConfig</code>，我们让 Agent 拥有了“手”和“眼”，它不再只是瞎聊，而是会先去查简历，再针对性提问。</p>
<p><strong>场景二：RAG 混合检索（解决幻觉）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9364ec9789741a886fca53095ec7600~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767557898&amp;x-signature=qG4sBi0V6Tx2E5A9QfgprdaQ8bw%3D" alt="image.png" loading="lazy"/></p>
<p>为了让 AI 面试官有“标准答案”，我们引入了 <strong>Milvus</strong> 做知识库。这里我们实现了一个<strong>混合检索</strong>逻辑：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/internal/eino/milvus/retrieval/retriever.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *RetrieverService)</span></span> RetrieveWithOptions(ctx context.Context, query <span class="hljs-type">string</span>, opts *RetrieveOptions) ([]*schema.Document, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 构建标量过滤表达式（Filter）</span>
    <span class="hljs-comment">// 比如：只检索“Go语言”分类下，“难度系数 &gt; 3”的题目</span>
    expr := BuildFilterExpr(opts)
    
    <span class="hljs-comment">// 2. 调用 Milvus 进行向量相似度搜索</span>
    <span class="hljs-comment">// Eino 的接口设计非常规范，直接对齐大厂标准</span>
    <span class="hljs-keyword">if</span> expr != <span class="hljs-string">""</span> {
        <span class="hljs-keyword">return</span> SearchWithExpr(ctx, s.client, s.config, query, expr, opts)
    }
    
    <span class="hljs-comment">// ... 默认检索逻辑</span>
}
</code></pre>
<p><strong>亮点</strong>：真正的企业级 RAG，绝不是简单的向量搜索。必须结合<strong>标量过滤（Scalar Filtering）</strong>，才能精准命中业务数据。</p>
<p><strong>场景三：异步削峰与流式响应</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d543b01f063c4e079eaf4efe6d7f2b05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767557898&amp;x-signature=p%2FN%2Fi2uV5Oz67boU%2FACLsBdq3zw%3D" alt="image.png" loading="lazy"/></p>
<p>AI 推理是很慢的（可能几秒到几十秒）。如果在主线程同步等待，Hertz 服务早被拖垮了。
我们设计了一套 <strong>Redis 队列 + SSE</strong> 机制：</p>
<ol>
<li>用户发请求 -&gt; 写入 Redis 队列 -&gt; 立刻返回 <code>task_id</code>。</li>
<li>后台 Consumer 轮询队列 -&gt; 调用 Eino Agent 执行推理。</li>
<li>前端通过 SSE (Server-Sent Events) 长连接监听 <code>task_id</code>，实现打字机效果。</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// backend/internal/mq/redis_queue.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *RedisQueue)</span></span> Publish(ctx context.Context, topic <span class="hljs-type">string</span>, message []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 使用 LPUSH 写入任务</span>
    <span class="hljs-keyword">return</span> q.client.LPush(ctx, topic, message).Err()
}

<span class="hljs-comment">// Consumer 端</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Consumer)</span></span> Start() {
    <span class="hljs-keyword">for</span> {
        <span class="hljs-comment">// 使用 BRPOP 阻塞式读取，避免空轮询浪费 CPU</span>
        result, err := c.client.BRPop(ctx, <span class="hljs-number">0</span>, c.topic).Result()
        <span class="hljs-comment">// ... 处理 AI 任务</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-6">四、 实战复盘：我踩过的那些坑</h2>
<p>做 Demo 容易，上生产难。在这个项目开发过程中，我也踩了不少坑，分享给大家：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a09e3de1d22449292cc8b202f6b2556~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767557898&amp;x-signature=Tl0VeGfXSEEmC9B6tjzD4tro7U0%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li><strong>Token 爆炸</strong>：最开始没做上下文截断，聊了十几轮后，Token 消耗指数级上升，接口直接报错。后来引入了<strong>滑动窗口</strong>机制，只保留最近 N 轮的核心对话。</li>
<li><strong>Prompt 调优</strong>：一开始 AI 总是“老好人”，面试不敢追问。后来我们引入了 <strong>CoT（思维链）</strong>，在 Prompt 里强制要求它“必须针对候选人的回答中的漏洞进行追问”，效果瞬间提升。</li>
<li><strong>PDF 解析乱码</strong>：很多简历格式奇葩。最后我们对比了多种 OCR 方案，选定了一套基于规则+模型的混合解析方案，准确率提升到 95% 以上。</li>
</ol>
<hr/>
<h2 data-id="heading-7">五、 写在最后</h2>
<p>技术在变，但工程化的本质不变。
<strong>AI 时代，Go 开发者依然大有可为。</strong></p>
<p>如果你也想从 CRUD 转型 AI 全栈，如果你也想拥有一套<strong>能写进简历、能抗住面试官深挖</strong>的商业级 AI 项目代码，欢迎一起交流。</p>
<p>这个项目的<strong>完整源代码（Go/Next.js/Docker）</strong>、<strong>20+小时的视频讲解</strong>以及<strong>详细的开发文档</strong>，我已经全部整理好了。</p>
<p>👉 <strong>获取方式：</strong>
关注公众号【<strong>王中阳</strong>】，回复“<strong>面试吧</strong>”，即可获取项目演示和源码线索。
或者直接绿泡泡私信我，备注“<strong>掘金</strong>”，拉你进技术交流群。</p>
<p><strong>2026，别焦虑，搞技术，搞落地！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【实践】2025年线上问题解决与总结-1]]></title>    <link>https://juejin.cn/post/7588456115882639395</link>    <guid>https://juejin.cn/post/7588456115882639395</guid>    <pubDate>2025-12-29T01:07:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588456115882639395" data-draft-id="7588093282530443316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【实践】2025年线上问题解决与总结-1"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-29T01:07:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lumen_于"/> <meta itemprop="url" content="https://juejin.cn/user/2744837165290328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【实践】2025年线上问题解决与总结-1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2744837165290328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lumen_于
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:07:32.000Z" title="Mon Dec 29 2025 01:07:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近我跳槽了，虽然我进了新公司，从原先公司（滨江某安防公司）离职了，但是我个人认为还是要好好的对之前的工作做一个总结，以避免自己在未来再犯同样的错误，以下是我整理的几个在线上的时候遇到的问题与解决，包含背景、分析、解决、规避方案等方面。</p>
<p>很多时候，那种可以预见到的问题，最好不要犯两次，一个可以预见的问题犯两次，可能领导不会说，但是实际上第二次就属于低级错误了，避免的方式就是第一次排查的时候就发现根因问题，并通过提升能力，固化流程等方式解决。这些是我遇到的问题以及解决思路，如果有更好的欢迎讨论，不吝赐教。</p>
<p>第一部分主要用于展示云存储业务产生的线上问题以及解决</p>
<h2 data-id="heading-0">1、云存储业务经常出现拒绝策略问题</h2>
<h3 data-id="heading-1"><strong>背景</strong></h3>
<p>如图所示，我们这边会有云存储（cloud storage）业务，设备会把资源上报到上报到存储桶里，我们这边也会有对应的微服务队设备的云存储功能进行编排，以下是这个系统大概的一个流程。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
flowchart TD

A[开始] --&gt; B[设备购买套餐]

B --&gt; C[套餐上线]

C --&gt; D[套餐开通]

D --&gt; E{开通方式}

E --&gt;|立即开通| F[下发token给设备]

E --&gt;|定时开通| G[等待定时任务执行]

F --&gt; H[设备使用token上传数据]

G --&gt; F

H --&gt; I{使用状态}

I --&gt;|正常使用| H

J[定时检查任务] --&gt; K{检查条件}

K --&gt;|需要续费| L[自动续费套餐]

K --&gt;|需要关闭| M[关闭套餐]

K --&gt;|正常| J

K --&gt;|token过期| N[更新设备token]

L --&gt; H

N --&gt; H

M --&gt; O[套餐关闭]

O --&gt; Q[结束]

R[套餐转移] --&gt; S[更换设备绑定]

S --&gt; F

</code></pre>
<p>可以看到，只有几块流程需要对通过线程池进行操作：比如对设备云存储套餐进行续费、关闭、开通、下发token（因和网页cookie一样，过期即失效，所以需要定时下发），但是随着业务量的增加，线程池经常触发拒绝策略</p>
<p>虽然拒绝策略是CallersRunPolicy，但是对于运维，系统稳定性是一个痛点（当然如果任务量超过线程池量，我们的池化策略会失效，同时业务稳定性肯定有影响）</p>
<p>同时如果更新线程池参数，但是因为没有对应API更新线程池参数，导致还需要重启服务才能生效，不合理</p>
<p>调试验证的周期延长了，因为修改文件，重启服务都是线上操作，需要走流程</p>
<h3 data-id="heading-2"><strong>根因分析</strong></h3>
<p>目前缺少一个合适的方式对线程池进行监控，运维，编排，并且这个也是其他的组会遇到的问题，其他的组没有对应的解决方案，我这边便通过引入动态线程池（Dynamic-TP）解决了这个问题。对应的一些文章为已经写过了，我把文章内容在这里</p>
<p><a href="https://juejin.cn/post/7406150677234221075" target="_blank" title="https://juejin.cn/post/7406150677234221075">动态线程池引入</a></p>
<p><a href="https://juejin.cn/post/7432366364369322024" target="_blank" title="https://juejin.cn/post/7432366364369322024">动态线程池源码</a></p>
<p><a href="https://juejin.cn/post/7455149236309557248" target="_blank" title="https://juejin.cn/post/7455149236309557248">动态线程池调参</a></p>
<h3 data-id="heading-3"><strong>后续维护</strong></h3>
<p>生成动态线程池Util包进行接入使用</p>
<p>对于重要业务进行线程池更新，对于其他新增非网关类pod也使用线程池，也通过私有仓库的二开dynamic-tp动态线程池包进行开发</p>
<h2 data-id="heading-4">2、云存储业务线程池资源一直增加问题</h2>
<h3 data-id="heading-5">背景</h3>
<p>在接入动态线程池动之后，我们后续的业务也遇到了问题，线上其中一个环境中。</p>
<ol>
<li>
<p>当前的线程池告警持续触发拒绝策略（调度线程处理任务），增加资源量快于业务增长量，导致运维要求我们进行排查</p>
</li>
<li>
<p>线程池资源告警则增加资源，环境中云存储微服务已经增加到了6台，但是仍然线程的队列容量稳步上升，增加资源并不能解决问题</p>
</li>
<li>
<p>因为任务队列容量较多，导致大量云存储设备下发云存储都是在初始化的5-6h以后了，涉及设备面广，影响较大</p>
</li>
</ol>
<h3 data-id="heading-6">根因分析</h3>
<ol>
<li>
<p>使用 jstack 1查看当前的线程池开头的线程状态与堆栈</p>
</li>
<li>
<p>发现初始化任务的线程池的线程状态都是WATING状态，这个是Java线程主动挂起等待的状态。</p>
</li>
</ol>
<p>查看堆栈，都是在等待Redisson的锁释放</p>
<ol start="3">
<li>
<p>查看了下对应线程池设计的流程，发现在下发license时确实会通过lock方法加锁</p>
</li>
<li>
<p>查看 云存储的 日志，发现同一台设备在日志中频繁向设备下发初始化，10s一次，正常流程应当至少2min才初始化下发一次</p>
</li>
</ol>
<p>所以我怀疑是代码问题+设备问题，导致的线程池资源占用。具体的问题原因可能如下</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
flowchart TD

A[设备频繁重复注册] --&gt; B[注册网关发送大量初始化请求]

B --&gt; C[线程池接收请求&lt;br&gt;创建多个同一设备的初始化线程]

C --&gt; D[redisson源码层面可能的真实锁是 各线程尝试获取分布式锁&lt;br&gt;锁KEY: device_&lt;设备ID&gt;_init_lock]

D --&gt; E{是否获取到锁?}

E --&gt;|否| F[线程等待锁释放]

E --&gt;|是| G[执行设备初始化流程]

G --&gt; H[初始化完成&lt;br&gt;释放分布式锁]

subgraph 问题发生场景

I[服务重启开始] --&gt; J[线程池开始关闭&lt;br&gt;状态: SHUTDOWN]

J --&gt; K[线程池关闭过程中&lt;br&gt;最后一个设备初始化线程释放锁]

K --&gt; L[同一设备的另一个等待线程&lt;br&gt;获取到分布式锁]

L --&gt; M[线程池状态变为TERMINATED&lt;br&gt;获取锁的线程被销毁]

M --&gt; N[分布式锁被永久占用&lt;br&gt;持有者: 已销毁的线程]

end

subgraph 重启后问题

O[新服务实例启动] --&gt; P[收到同一设备的初始化请求]

P --&gt; Q[尝试获取分布式锁]

Q --&gt; R{锁状态检查}

R --&gt;|锁仍被旧线程持有&lt;br&gt;但线程已不存在| S[锁无法释放&lt;br&gt;永久阻塞]

R --&gt;|正常情况| T[获取锁成功]

S --&gt; U[线程池资源被持续占用&lt;br&gt;可能导致线程耗尽]

end

subgraph 根本原因分析

V[Redisson锁机制] --&gt; W[锁标识: 客户端ID + 线程ID]

W --&gt; X[服务重启后&lt;br&gt;客户端ID相同]

X --&gt; Y[但持有锁的线程已不存在&lt;br&gt;且无法自动释放]

end

H --&gt; I

M --&gt; O

S --&gt; U

Y --&gt; N

</code></pre>
<p>除了使用lock方式永久等待，redisson看门狗给错误的key进行续期也是个问题。</p>
<h3 data-id="heading-7">解决方式</h3>
<ol>
<li>
<p>不能使用lock方法而是tryLock，等待一段时间后释放掉锁；一般会有重试机制，redisson锁一般是800ms以内，足够调用侧接收到异常并重试了</p>
</li>
<li>
<p>删除对应占用资源的redisson锁</p>
</li>
<li>
<p>排查redisson锁机制，避免出现重启仍然续期的问题。</p>
</li>
</ol>
<h2 data-id="heading-8">3、分库分表定时任务OOM问题</h2>
<h3 data-id="heading-9">背景</h3>
<p>还是云存储，某个环境中云存储服务一直不健康；原因是pod.yml中没有配置liveness，导致服务没有被容器重启；</p>
<p>随后查看日志发现服务触发了OOM异常。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81ef31afe8a946708db662f313c7ecce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVtZW5f5LqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767577301&amp;x-signature=UJ9SHjOz6y7Eo2TfMNDV%2BKYiGl4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">根因分析</h3>
<p>使用jmap命令（jmap -dump:format=b,file=heapdump.hprof 1）打印出服务的内存dump文件；</p>
<p>使用MemoryAnalyzer分析dump文件；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9de1461896c34ca38ceda24ed6ffcb8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVtZW5f5LqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767577301&amp;x-signature=jLviCW7LUupt3GyB4MuLZA3zZQM%3D" alt="img" loading="lazy"/></p>
<p>发现大对象是ShardingSphereDataSource，查看这个对象的外引用发现是数据库表实例；<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18b46fd380744da7ba3df2afc736be78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVtZW5f5LqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767577301&amp;x-signature=CSE%2FeEnl8fr3Ro%2F68yh7nWivElY%3D" alt="img" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/744bfaea405e4be08b1faf7810a9b634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVtZW5f5LqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767577301&amp;x-signature=JZsxamQ6qA1F7fJerjvv9Wf5cEk%3D" alt="img" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/021045d55b544fec856796024cb0306f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVtZW5f5LqO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767577301&amp;x-signature=nHui5QQP4yzJpVIVRKiEmOpjj%2F0%3D" alt="img" loading="lazy"/></p>
<p>最终发现table元数据存在47256个结点；查看node中的value发现数据是表名，但是环境内的表最多存在5632张表，很明显47256是异常的；</p>
<p>应该是环境内每日清理过期表的任务执行失败或者没有执行导致的；</p>
<h3 data-id="heading-11">解决方案</h3>
<ol>
<li>定时任务删除失败，并且没有记录，导致后续定时任务删除时，一次性获取过多的shardingJDBC导致问题，失败的定时任务需要及时通知开发人员进行介入</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis配置解析模块详解]]></title>    <link>https://juejin.cn/post/7588464673285079067</link>    <guid>https://juejin.cn/post/7588464673285079067</guid>    <pubDate>2025-12-29T01:10:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588464673285079067" data-draft-id="7588487605247819785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis配置解析模块详解"/> <meta itemprop="keywords" content="MyBatis,Java"/> <meta itemprop="datePublished" content="2025-12-29T01:10:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis配置解析模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:10:18.000Z" title="Mon Dec 29 2025 01:10:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入剖析MyBatis的"大脑"——配置解析模块的工作原理</p>
</blockquote>
<h2 data-id="heading-0">一、MyBatis整体架构概览</h2>
<p>在深入配置解析模块之前，我们先来看MyBatis的整体架构。MyBatis作为一个优秀的持久层框架，采用了分层设计思想，将整个框架划分为多个功能模块，各司其职又协同工作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ca88b17afb74d6c97151a28242a7574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767575417&amp;x-signature=8TEqU1xP3PppkICQueU8H1Ol%2FdA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">核心模块划分</h2>
<p>MyBatis主要包含以下九大核心模块：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 配置解析模块负责解析mybatis-config.xml和Mapper XML文件，构建Configuration对象
<span class="hljs-bullet">2.</span> 反射模块提供强大的反射工具，支持属性复制、类型转换等功能
<span class="hljs-bullet">3.</span> 类型处理模块处理JDBC类型和Java类型之间的转换
<span class="hljs-bullet">4.</span> 日志模块适配多种日志框架
<span class="hljs-bullet">5.</span> 缓存模块提供一级缓存和二级缓存实现
<span class="hljs-bullet">6.</span> 事务管理模块管理数据库事务
<span class="hljs-bullet">7.</span> 数据源模块管理数据库连接池
<span class="hljs-bullet">8.</span> SQL执行模块执行SQL语句并映射结果
<span class="hljs-bullet">9.</span> 插件模块提供拦截器机制
</code></pre>
<h2 data-id="heading-2">配置解析模块的核心地位</h2>
<p>配置解析模块是MyBatis的"大脑"，负责将配置信息转换为内存中的Configuration对象。这个Configuration对象贯穿整个MyBatis的生命周期，是后续所有操作的基石。</p>
<h2 data-id="heading-3">二、mybatis-config.xml配置文件解析</h2>
<h2 data-id="heading-4">配置文件结构</h2>
<p>mybatis-config.xml是MyBatis的全局配置文件，采用XML格式，包含了数据库连接、事务管理、映射器等核心配置。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1de809919740409c868b9290b877b35d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767575417&amp;x-signature=opFDAjZ0KH52cNqH7eD91Lfs6A8%3D" alt="" loading="lazy"/></p>
<p><strong>一个典型的mybatis-config.xml配置文件包含以下元素：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Config 3.0//EN"</span>
    <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 属性配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"jdbc.properties"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- 全局设置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"lazyLoadingEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mapUnderscoreToCamelCase"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 类型别名 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">typeAlias</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">"User"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.domain.User"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 类型处理器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">typeHandlers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">typeHandler</span> <span class="hljs-attr">handler</span>=<span class="hljs-string">"com.example.handler.StringTypeHandler"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">typeHandlers</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 插件配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span> <span class="hljs-attr">interceptor</span>=<span class="hljs-string">"com.example.plugin.PageInterceptor"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 环境配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"development"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"development"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"JDBC"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"POOLED"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${driver}"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${url}"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${username}"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${password}"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 数据库厂商标识 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">databaseIdProvider</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"DB_VENDOR"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"MySQL"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"mysql"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Oracle"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"oracle"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"PostgreSQL"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"postgresql"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">databaseIdProvider</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 映射器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"mapper/UserMapper.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-5">配置解析核心类</h2>
<p>配置解析的核心类是 XMLConfigBuilder，它继承自 BaseBuilder，专门负责解析mybatis-config.xml文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/531d791ac38f48aaaf64368ef0d5f599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767575417&amp;x-signature=VzE5Ww7JBf%2FIO3F1eWqx%2BqD4ABU%3D" alt="" loading="lazy"/></p>
<p><strong>XMLConfigBuilder的主要职责：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">1.解析配置文件
<span class="hljs-bullet"> -</span> 读取XML文件并解析为Document对象
2.构建Configuration对象
<span class="hljs-bullet"> -</span> 将XML配置转换为Configuration对象
3.管理解析状态
<span class="hljs-bullet"> -</span> 跟踪解析过程中的状态信息
4.处理异常
<span class="hljs-bullet"> -</span> 处理配置错误并提供友好的错误信息
</code></pre>
<h2 data-id="heading-6">配置解析核心方法</h2>
<p>XMLConfigBuilder 的核心方法是 parse() 方法：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> Configuration <span class="hljs-title">parse</span>()</span> {
    <span class="hljs-keyword">if</span> (parsed) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(
            <span class="hljs-string">"Each XMLConfigBuilder can only be used once."</span>);
    }
    parsed = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 解析configuration节点</span>
    parseConfiguration(parser.evalNode(<span class="hljs-string">"/configuration"</span>));
    <span class="hljs-keyword">return</span> configuration;
}
</code></pre>
<p>parseConfiguration() 方法会依次解析各个配置节点：</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">parseConfiguration</span>(XNode root) {
    try {
        <span class="hljs-comment">// 1. 解析properties节点</span>
        <span class="hljs-built_in">propertiesElement</span>(root.evalNode("properties"));
        <span class="hljs-comment">// 2. 解析settings节点</span>
        Properties settings = <span class="hljs-built_in">settingsAsProperties</span>(
            root.evalNode("settings"));
        <span class="hljs-built_in">loadCustomVfs</span>(settings);
        <span class="hljs-built_in">loadCustomLogImpl</span>(settings);
        <span class="hljs-comment">// 3. 解析typeAliases节点</span>
        <span class="hljs-built_in">typeAliasesElement</span>(root.evalNode("typeAliases"));
        <span class="hljs-comment">// 4. 解析plugins节点</span>
        <span class="hljs-built_in">pluginElement</span>(root.evalNode("plugins"));
        <span class="hljs-comment">// 5. 解析objectFactory节点</span>
        <span class="hljs-built_in">objectFactoryElement</span>(root.evalNode("objectFactory"));
        <span class="hljs-comment">// 6. 解析objectWrapperFactory节点</span>
        <span class="hljs-built_in">objectWrapperFactoryElement</span>(
            root.evalNode("objectWrapperFactory"));
        <span class="hljs-comment">// 7. 解析reflectorFactory节点</span>
        <span class="hljs-built_in">reflectorFactoryElement</span>(
            root.evalNode("reflectorFactory"));
        <span class="hljs-comment">// 8. 应用settings配置</span>
        <span class="hljs-built_in">settingsElement</span>(settings);
        <span class="hljs-comment">// 9. 解析environments节点</span>
        <span class="hljs-built_in">environmentsElement</span>(root.evalNode("environments"));
        <span class="hljs-comment">// 10. 解析databaseIdProvider节点</span>
        <span class="hljs-built_in">databaseIdProviderElement</span>(
            root.evalNode("databaseIdProvider"));
        <span class="hljs-comment">// 11. 解析typeHandlers节点</span>
        <span class="hljs-built_in">typeHandlerElement</span>(root.evalNode("typeHandlers"));
        <span class="hljs-comment">// 12. 解析mappers节点</span>
        <span class="hljs-built_in">mapperElement</span>(root.evalNode("mappers"));
    } catch (Exception e) {
        throw new <span class="hljs-built_in">BuilderException</span>(
            "Error parsing SQL Mapper Configuration. Cause: " + e, e);
    }
}
</code></pre>
<h2 data-id="heading-7">关键配置节点解析</h2>
<h2 data-id="heading-8">1️⃣ properties节点解析</h2>
<p>properties节点用于引入外部属性文件，可以采用resource或url方式加载：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">propertiesElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 读取子节点配置的属性</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">defaults</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();

        <span class="hljs-comment">// 读取resource或url指定的属性文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">"resource"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">"url"</span>);
        <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span> &amp;&amp; url != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(
                <span class="hljs-string">"The properties element cannot specify both "</span> +
                <span class="hljs-string">"a URL and a resource based property file reference."</span>);
        }
        <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) {
            defaults.putAll(
                Resources.getResourceAsProperties(resource));
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url != <span class="hljs-literal">null</span>) {
            defaults.putAll(
                Resources.getUrlAsProperties(url));
        }
        <span class="hljs-comment">// 合并配置</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">vars</span> <span class="hljs-operator">=</span> configuration.getVariables();
        <span class="hljs-keyword">if</span> (vars != <span class="hljs-literal">null</span>) {
            defaults.putAll(vars);
        }
        parser.setVariables(defaults);
        configuration.setVariables(defaults);
    }
}
</code></pre>
<h2 data-id="heading-9">2️⃣ settings节点解析</h2>
<p>settings节点包含MyBatis的全局配置选项，这些配置会影响MyBatis的运行时行为：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title class_">Properties</span> <span class="hljs-title function_">settingsAsProperties</span>(<span class="hljs-params">XNode context</span>) {
    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
    }
    <span class="hljs-title class_">Properties</span> props = context.<span class="hljs-title function_">getChildrenAsProperties</span>();

    <span class="hljs-comment">// 验证配置项是否合法</span>
    <span class="hljs-title class_">MetaClass</span> metaConfig = <span class="hljs-title class_">MetaClass</span>.<span class="hljs-title function_">forClass</span>(
        <span class="hljs-title class_">Configuration</span>.<span class="hljs-property">class</span>, localReflectorFactory);

    <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Object</span> key : props.<span class="hljs-title function_">keySet</span>()) {
        <span class="hljs-title class_">String</span> name = (<span class="hljs-title class_">String</span>) key;
        <span class="hljs-keyword">if</span> (!metaConfig.<span class="hljs-title function_">hasSetter</span>(name)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(
                <span class="hljs-string">"The setting "</span> + name + <span class="hljs-string">" is not known. "</span> +
                <span class="hljs-string">"Make sure you spelled it correctly (case sensitive)."</span>);
        }
    }
    <span class="hljs-keyword">return</span> props;
}
</code></pre>
<h2 data-id="heading-10">3️⃣ typeAliases节点解析</h2>
<p>类型别名是为了简化Java类型的引用，MyBatis提供了两种配置方式：</p>
<p><strong>方式一：为单个类配置别名</strong></p>
<pre><code class="hljs language-bash" lang="bash">&lt;typeAlias <span class="hljs-built_in">alias</span>=<span class="hljs-string">"User"</span> <span class="hljs-built_in">type</span>=<span class="hljs-string">"com.example.domain.User"</span>/&gt;
</code></pre>
<p><strong>方式二：批量配置别名</strong></p>
<pre><code class="hljs language-ini" lang="ini">&lt;package <span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.domain"</span>/&gt;
</code></pre>
<p>解析代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">typeAliasesElement</span>(<span class="hljs-params">XNode parent</span>) {
    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">XNode</span> child : parent.<span class="hljs-title function_">getChildren</span>()) {
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"package"</span>.<span class="hljs-title function_">equals</span>(child.<span class="hljs-title function_">getName</span>())) {
                <span class="hljs-comment">// 批量注册别名</span>
                <span class="hljs-title class_">String</span> typeAliasPackage = 
                    child.<span class="hljs-title function_">getStringAttribute</span>(<span class="hljs-string">"name"</span>);
                configuration.<span class="hljs-title function_">getTypeAliasRegistry</span>()
                    .<span class="hljs-title function_">registerAliases</span>(typeAliasPackage);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 单个注册别名</span>
                <span class="hljs-title class_">String</span> alias = child.<span class="hljs-title function_">getStringAttribute</span>(<span class="hljs-string">"alias"</span>);
                <span class="hljs-title class_">String</span> <span class="hljs-keyword">type</span> = child.<span class="hljs-title function_">getStringAttribute</span>(<span class="hljs-string">"type"</span>);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-title class_">Class</span>&lt;?&gt; clazz = <span class="hljs-title class_">Resources</span>.<span class="hljs-title function_">classForName</span>(<span class="hljs-keyword">type</span>);
                    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) {
                        typeAliasRegistry.<span class="hljs-title function_">registerAlias</span>(clazz);
                    } <span class="hljs-keyword">else</span> {
                        typeAliasRegistry.<span class="hljs-title function_">registerAlias</span>(alias, clazz);
                    }
                } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">ClassNotFoundException</span> e) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(
                        <span class="hljs-string">"Error registering typeAlias for '"</span> + 
                        alias + <span class="hljs-string">"'. Cause: "</span> + e, e);
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-11">4️⃣ environments节点解析</h2>
<p>environments节点用于配置数据库环境，可以配置多个environment，通过default属性指定默认环境：</p>
<pre><code class="hljs language-ini" lang="ini">private void environmentsElement(XNode context) throws Exception {
    if (<span class="hljs-attr">context</span> == null) {
        return<span class="hljs-comment">;</span>
    }
    if (<span class="hljs-attr">environment</span> == null) {
        <span class="hljs-attr">environment</span> = context.getStringAttribute(<span class="hljs-string">"default"</span>)<span class="hljs-comment">;</span>
    }
    for (XNode child : context.getChildren()) {
        String <span class="hljs-attr">id</span> = child.getStringAttribute(<span class="hljs-string">"id"</span>)<span class="hljs-comment">;</span>
        if (isSpecifiedEnvironment(id)) {
            // 解析事务管理器
            TransactionFactory <span class="hljs-attr">txFactory</span> = 
                transactionManagerElement(
                    child.evalNode("transactionManager"))<span class="hljs-comment">;</span>

            // 解析数据源
            DataSourceFactory <span class="hljs-attr">dsFactory</span> = 
                dataSourceElement(child.evalNode("dataSource"))<span class="hljs-comment">;</span>
            DataSource <span class="hljs-attr">dataSource</span> = dsFactory.getDataSource()<span class="hljs-comment">;</span>

            // 构建Environment对象
            Environment.Builder <span class="hljs-attr">environmentBuilder</span> = 
                new Environment.Builder(id)
                    .transactionFactory(txFactory)
                    .dataSource(dataSource)<span class="hljs-comment">;</span>
            configuration.setEnvironment(environmentBuilder.build())<span class="hljs-comment">;</span>
            break<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h2 data-id="heading-12">三、Mapper XML映射文件解析</h2>
<p>Mapper XML文件是MyBatis的核心，定义了SQL语句和映射规则。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/033b5c36aad44e5ea42e6d9c246f4db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767575417&amp;x-signature=F%2Bh%2F2stFch4o1OA8JgMD9aA4AA8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">Mapper文件结构</h2>
<p>一个典型的Mapper XML文件包含以下元素：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
    <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 缓存配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- 结果映射 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"User"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userName"</span> 
                <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"email"</span> 
                <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SQL片段 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span>&gt;</span>
        id, user_name, email
    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 查询语句 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        SELECT <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span>/&gt;</span>
        FROM t_user
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 插入语句 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"User"</span> 
            <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span>&gt;</span>
        INSERT INTO t_user (user_name, email)
        VALUES (#{userName}, #{email})
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 更新语句 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"update"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"User"</span>&gt;</span>
        UPDATE t_user
        SET user_name = #{userName},
            email = #{email}
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 删除语句 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteById"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"long"</span>&gt;</span>
        DELETE FROM t_user
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h2 data-id="heading-14">XMLMapperBuilder解析器</h2>
<p>XMLMapperBuilder 专门负责解析Mapper XML文件，它继承自 BaseBuilder：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XMLMapperBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseBuilder</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">XPathParser</span> parser;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MapperBuilderAssistant</span> builderAssistant;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">XNode</span>&gt; sqlFragments;
    public void parse() {
        <span class="hljs-comment">// 判断是否已加载</span>
        <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) {
            <span class="hljs-comment">// 解析mapper节点</span>
            configurationElement(parser.evalNode(<span class="hljs-string">"/mapper"</span>));

            <span class="hljs-comment">// 标记已加载</span>
            configuration.addLoadedResource(resource);

            <span class="hljs-comment">// 绑定命名空间</span>
            bindMapperForNamespace();
        }
        <span class="hljs-comment">// 处理未完成的缓存引用</span>
        parsePendingCacheRefs();

        <span class="hljs-comment">// 处理未完成的结果映射</span>
        parsePendingResultMaps();

        <span class="hljs-comment">// 处理未完成的语句</span>
        parsePendingStatements();
    }
}
</code></pre>
<h2 data-id="heading-15">核心解析方法</h2>
<p>configurationElement() 方法负责解析Mapper文件的所有子节点：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configurationElement</span>(<span class="hljs-params">XNode context</span>)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1. 解析namespace属性</span>
        String <span class="hljs-keyword">namespace</span> = context.getStringAttribute(<span class="hljs-string">"namespace"</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">namespace</span> == <span class="hljs-literal">null</span> || <span class="hljs-keyword">namespace</span>.<span class="hljs-keyword">equals</span>(<span class="hljs-string">""</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(
                <span class="hljs-string">"Mapper's namespace cannot be empty"</span>);
        }
        builderAssistant.setCurrentNamespace(<span class="hljs-keyword">namespace</span>);
        <span class="hljs-comment">// 2. 解析cache-ref节点</span>
        cacheRefElement(context.evalNodes(<span class="hljs-string">"mapper/cache-ref"</span>));
        <span class="hljs-comment">// 3. 解析cache节点</span>
        cacheElement(context.evalNodes(<span class="hljs-string">"mapper/cache"</span>));
        <span class="hljs-comment">// 4. 解析parameterMap节点（已废弃）</span>
        parameterMapElement(
            context.evalNodes(<span class="hljs-string">"/mapper/parameterMap"</span>));
        <span class="hljs-comment">// 5. 解析resultMap节点</span>
        resultMapElements(context.evalNodes(<span class="hljs-string">"/mapper/resultMap"</span>));
        <span class="hljs-comment">// 6. 解析sql节点</span>
        sqlElement(context.evalNodes(<span class="hljs-string">"/mapper/sql"</span>));
        <span class="hljs-comment">// 7. 解析select|insert|update|delete节点</span>
        buildStatementFromContext(
            context.evalNodes(<span class="hljs-string">"select|insert|update|delete"</span>));
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(
            <span class="hljs-string">"Error parsing Mapper XML. Cause: "</span> + e, e);
    }
}
</code></pre>
<h2 data-id="heading-16">SQL语句解析</h2>
<p>SQL语句的解析是Mapper解析的核心，包括select、insert、update、delete四种类型。</p>
<p><strong>XMLStatementBuilder 会解析SQL语句的各种属性和子节点，主要步骤包括：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 解析基本属性
   id、databaseId
   nodeName、sqlCommandType
<span class="hljs-bullet">2.</span> 解析配置属性
   flushCache、useCache
   resultOrdered
<span class="hljs-bullet">3.</span> 解析Include标签
   处理SQL片段引用
<span class="hljs-bullet">4.</span> 解析参数类型
   parameterType
   parameterTypeClass
<span class="hljs-bullet">5.</span> 解析语言驱动
   lang属性
   LanguageDriver
<span class="hljs-bullet">6.</span> 解析SQL源
  SqlSource创建
<span class="hljs-bullet">7.</span> 解析结果配置
  resultType、resultMap
  resultSets
<span class="hljs-bullet">8.</span> 解析主键生成
   keyProperty、keyColumn
   keyGenerator
<span class="hljs-bullet">9.</span> 构建MappedStatement
   将所有配置组装成MappedStatement对象
</code></pre>
<h2 data-id="heading-17">动态SQL解析</h2>
<p>MyBatis的动态SQL通过OGNL表达式实现，支持以下标签：</p>
<p><strong>条件判断</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span>&gt;</span>
 - 单条件判断
<span class="hljs-tag">&lt;<span class="hljs-name">choose</span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name">when</span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name">otherwise</span>&gt;</span>
 - 多条件分支
</code></pre>
<p><strong>字符串处理</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span>trim<span class="hljs-operator">&gt;</span>
 <span class="hljs-operator">-</span> 字符串裁剪
<span class="hljs-operator">&lt;</span><span class="hljs-keyword">where</span><span class="hljs-operator">&gt;</span>
 <span class="hljs-operator">-</span> <span class="hljs-keyword">WHERE</span>子句
<span class="hljs-operator">&lt;</span><span class="hljs-keyword">set</span><span class="hljs-operator">&gt;</span>
 <span class="hljs-operator">-</span> <span class="hljs-keyword">SET</span>子句
</code></pre>
<p><strong>循环遍历</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">&lt;<span class="hljs-keyword">foreach</span>&gt;
 集合遍历
</code></pre>
<p>动态SQL的解析由 XmlScriptBuilder 完成：</p>
<pre><code class="hljs language-ini" lang="ini">public SqlSource parseScriptNode() {
    // 解析SQL脚本
    MixedSqlNode <span class="hljs-attr">rootSqlNode</span> = parseDynamicTags(context)<span class="hljs-comment">;</span>
    SqlSource sqlSource<span class="hljs-comment">;</span>
    if (isDynamic) {
        <span class="hljs-attr">sqlSource</span> = new DynamicSqlSource(configuration, rootSqlNode)<span class="hljs-comment">;</span>
    } else {
        <span class="hljs-attr">sqlSource</span> = new RawSqlSource(
            configuration, rootSqlNode, parameterType)<span class="hljs-comment">;</span>
    }
    return sqlSource<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-18">四、注解配置解析</h2>
<p>除了XML配置，MyBatis还支持通过注解方式配置SQL语句。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6643b6090a64432eae5d759875824396~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767575417&amp;x-signature=65Ey6zIrWRLsf2B0HpwInYYTewM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-19">常用注解</h2>
<p><strong>MyBatis提供了以下常用注解：</strong></p>
<p><strong>基本SQL注解</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Select</span>
 - 查询语句
<span class="hljs-variable">@Insert</span>
 - 插入语句
<span class="hljs-variable">@Update</span>
 - 更新语句
<span class="hljs-variable">@Delete</span>
 - 删除语句
</code></pre>
<p><strong>动态SQL注解</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SelectProvider</span>
 - 动态查询
<span class="hljs-variable">@InsertProvider</span>
 - 动态插入
<span class="hljs-variable">@UpdateProvider</span>
 - 动态更新
<span class="hljs-variable">@DeleteProvider</span>
 - 动态删除
</code></pre>
<p><strong>结果映射注解</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Results</span>
 - 结果映射
<span class="hljs-variable">@Result</span>
 - 单个结果映射
<span class="hljs-variable">@ResultMap</span>
 - 引用结果映射
</code></pre>
<p><strong>其他注解</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@CacheNamespace</span>
 - 缓存配置
<span class="hljs-variable">@Options</span>
 - 选项配置
</code></pre>
<h2 data-id="heading-20">注解解析器</h2>
<p><strong>注解的解析由 MapperAnnotationBuilder 完成：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public class MapperAnnotationBuilder {
    private final Configuration configuration;
    private final MapperBuilderAssistant assistant;
    private final Class&lt;?&gt; type;
    public void <span class="hljs-built_in">parse</span>() {
        String resource = type<span class="hljs-selector-class">.toString</span>();
        if (!configuration.isResourceLoaded(resource)) {
            <span class="hljs-comment">// 解析XML资源</span>
            <span class="hljs-built_in">loadXmlResource</span>();

            <span class="hljs-comment">// 解析缓存注解</span>
            <span class="hljs-built_in">parseCache</span>();
            <span class="hljs-built_in">parseCacheRef</span>();
            <span class="hljs-comment">// 获取所有方法</span>
            Method<span class="hljs-selector-attr">[]</span> methods = type<span class="hljs-selector-class">.getMethods</span>();
            for (Method method : methods) {
                try {
                    if (!method.isBridge()) {
                        <span class="hljs-comment">// 解析SQL注解</span>
                        <span class="hljs-built_in">parseStatement</span>(method);
                    }
                } catch (IncompleteException e) {
                    configuration<span class="hljs-selector-class">.addIncompleteMethod</span>(
                        new MethodResolver(this, method));
                }
            }
        }
        configuration<span class="hljs-selector-class">.addLoadedResource</span>(resource);
    }
}
</code></pre>
<h2 data-id="heading-21">SQL注解解析</h2>
<p>parseStatement() 方法负责解析方法上的SQL注解，主要步骤包括：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">1.</span>获取参数类型
<span class="hljs-number">2.</span>解析<span class="hljs-keyword">SQL</span>注解
（<span class="hljs-variable">@Select</span><span class="hljs-operator">/</span><span class="hljs-variable">@Insert</span><span class="hljs-operator">/</span><span class="hljs-variable">@Update</span><span class="hljs-operator">/</span><span class="hljs-variable">@Delete</span>）
<span class="hljs-number">3.</span>解析<span class="hljs-variable">@Options</span>注解
<span class="hljs-number">4.</span>解析结果映射
（<span class="hljs-variable">@ResultMap</span><span class="hljs-operator">/</span><span class="hljs-variable">@Results</span>）
<span class="hljs-number">5.</span>构建MappedStatement对象
这个过程与XML解析类似，最终都会生成MappedStatement对象注册到Configuration中。
</code></pre>
<h2 data-id="heading-22">五、 Configuration对象构建</h2>
<p>Configuration对象是MyBatis配置解析的最终产物，包含了所有配置信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4ca722dbb5a47e3ba364e88fc02c3d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767575417&amp;x-signature=7anbWL1ognnbNOLrOTgrpMGxbic%3D" alt="" loading="lazy"/></p>
<p><strong>Configuration核心属性</strong></p>
<p><strong>Configuration类包含以下核心属性：</strong></p>
<p><strong>环境配置</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 环境</span>
<span class="hljs-keyword">protected</span> Environment environment;
</code></pre>
<p><strong>注册器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 注册的Mapper接口</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MapperRegistry</span> <span class="hljs-variable">mapperRegistry</span> <span class="hljs-operator">=</span> 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperRegistry</span>(<span class="hljs-built_in">this</span>);
<span class="hljs-comment">// 类型别名注册器</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TypeAliasRegistry</span> <span class="hljs-variable">typeAliasRegistry</span> <span class="hljs-operator">=</span> 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeAliasRegistry</span>();
<span class="hljs-comment">// 类型处理器注册器</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHandlerRegistry</span>();
</code></pre>
<p><strong>映射集合</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 结果映射集合</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;<span class="hljs-type">String</span>, ResultMap&gt; resultMaps = 
    <span class="hljs-keyword">new</span> StrictMap&lt;&gt;(<span class="hljs-string">"Result Maps collection"</span>);
<span class="hljs-comment">// 参数映射集合</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;<span class="hljs-type">String</span>, ParameterMap&gt; parameterMaps = 
    <span class="hljs-keyword">new</span> StrictMap&lt;&gt;(<span class="hljs-string">"Parameter Maps collection"</span>);
<span class="hljs-comment">// MappedStatement集合</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;<span class="hljs-type">String</span>, MappedStatement&gt; mappedStatements = 
    <span class="hljs-keyword">new</span> StrictMap&lt;&gt;(<span class="hljs-string">"Mapped Statements collection"</span>);
<span class="hljs-comment">// 缓存集合</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;<span class="hljs-type">String</span>, Cache&gt; caches = 
    <span class="hljs-keyword">new</span> StrictMap&lt;&gt;(<span class="hljs-string">"Caches collection"</span>);
</code></pre>
<p><strong>全局设置</strong></p>
<pre><code class="hljs language-ini" lang="ini">protected Integer defaultFetchSize<span class="hljs-comment">;</span>
protected Integer defaultStatementTimeout<span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">lazyLoadingEnabled</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">aggressiveLazyLoading</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">multipleResultSetsEnabled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">useColumnLabel</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">useGeneratedKeys</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">cacheEnabled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">callSettersOnNulls</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">useActualParamName</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">returnInstanceForEmptyRow</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
protected boolean <span class="hljs-attr">shrinkWhitespacesInSql</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-23">构建过程</h2>
<p><strong>Configuration对象的构建是一个逐步完善的过程：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">阶段一：初始化创建Configuration对象，注册内置的类型别名和类型处理器
阶段二：配置解析解析mybatis-config.xml，设置各种配置项
阶段三：Mapper解析解析Mapper XML文件和注解，构建MappedStatement对象
阶段四：完善处理缓存引用、结果映射等
</code></pre>
<h2 data-id="heading-24">Configuration的使用</h2>
<p><strong>Configuration对象主要用于：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">1.创建SqlSessionFactory
<span class="hljs-bullet"> -</span> 通过SqlSessionFactoryBuilder构建
2.获取MappedStatement
<span class="hljs-bullet"> -</span> 根据statementId查找对应的SQL配置
3.获取类型处理器
<span class="hljs-bullet"> -</span> 根据Java类型和JDBC类型查找对应的类型处理器
4.获取类型别名
<span class="hljs-bullet"> -</span> 根据别名查找对应的Java类型
5.获取结果映射
<span class="hljs-bullet"> -</span> 根据resultMapId查找对应的结果映射
</code></pre>
<h2 data-id="heading-25">六、 最佳实践</h2>
<h2 data-id="heading-26">配置文件组织</h2>
<p>建议按照以下方式组织配置文件：</p>
<pre><code class="hljs language-bash" lang="bash">src/main/resources/
├── mybatis-config.xml          <span class="hljs-comment"># 全局配置</span>
├── jdbc.properties              <span class="hljs-comment"># 数据库连接配置</span>
└── mapper/                      <span class="hljs-comment"># Mapper文件目录</span>
    ├── UserMapper.xml
    ├── OrderMapper.xml
    └── ProductMapper.xml
</code></pre>
<h2 data-id="heading-27">配置优化建议</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 合理使用别名为常用类配置别名，简化配置
<span class="hljs-bullet">2.</span> 启用缓存合理配置二级缓存，提高查询性能
<span class="hljs-bullet">3.</span> 懒加载根据业务需求配置懒加载策略
<span class="hljs-bullet">4.</span> 批量处理对于批量操作，使用ExecutorType.BATCH
</code></pre>
<h2 data-id="heading-28">常见问题</h2>
<pre><code class="hljs language-arduino" lang="arduino">❌ 配置文件找不到检查文件路径是否正确
❌ Mapper注册失败检查<span class="hljs-keyword">namespace</span>是否与接口全限定名一致
❌ 类型转换异常检查TypeHandler配置是否正确
❌ SQL解析错误检查XML语法和OGNL表达式
</code></pre>
<h2 data-id="heading-29">七、 总结</h2>
<p>MyBatis的配置解析模块是整个框架的基石，负责将各种形式的配置转换为内存中的Configuration对象。</p>
<p>通过解析mybatis-config.xml全局配置文件、Mapper XML映射文件和注解配置，构建出一个完整的配置对象，为后续的SQL执行提供基础。</p>
<p><strong>理解配置解析模块的工作原理，有助于我们：</strong></p>
<pre><code class="hljs">✅ 更好地使用MyBatis进行开发
✅ 快速定位配置问题
✅ 进行框架扩展和定制
✅ 优化应用性能
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[接口防抖实战：防重复提交的 5 种高级方案]]></title>    <link>https://juejin.cn/post/7588745319400734720</link>    <guid>https://juejin.cn/post/7588745319400734720</guid>    <pubDate>2025-12-29T01:47:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588745319400734720" data-draft-id="7588793670494208040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="接口防抖实战：防重复提交的 5 种高级方案"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-29T01:47:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            接口防抖实战：防重复提交的 5 种高级方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:47:24.000Z" title="Mon Dec 29 2025 01:47:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SpringBoot 接口防抖实战：防重复提交的 5 种高级方案</h2>
<p>作为一名摸爬滚打八年的 Java 开发，我敢说：<strong>线上 80% 的 “数据错乱” 故障，都和接口重复提交有关</strong>。上周大促，用户疯狂点击下单按钮，导致同一订单被创建了 3 次；去年支付接口被爬虫高频调用，直接产生了双倍扣款 —— 这些血淋淋的案例告诉我们：接口防抖不是 “可选功能”，而是 “必做防护”。</p>
<p>很多人觉得 “防重复提交不就是前端按钮禁用吗？”—— 太天真了！爬虫、Postman 直接调用、网络延迟重发，这些场景前端防护形同虚设。今天就从实战出发，分享 5 种 SpringBoot 接口防抖的高级方案，覆盖单机、分布式、高并发等所有场景，每一种都附可直接复制的代码和八年踩坑总结，让你彻底解决 “手抖党” 和 “恶意刷接口” 的烦恼。</p>
<h3 data-id="heading-1">一、先分清：防抖 vs 防重？别再混淆了！</h3>
<p>在讲方案前，先澄清两个高频混淆的概念（八年开发见过太多人用错）：</p>
<ul>
<li><strong>接口防抖（Debounce）</strong> ：阻止短时间内重复触发同一接口（比如 1 秒内点 5 次下单），核心是 “限制触发频率”；</li>
<li><strong>接口防重（Idempotent）</strong> ：保证同一请求多次执行结果一致（比如重复支付只扣一次钱），核心是 “结果唯一性”。</li>
</ul>
<p>本文的方案是 “防抖 + 防重” 结合 —— 既阻止高频重复调用，又保证即使调用多次也不会出问题，真正做到 “双重防护”。</p>
<h3 data-id="heading-2">二、5 种高级方案：从单机到分布式，覆盖所有场景</h3>
<h4 data-id="heading-3">方案 1：基于 Redis+Lua 脚本（分布式高并发首选）</h4>
<h5 data-id="heading-4">核心原理</h5>
<p>利用 Redis 的原子性 + Lua 脚本，给接口加 “限时锁”：同一请求标识（比如用户 ID + 接口名 + 参数摘要）在指定时间内只能执行一次，超过时间自动释放锁。</p>
<h5 data-id="heading-5">为什么用 Lua？</h5>
<p>Redis 单条命令是原子的，但多条命令组合（比如先查 key 是否存在，再 set 值）会有并发问题。Lua 脚本能把多步操作打包成原子执行，避免 “竞态条件”—— 这是分布式防重的关键（八年开发踩过的坑：以前用 Redis+Java 代码判断，高并发下还是会出现重复提交）。</p>
<h5 data-id="heading-6">实战代码</h5>
<ol>
<li>先定义防抖注解（标记需要防重的接口）</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.annotation.*;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AntiDuplicateSubmit {
    <span class="hljs-comment">// 防抖时间（默认1秒）</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;
    <span class="hljs-comment">// 时间单位（默认秒）</span>
    TimeUnit <span class="hljs-title function_">unit</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> TimeUnit.SECONDS;
    <span class="hljs-comment">// 提示信息</span>
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"操作过于频繁，请稍后再试！"</span>;
}
</code></pre>
<ol start="2">
<li>Lua 脚本（原子执行 “查锁 + 加锁”）在<code>resources/lua/anti_duplicate_submit.lua</code>创建脚本：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">-- 1. 接收参数：key=请求标识，<span class="hljs-built_in">timeout</span>=过期时间
<span class="hljs-built_in">local</span> key = KEYS[1]
<span class="hljs-built_in">local</span> <span class="hljs-built_in">timeout</span> = ARGV[1]

-- 2. 查锁：存在则返回1（重复提交），不存在则加锁返回0
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'EXISTS'</span>, key) == 1 <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">return</span> 1
<span class="hljs-keyword">else</span>
    redis.call(<span class="hljs-string">'SET'</span>, key, <span class="hljs-string">'1'</span>, <span class="hljs-string">'EX'</span>, <span class="hljs-built_in">timeout</span>)
    <span class="hljs-built_in">return</span> 0
end
</code></pre>
<ol start="3">
<li>AOP 切面（拦截注解，执行 Lua 脚本）</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;
<span class="hljs-keyword">import</span> org.springframework.core.io.ClassPathResource;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.util.DigestUtils;
<span class="hljs-keyword">import</span> org.springframework.util.StringUtils;

<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AntiDuplicateSubmitAspect</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; antiDuplicateScript;

    <span class="hljs-comment">// 初始化Lua脚本</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AntiDuplicateSubmitAspect</span><span class="hljs-params">()</span> {
        antiDuplicateScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();
        antiDuplicateScript.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">"lua/anti_duplicate_submit.lua"</span>));
        antiDuplicateScript.setResultType(Long.class);
    }

    <span class="hljs-meta">@Around("@annotation(com.example.demo.annotation.AntiDuplicateSubmit)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();
        <span class="hljs-type">AntiDuplicateSubmit</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> method.getAnnotation(AntiDuplicateSubmit.class);

        <span class="hljs-comment">// 3. 生成唯一请求标识（用户ID+接口名+参数摘要）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">requestKey</span> <span class="hljs-operator">=</span> generateRequestKey(joinPoint, method);
        <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> annotation.unit().toSeconds(annotation.timeout());

        <span class="hljs-comment">// 4. 执行Lua脚本</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                antiDuplicateScript,
                Collections.singletonList(requestKey),
                String.valueOf(timeout)
        );

        <span class="hljs-comment">// 5. 结果判断：1=重复提交，0=正常执行</span>
        <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1</span>) {
            log.warn(<span class="hljs-string">"接口重复提交，key:{}"</span>, requestKey);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(annotation.message());
        }

        <span class="hljs-comment">// 6. 正常执行接口逻辑</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> joinPoint.proceed();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 可选：非幂等接口执行完手动释放锁（幂等接口可依赖自动过期）</span>
            <span class="hljs-comment">// stringRedisTemplate.delete(requestKey);</span>
        }
    }

    <span class="hljs-comment">// 生成唯一请求标识：避免不同用户/不同参数被误判为重复</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateRequestKey</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, Method method)</span> {
        <span class="hljs-comment">// 获取用户ID（实际项目从Token/上下文获取，这里简化）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"anonymous"</span>; <span class="hljs-comment">// 替换为真实用户标识</span>
        <span class="hljs-comment">// 获取接口名（类名+方法名）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getDeclaringClass().getName() + <span class="hljs-string">"."</span> + method.getName();
        <span class="hljs-comment">// 获取参数摘要（避免参数不同但被误判，用MD5加密）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">paramDigest</span> <span class="hljs-operator">=</span> DigestUtils.md5DigestAsHex(
                (joinPoint.getArgs() != <span class="hljs-literal">null</span> ? joinPoint.getArgs().toString() : <span class="hljs-string">""</span>).getBytes(StandardCharsets.UTF_8)
        );
        <span class="hljs-comment">// 拼接key：redis key前缀+用户ID+接口名+参数摘要</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"anti_duplicate:"</span> + userId + <span class="hljs-string">":"</span> + methodName + <span class="hljs-string">":"</span> + paramDigest;
    }
}
</code></pre>
<ol start="4">
<li>接口使用（只需加注解）</li>
</ol>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.PostMapping</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.RequestBody</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.RestController</span>;

@<span class="hljs-selector-tag">RestController</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">OrderController</span> {

    <span class="hljs-comment">// 下单接口：1秒内禁止重复提交</span>
    <span class="hljs-variable">@AntiDuplicateSubmit</span>(timeout = <span class="hljs-number">1</span>, message = <span class="hljs-string">"下单太频繁啦，1秒后再试~"</span>)
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/api/order/create"</span>)
    public String <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestBody</span> OrderDTO orderDTO) {
        <span class="hljs-comment">// 下单逻辑（省略）</span>
        <span class="hljs-selector-tag">return</span> "下单成功，订单号：" + <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
    }
}
</code></pre>
<h5 data-id="heading-7">八年踩坑提示</h5>
<ul>
<li>过期时间别设太短（比如小于 500ms）：网络延迟可能导致正常请求被误判；也别设太长（比如超过 10 秒）：用户正常重试会被拦截；</li>
<li>请求标识必须包含 “用户 ID”：否则不同用户调用同一接口会被误判为重复；</li>
<li>非幂等接口（比如退款）建议执行完手动释放锁：避免正常流程结束后还占用锁。</li>
</ul>
<h5 data-id="heading-8">适用场景：分布式系统、高并发场景（电商大促、支付接口）</h5>
<h4 data-id="heading-9">方案 2：基于 Token 令牌（前后端联动，最安全）</h4>
<h5 data-id="heading-10">核心原理</h5>
<p>前端请求接口前，先向服务端申请 “唯一令牌”，服务端生成令牌存入 Redis；前端带着令牌调用业务接口，服务端验证令牌存在后执行逻辑，并删除令牌（确保只能用一次）。</p>
<h5 data-id="heading-11">为什么安全？</h5>
<p>令牌是一次性的，且绑定用户，即使接口被爬虫抓取，没有令牌也无法重复提交 —— 这是防御 “恶意刷接口” 的终极方案。</p>
<h5 data-id="heading-12">实战代码</h5>
<ol>
<li>Token 生成接口（前端先调用获取令牌）</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.springframework.<span class="hljs-keyword">data</span>.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;

<span class="hljs-keyword">import</span> jakarta.<span class="hljs-keyword">annotation</span>.Resource;
<span class="hljs-keyword">import</span> java.util.UUID;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;

    <span class="hljs-comment">// 生成防重令牌（前端调用接口前先获取）</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/api/token/get"</span>)</span>
    <span class="hljs-keyword">public</span> String getAntiDuplicateToken() {
        <span class="hljs-comment">// 生成UUID作为令牌</span>
        String token = <span class="hljs-string">"anti_duplicate_token:"</span> + UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
        <span class="hljs-comment">// 存入Redis，过期时间5分钟（根据业务调整）</span>
        stringRedisTemplate.opsForValue().<span class="hljs-keyword">set</span>(token, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
        <span class="hljs-keyword">return</span> token;
    }
}
</code></pre>
<ol start="2">
<li>令牌验证切面（可复用方案 1 的注解，新增验证逻辑）</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 在AntiDuplicateSubmitAspect的around方法中新增Token验证逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">validateToken</span><span class="hljs-params">(HttpServletRequest request)</span> </span>{
    <span class="hljs-type">String</span> token = request.<span class="hljs-built_in">getHeader</span>(<span class="hljs-string">"Anti-Duplicate-Token"</span>);
    <span class="hljs-keyword">if</span> (StringUtils.<span class="hljs-built_in">isEmpty</span>(token)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"缺少防重令牌，请先获取令牌！"</span>);
    }
    <span class="hljs-comment">// 验证令牌是否存在，存在则删除（一次性使用）</span>
    Boolean exists = stringRedisTemplate.<span class="hljs-built_in">delete</span>(token);
    <span class="hljs-keyword">if</span> (exists == null || !exists) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"令牌无效或已过期！"</span>);
    }
}
</code></pre>
<ol start="3">
<li>前端调用流程（伪代码）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 先获取令牌</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/token/get'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">token</span> =&gt;</span> {
    <span class="hljs-comment">// 2. 带着令牌调用下单接口</span>
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/order/create'</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
            <span class="hljs-string">'Anti-Duplicate-Token'</span>: token <span class="hljs-comment">// 令牌放在请求头</span>
        },
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({<span class="hljs-attr">orderNo</span>: <span class="hljs-string">'xxx'</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">100</span>})
    });
});
</code></pre>
<h5 data-id="heading-13">八年踩坑提示</h5>
<ul>
<li>令牌过期时间要合理：太短（比如 1 分钟）用户操作慢会失效，太长（比如 30 分钟）占用 Redis 内存；</li>
<li>前端要处理令牌失效：如果调用业务接口时提示令牌过期，需重新获取令牌再重试；</li>
<li>建议和方案 1 结合：令牌验证 + Redis 限时锁，双重防护更稳妥。</li>
</ul>
<h5 data-id="heading-14">适用场景：支付接口、退款接口等核心敏感接口</h5>
<h4 data-id="heading-15">方案 3：基于本地缓存（Caffeine）（单机高并发首选）</h4>
<h5 data-id="heading-16">核心原理</h5>
<p>如果是单机部署的应用，没必要用 Redis，直接用本地缓存（Caffeine）存储请求标识，效率更高（本地缓存响应时间微秒级）。</p>
<h5 data-id="heading-17">为什么用 Caffeine？</h5>
<p>Caffeine 是 Java 领域性能最好的本地缓存，支持过期时间、最大容量限制，比 HashMap + 定时任务更优雅，比 Guava Cache 性能高 5-10 倍。</p>
<h5 data-id="heading-18">实战代码</h5>
<ol>
<li>引入 Caffeine 依赖（SpringBoot 3.x）</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li>配置 Caffeine 缓存</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;
<span class="hljs-keyword">import</span> org.springframework.cache.CacheManager;
<span class="hljs-keyword">import</span> org.springframework.cache.caffeine.CaffeineCacheManager;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">antiDuplicateCacheManager</span><span class="hljs-params">()</span> {
        <span class="hljs-type">CaffeineCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaffeineCacheManager</span>();
        <span class="hljs-comment">// 配置缓存：最大容量10万（防止内存溢出），过期时间1秒</span>
        cacheManager.setCaffeine(Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">100000</span>)
                .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.SECONDS));
        <span class="hljs-keyword">return</span> cacheManager;
    }
}
</code></pre>
<ol start="3">
<li>改造切面（用本地缓存替代 Redis）</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Cache</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">CacheManager</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;

<span class="hljs-comment">// 在AntiDuplicateSubmitAspect中注入本地缓存管理器</span>
<span class="hljs-meta">@Resource</span>(name = <span class="hljs-string">"antiDuplicateCacheManager"</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">CacheManager</span> cacheManager;

<span class="hljs-comment">// 替换Lua脚本逻辑，用本地缓存实现</span>
<span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkLocalCache</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> requestKey</span>) {
    <span class="hljs-title class_">Cache</span> cache = cacheManager.<span class="hljs-title function_">getCache</span>(<span class="hljs-string">"antiDuplicateCache"</span>);
    <span class="hljs-keyword">if</span> (cache == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"本地缓存初始化失败！"</span>);
    }
    <span class="hljs-comment">// 查缓存：存在则返回true（重复），不存在则存入缓存</span>
    <span class="hljs-keyword">if</span> (cache.<span class="hljs-title function_">get</span>(requestKey) != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    cache.<span class="hljs-title function_">put</span>(requestKey, <span class="hljs-string">"1"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h5 data-id="heading-19">八年踩坑提示</h5>
<ul>
<li>必须设置最大容量：避免恶意请求导致缓存无限增长，引发 OOM；</li>
<li>仅适用于单机部署：多实例部署会出现缓存不一致，导致重复提交；</li>
<li>过期时间要短：本地缓存不支持分布式过期，太长会占用内存。</li>
</ul>
<h5 data-id="heading-20">适用场景：单机部署、高并发读少写多的接口（比如查询 + 提交类接口）</h5>
<h4 data-id="heading-21">方案 4：基于数据库唯一索引（兜底方案，最可靠）</h4>
<h5 data-id="heading-22">核心原理</h5>
<p>无论前端、缓存层防护得多好，数据库层都要加 “最后一道防线”—— 给核心业务字段建唯一索引（比如订单号、用户 ID + 商品 ID），即使重复提交，数据库也会抛出唯一约束异常，避免数据错乱。</p>
<h5 data-id="heading-23">为什么是兜底？</h5>
<p>缓存可能失效，令牌可能被绕过，但数据库唯一索引是 “物理防护”，除非删索引，否则绝对不会出现重复数据 —— 八年开发的底线：核心业务必须加唯一索引！</p>
<h5 data-id="heading-24">实战代码</h5>
<ol>
<li>数据库表设计（以订单表为例）</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_order` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `order_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号（唯一）'</span>,
  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `product_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'金额'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-comment">-- 唯一索引：订单号唯一（防止重复下单）</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`),
  <span class="hljs-comment">-- 联合唯一索引：同一用户不能同时买同一商品（根据业务需求）</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_user_product` (`user_id`,`product_id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'订单表'</span>;
</code></pre>
<ol start="2">
<li>业务代码处理唯一约束异常</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.springframework.dao.DuplicateKeyException;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.ExceptionHandler;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestControllerAdvice;

<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {

    <span class="hljs-comment">// 捕获数据库唯一约束异常，返回友好提示</span>
    <span class="hljs-meta">@ExceptionHandler(DuplicateKeyException.class)</span>
    <span class="hljs-keyword">public</span> String handleDuplicateKeyException(DuplicateKeyException e) {
        log.error(<span class="hljs-string">"重复提交导致唯一约束冲突："</span>, e);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"操作失败，请勿重复提交！"</span>;
    }
}
</code></pre>
<h5 data-id="heading-25">八年踩坑提示</h5>
<ul>
<li>唯一索引要贴合业务：别盲目建唯一索引，比如 “用户 ID + 商品 ID” 适合 “限购一件” 的场景，“订单号” 适合所有订单唯一的场景；</li>
<li>避免过度建索引：索引会影响插入性能，核心字段才需要；</li>
<li>异常信息要脱敏：别把数据库表结构、字段名暴露给前端。</li>
</ul>
<h5 data-id="heading-26">适用场景：所有核心业务接口（支付、下单、退款），作为兜底方案</h5>
<h4 data-id="heading-27">方案 5：基于 AOP + 自定义注解（优雅封装，复用性强）</h4>
<h5 data-id="heading-28">核心原理</h5>
<p>把方案 1-4 的逻辑封装成通用注解，业务接口只需加注解即可实现防抖，无需写重复代码 —— 这是八年开发的 “偷懒技巧”：一次封装，处处复用。</p>
<h5 data-id="heading-29">进阶封装：支持多场景切换</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 增强AntiDuplicateSubmit注解，支持选择防抖方式</span>
<span class="hljs-keyword">public</span> @interface AntiDuplicateSubmit {
    <span class="hljs-comment">// 防抖方式：REDIS/Local_CACHE/TOKEN</span>
    <span class="hljs-function">Mode <span class="hljs-title">mode</span>() <span class="hljs-literal">default</span> Mode.REDIS</span>;
    <span class="hljs-function"><span class="hljs-built_in">long</span> <span class="hljs-title">timeout</span>() <span class="hljs-literal">default</span> 1</span>;
    <span class="hljs-function">TimeUnit <span class="hljs-title">unit</span>() <span class="hljs-literal">default</span> TimeUnit.SECONDS</span>;
    <span class="hljs-function">String <span class="hljs-title">message</span>() <span class="hljs-literal">default</span> "操作过于频繁，请稍后再试！"</span>;

    <span class="hljs-built_in">enum</span> Mode {
        REDIS, LOCAL_CACHE, TOKEN
    }
}
</code></pre>
<h5 data-id="heading-30">改造切面：根据注解模式选择防抖方案</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Around</span>(<span class="hljs-string">"@annotation(antiDuplicateSubmit)"</span>)
public Object around(ProceedingJoinPoint joinPoint, AntiDuplicateSubmit antiDuplicateSubmit) throws Throwable {
    String requestKey = <span class="hljs-built_in">generateRequestKey</span>(joinPoint, antiDuplicateSubmit.method());
    AntiDuplicateSubmit<span class="hljs-selector-class">.Mode</span> mode = antiDuplicateSubmit<span class="hljs-selector-class">.mode</span>();

    <span class="hljs-comment">// 根据模式选择不同方案</span>
    if (mode == AntiDuplicateSubmit.Mode.REDIS) {
        <span class="hljs-comment">// Redis+Lua方案</span>
        Long result = stringRedisTemplate<span class="hljs-selector-class">.execute</span>(antiDuplicateScript, Collections.singletonList(requestKey), String<span class="hljs-selector-class">.valueOf</span>(timeout));
        if (result != null &amp;&amp; result == <span class="hljs-number">1</span>) {
            throw new <span class="hljs-built_in">RuntimeException</span>(antiDuplicateSubmit.message());
        }
    } else if (mode == AntiDuplicateSubmit.Mode.LOCAL_CACHE) {
        <span class="hljs-comment">// 本地缓存方案</span>
        if (checkLocalCache(requestKey)) {
            throw new <span class="hljs-built_in">RuntimeException</span>(antiDuplicateSubmit.message());
        }
    } else if (mode == AntiDuplicateSubmit.Mode.TOKEN) {
        <span class="hljs-comment">// Token方案</span>
        <span class="hljs-built_in">validateToken</span>(request);
    }

    return joinPoint<span class="hljs-selector-class">.proceed</span>();
}
</code></pre>
<h5 data-id="heading-31">接口使用示例（按需选择模式）</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 支付接口：用TOKEN模式（最安全）</span>
<span class="hljs-variable">@AntiDuplicateSubmit</span>(mode = AntiDuplicateSubmit.Mode.TOKEN, message = <span class="hljs-string">"支付请求已提交，请勿重复操作！"</span>)
<span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/api/pay"</span>)
public String <span class="hljs-built_in">pay</span>(<span class="hljs-variable">@RequestBody</span> PayDTO payDTO) { ... }

<span class="hljs-comment">// 下单接口：用REDIS模式（分布式高并发）</span>
<span class="hljs-variable">@AntiDuplicateSubmit</span>(mode = AntiDuplicateSubmit.Mode.REDIS, timeout = <span class="hljs-number">2</span>)
<span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/api/order/create"</span>)
public String <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestBody</span> OrderDTO orderDTO) { ... }

<span class="hljs-comment">// 评论接口：用LOCAL_CACHE模式（单机部署）</span>
<span class="hljs-variable">@AntiDuplicateSubmit</span>(mode = AntiDuplicateSubmit.Mode.LOCAL_CACHE)
<span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/api/comment/add"</span>)
public String <span class="hljs-built_in">addComment</span>(<span class="hljs-variable">@RequestBody</span> CommentDTO commentDTO) { ... }
</code></pre>
<h5 data-id="heading-32">适用场景：全场景复用，大型项目推荐（减少重复开发）</h5>
<h3 data-id="heading-33">三、八年踩坑总结：3 个致命错误别犯！</h3>
<ol>
<li><strong>只做前端防抖，不做后端防护</strong>：前端按钮禁用能防 “手抖”，但防不住爬虫、Postman 直接调用 —— 后端必须加防护；</li>
<li><strong>忽略幂等性设计</strong>：防抖是 “阻止调用”，防重是 “保证结果一致”，比如支付接口，即使防抖失效，重复调用也不能扣两次钱；</li>
<li><strong>Redis 过期时间设置不合理</strong>：太短导致正常请求被误判，太长导致用户无法重试 —— 建议根据业务调整，一般 1-5 秒。</li>
</ol>
<h3 data-id="heading-34">四、选型指南：一张表选对方案</h3>









































<table><thead><tr><th>方案</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>Redis+Lua</td><td>分布式、高并发</td><td>性能高、支持分布式</td><td>需部署 Redis</td></tr><tr><td>Token 令牌</td><td>敏感接口（支付 / 退款）</td><td>最安全、防恶意刷接口</td><td>前后端联动成本高</td></tr><tr><td>本地缓存（Caffeine）</td><td>单机部署、高并发</td><td>响应快、无网络开销</td><td>不支持分布式</td></tr><tr><td>数据库唯一索引</td><td>核心业务兜底</td><td>最可靠、物理防护</td><td>影响插入性能</td></tr><tr><td>AOP + 自定义注解</td><td>大型项目、多场景</td><td>复用性强、优雅简洁</td><td>需提前封装</td></tr></tbody></table>
<p><strong>一句话口诀</strong>：分布式用 Redis，敏感接口用 Token，单机用 Caffeine，核心业务加索引。</p>
<h3 data-id="heading-35">五、总结</h3>
<p>八年开发经验告诉我：接口防抖不是 “炫技”，而是 “底线思维”。一套完善的防抖方案，应该是 “前端按钮禁用 + 后端多重防护 + 数据库兜底” 的组合拳 —— 前端防普通用户，后端防恶意攻击，数据库防所有漏网之鱼。</p>
<p>本文的 5 种方案，从单机到分布式，从临时防护到长期复用，覆盖了所有场景，代码都经过实际项目验证，可直接复制使用。如果你的项目还在被重复提交困扰，不妨根据业务场景选择合适的方案，早日实现 “接口防抖自由”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day35 | Java多线程入门]]></title>    <link>https://juejin.cn/post/7588464673285455899</link>    <guid>https://juejin.cn/post/7588464673285455899</guid>    <pubDate>2025-12-29T02:01:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588464673285455899" data-draft-id="7588464673285423131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day35 | Java多线程入门"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-12-29T02:01:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day35 | Java多线程入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:01:24.000Z" title="Mon Dec 29 2025 02:01:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文开始，我们进入Java多线程模块。</p>
<p>现代计算机的CPU基本都是多个核心，每个核心都可以独立执行计算任务。</p>
<p>所谓的多线程编程，就是允许我们的程序创建多个执行流（线程），然后把它们分配到不同的CPU核心上同时运行，从而充分利用硬件资源，提高程序的响应速度和处理能力。</p>
<h2 data-id="heading-0">一、基本概念</h2>
<p>在学习Java的多线程之前，我们先弄清楚一些基本的概念。</p>
<h3 data-id="heading-1">进程：</h3>
<p>操作系统资源分配的最小单位，拥有独立的内存空间。一个程序运行起来就是一个进程。</p>
<p>你在电脑上双击wechat.exe启动微信的时候，系统就创建了一个微信进程。这个进程有自己的内存空间和资源。</p>
<h3 data-id="heading-2">线程：</h3>
<p>线程是进程中的执行单元，同一个进程可以有很多个线程，这些线程共享内存资源，用来同时执行多个任务。</p>
<p>微信里面一个线程负责收消息，另外一个线程可能负责渲染聊天界面，他们都是属于同一个微信进程的。</p>
<h3 data-id="heading-3">虚拟线程：</h3>
<p>JDK21正式引入了虚拟线程这个类似协程的机制。虚拟线程由Java自己调度，不需要操作系统的管理。</p>
<p>大家都在微信上发消息、看朋友圈、登录，如果微信服务器给每个用户分配一个轻量的虚拟线程，就不会像传统的线程那样，每个用户都占用一个系统线程，资源就不会那么紧张。</p>
<h3 data-id="heading-4">并发：</h3>
<p>多个任务在同一时间段交替执行，提高效率，看起来是同时进行，但实际上可能是轮流执行。</p>
<p>你在微信上发语音的同时，微信还能加载朋友圈，其实两个操作在一个线程里交替完成。</p>
<h3 data-id="heading-5">并行：</h3>
<p>多个任务在同一时刻真正同时执行，依赖于多核CPU支持。</p>
<p>打开微信和打开浏览器两个进程分别运行在不同CPU核心上，彼此互不干扰，同时运行。</p>
<h2 data-id="heading-6">二、创建线程</h2>
<p>接下来我们看一下在Java中如何创建线程。</p>
<h3 data-id="heading-7">2.1 继承Thread</h3>
<p>这是最直观的创建线程的方式。Thread类是Java提供的用来创建和控制线程的核心类。</p>
<p>他代表的就是一个独立执行的任务单元。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day35;

<span class="hljs-comment">/**
   * <span class="hljs-doctag">@ClassName</span> Day35Demo 
   * <span class="hljs-doctag">@Description</span> TODO
   * <span class="hljs-doctag">@Author</span> lazysnail
   * <span class="hljs-doctag">@Date</span> 2025/7/17 10:38
   * <span class="hljs-doctag">@Version</span> 1.0
   */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day35Demo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"主线程开始..."</span>);
        <span class="hljs-type">MyThread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>();
        thread1.setName(<span class="hljs-string">"我的线程"</span>);
        thread1.start();
        System.out.println(<span class="hljs-string">"主线程结束。"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            System.out.println(<span class="hljs-string">"子线程 "</span> + Thread.currentThread().getName() + <span class="hljs-string">" 正在运行: "</span> + i);
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<p>MyThread是我自定义的线程类，继承了Thread。</p>
<p>这个类中只做了一件事情，重写run方法。这个方法中的内容其实就是你想让线程帮你执行的逻辑。</p>
<p>在main方法中创建了自定义线程的对象，通过对象调用start方法，那么这个线程就启动了。</p>
<p>初学者容易把run方法和start方法搞混。记住run方法是你需要交给线程执行的任务逻辑。</p>
<p>start方法是启动线程，相当于激活这个线程。</p>
<p>如果你直接用线程对象调用了run方法，像这样：thread1.run。</p>
<p>就不会创建新的线程去执行你的逻辑，只是在当前线程中执行run()方法体，变成了普通的同步方法调用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d25cfa0ee3a84f2195e8dbeb20daef11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578483&amp;x-signature=LHzuG2gfBxh4UUQX5tlNKWt8lBg%3D" alt="" loading="lazy"/></p>
<p>正常启动线程的输出</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ffd640c82334324b0346c6d464e5081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578483&amp;x-signature=NzjiX52zTCTntjwBnAh25i6abd4%3D" alt="" loading="lazy"/></p>
<p>直接调用了run方法的输出</p>
<p>两者输出的对比，后者其实是按照代码顺序执行的。前者主线程和新启动的线程独立执行。</p>
<blockquote>
<p>main方法是一个独立的线程，当你在main方法某处创建启动了新的线程，这个新线程在某一时刻也会执行自己的逻辑。 正常启动线程的输出也不是一成不变的，你的机器上或者你多运行几次，可能输出的顺序就会发生改变。因为线程的调度权在操作系统手里。操作系统会根据系统负载，CPU状态等等情况合理的调度线程。我们是没办法预测多线程精确的执行顺序的。</p>
</blockquote>
<h3 data-id="heading-8">2.2 实现Runnable</h3>
<p>我们都知道Java有单继承的限制，这在某些情况下就不够灵活。</p>
<p>所以在有需要的情况下，我们一般都会选择实现Runnable的方式。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day35;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day35Demo2
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/17 11:19
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day35Demo2</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"主线程开始..."</span>);
        <span class="hljs-type">MyRunnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>();
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task, <span class="hljs-string">"我的线程"</span>);
        thread1.start();
        System.out.println(<span class="hljs-string">"主线程结束。"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            System.out.println(<span class="hljs-string">"子线程 "</span> + Thread.currentThread().getName() + <span class="hljs-string">" 正在运行: "</span> + i);
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<p>MyRunnable实现Runnable接口，类中也只做了一件事情，就是实现run方法。</p>
<p>在main方法中，需要创建一个Thread实例，然后把Runnable实现类的实例喂给他。</p>
<p>启动线程一样是通过线程实例的start方法。</p>
<p>这种写法的好处就在于把要执行的任务（Runnable）和执行任务的载体（Thread）解耦了。</p>
<p>如果你去翻看过Thread的源码，你会发现Thread类也实现了Runnable接口</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b570380f24e74939bb8e3cc55d09834d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578483&amp;x-signature=OYgfRfRXiTMGeEI6zrTaAVS969g%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>从本质上来说，Thread是用来构建线程的，Runnable是用来包装任务的。</p>
</blockquote>
<h2 data-id="heading-9">三、线程的生命周期</h2>
<p>生命周期就是一个事物从诞生到消亡的过程中所经历的一系列阶段。</p>
<p>线程从创建到终止会经历不同的状态。</p>
<p>对于开发者来说，这些状态可以让我们清晰精准的控制程序的运行。</p>
<p>对于操作系统和虚拟机来说，这些状态可以让他们合理的调度CPU资源。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8bc89ad039841b1b64c49d3c77dad40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578483&amp;x-signature=4GnvVepVTop%2BIjs0PcYA8ya13Qo%3D" alt="" loading="lazy"/></p>
<p>Thread.State是Thread类中的线程状态枚举。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f6704bfe787466a905282d1d0380fcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767578483&amp;x-signature=TXIUJs%2BwnYWCSBCzesNqgKlSZZw%3D" alt="" loading="lazy"/></p>
<p>在Java层面，线程的状态被抽象成了6个：</p>
<p>NEW：新建，new Thread()之后，线程对象已经创建，但是还没调用start()方法。</p>
<p>RUNNABLE：可运行，调用start()方法后，线程就准备就绪了，等待CPU的调度。这个状态包含了我们通常理解的正在运行和准备运行两种状态。</p>
<p>BLOCKED：阻塞，线程在等待锁资源，比如想要进入一个synchronized块，此时锁被其他线程持有，只能等着。</p>
<p>WAITING：无限等待，线程无限期的等待另一个线程的通知。wait()方法和join()方法都可以让线程记入WAITING状态。</p>
<p>TIMED_WAITING：限时等待，在指定时间后会自动唤醒的等待状态。sleep(long)、wait(long)、join(long)等方法可以让线程进入这个状态。</p>
<p>TERMINATED：终止，线程的run()方法执行完或因为异常退出，线程生命周期就结束了。</p>
<p>这几个状态是Java虚拟机在Java层面提供的逻辑视图，主要是方便我们在写多线程代码的时候更好的理解和控制线程。</p>
<p>在操作系统层面，比如Linux中，他更关心的是调度和资源的控制。</p>
<p>Running：正在CPU上执行。</p>
<p>Runnable (Ready)：可运行，等待被调度。</p>
<p>Blocked/Sleeping：因等待资源、IO、锁等而挂起。</p>
<p>Zombie：已退出，但父进程尚未回收。</p>
<p>Stopped：被外部信号暂停。</p>
<p>这几个状态是Linux操作系统调度器和内核真实管理线程时使用的状态。</p>
<p>二者对比，虽然不完全等价，但是存在一定的映射关系。</p>
<p>一个大致的映射关系</p>

































<table><thead><tr><th>Java线程状态</th><th>操作系统线程可能状态（粗略）</th></tr></thead><tbody><tr><td>NEW</td><td>不存在（还未调用start()）</td></tr><tr><td>RUNNABLE</td><td>Ready/Running（可运行或正在运行）</td></tr><tr><td>BLOCKED</td><td>Sleeping（等待锁）</td></tr><tr><td>WAITING</td><td>Sleeping（无限等待，需其他线程唤醒）</td></tr><tr><td>TIMED_WAITING</td><td>Sleeping（限时挂起）</td></tr><tr><td>TERMINATED</td><td>Zombie（Java层已销毁，可能系统层还未清理）</td></tr></tbody></table>
<blockquote>
<p>Java中的RUNNABLE包括了操作系统的Ready + Running，没有细分。</p>
</blockquote>
<h2 data-id="heading-10">四、Thread类的常用方法</h2>
<p>Thread类是学习Java多线程的一个基础，他是创建、启动、管理线程的核心类，几乎所有多线程操作的入口都离不开它。</p>
<p>Thread对象内部包装了一个原生操作系统线程（JVM映射），是Java抽象线程和系统调度机制之间的桥梁。</p>
<p>后续的线程池、虚拟线程、并发工具类等等的学习都需要建立在对Thread机制的理解之上。</p>
<p>下面我们一起看下Thread类中一些常见的方法：</p>
<h3 data-id="heading-11">start()</h3>
<p>这个方法用来启动线程，触发 run() 方法执行。只有调用start()，线程才会真正并发执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    System.out.println(<span class="hljs-string">"子线程正在运行..."</span>);
});
t.start();
</code></pre>
<p>需要注意的是start()只能调用一次；重复调用会抛出IllegalThreadStateException。</p>
<p>它会在新的线程中执行run()，不要手动调用run()。</p>
<h3 data-id="heading-12">run()</h3>
<p>线程启动之后执行的实际逻辑代码，要么是自己覆写的，要么是通过Lambda传入的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    System.out.println(<span class="hljs-string">"这是run()方法里的代码"</span>);
});
t.start();
</code></pre>
<p>run()本身不具有并发性，直接调用run()只是普通方法执行，不会启动线程。</p>
<h3 data-id="heading-13">sleep(long millis)</h3>
<p>让当前线程休眠指定毫秒数，不释放锁。</p>
<pre><code class="hljs language-java" lang="java">System.out.println(<span class="hljs-string">"开始"</span>);
Thread.sleep(<span class="hljs-number">1000</span>);
System.out.println(<span class="hljs-string">"1秒后执行"</span>);
</code></pre>
<p>Thread.sleep()休眠的是当前的线程，不是目标线程。</p>
<p>会抛出InterruptedException，需要捕获或者抛出。</p>
<p>不会释放资源，容易出现并发问题。</p>
<h3 data-id="heading-14">join()</h3>
<p>等待另一个线程执行完成后再继续执行当前线程。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">try</span> {
        Thread.sleep(<span class="hljs-number">1000</span>);
        System.out.println(<span class="hljs-string">"子线程执行完毕"</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {}
});

t.start();
t.join();
System.out.println(<span class="hljs-string">"主线程继续执行"</span>);
</code></pre>
<p>主线程等待子线程执行完成。</p>
<p>这个方法会让当前线程进入WAITING状态。</p>
<p>也可以通过join(long timeout)方法，让线程进入TIMED_WAITING状态。</p>
<h3 data-id="heading-15">interrupt()</h3>
<p>中断线程的休眠或等待状态，这个方法不会强制停止线程，只是设置一个中断标志。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
    <span class="hljs-keyword">try</span> {
        Thread.sleep(<span class="hljs-number">5000</span>);
        System.out.println(<span class="hljs-string">"醒来继续执行"</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        System.out.println(<span class="hljs-string">"被中断了！"</span>);
    }
});
t.start();

Thread.sleep(<span class="hljs-number">1000</span>);
t.interrupt();
</code></pre>
<p>这个方法对处于sleep()、wait()、join()状态的线程有效，会抛出InterruptedException。</p>
<p>对于正常运行中的线程，只是设置一个标志位，要手动检查：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) { ... }
</code></pre>
<h3 data-id="heading-16">isAlive()</h3>
<p>判断线程是否仍处于活动状态（已启动但还没终止）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {});
System.out.println(t.isAlive());
t.start();
System.out.println(t.isAlive());
</code></pre>
<h3 data-id="heading-17">setPriority(int newPriority)</h3>
<p>设置线程的优先级（范围是1~10，默认是5）。</p>
<pre><code class="hljs language-java" lang="java">t.setPriority(Thread.MAX_PRIORITY);
</code></pre>
<p>JVM不保证高优先级线程一定先执行，只是作为调度建议。</p>
<p>在现代操作系统下基本没什么作用，不推荐依赖它来做控制。</p>
<h3 data-id="heading-18">getName()/setName(String name)</h3>
<p>获取或设置线程的名称，主要是用来输出日志和调试。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {});
t.setName(<span class="hljs-string">"我的线程"</span>);
System.out.println(t.getName());
</code></pre>
<h3 data-id="heading-19">currentThread()</h3>
<p>用来获取当前正在执行的线程对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
System.out.println(<span class="hljs-string">"当前线程："</span> + t.getName());
</code></pre>
<h3 data-id="heading-20">setDaemon(boolean on)</h3>
<p>把线程设置成守护线程。</p>
<p>当JVM里只剩下守护线程的时候，JVM会直接退出，不会等待守护线程执行完。</p>
<p>像日志记录、监控这种后台服务比较常用。</p>
<p>垃圾回收线程（GC）就是一个守护线程。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                System.out.println(<span class="hljs-string">"守护线程运行中..."</span>);
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">500</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {}
            }
        });

        t.setDaemon(<span class="hljs-literal">true</span>);
        t.start();

        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1000</span>);
            System.out.println(<span class="hljs-string">"主线程结束"</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {}
    }
</code></pre>
<p>主线程结束之后，JVM不会管守护线程，守护线程的while循环也不再执行了。</p>
<h2 data-id="heading-21">结语</h2>
<p>今天讲了一些Java多线程的基础知识，这些都是并发程编程的基础。</p>
<p>并发编程也不是什么高大上或者进阶的东西，可以把他看成一个简单的模块。</p>
<p>掌握多线程要转变一下思维，之前都是独自按顺序完成任务，现在把任务分发给更多的人一起完成。</p>
<p>怎么让这些人按照有序的规则，高效的协作，共同完成任务。</p>
<p>这些规则其实就是我们关心的，我们需要掌握的，一旦掌握了，那么你写的代码就是安全、高效的。</p>
<p><strong>下一篇预告</strong></p>
<blockquote>
<p>Day36 | Java中的线程池技术</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p>
<p><strong>更多文章请关注我的公众号《懒惰蜗牛工坊》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别“千里传荔枝”：React useContext 打造跨层级通信“任意门”]]></title>    <link>https://juejin.cn/post/7588191506607636486</link>    <guid>https://juejin.cn/post/7588191506607636486</guid>    <pubDate>2025-12-28T17:28:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588191506607636486" data-draft-id="7588300640600080390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别“千里传荔枝”：React useContext 打造跨层级通信“任意门”"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-28T17:28:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别“千里传荔枝”：React useContext 打造跨层级通信“任意门”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T17:28:33.000Z" title="Sun Dec 28 2025 17:28:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 的开发江湖里，组件通信是绕不开的基本功。父传子用 Props，子传父用回调，这都没问题。但一旦项目稍微复杂一点，你就会遇到一个经典痛点：<strong>Props Drilling（属性钻取）</strong> 。</p>
<p>想象一下，你作为“皇上”（顶层组件 App）想吃一口新鲜的荔枝（数据），但这荔枝得从岭南（底层组件）一路运到长安。中间隔着千山万水（Page, Header, Content...），每一层组件都得像驿站一样接手这个荔枝，再传给下一站。</p>
<p>古人云：“一骑红尘妃子笑，无人知是荔枝来。” 程序员云：“一层一层传 Props，改个需求火葬场。”</p>
<p>这种“千里传荔枝”的模式性价比极低，中间的组件明明不需要这个数据，却被迫持有并传递它。今天，我们就来聊聊 React 官方提供的“虫洞”技术 —— <strong>Context API</strong>，以及如何用 <code>useContext</code> 优雅地解决跨层级通信难题。</p>
<hr/>
<h2 data-id="heading-0">一、 为什么我们需要 Context？</h2>
<p>在 React 的设计哲学里，数据流是单向的（Top-Down）。通常情况下，外层组件（父组件）持有并管理复杂数据，拥有“规矩”。</p>
<ul>
<li><strong>没有 Context 时</strong>：数据必须通过 Props 就像接力棒一样，父 -&gt; 子 -&gt; 孙 -&gt; 曾孙。只要链路断了一环，数据就丢了。</li>
<li><strong>有了 Context 后</strong>：我们相当于建立了一个<strong>全局广播塔</strong>。数据被放在一个查找上下文中（Context），任何层级的组件，只要它需要，就可以直接向 Context 申请：“把数据给我”，而不需要中间商赚差价。</li>
</ul>
<p><strong>核心思想转变：</strong></p>
<ul>
<li><strong>Props</strong>：被动接收。父给什么，子接什么。</li>
<li><strong>Context</strong>：主动消费。组件拥有了“找数据”的能力，按需索取。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、不仅是传值：Context 的三板斧</h2>
<p>使用 Context 其实非常简单，只需要记住三个步骤：<strong>创建（Create）、提供（Provide）、消费（Consume）</strong> 。</p>
<p>我们先用你提供的 <code>UserContext</code> 例子来走一遍流程。</p>
<h3 data-id="heading-2">1. 创建容器 (Create)</h3>
<p>首先，我们需要一个容器来装这些共享的数据。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 创建 Context 对象</span>
<span class="hljs-comment">// null 是默认值，只有当组件在树中找不到匹配的 Provider 时，才会使用这个默认值</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);
</code></pre>
<h3 data-id="heading-3">2. 提供数据 (Provide)</h3>
<p>在组件树的顶层（或者任何你希望开始共享数据的层级），使用 <code>Provider</code> 组件把数据“广播”出去。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Page</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./views/Page'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 这是我们要共享的数据，皇上的荔枝</span>
    <span class="hljs-keyword">const</span> user = {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"Andrew"</span>,
        <span class="hljs-attr">role</span>: <span class="hljs-string">"Admin"</span>
    }

    <span class="hljs-keyword">return</span> (
        <span class="hljs-comment">// UserContext.Provider 就是数据提供者</span>
        <span class="hljs-comment">// value 属性决定了下层组件能拿到什么</span>
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{user}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Page</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span>
    )
}
</code></pre>
<p>注意，这里的 <code>&lt;Page /&gt;</code> 组件根本不需要知道 <code>user</code> 是什么，它只需要安静地做一个容器。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Page.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/Header'</span>;
<span class="hljs-comment">// Page 组件完全解耦，不接收任何 user 相关的 props</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span>
  )
}

<span class="hljs-comment">// Header.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserInfo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./UserInfo'</span>;
<span class="hljs-comment">// Header 同样不需要关心 user</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserInfo</span> /&gt;</span></span>
    )
}
</code></pre>
<h3 data-id="heading-4">3. 消费数据 (Consume)</h3>
<p>到了最底层的 <code>UserInfo</code>，我们要用 <code>useContext</code> 这个 Hook 像变魔术一样把数据取出来。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// UserInfo.js</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../App'</span>; <span class="hljs-comment">// 引入刚才创建的 Context</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 核心代码：一句话拿到 value</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user); <span class="hljs-comment">// output: { name: "Andrew", role: "Admin" }</span>

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-card"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Name: {user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>看，是不是清爽多了？</strong> 中间的 <code>Page</code> 和 <code>Header</code> 组件完全从数据传递中解脱了出来，代码耦合度大大降低。</p>
<hr/>
<h2 data-id="heading-5">三、 进阶实战：封装 ThemeProvider（动态 Context）</h2>
<p>上面的例子是静态数据，但在真实业务中，我们通常需要传递<strong>状态（State）以及修改状态的方法</strong>。</p>
<p>最经典的场景就是 <strong>深色模式（Dark Mode）切换</strong>。我们要构建一个 <code>ThemeProvider</code>，它不仅提供当前的主题，还提供一个 <code>toggleTheme</code> 方法给子组件调用。</p>
<h3 data-id="heading-6">1. 封装 Context 逻辑</h3>
<p>为了保持 <code>App.js</code> 的整洁，我们通常会将 Context 的逻辑抽离到一个单独的文件中。这是一个非常好的<strong>工程化习惯</strong>。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// contexts/ThemeContext.js</span>
<span class="hljs-keyword">import</span> { createContext, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-comment">// 创建 Context</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 创建一个独立的 Provider 组件</span>
<span class="hljs-comment">// 这里的 children 是 React 也就是被包裹的子组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeProvider</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'light'</span>);

    <span class="hljs-comment">// 切换逻辑</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-title function_">setTheme</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
    }

    <span class="hljs-comment">// 副作用处理：同步到 DOM</span>
    <span class="hljs-comment">// 这是一个非常妙的操作，利用 data-* 属性配合 CSS 变量</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// document.documentElement 获取的是 &lt;html&gt; 标签</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-theme'</span>, theme);
    }, [theme]);

    <span class="hljs-keyword">return</span> (
        <span class="hljs-comment">// value 中同时包含 数据(theme) 和 方法(toggleTheme)</span>
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">toggleTheme</span> }}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
    )
}
</code></pre>
<h3 data-id="heading-7">2. 在入口处包裹</h3>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ThemeProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./contexts/ThemeContext"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Page</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./pages/Page"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">return</span>(
    <span class="hljs-comment">// 只要被 ThemeProvider 包裹，里面的所有组件都能访问到主题</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">Page</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-8">3. 在任意深处消费</h3>
<p>比如在 Header 中切换主题，在 Content 中展示主题样式。</p>
<p><strong>Header (控制者):</strong></p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// components/Header.js</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../contexts/ThemeContext"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>){
    <span class="hljs-comment">// 解构出 toggleTheme 方法</span>
    <span class="hljs-keyword">const</span> { theme, toggleTheme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
    
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">10px</span>', <span class="hljs-attr">borderBottom:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>' }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>当前模式：{theme === 'light' ? '🌞' : '🌙'}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginLeft:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
                切换主题
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>Content (消费者):</strong></p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// components/Content.js</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../contexts/ThemeContext"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Content</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { theme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
    
    <span class="hljs-comment">// 根据 theme 调整样式</span>
    <span class="hljs-keyword">const</span> styles = {
        <span class="hljs-attr">padding</span>: <span class="hljs-number">24</span>, 
        <span class="hljs-comment">// 实际项目中建议配合 CSS Variables，这里为了演示直接写内联样式</span>
        <span class="hljs-attr">backgroundColor</span>: theme === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'#f0f0f0'</span> : <span class="hljs-string">'#2a2a2a'</span>, 
        <span class="hljs-attr">color</span>: theme === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'#000'</span> : <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span>,
        <span class="hljs-attr">transition</span>: <span class="hljs-string">'all 0.3s ease'</span>
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个使用 React Context API 实现的主题切换示例。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<hr/>
<h2 data-id="heading-9">四、 避坑指南与最佳实践</h2>
<p>虽然 <code>useContext</code> 很香，但也不要贪杯（滥用）。</p>
<ol>
<li>
<p><strong>性能陷阱</strong>： Context 的机制是：<strong>只要 Provider 的 value 发生变化，所有消费该 Context 的组件都会强制重新渲染</strong>。</p>
<ul>
<li><em>坏习惯</em>：<code>value={{ theme, toggleTheme }}</code>。如果 Provider 组件自身重渲染（例如父组件更新），这个对象就是新的引用，会导致下层所有消费者重渲染。</li>
<li><em>优化</em>：配合 <code>useMemo</code> 缓存 value 对象。</li>
</ul>
</li>
<li>
<p><strong>上下文地狱</strong>： 不要为了避免 Props Drilling 就把所有数据都塞进 Context。如果你的组件树顶层包了十几个 Provider (<code>UserProvider</code>, <code>ThemeProvider</code>, <code>LanguageProvider</code>, <code>AuthProvider</code>...)，代码维护性也会变差。</p>
</li>
<li>
<p><strong>组件复用性</strong>： 一旦组件使用了 <code>useContext</code>，它就依赖了特定的环境。如果你想复用 <code>UserInfo</code> 组件到一个没有 <code>UserContext</code> 的地方，它就会报错或失效。对于简单的父子通信，<strong>Props 依然是首选</strong>。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-10">五、 总结</h2>
<p>React 的 <code>useContext</code> 是解决跨层级通信的一把利剑。</p>
<ul>
<li>它像一个<strong>虫洞</strong>，打通了组件层级的壁垒。</li>
<li>它让数据流向更加清晰，避免了中间组件的冗余代码。</li>
<li>配合 <code>useState</code> 和 <code>useEffect</code>，我们可以轻松实现全局的状态管理（如主题、用户信息、多语言）。</li>
</ul>
<p>下次当你发现自己在写 <code>props={props.something}</code> 超过两层时，停下来想一想： <strong>“是不是该给长安送个荔枝虫洞了？”</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 AbortSignal：前端异步操作取消的原生方案]]></title>    <link>https://juejin.cn/post/7588355695101820937</link>    <guid>https://juejin.cn/post/7588355695101820937</guid>    <pubDate>2025-12-28T23:45:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588355695101820937" data-draft-id="7579573664228605961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 AbortSignal：前端异步操作取消的原生方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-28T23:45:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ycgg"/> <meta itemprop="url" content="https://juejin.cn/user/1926000101039192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 AbortSignal：前端异步操作取消的原生方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000101039192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ycgg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T23:45:06.000Z" title="Sun Dec 28 2025 23:45:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，异步操作（如网络请求、定时器、文件读取）的“取消需求”十分常见——比如用户切换页面时取消未完成的 <code>fetch</code> 请求、关闭弹窗时终止定时器、表单提交后取消之前的验证任务。<code>AbortSignal</code> 是 HTML5 原生提供的<strong>异步操作取消信号机制</strong>，配合 <code>AbortController</code> 使用，能统一、优雅地实现各类异步任务的取消，避免内存泄漏或无效操作浪费资源。</p>
<p>本文将从基础用法、核心特性、常用场景到避坑指南，全面拆解 <code>AbortSignal</code> 的实用价值。</p>
<h2 data-id="heading-0">一、AbortSignal 是什么？</h2>
<p><code>AbortSignal</code> 是 <code>AbortController</code> 接口的核心组成部分，本质是一个“取消信号载体”：</p>
<ul>
<li>它由 <code>AbortController</code> 生成，用于关联一个或多个异步操作；</li>
<li>当调用 <code>AbortController.abort()</code> 时，对应的 <code>AbortSignal</code> 会被标记为“已取消”，所有关联该信号的异步操作会收到通知并终止；</li>
<li>原生支持 <code>fetch</code>、<code>ReadableStream</code>、<code>Timer</code>（部分场景）等异步 API，也可用于自定义异步函数的取消逻辑。</li>
</ul>
<h3 data-id="heading-1">核心关系：AbortController ↔ AbortSignal</h3>
<p><code>AbortSignal</code> 不能单独使用，必须与 <code>AbortController</code> 配套：</p>
<ul>
<li><code>AbortController</code>：负责“触发取消”的控制器（相当于“开关”）；</li>
<li><code>AbortSignal</code>：负责“传递取消信号”的载体（相当于“电线”）；</li>
<li>一个控制器可以生成一个信号，一个信号可以关联多个异步操作（一键取消所有关联任务）。</li>
</ul>
<h2 data-id="heading-2">二、基本用法（3 步上手）</h2>
<p><code>AbortSignal</code> 的使用流程极其简洁，核心是“创建控制器 → 关联信号 → 触发取消”，以下是最基础的示例：</p>
<h3 data-id="heading-3">1. 基础流程：取消 fetch 请求</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建 AbortController 实例（控制器）</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-comment">// 2. 获取关联的 AbortSignal（信号）</span>
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;

<span class="hljs-comment">// 3. 异步操作关联信号（fetch 原生支持 signal 参数）</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data'</span>, { signal })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功：'</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-comment">// 取消时会抛出 AbortError，需捕获</span>
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被手动取消'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, err);
    }
  });

<span class="hljs-comment">// 4. 触发取消（比如用户点击“取消”按钮）</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'cancelBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 调用 abort() 后，signal 会标记为“已取消”</span>
});
</code></pre>
<h3 data-id="heading-4">2. 核心 API 说明</h3>

































<table><thead><tr><th>相关对象/API</th><th>作用</th></tr></thead><tbody><tr><td><code>new AbortController()</code></td><td>创建控制器实例，用于生成信号和触发取消</td></tr><tr><td><code>controller.signal</code></td><td>获取与控制器绑定的 <code>AbortSignal</code> 实例（信号载体）</td></tr><tr><td><code>controller.abort(reason)</code></td><td>触发取消：标记 <code>signal</code> 为 <code>aborted: true</code>，可选传递取消原因（reason）</td></tr><tr><td><code>signal.aborted</code></td><td>只读属性：返回布尔值，表示信号是否已触发取消（<code>true</code> = 已取消）</td></tr><tr><td><code>signal.addEventListener('abort', () =&gt; {})</code></td><td>监听信号的“取消事件”（自定义异步操作时需用到）</td></tr><tr><td><code>signal.reason</code></td><td>只读属性：获取 <code>abort(reason)</code> 传递的取消原因（默认 <code>undefined</code>）</td></tr></tbody></table>
<h2 data-id="heading-5">三、核心特性与进阶用法</h2>
<h3 data-id="heading-6">1. 信号的“一次性”特性</h3>
<p><code>AbortSignal</code> 一旦被触发（<code>controller.abort()</code> 调用后），状态会永久变为 <code>aborted: true</code>，无法重置。若需再次取消异步操作，必须<strong>重新创建 <code>AbortController</code> 和信号</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例：信号触发后复用</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;

controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 首次取消，signal.aborted = true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(signal.<span class="hljs-property">aborted</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 再次调用 abort() 无效，信号状态不会改变</span>
controller.<span class="hljs-title function_">abort</span>(<span class="hljs-string">'再次取消'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(signal.<span class="hljs-property">reason</span>); <span class="hljs-comment">// undefined（仍为第一次的默认原因）</span>

<span class="hljs-comment">// 正确做法：重新创建控制器和信号</span>
<span class="hljs-keyword">const</span> newController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
newController.<span class="hljs-title function_">abort</span>(<span class="hljs-string">'新的取消原因'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newController.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newController.<span class="hljs-property">signal</span>.<span class="hljs-property">reason</span>); <span class="hljs-comment">// "新的取消原因"</span>
</code></pre>
<h3 data-id="heading-7">2. 传递取消原因</h3>
<p>调用 <code>abort()</code> 时可传递任意类型的“取消原因”（字符串、对象等），通过 <code>signal.reason</code> 读取，便于调试或业务逻辑处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;

<span class="hljs-comment">// 监听取消事件，读取原因</span>
signal.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'abort'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'取消原因：'</span>, signal.<span class="hljs-property">reason</span>); <span class="hljs-comment">// { code: 400, msg: '用户主动取消' }</span>
});

<span class="hljs-comment">// 传递对象类型的取消原因</span>
controller.<span class="hljs-title function_">abort</span>({ <span class="hljs-attr">code</span>: <span class="hljs-number">400</span>, <span class="hljs-attr">msg</span>: <span class="hljs-string">'用户主动取消'</span> });
</code></pre>
<h3 data-id="heading-8">3. 信号合并（<code>AbortSignal.any()</code>）</h3>
<p><code>AbortSignal.any()</code> 可将多个信号合并为一个“复合信号”，<strong>任意一个原始信号触发取消，复合信号就会触发取消</strong>，适用于“多个条件触发取消”的场景（如“超时 + 用户手动取消”）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：同时支持“超时取消”和“用户手动取消”</span>
<span class="hljs-keyword">const</span> userController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>(); <span class="hljs-comment">// 用户手动取消控制器</span>
<span class="hljs-keyword">const</span> timeoutController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>(); <span class="hljs-comment">// 超时取消控制器</span>

<span class="hljs-comment">// 合并两个信号：任意一个触发，复合信号就触发</span>
<span class="hljs-keyword">const</span> combinedSignal = <span class="hljs-title class_">AbortSignal</span>.<span class="hljs-title function_">any</span>([
  userController.<span class="hljs-property">signal</span>,
  timeoutController.<span class="hljs-property">signal</span>
]);

<span class="hljs-comment">// 5 秒后自动触发超时取消</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  timeoutController.<span class="hljs-title function_">abort</span>(<span class="hljs-string">'请求超时（5秒）'</span>);
}, <span class="hljs-number">5000</span>);

<span class="hljs-comment">// 关联复合信号到 fetch</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/slow-data'</span>, { <span class="hljs-attr">signal</span>: combinedSignal })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'取消原因：'</span>, combinedSignal.<span class="hljs-property">reason</span>);
      <span class="hljs-comment">// 可能输出："请求超时（5秒）" 或 "用户手动取消"</span>
    }
  });

<span class="hljs-comment">// 用户点击按钮触发手动取消</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'cancelBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  userController.<span class="hljs-title function_">abort</span>(<span class="hljs-string">'用户手动取消'</span>);
});
</code></pre>
<h3 data-id="heading-9">4. 预定义信号（<code>AbortSignal.timeout()</code>）</h3>
<p><code>AbortSignal.timeout(ms)</code> 是 ES2022 新增的静态方法，可直接创建一个“超时自动取消”的信号，无需手动创建 <code>AbortController</code>，简化超时取消逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：3 秒后自动取消 fetch 请求</span>
<span class="hljs-keyword">const</span> timeoutSignal = <span class="hljs-title class_">AbortSignal</span>.<span class="hljs-title function_">timeout</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 3 秒超时</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/slow-data'</span>, { <span class="hljs-attr">signal</span>: timeoutSignal })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求超时被取消'</span>); <span class="hljs-comment">// 3 秒后触发</span>
    }
  });
</code></pre>
<h2 data-id="heading-10">四、AbortSignal 的常用场景</h2>
<p><code>AbortSignal</code> 几乎可用于所有异步操作的取消，以下是实际开发中最高频的场景：</p>
<h3 data-id="heading-11">1. 取消 fetch/axios 请求</h3>
<p>这是最常见的场景，用于中断未完成的网络请求（如用户切换页面、搜索框输入防抖时取消之前的请求）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 搜索框防抖：输入时取消之前的请求</span>
<span class="hljs-keyword">let</span> controller;

<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'searchInput'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-keyword">async</span> (e) =&gt; {
  <span class="hljs-keyword">const</span> keyword = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
  <span class="hljs-keyword">if</span> (!keyword) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 取消上一次未完成的请求</span>
  <span class="hljs-keyword">if</span> (controller) controller.<span class="hljs-title function_">abort</span>();

  <span class="hljs-comment">// 新建控制器和信号</span>
  controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  <span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/search?keyword=<span class="hljs-subst">${keyword}</span>`</span>, { signal });
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索结果：'</span>, data);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'搜索失败：'</span>, err);
    }
  }
});
</code></pre>
<h3 data-id="heading-12">2. 取消定时器/延时任务</h3>
<p>原生 <code>setTimeout</code>/<code>setInterval</code> 不直接支持 <code>AbortSignal</code>，但可通过监听信号的 <code>abort</code> 事件实现取消：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：取消一个 3 秒后执行的定时器</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;

<span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器执行'</span>);
}, <span class="hljs-number">3000</span>);

<span class="hljs-comment">// 监听信号取消，清理定时器</span>
signal.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'abort'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-built_in">clearTimeout</span>(timer);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器被取消'</span>);
});

<span class="hljs-comment">// 触发取消（比如 1 秒后取消）</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>();
}, <span class="hljs-number">1000</span>);
</code></pre>
<h3 data-id="heading-13">3. 自定义异步操作取消</h3>
<p>对于自定义的异步函数（如文件读取、数据处理），可通过监听 <code>signal.abort</code> 事件实现取消，并清理资源：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自定义异步函数：模拟耗时数据处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">data, { signal }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 若信号已取消，直接拒绝</span>
    <span class="hljs-keyword">if</span> (signal.<span class="hljs-property">aborted</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMException</span>(<span class="hljs-string">'操作已取消'</span>, <span class="hljs-string">'AbortError'</span>));
    }

    <span class="hljs-comment">// 监听取消事件：清理资源并拒绝 Promise</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">abortHandler</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 清理耗时操作的资源（如终止计算、关闭文件流）</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清理资源，取消数据处理'</span>);
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMException</span>(signal.<span class="hljs-property">reason</span> || <span class="hljs-string">'操作已取消'</span>, <span class="hljs-string">'AbortError'</span>));
    };
    signal.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'abort'</span>, abortHandler, { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// once: true 避免重复触发</span>

    <span class="hljs-comment">// 模拟耗时处理（2 秒）</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> result = data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item * <span class="hljs-number">2</span>);
      signal.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'abort'</span>, abortHandler); <span class="hljs-comment">// 处理完成，移除监听</span>
      <span class="hljs-title function_">resolve</span>(result);
    }, <span class="hljs-number">2000</span>);
  });
}

<span class="hljs-comment">// 使用自定义函数并取消</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-title function_">processData</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'处理结果：'</span>, res))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据处理被取消：'</span>, err.<span class="hljs-property">message</span>);
    }
  });

<span class="hljs-comment">// 1 秒后取消</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>(<span class="hljs-string">'用户终止处理'</span>);
}, <span class="hljs-number">1000</span>);
</code></pre>
<h3 data-id="heading-14">4. 批量取消多个异步任务</h3>
<p>一个 <code>AbortSignal</code> 可关联多个异步操作，调用 <code>abort()</code> 时会一次性取消所有关联任务，适用于“批量清理”场景（如页面卸载时取消所有未完成的请求和定时器）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：页面卸载时取消所有异步任务</span>
<span class="hljs-keyword">const</span> globalController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> globalSignal = globalController.<span class="hljs-property">signal</span>;

<span class="hljs-comment">// 关联任务 1：fetch 请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data1'</span>, { <span class="hljs-attr">signal</span>: globalSignal });
<span class="hljs-comment">// 关联任务 2：fetch 请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data2'</span>, { <span class="hljs-attr">signal</span>: globalSignal });
<span class="hljs-comment">// 关联任务 3：自定义异步函数</span>
<span class="hljs-title function_">processData</span>([<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>], { <span class="hljs-attr">signal</span>: globalSignal });

<span class="hljs-comment">// 页面卸载时，批量取消所有任务</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  globalController.<span class="hljs-title function_">abort</span>(<span class="hljs-string">'页面卸载，取消所有异步任务'</span>);
});
</code></pre>
<h2 data-id="heading-15">五、注意事项与避坑指南</h2>
<h3 data-id="heading-16">1. 信号一旦触发，无法复用</h3>
<p>如前文所述，<code>AbortSignal</code> 是“一次性”的，触发 <code>abort()</code> 后状态永久为 <code>aborted: true</code>。若需再次执行异步操作，必须重新创建 <code>AbortController</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 正确做法：每次异步操作都创建新的控制器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  <span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>;
  <span class="hljs-keyword">const</span> request = <span class="hljs-title function_">fetch</span>(url, { signal });
  <span class="hljs-comment">// 返回请求和取消方法</span>
  <span class="hljs-keyword">return</span> { request, <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>() };
}

<span class="hljs-comment">// 第一次请求</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">request</span>: req1, <span class="hljs-attr">cancel</span>: cancel1 } = <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'/api/1'</span>);
<span class="hljs-comment">// 取消第一次请求</span>
<span class="hljs-title function_">cancel1</span>();

<span class="hljs-comment">// 第二次请求（新的控制器和信号）</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">request</span>: req2, <span class="hljs-attr">cancel</span>: cancel2 } = <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'/api/2'</span>);
</code></pre>
<h3 data-id="heading-17">2. fetch 取消会抛出 <code>AbortError</code>，必须捕获</h3>
<p><code>fetch</code> 接收 <code>signal</code> 后，若信号触发取消，会立即抛出 <code>AbortError</code>（属于 <code>DOMException</code>），若不捕获会导致控制台报错：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 正确示例：捕获 AbortError</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>, { signal })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">'AbortError'</span>) {
      <span class="hljs-comment">// 预期的取消，无需处理</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 其他错误（网络错误、404 等），需要处理</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, err);
    }
  });
</code></pre>
<h3 data-id="heading-18">3. 自定义异步函数需手动清理资源</h3>
<p>原生 API（如 <code>fetch</code>）已内置 <code>AbortSignal</code> 支持，但自定义异步函数需手动监听 <code>abort</code> 事件，清理资源（如定时器、文件流、计算任务）并拒绝 Promise，否则可能导致内存泄漏。</p>
<h3 data-id="heading-19">4. 兼容性</h3>
<p>现代浏览器（Chrome 66+、Firefox 60+、Safari 12.1+、Edge 79+）均支持 <code>AbortSignal</code> 和 <code>AbortController</code>，IE 完全不支持。若需兼容老旧浏览器，可使用 <code>abortcontroller-polyfill</code> 进行兼容。</p>
<h2 data-id="heading-20">六、总结</h2>
<p><code>AbortSignal</code> 是前端异步取消的“标准解决方案”，核心价值在于：</p>
<ul>
<li><strong>统一API</strong>：无需为不同异步操作设计单独的取消逻辑；</li>
<li><strong>原生支持</strong>：直接兼容 <code>fetch</code> 等原生异步 API，无需额外封装；</li>
<li><strong>高效可靠</strong>：信号触发后立即中断异步操作，避免无效资源消耗；</li>
<li><strong>灵活扩展</strong>：支持信号合并、传递取消原因，满足复杂场景需求。</li>
</ul>
<p>在网络请求防抖、页面卸载清理、异步任务超时控制等场景中，<code>AbortSignal</code> 能大幅简化代码，提升应用性能和用户体验，是现代前端开发中不可或缺的原生 API。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手实现 Gin + Socket.IO 实时聊天功能]]></title>    <link>https://juejin.cn/post/7588365276192030758</link>    <guid>https://juejin.cn/post/7588365276192030758</guid>    <pubDate>2025-12-29T02:10:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588365276192030758" data-draft-id="7588711557499125810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手实现 Gin + Socket.IO 实时聊天功能"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-29T02:10:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="啊哈灵机一动"/> <meta itemprop="url" content="https://juejin.cn/user/4188468930154890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手实现 Gin + Socket.IO 实时聊天功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4188468930154890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    啊哈灵机一动
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:10:30.000Z" title="Mon Dec 29 2025 02:10:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手实现 Gin + Socket.IO 实时聊天功能</h2>
<p>在 Web 开发中，实时通信场景（如在线聊天、实时通知、协同编辑等）十分常见，而 Socket.IO 作为一款成熟的实时通信库，支持 WebSocket 协议并提供轮询降级方案，能很好地兼容各类浏览器和场景。本文将手把手教你使用 Go 语言的 Gin 框架整合 Socket.IO，搭建一套完整的前后端实时聊天系统，包含房间广播、跨域处理、静态资源托管等核心功能。</p>
<h3 data-id="heading-1">一、项目准备</h3>
<h4 data-id="heading-2">1. 技术栈说明</h4>
<ul>
<li><strong>后端</strong>：Go 1.18+、Gin 框架（轻量高性能 HTTP 框架）、googollee/go-socket.io（Socket.IO Go 服务端实现）</li>
<li><strong>前端</strong>：原生 JavaScript、Socket.IO 客户端（兼容服务端版本）</li>
<li><strong>运行环境</strong>：Windows/Linux/Mac（本文以 Windows 为例，跨平台无差异）</li>
</ul>
<h4 data-id="heading-3">2. 项目目录结构</h4>
<p>先搭建规范的项目目录，便于后续开发和维护：</p>
<p>plaintext</p>
<pre><code class="hljs language-arduino" lang="arduino">chat-demo/
├── go.mod       <span class="hljs-comment">// Go 模块依赖配置</span>
├── main.go      <span class="hljs-comment">// 后端核心代码</span>
└── <span class="hljs-type">static</span>/      <span class="hljs-comment">// 前端静态资源目录</span>
    ├── index.html       <span class="hljs-comment">// 前端聊天页面</span>
    ├── jquery<span class="hljs-number">-3.6</span><span class="hljs-number">.0</span>.min.js  <span class="hljs-comment">// jQuery（可选，本文未实际依赖）</span>
    ├── socket.io<span class="hljs-number">-1.2</span><span class="hljs-number">.0</span>.js   <span class="hljs-comment">// Socket.IO 客户端</span>
    └── favicon.ico      <span class="hljs-comment">// 网站图标（可选）</span>
</code></pre>
<h4 data-id="heading-4">3. 初始化 Go 模块</h4>
<p>打开终端，进入项目目录，执行以下命令初始化 Go 模块：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp">go mod <span class="hljs-keyword">init</span> chat-demo
</code></pre>
<p>然后安装所需依赖：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Gin 框架</span>
go get github.com/gin-gonic/gin
<span class="hljs-comment"># 安装 Socket.IO Go 服务端</span>
go get github.com/googollee/go-socket.io
</code></pre>
<h3 data-id="heading-5">二、后端实现：Gin + Socket.IO 服务搭建</h3>
<p>后端核心功能包括：Gin 引擎配置、跨域处理、静态资源托管、Socket.IO 服务初始化、房间管理与消息广播。</p>
<h4 data-id="heading-6">1. 完整后端代码（main.go）</h4>
<p>go</p>
<p>运行</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"github.com/gin-gonic/gin"</span>
	socketio <span class="hljs-string">"github.com/googollee/go-socket.io"</span>
	<span class="hljs-string">"github.com/googollee/go-socket.io/engineio"</span>
	<span class="hljs-string">"github.com/googollee/go-socket.io/engineio/transport"</span>
	<span class="hljs-string">"github.com/googollee/go-socket.io/engineio/transport/polling"</span>
	<span class="hljs-string">"github.com/googollee/go-socket.io/engineio/transport/websocket"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"net/http"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 1. Gin 引擎优化：生产环境启用 Release 模式，关闭调试日志</span>
	gin.SetMode(gin.ReleaseMode)
	router := gin.Default()

	<span class="hljs-comment">// 2. 跨域中间件配置：解决前后端跨域通信问题</span>
	router.Use(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
		<span class="hljs-comment">// 允许所有来源跨域（生产环境可指定具体域名，更安全）</span>
		c.Writer.Header().Set(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>)
		<span class="hljs-comment">// 允许的 HTTP 请求方法</span>
		c.Writer.Header().Set(<span class="hljs-string">"Access-Control-Allow-Methods"</span>, <span class="hljs-string">"GET, POST, PUT, DELETE, OPTIONS"</span>)
		<span class="hljs-comment">// 允许的请求头</span>
		c.Writer.Header().Set(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type, Authorization"</span>)
		<span class="hljs-comment">// 处理 OPTIONS 预检请求</span>
		<span class="hljs-keyword">if</span> c.Request.Method == <span class="hljs-string">"OPTIONS"</span> {
			c.AbortWithStatus(http.StatusOK)
			<span class="hljs-keyword">return</span>
		}
		c.Next()
	})

	<span class="hljs-comment">// 3. 静态资源托管：映射 static 目录，提供前端页面和静态文件</span>
	router.Static(<span class="hljs-string">"/static"</span>, <span class="hljs-string">"./static"</span>)

	<span class="hljs-comment">// 4. Socket.IO 服务器配置：支持 polling（轮询）和 websocket（优先推荐）</span>
	sio := socketio.NewServer(&amp;engineio.Options{
		Transports: []transport.Transport{
			polling.Default,
			websocket.Default,
		},
	})

	<span class="hljs-comment">// 5. Socket.IO 事件监听：处理连接、消息、加入房间、断开连接等事件</span>
	<span class="hljs-comment">// 5.1 客户端连接事件</span>
	sio.OnConnect(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s socketio.Conn)</span></span> <span class="hljs-type">error</span> {
		log.Println(<span class="hljs-string">"客户端已连接:"</span>, s.ID())
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})

	<span class="hljs-comment">// 5.2 接收客户端发送的消息事件，并广播到 chat 房间</span>
	sio.OnEvent(<span class="hljs-string">"/"</span>, <span class="hljs-string">"message"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s socketio.Conn, msg <span class="hljs-type">string</span>)</span></span> {
		log.Println(<span class="hljs-string">"收到消息:"</span>, msg, <span class="hljs-string">"(来自:"</span>, s.ID(), <span class="hljs-string">")"</span>)
		<span class="hljs-comment">// 广播消息到 / 命名空间下的 chat 房间</span>
		sio.BroadcastToRoom(<span class="hljs-string">"/"</span>, <span class="hljs-string">"chat"</span>, <span class="hljs-string">"message"</span>, msg)
	})

	<span class="hljs-comment">// 5.3 客户端加入房间事件</span>
	sio.OnEvent(<span class="hljs-string">"/"</span>, <span class="hljs-string">"join"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s socketio.Conn, room <span class="hljs-type">string</span>)</span></span> {
		<span class="hljs-comment">// 让当前客户端加入指定房间</span>
		s.Join(room)
		log.Println(<span class="hljs-string">"客户端"</span>, s.ID(), <span class="hljs-string">"已加入房间："</span>, room)
	})

	<span class="hljs-comment">// 5.4 客户端断开连接事件</span>
	sio.OnDisconnect(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s socketio.Conn, reason <span class="hljs-type">string</span>)</span></span> {
		log.Println(<span class="hljs-string">"客户端"</span>, s.ID(), <span class="hljs-string">"已断开连接;原因:"</span>, reason)
	})

	<span class="hljs-comment">// 5.5 错误处理事件</span>
	sio.OnError(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s socketio.Conn, e <span class="hljs-type">error</span>)</span></span> {
		log.Println(<span class="hljs-string">"客户端"</span>, s.ID(), <span class="hljs-string">"发生错误:"</span>, e)
	})

	<span class="hljs-comment">// 6. 注册 Socket.IO 路由：将 Socket.IO 请求委托给 Gin 处理</span>
	router.GET(<span class="hljs-string">"/socket.io/*any"</span>, gin.WrapH(sio))
	router.POST(<span class="hljs-string">"/socket.io/*any"</span>, gin.WrapH(sio))

	<span class="hljs-comment">// 7. 根路径路由：访问 http://127.0.0.1:8080/ 直接返回前端聊天页面</span>
	router.GET(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
		c.File(<span class="hljs-string">"./static/index.html"</span>)
	})

	<span class="hljs-comment">// 8. 启动 Socket.IO 服务器（异步启动，不阻塞 Gin 启动）</span>
	<span class="hljs-keyword">go</span> sio.Serve()
	<span class="hljs-keyword">defer</span> sio.Close() <span class="hljs-comment">// 程序退出时关闭 Socket.IO 服务</span>

	<span class="hljs-comment">// 9. 启动 Gin 服务器，监听 8080 端口</span>
	<span class="hljs-keyword">if</span> err := router.Run(<span class="hljs-string">":8080"</span>); err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"服务器启动失败: %v"</span>, err)
	}
}
</code></pre>
<h4 data-id="heading-7">2. 后端核心功能说明</h4>
<ul>
<li>
<p><strong>Gin 优化</strong>：启用 <code>gin.ReleaseMode</code> 关闭调试日志，提升服务性能，适合生产环境部署。</p>
</li>
<li>
<p><strong>跨域处理</strong>：通过自定义中间件设置 CORS 响应头，处理 OPTIONS 预检请求，解决前后端跨域通信障碍。</p>
</li>
<li>
<p><strong>静态资源托管</strong>：通过 <code>router.Static</code> 将 <code>./static</code> 目录映射到 <code>/static</code> 路由，前端可通过该路径访问 JS、图片等静态资源。</p>
</li>
<li>
<p><strong>Socket.IO 配置</strong>：同时支持 <code>polling</code> 和 <code>websocket</code> 传输方式，<code>websocket</code> 为高性能全双工通信，<code>polling</code> 作为降级方案兼容低版本浏览器。</p>
</li>
<li>
<p><strong>事件处理</strong>：</p>
<ul>
<li><code>OnConnect</code>：监听客户端连接，打印客户端唯一 ID；</li>
<li><code>OnEvent("message")</code>：接收客户端消息，并通过 <code>BroadcastToRoom</code> 广播到 <code>chat</code> 房间；</li>
<li><code>OnEvent("join")</code>：处理客户端加入房间请求，通过 <code>s.Join(room)</code> 让客户端加入指定房间；</li>
<li><code>OnDisconnect</code>/<code>OnError</code>：监听客户端断开连接和错误事件，便于问题排查和日志监控。</li>
</ul>
</li>
<li>
<p><strong>路由配置</strong>：根路径 <code>/</code> 直接返回前端 <code>index.html</code>，无需手动拼接静态资源路径，使用更便捷；Socket.IO 路由注册后，可处理前端的 Socket.IO 连接请求。</p>
</li>
</ul>
<h3 data-id="heading-8">三、前端实现：Socket.IO 客户端与页面交互</h3>
<p>前端核心功能包括：页面布局搭建、Socket.IO 客户端连接、加入房间、消息发送与接收、页面渲染。</p>
<h4 data-id="heading-9">1. 完整前端代码（static/index.html）</h4>
<p>html</p>
<p>预览</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Socket.IO 实时聊天示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引入 jQuery（本文未实际使用，可按需移除） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/jquery-3.6.0.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引入 Socket.IO 客户端库（需与服务端协议兼容） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/socket.io-1.2.0.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 网站图标（可选） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/static/favicon.ico"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/x-icon"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 聊天界面布局：输入框、发送按钮、消息展示区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"message-input"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"send-button"</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messages"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 1. 连接 Socket.IO 服务端</span>
        <span class="hljs-keyword">var</span> socket = <span class="hljs-title function_">io</span>(<span class="hljs-string">'http://127.0.0.1:8080/'</span>, {
            <span class="hljs-attr">transports</span>: [<span class="hljs-string">'websocket'</span>, <span class="hljs-string">'polling'</span>], <span class="hljs-comment">// 优先使用 websocket，降级为 polling</span>
            <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span> <span class="hljs-comment">// 连接超时时间：5 秒</span>
        });

        <span class="hljs-comment">// 2. 监听连接成功事件，连接后立即加入 chat 房间</span>
        socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 发送 join 事件，加入 chat 房间</span>
            socket.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'join'</span>, <span class="hljs-string">'chat'</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'已连接到服务器'</span>);
        });

        <span class="hljs-comment">// 3. 监听服务端广播的 message 事件，渲染消息到页面</span>
        socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">msg</span>) {
            <span class="hljs-keyword">const</span> messagesDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messages'</span>);
            <span class="hljs-keyword">const</span> newMessage = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'p'</span>);
            newMessage.<span class="hljs-property">textContent</span> = msg;
            messagesDiv.<span class="hljs-title function_">appendChild</span>(newMessage);
        });

        <span class="hljs-comment">// 4. 绑定发送按钮点击事件，发送消息到服务端</span>
        <span class="hljs-keyword">const</span> sendButton = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'send-button'</span>);
        <span class="hljs-keyword">const</span> messageInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'message-input'</span>);
        sendButton.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> message = messageInput.<span class="hljs-property">value</span>;
            <span class="hljs-keyword">if</span> (message) {
                <span class="hljs-comment">// 发送 message 事件，携带输入的消息内容</span>
                socket.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'message'</span>, message);
                <span class="hljs-comment">// 清空输入框</span>
                messageInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
            }
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">2. 前端核心功能说明</h4>
<ul>
<li><strong>Socket.IO 连接</strong>：通过 <code>io()</code> 方法连接服务端地址 <code>http://127.0.0.1:8080/</code>，配置传输方式优先级和连接超时时间。</li>
<li><strong>连接成功处理</strong>：监听 <code>connect</code> 事件，连接成功后立即发送 <code>join</code> 事件，加入服务端的 <code>chat</code> 房间，确保能接收房间内的广播消息。</li>
<li><strong>消息接收与渲染</strong>：监听服务端的 <code>message</code> 事件，收到消息后创建 <code>&lt;p&gt;</code> 标签，将消息内容插入到页面的消息展示区域。</li>
<li><strong>消息发送</strong>：绑定按钮点击事件，获取输入框内容，通过 <code>socket.emit('message', message)</code> 发送到服务端，发送后清空输入框，提升交互体验。</li>
</ul>
<h3 data-id="heading-11">四、项目运行与测试</h3>
<h4 data-id="heading-12">1. 启动服务</h4>
<ol>
<li>
<p>将前端文件（<code>index.html</code>、<code>socket.io-1.2.0.js</code> 等）放入 <code>static</code> 目录；</p>
</li>
<li>
<p>在项目目录终端执行以下命令启动后端服务：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span>
</code></pre>
</li>
<li>
<p>服务启动成功后，终端会打印日志，监听端口为 <code>8080</code>。</p>
</li>
</ol>
<h4 data-id="heading-13">2. 测试步骤</h4>
<ol>
<li>打开多个浏览器窗口（或不同浏览器），访问 <code>http://127.0.0.1:8080/</code>；</li>
<li>在任意一个窗口的输入框中输入消息，点击「发送」按钮；</li>
<li>观察其他窗口，会实时收到该消息，实现多客户端实时聊天功能；</li>
<li>查看后端终端，可看到客户端连接、加入房间、接收消息、断开连接等日志信息。</li>
</ol>
<h3 data-id="heading-14">五、常见问题与优化建议</h3>
<h4 data-id="heading-15">1. 常见问题排查</h4>
<ul>
<li><strong>前后端无法通信</strong>：大概率是 Socket.IO 客户端与服务端版本不兼容，建议客户端使用 1.x 或 2.x 版本，与 <code>googollee/go-socket.io</code> 保持协议兼容；</li>
<li><strong>跨域报错</strong>：检查后端跨域中间件配置，确保 <code>Access-Control-Allow-Origin</code> 配置正确，生产环境建议指定具体域名而非 <code>*</code>；</li>
<li><strong>无法接收广播消息</strong>：确认前端已发送 <code>join</code> 事件加入 <code>chat</code> 房间，服务端广播时指定了正确的命名空间和房间名。</li>
</ul>
<h4 data-id="heading-16">2. 优化建议</h4>
<ul>
<li><strong>性能优化</strong>：后端可调整 Socket.IO 传输方式优先级，优先使用 <code>websocket</code>；Gin 框架可自定义 <code>http.Server</code> 配置，优化 TCP 连接复用和并发处理能力；</li>
<li><strong>体验优化</strong>：前端可添加回车键发送消息、消息区分发送者与接收者、自动滚动到最新消息等功能；</li>
<li><strong>安全优化</strong>：生产环境中，跨域配置指定具体域名，添加身份验证（如 Token 验证），防止非法客户端连接；</li>
<li><strong>部署优化</strong>：可将静态资源部署到 CDN，提升前端加载速度；后端可使用进程管理工具（如 supervisor）保障服务稳定运行。</li>
</ul>
<h3 data-id="heading-17">六、总结</h3>
<p>本文通过 Gin 框架与 Socket.IO 的整合，实现了一套完整的前后端实时聊天系统，核心亮点如下：</p>
<ol>
<li>后端完成了跨域处理、静态资源托管、Socket.IO 事件监听与房间广播；</li>
<li>前端实现了 Socket.IO 连接、房间加入、消息发送与接收渲染；</li>
<li>项目结构清晰，代码可直接复用，支持多客户端实时通信，可扩展为在线客服、实时通知等场景。</li>
</ol>
<p>通过本文的实战，你不仅能掌握 Gin 与 Socket.IO 的使用方法，还能理解实时通信的核心原理，为后续复杂实时系统的开发打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 React Context 实现全局主题切换：从零搭建暗黑/亮色模式系统]]></title>    <link>https://juejin.cn/post/7588507284953448463</link>    <guid>https://juejin.cn/post/7588507284953448463</guid>    <pubDate>2025-12-29T02:21:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588507284953448463" data-draft-id="7588456115883065379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 React Context 实现全局主题切换：从零搭建暗黑/亮色模式系统"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2025-12-29T02:21:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yira"/> <meta itemprop="url" content="https://juejin.cn/user/262123324974122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 React Context 实现全局主题切换：从零搭建暗黑/亮色模式系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/262123324974122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yira
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:21:02.000Z" title="Mon Dec 29 2025 02:21:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 React Context 实现全局主题切换：从零搭建暗黑/亮色模式系统</h2>
<p>在现代 Web 应用中，<strong>主题切换</strong>（如白天/夜间模式）已成为提升用户体验的标配功能。用户希望界面能随环境光线自动适应，或按个人偏好自由切换。然而，如何在 React 应用中高效、优雅地实现这一功能？答案就是：<strong>React Context + 自定义 Provider 封装</strong>。</p>
<p>本文将带你从零开始，手把手构建一个完整的主题管理系统，涵盖状态共享、UI 响应、持久化存储等核心环节，并深入解析其背后的设计思想与最佳实践。</p>
<hr/>
<h3 data-id="heading-1">一、为什么需要 Context？告别“Props Drilling”之痛</h3>
<p>假设我们想在应用顶部放一个“切换主题”按钮，而底部某个卡片组件需要根据主题改变背景色。若使用传统 props 传递：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">{theme}</span> <span class="hljs-attr">toggleTheme</span>=<span class="hljs-string">{toggleTheme}</span>&gt;</span>
  → <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">{theme}</span> <span class="hljs-attr">toggleTheme</span>=<span class="hljs-string">{toggleTheme}</span>&gt;</span>
    → <span class="hljs-tag">&lt;<span class="hljs-name">Content</span>&gt;</span>
      → <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">{theme}</span> /&gt;</span>
</code></pre>
<p>每一层组件都必须接收并透传 <code>theme</code> 和 <code>toggleTheme</code>，即使它们自身并不使用。这种 <strong>“属性层层透传”</strong> （Props Drilling）不仅代码冗余，还导致组件耦合度高、难以维护。</p>
<p><strong>React Context 正是为解决此类跨层级状态共享问题而生</strong>。它提供了一种机制：</p>
<blockquote>
<p><strong>父组件创建一个“数据广播站”，所有后代组件都能直接“收听”，无需中间人传话。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、核心架构：三大组件协同工作</h3>
<p>我们的主题系统由三个关键部分组成：</p>
<h4 data-id="heading-3">1. <code>ThemeContext</code>：数据通道</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// contexts/ThemeContext.js</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);
</code></pre>
<ul>
<li>使用 <code>createContext(null)</code> 创建一个全局可访问的上下文对象；</li>
<li><code>null</code> 是默认值，当组件未被 Provider 包裹时返回。</li>
</ul>
<h4 data-id="heading-4">2. <code>ThemeProvider</code>：状态管理 + 数据广播</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// contexts/ThemeContext.js (续)</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'light'</span>);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
  };

  <span class="hljs-comment">// 关键：同步主题到 HTML 根元素</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-theme'</span>, theme);
  }, [theme]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">toggleTheme</span> }}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><strong>状态管理</strong>：用 <code>useState</code> 维护当前主题（<code>'light'</code> 或 <code>'dark'</code>）；</li>
<li><strong>操作封装</strong>：<code>toggleTheme</code> 函数封装切换逻辑；</li>
<li><strong>DOM 同步</strong>：通过 <code>useEffect</code> 将主题写入 <code>&lt;html data-theme="dark"&gt;</code>，便于 CSS 选择器响应。</li>
</ul>
<h4 data-id="heading-5">3. <code>Header</code>：消费主题状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// components/Header.js</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../contexts/ThemeContext'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme, toggleTheme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">24</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>当前主题: {theme}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span>&gt;</span>切换主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li>使用 <code>useContext(ThemeContext)</code> 直接获取主题状态和切换函数；</li>
<li><strong>完全解耦</strong>：无需父组件传递 props，无论嵌套多深都能访问。</li>
</ul>
<hr/>
<h3 data-id="heading-6">三、应用组装：自上而下的数据流</h3>
<h4 data-id="heading-7">根组件 <code>App</code>：启动主题服务</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ThemeProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./contexts/ThemeContext'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Page</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Pages/Page'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Page</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li>用 <code>&lt;ThemeProvider&gt;</code> 包裹整个应用，确保所有子组件处于主题上下文中。</li>
</ul>
<h4 data-id="heading-8">页面组件 <code>Page</code>：透明中转</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Pages/Page.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/Header'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">24</span> }}&gt;</span>
      Page
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><code>Page</code> 无需知道主题存在，直接渲染 <code>Header</code>，实现<strong>零耦合</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-9">四、CSS 如何响应主题变化？</h3>
<p>虽然你的示例未使用 Tailwind，但原理相通。关键在于 <strong>利用 <code>data-theme</code> 属性编写条件样式</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 全局样式 */</span>
<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">background-color</span>: white;
  <span class="hljs-attribute">color</span>: black;
}

<span class="hljs-comment">/* 暗色模式覆盖 */</span>
<span class="hljs-selector-tag">html</span><span class="hljs-selector-attr">[data-theme=<span class="hljs-string">'dark'</span>]</span> <span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#1a1a1a</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#e0e0e0</span>;
}

<span class="hljs-comment">/* 组件级样式 */</span>
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
}

<span class="hljs-selector-tag">html</span><span class="hljs-selector-attr">[data-theme=<span class="hljs-string">'dark'</span>]</span> <span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2d2d2d</span>;
}
</code></pre>
<blockquote>
<p>✅ 优势：</p>
<ul>
<li>不依赖 JavaScript 动态设置 class；</li>
<li>样式集中管理，易于维护；</li>
<li>支持服务端渲染（SSR）。</li>
</ul>
</blockquote>
<p>若使用 <strong>Tailwind CSS</strong>，只需配置 <code>darkMode: 'class'</code>，然后写：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-white dark:bg-gray-900 text-black dark:text-white"</span>&gt;
</code></pre>
<p>并通过 JS 切换 <code>&lt;html class="dark"&gt;</code> 即可。</p>
<hr/>
<h3 data-id="heading-10">五、进阶优化：持久化用户偏好</h3>
<p>当前实现刷新后会重置为 <code>'light'</code>。要记住用户选择，只需两步：</p>
<h4 data-id="heading-11">1. 初始化时读取 localStorage</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'theme'</span>) || <span class="hljs-string">'light'</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">'light'</span>;
});
</code></pre>
<h4 data-id="heading-12">2. 切换时保存到 localStorage</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">toggleTheme</span> = () =&gt; {
  const <span class="hljs-attr">newTheme</span> = theme === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span><span class="hljs-comment">;</span>
  setTheme(newTheme)<span class="hljs-comment">;</span>
  localStorage.setItem('theme', newTheme)<span class="hljs-comment">; // 👈 保存</span>
}<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>💡 注意：需判断 <code>window</code> 是否存在，避免 SSR 报错。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">六、设计思想：为什么这样封装？</h3>
<h4 data-id="heading-14">1. <strong>单一职责原则</strong></h4>
<ul>
<li><code>ThemeContext</code>：只负责创建通道；</li>
<li><code>ThemeProvider</code>：只负责状态管理与广播；</li>
<li><code>Header</code>：只负责 UI 展示与交互。</li>
</ul>
<h4 data-id="heading-15">2. <strong>高内聚低耦合</strong></h4>
<ul>
<li>中间组件（如 <code>Page</code>）完全 unaware 主题存在；</li>
<li>新增组件只需调用 <code>useContext</code>，无需修改父组件。</li>
</ul>
<h4 data-id="heading-16">3. <strong>可复用性</strong></h4>
<ul>
<li><code>ThemeProvider</code> 可直接复制到新项目；</li>
<li>配合自定义 Hook（如 <code>useTheme()</code>）进一步简化调用。</li>
</ul>
<hr/>
<h3 data-id="heading-17">七、常见陷阱与解决方案</h3>






























<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>useContext</code> 返回 <code>null</code></td><td>组件未被 Provider 包裹</td><td>确保根组件正确包裹</td></tr><tr><td>切换无效</td><td>CSS 未响应 <code>data-theme</code></td><td>检查选择器优先级</td></tr><tr><td>SSR 不一致</td><td>客户端/服务端初始状态不同</td><td>在 <code>useEffect</code> 中初始化状态</td></tr><tr><td>性能问题</td><td>高频更新导致重渲染</td><td>拆分 Context，避免大对象</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">八、总结：Context 是 React 的“神经系统”</h3>
<p>通过这个主题切换案例，我们看到：</p>
<ul>
<li><strong>Context 不是“传数据”，而是“建通道”</strong> ；</li>
<li><strong>Provider 是数据源，useContext 是接收器</strong>；</li>
<li><strong>中间组件完全透明，实现极致解耦</strong>。</li>
</ul>
<p>这种模式不仅适用于主题，还可用于：</p>
<ul>
<li>用户登录状态</li>
<li>国际化语言</li>
<li>购物车数据</li>
<li>应用配置</li>
</ul>
<blockquote>
<p><strong>掌握 Context，你就掌握了 React 全局状态管理的第一把钥匙</strong>。</p>
</blockquote>
<p>未来，你可以在此基础上集成 <code>useReducer</code> 管理复杂状态，或结合 Zustand/Jotai 等轻量库进一步简化。但无论如何，<strong>理解 Context 的底层机制，永远是进阶之路的基石</strong>。</p>
<p>现在，打开你的编辑器，亲手实现一个主题切换吧——让用户在白天与黑夜之间，自由穿梭！ 🌓☀️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android和HarmonyOS 设置透明度]]></title>    <link>https://juejin.cn/post/7588456115882786851</link>    <guid>https://juejin.cn/post/7588456115882786851</guid>    <pubDate>2025-12-29T01:44:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588456115882786851" data-draft-id="7588745319400603648" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android和HarmonyOS 设置透明度"/> <meta itemprop="keywords" content="Android,HarmonyOS,APP"/> <meta itemprop="datePublished" content="2025-12-29T01:44:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gemini001"/> <meta itemprop="url" content="https://juejin.cn/user/2333635831676704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android和HarmonyOS 设置透明度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2333635831676704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gemini001
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:44:44.000Z" title="Mon Dec 29 2025 01:44:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android/HarmonyOS 透明度百分比与十六进制值对照表及实现</h2>
<h3 data-id="heading-1">透明度百分比 ↔ 十六进制值 完整对照表</h3>



















































































































































































































































































<table><thead><tr><th>百分比</th><th>十六进制</th><th>百分比</th><th>十六进制</th><th>百分比</th><th>十六进制</th><th>百分比</th><th>十六进制</th></tr></thead><tbody><tr><td>100%</td><td>FF</td><td>75%</td><td>BF</td><td>50%</td><td>80</td><td>25%</td><td>40</td></tr><tr><td>99%</td><td>FC</td><td>74%</td><td>BD</td><td>49%</td><td>7D</td><td>24%</td><td>3D</td></tr><tr><td>98%</td><td>FA</td><td>73%</td><td>BA</td><td>48%</td><td>7A</td><td>23%</td><td>3B</td></tr><tr><td>97%</td><td>F7</td><td>72%</td><td>B8</td><td>47%</td><td>78</td><td>22%</td><td>38</td></tr><tr><td>96%</td><td>F5</td><td>71%</td><td>B5</td><td>46%</td><td>75</td><td>21%</td><td>36</td></tr><tr><td>95%</td><td>F2</td><td>70%</td><td>B3</td><td>45%</td><td>73</td><td>20%</td><td>33</td></tr><tr><td>94%</td><td>F0</td><td>69%</td><td>B0</td><td>44%</td><td>70</td><td>19%</td><td>30</td></tr><tr><td>93%</td><td>ED</td><td>68%</td><td>AD</td><td>43%</td><td>6E</td><td>18%</td><td>2E</td></tr><tr><td>92%</td><td>EB</td><td>67%</td><td>AB</td><td>42%</td><td>6B</td><td>17%</td><td>2B</td></tr><tr><td>91%</td><td>E8</td><td>66%</td><td>A8</td><td>41%</td><td>69</td><td>16%</td><td>29</td></tr><tr><td>90%</td><td>E6</td><td>65%</td><td>A6</td><td>40%</td><td>66</td><td>15%</td><td>26</td></tr><tr><td>89%</td><td>E3</td><td>64%</td><td>A3</td><td>39%</td><td>63</td><td>14%</td><td>24</td></tr><tr><td>88%</td><td>E0</td><td>63%</td><td>A1</td><td>38%</td><td>61</td><td>13%</td><td>21</td></tr><tr><td>87%</td><td>DE</td><td>62%</td><td>9E</td><td>37%</td><td>5E</td><td>12%</td><td>1F</td></tr><tr><td>86%</td><td>DB</td><td>61%</td><td>9C</td><td>36%</td><td>5C</td><td>11%</td><td>1C</td></tr><tr><td>85%</td><td>D9</td><td>60%</td><td>99</td><td>35%</td><td>59</td><td>10%</td><td>1A</td></tr><tr><td>84%</td><td>D6</td><td>59%</td><td>96</td><td>34%</td><td>57</td><td>9%</td><td>17</td></tr><tr><td>83%</td><td>D4</td><td>58%</td><td>94</td><td>33%</td><td>54</td><td>8%</td><td>14</td></tr><tr><td>82%</td><td>D1</td><td>57%</td><td>91</td><td>32%</td><td>52</td><td>7%</td><td>12</td></tr><tr><td>81%</td><td>CF</td><td>56%</td><td>8F</td><td>31%</td><td>4F</td><td>6%</td><td>0F</td></tr><tr><td>80%</td><td>CC</td><td>55%</td><td>8C</td><td>30%</td><td>4D</td><td>5%</td><td>0D</td></tr><tr><td>79%</td><td>C9</td><td>54%</td><td>8A</td><td>29%</td><td>4A</td><td>4%</td><td>0A</td></tr><tr><td>78%</td><td>C7</td><td>53%</td><td>87</td><td>28%</td><td>47</td><td>3%</td><td>08</td></tr><tr><td>77%</td><td>C4</td><td>52%</td><td>85</td><td>27%</td><td>45</td><td>2%</td><td>05</td></tr><tr><td>76%</td><td>C2</td><td>51%</td><td>82</td><td>26%</td><td>42</td><td>1%</td><td>03</td></tr><tr><td/><td/><td/><td/><td/><td/><td>0%</td><td>00</td></tr></tbody></table>
<h3 data-id="heading-2">核心概念</h3>
<ul>
<li><strong>格式</strong>: <code>#AARRGGBB</code>(前两位AA是透明度，后六位是颜色)</li>
<li><strong>100%</strong> : 完全不透明 (FF)</li>
<li><strong>50%</strong> : 半透明 (80)</li>
<li><strong>0%</strong> : 完全透明 (00)</li>
</ul>
<h3 data-id="heading-3">Android 实现 (使用XML)</h3>
<h4 data-id="heading-4">1. 直接在XML中使用</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 直接在View中设置透明度 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">View</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"100dp"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"100dp"</span>
    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"#80FF0000"</span> /&gt;</span>  <span class="hljs-comment">&lt;!-- 50%透明红色 --&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"20%透明文字"</span>
    <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"#33000000"</span> /&gt;</span>    <span class="hljs-comment">&lt;!-- 20%透明黑色 --&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"80%透明按钮"</span>
    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"#CC2196F3"</span> /&gt;</span>   <span class="hljs-comment">&lt;!-- 80%透明蓝色 --&gt;</span>
</code></pre>
<h4 data-id="heading-5">2. 在res/colors.xml中定义</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 完全不透明 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"red"</span>&gt;</span>#FF0000<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"blue"</span>&gt;</span>#0000FF<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"green"</span>&gt;</span>#00FF00<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 50%透明 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"red_50"</span>&gt;</span>#80FF0000<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"blue_50"</span>&gt;</span>#800000FF<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 20%透明 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"black_20"</span>&gt;</span>#33000000<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"white_20"</span>&gt;</span>#33FFFFFF<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 80%透明 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"black_80"</span>&gt;</span>#CC000000<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"white_80"</span>&gt;</span>#CCFFFFFF<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">3. 在布局文件中使用颜色资源</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;LinearLayout
    xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>
    android:<span class="hljs-attr">padding</span>=<span class="hljs-string">"16dp"</span>&gt;
    
    &lt;!-- 50%透明红色背景 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"60dp"</span>
        android:<span class="hljs-attr">background</span>=<span class="hljs-string">"@color/red_50"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"50%透明红色背景"</span>
        android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"#FFFFFF"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">layout_marginBottom</span>=<span class="hljs-string">"8dp"</span>/&gt;
    
    &lt;!-- 20%透明黑色文字 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"20%透明黑色文字"</span>
        android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"@color/black_20"</span>
        android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"18sp"</span>
        android:<span class="hljs-attr">layout_marginBottom</span>=<span class="hljs-string">"8dp"</span>/&gt;
    
    &lt;!-- 80%透明蓝色按钮 --&gt;
    &lt;Button
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"80%透明按钮"</span>
        android:<span class="hljs-attr">background</span>=<span class="hljs-string">"@color/blue_50"</span>
        android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"#FFFFFF"</span>
        android:<span class="hljs-attr">layout_marginBottom</span>=<span class="hljs-string">"8dp"</span>/&gt;
    
    &lt;!-- 不同透明度示例 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"30dp"</span>
        android:<span class="hljs-attr">background</span>=<span class="hljs-string">"#FFFF0000"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"100% 红色"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">layout_marginBottom</span>=<span class="hljs-string">"4dp"</span>/&gt;
    
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"30dp"</span>
        android:<span class="hljs-attr">background</span>=<span class="hljs-string">"#CCFF0000"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"80% 红色"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">layout_marginBottom</span>=<span class="hljs-string">"4dp"</span>/&gt;
    
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"30dp"</span>
        android:<span class="hljs-attr">background</span>=<span class="hljs-string">"#80FF0000"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"50% 红色"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">layout_marginBottom</span>=<span class="hljs-string">"4dp"</span>/&gt;
    
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"30dp"</span>
        android:<span class="hljs-attr">background</span>=<span class="hljs-string">"#33FF0000"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"20% 红色"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">layout_marginBottom</span>=<span class="hljs-string">"4dp"</span>/&gt;
        
&lt;/LinearLayout&gt;
</code></pre>
<h3 data-id="heading-7">HarmonyOS (ArkTS) 实现</h3>
<h4 data-id="heading-8">1. 直接在ArkTS中使用</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct ColorDemo {
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">10</span> }) {
      <span class="hljs-comment">// 50%透明红色</span>
      Text('<span class="hljs-number">50%</span>透明红色')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">60</span>)
        <span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">80</span>FF0000')
        <span class="hljs-selector-class">.fontColor</span>('#FFFFFF')
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
        <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)

      <span class="hljs-comment">// 20%透明黑色文字</span>
      Text('<span class="hljs-number">20%</span>透明黑色文字')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">33000000</span>')
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
        <span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">8</span> })

      <span class="hljs-comment">// 80%透明蓝色按钮</span>
      <span class="hljs-selector-tag">Button</span>('<span class="hljs-number">80%</span>透明按钮')
        <span class="hljs-selector-class">.backgroundColor</span>('#CC2196F3')
        <span class="hljs-selector-class">.fontColor</span>('#FFFFFF')
        <span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">8</span> })

      <span class="hljs-comment">// 不同透明度示例</span>
      Text('<span class="hljs-number">100%</span> 红色')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">30</span>)
        <span class="hljs-selector-class">.backgroundColor</span>('#FFFF0000')
        <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
        <span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">4</span> })

      Text('<span class="hljs-number">80%</span> 红色')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">30</span>)
        <span class="hljs-selector-class">.backgroundColor</span>('#CCFF0000')
        <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
        <span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">4</span> })

      Text('<span class="hljs-number">50%</span> 红色')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">30</span>)
        <span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">80</span>FF0000')
        <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
        <span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">4</span> })

      Text('<span class="hljs-number">20%</span> 红色')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">30</span>)
        <span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">33</span>FF0000')
        <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
        <span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">4</span> })
    }
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">20</span>)
  }
}
</code></pre>
<h4 data-id="heading-9">2. 使用常量定义颜色</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct TransparencyDemo {
  <span class="hljs-comment">// 定义颜色常量</span>
  private readonly COLORS = {
    <span class="hljs-comment">// 不透明颜色</span>
    RED: <span class="hljs-string">'#FF0000'</span>,
    BLUE: <span class="hljs-string">'#0000FF'</span>,
    GREEN: <span class="hljs-string">'#00FF00'</span>,
    BLACK: <span class="hljs-string">'#000000'</span>,
    WHITE: <span class="hljs-string">'#FFFFFF'</span>,
    
    // <span class="hljs-number">50%</span>透明
    RED_50: <span class="hljs-string">'#80FF0000'</span>,
    BLUE_50: <span class="hljs-string">'#800000FF'</span>,
    GREEN_50: <span class="hljs-string">'#8000FF00'</span>,
    
    // <span class="hljs-number">20%</span>透明
    BLACK_20: <span class="hljs-string">'#33000000'</span>,
    WHITE_20: <span class="hljs-string">'#33FFFFFF'</span>,
    
    // <span class="hljs-number">80%</span>透明
    BLACK_80: <span class="hljs-string">'#CC000000'</span>,
    WHITE_80: <span class="hljs-string">'#CCFFFFFF'</span>
  }

  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">8</span> }) {
      <span class="hljs-comment">// 使用常量</span>
      Text('<span class="hljs-number">50%</span>透明红色背景')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)
        <span class="hljs-selector-class">.backgroundColor</span>(this.COLORS.RED_50)
        <span class="hljs-selector-class">.fontColor</span>(this.COLORS.WHITE)
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
        <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)

      Text('<span class="hljs-number">20%</span>透明黑色文字')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.fontColor</span>(this.COLORS.BLACK_20)
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)

      Text('<span class="hljs-number">80%</span>透明背景上的白色文字')
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)
        <span class="hljs-selector-class">.backgroundColor</span>(this.COLORS.BLUE_50)
        <span class="hljs-selector-class">.fontColor</span>(this.COLORS.WHITE_80)
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
        <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
    }
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">20</span>)
  }
}
</code></pre>
<h4 data-id="heading-10">3. 完整示例：透明度对比</h4>
<pre><code class="hljs language-php" lang="php">@Entry
@Component
struct AlphaComparison {
  <span class="hljs-title function_ invoke__">build</span>() {
    <span class="hljs-title function_ invoke__">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">2</span> }) {
      <span class="hljs-comment">// 标题</span>
      <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'透明度对照示例'</span>)
        .<span class="hljs-title function_ invoke__">fontSize</span>(<span class="hljs-number">20</span>)
        .<span class="hljs-title function_ invoke__">fontWeight</span>(FontWeight.Bold)
        .<span class="hljs-title function_ invoke__">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })
        .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_ invoke__">textAlign</span>(TextAlign.Center)

      <span class="hljs-comment">// 红色系列</span>
      this.<span class="hljs-title function_ invoke__">buildColorRow</span>(<span class="hljs-string">'红色'</span>, <span class="hljs-string">'#FF0000'</span>, [
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'FF'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'CC'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'80'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'33'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'00'</span> }
      ])

      <span class="hljs-title function_ invoke__">Divider</span>().<span class="hljs-title function_ invoke__">strokeWidth</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">color</span>(<span class="hljs-string">'#EEEEEE'</span>).<span class="hljs-title function_ invoke__">margin</span>({ <span class="hljs-attr">vertical</span>: <span class="hljs-number">10</span> })

      <span class="hljs-comment">// 蓝色系列</span>
      this.<span class="hljs-title function_ invoke__">buildColorRow</span>(<span class="hljs-string">'蓝色'</span>, <span class="hljs-string">'#0000FF'</span>, [
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'FF'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'CC'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'80'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'33'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'00'</span> }
      ])

      <span class="hljs-title function_ invoke__">Divider</span>().<span class="hljs-title function_ invoke__">strokeWidth</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">color</span>(<span class="hljs-string">'#EEEEEE'</span>).<span class="hljs-title function_ invoke__">margin</span>({ <span class="hljs-attr">vertical</span>: <span class="hljs-number">10</span> })

      <span class="hljs-comment">// 绿色系列</span>
      this.<span class="hljs-title function_ invoke__">buildColorRow</span>(<span class="hljs-string">'绿色'</span>, <span class="hljs-string">'#00FF00'</span>, [
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'FF'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'CC'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'80'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'33'</span> },
        { <span class="hljs-attr">percent</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-string">'00'</span> }
      ])
    }
    .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_ invoke__">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_ invoke__">padding</span>(<span class="hljs-number">20</span>)
  }

  @Builder
  <span class="hljs-title function_ invoke__">buildColorRow</span>(<span class="hljs-attr">colorName</span>: <span class="hljs-keyword">string</span>, <span class="hljs-attr">colorCode</span>: <span class="hljs-keyword">string</span>, <span class="hljs-attr">alphas</span>: Array&lt;{<span class="hljs-attr">percent</span>: number, <span class="hljs-attr">alpha</span>: <span class="hljs-keyword">string</span>}&gt;) {
    <span class="hljs-title function_ invoke__">Column</span>() {
      <span class="hljs-title function_ invoke__">Text</span>(colorName)
        .<span class="hljs-title function_ invoke__">fontSize</span>(<span class="hljs-number">16</span>)
        .<span class="hljs-title function_ invoke__">fontWeight</span>(FontWeight.Bold)
        .<span class="hljs-title function_ invoke__">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">8</span> })
        .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_ invoke__">textAlign</span>(TextAlign.Start)

      <span class="hljs-title function_ invoke__">ForEach</span>(alphas, (<span class="hljs-attr">item</span>: {<span class="hljs-attr">percent</span>: number, <span class="hljs-attr">alpha</span>: <span class="hljs-keyword">string</span>}) =&gt; {
        <span class="hljs-title function_ invoke__">Row</span>() {
          <span class="hljs-title function_ invoke__">Text</span>(`${item.percent}%`)
            .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-number">60</span>)
            .<span class="hljs-title function_ invoke__">fontSize</span>(<span class="hljs-number">14</span>)
          
          <span class="hljs-title function_ invoke__">Text</span>(`#${item.alpha}${colorCode.<span class="hljs-title function_ invoke__">substring</span>(<span class="hljs-number">1</span>)}`)
            .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-number">120</span>)
            .<span class="hljs-title function_ invoke__">fontSize</span>(<span class="hljs-number">12</span>)
            .<span class="hljs-title function_ invoke__">fontColor</span>(<span class="hljs-string">'#666666'</span>)
          
          <span class="hljs-comment">// 颜色块</span>
          <span class="hljs-title function_ invoke__">Row</span>()
            .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-number">100</span>)
            .<span class="hljs-title function_ invoke__">height</span>(<span class="hljs-number">30</span>)
            .<span class="hljs-title function_ invoke__">backgroundColor</span>(`#${item.alpha}${colorCode.<span class="hljs-title function_ invoke__">substring</span>(<span class="hljs-number">1</span>)}`)
            .<span class="hljs-title function_ invoke__">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#CCCCCC'</span> })
        }
        .<span class="hljs-title function_ invoke__">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_ invoke__">justifyContent</span>(FlexAlign.SpaceBetween)
        .<span class="hljs-title function_ invoke__">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">4</span> })
      })
    }
  }
}
</code></pre>
<h3 data-id="heading-11">使用总结</h3>
<h4 data-id="heading-12">Android (XML方式):</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 直接使用十六进制值 --&gt;</span>
android:background="#80FF0000"      <span class="hljs-comment">&lt;!-- 50%透明红色 --&gt;</span>
android:textColor="#33000000"       <span class="hljs-comment">&lt;!-- 20%透明黑色 --&gt;</span>

<span class="hljs-comment">&lt;!-- 或者定义在colors.xml中 --&gt;</span>
android:background="@color/red_50"
android:textColor="@color/black_20"
</code></pre>
<h4 data-id="heading-13">HarmonyOS (ArkTS方式):</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 直接在backgroundColor/textColor中使用</span>
.<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-string">'#80FF0000'</span>)      <span class="hljs-comment">// 50%透明红色</span>
.<span class="hljs-built_in">fontColor</span>(<span class="hljs-string">'#33000000'</span>)            <span class="hljs-comment">// 20%透明黑色</span>
</code></pre>
<h3 data-id="heading-14">常用值速记</h3>
<ul>
<li><strong>100%</strong> ​ → <code>FF</code></li>
<li><strong>80%</strong> ​ → <code>CC</code></li>
<li><strong>50%</strong> ​ → <code>80</code></li>
<li><strong>20%</strong> ​ → <code>33</code></li>
<li><strong>0%</strong> ​ → <code>00</code></li>
</ul>
<p><strong>规律</strong>：每10%大约差19（十六进制），比如90%是E6，80%是CC，70%是B3，60%是99，50%是80。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[国产 OCR 开源神器官网上线了，相当给力。]]></title>    <link>https://juejin.cn/post/7588388014505312298</link>    <guid>https://juejin.cn/post/7588388014505312298</guid>    <pubDate>2025-12-29T02:30:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588388014505312298" data-draft-id="7588445332772438070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="国产 OCR 开源神器官网上线了，相当给力。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-29T02:30:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            国产 OCR 开源神器官网上线了，相当给力。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:30:59.000Z" title="Mon Dec 29 2025 02:30:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大模型狂飙突进的今天，高质量、结构化的数据已成为决定 AI 能力的核心基建。而现实中，海量知识却沉睡在PDF、扫描件、报告等非结构化文档中。</p>
<p>如何将这座富矿高效、精准地转化为大模型可理解、可训练的数据燃料，是整个产业面临的关键瓶颈。</p>
<p>OCR（光学字符识别）技术正是打通这一瓶颈的数据管道。但传统OCR主要停留在「字符识别」层面，面对包含图表、公式、代码以及复杂版式的文档时，往往会产出混乱的文本流，难以支撑后续理解、检索等等需求。</p>
<p>因此，在大模型时代，这一能力已远远不够。一个真正可用的文档解析方案，必须提供端到端的文档智能解析能力：不仅「看得准」，更要「懂得清」。</p>
<p>它需要在识别文本的同时，理解文档的语义结构和版式逻辑，将原始文档精准还原为包含标题、段落、表格、图表描述、公式 LaTeX、代码块等语义信息的标准化表示形式（如 Markdown / JSON）。</p>
<p>只有当非结构化文档被转化为高质量、可直接消费的结构化数据，才能真正成为大模型训练、知识库构建、RAG 检索与智能问答中的可靠数据原料，从而发挥它应有的价值。</p>
<p>今天，这个关键的「数据管道」迎来了它里程碑式产品化升级——PaddleOCR 官网（<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.paddleocr.com%25EF%25BC%2589%25E6%25AD%25A3%25E5%25BC%258F%25E7%2589%2588%25E4%25B8%258A%25E7%25BA%25BF%25E4%25BA%2586%25EF%25BC%2581" target="_blank" title="http://www.paddleocr.com%EF%BC%89%E6%AD%A3%E5%BC%8F%E7%89%88%E4%B8%8A%E7%BA%BF%E4%BA%86%EF%BC%81" ref="nofollow noopener noreferrer">www.paddleocr.com）正式版上线了！</a></p>
<p>这不仅是其强大开源能力的直观展现，更通过丝滑的体验与海量API，将文档结构化能力推向了普惠化应用。</p>
<p>熟悉我的老粉都知道，过去如果我要推荐 OCR 或文档解析工具，基本只会提到 PaddleOCR。原因很简单：我希望为大家提供一条最高效、最直接的“生产力路径”，而不是让大家在众多项目中反复试错。</p>
<p>这不仅是我的推荐逻辑，也是各大模型厂商在开源选型时的共识——PaddleOCR 几乎是文档解析领域唯一被广泛引用的开源方案。</p>
<p>今年 10 月 17 日 PaddleOCR-VL 刚刚发布，仅用 16 小时就登顶 HuggingFace Trending 全球榜首。</p>
<p>短短两个月内，项目的 Star 数从 57k 飙升至接近 67k。要知道，一个开源项目在五年之后还能保持这样的增长速度，背后一定是它切中了真实且迫切的用户需求。</p>
<h2 data-id="heading-0">01、关键特性：三大模型，覆盖全场景文档解析</h2>
<p>打开官网，你会看到三个核心入口：GitHub 开源地址、MCP 接口、API 接口。下方支持直接上传图像或 PDF，体验 PaddleOCR 的三大模型方案：</p>
<ul>
<li>PP-OCRv5：轻量级 OCR，适合纯文本提取</li>
<li>PP-StructureV3：基于pipeline架构的文档解析，支持印章、表格、标题等还原，零幻觉</li>
<li>PaddleOCR-VL（默认）：基于视觉-语言模型的文档解析，支持图文、公式、代码等多模态解析，当前全球最高精度</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e13af86e46c470da155b3c5f26c4298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=ZITfV5zsvXsmQiaHfK2AoeCAlME%3D" alt="图片" loading="lazy"/></p>
<p>如果你还不清楚这些模型能力的区别，PaddleOCR 官方文档（<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.paddleocr.ai%25EF%25BC%2589%25E6%258F%2590%25E4%25BE%259B%25E4%25BA%2586%25E6%25B8%2585%25E6%2599%25B0%25E7%259A%2584%25E8%25AF%25B4%25E6%2598%258E%25EF%25BC%258C%25E6%2594%25AF%25E6%258C%2581%25E6%2590%259C%25E7%25B4%25A2%25E4%25B8%258E%25E8%25AF%2584%25E8%25AE%25BA%25EF%25BC%258C%25E9%259D%259E%25E5%25B8%25B8%25E5%258F%258B%25E5%25A5%25BD%25E3%2580%2582" target="_blank" title="http://www.paddleocr.ai%EF%BC%89%E6%8F%90%E4%BE%9B%E4%BA%86%E6%B8%85%E6%99%B0%E7%9A%84%E8%AF%B4%E6%98%8E%EF%BC%8C%E6%94%AF%E6%8C%81%E6%90%9C%E7%B4%A2%E4%B8%8E%E8%AF%84%E8%AE%BA%EF%BC%8C%E9%9D%9E%E5%B8%B8%E5%8F%8B%E5%A5%BD%E3%80%82" ref="nofollow noopener noreferrer">www.paddleocr.ai）提供了清晰的说明，支持搜索与评论，非常友好。</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25d6d9e07c1d41718b865d03eaaf4360~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=JePXIRlwvNnIs4StX7yl3%2F6E1bo%3D" alt="图片" loading="lazy"/></p>
<p>我这里以 PaddleOCR-VL 为例，上传了一篇 DeepSeek-R1 的论文 PDF。</p>
<p>几秒后，解析结果清晰呈现：不管是文字、图像、代码、表格还是公式，PaddleOCR都能精准还原，相关内容，可以左右一一对应。</p>
<p>在右侧，你也可以复制所有的解析结果，也可以复制其中的某一个block的结果，还可以基于某一个block进行内容纠正。下边是一些关键场景的可视化。</p>
<p>·文字场景</p>
<p>一级标题、二级标题、正文层次分明，还原精准。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd8663cb500a48768e7ad7a9e3d88173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=L9z%2BnQK%2FoMK1Ki1xFyYsYWikZT8%3D" alt="图片" loading="lazy"/></p>
<p>·图像/图表场景</p>
<p>支持图表转表格，对科研与数据分析工作者极其友好。关闭图表识别功能：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63fc56a3bf4d4215997ef18607167fad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=9N%2FnsiHqoKsnEo0bzTdTU%2BI7Zhg%3D" alt="图片" loading="lazy"/></p>
<p>打开图表识别功能：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6155cde700b4c93b01ddba9e1adff04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=C4ecgtUcJWvpHgaSJqRzSwEQtvY%3D" alt="图片" loading="lazy"/></p>
<p>这项功能极其实用，能够将图表等非结构化数据转换为结构化表格，对于科研人员以及日常需要处理图表数据的工作者而言，是一项极具价值的工具。</p>
<p>·代码场景</p>
<p>代码区域被转换为等宽字体，代码的格式与内嵌公式保留完整，恢复完美。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a201c6857feb41e79d378bcb052173fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=18W%2BM1QYk4wNEbqT8uj2rlgmRFI%3D" alt="图片" loading="lazy"/></p>
<p>·表格场景</p>
<p>合并单元格也能准确预测，精准还原表格中的各项指标。点击“复制”可直接粘贴至 Excel，格式无损。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae3fb451c2154820aaa84a574a36843e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=w5LU47U06nXBCNTFvYh4lqWz%2BKA%3D" alt="图片" loading="lazy"/></p>
<p>此外，在表格应用场景中，我还发现了一个小惊喜：点击右侧下方表格区块的复制按钮后，可以将表格内容无损地粘贴到Excel中，原有格式能够完整保留。这个功能对我日常整理数据非常有帮助，没想到能够如此完美地实现。</p>
<p>不过，官方似乎并未特别宣传这项小功能，看来还有许多实用细节有待用户进一步发掘。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cac7e71f11bd4a7ba2a67a61d374ed9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=50dnL4OCEwPSYTLRh6Z9O6JJJoU%3D" alt="图片" loading="lazy"/></p>
<p>·公式场景 </p>
<p>LaTeX 格式输出，右侧实时渲染，复杂公式也无错漏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3046027e449423a984538abd3e416b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=dCeoJu3LRNZAR%2BwGCc%2Fvqv9o9jU%3D" alt="图片" loading="lazy"/></p>
<p>公式内容会被自动识别并转换为LaTeX格式的代码，随后在右侧的Markdown区域被正确渲染。经过对比验证，即使是较为复杂的公式也能够准确无误地显示，未发现任何错误。</p>
<p>·更多功能</p>
<p>此外，官网还支持批量上传（最多 20 个文件），并提供了超参数设置面板，除了默认的结果，还有一个设置超参数的按钮，用户可根据需求设置很多超参数，关于超参数的解释，也在旁边隐藏的部分有解释。</p>
<p>比如上边的图表识别的功能，我就是打开了这个超参数中的图表识别的开关，灵活度很高。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/377882d9cbcf45c9bce624b5fac3e771~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=SsQ3rxePn30vl%2FE%2Fsx9%2F318Fkoc%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3530c1c618e543da9363c4c8312ab1c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=QuWIc95c0IMsajNnB7ogFI%2FC3Ts%3D" alt="图片" loading="lazy"/></p>
<p>02</p>
<p><strong>API 调用：数据基建的“普惠管道”</strong></p>
<p>PaddleOCR官网首页已直接提供了 API 和 MCP 的调用示例，点击就可以有对应的弹窗，亲测带上token，复制可以跑。这里以 API 为例，MCP类似。</p>
<p>基础跑通三步走：</p>
<p>1. 点击首页的API：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b095477f7804580b14d3bc861ddff84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=xxAPVV%2Fd0YggVSum8XAtEu7b%2B4Y%3D" alt="图片" loading="lazy"/></p>
<p>2. 复制代码到本地</p>
<p>在本地电脑新建一个名为 test.py 的文件，并将复制的代码粘贴进去（此时你的账号 token 也会被自动复制）。然后，在代码中的 file_path 参数填写你要预测的文件名。这里需要注意的是：如果是 PDF 文件，fileType 应设置为 0；如果是图像文件，fileType 则需要设置为 1。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffbf04f358b042e6a612feae5288fb90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=%2BXPlKwLdkvrsbmWfZM9UtlXuYc8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/070f0c196a984afa8a51b6665997117b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=WldO4R%2F8VX%2BAfO%2ByRjULoq8Vmio%3D" alt="图片" loading="lazy"/></p>
<p>3. 运行代码</p>
<p>大约在20多秒可以返回一个21页的PDF结果，包含了每一页的Markdown的结果、对应的插图等。基本上每秒一页，速度还不错。本地可视化如图所示，和网页端完全一致。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b2fa34370ce4a998a50a477a2256ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=1IG5Gn8SGL0p0q%2BHLWS0zyTx%2BWk%3D" alt="图片" loading="lazy"/></p>
<p>进阶玩法三步走：</p>
<p>进一步体验PaddleOCR官网，会发现一些我认为非常重要的细节。</p>
<p>1. API和效果联动</p>
<p>这次 PaddleOCR 官网的一个重要变化，是前端整体把体验优化得非常友好了，不再只是“展示效果”，而是围绕 参数配置 → 效果验证 → API 接入 这条完整路径来设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/961bfb1025cf43fba68f05e3b8ba37d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=2CHCXd08e7dTxJkAAIQ9vyWFJwM%3D" alt="图片" loading="lazy"/></p>
<p>在网页端，你可以直接调整解析参数，比如是否开启图表识别、是否需要方向矫正、不同结构化策略等，每一次参数变化，解析结果都会即时刷新返回。图像或 PDF 的结构化结果几乎是秒级可见，非常适合快速对比不同参数组合下的效果差异，而不是靠猜。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cab5e29fe8347259afce07ae5168d48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=e18JfgQE9HC8UbhM%2FIh01FzZpas%3D" alt="图片" loading="lazy"/></p>
<p>更关键的是，这些在网页端调过、验证过的参数，并不会停留在「试用层」。当你确认某一套配置满足你的业务需求后，可以直接一键复制对应的 API 调用代码，包括参数、模型类型和调用方式，拿到本地或直接接入业务系统即可使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b69e985659341068ce776895258c1b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=DdoRhZktpewPGDs2fuoNPgyHBss%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>整个过程非常顺滑：</p>
<p>你不需要先搭环境、不需要翻文档对着字段一个一个找参数含义，先在网页上把效果跑通，再把同一套配置“原封不动”搬进工程里。哪怕完全没有本地部署过，也可以先把解析效果看清楚、想明白，再决定是否以及如何在真实业务中使用。</p>
<p>一句话总结就是：</p>
<p>不用写一行代码，也能把PaddleOCR的能力验证到位；一旦要上线，代码已经帮你准备好了。</p>
<p>2.更多的 API 调用</p>
<p>在 API 文档页有一行关键说明：“每位用户每日对同一模型的解析上限为 3000 页，超出会返回 429 错误。如需更高额度，可通过问卷申请白名单。”</p>
<p>🔗申请链接为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpaddle.wjx.cn%2Fvm%2FmePnNLR.aspx%3Fudsid%3D715751" target="_blank" title="https://paddle.wjx.cn/vm/mePnNLR.aspx?udsid=715751" ref="nofollow noopener noreferrer">paddle.wjx.cn/vm/mePnNLR.…</a></p>
<p>我填写了问卷中四个常规问题留下联系方式后，很快就有官方人员联系我，了解使用场景后直接开通了白名单。随后我测试了约 1 万份 PDF（共 3 万多页），开了一个后台的访问服务的进程挂机运行一夜，第二天一早，全部解析成功。这意味着，现阶段个人、团队或初创企业完全可以借助此额度，启动大规模的数据清洗与知识库构建工作，成本几乎为零。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e194afc6139449fea4f8e5d24d6b3076~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=gEyH8ymupDdc%2B1DzLPCveU7HEg0%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>3.不容错过的MCP</p>
<p>作为 AI 时代的 Type-C 接口，MCP 正逐渐成为各类 AI 产品的基础能力配置。PaddleOCR 官网也提供了开箱即用的 MCP server：只需复制官网给出的配置示例，并在 MCP host 应用中完成简单配置，即可让大模型直接调用 PaddleOCR 的文字识别与文档解析能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9b3ffe0c65e41b7bb75fa2df255bae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=lAqJH1kHZURcmeyHu2X2beFlbHc%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>我也在 Cherry Studio 里试了试效果。花了不到一分钟复制粘贴 MCP 配置，然后使用 PaddleOCR 官网提供的 PP-OCRv5 MCP server 来识别图像中的酒店名称：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1349c0a754f1456dbc41e34bfde1f487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580259&amp;x-signature=Vu%2BbSbL2fZPsZxus5uu0TbHxus8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">03、项目相关链接</h2>
<p>官网虽已足够强大，但如果你有私有化部署需求，仍可基于开源项目自行部署。</p>
<pre><code class="hljs language-bash" lang="bash">·PaddleOCR GitHub：https://github.com/PaddlePaddle/PaddleOCR·官方文档：https://www.paddleocr.ai·Hugging Face 模型：https://huggingface.co/PaddlePaddle
</code></pre>
<p>PaddleOCR 再一次没有让人失望。从开源项目到产品化官网，从模型迭代到这波 API 的开放，它正在把文档智能从“技术能力”推向“普及工具”。大模型时代，数据是石油，而 OCR 则是开采与提炼的核心装备。PaddleOCR 这一次的升级，不仅提升了开采效率，还让更多人用上了这把利器。</p>
<p>期待大家亲自体验，也欢迎在评论区分享你的使用场景与发现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[摄像头如何“看懂”你的手势？手势识别实现新人机交互]]></title>    <link>https://juejin.cn/post/7588680081352458276</link>    <guid>https://juejin.cn/post/7588680081352458276</guid>    <pubDate>2025-12-29T02:36:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081352458276" data-draft-id="7589083093693579327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="摄像头如何“看懂”你的手势？手势识别实现新人机交互"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-29T02:36:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            摄像头如何“看懂”你的手势？手势识别实现新人机交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:36:21.000Z" title="Mon Dec 29 2025 02:36:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着技术不断发展，我们与机器的交互方式也在不断演进。早期的机器依赖体力操作和机械控制，而现代计算机技术则带来了触摸屏和语音输入。</p>
<p>如今，手势识别已成为人机交互的新方向，它让我们能用自然动作来操控设备。轻轻一挥手、捏一下手指、快速做个手势——这些动作已经可以控制应用、屏幕和各类机器。</p>
<p>这种非接触式交互的背后，往往离不开计算机视觉技术的支持。作为人工智能的一个分支，计算机视觉让机器能够“看见”并理解摄像头捕捉到的画面。搭载视觉AI系统的设备，例如智能手机、虚拟现实（VR）和增强现实（AR）头显、汽车以及智能家居设备，都可以用手势代替点击、触摸或按键，带来更流畅的用户体验。</p>
<p>非接触控制在日常生活中越来越常见。在工作场所和公共空间，避免直接接触有助于提升卫生和安全性。许多数字产品也在向免手持交互转型，而手势提供了一种直观简便的控制方式，无需触碰设备即可操作。</p>
<p>在这篇文章中，我们将探讨什么是手势识别、计算机视觉如何让它更精准，以及它在实际场景中的应用。让我们开始吧！</p>
<h2 data-id="heading-0"><strong>什么是手势识别？</strong></h2>
<p>手势识别是一种传感技术，让机器能够理解人类的手势或身体动作，并将其转化为数字指令。用户无需点击屏幕或按下按钮，只需通过简单自然的动作即可控制设备。</p>
<p>这让交互过程更加直观，也是为什么手势输入正被越来越多地应用于机器学习和人工智能控制系统。尤其是手部手势识别，它是目前应用最广泛的形式之一，并且通常依赖于计算机视觉技术。</p>
<p>简单来说，视觉AI系统能够在摄像头画面中识别出手部，跟踪其动作或形状变化，然后将这些动作模式与已知手势进行匹配，从而触发屏幕上的相应操作。</p>
<p>这类系统的核心是一个计算机视觉模型，它通过大量标记过的手势图片或视频数据进行训练。训练数据越多样，模型评估越细致，它就越能适应不同用户、光线条件和背景环境，从而在实际应用中更可靠地识别手势。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/638ea7277869426a8aa23f2625953b4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580581&amp;x-signature=gvQlNQpQbUeU6fwi1yx1muew1GA%3D" alt="screenshot_2025-12-26_13-25-27.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>探索不同类型的手势与人机交互</strong></h2>
<p>在深入了解计算机视觉在手势识别中的作用之前，我们先来看看系统通常能识别哪些类型的手势。</p>
<p>大多数手势可分为两类：静态手势和动态手势。静态手势是固定的手部姿态，比如竖起大拇指、做出停止手势或比出“耶”的手势。由于不涉及动作，通常单张图像帧就能识别。</p>
<p>而动态手势则涉及随时间变化的动作，例如在空中挥手或滑动。要识别这类手势，视觉AI系统需要分析连续多帧画面，跟踪手部运动轨迹，理解手势的方向和节奏。</p>
<h2 data-id="heading-2"><strong>计算机视觉算法在手势识别中的作用</strong></h2>
<p>手势识别系统可以通过不同方式构建。有些输入系统采用可穿戴传感器，比如数据手套或腕戴式追踪器，来捕捉手部动作。</p>
<p>这类方案可能很精准，但并不总是方便。可穿戴设备需要佩戴、设置、充电和维护，在日常使用或多人共享的场景中也可能显得局限。</p>
<p>因此，许多前沿系统转而依赖计算机视觉。借助普通的RGB摄像头以及深度或飞行时间传感器，设备就能实时捕捉手部和身体动作，用户无需额外佩戴设备。这使得基于视觉的手势识别非常适合智能手机、汽车、智能电视以及AR/VR头显等设备。</p>
<p>例如，像Coovally平台，支持目标检测、目标跟踪和姿态估计等任务。这些功能可以用来在每帧画面中检测手部、跨帧跟踪其运动轨迹，并映射出指尖、关节等关键点。这使得识别诸如抬手暂停、捏合缩放、滑动浏览菜单，或在AR/VR中通过指向手势选择物品等操作成为可能。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e8e5d912d334063ae23982c1590717d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580581&amp;x-signature=ck1VenYCSfr8u68swI14IX2BdF8%3D" alt="Coovally操作动图.gif" loading="lazy"/></p>
<p>Coovally平台不仅提供模型资源，还可以帮助你提供<strong>AI解决方案</strong>，可以扫描二维码，我们来给你提供解决方案！！</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a5f59ba3737499dad68e7a17edceb77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580581&amp;x-signature=OHPdHjwriVTVVhIHeuGlf5B6ZgM%3D" alt="小助手二维码.png" loading="lazy"/></p>
<p>点击<strong>阅读原文</strong>，即可体验Coovally平台！</p>
<h2 data-id="heading-3"><strong>用于人机交互识别的计算机视觉任务</strong></h2>
<p>以下是手势识别中常用的一些关键计算机视觉任务：</p>
<ul>
<li><strong>目标检测：</strong> 用于在图像或视频帧中定位手部，通常通过绘制边界框来实现。这有助于系统聚焦于手势区域，忽略不必要的背景细节。</li>
<li><strong>目标跟踪：</strong> 在目标检测的基础上，跨多帧跟踪已检测到的手部，并维持其身份标识。这对于以运动和方向为核心的动态手势尤为重要。</li>
<li><strong>姿态估计：</strong> 不同于关注边界框，姿态估计会识别手部的关键点，如指尖、指关节和手腕。这些关键点构成了一个简单的手部骨架，能捕捉手指位置和细微动作，从而实现更精细的手势分类。</li>
<li><strong>实例分割：</strong> 该任务旨在像素级别将每只手从背景中分离出来，为每个可见的手部生成掩码。在背景杂乱、手部重叠或多只手同时出现的场景中特别有用。</li>
</ul>
<p>许多视觉AI解决方案会将这些任务组合成一个完整的处理流程。例如，系统可能先从目标检测开始找到手部，然后利用跟踪技术跨帧跟踪手部以识别动态手势。如果手势依赖于手指位置，姿态估计可以添加关键点来获取更精细的细节，而实例分割则有助于在复杂场景或手部重叠时更精确地分离每只手。这些步骤协同工作，提供了位置和运动信息，使得手势识别更加准确可靠。</p>
<h2 data-id="heading-4"><strong>基于视觉的手势识别如何工作</strong></h2>
<p>在了解了手势识别背后的计算机视觉任务后，我们一步步来看看基于视觉的系统是如何运作的。</p>
<p>一个典型的系统首先从摄像头捕获视频，有时如果设备支持，还会同时获取深度数据。接着对图像帧进行预处理（如图像处理中的去噪、稳定、减少运动模糊等），使其更易于模型稳定处理。</p>
<p>然后，系统利用检测或分割技术识别画面中的手部，并通过跟踪技术跨帧追踪其运动。如果应用需要更精细的细节，可能还会运行姿态估计来提取指尖、关节等关键点。利用这些信息，模型对手势进行分类——无论是像竖起大拇指这样的静态姿势，还是像滑动这样的动态动作模式。</p>
<p>最后，识别出的手势会被映射到界面上的某个操作，例如滚动、缩放、选择项目、调节音量，或控制AR/VR交互。具体的处理流程可能有所不同，较简单的应用步骤较少，而更复杂的应用则会结合检测、跟踪和姿态估计以获得更高的准确性。</p>
<h2 data-id="heading-5"><strong>基于视觉的手势识别的应用</strong></h2>
<p>接下来，我们看看手势识别在实际应用场景中是如何运作的。</p>

<ul>
<li><strong>汽车信息娱乐系统的基于手势交互</strong></li>
</ul>
<p>手势识别开始出现在智能汽车界面中，特别是在信息娱乐系统里。它提供了一种便捷的方式，通过简单的手势控制某些功能，有助于减少驾驶员操作触摸屏或物理按钮的频率。例如，一个快速手势可以用来调节音量、接打电话或浏览屏幕菜单。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/040a938a811c429b84560b442a2c45db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580581&amp;x-signature=edjQcKtvU2L7DkPgbbgJlfYkNmI%3D" alt="screenshot_2025-12-26_13-26-26.png" loading="lazy"/></p>
<ul>
<li><strong>游戏中的手势驱动交互</strong></li>
</ul>
<p>在游戏和沉浸式体验中，基于手势的控制正在改变人们与虚拟世界的交互方式。玩家不再仅仅依赖手柄或摇杆，而是可以使用自然的手部动作来导航菜单、拾取虚拟物品、操控角色或触发游戏内的动作。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a59d3a8a8bf4c68ae9c623279b3a7ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580581&amp;x-signature=mOzeLipnsb%2BsE9SdZZ%2FoBi1C0JA%3D" alt="screenshot_2025-12-26_13-26-45.png" loading="lazy"/></p>
<p>这种非接触式交互让人感觉更加流畅自然，尤其在AR和VR环境中。因此，手部追踪和手势控制正成为VR和混合现实头显的常见功能。</p>
<ul>
<li><strong>智能家居设备的无缝手势控制</strong></li>
</ul>
<p>智能电视、音箱和智能灯等智能家居设备，开始支持通过手势控制来实现快速、非接触的操作。用户只需一个简单的手部动作，就能开灯、调音量或触发基本指令，而无需触碰开关或遥控器。</p>
<p>例如，在家庭娱乐系统中，内置或外接的深度摄像头可以识别滑动、指向或举手等手势。这使得在房间另一端浏览菜单、调整设置或确认选择变得更加方便。背后，计算机视觉模型实时处理摄像头画面来检测和解读这些手势。</p>
<ul>
<li><strong>人工智能赋能的机器人手势控制</strong></li>
</ul>
<p>设想一下工厂里的场景：工人需要搬运零件、戴着手套，或与移动设备保持安全距离时，还要指导机器人工作。在这些情况下，伸手去按按钮或控制面板可能效率低下甚至存在安全隐患。</p>
<p>相比之下，基于手势的控制系统为操作这类机器提供了一种更实用、免手持的交互方式。这对于旨在与人类协作的“协作机器人”尤其有用。</p>
<p>操作员无需走到控制面板前，而是可以通过简单的手势信号，在一定距离外启动、停止或引导机器人。这减少了对物理控制的依赖，有助于在车间实现更安全的工作流程。</p>
<p>基于深度学习模型或学习算法的先进视觉控制系统，甚至能实现超越基本指令的功能。它们可以解读更精细的手部动作，并对细微的方向变化做出流畅响应，从而实现更精准的引导和自动化操作。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/328296d723854ab281bee5a2ee4ac67c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580581&amp;x-signature=Cqr1pj68kskZ3BB8tVIISRaGu9s%3D" alt="screenshot_2025-12-26_13-27-07.png" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>手势识别技术的优缺点</strong></h2>
<p>以下是使用手势识别技术的一些主要优势：</p>
<ul>
<li><strong>提升无障碍使用体验：</strong> 对于操作键盘、触摸屏或控制器有困难的用户，手势提供了一种替代方案。</li>
<li><strong>支持远距离操作：</strong> 手势可以在房间另一头被识别，这对智能电视、信息亭和家用设备非常有用。</li>
<li><strong>跨设备通用性强：</strong> 相似的手势集可以在手机、汽车、智能显示屏以及AR/VR头显上通用，保持了交互的一致性。</li>
</ul>
<p>同时，实际应用中也存在一些可能影响准确性和稳定性的挑战：</p>
<ul>
<li><strong>光线和摄像头质量的影响：</strong> 光线不足、反光、阴影或低分辨率摄像头可能会降低识别性能，进而影响运动控制的准确性。</li>
<li><strong>用户个体差异：</strong> 人们做手势的方式自然不同，手部大小、手指灵活度或佩戴饰物等差异都可能影响识别准确率。</li>
<li><strong>快速动作的局限：</strong> 快速手势可能导致运动模糊，或者在低帧率摄像头上造成模型错过关键帧。</li>
</ul>
<h2 data-id="heading-7"><strong>总结</strong></h2>
<p>手势识别技术已走出研究实验室，成为日常设备和创新应用的一部分。具体来说，计算机视觉使得游戏、机器人、智能家居和汽车系统中的非接触控制成为可能。随着视觉模型的不断改进，这些非接触式界面可能会变得更容易开发，应用也更加广泛。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java Optional 最佳实践+注意事项+避坑指南]]></title>    <link>https://juejin.cn/post/7588388014505328682</link>    <guid>https://juejin.cn/post/7588388014505328682</guid>    <pubDate>2025-12-29T02:35:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588388014505328682" data-draft-id="7587582213060886582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java Optional 最佳实践+注意事项+避坑指南"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-29T02:35:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李拾叁的摸鱼日常"/> <meta itemprop="url" content="https://juejin.cn/user/4443539294129722"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java Optional 最佳实践+注意事项+避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443539294129722/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李拾叁的摸鱼日常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:35:36.000Z" title="Mon Dec 29 2025 02:35:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Optional 是 Java 8 引入的核心工具（Java 17 无语法变更，但结合 <code>var</code>/<code>record</code> 等新特性有更简洁的用法），核心目标是<strong>显式处理 null，避免 NPE（空指针异常）</strong>，而非“消除所有 null”。作为 JavaWeb/微服务开发者，Optional 用得好能大幅降低 NPE 风险，用得差则会让代码更冗余。</p>
<h2 data-id="heading-0">一、Optional 核心定位，先明确“能做/不能做”</h2>
<ul>
<li>✅ <strong>能做</strong>：封装“可能为 null 的单个对象”，显式表达“值存在/不存在”，强制开发者处理 null 场景；</li>
<li>❌ <strong>不能做</strong>：替代所有 null、作为方法参数/类字段/集合元素、序列化传输（如微服务接口返回）；</li>
<li>📌 Java 17 特性适配：可结合 <code>var</code> 简化声明、<code>record</code> 封装返回值、<code>Stream</code> 流式处理，语法更简洁。</li>
</ul>
<h2 data-id="heading-1">二、Optional 最佳实践</h2>
<h3 data-id="heading-2">1. 优先用 Optional 作为方法返回值核心场景</h3>
<p><strong>核心原则</strong>：方法返回“可能为 null 的单个对象”时，返回 Optional 而非直接返回 null，显式告知调用方“需处理空值”。
<strong>适用场景</strong>：微服务中“根据 ID 查询单条数据”（如用户、订单、商品查询）。</p>
<h4 data-id="heading-3">案例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// UserService</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;

    <span class="hljs-comment">// 正确：返回 Optional&lt;User&gt;，显式表达“用户可能不存在”</span>
    <span class="hljs-keyword">public</span> Optional&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// Java 17 中可结合 var 简化</span>
        <span class="hljs-type">var</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(userId); <span class="hljs-comment">// MyBatis 查询，可能返回 null</span>
        <span class="hljs-keyword">return</span> Optional.ofNullable(user); <span class="hljs-comment">// 封装为 Optional</span>
    }
}

<span class="hljs-comment">// Controller 层调用（Java 17）</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> Result&lt;UserVO&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 链式处理：存在则转换为VO，不存在则返回404</span>
        <span class="hljs-type">var</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> userService.getUserById(id)
                .map(<span class="hljs-built_in">this</span>::convertToVO) <span class="hljs-comment">// 存在时转换</span>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户不存在"</span>)); <span class="hljs-comment">// 不存在抛异常</span>
        <span class="hljs-keyword">return</span> Result.success(userVO);
    }

    <span class="hljs-comment">// 转换方法（Java 17 record 可简化VO，此处用传统POJO）</span>
    <span class="hljs-keyword">private</span> UserVO <span class="hljs-title function_">convertToVO</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVO</span>();
        vo.setId(user.getId());
        vo.setUsername(user.getUsername());
        <span class="hljs-keyword">return</span> vo;
    }
}
</code></pre>
<p><strong>优势</strong>：调用方必须显式处理“用户不存在”场景，避免直接调用 <code>user.getUsername()</code> 导致 NPE。</p>
<h3 data-id="heading-4">2. 正确创建 Optional 实例3 种方式</h3>

























<table><thead><tr><th>方法</th><th>适用场景</th><th>风险点</th></tr></thead><tbody><tr><td><code>Optional.of(T)</code></td><td>值<strong>确定非 null</strong>（如常量、已校验的值）</td><td>值为 null 时抛 <code>NullPointerException</code></td></tr><tr><td><code>Optional.ofNullable(T)</code></td><td>值<strong>可能为 null</strong>（如数据库查询结果）</td><td>无风险，最常用</td></tr><tr><td><code>Optional.empty()</code></td><td>明确返回“空值”（如手动构造空结果）</td><td>无风险</td></tr></tbody></table>
<h4 data-id="heading-5">案例：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. ofNullable：最常用（数据查询结果）</span>
Optional&lt;User&gt; optionalUser = Optional.ofNullable(userMapper.selectById(<span class="hljs-number">1001L</span>));

<span class="hljs-comment">// 2. of：值确定非 null（Java 17 var 简化）</span>
<span class="hljs-type">var</span> <span class="hljs-variable">nonNullUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">1002L</span>, <span class="hljs-string">"zhangsan"</span>);
Optional&lt;User&gt; optionalNonNull = Optional.of(nonNullUser); <span class="hljs-comment">// 安全</span>

<span class="hljs-comment">// 3. empty：明确返回空</span>
Optional&lt;User&gt; emptyUser = Optional.empty();
</code></pre>
<h3 data-id="heading-6">3. 避免直接调用 <code>get()</code>，优先用“安全取值”方法</h3>
<p><code>get()</code> 是 Optional 最“危险”的方法：值不存在时抛 <code>NoSuchElementException</code>，等同于手动写 <code>if (obj == null) throw ...</code>，失去 Optional 意义。优先用以下安全方法：</p>






























<table><thead><tr><th>方法</th><th>作用</th><th>适用场景</th></tr></thead><tbody><tr><td><code>orElse(T)</code></td><td>无值时返回默认值（默认值立即创建）</td><td>默认值创建成本低（如空字符串、0）</td></tr><tr><td><code>orElseGet(Supplier)</code></td><td>无值时通过 Supplier 创建默认值（懒加载）</td><td>默认值创建成本高（如 new 对象、数据库查询）</td></tr><tr><td><code>orElseThrow()</code></td><td>无值时抛 <code>NoSuchElementException</code></td><td>Java 10+ 简化写法，快速抛默认异常</td></tr><tr><td><code>orElseThrow(Supplier)</code></td><td>无值时抛自定义异常</td><td>微服务业务异常（如用户不存在）</td></tr></tbody></table>
<h4 data-id="heading-7">案例：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 微服务订单查询（安全取值示例）</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
	<span class="hljs-meta">@Autowired</span>
	<span class="hljs-keyword">private</span> OrderMapper orderMapper;
    <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">getOrder</span><span class="hljs-params">(Long orderId)</span> {
        Optional&lt;Order&gt; optionalOrder = Optional.ofNullable(orderMapper.selectById(orderId));

        <span class="hljs-comment">// 反例：直接 get()，无值时抛异常，等同于 NPE</span>
        <span class="hljs-comment">// Order order = optionalOrder.get(); // 危险！</span>

        <span class="hljs-comment">// 正例1：无值时返回默认值（orElse，默认值简单）</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">defaultOrder</span> <span class="hljs-operator">=</span> optionalOrder.orElse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-number">0L</span>, <span class="hljs-string">"默认订单"</span>));

        <span class="hljs-comment">// 正例2：无值时懒加载默认值（orElseGet，默认值创建成本高）</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">lazyOrder</span> <span class="hljs-operator">=</span> optionalOrder.orElseGet(() -&gt; createDefaultOrder(orderId));

        <span class="hljs-comment">// 正例3：无值时抛自定义异常</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">businessOrder</span> <span class="hljs-operator">=</span> optionalOrder.orElseThrow(() -&gt; 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"订单不存在，ID："</span> + orderId));

        <span class="hljs-keyword">return</span> convertToVO(businessOrder);
    }

    <span class="hljs-comment">// 高成本默认值创建（数据库/远程调用）</span>
    <span class="hljs-keyword">private</span> Order <span class="hljs-title function_">createDefaultOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">return</span> orderMapper.selectDefaultOrder();
    }
}
</code></pre>
<h3 data-id="heading-8">4. 结合流式 API（map/flatMap/filter）处理嵌套 null</h3>
<p>对象查询中常遇到“嵌套对象”（如 <code>User → Address → City</code>），Optional 的流式 API 可避免多层 <code>if (obj != null)</code> 嵌套。</p>
<h4 data-id="heading-9">案例（处理嵌套 null）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 嵌套对象：User → Address（可能null） → City（可能null） → cityName</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserCity</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> Optional.ofNullable(userMapper.selectById(userId)) <span class="hljs-comment">// User 可能null</span>
                .map(User::getAddress) <span class="hljs-comment">// User→Address，Address可能null</span>
                .map(Address::getCity) <span class="hljs-comment">// Address→City，City可能null</span>
                .map(City::getCityName) <span class="hljs-comment">// City→cityName，可能null</span>
                .filter(name -&gt; !name.isBlank()) <span class="hljs-comment">// 过滤空城市名（Java 11+ isBlank）</span>
                .orElse(<span class="hljs-string">"未知城市"</span>); <span class="hljs-comment">// 无值时返回默认</span>
    }
}

<span class="hljs-comment">// 反例：多层 null 检查（代码冗余）</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserCityBad</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(userId);
    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) 
	    <span class="hljs-keyword">return</span> <span class="hljs-string">"未知城市"</span>;
    <span class="hljs-type">Address</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> user.getAddress();
    <span class="hljs-keyword">if</span> (address == <span class="hljs-literal">null</span>) 
	    <span class="hljs-keyword">return</span> <span class="hljs-string">"未知城市"</span>;
    <span class="hljs-type">City</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> address.getCity();
    <span class="hljs-keyword">if</span> (city == <span class="hljs-literal">null</span>) 
	    <span class="hljs-keyword">return</span> <span class="hljs-string">"未知城市"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> city.getCityName();
    <span class="hljs-keyword">return</span> name.isBlank() ? <span class="hljs-string">"未知城市"</span> : name;
}
</code></pre>
<p><strong>关键区别</strong>：<code>flatMap</code> 用于处理“返回 Optional 的方法”，避免嵌套 <code>Optional&lt;Optional&lt;T&gt;&gt;</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// flatMap 示例（解决嵌套 Optional）</span>
<span class="hljs-keyword">public</span> Optional&lt;City&gt; <span class="hljs-title function_">getUserCityOptional</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-keyword">return</span> Optional.ofNullable(userMapper.selectById(userId))
            .flatMap(user -&gt; Optional.ofNullable(user.getAddress())) <span class="hljs-comment">// flatMap 解嵌套</span>
            .flatMap(address -&gt; Optional.ofNullable(address.getCity()));
}
</code></pre>
<h3 data-id="heading-10">5. 用 <code>ifPresent()</code>/<code>ifPresentOrElse()</code> 消费值（避免 isPresent()+get()）</h3>
<p><code>isPresent()</code> + <code>get()</code> 是 Optional 的“反模式”，等同于手动 null 检查；Java 11+ 新增的 <code>ifPresentOrElse()</code> 更适合“消费值 + 空值处理”场景。</p>
<h4 data-id="heading-11">案例（消费值）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 微服务日志记录（消费值）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logUserInfo</span><span class="hljs-params">(Long userId)</span> {
    Optional&lt;User&gt; optionalUser = userService.getUserById(userId);

    <span class="hljs-comment">// 反例：isPresent() + get()（冗余，失去 Optional 意义）</span>
    <span class="hljs-keyword">if</span> (optionalUser.isPresent()) {
        log.info(<span class="hljs-string">"用户信息：{}"</span>, optionalUser.get().getUsername());
    } <span class="hljs-keyword">else</span> {
        log.warn(<span class="hljs-string">"用户不存在，ID：{}"</span>, userId);
    }

    <span class="hljs-comment">// 正例1：仅消费值（ifPresent）</span>
    optionalUser.ifPresent(user -&gt; log.info(<span class="hljs-string">"用户信息：{}"</span>, user.getUsername()));

    <span class="hljs-comment">// 正例2：消费值 + 空值处理（ifPresentOrElse，Java 11+）</span>
    optionalUser.ifPresentOrElse(
            user -&gt; log.info(<span class="hljs-string">"用户信息：{}"</span>, user.getUsername()), <span class="hljs-comment">// 有值时消费</span>
            () -&gt; log.warn(<span class="hljs-string">"用户不存在，ID：{}"</span>, userId) <span class="hljs-comment">// 无值时处理</span>
    );
}
</code></pre>
<h3 data-id="heading-12">6. 结合 Java 17 新特性简化 Optional 使用</h3>
<p>Java 17 的 <code>var</code>、<code>record</code>、<code>Stream</code> 可让 Optional 代码更简洁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. var 简化声明</span>
<span class="hljs-type">var</span> <span class="hljs-variable">optionalUser</span> <span class="hljs-operator">=</span> userService.getUserById(<span class="hljs-number">1001L</span>);

<span class="hljs-comment">// 2. record 封装返回值（Java 16+）</span>
<span class="hljs-keyword">record</span> <span class="hljs-title class_">UserSimpleVO</span><span class="hljs-params">(Long id, String username)</span> {}
<span class="hljs-comment">// map 转换为 record</span>
<span class="hljs-type">var</span> <span class="hljs-variable">userSimpleVO</span> <span class="hljs-operator">=</span> optionalUser.map(u -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserSimpleVO</span>(u.getId(), u.getUsername()))
        .orElse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserSimpleVO</span>(<span class="hljs-number">0L</span>, <span class="hljs-string">"未知用户"</span>));

<span class="hljs-comment">// 3. Stream 结合 Optional（批量查询）</span>
<span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title function_">getActiveUsers</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> userMapper.selectAll() <span class="hljs-comment">// List&lt;User&gt;</span>
            .stream()
            .filter(user -&gt; user.getStatus() == <span class="hljs-number">1</span>) <span class="hljs-comment">// 过滤活跃用户</span>
            .findFirst() <span class="hljs-comment">// Optional&lt;User&gt;</span>
            .map(List::of) <span class="hljs-comment">// 存在则转List</span>
            .orElse(Collections.emptyList()); <span class="hljs-comment">// 不存在则返回空List</span>
}
</code></pre>
<h2 data-id="heading-13">三、Optional 注意事项，使用边界</h2>
<h3 data-id="heading-14">1. 不要用 Optional 作为方法参数</h3>
<p>Optional 作为参数会增加调用复杂度，调用方需手动创建 Optional，且无法通过方法签名判断“是否允许 null”。</p>
<h4 data-id="heading-15">反例（参数用 Optional）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：参数用 Optional，调用方需额外封装，冗余</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(Optional&lt;Long&gt; userId, Optional&lt;String&gt; username)</span> {
    <span class="hljs-comment">// 调用方：updateUser(Optional.of(1001L), Optional.of("zhangsan")) → 冗余</span>
}
</code></pre>
<h4 data-id="heading-16">正例（参数用 null + 重载/默认值）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正例：参数直接用基本类型，允许 null，通过重载简化</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(Long userId, String username)</span> {
    <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户ID不能为空"</span>);
    <span class="hljs-comment">// 业务逻辑</span>
}
<span class="hljs-comment">// 重载（可选）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(Long userId)</span> {
    updateUser(userId, <span class="hljs-literal">null</span>);
}
</code></pre>
<h3 data-id="heading-17">2. 不要用 Optional 作为类字段/集合元素</h3>
<ul>
<li><strong>类字段</strong>：Optional 不可序列化（实现 <code>Serializable</code> 但序列化会丢失值），微服务调用中 JPA 实体、DTO 序列化传输时会出问题；</li>
<li><strong>集合元素</strong>：集合（List/Map）本身可空，<code>List&lt;Optional&lt;User&gt;&gt;</code> 嵌套无意义，直接用 <code>List&lt;User&gt;</code>，空元素用 null 或过滤即可。</li>
</ul>
<h4 data-id="heading-18">反例（字段用 Optional）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：JPA 实体字段用 Optional（序列化失败）</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Optional&lt;String&gt; username; <span class="hljs-comment">// 错误！序列化时丢失值</span>
}
</code></pre>
<h4 data-id="heading-19">正例（字段用普通类型）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username; <span class="hljs-comment">// 允许 null，查询后用 Optional 封装</span>
}
</code></pre>
<h3 data-id="heading-20">3. 避免过度使用 Optional</h3>
<p>简单的 null 检查无需封装为 Optional，否则代码冗余。例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：过度使用 Optional（简单 null 检查）</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isUserExist</span><span class="hljs-params">(Long userId)</span> {
    Optional&lt;User&gt; optionalUser = Optional.ofNullable(userMapper.selectById(userId));
    <span class="hljs-keyword">return</span> optionalUser.isPresent(); <span class="hljs-comment">// 冗余，等同于 user != null</span>
}

<span class="hljs-comment">// 正例：直接 null 检查</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isUserExist</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-keyword">return</span> userMapper.selectById(userId) != <span class="hljs-literal">null</span>;
}
</code></pre>
<h2 data-id="heading-21">四、避坑指南</h2>
<h3 data-id="heading-22">坑1：<code>orElse()</code> 和 <code>orElseGet()</code> 混用（性能坑）</h3>
<p><code>orElse()</code> 的默认值<strong>无论值是否存在都会创建</strong>，<code>orElseGet()</code> 是<strong>懒加载</strong>（仅值不存在时创建）。开发中若默认值是“数据库查询/远程调用”，用 <code>orElse()</code> 会导致性能浪费。</p>
<h4 data-id="heading-23">反例（性能浪费）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：orElse() 创建高成本默认值（即使有值，也会调用 createDefaultUser）</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long userId)</span> {
    Optional&lt;User&gt; optionalUser = userService.getUserById(userId);
    <span class="hljs-keyword">return</span> optionalUser.orElse(createDefaultUser()); <span class="hljs-comment">// 即使有值，也执行 createDefaultUser</span>
}
</code></pre>
<h4 data-id="heading-24">正例（懒加载）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正例：orElseGet() 懒加载（仅无值时执行 createDefaultUser）</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long userId)</span> {
    Optional&lt;User&gt; optionalUser = userService.getUserById(userId);
    <span class="hljs-keyword">return</span> optionalUser.orElseGet(<span class="hljs-built_in">this</span>::createDefaultUser);
}
</code></pre>
<h3 data-id="heading-25">坑2：嵌套 Optional（<code>Optional&lt;Optional&lt;T&gt;&gt;</code>）</h3>
<p>嵌套 Optional 是常见错误，原因是 <code>map()</code> 中返回了 Optional，需用 <code>flatMap()</code> 解嵌套。</p>
<h4 data-id="heading-26">反例（嵌套 Optional）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：map 返回 Optional，导致嵌套 Optional&lt;Optional&lt;City&gt;&gt;</span>
<span class="hljs-keyword">public</span> Optional&lt;Optional&lt;City&gt;&gt; <span class="hljs-title function_">getUserCityNested</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-keyword">return</span> Optional.ofNullable(userMapper.selectById(userId))
            .map(user -&gt; Optional.ofNullable(user.getAddress()))
            .map(addressOpt -&gt; addressOpt.map(Address::getCity));
}
</code></pre>
<h4 data-id="heading-27">正例（flatMap 解嵌套）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正例：flatMap 解嵌套，返回 Optional&lt;City&gt;</span>
<span class="hljs-keyword">public</span> Optional&lt;City&gt; <span class="hljs-title function_">getUserCityFlat</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-keyword">return</span> Optional.ofNullable(userMapper.selectById(userId))
            .flatMap(user -&gt; Optional.ofNullable(user.getAddress()))
            .flatMap(address -&gt; Optional.ofNullable(address.getCity()));
}
</code></pre>
<h3 data-id="heading-28">坑3：序列化/反序列化问题（微服务传输坑）</h3>
<p>Optional 不可序列化，若微服务接口返回 Optional，会导致 JSON 序列化失败（如 Jackson 序列化后为 <code>{"present":true,"value":{...}}</code>，前端解析异常）。</p>
<h4 data-id="heading-29">反例（接口返回 Optional）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：Controller 返回 Optional（序列化异常）</span>
<span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> Optional&lt;UserVO&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-keyword">return</span> userService.getUserById(id).map(<span class="hljs-built_in">this</span>::convertToVO);
}
</code></pre>
<h4 data-id="heading-30">正例（返回普通对象）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正例：返回普通对象，无值时抛异常/返回默认值</span>
<span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-keyword">return</span> userService.getUserById(id)
            .map(<span class="hljs-built_in">this</span>::convertToVO)
            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户不存在"</span>));
}
</code></pre>
<h3 data-id="heading-31">坑4：<code>ifPresent()</code> 中修改外部变量（线程安全坑）</h3>
<p><code>ifPresent()</code> 是消费型接口，若在其中修改外部可变变量，可能导致线程安全问题（尤其多线程场景）。</p>
<h4 data-id="heading-32">反例（线程不安全）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：ifPresent 中修改外部变量</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">"未知"</span>; <span class="hljs-comment">// 外部可变变量</span>
    userService.getUserById(userId).ifPresent(user -&gt; {
        username = user.getUsername(); <span class="hljs-comment">// 编译错误！lambda 中不能修改外部非final变量</span>
    });
    <span class="hljs-keyword">return</span> username;
}
</code></pre>
<h4 data-id="heading-33">正例（返回值替代）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正例：用 map + orElse 返回值，无外部变量修改</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-keyword">return</span> userService.getUserById(userId)
            .map(User::getUsername)
            .orElse(<span class="hljs-string">"未知"</span>);
}
</code></pre>
<h3 data-id="heading-34">坑5：<code>Optional.of()</code> 传入 null（隐性 NPE）</h3>
<p><code>Optional.of()</code> 要求值非 null，若传入 null 会立即抛 NPE，失去 Optional 防 NPE 的意义。</p>
<h4 data-id="heading-35">反例（隐性 NPE）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 反例：of() 传入可能为 null 的值</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">1001L</span>); <span class="hljs-comment">// 可能 null</span>
Optional&lt;User&gt; optionalUser = Optional.of(user); <span class="hljs-comment">// 若 user 为 null，抛 NPE</span>
</code></pre>
<h4 data-id="heading-36">正例（用 ofNullable）：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正例：ofNullable 处理可能为 null 的值</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">1001L</span>);
Optional&lt;User&gt; optionalUser = Optional.ofNullable(user); <span class="hljs-comment">// 安全</span>
</code></pre>
<h2 data-id="heading-37">五、总结（关键点回顾）</h2>
<ol>
<li><strong>核心定位</strong>：Optional 是“显式处理 null 的工具”，优先作为<strong>方法返回值</strong>，不用于参数/字段/集合元素；</li>
<li><strong>最佳实践</strong>：
<ul>
<li>创建用 <code>ofNullable()</code>（最常用）、<code>of()</code>（非 null）、<code>empty()</code>（空值）；</li>
<li>取值用 <code>orElseGet()</code>/<code>orElseThrow()</code>，避免 <code>get()</code>；</li>
<li>嵌套 null 用 <code>flatMap()</code>，消费值用 <code>ifPresentOrElse()</code>；</li>
<li>结合 Java 17 <code>var</code>/<code>record</code> 简化代码；</li>
</ul>
</li>
<li><strong>避坑核心</strong>：
<ul>
<li>区分 <code>orElse()</code>（立即创建）和 <code>orElseGet()</code>（懒加载）；</li>
<li>避免嵌套 Optional（用 <code>flatMap()</code> 解嵌套）；</li>
<li>禁止 Optional 序列化（微服务接口返回普通对象）；</li>
<li>不滥用 Optional（简单 null 检查直接判断）。</li>
</ul>
</li>
</ol>
<p>Optional 的核心价值是<strong>让 null 处理显式化</strong>，无需追求<strong>所有场景都用 Optional</strong>，而是在<strong>可能返回 null 的单对象查询</strong>场景中精准使用，这才是避免 NPE、提升代码可读性的关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git Worktree：同时处理多个分支的正确姿势]]></title>    <link>https://juejin.cn/post/7588680081351835684</link>    <guid>https://juejin.cn/post/7588680081351835684</guid>    <pubDate>2025-12-29T01:58:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081351835684" data-draft-id="7589083093693300799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git Worktree：同时处理多个分支的正确姿势"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-12-29T01:58:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="妖孽白YoonA"/> <meta itemprop="url" content="https://juejin.cn/user/3931509312728759"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git Worktree：同时处理多个分支的正确姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509312728759/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    妖孽白YoonA
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:58:32.000Z" title="Mon Dec 29 2025 01:58:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-plateau-light">.hljs-comment,.hljs-quote{color:#655d5d}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ca4949}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#b45a3c}.hljs-bullet,.hljs-string,.hljs-symbol{color:#4b8b8b}.hljs-section,.hljs-title{color:#7272ca}.hljs-keyword,.hljs-selector-tag{color:#8464c4}.hljs-addition,.hljs-deletion{color:#1b1818;display:inline-block;width:100%}.hljs-deletion{background-color:#ca4949}.hljs-addition{background-color:#4b8b8b}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f4ecec;color:#585050}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">遇到过这种情况吗？</h2>
<p>正写着代码，突然产品经理跑过来说线上出bug了，得马上修。你看看自己的工作区：改了一半的文件、新加的测试代码、还有几个临时文件……这时候你会怎么办？</p>
<p>以前我都是 <code>git stash</code>，改完bug再 <code>stash pop</code> 回来。但有时候 stash 多了就乱了，pop 的时候还可能冲突。后来发现 <code>git worktree</code> 这个功能，简直完美解决了这个问题。</p>
<h2 data-id="heading-1">Worktree 是什么？</h2>
<p>说白了就是让你在一个 Git 仓库里同时 checkout 多个分支到不同的文件夹。比如：</p>
<pre><code class="hljs language-bash" lang="bash">project/                 <span class="hljs-comment"># 主目录，开发新功能</span>
project-hotfix/         <span class="hljs-comment"># 修bug用</span>
project-review/         <span class="hljs-comment"># 看别人代码用</span>
</code></pre>
<p>这三个目录用的是同一个 Git 仓库，提交、分支这些都是共享的，但每个目录可以切到不同分支，互不干扰。</p>
<blockquote>
<p>想了解更多细节？可以看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fdocs%2Fgit-worktree%2Fzh_HANS-CN" target="_blank" title="https://git-scm.com/docs/git-worktree/zh_HANS-CN" ref="nofollow noopener noreferrer">Git 官方文档</a></p>
</blockquote>
<h2 data-id="heading-2">常用命令详解</h2>
<h3 data-id="heading-3">1. 添加工作区 (add)</h3>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-css" lang="css">git worktree add <span class="hljs-selector-attr">[选项]</span> &lt;路径&gt; <span class="hljs-selector-attr">[&lt;提交号&gt;]</span>
</code></pre>
<p><strong>常见用法：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 最简单：自动创建同名分支</span>
git worktree <span class="hljs-keyword">add</span> ../hotfix
<span class="hljs-meta"># 会在 ../hotfix 目录创建名为 hotfix 的新分支</span>

<span class="hljs-meta"># 基于现有分支创建工作区</span>
git worktree <span class="hljs-keyword">add</span> ../feature-test feature-branch
<span class="hljs-meta"># checkout 已存在的 feature-branch 分支</span>

<span class="hljs-meta"># 创建新分支</span>
git worktree <span class="hljs-keyword">add</span> -b <span class="hljs-keyword">new</span>-feature ../<span class="hljs-keyword">new</span>-feature
<span class="hljs-meta"># 基于当前 HEAD 创建新分支</span>

<span class="hljs-meta"># 基于指定提交创建新分支</span>
git worktree <span class="hljs-keyword">add</span> -b bugfix-v1 ../bugfix v1<span class="hljs-number">.0</span><span class="hljs-number">.0</span>
<span class="hljs-meta"># 从 v1.0.0 标签创建 bugfix-v1 分支</span>

<span class="hljs-meta"># 创建分离 HEAD（不关联任何分支）</span>
git worktree <span class="hljs-keyword">add</span> -d ../temp-check
<span class="hljs-meta"># 适合临时查看代码，不打算提交</span>
</code></pre>
<p><strong>常用参数说明：</strong></p>
<ul>
<li><code>-b &lt;新分支名&gt;</code>：创建新分支并 checkout</li>
<li><code>-B &lt;分支名&gt;</code>：强制创建分支，如果已存在则重置它</li>
<li><code>-d</code> 或 <code>--detach</code>：创建分离 HEAD 状态的工作区</li>
<li><code>-f</code> 或 <code>--force</code>：强制操作，即使分支已在其他工作区被 checkout</li>
<li><code>--lock</code>：创建后立即锁定工作区，防止被删除或移动</li>
<li><code>--orphan</code>：创建孤儿分支（空历史的新分支）</li>
</ul>
<p><strong>智能分支追踪：</strong> 如果你指定的分支在本地不存在，但远程有同名分支，Git 会自动帮你创建并设置追踪：</p>
<pre><code class="hljs language-bash" lang="bash">git worktree add ../feature-auth feature-auth
<span class="hljs-comment"># 如果本地没有 feature-auth，但 origin/feature-auth 存在</span>
<span class="hljs-comment"># 会自动创建本地分支并追踪远程分支</span>
</code></pre>
<h3 data-id="heading-4">2. 查看工作区列表 (list)</h3>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-css" lang="css">git worktree list <span class="hljs-selector-attr">[选项]</span>
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">基本列表</span>
git worktree list
<span class="hljs-meta prompt_"># </span><span class="bash">输出：</span>
<span class="hljs-meta prompt_"># </span><span class="bash">/path/to/project        abc1234 [main]</span>
<span class="hljs-meta prompt_"># </span><span class="bash">/path/to/project-hotfix def5678 [hotfix-bug]</span>
<span class="hljs-meta prompt_"># </span><span class="bash">/path/to/temp          789abc0 (detached HEAD)</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">详细信息（显示锁定原因等）</span>
git worktree list --verbose
<span class="hljs-meta prompt_"># </span><span class="bash">输出：</span>
<span class="hljs-meta prompt_"># </span><span class="bash">/path/to/project        abc1234 [main]</span>
<span class="hljs-meta prompt_"># </span><span class="bash">/path/to/locked-work    def5678 [feature-a]</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    locked: 在移动硬盘上</span>
<span class="hljs-meta prompt_"># </span><span class="bash">/path/to/prunable      789abc0 (detached HEAD)</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    prunable: gitdir 文件指向不存在的位置</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">机器可读格式（适合脚本解析）</span>
git worktree list --porcelain
</code></pre>
<p><strong>常用参数：</strong></p>
<ul>
<li><code>-v</code> 或 <code>--verbose</code>：显示详细信息，包括锁定原因</li>
<li><code>--porcelain</code>：以固定格式输出，方便脚本解析</li>
<li><code>-z</code>：配合 --porcelain 使用，用 NUL 字符分隔（处理路径中包含换行的情况）</li>
</ul>
<h3 data-id="heading-5">3. 删除工作区 (remove)</h3>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">git worktree remove [选项] &lt;工作区&gt;
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除干净的工作区</span>
git worktree remove ../hotfix

<span class="hljs-comment"># 强制删除（即使有未提交的更改）</span>
git worktree remove -f ../hotfix

<span class="hljs-comment"># 删除锁定的工作区（需要两次 --force）</span>
git worktree remove --force --force ../locked-work
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>-f</code> 或 <code>--force</code>：强制删除脏工作区（有未提交的修改）</li>
<li><code>--force --force</code>：强制删除锁定的工作区</li>
</ul>
<h3 data-id="heading-6">4. 移动工作区 (move)</h3>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-xml" lang="xml">git worktree move <span class="hljs-tag">&lt;<span class="hljs-name">工作区</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">新路径</span>&gt;</span>
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 移动工作区到新位置</span>
git worktree move ../hotfix ../urgent-fix

<span class="hljs-comment"># 移动锁定的工作区（需要两次 --force）</span>
git worktree move --force --force ../locked-work ../new-location
</code></pre>
<p>**注意：**主工作区和包含子模块的工作区不能移动。</p>
<h3 data-id="heading-7">5. 锁定/解锁工作区 (lock/unlock)</h3>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-xml" lang="xml">git worktree lock [选项] <span class="hljs-tag">&lt;<span class="hljs-name">工作区</span>&gt;</span>
git worktree unlock <span class="hljs-tag">&lt;<span class="hljs-name">工作区</span>&gt;</span>
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 锁定工作区并说明原因</span>
git worktree lock ../portable-work --reason <span class="hljs-string">"在移动硬盘上"</span>

<span class="hljs-comment"># 解锁工作区</span>
git worktree unlock ../portable-work
</code></pre>
<p><strong>使用场景：</strong> 工作区在移动硬盘、U盘或网络盘上，不希望被自动清理时使用。</p>
<h3 data-id="heading-8">6. 修复工作区 (repair)</h3>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-css" lang="css">git worktree repair <span class="hljs-selector-attr">[&lt;路径&gt;...]</span>
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在主工作区修复所有链接</span>
git worktree repair

<span class="hljs-comment"># 修复特定工作区（如果手动移动了目录）</span>
git worktree repair /new/path/to/moved-worktree

<span class="hljs-comment"># 修复多个工作区</span>
git worktree repair ../work1 ../work2 ../work3
</code></pre>
<p><strong>使用场景：</strong></p>
<ul>
<li>手动移动了工作区目录</li>
<li>手动移动了主仓库</li>
<li>Git 连接损坏需要重建</li>
</ul>
<h3 data-id="heading-9">7. 清理过期记录 (prune)</h3>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-css" lang="css">git worktree prune <span class="hljs-selector-attr">[选项]</span>
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清理已删除工作区的记录</span>
git worktree prune

<span class="hljs-comment"># 预览会删除什么（不实际删除）</span>
git worktree prune -n

<span class="hljs-comment"># 显示详细清理过程</span>
git worktree prune -v

<span class="hljs-comment"># 清理超过指定时间未使用的工作区</span>
git worktree prune --expire 7.days.ago
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>-n</code> 或 <code>--dry-run</code>：只显示会删除什么，不实际删除</li>
<li><code>-v</code> 或 <code>--verbose</code>：显示详细信息</li>
<li><code>--expire &lt;时间&gt;</code>：只清理超过指定时间的记录</li>
</ul>
<p><strong>使用场景：</strong> 如果你直接用 <code>rm -rf</code> 删除了工作区目录（不推荐），用这个命令清理 Git 中的残留记录。</p>
<h2 data-id="heading-10">真实使用场景</h2>
<h3 data-id="heading-11">场景一：紧急修bug</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 赶紧创建个新目录改bug</span>
git worktree add ../hotfix main

<span class="hljs-built_in">cd</span> ../hotfix
<span class="hljs-comment"># 改代码，提交</span>
git commit -am <span class="hljs-string">"修复登录问题"</span>
git push

<span class="hljs-comment"># 回到原来的目录继续写代码</span>
<span class="hljs-built_in">cd</span> -

<span class="hljs-comment"># bug修完了，删掉这个临时目录</span>
git worktree remove ../hotfix
</code></pre>
<p>整个过程原来的工作区一点没动，改了一半的代码还在那儿。</p>
<h3 data-id="heading-12">场景二：Code Review</h3>
<p>要看同事的代码，但不想影响自己正在写的：</p>
<pre><code class="hljs language-bash" lang="bash">git worktree add ../review-pr feature/user-login
<span class="hljs-built_in">cd</span> ../review-pr
<span class="hljs-comment"># 慢慢看代码，跑跑测试</span>
</code></pre>
<p>看完直接删掉就行，不用来回切分支。</p>
<h3 data-id="heading-13">场景三：同时开发多个功能</h3>
<pre><code class="hljs language-css" lang="css">git worktree add ../feature-<span class="hljs-selector-tag">a</span> -<span class="hljs-selector-tag">b</span> feature-<span class="hljs-selector-tag">a</span>
git worktree add ../feature-<span class="hljs-selector-tag">b</span> -<span class="hljs-selector-tag">b</span> feature-<span class="hljs-selector-tag">b</span>
</code></pre>
<p>写着写着 feature-a 卡住了？直接去 feature-b 目录写别的，不用切来切去。</p>
<h3 data-id="heading-14">场景四：测试不同版本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试当前版本</span>
git worktree add -d ../test-current

<span class="hljs-comment"># 测试旧版本</span>
git worktree add -d ../test-v1 v1.0.0

<span class="hljs-comment"># 测试完删掉</span>
git worktree remove ../test-current
git worktree remove ../test-v1
</code></pre>
<h2 data-id="heading-15">一些坑和注意事项</h2>
<p><strong>同一个分支不能在多个工作区同时 checkout</strong></p>
<p>会报错。想想也合理，不然容易乱。非要这么干的话加 <code>--force</code>，但我从没这么用过。</p>
<p><strong>直接删文件夹不行</strong></p>
<p>别直接 <code>rm -rf</code> 删工作区目录，用 <code>git worktree remove</code>。否则 Git 里还留着记录，虽然可以用 <code>git worktree prune</code> 清理，但还是麻烦。</p>
<p><strong>子模块支持不太好</strong></p>
<p>文档里明说了，有子模块的项目最好别用 worktree。我试过几次确实有点问题。</p>
<p><strong>移动目录后要修复</strong></p>
<p>如果手动把工作区目录挪了地方，记得运行：</p>
<pre><code class="hljs">git worktree repair
</code></pre>
<p><strong>主工作区不能删除</strong></p>
<p><code>git worktree remove</code> 只能删除链接工作区，主工作区（最初 clone 或 init 的那个）删不了。</p>
<h2 data-id="heading-16">小技巧</h2>
<p><strong>目录名起得有意义点</strong></p>
<p>别都叫 <code>temp1</code>、<code>temp2</code>，过两天就忘了哪个是哪个。我一般这样：</p>
<pre><code class="hljs language-sql" lang="sql">git worktree <span class="hljs-keyword">add</span> ..<span class="hljs-operator">/</span>fix<span class="hljs-operator">-</span>issue<span class="hljs-number">-123</span> <span class="hljs-operator">-</span>b fix<span class="hljs-operator">-</span>issue<span class="hljs-number">-123</span>
git worktree <span class="hljs-keyword">add</span> ..<span class="hljs-operator">/</span>feature<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>auth <span class="hljs-operator">-</span>b feature<span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>auth
</code></pre>
<p><strong>定期清理</strong></p>
<p>偶尔跑一下 <code>git worktree list</code>，看看有没有不用的工作区。该删的删掉，保持干净。</p>
<p><strong>用相对路径还是绝对路径？</strong></p>
<p>看个人习惯。我一般用相对路径 <code>../xxx</code>，这样整个项目目录移动也不影响。如果需要绝对路径，可以在配置中设置：</p>
<pre><code class="hljs language-arduino" lang="arduino">git config worktree.useRelativePaths <span class="hljs-literal">false</span>
</code></pre>
<p><strong>创建时就锁定</strong></p>
<p>如果知道工作区在移动设备上，创建时直接锁定：</p>
<pre><code class="hljs language-csharp" lang="csharp">git worktree <span class="hljs-keyword">add</span> --<span class="hljs-keyword">lock</span> ../portable-work --reason <span class="hljs-string">"在U盘上"</span>
</code></pre>
<h2 data-id="heading-17">什么时候用 Worktree？</h2>
<p>适合用：</p>
<ul>
<li>需要紧急切换任务</li>
<li>同时开发多个功能</li>
<li>Code Review 不想影响当前工作</li>
<li>想在不同分支间对比代码</li>
<li>测试不同版本的代码</li>
</ul>
<p>不适合用：</p>
<ul>
<li>项目有子模块</li>
<li>只是临时看看代码（直接 <code>git show</code> 或者 GitHub 上看就行）</li>
<li>磁盘空间紧张（每个工作区都要占空间）</li>
</ul>
<h2 data-id="heading-18">总结</h2>
<p>Worktree 这功能其实很早就有了，但知道的人不多。用习惯之后真的回不去了，尤其是经常被打断改 bug 的时候。</p>
<p>不过也别滥用，大部分情况下一个工作区够用了。真需要的时候，Worktree 能帮你省不少事儿。</p>
<p>想深入了解所有选项和高级用法，建议看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fdocs%2Fgit-worktree%2Fzh_HANS-CN" target="_blank" title="https://git-scm.com/docs/git-worktree/zh_HANS-CN" ref="nofollow noopener noreferrer">Git 官方文档的 Worktree 章节</a>，里面讲得很详细。</p>
<h2 data-id="heading-19">快速参考</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 创建工作区</span>
git worktree <span class="hljs-keyword">add</span> &lt;路径&gt;                    <span class="hljs-meta"># 自动创建同名分支</span>
git worktree <span class="hljs-keyword">add</span> &lt;路径&gt; &lt;分支&gt;              <span class="hljs-meta"># 基于现有分支</span>
git worktree <span class="hljs-keyword">add</span> -b &lt;新分支&gt; &lt;路径&gt;         <span class="hljs-meta"># 创建新分支</span>
git worktree <span class="hljs-keyword">add</span> -d &lt;路径&gt;                 <span class="hljs-meta"># 分离HEAD</span>

<span class="hljs-meta"># 查看和管理</span>
git worktree list                         <span class="hljs-meta"># 查看所有工作区</span>
git worktree list -v                      <span class="hljs-meta"># 详细信息</span>
git worktree <span class="hljs-keyword">remove</span> &lt;路径&gt;                 <span class="hljs-meta"># 删除工作区</span>
git worktree prune                        <span class="hljs-meta"># 清理记录</span>

<span class="hljs-meta"># 锁定和修复</span>
git worktree <span class="hljs-keyword">lock</span> &lt;路径&gt;                   <span class="hljs-meta"># 锁定</span>
git worktree unlock &lt;路径&gt;                 <span class="hljs-meta"># 解锁</span>
git worktree repair                       <span class="hljs-meta"># 修复连接</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-198 KNN 必须先归一化：Min-Max 正确姿势、数据泄露陷阱与 sklearn 落地]]></title>    <link>https://juejin.cn/post/7588376012121767963</link>    <guid>https://juejin.cn/post/7588376012121767963</guid>    <pubDate>2025-12-29T02:16:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588376012121767963" data-draft-id="7588464673285570587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-198 KNN 必须先归一化：Min-Max 正确姿势、数据泄露陷阱与 sklearn 落地"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2025-12-29T02:16:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-198 KNN 必须先归一化：Min-Max 正确姿势、数据泄露陷阱与 sklearn 落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:16:10.000Z" title="Mon Dec 29 2025 02:16:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：KNN/距离类模型在量纲不统一数据上效果失真，且归一化顺序易引入数据泄露</li>
<li>结论：先划分数据集；只用训练集拟合归一化参数；测试集只做 transform；交叉验证用 Pipeline 才稳</li>
<li>产出：一套可复用的 MinMaxScaler + KNN（含 distance 权重）工程流程与排错清单</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da8b19427153402abb01fd25a0dcd0b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=q9XTeFwQU3G%2FkNy1zv33rZ5TJNU%3D" alt="大数据-198 KNN 必须先归一化：Min-Max 正确姿势、数据泄露陷阱与 sklearn 落地" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e60a8b6ad248458199305edcdb81c62e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=zNOFZAydezDpZbcELVDbRvveHc8%3D" alt="大数据-198 KNN 必须先归一化：Min-Max 正确姿势、数据泄露陷阱与 sklearn 落地" loading="lazy"/></p>
<h2 data-id="heading-1">归一化</h2>
<h3 data-id="heading-2">距离类模型归一化要求</h3>
<p>我们把 X 放到数据框中看一眼，是否观察到，每个特征值的均值差异很大？有的特征数值很大，有的特征数据很小，这种现象在机器学习中称为“量纲不统一”，KNN 是距离类模型，欧式距离的计算公式中存在着特征上的平方和：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0bc6c46d3724b6e943deceef7911d26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=Y6bEVaUeCICwbOho8R7eanvQY1A%3D" alt="距离类模型归一化要求" loading="lazy"/>
如果某个特征 Xi 的取值非常大，其他特征的取值和它比起来就不算什么，那么距离的大小很大程度上都回由这个 Xi 来决定，其他的特征之间的距离可能无法对 d(A,B)的大小产生什么影响，这种现象会让 KNN 这样的距离类模型的效果大打折扣。
然而实际分析情况中，绝大多数数据集都会存在各特征量纲不同的情况，此时若要使用KNN 分类器，则需要先对数据集进行归一化处理，即是将所有的数据压缩都同一个范围内。
当数据（X）按照最小值中心化后，再按极差（最大值-最小值）缩放，数据移动了最小值个单位，并且会被收敛到【0，1】之间，而这个过程，就称做数据归一化（Normalization，又称 Min-Max Scaling）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f4b589c9ebf41bbbb84f076401d7ecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=mGekvRj0sPZ0E73Z73KjrTzisbU%3D" alt="距离类模型归一化要求 数据归一化" loading="lazy"/></p>
<h3 data-id="heading-3">先分数据集 再做归一化</h3>
<h2 data-id="heading-4">机器学习数据预处理中的归一化注意事项</h2>
<h3 data-id="heading-5">错误做法分析</h3>
<p>直接在全数据集X上进行归一化后再进行交叉验证绘制学习曲线的做法存在严重问题，这种操作会导致数据泄露(data leakage)，具体表现在：</p>
<ol>
<li><strong>统计量计算错误</strong>：当使用全数据集计算归一化参数(如最小值和极差)时，这些参数实际上包含了未来测试集的信息</li>
<li><strong>评估偏差</strong>：这种操作会使模型在交叉验证中表现异常好，但这种"好"是虚假的，因为测试集信息已经通过归一化过程泄露给了训练过程</li>
</ol>
<h3 data-id="heading-6">正确做法详解</h3>
<p>正确的数据预处理流程应该遵循以下步骤：</p>
<ol>
<li><strong>数据分割</strong>：首先将完整数据集分割为训练集和测试集(通常比例为7:3或8:2)</li>
<li><strong>仅使用训练集计算归一化参数</strong>：在训练集上计算所需的归一化统计量(最小值、最大值、均值、标准差等)</li>
<li><strong>应用归一化</strong>：
<ul>
<li>使用训练集计算的参数对训练集本身进行归一化</li>
<li>使用相同的参数对测试集进行归一化(绝对不要在测试集上重新计算归一化参数)</li>
</ul>
</li>
<li><strong>模型训练与评估</strong>：在归一化后的数据上进行模型训练和交叉验证</li>
</ol>
<h3 data-id="heading-7">现实业务场景的重要性</h3>
<p>在实际业务中，这种规范尤为重要，因为：</p>
<ol>
<li><strong>模拟真实场景</strong>：我们永远只能基于历史数据(训练集)来构建模型，无法预先知道未来数据(测试集)的分布</li>
<li><strong>避免过度乐观</strong>：使用错误的归一化方法会导致模型评估结果过于乐观，从而可能选择在实际应用中表现不佳的模型</li>
<li><strong>流程一致性</strong>：生产环境中，新数据到来时也必须使用训练阶段确定的归一化参数进行处理</li>
</ol>
<h3 data-id="heading-8">示例说明</h3>
<p>假设我们有一个包含1000个样本的数据集：</p>
<ol>
<li>首先分割为700个训练样本和300个测试样本</li>
<li>在700个训练样本上计算最小值为10，最大值为90(极差为80)</li>
<li>使用这些参数：
<ul>
<li>训练集归一化：(每个值-10)/80</li>
<li>测试集归一化：(每个值-10)/80(即使测试集中出现值5或95)</li>
</ul>
</li>
<li>这样得到的评估结果才能真实反映模型在未知数据上的表现</li>
</ol>
<pre><code class="hljs language-python" lang="python">data = [[-<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],[-<span class="hljs-number">0.5</span>,<span class="hljs-number">6</span>],[<span class="hljs-number">0</span>,<span class="hljs-number">10</span>],[<span class="hljs-number">1</span>,<span class="hljs-number">18</span>]]
data=pd.DataFrame(data)
(data-np.<span class="hljs-built_in">min</span>(data,axis=<span class="hljs-number">0</span>))/(np.<span class="hljs-built_in">max</span>(data,axis=<span class="hljs-number">0</span>)-np.<span class="hljs-built_in">min</span>(data,axis=<span class="hljs-number">0</span>))
</code></pre>
<p>运行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fffd0c0ec2604c4aa0ec46c08d03328c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=VoO5wBf%2FvA%2FQyACzEiOMS7OXsPg%3D" alt="数据集训练" loading="lazy"/></p>
<h3 data-id="heading-9">通过 sklearn 实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> MinMaxScaler <span class="hljs-keyword">as</span> mms

Xtrain,Xtest,Ytrain,Ytest=train_test_split(X,y,test_size=<span class="hljs-number">0.2</span>,random_state=<span class="hljs-number">420</span>)
<span class="hljs-comment"># 归一化</span>
<span class="hljs-comment"># 求训练集最大/小值</span>
MMS_01=mms().fit(Xtrain) 
<span class="hljs-comment"># 求测试集最大/小值</span>
MMS_02=mms().fit(Xtest) 

<span class="hljs-comment"># 转换</span>
X_train=MMS_01.transform(Xtrain)
X_test =MMS_02.transform(Xtest)

score=[]
var=[]
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">20</span>):
    clf=KNeighborsClassifier(n_neighbors=i)
    <span class="hljs-comment"># 交叉验证的每次得分</span>
    cvresult=CVS(clf,X_train,Ytrain,cv=<span class="hljs-number">5</span>) 
    score.append(cvresult.mean())
    var.append(cvresult.var())

plt.plot(krange,score,color=<span class="hljs-string">"k"</span>)
plt.plot(krange,np.array(score)+np.array(var)*<span class="hljs-number">2</span>,c=<span class="hljs-string">"red"</span>,linestyle=<span class="hljs-string">"--"</span>)
plt.plot(krange,np.array(score)-np.array(var)*<span class="hljs-number">2</span>,c=<span class="hljs-string">"red"</span>,linestyle=<span class="hljs-string">"--"</span>)
plt.show()
</code></pre>
<p>运行之后，我们查看结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03201f25d1ce413a9628debb6161b20e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=8pVF6%2B81JIy6wseLsdrkTIM90ME%3D" alt="sklearn 计算结果绘图" loading="lazy"/></p>
<p>再次查看最大值，运行结果：</p>
<pre><code class="hljs language-python" lang="python">score.index(<span class="hljs-built_in">max</span>(score))+<span class="hljs-number">1</span>
</code></pre>
<p>输出结果是：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0885159067a2475d96838e11a56d2b54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=YSgr8nbLgj95zW5yeea354eRctA%3D" alt="计算的 index" loading="lazy"/></p>
<p>最终值是：7
无论 random_state取什么值，最优的 K 值都不会相差太多。</p>
<p>把经过交叉验证、归一化处理之后，我们得到最优 K 是 8，放在归一化后的训练集重新建模，然后在归一化后的测试集中查看结果分数：</p>
<pre><code class="hljs language-python" lang="python">clf=KNeighborsClassifier(n_neighbors=<span class="hljs-number">6</span>,weights=<span class="hljs-string">'distance'</span>).fit(X_train,Ytrain)
score=clf.score(X_test,Ytest)
score
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9925d36422747a8ad3000f8b54a8f15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=TMGiyLIjg7rFk7MtYTfUnZL33hk%3D" alt="KNeighborsClassifier" loading="lazy"/></p>
<h2 data-id="heading-10">距离的惩罚</h2>
<p>最近邻点距离远近修正在对未知样本分类过程中是一个重要的优化步骤。传统KNN模型采用"一点一票"的简单投票机制：在选取最近的K个邻居后，统计这些邻居的类别分布，每个邻居对分类结果的影响力相同。</p>
<p>然而这种简单投票机制存在明显缺陷。实际上，即使是K个最近邻点，它们与目标样本的距离也存在显著差异。根据KNN模型的基本假设——相似样本具有相似类别属性，距离更近的邻居往往与目标样本属于同一类别的概率更高。因此，距离较近的邻居理应比距离较远的邻居具有更大的投票权重。</p>
<p>举例来说，假设我们要对一个未知样本进行分类，K=5时找到的5个最近邻中：</p>
<ul>
<li>3个A类样本，距离分别为0.1、0.5、1.2</li>
<li>2个B类样本，距离分别为0.2、0.3</li>
</ul>
<p>在传统投票中A类以3:2胜出，但实际B类的两个样本距离明显更近。采用距离加权后，B类可能获得更高权重而胜出。常用的加权方式包括：</p>
<ol>
<li>反比加权：权重=1/(距离+ε)</li>
<li>高斯加权：权重=exp(-距离²/σ²)</li>
<li>线性加权：权重=(最大距离-距离)/(最大距离-最小距离)</li>
</ol>
<p>这种距离加权修正能更好地反映局部样本分布的实际情况，提高分类准确率，特别是在样本分布不均匀或存在噪声的情况下效果更为显著。</p>
<p>关于惩罚因子的选取有很多种方法，最常用的就是根据每个近邻 x=距离的不同对其做加权，加权方法设置 Wi 权重，该权重计算公式为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c90421c4eefc4e4fb1527aa72c3feb5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=9IPdIXJckunXmwyiy6LWUKSiec4%3D" alt="惩罚因子的方式" loading="lazy"/>
这里需要注意的是，关于模型的优化方法只是在理论上而言进行优化会提升模型判别效力，但实际应用过程中最终能否发挥作用，本质上缓释取决于优化方法和实际数据情况的契合程度，如果数据本身存在大量异常值点，则采用距离远近作为惩罚因子则会有较好的效果，反之则不然。
因此在实际我们进行模型优化的过程中，是否起到优化效果还是要以最终模型运行结果为准，在 sklearn 中，我们可以通过参数 weights 来控制是否适用距离作为惩罚因子。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">20</span>):
    clf=KNeighborsClassifier(n_neighbors=i,weights=<span class="hljs-string">'distance'</span>)
<span class="hljs-comment"># 交叉验证的每次得分</span>
    cvresult=CVS(clf,X_train,Ytrain,cv=<span class="hljs-number">5</span>) 
    score.append(cvresult.mean())
    var.append(cvresult.var())
plt.plot(krange,score,color=<span class="hljs-string">"k"</span>)
plt.plot(krange,np.array(score)+np.array(var)*<span class="hljs-number">2</span>,c=<span class="hljs-string">"red"</span>,linestyle=<span class="hljs-string">"--"</span>)
plt.plot(krange,np.array(score)-np.array(var)*<span class="hljs-number">2</span>,c=<span class="hljs-string">"red"</span>,linestyle=<span class="hljs-string">"--"</span>)
plt.show()
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78d0b2ef292e4d0b80d2cab733f62da9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=kz6na%2BHaTL742j92iiRM8rVzYXc%3D" alt="KNeighborsClassifier 绘制图片" loading="lazy"/>
生成的图片如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4860c708d1f344169e4eefcce902c797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=N9GrA95DRtlGXNlTQ5migsUvbpc%3D" alt="KNeighborsClassifier 绘制图片" loading="lazy"/>
此时查看最大值：</p>
<pre><code class="hljs language-shell" lang="shell">score.index(max(score))+1
</code></pre>
<p>输出结果如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eff46309def4813826ce1958f69cc9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=QQfskBkGGF%2FknKAPAxaglp3jNtQ%3D" alt="KNeighborsClassifier index max" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python">clf=KNeighborsClassifier(n_neighbors=<span class="hljs-number">6</span>,weights=<span class="hljs-string">'distance'</span>).fit(X_train,Ytrain)
score=clf.score(X_test,Ytest)
score
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b167161a777402ea6580888e974471e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767579369&amp;x-signature=%2BkldYBQyPS2aVhlz6uNy1pacAJY%3D" alt="KNeighborsClassifier 计算结果" loading="lazy"/></p>
<h2 data-id="heading-11">错误速查</h2>





















































<table><thead><tr><th>症状</th><th>根因</th><th>定位方法</th><th>修复方案</th></tr></thead><tbody><tr><td>交叉验证分数异常高、线上掉分明显</td><td>在全量 X 上 fit 归一化参数，产生 data leakage</td><td>检查是否在 split/CV 之前 fit scaler</td><td>先 split；仅在训练集 fit；CV 用 Pipeline（scaler+model）</td></tr><tr><td>测试集表现不稳定、不同 random_state 波动大</td><td>测试集单独 fit 了 scaler（训练/测试缩放标准不一致）</td><td>代码里出现 <code>mms().fit(Xtest)</code></td><td>测试集只用训练集 scaler 的 transform，不允许对 Xtest 再 fit</td></tr><tr><td>训练/测试落在不同的 [0,1] 区间映射</td><td>分别拟合了两个 MinMaxScaler</td><td>发现 <code>MMS_01</code> 和 <code>MMS_02</code> 同时存在且都 fit</td><td>只保留一个 scaler：fit(Xtrain)；两边都 transform</td></tr><tr><td>最优 K 结论前后不一致（7/8/6 混用）</td><td>文本与代码的 n_neighbors、index 计算未同步</td><td>文中“最终值是 7/最优K是8”，但建模用 <code>n_neighbors=6</code></td><td>统一口径：用同一套 score 列表与同一 n_neighbors 复现最终结论</td></tr><tr><td>绘图或循环报错（变量未定义/长度不匹配）</td><td>krange 未定义或与 score 长度不一致；score/var 未清空复用报 NameError 或 plot 维度错误</td><td>明确 <code>krange=range(1,20)</code>；每次实验前 <code>score=[]; var=[]</code></td><td/></tr><tr><td>加权 KNN 看似提升但不可复现</td><td>加权策略对异常点/噪声敏感，且评估流程不规范</td><td>对比不同 split、不同 CV 结果差异大</td><td>用固定评估协议：Pipeline + StratifiedKFold；同时报告均值与方差</td></tr><tr><td>线上新数据出现 &lt;0 或 &gt;1 的缩放结果被误判为错误</td><td>测试/线上数据超出训练集 min/max 属正常现象</td><td>发现 transform 后有负数或大于 1</td><td>保持训练期参数不变；必要时做异常值策略（截断/鲁棒缩放）并用验证集评估</td></tr></tbody></table>
<h2 data-id="heading-12">其他系列</h2>
<h3 data-id="heading-13">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-14">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-207 RabbitMQ Direct 交换器路由：RoutingKey 精确匹配、队列多绑定与日志分流实战</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-15">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 工作区使用技巧：让 AI 真正理解你的多项目协作]]></title>    <link>https://juejin.cn/post/7588865809473208360</link>    <guid>https://juejin.cn/post/7588865809473208360</guid>    <pubDate>2025-12-29T02:46:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588865809473208360" data-draft-id="7588745319401226240" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 工作区使用技巧：让 AI 真正理解你的多项目协作"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-29T02:46:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="37手游后端团队"/> <meta itemprop="url" content="https://juejin.cn/user/1548527766871239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 工作区使用技巧：让 AI 真正理解你的多项目协作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548527766871239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    37手游后端团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:46:27.000Z" title="Mon Dec 29 2025 02:46:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一篇实战向的工作区使用指南，用真实案例告诉你如何用 Cursor 工作区 + AI 高效管理多项目</p>
</blockquote>
<h2 data-id="heading-0">写在前面</h2>
<p>你有没有遇到过这样的场景：改一个功能，需要在三个项目里来回切换窗口？或者基于旧项目做新项目，不停地复制粘贴代码？又或者明明改了 A 项目，上线后才发现 B 项目也要改，但已经遗漏了？</p>
<p>这些都是我亲身踩过的坑。直到发现了 Cursor 的工作区功能，才意识到：<strong>原来 AI 可以同时"看到"多个项目，理解它们之间的关系！</strong></p>
<h2 data-id="heading-1">为什么你需要工作区？</h2>
<p><strong>传统方式的痛</strong>：</p>
<ul>
<li>😫 <code>Alt+Tab</code> 按到手酸，还容易按错窗口</li>
<li>😫 AI 只能看单个项目，给的建议经常不靠谱</li>
<li>😫 改完一个仓库，另一个仓库忘了改，上线背锅</li>
</ul>
<p><strong>工作区的爽</strong>：</p>
<ul>
<li>
<p>🎉 一个窗口搞定多个项目，眼不花了</p>
</li>
<li>
<p>🎉 AI 能跨项目学习，建议更准了</p>
</li>
<li>
<p>🎉 并行检索一键对比，不再遗漏了</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8915d561f07b4ce1a0d123c99e3ef443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzfmiYvmuLjlkI7nq6_lm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581187&amp;x-signature=kxmx7XUBOQhBdZ9tVtQYCZLr6ZI%3D" alt="14b7b79d0c50b61bcb0de17d28311f29.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">三分钟上手：速查清单</h2>
<h3 data-id="heading-3">📁 第一步：把项目"请"进来</h3>
<p>就三个操作，跟着做一遍就会了：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>️⃣ 文件 → 打开文件夹（先打开项目 <span class="hljs-selector-tag">A</span>）
<span class="hljs-number">2</span>️⃣ 文件 → 将文件夹添加到工作区（再加项目 <span class="hljs-selector-tag">B</span>、C...）
<span class="hljs-number">3</span>️⃣ 文件 → 将工作区另存为（保存成 <span class="hljs-selector-class">.code-workspace</span> 文件）
</code></pre>
<p><strong>小贴士</strong>：我一般会按职责排序，比如参考项目放最上面，方便查看。</p>
<h3 data-id="heading-4">🔍 第二步：跨项目"扫雷"技巧</h3>
<p>这是工作区的核心能力，我总结了三板斧：</p>
<p><strong>1️⃣ 关键词并行检索</strong>（一次搜索，全项目命中）</p>
<pre><code class="hljs language-css" lang="css">Ctrl+Shift+F 搜索 "CreateOrder"
↓
项目<span class="hljs-selector-tag">A</span>：找到 <span class="hljs-number">3</span> 处
项目<span class="hljs-selector-tag">B</span>：找到 <span class="hljs-number">5</span> 处  
项目C：找到 <span class="hljs-number">2</span> 处
→ 一眼看清谁改了谁没改
</code></pre>
<p><strong>2️⃣ 分层定位法</strong>（像剥洋葱一样，一层层找）</p>
<pre><code class="hljs language-bash" lang="bash">封装层（sdk/svc）
    ↓ 谁封装了这个能力？
调用层（svc_impls）
    ↓ 谁在用这个能力？
注入层（cmd/config）
    ↓ 怎么启动的？配置在哪？
</code></pre>
<p><strong>3️⃣ R/W/E/I/C 职责地图</strong>（不漏掉任何环节）</p>
<pre><code class="hljs language-css" lang="css">R - Read   读在哪？
W - Write  写在哪？
E - Entry  入口在哪？
<span class="hljs-selector-tag">I</span> - Inject 注入在哪？
C - Config 配置在哪？
</code></pre>
<h3 data-id="heading-5">💡 第三步：AI 提示词"咒语"</h3>
<p>这些是我常用的提示词，直接复制粘贴就能用，超级好用：</p>
<pre><code class="hljs language-arduino" lang="arduino">🔎 定位问题
<span class="hljs-string">"在工作区检索【CreateOrder】，列出每个项目的定义/调用/入口及函数名"</span>

🔀 对比差异
<span class="hljs-string">"对比三项目中【订单创建】与【库存扣减】职责，产出职责地图（R/W/E/I/C）"</span>

🔧 技术重构
<span class="hljs-string">"对比 PHP/Go 项目中【支付回调】逻辑，列出实现差异和可能遗漏的边界条件"</span>

🐛 排查 Bug
<span class="hljs-string">"对比所有项目的【积分计算】，找出实现差异和潜在 bug（重点关注四舍五入）"</span>

🛡️ 安全审计
<span class="hljs-string">"检查工作区所有项目中的 SQL 拼接/权限校验/敏感数据脱敏处理是否统一"</span>
</code></pre>
<p><strong>敲黑板</strong>：提示词里带上具体的关键词（如函数名、业务术语），AI 的回答会更准确！</p>
<h3 data-id="heading-6">⚠️ 会踩的坑（血泪教训）</h3>

























<table><thead><tr><th>坑</th><th>后果</th><th>教训</th></tr></thead><tbody><tr><td>只改了 A 项目，忘了 B</td><td>线上数据不一致</td><td><strong>一定要并行检索确认</strong></td></tr><tr><td>改了代码，忘改配置</td><td>发版后启动失败</td><td><strong>记得检查注入/配置层</strong></td></tr><tr><td>读写端用的不同数据源</td><td>查出来的数据是旧的</td><td><strong>用职责地图理清读写</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">实战案例：从零到一看懂工作区的威力</h2>
<h3 data-id="heading-8">案例一：项目复刻 —— 不用再复制粘贴了</h3>
<p><strong>真实场景</strong>：老板说，把 A 商城的代码复刻一份，加上秒杀、地址管理、会员等级功能，做成 B 商城。</p>
<p>以前我的做法：打开 A 项目 → 复制代码 → 打开 B 项目 → 粘贴 → 改改改... 来回切换 50 次，头都大了。</p>
<p>现在有了工作区：</p>
<pre><code class="hljs language-less" lang="less">📁 <span class="hljs-selector-tag">A</span><span class="hljs-selector-tag">-COIN-MALL</span> (参考项目，我的<span class="hljs-string">"教科书"</span>)
📁 <span class="hljs-selector-tag">B</span><span class="hljs-selector-tag">-COIN-MALL</span> (开发项目，正在施工)
</code></pre>
<p><strong>我的操作流程</strong>：</p>
<p><strong>Step 1</strong>：告诉 AI 项目关系</p>
<pre><code class="hljs language-css" lang="css">"<span class="hljs-selector-tag">A</span> 是参考项目，<span class="hljs-selector-tag">B</span> 是新项目。请学习 <span class="hljs-selector-tag">A</span> 的代码结构，
帮我在 <span class="hljs-selector-tag">B</span> 里实现相同风格的功能。"
</code></pre>
<p><strong>Step 2</strong>：指定参考文件</p>
<pre><code class="hljs language-css" lang="css">"参考 <span class="hljs-selector-tag">A</span> 的 svc_mall/precheck<span class="hljs-selector-class">.go</span>（商城预检查），
在 <span class="hljs-selector-tag">B</span> 里实现 svc_flash_sale/precheck<span class="hljs-selector-class">.go</span>（秒杀预检查）。"
</code></pre>
<p><strong>Step 3</strong>：AI 自动搞定</p>
<ul>
<li>✅ 自动识别预检查的流程模式</li>
<li>✅ 适配秒杀专属字段（时间槽、限购轮次等）</li>
<li>✅ 保持错误处理和命名风格一致</li>
<li>✅ 连注释风格都学会了！</li>
</ul>
<p><strong>效果对比</strong>：</p>

























<table><thead><tr><th>维度</th><th>传统复制粘贴</th><th>工作区 + AI</th></tr></thead><tbody><tr><td>时间</td><td>2-3 天</td><td>1 天</td></tr><tr><td>代码一致性</td><td>60%（改漏了很多）</td><td>95%</td></tr><tr><td>Bug 率</td><td>经常漏处理边界条件</td><td>AI 提醒了所有边界</td></tr></tbody></table>
<p><strong>真实感受</strong>：第一次用的时候，看着 AI 自动把 A 项目的模式迁移到 B，还保持了代码风格，我人都傻了... 这也太智能了吧！</p>
<h3 data-id="heading-9">案例二：架构分析 —— 三个项目到底谁调谁？</h3>
<p><strong>真实场景</strong>：新来的运营中台系统有三个仓库，看得我眼花缭乱。trigger？engine？action-proxy？谁调谁？数据怎么流转的？文档也没写清楚...</p>
<p>传统做法：打开三个窗口，在代码里各种搜索，画草图，脑补调用关系，一天过去了还是晕的。</p>
<p>工作区搞定：</p>
<pre><code class="hljs language-scss" lang="scss">📁 TRIGGER (触发层，负责监听)
📁 ENGINE (引擎层，负责编排)  
📁 ACTION-PROXY (执行层，负责干活)
</code></pre>
<p><strong>我的操作</strong>：</p>
<p>直接问 AI：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"分析工作区中三个项目的职责与协作方式，
画出调用链路和数据流转"</span>
</code></pre>
<p><strong>AI 给我画了这个图</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7743cb070174469993c5e76d8f1efde4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzfmiYvmuLjlkI7nq6_lm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581187&amp;x-signature=g%2BGbhj7iLY8Zoxdpe6ugW72Rdro%3D" alt="20f0c7f801cb330ab928f55f93d061b4.png" loading="lazy"/>
然后搜索 <code>ExecuteAction</code> 接口：</p>
<ul>
<li>Trigger 里：<strong>定义和发起调用</strong></li>
<li>Engine 里：<strong>接收和处理</strong></li>
<li>Action-Proxy 里：<strong>具体实现</strong></li>
</ul>
<p>一下子就理解了整个系统！</p>
<p><strong>效果</strong>：以前要一天才能搞清楚的架构，现在 30 分钟就懂了。</p>
<h3 data-id="heading-10">案例三：跨仓改动 —— 一个都不能少！</h3>
<p><strong>真实场景</strong>：老旧的数据库要下线了，系统里三个仓库都在双写数据（写 A 库也写 B 库），现在要统一只写 A 库。</p>
<p><strong>最怕的情况</strong>：改了两个仓库，漏了第三个 → 上线后数据不一致 → 故障 → 背锅</p>
<p>以前我是怎么做的：</p>
<ol>
<li>打开第一个项目，全局搜索 "DbWriteBCli"，改掉</li>
<li>打开第二个项目，再搜索一遍，改掉</li>
<li>打开第三个项目... 卧槽，忘了这个项目也要改！</li>
</ol>
<p><strong>用工作区就稳了</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">📁 USER-PROFILED-DAEMON (离线任务/缓存写入)
📁 USER-PROFILED (实时数据/Kafka消费入库)
📁 USER-PROFILED-API (对外接口/用户查询)
</code></pre>
<p><strong>第一步：并行检索定位</strong></p>
<p>一次搜索，三个项目全看到：</p>
<pre><code class="hljs language-scss" lang="scss">搜索："DbWriteBCli"（旧数据库的客户端）

结果：
📁 daemon    → SetIdDbCache (封装层)
             → consumer<span class="hljs-selector-class">.go</span> (调用层)  
             → wire_gen<span class="hljs-selector-class">.go</span> (注入层)

📁 profiled  → kafka2db (写入层)
             → <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.go</span> (启动层)
             → config<span class="hljs-selector-class">.yaml</span> (配置层)

📁 api       → UpsertRowKv (写入层)
             → info<span class="hljs-selector-class">.go</span> (接口层)
             → <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.go</span> (注入层)
</code></pre>
<p>一眼就看出来：<strong>三个项目都有写入！一个都不能漏！</strong></p>
<p><strong>第二步：画职责地图</strong></p>
<p>我用 R/W/E/I/C 五要素梳理清楚：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc3fed3779f46768fe7741e5a53a7a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzfmiYvmuLjlkI7nq6_lm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581187&amp;x-signature=EB0D1jPW2HJsryoshbHS%2BtoyhHw%3D" alt="120405572606f858e09b46154891ad0f.png" loading="lazy"/>
<strong>第三步：执行清单</strong></p>
<pre><code class="hljs language-bash" lang="bash">✅ daemon/SetIdDbCache.go    → 删除 DbWriteB 调用
✅ daemon/wire_gen.go         → 清理注入
✅ profiled/kafka2db/main.go  → 改配置，只写 A
✅ profiled/config.yaml       → 删除 DbB 配置
✅ api/UpsertRowKv.go         → 删除双写逻辑
✅ api/main.go                → 清理注入
</code></pre>
<p><strong>验证环节</strong>：</p>
<ul>
<li>✅ 读写端都指向 A 库了吗？（用工作区全局搜索确认）</li>
<li>✅ 重试逻辑统一了吗？</li>
<li>✅ 监控和日志都改了吗？</li>
</ul>
<p><strong>效果</strong>：</p>
<ul>
<li>🎯 <strong>0 遗漏</strong>：并行检索保证不漏项目</li>
<li>🎯 <strong>0 回滚</strong>：职责地图确保改得完整</li>
<li>🎯 <strong>省时间</strong>：以前要 2 天确认，现在 2 小时搞定</li>
</ul>
<hr/>
<h2 data-id="heading-11">方法论沉淀：我总结的工作区"心法"</h2>
<h3 data-id="heading-12">核心三板斧（屡试不爽）</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c58866359c2474384b13f9756d164f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzfmiYvmuLjlkI7nq6_lm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581187&amp;x-signature=YdOfqkq48fDtLy%2FeH%2BmnIAl%2FPzs%3D" alt="a2cf44ddf883967d2b0141066847a896.png" loading="lazy"/>
<strong>实战心得</strong>：</p>
<ul>
<li>并行检索帮你"看全"</li>
<li>分层对比帮你"看透"</li>
<li>职责地图帮你"看懂"</li>
</ul>
<h3 data-id="heading-13">更多玩法（工作区还能这样用）</h3>
<p><strong>🔧 场景四：技术栈升级（PHP → Go）</strong></p>
<p>老系统是 PHP 写的，现在要用 Go 重写。最怕的就是漏掉业务逻辑！</p>
<pre><code class="hljs language-go" lang="go">📁 legacy-php-project (旧系统，<span class="hljs-number">30</span> 万行代码)
📁 <span class="hljs-built_in">new</span>-<span class="hljs-keyword">go</span>-project (新系统，正在重写)
</code></pre>
<p>问 AI：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"对比 PHP 和 Go 项目中【订单创建】逻辑，
列出实现差异和可能的遗漏点"</span>
</code></pre>
<p>AI 给我找出来：</p>
<ul>
<li>❌ PHP 有 <code>empty($userId)</code> 检查，Go 版本漏了</li>
<li>❌ PHP 有 <code>try-catch</code> 捕获异常，Go 的 error 处理不够完整</li>
<li>❌ PHP 的数字用了 <code>bcmath</code> 精确计算，Go 用了 float64 会丢精度</li>
</ul>
<p>这些细节如果不对比，根本想不起来！</p>
<hr/>
<p><strong>🐛 场景五：Bug 排查（多端逻辑不一致）</strong></p>
<p>用户反馈：为啥 Web 端的优惠金额和小程序不一样？</p>
<pre><code class="hljs language-scss" lang="scss">📁 web-client (Web 端)
📁 <span class="hljs-selector-tag">h5</span>-client (H5 端)
📁 miniprogram-client (小程序端)
</code></pre>
<p>问 AI：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"对比三个项目的【优惠券计算】逻辑，
找出实现差异"</span>
</code></pre>
<p>AI 发现了问题：</p>
<ul>
<li>Web 端：<code>Math.round()</code> 四舍五入</li>
<li>H5 端：<code>Math.floor()</code> 向下取整，而且漏了满减门槛校验</li>
<li>小程序：<code>toFixed(2)</code> 四舍五入</li>
</ul>
<p>难怪金额对不上！马上统一成四舍五入，bug 解决。</p>
<p><strong>类似场景</strong>：积分计算、库存扣减、价格折扣... 多端开发最容易不一致。</p>
<hr/>
<p><strong>🛡️ 场景六：代码审计（安全检查）</strong></p>
<p>公司要做安全审计，要检查所有项目有没有 SQL 注入风险。</p>
<pre><code class="hljs language-css" lang="css">📁 project-<span class="hljs-selector-tag">a</span>
📁 project-<span class="hljs-selector-tag">b</span>
📁 project-c
</code></pre>
<p>问 AI：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"检查工作区所有项目中是否存在 SQL 拼接、
fmt.Sprintf 构造 SQL 的情况"</span>
</code></pre>
<p>AI 扫出来一堆问题：</p>
<ul>
<li>A 项目：用了 ORM，安全 ✅</li>
<li>B 项目：还在用字符串拼接 SQL ⚠️</li>
<li>C 项目：部分接口缺少权限校验 ⚠️</li>
</ul>
<p>一次性把隐患都找出来了，省得一个个项目翻。</p>
<p><strong>还能检查</strong>：</p>
<ul>
<li>敏感数据脱敏（手机号、身份证）是否统一</li>
<li>API 接口的鉴权是否完整</li>
<li>日志里有没有打印密码等敏感信息</li>
</ul>
<h3 data-id="heading-14">六大适用场景全景图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6404cae818024f84be24d1b3857735fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzfmiYvmuLjlkI7nq6_lm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767581187&amp;x-signature=XwAPaUCfUoP1j%2BT8NmtWp4vhgDU%3D" alt="cf0eca19cbcacdabc7327dfc21e1a43d.png" loading="lazy"/></p>
<h3 data-id="heading-15">AI 提示词大全（复制即用）</h3>
<p>把这些提示词收藏好，以后直接粘贴，改几个关键词就能用！</p>
<p><strong>📍 基础定位类</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"在工作区检索【CreateOrder】，列出每个项目的定义/调用/入口，输出文件与函数名。"</span>

<span class="hljs-string">"对比三项目中【订单模块】与【支付模块】职责，生成职责地图（R/W/E/I/C）。"</span>

<span class="hljs-string">"分析工作区中【用户登录】的完整调用链，从入口到数据库层，画出流程图。"</span>

<span class="hljs-string">"给出【下线旧缓存】的最小化编辑清单（按仓库→文件→函数，不展开代码）。"</span>
</code></pre>
<p><strong>🔧 技术升级类</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"对比 PHP 项目和 Go 项目中【订单创建】逻辑，列出实现差异和可能遗漏的边界条件。"</span>

<span class="hljs-string">"检查 Go 项目是否完整迁移了 PHP 项目中的所有边界条件处理（empty/isset/try-catch）。"</span>

<span class="hljs-string">"列出 PHP 项目中使用的特殊函数（如 bcmath、session、cookie），检查 Go 项目的对应实现。"</span>

<span class="hljs-string">"对比 Java 和 Go 项目中的【事务处理】方式，列出需要注意的差异点。"</span>
</code></pre>
<p><strong>🐛 Bug 排查类</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"对比工作区内所有项目的【优惠券计算】逻辑，找出实现差异和潜在 bug（重点关注四舍五入）。"</span>

<span class="hljs-string">"检查 Web/H5/小程序三个客户端项目中【积分扣减】逻辑是否一致，列出不一致的地方。"</span>

<span class="hljs-string">"分析多个项目中【库存扣减】的并发处理方式，找出可能的竞态条件和锁机制差异。"</span>

<span class="hljs-string">"对比【支付回调】在不同项目中的重试机制、幂等性处理、超时配置，找出潜在问题。"</span>
</code></pre>
<p><strong>🛡️ 代码审计类</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"检查工作区所有项目中是否存在 SQL 拼接、fmt.Sprintf 构造 SQL 的情况，输出文件和行号。"</span>

<span class="hljs-string">"查找所有项目中缺少用户权限校验的接口（public HTTP 方法但无 auth 中间件检查）。"</span>

<span class="hljs-string">"对比项目间敏感数据（手机号、身份证、密码）的脱敏处理是否统一，列出不规范的地方。"</span>

<span class="hljs-string">"检查所有项目的日志打印，是否存在输出敏感信息（密码、token、身份证）的情况。"</span>

<span class="hljs-string">"分析工作区中【文件上传】功能的安全性，检查是否有文件类型/大小/路径校验。"</span>
</code></pre>
<p><strong>小技巧</strong>：</p>
<ul>
<li>🎯 关键词越具体，AI 回答越准确（比如用"CreateOrder"而不是"订单"）</li>
<li>🎯 明确你的目的（找 bug、对比差异、生成清单...）</li>
<li>🎯 要求输出格式（文件名+行号、职责地图、流程图...）</li>
</ul>
<h3 data-id="heading-16">快捷键速查</h3>





















































<table><thead><tr><th>功能</th><th>Windows/Linux</th><th>Mac</th><th>我的使用频率</th></tr></thead><tbody><tr><td>工作区全局搜索</td><td><code>Ctrl+Shift+F</code></td><td><code>⌘+Shift+F</code></td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>快速打开文件</td><td><code>Ctrl+P</code></td><td><code>⌘+P</code></td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>符号搜索</td><td><code>Ctrl+P</code> → <code>@</code></td><td><code>⌘+P</code> → <code>@</code></td><td>⭐⭐⭐⭐</td></tr><tr><td>跳转到定义</td><td><code>F12</code></td><td><code>F12</code></td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>查找所有引用</td><td><code>Shift+F12</code></td><td><code>Shift+F12</code></td><td>⭐⭐⭐⭐</td></tr><tr><td>侧边打开文件</td><td><code>Ctrl+\</code></td><td><code>⌘+\</code></td><td>⭐⭐⭐</td></tr><tr><td>返回上一位置</td><td><code>Alt+←</code></td><td><code>⌘+[</code></td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<p><strong>私藏技巧</strong>：</p>
<ul>
<li><code>Ctrl+Shift+F</code> 搜索时，可以用正则表达式</li>
<li><code>F12</code> 跳转后，<code>Alt+←</code> 快速返回，来回跳转超快</li>
<li>同时打开多个文件对比时，用 <code>Ctrl+\</code> 分屏查看</li>
</ul>
<hr/>
<h2 data-id="heading-17">写在最后</h2>
<p>工作区这个功能，我用了半年多，真的改变了我的开发方式。以前多项目开发就像打地鼠，哪里有问题改哪里，经常漏改。现在有了工作区 + AI，就像开了上帝视角，能同时看到所有项目，AI 还能帮我对比分析。</p>
<p><strong>最大的感受</strong>：</p>
<ul>
<li>💡 <strong>不再遗漏</strong>：并行检索让我看到全貌</li>
<li>💡 <strong>更快理解</strong>：AI 跨项目分析，快速理解架构</li>
<li>💡 <strong>更少 Bug</strong>：代码对比发现隐藏的逻辑差异</li>
<li>💡 <strong>更好传承</strong>：新人看工作区配置就能理解项目关系</li>
</ul>
<p>如果你也在做多项目开发，强烈建议试试工作区。第一次用可能会有点不习惯，但用几次之后，你就再也回不去了。</p>
<p>祝大家都能早日告别 <code>Alt+Tab</code>，拥抱工作区！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA["氛围编程"程序员被解雇了]]></title>    <link>https://juejin.cn/post/7588730836864253967</link>    <guid>https://juejin.cn/post/7588730836864253967</guid>    <pubDate>2025-12-29T02:39:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588730836864253967" data-draft-id="7588865809473142824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="&quot;氛围编程&quot;程序员被解雇了"/> <meta itemprop="keywords" content="前端,人工智能,Android"/> <meta itemprop="datePublished" content="2025-12-29T02:39:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张拭心"/> <meta itemprop="url" content="https://juejin.cn/user/571401775094312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            "氛围编程"程序员被解雇了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/571401775094312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张拭心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T02:39:46.000Z" title="Mon Dec 29 2025 02:39:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ede3ccda94a4280a18b0d887abad422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byg5out5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767580786&amp;x-signature=eG7WUXp4ft4t1Fckibgw2GnLioo%3D" alt="image.png" loading="lazy"/></p>
<p>很多程序员沉迷于“氛围编程”，而忘了自己存在的价值：<strong>理解、判断、负责</strong>。</p>
<p>当 AI 生成了一段看起来没问题的代码时，你能看出来它在边界情况下会崩溃；当 AI 给了你一个"标准答案"时，你能想到更好的架构；当 AI 犯错时，你能迅速定位问题，而不是束手无策。</p>
<p>这听起来简单，但实际上需要<strong>付出极大的自律，才能不断地投入精力来认真审查和优化 AI 输出的代码</strong>，提出“为什么这样实现”或者“是否兼容所有情况、是否会有 XX 问题”等问题，并在 AI 回答后进行适当的测试确认。</p>
<p><strong>AI 现在就像一种强效毒品：服用过量会毁了你，服用过少又会让你落后于服用量更大的人。</strong></p>
<p>难点在于<strong>找到平衡点、找到最适合你的量</strong>，让你在 AI 的加持下能更轻松，又不至于变得更蠢。</p>
<p>有个资深开发者在 Reddit 上说："对我们这种有经验的人来说，很快我们会变得像黄金一样值钱。那些只会用 AI 的所谓的“氛围程序员”们会创造出一大堆技术债务，到时候还得我们来收拾干净。"</p>
<p>如果你沉迷于"氛围编程"，享受那种回车键一敲 AI 都搞定的快感，却从不停下来问问自己"我真的理解这些吗"，你迟早会成为漫画里那个人。</p>
<blockquote>
<p>《转型 AI 工程师》一阶段已完成：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FBcrTHliEQaV4fLz0_NRHGA" target="_blank" title="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FBcrTHliEQaV4fLz0_NRHGA">mp.weixin.qq.com/s/BcrTHliEQ…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失]]></title>    <link>https://juejin.cn/post/7588445332771881014</link>    <guid>https://juejin.cn/post/7588445332771881014</guid>    <pubDate>2025-12-29T01:01:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588445332771881014" data-draft-id="7587606718843732009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-29T01:01:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            历史性突破！LCP 和 INP 终于覆盖所有主流浏览器，iOS 性能盲点彻底消失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:01:42.000Z" title="Mon Dec 29 2025 01:01:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>随着 Safari 26.2 在 12 月 12 日的发布，Web 性能领域迎来了一个令人振奋的年终礼物：最大内容绘制（LCP）和交互到下次绘制（INP）现已正式成为 Baseline 新可用功能。所有主流浏览器的最新版本现在都包含了测量这些指标所需的最大内容绘制 API 和事件计时 API。这是 Interop 2025 项目的一部分，很高兴看到这些功能在今年成功交付！</p>
<h2 data-id="heading-0">这意味着什么</h2>
<p>核心 Web 指标（Core Web Vitals）已成为衡量网页体验的广泛采用标准，无论是对于 Web 开发者还是业务利益相关者而言都是如此。它们试图将复杂的 Web 性能故事总结为几个关键指标：页面加载速度（LCP）、交互响应速度（INP）以及内容稳定性（CLS）。</p>
<p>长期以来，这些指标只能在基于 Chromium 的浏览器（如 Chrome 和 Edge）中测量。在 iOS 设备上，由于所有浏览器都使用驱动 Safari 的 WebKit 浏览器引擎，这些指标完全不可用。这造成了一个盲点：网站可能不知道大量访问者正在经历完全不同的体验。虽然许多 Web 性能改进确实使所有浏览器受益，但某些技术和 API 仅在部分浏览器中可用。此外，浏览器内部的工作方式、页面加载方式以及处理交互的方式可能彼此不同。仅拥有网站性能的部分视图远非理想状态。</p>
<p>随着所有主流浏览器现在都支持这两个指标，我们现在可以更好地了解网站的关键加载和交互性能。这将使网站所有者能够更好地理解性能问题并识别可以进行的改进，最终使用户和业务指标受益。</p>
<h2 data-id="heading-1">其他浏览器的数据会进入 CrUX 吗？</h2>
<p>不会。Chrome 用户体验报告（CrUX）仅基于符合条件的 Chrome 用户，这一点不会改变。这也适用于使用此数据的下游系统，如 PageSpeed Insights、Google Search Console 和 CrUX Vis。</p>
<p>这也将继续排除 Chrome iOS 用户，因为他们使用 WebKit 浏览器引擎。</p>
<h2 data-id="heading-2">如何从其他浏览器测量</h2>
<p>CrUX 数据仍然作为网站性能的摘要很有用，并且可以与网络上的其他网站进行基准测试。然而，由于它是一个高级摘要，我们长期以来一直建议测量更详细的真实用户数据（field data）以帮助识别和改进性能。</p>
<p>真实用户监控（RUM）工具现在能够收集额外的真实用户数据，包括通过 Chrome 团队的 web-vitals 库测量的数据。在大多数情况下，这应该自动开始包含在您现有的解决方案中，但如果您有任何问题，请与您的 RUM 提供商确认。</p>
<p>请注意，RUM 和 CrUX 之间可能存在差异，现在这些指标在更多不包括在 CrUX 中的浏览器中可用，这种差异可能更加明显。</p>
<h2 data-id="heading-3">实现方式有什么不同吗？</h2>
<p>虽然所有浏览器引擎在加载和显示网页方面大致执行相同的任务，但这些浏览器的构建方式存在许多差异，特别是在它们的渲染管道中，这些管道将网站的代码（主要是 HTML、CSS 和 JavaScript）转换为屏幕上的像素。</p>
<p>渲染循环的结束大致是可互操作的，被定义为 <code>paintTime</code>。然而，在这之后，有一个稍后的 <code>presentationTime</code>，这是特定于实现的，旨在指示像素实际绘制到屏幕上的时间。Chrome 测量 LCP 直到 <code>presentationTime</code> 结束，而 Firefox 和 Safari 不包括 <code>presentationTime</code>，因此测量到更早的 <code>paintTime</code>。这导致测量结果之间存在几毫秒的差异。从 Chrome 145 开始，<code>paintTime</code> 测量也将为 LCP 公开，以便那些希望能够在浏览器之间进行同类比较的人使用。</p>
<p>同样的差异也适用于 INP。</p>
<p>其他浏览器实现这些指标的事实，有助于识别一些需要澄清和更好定义的未解决问题。这再次可能导致轻微差异——尽管这些主要出现在边缘情况中。这就是拥有多个实现和关注 API 的好处！我们将继续致力于这些以及指标的任何其他改进。</p>
<p>然而，尽管存在这些小的差异，我们确信 LCP 和 INP 大致是可互操作的，因此我们很高兴它们被标记为 Baseline 新可用功能。那些实现 RUM 解决方案或深入研究数据的人可能会注意到其中一些差异，但 Web 开发者应该对跨浏览器测量这些指标充满信心，尽管存在这些微小差异。</p>
<h2 data-id="heading-4">不支持这些 API 的浏览器怎么办？</h2>
<p>Baseline 新可用功能仅在所有主流浏览器的最新版本中可用。您的用户群可能不会立即升级，或者可能无法升级，这取决于他们的操作系统和提供商。30 个月后，它们将被视为 Baseline 广泛可用，因为大多数用户可能会使用支持这些功能的浏览器。</p>
<p>然而，作为测量 API 而不是网站的核心功能，您可以安全地为支持这些功能的浏览器测量这些指标——就像您到目前为止可能一直在做的那样。只需注意，您可能正在看到过滤后的用户视图——那些已升级的用户——特别是在最初的几个月里。</p>
<h2 data-id="heading-5">累积布局偏移（CLS）呢？</h2>
<p>第三个核心 Web 指标是累积布局偏移（CLS），它不是 Interop 2025 项目的一部分——尽管它已被提议用于 Interop 2026。目前，除了基于 Chromium 的浏览器之外，它不受支持。</p>
<h2 data-id="heading-6">结论</h2>
<p>Web Vitals 计划的目标是通过为 Web 平台创建一套标准 API 来改善 Web 性能，使关键指标能够被测量并被网站所有者广泛理解。很高兴看到这些指标中的两个现在得到了所有主流浏览器的支持。我们期待看到这些指标为网站所有者提供什么见解，以及这如何带来更好的用户体验！</p>
<p><strong>参考来源：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fblog%2Flcp-and-inp-are-now-baseline-newly-available" target="_blank" title="https://web.dev/blog/lcp-and-inp-are-now-baseline-newly-available" ref="nofollow noopener noreferrer">web.dev - LCP and INP are now Baseline Newly available</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[夜莺告警引擎内核：一个优雅的设计]]></title>    <link>https://juejin.cn/post/7588411503121268772</link>    <guid>https://juejin.cn/post/7588411503121268772</guid>    <pubDate>2025-12-29T01:23:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588411503121268772" data-draft-id="7588411503121252388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="夜莺告警引擎内核：一个优雅的设计"/> <meta itemprop="keywords" content="后端,Go,运维"/> <meta itemprop="datePublished" content="2025-12-29T01:23:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            夜莺告警引擎内核：一个优雅的设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:23:41.000Z" title="Mon Dec 29 2025 01:23:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">夜莺告警引擎内核：一个优雅的设计</h2>
<p>这是一个从 Prometheus 指标到告警事件的完整引擎。它做的事情很简单：<strong>把 Prometheus 里的指标曲线，变成可追踪、可管理的告警事件</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、这个引擎解决什么问题？</h3>
<h4 data-id="heading-2">它做的事</h4>
<p>假设你的系统在 Prometheus 里有这些指标：</p>
<ul>
<li><code>alarm_log_error_total</code>：错误日志数量</li>
<li><code>alarm_sql_slow_count</code>：慢 SQL 数量</li>
<li><code>alarm_api_timeout_total</code>：API 超时数量</li>
</ul>
<p>这个引擎的工作就是：</p>
<ol>
<li><strong>定时去 Prometheus 查询</strong>这些指标</li>
<li><strong>判断是否异常</strong>（比如错误数 &gt; 10）</li>
<li><strong>确认是真问题还是毛刺</strong>（持续一段时间才算）</li>
<li><strong>生成告警事件</strong>，记录下来，必要时发通知</li>
<li><strong>追踪告警状态</strong>：知道哪些问题还在，哪些已经恢复</li>
</ol>
<h4 data-id="heading-3">为什么需要这个引擎？</h4>
<p>Prometheus 自己只负责存指标，不管告警。它的原生告警功能 Alertmanager 太重，而且：</p>
<ul>
<li>无法细粒度控制告警生命周期</li>
<li>难以和业务系统集成</li>
<li>状态管理不够灵活</li>
</ul>
<p>所以需要自己做一个轻量级的告警引擎，完全控制从"指标异常"到"告警事件"的全过程。</p>
<hr/>
<h3 data-id="heading-4">二、整体架构：五个核心组件</h3>
<p>整个引擎分成五层，每层干一件事：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Prometheus&lt;br/&gt;指标数据源] --&gt; B[Scheduler&lt;br/&gt;定时调度器]
    B --&gt; C[Evaluator&lt;br/&gt;规则评估器]
    C --&gt; D[AlertQueue&lt;br/&gt;事件队列]
    D --&gt; E[Workers&lt;br/&gt;消费处理]
    E --&gt; F[Database&lt;br/&gt;当前/历史告警]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#ffe1f5
    style E fill:#e1ffe1
    style F fill:#f5e1ff
</code></pre>
<p><strong>各层职责：</strong></p>



































<table><thead><tr><th>组件</th><th>功能</th><th>为什么这样设计</th></tr></thead><tbody><tr><td><strong>Prometheus</strong></td><td>存储所有业务指标</td><td>作为唯一的事实来源，告警引擎只读不写</td></tr><tr><td><strong>Scheduler</strong></td><td>每隔 N 秒触发一次评估</td><td>定时轮询，简单可靠</td></tr><tr><td><strong>Evaluator</strong></td><td>执行 PromQL 判断是否异常</td><td>纯计算逻辑，不做 I/O，保证评估速度</td></tr><tr><td><strong>AlertQueue</strong></td><td>缓冲告警事件</td><td>解耦评估和处理，削峰填谷</td></tr><tr><td><strong>Workers</strong></td><td>写库、发通知、去重</td><td>异步处理重活，不拖慢评估</td></tr></tbody></table>
<p><strong>核心设计思想：评估和处理分离</strong></p>
<p>Evaluator 只管"算"，不管"写"。所有状态变化都变成事件，丢给队列慢慢处理。这样：</p>
<ul>
<li>评估永远很快，不会因为数据库慢而卡住</li>
<li>告警量暴增时，队列可以缓冲</li>
<li>后续要加通知、静默等功能，直接在 Worker 里加逻辑即可</li>
</ul>
<hr/>
<h3 data-id="heading-5">三、告警规则：定义"什么算异常"</h3>
<h4 data-id="heading-6">规则长什么样</h4>
<p>每条规则包含三个核心字段：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> AlertRule <span class="hljs-keyword">struct</span> {
    ID          <span class="hljs-type">uint64</span>    <span class="hljs-comment">// 规则ID</span>
    Name        <span class="hljs-type">string</span>    <span class="hljs-comment">// 规则名称，如"错误日志告警"</span>
    Expr        <span class="hljs-type">string</span>    <span class="hljs-comment">// PromQL 表达式</span>
    ForDuration <span class="hljs-type">uint</span>      <span class="hljs-comment">// 持续时间（秒），如 60 表示持续1分钟</span>
    Enabled     <span class="hljs-type">bool</span>      <span class="hljs-comment">// 是否启用</span>
}
</code></pre>
<p><strong>示例规则：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">规则1:</span> <span class="hljs-string">错误日志告警</span>
  <span class="hljs-attr">Expr:</span> <span class="hljs-string">increase(alarm_log_error_total[1m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">ForDuration:</span> <span class="hljs-number">60</span><span class="hljs-string">秒</span>
  
<span class="hljs-string">规则2:</span> <span class="hljs-string">SQL异常告警</span>  
  <span class="hljs-attr">Expr:</span> <span class="hljs-string">alarm_sql_abnormal</span> <span class="hljs-string">==</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">ForDuration:</span> <span class="hljs-number">0</span><span class="hljs-string">秒（立即告警）</span>
</code></pre>
<h4 data-id="heading-7">Prometheus 怎么配合工作？</h4>
<p>告警引擎不负责采集指标，它假设：</p>
<ol>
<li>你的应用已经通过 Exporter 或 SDK 把指标暴露给 Prometheus</li>
<li>Prometheus 已经在定时抓取这些指标</li>
<li>引擎只需要用 PromQL 去查询当前状态</li>
</ol>
<p><strong>数据流向：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[应用/中间件] --&gt;|暴露指标| B[Prometheus Exporter]
    B --&gt;|scrape| C[Prometheus TSDB]
    C --&gt;|PromQL查询| D[告警引擎 Evaluator]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#ffe1f5
</code></pre>
<p>这样分工的好处：</p>
<ul>
<li><strong>Prometheus 专注采集和存储</strong>：它做自己最擅长的事</li>
<li><strong>告警引擎专注判断和通知</strong>：不用管数据从哪来</li>
<li><strong>两者松耦合</strong>：换个时序库也不影响告警逻辑</li>
</ul>
<hr/>
<h3 data-id="heading-8">四、告警事件是怎么产生的？</h3>
<h4 data-id="heading-9">核心概念：Fingerprint</h4>
<p>一条告警对应的是"规则 + 特定标签组合"。比如：</p>
<pre><code class="hljs language-text" lang="text">规则: 错误日志告警
标签: {service="order", host="server-01"}

生成 Fingerprint: hash(rule_id + labels) = "abc123"
</code></pre>
<p><strong>为什么需要 Fingerprint？</strong></p>
<p>同一个规则可能命中多个实例：</p>
<ul>
<li><code>{service="order", host="server-01"}</code> 在告警</li>
<li><code>{service="order", host="server-02"}</code> 也在告警</li>
</ul>
<p>每个实例是独立的告警，需要单独追踪。Fingerprint 就是"告警实例"的唯一标识。</p>
<h4 data-id="heading-10">评估流程：从指标到事件</h4>
<p>每次评估做这几件事：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[1.执行 PromQL] --&gt; B[2.生成 Fingerprint]
    B --&gt; C[3.查询当前状态]
    C --&gt; D{4.是否首次命中?}
    D --&gt;|是| E[创建 pending]
    D --&gt;|否| F[更新计数和时间]
    E --&gt; G[5.判断持续时长]
    F --&gt; G
    G --&gt; H[6.推入队列]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style G fill:#ffe1f5
    style H fill:#e1ffe1
</code></pre>
<p><strong>伪代码（思想版）：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">evaluateRule</span><span class="hljs-params">(rule AlertRule)</span></span> {
    <span class="hljs-comment">// 1. 查询 Prometheus，得到一批 time series</span>
    seriesList := queryPrometheus(rule.Expr)
    
    currentFingerprints := []<span class="hljs-type">string</span>{} <span class="hljs-comment">// 本轮命中的实例</span>
    
    <span class="hljs-keyword">for</span> _, series := <span class="hljs-keyword">range</span> seriesList {
        <span class="hljs-comment">// 2. 生成唯一标识</span>
        fp := hash(rule.ID + series.Labels)
        currentFingerprints.<span class="hljs-built_in">append</span>(fp)
        
        <span class="hljs-comment">// 3. 加载或创建告警状态</span>
        alert := loadOrCreate(fp)
        alert.TriggerCount++
        alert.LastTriggerAt = now()
        
        <span class="hljs-comment">// 4. 判断是否达到 for_duration</span>
        elapsed := now() - alert.FirstTriggerAt
        <span class="hljs-keyword">if</span> elapsed &gt;= rule.ForDuration &amp;&amp; alert.Status == <span class="hljs-string">"pending"</span> {
            alert.Status = <span class="hljs-string">"firing"</span>  <span class="hljs-comment">// 从观察期转为真正告警</span>
        }
        
        <span class="hljs-comment">// 5. 推入队列，交给 Worker 处理</span>
        queue.Push(alert)
    }
    
    <span class="hljs-comment">// 6. 恢复检测：本轮没命中的，视为已恢复</span>
    <span class="hljs-keyword">for</span> _, old := <span class="hljs-keyword">range</span> getCurrentAlerts(rule.ID) {
        <span class="hljs-keyword">if</span> !currentFingerprints.contains(old.Fingerprint) {
            moveToHistory(old)  <span class="hljs-comment">// 从 current 删除，写入 history</span>
        }
    }
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>Evaluator 不直接写数据库，只生成事件</li>
<li>所有 I/O 操作都在 Worker 里异步完成</li>
<li>评估速度快，不会被拖慢</li>
</ul>
<hr/>
<h3 data-id="heading-11">五、防抖动设计：如何避免误报？</h3>
<h4 data-id="heading-12">问题：网络抖动、偶发错误不该告警</h4>
<p>假设 API 偶尔超时一次，或者网络瞬间抖动，这种情况不该打扰人。需要一个机制来判断：<strong>这是真问题，还是毛刺？</strong></p>
<h4 data-id="heading-13">解决方案：for_duration 观察期</h4>
<p>告警分两个阶段：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次命中] --&gt; B[pending&lt;br/&gt;观察中]
    B --&gt;|持续 &gt;= for_duration| C[firing&lt;br/&gt;确认告警]
    C --&gt;|不再命中| D[resolved&lt;br/&gt;已恢复]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffcccc
    style D fill:#ccffcc
</code></pre>
<p><strong>状态定义：</strong></p>

























<table><thead><tr><th>状态</th><th>含义</th><th>是否通知</th></tr></thead><tbody><tr><td><strong>pending</strong></td><td>观察中，可能是毛刺</td><td>否</td></tr><tr><td><strong>firing</strong></td><td>确认告警，真出问题了</td><td>是</td></tr><tr><td><strong>resolved</strong></td><td>已恢复</td><td>是（恢复通知）</td></tr></tbody></table>
<p><strong>实现细节：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> CurrentAlert <span class="hljs-keyword">struct</span> {
    Fingerprint    <span class="hljs-type">string</span>    <span class="hljs-comment">// 唯一标识</span>
    Status         <span class="hljs-type">string</span>    <span class="hljs-comment">// pending / firing</span>
    FirstTriggerAt time.Time <span class="hljs-comment">// 第一次命中时间</span>
    LastTriggerAt  time.Time <span class="hljs-comment">// 最近一次命中时间</span>
    TriggerCount   <span class="hljs-type">int</span>       <span class="hljs-comment">// 总共命中几次</span>
}

<span class="hljs-comment">// 判断是否该从 pending 转 firing</span>
elapsed := now() - alert.FirstTriggerAt
<span class="hljs-keyword">if</span> elapsed &gt;= rule.ForDuration &amp;&amp; alert.Status == <span class="hljs-string">"pending"</span> {
    alert.Status = <span class="hljs-string">"firing"</span>
}
</code></pre>
<p><strong>举例：</strong></p>
<pre><code class="hljs language-text" lang="text">规则: increase(error_log[1m]) &gt; 10
ForDuration: 60秒

时间轴:
10:00:00 - 命中，创建 pending
10:00:15 - 命中，仍是 pending
10:00:30 - 命中，仍是 pending
10:01:00 - 命中，持续60秒 → 转为 firing，开始通知
10:01:15 - 命中，保持 firing
10:01:30 - 不再命中 → 转为 resolved，写入历史
</code></pre>
<p>这样就过滤掉了短暂的抖动，只有持续异常才会真正告警。</p>
<hr/>
<h3 data-id="heading-14">六、队列与消费：评估和处理的分离</h3>
<h4 data-id="heading-15">为什么要队列？</h4>
<p>如果 Evaluator 直接写数据库：</p>
<ul>
<li>数据库慢了，评估就慢了</li>
<li>数据库挂了，评估就卡住了</li>
<li>告警量暴增时，数据库压力大</li>
</ul>
<p>引入队列后：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Evaluator&lt;br/&gt;快速计算] --&gt; B[AlertQueue&lt;br/&gt;缓冲区]
    B --&gt; C[Worker #1&lt;br/&gt;写库/通知]
    B --&gt; D[Worker #2&lt;br/&gt;写库/通知]
    B --&gt; E[Worker #3&lt;br/&gt;写库/通知]
    
    style A fill:#e1f5ff
    style B fill:#ffe1f5
    style C fill:#e1ffe1
    style D fill:#e1ffe1
    style E fill:#e1ffe1
</code></pre>
<p><strong>队列做了什么：</strong></p>
<ol>
<li>评估产生的告警事件先放到内存队列</li>
<li>多个 Worker 从队列消费，各自独立处理</li>
<li>队列满了也不会影响评估，最多丢弃部分事件</li>
</ol>
<p><strong>队列实现（简化版）：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> AlertQueue <span class="hljs-keyword">struct</span> {
    ch <span class="hljs-keyword">chan</span> *CurrentAlert  <span class="hljs-comment">// Go 的 channel 天然支持队列</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *AlertQueue)</span></span> Push(alert *CurrentAlert) {
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> q.ch &lt;- alert:
        <span class="hljs-comment">// 推入成功</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-comment">// 队列满了，丢弃或记录日志</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *AlertQueue)</span></span> Pop() &lt;-<span class="hljs-keyword">chan</span> *CurrentAlert {
    <span class="hljs-keyword">return</span> q.ch  <span class="hljs-comment">// Worker 直接从 channel 读取</span>
}
</code></pre>
<h4 data-id="heading-16">Worker 做什么？</h4>
<p>Worker 是消费者，负责所有"重活"：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Worker <span class="hljs-keyword">struct</span> {
    queue *AlertQueue
    db    *Database
    dedup *DedupCache  <span class="hljs-comment">// 5分钟去重缓存</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Worker)</span></span> Start() {
    <span class="hljs-keyword">for</span> alert := <span class="hljs-keyword">range</span> w.queue.Pop() {
        <span class="hljs-comment">// 1. 检查是否在去重窗口内</span>
        <span class="hljs-keyword">if</span> w.dedup.Contains(alert.Fingerprint) {
            <span class="hljs-keyword">continue</span>  <span class="hljs-comment">// 5分钟内重复的，直接跳过</span>
        }
        
        <span class="hljs-comment">// 2. 写入或更新 current_alerts 表</span>
        w.db.UpsertCurrentAlert(alert)
        
        <span class="hljs-comment">// 3. 如果是 firing，可以在这里发通知</span>
        <span class="hljs-keyword">if</span> alert.Status == <span class="hljs-string">"firing"</span> {
            sendNotification(alert)
        }
        
        <span class="hljs-comment">// 4. 加入去重缓存，5分钟内不再处理</span>
        w.dedup.Add(alert.Fingerprint)
    }
}
</code></pre>
<p><strong>为什么这样设计好？</strong></p>

























<table><thead><tr><th>好处</th><th>说明</th></tr></thead><tbody><tr><td><strong>解耦</strong></td><td>评估和处理互不影响</td></tr><tr><td><strong>削峰</strong></td><td>告警量暴增时队列缓冲</td></tr><tr><td><strong>可扩展</strong></td><td>Worker 数量可以动态调整</td></tr><tr><td><strong>容错</strong></td><td>某个 Worker 挂了不影响其他 Worker</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">七、5分钟去重：避免重复处理</h3>
<h4 data-id="heading-18">问题：高频指标会疯狂触发</h4>
<p>假设某个指标每 15 秒评估一次，一旦进入 firing 状态，每次评估都会命中。这意味着：</p>
<ul>
<li>每 15 秒就会推一次队列</li>
<li>每 15 秒就会写一次数据库</li>
<li>每 15 秒就会发一次通知</li>
</ul>
<p>这完全没必要，浪费资源还烦人。</p>
<h4 data-id="heading-19">解决方案：时间窗口去重</h4>
<p>在 Worker 层加一个简单的缓存：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> DedupCache <span class="hljs-keyword">struct</span> {
    m   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time  <span class="hljs-comment">// fingerprint -&gt; 过期时间</span>
    mu  sync.RWMutex
    ttl time.Duration          <span class="hljs-comment">// 5分钟</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *DedupCache)</span></span> Contains(fp <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> {
    c.mu.RLock()
    expireAt, exists := c.m[fp]
    c.mu.RUnlock()
    
    <span class="hljs-keyword">if</span> !exists {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">return</span> time.Now().Before(expireAt)  <span class="hljs-comment">// 还没过期</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *DedupCache)</span></span> Add(fp <span class="hljs-type">string</span>) {
    c.mu.Lock()
    c.m[fp] = time.Now().Add(c.ttl)  <span class="hljs-comment">// 当前时间 + 5分钟</span>
    c.mu.Unlock()
}
</code></pre>
<p><strong>工作流程：</strong></p>
<pre><code class="hljs language-text" lang="text">10:00:00 - alert_abc 首次进入 Worker
           检查缓存：不存在
           处理：写库、发通知
           加入缓存：过期时间 = 10:05:00

10:00:15 - alert_abc 再次进入 Worker
           检查缓存：存在，且未过期
           跳过处理

10:00:30 - alert_abc 再次进入 Worker
           检查缓存：存在，且未过期
           跳过处理

... (中间所有重复都被跳过)

10:05:01 - alert_abc 再次进入 Worker
           检查缓存：已过期
           处理：写库、更新时间
           刷新缓存：过期时间 = 10:10:01
</code></pre>
<p><strong>两层防抖的配合：</strong></p>




















<table><thead><tr><th>机制</th><th>作用阶段</th><th>解决的问题</th></tr></thead><tbody><tr><td><strong>for_duration</strong></td><td>评估阶段</td><td>防止毛刺，pending → firing 需要持续时间</td></tr><tr><td><strong>5分钟去重</strong></td><td>消费阶段</td><td>防止重复，firing 状态下避免频繁写库/通知</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-20">八、当前告警 vs 历史告警：状态迁移</h3>
<h4 data-id="heading-21">两张表的职责</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[规则命中] --&gt; B[current_alerts&lt;br/&gt;当前告警表]
    B --&gt; C{下轮还命中?}
    C --&gt;|是| B
    C --&gt;|否| D[history_alerts&lt;br/&gt;历史告警表]
    
    style B fill:#ffcccc
    style D fill:#cccccc
</code></pre>




















<table><thead><tr><th>表名</th><th>存什么</th><th>什么时候写入</th></tr></thead><tbody><tr><td><strong>current_alerts</strong></td><td>正在发生的告警</td><td>规则命中时创建/更新</td></tr><tr><td><strong>history_alerts</strong></td><td>已结束的告警</td><td>不再命中时从 current 迁移过来</td></tr></tbody></table>
<p><strong>current_alerts 的记录：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> CurrentAlert <span class="hljs-keyword">struct</span> {
    Fingerprint    <span class="hljs-type">string</span>    <span class="hljs-comment">// 唯一标识</span>
    RuleID         <span class="hljs-type">uint64</span>    <span class="hljs-comment">// 属于哪条规则</span>
    Status         <span class="hljs-type">string</span>    <span class="hljs-comment">// pending / firing</span>
    FirstTriggerAt time.Time <span class="hljs-comment">// 首次触发时间</span>
    LastTriggerAt  time.Time <span class="hljs-comment">// 最近触发时间</span>
    TriggerCount   <span class="hljs-type">int</span>       <span class="hljs-comment">// 触发次数</span>
    Labels         <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>  <span class="hljs-comment">// 标签</span>
    Value          <span class="hljs-type">float64</span>   <span class="hljs-comment">// 当前值</span>
}
</code></pre>
<p><strong>history_alerts 的记录：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> HistoryAlert <span class="hljs-keyword">struct</span> {
    Fingerprint    <span class="hljs-type">string</span>
    RuleID         <span class="hljs-type">uint64</span>
    StartAt        time.Time  <span class="hljs-comment">// 开始时间（= FirstTriggerAt）</span>
    EndAt          time.Time  <span class="hljs-comment">// 结束时间（= 最后评估时间）</span>
    Duration       <span class="hljs-type">int</span>        <span class="hljs-comment">// 持续时长（秒）</span>
    TriggerCount   <span class="hljs-type">int</span>        <span class="hljs-comment">// 总共触发几次</span>
    Labels         <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>
}
</code></pre>
<h4 data-id="heading-22">状态迁移：如何判断"已恢复"？</h4>
<p>每次评估后，引擎会做恢复检测：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">evaluateRule</span><span class="hljs-params">(rule AlertRule)</span></span> {
    <span class="hljs-comment">// ... 前面的评估逻辑</span>
    
    <span class="hljs-comment">// 收集本轮命中的所有 fingerprint</span>
    currentFPs := []<span class="hljs-type">string</span>{}
    <span class="hljs-keyword">for</span> _, series := <span class="hljs-keyword">range</span> seriesList {
        fp := hash(rule.ID + series.Labels)
        currentFPs.<span class="hljs-built_in">append</span>(fp)
        <span class="hljs-comment">// ... 处理这条告警</span>
    }
    
    <span class="hljs-comment">// 遍历该规则下所有当前告警</span>
    <span class="hljs-keyword">for</span> _, existing := <span class="hljs-keyword">range</span> db.GetCurrentAlerts(rule.ID) {
        <span class="hljs-comment">// 如果某个 fingerprint 在本轮没出现，说明已恢复</span>
        <span class="hljs-keyword">if</span> !currentFPs.contains(existing.Fingerprint) {
            <span class="hljs-comment">// 1. 写入 history_alerts</span>
            db.InsertHistory(HistoryAlert{
                Fingerprint:  existing.Fingerprint,
                RuleID:       existing.RuleID,
                StartAt:      existing.FirstTriggerAt,
                EndAt:        now(),
                Duration:     now() - existing.FirstTriggerAt,
                TriggerCount: existing.TriggerCount,
                Labels:       existing.Labels,
            })
            
            <span class="hljs-comment">// 2. 从 current_alerts 删除</span>
            db.DeleteCurrent(existing.Fingerprint)
        }
    }
}
</code></pre>
<p><strong>核心思想：缺席即恢复</strong></p>
<p>不需要额外判断"恢复条件"，只要本轮评估中某个告警实例没出现，就认为已经恢复了。这种设计：</p>
<ul>
<li>简单直接，不需要额外状态机</li>
<li>自动处理恢复，不需要定时扫描</li>
<li>和评估逻辑天然融合</li>
</ul>
<p><strong>举例说明：</strong></p>
<pre><code class="hljs language-text" lang="text">时间线:
10:00 - 规则命中 {host="server-01"}
        创建 current_alerts 记录

10:01 - 规则命中 {host="server-01"}
        更新 current_alerts（TriggerCount++）

10:02 - 规则命中 {host="server-01"}
        更新 current_alerts

10:03 - 规则不再命中（指标恢复正常）
        本轮 fingerprints = []（空）
        发现 {host="server-01"} 缺席
        → 写入 history_alerts
        → 删除 current_alerts
</code></pre>
<hr/>
<h3 data-id="heading-23">九、整体流程总结</h3>
<p>把所有环节串起来：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[Scheduler: 每15秒触发] --&gt; B[Evaluator: 执行 PromQL]
    B --&gt; C{规则是否命中?}
    C --&gt;|否| D[本轮无告警]
    C --&gt;|是| E[生成 Fingerprint]
    E --&gt; F{是否首次命中?}
    F --&gt;|是| G[创建 pending]
    F --&gt;|否| H[更新计数/时间]
    G --&gt; I{持续 &gt;= for_duration?}
    H --&gt; I
    I --&gt;|否| J[保持 pending]
    I --&gt;|是| K[转为 firing]
    J --&gt; L[推入 AlertQueue]
    K --&gt; L
    L --&gt; M[Worker: 从队列消费]
    M --&gt; N{5分钟内重复?}
    N --&gt;|是| O[跳过]
    N --&gt;|否| P[写入 current_alerts]
    P --&gt; Q{下轮还命中?}
    Q --&gt;|是| A
    Q --&gt;|否| R[迁移到 history_alerts]
    
    style B fill:#e1f5ff
    style E fill:#fff4e1
    style K fill:#ffcccc
    style M fill:#e1ffe1
    style R fill:#cccccc
</code></pre>
<p><strong>各阶段职责：</strong></p>
<ol>
<li><strong>Scheduler</strong>：按固定间隔触发评估</li>
<li><strong>Evaluator</strong>：查询 Prometheus，计算状态变化</li>
<li><strong>Fingerprint</strong>：标识每个告警实例</li>
<li><strong>pending/firing</strong>：区分观察期和确认告警</li>
<li><strong>AlertQueue</strong>：缓冲事件，削峰填谷</li>
<li><strong>Worker</strong>：异步处理，写库、去重、通知</li>
<li><strong>current/history</strong>：区分当前问题和历史记录</li>
</ol>
<hr/>
<h3 data-id="heading-24">十、这个设计好在哪里？</h3>
<h4 data-id="heading-25">1. 职责清晰，分层明确</h4>



































<table><thead><tr><th>层级</th><th>只做一件事</th><th>好处</th></tr></thead><tbody><tr><td>Prometheus</td><td>存指标</td><td>专业的事交给专业的工具</td></tr><tr><td>Evaluator</td><td>纯计算</td><td>评估速度快，不被 I/O 拖累</td></tr><tr><td>Queue</td><td>缓冲</td><td>削峰填谷，容错能力强</td></tr><tr><td>Worker</td><td>重活</td><td>异步处理，可以慢慢来</td></tr><tr><td>Database</td><td>持久化</td><td>状态可追溯，支持查询</td></tr></tbody></table>
<h4 data-id="heading-26">2. 防抖动做得优雅</h4>
<p>两层防抖配合：</p>
<ul>
<li><strong>for_duration</strong>：防毛刺，观察期后才确认</li>
<li><strong>5分钟去重</strong>：防重复，避免疯狂写库</li>
</ul>
<p>既不误报，也不扰民。</p>
<h4 data-id="heading-27">3. 状态迁移自然</h4>
<p>不需要额外的"恢复检测"逻辑：</p>
<ul>
<li>命中 → 在 current 里</li>
<li>不命中 → 自动迁移到 history</li>
</ul>
<p>"缺席即恢复"是最简单的设计。</p>
<h4 data-id="heading-28">4. 易扩展</h4>
<p>想加新功能，只需要：</p>
<ul>
<li>加规则：在规则表里插一条</li>
<li>加通知：在 Worker 里加逻辑</li>
<li>加静默：在 Worker 里加判断</li>
<li>加多数据源：扩展 Evaluator 支持其他查询接口</li>
</ul>
<p>核心架构不用动。</p>
<h4 data-id="heading-29">5. 性能好</h4>
<ul>
<li>评估是纯内存计算，每秒可以处理成百上千条规则</li>
<li>队列异步处理，数据库慢了也不影响评估</li>
<li>Worker 可以水平扩展，告警量大了加机器就行</li>
</ul>
<hr/>
<h3 data-id="heading-30">十一、适用场景与局限</h3>
<h4 data-id="heading-31">适合什么场景？</h4>
<ol>
<li><strong>中小规模监控</strong>：几百到几千条规则</li>
<li><strong>对接 Prometheus</strong>：已有 Prometheus 作为时序库</li>
<li><strong>需要精细控制</strong>：想自己管理告警生命周期</li>
<li><strong>要和业务系统集成</strong>：比如推送到自己的工单系统</li>
</ol>
<h4 data-id="heading-32">不适合什么场景？</h4>
<ol>
<li><strong>超大规模</strong>：上万条规则，几十万个告警实例
<ul>
<li>需要做分布式评估，单机扛不住</li>
</ul>
</li>
<li><strong>多数据源</strong>：不只是 Prometheus，还有 InfluxDB、MySQL 等
<ul>
<li>需要扩展 Evaluator 支持多种查询接口</li>
</ul>
</li>
<li><strong>复杂告警逻辑</strong>：比如多指标关联、机器学习预测
<ul>
<li>需要更强大的规则引擎</li>
</ul>
</li>
</ol>
<p>但这个内核设计很灵活，扩展起来不难。</p>
<hr/>
<h3 data-id="heading-33">十二、总结</h3>
<p>这个告警引擎虽然小，但该有的都有：</p>
<p><strong>核心功能：</strong></p>
<ul>
<li>从 Prometheus 指标到告警事件的完整流程</li>
<li>防抖动设计（for_duration + 5分钟去重）</li>
<li>告警生命周期管理（pending → firing → resolved）</li>
<li>当前/历史状态分离</li>
</ul>
<p><strong>设计亮点：</strong></p>
<ul>
<li>评估和处理分离，队列解耦</li>
<li>状态迁移简单，缺席即恢复</li>
<li>易扩展，加功能不需要改架构</li>
</ul>
<p><strong>实现简洁：</strong></p>
<ul>
<li>没有复杂的状态机</li>
<li>没有臃肿的抽象</li>
<li>代码量小，易维护</li>
</ul>
<p>这就是一个优雅的告警引擎内核该有的样子：<strong>简单、清晰、好用</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI浪潮下，前端的路在何方，附前端转KMP实践]]></title>    <link>https://juejin.cn/post/7587675443442417704</link>    <guid>https://juejin.cn/post/7587675443442417704</guid>    <pubDate>2025-12-26T03:00:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442417704" data-draft-id="7587671647399870504" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI浪潮下，前端的路在何方，附前端转KMP实践"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-26T03:00:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qiyue77"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450881991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI浪潮下，前端的路在何方，附前端转KMP实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450881991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qiyue77
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:00:28.000Z" title="Fri Dec 26 2025 03:00:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、本文主题</h3>
<p><strong>本篇为第二篇，依托于AI，无学习基础前端转KMP开发</strong>，主要针对前端发展展望，实践，和思考进行讲解。其中包含前端转KMP开发，并最终将项目如期落地。</p>
<p>篇一</p>
<p><a href="https://juejin.cn/post/7580288235030216704" target="_blank" title="https://juejin.cn/post/7580288235030216704">juejin.cn/post/758028…</a></p>
<p>篇二</p>
<ul>
<li>展望：介绍AI对前端职业的影响和变革，以及对自身学习成长的影响</li>
<li>实践：依托于AI，实现无学习周期的，前端转KMP跨端</li>
<li>思考：未来研发团队新形态的探索和思考</li>
</ul>
<h3 data-id="heading-1">二、行业发展，展望总结性观点</h3>
<p>从语言热度趋势，框架/工具发展，浏览器发展，AI工具支持，跨端演变，学习模式变革等方面，分析前端发展和未来展望</p>
<h4 data-id="heading-2">总结性观点</h4>
<ul>
<li>
<p>从AI在编程语言支持能力情况，<strong>前端和AI有非常强的融合能力，必然会走向人机协同模式</strong>。同时拥抱具有类型安全性的TS已是必然趋势。有机遇也有风险，传统开发者逐步转变为AI人机协同研发。<strong>vibe coding，大模型善后工程师，AI 80分危机等，新兴用词出现，也预示着这一变革的推进，编码方式转变正在发生</strong>。</p>
</li>
<li>
<p>前端在视觉展现上，具有代码体量小，依赖少，适配性强（web/pc/android/iOS均可渲染）的特性，<strong>HTML+CSS或HTMX渲染的具有动态和交互行动的视觉文档，未来会有更大的发展空间，既能很好的适配AI认知理解，又能呈现良好的视觉</strong>，未来对PPT必然产生强有力的冲击。（不妨在知识库随心搭试试，比PPT效果好）</p>
</li>
<li>
<p>前端工程体量逐渐庞大，<strong>开发阶段效率和性能问题</strong>已然摆到开发者面前；AIGC的快速发展，<strong>浏览器将承接更多复杂场景，视频编辑、设计工具（Figma）、3D引擎</strong>等。基于Rust工具链建设和Rust+Wasm在浏览器中实现原生性能，快速崛起。前端工程和浏览器将依托Rust的性能优势，组合出更复杂的工具和业务场景。</p>
</li>
<li>
<p>谷歌浏览重大更新，DevTools 深度集成 Gemini，Chrome DevTools 不仅仅是检查器，它正在变成一个 AI 编程助手，WebGPU 全面铺开：Chrome 121 起支持 Android WebGPU。意味着浏览器中的 AI 推理Transformers.js、3D 渲染和视频编码现在可以直接调用 GPU 底层架构。Wasm 内存升级： WebAssembly 现在支持大于 4GB 的内存寻址，可以处理更加的大型 3D 工程（AutoDesk Web、Adobe 全家桶）</p>
</li>
<li>
<p>AI原生IDE和AI插件和Code CLI，当前三分天下，原生IDE快速崛起，Cursor领头，国内外多家大厂开始意识到IDE集成化的优势和价值。AI插件仍是用户基数最大的选择，也是起步早，范围广的AI辅助方式。Code CLI在专业开发者中获得认可，非常切合研发使用。AI编程已是全方向展开。<strong>未来原生IDE成为主流选择，AI插件转向垂直（安全、部署、工具），Code CLI与DevOps深度融合</strong></p>
</li>
<li>
<p>国内移动生态三分天下是必然趋势，<strong>政策与产品影响，鸿蒙将登上舞台</strong>。穿戴设备，车机系统（新能源覆盖）各类智能化产品，使跨端在国内将更快，更广展开。企业适配鸿蒙，研发成本等因素，将推进跨端发展。<strong>相信国内在压缩人力/降本增效方面会有显著且卓越的进展。</strong></p>
</li>
<li>
<p>学习与产出并行推进，AI辅助下的软件职能边界逐渐模糊，<strong>软性的(AI辅助)全栈/大前端角色逐渐增多</strong>，企业内部<strong>相近角色协调转换，能代来更灵活/快速的需求响应</strong>，产品研发效率进一步提升。</p>
</li>
</ul>
<h3 data-id="heading-3">三、行业发展，展望展开</h3>
<h4 data-id="heading-4">3.1 先看趋势语言</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d8639ec29ff4fec9e0821bb8f09ca0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=Y61msC4sB%2F51FtpiFyY9pnq8Z%2BA%3D" alt="" loading="lazy"/></p>
<p>2024年，Python 大热荣登桂冠，JS/TS分别居于第二，第三。这么多年JS首次退下神坛，<strong>对于前端来说这就是最明显的信号</strong>。</p>
<p>从上面的数据，结合当下行业发展，我们可以展望几点内容。</p>
<ul>
<li>AI的发展，确实推进了Python的进一步发展，它更偏向于专业人士的工具，Python面向开发者，与JS不同，JS面向用户。</li>
<li>JS虽然离开了王座，但是TS持续崛起，分流了JS的同时，也说明<strong>拥抱具有类型安全性的TS已是必然趋势</strong></li>
<li>在github上排名靠前编程语言，拥有大量开源代码和社区贡献，<strong>是AI训练的核心素材</strong>，因此AI编程支持更好</li>
<li>如果将这个年度榜单的编程语言交给AI，让其分析AI Coding 对编程语言支持情况，进行梯队划分，<strong>第一梯队一定有Python/JS/TS</strong>。</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 你去问问AI</span>

Python,JavaScript,TypeScript,Java,C<span class="hljs-meta">#,C++,PHP,Shell,C,Go</span>

将上面这些编程语言，根据LLM编程能力支持情况，划分三个梯队，进行总结分析。
</code></pre>
<h4 data-id="heading-5">3.2 再看框架/工具</h4>
<h5 data-id="heading-6">3.2.1 框架发展趋势</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81cc954cf5024e048898f858908de00b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=d3nmyc%2FjfvUFFbx72d30qE2IQvc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c611ed14f61c4091a6c0fca6dade7dd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=FWkch7yn%2BB8VzgxUz8qm6McTmS8%3D" alt="" loading="lazy"/></p>
<p><strong>四大框架 React、Vue、Angular、Svelte</strong></p>
<ul>
<li>
<p>核心四大框架 React、Vue、Angular 和 Svelte。React 框架一骑绝尘，遥遥领先于其他三个框架。Vue 框架则处于第二的位置。Svelte 已超过 Angular</p>
</li>
<li>
<p>四大主流框架，保持的稳定更新迭代，短时间内，前端主流框架技术不会大变革，<strong>掌握React、Vue和基础JS/CSS/HTML，搭配AI这位老师</strong>，能应对前端绝大多数基础工作。</p>
</li>
</ul>
<h5 data-id="heading-7">3.2.2 全新形式HTMX库</h5>
<ul>
<li>
<p>htmx在GitHub上，star数在近两年内飙升，多次登顶 GitHub Trending 榜单。甚至被许多资深开发者视为解决“过度工程“的良药。</p>
</li>
<li>
<p>新全栈架构，htmx 极大利好非JavaScript背景的后端开发者，Go/Rust/Python + htmx这类组合非常流行。构建响应极快的 Web 应用。</p>
</li>
<li>
<p>企业内部生态，轻量级后台的首选，对于企业内部管理系统、CRUD（增删改查）类应用，htmx 的开发效率极高</p>
</li>
<li>
<p>性能优势，省去了客户端渲染（CSR）解析 JSON 并生成 DOM 的过程，htmx 在低端设备上的首屏渲染和交互响应往往更快。</p>
</li>
<li>
<p><strong>拥抱 AI，通过htmx，AI可以一次性生成带有交互逻辑的HTML，极大缩短了从 Prompt 到可运行原型的路径。</strong></p>
</li>
</ul>
<h5 data-id="heading-8">3.2.3 工具发展趋势</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8db1e6a6a4740ab9eb3c0fbde26a955~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=lXavmWyKqAGPvsi0YxAgp0oFtAQ%3D" alt="" loading="lazy"/></p>
<p>Rust 是最受推崇的编程语言，今年的得分为 83%。前端基础建设，<strong>工具链的重构，Rust 化愈演愈烈</strong>，带来极致的开发性能体验。</p>
<p>浏览器运行时的变革，<strong>Rust 是编译为 WebAssembly 的最佳语言</strong>，使得前端能够承担以前无法想象的任务</p>
<p><strong>对前端开发的深远影响</strong></p>
<ul>
<li>
<p>Vite6、Rspack、Oxlint、Biome 和 Rolldown。利用 Rust 的特性，极大的提升编译速度</p>
</li>
<li>
<p>视频编辑、设计工具（Figma）、3D 引擎等，通过 Rust + Wasm 在浏览器中实现原生性能。<strong>AI浪潮下，前端必将承接更多视频/图片编辑能力（人脸识别/大模型嵌入/图形算法处理），以及更负责的大型任务。</strong></p>
</li>
<li>
<p>性能组件化：开发者开始在 React/Vue 应用中嵌入 Rust 编写的性能敏感组件（如复杂的加密算法、图像处理、大数据量计算）</p>
</li>
</ul>
<p><strong>行业渗透率持续攀升</strong></p>
<p>根据 2025 年的市场调查，在商业用途中使用 Rust 的比例较三年前增长了近 70%。成为微软、亚马逊和 Google 构建核心基础设施的首选。</p>
<p><strong>AI 浪潮下的性能基石</strong></p>
<p>AI 模型推理和大规模数据处理对性能要求极高。越来越多的 AI 基础设施（如向量数据库、推理引擎）开始使用 Rust 重写，利用其零成本抽象和无垃圾回收 (GC) 的内存管理特性</p>
<h4 data-id="heading-9">3.3 三看浏览器发展</h4>
<p><strong>性能指标更替</strong>：INP 正式取代 FID。性能依旧是用户体验的真理</p>
<ul>
<li>2024 年 3 月起，INP (Interaction to Next Paint) 正式取代 FID 成为 Core Web Vitals 的三大指标之一</li>
</ul>
<p><strong>工具链的AI原生化</strong>：DevTools 深度集成 Gemini，Chrome DevTools 不仅仅是检查器，它正在变成一个 AI 编程助手</p>
<ul>
<li>
<p>AI 解释与诊断，在Console中，你可以点击“理解此错误”，Gemini 会自动分析报错、查找 MDN 文档并给出修复建议。</p>
</li>
<li>
<p>AI 样式调试，在 Elements 面板中，开发者可以利用 AI 辅助生成 CSS 样式或解释复杂的层叠逻辑。</p>
</li>
</ul>
<p><strong>Web平台算力解放</strong>：WebGPU 与 Wasm 增强，Chrome 完成了从“网页浏览”向“复杂计算平台”的转型。</p>
<ul>
<li>
<p>WebGPU 全面铺开：Chrome 121 起支持 Android WebGPU。意味着浏览器中的 AI 推理Transformers.js、3D 渲染和视频编码现在可以直接调用 GPU 底层架构。</p>
</li>
<li>
<p>Wasm 内存升级： WebAssembly 现在支持大于 4GB 的内存寻址，可以处理更加的大型 3D 工程（AutoDesk Web、Adobe 全家桶）</p>
</li>
</ul>
<p><strong>CSS 与 DOM 的新范式</strong>：CSS 的编写习惯在这一两年发生了翻天覆地的变化</p>
<ul>
<li>
<p>CSS Nesting (原生嵌套)： 2024 年起 Chrome 对原生 CSS 嵌套提供了极其稳定的 DevTools 支持。你可能不再需要 Sass 来处理层级。</p>
</li>
<li>
<p>Anchor Positioning (锚点定位)：允许 Tooltip 或弹出菜单直接在 CSS 中关联其触发元素，无需 JS 库进行实时位置计算。</p>
</li>
<li>
<p>Scroll-driven Animations： 仅靠 CSS 即可实现极其复杂的视差滚动或进度条动画，无需再监听 onscroll 事件</p>
</li>
</ul>
<h4 data-id="heading-10">3.4 四看AI工具支持</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dae2114fd37e4b508d3f80522b07a46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=tVf3cEH2kt4vatRBIcVodNKX%2FYc%3D" alt="" loading="lazy"/></p>
<p>AI 在编程领域的工具和 IDE 支持已经从简单的“代码补全”进化到了 <strong>“代理式（Agentic）开发”</strong> 和 <strong>“自然语言全栈构建”</strong> 的阶段，几乎所有的IDE都支持AI能力，且2025的能力更新也都围绕AI升级。</p>
<p><strong>编程环境变革，IDE 代理化</strong></p>
<ul>
<li>
<p>传统的 IDE（VS Code）正在被“AI 原生 IDE”挑战，或者通过深度集成实现自我革新</p>
</li>
<li>
<p>Cursor领跑者，已经实现多文件协同修改。MCP工具爆发（context7，brower mcp，playwright mcp，Figma mcp等），允许 IDE 连接外部工具（如文档、API、终端），让 AI 具备读取你实时文档库的能力。</p>
</li>
<li>
<p>GitHub Copilot Workspace，从 GitHub Issue 直接生成“开发计划”，并在云端沙盒中完成代码编写、运行测试和提交 PR，前端开发者更少写代码，更多审核代码，<strong>角色发生转变</strong></p>
</li>
<li>
<p>Gemini in DevTools， Chrome 控制台直接集成了 Gemini，能够实时解释前端报错</p>
</li>
</ul>
<p><strong>Vibe Coding从对话到完整应用</strong></p>
<p>2025 年前端开发出现了一个新词Vibe Coding（氛围感编程），通过自然语言描述“氛围”和“功能”，由 AI 生成预览并完成部署</p>
<ul>
<li>
<p>各个大厂都在推进Vibe Coding，从年初被提出，到现在各类架构实践知识，无疑都是针对 AI Coding和开发者人机协同模式的探索。也是对效率的提升的全新展开。</p>
</li>
<li>
<p>v0.dev 输入一段话或上传一张设计图，它会直接生成生产级别的代码。</p>
</li>
<li>
<p>Bolt.new / Lovable浏览器内的全栈 IDE，这些工具可以在浏览器里直接运行 Node.js 环境。</p>
</li>
<li>
<p><strong>从早期如何写出好的Prompt；到如何在IDE中利用AI提效；再到通过"Prompt + Review" 或 "SPEC" 模式管理 AI Agent，以及更加复杂的通过知识图谱或RAG结合向量数据库，进行记忆管理等等，都在让AI Coding变成体系化的开发模式</strong>，使其生成代码快速集成到现有的大型系统中。</p>
</li>
</ul>
<p><strong>Agentic Frontend（代理式前端）架构</strong></p>
<p>AI生成的年度总结，漂亮的排版，无需配色，找模版，调样式。AI更能好的理解文件形式。（<strong>该能力为公司内部功能，外部具有相同能力平台，可用秒搭</strong>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4962fec3b3254a04bf7ccc7d4dee80ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=OLF7%2Bpn0dfsi5xp2l34I0aXMHAU%3D" alt="" loading="lazy"/></p>
<p>AI 不仅写代码，还在变成代码的一部分。</p>
<ul>
<li>
<p>A2UI (Agent-to-UI)：这是一个 2025 年兴起的协议。它允许 AI Agent 根据用户的意图，实时生成动态 UI。AI 不再只是回一段文字，而是返回更加丰富多彩的展现形式。</p>
</li>
<li>
<p>CopilotKit：让前端开发者能快速给自己的APP增加AI助手。它能让AI感知你页面上的状态，并允许用户通过语音/文本直接操作你的网页组件。</p>
</li>
</ul>
<h4 data-id="heading-11">3.5 五看跨端演变</h4>
<p><strong>国内特例，鸿蒙必行</strong></p>
<ul>
<li>
<p>政策压力也好，还是国内市场环境也罢，华为鸿蒙早晚都是必经之路，未来国内三分天下，单启一职鸿蒙研发，目前看下下策，跨端才是根本。</p>
</li>
<li>
<p>鸿蒙给出了前端友好型的TS模式，同时也非常巧妙的切合了AI能力支持（AI对TS支持良好），未来AI+artTS也许会有不一样发展。</p>
</li>
</ul>
<p><strong>经济下行，成本为王</strong></p>
<ul>
<li>全球经济背景下，成本控制是企业的生存关键。根据 Neontri 的 2025 报告，跨端开发平均能降低 40% 的成本并缩短 70% 的开发周期。</li>
</ul>
<p><strong>性能天花板降低</strong></p>
<ul>
<li>手机硬件性能过剩，现代手机芯片的算力已经足够抹平框架带来的微小开销。</li>
</ul>
<p><strong>市场碎片化和多样化</strong></p>
<ul>
<li>
<p>多端一致性： 手机、平板、桌面、车机系统、甚至穿戴设备上保持 UI/UX 的一致。</p>
</li>
<li>
<p>国内两大手机厂商，入住汽车行业，结合两大厂商的营销风格，电车的市场销量，和用户的实际需求，车技系统也会有更多的应用发展。</p>
</li>
</ul>
<p><strong>AI浪潮下的全新机会</strong></p>
<ul>
<li>
<p>更适合 AI 生成，跨端代码（TS/JS/Dart）拥有庞大的开源社区数据。相比于Swift/Kotlin 混合开发，AI 在生成跨端代码时的准确率更高</p>
</li>
<li>
<p>AI带来的快速实践，落地机会，AI让开发者学习成本和开发效率发生实质性的变革，相比传统的 <strong>“先学习，在开发”</strong> 的模式，AI协同下，可以 <strong>“同时进行学习和开发”</strong></p>
</li>
</ul>
<h4 data-id="heading-12">3.6 六看学习模式</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ab20e44f24d487d8266d6244aad007e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=cxwE9vpwUyvUpvsYfLghl24qapE%3D" alt="" loading="lazy"/></p>
<p>AI浪潮下，编程领域的学习模式绝对是翻天覆地的变化，传统的<strong>学文档 =&gt; 学视频 =&gt; 写demo =&gt; 做测试验证</strong>，流程长，成本高。更多人选择了AI生成工具/应用辅助学习。</p>
<p>AI辅助下，整个学习过程到验证效果，完全可以AI辅助生成。验证通过后，<strong>再由AI总结知识点，记忆练习后一个学习周期完成</strong>。</p>
<p>只要你做好核心的学习思维导图（知识树），学习效率极大的提升，学习中的问题，均可交给AI老师解答，全部过程无需法付费，无需大量学习时间成本。</p>
<h3 data-id="heading-13">四、前端转KMP实践</h3>
<h4 data-id="heading-14">4.1 实践的硬性条件</h4>
<p>虽然我非常认可AI能力，但是团队中如果完全没有具有KMP开发经验的人，<strong>那一定不要直接排期需求迭代</strong>，必须要有一版从环境搭建到构建产出，并上线验证的Demo。这样能极大的避免环境，工程带来的时间不可控性。</p>
<ul>
<li>必须有KMP开发经验的研发和一版验证过的Dmeo能力。</li>
</ul>
<h4 data-id="heading-15">4.2 转换实践经验</h4>
<h5 data-id="heading-16">目标</h5>
<ol>
<li>没有KMP经验和实践</li>
<li>没有独立学习时间</li>
<li>前端常规迭代和反馈问题穿插进行</li>
<li>前端用KMP完成40天的需求开发</li>
<li>最终整体人力采用1.5倍（60天）计算评估。</li>
</ol>
<h5 data-id="heading-17">期间难点</h5>
<ol>
<li>工期时间的评估</li>
<li>大量的知识和名词</li>
<li>思维认知方式</li>
<li>学习成本与需求进度</li>
<li>如何总结沉淀，融汇贯通</li>
</ol>
<ul>
<li>
<p>针对工期评估，一般是采用1.5人力方案计算，即前端1天需要，KMP需要1.5天，相当于增加一些Buffer处理学习，未知内容和环境问题等。<strong>但我可以明确的说，前端没有提前学习足够的知识，1.5并不够。</strong> 那时间怎么来的？AI结余出来的。</p>
</li>
<li>
<p><strong>前端相比Native转KMP，要额外学习知识和概念</strong>，文件存储体系/数据库操作/多线程开发/崩溃问题/双端的环境常识（Native只需要学一端，安卓甚至无需，天然适配KMP）</p>
</li>
<li>
<p>KMP更接近Native，相比前端更复杂，<strong>思维转变非常关键</strong>，前端从不需要考虑相册权限/数据隐私/iOS沙盒等，如果长期使用JS弱类型约束，前端开发更为松散。<strong>因此FE开在初期会感觉约束，不变，不可理喻的费事</strong>。</p>
</li>
<li>
<p>学习成本与需求进度，如果一个整个需求持续半年，再配合1.5倍人力关系，那没有AI可能也正常完成（120+60=180也就是说有60天可以用来学习处理异常问题）。但如果只有2个月那是万万不能的（40+20=60也就是说只有20天学习和处理异常时间）。<strong>所以在AI的支持下，我们2个月完成了需求同时学习了KMP</strong>。</p>
</li>
<li>
<p>有学习，就要有总结，不然怎么能记住，温故而知新，才是持续记忆的良方。所以<strong>必须要总结回顾</strong>。开发过程中如何抽出时间进行总结并复习很关键。</p>
</li>
</ul>
<h5 data-id="heading-18">解决方案</h5>
<p><strong>第一步：开发者搭建自己的环境</strong></p>
<ul>
<li>
<p>当确定要做KPM这件事情，或者有规划时，就可以提前做这一步（没时间另说），不必等到万事确定在开始，那就太晚了。</p>
</li>
<li>
<p>熟悉IDE/安装KMP工具/安装iOS Xcode/CocoaPods等，这些能提前就提前，最起码启动hello world，期间问题可以让AI辅助解决。</p>
</li>
</ul>
<p><strong>第二步：启动规划</strong></p>
<ul>
<li>
<p>功能排期直接已前端视角评估需要的时间为基础，然后乘1.5倍系数，确定整体需求排期。</p>
</li>
<li>
<p>由有经验的KMP研发完成项目基建设，为什么我上面强调需要有经验的开发或者有项目Dmeo落地，主要两点：<strong>1.基建不稳定后续可能工期崩盘；2.没有经验的基建，无法确定它是好是坏。</strong></p>
</li>
</ul>
<p><strong>第三步：项目宣讲</strong></p>
<ul>
<li>针对搭建好的基础环境，还是要统一讲解，让大家都了解基本内容，大概知道项目代码应该放到哪个目录下合理。这样开发的大方向就不会错，<strong>不要以为有分享者讲了就能懂，分享的知识只能记住小部分</strong>，只有实际操作记忆后才能逐步适应。</li>
</ul>
<p><strong>第四步：进入开发</strong></p>
<ul>
<li>
<p>没有AI支持，那是屁都开发不了的，<strong>所以AI省去了完整的一个大步骤，学习基本的KMP编程语法和UI框架和基础知识</strong>。</p>
</li>
<li>
<p>整个开发阶段，全凭rule和AI对话，实现并发学习和开发，总结沉淀。</p>
</li>
<li>
<p>我给其设定为具有丰富前端转KMP经验的开发角色，<strong>根据开发中的一些关键点，自由评估总结思维转变思路</strong>，根据内容情况，自动沉淀到知识目录或工程目录。</p>
</li>
<li>
<p>让其开发实际业务功能代码，<strong>开发完整后并自动提取有价值的知识点，进行讲解和沉淀</strong>。保证开发/学习/沉淀面面具到。</p>
</li>
<li>
<p>提供输出规范模版说明，并采用类比的思路讲解知识，让AI总结的内容可以类比前端更容易理解内容。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f87749a7935a42128daec0681a443be2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=NiiFUZ%2FQwpymZJk8Veu2sFcjcL8%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-markdown" lang="markdown">角色
你是一名前端专家转型KMP跨端开发，并成为一名跨端开发专家，拥有丰富的前端和跨端经验。同时非常善于分享教学，拥有丰富的授课经验。
技能
<span class="hljs-bullet">*</span> 精通 Kotlin Multiplatform(KMP)、Compose Multiplatform(CMP)、Kotlin、Java，Gradle等跨端技术栈。
<span class="hljs-bullet">*</span> 精通 JS，HTML，CSS，TypeScript，VUE，React，Node等前端技术栈。
<span class="hljs-bullet">*</span> 拥有丰富的[前端]到[KMP跨端]的思维转变经验。善于使用对比，抽象，渐进式教学等技巧通过项目驱动学习，Demo演示等进行教学。
<span class="hljs-bullet">*</span> 善于总结教学笔记，从项目开发中沉淀[前端]转型[KMP跨端]需要学习的知识点。
<span class="hljs-bullet">*</span> 善于使用精简的伪代码，展示完整的功能应用，遵循标准执行流程 "代码声明=&gt;文件导入=&gt;函数/类调用[参数解释]"。
<span class="hljs-bullet">*</span> 理解 Gradle 构建系统和插件开发。

任务要求
<span class="hljs-bullet">*</span> 开发对话中，针对本次代码生成，提取跨端知识点，自行评估对前端转KMP跨端价值，询问是否需要沉淀到学习文档。

<span class="hljs-bullet">    1.</span> 这次对话是否涉及前端→KMP的思维转变?
<span class="hljs-bullet">    2.</span> 是否包含新的技术概念对比?
<span class="hljs-bullet">    3.</span> 是否有可复用的最佳实践?
<span class="hljs-bullet">    4.</span> 如果安卓/iOS/跨端有差异，需要提供对比分析。

<span class="hljs-bullet">*</span> 新的知识点需要对比 /docs/forlearn目录下是否已经存在，如果不存在创建新的知识点文档。
<span class="hljs-bullet">*</span> 知识点沉淀需要合理分类，形成章节markdown文档，知识点文档必须沉淀在/docs/forlearn目录，章节分类可以参考下面【章节分类举例】。
<span class="hljs-bullet">*</span> 知识沉淀注重清晰有条理且简单易懂，必要时，附带参考资料引用，但每个知识点资料引用少余2条。

文档分类
<span class="hljs-bullet">1.</span> 工程文档（Engineering Docs）
<span class="hljs-bullet">*</span> 位置: /docs/ 或 /docs/integration/、/docs/api/ 等
<span class="hljs-bullet">*</span> 目的: 项目开发、功能接入、API参考
<span class="hljs-bullet">*</span> 内容: 配置步骤、代码示例、API文档
<span class="hljs-bullet">*</span> 不需要前端对比

<span class="hljs-bullet">2.</span> 学习文档（Learning Docs）
<span class="hljs-bullet">*</span> 位置: /docs/forlearn/
<span class="hljs-bullet">*</span> 目的: 前端转KMP的知识沉淀
<span class="hljs-bullet">*</span> 内容: 概念对比、思维转变、Demo等，可自由编排
<span class="hljs-bullet">*</span> 必须包含"前端思维转变和理解"章节
</code></pre>
<h3 data-id="heading-19">五、研发团队新形态思考</h3>
<p>在快速的AI发展阶段，想要走在前沿，需要不断摸索前进。大胆假设，小心求证，必要的尝试可能带来意想不到的效果。</p>
<h4 data-id="heading-20">5.1 团队组成</h4>
<h5 data-id="heading-21">5.1.1 传统团队</h5>
<p>传统团队1是1，2是2，各个职能线之前没有交叉和转换的可能，除非招聘有实际多端开发经验的开发，在面对人力不足，实效性需求时，缺少灵活性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fce06d6059447e6a0c4ef50fec55f2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=x52vQ0jwrqmBpoqXKiIQGtJ2Cp0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-22">4.1.2 AI辅助型团队</h5>
<p>AI辅助型，软全栈开发。<strong>各个职能线独立一名AI辅助型全栈</strong>，在面对紧急需求，人力不足，实效性需求等，具有良好的协调性。</p>
<p>谁当这类人？这类型意味着更累，工作强度更大？</p>
<ul>
<li>
<p>学习探索能力强，渴望技术快速成长，对AI感兴趣的人，可以作为优先考虑对象。</p>
</li>
<li>
<p>不管什么样的角色，一个人的时间有限，工作量不会有什么差别，<strong>不过确实可能比单角色研发面临紧急项目，高优项目多。当然晋升和成长机会也会更高</strong>。毕竟关键性项目都有身影。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16d39c07dc7b4c1c880c37961a776042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=rZikIzMSeKTEm1M1brR%2BHkMhmKM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-23">5.2 快速低成本建设方案</h4>
<ul>
<li>
<p>将项目功能技术进行文档和知识沉淀，搭配嵌套<code>__docs__</code>目录，将整个项目构建出AI需要的上下文资源。</p>
</li>
<li>
<p>开发者，利用IDE，rule，MCP工具，以及嵌套的文档资源，根据功能开发情况，按需喂给AI上下文。</p>
</li>
<li>
<p>特点是：文档伴随项目git提交更新，开发者遵守文档维护目录结构和更新规范。开发时按需使用文档和rule。人工更新维护文档。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a08c5f915344d9b3f7c1a15517eeb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=5xeybQtmAbGsz5ZP6JrW9HoalhI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-24">5.3 体系化建设方案</h4>
<ul>
<li>
<p>将项目功能技术进行文档和知识沉淀，搭配向量化数据库和知识图谱（或RAG），将多个项目通用信息抽离进行向量化存储。</p>
</li>
<li>
<p>开发者，利用IDE，rule，MCP工具，基于知识图谱和云端数据库，进行功能开发。</p>
</li>
<li>
<p>特点是：多个研发/多个项目之前可以共享云端数据，数据更新也可通过AI+MCP进行向量化处理并自动更新数据库。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd25f4460226416ab3da26577d98b14a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322856&amp;x-signature=sGVq9kj9FJg6t%2B8i%2BijacrDixhY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-25">六、核心技术资讯平台</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fnews-insights%2Foctoverse%2F" target="_blank" title="https://github.blog/news-insights/octoverse/" ref="nofollow noopener noreferrer">github.blog/news-insigh…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F2025%2F" target="_blank" title="https://survey.stackoverflow.co/2025/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/2025/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.thoughtworks.com%2Fradar" target="_blank" title="https://www.thoughtworks.com/radar" ref="nofollow noopener noreferrer">www.thoughtworks.com/radar</a></p>
<h4 data-id="heading-26">6.1 其他资料</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Franndy360%2Fai-coding-best-practices-in-2025-4eel" target="_blank" title="https://dev.to/ranndy360/ai-coding-best-practices-in-2025-4eel" ref="nofollow noopener noreferrer">dev.to/ranndy360/a…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F2025%2F" target="_blank" title="https://survey.stackoverflow.co/2025/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/2025/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fnews-insights%2Foctoverse%2F" target="_blank" title="https://github.blog/news-insights/octoverse/" ref="nofollow noopener noreferrer">github.blog/news-insigh…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fchrome.xahuapu.net%2Fhelp%2F3862.html" target="_blank" title="https://chrome.xahuapu.net/help/3862.html" ref="nofollow noopener noreferrer">chrome.xahuapu.net/help/3862.h…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgooglechromexz.com%2Fguide%2F3118.html" target="_blank" title="https://googlechromexz.com/guide/3118.html" ref="nofollow noopener noreferrer">googlechromexz.com/guide/3118.…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Frelease-notes%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/release-notes?hl=zh-cn" ref="nofollow noopener noreferrer">developer.chrome.com/release-not…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F2024%2Ftechnology%23admired-and-desired" target="_blank" title="https://survey.stackoverflow.co/2024/technology#admired-and-desired" ref="nofollow noopener noreferrer">survey.stackoverflow.co/2024/techno…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvite.dev%2Fblog%2Fannouncing-vite6.html" target="_blank" title="https://vite.dev/blog/announcing-vite6.html" ref="nofollow noopener noreferrer">vite.dev/blog/announ…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnpm-stat.com%2Fcharts.html%3Fpackage%3Dvue%26package%3Dreact%26package%3Dsvelte%26package%3Dangular%26from%3D2024-01-01%26to%3D2024-12-31" target="_blank" title="https://npm-stat.com/charts.html?package=vue&amp;package=react&amp;package=svelte&amp;package=angular&amp;from=2024-01-01&amp;to=2024-12-31" ref="nofollow noopener noreferrer">npm-stat.com/charts.html…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hono与Honox一次尝试]]></title>    <link>https://juejin.cn/post/7588300640599719942</link>    <guid>https://juejin.cn/post/7588300640599719942</guid>    <pubDate>2025-12-28T11:19:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640599719942" data-draft-id="7588191506607194118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hono与Honox一次尝试"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-28T11:19:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小荧"/> <meta itemprop="url" content="https://juejin.cn/user/606586151371054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hono与Honox一次尝试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586151371054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小荧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T11:19:53.000Z" title="Sun Dec 28 2025 11:19:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Hono与Honox一次尝试</h2>
<p>最近心血来潮，尝试着用Hono和Honox写了一个简单的Web应用。但是我被折磨了一顿😣。最近看到了hono+cloudflare搭建一个接口服务还是很有趣的，本想着用来搭建一个图床的服务，突然看到官网hono中可以编写jsx组件，于是来的兴趣准备尝试尝试。
<img src="https://static.xxytime.top/2025/12/28/17-32-34-17181f9131880e71a5f53dcf7600d75f-20251228173233695-bce866.png" alt="" loading="lazy"/></p>
<p><strong>Hono是一个用于Node.js的Web框架，而Honox是Hono的实验性版本，旨在提供更好的性能和更现代的API。我尝试着用Hono和Honox写了一个简单的Web应用，结果出乎意料的好。Honox的性能比Hono更好，API也更现代，推荐给大家。</strong></p>
<h3 data-id="heading-1">环境准备</h3>
<ol>
<li>安装Node.js和npm</li>
<li>创建一个新项目</li>
<li>安装Hono和Honox</li>
<li>配置D1数据库本地用SqlLite代替</li>
<li>部署cloudflare workers先把项目跑起来😊</li>
</ol>
<blockquote>
<p>以上的操作都没有问题，一切看起来如此的顺利😊。</p>
</blockquote>
<h4 data-id="heading-2">槽点一</h4>
<p>honox的文档写得不够详细，很多地方都看不太懂。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// app/routes/index.tsx</span>
<span class="hljs-comment">// `createRoute()` helps you create handlers</span>
<span class="hljs-keyword">import</span> { createRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'honox/factory'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">createRoute</span>(<span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">render</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
})
</code></pre>
<p>以上代码<code>createRoute</code>内不支持<code>react</code>运行时语法，比如:<code>useEffect</code>语法无法使用,只能使用<code>honox</code>的<code>jsx</code>语法。在请求数据的时候的时候我还傻傻的在<code>useEffect</code>中写<code>fetch</code>请求数据，结果可想而知， honox中没有<code>useEffect</code>，也没有<code>useState</code>，有的只是<code>c.request</code>和<code>c.render</code>。而正确的做法是直接调用DB的服务查询数据，直接在服务端渲染。其实这也是陷入了<code>ssr</code>的陷阱。但这种模式更像是传统的后端开发中前后端不分离的一种架构方式</p>
<h4 data-id="heading-3">槽点二</h4>
<p><code>jwt</code>中间件失效，按照官方文件所言在hono的是可以直接拦截鉴权逻辑的，但是在honox中却是失效的需要honox还在beta版本中的原有一些hono的配套的中间件还没有完全支持，所有我有自己写了一个鉴权的中间件逻辑</p>
<h4 data-id="heading-4">槽点三</h4>
<p>没有配套的<code>ui</code>组件库，比如<code>antd</code>、<code>element</code>等，所有需要自己写样式或者使用<code>honox</code>的<code>jsx</code>语法自己写组件
不过还好他支持<code>tailwindcss</code></p>
<h4 data-id="heading-5">总结</h4>
<p><code>Honox</code>都还处于beta版本，还有很多功能没有完善，但是总体来说，<code>Honox</code>确实为hono提供了更优雅的ui组件编写方式，结合了<code>jsx</code>，融入了<code>react</code>的语法，让后端模板语法写起来更加优雅。但是尝鲜毕竟只是尝鲜，实际生产中需要使用ssr还是推荐使用<code>nuxt.js</code>或者<code>next.js</code>。<code>hono</code>我也推荐只是用在一些小项目或者实验性项目中。尝鲜网址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fimgbed.xxytime.top%2F" target="_blank" title="https://imgbed.xxytime.top/" ref="nofollow noopener noreferrer">图床</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「分库分表不是万能药」：高并发MySQL架构的理性选择]]></title>    <link>https://juejin.cn/post/7588355695101018121</link>    <guid>https://juejin.cn/post/7588355695101018121</guid>    <pubDate>2025-12-28T11:28:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588355695101018121" data-draft-id="7588140921248399398" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「分库分表不是万能药」：高并发MySQL架构的理性选择"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T11:28:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术不打烊"/> <meta itemprop="url" content="https://juejin.cn/user/893244690677165"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「分库分表不是万能药」：高并发MySQL架构的理性选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/893244690677165/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术不打烊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T11:28:18.000Z" title="Sun Dec 28 2025 11:28:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91aafae4a5c741129c551c687385876a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5LiN5omT54OK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767526098&amp;x-signature=6rPCD1qOnruVr3vwQG52gnDOUqY%3D" alt="0dacd9b9-d0e4-4da1-b8e5-a09762831a9a.png" loading="lazy"/></p>
<p>越“分”越乱，是不是你也掉过这个坑？</p>
<p>前些日子，朋友所在的公司为了冲刺年末促销，大张旗鼓地将原本的单个数据库拆分成八个分库、十六个分表，不过结果却事与愿违，系统不仅没有提速，反而慢得像蜗牛爬行一般，连基本的报表都查不出来；老板一怒之下，DBA不得不连夜加班，开发团队也纷纷抱怨连连。</p>
<p>我问他一个问题：是不是所有高并发问题，都能靠分库分表解决？</p>
<p>他说：“以前我也这么以为——现在真不敢了。”</p>
<p>分库分表不是银弹，它只是架构演进中的一枚棋子。</p>
<p>今天我们就聊聊，到底什么时候该“分”？怎么“分”？分完又该怎么“活下去”？</p>
<p>看完这篇，你会对“分库分表”这事，有个清晰、冷静、能吹也能干的判断。</p>
<hr/>
<h2 data-id="heading-0">并发瓶颈真的是数据库的问题吗</h2>
<p>很多项目一上来就喊“数据库扛不住了”，但真相往往扎心。并发的瓶颈，八成不在数据库，而在业务设计和SQL习惯上。</p>
<ul>
<li>
<p>一堆慢SQL没索引</p>
</li>
<li>
<p>一个事务锁着十几张表</p>
</li>
<li>
<p>同步更新、死循环队列</p>
</li>
<li>
<p>甚至还有人用<code>SELECT *</code>查全表</p>
</li>
</ul>
<p>不是MySQL不行，是设计太随性</p>
<p>单库其实可以支撑起相当高的并发，要是你加上主从读写分离、Redis缓存命中以及SQL优化，或许都能让性能翻倍很多回。</p>
<p>所以，别一看到TPS上升就喊“我要分库！”。那不是架构升级，那是交智商税。</p>
<p>想想你上次线上“高并发”是不是，其实是日志打太多了？</p>
<hr/>
<h2 data-id="heading-1">从事实指标判断需要“分”的时机</h2>
<p>真正要不要分，要看三个硬指标：<strong>QPS、数据量、事务耦合度</strong></p>
<ol>
<li>
<p><strong>QPS</strong>（每秒查询数）：单库单实例能够稳定达到5000以上，大部分业务实际上都足够使用</p>
</li>
<li>
<p><strong>数据量</strong>：单表超过5000万行、索引命中率明显下降时，该警觉</p>
</li>
<li>
<p><strong>事务耦合度</strong>：跨业务、跨表事务多，分后代价巨大</p>
</li>
</ol>
<p>不是系统慢了就分，而是优化尽头了才分</p>
<p>像电商订单、日志，还有用户行为数据这类天然归属于大表的情况，确实或许要分库。</p>
<p>但很多中小系统、SaaS平台，根本没到那个量级。</p>
<p>建议大家先做个性能基线测试，自测看看瓶颈真的在哪。搞不好，半天的索引优化，比一个月的分库分表还值！</p>
<hr/>
<h2 data-id="heading-2">分库分表的三种主流策略及适用场景</h2>
<p>等到真的到了要分开的时候，不要慌。分开的办法，有三种：<strong>水平分表、垂直分库、混合方案</strong></p>
<ol>
<li>
<p><strong>水平分表</strong>：将同一张表依照规则分割成若干张，例如依据用户ID进行取模。适用于单表过大的情况</p>
</li>
<li>
<p><strong>垂直分库</strong>：依据业务来进行拆分，比如说订单库、用户库、日志库这类的，通常是在业务模块耦合程度比较低的时候适用</p>
</li>
<li>
<p><strong>混合方案</strong>：复杂系统的常态，灵活但维护成本高</p>
</li>
</ol>
<p>分得好是解药，分不好是毒药</p>
<p>分片键的设计那可是相当关键，打个比方哈，要是按用户ID去分库，可实际查询的时候大多靠的是订单号，这么一来，那肯定就会不可避免地出现跨库查询，性能一下子就得掉一半。</p>
<p>建议先画出核心查询路径，再决定分片逻辑</p>
<p>可以自己试试手动分片演练，比如：如何确保同一用户的订单数据能落在一库？</p>
<p>做几次这个练习，你就知道架构师凭啥贵</p>
<hr/>
<h2 data-id="heading-3">跨库查询、统计与全局一致性的挑战</h2>
<p>分完之后，不少人会说：“数据查不到了，聚合不准了，事务也炸了。”</p>
<p>因为分库分表最难的不在“分”，而在“查”。</p>
<p>以往一条SQL就能解决的事情，现在或许要修改十条，还要进行合并、分页、排序。</p>
<p>你以为你在优化架构，其实你在重写MySQL。</p>
<p>解决方案也不是没有，比如</p>
<ul>
<li>
<p>ShardingSphere：中间件层做分片、汇总</p>
</li>
<li>
<p>分布式事务框架（Seata、TCC）</p>
</li>
<li>
<p>统计异步化与ETL离线聚合</p>
</li>
</ul>
<p>但这些却都造成了很大复杂程度。很多团队用了半年时间去重新构建，最终发现查看报表竟然比原先还要慢。</p>
<p>所以，一定要问自己一句——你的业务，真的值这个代价吗？</p>
<hr/>
<h2 data-id="heading-4">你真的需要拆数据库吗</h2>
<p>最后，我们得说实话：分库分表只是解决高并发的一个选项，不是唯一选项。</p>
<p>业内高手常常这样干</p>
<ul>
<li>
<p>Redis预热缓存，命中率99%</p>
</li>
<li>
<p>消息队列异步削峰</p>
</li>
<li>
<p>热冷数据分层，热点放内存，冷数据归档</p>
</li>
<li>
<p>读写分离+分区表，撑足百万QPS</p>
</li>
</ul>
<p>真正的高手，不是动刀最频繁的，而是最少动刀的。</p>
<p>存在这么一家知名的互联网公司，到现在依旧采用单个MySQL实例，凭借着缓存以及限流办法稳稳地为几千万用户提供服务。</p>
<p>所以别急着拆数据库，先拆思维框架</p>
<p>如果给你一次重新设计机会，你会先分库，还是先分流？</p>
<hr/>
<h2 data-id="heading-5">结尾：理性，不是保守，而是成熟</h2>
<p>分库分表是架构的必修课，但绝不是考试答案。</p>
<p>它让你学会取舍，也让你明白——架构从不是炫技，而是权衡。</p>
<p>架构的尽头，不是炫技，而是稳</p>
<p>那所以，下一次你要是听到要不要分库，先问这么一个问题：</p>
<p>“我的系统，是不是已经把单库吃干榨尽？”</p>
<p>如果没有，先稳住，测一测、调一调、补一补。</p>
<p>关注我，让我们一起少踩坑，多落地，写出更聪明的系统。</p>
<hr/>
<p><strong>声明</strong>：此文章里九成内容是我自己撰写的，有一小部分素材借助了AI来打造，而且所有内容我都仔细核查过，图片素材要么是真实存在的，要么是由AI原创的，该文章旨在传播正能量，没有低俗不良的引导，希望读者能够知道。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[短思考第267天，周末亲子游，拆解一个很常见的商业化项目！]]></title>    <link>https://juejin.cn/post/7588793670494109736</link>    <guid>https://juejin.cn/post/7588793670494109736</guid>    <pubDate>2025-12-29T01:36:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588793670494109736" data-draft-id="7588456115882721315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="短思考第267天，周末亲子游，拆解一个很常见的商业化项目！"/> <meta itemprop="keywords" content="创业,全栈,AI编程"/> <meta itemprop="datePublished" content="2025-12-29T01:36:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员码歌"/> <meta itemprop="url" content="https://juejin.cn/user/764915820529831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            短思考第267天，周末亲子游，拆解一个很常见的商业化项目！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/764915820529831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员码歌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-29T01:36:25.000Z" title="Mon Dec 29 2025 01:36:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>周末娃吵着要出去玩，在附近找了一个亲子农场公园，分享一下这次游玩所见的一些商业化思考。</p>
<p>【公园选地】
公园位于番禺相对偏远的区域，占地约两个足球场大小，租金成本较低。公共交通不便，主要依赖自驾或网约车，目标客群具备一定消费能力。
商业思考：在成本可控的近郊选址，通过差异化体验弥补区位劣势，吸引对交通不敏感的亲子家庭。</p>
<p>【游玩项目】</p>
<ol>
<li>
<p>蘑菇屋等童话场景，适合拍照打卡。
商业思考：利用视觉化场景打造社交媒体传播点，提升园区的自传播能力。</p>
</li>
<li>
<p>小白兔喂养区，提供胡萝卜和干草。
商业思考：通过低成本互动项目提高游客停留时间和参与感。</p>
</li>
<li>
<p>散养羊驼、梅花鹿、羊、孔雀等动物，可自由投喂。
商业思考：以“亲近自然”的沉浸式体验形成核心吸引力，增强亲子互动和趣味性。</p>
</li>
<li>
<p>骑马体验，每张票可免费体验一次。
商业思考：通过高感知价值项目提升票价吸引力，形成差异化竞争优势。</p>
</li>
<li>
<p>小火车游园，支持一大一小乘坐。
商业思考：通过家庭友好型项目提升客单价和亲子体验的完整性。</p>
</li>
<li>
<p>园区小溪及金鱼观赏。
商业思考：以低成本自然景观丰富游览层次，提高空间利用率。</p>
</li>
<li>
<p>免费露营区，提供天幕、桌椅供游客休息。
商业思考：通过免费设施提升游客舒适度，延长停留时间，促进二次消费。</p>
</li>
<li>
<p>小炉子煎南瓜饼体验。
商业思考：以“DIY体验”增强儿童参与感，形成独特记忆点，提高复购与传播。</p>
</li>
<li>
<p>小丑表演与气球赠送，表演后可通过抖音分享领取免费气球。
商业思考：利用娱乐表演提升现场氛围，并以“社交平台分享”作为低成本裂变方式。</p>
</li>
</ol>
<p>【美食小街】
园区内设置美食小街，满足游客在游玩过程中的即时性饮食需求。
商业思考：利用“刚需消费”提升非门票收入，通过轻餐饮实现高毛利、低投入的持续变现</p>
<p>【抖音购票引流】
主要面向亲子家庭，推出两大一小套票约70元，含所有项目和一份萝卜；同时提供17.9元的单人入园票。多领萝卜或领取气球需在抖音发布图文并评论15字以上。
商业思考：通过分层票价结构满足不同需求，以“社交平台任务奖励”实现用户自发传播，降低获客成本。</p>
<p>【总结】
总的来说，这是一套很成功的一个商业化运作，整体逻辑如下：
以低成本近郊场地为基础，通过强互动、强社交属性的亲子体验组合，结合抖音裂变机制，形成“体验吸引—社交传播—转化购票—现场消费”的完整商业闭环。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI应用-基于LangChain4j实现AI对话]]></title>    <link>https://juejin.cn/post/7588355695101165577</link>    <guid>https://juejin.cn/post/7588355695101165577</guid>    <pubDate>2025-12-28T12:51:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588355695101165577" data-draft-id="7585534343562133554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI应用-基于LangChain4j实现AI对话"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-28T12:51:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="清名"/> <meta itemprop="url" content="https://juejin.cn/user/2080748088600525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI应用-基于LangChain4j实现AI对话
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2080748088600525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    清名
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T12:51:29.000Z" title="Sun Dec 28 2025 12:51:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/065d214b077a456d9bfada09ca6218a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=xRDSNf9QZ6F76jsL5fSfoA7uMe8%3D" alt="生成特定背景图片.png" loading="lazy"/></p>
<p>AI（即人工智能 Artificial Intelligence）是计算机科学的一个分支，旨在让计算机模仿人类的决策能力、像人类一样思考，学习和解决问题的技术。而大模型是实现AI的一种强大技术和路径。</p>
<p>大模型，通常指大规模预训练模型，是深度学习的一个分支。它的大体现在三个方面：</p>
<ul>
<li><strong>参数量巨大</strong>：千亿、万亿级别的神经元连接，能够存储海量知识。</li>
<li><strong>训练数据巨大</strong>：使用整个互联网规模的文本、图像、代码等进行训练。</li>
<li><strong>算力消耗巨大</strong>：需要强大的GPU集群进行数周甚至数月的训练。</li>
</ul>
<p>像ChatGPT、Claude 、文心一言、通义千问都属于大模型的一种。</p>
<h3 data-id="heading-0">ollama</h3>
<p>Ollama 是一个开源工具，可以让你能在自己的电脑上轻松地运行、管理和部署大型语言模型。
像deepseek、通义千问、gemini等模型都可以通过ollama进行部署运行。官网地址为：
<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">ollama.com/</a> 。 下载并安装成功后，我们可以进入Models选择自己需要的模型进行部署,机器性能有限，所以选取了qwen3:0.6b作为本次部署的模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05344b32d09e42e687a3bd6b60d154d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=TDjMJaE2Dy3PhDSinjWjsadA70Y%3D" alt="image.png" loading="lazy"/></p>
<p>这些大模型中都带有个"b"，这个b表示十亿的意思。0.6b则表示6亿个参数，参数越多表示功能越强大。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae3c63e855948848a9b1c62abf08206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=tJeXGTtbiVR2X%2Bp3FO3UFGuKikU%3D" alt="image.png" loading="lazy"/>
选择对应的模型后，进入详情可以查看ollama的安装命令。将该命令复制后进行安装。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5ac0808815e4ab88d728f4147487212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=gA56mHmD8%2FLti7sC0NDI5J%2F6Xdw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3128a351c6984feeb58b8092677b3c23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=sHHkX86%2FBg5w%2FEccc3XOMD%2Fgofc%3D" alt="image.png" loading="lazy"/></p>
<p>虽然成功的部署了大模型，但是当前状态下用户无法直接使用该模型。所以需要建立一个桥梁，来连接用户和大模型。对于传统软件来讲，想要进行智能化改造，目前有两种选择：<strong>LangChain4j</strong>和<strong>Spring Ai</strong>。本次将以LangChain4j来作为桥梁，LangChain4j 是一个专为Java设计的大语言模型集成框架，其核心目标是简化将各类大语言模型集成到Java应用程序中的过程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21f770ee40c94b0d9710b95802be1567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=wy88QvQpYBYSmDYl4StQKpgkI%2Fs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">LangChain4j</h3>
<h4 data-id="heading-2">OpenAiChatModel</h4>
<p>本地部署大模型后，会提供出各种api，ollama默认提供的服务端口是<code>11434</code>，langchain4j底层已经默认集成了这些接口，而这些接口被封装在OpenAiChatModel中，所以OpenAiChatModel是OpenAi的关键入口，我们在使用时只需要调用对应的方法即可，减少了很多的接口对接的时间。现在需要将langchain4j整合到项目中，下面是demo中相关框架的版本，需要注意的是，langchain4j强制使用17及以上的jdk版本。。</p>
<blockquote>
<p>springboot版本为3.5.0</p>
<p>jdk版本为17</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.29.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 最新稳定版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.29.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 如果使用 Spring Boot Starter --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<p>如果你使用的是云版的大模型，那么这部可以忽略，你只需要在yml文件中配置相应的模型信息即可。这段配置主要是用于本地部署版本，本地部署一般不需要apiKey，但是这里不填的话会报错，所以随便填上一点内容就行。baseUrl填写模型的地址就行，需要注意的是，ollama的官网中提供的api接口地址并没有v1部分，但是这里不配置的话请求时会404。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd1b5501ee73424da2cc7ba728e89bff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=hkAsre4PqwC3jJw59jUHjbS79VE%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatModelConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> OpenAiChatModel <span class="hljs-title function_">openAiChatModel</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> OpenAiChatModel.builder()
                .baseUrl(<span class="hljs-string">"http://127.0.0.1:11434/v1"</span>)  <span class="hljs-comment">// ollama地址</span>
                .modelName(<span class="hljs-string">"qwen3:0.6b"</span>)   <span class="hljs-comment">// 模型名称</span>
                .apiKey(<span class="hljs-string">"123"</span>)   <span class="hljs-comment">// apikey  随便填写</span>
                .build();
    }
}
</code></pre>
<p>给用户提供一个模拟对话的接口，用户将通过该接口将对话内容请求到模型中，模型再将思考结果通过该接口返回给用户。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RequestMapping("/api")</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatApiController</span> {


    OpenAiChatModel openAiChatModel;

    ChatApiController( OpenAiChatModel openAiChatModel){
        <span class="hljs-built_in">this</span>.openAiChatModel = openAiChatModel;
    }

    <span class="hljs-meta">@PostMapping("/chat")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatDTO chatDTO)</span>{
        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> openAiChatModel.generate(chatDTO.getData());
        <span class="hljs-keyword">return</span> response;
    }

}
</code></pre>
<p>通过该接口发送对话内容并查看模型思考的结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62233eec0a25486bbff62a3234e5d77c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=c6JueF9QINdGA3AFynuJL3dpdZs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">@AiService</h4>
<p>上面使用了OpenAiChatModel进行了对话demo的编写，但是LangChain4j提供了更简洁的编码方式，即使用<code>@AiService</code>注解来进行声明式编写。在使用该注解时，需要自定义一个对话接口，并在接口上添加该注解。该注解内有几个参数<code>wiringMode</code>(模型是自动配置还是手动配置)，<code>chatModel</code>(指定的模型配置)等。现在对上面的代码进行改造。首先定义一个AiChatService接口，并添加注解。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AiService(wiringMode = AiServiceWiringMode.EXPLICIT, // 表示手动配置，默认自动配置
chatModel = "openAiChatModel"  // 对话模型
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AiChatService</span> {

    <span class="hljs-comment">// 实现ai对话</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(String content)</span>;

}
</code></pre>
<p>在原来的controller中，将OpenAiChatModel替换为AiChatService，重启成功后，并进行对话，模型同样返回了结果。</p>
<pre><code class="hljs language-java" lang="java">AiChatService aiChatService;

ChatApiController(AiChatService aiChatService){
    <span class="hljs-built_in">this</span>.aiChatService = aiChatService;
}

<span class="hljs-meta">@PostMapping("/chat")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatDTO chatDTO)</span>{
    <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> aiChatService.chat(chatDTO.getData());
    <span class="hljs-keyword">return</span> response;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f00023490a4a5dbb38313cbb208329~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=OtosvYqfM277xVtFTHbDmq2%2Fxj8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">流式调用</h4>
<p>流式调用主要用于让大模型生成回复时，实时的、逐步的输出内容，而不是等全部内容生成完才一次性返回，文字能像“打字”一样出现，缩短用户等待时间，像常用的deepseek,豆包等都是采用流式调用的方式，大大提高了用户体验。LangChain4j中，提供了<code>OpenAiStreamingChatModel</code>对象，使用该对象结合Spring提供的<code>Flux&lt;T&gt;</code>即可实现流式调用。首先引入langchain4j-reactor的依赖。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>dev.langchain4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>langchain4j-reactor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0-beta7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>Model配置和上述配置几乎相同，只是将<code>OpenAiChatModel</code>替换成了<code>OpenAiStreamingChatModel</code>。logRequests和logResponses的作用是输出与模型交互的请求和响应报文日志。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OpenAiStreamingChatModel <span class="hljs-title function_">openAiStreamingChatModel</span><span class="hljs-params">()</span>{
    <span class="hljs-type">OpenAiStreamingChatModel</span> <span class="hljs-variable">build</span> <span class="hljs-operator">=</span> OpenAiStreamingChatModel.builder()
            .baseUrl(<span class="hljs-string">"http://127.0.0.1:11434/v1"</span>)
            .modelName(<span class="hljs-string">"qwen3:0.6b"</span>)
            .apiKey(<span class="hljs-string">"123"</span>)
            .logRequests(<span class="hljs-literal">true</span>)
            .logResponses(<span class="hljs-literal">true</span>)
            .build();
    <span class="hljs-keyword">return</span> build;
}
</code></pre>
<p>配置完成后，需要在定义的接口中新增一个流式调用的方法，并且方法的返回值类型需要是<code>Flux&lt;T&gt;</code>,同时在<code>@AiService</code>注解内需要配置流式模型的配置(<code>streamingChatModel</code>)。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AiService(wiringMode = AiServiceWiringMode.EXPLICIT,
        chatModel = "openAiChatModel",
        streamingChatModel = "openAiStreamingChatModel"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AiChatService</span> {

    <span class="hljs-comment">/**
     *  非流式对话
     * <span class="hljs-doctag">@param</span> content
     * <span class="hljs-doctag">@return</span>
     */</span>
    String <span class="hljs-title function_">chat</span><span class="hljs-params">(String content)</span>;

    <span class="hljs-comment">/**
     * 流式对话
     * <span class="hljs-doctag">@param</span> content
     * <span class="hljs-doctag">@return</span>
     */</span>
    Flux&lt;String&gt; <span class="hljs-title function_">chatFlux</span><span class="hljs-params">(String content)</span>;
}
</code></pre>
<p>在以上全部实现后，在额外提供一个给用户调用的接口，这个接口的返回类型同样需要使用Flux。这里需要注意的是在@GetMapping中，需要将produces的值设置为<code>text/html;charset=utf-8</code>，否则返回的内容将会是一串乱码。直接调用该接口，会直接展示流式调用效果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping(value = "/chat-flux",produces = "text/html;charset=utf-8")</span>
<span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chatFlux</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = "content")</span> String content)</span>{
    Flux&lt;String&gt; chatFlux = aiChatService.chatFlux(content);
    <span class="hljs-keyword">return</span> chatFlux;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c58cfbc54c1142afbcb0710ed9683bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=Dt%2F2AM%2BjRqpw7zsnKW6Jf5vH3QI%3D" alt="动画.gif" loading="lazy"/>
上面响应的内容不太美观，那我们自己可以实现一个简单的前端页面来模拟ai智能问答(网上找一个模板或者ai生成一个就行，没必要在这个上面浪费时间)。虽然回复有些卡顿，但作为古董级的笔记本部署0.6b的模型效果也算不错了😔😔😔。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14f8ec0ab0474020bf506df28e8bae67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=23jkKaGQa3GHFM4EHNO5%2BGO%2FLP8%3D" alt="动画 (1).gif" loading="lazy"/></p>
<h4 data-id="heading-5">会话记忆</h4>
<p>通常来说，正常的对话具有连续性，我们可能通过连续的对话能够更加准确的理解对方的意图或想法。但是对于机器而言，每一句对话都是独立的，并没有连续的效果。比如下面对话，机器并没有通过上下文，来理解我提问的问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679cab29856c4173a84c82509b121b55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=DxzXL7vGweoGTTpO%2FaTlUSj1l%2FE%3D" alt="image.png" loading="lazy"/>
为了让机器能够理解对话的内容，就需要将对话的上下文一并推给机器，让机器在连续对话中记住之前交互内容的能力。它使得对话能够保持连贯性，而不是每次只处理独立的单轮对话，这就是会话记忆。目前会话记忆主要有两种，一种是短期记忆，一种是长期记忆。</p>
<ul>
<li><strong>短期记忆（上下文窗口）</strong><br/>
固定上下文长度，将整个对话历史作为输入传递给模型。这是目前最常见的方式。</li>
<li><strong>长期记忆（外部存储）</strong><br/>
通过向量数据库、缓存或用户档案存储重要信息，在需要时检索并注入到当前对话中。</li>
</ul>
<p>如果想要实现短期记忆，langchain4j提供了<code>MessageWindowChatMemory</code>，并且可以通过调用<code>maxMessages</code>方法来确定上下文的消息数量，并在<code>@AiService</code>注解中来指定会话记忆配置对象<code>chatMemory</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> ChatMemory <span class="hljs-title function_">chatMemory</span><span class="hljs-params">()</span>{
    <span class="hljs-type">MessageWindowChatMemory</span> <span class="hljs-variable">chatMemory</span> <span class="hljs-operator">=</span> MessageWindowChatMemory.builder()
            .maxMessages(<span class="hljs-number">30</span>) <span class="hljs-comment">// 上下文长度为30条</span>
            .build();
    <span class="hljs-keyword">return</span> chatMemory;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AiService(wiringMode = AiServiceWiringMode.EXPLICIT,
        chatModel = "openAiChatModel",
        streamingChatModel = "openAiStreamingChatModel",
        chatMemory = "chatMemory"  // 配置会话记忆
)</span>
</code></pre>
<p>当重新运行后在进行同样的提问，可以看出来模型已经根据会话记忆的上下文进行理解并准确的回答问题了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bca4ea8abc1a4bb2b4a632eed39eba6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=4a%2Blq3PdT9hVACuQtA26x2ngmfA%3D" alt="image.png" loading="lazy"/></p>
<p>短期记忆存在一个弊端，因为对话记忆内容是存储在内存中的，当服务器重启时，那这些记忆的内容就会丢失。如果想要实现长期记忆，则需要自主开发实现，比如将对话内容存储到redis中。在Langchain4j中有提供 <code>ChatMemoryStore</code>接口，长期存储时需要实现这个接口。以redis为例，定义一个ChatMemoryStore的实现类<code>RedisChatStoreService</code>,将对话消息进行存储。需要注意的是，实现长期记忆的同时，也要实现会话隔离。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisChatStoreService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChatMemoryStore</span> {

    <span class="hljs-meta">@Autowired</span>
    StringRedisTemplate redisTemplate;

   <span class="hljs-comment">// 以会话id作为缓存的key</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChatMessage&gt; <span class="hljs-title function_">getMessages</span><span class="hljs-params">(Object memoryId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(memoryId.toString());
        <span class="hljs-keyword">return</span> ChatMessageDeserializer.messagesFromJson(message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMessages</span><span class="hljs-params">(Object memoryId, List&lt;ChatMessage&gt; list)</span> {
        redisTemplate.opsForValue().set(memoryId.toString(), ChatMessageSerializer.messagesToJson(list));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteMessages</span><span class="hljs-params">(Object memoryId)</span> {
        redisTemplate.delete(memoryId.toString());
    }
}
</code></pre>
<p>长期记忆实现后，需要将该内容配置到记忆对象中，与短期记忆不同，这里需要实现一个对话记忆提供对象<code>ChatMemoryProvider</code>，并且在对象中配置对话存储实现类以及记忆id。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
RedisChatStoreService redisChatStoreService;

<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> ChatMemoryProvider <span class="hljs-title function_">chatMemoryProvider</span><span class="hljs-params">()</span>{
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatMemoryProvider</span>() {
         <span class="hljs-meta">@Override</span>
         <span class="hljs-keyword">public</span> ChatMemory <span class="hljs-title function_">get</span><span class="hljs-params">(Object memoryId)</span> {
             <span class="hljs-keyword">return</span>  MessageWindowChatMemory.builder()
                     .id(memoryId)
                     .chatMemoryStore(redisChatStoreService)
                     .maxMessages(<span class="hljs-number">30</span>)
                     .build();
         }
     };
}
</code></pre>
<p>在service红需要在@AiService注解中，需要指定上述定义的会话记忆提供者chatMemoryProvider。并且在流式调用的方法中指定记忆id。<code>@MemoryId</code>表示该字段为记忆id,<code>@UserMessage</code>表示为该字段为用户对话的内容。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@AiService</span>(wiringMode = AiServiceWiringMode.EXPLICIT,
        chatModel = <span class="hljs-string">"openAiChatModel"</span>,
        streamingChatModel = <span class="hljs-string">"openAiStreamingChatModel"</span>,
      <span class="hljs-comment">//  chatMemory = "chatMemory"  // 配置会话记忆</span>
        chatMemoryProvider = <span class="hljs-string">"chatMemoryProvider"</span>
)

...... 

Flux&lt;String&gt; <span class="hljs-built_in">chatFlux</span>(<span class="hljs-variable">@MemoryId</span> String memoryId, <span class="hljs-variable">@UserMessage</span> String content);
</code></pre>
<p>配置完成后，当再次发起对话时，对话的内容已经被存储到redis当中了，这样即使重启，也不会导致记忆内容丢失。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3ce7589741b4058af463871d9037aec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=TIZ9uH1HjhSRt70MqR68tpTBB64%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa4ce30e8c0403c9236b89890a4b5dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5ZCN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531088&amp;x-signature=8SLNtG9fTJ6NqHA%2BF0c9Dbpt9vs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">总结</h4>
<p>LangChain4j 是专为 Java 开发者设计的 AI 应用开发框架，相当于 Python中的LangChain。它简化了大模型在Java应用中的集成。核心优势在于提供简洁的 API 支持对话管理、RAG（后面会涉及到）、工具调用等高级功能。同时支持多种 AI 服务提供商，并可与 Spring Boot 等主流 Java 框架无缝集成，让企业级应用快速获得 AI 能力而无需重构技术栈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3分钟Solidity: 7.6 Yul语言简介]]></title>    <link>https://juejin.cn/post/7588139768276598835</link>    <guid>https://juejin.cn/post/7588139768276598835</guid>    <pubDate>2025-12-28T13:38:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588139768276598835" data-draft-id="7588355695101296649" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3分钟Solidity: 7.6 Yul语言简介"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2025-12-28T13:38:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3分钟Solidity: 7.6 Yul语言简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:38:57.000Z" title="Sun Dec 28 2025 13:38:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读38分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7578762210285977663" title="https://juejin.cn/column/7578762210285977663" target="_blank">3分钟Solidity--智能合约--Web3区块链技术必学</a></p>
<p><code>Yul</code>（先前被也被称为 <code>JULIA</code> 或 <code>IULIA</code>）是一种可以编译到各种不同后端的中间语言。</p>
<p>它可以在独立模式下使用，也可以在<code>Solidity</code>内部用于 <code>“内联汇编”</code>。 编译器在基于IR的代码生成器（“新代码生成器” 或 “基于IR的代码生成器”）中使用Yul作为一种中间语言。 Yul是高级优化阶段的一个很好的目标，可以使所有的目标平台同样受益。</p>
<h2 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id2" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id2" target="_blank" ref="nofollow noopener noreferrer">动机和高级别描述</a></h2>
<p>Yul 的设计试图实现几个目标：</p>
<ol>
<li>用Yul编写的程序应该是可读的，即使代码是由Solidity或其他高级语言的编译器生成的。</li>
<li>控制流应易于理解，以帮助人工检查、形式化验证和优化。</li>
<li>从Yul到字节码的翻译应该尽可能的简单明了。</li>
<li>Yul应该适用于整个程序的优化。</li>
</ol>
<p>为了实现第一个和第二个目标，Yul提供了高级别的结构，如 <code>for</code> 循环， <code>if</code> 和 <code>switch</code> 语句和函数调用。 这些应该足以充分代表汇编程序的控制流。 因此，没有提供 <code>SWAP</code>， <code>DUP</code>， <code>JUMPDEST</code>， <code>JUMP</code> 和 <code>JUMPI</code> 的明确语句， 因为前两者混淆了数据流，后两者混淆了控制流。此外， <code>mul(add(x, y), 7)</code> 形式的函数语句比 <code>7 y x add mul</code> 这样的纯操作码语句更受欢迎， 因为在第一种形式中，更容易看到哪个操作数用于哪个操作码。</p>
<p>尽管它是为堆栈机设计的，但Yul并没有暴露堆栈本身的复杂性。 程序员或审计师不应该担心堆栈的问题。</p>
<p>第三个目标是通过以一种非常有规律的方式将高层结构编译成字节码来实现的。 汇编器执行的唯一非本地操作是用户定义的标识符（函数、变量……）的名称查找和清理堆栈中的本地变量。</p>
<p>为了避免值和引用等概念之间的混淆， Yul是静态类型的。同时， 有一个默认的类型（通常是目标机的整数字）， 可以随时省略以帮助增加可读性。</p>
<p>为了保持语言的简单和灵活， Yul在其纯粹的形式下没有任何内置的操作，函数或类型。 在指定Yul的语言时，这些操作和语义被添加到一起， 这使得Yul可以根据不同的目标平台和功能集的要求进行专业化。</p>
<p>目前，只有一种指定的Yul语言。这个语言使用EVM的操作码作为内建函数（见下文）， 并且只定义了 <code>u256</code> 类型，这是EVM的本地256位类型。正因为如此，我们将不在下面的例子中提供类型。</p>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id3" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id3" target="_blank" ref="nofollow noopener noreferrer">简单的例子</a></h2>
<p>下面的例子程序是用EVM语言编写的，用来计算指数。 它可以用 <code>solc --strict-assembly</code> 指令编译。 内置函数 <code>mul</code> 和 <code>div</code> 分别计算乘法和除法。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0%2BIHJlc3VsdAogICAgewogICAgICAgIHN3aXRjaCBleHBvbmVudAogICAgICAgIGNhc2UgMCB7IHJlc3VsdCA6PSAxIH0KICAgICAgICBjYXNlIDEgeyByZXN1bHQgOj0gYmFzZSB9CiAgICAgICAgZGVmYXVsdAogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0+IHJlc3VsdAogICAgewogICAgICAgIHN3aXRjaCBleHBvbmVudAogICAgICAgIGNhc2UgMCB7IHJlc3VsdCA6PSAxIH0KICAgICAgICBjYXNlIDEgeyByZXN1bHQgOj0gYmFzZSB9CiAgICAgICAgZGVmYXVsdAogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-sql" lang="sql">{
    <span class="hljs-keyword">function</span> <span class="hljs-built_in">power</span>(base, exponent) <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">result</span>
    {
        switch exponent
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-number">1</span> }
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> base }
        <span class="hljs-keyword">default</span>
        {
            <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-built_in">power</span>(mul(base, base), div(exponent, <span class="hljs-number">2</span>))
            switch <span class="hljs-built_in">mod</span>(exponent, <span class="hljs-number">2</span>)
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> mul(base, <span class="hljs-keyword">result</span>) }
        }
    }
}
</code></pre>
<p>也可以用for循环而不是递归来实现同样的函数。 这里， <code>lt(a, b)</code> 计算 <code>a</code> 是否小于 <code>b</code>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0%2BIHJlc3VsdAogICAgewogICAgICAgIHJlc3VsdCA6PSAxCiAgICAgICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIGV4cG9uZW50KSB7IGkgOj0gYWRkKGksIDEpIH0KICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA6PSBtdWwocmVzdWx0LCBiYXNlKQogICAgICAgIH0KICAgIH0KfQ%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0+IHJlc3VsdAogICAgewogICAgICAgIHJlc3VsdCA6PSAxCiAgICAgICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIGV4cG9uZW50KSB7IGkgOj0gYWRkKGksIDEpIH0KICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA6PSBtdWwocmVzdWx0LCBiYXNlKQogICAgICAgIH0KICAgIH0KfQ==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    function power(base, exponent) -&gt; result
    {
        result := <span class="hljs-number">1</span>
        for { let <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span> } lt(<span class="hljs-selector-tag">i</span>, exponent) { <span class="hljs-selector-tag">i</span> := <span class="hljs-built_in">add</span>(i, <span class="hljs-number">1</span>) }
        {
            result := <span class="hljs-built_in">mul</span>(result, base)
        }
    }
}
</code></pre>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23erc20yul" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#erc20yul" ref="nofollow noopener noreferrer">本节的末尾</a> ，可以找到ERC-20标准的完整实现。</p>
<h2 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id4" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id4" target="_blank" ref="nofollow noopener noreferrer">单独使用</a></h2>
<p>您可以使用Solidity编译器在EVM语言中以独立的形式使用Yul。 这将使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-object" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-object" ref="nofollow noopener noreferrer">Yul 对象符号</a>，这样就有可能将代码作为数据引用到部署合约中。 这种Yul模式可用于命令行编译器（使用 <code>--strict-assembly</code>）和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fusing-the-compiler.html%23compiler-api" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/using-the-compiler.html#compiler-api" ref="nofollow noopener noreferrer">标准-json接口</a>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"language"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Yul"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"input.yul"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{ sstore(0, 1) }"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"settings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"outputSelection"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">""</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-string">"*"</span> <span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"optimizer"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"details"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"yul"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>警告</p>
<p>Yul正在积极开发中，只有以EVM 1.0为目标，Yul的EVM语言才能完全实现字节码生成。</p>
</blockquote>
<h2 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id5" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id5" target="_blank" ref="nofollow noopener noreferrer">对Yul的非正式描述</a></h2>
<p>在下文中，我们将谈论Yul语言的每个单独方面。在例子中，我们将使用默认的EVM语言。</p>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id6" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id6" target="_blank" ref="nofollow noopener noreferrer">语法</a></h3>
<p>Yul使用与Solidity相同的方式解析注释，字词和标识符， 所以您可以使用 <code>//</code> 和 <code>/* */</code> 来表示注释。 但是有一个例外，Yul中的标识符可以包含圆点： <code>.</code>。</p>
<p>Yul可以指定由代码，数据和子对象组成的 “对象”。 请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-object" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-object" ref="nofollow noopener noreferrer">Yul 对象</a> 以了解这方面的详情。 在本节中，我们只关注这样一个对象的代码部分。 这个代码部分总是由一个大括号限定的块组成。 大多数工具都支持只指定一个预期对象的代码块。</p>
<p>在一个代码块内，可以使用以下元素（更多细节见后面章节）：</p>
<ul>
<li>字符，即 <code>0x123</code>， <code>42</code> 或 <code>"abc"</code> （32个字符以内的字符串）。</li>
<li>对内置函数的调用，例如 <code>add(1, mload(0))</code></li>
<li>变量声明，例如 <code>let x := 7</code>， <code>let x := add(y, 3)</code> 或 <code>let x</code> （初始值为0）</li>
<li>标识符（变量），例如： <code>add(3, x)</code></li>
<li>赋值，例如： <code>x := add(y, 3)</code></li>
<li>局部变量的作用域所在的代码块，例如 <code>{ let x := 3 { let y := add(x, 1) } }</code></li>
<li>if 语句，例如 <code>if lt(a, b) { sstore(0, 1) }</code></li>
<li>switch 语句，例如 <code>switch mload(0) case 0 { revert() } default { mstore(0, 1) }</code></li>
<li>for 循环，例如 <code>for { let i := 0} lt(i, 10) { i := add(i, 1) } { mstore(i, 7) }</code></li>
<li>函数的定义，例如 <code>function f(a, b) -&gt; c { c := add(a, b) }</code></li>
</ul>
<p>多个语法元素之间可以简单地用空格隔开，即不需要结尾的 <code>;</code> 或换行。</p>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23index-1" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#index-1" target="_blank" ref="nofollow noopener noreferrer">字符</a></h3>
<p>作为字符，您可以使用。</p>
<ul>
<li>以十进制或十六进制符号表示的整数常数。</li>
<li>ASCII字符串（例如 <code>"abc"</code>），可能包含十六进制转义 <code>\xNN</code> 和 Unicode转义 <code>\uNNNN</code>，其中 <code>N</code> 是十六进制数字。</li>
<li>十六进制字符串（例如： <code>hex"616263"</code>）。</li>
</ul>
<p>在Yul的EVM语言中，字面量表示256位的单词，如下所示：</p>
<ul>
<li>十进制或十六进制的常量必须小于 <code>2**256</code>。 它们以大端编码的无符号整数形式表示具有该值的256位字。</li>
<li>一个ASCII字符串首先被看作是一个字节序列， 通过将非转义ASCII字符看作是一个单字节，其值是ASCII代码， 转义 <code>\xNN</code> 是具有该值的单字节， 转义 <code>\uNNNN</code> 是该代码点的UTF-8字节序列。 字节序列不得超过32字节。 字节序列在右边用零填充，以达到32个字节的长度； 换句话说，字符串是以左对齐的方式存储。 填充后的字节序列代表一个256位的字，其最有意义的8位是第一个字节的1， 也就是说，字节被解释为大端形式。</li>
<li>十六进制字符串首先被视为一个字节序列， 将每一对连续的十六进制数字视为一个字节。 字节序列不得超过32个字节（即64个十六进制数字），并按上述方法处理。</li>
</ul>
<p>当为EVM编译时，这将被翻译成一个适当的 <code>PUSHi</code> 指令。 在下面的例子中， <code>3</code> 和 <code>2</code> 相加的结果是 5， 然后计算与字符串 “abc” 的按位 <code>与（and）</code>。 最后的数值被分配到一个叫做 <code>x</code> 的局部变量。</p>
<p>上述32字节的限制并不适用于传递给需要字面参数的内置函数的字符串（例如， <code>setimmutable</code> 或 <code>loadimmutable</code>）。 这些字符串最终不会出现在生成的字节码中。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IHggOj0gYW5kKCJhYmMiLCBhZGQoMywgMikp" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IHggOj0gYW5kKCJhYmMiLCBhZGQoMywgMikp" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> x := <span class="hljs-keyword">and</span>(<span class="hljs-string">"abc"</span>, <span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>))
</code></pre>
<p>除非是默认类型，否则字面的类型必须在冒号后指定：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DLy8g6L%2BZ5bCG5LiN5Lya6KKr57yW6K%2BR77yIdTMy5ZKMdTI1Nuexu%2BWei%2BWwmuacquWunueOsO%2B8ieOAggpsZXQgeCA6PSBhbmQoImFiYyI6dTMyLCBhZGQoMzp1MjU2LCAyOnUyNTYpKQ%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Ly8g6L+Z5bCG5LiN5Lya6KKr57yW6K+R77yIdTMy5ZKMdTI1Nuexu+Wei+WwmuacquWunueOsO+8ieOAggpsZXQgeCA6PSBhbmQoImFiYyI6dTMyLCBhZGQoMzp1MjU2LCAyOnUyNTYpKQ==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 这将不会被编译（u32和u256类型尚未实现）。</span>
<span class="hljs-keyword">let</span> x := <span class="hljs-keyword">and</span>(<span class="hljs-string">"abc"</span>:u32, <span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>:u256, <span class="hljs-number">2</span>:u256))
</code></pre>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id8" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id8" target="_blank" ref="nofollow noopener noreferrer">函数调用</a></h3>
<p>内置函数和用户定义的函数（见下文）都可以用前面例子中的相同方式调用。 如果函数返回一个单一的值，它可以直接在一个表达式中再次使用。 如果它返回多个值，则必须将它们分配给局部变量。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DZnVuY3Rpb24gZih4LCB5KSAtPiBhLCBiIHsgLyogLi4uICovIH0KbXN0b3JlKDB4ODAsIGFkZChtbG9hZCgweDgwKSwgMykpCi8vIOatpOWkhO%2B8jOeUqOaIt%2BWumuS5ieeahOWHveaVsCBgZmAg6L%2BU5Zue5Lik5Liq5YC844CCCmxldCB4LCB5IDo9IGYoMSwgbWxvYWQoMCkp" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ZnVuY3Rpb24gZih4LCB5KSAtPiBhLCBiIHsgLyogLi4uICovIH0KbXN0b3JlKDB4ODAsIGFkZChtbG9hZCgweDgwKSwgMykpCi8vIOatpOWkhO+8jOeUqOaIt+WumuS5ieeahOWHveaVsCBgZmAg6L+U5Zue5Lik5Liq5YC844CCCmxldCB4LCB5IDo9IGYoMSwgbWxvYWQoMCkp" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">f</span>(x, y) -&gt; <span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span> { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>x80, add(mload(<span class="hljs-number">0</span>x80), <span class="hljs-number">3</span>))
<span class="hljs-comment">// 此处，用户定义的函数 `f` 返回两个值。</span>
let x, y := <span class="hljs-built_in">f</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">mload</span>(<span class="hljs-number">0</span>))
</code></pre>
<p>对于EVM的内置函数，函数表达式可以直接转换为操作码流： 您只需从右到左读取表达式，就可以得到操作码。 在例子中的第二行，是 <code>PUSH1 3 PUSH1 0x80 MLOAD ADD PUSH1 0x80 MSTORE</code>。</p>
<p>对于调用用户定义的函数，参数也从右到左放在堆栈中，这是参数列表被评估的顺序。 然而，返回值是在堆栈中从左到右，即在这个例子中， <code>y</code> 在堆栈的顶部， <code>x</code> 在其下方。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id9" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id9" target="_blank" ref="nofollow noopener noreferrer">变量声明</a></h3>
<p>您可以使用 <code>let</code> 关键字来声明变量。变量只在它所定义的 <code>{...}</code> 块内可见。 当编译到EVM时，会创建一个新的堆栈槽，为该变量保留，并在到达块的末端时自动移除。 您可以为该变量提供一个初始值。如果您不提供一个值，该变量将被初始化为零。</p>
<p>由于变量存储在堆栈中，它们不直接影响内存或存储， 但它们可以在内置函数 <code>mstore</code>， <code>mload</code>， <code>sstore</code> 和 <code>sload</code> 中作为内存或存储位置的指针使用。 未来的语言可能会为这种指针引入特定的类型。</p>
<p>当一个变量被引用时，其当前值被复制。 对于EVM来说，这相当于一个 <code>DUP</code> 指令。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHplcm8gOj0gMAogICAgbGV0IHYgOj0gY2FsbGRhdGFsb2FkKHplcm8pCiAgICB7CiAgICAgICAgbGV0IHkgOj0gYWRkKHNsb2FkKHYpLCAxKQogICAgICAgIHYgOj0geQogICAgfSAvLyB55Zyo6L%2BZ6YeM6KKrIOKAnOWIoOmZpOKAnSDkuoYKICAgIHNzdG9yZSh2LCB6ZXJvKQp9IC8vIHblkox6ZXJv5Zyo6L%2BZ6YeM6KKrIOKAnOWIoOmZpOKAneOAgg%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHplcm8gOj0gMAogICAgbGV0IHYgOj0gY2FsbGRhdGFsb2FkKHplcm8pCiAgICB7CiAgICAgICAgbGV0IHkgOj0gYWRkKHNsb2FkKHYpLCAxKQogICAgICAgIHYgOj0geQogICAgfSAvLyB55Zyo6L+Z6YeM6KKrIOKAnOWIoOmZpOKAnSDkuoYKICAgIHNzdG9yZSh2LCB6ZXJvKQp9IC8vIHblkox6ZXJv5Zyo6L+Z6YeM6KKrIOKAnOWIoOmZpOKAneOAgg==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-javascript" lang="javascript">{
    <span class="hljs-keyword">let</span> zero := <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> v := <span class="hljs-title function_">calldataload</span>(<span class="hljs-params">zero</span>)
    {
        <span class="hljs-keyword">let</span> y := <span class="hljs-title function_">add</span>(<span class="hljs-title function_">sload</span>(v), <span class="hljs-number">1</span>)
        v := y
    } <span class="hljs-comment">// y在这里被 “删除” 了</span>
    <span class="hljs-title function_">sstore</span>(v, zero)
} <span class="hljs-comment">// v和zero在这里被 “删除”。</span>
</code></pre>
<p>如果声明的变量应该有一个与默认类型不同的类型，您可以用冒号表示。 当您从一个返回多个值的函数调用中赋值时，您也可以在一条语句中声明多个变量。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DLy8g6L%2BZ5bCG5LiN5Lya6KKr57yW6K%2BR77yIdTMy5ZKMdTI1Nuexu%2BWei%2BWwmuacquWunueOsO%2B8ieOAggp7CiAgICBsZXQgemVybzp1MzIgOj0gMDp1MzIKICAgIGxldCB2OnUyNTYsIHQ6dTMyIDo9IGYoKQogICAgbGV0IHgsIHkgOj0gZygpCn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Ly8g6L+Z5bCG5LiN5Lya6KKr57yW6K+R77yIdTMy5ZKMdTI1Nuexu+Wei+WwmuacquWunueOsO+8ieOAggp7CiAgICBsZXQgemVybzp1MzIgOj0gMDp1MzIKICAgIGxldCB2OnUyNTYsIHQ6dTMyIDo9IGYoKQogICAgbGV0IHgsIHkgOj0gZygpCn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 这将不会被编译（u32和u256类型尚未实现）。</span>
{
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">zero</span>:<span class="hljs-type">u32</span> := <span class="hljs-number">0</span>:<span class="hljs-type">u32</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span>:u256, t:<span class="hljs-type">u32</span> := <span class="hljs-title function_ invoke__">f</span>()
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span>, y := <span class="hljs-title function_ invoke__">g</span>()
}
</code></pre>
<p>根据优化器的设置，编译器可以在变量被最后一次使用后释放堆栈槽，即使它仍然在范围内。</p>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id10" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id10" target="_blank" ref="nofollow noopener noreferrer">赋值</a></h3>
<p>变量可以在其定义后使用 <code>:=</code> 操作符进行赋值。可以在同一时间对多个变量进行赋值。 为此，数值的数量和类型必须匹配。如果您想对一个有多个返回参数的函数进行赋值， 您必须提供多个变量。同一变量不能多次出现在赋值的左侧，例如： <code>x, x := f()</code> 是无效的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IHYgOj0gMAovLyDph43mlrDlr7l26LWL5YC8CnYgOj0gMgpsZXQgdCA6PSBhZGQodiwgMikKZnVuY3Rpb24gZigpIC0%2BIGEsIGIgeyB9Ci8vIOi1i%2BS6iOWkmuS4quWAvAp2LCB0IDo9IGYoKQ%3D%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IHYgOj0gMAovLyDph43mlrDlr7l26LWL5YC8CnYgOj0gMgpsZXQgdCA6PSBhZGQodiwgMikKZnVuY3Rpb24gZigpIC0+IGEsIGIgeyB9Ci8vIOi1i+S6iOWkmuS4quWAvAp2LCB0IDo9IGYoKQ==" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> v := <span class="hljs-number">0</span>
<span class="hljs-comment">// 重新对v赋值</span>
v := <span class="hljs-number">2</span>
<span class="hljs-keyword">let</span> t := <span class="hljs-keyword">add</span>(v, <span class="hljs-number">2</span>)
<span class="hljs-function">function <span class="hljs-title">f</span>() -&gt; a, b</span> { }
<span class="hljs-comment">// 赋予多个值</span>
v, t := f()
</code></pre>
<h3 data-id="heading-9">If<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23if" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#if" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>if语句可用于有条件地执行代码。不能定义 “else” 块。 如果您需要多种选择条件，可以考虑使用 “switch” 来代替（见下文）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DaWYgbHQoY2FsbGRhdGFzaXplKCksIDQpIHsgcmV2ZXJ0KDAsIDApIH0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=aWYgbHQoY2FsbGRhdGFzaXplKCksIDQpIHsgcmV2ZXJ0KDAsIDApIH0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-scss" lang="scss">if <span class="hljs-built_in">lt</span>(calldatasize(), <span class="hljs-number">4</span>) { <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) }
</code></pre>
<p>代码块的大括号是必需的。</p>
<h3 data-id="heading-10">Switch<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23switch" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#switch" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>您可以使用switch语句作为if语句的扩展版本。 它获取一个表达式的值，并将其与几个字面常量进行比较，与匹配的常量相对应的分支被选中。 与其他编程语言不同的是，出于安全考虑，控制流不会从一个条件延续到下一个条件。 可以有一个叫 <code>default</code> 的回退或默认情况，如果没有一个字面常数匹配，就会采取这种情况。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHggOj0gMAogICAgc3dpdGNoIGNhbGxkYXRhbG9hZCg0KQogICAgY2FzZSAwIHsKICAgICAgICB4IDo9IGNhbGxkYXRhbG9hZCgweDI0KQogICAgfQogICAgZGVmYXVsdCB7CiAgICAgICAgeCA6PSBjYWxsZGF0YWxvYWQoMHg0NCkKICAgIH0KICAgIHNzdG9yZSgwLCBkaXYoeCwgMikpCn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHggOj0gMAogICAgc3dpdGNoIGNhbGxkYXRhbG9hZCg0KQogICAgY2FzZSAwIHsKICAgICAgICB4IDo9IGNhbGxkYXRhbG9hZCgweDI0KQogICAgfQogICAgZGVmYXVsdCB7CiAgICAgICAgeCA6PSBjYWxsZGF0YWxvYWQoMHg0NCkKICAgIH0KICAgIHNzdG9yZSgwLCBkaXYoeCwgMikpCn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    let x := <span class="hljs-number">0</span>
    switch <span class="hljs-built_in">calldataload</span>(<span class="hljs-number">4</span>)
    case <span class="hljs-number">0</span> {
        x := <span class="hljs-built_in">calldataload</span>(<span class="hljs-number">0</span>x24)
    }
    default {
        x := <span class="hljs-built_in">calldataload</span>(<span class="hljs-number">0</span>x44)
    }
    sstore(<span class="hljs-number">0</span>, <span class="hljs-selector-tag">div</span>(x, <span class="hljs-number">2</span>))
}
</code></pre>
<p>条件的列表没有用大括号括起来，但条件的主体确实需要大括号。</p>
<h3 data-id="heading-11">循环<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id11" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id11" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>Yul支持for循环，它由一个包含初始化部分的头，一个条件，一个后迭代部分和一个主体组成。 条件必须是一个表达式，而其他三个是代码块。 如果初始化部分在顶层声明了任何变量，这些变量的范围将延伸到循环的所有其他部分。</p>
<p><code>break</code> 和 <code>continue</code> 语句可以在主体中使用，分别用于退出循环或跳到后部分。</p>
<p>下面的例子是计算内存中一个代码区域的总和。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHggOj0gMAogICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIDB4MTAwKSB7IGkgOj0gYWRkKGksIDB4MjApIH0gewogICAgICAgIHggOj0gYWRkKHgsIG1sb2FkKGkpKQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHggOj0gMAogICAgZm9yIHsgbGV0IGkgOj0gMCB9IGx0KGksIDB4MTAwKSB7IGkgOj0gYWRkKGksIDB4MjApIH0gewogICAgICAgIHggOj0gYWRkKHgsIG1sb2FkKGkpKQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    let x := <span class="hljs-number">0</span>
    for { let <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span> } lt(<span class="hljs-selector-tag">i</span>, <span class="hljs-number">0</span>x100) { <span class="hljs-selector-tag">i</span> := <span class="hljs-built_in">add</span>(i, <span class="hljs-number">0</span>x20) } {
        x := <span class="hljs-built_in">add</span>(x, <span class="hljs-built_in">mload</span>(i))
    }
}
</code></pre>
<p>For循环也可以作为while循环的替代： 只需将初始化和后迭代部分留为空即可。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgbGV0IHggOj0gMAogICAgbGV0IGkgOj0gMAogICAgZm9yIHsgfSBsdChpLCAweDEwMCkgeyB9IHsgICAgIC8vIHdoaWxlKGkgPCAweDEwMCkKICAgICAgICB4IDo9IGFkZCh4LCBtbG9hZChpKSkKICAgICAgICBpIDo9IGFkZChpLCAweDIwKQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgbGV0IHggOj0gMAogICAgbGV0IGkgOj0gMAogICAgZm9yIHsgfSBsdChpLCAweDEwMCkgeyB9IHsgICAgIC8vIHdoaWxlKGkgPCAweDEwMCkKICAgICAgICB4IDo9IGFkZCh4LCBtbG9hZChpKSkKICAgICAgICBpIDo9IGFkZChpLCAweDIwKQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">{
    let x := <span class="hljs-number">0</span>
    let i := <span class="hljs-number">0</span>
    for { } lt(<span class="hljs-selector-tag">i</span>, <span class="hljs-number">0</span>x100) { } {     // while(<span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">0</span>x100)
        x := <span class="hljs-built_in">add</span>(x, <span class="hljs-built_in">mload</span>(i))
        i := <span class="hljs-built_in">add</span>(i, <span class="hljs-number">0</span>x20)
    }
}
</code></pre>
<h3 data-id="heading-12">函数声明<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id12" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id12" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>Yul允许定义函数。这些不应该与 Solidity 中的函数相混淆，因为它们从来不是一个合约的外部接口的一部分， 而是一个独立于 Solidity 函数的命名空间的一部分。</p>
<p>对于EVM来说，Yul函数从堆栈中获取它们的参数（和一个返回的PC）， 同时也将结果放到堆栈中。用户定义的函数和内置函数的调用方式完全相同。</p>
<p>函数可以在任何地方定义，并且在它们所声明的块中是可见的。 在一个函数中，您不能访问在该函数之外定义的局部变量。</p>
<p>函数声明参数和返回变量，与Solidity类似。 为了返回一个值，您可以把它分配给返回变量。</p>
<p>如果您调用一个返回多个值的函数， 您必须用 <code>a, b := f(x)</code> 或 <code>let a, b := f(x)</code> 将它们分配给多个变量。</p>
<p><code>leave</code> 语句可以用来退出当前函数。它的工作原理类似于其他语言中的 <code>return</code> 语句， 只是它不需要返回值，它只是退出函数， 函数将返回当前分配给返回变量的任何值。</p>
<p>注意，EVM语言有一个内置的函数叫 <code>return</code>， 它可以退出整个执行环境（内部消息调用），而不仅仅是当前的yul函数。</p>
<p>下面的例子通过平方和乘法实现了幂函数。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0%2BIHJlc3VsdCB7CiAgICAgICAgc3dpdGNoIGV4cG9uZW50CiAgICAgICAgY2FzZSAwIHsgcmVzdWx0IDo9IDEgfQogICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBiYXNlIH0KICAgICAgICBkZWZhdWx0IHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=ewogICAgZnVuY3Rpb24gcG93ZXIoYmFzZSwgZXhwb25lbnQpIC0+IHJlc3VsdCB7CiAgICAgICAgc3dpdGNoIGV4cG9uZW50CiAgICAgICAgY2FzZSAwIHsgcmVzdWx0IDo9IDEgfQogICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBiYXNlIH0KICAgICAgICBkZWZhdWx0IHsKICAgICAgICAgICAgcmVzdWx0IDo9IHBvd2VyKG11bChiYXNlLCBiYXNlKSwgZGl2KGV4cG9uZW50LCAyKSkKICAgICAgICAgICAgc3dpdGNoIG1vZChleHBvbmVudCwgMikKICAgICAgICAgICAgICAgIGNhc2UgMSB7IHJlc3VsdCA6PSBtdWwoYmFzZSwgcmVzdWx0KSB9CiAgICAgICAgfQogICAgfQp9" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-sql" lang="sql">{
    <span class="hljs-keyword">function</span> <span class="hljs-built_in">power</span>(base, exponent) <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">result</span> {
        switch exponent
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-number">1</span> }
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> base }
        <span class="hljs-keyword">default</span> {
            <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> <span class="hljs-built_in">power</span>(mul(base, base), div(exponent, <span class="hljs-number">2</span>))
            switch <span class="hljs-built_in">mod</span>(exponent, <span class="hljs-number">2</span>)
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span> { <span class="hljs-keyword">result</span> :<span class="hljs-operator">=</span> mul(base, <span class="hljs-keyword">result</span>) }
        }
    }
}
</code></pre>
<h2 data-id="heading-13">Yul形式规范<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id13" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id13" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p>本章正式描述Yul代码。Yul代码通常放置在Yul对象内， Yul对象将在它们自己的章节中解释。</p>
<pre><code class="hljs language-sql" lang="sql">代码块 <span class="hljs-operator">=</span> <span class="hljs-string">'{'</span> 语句<span class="hljs-operator">*</span> <span class="hljs-string">'}'</span>
语句 <span class="hljs-operator">=</span>
    代码块 <span class="hljs-operator">|</span>
    函数定义 <span class="hljs-operator">|</span>
    变量声明 <span class="hljs-operator">|</span>
    赋值 <span class="hljs-operator">|</span>
    If <span class="hljs-operator">|</span>
    表达式 <span class="hljs-operator">|</span>
    Switch <span class="hljs-operator">|</span>
    <span class="hljs-keyword">For</span> 循环 <span class="hljs-operator">|</span>
    循环中断 <span class="hljs-operator">|</span>
    退出
函数定义 <span class="hljs-operator">=</span>
    <span class="hljs-string">'function'</span> 标识符 <span class="hljs-string">'('</span> 带类型的标识符列表? <span class="hljs-string">')'</span>
    ( <span class="hljs-string">'-&gt;'</span> 带类型的标识符列表 )? 代码块
变量声明 <span class="hljs-operator">=</span>
    <span class="hljs-string">'let'</span> 带类型的标识符列表 ( <span class="hljs-string">':='</span> 表达式 )?
赋值 <span class="hljs-operator">=</span>
    标识符列表 <span class="hljs-string">':='</span> 表达式
表达式 <span class="hljs-operator">=</span>
    函数调用 <span class="hljs-operator">|</span> 标识符 <span class="hljs-operator">|</span> 字面量
If 条件语句 <span class="hljs-operator">=</span>
    <span class="hljs-string">'if'</span> 表达式 代码块
Switch 条件语句 <span class="hljs-operator">=</span>
    <span class="hljs-string">'switch'</span> 表达式 ( <span class="hljs-keyword">Case</span><span class="hljs-operator">+</span> <span class="hljs-keyword">Default</span>? <span class="hljs-operator">|</span> <span class="hljs-keyword">Default</span> )
<span class="hljs-keyword">Case</span> <span class="hljs-operator">=</span>
    <span class="hljs-string">'case'</span> 字面量 代码块
<span class="hljs-keyword">Default</span> <span class="hljs-operator">=</span>
    <span class="hljs-string">'default'</span> 代码块
<span class="hljs-keyword">For</span> 循环 <span class="hljs-operator">=</span>
    <span class="hljs-string">'for'</span> 代码块 表达式 代码块 代码块
循环中断 <span class="hljs-operator">=</span>
    <span class="hljs-string">'break'</span> <span class="hljs-operator">|</span> <span class="hljs-string">'continue'</span>
退出 <span class="hljs-operator">=</span> <span class="hljs-string">'leave'</span>
函数调用 <span class="hljs-operator">=</span>
    标识符 <span class="hljs-string">'('</span> ( 表达式 ( <span class="hljs-string">','</span> 表达式 )<span class="hljs-operator">*</span> )? <span class="hljs-string">')'</span>
标识符 <span class="hljs-operator">=</span> [a<span class="hljs-operator">-</span>zA<span class="hljs-operator">-</span>Z_$] [a<span class="hljs-operator">-</span>zA<span class="hljs-operator">-</span>Z_$<span class="hljs-number">0</span><span class="hljs-number">-9.</span>]<span class="hljs-operator">*</span>
标识符列表 <span class="hljs-operator">=</span> 标识符 ( <span class="hljs-string">','</span> 标识符)<span class="hljs-operator">*</span>
类型名 <span class="hljs-operator">=</span> 标识符
带类型的标识符列表 <span class="hljs-operator">=</span> 标识符 ( <span class="hljs-string">':'</span> 类型名 )? ( <span class="hljs-string">','</span> 标识符 ( <span class="hljs-string">':'</span> 类型名 )? )<span class="hljs-operator">*</span>
字面量 <span class="hljs-operator">=</span>
    (数字字面量 <span class="hljs-operator">|</span> 字符串字面量 <span class="hljs-operator">|</span> <span class="hljs-literal">True</span>字面量 <span class="hljs-operator">|</span> <span class="hljs-literal">False</span>字面量) ( <span class="hljs-string">':'</span> 类型名 )?
数字字面量 <span class="hljs-operator">=</span> 十六进制数字 <span class="hljs-operator">|</span> 十进制数字
字符串字面量 <span class="hljs-operator">=</span> <span class="hljs-string">'"'</span> ([<span class="hljs-operator">^</span>"\r\n\] | '\' .)* '"<span class="hljs-string">'
True字面量 = '</span><span class="hljs-literal">true</span><span class="hljs-string">'
False字面量 = '</span><span class="hljs-literal">false</span><span class="hljs-string">'
十六进制数字 = '</span><span class="hljs-number">0</span>x<span class="hljs-string">' [0-9a-fA-F]+
十进制数字 = [0-9]+
</span></code></pre>
<h3 data-id="heading-14">语法层面的限制<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id14" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id14" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>除语法直接规定的限制外，还适用以下限制：</p>
<p>Switch 语句必须至少有一个判断条件（包括默认条件）。 所有情况下的值都需要有相同的类型和不同的值。 如果表达式类型的所有可能值都被覆盖，则不允许有默认情况 （例如，一个带有 <code>bool</code> 表达式的Switch 语句，如果有一个真和一个假的情况，则不允许有默认情况）。</p>
<p>每个表达式都评估为零或多个值。 标识符和字面量精确地评估为一个值， 而函数调用求值为所调用函数的返回值。</p>
<p>在变量声明和赋值中，右边的表达式（如果存在的话）必须求值到与左边的变量数量相等的数值。 这是唯一允许对一个以上的值进行评估的表达式的情况。 在赋值或变量声明的左侧，同一个变量名称不能出现多次。</p>
<p>也是语句的表达式（即在块级）必须评估为零值。</p>
<p>在所有其他情况下，表达式必须精确评估为一个值。</p>
<p><code>continue</code> 或 <code>break</code> 语句只能在for循环的主体内使用，如下所示。 考虑包含该语句的最内部循环。循环和语句必须在同一个函数中，或者两者必须在最高层。 该语句必须在循环的主体块中；不能在循环的初始化块或更新块中。 值得强调的是，这个限制只适用于包含 <code>continue</code> 或 <code>break</code> 语句的最内层循环： 这个最内层循环，以及 <code>continue</code> 或 <code>break</code> 语句， 可以出现在外层循环的任何地方，可能是外层循环的初始化块或更新块中。 例如，下面的例子是合法的，因为 <code>break</code> 出现在内循环的主体块中，尽管也出现在外循环的更新块中。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DZm9yIHt9IHRydWUgeyBmb3Ige30gdHJ1ZSB7fSB7IGJyZWFrIH0gfQp7Cn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Zm9yIHt9IHRydWUgeyBmb3Ige30gdHJ1ZSB7fSB7IGJyZWFrIH0gfQp7Cn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">for</span> {} <span class="hljs-literal">true</span> { <span class="hljs-keyword">for</span> {} <span class="hljs-literal">true</span> {} { <span class="hljs-keyword">break</span> } }
{
}
</code></pre>
<p>for循环的条件部分必须精确评估为一个值。</p>
<p><code>leave</code> 语句只能在一个函数内使用。</p>
<p>函数不能在for循环初始化块的任何地方定义。</p>
<p>字面量不可以大于它们本身的类型。已定义的最大类型宽度为 256 比特。</p>
<p>在赋值和函数调用过程中，各个值的类型必须匹配。 没有隐式的类型转换。一般来说，只有当EVM语言提供一个适当的内置函数， 接收一个类型的值并返回一个不同类型的值时，才能实现类型转换。</p>
<h3 data-id="heading-15">作用域规则<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id15" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id15" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>Yul中的作用域是与块联系在一起的（函数和for循环是例外，下面会解释）， 所有的声明（ <code>函数定义（FunctionDefinition）</code>， <code>变量声明（VariableDeclaration）</code>） 都将新的标识符引入这些作用域。</p>
<p>标识符在其定义的块中是可见的（包括所有子节点和子块）。 函数在整个块中是可见的（甚至在其定义之前）， 而变量只在 <code>变量声明</code> 之后的语句中可见。</p>
<p>特别是，变量不能在其自身变量声明的右侧被引用。 函数可以在其声明之前就被引用（如果它们是可见的）。</p>
<p>作为一般范围规则的一个例外，for 循环的 “init” 部分（第一个块）的范围延伸到for 循环的所有其他部分。 这意味着在init部分声明的变量（和函数）（但不在init部分的块内）在for循环的所有其他部分都是可见的。</p>
<p>在for循环的其他部分声明的标识符要遵守常规的句法范围规则。</p>
<p>这意味着一个for循环的形式 <code>for { I... } C { P... } { B... }</code> 等同于 <code>{ I... for {}. C { P... } { B...  }</code>.</p>
<p>函数的参数和返回参数在函数体中是可见的，其名称必须是不同的。</p>
<p>在函数内部，不可能引用一个在该函数之外声明的变量。</p>
<p>影子变量是不允许的，也就是说，您不能在另一个同名的标识符也可见的地方声明一个标识符， 即使因为它是在当前函数之外声明的而不可能引用它。</p>
<h3 data-id="heading-16">形式规范<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id16" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id16" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>我们通过提供一个在AST的各个节点上重写的评估函数E来正式指定Yul。 由于内置函数可能有副作用，E接收两个状态对象和AST节点，并返回两个新的状态对象和数量不定的其他值。 这两个状态对象是全局状态对象（在EVM的背景下，它是区块链的内存、存储和状态） 和本地状态对象（本地变量的状态，即EVM中堆栈的一段）。</p>
<p>如果AST节点是一个语句，E返回两个状态对象和一个 “mode”， 该mode用于 <code>break</code>， <code>continue</code> 和 <code>leave</code> 语句。 如果AST节点是一个表达式，E返回两个状态对象和表达式所评估的数值。</p>
<p>全局状态的确切性质在这个高层次的描述中没有明确说明。 本地状态 <code>L</code> 是标识符 <code>i</code> 到值 <code>v</code> 的映射，表示为 <code>L[i] = v</code>。</p>
<p>对于标识符 <code>v</code>, 我们用 <code>$v</code> 作为标识符的名字。</p>
<p>我们将为 AST 节点使用解构符号。</p>
<pre><code class="hljs language-csharp" lang="csharp">E(G, L, &lt;{St1, ..., Stn}&gt;: Block) =
    <span class="hljs-keyword">let</span> G1, L1, mode = E(G, L, St1, ..., Stn)
    <span class="hljs-keyword">let</span> L2 be a restriction of L1 to the identifiers of L
    G1, L2, <span class="hljs-function">mode
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, St1, ..., Stn: Statement</span>)</span> =
    <span class="hljs-keyword">if</span> n <span class="hljs-keyword">is</span> zero:
        G, L, regular
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">let</span> G1, L1, mode = E(G, L, St1)
        <span class="hljs-function"><span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> regular then
            <span class="hljs-title">E</span>(<span class="hljs-params">G1, L1, St2, ..., Stn</span>)
        otherwise
            G1, L1, mode
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, FunctionDefinition</span>)</span> =
    G, L, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">let</span> var_1, ..., var_n := rhs&gt;: VariableDeclaration</span>)</span> =
    E(G, L, &lt;var_1, ..., var_n := rhs&gt;: Assignment)
E(G, L, &lt;<span class="hljs-keyword">let</span> var_1, ..., var_n&gt;: VariableDeclaration) =
    <span class="hljs-keyword">let</span> L1 be a copy of L <span class="hljs-keyword">where</span> L1[$var_i] = <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, ..., n
    G, L1, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;var_1, ..., var_n := rhs&gt;: Assignment</span>)</span> =
    <span class="hljs-keyword">let</span> G1, L1, v1, ..., vn = E(G, L, rhs)
    <span class="hljs-keyword">let</span> L2 be a copy of L1 <span class="hljs-keyword">where</span> L2[$var_i] = vi <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, ..., n
    G1, L2, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">for</span> { i1, ..., <span class="hljs-keyword">in</span> } condition post body&gt;: ForLoop</span>)</span> =
    <span class="hljs-keyword">if</span> n &gt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">let</span> G1, L1, mode = E(G, L, i1, ..., <span class="hljs-keyword">in</span>)
        <span class="hljs-comment">// 由于语法限制，mode 必须是规则的</span>
        <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> leave then
            G1, L1 restricted to variables of L, leave
        otherwise
            <span class="hljs-keyword">let</span> G2, L2, mode = E(G1, L1, <span class="hljs-keyword">for</span> {} condition post body)
            G2, L2 restricted to variables of L, mode
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">let</span> G1, L1, v = E(G, L, condition)
        <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>:
            G1, L1, regular
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">let</span> G2, L2, mode = E(G1, L, body)
            <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> <span class="hljs-keyword">break</span>:
                G2, L2, regular
            otherwise <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> leave:
                G2, L2, leave
            <span class="hljs-keyword">else</span>:
                G3, L3, mode = E(G2, L2, post)
                <span class="hljs-keyword">if</span> mode <span class="hljs-keyword">is</span> leave:
                    G3, L3, <span class="hljs-function">leave
                otherwise
                    <span class="hljs-title">E</span>(<span class="hljs-params">G3, L3, <span class="hljs-keyword">for</span> {} condition post body</span>)
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, <span class="hljs-keyword">break</span>: BreakContinue</span>)</span> =
    G, L, <span class="hljs-function"><span class="hljs-keyword">break</span>
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, <span class="hljs-keyword">continue</span>: BreakContinue</span>)</span> =
    G, L, <span class="hljs-function"><span class="hljs-keyword">continue</span>
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, leave: Leave</span>)</span> =
    G, L, <span class="hljs-function">leave
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">if</span> condition body&gt;: If</span>)</span> =
    <span class="hljs-keyword">let</span> G0, L0, v = E(G, L, condition)
    <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>:
        E(G0, L0, body)
    <span class="hljs-keyword">else</span>:
        G0, L0, <span class="hljs-function">regular
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, &lt;<span class="hljs-keyword">switch</span> condition <span class="hljs-keyword">case</span> l1:t1 st1 ... <span class="hljs-keyword">case</span> ln:tn stn&gt;: Switch</span>)</span> =
    E(G, L, <span class="hljs-keyword">switch</span> condition <span class="hljs-keyword">case</span> l1:t1 st1 ... <span class="hljs-keyword">case</span> ln:tn stn <span class="hljs-literal">default</span> {})
E(G, L, &lt;<span class="hljs-keyword">switch</span> condition <span class="hljs-keyword">case</span> l1:t1 st1 ... <span class="hljs-keyword">case</span> ln:tn stn <span class="hljs-literal">default</span> st<span class="hljs-string">'&gt;: Switch) =
    let G0, L0, v = E(G, L, condition)
    // i = 1 .. n
    // 对字面量求值，上下文无关
    let _, _, v1 = E(G0, L0, l1)
    ...
    let _, _, vn = E(G0, L0, ln)
    if there exists smallest i such that vi = v:
        E(G0, L0, sti)
    else:
        E(G0, L0, st'</span>)

E(G, L, &lt;name&gt;: Identifier) =
    G, L, L[$name]
E(G, L, &lt;fname(arg1, ..., argn)&gt;: FunctionCall) =
    G1, L1, vn = E(G, L, argn)
    ...
    G(n<span class="hljs-number">-1</span>), L(n<span class="hljs-number">-1</span>), v2 = E(G(n<span class="hljs-number">-2</span>), L(n<span class="hljs-number">-2</span>), arg2)
    Gn, Ln, v1 = E(G(n<span class="hljs-number">-1</span>), L(n<span class="hljs-number">-1</span>), arg1)
    Let &lt;<span class="hljs-function">function <span class="hljs-title">fname</span> (<span class="hljs-params">param1, ..., paramn</span>) -&gt; ret1, ..., retm block&gt;
    be the function of name $fname visible at the point of the call.
    Let L' be a <span class="hljs-keyword">new</span> local state such that
    L'[$parami]</span> = vi <span class="hljs-keyword">and</span> L<span class="hljs-string">'[$reti] = 0 for all i.
    Let G'</span><span class="hljs-string">', L'</span><span class="hljs-string">', mode = E(Gn, L'</span>, block)
    G<span class="hljs-string">''</span>, Ln, L<span class="hljs-string">''</span>[$ret1], ..., L<span class="hljs-string">''</span>[$retm]
E(G, L, l: StringLiteral) = G, L, str(l),
    <span class="hljs-keyword">where</span> str <span class="hljs-keyword">is</span> the <span class="hljs-built_in">string</span> evaluation function,
    which <span class="hljs-keyword">for</span> the EVM dialect <span class="hljs-keyword">is</span> defined <span class="hljs-keyword">in</span> the section <span class="hljs-string">'Literals'</span> <span class="hljs-function">above
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, n: HexNumber</span>)</span> = G, L, hex(n)
    <span class="hljs-keyword">where</span> hex <span class="hljs-keyword">is</span> the hexadecimal evaluation function,
    <span class="hljs-function">which turns a sequence of hexadecimal digits <span class="hljs-keyword">into</span> their big endian <span class="hljs-keyword">value</span>
<span class="hljs-title">E</span>(<span class="hljs-params">G, L, n: DecimalNumber</span>)</span> = G, L, dec(n),
    <span class="hljs-keyword">where</span> dec <span class="hljs-keyword">is</span> the <span class="hljs-built_in">decimal</span> evaluation function,
    which turns a sequence of <span class="hljs-built_in">decimal</span> digits <span class="hljs-keyword">into</span> their big endian <span class="hljs-keyword">value</span>
</code></pre>
<h3 data-id="heading-17">EVM语言<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23evm" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#evm" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>目前Yul的默认语言是当前选择的EVM版本的EVM语言。 该语言中唯一可用的类型是 <code>u256</code>，即Ethereum虚拟机的256位本地类型。 因为它是该语言的默认类型，所以可以省略。</p>
<p>下表列出了所有内置函数（取决于EVM版本），并提供了函数/操作码的语义的简短描述。 本文件并不想成为以太坊虚拟机的完整描述。如果您对精确的语义感兴趣，请参考另一份文件。</p>
<p>标有 <code>-</code> 的操作码不返回结果，所有其他操作码正好返回一个值。 标有 <code>F</code>， <code>H</code>， <code>B</code>， <code>C</code>， <code>I</code>， <code>L</code>， <code>P</code> 和 <code>N</code> 的操作码分别 是从Frontier，Homestead，Byzantium，Constantinople，Istanbul，London，Paris或Cancun版本出现的。</p>
<p>在下文中， <code>mem[a...b)</code> 表示从位置 <code>a</code> 开始到不包括位置 <code>b</code> 的内存字节， <code>storage[p]</code> 表示插槽 <code>p</code> 的存储内容。 同样地， <code>transientStorage[p]</code> 表示插槽 <code>p</code> 处的临时存储内容。</p>
<p>由于Yul管理着局部变量和控制流，所以不能使用干扰这些功能的操作码。 这包括 <code>dup</code> 和 <code>swap</code> 指令，以及 <code>jump</code> 指令，标签和 <code>push</code> 指令。</p>























































































































































































































































































































































































































































































































<table><thead><tr><th>指令</th><th/><th/><th>解释</th></tr></thead><tbody><tr><td>stop()</td><td>-</td><td>F</td><td>停止执行，与return(0, 0)相同</td></tr><tr><td>add(x, y)</td><td/><td>F</td><td>x + y</td></tr><tr><td>sub(x, y)</td><td/><td>F</td><td>x - y</td></tr><tr><td>mul(x, y)</td><td/><td>F</td><td>x * y</td></tr><tr><td>div(x, y)</td><td/><td>F</td><td>x / y 或 如果 y == 0，则为 0</td></tr><tr><td>sdiv(x, y)</td><td/><td>F</td><td>x / y，对于有符号的二进制补码，如果 y == 0，则为 0</td></tr><tr><td>mod(x, y)</td><td/><td>F</td><td>x % y, 如果 y == 0，则为 0</td></tr><tr><td>smod(x, y)</td><td/><td>F</td><td>x % y, 对于有符号的二进制补码, 如果 y == 0，则为 0</td></tr><tr><td>exp(x, y)</td><td/><td>F</td><td>x的y次方</td></tr><tr><td>not(x)</td><td/><td>F</td><td>x的位 “非”（x的每一个位都取反）</td></tr><tr><td>lt(x, y)</td><td/><td>F</td><td>如果 x &lt; y，则为1，否则为0</td></tr><tr><td>gt(x, y)</td><td/><td>F</td><td>如果 x &gt; y，则为1，否则为0</td></tr><tr><td>slt(x, y)</td><td/><td>F</td><td>如果 x &lt; y，则为1，否则为0，适用于有符号的二进制补码</td></tr><tr><td>sgt(x, y)</td><td/><td>F</td><td>如果 x &gt; y，则为1，否则为0，适用于有符号的二进制补码</td></tr><tr><td>eq(x, y)</td><td/><td>F</td><td>如果 x == y，则为1，否则为0</td></tr><tr><td>iszero(x)</td><td/><td>F</td><td>如果 x == 0，则为1，否则为0</td></tr><tr><td>and(x, y)</td><td/><td>F</td><td>x 和 y 的按位 “与”</td></tr><tr><td>or(x, y)</td><td/><td>F</td><td>x 和 y 的按位 “或”</td></tr><tr><td>xor(x, y)</td><td/><td>F</td><td>x 和 y 的按位 “异或”</td></tr><tr><td>byte(n, x)</td><td/><td>F</td><td>x的第n个字节，其中最高有效字节是第0个字节</td></tr><tr><td>shl(x, y)</td><td/><td>C</td><td>将 y 逻辑左移 x 位</td></tr><tr><td>shr(x, y)</td><td/><td>C</td><td>将 y 逻辑右移 x 位</td></tr><tr><td>sar(x, y)</td><td/><td>C</td><td>有符号算术右移 y 的 x 位</td></tr><tr><td>addmod(x, y, m)</td><td/><td>F</td><td>(x + y) % m，采用任意精度算术，如果m == 0则为0</td></tr><tr><td>mulmod(x, y, m)</td><td/><td>F</td><td>(x * y) % m，采用任意精度算术，如果m == 0则为0</td></tr><tr><td>signextend(i, x)</td><td/><td>F</td><td>从最低有效位开始计数，从第 (i*8+7) 位进行符号扩展</td></tr><tr><td>keccak256(p, n)</td><td/><td>F</td><td>keccak(mem[p…(p+n)))</td></tr><tr><td>pc()</td><td/><td>F</td><td>代码中的当前位置</td></tr><tr><td>pop(x)</td><td>-</td><td>F</td><td>丢弃值 x</td></tr><tr><td>mload(p)</td><td/><td>F</td><td>mem[p…(p+32))</td></tr><tr><td>mstore(p, v)</td><td>-</td><td>F</td><td>mem[p…(p+32)) := v</td></tr><tr><td>mstore8(p, v)</td><td>-</td><td>F</td><td>mem[p] := v &amp; 0xff （只修改一个字节）</td></tr><tr><td>sload(p)</td><td/><td>F</td><td>storage[p]</td></tr><tr><td>sstore(p, v)</td><td>-</td><td>F</td><td>storage[p] := v</td></tr><tr><td>tload(p)</td><td/><td>N</td><td>transientStorage[p]</td></tr><tr><td>tstore(p, v)</td><td>-</td><td>N</td><td>transientStorage[p] := v</td></tr><tr><td>msize()</td><td/><td>F</td><td>内存的大小，即最大的访问内存索引</td></tr><tr><td>gas()</td><td/><td>F</td><td>仍可以执行的燃料值</td></tr><tr><td>address()</td><td/><td>F</td><td>当前合约/执行环境的地址</td></tr><tr><td>balance(a)</td><td/><td>F</td><td>地址为a的余额，以wei为单位</td></tr><tr><td>selfbalance()</td><td/><td>I</td><td>相当于balance(address())，但更便宜</td></tr><tr><td>caller()</td><td/><td>F</td><td>消息调用者（不包括 <code>delegatecall</code> 调用）</td></tr><tr><td>callvalue()</td><td/><td>F</td><td>与当前调用一起发送的wei的数量</td></tr><tr><td>calldataload(p)</td><td/><td>F</td><td>从位置p开始的调用数据（32字节）</td></tr><tr><td>calldatasize()</td><td/><td>F</td><td>调用数据的大小，以字节为单位</td></tr><tr><td>calldatacopy(t, f, s)</td><td>-</td><td>F</td><td>从位置f的调用数据复制s个字节到位置t的内存中</td></tr><tr><td>codesize()</td><td/><td>F</td><td>当前合约/执行环境的代码大小</td></tr><tr><td>codecopy(t, f, s)</td><td>-</td><td>F</td><td>从位置f的code中复制s个字节到位置t的内存中</td></tr><tr><td>extcodesize(a)</td><td/><td>F</td><td>地址为a的代码的大小</td></tr><tr><td>extcodecopy(a, t, f, s)</td><td>-</td><td>F</td><td>像 codecopy(t, f, s) 一样，但在地址a处取代码</td></tr><tr><td>returndatasize()</td><td/><td>B</td><td>最后返回数据的大小</td></tr><tr><td>returndatacopy(t, f, s)</td><td>-</td><td>B</td><td>从位置f的returndata复制s个字节到位置t的内存中</td></tr><tr><td>mcopy(t, f, s)</td><td>-</td><td>N</td><td>从位置f的内存复制s个字节到位置t的内存中</td></tr><tr><td>extcodehash(a)</td><td/><td>C</td><td>地址a的代码哈希值</td></tr><tr><td>create(v, p, n)</td><td/><td>F</td><td>创建新合约，其代码为内存中位置p到(p+n)的内容，发送v数量的wei 并返回新地址；错误时返回0</td></tr><tr><td>create2(v, p, n, s)</td><td/><td>C</td><td>创建新合约，其代码为内存中位置p到(p+n)的内容 合约地址为 keccak256(0xff . this . s . keccak256(mem[p…(p+n))) 并发送v数量wei然后返回新地址， 其中 <code>0xff</code> 是一个1字节的值， <code>this</code> 是当前合约的地址， 是一个20字节的值， <code>s</code> 是一个大端序的256位值； 错误时返回0</td></tr><tr><td>call(g, a, v, in, insize, out, outsize)</td><td/><td>F</td><td>调用地址为a的合约，输入数据为内存中位置in到(in+insize)的内容 一并发送g数量的燃料和v数量的wei，并将输出写入内存中 位置out到(out+outsize)的区域。 如果错误，返回0（比如，燃料耗尽） 成功则返回1 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>callcode(g, a, v, in, insize, out, outsize)</td><td/><td>F</td><td>相当于 <code>call</code> 但仅仅使用地址a上的代码 执行时留在当前合约的上下文当中 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>delegatecall(g, a, in, insize, out, outsize)</td><td/><td>H</td><td>相当于 <code>callcode</code>, 但同时保留 <code>caller</code> 和 <code>callvalue</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>staticcall(g, a, in, insize, out, outsize)</td><td/><td>B</td><td>相当于 <code>call(g, a, 0, in, insize, out, outsize)</code> 但不允许状态变量的修改 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-call-return-area" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-call-return-area" ref="nofollow noopener noreferrer">查看更多</a></td></tr><tr><td>return(p, s)</td><td>-</td><td>F</td><td>终止执行，并返回内存中位置p到(p+s)的数据</td></tr><tr><td>revert(p, s)</td><td>-</td><td>B</td><td>终止执行，回滚状态更改，并返回内存中位置p到(p+s)的数据</td></tr><tr><td>selfdestruct(a)</td><td>-</td><td>F</td><td>终止执行，销毁当前合约，并且将余额发送到地址a （已废弃）</td></tr><tr><td>invalid()</td><td>-</td><td>F</td><td>以无效指令终止执行</td></tr><tr><td>log0(p, s)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容产生日志</td></tr><tr><td>log1(p, s, t1)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1 产生日志</td></tr><tr><td>log2(p, s, t1, t2)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1，t2 产生日志</td></tr><tr><td>log3(p, s, t1, t2, t3)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1，t2，t3 产生日志</td></tr><tr><td>log4(p, s, t1, t2, t3, t4)</td><td>-</td><td>F</td><td>用内存中位置p到(p+s)的内容和 topic t1，t2，t3，t4 产生日志</td></tr><tr><td>chainid()</td><td/><td>I</td><td>执行链的ID（EIP-1344）</td></tr><tr><td>basefee()</td><td/><td>L</td><td>当前区块的基本费用（EIP-3198和EIP-1559）</td></tr><tr><td>blobbasefee()</td><td/><td>N</td><td>当前区块的blob的基本费用 （EIP-7516和EIP-4844）</td></tr><tr><td>origin()</td><td/><td>F</td><td>交易发送者</td></tr><tr><td>gasprice()</td><td/><td>F</td><td>交易的燃料价格</td></tr><tr><td>blockhash(b)</td><td/><td>F</td><td>区块编号b的哈希值-只针对最近的256个区块，不包括当前区块</td></tr><tr><td>blobhash(i)</td><td/><td>N</td><td>交易的第i个blob的版本化哈希值</td></tr><tr><td>coinbase()</td><td/><td>F</td><td>当前的挖矿的受益者</td></tr><tr><td>timestamp()</td><td/><td>F</td><td>自epoch开始的，当前块的时间戳，以秒为单位</td></tr><tr><td>number()</td><td/><td>F</td><td>当前区块号</td></tr><tr><td>difficulty()</td><td/><td>F</td><td>当前区块的难度（见下面的注释）</td></tr><tr><td>prevrandao()</td><td/><td>P</td><td>由信标链提供的随机性（见下面的注释）</td></tr><tr><td>gaslimit()</td><td/><td>F</td><td>当前区块的区块以太燃料限制</td></tr></tbody></table>
<p>备注</p>
<p><code>call*</code> 指令使用 <code>out</code> 和 <code>outsize</code> 参数来在内存中定义的一个区域， 用于放置返回或失败数据。这个区域的写入取决于被调用的合约返回多少字节。 如果它返回更多的数据，只有第一个 <code>outsize</code> 字节被写入。您可以使用 <code>returndatacopy</code> 操作码访问其余的数据。 如果它返回较少的数据，那么剩下的字节根本不被触及。 您需要使用 <code>returndatacopy</code> 操作码来检查这个内存区域的哪一部分包含返回数据。 剩下的字节将保留调用前的值。</p>
<p>备注</p>
<p><code>difficulty()</code> 指令在 EVM &gt;= Paris 版本中是不允许的。 随着 Paris 网络的升级，以前被称为 <code>difficulty</code> 的指令的语义已经改变， 该指令被重新命名为 <code>prevrandao</code>。 它现在可以返回全256位范围内的任意值， 而Ethash内部记录的最高难度值是~54位。 这一变化在 <a href="https://link.juejin.cn?target=https%3A%2F%2Feips.ethereum.org%2FEIPS%2Feip-4399" target="_blank" title="https://eips.ethereum.org/EIPS/eip-4399" ref="nofollow noopener noreferrer">EIP-4399</a> 中有所描述。 请注意，与在编译器中选择哪个EVM版本无关，指令的语义取决于最终的部署链。</p>
<p>警告</p>
<p>从0.8.18及更高版本开始，在 Solidity 和 Yul 中使用 <code>selfdestruct</code> 将触发弃用警告， 因为 <code>SELFDESTRUCT</code> 操作码最终将经历 <a href="https://link.juejin.cn?target=https%3A%2F%2Feips.ethereum.org%2FEIPS%2Feip-6049" target="_blank" title="https://eips.ethereum.org/EIPS/eip-6049" ref="nofollow noopener noreferrer">EIP-6049</a> 中所述的行为的重大变化。</p>
<p>在一些内部语言中，还有一些额外的函数：</p>
<h4 data-id="heading-18">datasize, dataoffset, datacopy<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23datasize-dataoffset-datacopy" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#datasize-dataoffset-datacopy" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>函数 <code>datasize(x)</code>， <code>dataoffset(x)</code> 和 <code>datacopy(t, f, l)</code> 用来访问Yul对象的其他部分。</p>
<p><code>datasize</code> 和 <code>dataoffset</code> 只能接受字符串字面量（其他对象的名称）作为参数， 并分别返回数据区的大小和偏移量。 对于EVM， <code>datacopy</code> 函数等同于 <code>codecopy</code>。</p>
<h4 data-id="heading-19">setimmutable, loadimmutable<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23setimmutable-loadimmutable" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#setimmutable-loadimmutable" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>函数 <code>setimmutable(offset, "name", value)</code> 和 <code>loadimmutable("name")</code> 用于Solidity中的不可变机制， 不能很好地映射到纯Yul。 对 <code>setimmutable(offset, "name", value)</code> 的调用假定包含给定不可变的命名的合约的运行时代码 在偏移量 <code>offset</code> 处被复制到内存中，并将把 <code>value</code> 写到内存中的所有位置（相对于 <code>offset</code>）， 这些位置包含在运行时代码中为调用 <code>loadimmutable("name")</code> 产生的占位符。</p>
<h4 data-id="heading-20">linkersymbol<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23linkersymbol" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#linkersymbol" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>函数 <code>linkersymbol("library_id")</code> 是一个占位符，用来表示被链接器替换的地址字头。 它的第一个也是唯一的参数必须是一个字符串变量，并且唯一地代表要插入的地址。 标识符可以是任意的，但是当编译器从Solidity源产生Yul代码时，它使用一个库名， 并以定义该库的源单元的名称作为限定。 要用一个特定的库地址链接代码，必须在命令行上的 <code>--libraries</code> 选项中提供相同的标识符。</p>
<p>例如，这段代码</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IGEgOj0gbGlua2Vyc3ltYm9sKCJmaWxlLnNvbDpNYXRoIik%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IGEgOj0gbGlua2Vyc3ltYm9sKCJmaWxlLnNvbDpNYXRoIik=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-css" lang="css">let <span class="hljs-selector-tag">a</span> := <span class="hljs-built_in">linkersymbol</span>(<span class="hljs-string">"file.sol:Math"</span>)
</code></pre>
<p>相当于</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IGEgOj0gMHgxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkw" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IGEgOj0gMHgxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkw" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">let</span> a := 0x1234567890123456789012345678901234567890
</code></pre>
<p>当使用 <code>--libraries "file.sol:Math=0x1234567890123456789012345678901234567890</code> 选项调用链接器时。</p>
<p>请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fusing-the-compiler.html%23commandline-compiler" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/using-the-compiler.html#commandline-compiler" ref="nofollow noopener noreferrer">使用命令行编译器</a> 以了解有关 Solidity 链接器的详情。</p>
<h4 data-id="heading-21">memoryguard<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23memoryguard" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#memoryguard" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>调用 <code>let ptr := memoryguard(size)</code> 的调用者（其中 <code>size</code> 必须是一个数字字面量） 承诺他们只使用 <code>[0, size]</code> 范围内的内存，或者从 <code>ptr</code> 开始的无界范围。</p>
<p>由于 <code>memoryguard</code> 调用的存在表明所有的内存访问都遵守这一限制， 它允许优化器执行额外的优化步骤， 例如堆栈限制规避器，它试图将原本无法到达的堆栈变量转移到内存中。</p>
<p>Yul优化器承诺只使用内存范围 <code>[size, ptr)</code> 来实现其目的。 如果优化器不需要保留任何内存，它认为 <code>ptr == size</code>。</p>
<p><code>memoryguard</code> 可以被多次调用，但是需要在一个Yul子对象内有相同的字样作为参数。 如果在一个子对象中发现至少一个 <code>memoryguard</code> 的调用，额外的优化步骤将在它身上运行。</p>
<h4 data-id="heading-22">verbatim<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23verbatim" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#verbatim" target="_blank" ref="nofollow noopener noreferrer"></a></h4>
<p>一组 <code>verbatim...</code> 内置函数可以让您为Yul编译器不知道的操作码创建字节码。 它还允许您创建不会被优化器修改的字节码序列。</p>
<p>这些函数是 <code>verbatim_&lt;n&gt;i_&lt;m&gt;o("&lt;data&gt;", ...)</code>，其中</p>
<ul>
<li><code>n</code> 是一个介于0和99之间的小数，指定输入栈槽/变量的数量</li>
<li><code>m</code> 是一个介于0和99之间的小数，指定输出栈槽/变量的数量</li>
<li><code>data</code> 是一个字符串字面量，包含字节的序列</li>
</ul>
<p>例如，如果您想定义一个函数，将输入值乘以2，而不需要优化器触及常数2，您可以使用</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DbGV0IHggOj0gY2FsbGRhdGFsb2FkKDApCmxldCBkb3VibGUgOj0gdmVyYmF0aW1fMWlfMW8oaGV4IjYwMDIwMiIsIHgp" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=bGV0IHggOj0gY2FsbGRhdGFsb2FkKDApCmxldCBkb3VibGUgOj0gdmVyYmF0aW1fMWlfMW8oaGV4IjYwMDIwMiIsIHgp" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> x := calldataload(<span class="hljs-number">0</span>)
<span class="hljs-keyword">let</span> <span class="hljs-built_in">double</span> := verbatim_1i_1o(hex<span class="hljs-string">"600202"</span>, x)
</code></pre>
<p>这段代码将产生一个 <code>dup1</code> 操作码来检索 <code>x</code> （尽管优化器可能直接重新使用 <code>calldataload</code> 操作码的结果）， 后面直接是 <code>600202</code>。该代码被假定为消耗 <code>x</code> 的复制值，并在堆栈顶部产生结果。 然后编译器生成代码，为 <code>double</code> 分配一个堆栈槽，并将结果存储在那里。</p>
<p>与所有的操作码一样，参数被安排在堆栈中，最左边的参数在最上面， 而返回值则被假定是以最右边的变量在栈顶的方式排列的。</p>
<p>由于 <code>verbatim</code> 可以用来生成任意的操作码，甚至是Solidity编译器不知道的操作码， 在与优化器一起使用 <code>verbatim</code> 时，必须小心。 即使优化器被关闭，代码生成器也必须确定堆栈布局，这意味着，例如， 使用 <code>verbatim</code> 来修改堆栈高度会导致未定义行为。</p>
<p>下面是一个不完全的列表，列出了对逐字字节码的限制， 这些限制不被编译器检查。违反这些限制会导致未定义的行为。</p>
<ul>
<li>控制流不应该跳入或跳出 verbatim 块，但它可以在同一个 verbatim 块内跳入。</li>
<li>除了输入和输出参数外，堆栈内容不应该被访问。</li>
<li>堆栈的高度差应该正好是 <code>m - n</code> （输出槽减去输入槽）。</li>
<li>Verbatim字节码不能对周围的字节码做任何假设。 所有需要的参数都必须作为堆栈变量传入。</li>
</ul>
<p>优化器不分析 verbatim 字节码，总是假设它修改了状态的所有方面， 因此只能在 <code>verbatim</code> 函数调用中做很少的优化。</p>
<p>优化器将 verbatim 字节码视为一个不透明的代码块。它不会分割它， 但可能会移动、重复或与相同的 verbatim 字节码块结合。 如果一个 verbatim 的字节码块不能被控制流所触及。 它可以被删除。</p>
<p>警告</p>
<p>在讨论EVM的改进是否会破坏现有的智能合约时， <code>verbatim</code> 内部的功能不能得到与Solidity编译器本身使用的功能一样的考虑。</p>
<p>备注</p>
<p>为了避免混淆，所有以字符串 <code>verbatim</code> 开头的标识符都被保留， 不能用于用户定义的标识符。</p>
<h2 data-id="heading-23">Yul对象的规范<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23yul-object" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#yul-object" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p>Yul对象被用来分组命名代码和数据部分。 函数 <code>datasize</code>， <code>dataoffset</code> 和 <code>datacopy</code> 可以用来从代码中访问这些部分。 十六进制字符串可用于指定十六进制编码的数据， 普通字符串为本地编码。对于代码， <code>datacopy</code> 将访问其组装的二进制所表示的数据。</p>
<pre><code class="hljs language-python" lang="python">对象 = <span class="hljs-string">'object'</span> 字面量 <span class="hljs-string">'{'</span> 代码 ( 对象 | 数据 )* <span class="hljs-string">'}'</span>
代码 = <span class="hljs-string">'code'</span> 块
数据 = <span class="hljs-string">'data'</span> 字面量 ( 十六进制字面量 | 字面量 )
十六进制字面量 = <span class="hljs-string">'hex'</span> (<span class="hljs-string">'"'</span> ([<span class="hljs-number">0</span>-9a-fA-F]{<span class="hljs-number">2</span>})* <span class="hljs-string">'"'</span> | <span class="hljs-string">''' ([0-9a-fA-F]{2})* '''</span>)
字面量 = <span class="hljs-string">'"'</span> ([^<span class="hljs-string">"\r\n\] | '\' .)* '"</span><span class="hljs-string">'
</span></code></pre>
<p>对于上面的 <code>Block</code>，指的是前一章解释的Yul代码语法中的 <code>Block</code>。</p>
<p>备注</p>
<p>当一个对象的名称以 <code>_deployed</code> 结尾时，Yul 优化器将其视为部署的代码。 这样做的唯一后果是优化器中的不同燃料成本启发式算法。</p>
<p>备注</p>
<p>可以定义名称中包含 <code>.</code> 的数据对象或子对象， 但不可能通过 <code>datasize</code>， <code>dataoffset</code> 或 <code>datacopy</code> 访问它们， 因为 <code>.</code> 是作为分隔符用来访问另一个对象内的对象。</p>
<p>备注</p>
<p>被称为 <code>".metadata"</code> 的数据对象有特殊意义： 它不能从代码中访问，并且总是被附加到字节码的最末端， 无论它在对象中的位置如何。</p>
<p>其他具有特殊意义的数据对象在未来可能会被添加， 但它们的名字总是以 <code>.</code> 开头。</p>
<p>下面是一个Yul对象的例子：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3DLy8g5LiA5Liq5ZCI57qm55Sx5LiA5Liq5Y2V5LiA55qE5a%2B56LGh57uE5oiQ77yMCi8vIOWFtuWtkOWvueixoeS7o%2BihqOimgemDqOe9sueahOS7o%2BeggeaIluWug%2BWPr%2BS7peWIm%2BW7uueahOWFtuS7luWQiOe6puOAggovLyDljZXkuKog4oCc5Luj56CB4oCdIOiKgueCueaYr%2BivpeWvueixoeeahOWPr%2BaJp%2BihjOS7o%2BeggeOAggovLyDmr4%2FkuIDkuKrvvIjlhbbku5bvvInlkb3lkI3nmoTlr7nosaHmiJbmlbDmja7pg6jliIbpg73ooqvluo%2FliJfljJbvvIwKLy8g5bm26KKr54m55q6K55qE5YaF572u5Ye95pWwIGRhdGFjb3B5IC8gZGF0YW9mZnNldCAvIGRhdGFzaXplIOaJgOiuv%2BmXrgovLyDlvZPliY3lr7nosaHjgIHlrZDlr7nosaHlkozlvZPliY3lr7nosaHlhoXnmoTmlbDmja7pobnpg73lnKjojIPlm7TlhoXjgIIKb2JqZWN0ICJDb250cmFjdDEiIHsKICAgIC8vIOi%2FmeaYr%2BWQiOe6pueahOaehOmAoOWHveaVsOS7o%2BeggeOAggogICAgY29kZSB7CiAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgcHRyIDo9IG1sb2FkKDB4NDApCiAgICAgICAgICAgIC8vIOivt%2BazqOaEj%2B%2B8jFNvbGlkaXR5IOeUn%2BaIkOeahCBJUiDku6PnoIHkuZ%2Fkv53nlZnkuoblhoXlrZjlgY%2Fnp7vph48gYGAweDYwYGDvvIzkvYbkuIDkuKrnuq8gWXVsIOWvueixoeWPr%2BS7peiHqueUseWcsOS9v%2BeUqOWGheWtmOOAggogICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgbXN0b3JlKDB4NDAsIGFkZChwdHIsIHNpemUpKQogICAgICAgIH0KCiAgICAgICAgLy8g6aaW5YWI5Yib5bu6IOKAnENvbnRyYWN0MuKAnQogICAgICAgIGxldCBzaXplIDo9IGRhdGFzaXplKCJDb250cmFjdDIiKQogICAgICAgIGxldCBvZmZzZXQgOj0gYWxsb2NhdGUoc2l6ZSkKICAgICAgICAvLyDov5nlsIbovazljJbkuLpFVk3nmoTku6PnoIHmi7fotJ3jgIIKICAgICAgICBkYXRhY29weShvZmZzZXQsIGRhdGFvZmZzZXQoIkNvbnRyYWN0MiIpLCBzaXplKQogICAgICAgIC8vIOaehOmAoOWHveaVsOWPguaVsOaYr%2BS4gOS4quWNleS4gOeahOaVsOWtlyAweDEyMzQKICAgICAgICBtc3RvcmUoYWRkKG9mZnNldCwgc2l6ZSksIDB4MTIzNCkKICAgICAgICBwb3AoY3JlYXRlKDAsIG9mZnNldCwgYWRkKHNpemUsIDMyKSkpCgogICAgICAgIC8vIOeOsOWcqOi%2FlOWbnui%2FkOihjOaXtuWvueixoQogICAgICAgIC8vIOW9k%2BWJjeaJp%2BihjOeahOS7o%2BeggeaYr%2BaehOmAoOWHveaVsOS7o%2Begge%2B8ieOAggogICAgICAgIHNpemUgOj0gZGF0YXNpemUoIkNvbnRyYWN0MV9kZXBsb3llZCIpCiAgICAgICAgb2Zmc2V0IDo9IGFsbG9jYXRlKHNpemUpCiAgICAgICAgLy8g6L%2BZ5bCG5Y%2BY5oiQRVZN55qE5Luj56CB5ou36LSd44CCCiAgICAgICAgZGF0YWNvcHkob2Zmc2V0LCBkYXRhb2Zmc2V0KCJDb250cmFjdDFfZGVwbG95ZWQiKSwgc2l6ZSkKICAgICAgICByZXR1cm4ob2Zmc2V0LCBzaXplKQogICAgfQoKICAgIGRhdGEgIlRhYmxlMiIgaGV4IjQxMjMiCgogICAgb2JqZWN0ICJDb250cmFjdDFfZGVwbG95ZWQiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgICAgIHB0ciA6PSBtbG9hZCgweDQwKQogICAgICAgICAgICAgICAgLy8g6K%2B35rOo5oSP77yMU29saWRpdHkg55Sf5oiQ55qEIElSIOS7o%2BeggeS5n%2BS%2FneeVmeS6huWGheWtmOWBj%2Benu%2BmHjyBgYDB4NjBgYO%2B8jOS9huS4gOS4que6ryBZdWwg5a%2B56LGh5Y%2Bv5Lul6Ieq55Sx5Zyw5L2%2F55So5YaF5a2Y44CCCiAgICAgICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgICAgIG1zdG9yZSgweDQwLCBhZGQocHRyLCBzaXplKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8g6L%2BQ6KGM5pe25Luj56CBCgogICAgICAgICAgICBtc3RvcmUoMCwgIkhlbGxvLCBXb3JsZCEiKQogICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICB9CiAgICB9CgogICAgLy8g5bWM5YWl5a%2B56LGh44CC5L2%2F55So5oOF5Ya15piv77yM5aSW6Z2i5piv5LiA5Liq5bel5Y6C5ZCI57qm77yMCiAgICAvLyDogIwgQ29udHJhY3QyIOaYr%2BeUseW3peWOguWIm%2BW7uueahOS7o%2BeggeOAggogICAgb2JqZWN0ICJDb250cmFjdDIiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g5q2k5aSE5piv5Luj56CBIC4uLgogICAgICAgIH0KCiAgICAgICAgb2JqZWN0ICJDb250cmFjdDJfZGVwbG95ZWQiIHsKICAgICAgICAgICAgY29kZSB7CiAgICAgICAgICAgICAgICAvLyDmraTlpITmmK%2Fku6PnoIEgLi4uCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRhdGEgIlRhYmxlMSIgaGV4IjQxMjMiCiAgICB9Cn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=Ly8g5LiA5Liq5ZCI57qm55Sx5LiA5Liq5Y2V5LiA55qE5a+56LGh57uE5oiQ77yMCi8vIOWFtuWtkOWvueixoeS7o+ihqOimgemDqOe9sueahOS7o+eggeaIluWug+WPr+S7peWIm+W7uueahOWFtuS7luWQiOe6puOAggovLyDljZXkuKog4oCc5Luj56CB4oCdIOiKgueCueaYr+ivpeWvueixoeeahOWPr+aJp+ihjOS7o+eggeOAggovLyDmr4/kuIDkuKrvvIjlhbbku5bvvInlkb3lkI3nmoTlr7nosaHmiJbmlbDmja7pg6jliIbpg73ooqvluo/liJfljJbvvIwKLy8g5bm26KKr54m55q6K55qE5YaF572u5Ye95pWwIGRhdGFjb3B5IC8gZGF0YW9mZnNldCAvIGRhdGFzaXplIOaJgOiuv+mXrgovLyDlvZPliY3lr7nosaHjgIHlrZDlr7nosaHlkozlvZPliY3lr7nosaHlhoXnmoTmlbDmja7pobnpg73lnKjojIPlm7TlhoXjgIIKb2JqZWN0ICJDb250cmFjdDEiIHsKICAgIC8vIOi/meaYr+WQiOe6pueahOaehOmAoOWHveaVsOS7o+eggeOAggogICAgY29kZSB7CiAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgcHRyIDo9IG1sb2FkKDB4NDApCiAgICAgICAgICAgIC8vIOivt+azqOaEj++8jFNvbGlkaXR5IOeUn+aIkOeahCBJUiDku6PnoIHkuZ/kv53nlZnkuoblhoXlrZjlgY/np7vph48gYGAweDYwYGDvvIzkvYbkuIDkuKrnuq8gWXVsIOWvueixoeWPr+S7peiHqueUseWcsOS9v+eUqOWGheWtmOOAggogICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgbXN0b3JlKDB4NDAsIGFkZChwdHIsIHNpemUpKQogICAgICAgIH0KCiAgICAgICAgLy8g6aaW5YWI5Yib5bu6IOKAnENvbnRyYWN0MuKAnQogICAgICAgIGxldCBzaXplIDo9IGRhdGFzaXplKCJDb250cmFjdDIiKQogICAgICAgIGxldCBvZmZzZXQgOj0gYWxsb2NhdGUoc2l6ZSkKICAgICAgICAvLyDov5nlsIbovazljJbkuLpFVk3nmoTku6PnoIHmi7fotJ3jgIIKICAgICAgICBkYXRhY29weShvZmZzZXQsIGRhdGFvZmZzZXQoIkNvbnRyYWN0MiIpLCBzaXplKQogICAgICAgIC8vIOaehOmAoOWHveaVsOWPguaVsOaYr+S4gOS4quWNleS4gOeahOaVsOWtlyAweDEyMzQKICAgICAgICBtc3RvcmUoYWRkKG9mZnNldCwgc2l6ZSksIDB4MTIzNCkKICAgICAgICBwb3AoY3JlYXRlKDAsIG9mZnNldCwgYWRkKHNpemUsIDMyKSkpCgogICAgICAgIC8vIOeOsOWcqOi/lOWbnui/kOihjOaXtuWvueixoQogICAgICAgIC8vIOW9k+WJjeaJp+ihjOeahOS7o+eggeaYr+aehOmAoOWHveaVsOS7o+egge+8ieOAggogICAgICAgIHNpemUgOj0gZGF0YXNpemUoIkNvbnRyYWN0MV9kZXBsb3llZCIpCiAgICAgICAgb2Zmc2V0IDo9IGFsbG9jYXRlKHNpemUpCiAgICAgICAgLy8g6L+Z5bCG5Y+Y5oiQRVZN55qE5Luj56CB5ou36LSd44CCCiAgICAgICAgZGF0YWNvcHkob2Zmc2V0LCBkYXRhb2Zmc2V0KCJDb250cmFjdDFfZGVwbG95ZWQiKSwgc2l6ZSkKICAgICAgICByZXR1cm4ob2Zmc2V0LCBzaXplKQogICAgfQoKICAgIGRhdGEgIlRhYmxlMiIgaGV4IjQxMjMiCgogICAgb2JqZWN0ICJDb250cmFjdDFfZGVwbG95ZWQiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgZnVuY3Rpb24gYWxsb2NhdGUoc2l6ZSkgLT4gcHRyIHsKICAgICAgICAgICAgICAgIHB0ciA6PSBtbG9hZCgweDQwKQogICAgICAgICAgICAgICAgLy8g6K+35rOo5oSP77yMU29saWRpdHkg55Sf5oiQ55qEIElSIOS7o+eggeS5n+S/neeVmeS6huWGheWtmOWBj+enu+mHjyBgYDB4NjBgYO+8jOS9huS4gOS4que6ryBZdWwg5a+56LGh5Y+v5Lul6Ieq55Sx5Zyw5L2/55So5YaF5a2Y44CCCiAgICAgICAgICAgICAgICBpZiBpc3plcm8ocHRyKSB7IHB0ciA6PSAweDYwIH0KICAgICAgICAgICAgICAgIG1zdG9yZSgweDQwLCBhZGQocHRyLCBzaXplKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8g6L+Q6KGM5pe25Luj56CBCgogICAgICAgICAgICBtc3RvcmUoMCwgIkhlbGxvLCBXb3JsZCEiKQogICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICB9CiAgICB9CgogICAgLy8g5bWM5YWl5a+56LGh44CC5L2/55So5oOF5Ya15piv77yM5aSW6Z2i5piv5LiA5Liq5bel5Y6C5ZCI57qm77yMCiAgICAvLyDogIwgQ29udHJhY3QyIOaYr+eUseW3peWOguWIm+W7uueahOS7o+eggeOAggogICAgb2JqZWN0ICJDb250cmFjdDIiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g5q2k5aSE5piv5Luj56CBIC4uLgogICAgICAgIH0KCiAgICAgICAgb2JqZWN0ICJDb250cmFjdDJfZGVwbG95ZWQiIHsKICAgICAgICAgICAgY29kZSB7CiAgICAgICAgICAgICAgICAvLyDmraTlpITmmK/ku6PnoIEgLi4uCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRhdGEgIlRhYmxlMSIgaGV4IjQxMjMiCiAgICB9Cn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 一个合约由一个单一的对象组成，</span>
<span class="hljs-comment">// 其子对象代表要部署的代码或它可以创建的其他合约。</span>
<span class="hljs-comment">// 单个 “代码” 节点是该对象的可执行代码。</span>
<span class="hljs-comment">// 每一个（其他）命名的对象或数据部分都被序列化，</span>
<span class="hljs-comment">// 并被特殊的内置函数 datacopy / dataoffset / datasize 所访问</span>
<span class="hljs-comment">// 当前对象、子对象和当前对象内的数据项都在范围内。</span>
<span class="hljs-built_in">object</span> <span class="hljs-string">"Contract1"</span> {
    <span class="hljs-comment">// 这是合约的构造函数代码。</span>
    code {
        <span class="hljs-function">function <span class="hljs-title">allocate</span>(<span class="hljs-params">size</span>) -&gt; ptr</span> {
            ptr := mload(<span class="hljs-number">0x40</span>)
            <span class="hljs-comment">// 请注意，Solidity 生成的 IR 代码也保留了内存偏移量 ``0x60``，但一个纯 Yul 对象可以自由地使用内存。</span>
            <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">iszero</span>(<span class="hljs-params">ptr</span>)</span> { ptr := <span class="hljs-number">0x60</span> }
            mstore(<span class="hljs-number">0x40</span>, <span class="hljs-keyword">add</span>(ptr, size))
        }

        <span class="hljs-comment">// 首先创建 “Contract2”</span>
        <span class="hljs-keyword">let</span> size := datasize(<span class="hljs-string">"Contract2"</span>)
        <span class="hljs-keyword">let</span> offset := allocate(size)
        <span class="hljs-comment">// 这将转化为EVM的代码拷贝。</span>
        datacopy(offset, dataoffset(<span class="hljs-string">"Contract2"</span>), size)
        <span class="hljs-comment">// 构造函数参数是一个单一的数字 0x1234</span>
        mstore(<span class="hljs-keyword">add</span>(offset, size), <span class="hljs-number">0x1234</span>)
        pop(create(<span class="hljs-number">0</span>, offset, <span class="hljs-keyword">add</span>(size, <span class="hljs-number">32</span>)))

        <span class="hljs-comment">// 现在返回运行时对象</span>
        <span class="hljs-comment">// 当前执行的代码是构造函数代码）。</span>
        size := datasize(<span class="hljs-string">"Contract1_deployed"</span>)
        offset := allocate(size)
        <span class="hljs-comment">// 这将变成EVM的代码拷贝。</span>
        datacopy(offset, dataoffset(<span class="hljs-string">"Contract1_deployed"</span>), size)
        <span class="hljs-keyword">return</span>(offset, size)
    }

    data <span class="hljs-string">"Table2"</span> hex<span class="hljs-string">"4123"</span>

    <span class="hljs-built_in">object</span> <span class="hljs-string">"Contract1_deployed"</span> {
        code {
            <span class="hljs-function">function <span class="hljs-title">allocate</span>(<span class="hljs-params">size</span>) -&gt; ptr</span> {
                ptr := mload(<span class="hljs-number">0x40</span>)
                <span class="hljs-comment">// 请注意，Solidity 生成的 IR 代码也保留了内存偏移量 ``0x60``，但一个纯 Yul 对象可以自由地使用内存。</span>
                <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">iszero</span>(<span class="hljs-params">ptr</span>)</span> { ptr := <span class="hljs-number">0x60</span> }
                mstore(<span class="hljs-number">0x40</span>, <span class="hljs-keyword">add</span>(ptr, size))
            }

            <span class="hljs-comment">// 运行时代码</span>

            mstore(<span class="hljs-number">0</span>, <span class="hljs-string">"Hello, World!"</span>)
            <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>)
        }
    }

    <span class="hljs-comment">// 嵌入对象。使用情况是，外面是一个工厂合约，</span>
    <span class="hljs-comment">// 而 Contract2 是由工厂创建的代码。</span>
    <span class="hljs-built_in">object</span> <span class="hljs-string">"Contract2"</span> {
        code {
            <span class="hljs-comment">// 此处是代码 ...</span>
        }

        <span class="hljs-built_in">object</span> <span class="hljs-string">"Contract2_deployed"</span> {
            code {
                <span class="hljs-comment">// 此处是代码 ...</span>
            }
        }

        data <span class="hljs-string">"Table1"</span> hex<span class="hljs-string">"4123"</span>
    }
}
</code></pre>
<h2 data-id="heading-24">Yul 优化器<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23id18" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#id18" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p>Yul优化器对Yul代码进行操作，并对输入、输出和中间状态使用相同的语言。这使得优化器的调试和验证变得容易。</p>
<p>请参考一般的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Finternals%2Foptimizer.html%23optimizer" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/internals/optimizer.html#optimizer" ref="nofollow noopener noreferrer">优化器文档</a>，以了解关于不同优化阶段和如何使用优化器的更多细节。</p>
<p>如果您想在独立的Yul模式下使用Solidity，您可以用 <code>--optimize</code> 激活优化器， 并可选择用 <code>--optimize-runs</code> 指定 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Finternals%2Foptimizer.html%23optimizer-parameter-runs" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/internals/optimizer.html#optimizer-parameter-runs" ref="nofollow noopener noreferrer">预期合约执行次数</a>：</p>
<pre><code class="hljs language-css" lang="css">solc <span class="hljs-attr">--strict-assembly</span> <span class="hljs-attr">--optimize</span> <span class="hljs-attr">--optimize-runs</span> <span class="hljs-number">200</span>
</code></pre>
<p>在Solidity模式下，Yul优化器与常规优化器一起被激活。</p>
<h3 data-id="heading-25">优化步骤顺序<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23optimization-step-sequence" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#optimization-step-sequence" target="_blank" ref="nofollow noopener noreferrer"></a></h3>
<p>有关优化顺序的详细信息以及缩写列表可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Finternals%2Foptimizer.html%23optimizer-steps" target="_blank" title="https://docs.soliditylang.org/zh-cn/latest/internals/optimizer.html#optimizer-steps" ref="nofollow noopener noreferrer">优化器文档</a> 中找到。</p>
<h2 data-id="heading-26">完整的ERC20示例（基于yul）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fzh-cn%2Flatest%2Fyul.html%23erc20-yul" title="https://docs.soliditylang.org/zh-cn/latest/yul.html#erc20-yul" target="_blank" ref="nofollow noopener noreferrer"></a></h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23language%3Dyul%26version%3D0.8.24%26code%3Db2JqZWN0ICJUb2tlbiIgewogICAgY29kZSB7CiAgICAgICAgLy8g5bCG5Yib5bu66ICF5a2Y5YKo5Zyo6Zu25Y%2B35qe95Lit44CCCiAgICAgICAgc3N0b3JlKDAsIGNhbGxlcigpKQoKICAgICAgICAvLyDpg6jnvbLlkIjnuqYKICAgICAgICBkYXRhY29weSgwLCBkYXRhb2Zmc2V0KCJydW50aW1lIiksIGRhdGFzaXplKCJydW50aW1lIikpCiAgICAgICAgcmV0dXJuKDAsIGRhdGFzaXplKCJydW50aW1lIikpCiAgICB9CiAgICBvYmplY3QgInJ1bnRpbWUiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g6Ziy5q2i5Y%2BR6YCB5Lul5aSq55qE5L%2Bd5oqk5o6q5pa9CiAgICAgICAgICAgIHJlcXVpcmUoaXN6ZXJvKGNhbGx2YWx1ZSgpKSkKCiAgICAgICAgICAgIC8vIOiwg%2BW6puWZqAogICAgICAgICAgICBzd2l0Y2ggc2VsZWN0b3IoKQogICAgICAgICAgICBjYXNlIDB4NzBhMDgyMzEgLyogImJhbGFuY2VPZihhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChiYWxhbmNlT2YoZGVjb2RlQXNBZGRyZXNzKDApKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4MTgxNjBkZGQgLyogInRvdGFsU3VwcGx5KCkiICovIHsKICAgICAgICAgICAgICAgIHJldHVyblVpbnQodG90YWxTdXBwbHkoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4YTkwNTljYmIgLyogInRyYW5zZmVyKGFkZHJlc3MsdWludDI1NikiICovIHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweDIzYjg3MmRkIC8qICJ0cmFuc2ZlckZyb20oYWRkcmVzcyxhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICB0cmFuc2ZlckZyb20oZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSksIGRlY29kZUFzVWludCgyKSkKICAgICAgICAgICAgICAgIHJldHVyblRydWUoKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHgwOTVlYTdiMyAvKiAiYXBwcm92ZShhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBhcHByb3ZlKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweGRkNjJlZDNlIC8qICJhbGxvd2FuY2UoYWRkcmVzcyxhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChhbGxvd2FuY2UoZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSkpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHg0MGMxMGYxOSAvKiAibWludChhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBtaW50KGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdCB7CiAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gbWludChhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoY2FsbGVkQnlPd25lcigpKQoKICAgICAgICAgICAgICAgIG1pbnRUb2tlbnMoYW1vdW50KQogICAgICAgICAgICAgICAgYWRkVG9CYWxhbmNlKGFjY291bnQsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2ZlcigwLCBhY2NvdW50LCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXIodG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgZXhlY3V0ZVRyYW5zZmVyKGNhbGxlcigpLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFwcHJvdmUoc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICByZXZlcnRJZlplcm9BZGRyZXNzKHNwZW5kZXIpCiAgICAgICAgICAgICAgICBzZXRBbGxvd2FuY2UoY2FsbGVyKCksIHNwZW5kZXIsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRBcHByb3ZhbChjYWxsZXIoKSwgc3BlbmRlciwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShmcm9tLCB0bywgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBkZWNyZWFzZUFsbG93YW5jZUJ5KGZyb20sIGNhbGxlcigpLCBhbW91bnQpCiAgICAgICAgICAgICAgICBleGVjdXRlVHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJldmVydElmWmVyb0FkZHJlc3ModG8pCiAgICAgICAgICAgICAgICBkZWR1Y3RGcm9tQmFsYW5jZShmcm9tLCBhbW91bnQpCiAgICAgICAgICAgICAgICBhZGRUb0JhbGFuY2UodG8sIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2Zlcihmcm9tLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSBjYWxsZGF0YSDop6PnoIHlh73mlbAgLS0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gc2VsZWN0b3IoKSAtPiBzIHsKICAgICAgICAgICAgICAgIHMgOj0gZGl2KGNhbGxkYXRhbG9hZCgwKSwgMHgxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzQWRkcmVzcyhvZmZzZXQpIC0%2BIHYgewogICAgICAgICAgICAgICAgdiA6PSBkZWNvZGVBc1VpbnQob2Zmc2V0KQogICAgICAgICAgICAgICAgaWYgaXN6ZXJvKGlzemVybyhhbmQodiwgbm90KDB4ZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZikpKSkgewogICAgICAgICAgICAgICAgICAgIHJldmVydCgwLCAwKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzVWludChvZmZzZXQpIC0%2BIHYgewogICAgICAgICAgICAgICAgbGV0IHBvcyA6PSBhZGQoNCwgbXVsKG9mZnNldCwgMHgyMCkpCiAgICAgICAgICAgICAgICBpZiBsdChjYWxsZGF0YXNpemUoKSwgYWRkKHBvcywgMHgyMCkpIHsKICAgICAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHYgOj0gY2FsbGRhdGFsb2FkKHBvcykKICAgICAgICAgICAgfQogICAgICAgICAgICAvKiAtLS0tLS0tLS0tIGNhbGxkYXRhIOe8lueggeWHveaVsCAtLS0tLS0tLS0tICovCiAgICAgICAgICAgIGZ1bmN0aW9uIHJldHVyblVpbnQodikgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIHYpCiAgICAgICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuVWludCgxKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvKiAtLS0tLS0tLSDkuovku7YgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBlbWl0VHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IHNpZ25hdHVyZUhhc2ggOj0gMHhkZGYyNTJhZDFiZTJjODliNjljMmIwNjhmYzM3OGRhYTk1MmJhN2YxNjNjNGExMTYyOGY1NWE0ZGY1MjNiM2VmCiAgICAgICAgICAgICAgICBlbWl0RXZlbnQoc2lnbmF0dXJlSGFzaCwgZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBlbWl0QXBwcm92YWwoZnJvbSwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgc2lnbmF0dXJlSGFzaCA6PSAweDhjNWJlMWU1ZWJlYzdkNWJkMTRmNzE0MjdkMWU4NGYzZGQwMzE0YzBmN2IyMjkxZTViMjAwYWM4YzdjM2I5MjUKICAgICAgICAgICAgICAgIGVtaXRFdmVudChzaWduYXR1cmVIYXNoLCBmcm9tLCBzcGVuZGVyLCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gZW1pdEV2ZW50KHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMiwgbm9uSW5kZXhlZCkgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIG5vbkluZGV4ZWQpCiAgICAgICAgICAgICAgICBsb2czKDAsIDB4MjAsIHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMikKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo5biD5bGAIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXJQb3MoKSAtPiBwIHsgcCA6PSAwIH0KICAgICAgICAgICAgZnVuY3Rpb24gdG90YWxTdXBwbHlQb3MoKSAtPiBwIHsgcCA6PSAxIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFkZCgweDEwMDAsIGFjY291bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFjY291bnRUb1N0b3JhZ2VPZmZzZXQoYWNjb3VudCkKICAgICAgICAgICAgICAgIG1zdG9yZSgwLCBvZmZzZXQpCiAgICAgICAgICAgICAgICBtc3RvcmUoMHgyMCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIG9mZnNldCA6PSBrZWNjYWsyNTYoMCwgMHg0MCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo6K6%2F6ZeuIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXIoKSAtPiBvIHsKICAgICAgICAgICAgICAgIG8gOj0gc2xvYWQob3duZXJQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIC0%2BIHN1cHBseSB7CiAgICAgICAgICAgICAgICBzdXBwbHkgOj0gc2xvYWQodG90YWxTdXBwbHlQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBtaW50VG9rZW5zKGFtb3VudCkgewogICAgICAgICAgICAgICAgc3N0b3JlKHRvdGFsU3VwcGx5UG9zKCksIHNhZmVBZGQodG90YWxTdXBwbHkoKSwgYW1vdW50KSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWNjb3VudCkgLT4gYmFsIHsKICAgICAgICAgICAgICAgIGJhbCA6PSBzbG9hZChhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZFRvQmFsYW5jZShhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgOj0gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KQogICAgICAgICAgICAgICAgc3N0b3JlKG9mZnNldCwgc2FmZUFkZChzbG9hZChvZmZzZXQpLCBhbW91bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlZHVjdEZyb21CYWxhbmNlKGFjY291bnQsIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IG9mZnNldCA6PSBhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpCiAgICAgICAgICAgICAgICBsZXQgYmFsIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgYmFsKSkKICAgICAgICAgICAgICAgIHNzdG9yZShvZmZzZXQsIHN1YihiYWwsIGFtb3VudCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlKGFjY291bnQsIHNwZW5kZXIpIC0%2BIGFtb3VudCB7CiAgICAgICAgICAgICAgICBhbW91bnQgOj0gc2xvYWQoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzZXRBbGxvd2FuY2UoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBzc3RvcmUoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY3JlYXNlQWxsb3dhbmNlQnkoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgb2Zmc2V0IDo9IGFsbG93YW5jZVN0b3JhZ2VPZmZzZXQoYWNjb3VudCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50QWxsb3dhbmNlIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgY3VycmVudEFsbG93YW5jZSkpCiAgICAgICAgICAgICAgICBzc3RvcmUob2Zmc2V0LCBzdWIoY3VycmVudEFsbG93YW5jZSwgYW1vdW50KSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSDlt6Xlhbflh73mlbAgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBsdGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhndChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBndGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhsdChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzYWZlQWRkKGEsIGIpIC0%2BIHIgewogICAgICAgICAgICAgICAgciA6PSBhZGQoYSwgYikKICAgICAgICAgICAgICAgIGlmIG9yKGx0KHIsIGEpLCBsdChyLCBiKSkgeyByZXZlcnQoMCwgMCkgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxlZEJ5T3duZXIoKSAtPiBjYm8gewogICAgICAgICAgICAgICAgY2JvIDo9IGVxKG93bmVyKCksIGNhbGxlcigpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVydElmWmVyb0FkZHJlc3MoYWRkcikgewogICAgICAgICAgICAgICAgcmVxdWlyZShhZGRyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlcXVpcmUoY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICBpZiBpc3plcm8oY29uZGl0aW9uKSB7IHJldmVydCgwLCAwKSB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0%3D" target="_blank" title="https://remix.ethereum.org/?#language=yul&amp;version=0.8.24&amp;code=b2JqZWN0ICJUb2tlbiIgewogICAgY29kZSB7CiAgICAgICAgLy8g5bCG5Yib5bu66ICF5a2Y5YKo5Zyo6Zu25Y+35qe95Lit44CCCiAgICAgICAgc3N0b3JlKDAsIGNhbGxlcigpKQoKICAgICAgICAvLyDpg6jnvbLlkIjnuqYKICAgICAgICBkYXRhY29weSgwLCBkYXRhb2Zmc2V0KCJydW50aW1lIiksIGRhdGFzaXplKCJydW50aW1lIikpCiAgICAgICAgcmV0dXJuKDAsIGRhdGFzaXplKCJydW50aW1lIikpCiAgICB9CiAgICBvYmplY3QgInJ1bnRpbWUiIHsKICAgICAgICBjb2RlIHsKICAgICAgICAgICAgLy8g6Ziy5q2i5Y+R6YCB5Lul5aSq55qE5L+d5oqk5o6q5pa9CiAgICAgICAgICAgIHJlcXVpcmUoaXN6ZXJvKGNhbGx2YWx1ZSgpKSkKCiAgICAgICAgICAgIC8vIOiwg+W6puWZqAogICAgICAgICAgICBzd2l0Y2ggc2VsZWN0b3IoKQogICAgICAgICAgICBjYXNlIDB4NzBhMDgyMzEgLyogImJhbGFuY2VPZihhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChiYWxhbmNlT2YoZGVjb2RlQXNBZGRyZXNzKDApKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4MTgxNjBkZGQgLyogInRvdGFsU3VwcGx5KCkiICovIHsKICAgICAgICAgICAgICAgIHJldHVyblVpbnQodG90YWxTdXBwbHkoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDB4YTkwNTljYmIgLyogInRyYW5zZmVyKGFkZHJlc3MsdWludDI1NikiICovIHsKICAgICAgICAgICAgICAgIHRyYW5zZmVyKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweDIzYjg3MmRkIC8qICJ0cmFuc2ZlckZyb20oYWRkcmVzcyxhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICB0cmFuc2ZlckZyb20oZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSksIGRlY29kZUFzVWludCgyKSkKICAgICAgICAgICAgICAgIHJldHVyblRydWUoKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHgwOTVlYTdiMyAvKiAiYXBwcm92ZShhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBhcHByb3ZlKGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAweGRkNjJlZDNlIC8qICJhbGxvd2FuY2UoYWRkcmVzcyxhZGRyZXNzKSIgKi8gewogICAgICAgICAgICAgICAgcmV0dXJuVWludChhbGxvd2FuY2UoZGVjb2RlQXNBZGRyZXNzKDApLCBkZWNvZGVBc0FkZHJlc3MoMSkpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMHg0MGMxMGYxOSAvKiAibWludChhZGRyZXNzLHVpbnQyNTYpIiAqLyB7CiAgICAgICAgICAgICAgICBtaW50KGRlY29kZUFzQWRkcmVzcygwKSwgZGVjb2RlQXNVaW50KDEpKQogICAgICAgICAgICAgICAgcmV0dXJuVHJ1ZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdCB7CiAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gbWludChhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJlcXVpcmUoY2FsbGVkQnlPd25lcigpKQoKICAgICAgICAgICAgICAgIG1pbnRUb2tlbnMoYW1vdW50KQogICAgICAgICAgICAgICAgYWRkVG9CYWxhbmNlKGFjY291bnQsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2ZlcigwLCBhY2NvdW50LCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXIodG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgZXhlY3V0ZVRyYW5zZmVyKGNhbGxlcigpLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFwcHJvdmUoc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICByZXZlcnRJZlplcm9BZGRyZXNzKHNwZW5kZXIpCiAgICAgICAgICAgICAgICBzZXRBbGxvd2FuY2UoY2FsbGVyKCksIHNwZW5kZXIsIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRBcHByb3ZhbChjYWxsZXIoKSwgc3BlbmRlciwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShmcm9tLCB0bywgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBkZWNyZWFzZUFsbG93YW5jZUJ5KGZyb20sIGNhbGxlcigpLCBhbW91bnQpCiAgICAgICAgICAgICAgICBleGVjdXRlVHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIHJldmVydElmWmVyb0FkZHJlc3ModG8pCiAgICAgICAgICAgICAgICBkZWR1Y3RGcm9tQmFsYW5jZShmcm9tLCBhbW91bnQpCiAgICAgICAgICAgICAgICBhZGRUb0JhbGFuY2UodG8sIGFtb3VudCkKICAgICAgICAgICAgICAgIGVtaXRUcmFuc2Zlcihmcm9tLCB0bywgYW1vdW50KQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSBjYWxsZGF0YSDop6PnoIHlh73mlbAgLS0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gc2VsZWN0b3IoKSAtPiBzIHsKICAgICAgICAgICAgICAgIHMgOj0gZGl2KGNhbGxkYXRhbG9hZCgwKSwgMHgxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzQWRkcmVzcyhvZmZzZXQpIC0+IHYgewogICAgICAgICAgICAgICAgdiA6PSBkZWNvZGVBc1VpbnQob2Zmc2V0KQogICAgICAgICAgICAgICAgaWYgaXN6ZXJvKGlzemVybyhhbmQodiwgbm90KDB4ZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZikpKSkgewogICAgICAgICAgICAgICAgICAgIHJldmVydCgwLCAwKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZUFzVWludChvZmZzZXQpIC0+IHYgewogICAgICAgICAgICAgICAgbGV0IHBvcyA6PSBhZGQoNCwgbXVsKG9mZnNldCwgMHgyMCkpCiAgICAgICAgICAgICAgICBpZiBsdChjYWxsZGF0YXNpemUoKSwgYWRkKHBvcywgMHgyMCkpIHsKICAgICAgICAgICAgICAgICAgICByZXZlcnQoMCwgMCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHYgOj0gY2FsbGRhdGFsb2FkKHBvcykKICAgICAgICAgICAgfQogICAgICAgICAgICAvKiAtLS0tLS0tLS0tIGNhbGxkYXRhIOe8lueggeWHveaVsCAtLS0tLS0tLS0tICovCiAgICAgICAgICAgIGZ1bmN0aW9uIHJldHVyblVpbnQodikgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIHYpCiAgICAgICAgICAgICAgICByZXR1cm4oMCwgMHgyMCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuVWludCgxKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvKiAtLS0tLS0tLSDkuovku7YgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBlbWl0VHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IHNpZ25hdHVyZUhhc2ggOj0gMHhkZGYyNTJhZDFiZTJjODliNjljMmIwNjhmYzM3OGRhYTk1MmJhN2YxNjNjNGExMTYyOGY1NWE0ZGY1MjNiM2VmCiAgICAgICAgICAgICAgICBlbWl0RXZlbnQoc2lnbmF0dXJlSGFzaCwgZnJvbSwgdG8sIGFtb3VudCkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBlbWl0QXBwcm92YWwoZnJvbSwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgc2lnbmF0dXJlSGFzaCA6PSAweDhjNWJlMWU1ZWJlYzdkNWJkMTRmNzE0MjdkMWU4NGYzZGQwMzE0YzBmN2IyMjkxZTViMjAwYWM4YzdjM2I5MjUKICAgICAgICAgICAgICAgIGVtaXRFdmVudChzaWduYXR1cmVIYXNoLCBmcm9tLCBzcGVuZGVyLCBhbW91bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gZW1pdEV2ZW50KHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMiwgbm9uSW5kZXhlZCkgewogICAgICAgICAgICAgICAgbXN0b3JlKDAsIG5vbkluZGV4ZWQpCiAgICAgICAgICAgICAgICBsb2czKDAsIDB4MjAsIHNpZ25hdHVyZUhhc2gsIGluZGV4ZWQxLCBpbmRleGVkMikKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo5biD5bGAIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXJQb3MoKSAtPiBwIHsgcCA6PSAwIH0KICAgICAgICAgICAgZnVuY3Rpb24gdG90YWxTdXBwbHlQb3MoKSAtPiBwIHsgcCA6PSAxIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFkZCgweDEwMDAsIGFjY291bnQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSAtPiBvZmZzZXQgewogICAgICAgICAgICAgICAgb2Zmc2V0IDo9IGFjY291bnRUb1N0b3JhZ2VPZmZzZXQoYWNjb3VudCkKICAgICAgICAgICAgICAgIG1zdG9yZSgwLCBvZmZzZXQpCiAgICAgICAgICAgICAgICBtc3RvcmUoMHgyMCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIG9mZnNldCA6PSBrZWNjYWsyNTYoMCwgMHg0MCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0g5a2Y5YKo6K6/6ZeuIC0tLS0tLS0tLS0gKi8KICAgICAgICAgICAgZnVuY3Rpb24gb3duZXIoKSAtPiBvIHsKICAgICAgICAgICAgICAgIG8gOj0gc2xvYWQob3duZXJQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB0b3RhbFN1cHBseSgpIC0+IHN1cHBseSB7CiAgICAgICAgICAgICAgICBzdXBwbHkgOj0gc2xvYWQodG90YWxTdXBwbHlQb3MoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBtaW50VG9rZW5zKGFtb3VudCkgewogICAgICAgICAgICAgICAgc3N0b3JlKHRvdGFsU3VwcGx5UG9zKCksIHNhZmVBZGQodG90YWxTdXBwbHkoKSwgYW1vdW50KSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWNjb3VudCkgLT4gYmFsIHsKICAgICAgICAgICAgICAgIGJhbCA6PSBzbG9hZChhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZFRvQmFsYW5jZShhY2NvdW50LCBhbW91bnQpIHsKICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgOj0gYWNjb3VudFRvU3RvcmFnZU9mZnNldChhY2NvdW50KQogICAgICAgICAgICAgICAgc3N0b3JlKG9mZnNldCwgc2FmZUFkZChzbG9hZChvZmZzZXQpLCBhbW91bnQpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlZHVjdEZyb21CYWxhbmNlKGFjY291bnQsIGFtb3VudCkgewogICAgICAgICAgICAgICAgbGV0IG9mZnNldCA6PSBhY2NvdW50VG9TdG9yYWdlT2Zmc2V0KGFjY291bnQpCiAgICAgICAgICAgICAgICBsZXQgYmFsIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgYmFsKSkKICAgICAgICAgICAgICAgIHNzdG9yZShvZmZzZXQsIHN1YihiYWwsIGFtb3VudCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYWxsb3dhbmNlKGFjY291bnQsIHNwZW5kZXIpIC0+IGFtb3VudCB7CiAgICAgICAgICAgICAgICBhbW91bnQgOj0gc2xvYWQoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzZXRBbGxvd2FuY2UoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBzc3RvcmUoYWxsb3dhbmNlU3RvcmFnZU9mZnNldChhY2NvdW50LCBzcGVuZGVyKSwgYW1vdW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY3JlYXNlQWxsb3dhbmNlQnkoYWNjb3VudCwgc3BlbmRlciwgYW1vdW50KSB7CiAgICAgICAgICAgICAgICBsZXQgb2Zmc2V0IDo9IGFsbG93YW5jZVN0b3JhZ2VPZmZzZXQoYWNjb3VudCwgc3BlbmRlcikKICAgICAgICAgICAgICAgIGxldCBjdXJyZW50QWxsb3dhbmNlIDo9IHNsb2FkKG9mZnNldCkKICAgICAgICAgICAgICAgIHJlcXVpcmUobHRlKGFtb3VudCwgY3VycmVudEFsbG93YW5jZSkpCiAgICAgICAgICAgICAgICBzc3RvcmUob2Zmc2V0LCBzdWIoY3VycmVudEFsbG93YW5jZSwgYW1vdW50KSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogLS0tLS0tLS0tLSDlt6Xlhbflh73mlbAgLS0tLS0tLS0tLSAqLwogICAgICAgICAgICBmdW5jdGlvbiBsdGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhndChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBndGUoYSwgYikgLT4gciB7CiAgICAgICAgICAgICAgICByIDo9IGlzemVybyhsdChhLCBiKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBzYWZlQWRkKGEsIGIpIC0+IHIgewogICAgICAgICAgICAgICAgciA6PSBhZGQoYSwgYikKICAgICAgICAgICAgICAgIGlmIG9yKGx0KHIsIGEpLCBsdChyLCBiKSkgeyByZXZlcnQoMCwgMCkgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGxlZEJ5T3duZXIoKSAtPiBjYm8gewogICAgICAgICAgICAgICAgY2JvIDo9IGVxKG93bmVyKCksIGNhbGxlcigpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVydElmWmVyb0FkZHJlc3MoYWRkcikgewogICAgICAgICAgICAgICAgcmVxdWlyZShhZGRyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlcXVpcmUoY29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICBpZiBpc3plcm8oY29uZGl0aW9uKSB7IHJldmVydCgwLCAwKSB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0=" ref="nofollow noopener noreferrer">open in Remix</a></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">object</span> "Token" {
    <span class="hljs-selector-tag">code</span> {
        <span class="hljs-comment">// 将创建者存储在零号槽中。</span>
        <span class="hljs-built_in">sstore</span>(<span class="hljs-number">0</span>, caller())

        <span class="hljs-comment">// 部署合约</span>
        <span class="hljs-built_in">datacopy</span>(<span class="hljs-number">0</span>, dataoffset("runtime"), <span class="hljs-built_in">datasize</span>("runtime"))
        <span class="hljs-built_in">return</span>(<span class="hljs-number">0</span>, datasize("runtime"))
    }
    <span class="hljs-selector-tag">object</span> "runtime" {
        <span class="hljs-selector-tag">code</span> {
            <span class="hljs-comment">// 防止发送以太的保护措施</span>
            <span class="hljs-built_in">require</span>(iszero(callvalue()))

            <span class="hljs-comment">// 调度器</span>
            switch <span class="hljs-built_in">selector</span>()
            case <span class="hljs-number">0</span>x70a08231 <span class="hljs-comment">/* "balanceOf(address)" */</span> {
                <span class="hljs-built_in">returnUint</span>(balanceOf(decodeAsAddress(<span class="hljs-number">0</span>)))
            }
            case <span class="hljs-number">0</span>x18160ddd <span class="hljs-comment">/* "totalSupply()" */</span> {
                <span class="hljs-built_in">returnUint</span>(totalSupply())
            }
            case <span class="hljs-number">0</span>xa9059cbb <span class="hljs-comment">/* "transfer(address,uint256)" */</span> {
                <span class="hljs-built_in">transfer</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">1</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            case <span class="hljs-number">0</span>x23b872dd <span class="hljs-comment">/* "transferFrom(address,address,uint256)" */</span> {
                <span class="hljs-built_in">transferFrom</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsAddress</span>(<span class="hljs-number">1</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">2</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            case <span class="hljs-number">0</span>x095ea7b3 <span class="hljs-comment">/* "approve(address,uint256)" */</span> {
                <span class="hljs-built_in">approve</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">1</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            case <span class="hljs-number">0</span>xdd62ed3e <span class="hljs-comment">/* "allowance(address,address)" */</span> {
                <span class="hljs-built_in">returnUint</span>(allowance(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsAddress</span>(<span class="hljs-number">1</span>)))
            }
            case <span class="hljs-number">0</span>x40c10f19 <span class="hljs-comment">/* "mint(address,uint256)" */</span> {
                <span class="hljs-built_in">mint</span>(decodeAsAddress(<span class="hljs-number">0</span>), <span class="hljs-built_in">decodeAsUint</span>(<span class="hljs-number">1</span>))
                <span class="hljs-built_in">returnTrue</span>()
            }
            default {
                <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
            }

            function <span class="hljs-built_in">mint</span>(account, amount) {
                <span class="hljs-built_in">require</span>(calledByOwner())

                <span class="hljs-built_in">mintTokens</span>(amount)
                <span class="hljs-built_in">addToBalance</span>(account, amount)
                <span class="hljs-built_in">emitTransfer</span>(<span class="hljs-number">0</span>, account, amount)
            }
            function <span class="hljs-built_in">transfer</span>(to, amount) {
                <span class="hljs-built_in">executeTransfer</span>(caller(), to, amount)
            }
            function <span class="hljs-built_in">approve</span>(spender, amount) {
                <span class="hljs-built_in">revertIfZeroAddress</span>(spender)
                <span class="hljs-built_in">setAllowance</span>(caller(), spender, amount)
                <span class="hljs-built_in">emitApproval</span>(caller(), spender, amount)
            }
            function <span class="hljs-built_in">transferFrom</span>(from, to, amount) {
                <span class="hljs-built_in">decreaseAllowanceBy</span>(from, caller(), amount)
                <span class="hljs-built_in">executeTransfer</span>(from, to, amount)
            }

            function <span class="hljs-built_in">executeTransfer</span>(from, to, amount) {
                <span class="hljs-built_in">revertIfZeroAddress</span>(to)
                <span class="hljs-built_in">deductFromBalance</span>(from, amount)
                <span class="hljs-built_in">addToBalance</span>(to, amount)
                <span class="hljs-built_in">emitTransfer</span>(from, to, amount)
            }


            <span class="hljs-comment">/* ---------- calldata 解码函数 ----------- */</span>
            function <span class="hljs-built_in">selector</span>() -&gt; s {
                s := <span class="hljs-built_in">div</span>(<span class="hljs-built_in">calldataload</span>(<span class="hljs-number">0</span>), <span class="hljs-number">0</span>x100000000000000000000000000000000000000000000000000000000)
            }

            function <span class="hljs-built_in">decodeAsAddress</span>(offset) -&gt; v {
                v := <span class="hljs-built_in">decodeAsUint</span>(offset)
                if <span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">and</span>(v, <span class="hljs-built_in">not</span>(<span class="hljs-number">0</span>xffffffffffffffffffffffffffffffffffffffff)))) {
                    <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
                }
            }
            function <span class="hljs-built_in">decodeAsUint</span>(offset) -&gt; v {
                let pos := <span class="hljs-built_in">add</span>(<span class="hljs-number">4</span>, <span class="hljs-built_in">mul</span>(offset, <span class="hljs-number">0</span>x20))
                if <span class="hljs-built_in">lt</span>(<span class="hljs-built_in">calldatasize</span>(), <span class="hljs-built_in">add</span>(pos, <span class="hljs-number">0</span>x20)) {
                    <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
                }
                v := <span class="hljs-built_in">calldataload</span>(pos)
            }
            <span class="hljs-comment">/* ---------- calldata 编码函数 ---------- */</span>
            function <span class="hljs-built_in">returnUint</span>(v) {
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>, v)
                <span class="hljs-built_in">return</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>x20)
            }
            function <span class="hljs-built_in">returnTrue</span>() {
                <span class="hljs-built_in">returnUint</span>(<span class="hljs-number">1</span>)
            }

            <span class="hljs-comment">/* -------- 事件 ---------- */</span>
            function <span class="hljs-built_in">emitTransfer</span>(from, to, amount) {
                let signatureHash := <span class="hljs-number">0</span>xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef
                <span class="hljs-built_in">emitEvent</span>(signatureHash, from, to, amount)
            }
            function <span class="hljs-built_in">emitApproval</span>(from, spender, amount) {
                let signatureHash := <span class="hljs-number">0</span>x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925
                <span class="hljs-built_in">emitEvent</span>(signatureHash, from, spender, amount)
            }
            function <span class="hljs-built_in">emitEvent</span>(signatureHash, indexed1, indexed2, nonIndexed) {
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>, nonIndexed)
                <span class="hljs-built_in">log3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>x20, signatureHash, indexed1, indexed2)
            }

            <span class="hljs-comment">/* -------- 存储布局 ---------- */</span>
            function <span class="hljs-built_in">ownerPos</span>() -&gt; <span class="hljs-selector-tag">p</span> { <span class="hljs-selector-tag">p</span> := <span class="hljs-number">0</span> }
            function <span class="hljs-built_in">totalSupplyPos</span>() -&gt; <span class="hljs-selector-tag">p</span> { <span class="hljs-selector-tag">p</span> := <span class="hljs-number">1</span> }
            function <span class="hljs-built_in">accountToStorageOffset</span>(account) -&gt; offset {
                offset := <span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x1000, account)
            }
            function <span class="hljs-built_in">allowanceStorageOffset</span>(account, spender) -&gt; offset {
                offset := <span class="hljs-built_in">accountToStorageOffset</span>(account)
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>, offset)
                <span class="hljs-built_in">mstore</span>(<span class="hljs-number">0</span>x20, spender)
                offset := <span class="hljs-built_in">keccak256</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>x40)
            }

            <span class="hljs-comment">/* -------- 存储访问 ---------- */</span>
            function <span class="hljs-built_in">owner</span>() -&gt; o {
                o := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">ownerPos</span>())
            }
            function <span class="hljs-built_in">totalSupply</span>() -&gt; supply {
                supply := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">totalSupplyPos</span>())
            }
            function <span class="hljs-built_in">mintTokens</span>(amount) {
                <span class="hljs-built_in">sstore</span>(totalSupplyPos(), <span class="hljs-built_in">safeAdd</span>(totalSupply(), amount))
            }
            function <span class="hljs-built_in">balanceOf</span>(account) -&gt; bal {
                bal := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">accountToStorageOffset</span>(account))
            }
            function <span class="hljs-built_in">addToBalance</span>(account, amount) {
                let offset := <span class="hljs-built_in">accountToStorageOffset</span>(account)
                <span class="hljs-built_in">sstore</span>(offset, <span class="hljs-built_in">safeAdd</span>(<span class="hljs-built_in">sload</span>(offset), amount))
            }
            function <span class="hljs-built_in">deductFromBalance</span>(account, amount) {
                let offset := <span class="hljs-built_in">accountToStorageOffset</span>(account)
                let bal := <span class="hljs-built_in">sload</span>(offset)
                <span class="hljs-built_in">require</span>(<span class="hljs-built_in">lte</span>(amount, bal))
                <span class="hljs-built_in">sstore</span>(offset, <span class="hljs-built_in">sub</span>(bal, amount))
            }
            function <span class="hljs-built_in">allowance</span>(account, spender) -&gt; amount {
                amount := <span class="hljs-built_in">sload</span>(<span class="hljs-built_in">allowanceStorageOffset</span>(account, spender))
            }
            function <span class="hljs-built_in">setAllowance</span>(account, spender, amount) {
                <span class="hljs-built_in">sstore</span>(allowanceStorageOffset(account, spender), amount)
            }
            function <span class="hljs-built_in">decreaseAllowanceBy</span>(account, spender, amount) {
                let offset := <span class="hljs-built_in">allowanceStorageOffset</span>(account, spender)
                let currentAllowance := <span class="hljs-built_in">sload</span>(offset)
                <span class="hljs-built_in">require</span>(<span class="hljs-built_in">lte</span>(amount, currentAllowance))
                <span class="hljs-built_in">sstore</span>(offset, <span class="hljs-built_in">sub</span>(currentAllowance, amount))
            }

            <span class="hljs-comment">/* ---------- 工具函数 ---------- */</span>
            function <span class="hljs-built_in">lte</span>(a, b) -&gt; r {
                r := <span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">gt</span>(a, b))
            }
            function <span class="hljs-built_in">gte</span>(a, b) -&gt; r {
                r := <span class="hljs-built_in">iszero</span>(<span class="hljs-built_in">lt</span>(a, b))
            }
            function <span class="hljs-built_in">safeAdd</span>(a, b) -&gt; r {
                r := <span class="hljs-built_in">add</span>(a, b)
                if <span class="hljs-built_in">or</span>(<span class="hljs-built_in">lt</span>(r, a), <span class="hljs-built_in">lt</span>(r, b)) { <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) }
            }
            function <span class="hljs-built_in">calledByOwner</span>() -&gt; cbo {
                cbo := <span class="hljs-built_in">eq</span>(<span class="hljs-built_in">owner</span>(), <span class="hljs-built_in">caller</span>())
            }
            function <span class="hljs-built_in">revertIfZeroAddress</span>(addr) {
                <span class="hljs-built_in">require</span>(addr)
            }
            function <span class="hljs-built_in">require</span>(condition) {
                if <span class="hljs-built_in">iszero</span>(condition) { <span class="hljs-built_in">revert</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) }
            }
        }
    }
}
</code></pre>
<hr/>
<p>END</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Springboot整合kafka(MQ)]]></title>    <link>https://juejin.cn/post/7588411503120793636</link>    <guid>https://juejin.cn/post/7588411503120793636</guid>    <pubDate>2025-12-28T13:46:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588411503120793636" data-draft-id="7588411503120777252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Springboot整合kafka(MQ)"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T13:46:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ihgry"/> <meta itemprop="url" content="https://juejin.cn/user/3210229685954718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Springboot整合kafka(MQ)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3210229685954718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ihgry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T13:46:39.000Z" title="Sun Dec 28 2025 13:46:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">概念</h4>
<ul>
<li>
<p>一个topic主题下面有多个分区（比如partition1、partition2、partition3），每个分区有多个副本；从所有的副本中选取一个作为Leader，其他作为Follower，Leader副本 负责消息的接收和消息的消费，Follower只负责数据的同步；当Leader分区故障后，从Follower中选取一个作为新的Leader</p>
</li>
<li>
<p>一个分区partition只能被消费者组中的一个消费者实例消费，当topic中分区数量发生变化 或者 消费者组中的消费者发生变化 会触发rebalance，重新分配分区partition和消费者实例 之间的关系</p>
</li>
<li>
<p>生产者发送的消息只在一个partition分区内有序，如果topic下面有多个分区，那所有消息整体是无序的</p>
</li>
<li>
<p>一个topic可以有多个消费者组，kafka会记录每个“消费者组” 消费到 “哪个分区的哪个偏移量offset”了</p>
</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0682279ae6354bfc885ba4cef6a62202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767538899&amp;x-signature=yGQsogQMwY6Des3SmbIqi8LI%2Bh4%3D" alt="kafka.jpg" width="90%" loading="lazy"/></p>
<h4 data-id="heading-1">下载</h4>
<ul>
<li>
<p>下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkafka.apache.org%2Fcommunity%2Fdownloads%2F%25EF%25BC%258C%25E8%25A7%25A3%25E5%258E%258B%25E5%258E%258B%25E7%25BC%25A9%25E5%258C%2585" target="_blank" title="https://kafka.apache.org/community/downloads/%EF%BC%8C%E8%A7%A3%E5%8E%8B%E5%8E%8B%E7%BC%A9%E5%8C%85" ref="nofollow noopener noreferrer">kafka.apache.org/community/d…</a></p>
</li>
<li>
<p>在<code>/root/kafka/kafka_2.12-3.6.2</code>目录下创建文件夹<code>mq_logs</code>，并在<code>mq_logs</code>文件夹下分别创建文件夹<code>kafka_data_logs</code>和<code>zookeeper_data</code>分别保存kafka的日志数据和zookeeper的数据</p>
</li>
<li>
<p>在<code>mq_logs</code>目录下创建<code>kafka_console.out</code>和<code>zookeeper_console.out</code>保存启动程序时的日志输出</p>
</li>
<li>
<p>进入config目录修改<code>zookeeper.properties</code>，将dataDir改为：<code>dataDir=/root/kafka/kafka_2.12-3.6.2/mq_logs/zookeeper_data</code></p>
</li>
<li>
<p>进入config目录修改<code>server.properties</code></p>
<ul>
<li>
<p>将log.dir改为<code>log.dirs=/root/kafka/kafka_2.12-3.6.2/mq_logs/kafka_data_logs</code></p>
</li>
<li>
<p>添加配置：<code>listeners=PLAINTEXT://0.0.0.0:9092</code>和<code> advertised.listeners=PLAINTEXT://localhost:9092</code></p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">启动</h4>
<ul>
<li>
<p>先启动zookeeper：<code>nohup bin/zookeeper-server-start.sh config/zookeeper.properties &gt; /root/kafka/kafka_2.12-3.6.2/mq_logs/zookeeper_console.out 2&gt;&amp;1 &amp;</code></p>
</li>
<li>
<p>再启动kafka：<code>nohup bin/kafka-server-start.sh config/server.properties &gt; /root/kafka/kafka_2.12-3.6.2/mq_logs/kafka_console.out  2&gt;&amp;1 &amp;</code></p>
</li>
</ul>
<h4 data-id="heading-3">命令</h4>
<ul>
<li>
<p>创建主题：<code>./kafka-topics.sh --create --topic 主题名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看所有主题：<code>./kafka-topics.sh --list --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看某个主题：<code>./kafka-topics.sh --describe --topic 主题名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>删除某个主题：<code>./kafka-topics.sh --delete --topic 主题名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看某个组的消费情况：<code>./kafka-consumer-groups.sh --describe --group 消费者组名称 --bootstrap-server localhost:9092</code></p>
</li>
<li>
<p>查看某个组下面的消费者：<code>./kafka-consumer-groups.sh --describe --group 消费组名称 --bootstrap-server localhost:9092 --members</code></p>
</li>
</ul>
<h4 data-id="heading-4">springboot整合kafka</h4>
<ul>
<li>
<p>引入依赖</p>
<pre><code class="hljs language-java" lang="java">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;
    &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li>
<p>引入配置</p>
<pre><code class="hljs language-properties" lang="properties">spring.kafka.bootstrap-servers=115.190.156.159:9092
spring.kafka.producer.retries=3
spring.kafka.producer.batch-size=1000
spring.kafka.producer.buffer-memory=33554432

spring.kafka.consumer.group-id=crm-microservice-newperformance
spring.kafka.consumer.enable-auto-commit=false
spring.kafka.consumer.auto-offset-reset=earliest
spring.kafka.consumer.max-poll-records=200
spring.kafka.listener.ack-mode=MANUAL_IMMEDIATE
</code></pre>
</li>
<li>
<p>配置类：如果程序异常，spring默认将这条消息重复处理9次；这里配置的是同一消息 多次消费失败 的处理策略，即转发到另一个死信topic中；注意，这里是springboot2.7及以上版本的配置方式，和2.7以下版本配置方法不同</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> CommonErrorHandler <span class="hljs-title function_">errorHandler</span><span class="hljs-params">(KafkaTemplate&lt;Object, Object&gt; template)</span> {
        <span class="hljs-comment">// 1. 定义死信恢复器,当重试耗尽后，将消息转发到 "原Topic.DLT"</span>
        <span class="hljs-type">DeadLetterPublishingRecoverer</span> <span class="hljs-variable">recover</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeadLetterPublishingRecoverer</span>(template);
        
        <span class="hljs-comment">// 2. 定义错误处理器</span>
        <span class="hljs-type">DefaultErrorHandler</span> <span class="hljs-variable">errorHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultErrorHandler</span>(recover, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FixedBackOff</span>(<span class="hljs-number">1000L</span>, <span class="hljs-number">3</span>));

        <span class="hljs-keyword">return</span> errorHandler;
    }
}
</code></pre>
</li>
<li>
<p>生产者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@CrossOrigin</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/kafka")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;

    <span class="hljs-meta">@RequestMapping("/send")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">send</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException {
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
        map.put(<span class="hljs-string">"userid"</span>, <span class="hljs-number">1001</span>);
        map.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"ccb"</span>+ UUID.randomUUID());

        ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; result = kafkaTemplate.send(<span class="hljs-string">"test_ccb"</span>, JSONObject.toJSONString(map));
        System.out.println(<span class="hljs-string">"发送结果："</span>+result.get());
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ok"</span>;
    }
}
</code></pre>
</li>
<li>
<p>消费者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConsumer</span> {

    <span class="hljs-comment">// 这里的concurrency=5代表会创建5个消费者实例</span>
    <span class="hljs-meta">@KafkaListener(topics = {"test_ccb"},concurrency = "5")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumer</span><span class="hljs-params">(ConsumerRecord&lt;?, ?&gt; consumerRecord, Acknowledgment ack)</span> {
        System.out.println(<span class="hljs-string">"收到消息："</span> + consumerRecord);
        ack.acknowledge();
    }
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-5">Spring-Kafka原理</h4>
<ul>
<li><code>spring-kafka</code>的自动配置类中，通过<code>KafkaListenerAnnotationBeanPostProcessor </code>扫描每个Bean对象是否带有<code>@KafkaListener</code>注解，如果有则提取注解上的<code>topics</code>、<code>groupId</code>、<code>concurrency</code>等信息封装成一个Endpoint对象，根据Endpoint指定的容器工厂containerFactory创建容器，在容器内运行<code>KafkaConsumer</code></li>
<li>容器工厂是<code>ConcurrentKafkaListenerContainerFactory</code>，它生产容器<code>KafkaMessageListenerContainer</code>，在容器内运行<code>KafkaConsumer</code>，如果<code>concurrency</code>设置为3，将创建3个容器，也就是会有3个消费者实例</li>
<li>如果程序处理过程中出现了错误，会调用配置好的 <code>CommonErrorHandler</code>进行处理，默认会重试9次，如果还是失败，则提交该偏移量避免阻塞后续消息</li>
<li>gemini3剖析过程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fshare%2F4de8006d21e2" target="_blank" title="https://gemini.google.com/share/4de8006d21e2" ref="nofollow noopener noreferrer">gemini.google.com/share/4de80…</a></li>
</ul>
<h4 data-id="heading-6">相关文章</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2185118" target="_blank" title="https://cloud.tencent.com/developer/article/2185118" ref="nofollow noopener noreferrer">3分钟带你彻底搞懂 Kafka-腾讯云开发者社区-腾讯云</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2185123" target="_blank" title="https://cloud.tencent.com/developer/article/2185123" ref="nofollow noopener noreferrer">【真实生产案例】SpringBoot 整合 Kafka 实现数据高吞吐-腾讯云开发者社区-腾讯云</a></p>
</li>
<li>
<p>spring-kafka分析：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fshare%2F4de8006d21e2" target="_blank" title="https://gemini.google.com/share/4de8006d21e2" ref="nofollow noopener noreferrer">gemini.google.com/share/4de80…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年终醒悟，AI 让我误以为自己很强，未来程序员的转型之路]]></title>    <link>https://juejin.cn/post/7587845752681807935</link>    <guid>https://juejin.cn/post/7587845752681807935</guid>    <pubDate>2025-12-26T06:56:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587845752681807935" data-draft-id="7587825267878363177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T06:56:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:56:11.000Z" title="Fri Dec 26 2025 06:56:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 可以说只要是开发者都绕不过 AI ，<strong>时至今日你说你不用 AI 写代码我是不信的</strong>，但是直到最近我才发现，我似乎已经把 AI 的能力当做自己的能力，这种错觉体现在，昨天我用 AI 五分钟做出这下方这个动画效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3613ce014e91453e94fd1c50e05143b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=V%2FggoLB%2BRrHCDNxj18pG0%2BKeNEk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>不知道有没有人能看出这个动画里的梗。。。。</p>
</blockquote>
<p>自从有了 AI 之后，有问题可以让 AI 解读，有需求可以让 AI 分解，比如我想做上面那个动画的时候，只需要让 AI 先根据我的表述给出数学公式，然后根据公式再让 AI 实现和组合代码，而这个过程我只需要点一点运行，预览下效果符不符合我的要求，然后我就觉得自己强的可怕。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b801a608a3d495ca937d2d310dc418b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4sQwLflLYn2KO2O6JqxXpFkmZiU%3D" alt="image-20251226121839643" loading="lazy"/></p>
<p><strong>这种错觉经常让我陷入以为自己“无所不能”</strong>，在提效的同时，心态似乎也在慢慢的走偏，比如这段时间以来，我通过 AI 复刻和尝试了许多特效，虽然偶尔需要我介入修改问题，但是大多数时候都是在 Vibe Coding ，<strong>而看着这些充满想象力的炫酷动画，那种自以为是的心理就会被 AI 无限放大</strong> 。</p>






























<table><thead><tr><th/><th/><th/></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a0b6d11b53452aabc66265090bff30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=B4fz6UPLNseq%2BwXTBX5v2pwKfmA%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0652e86bc274bbe848f632b1c9a4de0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=DTitkkZn7FjnWI7tNlmYg6Dw5Nc%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59c367b6756e4943be98af358fbda0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=Pr6BMhu8aVvezQ54%2FAr6Kk2XRaw%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e6a3504cef472aafc13d3dbd1a3231~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=A2xT%2Bo62zuV2YSno8IMzQsBzZuY%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27890d610f0a46c8b03fc3729d950408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=ttJCBUnDlMTHPlcf4t5yp%2BIq88U%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b946921d4ccc4edbb9a1029fdc24ddcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=76PXV6IfJcYGOFboTNrrVWHY4Es%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0922dc78fe5456fac76e2f26777624a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=uuAOJoF5FGq7IhDEStgVaI6oQb0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/704d800576f34e0f8529a09be8951d83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=7LLJKuhnAaUJeEkTnKM%2F7jomc1k%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9f9c62e85e74c21a076cd06236976ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=lqxbzv51reLd%2Bum5GesSiHyi59U%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b801b53c1d0461fbac8c3e136fbd2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4bKyBdV4vnEg7AkYw%2FJRwR86lm0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af36b93fae24792aa76ccbaed68dda9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=qhOkHiOw5CYUmcVJ6HNGjhmXl5A%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409a495b57284042bb88798cf8c738c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=24DWwASBfi1wo%2BF%2Bpnly9BlI3%2Fw%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>但是现在想来，你真的理解过这些动画吗？真的有去了解他们的实现原理和实现逻辑吗？就算事后看过，不是你写的东西，过后还有印象吗？也让我想起了  Anthropic 在 <a href="https://juejin.cn/post/7579555970594947113" target="_blank" title="https://juejin.cn/post/7579555970594947113">《How AI Is Transforming Work at Anthropic》</a> 文章里提到过的：</p>
<blockquote>
<p>“我以为我喜欢写代码，其实我只是喜欢代码跑通的结果”。</p>
</blockquote>
<p>这也让我开始怀疑，我究竟是喜欢写代码，还是只是单纯喜欢跑通产品？在这个过程中，AI 带来的短期能力提升，很容易就让人对自己的定位产生误差，实际上这个过程有没有发现你的能力可能正在倒退？</p>
<p>这种<strong>职业认同的危机不只是外部开发者有， Claude 内部开发者也有这个焦虑</strong>，所以未来 AI 对于开发者的影响，还可能会带来新的职业价值观的重构，所以有人感到迷茫：<strong>如果写代码这个动作本身不再重要，那么以后作为软件工程师的身份认同建立在哪里</strong>？</p>
<blockquote>
<p>而在这个过程里，<strong>AI 能显著增加产量并扩展个人可承担任务的范围，但同时带来技能退化风险</strong>。</p>
</blockquote>
<p>如今 AI 越来越强已经是时代必然的浪潮，而 AI 现在的缺陷也会很快被时代所修复，就像 Google 的 <a href="https://juejin.cn/post/7576181242582892607" target="_blank" title="https://juejin.cn/post/7576181242582892607">Nested  Learning</a>  论文介绍的，现在大模型的问题在于<strong>大模型无法在训练后继续学习</strong> ，因为目前的大模型只有<strong>极快且短暂的记忆</strong>（In-Context Learning）和<strong>冻结的长期记忆（Pre-trained Weights）</strong> ，这个问题在于：</p>
<blockquote>
<p>当前模型缺乏将“即时对话”转化为“长期参数”的机制，也就是它们缺乏中间的频谱：<strong>那些应该从短期逐渐变为长期的记忆</strong>。</p>
</blockquote>
<p>但是这个问题已经被他们通过全新的 HOPE 架构攻克，未来<strong>能“吃一堑长一智”的 AI 也许离我们就不远了</strong>，所以编程能力对于程序员来说，未来是一个什么地位？这个职业的核心竞争力又在哪里？</p>
<p>在开发实现过程中 AI 很强，但是我们需要清晰的知道，<strong>AI 的强大的编程能力并不是你的能力，而作为程序员，你竞争力也不再是</strong>：</p>
<ul>
<li>熟练掌握某些框架和 API</li>
<li>精通某个语言和语法</li>
</ul>
<p>在这些方面，人是跑不过机器的，就像 <a href="https://juejin.cn/post/7584729714339250195" target="_blank" title="https://juejin.cn/post/7584729714339250195">《  OpenAI  使用 Codex 在 28 天内构建 Android 版 Sora》</a> 里介绍的：</p>
<blockquote>
<p>在使用 GPT-5.1-Codex 之后，在短短 28 天内，不仅完成了繁重的开发任务，还创造了上线 24 小时生成 100 万视频、99.9% 无崩溃率的应用，在这个过程里AI 可以 24 小时无间断编写代码和自我修复，28 天通过 50 亿 token 完成了正常需要几个月的产品上线。</p>
</blockquote>
<p>所以从这里可以看到，你如果想和 AI 拼编码能力肯定是拼不过的，就像 OpenAI 最后总结的：<strong>未来的开发工程师的能力不再是打字速度或语法 API 记忆，而是对系统的深刻洞察力。</strong></p>
<p>直到看到 OpenAI  和 Anthropic 等模型公司对于程序员未来的思考时，我才明白不能再沉迷于 AI 编程给自己带来的“成就感”，因为那是 AI 的能力而不是你的，<strong>你用 AI 可以做到，那别人用 AI 是不是也能做到，那你的职业竞争力在哪里</strong>？</p>
<blockquote>
<p>未来的开发者，强的可能不是代码能力，而是项目管理和 AI 驯服能力。</p>
</blockquote>
<p>所以未来程序员的职业能力肯定会发现变化，比如 2026 对于开发者来说，<strong>短期的价值会体现在如何驯服 AI</strong> ，因为现在的 AI 还是一批脱缰的野马，他的保证就像是“事前”的承诺，各种言之凿凿让你相信它：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de1b143a7a54428803ad5ddb57b13c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=nLA0hRhAuuidTgf9iibjVAymlAs%3D" alt="" loading="lazy"/></p>
<p>而事后提起裤子，出问题了它可半点不认，所以<strong>如何驯服 AI ，同时如何管理和做好大模型善后工程师，这将是程序员短期内的职业变化</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65b268e5419642d7925522fec6dcf45c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=RRDXTLPqV9kxqTt7sL%2BcksYg49g%3D" alt="" loading="lazy"/></p>
<p>而如何驯服 AI ，其实也很简单，<strong>那就是不要上来就让 AI 执行需求，而是给 AI 规划好需求和规则</strong>，把 AI 看作是一个“<em>高能力但缺乏背景的资深新员工</em>”，而你负责架构设计、用户体验和最终决策，而 AI 负责写代码、单元测试和需求落地。</p>
<p>因为 AI 的短板在于目前对于需求的理解还不够，也不擅长得深层的架构权衡（经常为了实现功能而把代码写乱），因为它的 Context 有限，所以经常都会比较片面去理解项目，所以作为程序员，你需要做的是：</p>
<ul>
<li><strong>先规划后代码</strong>：先让 AI 理解系统并编写“设计文档”，纠偏后再执行</li>
<li><strong>背景信息驱动</strong>：通过各种文件文档为 AI 提供规范和上下文，比如各种 rule 和模块描述</li>
<li><strong>增加技能支持</strong> :  通过各种技能描述让 AI 能力增加，比如 CC 可以通过 skills 加载各种插件来辅助能力提升</li>
</ul>
<p>举个例子，比如你要用 Flutter 做一个 Wallet App ，而任务是开发一个 <code>TransactionDetail</code> 模块，需求是：</p>
<ul>
<li>必须遵循 Clean Architecture (Domain -&gt; Data -&gt; Presentation)</li>
<li>数据敏感，金额精度（Decimal）、哈希脱敏显示有严格规范</li>
<li>状态管理，强制使用 <code>riverpod_generator</code> + <code>freezed</code></li>
</ul>
<p>那么在 Claude Code 场景，首先接下来你需要做的会是：</p>
<h3 data-id="heading-0">一、增加 Skill</h3>
<p>这里的核心是教 AI <strong>“在这个团队里，如何标准化地生产一个 Feature”</strong> ，例如创建一个 <code>skills/flutter-clean-feature/</code>  ：</p>
<ol>
<li>
<p><strong><code>SKILL.md</code></strong></p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: flutter-clean-feature
description: 能够按 Clean Architecture 标准生成全套 Flutter 功能模块
<span class="hljs-section">usage: "当用户想开发新页面或功能模块时使用"
---</span>

<span class="hljs-section"># 标准工作流 (SOP)</span>
AI 在执行此 Skill 时，必须严格遵守以下顺序：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**Phase 1: 领域建模 (Domain First)**</span>
<span class="hljs-bullet">    -</span> 读取 <span class="hljs-code">`references/domain_rules.md`</span>。
<span class="hljs-bullet">    -</span> 优先定义 Entity 和 Repository 接口。
<span class="hljs-bullet">    -</span> <span class="hljs-emphasis">*Check*</span>: 所有的金额字段必须使用 <span class="hljs-code">`Decimal`</span> 类型，禁止使用 <span class="hljs-code">`double`</span>。

<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**Phase 2: 架构脚手架 (Scaffolding)**</span>
<span class="hljs-bullet">    -</span> 调用 <span class="hljs-code">`scripts/scaffold_module.py`</span> 自动生成文件夹和空文件。
<span class="hljs-bullet">    -</span> 路径结构必须是 <span class="hljs-code">`lib/features/&lt;name&gt;/{data,domain,presentation}`</span>。

<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**Phase 3: 实现与绑定**</span>
<span class="hljs-bullet">    -</span> 实现 Repository 时，必须使用 <span class="hljs-code">`fpdart`</span> 处理 <span class="hljs-code">`Either&lt;Failure, T&gt;`</span>。
<span class="hljs-bullet">    -</span> UI 层必须使用 <span class="hljs-code">`AsyncValue`</span> 处理加载状态。
</code></pre>
</li>
<li>
<p><strong><code>references/domain_rules.md</code> (知识库)</strong></p>
<ul>
<li>包含团队约定的 Clean Architecture 分层图</li>
<li>包含 JSON 解析的通用错误处理模版</li>
</ul>
</li>
<li>
<p><strong><code>assets/repo_template.dart</code> (模版)</strong></p>
<ul>
<li>预置了带有 <code>Either</code> 返回值的 Repository 接口模版</li>
</ul>
</li>
<li>
<p><strong><code>scripts/scaffold_module.py</code> (自动化工具)</strong></p>
<ul>
<li>一个 Python 脚本，接受模块名参数，自动在 <code>lib/features/</code> 下创建标准的文件夹结构和基础文件（解决 AI 有时候懒得创建文件的毛病）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">二、增加上下文信息</h3>
<p>核心思想就是告诉 AI “这个项目现有的基础设施是什么” ，比如项目维护一个 <code>CLAUDE.md</code>，提供项目级上下文：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># CryptoWallet Project Context</span>

<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> Flutter 3.24
<span class="hljs-bullet">-</span> Riverpod (Annotation mode only)
<span class="hljs-bullet">-</span> Dio (已封装在 <span class="hljs-code">`lib/core/network/dio_client.dart`</span>)
<span class="hljs-bullet">-</span> UI Kit (所有按钮必须使用 <span class="hljs-code">`lib/core/widgets/app_button.dart`</span>)

<span class="hljs-section">## 现有能力</span>
<span class="hljs-bullet">-</span> 格式化工具：<span class="hljs-code">`lib/core/utils/formatters.dart`</span> (包含 hash 截断、货币格式化)
<span class="hljs-bullet">-</span> 路由：GoRouter，路由定义在 <span class="hljs-code">`lib/routes.dart`</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">三、先规划后代码 (Plan)</h3>
<p>可以利用 Claude Code 的交互能力，先加载 Skill 进行规划，审核无误后再由 Skill 中的 Script 自动执行，例如：</p>
<p><strong>1. 启动与规划</strong></p>
<blockquote>
<p>"使用 skill: flutter-clean-feature，我要开发一个 TransactionDetail 模块，输入是 txHash，需要展示交易金额、时间、发送方和接收方。"`</p>
</blockquote>
<blockquote>
<p><strong>Claude (加载 Skill)</strong>: <em>读取 <code>skills/flutter-clean-feature/SKILL.md</code>...</em> <em>读取 <code>CLAUDE.md</code> 获取项目上下文...</em></p>
<p><strong>Claude (输出规划)</strong>: 根据 <strong>Flutter Clean Feature SOP</strong>，我制定了以下计划：</p>
<ol>
<li><strong>Domain</strong>: 定义 <code>TransactionEntity</code> (包含 <code>Decimal amount</code>) 和 <code>ITransactionRepo</code>。</li>
<li><strong>Scaffold</strong>: 运行脚本创建 <code>lib/features/transaction_detail/...</code> 目录。</li>
<li><strong>Data</strong>: 实现 Repo，调用 Context 中提到的 <code>DioClient</code>。</li>
<li><strong>Presentation</strong>: 使用 <code>riverpod_generator</code> 创建 <code>transactionDetailProvider</code>。</li>
</ol>
<p><strong>请确认</strong>：是否需要支持“交易状态（成功/失败）”的枚举？</p>
</blockquote>
<p><strong>2.  Review 优化</strong></p>
<blockquote>
<p><strong>User</strong>: "需要。另外，UI 上金额显示需要调用 <code>formatters.dart</code> 里的方法，不要自己写格式化逻辑。"</p>
</blockquote>
<p><strong>3. 执行</strong></p>
<blockquote>
<p><strong>Claude</strong>: 收到。开始执行。</p>
</blockquote>
<p><em>(Claude 内部触发 Skill 中的 Script)</em> <code>Run script: python skills/flutter-clean-feature/scripts/scaffold_module.py transaction_detail</code> ：</p>
<blockquote>
<p><strong>Terminal Output</strong>:
✅ Created lib/features/transaction_detail/domain
✅ Created lib/features/transaction_detail/data
✅ Created lib/features/transaction_detail/presentation</p>
</blockquote>
<p><em>(Claude 继续编写代码)</em> Claude 根据 <code>assets/repo_template.dart</code> 填充 <code>transaction_repository.dart</code>，并根据 <code>CLAUDE.md</code> 里的规则，引入了 <code>dio_client.dart</code>。</p>
<p>······</p>
<p>是不是觉得很繁琐？是不是觉得一轮整下来我需求都写完了？但是这就是使用 AI 的趋势，只有这样才能控制和管理好 AI 的代码，不至于让 AI 写出一坨屎山，而随着你对工程文档和技能补充的完善，你的开发速度就会越来越快，AI 也能像是你多年的老哥们一样懂你需求，比如 ：</p>
<blockquote>
<p><code>CLAUDE.md</code> 确保了 AI 不会引入 <code>http</code> 库（因为它知道有 <code>Dio</code>），也不会手写丑陋的按钮（因为它知道有 <code>AppButton</code>），它理解了项目的现状，知道有什么技能可用，然后通过规划很你完成确认，这些写出来的代码和项目才是可持续维护的。</p>
</blockquote>
<p>最后，这一年里我出了用 AI 写代码之外，也开始尝试用 AI 去解决和尝试代码之外的事情，因为 AI 所以我敢于尝试一些以前不敢接触的领域，因为过程学习成本太高，而现在 AI 提供了另外一种思路：</p>
<blockquote>
<p><strong>我不需要真的懂，我只需要让 AI 去做就好了，而我只需要提供想法和验证结果</strong>。</p>
</blockquote>
<p>2025 即将结束，而 2026 也会如期而至，而 AI 的浪潮从未停歇，<strong>愿你我都能在新的浪潮下找到自己的位置</strong>~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 进阶核心文档（零基础衔接版，通俗易懂 2025最新）]]></title>    <link>https://juejin.cn/post/7588124225702641704</link>    <guid>https://juejin.cn/post/7588124225702641704</guid>    <pubDate>2025-12-28T10:31:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588124225702641704" data-draft-id="7588095884070780928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 进阶核心文档（零基础衔接版，通俗易懂 2025最新）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-28T10:31:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小脑虎"/> <meta itemprop="url" content="https://juejin.cn/user/1946551141023520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 进阶核心文档（零基础衔接版，通俗易懂 2025最新）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1946551141023520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小脑虎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T10:31:04.000Z" title="Sun Dec 28 2025 10:31:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文是 <strong>JavaScript基础版</strong> 的无缝衔接进阶内容，所有知识点承接基础篇（变量、数据类型、运算符、流程控制、数组），语句通俗易懂、无晦涩概念、案例充足，<strong>零基础可直接上手</strong>，所有案例均可复制运行练习。</p>
<blockquote>
<p>进阶核心定位：基础篇学会「JS的基本语法规则」，进阶篇学会「JS的核心编程思想 + 高频高级语法」，是从「能写代码」到「能写好代码」的必经之路，也是前端开发的核心必备知识。
学习提示：进阶内容更注重「理解原理 + 多做案例」，每个知识点先看懂、再敲代码、最后自己仿写，就能完全掌握。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、数组 进阶（重中之重，开发高频使用）</h2>
<p>在基础篇中我们学习了数组的定义、访问、遍历，数组是JS开发中<strong>最常用的复杂数据类型</strong>，90%的业务逻辑都会用到数组，基础只是入门，<strong>数组的进阶方法和高阶遍历</strong> 是必须吃透的核心内容。</p>
<h3 data-id="heading-2">✅ 数组的基础回顾（快速衔接）</h3>
<ol>
<li>数组是「存储多个数据的容器」，可以存放任意类型的数据：<code>var arr = [1, '张三', true, null, [10,20]]</code></li>
<li>数组的索引从 <code>0</code> 开始，通过 <code>数组名[索引]</code> 访问元素，<code>arr.length</code> 获取数组长度</li>
<li>基础遍历方式：<code>for循环</code> 遍历数组所有元素</li>
</ol>
<h3 data-id="heading-3">✅ 1. 数组的 增/删/改/查 进阶方法（必会，开发高频）</h3>
<p>基础的数组操作是通过索引赋值/取值，但是开发中经常需要「在开头/结尾/指定位置」添加、删除元素，JS内置了<strong>6个核心方法</strong>，语法简单、无需自己写循环，直接调用即可，<strong>必须背会、会用</strong>，分为两组记忆：</p>
<h4 data-id="heading-4">✔️ 第一组：操作数组「尾部」的元素（最常用，无参数坑）</h4>
<h5 data-id="heading-5">① <code>数组.push(元素1, 元素2...)</code> → 尾部追加元素</h5>
<ul>
<li><strong>作用</strong>：向数组的 <strong>最后面</strong> 添加一个或多个元素</li>
<li><strong>返回值</strong>：数组<strong>新的长度</strong></li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>];
<span class="hljs-keyword">var</span> newLen = arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>); <span class="hljs-comment">// 尾部追加4和5</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3,4,5] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newLen); <span class="hljs-comment">// 5 → 返回新长度</span>
</code></pre>
<h5 data-id="heading-6">② <code>数组.pop()</code> → 尾部删除元素</h5>
<ul>
<li><strong>作用</strong>：删除数组的 <strong>最后一个</strong> 元素</li>
<li><strong>返回值</strong>：被删除的那个元素</li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> delItem = arr.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// 删除最后一个元素4</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(delItem); <span class="hljs-comment">//4 → 返回被删除的元素</span>
</code></pre>
<h4 data-id="heading-7">✔️ 第二组：操作数组「头部」的元素（常用）</h4>
<h5 data-id="heading-8">① <code>数组.unshift(元素1, 元素2...)</code> → 头部追加元素</h5>
<ul>
<li><strong>作用</strong>：向数组的 <strong>最前面</strong> 添加一个或多个元素</li>
<li><strong>返回值</strong>：数组<strong>新的长度</strong></li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>];
<span class="hljs-keyword">var</span> newLen = arr.<span class="hljs-title function_">unshift</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>); <span class="hljs-comment">// 头部追加1和2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3,4,5] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newLen); <span class="hljs-comment">//5 → 返回新长度</span>
</code></pre>
<h5 data-id="heading-9">② <code>数组.shift()</code> → 头部删除元素</h5>
<ul>
<li><strong>作用</strong>：删除数组的 <strong>第一个</strong> 元素</li>
<li><strong>返回值</strong>：被删除的那个元素</li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> delItem = arr.<span class="hljs-title function_">shift</span>(); <span class="hljs-comment">// 删除第一个元素1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [2,3,4] 原数组被修改</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(delItem); <span class="hljs-comment">//1 → 返回被删除的元素</span>
</code></pre>
<h4 data-id="heading-10">✔️ 第三组：操作数组「指定位置」的元素（万能增删改，重点）</h4>
<p><code>数组.splice(起始索引, 删除个数, 新增元素1, 新增元素2...)</code> → 数组的「万能方法」</p>
<ul>
<li><strong>作用</strong>：可以在数组的<strong>任意位置</strong>，删除指定个数的元素，同时可以追加新元素</li>
<li><strong>参数说明（3个）</strong>：
<ol>
<li>第1个参数：<strong>必填</strong>，从哪个索引开始操作（索引从0开始）</li>
<li>第2个参数：<strong>必填</strong>，删除的元素个数（0 = 不删除）</li>
<li>第3个及以后参数：<strong>可选</strong>，要新增的元素，写几个加几个</li>
</ol>
</li>
<li><strong>返回值</strong>：被删除的元素组成的「新数组」（没删除则返回空数组）</li>
<li><strong>原数组</strong>：<strong>会被修改</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>];
<span class="hljs-comment">// 案例1：只删除 → 从索引2开始，删除2个元素（3和4）</span>
<span class="hljs-keyword">var</span> delArr = arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,5]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(delArr); <span class="hljs-comment">// [3,4]</span>

<span class="hljs-comment">// 案例2：只新增 → 从索引2开始，删除0个，新增 6,7</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,6,7,5]</span>

<span class="hljs-comment">// 案例3：删了再加（替换）→ 从索引2开始，删除1个，新增 8</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">8</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,8,7,5]</span>
</code></pre>
<h3 data-id="heading-11">✅ 2. 数组的 高阶遍历方法（基础for循环的升级版，开发必用）</h3>
<p>基础篇我们用 <code>for循环</code> 遍历数组，语法繁琐（要写初始值、条件、更新变量），JS为数组内置了 <strong>3个高阶遍历方法</strong>，语法简洁、语义清晰，<strong>开发中99%的场景会替代基础for循环</strong>，也是面试高频考点，<strong>理解原理 + 会用即可</strong>，无需死记硬背。</p>
<blockquote>
<p><strong>核心共性</strong>：这3个方法都是「遍历数组的每一个元素」，都会接收一个 <strong>函数作为参数</strong>（这个函数我们叫「回调函数」），回调函数会被<strong>自动执行</strong>，不需要手动调用。
<strong>回调函数的固定参数</strong>（3个，按顺序写）：</p>
<ol>
<li><code>item</code> → 数组的「当前遍历到的元素」（必用）</li>
<li><code>index</code> → 当前元素的「索引」（可选）</li>
<li><code>arr</code> → 原数组本身（几乎不用）</li>
</ol>
</blockquote>
<h4 data-id="heading-12">✔️ ① <code>数组.forEach(function(item, index){})</code> → 纯遍历（无返回值）</h4>
<ul>
<li><strong>中文含义</strong>：<code>为每个</code>，作用就是「遍历数组的每一个元素」，等价于基础的for循环</li>
<li><strong>核心特点</strong>：<strong>没有返回值</strong>，只做遍历操作（打印、累加、修改元素等）</li>
<li><strong>适用场景</strong>：只需要遍历数组，不需要得到新数组的场景（最常用）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>];
<span class="hljs-comment">// 遍历数组，打印每个元素和对应的索引</span>
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`索引<span class="hljs-subst">${index}</span>的元素是：<span class="hljs-subst">${item}</span>`</span>);
});
<span class="hljs-comment">// 输出结果：</span>
<span class="hljs-comment">// 索引0的元素是：10</span>
<span class="hljs-comment">// 索引1的元素是：20</span>
<span class="hljs-comment">// 索引2的元素是：30</span>
<span class="hljs-comment">// 索引3的元素是：40</span>

<span class="hljs-comment">// 案例：用forEach求数组所有元素的和</span>
<span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>;
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  sum += item;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum); <span class="hljs-comment">// 100</span>
</code></pre>
<h4 data-id="heading-13">✔️ ② <code>数组.map(function(item, index){ return 新值 })</code> → 遍历+加工，返回新数组（开发高频）</h4>
<ul>
<li><strong>中文含义</strong>：<code>映射</code>，作用是「遍历数组的每一个元素，对元素进行加工处理，返回一个新数组」</li>
<li><strong>核心特点</strong>：<strong>有返回值</strong>，返回一个「和原数组长度相同」的新数组，新数组的元素是加工后的结果</li>
<li><strong>原数组</strong>：<strong>不会被修改</strong>（重点，纯纯的新数组）</li>
<li><strong>适用场景</strong>：需要对数组的每一个元素做「统一处理」，得到新数组（如：所有元素乘2、拼接字符串、提取对象属性等）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-comment">// 案例1：所有元素乘2，得到新数组</span>
<span class="hljs-keyword">var</span> newArr = arr.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> item * <span class="hljs-number">2</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1,2,3,4] 原数组不变</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newArr); <span class="hljs-comment">// [2,4,6,8] 新数组</span>

<span class="hljs-comment">// 案例2：给所有元素拼接字符串</span>
<span class="hljs-keyword">var</span> strArr = arr.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> <span class="hljs-string">'数字：'</span> + item;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strArr); <span class="hljs-comment">// ["数字：1", "数字：2", "数字：3", "数字：4"]</span>
</code></pre>
<h4 data-id="heading-14">✔️ ③ <code>数组.filter(function(item, index){ return 布尔值 })</code> → 遍历+筛选，返回新数组（开发高频）</h4>
<ul>
<li><strong>中文含义</strong>：<code>过滤</code>，作用是「遍历数组的每一个元素，按照指定条件筛选出符合要求的元素，返回一个新数组」</li>
<li><strong>核心特点</strong>：<strong>有返回值</strong>，返回的新数组是「原数组的子集」（长度≤原数组）</li>
<li><strong>回调函数规则</strong>：return后面写「筛选条件」，条件成立（true）则保留当前元素，不成立（false）则过滤掉</li>
<li><strong>原数组</strong>：<strong>不会被修改</strong></li>
<li><strong>适用场景</strong>：需要从数组中「筛选符合条件的数据」（如：筛选大于10的数、筛选偶数、筛选符合条件的用户等）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>,<span class="hljs-number">10</span>,<span class="hljs-number">12</span>,<span class="hljs-number">15</span>];
<span class="hljs-comment">// 案例1：筛选出数组中大于10的元素</span>
<span class="hljs-keyword">var</span> bigArr = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> item &gt; <span class="hljs-number">10</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigArr); <span class="hljs-comment">// [12,15]</span>

<span class="hljs-comment">// 案例2：筛选出数组中的偶数</span>
<span class="hljs-keyword">var</span> evenArr = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
  <span class="hljs-keyword">return</span> item % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(evenArr); <span class="hljs-comment">// [8,10,12]</span>
</code></pre>
<h3 data-id="heading-15">✅ 3. 数组的其他常用进阶方法（必会，高频）</h3>
<p>除了遍历和增删改，开发中还有几个数组方法使用率极高，语法简单，直接调用即可，<strong>记牢作用和返回值</strong>：</p>
<h4 data-id="heading-16">✔️ ① <code>数组.indexOf(查找的元素)</code> → 查找元素的索引</h4>
<ul>
<li><strong>作用</strong>：查找数组中是否包含某个元素，返回该元素的<strong>第一个索引</strong></li>
<li><strong>返回值</strong>：找到则返回「索引值」，找不到则返回 <code>-1</code>（重点，判断是否存在的核心）</li>
<li><strong>原数组</strong>：不变</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">20</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">indexOf</span>(<span class="hljs-number">20</span>)); <span class="hljs-comment">// 1 → 找到第一个20的索引是1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">indexOf</span>(<span class="hljs-number">50</span>)); <span class="hljs-comment">// -1 → 找不到返回-1</span>

<span class="hljs-comment">// 开发常用场景：判断数组中是否包含某个元素</span>
<span class="hljs-keyword">if</span>(arr.<span class="hljs-title function_">indexOf</span>(<span class="hljs-number">30</span>) !== -<span class="hljs-number">1</span>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组中包含30'</span>);
}<span class="hljs-keyword">else</span>{
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组中不包含30'</span>);
}
</code></pre>
<h4 data-id="heading-17">✔️ ② <code>数组.includes(查找的元素)</code> → 判断元素是否存在（ES6新增，推荐）</h4>
<ul>
<li><strong>作用</strong>：判断数组中是否包含某个元素，返回布尔值，<strong>比indexOf更直观</strong></li>
<li><strong>返回值</strong>：存在返回 <code>true</code>，不存在返回 <code>false</code></li>
<li><strong>原数组</strong>：不变</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">20</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">50</span>)); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 开发常用场景：判断包含</span>
<span class="hljs-keyword">if</span>(arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">30</span>)){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组中包含30'</span>);
}
</code></pre>
<h4 data-id="heading-18">✔️ ③ <code>数组.join(分隔符)</code> → 数组转字符串</h4>
<ul>
<li><strong>作用</strong>：将数组的所有元素拼接成一个「字符串」</li>
<li><strong>参数</strong>：分隔符（可选），不写则默认用 <code>,</code> 分隔，写空字符串 <code>''</code> 则无缝拼接</li>
<li><strong>返回值</strong>：拼接后的字符串</li>
<li><strong>原数组</strong>：不变</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> arr = [<span class="hljs-string">'我'</span>,<span class="hljs-string">'是'</span>,<span class="hljs-string">'前端'</span>,<span class="hljs-string">'工程师'</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">join</span>()); <span class="hljs-comment">// 我,是,前端,工程师</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)); <span class="hljs-comment">// 我是前端工程师</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>)); <span class="hljs-comment">// 我-是-前端-工程师</span>
</code></pre>
<hr/>
<h2 data-id="heading-19">二、函数 核心（JS的灵魂，进阶核心中的核心）</h2>
<h3 data-id="heading-20">✅ 为什么要学函数？（基础衔接，理解必要性）</h3>
<p>在基础篇中，我们写的代码都是「顺序执行的零散代码」，比如求1~100的和、遍历数组、判断奇偶，这些代码如果需要<strong>重复使用</strong>，只能复制粘贴，会造成：</p>
<ol>
<li><strong>代码冗余</strong>：相同逻辑写多遍，代码量变大</li>
<li><strong>维护困难</strong>：逻辑需要修改时，所有复制的地方都要改，容易漏改</li>
<li><strong>可读性差</strong>：零散代码没有语义，看不懂这段代码的作用</li>
</ol>
<p>而 <strong>函数</strong> 就是为了解决这个问题而生的，函数的核心作用：<strong>把一段实现特定功能的代码「封装」起来，给这段代码起个名字，以后需要用的时候，直接调用名字即可，不用重复写代码</strong>。</p>
<blockquote>
<p>一句话总结：函数 = 封装好的、可重复使用的「代码块」，是JS的核心编程思想。</p>
</blockquote>
<h3 data-id="heading-21">✅ 1. 函数的基础概念（通俗易懂）</h3>
<h4 data-id="heading-22">✔️ 什么是函数？</h4>
<p>函数是一段 <strong>被命名的、可重复执行的代码块</strong>，这段代码块实现了一个「特定的功能」，比如：求和、求最大值、判断闰年、遍历数组等，只要是「需要重复使用的逻辑」，都应该封装成函数。</p>
<h4 data-id="heading-23">✔️ 函数的核心特点（3个）</h4>
<ol>
<li><strong>封装性</strong>：把实现功能的代码包起来，对外只暴露一个名字，隐藏内部细节</li>
<li><strong>复用性</strong>：一次封装，多次调用，不用重复写代码</li>
<li><strong>独立性</strong>：函数内部的代码和外部是隔离的，互不影响</li>
</ol>
<h3 data-id="heading-24">✅ 2. 函数的 定义 &amp; 调用（基础语法，必会，核心两步）</h3>
<p>使用函数的完整流程只有两步：<strong>第一步：定义函数（封装代码），第二步：调用函数（执行代码）</strong>，缺一不可，先定义后调用，顺序不能乱。</p>
<blockquote>
<p>类比：定义函数 = 买了一个洗衣机（封装了洗衣服的功能），调用函数 = 按下洗衣机的开关（执行洗衣服的功能），洗衣机买了不用就不会工作，函数定义了不调用就不会执行。</p>
</blockquote>
<h4 data-id="heading-25">✔️ 第一步：定义函数（两种方式，开发都用第一种）</h4>
<h5 data-id="heading-26">方式1：声明式定义函数（推荐，最常用）</h5>
<p><strong>语法格式（固定）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// function 是关键字，固定写</span>
<span class="hljs-comment">// 函数名：自己起的名字，命名规则和变量一样（见名知意、驼峰命名）</span>
<span class="hljs-comment">// ()：形参列表，后面讲</span>
<span class="hljs-comment">// {}：函数体，写实现功能的代码</span>
<span class="hljs-keyword">function</span> 函数名() {
  <span class="hljs-comment">// 函数体：实现功能的代码</span>
  代码逻辑;
}
</code></pre>
<p><strong>案例</strong>：封装一个「求两个数之和」的函数</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：封装求和的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">20</span>;
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'两个数的和是：'</span>, sum);
}
</code></pre>
<h5 data-id="heading-27">方式2：赋值式定义函数（了解即可）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 把函数赋值给一个变量，变量名就是函数名</span>
<span class="hljs-keyword">var</span> getSum = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">20</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a + b);
}
</code></pre>
<h4 data-id="heading-28">✔️ 第二步：调用函数（执行函数的核心，语法固定）</h4>
<p><strong>语法格式（固定）</strong>：<code>函数名();</code></p>
<ul>
<li>只要写了这行代码，函数内部的代码就会被执行</li>
<li>调用多少次，函数就执行多少次</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">var</span> b = <span class="hljs-number">20</span>;
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'两个数的和是：'</span>, sum);
}

<span class="hljs-comment">// 调用函数 → 执行函数体代码，打印结果</span>
<span class="hljs-title function_">getSum</span>(); <span class="hljs-comment">// 输出：两个数的和是：30</span>
<span class="hljs-comment">// 再调用一次 → 再执行一次</span>
<span class="hljs-title function_">getSum</span>(); <span class="hljs-comment">// 输出：两个数的和是：30</span>
</code></pre>
<h3 data-id="heading-29">✅ 3. 函数的 参数（核心进阶，让函数更灵活，必学）</h3>
<h4 data-id="heading-30">✔️ 为什么需要参数？（理解必要性）</h4>
<p>上面的求和函数有一个问题：求和的两个数 <code>10</code> 和 <code>20</code> 是「写死的」，调用函数只能求10+20的和，如果想求其他数的和，需要修改函数内部的代码，这样的函数灵活性太差，复用性不高。</p>
<p>而 <strong>参数</strong> 就是为了解决这个问题，参数的核心作用：<strong>让函数的「逻辑不变，数据可变」</strong>，调用函数的时候，把需要处理的数据「传进去」，函数内部用传进来的数据执行逻辑，这样同一个函数可以处理不同的数据，灵活性拉满。</p>
<h4 data-id="heading-31">✔️ 参数的两个核心概念（形参 &amp; 实参，通俗易懂，必记）</h4>
<p>为了方便理解，我们用「洗衣机洗衣服」来类比：</p>
<ul>
<li>洗衣机的功能是「洗衣服」（函数的逻辑不变）</li>
<li>洗衣服时需要「放衣服进去」（衣服就是传给洗衣机的「数据」）</li>
<li>洗衣机上有一个「放衣服的入口」（这个入口就是函数的「形参」）</li>
<li>你放进去的「具体衣服」（比如T恤、裤子）就是「实参」</li>
</ul>
<p>对应到函数中，两个概念的定义：</p>
<ol>
<li><strong>形参（形式参数）</strong>：写在函数定义时的 <code>()</code> 里面，本质是「函数内部的变量」，<strong>没有具体的值</strong>，只是用来「接收」调用函数时传进来的数据。
<ul>
<li><strong>语法</strong>：多个形参用 <code>,</code> 分隔</li>
<li><strong>作用</strong>：函数内部可以直接使用这个变量</li>
</ul>
</li>
<li><strong>实参（实际参数）</strong>：写在函数调用时的 <code>()</code> 里面，是「具体的数据」，作用是「传给函数的形参」，给形参赋值。
<ul>
<li><strong>语法</strong>：多个实参用 <code>,</code> 分隔</li>
<li><strong>规则</strong>：<strong>形参和实参是一一对应的</strong>，第一个实参给第一个形参赋值，第二个给第二个赋值，以此类推。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-32">✔️ 参数的使用语法（固定，案例理解，一看就会）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数时：()里写 形参 → 相当于声明变量，无值</span>
<span class="hljs-keyword">function</span> 函数名(形参<span class="hljs-number">1</span>, 形参<span class="hljs-number">2</span>, ...) {
  <span class="hljs-comment">// 函数体中直接使用形参</span>
  代码逻辑(形参<span class="hljs-number">1</span>, 形参<span class="hljs-number">2</span>);
}

<span class="hljs-comment">// 调用函数时：()里写 实参 → 给形参赋值</span>
函数名(实参<span class="hljs-number">1</span>, 实参<span class="hljs-number">2</span>, ...);
</code></pre>
<p><strong>案例1</strong>：封装求和函数，支持求「任意两个数」的和（核心案例）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：形参a和b，接收传进来的两个数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a + <span class="hljs-string">'+'</span> + b + <span class="hljs-string">'='</span> + sum);
}

<span class="hljs-comment">// 调用函数：传不同的实参，处理不同的数据</span>
<span class="hljs-title function_">getSum</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 实参10→a，20→b → 输出：10+20=30</span>
<span class="hljs-title function_">getSum</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>);   <span class="hljs-comment">// 实参5→a，8→b → 输出：5+8=13</span>
<span class="hljs-title function_">getSum</span>(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>);<span class="hljs-comment">// 实参100→a，200→b → 输出：100+200=300</span>
</code></pre>
<p><strong>案例2</strong>：封装函数，求「任意数组」的所有元素之和（进阶案例，衔接数组）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：形参arr接收传进来的数组</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getArrSum</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>;
  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
    sum += item;
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组的和是：'</span>, sum);
}

<span class="hljs-comment">// 调用函数：传不同的数组</span>
<span class="hljs-keyword">var</span> arr1 = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> arr2 = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>];
<span class="hljs-title function_">getArrSum</span>(arr1); <span class="hljs-comment">// 输出：数组的和是：10</span>
<span class="hljs-title function_">getArrSum</span>(arr2); <span class="hljs-comment">// 输出：数组的和是：60</span>
</code></pre>
<h3 data-id="heading-33">✅ 4. 函数的 返回值（核心进阶，函数的精髓，必学）</h3>
<h4 data-id="heading-34">✔️ 为什么需要返回值？（理解必要性）</h4>
<p>上面的函数都是「执行逻辑后直接打印结果」，比如求和函数打印和、求数组和函数打印数组和，但是开发中，我们经常需要「使用函数的执行结果」做后续处理，比如：</p>
<ul>
<li>求两个数的和后，再把和乘2</li>
<li>求数组的和后，再判断和是否大于100</li>
<li>求最大值后，再把最大值赋值给一个变量</li>
</ul>
<p>如果函数只是打印结果，我们无法拿到这个结果做后续处理，而 <strong>返回值</strong> 就是为了解决这个问题，返回值的核心作用：<strong>函数执行完逻辑后，把「执行结果」返回给调用者，调用者可以拿到这个结果，赋值给变量、做运算、做判断等，想怎么用就怎么用</strong>。</p>
<blockquote>
<p>一句话总结：函数的「参数」是「往函数里传数据」，函数的「返回值」是「从函数里拿数据出来」，有了参数和返回值，函数才是一个完整的「数据处理容器」。</p>
</blockquote>
<h4 data-id="heading-35">✔️ 返回值的核心语法（固定，必记）</h4>
<ol>
<li><strong>关键字</strong>：<code>return</code> → 写在函数体内部，固定关键字</li>
<li><strong>语法</strong>：<code>return 要返回的结果;</code></li>
<li><strong>核心规则（3个，必背）</strong>：
<ul>
<li>函数执行到 <code>return</code> 时，会立刻停止执行，后面的代码都不会执行（<code>return</code> 是函数的「出口」）</li>
<li>一个函数只能有「一个返回值」，写多个return只有第一个生效</li>
<li>如果函数没有写 <code>return</code>，则默认返回 <code>undefined</code></li>
</ul>
</li>
</ol>
<h4 data-id="heading-36">✔️ 返回值的使用案例（核心，开发必用，一看就会）</h4>
<p><strong>案例1</strong>：求和函数，返回求和结果，调用者拿到结果后做后续处理</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：求和后，return返回结果</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSum</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">var</span> sum = a + b;
  <span class="hljs-keyword">return</span> sum; <span class="hljs-comment">// 返回求和结果</span>
}

<span class="hljs-comment">// 调用函数：用变量接收返回值，后续可以任意使用</span>
<span class="hljs-keyword">var</span> res1 = <span class="hljs-title function_">getSum</span>(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res1); <span class="hljs-comment">// 30 → 拿到结果</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res1 * <span class="hljs-number">2</span>); <span class="hljs-comment">//60 → 用结果做运算</span>
<span class="hljs-keyword">var</span> res2 = <span class="hljs-title function_">getSum</span>(<span class="hljs-number">5</span>,<span class="hljs-number">8</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res1 + res2); <span class="hljs-comment">//30+13=43 → 多个结果做运算</span>
</code></pre>
<p><strong>案例2</strong>：封装函数，返回「任意数组」的最大值（进阶案例，开发高频）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义函数：接收数组，返回数组的最大值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getMax</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">var</span> max = arr[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 假设第一个元素是最大值</span>
  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){
    <span class="hljs-keyword">if</span>(item &gt; max){
      max = item;
    }
  });
  <span class="hljs-keyword">return</span> max; <span class="hljs-comment">// 返回最大值</span>
}

<span class="hljs-comment">// 调用函数：拿到最大值，做后续处理</span>
<span class="hljs-keyword">var</span> arr = [<span class="hljs-number">10</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>,<span class="hljs-number">15</span>,<span class="hljs-number">8</span>];
<span class="hljs-keyword">var</span> maxNum = <span class="hljs-title function_">getMax</span>(arr);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组的最大值是：'</span>, maxNum); <span class="hljs-comment">//20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最大值加10是：'</span>, maxNum +<span class="hljs-number">10</span>); <span class="hljs-comment">//30</span>
</code></pre>
<h3 data-id="heading-37">✅ 5. 函数的 作用域（进阶重点，理解即可，面试高频）</h3>
<h4 data-id="heading-38">✔️ 什么是作用域？（通俗易懂，无晦涩概念）</h4>
<p>作用域 = 变量的「生效范围」，就是一个变量「能在哪个区域被访问、被使用」，超出这个区域就访问不到了。</p>
<blockquote>
<p>类比：你在自己家里可以随便用自己的东西（变量），但是到了别人家就不能用别人的东西，这就是「作用域」的本质。</p>
</blockquote>
<h4 data-id="heading-39">✔️ JS的两种核心作用域（必记，通俗易懂）</h4>
<p>在JS中，根据变量的声明位置，分为两种作用域，<strong>所有变量都遵守这个规则</strong>：</p>
<h5 data-id="heading-40">① 全局作用域（全局变量）</h5>
<ul>
<li><strong>定义</strong>：在「函数外部」声明的变量，就是「全局变量」</li>
<li><strong>作用范围</strong>：<strong>整个JS文件都能访问到</strong>，函数内部也能访问全局变量</li>
<li><strong>生命周期</strong>：页面打开时创建，页面关闭时销毁</li>
</ul>
<h5 data-id="heading-41">② 局部作用域（局部变量）</h5>
<ul>
<li><strong>定义</strong>：在「函数内部」声明的变量（包括函数的「形参」），就是「局部变量」</li>
<li><strong>作用范围</strong>：<strong>只能在当前函数内部访问</strong>，函数外部完全访问不到</li>
<li><strong>生命周期</strong>：函数调用时创建，函数执行结束后立刻销毁（节省内存）</li>
</ul>
<h4 data-id="heading-42">✔️ 作用域的核心规则（黄金规则，必背，开发不会出错）</h4>
<ol>
<li><strong>变量的访问规则</strong>：「就近原则」→ 访问变量时，先在当前作用域找，如果有就用；没有就去上一级作用域找，直到全局作用域；全局作用域没有则报错 <code>undefined</code>。</li>
<li><strong>变量的赋值规则</strong>：给变量赋值时，先在当前作用域找，如果有就赋值；没有就去上一级作用域找，直到全局作用域；全局作用域没有则「自动声明为全局变量」（不推荐）。</li>
</ol>
<h4 data-id="heading-43">✔️ 作用域的案例（一看就会，理解即可）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全局变量：在函数外部声明</span>
<span class="hljs-keyword">var</span> num = <span class="hljs-number">100</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 局部变量：在函数内部声明</span>
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">200</span>;
  <span class="hljs-comment">// 形参也是局部变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 100 → 访问全局变量，能拿到</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">//200 → 访问局部变量，能拿到</span>
}
<span class="hljs-title function_">fn</span>();

<span class="hljs-comment">// 函数外部访问局部变量 → 报错，访问不到</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// Uncaught ReferenceError: a is not defined</span>
<span class="hljs-comment">// 函数外部访问全局变量 → 能拿到</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">//100</span>
</code></pre>
<h3 data-id="heading-44">✅ 6. 函数的 进阶使用：匿名函数 &amp; 立即执行函数（开发常用，了解即可）</h3>
<h4 data-id="heading-45">✔️ 匿名函数</h4>
<p>就是「没有名字的函数」，语法：<code>function() { 函数体 }</code></p>
<ul>
<li><strong>特点</strong>：无法直接调用，因为没有名字，一般和其他语法结合使用（如：数组遍历的回调函数、事件绑定）</li>
<li><strong>开发场景</strong>：数组的forEach/map/filter的回调函数，就是匿名函数，这也是匿名函数的最常用场景。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数组遍历的回调函数，就是匿名函数</span>
<span class="hljs-keyword">var</span> arr = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>];
arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>){ <span class="hljs-comment">// 这个function就是匿名函数</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
});
</code></pre>
<h4 data-id="heading-46">✔️ 立即执行函数（IIFE）</h4>
<p>就是「定义后立刻执行的函数」，语法：<code>(function(){ 函数体 })();</code></p>
<ul>
<li><strong>特点</strong>：定义和调用合二为一，执行完后立刻销毁，不会污染全局变量</li>
<li><strong>开发场景</strong>：页面加载时需要执行的一次性逻辑，比如初始化数据、页面渲染前的准备工作。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 立即执行函数：定义后立刻执行</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我是立即执行函数，定义后马上执行'</span>);
})();
</code></pre>
<hr/>
<h2 data-id="heading-47">三、对象 核心（JS的核心数据类型，开发高频，进阶必备）</h2>
<h3 data-id="heading-48">✅ 为什么要学对象？（基础衔接，理解必要性）</h3>
<p>在基础篇中，我们用「数组」存储多个数据，但是数组有一个缺点：<strong>数据是无序的，只能通过索引访问，无法直观的表示数据的含义</strong>。</p>
<p>比如：存储一个人的信息，用数组是这样的：<code>var person = ['张三', 18, '男', '北京'];</code></p>
<ul>
<li>我们无法直观的知道 <code>person[0]</code> 是姓名，<code>person[1]</code> 是年龄</li>
<li>如果数据顺序变了，访问的结果就错了</li>
</ul>
<p>而 <strong>对象</strong> 就是为了解决这个问题而生的，对象的核心特点：<strong>用「键值对」的形式存储数据，键（属性名）表示数据的含义，值（属性值）表示数据的内容</strong>，可以直观的表示「一个事物的多个属性」，比如人、商品、文章等，都是用对象存储。</p>
<blockquote>
<p>一句话总结：数组是「有序的、无含义的」数据集合，对象是「无序的、有含义的」数据集合，数组适合存储「同类型的多个数据」，对象适合存储「一个事物的多个属性」。</p>
</blockquote>
<h3 data-id="heading-49">✅ 1. 对象的基础概念（通俗易懂，必记）</h3>
<h4 data-id="heading-50">✔️ 什么是对象？</h4>
<p>对象是JS中的一种 <strong>复杂数据类型</strong>，是一个「键值对的集合」，用来表示「一个具体的事物」，比如：一个人、一个商品、一个汽车。</p>
<ul>
<li><strong>键（key）</strong>：也叫「属性名」，是字符串类型，用来表示数据的「含义」（如：name、age、sex）</li>
<li><strong>值（value）</strong>：也叫「属性值」，可以是任意类型的数据（数字、字符串、布尔值、数组、甚至对象、函数）</li>
<li>键值对之间用 <code>,</code> 分隔，键和值之间用 <code>:</code> 分隔</li>
</ul>
<h4 data-id="heading-51">✔️ 对象的核心特点</h4>
<ol>
<li><strong>无序性</strong>：对象的属性没有顺序，不像数组有索引，访问属性只能通过「属性名」</li>
<li><strong>灵活性</strong>：对象的属性可以随时添加、修改、删除</li>
<li><strong>可读性</strong>：属性名有明确的含义，一看就知道存储的是什么数据</li>
</ol>
<h3 data-id="heading-52">✅ 2. 对象的 创建 &amp; 访问（基础语法，必会）</h3>
<h4 data-id="heading-53">✔️ 方式1：字面量创建对象（推荐，开发最常用，简洁高效）</h4>
<p><strong>语法格式（固定）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> 对象名 = {
  属性名<span class="hljs-number">1</span>: 属性值<span class="hljs-number">1</span>,
  属性名<span class="hljs-number">2</span>: 属性值<span class="hljs-number">2</span>,
  属性名<span class="hljs-number">3</span>: 属性值<span class="hljs-number">3</span>,
  <span class="hljs-comment">// ... 可以写多个属性</span>
};
</code></pre>
<p><strong>案例</strong>：创建一个「人的对象」，存储姓名、年龄、性别、地址</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>,
  <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市'</span>,
  <span class="hljs-attr">hobby</span>: [<span class="hljs-string">'打球'</span>, <span class="hljs-string">'听歌'</span>, <span class="hljs-string">'编程'</span>] <span class="hljs-comment">// 属性值可以是数组</span>
};
</code></pre>
<h4 data-id="heading-54">✔️ 方式2：构造函数创建对象（了解即可）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
person.<span class="hljs-property">name</span> = <span class="hljs-string">'张三'</span>;
person.<span class="hljs-property">age</span> = <span class="hljs-number">18</span>;
person.<span class="hljs-property">sex</span> = <span class="hljs-string">'男'</span>;
</code></pre>
<h4 data-id="heading-55">✔️ 对象的属性访问（两种方式，必会，开发都用）</h4>
<p><strong>语法格式（两种，都要会）</strong>：</p>
<ol>
<li><strong>点语法</strong>：<code>对象名.属性名</code> → 推荐，语法简洁，可读性高（开发99%用这个）</li>
<li><strong>方括号语法</strong>：<code>对象名['属性名']</code> → 适合属性名是变量、或者属性名有特殊字符的场景</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>
};

<span class="hljs-comment">// 点语法访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">name</span>); <span class="hljs-comment">// 张三</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">age</span>); <span class="hljs-comment">//18</span>

<span class="hljs-comment">// 方括号语法访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person[<span class="hljs-string">'name'</span>]); <span class="hljs-comment">//张三</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person[<span class="hljs-string">'age'</span>]); <span class="hljs-comment">//18</span>
</code></pre>
<h3 data-id="heading-56">✅ 3. 对象的 属性 增/删/改/查（进阶，必会，开发高频）</h3>
<p>对象的属性是「动态的」，可以随时添加、修改、删除，语法简单，和访问属性的语法一致，<strong>必记</strong>：</p>
<h4 data-id="heading-57">✔️ ① 查：访问属性 → 两种方式，同上</h4>
<h4 data-id="heading-58">✔️ ② 改：修改属性值 → 访问属性后直接赋值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {<span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>};
person.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>; <span class="hljs-comment">// 修改年龄为20</span>
person.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span>; <span class="hljs-comment">// 修改姓名为李四</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person); <span class="hljs-comment">// {name: '李四', age: 20}</span>
</code></pre>
<h4 data-id="heading-59">✔️ ③ 增：添加新属性 → 直接给对象的新属性赋值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {<span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>};
person.<span class="hljs-property">sex</span> = <span class="hljs-string">'男'</span>; <span class="hljs-comment">// 添加性别属性</span>
person.<span class="hljs-property">address</span> = <span class="hljs-string">'北京市'</span>; <span class="hljs-comment">// 添加地址属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person); <span class="hljs-comment">// {name: '张三', age:18, sex:'男', address:'北京市'}</span>
</code></pre>
<h4 data-id="heading-60">✔️ ④ 删：删除属性 → 关键字 <code>delete</code></h4>
<p><strong>语法</strong>：<code>delete 对象名.属性名</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {<span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>, <span class="hljs-attr">sex</span>:<span class="hljs-string">'男'</span>};
<span class="hljs-keyword">delete</span> person.<span class="hljs-property">sex</span>; <span class="hljs-comment">// 删除性别属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person); <span class="hljs-comment">// {name: '张三', age:18}</span>
</code></pre>
<h3 data-id="heading-61">✅ 4. 对象的 方法（核心进阶，对象的灵魂，必会）</h3>
<h4 data-id="heading-62">✔️ 什么是对象的方法？</h4>
<p>对象的属性值可以是「任意类型的数据」，如果属性值是「函数」，那么这个属性就叫做「方法」。</p>
<blockquote>
<p>一句话总结：对象的属性是「描述事物的特征」（如：姓名、年龄），对象的方法是「描述事物的行为」（如：吃饭、跑步、说话、工作）。</p>
</blockquote>
<h4 data-id="heading-63">✔️ 方法的定义 &amp; 调用（语法固定，必会）</h4>
<h5 data-id="heading-64">① 定义方法：属性值是函数</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-comment">// 定义方法：属性名是sayHi，属性值是函数</span>
  <span class="hljs-attr">sayHi</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你好，我是'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-comment">// 定义带参数的方法</span>
  <span class="hljs-attr">eat</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">food</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我喜欢吃'</span> + food);
  }
};
</code></pre>
<blockquote>
<p><strong>重点关键字</strong>：<code>this</code> → 在对象的方法中，<code>this</code> 指向「当前对象」，可以通过 <code>this.属性名</code> 访问对象的属性，这是对象方法的核心语法，必记！</p>
</blockquote>
<h5 data-id="heading-65">② 调用方法：<code>对象名.方法名()</code> → 方法是函数，必须加括号调用</h5>
<pre><code class="hljs language-javascript" lang="javascript">person.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 输出：你好，我是张三</span>
person.<span class="hljs-title function_">eat</span>(<span class="hljs-string">'红烧肉'</span>); <span class="hljs-comment">// 输出：我喜欢吃红烧肉</span>
</code></pre>
<h3 data-id="heading-66">✅ 5. 对象的 遍历（进阶，必会，开发高频）</h3>
<p>对象是「键值对的集合」，没有索引，所以不能用for循环遍历，JS提供了专门的遍历对象的语法：<code>for...in</code> 循环，语法固定，必记。</p>
<h4 data-id="heading-67">✔️ for...in 循环遍历对象</h4>
<p><strong>语法格式（固定）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> 对象名) {
  <span class="hljs-comment">// key 是对象的「属性名」（字符串类型）</span>
  <span class="hljs-comment">// 对象名[key] 是对象的「属性值」</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'属性名：'</span>, key);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'属性值：'</span>, 对象名[key]);
}
</code></pre>
<p><strong>案例</strong>：遍历人的对象，打印所有属性名和属性值</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>,
  <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市'</span>
};

<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> person) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key + <span class="hljs-string">'：'</span> + person[key]);
}
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// name：张三</span>
<span class="hljs-comment">// age：18</span>
<span class="hljs-comment">// sex：男</span>
<span class="hljs-comment">// address：北京市</span>
</code></pre>
<hr/>
<h2 data-id="heading-68">四、JS的 内置对象（进阶，开发高频，不用记，会查即用）</h2>
<h3 data-id="heading-69">✅ 什么是内置对象？（通俗易懂）</h3>
<p>JS为了方便开发者开发，<strong>提前内置了一些常用的对象</strong>，这些对象封装了很多常用的功能和方法，我们不需要自己封装，直接调用即可，比如：数组、字符串、数字、日期等，都是JS的内置对象。</p>
<blockquote>
<p>一句话总结：内置对象 = JS官方给我们写好的「工具包」，里面有很多现成的方法，拿来即用，节省开发时间。</p>
</blockquote>
<h3 data-id="heading-70">✅ 开发中最常用的3个内置对象（必会，高频）</h3>
<h4 data-id="heading-71">✔️ 1. 字符串内置对象（String）</h4>
<p>字符串本质上就是一个「字符数组」，JS为字符串内置了很多方法，用于处理字符串（如：截取、替换、转大小写、查找等），<strong>所有字符串都可以直接调用这些方法</strong>，原字符串不变，返回新字符串。</p>
<p><strong>常用方法（必记，开发高频）</strong>：</p>
<ul>
<li><code>字符串.length</code> → 获取字符串长度（基础）</li>
<li><code>字符串.indexOf(字符)</code> → 查找字符的索引，找不到返回-1</li>
<li><code>字符串.includes(字符)</code> → 判断是否包含某个字符，返回布尔值</li>
<li><code>字符串.toUpperCase()</code> → 转大写</li>
<li><code>字符串.toLowerCase()</code> → 转小写</li>
<li><code>字符串.slice(起始索引, 结束索引)</code> → 截取字符串，含头不含尾</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> str = <span class="hljs-string">'Hello JavaScript'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-property">length</span>); <span class="hljs-comment">//16</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'Java'</span>)); <span class="hljs-comment">//6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Java'</span>)); <span class="hljs-comment">//true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">//HELLO JAVASCRIPT</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">toLowerCase</span>()); <span class="hljs-comment">//hello javascript</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>,<span class="hljs-number">5</span>)); <span class="hljs-comment">//Hello</span>
</code></pre>
<h4 data-id="heading-72">✔️ 2. 数字内置对象（Number）</h4>
<p>封装了数字的常用方法，开发中主要用两个常量：</p>
<ul>
<li><code>Number.MAX_VALUE</code> → JS中最大的数字</li>
<li><code>Number.MIN_VALUE</code> → JS中最小的正数</li>
</ul>
<h4 data-id="heading-73">✔️ 3. 日期内置对象（Date）（开发高频，必会）</h4>
<p>用于处理「日期和时间」，开发中经常用到（如：获取当前时间、格式化时间、计算时间差），语法固定，会用即可。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建日期对象：获取当前时间</span>
<span class="hljs-keyword">var</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date); <span class="hljs-comment">// 打印当前完整时间</span>

<span class="hljs-comment">// 常用方法：获取年、月、日、时、分、秒</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getFullYear</span>()); <span class="hljs-comment">// 获取年份（4位）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>); <span class="hljs-comment">// 获取月份（0-11，所以要+1）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getDate</span>()); <span class="hljs-comment">// 获取日期</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getHours</span>()); <span class="hljs-comment">// 获取小时</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getMinutes</span>()); <span class="hljs-comment">// 获取分钟</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">getSeconds</span>()); <span class="hljs-comment">// 获取秒</span>
</code></pre>
<hr/>
<h2 data-id="heading-74">最后：进阶篇学习建议（零基础友好，2025良心建议）</h2>
<ol>
<li><strong>学习顺序</strong>：先吃透「数组进阶」→ 再学「函数核心」→ 最后学「对象核心」，这三个模块是进阶篇的核心，也是开发的核心，循序渐进，不要跳着学。</li>
<li><strong>学习方法</strong>：进阶内容的核心是「理解原理 + 多做案例」，每个知识点先看懂案例，再自己仿写，比如：封装求和函数、封装求最大值函数、封装数组去重函数、创建对象并遍历，这些都是经典案例，一定要自己敲一遍。</li>
<li><strong>核心重点</strong>：函数的「参数和返回值」是函数的精髓，对象的「键值对和方法」是对象的精髓，数组的「高阶遍历方法」是数组的精髓，这三个点吃透，你就掌握了JS的核心编程思想。</li>
<li><strong>心态调整</strong>：进阶内容比基础内容难一点，遇到不懂的地方不要慌，多看几遍案例、多敲几遍代码，就能理解，这是所有前端开发者的必经之路，坚持下去就会突破。</li>
</ol>
<hr/>
<p><strong>结语</strong>：本文档是JavaScript基础版的无缝衔接进阶内容，涵盖了开发中<strong>90%的高频进阶知识点</strong>，语句通俗易懂、案例充足，零基础可直接上手。学好这些内容，你就具备了编写「复杂业务逻辑」的能力，后续可以继续学习「DOM操作、BOM操作、事件、AJAX」等前端实战内容，向真正的前端开发工程师迈进！加油！💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Commit 阶段的 3 个子阶段与副作用执行全解析]]></title>    <link>https://juejin.cn/post/7588388014504493098</link>    <guid>https://juejin.cn/post/7588388014504493098</guid>    <pubDate>2025-12-28T12:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588388014504493098" data-draft-id="7588191506607341574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Commit 阶段的 3 个子阶段与副作用执行全解析"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-28T12:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="day1"/> <meta itemprop="url" content="https://juejin.cn/user/4310544201823182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Commit 阶段的 3 个子阶段与副作用执行全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4310544201823182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    day1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T12:59:45.000Z" title="Sun Dec 28 2025 12:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>Commit 阶段是 React 更新流程的最后一环，用于把 Render 阶段计算出的变更与副作用原子化地应用到宿主环境（DOM），确保界面一致性与不出现中间态。</p>
<h2 data-id="heading-1">二、React 全流程视角下的 Commit 阶段</h2>
<h3 data-id="heading-2">2.1 React 渲染全流程回顾</h3>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f114594b3011466dad716fcbeeddf7c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF5MQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531584&amp;x-signature=lY6Tq3%2BWx30hLi1qhaJjiK1JxWA%3D" alt="7-1.png" loading="lazy"/></p>
<ol>
<li>触发：来自事件、<code>setState</code>、<code>dispatch</code>、<code>startTransition</code>、异步回调等，进入调度。</li>
<li>调度：为更新分配车道（<code>Lane</code>），选择下一批工作（<code>getNextLanes</code>），安排回调。</li>
<li>Render（可中断）：自顶向下构建/复用 Fiber，Diff 得出宿主层变更与副作用列表；不会触碰 DOM。</li>
<li>Commit（不可中断）：原子化应用 DOM 变更，执行 layout 类副作用与 ref，保证可见更新的一致性。</li>
<li>绘制（Paint）：浏览器将提交的变更绘制到屏幕。</li>
<li>被动阶段（Passive）：在一个独立宏任务中异步冲洗 <code>useEffect</code>（HookPassive）的清理与安装，避免阻塞提交与布局。</li>
</ol>
<h3 data-id="heading-3">2.2 Commit 阶段的核心目标</h3>
<ol>
<li>原子应用宿主层变更：在一次不可中断的关键段内完成所有 DOM 插入/删除/属性更新，避免“半提交”导致的视觉撕裂。</li>
<li>正确的副作用时序：<code>useInsertionEffect</code> 在变更前、<code>useLayoutEffect</code> 清理于变更期/安装于布局期、类组件 <code>DidMount/DidUpdate</code> 与 ref 绑定于布局期。</li>
<li>界面一致性与可预期的读写：布局读/写必须发生在稳定的 DOM 状态上，确保测量与同步操作正确。</li>
<li>与调度器的配合：提交期间不让步、不给调度器插入中断，确保一个提交完成后再进入绘制与被动阶段。</li>
<li>产出后续异步工作：将 <code>useEffect</code> 的清理与安装延迟到绘制后，尽量降低对交互的阻塞。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 提交阶段的顺序（简化伪代码）</span>
<span class="hljs-title function_">commitBeforeMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// 变更前处理，如焦点/过渡</span>
<span class="hljs-title function_">commitMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// 应用 DOM 变更</span>
<span class="hljs-title function_">commitLayoutEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// ref、类组件、layout effect 安装</span>
<span class="hljs-comment">// 绘制发生在上述之后；随后进入被动阶段：</span>
<span class="hljs-title function_">flushPassiveEffects</span>(); <span class="hljs-comment">// useEffect 的清理和安装（异步宏任务）</span>
</code></pre>
<h2 data-id="heading-4">三、Commit 阶段源码关键函数解析</h2>
<h3 data-id="heading-5">3.1 入口函数：commitRoot</h3>
<h4 data-id="heading-6">3.1.1 角色定位：</h4>
<p>提交阶段的总调度器；将 Render 阶段完成的变更与副作用在宿主环境原子化应用。</p>
<h4 data-id="heading-7">3.1.2 核心特征：</h4>
<ol>
<li>不可中断：提交路径置位 <code>CommitContext</code>，不调用 <code>shouldYield</code>。</li>
<li>明确分期：严格依序执行 Before Mutation → Mutation → Layout。</li>
<li>提交后异步：被动副作用（<code>useEffect</code>）在一个后续宏任务中冲洗，避免阻塞交互。</li>
<li>关键职责（串联三子阶段并安排 Passive）：</li>
</ol>
<ul>
<li>冲刷潜在残留的被动效果，确保提交干净。</li>
<li>进入提交上下文并短期提升更新优先级到离散事件级别。</li>
<li>在 Mutation 结束后切换当前树：<code>root.current = finishedWork</code>。</li>
<li>调度并在绘制后冲洗被动副作用，设置合适的更新优先级。</li>
</ul>
<h4 data-id="heading-8">3.1.3 核心实现逻辑</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params">root, finishedWork, lanes <span class="hljs-comment">/* ... */</span></span>) {
  <span class="hljs-comment">// 先冲刷可能残留的被动效果，确保提交干净</span>
  <span class="hljs-keyword">do</span> {
    <span class="hljs-title function_">flushPendingEffects</span>();
  } <span class="hljs-keyword">while</span> (pendingEffectsStatus !== <span class="hljs-variable constant_">NO_PENDING_EFFECTS</span>);

  <span class="hljs-comment">// 设置提交阶段的性能标记与校验</span>
  <span class="hljs-comment">// ...</span>

  <span class="hljs-comment">// 安排被动效果（Passive）后续冲洗（必要时）</span>
  <span class="hljs-keyword">if</span> (
    (finishedWork.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">PassiveMask</span>) !== <span class="hljs-title class_">NoFlags</span> ||
    (finishedWork.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">PassiveMask</span>) !== <span class="hljs-title class_">NoFlags</span>
  ) {
    <span class="hljs-comment">// 常规：调度一个普通优先级任务执行 flushPassiveEffects</span>
    root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
    root.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoLane</span>;
    <span class="hljs-title function_">scheduleCallback</span>(<span class="hljs-title class_">NormalSchedulerPriority</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">flushPassiveEffects</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    });
  } <span class="hljs-keyword">else</span> {
    root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
    root.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoLane</span>;
  }

  <span class="hljs-comment">// Before Mutation 子阶段（提交上下文 + 提升优先级）</span>
  <span class="hljs-keyword">if</span> (hasBeforeMutationEffects) {
    <span class="hljs-keyword">const</span> prev = <span class="hljs-title function_">getCurrentUpdatePriority</span>();
    <span class="hljs-title function_">setCurrentUpdatePriority</span>(<span class="hljs-title class_">DiscreteEventPriority</span>); <span class="hljs-comment">// 提交路径短期提升为离散优先级</span>
    <span class="hljs-keyword">const</span> prevCtx = executionContext;
    executionContext |= <span class="hljs-title class_">CommitContext</span>; <span class="hljs-comment">// 进入提交上下文</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">commitBeforeMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// DOM 读前置与快照</span>
    } <span class="hljs-keyword">finally</span> {
      executionContext = prevCtx;
      <span class="hljs-title function_">setCurrentUpdatePriority</span>(prev);
    }
  }

  <span class="hljs-keyword">if</span> (!startedViewTransition) {
    <span class="hljs-title function_">flushMutationEffects</span>(); <span class="hljs-comment">// 执行 DOM 增删改</span>
    <span class="hljs-title function_">flushLayoutEffects</span>(); <span class="hljs-comment">// 执行 useLayoutEffect、更新 ref 等</span>
    <span class="hljs-title function_">flushSpawnedWork</span>(); <span class="hljs-comment">// 提交后异步执行 flushPassiveEffects</span>
  }
}
</code></pre>
<h4 data-id="heading-9">3.1.4 示例：一次“点击打开弹层”的完整提交与副作用时序</h4>
<p>以下示例展示一次离散事件（<code>click</code>）触发的更新如何穿越三个子阶段，以及绘制后的被动副作用如何执行与设定优先级。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">DialogExample</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [open, setOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> dialogRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// Layout 阶段执行：此处可安全测量并同步读写 DOM</span>
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (open &amp;&amp; dialogRef.<span class="hljs-property">current</span>) {
      <span class="hljs-comment">// 运行于 Layout 子阶段：DOM 已变更且稳定</span>
      <span class="hljs-keyword">const</span> rect = dialogRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>(); <span class="hljs-comment">// 同步测量</span>
      <span class="hljs-comment">// 例如根据尺寸定位弹层</span>
      dialogRef.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${rect.bottom + <span class="hljs-number">8</span>}</span>px`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 下次提交时，Layout 清理发生在 Mutation 之前（避免脏读）</span>
      <span class="hljs-comment">// 可在这里撤销同步副作用（如绑定的同步事件等）</span>
    };
  }, [open]);

  <span class="hljs-comment">// Passive 阶段执行：绘制后再执行，避免阻塞提交/布局</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!open) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 示例：给窗口添加滚动监听，滚动时关闭弹层</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onScroll</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 注意：此处 setState 的更新优先级由 Passive 阶段设定：</span>
      <span class="hljs-comment">// priority = lowerEventPriority(DefaultEventPriority, lanesToEventPriority(pendingEffectsLanes))</span>
      <span class="hljs-comment">// 通常为 Default；如果本次渲染包含 Idle 等更低优先级，效果更新也会更低</span>
      <span class="hljs-title function_">setOpen</span>(<span class="hljs-literal">false</span>);
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"scroll"</span>, onScroll);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"scroll"</span>, onScroll); <span class="hljs-comment">// Passive 清理</span>
  }, [open]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
          setOpen(true); // 离散事件入口（click）：触发一次高优先级更新
        }}
      &gt;
        打开弹层
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {open &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{dialogRef}</span>&gt;</span>
          弹层内容（Layout 效果会在提交后立刻测量并定位）
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>时间线解读：</p>
<ul>
<li>Before Mutation：读取现有焦点/选择，准备快照与过渡信息；不触碰 DOM。</li>
<li>Mutation：插入弹层节点、属性写入、可能的宿主层重置；随后 <code>root.current = finishedWork</code>。</li>
<li>Layout：执行 <code>useLayoutEffect</code> 清理与安装、类组件 <code>DidMount/DidUpdate</code>、<code>ref</code> 绑定；支持同步测量。</li>
<li>Paint：浏览器将变更绘制到屏幕（用户现在看到弹层）。</li>
<li>Passive：宏任务中冲洗 <code>useEffect</code> 清理与安装，此处绑定滚动监听；若滚动触发 <code>setOpen(false)</code>，该更新优先级不会高于 <code>DefaultEventPriority</code>，并可能更低（比如渲染包含 Idle 车道时）。</li>
</ul>
<h4 data-id="heading-10">3.1.5 commit 流程图</h4>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e598a5638d94a1f8bbe0e34657d1d82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF5MQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767531584&amp;x-signature=pxuCES90zR8nI69uYbooqIHP0B0%3D" alt="7-2.png" loading="lazy"/></p>
<h3 data-id="heading-11">3.2 子阶段一：Before Mutation</h3>
<p>简单说，这个阶段的核心是：在 DOM 发生任何增删改之前，先完成 “读状态” 和 “做准备” 的工作—— 比如记录 DOM 快照、处理焦点，避免后续 DOM 变更破坏这些需要的信息，确保数据和交互的一致性。</p>
<h4 data-id="heading-12">3.2.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：DOM 变更前，安全读取当前页面状态（如滚动位置、焦点元素、选择的文本），执行前置准备（如快照、焦点处理）。</li>
<li>关键时机：在 Mutation 阶段（实际改 DOM）之前，且整个过程同步执行、不可中断。</li>
<li>为什么要单独分这个阶段：如果先改 DOM 再读状态，拿到的就是变更后的数据，可能导致逻辑错误（比如想记录列表滚动位置，结果 DOM 先更新了，滚动位置变了）。</li>
</ol>
<h4 data-id="heading-13">3.2.2 核心实现逻辑</h4>
<p>commitBeforeMutationEffects 先初始化提交环境（获取聚焦实例句柄、判断视图过渡场景），通过 commitBeforeMutationEffects_begin 以深度优先方式遍历 Fiber 树，先处理待删除子节点的提交前副作用，有子节点且子树含相关副作用标记则深入遍历，无子节点则记录视图过渡状态并切换到兄弟 / 父节点；遍历过程中通过 commitBeforeMutationEffects_onFiber 处理单个节点逻辑，包括焦点在隐藏 Suspense 边界内的失焦处理、类组件 getSnapshotBeforeUpdate 快照执行、根节点容器清空等，全程在 DOM 变更前完成，为后续 Mutation 阶段做准备，执行完毕后清理环境状态。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitBeforeMutationEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  firstChild: Fiber,
  committedLanes: Lanes
</span>): <span class="hljs-keyword">void</span> {
  focusedInstanceHandle = <span class="hljs-title function_">prepareForCommit</span>(root.<span class="hljs-property">containerInfo</span>);
  shouldFireAfterActiveInstanceBlur = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">const</span> isViewTransitionEligible =
    enableViewTransition &amp;&amp;
    <span class="hljs-title function_">includesOnlyViewTransitionEligibleLanes</span>(committedLanes);

  <span class="hljs-comment">// 初始化副作用遍历指针，指向待处理的第一个 Fiber 节点</span>
  nextEffect = firstChild;
  <span class="hljs-comment">// 开始执行提交前阶段核心逻辑</span>
  <span class="hljs-title function_">commitBeforeMutationEffects_begin</span>(isViewTransitionEligible);

  focusedInstanceHandle = <span class="hljs-literal">null</span>;
  <span class="hljs-title function_">resetAppearingViewTransitions</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitBeforeMutationEffects_begin</span>(<span class="hljs-params">isViewTransitionEligible: boolean</span>) {
  <span class="hljs-comment">// 确定副作用掩码：视图过渡场景用专用掩码，否则用默认提交前掩码</span>
  <span class="hljs-keyword">const</span> subtreeMask = isViewTransitionEligible
    ? <span class="hljs-title class_">BeforeAndAfterMutationTransitionMask</span>
    : <span class="hljs-title class_">BeforeMutationMask</span>;

  <span class="hljs-comment">// 遍历副作用链表（nextEffect 驱动）</span>
  <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> fiber = nextEffect;

    <span class="hljs-comment">// 先处理 deletions：父→子</span>
    <span class="hljs-keyword">if</span> (enableCreateEventHandleAPI || isViewTransitionEligible) {
      <span class="hljs-keyword">const</span> deletions = fiber.<span class="hljs-property">deletions</span>;
      <span class="hljs-keyword">if</span> (deletions !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; deletions.<span class="hljs-property">length</span>; i++) {
          <span class="hljs-title function_">commitBeforeMutationEffectsDeletion</span>(
            deletions[i],
            isViewTransitionEligible
          );
        }
      }
    }

    <span class="hljs-comment">// 隐藏子树优化（Offscreen/Suspense）与视图过渡特殊处理</span>
    <span class="hljs-keyword">if</span> (enableViewTransition &amp;&amp; fiber.<span class="hljs-property">tag</span> === <span class="hljs-title class_">OffscreenComponent</span>) {
      <span class="hljs-comment">// 根据隐藏/显现状态跳过或特殊遍历</span>
      <span class="hljs-title function_">commitBeforeMutationEffects_complete</span>(isViewTransitionEligible);
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">const</span> child = fiber.<span class="hljs-property">child</span>;
    <span class="hljs-comment">// 有子节点且子树含提交前副作用标记：深入子节点遍历（深度优先）</span>
    <span class="hljs-keyword">if</span> ((fiber.<span class="hljs-property">subtreeFlags</span> &amp; subtreeMask) !== <span class="hljs-title class_">NoFlags</span> &amp;&amp; child !== <span class="hljs-literal">null</span>) {
      child.<span class="hljs-property">return</span> = fiber;
      nextEffect = child;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (isViewTransitionEligible) {
        <span class="hljs-comment">// 视图过渡：记录子树内变更前状态</span>
        <span class="hljs-title function_">commitNestedViewTransitions</span>(fiber);
      }
      <span class="hljs-comment">// 完成当前节点处理，切换到兄弟/父节点</span>
      <span class="hljs-title function_">commitBeforeMutationEffects_complete</span>(isViewTransitionEligible);
    }
  }
}

<span class="hljs-comment">// 处理单个 Fiber 节点的提交前副作用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitBeforeMutationEffects_onFiber</span>(<span class="hljs-params">
  finishedWork: Fiber,
  isViewTransitionEligible: boolean
</span>) {
  <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;

  <span class="hljs-comment">// 焦点在隐藏边界内的处理</span>
  <span class="hljs-keyword">if</span> (enableCreateEventHandleAPI) {
    <span class="hljs-keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (
        finishedWork.<span class="hljs-property">tag</span> === <span class="hljs-title class_">SuspenseComponent</span> &amp;&amp;
        <span class="hljs-title function_">isSuspenseBoundaryBeingHidden</span>(current, finishedWork) &amp;&amp;
        <span class="hljs-title function_">doesFiberContain</span>(finishedWork, focusedInstanceHandle)
      ) {
        shouldFireAfterActiveInstanceBlur = <span class="hljs-literal">true</span>;
        <span class="hljs-title function_">beforeActiveInstanceBlur</span>(finishedWork); <span class="hljs-comment">//  // 执行活跃实例失焦前回调</span>
      }
    }
  }

  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-keyword">if</span> ((flags &amp; <span class="hljs-title class_">Snapshot</span>) !== <span class="hljs-title class_">NoFlags</span> &amp;&amp; current !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 类组件：存在 Snapshot 标记且有旧节点，执行快照逻辑（如 getSnapshotBeforeUpdate）</span>
        <span class="hljs-title function_">commitClassSnapshot</span>(finishedWork, current);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>: {
      <span class="hljs-comment">// 根节点：存在 Snapshot 标记，清空容器（DOM 变更前准备）</span>
      <span class="hljs-keyword">if</span> ((flags &amp; <span class="hljs-title class_">Snapshot</span>) !== <span class="hljs-title class_">NoFlags</span>) {
        <span class="hljs-keyword">if</span> (supportsMutation) {
          <span class="hljs-keyword">const</span> root = finishedWork.<span class="hljs-property">stateNode</span>;
          <span class="hljs-title function_">clearContainer</span>(root.<span class="hljs-property">containerInfo</span>);
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>: {
      <span class="hljs-comment">// useEffectEvent：更新事件实现引用（非 DOM 快照）</span>
      <span class="hljs-comment">// 省略具体细节</span>
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-attr">default</span>: {
      <span class="hljs-keyword">if</span> ((flags &amp; <span class="hljs-title class_">Snapshot</span>) !== <span class="hljs-title class_">NoFlags</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Unexpected Snapshot flag for this fiber tag."</span>);
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-14">3.3 子阶段二：Mutation</h3>
<p>Mutation 阶段是 React 真正 “动手修改 DOM” 的阶段，核心任务是将 Render 阶段计算出的 DOM 变更（插入、删除、更新）应用到真实 DOM 上，同时完成旧 Ref 解绑、宿主状态清理等关键操作。这一阶段的操作直接影响用户可见的界面，且全程同步执行、不可中断。</p>
<h4 data-id="heading-15">3.3.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：执行真实 DOM 操作（插入新节点、删除旧节点、更新属性 / 文本），并完成与 DOM 变更相关的前置清理（如旧 Ref 解绑）。</li>
<li>关键时机：在 Before Mutation 阶段（读状态）之后，Layout 阶段（读新 DOM 状态）之前，是 “写 DOM” 的唯一阶段。</li>
<li>为什么重要：这是虚拟 DOM 映射到真实 DOM 的 “最后一步”，所有 Render 阶段的计算结果在此落地，直接决定用户看到的界面。</li>
</ol>
<h4 data-id="heading-16">3.3.2 核心实现逻辑</h4>
<ol>
<li>和 Before Mutation 阶段类似，Mutation 阶段也需要确保操作不被打断，因此会先切换到高优先级环境，会调用<code>commitMutationEffectsOnFiber</code> 来递归处理 <code>finishedWork</code> 树。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> prev = <span class="hljs-title function_">getCurrentUpdatePriority</span>();
<span class="hljs-title function_">setCurrentUpdatePriority</span>(<span class="hljs-title class_">DiscreteEventPriority</span>);
<span class="hljs-keyword">const</span> prevCtx = executionContext;
executionContext |= <span class="hljs-title class_">CommitContext</span>;
<span class="hljs-keyword">try</span> {
  <span class="hljs-title function_">commitMutationEffects</span>(root, finishedWork, lanes); <span class="hljs-comment">// 核心：执行所有 DOM 变更操作</span>
  <span class="hljs-title function_">resetAfterCommit</span>(root.<span class="hljs-property">containerInfo</span>); <span class="hljs-comment">// 宿主层收尾</span>
} <span class="hljs-keyword">finally</span> {
  executionContext = prevCtx;
  <span class="hljs-title function_">setCurrentUpdatePriority</span>(prev);
}

<span class="hljs-comment">// 关键：DOM 变更完成后，切换当前 Fiber 树（旧树 → 新树）</span>
root.<span class="hljs-property">current</span> = finishedWork;
<span class="hljs-comment">// 标记进入下一阶段（Layout 阶段）</span>
pendingEffectsStatus = <span class="hljs-variable constant_">PENDING_LAYOUT_PHASE</span>;
</code></pre>
<ol start="2">
<li><code>commitMutationEffectsOnFiber</code> 是实际执行副作用的核心。它会根据 <code>fiber.flags</code> 的不同，执行相应的操作。其基本流程是 “自上而下” 递归，但处理副作用的顺序有所不同。</li>
</ol>
<p>首先处理 <code>deletions</code>，在遍历子节点之前，优先处理当前 Fiber 节点上标记为 <code>ChildDeletion</code> 的所有待删除子节点。这确保了在执行其他变更前，旧的 DOM 节点已被移除；然后递归子节点：如果子树中存在 <code>MutationMask</code> 标记的变更，则继续向下遍历，对每个子节点调用 <code>commitMutationEffectsOnFiber</code>；在递归回到当前 Fiber 后，处理自身的副作用。例如，对于 <code>HostComponent</code>，会根据 <code>flags</code> 执行 <code>commitHostUpdate</code>（更新属性）或 <code>commitHostPlacement</code>（插入 DOM 树）。对于函数组件，会在这里触发 <code>useInsertionEffect</code> 的销毁和创建回调。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitMutationEffectsOnFiber</span>(<span class="hljs-params">
  finishedWork: Fiber,
  root: FiberRoot,
  lanes: Lanes
</span>) {
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;

  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 递归处理子节点的 Mutation Effects</span>
      <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);
      <span class="hljs-comment">// 处理当前节点的 Placement (插入)</span>
      <span class="hljs-title function_">commitReconciliationEffects</span>(finishedWork);

      <span class="hljs-comment">// 3. 如果有 Update 标记 (通常由 Hook 副作用引起)</span>
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-comment">// 卸载之前的插入副作用钩子 (useInsertionEffect)</span>
        <span class="hljs-title function_">commitHookEffectListUnmount</span>(
          <span class="hljs-title class_">HookInsertion</span> | <span class="hljs-title class_">HookHasEffect</span>,
          finishedWork,
          finishedWork.<span class="hljs-property">return</span>
        );
        <span class="hljs-comment">// 挂载新的插入副作用钩子 (useInsertionEffect)</span>
        <span class="hljs-title function_">commitHookEffectListMount</span>(<span class="hljs-title class_">HookInsertion</span> | <span class="hljs-title class_">HookHasEffect</span>, finishedWork);
        <span class="hljs-comment">// 卸载之前的插入副作用钩子 (useLayoutEffect)</span>
        <span class="hljs-title function_">commitHookLayoutUnmountEffects</span>(
          finishedWork,
          finishedWork.<span class="hljs-property">return</span>,
          <span class="hljs-title class_">HookLayout</span> | <span class="hljs-title class_">HookHasEffect</span>
        );、
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);
      <span class="hljs-title function_">commitReconciliationEffects</span>(finishedWork);

      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-comment">// 解绑旧的 ref</span>
        <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>;
        <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span>) {
          <span class="hljs-title function_">safelyDetachRef</span>(current, current.<span class="hljs-property">return</span>);
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// DOM 元素</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(root, finishedWork, lanes);
      <span class="hljs-title function_">commitReconciliationEffects</span>(finishedWork);

      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>;
        <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span>) {
          <span class="hljs-title function_">safelyDetachRef</span>(current, current.<span class="hljs-property">return</span>);
        }
      }

      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-keyword">const</span> instance = finishedWork.<span class="hljs-property">stateNode</span>;
        <span class="hljs-keyword">if</span> (instance != <span class="hljs-literal">null</span>) {
          <span class="hljs-comment">// 应用 DOM 属性更新</span>
          <span class="hljs-keyword">const</span> newProps = finishedWork.<span class="hljs-property">memoizedProps</span>;
          <span class="hljs-keyword">const</span> oldProps = current !== <span class="hljs-literal">null</span> ? current.<span class="hljs-property">memoizedProps</span> : newProps;
          <span class="hljs-keyword">const</span> type = finishedWork.<span class="hljs-property">type</span>;
          <span class="hljs-keyword">const</span> updatePayload = finishedWork.<span class="hljs-property">updateQueue</span>;
          finishedWork.<span class="hljs-property">updateQueue</span> = <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">if</span> (updatePayload) {
            <span class="hljs-comment">// 调用 commitHostUpdate 执行 DOM 更新</span>
            <span class="hljs-title function_">commitHostUpdate</span>(
              instance,
              updatePayload,
              type,
              oldProps,
              newProps,
              finishedWork
            );
          }
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// ... 其他类型的 Fiber</span>
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraverseMutationEffects</span>(<span class="hljs-params">root, parentFiber, lanes</span>) {
  <span class="hljs-comment">// 优先处理删除</span>
  <span class="hljs-keyword">const</span> deletions = parentFiber.<span class="hljs-property">deletions</span>;
  <span class="hljs-keyword">if</span> (deletions !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; deletions.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> childToDelete = deletions[i];
      <span class="hljs-title function_">commitDeletionEffects</span>(root, parentFiber, childToDelete);
    }
  }

  <span class="hljs-comment">// 递归处理子节点</span>
  <span class="hljs-keyword">if</span> (parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">MutationMask</span>) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">commitMutationEffectsOnFiber</span>(child, root, lanes);
      child = child.<span class="hljs-property">sibling</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-17">3.4 子阶段三：Layout</h3>
<p>Layout 阶段是提交过程中 DOM 稳定后、被动副作用执行前的关键环节，核心目标是处理需要依赖完整 DOM 状态的同步操作，同时完成组件生命周期与 ref 的最终绑定。</p>
<h4 data-id="heading-18">3.4.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：在 DOM 状态稳定后同步处理依赖 DOM 的布局操作、生命周期回调与 ref 绑定。</li>
<li>关键时机：Mutation 阶段（DOM 增删改）之后、被动副作用（如 useEffect）之前。</li>
<li>为什么重要：为需要即时获取 / 操作最新 DOM 状态的场景提供同步执行环境，同时保证相关逻辑的执行时序与 DOM 状态一致性。</li>
</ol>
<h4 data-id="heading-19">3.4.2 核心实现逻辑</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffects</span>(<span class="hljs-params">
  finishedWork: Fiber,
  root: FiberRoot,
  committedLanes: Lanes
</span>): <span class="hljs-keyword">void</span> {
  nProgressLanes = committedLanes; <span class="hljs-comment">// 记录当前处理的优先级车道</span>
  inProgressRoot = root; <span class="hljs-comment">// 记录当前根节点</span>

  <span class="hljs-title function_">resetComponentEffectTimers</span>(); <span class="hljs-comment">// 重置组件副作用计时器</span>

  <span class="hljs-keyword">const</span> current = finishedWork.<span class="hljs-property">alternate</span>; <span class="hljs-comment">// 获取旧 Fiber 节点（current 树）</span>
  <span class="hljs-comment">// 处理当前 Fiber 节点的布局副作用</span>
  <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(root, current, finishedWork, committedLanes);

  inProgressLanes = <span class="hljs-literal">null</span>;
  inProgressRoot = <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  parentFiber: Fiber,
  lanes: Lanes
</span>) {
  <span class="hljs-comment">// 若子树存在布局副作用标记，才遍历子节点</span>
  <span class="hljs-keyword">if</span> (parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">LayoutMask</span>) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> current = child.<span class="hljs-property">alternate</span>;
      <span class="hljs-comment">// 处理子节点的布局副作用</span>
      <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(root, current, child, lanes);
      child = child.<span class="hljs-property">sibling</span>; <span class="hljs-comment">// 遍历兄弟节点</span>
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(<span class="hljs-params">
  finishedRoot: FiberRoot,
  current: Fiber | <span class="hljs-literal">null</span>,
  finishedWork: Fiber,
  committedLanes: Lanes
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;
  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树布局副作用</span>
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-comment">// 若节点有更新标记，执行 useLayoutEffect 回调</span>
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-title function_">commitHookLayoutEffects</span>(finishedWork, <span class="hljs-title class_">HookLayout</span> | <span class="hljs-title class_">HookHasEffect</span>);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树</span>
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-comment">// 若有更新，调用类组件生命周期（componentDidMount/Update）</span>
        <span class="hljs-title function_">commitClassLayoutLifecycles</span>(finishedWork, current);
      }
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Callback</span>) {
        <span class="hljs-comment">// 处理回调（如 setState 的第二个参数）</span>
        <span class="hljs-title function_">commitClassCallbacks</span>(finishedWork);
      }
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-comment">// 绑定 ref</span>
        <span class="hljs-title function_">safelyAttachRef</span>(finishedWork, finishedWork.<span class="hljs-property">return</span>);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (current === <span class="hljs-literal">null</span> &amp;&amp; flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-comment">// 初次挂载时执行额外逻辑（如输入框聚焦）</span>
        <span class="hljs-title function_">commitHostMount</span>(finishedWork);
      }
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
        <span class="hljs-title function_">safelyAttachRef</span>(finishedWork, finishedWork.<span class="hljs-property">return</span>);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>: {
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Callback</span>) {
        <span class="hljs-comment">// 处理根节点回调（如 ReactDOM.render 的回调）</span>
        <span class="hljs-title function_">commitRootCallbacks</span>(finishedWork);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// 性能分析节点</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Profiler</span>: {
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
          finishedRoot,
          finishedWork,
          committedLanes
        );
        <span class="hljs-title function_">commitProfilerUpdate</span>(
          finishedWork,
          current,
          commitStartTime,
          finishedWork.<span class="hljs-property">stateNode</span>.<span class="hljs-property">effectDuration</span>
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
          finishedRoot,
          finishedWork,
          committedLanes
        );
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseComponent</span>: {
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
        <span class="hljs-title function_">commitSuspenseHydrationCallbacks</span>(finishedRoot, finishedWork);
      }
      <span class="hljs-comment">// Callback 注册逻辑略</span>
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">OffscreenComponent</span>: {
      <span class="hljs-comment">// 隐藏时跳过；重新显现时使用 reappear 递归；否则正常递归</span>
      <span class="hljs-comment">// 细节见源码的可见性与上下文切换逻辑</span>
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-attr">default</span>: {
      <span class="hljs-comment">// 其他类型节点默认递归处理子树</span>
      <span class="hljs-title function_">recursivelyTraverseLayoutEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes
      );
      <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-20">3.5 被动阶段（Passive Effects）</h3>
<p>被动阶段是 Commit 阶段的最后一个子阶段，核心负责执行 useEffect 相关逻辑（清理 + 回调）。其设计核心是不阻塞 DOM 渲染与用户交互，将非紧急副作用延迟到浏览器绘制后异步执行，平衡性能与开发体验。</p>
<h4 data-id="heading-21">3.5.1 核心目标与执行时机</h4>
<ol>
<li>核心目标：在不阻塞 DOM 渲染与用户交互的前提下，安全执行非紧急异步副作用。</li>
<li>关键时机：本次提交的 Fiber 树或其子树包含 Passive 副作用标记（flags/subtreeFlags &amp; PassiveMask）时，useEffect 会在布局完成且浏览器完成绘制后通过后续的非阻塞调度执行。</li>
</ol>
<h4 data-id="heading-22">3.5.2 核心实现逻辑</h4>
<p>先通过 flushPassiveEffects 校验阶段状态、取出提交数据，将渲染车道映射为不高于 Default 的更新优先级并保护原始上下文，再调用 flushPassiveEffectsImpl 做重入保护并进入提交上下文，随后按 “先卸载后挂载” 顺序，通过 commitPassiveUnmountEffects 递归遍历 Fiber 树执行 useEffect 清理函数（含被删除子树的副作用清理、离线组件的断开逻辑），再通过 commitPassiveMountEffects 递归遍历执行 useEffect 回调函数（含视图过渡场景适配、离线 / 根节点等特殊类型 Fiber 的差异化处理），全程同步串行且不阻塞 DOM 渲染与用户交互，执行完毕后恢复原始上下文并释放资源。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushPassiveEffects</span>(<span class="hljs-params">wasDelayedCommit?: boolean</span>): boolean {
  <span class="hljs-keyword">if</span> (pendingEffectsStatus !== <span class="hljs-variable constant_">PENDING_PASSIVE_PHASE</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">const</span> root = pendingEffectsRoot;
  <span class="hljs-keyword">const</span> remainingLanes = pendingEffectsRemainingLanes;
  pendingEffectsRemainingLanes = <span class="hljs-title class_">NoLanes</span>;

  <span class="hljs-comment">// 计算被动阶段的更新优先级：不高于Default，避免抢占高优任务</span>
  <span class="hljs-keyword">const</span> renderPriority = <span class="hljs-title function_">lanesToEventPriority</span>(pendingEffectsLanes); <span class="hljs-comment">// 渲染车道转事件优先级</span>
  <span class="hljs-keyword">const</span> priority = <span class="hljs-title function_">lowerEventPriority</span>(<span class="hljs-title class_">DefaultEventPriority</span>, renderPriority); <span class="hljs-comment">// 取较低优先级</span>

  <span class="hljs-keyword">const</span> prevTransition = <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span>;
  <span class="hljs-keyword">const</span> previousPriority = <span class="hljs-title function_">getCurrentUpdatePriority</span>();

  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">setCurrentUpdatePriority</span>(priority);
    <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">flushPassiveEffectsImpl</span>(wasDelayedCommit); <span class="hljs-comment">// 执行副作用核心逻辑</span>
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-title function_">setCurrentUpdatePriority</span>(previousPriority);
    <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">T</span> = prevTransition;
    <span class="hljs-title function_">releaseRootPooledCache</span>(root, remainingLanes);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushPassiveEffectsImpl</span>(<span class="hljs-params">wasDelayedCommit: <span class="hljs-keyword">void</span> | boolean</span>) {
  <span class="hljs-keyword">const</span> transitions = pendingPassiveTransitions;
  pendingPassiveTransitions = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> root = pendingEffectsRoot;
  <span class="hljs-keyword">const</span> lanes = pendingEffectsLanes;
  pendingEffectsStatus = <span class="hljs-variable constant_">NO_PENDING_EFFECTS</span>;
  pendingEffectsRoot = (<span class="hljs-attr">null</span>: any);
  pendingFinishedWork = (<span class="hljs-attr">null</span>: any);
  pendingEffectsLanes = <span class="hljs-title class_">NoLanes</span>;

  <span class="hljs-keyword">if</span> ((executionContext &amp; (<span class="hljs-title class_">RenderContext</span> | <span class="hljs-title class_">CommitContext</span>)) !== <span class="hljs-title class_">NoContext</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Cannot flush passive effects while already rendering."</span>);
  }

  <span class="hljs-keyword">const</span> prevExecutionContext = executionContext;
  executionContext |= <span class="hljs-title class_">CommitContext</span>;

  <span class="hljs-comment">// 严格执行顺序：先卸载（清理旧副作用），后挂载（执行新回调）</span>
  <span class="hljs-title function_">commitPassiveUnmountEffects</span>(root.<span class="hljs-property">current</span>); <span class="hljs-comment">// 执行useEffect清理函数</span>
  <span class="hljs-comment">// 执行useEffect回调函数</span>
  <span class="hljs-title function_">commitPassiveMountEffects</span>(
    root,
    root.<span class="hljs-property">current</span>,
    lanes,
    transitions,
    pendingEffectsRenderEndTime
  );

  executionContext = prevExecutionContext;
}

<span class="hljs-comment">// ReactFiberCommitWork.js — 卸载入口与遍历</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveUnmountEffects</span>(<span class="hljs-params">finishedWork: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-title function_">resetComponentEffectTimers</span>();
  <span class="hljs-title function_">commitPassiveUnmountOnFiber</span>(finishedWork); <span class="hljs-comment">// 开始处理单个Fiber节点的卸载逻辑</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(<span class="hljs-params">parentFiber: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> deletions = parentFiber.<span class="hljs-property">deletions</span>; <span class="hljs-comment">// 待删除的子节点列表</span>
  <span class="hljs-comment">// 若父节点有子删除标记且存在待删除节点，处理被删除子树的卸载</span>
  <span class="hljs-keyword">if</span> ((parentFiber.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">ChildDeletion</span>) !== <span class="hljs-title class_">NoFlags</span> &amp;&amp; deletions !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; deletions.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> childToDelete = deletions[i]; <span class="hljs-comment">// 待删除的子节点</span>
      nextEffect = childToDelete; <span class="hljs-comment">// 标记当前处理的副作用节点</span>
      <span class="hljs-comment">// 处理被删除子树的被动卸载（深度优先遍历）</span>
      <span class="hljs-title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(
        childToDelete,
        parentFiber
      );
    }
    <span class="hljs-title function_">detachAlternateSiblings</span>(parentFiber); <span class="hljs-comment">// 分离旧Fiber树的兄弟节点引用，避免内存泄漏</span>
  }
  <span class="hljs-comment">// 若子树存在被动副作用标记，递归处理所有子节点</span>
  <span class="hljs-keyword">if</span> (parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; <span class="hljs-title class_">PassiveMask</span>) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">commitPassiveUnmountOnFiber</span>(child);
      child = child.<span class="hljs-property">sibling</span>;
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveUnmountOnFiber</span>(<span class="hljs-params">finishedWork: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树的卸载副作用</span>
      <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(finishedWork);
      <span class="hljs-keyword">if</span> (finishedWork.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">Passive</span>) {
        <span class="hljs-comment">// 若节点有被动副作用标记，执行useEffect清理函数</span>
        <span class="hljs-title function_">commitHookPassiveUnmountEffects</span>(
          finishedWork,
          finishedWork.<span class="hljs-property">return</span>,
          <span class="hljs-title class_">HookPassive</span> | <span class="hljs-title class_">HookHasEffect</span>
        );
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// 离线/隐藏组件</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">OffscreenComponent</span>: {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">OffscreenInstance</span> = finishedWork.<span class="hljs-property">stateNode</span>;
      <span class="hljs-keyword">const</span> isHidden = finishedWork.<span class="hljs-property">memoizedState</span> !== <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (
        isHidden &amp;&amp;
        instance.<span class="hljs-property">_visibility</span> &amp; <span class="hljs-title class_">OffscreenPassiveEffectsConnected</span> &amp;&amp;
        (finishedWork.<span class="hljs-property">return</span> === <span class="hljs-literal">null</span> ||
          finishedWork.<span class="hljs-property">return</span>.<span class="hljs-property">tag</span> !== <span class="hljs-title class_">SuspenseComponent</span>)
      ) {
        <span class="hljs-comment">// 隐藏子树：断开被动副作用连接</span>
        instance.<span class="hljs-property">_visibility</span> &amp;= ~<span class="hljs-title class_">OffscreenPassiveEffectsConnected</span>;
        <span class="hljs-title function_">recursivelyTraverseDisconnectPassiveEffects</span>(finishedWork);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(finishedWork);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-attr">default</span>: {
      <span class="hljs-title function_">recursivelyTraversePassiveUnmountEffects</span>(finishedWork);
      <span class="hljs-keyword">break</span>;
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveMountEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  finishedWork: Fiber,
  committedLanes: Lanes,
  committedTransitions: <span class="hljs-built_in">Array</span>&lt;Transition&gt; | <span class="hljs-literal">null</span>,
  renderEndTime: number
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-title function_">resetComponentEffectTimers</span>();
  <span class="hljs-comment">// 开始处理单个Fiber节点的挂载逻辑</span>
  <span class="hljs-title function_">commitPassiveMountOnFiber</span>(
    root,
    finishedWork,
    committedLanes,
    committedTransitions,
    renderEndTime
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(<span class="hljs-params">
  root: FiberRoot,
  parentFiber: Fiber,
  committedLanes: Lanes,
  committedTransitions: <span class="hljs-built_in">Array</span>&lt;Transition&gt; | <span class="hljs-literal">null</span>,
  endTime: number
</span>) {
  <span class="hljs-comment">// 判断是否为视图过渡 eligible 场景（仅包含视图过渡相关车道）</span>
  <span class="hljs-keyword">const</span> isViewTransitionEligible =
    enableViewTransition &amp;&amp;
    <span class="hljs-title function_">includesOnlyViewTransitionEligibleLanes</span>(committedLanes);
  <span class="hljs-comment">// 确定被动副作用掩码：视图过渡场景用专用掩码，否则用默认被动掩码</span>
  <span class="hljs-keyword">const</span> subtreeMask = isViewTransitionEligible
    ? <span class="hljs-title class_">PassiveTransitionMask</span>
    : <span class="hljs-title class_">PassiveMask</span>;

  <span class="hljs-comment">// 满足以下条件则遍历子节点：</span>
  <span class="hljs-comment">// 1. 子树存在对应被动副作用标记；</span>
  <span class="hljs-comment">// 2. 开启性能追踪且组件有渲染耗时，且子树结构变更（需重新执行副作用）</span>
  <span class="hljs-keyword">if</span> (
    parentFiber.<span class="hljs-property">subtreeFlags</span> &amp; subtreeMask ||
    (enableProfilerTimer &amp;&amp;
      enableComponentPerformanceTrack &amp;&amp;
      parentFiber.<span class="hljs-property">actualDuration</span> !== <span class="hljs-number">0</span> &amp;&amp;
      (parentFiber.<span class="hljs-property">alternate</span> === <span class="hljs-literal">null</span> ||
        parentFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">child</span> !== parentFiber.<span class="hljs-property">child</span>))
  ) {
    <span class="hljs-keyword">let</span> child = parentFiber.<span class="hljs-property">child</span>;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 处理单个子节点的被动挂载副作用</span>
      <span class="hljs-title function_">commitPassiveMountOnFiber</span>(
        root,
        child,
        committedLanes,
        committedTransitions,
        enableProfilerTimer &amp;&amp; enableComponentPerformanceTrack
          ? child.<span class="hljs-property">sibling</span> !== <span class="hljs-literal">null</span>
            ? ((child.<span class="hljs-property">sibling</span>.<span class="hljs-property">actualStartTime</span>: any): number)
            : endTime
          : <span class="hljs-number">0</span>
      );
      child = child.<span class="hljs-property">sibling</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isViewTransitionEligible) {
    <span class="hljs-title function_">restoreNestedViewTransitions</span>(parentFiber);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPassiveMountOnFiber</span>(<span class="hljs-params">
  finishedRoot: FiberRoot,
  finishedWork: Fiber,
  committedLanes: Lanes,
  committedTransitions: <span class="hljs-built_in">Array</span>&lt;Transition&gt; | <span class="hljs-literal">null</span>,
  endTime: number
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;
  <span class="hljs-keyword">switch</span> (finishedWork.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-comment">// 先递归处理子树的被动挂载副作用</span>
      <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes,
        committedTransitions,
        endTime
      );
      <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Passive</span>) {
        <span class="hljs-comment">// 安装 useEffect</span>
        <span class="hljs-title function_">commitHookPassiveMountEffects</span>(
          finishedWork,
          <span class="hljs-title class_">HookPassive</span> | <span class="hljs-title class_">HookHasEffect</span>
        );
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>: {
      <span class="hljs-keyword">const</span> prevEffectDuration = <span class="hljs-title function_">pushNestedEffectDurations</span>();
      <span class="hljs-comment">// 递归处理子树的被动挂载副作用</span>
      <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes,
        committedTransitions,
        endTime
      );
      <span class="hljs-keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) {
        finishedRoot.<span class="hljs-property">passiveEffectDuration</span> +=
          <span class="hljs-title function_">popNestedEffectDurations</span>(prevEffectDuration);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// ... existing code ...</span>
    <span class="hljs-attr">default</span>: {
      <span class="hljs-title function_">recursivelyTraversePassiveMountEffects</span>(
        finishedRoot,
        finishedWork,
        committedLanes,
        committedTransitions,
        endTime
      );
      <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h2 data-id="heading-23">四、实践启示</h2>
<h3 data-id="heading-24">4.1 Hook 与生命周期的正确选择</h3>
<p>理解各阶段时序后，能更精准地选择合适的 API，避免常见坑：
需在 DOM 变更前插入样式（CSS-in-JS 动态样式）→ 用 useInsertionEffect（Before Mutation 阶段执行，无 DOM 读取能力）；
需同步获取 DOM 尺寸、位置（如弹层定位）→ 用 useLayoutEffect（Layout 阶段执行，DOM 已稳定，支持同步读写）；
需绑定事件监听、发起异步请求（如数据拉取、滚动监听）→ 用 useEffect（Passive 阶段执行，不阻塞渲染与交互）；
类组件场景：getSnapshotBeforeUpdate 对应 Before Mutation 阶段（读快照），componentDidMount/componentDidUpdate 对应 Layout 阶段（操作 DOM）。</p>
<h3 data-id="heading-25">4.2 常见问题与解决方案</h3>
<p>坑 1：在 useEffect 中同步操作 DOM 后立即测量 → 可能触发强制重排。
解决：需同步测量用 useLayoutEffect，异步操作用 useEffect。
坑 2：Ref 引用在组件挂载后立即访问为 null → 误解 Ref 绑定时机。
解决：Ref 绑定在 Layout 阶段，可在 useLayoutEffect 或 useEffect 中访问（前者同步，后者异步）。</p>
<h3 data-id="heading-26">4.3 借力 Commit 阶段的设计理念</h3>
<p>优先使用 useEffect 而非同步副作用：将非紧急操作推迟到绘制后，减少对主线程的阻塞；
避免在 Layout 阶段执行 heavy 计算：该阶段同步执行，耗时操作会直接影响界面响应速度；
合理使用 startTransition：将低优先级更新标记为过渡任务，React 会在调度时避开高优先级交互（如输入、点击），避免阻塞 Commit 阶段。</p>
<h2 data-id="heading-27">五、最后</h2>
<p>深入理解 Commit 阶段的三子阶段（Before Mutation → Mutation → Layout）及被动阶段（Passive Effects），不仅能帮我们看透 React 渲染的底层逻辑，更能指导开发中写出更高效、无隐患的代码 —— 毕竟很多性能问题、时序 Bug 都源于对副作用执行时机的误解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>