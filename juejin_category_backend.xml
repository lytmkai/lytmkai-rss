<?xml version="1.0" encoding="UTF-8"?><rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>掘金 后端</title><link>https://juejin.cn/backend</link><atom:link href="http://10.0.0.5:1200/juejin/category/backend" rel="self" type="application/rss+xml"></atom:link><description>掘金 后端 - Powered by RSSHub</description><generator>RSSHub</generator><webMaster>contact@rsshub.app (RSSHub)</webMaster><language>en</language><lastBuildDate>Wed, 14 Jan 2026 06:13:41 GMT</lastBuildDate><ttl>5</ttl><item><title>JWT鉴权的实现：从原理到 Django + Vue3</title><description>一、什么是 JWT？ 1&amp;nbsp;JWT 的基本概念 JWT（JSON Web&amp;nbsp;Token）是一种开放标准（RFC 7519），用于在各方之间安全地传输信息。它由三部分组成，用点号（.）分隔： 一个典型的 J</description><link>https://juejin.cn/post/7594745643892457507</link><guid isPermaLink="false">https://juejin.cn/post/7594745643892457507</guid><pubDate>Wed, 14 Jan 2026 05:39:01 GMT</pubDate><author>Java水解</author><category>后端</category><category>Django</category></item><item><title>性能突破：星图平台架构优化</title><description>随着货拉拉业务的快速扩展与场景复杂度的提升，星图平台作为客服系统的核心枢纽，不仅承载高并发场景下的关键功能，还肩负着保障服务稳定与用户体验的重任。</description><link>https://juejin.cn/post/7594731175405518888</link><guid isPermaLink="false">https://juejin.cn/post/7594731175405518888</guid><pubDate>Wed, 14 Jan 2026 05:38:39 GMT</pubDate><author>货拉拉技术</author><category>后端</category></item><item><title>猿辅导二面：线上出现的OOM是如何排查的？</title><description>&lt;p&gt;&lt;strong&gt;文章内容收录到个人网站，方便阅读&lt;/strong&gt;：&lt;a href=&quot;https://link.juejin.cn/?target=http%3A%2F%2Fhardyfish.top%2F&quot; target=&quot;_blank&quot; title=&quot;http://hardyfish.top/&quot; ref=&quot;nofollow noopener noreferrer&quot;&gt;hardyfish.top/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;看是哪种OOM?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;看报错信息/监控/容器事件，区分类型，不同解法完全不一样。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Java heap&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;java.lang.OutOfMemoryError: Java heap space&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;GC overhead limit exceeded&lt;/code&gt;（一直 GC 但回收极少）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Direct/Off-heap&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;java.lang.OutOfMemoryError: Direct buffer memory&lt;/code&gt;（NIO/Netty/ByteBuffer）&lt;/li&gt;
&lt;li&gt;原生内存耗尽（JNA、压缩、TLS、线程栈等）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Metaspace&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;java.lang.OutOfMemoryError: Metaspace&lt;/code&gt;（类加载泄漏/频繁重载）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;系统/容器把进程杀了&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;K8s：&lt;code&gt;OOMKilled&lt;/code&gt;；Linux：&lt;code&gt;dmesg&lt;/code&gt; 里 &lt;code&gt;Out of memory: Kill process&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;JVM 日志未必有 OOM 栈&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;判定方法&lt;/strong&gt;：应用日志、K8s 事件 (&lt;code&gt;kubectl describe pod&lt;/code&gt;)、系统日志 (&lt;code&gt;dmesg&lt;/code&gt;)、JVM 日志（GC/错误日志）。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;快速止血（把服务活下来）&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;扩容/降流/限并发&lt;/strong&gt;：临时缩小线程池或限流；必要时扩副本。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;增配但留余量&lt;/strong&gt;：容器 &lt;code&gt;memoryLimit&lt;/code&gt; ↑，同时 &lt;strong&gt;Xmx 要明显小于 limit&lt;/strong&gt;（给 off-heap/线程/代码缓存留 30% 余量）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;降级&lt;/strong&gt;：关闭大对象功能（一次性加载、导出、聚合）、降低批量大小。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;打开取证开关&lt;/strong&gt;（见下一步），重启服务。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;取证与快速体检（上线就该常备）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JVM 启动参数（长期建议）&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/dump&lt;/code&gt;（自动导出 heap dump）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-Xlog:gc*:file=/data/logs/gc.log:time,uptime,level,tags&lt;/code&gt;（JDK9+；JDK8 用 &lt;code&gt;-Xloggc&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;（可选）&lt;code&gt;-XX:NativeMemoryTracking=summary&lt;/code&gt;（开销小）或 &lt;code&gt;detail&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;线上排查常用命令&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;线程/堆：
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;jcmd &amp;lt;pid&amp;gt; GC.heap_info&lt;/code&gt;、&lt;code&gt;jcmd &amp;lt;pid&amp;gt; GC.class_histogram&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;jmap -histo:live &amp;lt;pid&amp;gt; | head -50&lt;/code&gt;（大对象分布）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;jmap -dump:live,format=b,file=heap.hprof &amp;lt;pid&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;jstack -l &amp;lt;pid&amp;gt;&lt;/code&gt;（看看是否卡某些线程/ThreadLocal 泄漏）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;原生内存：
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;jcmd &amp;lt;pid&amp;gt; VM.native_memory summary&lt;/code&gt;（NMT：看 Direct / Internal / Thread 等占用）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;容器/系统：
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;kubectl top pod&lt;/code&gt; / &lt;code&gt;describe pod&lt;/code&gt;（&lt;code&gt;OOMKilled&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ps -o pid,rss,command -p &amp;lt;pid&amp;gt;&lt;/code&gt;、&lt;code&gt;pmap -x &amp;lt;pid&amp;gt;&lt;/code&gt;、&lt;code&gt;dmesg | tail&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;对症下药（不同 OOM 的根因与修复）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Heap OOM / GC Overhead&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;症状&lt;/strong&gt;：堆占用持续上升或 Full GC 频繁。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;定位&lt;/strong&gt;：用 Dump 在 MAT/VisualVM 看 &lt;strong&gt;Dominator Tree&lt;/strong&gt;、GC Roots 路径，找最大保留集。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;常见根因 &amp;amp; 修复&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;无限制缓存/Map&lt;/strong&gt;（没有 TTL/最大容量）→ 上 Caffeine/Guava &lt;strong&gt;Size/Weight + TTL&lt;/strong&gt;，监控命中率与大小&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;聚合/拼装大对象&lt;/strong&gt;（一次性 &lt;code&gt;toList()&lt;/code&gt;、大 &lt;code&gt;StringBuilder&lt;/code&gt;、无分页）→ 分页/分块处理，流式读写&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ThreadLocal 泄漏&lt;/strong&gt;（未 &lt;code&gt;remove&lt;/code&gt;）→ try/finally 清理；线程池复用时尤需注意&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;反序列化/JSON 组装大对象&lt;/strong&gt; → 换流式解析（Jackson streaming）、限制字段&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;序列化队列堆积&lt;/strong&gt;（MQ/队列消费不过来）→ 限流/背压，调小批量&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;调参兜底&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;合理设置 &lt;strong&gt;Xms=Xmx&lt;/strong&gt;（避免频繁扩容），用 &lt;strong&gt;G1/GenZ&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;检查 &lt;code&gt;-XX:MaxRAMPercentage&lt;/code&gt;（容器内）与 Limit 的匹配，确保 &lt;strong&gt;Xmx &amp;lt; Limit × 0.7&lt;/strong&gt; 左右。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Direct buffer / Off-heap OOM&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;症状&lt;/strong&gt;：报 &lt;code&gt;Direct buffer memory&lt;/code&gt; 或 RSS 高而堆不高。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;定位&lt;/strong&gt;：NMT（&lt;code&gt;VM.native_memory summary&lt;/code&gt;）、应用指标（Netty PooledArena）、&lt;code&gt;-XX:MaxDirectMemorySize&lt;/code&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;根因 &amp;amp; 修复&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;未释放 ByteBuffer/Netty ByteBuf&lt;/strong&gt; → 确保 &lt;code&gt;release()&lt;/code&gt;：用 Try-With-Resources 包装，开启 Netty 泄漏检测 &lt;code&gt;-Dio.netty.leakDetectionLevel=paranoid&lt;/code&gt;（只在测试/预发）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;无上限的直接内存&lt;/strong&gt; → 配置 &lt;code&gt;-XX:MaxDirectMemorySize=256m~1g&lt;/code&gt;；Netty 配对象池且限制最大并发&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;大响应/压缩/SSL 原生内存&lt;/strong&gt; → 减小批量、分块，确认本地/Native 库版本&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Metaspace OOM&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;症状&lt;/strong&gt;：&lt;code&gt;OutOfMemoryError: Metaspace&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;根因&lt;/strong&gt;：&lt;strong&gt;类加载器泄漏&lt;/strong&gt;（反复热加载/动态代理生成类、URLClassLoader 未关闭）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;修复&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;修正热加载逻辑；减少频繁生成新 Class。&lt;/li&gt;
&lt;li&gt;调整 &lt;code&gt;-XX:MaxMetaspaceSize&lt;/code&gt; 但重点是修复泄漏。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;jcmd &amp;lt;pid&amp;gt; VM.classloaders&lt;/code&gt;、&lt;code&gt;GC.class_stats&lt;/code&gt; 辅助判断。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;unable to create new native thread&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;症状&lt;/strong&gt;：线程数爆表或系统 &lt;code&gt;ulimit -u&lt;/code&gt; 限制。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;修复&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;控线程池并发&lt;/strong&gt;、合并池；合理 &lt;code&gt;queue&lt;/code&gt; 与拒绝策略。&lt;/li&gt;
&lt;li&gt;调整容器/系统线程数限制。&lt;/li&gt;
&lt;li&gt;用 &lt;code&gt;jstack&lt;/code&gt;/&lt;code&gt;top -H&lt;/code&gt; 找线程源头（哪个池在疯狂建线程）。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;容器 OOMKilled（非 JVM 报 OOM）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;症状&lt;/strong&gt;：Pod 被杀，JVM没栈。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;修复&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JVM 堆（Xmx）+ 原生内存之和 &lt;strong&gt;必须显著小于&lt;/strong&gt; K8s Limit。&lt;/li&gt;
&lt;li&gt;JDK11+ 使用 &lt;code&gt;-XX:MaxRAMPercentage&lt;/code&gt;（如 50）配合 Limit。&lt;/li&gt;
&lt;li&gt;预留线程栈/Direct/Metaspace/CodeCache 等空间（通常 ≥ 30% 预留）。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;防复发（工程化治理）&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;监控告警&lt;/strong&gt;：堆使用率、Young/Old GC 次数与时间、Full GC、RSS、Direct 内存、线程数、类加载数、对象分配速率。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;容量/压测&lt;/strong&gt;：关键接口做 3× 峰值压测，观察 P95/P99 与 RSS；设置&lt;strong&gt;自动化内存回归测试&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;限流与背压&lt;/strong&gt;：线程池有界队列 + 合理拒绝策略；对外部依赖设置超时与舱壁。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据/批量&lt;/strong&gt;：所有批处理/导出/聚合都&lt;strong&gt;限制批大小&lt;/strong&gt;并流式处理。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;开关与熔断&lt;/strong&gt;：配置化关闭大对象功能；遇压自动降级。&lt;/li&gt;
&lt;/ul&gt;</description><link>https://juejin.cn/post/7594742976712949794</link><guid isPermaLink="false">https://juejin.cn/post/7594742976712949794</guid><pubDate>Wed, 14 Jan 2026 05:33:38 GMT</pubDate><author>程序员飞鱼</author><category>后端</category><category>面试</category><category>Java</category></item><item><title>Java注解校验实战</title><description>&lt;h2 data-id=&quot;heading-0&quot;&gt;一、注解校验概述&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-1&quot;&gt;1.1 为什么需要注解校验？&lt;/h3&gt;
&lt;p&gt;在实际开发中，我们经常需要对输入数据进行校验：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// 传统方式：代码冗长、难以维护&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;createUser&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String username, String email, Integer age)&lt;/span&gt; {
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (username == &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; || username.length() &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt; || username.length() &amp;gt; &lt;span class=&quot;hljs-number&quot;&gt;20&lt;/span&gt;) {
        &lt;span class=&quot;hljs-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;IllegalArgumentException&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;用户名长度必须在3-20之间&quot;&lt;/span&gt;);
    }
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (email == &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; || !email.matches(&lt;span class=&quot;hljs-string&quot;&gt;&quot;^[A-Za-z0-9+_.-]+@(.+)$&quot;&lt;/span&gt;)) {
        &lt;span class=&quot;hljs-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;IllegalArgumentException&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;邮箱格式不正确&quot;&lt;/span&gt;);
    }
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (age == &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; || age &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;18&lt;/span&gt; || age &amp;gt; &lt;span class=&quot;hljs-number&quot;&gt;120&lt;/span&gt;) {
        &lt;span class=&quot;hljs-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;IllegalArgumentException&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;年龄必须在18-120之间&quot;&lt;/span&gt;);
    }
    &lt;span class=&quot;hljs-comment&quot;&gt;//...&lt;/span&gt;
}

&lt;span class=&quot;hljs-comment&quot;&gt;// ✅ 注解校验：简洁、声明式、可复用&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;createUser&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(&lt;span class=&quot;hljs-meta&quot;&gt;@Valid&lt;/span&gt; UserDTO userDTO)&lt;/span&gt; {
    &lt;span class=&quot;hljs-comment&quot;&gt;//...&lt;/span&gt;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;注解校验的优势&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;✅ &lt;strong&gt;声明式&lt;/strong&gt;：通过注解声明校验规则，代码更简洁&lt;/li&gt;
&lt;li&gt;✅ &lt;strong&gt;可复用&lt;/strong&gt;：校验逻辑可以复用，避免重复代码&lt;/li&gt;
&lt;li&gt;✅ &lt;strong&gt;易维护&lt;/strong&gt;：校验规则集中管理，易于维护&lt;/li&gt;
&lt;li&gt;✅ &lt;strong&gt;标准化&lt;/strong&gt;：遵循JSR-303/JSR-380标准&lt;/li&gt;
&lt;li&gt;✅ &lt;strong&gt;国际化&lt;/strong&gt;：支持国际化错误消息&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 data-id=&quot;heading-2&quot;&gt;1.2 常用校验注解&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d75942f76fe463ca72881781d563aac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;amp;x-expires=1768972030&amp;amp;x-signature=Lr04MVUvNK4vknuXUusWIknEC7Q%3D&quot; alt=&quot;&quot; loading=&quot;lazy&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Jakarta Bean Validation提供的注解&lt;/strong&gt;：&lt;/p&gt;











































































&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;注解&lt;/th&gt;&lt;th&gt;说明&lt;/th&gt;&lt;th&gt;示例&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@NotNull&lt;/code&gt;&lt;/td&gt;&lt;td&gt;值不能为null&lt;/td&gt;&lt;td&gt;&lt;code&gt;@NotNull String name&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@NotEmpty&lt;/code&gt;&lt;/td&gt;&lt;td&gt;集合、字符串、数组不能为空&lt;/td&gt;&lt;td&gt;&lt;code&gt;@NotEmpty List&amp;lt;String&amp;gt; items&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@NotBlank&lt;/code&gt;&lt;/td&gt;&lt;td&gt;字符串不能为空白（去除首尾空格后长度&amp;gt;0）&lt;/td&gt;&lt;td&gt;&lt;code&gt;@NotBlank String content&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Size(min, max)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;大小必须在指定范围内&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Size(min=3, max=20) String name&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Min(value)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;数值必须大于等于指定值&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Min(18) Integer age&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Max(value)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;数值必须小于等于指定值&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Max(120) Integer age&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Email&lt;/code&gt;&lt;/td&gt;&lt;td&gt;必须是有效的邮箱格式&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Email String email&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Pattern(regexp)&lt;/code&gt;&lt;/td&gt;&lt;td&gt;必须匹配指定的正则表达式&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Pattern(regexp=&quot;^1[3-9]\\d{9}$&quot;) String phone&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Past&lt;/code&gt;&lt;/td&gt;&lt;td&gt;日期必须是过去的时间&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Past Date birthDate&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Future&lt;/code&gt;&lt;/td&gt;&lt;td&gt;日期必须是未来的时间&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Future Date appointmentDate&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@AssertTrue&lt;/code&gt;&lt;/td&gt;&lt;td&gt;布尔值必须是true&lt;/td&gt;&lt;td&gt;&lt;code&gt;@AssertTrue Boolean agreed&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Negative&lt;/code&gt;&lt;/td&gt;&lt;td&gt;数值必须是负数&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Negative Integer balance&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;@Positive&lt;/code&gt;&lt;/td&gt;&lt;td&gt;数值必须是正数&lt;/td&gt;&lt;td&gt;&lt;code&gt;@Positive Integer amount&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;hr&gt;
&lt;h2 data-id=&quot;heading-3&quot;&gt;二、@Valid vs @Validated&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-4&quot;&gt;2.1 核心区别&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14bdc2a2e8ae445db42f96080bb1d312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;amp;x-expires=1768972030&amp;amp;x-signature=Ezh8V%2FE8oes3yV0mO5w5sgJNbEI%3D&quot; alt=&quot;&quot; loading=&quot;lazy&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/p&gt;
&lt;p&gt;这两个注解虽然功能相似，但有关键区别：&lt;/p&gt;








































&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;特性&lt;/th&gt;&lt;th&gt;@Valid&lt;/th&gt;&lt;th&gt;@Validated&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;来源&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;Jakarta Bean Validation (JSR-380)&lt;/td&gt;&lt;td&gt;Spring Framework&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;位置&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;方法、字段、构造器参数&lt;/td&gt;&lt;td&gt;方法、类型、参数&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;嵌套校验&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;✅ 支持&lt;/td&gt;&lt;td&gt;✅ 支持&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;分组校验&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;❌ 不支持&lt;/td&gt;&lt;td&gt;✅ 支持&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;校验组序列&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;❌ 不支持&lt;/td&gt;&lt;td&gt;✅ 支持&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;Spring集成&lt;/strong&gt;&lt;/td&gt;&lt;td&gt;需要配置&lt;/td&gt;&lt;td&gt;原生支持&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;h3 data-id=&quot;heading-5&quot;&gt;2.2 @Valid的使用&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;基本用法&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserDTO&lt;/span&gt; {
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(message = &quot;用户ID不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Long id;

    &lt;span class=&quot;hljs-meta&quot;&gt;@NotBlank(message = &quot;用户名不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Size(min = 3, max = 20, message = &quot;用户名长度必须在3-20之间&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String username;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Email(message = &quot;邮箱格式不正确&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotBlank(message = &quot;邮箱不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String email;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Min(value = 18, message = &quot;年龄必须大于等于18岁&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Max(value = 120, message = &quot;年龄必须小于等于120岁&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Integer age;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;在Controller中使用&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@RestController&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@RequestMapping(&quot;/api/users&quot;)&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserController&lt;/span&gt; {

    &lt;span class=&quot;hljs-comment&quot;&gt;// 使用@Valid触发校验&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@PostMapping&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;String&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;createUser&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(&lt;span class=&quot;hljs-meta&quot;&gt;@Valid&lt;/span&gt; &lt;span class=&quot;hljs-meta&quot;&gt;@RequestBody&lt;/span&gt; UserDTO userDTO)&lt;/span&gt; {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 如果校验失败，会自动抛出MethodArgumentNotValidException&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.ok(&lt;span class=&quot;hljs-string&quot;&gt;&quot;用户创建成功&quot;&lt;/span&gt;);
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;嵌套校验&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;OrderDTO&lt;/span&gt; {
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(message = &quot;订单ID不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Long orderId;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Valid&lt;/span&gt;  &lt;span class=&quot;hljs-comment&quot;&gt;// 关键：必须使用@Valid才能触发嵌套对象的校验&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(message = &quot;用户信息不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; UserDTO user;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Valid&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotEmpty(message = &quot;订单项不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;OrderItemDTO&amp;gt; items;
}

&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;OrderItemDTO&lt;/span&gt; {
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(message = &quot;商品ID不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Long productId;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Min(value = 1, message = &quot;数量必须大于0&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Integer quantity;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-6&quot;&gt;2.3 @Validated的使用&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;基本用法&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Service&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Validated&lt;/span&gt;  &lt;span class=&quot;hljs-comment&quot;&gt;// 类级别添加@Validated，启用方法参数校验&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserService&lt;/span&gt; {

    &lt;span class=&quot;hljs-comment&quot;&gt;// 简单参数校验&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;updateUser&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(
            &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(message = &quot;用户ID不能为空&quot;)&lt;/span&gt; Long id,
            &lt;span class=&quot;hljs-meta&quot;&gt;@NotBlank(message = &quot;用户名不能为空&quot;)&lt;/span&gt; String username)&lt;/span&gt; {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 业务逻辑...&lt;/span&gt;
    }

    &lt;span class=&quot;hljs-comment&quot;&gt;// 对象校验&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;createUser&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(&lt;span class=&quot;hljs-meta&quot;&gt;@Valid&lt;/span&gt; UserDTO userDTO)&lt;/span&gt; {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 业务逻辑...&lt;/span&gt;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;分组校验&lt;/strong&gt;（@Validated独有）：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;CreateGroup&lt;/span&gt; {}
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UpdateGroup&lt;/span&gt; {}

&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserDTO&lt;/span&gt; {
    &lt;span class=&quot;hljs-meta&quot;&gt;@Null(groups = CreateGroup.class, message = &quot;创建时ID必须为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(groups = UpdateGroup.class, message = &quot;更新时ID不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Long id;

    &lt;span class=&quot;hljs-meta&quot;&gt;@NotBlank(groups = {CreateGroup.class, UpdateGroup.class})&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String username;
}

&lt;span class=&quot;hljs-meta&quot;&gt;@RestController&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@RequestMapping(&quot;/api/users&quot;)&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserController&lt;/span&gt; {

    &lt;span class=&quot;hljs-meta&quot;&gt;@PostMapping&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;String&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(
            &lt;span class=&quot;hljs-meta&quot;&gt;@Validated(CreateGroup.class)&lt;/span&gt; &lt;span class=&quot;hljs-meta&quot;&gt;@RequestBody&lt;/span&gt; UserDTO userDTO)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.ok(&lt;span class=&quot;hljs-string&quot;&gt;&quot;创建成功&quot;&lt;/span&gt;);
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@PutMapping&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;String&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(
            &lt;span class=&quot;hljs-meta&quot;&gt;@Validated(UpdateGroup.class)&lt;/span&gt; &lt;span class=&quot;hljs-meta&quot;&gt;@RequestBody&lt;/span&gt; UserDTO userDTO)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.ok(&lt;span class=&quot;hljs-string&quot;&gt;&quot;更新成功&quot;&lt;/span&gt;);
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-7&quot;&gt;2.4 选择建议&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bc644bb552440bf90eee2200d5f33ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;amp;x-expires=1768972030&amp;amp;x-signature=YtVeSX8VJ9zR6C9zR0%2F%2FJBvN60I%3D&quot; alt=&quot;&quot; loading=&quot;lazy&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;选择决策树&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-less&quot; lang=&quot;less&quot;&gt;是否需要分组校验？
├─ 是 → 使用 &lt;span class=&quot;hljs-variable&quot;&gt;@Validated&lt;/span&gt;
└─ 否 → 是否在Controller中？
    ├─ 是 → 两者都可以，推荐 &lt;span class=&quot;hljs-variable&quot;&gt;@Valid&lt;/span&gt;
    └─ 否 → 使用 &lt;span class=&quot;hljs-variable&quot;&gt;@Validated&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;最佳实践&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Controller层&lt;/strong&gt;：使用 &lt;code&gt;@Valid&lt;/code&gt;（简洁、够用）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Service层&lt;/strong&gt;：使用 &lt;code&gt;@Validated&lt;/code&gt;（支持方法参数校验）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;需要分组&lt;/strong&gt;：必须使用 &lt;code&gt;@Validated&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;嵌套对象&lt;/strong&gt;：在嵌套对象字段上添加 &lt;code&gt;@Valid&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;hr&gt;
&lt;h2 data-id=&quot;heading-8&quot;&gt;三、校验组（Validation Groups）&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-9&quot;&gt;3.1 为什么需要校验组？&lt;/h3&gt;
&lt;p&gt;不同场景下，同一对象的校验规则可能不同：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// 场景1：新增用户&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - id为空（由数据库生成）&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - username必填&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - password必填&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;// 场景2：更新用户&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - id必填（根据id更新）&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - username可选&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - password可选（不修改则不传）&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-10&quot;&gt;3.2 定义校验组&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/988f1add0aa542e9bf4de37a1ddfb86c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;amp;x-expires=1768972030&amp;amp;x-signature=lPsWPUcWL%2B5hU%2BRIJ1tsz830aw4%3D&quot; alt=&quot;&quot; loading=&quot;lazy&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;/**
 * 校验组定义
 */&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ValidationGroups&lt;/span&gt; {
    &lt;span class=&quot;hljs-comment&quot;&gt;// 新增操作&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Create&lt;/span&gt; {}

    &lt;span class=&quot;hljs-comment&quot;&gt;// 更新操作&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Update&lt;/span&gt; {}

    &lt;span class=&quot;hljs-comment&quot;&gt;// 删除操作&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Delete&lt;/span&gt; {}

    &lt;span class=&quot;hljs-comment&quot;&gt;// 默认组（不指定group时使用）&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Default&lt;/span&gt; {}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-11&quot;&gt;3.3 在实体类中使用分组&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserDTO&lt;/span&gt; {

    &lt;span class=&quot;hljs-comment&quot;&gt;// 创建时ID必须为空，更新时ID不能为空&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Null(groups = ValidationGroups.Create.class,
          message = &quot;创建用户时ID必须为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(groups = {ValidationGroups.Update.class,
                       ValidationGroups.Delete.class},
              message = &quot;更新/删除用户时ID不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Long id;

    &lt;span class=&quot;hljs-meta&quot;&gt;@NotBlank(groups = {ValidationGroups.Create.class,
                        ValidationGroups.Update.class},
               message = &quot;用户名不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Size(min = 3, max = 20,
          groups = {ValidationGroups.Create.class,
                    ValidationGroups.Update.class},
          message = &quot;用户名长度必须在3-20之间&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String username;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Email(groups = ValidationGroups.Create.class,
           message = &quot;邮箱格式不正确&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotBlank(groups = ValidationGroups.Create.class,
              message = &quot;邮箱不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String email;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 创建时密码必填，更新时可选&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@NotBlank(groups = ValidationGroups.Create.class,
              message = &quot;密码不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Size(min = 6, max = 20,
          groups = ValidationGroups.Create.class,
          message = &quot;密码长度必须在6-20之间&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String password;

    &lt;span class=&quot;hljs-meta&quot;&gt;@NotNull(groups = ValidationGroups.Create.class,
             message = &quot;年龄不能为空&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Min(value = 18, groups = ValidationGroups.Create.class,
         message = &quot;年龄必须大于等于18岁&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Integer age;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-12&quot;&gt;3.4 使用校验组&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@RestController&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@RequestMapping(&quot;/api/users&quot;)&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserController&lt;/span&gt; {

    &lt;span class=&quot;hljs-meta&quot;&gt;@PostMapping&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;?&amp;gt; create(
            &lt;span class=&quot;hljs-meta&quot;&gt;@Validated(ValidationGroups.Create.class)&lt;/span&gt;
            &lt;span class=&quot;hljs-meta&quot;&gt;@RequestBody&lt;/span&gt; UserDTO userDTO) {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 只校验Create组中定义的规则&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.ok(&lt;span class=&quot;hljs-string&quot;&gt;&quot;创建成功&quot;&lt;/span&gt;);
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@PutMapping(&quot;/{id}&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;?&amp;gt; update(
            &lt;span class=&quot;hljs-meta&quot;&gt;@PathVariable&lt;/span&gt; Long id,
            &lt;span class=&quot;hljs-meta&quot;&gt;@Validated(ValidationGroups.Update.class)&lt;/span&gt;
            &lt;span class=&quot;hljs-meta&quot;&gt;@RequestBody&lt;/span&gt; UserDTO userDTO) {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 只校验Update组中定义的规则&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.ok(&lt;span class=&quot;hljs-string&quot;&gt;&quot;更新成功&quot;&lt;/span&gt;);
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@DeleteMapping(&quot;/{id}&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;?&amp;gt; delete(
            &lt;span class=&quot;hljs-meta&quot;&gt;@PathVariable&lt;/span&gt; Long id,
            &lt;span class=&quot;hljs-meta&quot;&gt;@Validated(ValidationGroups.Delete.class)&lt;/span&gt;
            &lt;span class=&quot;hljs-meta&quot;&gt;@RequestBody&lt;/span&gt; UserDTO userDTO) {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 只校验Delete组中定义的规则&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.ok(&lt;span class=&quot;hljs-string&quot;&gt;&quot;删除成功&quot;&lt;/span&gt;);
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-13&quot;&gt;3.5 组序列（Group Sequence）&lt;/h3&gt;
&lt;p&gt;控制校验组的执行顺序，默认按照定义的顺序依次校验：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@GroupSequence({CreateGroup.class, UpdateGroup.class, Default.class})&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;OrderedGroup&lt;/span&gt; {
}

&lt;span class=&quot;hljs-meta&quot;&gt;@RestController&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserController&lt;/span&gt; {
    &lt;span class=&quot;hljs-meta&quot;&gt;@PostMapping&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;?&amp;gt; create(
            &lt;span class=&quot;hljs-meta&quot;&gt;@Validated(OrderedGroup.class)&lt;/span&gt;
            &lt;span class=&quot;hljs-meta&quot;&gt;@RequestBody&lt;/span&gt; UserDTO userDTO) {
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.ok(&lt;span class=&quot;hljs-string&quot;&gt;&quot;创建成功&quot;&lt;/span&gt;);
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt;：一旦某个组校验失败，后续组不会再执行。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 data-id=&quot;heading-14&quot;&gt;四、自定义校验注解&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-15&quot;&gt;4.1 自定义注解的应用场景&lt;/h3&gt;
&lt;p&gt;当内置注解无法满足需求时，可以创建自定义校验注解：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;手机号校验&lt;/strong&gt;：&lt;code&gt;@PhoneNumber&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;身份证号校验&lt;/strong&gt;：&lt;code&gt;@IdCard&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;枚举值校验&lt;/strong&gt;：&lt;code&gt;@EnumValue&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;字段互斥&lt;/strong&gt;：&lt;code&gt;@FieldMatch&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;密码强度&lt;/strong&gt;：&lt;code&gt;@StrongPassword&lt;/code&gt;
&lt;img src=&quot;https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40dbc0b98824465892fe717247363428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;amp;x-expires=1768972030&amp;amp;x-signature=KIiUfm%2B15Kz1E62e9vbPJSa5toY%3D&quot; alt=&quot;&quot; loading=&quot;lazy&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 data-id=&quot;heading-16&quot;&gt;4.2 实现手机号校验注解&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;第一步：定义注解&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Target({ElementType.FIELD, ElementType.PARAMETER})&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Retention(RetentionPolicy.RUNTIME)&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Constraint(validatedBy = PhoneNumberValidator.class)&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Documented&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-meta&quot;&gt;@interface&lt;/span&gt; PhoneNumber {

    &lt;span class=&quot;hljs-comment&quot;&gt;// 必须的三个属性&lt;/span&gt;
    String &lt;span class=&quot;hljs-title function_&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;手机号格式不正确&quot;&lt;/span&gt;;

    Class&amp;lt;?&amp;gt;[] groups() &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; {};

    Class&amp;lt;? &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Payload&lt;/span&gt;&amp;gt;[] payload() &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; {};

    &lt;span class=&quot;hljs-comment&quot;&gt;// 自定义属性：是否支持国际化号码&lt;/span&gt;
    &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;international&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 自定义属性：支持的国家代码&lt;/span&gt;
    String[] countryCodes() &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; {&lt;span class=&quot;hljs-string&quot;&gt;&quot;+86&quot;&lt;/span&gt;};
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;第二步：实现校验器&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;PhoneNumberValidator&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ConstraintValidator&lt;/span&gt;&amp;lt;PhoneNumber, String&amp;gt; {

    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; international;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String[] countryCodes;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 中国大陆手机号正则&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;CHINA_PHONE_PATTERN&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;^1[3-9]\\d{9}$&quot;&lt;/span&gt;;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(PhoneNumber constraintAnnotation)&lt;/span&gt; {
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.international = constraintAnnotation.international();
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.countryCodes = constraintAnnotation.countryCodes();
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;isValid&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String value,
                          ConstraintValidatorContext context)&lt;/span&gt; {
        &lt;span class=&quot;hljs-comment&quot;&gt;// null值由@NotNull处理&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-comment&quot;&gt;// 国际号码校验&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (international) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; validateInternational(value);
        }

        &lt;span class=&quot;hljs-comment&quot;&gt;// 中国手机号校验&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; value.matches(CHINA_PHONE_PATTERN);
    }

    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;validateInternational&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String phone)&lt;/span&gt; {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 简单的国际号码校验逻辑&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; (String code : countryCodes) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (phone.startsWith(code)) {
                &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; phone.substring(code.length());
                &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; number.matches(&lt;span class=&quot;hljs-string&quot;&gt;&quot;^\\d{6,15}$&quot;&lt;/span&gt;);
            }
        }
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;第三步：使用注解&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserDTO&lt;/span&gt; {
    &lt;span class=&quot;hljs-meta&quot;&gt;@PhoneNumber(message = &quot;手机号格式不正确&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String mobile;

    &lt;span class=&quot;hljs-meta&quot;&gt;@PhoneNumber(international = true,
                countryCodes = {&quot;+86&quot;, &quot;+1&quot;, &quot;+44&quot;},
                message = &quot;国际手机号格式不正确&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String internationalPhone;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-17&quot;&gt;4.3 实现密码强度校验&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;注解定义&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Target({ElementType.FIELD, ElementType.PARAMETER})&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Retention(RetentionPolicy.RUNTIME)&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Constraint(validatedBy = StrongPasswordValidator.class)&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Documented&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-meta&quot;&gt;@interface&lt;/span&gt; StrongPassword {

    String &lt;span class=&quot;hljs-title function_&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;密码强度不足&quot;&lt;/span&gt;;

    Class&amp;lt;?&amp;gt;[] groups() &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; {};

    Class&amp;lt;? &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Payload&lt;/span&gt;&amp;gt;[] payload() &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; {};

    &lt;span class=&quot;hljs-comment&quot;&gt;// 最小长度&lt;/span&gt;
    &lt;span class=&quot;hljs-type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;minLength&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;8&lt;/span&gt;;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 是否需要大写字母&lt;/span&gt;
    &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;requireUppercase&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 是否需要小写字母&lt;/span&gt;
    &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;requireLowercase&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 是否需要数字&lt;/span&gt;
    &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;requireDigit&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 是否需要特殊字符&lt;/span&gt;
    &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;requireSpecialChar&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;校验器实现&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;StrongPasswordValidator&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ConstraintValidator&lt;/span&gt;&amp;lt;StrongPassword, String&amp;gt; {

    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;int&lt;/span&gt; minLength;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; requireUppercase;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; requireLowercase;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; requireDigit;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; requireSpecialChar;

    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;Pattern&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;UPPERCASE_PATTERN&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;
        Pattern.compile(&lt;span class=&quot;hljs-string&quot;&gt;&quot;[A-Z]&quot;&lt;/span&gt;);
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;Pattern&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;LOWERCASE_PATTERN&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;
        Pattern.compile(&lt;span class=&quot;hljs-string&quot;&gt;&quot;[a-z]&quot;&lt;/span&gt;);
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;Pattern&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;DIGIT_PATTERN&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;
        Pattern.compile(&lt;span class=&quot;hljs-string&quot;&gt;&quot;\\d&quot;&lt;/span&gt;);
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;Pattern&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;SPECIAL_CHAR_PATTERN&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt;
        Pattern.compile(&lt;span class=&quot;hljs-string&quot;&gt;&quot;[!@#$%^&amp;amp;*()_+\\-=\\[\\]{};&#39;:\&quot;\\\\|,.&amp;lt;&amp;gt;\\/?]&quot;&lt;/span&gt;);

    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(StrongPassword constraintAnnotation)&lt;/span&gt; {
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.minLength = constraintAnnotation.minLength();
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.requireUppercase = constraintAnnotation.requireUppercase();
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.requireLowercase = constraintAnnotation.requireLowercase();
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.requireDigit = constraintAnnotation.requireDigit();
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.requireSpecialChar = constraintAnnotation.requireSpecialChar();
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;isValid&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String password,
                          ConstraintValidatorContext context)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (password == &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (password.length() &amp;lt; minLength) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (requireUppercase &amp;amp;&amp;amp; !UPPERCASE_PATTERN.matcher(password).find()) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (requireLowercase &amp;amp;&amp;amp; !LOWERCASE_PATTERN.matcher(password).find()) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (requireDigit &amp;amp;&amp;amp; !DIGIT_PATTERN.matcher(password).find()) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (requireSpecialChar &amp;amp;&amp;amp; !SPECIAL_CHAR_PATTERN.matcher(password).find()) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-18&quot;&gt;4.4 跨字段校验&lt;/h3&gt;
&lt;p&gt;实现&quot;密码&quot;和&quot;确认密码&quot;必须一致的校验：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注解定义&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Target({ElementType.TYPE})&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Retention(RetentionPolicy.RUNTIME)&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Constraint(validatedBy = FieldMatchValidator.class)&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Documented&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-meta&quot;&gt;@interface&lt;/span&gt; FieldMatch {

    String &lt;span class=&quot;hljs-title function_&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;字段值不匹配&quot;&lt;/span&gt;;

    Class&amp;lt;?&amp;gt;[] groups() &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; {};

    Class&amp;lt;? &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Payload&lt;/span&gt;&amp;gt;[] payload() &lt;span class=&quot;hljs-keyword&quot;&gt;default&lt;/span&gt; {};

    &lt;span class=&quot;hljs-comment&quot;&gt;// 第一个字段名&lt;/span&gt;
    String &lt;span class=&quot;hljs-title function_&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt;;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 第二个字段名&lt;/span&gt;
    String &lt;span class=&quot;hljs-title function_&quot;&gt;second&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt;;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;校验器实现&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;FieldMatchValidator&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ConstraintValidator&lt;/span&gt;&amp;lt;FieldMatch, Object&amp;gt; {

    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String firstFieldName;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String secondFieldName;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(FieldMatch constraintAnnotation)&lt;/span&gt; {
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.firstFieldName = constraintAnnotation.first();
        &lt;span class=&quot;hljs-built_in&quot;&gt;this&lt;/span&gt;.secondFieldName = constraintAnnotation.second();
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;isValid&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(Object value,
                          ConstraintValidatorContext context)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;
        }

        &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;hljs-type&quot;&gt;Field&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;firstField&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; value.getClass().getDeclaredField(firstFieldName);
            firstField.setAccessible(&lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;);
            &lt;span class=&quot;hljs-type&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;firstValue&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; firstField.get(value);

            &lt;span class=&quot;hljs-type&quot;&gt;Field&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;secondField&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; value.getClass().getDeclaredField(secondFieldName);
            secondField.setAccessible(&lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;);
            &lt;span class=&quot;hljs-type&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;secondValue&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; secondField.get(value);

            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; Objects.equals(firstValue, secondValue);
        } &lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;false&lt;/span&gt;;
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;使用示例&lt;/strong&gt;：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@FieldMatch(first = &quot;password&quot;, second = &quot;confirmPassword&quot;,
            message = &quot;两次输入的密码不一致&quot;)&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;RegisterRequest&lt;/span&gt; {
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String username;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String password;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String confirmPassword;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;hr&gt;
&lt;h2 data-id=&quot;heading-19&quot;&gt;五、生产环境实战&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-20&quot;&gt;5.1 统一异常处理&lt;/h3&gt;
&lt;p&gt;在生产环境中，需要统一处理校验异常：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe07446f944468d9855d0cd8fcaef87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;amp;x-expires=1768972030&amp;amp;x-signature=OBcyPGTdfVZ9uRxWapk6Akd36CY%3D&quot; alt=&quot;&quot; loading=&quot;lazy&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@RestControllerAdvice&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;GlobalExceptionHandler&lt;/span&gt; {

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 处理 &lt;span class=&quot;hljs-doctag&quot;&gt;@Valid&lt;/span&gt; 触发的校验异常
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@ExceptionHandler(MethodArgumentNotValidException.class)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;ErrorResponse&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;handleValidationException&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(
            MethodArgumentNotValidException ex)&lt;/span&gt; {

        List&amp;lt;String&amp;gt; errors = ex.getBindingResult()
            .getFieldErrors()
            .stream()
            .map(error -&amp;gt; error.getField() + &lt;span class=&quot;hljs-string&quot;&gt;&quot;: &quot;&lt;/span&gt; + error.getDefaultMessage())
            .collect(Collectors.toList());

        &lt;span class=&quot;hljs-type&quot;&gt;ErrorResponse&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; ErrorResponse.builder()
            .code(&lt;span class=&quot;hljs-number&quot;&gt;400&lt;/span&gt;)
            .message(&lt;span class=&quot;hljs-string&quot;&gt;&quot;参数校验失败&quot;&lt;/span&gt;)
            .errors(errors)
            .timestamp(LocalDateTime.now())
            .build();

        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.badRequest().body(response);
    }

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 处理 &lt;span class=&quot;hljs-doctag&quot;&gt;@Validated&lt;/span&gt; 触发的校验异常
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@ExceptionHandler(ConstraintViolationException.class)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;ErrorResponse&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;handleConstraintViolation&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(
            ConstraintViolationException ex)&lt;/span&gt; {

        List&amp;lt;String&amp;gt; errors = ex.getConstraintViolations()
            .stream()
            .map(violation -&amp;gt; violation.getPropertyPath() + &lt;span class=&quot;hljs-string&quot;&gt;&quot;: &quot;&lt;/span&gt; + violation.getMessage())
            .collect(Collectors.toList());

        &lt;span class=&quot;hljs-type&quot;&gt;ErrorResponse&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; ErrorResponse.builder()
            .code(&lt;span class=&quot;hljs-number&quot;&gt;400&lt;/span&gt;)
            .message(&lt;span class=&quot;hljs-string&quot;&gt;&quot;参数校验失败&quot;&lt;/span&gt;)
            .errors(errors)
            .timestamp(LocalDateTime.now())
            .build();

        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.badRequest().body(response);
    }

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 处理请求参数绑定异常
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@ExceptionHandler(BindException.class)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; ResponseEntity&amp;lt;ErrorResponse&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;handleBindException&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(BindException ex)&lt;/span&gt; {
        List&amp;lt;String&amp;gt; errors = ex.getBindingResult()
            .getFieldErrors()
            .stream()
            .map(error -&amp;gt; error.getField() + &lt;span class=&quot;hljs-string&quot;&gt;&quot;: &quot;&lt;/span&gt; + error.getDefaultMessage())
            .collect(Collectors.toList());

        &lt;span class=&quot;hljs-type&quot;&gt;ErrorResponse&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; ErrorResponse.builder()
            .code(&lt;span class=&quot;hljs-number&quot;&gt;400&lt;/span&gt;)
            .message(&lt;span class=&quot;hljs-string&quot;&gt;&quot;参数绑定失败&quot;&lt;/span&gt;)
            .errors(errors)
            .timestamp(LocalDateTime.now())
            .build();

        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; ResponseEntity.badRequest().body(response);
    }
}

&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Builder&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ErrorResponse&lt;/span&gt; {
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; Integer code;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String message;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;String&amp;gt; errors;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; LocalDateTime timestamp;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-21&quot;&gt;5.2 快速失败机制&lt;/h3&gt;
&lt;p&gt;默认情况下，Bean Validation会校验所有约束并返回所有错误。如果需要在第一个错误时就停止：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Configuration&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ValidationConfig&lt;/span&gt; {

    &lt;span class=&quot;hljs-meta&quot;&gt;@Bean&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; Validator &lt;span class=&quot;hljs-title function_&quot;&gt;validator&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; {
        &lt;span class=&quot;hljs-type&quot;&gt;ValidatorFactory&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;factory&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; Validation.byDefaultProvider()
            .configure()
            .failFast(&lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;)  &lt;span class=&quot;hljs-comment&quot;&gt;// 启用快速失败&lt;/span&gt;
            .buildValidatorFactory();
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; factory.getValidator();
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@Bean&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; MethodValidationPostProcessor &lt;span class=&quot;hljs-title function_&quot;&gt;methodValidationPostProcessor&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; {
        &lt;span class=&quot;hljs-type&quot;&gt;MethodValidationPostProcessor&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;processor&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;MethodValidationPostProcessor&lt;/span&gt;();
        processor.setValidator(validator());
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; processor;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-22&quot;&gt;5.4 手动触发校验&lt;/h3&gt;
&lt;p&gt;在Service层手动触发校验：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Service&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@RequiredArgsConstructor&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserService&lt;/span&gt; {

    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; Validator validator;

    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;createUser&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(UserDTO userDTO)&lt;/span&gt; {
        &lt;span class=&quot;hljs-comment&quot;&gt;// 手动校验&lt;/span&gt;
        Set&amp;lt;ConstraintViolation&amp;lt;UserDTO&amp;gt;&amp;gt; violations =
            validator.validate(userDTO, Default.class);

        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (!violations.isEmpty()) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ConstraintViolationException&lt;/span&gt;(violations);
        }

        &lt;span class=&quot;hljs-comment&quot;&gt;// 业务逻辑...&lt;/span&gt;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;hr&gt;
&lt;h2 data-id=&quot;heading-23&quot;&gt;六、最佳实践&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-24&quot;&gt;6.1 设计原则&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;单一职责&lt;/strong&gt;：每个注解只负责一个校验规则&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;组合使用&lt;/strong&gt;：多个简单注解组合成复杂规则&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;错误消息清晰&lt;/strong&gt;：提供具体、可操作的错误提示&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;分组管理&lt;/strong&gt;：使用校验组区分不同场景&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;自定义注解&lt;/strong&gt;：复杂业务逻辑创建自定义注解&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 data-id=&quot;heading-25&quot;&gt;6.2 性能优化&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;避免过度校验&lt;/strong&gt;：只校验必要的数据&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;校验顺序&lt;/strong&gt;：将简单的校验放在前面&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缓存Validator&lt;/strong&gt;：Validator实例可以复用&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;异步校验&lt;/strong&gt;：对于复杂校验，考虑异步处理&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 data-id=&quot;heading-26&quot;&gt;七、总结&lt;/h2&gt;
&lt;p&gt;本文系统地介绍了Java注解校验的核心概念和实践：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;@Valid vs @Validated&lt;/strong&gt;：理解两者的区别和适用场景&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;校验组&lt;/strong&gt;：使用分组管理不同场景的校验规则&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;自定义注解&lt;/strong&gt;：创建符合业务需求的校验注解&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;生产实践&lt;/strong&gt;：异常处理、国际化、性能优化&lt;/li&gt;
&lt;/ol&gt;</description><link>https://juejin.cn/post/7594843125320712218</link><guid isPermaLink="false">https://juejin.cn/post/7594843125320712218</guid><pubDate>Wed, 14 Jan 2026 05:06:26 GMT</pubDate><author>雨中飘荡的记忆</author><category>后端</category><category>Java</category></item><item><title>git 删除历史记录或历史大文件后 提交历史记录到新的仓库</title><description>我这里的情况是原有仓库已经关闭了，就只有手里的项目代码，现在需要将包括带有大文件的历史提交记录 clone到新的仓库中，而且新仓库已有代码和提交记录的情况下。</description><link>https://juejin.cn/post/7594854295746740260</link><guid isPermaLink="false">https://juejin.cn/post/7594854295746740260</guid><pubDate>Wed, 14 Jan 2026 04:27:56 GMT</pubDate><author>用户383551424028</author><category>后端</category><category>Git</category></item><item><title>Spring Boot多数据源配置实战指南：从选型到落地优化</title><description>Spring Boot多数据源配置实战指南：从选型到落地优化 在后端开发中，随着业务复杂度提升，单一数据源往往无法满足需求——比如电商系统需要区分订单库与用户库、数据归档场景需要同时操作业务库与历史库</description><link>https://juejin.cn/post/7594854295746707492</link><guid isPermaLink="false">https://juejin.cn/post/7594854295746707492</guid><pubDate>Wed, 14 Jan 2026 03:51:14 GMT</pubDate><author>回家路上绕了弯</author><category>后端</category><category>分布式</category></item><item><title>ebpf检测Linux系统要来了</title><description>哈喽，我是子牙老师，深耕计算机底层，手写过操作系统、Linux 内核等核心技术。此前推出《手写生产级 eBPF 内存监测工具》，结合学员需求，决定将工具升级为通用 Linux 系统检测工具！</description><link>https://juejin.cn/post/7594859060857225226</link><guid isPermaLink="false">https://juejin.cn/post/7594859060857225226</guid><pubDate>Wed, 14 Jan 2026 03:46:00 GMT</pubDate><author>硬核子牙</author><category>后端</category><category>Linux</category></item><item><title>Node.js 编程实战：博客系统 —— 数据库设计</title><description>一、数据库设计的重要性 数据库设计是博客系统的根基。它决定了： • 数据存储结构是否合理 • 功能扩展是否顺畅 • 查询性能是否高效 • 数据一致性是否有保障 如果在项目初期忽略数据库设计，后续改表和</description><link>https://juejin.cn/post/7594822511436333082</link><guid isPermaLink="false">https://juejin.cn/post/7594822511436333082</guid><pubDate>Wed, 14 Jan 2026 03:26:48 GMT</pubDate><author>程序员爱钓鱼</author><category>后端</category><category>前端</category><category>Node.js</category></item><item><title>Nginx分布式框架</title><description>&lt;h2 data-id=&quot;heading-0&quot;&gt;Nginx&lt;/h2&gt;
&lt;p&gt;是一个高性能的HTTP和反向代理web服务器。&lt;/p&gt;
&lt;p&gt;提供的服务：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;动静分离（web 服务）&lt;/li&gt;
&lt;li&gt;负载均衡 （反向代理）&lt;/li&gt;
&lt;li&gt;web 缓存&lt;/li&gt;
&lt;li&gt;内存少，并发能力强（支持50,000 个并发）&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 data-id=&quot;heading-1&quot;&gt;安装&lt;/h2&gt;
&lt;p&gt;下载地址：&lt;a href=&quot;https://link.juejin.cn/?target=http%3A%2F%2Fnginx.org%2Fen%2Fdownload.html&quot; target=&quot;_blank&quot; title=&quot;http://nginx.org/en/download.html&quot; ref=&quot;nofollow noopener noreferrer&quot;&gt;nginx.org/en/download…&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;下载完上传Linux服务器上，一般安装在/usr/local下，进行解压&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;tar -zxvf nginx-1.18.0.tar.gz
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;进行配置，在nginx根目录下执行&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;# 1.安装编译工具文件库
yum -y install make zlib zlib-devel gcc-c++ libtool openssl openssl-devel

# 方式1：
# 2.使用默认配置
./configur

# 3.然后回车,进行编译
make

# 4.然后回车,安装
make install

# 方式2：注意：如果自定义安装
# 1. 创建nginx临时目录
mkdir -p /var/temp/nginx

# 2. 进入nginx安装目录，指定配置文件
./configure \
# 安装在哪个目录下
--prefix=/usr/local/nginx/nginx \
--conf-path=/usr/local/nginx/nginx.conf  \
--pid-path=/var/run/nginx/nginx.pid \
--lock-path=/var/lock/nginx.lock \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log \
--with-http_gzip_static_module \
--http-client-body-temp-path=/var/temp/nginx/client \
--http-proxy-temp-path=/var/temp/nginx/proxy \
--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \
--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \
--http-scgi-temp-path=/var/temp/nginx/scgi \
--with-http_stub_status_module \
--with-http_ssl_module 
# --with-http_ssl_module 是配置支持https

# 3.编译、安装
make
make install
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;查找安装路径：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;whereis nginx
# 默认在/usr/local/nginx
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;启动Nginx，默认是80端口，在浏览器输入服务器IP地址，就能访问Nginx默认页面，说明安装成功。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;卸载Nginx：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;# 关闭nginx进程
./nginx -s stop
rm -rf /user/local/nginx
make clean
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 data-id=&quot;heading-2&quot;&gt;常用命令&lt;/h2&gt;
&lt;p&gt;启动/停止/退出nginx：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;# 启动
cd /usr/local/nginx/sbin/
./nginx
start nginx
# 指定配置文件启动
/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
或者
./nginx -c /usr/local/nginx/conf/nginx.conf

# 停止
./nginx -s stop

# 安全退出,优雅退出
./nginx -s quit

# 重新加载配置文件
./nginx -s reload

# 查看配置文件是否错误
./nginx -t

# 查看nginx进程
ps aux|grep nginx
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;设置nginx开机启动：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;vim /etc/rc.local
然后在底部增加
/usr/local/nginx/sbin/nginx
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;其他命令：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;# 开启防火墙
service firewalld start
# 关闭防火墙
service firewalld stop
# 查询端口是否开放
firewall-cmd --query-port=8080/tcp
# 开放80端口
firewall-cmd --permanent --add-port=80/tcp
# 移除端口
firewall-cmd --permanent --remove-port=8080/tcp
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Nginx目录结构有哪些：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;/usr/local/nginx
├── client_body_temp
├── conf                             # Nginx所有配置文件的目录
│   ├── fastcgi.conf                 # fastcgi相关参数的配置文件
│   ├── fastcgi.conf.default         # fastcgi.conf的原始备份文件
│   ├── fastcgi_params               # fastcgi的参数文件
│   ├── fastcgi_params.default       
│   ├── koi-utf
│   ├── koi-win
│   ├── mime.types                   # 媒体类型
│   ├── mime.types.default
│   ├── nginx.conf                   # Nginx主配置文件
│   ├── nginx.conf.default
│   ├── scgi_params                  # scgi相关参数文件
│   ├── scgi_params.default  
│   ├── uwsgi_params                 # uwsgi相关参数文件
│   ├── uwsgi_params.default
│   └── win-utf
├── fastcgi_temp                     # fastcgi临时数据目录
├── html                             # Nginx默认站点目录
│   ├── 50x.html                     # 错误页面优雅替代显示文件，例如当出现502错误时会调用此页面
│   └── index.html                   # 默认的首页文件
├── logs                             # Nginx日志目录
│   ├── access.log                   # 访问日志文件
│   ├── error.log                    # 错误日志文件
│   └── nginx.pid                    # pid文件，Nginx进程启动后，会把所有进程的ID号写到此文件
├── proxy_temp                       # 临时目录
├── sbin                             # Nginx命令目录
│   └── nginx                        # Nginx的启动命令
├── scgi_temp                        # 临时目录
└── uwsgi_temp                       # 临时目录
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 data-id=&quot;heading-3&quot;&gt;核心配置文件结构&lt;/h2&gt;
&lt;p&gt;配置文件默认是放在&lt;code&gt;/usr/local/nginx/conf/nginx.conf&lt;/code&gt;，配置文件中默认有三大块：全局块、events块、http块。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;# 一般几个CPU，配置几个工作线程
worker_processes  1;

events {
   # 一个线程最大的连接数1024个
    worker_connections  1024;
}

http {
    # 在配置文件 conf/mime.types 下有配置，文件后缀对应的打开匹配文件后缀的配置
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;
        location / {
            root   html;
            index  index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-4&quot;&gt;全局块&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;user指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;用于配置运行Nginx服务器的worker进程的用户和用户组。我们最开始创建Nginx时，执行&lt;code&gt;./configure --user=user --group=group&lt;/code&gt;，在配置文件添加&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;user 用户名;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;然后再Linux命令行，创建一个用户&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;useradd 用户名
user 用户名
# 然后该用户有/home/用户名/`目录下访问权限,其他目录没有权限
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;work process指令&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;nginx是进程模型，分为主进程、工作进程。&lt;/p&gt;
&lt;p&gt;master_process：用来指定是否开启工作进程。&lt;/p&gt;
&lt;p&gt;worker_processes：配置Nginx生成工作进程的数量，一般与CPU的内核数-1数保存一致。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;# 设置工作进程
worker_processes  2;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-5&quot;&gt;events块&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;accept_mutex指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;配置：accept_mutex on|off ；用来设置Nginx网络连接序列化。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;worker_connections指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;默认是 worker_commections 512；用来配置单个worker进程最大的连接数；&lt;/p&gt;
&lt;p&gt;（单个worker进程最大的连接数 * N个worker线程），这个值不能大于操作系统支持打开的最大文件句柄数量。（Linux一般是65535）&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;# 修改操作系统支持打开的最大文件句柄数量，临时修改
ulimit -HSn 2048
# 永久修改
vi /etc/security/limits.conf
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-6&quot;&gt;http块&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;include指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;包含和导入外部文件，进行模块化的划分。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;include mime.types;
default_type application/octet-stream;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;sendfile指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;启用文件的高效传输，打开有利于文件传输的性能。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;sendfile   on;  # 启用高效传输，与tcp_nopush联合使用
tcp_nopush on;  # 当请求累积一定大小的时候，在进行发送
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;keepalive_requests指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;用来设置一个keep-alive连接使用的次数，客户端连接服务的超时时间。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;gzip指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;开启它有利于文件和请求数据的传输。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;gzip on
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-7&quot;&gt;server块:&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;listen指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;用来配置监听端口。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;server_name指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;用来设置虚拟主机服务名称。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;server {
listen 80;
server_name www.xx1.cn www.xx2.cn;
# 可以配置多个，也可以通配符进行配置 *.itcast.cn www.itcast.* 注意*只能在首尾部分
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;location指令：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;用来设置请求的URI。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;server {
...
server_name xxx.cn
# 可以在location后面加=（精确匹配）~（支持正则）~*（支持正则，支持大写）
location /abc{
default_type text/plain;
return 200 &quot;access success&quot;;
}
}
# 例子：请求：http://127.0.0.1/bbs，会匹配这里，页面存放路径在html/bbs目录下
location /bbs {
       root html;
}
# 可以模糊匹配，动静分离这里就是模糊匹配
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;error_page指令:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;设置网站的错误页面。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;server {
error_page 404 http://www.404.cn;
}
或者
server{
error_page 404 /50x.html;
error_page 500 502 503 504 /50x.html;
location =/50x.html{
root html;
}
}

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;gzip_static指令:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;解决Gzip和sendfile共存问题，需要添加ngx_http_gzip_static_module模块，才能使用gzip_static指令。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;# 1.查询当前Nginx的配置参数
nginx -V
# 2.清楚编译内容
cd /root/nginx/core/nginx-xxx
make clean
# 3.使用configure来配置参数
./configure (...之前的内容) --with-http_gzip_static_module
# 4.进行编译
make
# 5.将objs目录下的nginx二进制执行文件移动到nginx安装目录下的sbin下
mv objs/nginx /usr/local/nginx/sbin
# 6.执行更新命令
make upgrade
# 7.在配置文件http块下添加
gzip_static on
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-8&quot;&gt;proxy块：&lt;/h3&gt;
&lt;p&gt;反向代理模块&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;proxy_pass指令:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;令用来设置被代理服务器地址。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;proxy_set_header指令:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;该指令可以更改Nginx服务器接收到的客户端请求的请求头信息，然后 将新的请求头发送给代理的服务器。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;server {
listen 8080;
server_name localhost;
# 设置DNS的IP，用来解析proxy_pass域名
resolver 8.8.8.8;
location /server {
proxy_pass http://192.168.xx.xx:8080/;
proxy_set_header username TOM;
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 data-id=&quot;heading-9&quot;&gt;配置文件案例：&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-10&quot;&gt;&lt;strong&gt;基本部署：&lt;/strong&gt;&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;# 全局块
# 配置允许运行Nginx工作进程的用户和用户组
user www;
# 一般是CPU核数-1
worker_processes 2; 

# 配置Nginx服务器运行对错误日志存放的路径
error_log logs/error.log;
pid logs/nginx.pid;

# 全局块
events{
accept_mutex on;
multi_accept on;
# 设置Nginx的worker进程最大的连接数
worker_connections 1024;
}
# http块
http{
include mime.types;
default_type application/octet-stream;
# 配置允许使用sendfile方式运输，开启高效的文件传输
sendfile on;
tcp_nopush on;
tcp_nodelay on;
# 配置连接超时时间
keepalive_timeout 65;

# Gzip压缩功能配置
include /home/www/gzip/nginx_gzip.conf;
# 配置请求处理日志格式
log_format server1 &#39;===&amp;gt;server1 access log&#39;;
# log_format server2 &#39;===&amp;gt;server2 access log&#39;;

# server块 开始 #
include /home/www/conf.d/*.conf;
# server块 结束 #

}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;server1的配置文件&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;server{
listen 8081;
# 设置虚拟主机服务名称，可以用域名，多个空格隔开，也可以通配符&quot;*“例子：*.good.cn
server_name localhost;
# 配置请求处理日志存放路径
access_log /home/www/myweb/server1/logs/access.log server1;

location /server1/location1{
root /home/www/myweb;
index server1.html;
}
location /server1/location2{
root /home/www/myweb;
index server2.html;
}
# 配置错误页面转向
location = /404.html {
root /home/www/myweb;
index 404.html;
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;nginx_gzip.conf的配置文件&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;# 开启gzip功能
gzip on;
# 压缩源文件类型,例 application/javascript application/html;在mine.types里查看。
gzip_types *; 
# 压缩级别 1-9
gzip_comp_level 6; 
# 进行压缩响应页面的最小长度,小于这个数不进行压缩
gzip_min_length 1024k;
# 缓存空间大小,使用默认就好
gzip_buffers 4 16K; 
# 指定压缩响应所需要的最低HTTP请求版，使用默认就好
gzip_http_version 1.1;
# 往头信息中添加压缩标识，默认是off
gzip_vary on;
# 对IE6以下的版本都不进行压缩
gzip_disable &quot;MSIE [1-6]\.&quot;;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-11&quot;&gt;&lt;strong&gt;解决跨域问题：&lt;/strong&gt;&lt;/h3&gt;
&lt;p&gt;用add_header指令，该指令可以用来添加一些头信息&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;location /xxx{
add_header ‘Access-Control-Allow-Origin’ *;
add_header ‘Access-Control-Allow-Credentials’ &#39;true&#39;;
add_header ‘Access-Control-Allow-Methods’ GET,POST,PUT,DELETE;
add_header ‘Access-Control-Allow-Headers’ *;
root /home/www/myweb;
index server1.html;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-12&quot;&gt;&lt;strong&gt;解决静态资源防盗链：&lt;/strong&gt;&lt;/h3&gt;
&lt;p&gt;用valid_referers指令，如果在添加上域名或者IP地址，如果该值为1就返回403&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;location /xxx {
valid_referers none blocked www.baidu.* 127.0.0.1;
if ($invalid_referer){
# 返回403
return 403
# 如果让该图片显示其他默认图片
rewrite ^/ /images/图片名.png break;
}
root /usr/local/nginx/html;
}

# 如果不算这个域名，会重定向403
valid_referers *.goodysr.cn
if($invalid_referer){
return 403
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-13&quot;&gt;Rewrite域名跳转：&lt;/h3&gt;
&lt;p&gt;访问xxx1、xxx2域名 会跳转到zong的域名下。
标记说明：
1、last：本条规则匹配玩成后，继续向后新的location URL规则，一般用在server和if中。
2、break：本条规则匹配完成即终止，不再匹配后面的任何规则，一般使用在location中。
3、redirect：返回302临时重定向，浏览器地址会显示跳转后的URL地址
4、permanent：返回301也就重定向，浏览器地址栏会现实跳转后的URL地址&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;server {
listen 80;
server_name www.xxx1.com www.xxx2.cn;
rewrite ^(.*) http://www.zong.cn$1；
# 也可以某个路径下进行跳转，没有$1，代表请求后面的参数，不会携带
location /user {
rewrite ^/user(.*)$ http://www.user.cn$1;
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-14&quot;&gt;配置SSL：&lt;/h3&gt;
&lt;p&gt;步驟1：生成证书&lt;/p&gt;
&lt;p&gt;1.使用阿里云等平台购买:  或者使用openssl&lt;/p&gt;
&lt;p&gt;购买证书，然后创建证书，进行绑定域名，然后审核通过，下载证书。&lt;/p&gt;
&lt;p&gt;在服务器上某文件下（nginx/conf下），创建cert目录，存放所下载的证书文件。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;server {
listen 80;
server_name 域名;
# 将http请求重定向https上
rewrite ^(.*)$ https://$host$1；
location / {
root html;
index index.html index.htm;
}
}
server {
listen 443 ssl;
server_name 域名;
root html;
index index.html index.htm;
# 证书文件
ssl_certificate cert/xxx.pem;
ssl_certificate_key cert/xxx.key;
ssl_session_cache shared:SSL:1m;
ssl_session_timeout 5m;
# 加密规则
ssl_ciphers HIGH:!aNULL:!MD5;
# 表示使用TLS协议类型
ssl_protocols TLSv1 TLSv1.1 TLSv1.2
ssl_prefer_server_ciphers on;
location / {
root html;
index index.html index.htm;
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-15&quot;&gt;&lt;strong&gt;配置负载均衡&lt;/strong&gt;：&lt;/h3&gt;
&lt;p&gt;负载均衡状态 ：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;down 不参与负载均衡&lt;/li&gt;
&lt;li&gt;backup 备份服务器，不执行，当主服务挂的时候才执行&lt;/li&gt;
&lt;li&gt;max_fails 允许请求失败的次数，max_fails =3&lt;/li&gt;
&lt;li&gt;fail_timeout 经过max_fails失败后，服务暂停时间，fail_timeout=15&lt;/li&gt;
&lt;li&gt;max_conns 限制最大的接收连接数，当这台机器最大并发是100，也就是值为100&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;负载均衡策略：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;轮询 默认方式&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;weight 权重方式&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ip_hash 根据ip分配方式 ，这样可以解决session不共享问题&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;upstream backend{
ip_hash;
server 127.0.0.1:9091;
server 127.0.0.1:9092;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;least_conn 根据最少连接方式 ，适合请求处理时间长短不一造成服务器过载。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;url_hash 根据URL分配方式 ，hash &amp;amp;request_uri;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;fair 根据响应时间方式&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;# 负载均衡配置
upstream backend {
server 127.0.0.1:9091 down;
server 127.0.0.1:9092 max_conns=100 weight=1;
server 127.0.0.1:9093 weight=2;
}
upstream backend2{
hash &amp;amp;request_uri;
server 127.0.0.1:9091;
server 127.0.0.1:9091;
}
server {
    listen       80;
    server_name  localhost;
    location / {
        #root   html;
        #index  index.html index.htm;
proxy_pass http://backend;
    }
    location /backend2/ {
proxy_pass http://backend2;
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-16&quot;&gt;配置缓存：&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;http{
# 设置缓存根目录 levels缓存规则 keys_zone缓存名，缓存大小，1m=8000连接地址
 # inactive缓存多久会被情况 max_size缓存空间最大空间
proxy_cache_path /usr/local/cache levels=2:1 keys_zone=缓存名:200m inactive=1d max_size=20g;

upstream backend{
server 192.168.200.146:8080;
}
server {
listen 8080;
server_name localhost;
location / {
# 设置不缓存 如果是js文件不进行缓存
if ($request_uri ~ /.*\.js$){
set $nocache 1;
}
proxy_no_cache $nocache $cookie_nocache $arg_nocache $arg_comment;
proxy_cache_bypass $nocache $cookie_nocache $arg_nocache $arg_comment;
proxy_cache 缓存名;
proxy_cache_key $scheme$proxy_host$request_uri;
# 当请求为5次才进行缓存
proxy_cache_min_uses 5;
# 当缓存状态码是200 ，缓存时长5天
proxy_cache_valid 200 5d;
# 当缓存状态码是404，缓存时长30s
proxy_cache_valid 404 30s;
proxy_cache_valid any 1m;
add_header nginx-cache&quot;$upstream_cache_status&quot;;
proxy_pass http://backend;
}
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;删除对应的缓存目录：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;rm -rf /usr/local/proxy_cache/......
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-17&quot;&gt;动静分离：&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;upstream webservice{
# tomcat地址
server 192.168.10.xxx:8080;
}
server {
listen 80;
server_name localhost;
# 动态资源
location /demo {
proxy_pass http://webservice;
}
# 静态资源
location ~/.*\.(png|jpg|gif|js){
root html/web; # 静态文件地址
gzip on;
}
location / {
root html/web;
index index.html index.htm;
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-18&quot;&gt;搭建高可用Nginx集群：&lt;/h3&gt;
&lt;p&gt;准备两台Nginx机器，需要在这两台机器安装Keepalived，通过 VRRP 协议实现高可 用功能。&lt;/p&gt;
&lt;p&gt;安装Keepalived&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;步骤1:从官方网站下载keepalived,官网地址 https://keepalived.org/
步骤2:将下载的资源上传到服务器 
keepalived-2.0.20.tar.gz
步骤3:创建keepalived目录
mkdir keepalived
步骤4:将压缩文件进行解压缩，解压缩到指定的目录
tar -zxf keepalived-2.0.20.tar.gz -C keepalived/
步骤5:对keepalived进行配置，编译和安装
cd keepalived/keepalived-2.0.20
./configure --sysconf=/etc --prefix=/usr/local
make &amp;amp;&amp;amp; make install
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;配置文件&lt;/p&gt;
&lt;p&gt;一般在 /etc/keepalived/keepalived.conf ，我们进行配置&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;global_defs {
# 当keepalived发送切换时需要发email给具体的邮箱地址
notification_email {
xx1@xx1.com
xx2@xx2.com
}
# 设置发件人的邮箱信息
notification_email_from yy@xx3.com
# 指定smpt邮箱服务地址
smtp_server 192.168.200.1
smtp_connect_timeout 30
# 服务器的一个标识 A机器
router_id keepalivedA
vrrp_skip_check_adv_addr
vrrp_strict
vrrp_garp_interval 0
vrrp_gna_interval 0
}
vrrp_instance VI_1 {
# 两个值可选 MASTER主机 BACKUP从机
state MASTER
# 非抢占,这个参数只能用于state为backup
# 所以我们把state都设置成backup 让其通过priority来竞争，实现主机和从机
nopreempt
interface ens33
virtual_router_id 51
# 优先级高的将成为主机
priority 100
advert_int 1
authentication {
# 认证方式
auth_type PASS
# 指定认证使用的密码，最多8位
auth_pass 1111
}
virtual_ipaddress {
# 虚拟IP地址设置虚拟IP地址
192.168.200.222
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;启用keepalived&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;cd /usr/local/sbin
./keepalived
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;编写脚本实现自动切换&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;在keepalived配置文件中添加对应的配置像&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;gloval_defs{
....
}

# ck_n为脚本名称
vrrp_script ck_n{
script &quot;脚本位置&quot;
interval 3 #执行时间间隔
weight -20 #动态调整vrrp_instance的优先级
}

vrrp_instance VI_1 {
...
virtual_ipaddress {
192.168.200.111
}
# 使用Shell脚本
track_script {
ck_n
}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;编写脚本&lt;/p&gt;
&lt;p&gt;内容：监听nginx运行状态，如果nginx启动失败，尝试再次启动，如果启动失败，关掉keepalived进程。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;#!/bin/bash
num=`ps -C nginx --no-header | wc -l`
 if [ $num -eq 0 ];then
 /usr/local/nginx/sbin/nginx
 sleep 2
if [ `ps -C nginx --no-header | wc -l` -eq 0 ]; then
 killall keepalived
fi
fi
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;为脚本文件设置权限&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-conf&quot; lang=&quot;conf&quot;&gt;chmod 755 ck_nginx.sh
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 data-id=&quot;heading-19&quot;&gt;常见问题&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-20&quot;&gt;启动失败找不到pid文件&lt;/h3&gt;
&lt;p&gt;解决：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;mkdir -p /var/run/nginx/
# 指定配置文件进行重启
nginx -C /usr/local/nginx/conf/nginx.conf
# 重启
nginx -s reload
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-21&quot;&gt;配置环境变量：&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;vim /etc/profile
# 在文件末尾加上
export NGINX_HOME=/usr/local/nginx
export PATH=$NGINX_HOME/sbin:$PATH
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-22&quot;&gt;设置开机自动启动：&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-linux&quot; lang=&quot;linux&quot;&gt;vim /lib/systemd/system/nginx.service
# 在文件添加
[Unit]
#描述服务
Description=nginx
#描述服务类别
After=network.target
 
#服务运行参数的设置，注意【Service】的启动、重启、停止命令都要用绝对路径
[Service]
#后台运行的形式
Type=forking
#服务具体运行的命令
ExecStart=/usr/local/nginx/sbin/nginx
#重启命令
ExecReload=/usr/local/nginx/sbin/nginx -s reload
#停止命令
ExecStop=/usr/local/nginx/sbin/nginx -s quit
#表示给服务分配独立的临时空间
PrivateTmp=true
 
#运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3
[Install]
WantedBy=multi-user.target

# 然后 修改文件权限
chmod 755 /usr/lib/systemd/system/nginx.service
# 设置开机自启动
systemctl enable nginx.service
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-23&quot;&gt;防火墙的配置：&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-ini&quot; lang=&quot;ini&quot;&gt;---- 常用防火墙配置
&lt;span class=&quot;hljs-comment&quot;&gt;# 查看防火墙状态&lt;/span&gt;
systemctl status firewalld
&lt;span class=&quot;hljs-comment&quot;&gt;# 开启防火墙&lt;/span&gt;
systemctl start firewalld
&lt;span class=&quot;hljs-comment&quot;&gt;# 开机启动&lt;/span&gt;
systemctl enable firewalld
&lt;span class=&quot;hljs-comment&quot;&gt;# 开机关闭&lt;/span&gt;
systemctl disable firewalld

-- 设置对应开放的端口号
&lt;span class=&quot;hljs-comment&quot;&gt;# 查询打开的端口有哪些&lt;/span&gt;
firewall-cmd &lt;span class=&quot;hljs-attr&quot;&gt;--zone&lt;/span&gt;=public --list-ports
&lt;span class=&quot;hljs-comment&quot;&gt;# 关闭端口9002&lt;/span&gt;
firewall-cmd &lt;span class=&quot;hljs-attr&quot;&gt;--zone&lt;/span&gt;=public --remove-port=&lt;span class=&quot;hljs-number&quot;&gt;9002&lt;/span&gt;/tcp --permanent
&lt;span class=&quot;hljs-comment&quot;&gt;# 重新载入一下防火墙设置，使设置生效&lt;/span&gt;
firewall-cmd --reload

-- 设置nginx可对外网访问，服务端的tomcat不对外网方法，他们可以内网访问
&lt;span class=&quot;hljs-comment&quot;&gt;# 允许某ip访问9002端口 ip地址一般是nginx的ip地址&lt;/span&gt;
firewall-cmd --permanent &lt;span class=&quot;hljs-attr&quot;&gt;--add-rich-rule&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;rule family=&quot;&lt;/span&gt;ipv4&lt;span class=&quot;hljs-string&quot;&gt;&quot; source address=&quot;&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;172.27&lt;/span&gt;.&lt;span class=&quot;hljs-number&quot;&gt;0.45&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&quot; port protocol=&quot;&lt;/span&gt;tcp&lt;span class=&quot;hljs-string&quot;&gt;&quot; port=&quot;&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;9002&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&quot; accept&quot;&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;# 移出某ip访问9002端口 ip地址一般是nginx的ip地址&lt;/span&gt;
firewall-cmd --permanent &lt;span class=&quot;hljs-attr&quot;&gt;--remove-rich-rule&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&quot;rule family=&quot;&lt;/span&gt;ipv4&lt;span class=&quot;hljs-string&quot;&gt;&quot; source address=&quot;&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;172.27&lt;/span&gt;.&lt;span class=&quot;hljs-number&quot;&gt;0.45&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&quot; port protocol=&quot;&lt;/span&gt;tcp&lt;span class=&quot;hljs-string&quot;&gt;&quot; port=&quot;&lt;/span&gt;&lt;span class=&quot;hljs-number&quot;&gt;9002&lt;/span&gt;&lt;span class=&quot;hljs-string&quot;&gt;&quot; accept&quot;&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;# 重新载入一下防火墙设置，使设置生效&lt;/span&gt;
firewall-cmd --reload
&lt;span class=&quot;hljs-comment&quot;&gt;# 查看已设置规则&lt;/span&gt;
firewall-cmd &lt;span class=&quot;hljs-attr&quot;&gt;--zone&lt;/span&gt;=public --list-rich-rules
&lt;/code&gt;&lt;/pre&gt;</description><link>https://juejin.cn/post/7594874733382336563</link><guid isPermaLink="false">https://juejin.cn/post/7594874733382336563</guid><pubDate>Wed, 14 Jan 2026 03:18:18 GMT</pubDate><author>优秀的颜</author><category>后端</category></item><item><title>Java Stream：Collectors.collectingAndThen() 用法详解</title><description>&lt;h2 data-id=&quot;heading-0&quot;&gt;一、基本概念&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Collectors.collectingAndThen()&lt;/code&gt; 是一个收集器适配器，允许在收集完成后对结果进行转换。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// 方法签名&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T, A, R, RR&amp;gt; Collector&amp;lt;T, A, RR&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;collectingAndThen&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(
    Collector&amp;lt;T, A, R&amp;gt; downstream,  // 下游收集器
    Function&amp;lt;R, RR&amp;gt; finisher        // 最终转换函数
)&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;// 参数说明： &lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// T: 输入元素类型 (不变) &lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// A: 中间容器类型 (不变) &lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// R: 下游收集器的结果类型 &lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// RR: 最终结果类型（finisher转换后）&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;其中这里面涉及到的范型参数可以参考下面的解析：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Collector&lt;/span&gt;&amp;lt;T, A, R&amp;gt; {
    &lt;span class=&quot;hljs-comment&quot;&gt;// T: 流元素的类型（输入）&lt;/span&gt;
    &lt;span class=&quot;hljs-comment&quot;&gt;// A: 累加器的中间类型（容器）&lt;/span&gt;
    &lt;span class=&quot;hljs-comment&quot;&gt;// R: 最终结果的类型（输出）&lt;/span&gt;
    
    Supplier&amp;lt;A&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;supplier&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt;;        &lt;span class=&quot;hljs-comment&quot;&gt;// 创建容器A&lt;/span&gt;
    BiConsumer&amp;lt;A, T&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;accumulator&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt;; &lt;span class=&quot;hljs-comment&quot;&gt;// 将T累加到A&lt;/span&gt;
    BinaryOperator&amp;lt;A&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;combiner&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt;;   &lt;span class=&quot;hljs-comment&quot;&gt;// 合并两个A（并行流）&lt;/span&gt;
    Function&amp;lt;A, R&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;finisher&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt;;     &lt;span class=&quot;hljs-comment&quot;&gt;// 将A转换为R&lt;/span&gt;
    Set&amp;lt;Characteristics&amp;gt; &lt;span class=&quot;hljs-title function_&quot;&gt;characteristics&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt;;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;示例分析：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;String&amp;gt; list = Arrays.asList(&lt;span class=&quot;hljs-string&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;c&quot;&lt;/span&gt;);

List&amp;lt;String&amp;gt; result = list.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.toList(),        &lt;span class=&quot;hljs-comment&quot;&gt;// Collector&amp;lt;String, List&amp;lt;String&amp;gt;, List&amp;lt;String&amp;gt;&amp;gt;&lt;/span&gt;
        Collections::unmodifiableList &lt;span class=&quot;hljs-comment&quot;&gt;// Function&amp;lt;List&amp;lt;String&amp;gt;, List&amp;lt;String&amp;gt;&amp;gt;&lt;/span&gt;
    ));
    
&lt;span class=&quot;hljs-comment&quot;&gt;// 类型推导：&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// Collector&amp;lt;T=String, A=List&amp;lt;String&amp;gt;, R=List&amp;lt;String&amp;gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// Function&amp;lt;R=List&amp;lt;String&amp;gt;, RR=List&amp;lt;String&amp;gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// 最终 Collector&amp;lt;T=String, A=List&amp;lt;String&amp;gt;, RR=List&amp;lt;String&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 data-id=&quot;heading-1&quot;&gt;二、基本用法&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-2&quot;&gt;示例1：收集为不可变集合&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;String&amp;gt; list = Arrays.asList(&lt;span class=&quot;hljs-string&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;c&quot;&lt;/span&gt;);

&lt;span class=&quot;hljs-comment&quot;&gt;// 转换为不可修改的List&lt;/span&gt;
List&amp;lt;String&amp;gt; unmodifiableList = list.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.toList(),       &lt;span class=&quot;hljs-comment&quot;&gt;// 先收集为List&lt;/span&gt;
        Collections::unmodifiableList  &lt;span class=&quot;hljs-comment&quot;&gt;// 再转换为不可修改&lt;/span&gt;
    ));

&lt;span class=&quot;hljs-comment&quot;&gt;// 尝试修改会抛出异常&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// unmodifiableList.add(&quot;d&quot;); // UnsupportedOperationException&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-3&quot;&gt;示例2：获取集合大小&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;String&amp;gt; list = Arrays.asList(&lt;span class=&quot;hljs-string&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;d&quot;&lt;/span&gt;);

&lt;span class=&quot;hljs-comment&quot;&gt;// 直接计算集合大小&lt;/span&gt;
&lt;span class=&quot;hljs-type&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; list.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.toList(),  &lt;span class=&quot;hljs-comment&quot;&gt;// 收集为List&lt;/span&gt;
        List::size            &lt;span class=&quot;hljs-comment&quot;&gt;// 转换为大小&lt;/span&gt;
    ));

System.out.println(size); &lt;span class=&quot;hljs-comment&quot;&gt;// 输出: 4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-4&quot;&gt;示例3：分组后执行操作&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;Person&amp;gt; people = Arrays.asList(
    &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Person&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Alice&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;New York&quot;&lt;/span&gt;),
    &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Person&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Bob&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;New York&quot;&lt;/span&gt;),
    &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Person&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Charlie&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;London&quot;&lt;/span&gt;)
);

&lt;span class=&quot;hljs-comment&quot;&gt;// 按城市分组，并获取每个组的数量&lt;/span&gt;
Map&amp;lt;String, Integer&amp;gt; cityCount = people.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.groupingBy(Person::getCity),
        map -&amp;gt; {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 对分组结果进行处理&lt;/span&gt;
            Map&amp;lt;String, Integer&amp;gt; result = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;HashMap&lt;/span&gt;&amp;lt;&amp;gt;();
            map.forEach((city, list) -&amp;gt; result.put(city, list.size()));
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; result;
        }
    ));
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-5&quot;&gt;示例4：获取最大值或最小值&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;Integer&amp;gt; numbers = Arrays.asList(&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;4&lt;/span&gt;);

&lt;span class=&quot;hljs-comment&quot;&gt;// 获取最大值，如果没有则返回默认值&lt;/span&gt;
&lt;span class=&quot;hljs-type&quot;&gt;Integer&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;max&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; numbers.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.maxBy(Integer::compareTo),
        opt -&amp;gt; opt.orElse(-&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;)  &lt;span class=&quot;hljs-comment&quot;&gt;// 处理Optional&lt;/span&gt;
    ));

System.out.println(max); &lt;span class=&quot;hljs-comment&quot;&gt;// 输出: 5&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-6&quot;&gt;示例5：连接字符串并添加前缀后缀&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;String&amp;gt; words = Arrays.asList(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Hello&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;World&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;Java&quot;&lt;/span&gt;);

&lt;span class=&quot;hljs-comment&quot;&gt;// 用逗号连接，并添加方括号&lt;/span&gt;
&lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; words.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.joining(&lt;span class=&quot;hljs-string&quot;&gt;&quot;, &quot;&lt;/span&gt;),  &lt;span class=&quot;hljs-comment&quot;&gt;// 先连接&lt;/span&gt;
        s -&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;[&quot;&lt;/span&gt; + s + &lt;span class=&quot;hljs-string&quot;&gt;&quot;]&quot;&lt;/span&gt;         &lt;span class=&quot;hljs-comment&quot;&gt;// 再加括号&lt;/span&gt;
    ));

System.out.println(result); &lt;span class=&quot;hljs-comment&quot;&gt;// 输出: [Hello, World, Java]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-7&quot;&gt;示例6：收集为Set并排序&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;Integer&amp;gt; numbers = Arrays.asList(&lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;5&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;);

&lt;span class=&quot;hljs-comment&quot;&gt;// 去重后排序&lt;/span&gt;
List&amp;lt;Integer&amp;gt; sortedUnique = numbers.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.toCollection(TreeSet::&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt;),  &lt;span class=&quot;hljs-comment&quot;&gt;// 自动去重和排序&lt;/span&gt;
        ArrayList::&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt;  &lt;span class=&quot;hljs-comment&quot;&gt;// 转换为List&lt;/span&gt;
    ));

System.out.println(sortedUnique); &lt;span class=&quot;hljs-comment&quot;&gt;// 输出: [1, 2, 3, 5]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-8&quot;&gt;示例7：多重转换&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;Employee&amp;gt; employees = Arrays.asList(
    &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Employee&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Alice&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;5000&lt;/span&gt;),
    &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Employee&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Bob&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;6000&lt;/span&gt;),
    &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Employee&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Charlie&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-number&quot;&gt;5000&lt;/span&gt;)
);

&lt;span class=&quot;hljs-comment&quot;&gt;// 按薪资分组 -&amp;gt; 获取名字列表 -&amp;gt; 排序&lt;/span&gt;
Map&amp;lt;Integer, List&amp;lt;String&amp;gt;&amp;gt; salaryToNames = employees.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.groupingBy(
            Employee::getSalary,
            Collectors.mapping(Employee::getName, Collectors.toList())
        ),
        map -&amp;gt; {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 对每个分组的名字列表排序&lt;/span&gt;
            map.replaceAll((k, v) -&amp;gt; {
                Collections.sort(v);
                &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; v;
            });
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; map;
        }
    ));
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-9&quot;&gt;示例8：数据库查询结果处理&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// 查询用户列表，按部门分组，统计每个部门的平均工资&lt;/span&gt;
List&amp;lt;User&amp;gt; users = userRepository.findAll();

Map&amp;lt;String, Double&amp;gt; deptAvgSalary = users.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.groupingBy(
            User::getDepartment,
            Collectors.averagingDouble(User::getSalary)
        ),
        map -&amp;gt; {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 保留两位小数&lt;/span&gt;
            Map&amp;lt;String, Double&amp;gt; result = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;LinkedHashMap&lt;/span&gt;&amp;lt;&amp;gt;();
            map.forEach((dept, avg) -&amp;gt; 
                result.put(dept, Math.round(avg * &lt;span class=&quot;hljs-number&quot;&gt;100.0&lt;/span&gt;) / &lt;span class=&quot;hljs-number&quot;&gt;100.0&lt;/span&gt;));
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; result;
        }
    ));
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-10&quot;&gt;示例9：订单统计&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;Order&amp;gt; orders = orderService.getRecentOrders();

&lt;span class=&quot;hljs-comment&quot;&gt;// 统计每个用户的订单总金额，按金额降序排序&lt;/span&gt;
List&amp;lt;UserTotal&amp;gt; userTotals = orders.stream()
    .collect(Collectors.collectingAndThen(
        Collectors.groupingBy(
            Order::getUserId,
            Collectors.summingDouble(Order::getAmount)
        ),
        map -&amp;gt; map.entrySet().stream()
            .map(e -&amp;gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;UserTotal&lt;/span&gt;(e.getKey(), e.getValue()))
            .sorted(Comparator.comparing(UserTotal::getTotal).reversed())
            .collect(Collectors.toList())
    ));
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 data-id=&quot;heading-11&quot;&gt;三、使用建议&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;&quot;用 collectingAndThen 只做一件事，复杂的就分步，简单的直接做，保持代码干净。&quot;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;三个核心原则：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;只做简单转换&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;一次只做一件事&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据量大才考虑使用&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 data-id=&quot;heading-12&quot;&gt;1.  简单原则&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;能用简单方式就不用复杂收集器&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// ❌ 过度使用&lt;/span&gt;
List&amp;lt;String&amp;gt; result = list.stream()
    .collect(collectingAndThen(
        toList(),
        Collections::unmodifiableList
    ));

&lt;span class=&quot;hljs-comment&quot;&gt;// ✅ 简单方式（Java 10+）&lt;/span&gt;
List&amp;lt;String&amp;gt; result = List.copyOf(list);
&lt;span class=&quot;hljs-comment&quot;&gt;// 或&lt;/span&gt;
List&amp;lt;String&amp;gt; result = Collections.unmodifiableList(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ArrayList&lt;/span&gt;&amp;lt;&amp;gt;(list));
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-13&quot;&gt;2. 保持函数纯净&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;不要在转换函数中有副作用&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// ❌ 有副作用&lt;/span&gt;
Map&amp;lt;String, List&amp;lt;Person&amp;gt;&amp;gt; result = persons.stream()
    .collect(collectingAndThen(
        groupingBy(Person::getCity),
        map -&amp;gt; {
            map.forEach((k, v) -&amp;gt; System.out.println(k)); &lt;span class=&quot;hljs-comment&quot;&gt;// 副作用&lt;/span&gt;
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; map;
        }
    ));

&lt;span class=&quot;hljs-comment&quot;&gt;// ✅ 纯函数&lt;/span&gt;
Map&amp;lt;String, List&amp;lt;Person&amp;gt;&amp;gt; result = persons.stream()
    .collect(groupingBy(Person::getCity));
&lt;span class=&quot;hljs-comment&quot;&gt;// 副作用放到后面&lt;/span&gt;
result.forEach((k, v) -&amp;gt; System.out.println(k));
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-14&quot;&gt;3. 性能意识&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;小数据不要用，大数据才考虑&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;List&amp;lt;String&amp;gt; smallList = Arrays.asList(&lt;span class=&quot;hljs-string&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;c&quot;&lt;/span&gt;); &lt;span class=&quot;hljs-comment&quot;&gt;// 只有3个元素&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;// ❌ 没必要用 collectingAndThen&lt;/span&gt;
List&amp;lt;String&amp;gt; result1 = smallList.stream()
    .collect(collectingAndThen(toList(), Collections::unmodifiableList));

&lt;span class=&quot;hljs-comment&quot;&gt;// ✅ 直接创建不可变集合&lt;/span&gt;
List&amp;lt;String&amp;gt; result2 = List.copyOf(smallList); &lt;span class=&quot;hljs-comment&quot;&gt;// Java 10+&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// 或&lt;/span&gt;
List&amp;lt;String&amp;gt; result3 = Collections.unmodifiableList(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ArrayList&lt;/span&gt;&amp;lt;&amp;gt;(smallList));

&lt;span class=&quot;hljs-comment&quot;&gt;// ✅ 大数据集用 collectingAndThen&lt;/span&gt;
List&amp;lt;String&amp;gt; largeList = getLargeList(); &lt;span class=&quot;hljs-comment&quot;&gt;// 假设有上万条&lt;/span&gt;
List&amp;lt;String&amp;gt; result = largeList.stream()
    .collect(collectingAndThen(toList(), Collections::unmodifiableList));
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-15&quot;&gt;4. 常用场景才用&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;不要为了用而用&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// ✅ 真正有用的场景：&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;// 1. 收集后立即转换&lt;/span&gt;
List&amp;lt;String&amp;gt; result = list.stream()
    .collect(collectingAndThen(
        toList(),
        Collections::unmodifiableList  &lt;span class=&quot;hljs-comment&quot;&gt;// 立即转为不可变&lt;/span&gt;
    ));

&lt;span class=&quot;hljs-comment&quot;&gt;// 2. 处理 Optional 结果&lt;/span&gt;
&lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;max&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; list.stream()
    .collect(collectingAndThen(
        maxBy(String::compareTo),
        opt -&amp;gt; opt.orElse(&lt;span class=&quot;hljs-string&quot;&gt;&quot;default&quot;&lt;/span&gt;)  &lt;span class=&quot;hljs-comment&quot;&gt;// 解包Optional&lt;/span&gt;
    ));

&lt;span class=&quot;hljs-comment&quot;&gt;// 3. 连接字符串后包装&lt;/span&gt;
&lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;joined&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; list.stream()
    .collect(collectingAndThen(
        joining(&lt;span class=&quot;hljs-string&quot;&gt;&quot;, &quot;&lt;/span&gt;),
        s -&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;[&quot;&lt;/span&gt; + s + &lt;span class=&quot;hljs-string&quot;&gt;&quot;]&quot;&lt;/span&gt;  &lt;span class=&quot;hljs-comment&quot;&gt;// 添加括号&lt;/span&gt;
    ));

&lt;span class=&quot;hljs-comment&quot;&gt;// ❌ 没必要用的场景：&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - 只是简单的收集&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - 后续还有更多处理步骤&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// - 转换逻辑很复杂&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-16&quot;&gt;5. 复杂逻辑就分步&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;不要都塞进 collectingAndThen&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-comment&quot;&gt;// ❌ 过于复杂&lt;/span&gt;
List&amp;lt;String&amp;gt; result = list.stream()
    .collect(collectingAndThen(
        toList(),
        list -&amp;gt; {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 一大堆复杂逻辑&lt;/span&gt;
            list.sort(Comparator.reverseOrder());
            list.replaceAll(String::toUpperCase);
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; Collections.unmodifiableList(list);
        }
    ));

&lt;span class=&quot;hljs-comment&quot;&gt;// ✅ 分步处理更清晰&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;// 步骤1：收集和排序&lt;/span&gt;
List&amp;lt;String&amp;gt; temp = list.stream()
    .sorted(Comparator.reverseOrder())
    .collect(toList());

&lt;span class=&quot;hljs-comment&quot;&gt;// 步骤2：转换&lt;/span&gt;
temp.replaceAll(String::toUpperCase);

&lt;span class=&quot;hljs-comment&quot;&gt;// 步骤3：转为不可变&lt;/span&gt;
List&amp;lt;String&amp;gt; result = Collections.unmodifiableList(temp);
&lt;/code&gt;&lt;/pre&gt;</description><link>https://juejin.cn/post/7594859060856979466</link><guid isPermaLink="false">https://juejin.cn/post/7594859060856979466</guid><pubDate>Wed, 14 Jan 2026 03:16:52 GMT</pubDate><author>白衣鸽子</author><category>后端</category></item><item><title>Maven详细配置（完整笔记）</title><description>Maven：Java 领域开源自动化构建工具，基于项目对象模型（POM），统一依赖管理、构建流程，提升项目开发效率与协作一致性。</description><link>https://juejin.cn/post/7594831933515857966</link><guid isPermaLink="false">https://juejin.cn/post/7594831933515857966</guid><pubDate>Wed, 14 Jan 2026 03:13:42 GMT</pubDate><author>优秀的颜</author><category>后端</category></item><item><title>Ubuntu 24.04 PostgreSQL + PostGIS 完整安装与配置指南</title><description>Ubuntu 24.04 PostgreSQL + PostGIS 完整安装与配置指南 PostGIS 是 PostgreSQL 的空间数据库扩展，为地理空间数据提供了强大的存储、查询和分析功能。本教</description><link>https://juejin.cn/post/7594765626457030706</link><guid isPermaLink="false">https://juejin.cn/post/7594765626457030706</guid><pubDate>Wed, 14 Jan 2026 03:09:03 GMT</pubDate><author>勿忘初心720</author><category>后端</category></item><item><title>深入理解 LLVM：从编译器原理到 JIT 实战</title><description>本文从编译器基础概念开始，逐步深入到 LLVM 的实现细节和实际应用，帮助开发者全面理解 LLVM 的工作原理和使用方法。</description><link>https://juejin.cn/post/7594722586731642886</link><guid isPermaLink="false">https://juejin.cn/post/7594722586731642886</guid><pubDate>Wed, 14 Jan 2026 02:45:45 GMT</pubDate><author>杨杨杨大侠</author><category>后端</category><category>Java</category><category>JVM</category><category>编译器</category></item><item><title>10分钟搞定！SpringBoot集成腾讯云短信全攻略，从配置到发送一气呵成</title><description>在Spring Boot项目中集成腾讯云短信服务，主要通过官方SDK调用API实现，具有稳定性高、接入便捷的特点。下面是详细介绍如何实现。</description><link>https://juejin.cn/post/7594739292200665123</link><guid isPermaLink="false">https://juejin.cn/post/7594739292200665123</guid><pubDate>Wed, 14 Jan 2026 02:09:31 GMT</pubDate><author>悟空码字</author><category>后端</category><category>Java</category><category>Spring Boot</category></item><item><title>SpringCloud分布式追踪深度实战：Sleuth+Zipkin从入门到生产部署全攻略</title><description>分布式链路追踪 - 微服务里的&quot;侦探&quot;，请求去哪儿了一清二楚🔍 一、先白话白话为啥需要链路追踪 零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目 资源获取：关注公</description><link>https://juejin.cn/post/7594742976711884834</link><guid isPermaLink="false">https://juejin.cn/post/7594742976711884834</guid><pubDate>Wed, 14 Jan 2026 02:06:05 GMT</pubDate><author>小坏说Java</author><category>后端</category><category>Spring Cloud</category><category>分布式</category></item><item><title>工作中最常用的5种本地缓存</title><description>前言 今天和大家聊聊一个几乎所有Java开发者都会用到，但很多人对其理解不够深入的技术——本地缓存。 有些小伙伴在工作中可能遇到过这样的场景：系统性能测试时，发现某个接口响应时间越来越长，一查发现是数</description><link>https://juejin.cn/post/7594728203257364514</link><guid isPermaLink="false">https://juejin.cn/post/7594728203257364514</guid><pubDate>Wed, 14 Jan 2026 01:58:04 GMT</pubDate><author>苏三说技术</author><category>后端</category></item><item><title>“磁盘爆满告警”——Linux 服务器空间排查与优化实战</title><description>来自运维的告警 近日运维同事找到我说你看看这台 113 的机器是不是你这边业务的，存储使用超出 80% 了，我心里一沉这确实是我的业务！根分区使用率超过 90% 就是高危状态，再涨一点</description><link>https://juejin.cn/post/7594735599313993778</link><guid isPermaLink="false">https://juejin.cn/post/7594735599313993778</guid><pubDate>Wed, 14 Jan 2026 01:53:26 GMT</pubDate><author>帅气的你</author><category>后端</category><category>Linux</category><category>程序员</category></item><item><title>工作中七天免登录如何实现</title><description>作为一名Java后端高级开发，我敢说“七天免登录”是业务系统里最常见的需求之一——用户登录一次后，一周内再次访问系统无需重复输入账号密码，直接就能进入主页。这个需求看似简单，但实现不好很容易踩坑：要么</description><link>https://juejin.cn/post/7594728203257167906</link><guid isPermaLink="false">https://juejin.cn/post/7594728203257167906</guid><pubDate>Wed, 14 Jan 2026 01:30:47 GMT</pubDate><author>天天摸鱼的java工程师</author><category>后端</category><category>Java</category></item><item><title>大数据量查询处理方案</title><description>在实际开发中，经常遇到需要查询大量数据的场景，如：订单历史数据导出，报表统计查询等，此文章记录如何优化该场景</description><link>https://juejin.cn/post/7594734666009100297</link><guid isPermaLink="false">https://juejin.cn/post/7594734666009100297</guid><pubDate>Wed, 14 Jan 2026 01:01:27 GMT</pubDate><author>码头整点薯条</author><category>后端</category><category>Java</category></item><item><title>《自动化埋点：利用 AOP 统一记录接口入参、出参及执行耗时》</title><description>&lt;h3 data-id=&quot;heading-0&quot;&gt;前言&lt;/h3&gt;
&lt;p&gt;在定位线上问题时，最常用的操作就是查看接口的“入参是什么”以及“返回了什么”。如果手动在每个 Controller 方法中去打印日志，不仅代码臃肿，且难以维护。&lt;/p&gt;
&lt;p&gt;通过 Spring &lt;strong&gt;AOP（面向切面编程）&lt;/strong&gt; ，我们可以实现一种非侵入式的日志增强机制：在不修改任何业务代码的前提下，自动捕捉接口的请求参数、响应结果以及整个方法的执行耗时。&lt;/p&gt;
&lt;h2 data-id=&quot;heading-1&quot;&gt;关键实现&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-2&quot;&gt;性能监控 StopWatch&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;StopWatch&lt;/code&gt; 是 spring 提供的轻量级性能监控工具，使用方式如下：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-type&quot;&gt;StopWatch&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;stopWatch&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;StopWatch&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;order-process&quot;&lt;/span&gt;);

stopWatch.start(&lt;span class=&quot;hljs-string&quot;&gt;&quot;query-db&quot;&lt;/span&gt;);
&lt;span class=&quot;hljs-comment&quot;&gt;// 查询数据库&lt;/span&gt;
stopWatch.stop();

stopWatch.start(&lt;span class=&quot;hljs-string&quot;&gt;&quot;call-remote&quot;&lt;/span&gt;);
&lt;span class=&quot;hljs-comment&quot;&gt;// 调用远程接口&lt;/span&gt;
stopWatch.stop();

stopWatch.start(&lt;span class=&quot;hljs-string&quot;&gt;&quot;calculate&quot;&lt;/span&gt;);
&lt;span class=&quot;hljs-comment&quot;&gt;// 业务计算&lt;/span&gt;
stopWatch.stop();

log.info(&lt;span class=&quot;hljs-string&quot;&gt;&quot;cost info:\n{}&quot;&lt;/span&gt;, stopWatch.prettyPrint());

&lt;span class=&quot;hljs-comment&quot;&gt;// 耗时&lt;/span&gt;
log.info(&lt;span class=&quot;hljs-string&quot;&gt;&quot;接口耗时：{}ms&quot;&lt;/span&gt;, stopWatch.getTotalTimeMillis());

&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-3&quot;&gt;切入点&lt;/h3&gt;
&lt;p&gt;配置切入点 &lt;code&gt;@RestController&lt;/code&gt; 或 &lt;code&gt;Controller&lt;/code&gt;，对所有接口中的方法进行拦截：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@Pointcut(&quot;@within(org.springframework.web.bind.annotation.RestController) || @within(org.springframework.stereotype.Controller)&quot;)&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;controllerPointcut&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; {
    
}
    
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-4&quot;&gt;获取 swagger 接口描述&lt;/h3&gt;
&lt;p&gt;配置上面切入点的环绕通知，对接口方法增强：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;
    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 缓存方法描述，避免频繁反射
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;Method, String&amp;gt; methodDescriptionCache = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ConcurrentHashMap&lt;/span&gt;&amp;lt;&amp;gt;();
    
    &lt;span class=&quot;hljs-comment&quot;&gt;// swagger 接口全类名（用于反射）&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;SWAGGER_OPERATION_CLASS&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;io.swagger.v3.oas.annotations.Operation&quot;&lt;/span&gt;;

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 获取方法描述（尝试从 Swagger 注解中获取）
     *
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; method 方法
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@return&lt;/span&gt; 描述信息
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String &lt;span class=&quot;hljs-title function_&quot;&gt;getMethodDescription&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(Method method)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; methodDescriptionCache.computeIfAbsent(method, m -&amp;gt; {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 尝试获取 Swagger 3 (@Operation)&lt;/span&gt;
            &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;summary&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; getAnnotationValue(m, SWAGGER_OPERATION_CLASS, &lt;span class=&quot;hljs-string&quot;&gt;&quot;summary&quot;&lt;/span&gt;);
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (StringUtils.hasText(summary)) {
                &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; summary;
            }

            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;;
        });
    }

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 反射获取注解属性值
     *
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; method          方法
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; annotationClass 注解全类名
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; property        属性名
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@return&lt;/span&gt; 属性值
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String &lt;span class=&quot;hljs-title function_&quot;&gt;getAnnotationValue&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(Method method, String annotationClass, String property)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; {
            Class&amp;lt;?&amp;gt; clazz = Class.forName(annotationClass);
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (clazz.isAnnotation()) {
                &lt;span class=&quot;hljs-meta&quot;&gt;@SuppressWarnings(&quot;unchecked&quot;)&lt;/span&gt;
                Class&amp;lt;? &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Annotation&lt;/span&gt;&amp;gt; annotationType = (Class&amp;lt;? &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Annotation&lt;/span&gt;&amp;gt;) clazz;
                &lt;span class=&quot;hljs-type&quot;&gt;Annotation&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;annotation&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; method.getAnnotation(annotationType);
                &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (annotation != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;) {
                    &lt;span class=&quot;hljs-type&quot;&gt;Method&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;propertyMethod&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; clazz.getMethod(property);
                    &lt;span class=&quot;hljs-type&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; propertyMethod.invoke(annotation);
                    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; value != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; ? value.toString() : &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;;
                }
            }
        } &lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 忽略异常（类不存在或反射失败）&lt;/span&gt;
        }
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;;
    }

&lt;/code&gt;&lt;/pre&gt;
&lt;h2 data-id=&quot;heading-5&quot;&gt;完整实现&lt;/h2&gt;
&lt;h3 data-id=&quot;heading-6&quot;&gt;配置文件&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;&lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@ConfigurationProperties(prefix = &quot;x-polaris.web&quot;)&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;PolarisWebProperties&lt;/span&gt; {

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 请求日志配置
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;Log&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;log&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Log&lt;/span&gt;();

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 请求日志配置类
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-meta&quot;&gt;@Data&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Log&lt;/span&gt; {
        &lt;span class=&quot;hljs-comment&quot;&gt;/**
         * 是否开启请求日志切面，默认 true
         */&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;enabled&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;

        &lt;span class=&quot;hljs-comment&quot;&gt;/**
         * 是否记录请求参数，默认 true
         */&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;logRequest&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;

        &lt;span class=&quot;hljs-comment&quot;&gt;/**
         * 是否记录响应结果，默认 true
         */&lt;/span&gt;
        &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;logResponse&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;true&lt;/span&gt;;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-7&quot;&gt;日志切面&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt;perties properties;

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 缓存方法描述，避免频繁反射
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;Method, String&amp;gt; methodDescriptionCache = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;ConcurrentHashMap&lt;/span&gt;&amp;lt;&amp;gt;();

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * Swagger Operation 注解全类名
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;SWAGGER_OPERATION_CLASS&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;io.swagger.v3.oas.annotations.Operation&quot;&lt;/span&gt;;

    &lt;span class=&quot;hljs-meta&quot;&gt;@Pointcut(&quot;@within(org.springframework.web.bind.annotation.RestController) || @within(org.springframework.stereotype.Controller)&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title function_&quot;&gt;controllerPointcut&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;()&lt;/span&gt; {
    }

    &lt;span class=&quot;hljs-meta&quot;&gt;@Around(&quot;controllerPointcut()&quot;)&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; Object &lt;span class=&quot;hljs-title function_&quot;&gt;around&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(ProceedingJoinPoint point)&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;throws&lt;/span&gt; Throwable {
        PolarisWebProperties.&lt;span class=&quot;hljs-type&quot;&gt;Log&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;logConfig&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; properties.getLog();
        &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (!logConfig.isEnabled()) {
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; point.proceed();
        }

        &lt;span class=&quot;hljs-type&quot;&gt;StopWatch&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;stopWatch&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;StopWatch&lt;/span&gt;();
        stopWatch.start();
        &lt;span class=&quot;hljs-type&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;hljs-type&quot;&gt;HttpServletRequest&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;request&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;;

        &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;hljs-type&quot;&gt;ServletRequestAttributes&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;attributes&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; (ServletRequestAttributes) RequestContextHolder
                    .getRequestAttributes();
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (attributes != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;) {
                request = attributes.getRequest();
            }

            &lt;span class=&quot;hljs-comment&quot;&gt;// 获取方法描述&lt;/span&gt;
            &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;description&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;;
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (point.getSignature() &lt;span class=&quot;hljs-keyword&quot;&gt;instanceof&lt;/span&gt; MethodSignature) {
                &lt;span class=&quot;hljs-type&quot;&gt;Method&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;method&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; ((MethodSignature) point.getSignature()).getMethod();
                description = getMethodDescription(method);
            }

            &lt;span class=&quot;hljs-comment&quot;&gt;// 记录请求信息&lt;/span&gt;
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (request != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; logConfig.isLogRequest()) {
                &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;method&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; request.getMethod();
                &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;uri&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; request.getRequestURI();
                &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;queryString&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; request.getQueryString();
                &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;args&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; Arrays.stream(point.getArgs())
                        .map(arg -&amp;gt; {
                            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (arg &lt;span class=&quot;hljs-keyword&quot;&gt;instanceof&lt;/span&gt; MultipartFile) {
                                &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;MultipartFile:&quot;&lt;/span&gt; + ((MultipartFile) arg).getOriginalFilename();
                            }
                            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; String.valueOf(arg);
                        })
                        .collect(Collectors.joining(&lt;span class=&quot;hljs-string&quot;&gt;&quot;, &quot;&lt;/span&gt;));

                &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (StringUtils.hasText(description)) {
                    log.info(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Request Start: ({}) [{}] {} , Args: {}&quot;&lt;/span&gt;, description, method,
                            uri + (queryString != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;hljs-string&quot;&gt;&quot;?&quot;&lt;/span&gt; + queryString : &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;), args);
                } &lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt; {
                    log.info(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Request Start: [{}] {}, Args: {}&quot;&lt;/span&gt;, method,
                            uri + (queryString != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;hljs-string&quot;&gt;&quot;?&quot;&lt;/span&gt; + queryString : &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;), args);
                }
            }

            result = point.proceed();
            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; result;

        } &lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
            log.error(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Request Error: {}&quot;&lt;/span&gt;, e.getMessage());
            &lt;span class=&quot;hljs-keyword&quot;&gt;throw&lt;/span&gt; e;
        } &lt;span class=&quot;hljs-keyword&quot;&gt;finally&lt;/span&gt; {
            stopWatch.stop();
            &lt;span class=&quot;hljs-comment&quot;&gt;// 记录响应信息&lt;/span&gt;
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (logConfig.isLogResponse()) {
                log.info(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Request End: Time: {}ms, Result: {}&quot;&lt;/span&gt;, stopWatch.getTotalTimeMillis(), result);
            } &lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt; {
                log.info(&lt;span class=&quot;hljs-string&quot;&gt;&quot;Request End: Time: {}ms&quot;&lt;/span&gt;, stopWatch.getTotalTimeMillis());
            }
        }
    }

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 获取方法描述（尝试从 Swagger 注解中获取）
     *
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; method 方法
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@return&lt;/span&gt; 描述信息
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String &lt;span class=&quot;hljs-title function_&quot;&gt;getMethodDescription&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(Method method)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; methodDescriptionCache.computeIfAbsent(method, m -&amp;gt; {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 尝试获取 Swagger 3 (@Operation)&lt;/span&gt;
            &lt;span class=&quot;hljs-type&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;summary&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; getAnnotationValue(m, SWAGGER_OPERATION_CLASS, &lt;span class=&quot;hljs-string&quot;&gt;&quot;summary&quot;&lt;/span&gt;);
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (StringUtils.hasText(summary)) {
                &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; summary;
            }

            &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;;
        });
    }

    &lt;span class=&quot;hljs-comment&quot;&gt;/**
     * 反射获取注解属性值
     *
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; method          方法
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; annotationClass 注解全类名
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@param&lt;/span&gt; property        属性名
     * &lt;span class=&quot;hljs-doctag&quot;&gt;@return&lt;/span&gt; 属性值
     */&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String &lt;span class=&quot;hljs-title function_&quot;&gt;getAnnotationValue&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(Method method, String annotationClass, String property)&lt;/span&gt; {
        &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; {
            Class&amp;lt;?&amp;gt; clazz = Class.forName(annotationClass);
            &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (clazz.isAnnotation()) {
                &lt;span class=&quot;hljs-meta&quot;&gt;@SuppressWarnings(&quot;unchecked&quot;)&lt;/span&gt;
                Class&amp;lt;? &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Annotation&lt;/span&gt;&amp;gt; annotationType = (Class&amp;lt;? &lt;span class=&quot;hljs-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;Annotation&lt;/span&gt;&amp;gt;) clazz;
                &lt;span class=&quot;hljs-type&quot;&gt;Annotation&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;annotation&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; method.getAnnotation(annotationType);
                &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (annotation != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;) {
                    &lt;span class=&quot;hljs-type&quot;&gt;Method&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;propertyMethod&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; clazz.getMethod(property);
                    &lt;span class=&quot;hljs-type&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;hljs-variable&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;hljs-operator&quot;&gt;=&lt;/span&gt; propertyMethod.invoke(annotation);
                    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; value != &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt; ? value.toString() : &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;;
                }
            }
        } &lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;hljs-comment&quot;&gt;// 忽略异常（类不存在或反射失败）&lt;/span&gt;
        }
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;null&lt;/span&gt;;
    }
}

&lt;/code&gt;&lt;/pre&gt;
&lt;h3 data-id=&quot;heading-8&quot;&gt;自动配置&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&quot;hljs language-java&quot; lang=&quot;java&quot;&gt; &lt;span class=&quot;hljs-meta&quot;&gt;@Bean&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@ConditionalOnMissingBean&lt;/span&gt;
&lt;span class=&quot;hljs-meta&quot;&gt;@ConditionalOnProperty(prefix = &quot;x-polaris.web.log&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; RequestLogAspect &lt;span class=&quot;hljs-title function_&quot;&gt;requestLogAspect&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(PolarisWebProperties properties)&lt;/span&gt; {
    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-title class_&quot;&gt;RequestLogAspect&lt;/span&gt;(properties);
}
&lt;/code&gt;&lt;/pre&gt;</description><link>https://juejin.cn/post/7594682922684006409</link><guid isPermaLink="false">https://juejin.cn/post/7594682922684006409</guid><pubDate>Tue, 13 Jan 2026 16:09:34 GMT</pubDate><author>用户94835701651</author><category>后端</category></item></channel></rss>